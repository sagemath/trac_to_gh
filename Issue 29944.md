# Issue 29944: Immutable elements of FreeModuleTensor

archive/issues_029944.json:
```json
{
    "body": "CC:  @egourgoulhon @tscrim @mjungmath\n\nCurrently, elements of a `FiniteRankFreeModule` and its tensor modules are mutable and therefore cannot be hashed.\n\nIn analogy to `sage.modules.FreeModuleElement` and `sage.matrix.Matrix`, a method `set_immutable()` should be added.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30181\n\n",
    "created_at": "2020-07-20T18:44:55Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Immutable elements of FreeModuleTensor",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29944",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @egourgoulhon @tscrim @mjungmath

Currently, elements of a `FiniteRankFreeModule` and its tensor modules are mutable and therefore cannot be hashed.

In analogy to `sage.modules.FreeModuleElement` and `sage.matrix.Matrix`, a method `set_immutable()` should be added.

Issue created by migration from https://trac.sagemath.org/ticket/30181





---

archive/issue_comments_424856.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T21:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424856",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_424857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T21:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424857",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_424858.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-30T21:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424858",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_424859.json:
```json
{
    "body": "Although hashing is one of the motivations for this ticket, it will not be implemented on this ticket. A follow-up ticket will take care of it.",
    "created_at": "2020-07-30T21:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424859",
    "user": "https://github.com/mkoeppe"
}
```

Although hashing is one of the motivations for this ticket, it will not be implemented on this ticket. A follow-up ticket will take care of it.



---

archive/issue_comments_424860.json:
```json
{
    "body": "I would also make those methods\n\n```\ncpdef bool is_[im]mutable(self):\n```\n\n\nIn some ways, I think this would be better as a mixin class. Alas, Cython does not have multiple inheritance...",
    "created_at": "2020-07-30T23:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424860",
    "user": "https://github.com/tscrim"
}
```

I would also make those methods

```
cpdef bool is_[im]mutable(self):
```


In some ways, I think this would be better as a mixin class. Alas, Cython does not have multiple inheritance...



---

archive/issue_comments_424861.json:
```json
{
    "body": "There is already a mixin class written in Cython, `sage.structure.mutability`, but it cannot be used for exactly this reason.",
    "created_at": "2020-07-30T23:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424861",
    "user": "https://github.com/mkoeppe"
}
```

There is already a mixin class written in Cython, `sage.structure.mutability`, but it cannot be used for exactly this reason.



---

archive/issue_comments_424862.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> I would also make those methods\n> \n> ```\n> cpdef bool is_[im]mutable(self):\n> ```\n\nYes, I'll make this change",
    "created_at": "2020-07-30T23:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424862",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 tscrim]:
> I would also make those methods
> 
> ```
> cpdef bool is_[im]mutable(self):
> ```

Yes, I'll make this change



---

archive/issue_comments_424863.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T23:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424863",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_424864.json:
```json
{
    "body": "Thank you. LGTM.\n\n(I slightly wonder if a user who really cares about speed should instead be just breaking the encapsulation here...)",
    "created_at": "2020-07-31T04:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424864",
    "user": "https://github.com/tscrim"
}
```

Thank you. LGTM.

(I slightly wonder if a user who really cares about speed should instead be just breaking the encapsulation here...)



---

archive/issue_comments_424865.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-31T04:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424865",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_424866.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-07-31T05:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424866",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_424867.json:
```json
{
    "body": "Thank you for this very nice improvement!\n\nWhat about the name of an immutable element? Should that be immutable, too? This is not covered in this modification, but maybe it should?\n\nAs you suggested a systematic solution to #30239, it would be good to add this improvement to all modules in the `manifolds` module and to the scalar field algebra as well. The latter probably needs a new implementation, e.g. `CommutativeAlgebraElementWithMutability`.",
    "created_at": "2020-07-31T05:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424867",
    "user": "https://github.com/mjungmath"
}
```

Thank you for this very nice improvement!

What about the name of an immutable element? Should that be immutable, too? This is not covered in this modification, but maybe it should?

As you suggested a systematic solution to #30239, it would be good to add this improvement to all modules in the `manifolds` module and to the scalar field algebra as well. The latter probably needs a new implementation, e.g. `CommutativeAlgebraElementWithMutability`.



---

archive/issue_comments_424868.json:
```json
{
    "body": "What about a slighly more general approach like having a class `ElementWithMutability` and then simply\n\n```python\nclass FreeModuleTensor(ModuleElement, ElementWithMutability) \n```\n\nThis approach can also be applied to other elements. The hashablility can then be implemented via `ElementWithMutability`.\n\nThis has also the great advantage that this can be used for affine connections and bundle connections, too.",
    "created_at": "2020-07-31T06:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424868",
    "user": "https://github.com/mjungmath"
}
```

What about a slighly more general approach like having a class `ElementWithMutability` and then simply

```python
class FreeModuleTensor(ModuleElement, ElementWithMutability) 
```

This approach can also be applied to other elements. The hashablility can then be implemented via `ElementWithMutability`.

This has also the great advantage that this can be used for affine connections and bundle connections, too.



---

archive/issue_comments_424869.json:
```json
{
    "body": "`@`gh-mjungmath Did you see comment:8?",
    "created_at": "2020-07-31T06:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424869",
    "user": "https://github.com/tscrim"
}
```

`@`gh-mjungmath Did you see comment:8?



---

archive/issue_comments_424870.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> `@`gh-mjungmath Did you see comment:8?\n\nOh, I see. But is implementing the same code for each kind of element really necessary?",
    "created_at": "2020-07-31T07:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424870",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:15 tscrim]:
> `@`gh-mjungmath Did you see comment:8?

Oh, I see. But is implementing the same code for each kind of element really necessary?



---

archive/issue_comments_424871.json:
```json
{
    "body": "Replying to [comment:16 gh-mjungmath]:\n> Replying to [comment:15 tscrim]:\n> > `@`gh-mjungmath Did you see comment:8?\n\n> Oh, I see. But is implementing the same code for each kind of element really necessary? \n\nCython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.",
    "created_at": "2020-07-31T07:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424871",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:16 gh-mjungmath]:
> Replying to [comment:15 tscrim]:
> > `@`gh-mjungmath Did you see comment:8?

> Oh, I see. But is implementing the same code for each kind of element really necessary? 

Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.



---

archive/issue_comments_424872.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> Replying to [comment:16 gh-mjungmath]:\n> > Replying to [comment:15 tscrim]:\n> > > `@`gh-mjungmath Did you see comment:8?\n\n> > Oh, I see. But is implementing the same code for each kind of element really necessary? \n> \n> Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.\n\n\nReasonable point. Mh, that would mean, we need a seperate solution for scalar fields and connections, right?\n\nDo you have an opinion regarding the behavior of the tensor's names? I think that the names should be fixed as soon as the element is immutable.",
    "created_at": "2020-07-31T08:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424872",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:17 tscrim]:
> Replying to [comment:16 gh-mjungmath]:
> > Replying to [comment:15 tscrim]:
> > > `@`gh-mjungmath Did you see comment:8?

> > Oh, I see. But is implementing the same code for each kind of element really necessary? 
> 
> Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.


Reasonable point. Mh, that would mean, we need a seperate solution for scalar fields and connections, right?

Do you have an opinion regarding the behavior of the tensor's names? I think that the names should be fixed as soon as the element is immutable.



---

archive/issue_comments_424873.json:
```json
{
    "body": "Replying to [comment:18 gh-mjungmath]:\n> Replying to [comment:17 tscrim]:\n> > Replying to [comment:16 gh-mjungmath]:\n> > > Replying to [comment:15 tscrim]:\n> > > > `@`gh-mjungmath Did you see comment:8?\n\n> > > Oh, I see. But is implementing the same code for each kind of element really necessary? \n> > \n> > Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.\n\n> \n> Reasonable point. Mh, that would mean, we need a seperate solution for scalar fields and connections, right?\n\n\nPossibly, but it might suggest that you just need a better mixin class that is perhaps (a subclass of) `sage.structure.mutability`. I am not sure as you know the code better than I do. You can try experimenting and seeing what works best.\n\n> Do you have an opinion regarding the behavior of the tensor's names? I think that the names should be fixed as soon as the element is immutable.\n\n\nPart of me would want it to be mutable because I want to rename things, but the other part says that 0 should not be renamed. I would say because of that, (latex) names should be immutable.",
    "created_at": "2020-07-31T09:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424873",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:18 gh-mjungmath]:
> Replying to [comment:17 tscrim]:
> > Replying to [comment:16 gh-mjungmath]:
> > > Replying to [comment:15 tscrim]:
> > > > `@`gh-mjungmath Did you see comment:8?

> > > Oh, I see. But is implementing the same code for each kind of element really necessary? 
> > 
> > Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.

> 
> Reasonable point. Mh, that would mean, we need a seperate solution for scalar fields and connections, right?


Possibly, but it might suggest that you just need a better mixin class that is perhaps (a subclass of) `sage.structure.mutability`. I am not sure as you know the code better than I do. You can try experimenting and seeing what works best.

> Do you have an opinion regarding the behavior of the tensor's names? I think that the names should be fixed as soon as the element is immutable.


Part of me would want it to be mutable because I want to rename things, but the other part says that 0 should not be renamed. I would say because of that, (latex) names should be immutable.



---

archive/issue_comments_424874.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> Part of me would want it to be mutable because I want to rename things, but the other part says that 0 should not be renamed. I would say because of that, (latex) names should be immutable.\n\n\nThis is exactly the reason why I struggle, too.\n\nHowever, I think, the names should be set fixed when the element is immutable. At least, immutability means exactly this.\n\nMatthias, what do you say? Would you mind to add this condition here?\n\nAnyway, I would use your code as a template to apply the mutability changes to the `manifolds` module accordingly; also to fix #30239 \"more systematically\", as you said.",
    "created_at": "2020-07-31T10:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424874",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:19 tscrim]:
> Part of me would want it to be mutable because I want to rename things, but the other part says that 0 should not be renamed. I would say because of that, (latex) names should be immutable.


This is exactly the reason why I struggle, too.

However, I think, the names should be set fixed when the element is immutable. At least, immutability means exactly this.

Matthias, what do you say? Would you mind to add this condition here?

Anyway, I would use your code as a template to apply the mutability changes to the `manifolds` module accordingly; also to fix #30239 "more systematically", as you said.



---

archive/issue_comments_424875.json:
```json
{
    "body": "Replying to [comment:20 gh-mjungmath]:\n> However, I think, the names should be set fixed when the element is immutable. At least, immutability means exactly this.\n> \n> Matthias, what do you say?\n\n\nI feel I don't really have a qualified opinion on this because I have not studied how you use these symbolic names in sage-manifolds. \n\nThe vectors from `sage.modules` do not support renaming, so there's no concern regarding compatibility here.\n\n```\nsage: v = vector(QQ, [2, 3, 4])\nsage: v.rename('mangrove')\nNotImplementedError: object does not support renaming: (2, 3, 4)\n```\n\nNeither do elements of `CombinatorialFreeModule`.\n\n> Would you mind to add this condition here?\n\n\nI would prefer it if this could be done on follow-up tickets to keep this technical ticket small.\n\nThere are some more changes that you could consider: `vector` supports an optional argument `immutable`; and hashing of immutable tensors should be implemented.\n\n> Anyway, I would use your code as a template to apply the mutability changes to the `manifolds` module accordingly; also to fix #30239 \"more systematically\", as you said.\n\n\nGreat!",
    "created_at": "2020-07-31T12:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424875",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:20 gh-mjungmath]:
> However, I think, the names should be set fixed when the element is immutable. At least, immutability means exactly this.
> 
> Matthias, what do you say?


I feel I don't really have a qualified opinion on this because I have not studied how you use these symbolic names in sage-manifolds. 

The vectors from `sage.modules` do not support renaming, so there's no concern regarding compatibility here.

```
sage: v = vector(QQ, [2, 3, 4])
sage: v.rename('mangrove')
NotImplementedError: object does not support renaming: (2, 3, 4)
```

Neither do elements of `CombinatorialFreeModule`.

> Would you mind to add this condition here?


I would prefer it if this could be done on follow-up tickets to keep this technical ticket small.

There are some more changes that you could consider: `vector` supports an optional argument `immutable`; and hashing of immutable tensors should be implemented.

> Anyway, I would use your code as a template to apply the mutability changes to the `manifolds` module accordingly; also to fix #30239 "more systematically", as you said.


Great!



---

archive/issue_comments_424876.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> Replying to [comment:16 gh-mjungmath]:\n> > Replying to [comment:15 tscrim]:\n> > > `@`gh-mjungmath Did you see comment:8?\n\n> > Oh, I see. But is implementing the same code for each kind of element really necessary? \n> \n> Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.\n\n\nActually this is not quite true. One cannot do general mix-in classes with Cython.\nBut the following works:\n\n```\ndiff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py\nindex edb52ecd95..83883394f2 100644\n--- a/src/sage/manifolds/scalarfield.py\n+++ b/src/sage/manifolds/scalarfield.py\n@@ -40,12 +40,12 @@ REFERENCES:\n #                  https://www.gnu.org/licenses/\n # *****************************************************************************\n \n-from sage.structure.element import CommutativeAlgebraElement\n+from sage.structure.element import CommutativeAlgebraElement, ModuleElementWithMutability\n from sage.symbolic.expression import Expression\n from sage.manifolds.chart_func import ChartFunction\n \n \n-class ScalarField(CommutativeAlgebraElement):\n+class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):\n     r\"\"\"\n     Scalar field on a topological manifold.\n \n```\n\nThis works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.\n\n```\nsage: M = Manifold(2, 'M', structure='topological') # the 2-dimensional sphere S^2\nsage: U = M.open_subset('U') # complement of the North pole\nsage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole\nsage: g = U.scalar_field(x*y, chart=c_xy, name='g') ; g\nScalar field g on the Open subset U of the 2-dimensional topological manifold M\nsage: g.set_immutable()\nsage: g.is_immutable()\nTrue\n```",
    "created_at": "2020-07-31T12:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424876",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:17 tscrim]:
> Replying to [comment:16 gh-mjungmath]:
> > Replying to [comment:15 tscrim]:
> > > `@`gh-mjungmath Did you see comment:8?

> > Oh, I see. But is implementing the same code for each kind of element really necessary? 
> 
> Cython does not have multiple inheritance and you want the Sage vectors, which are Cython classes, to have this behavior. Since that structure is already there, the `FreeModuleTensor` should use it.


Actually this is not quite true. One cannot do general mix-in classes with Cython.
But the following works:

```
diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py
index edb52ecd95..83883394f2 100644
--- a/src/sage/manifolds/scalarfield.py
+++ b/src/sage/manifolds/scalarfield.py
@@ -40,12 +40,12 @@ REFERENCES:
 #                  https://www.gnu.org/licenses/
 # *****************************************************************************
 
-from sage.structure.element import CommutativeAlgebraElement
+from sage.structure.element import CommutativeAlgebraElement, ModuleElementWithMutability
 from sage.symbolic.expression import Expression
 from sage.manifolds.chart_func import ChartFunction
 
 
-class ScalarField(CommutativeAlgebraElement):
+class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):
     r"""
     Scalar field on a topological manifold.
 
```

This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.

```
sage: M = Manifold(2, 'M', structure='topological') # the 2-dimensional sphere S^2
sage: U = M.open_subset('U') # complement of the North pole
sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
sage: g = U.scalar_field(x*y, chart=c_xy, name='g') ; g
Scalar field g on the Open subset U of the 2-dimensional topological manifold M
sage: g.set_immutable()
sage: g.is_immutable()
True
```



---

archive/issue_comments_424877.json:
```json
{
    "body": "Replying to [comment:14 gh-mjungmath]:\n> What about a slighly more general approach like having a class `ElementWithMutability` \n\n\nI think I wouldn't like to push the mutability down to the level of `Element`. Mutating components is something that we traditionally do with \"vectors\". Other types of elements are traditionally immutable, and a functional style (creating new objects instead of mutating objects) is preferred.",
    "created_at": "2020-07-31T13:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424877",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:14 gh-mjungmath]:
> What about a slighly more general approach like having a class `ElementWithMutability` 


I think I wouldn't like to push the mutability down to the level of `Element`. Mutating components is something that we traditionally do with "vectors". Other types of elements are traditionally immutable, and a functional style (creating new objects instead of mutating objects) is preferred.



---

archive/issue_comments_424878.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> > Would you mind to add this condition here?\n\n> \n> I would prefer it if this could be done on follow-up tickets to keep this technical ticket small.\n\n\nThis makes sense.\n\n> There are some more changes that you could consider: `vector` supports an optional argument `immutable`; and hashing of immutable tensors should be implemented.\n\n\nThat's right. More importantly, connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.\n\nReplying to [comment:22 mkoeppe]: \n> Actually this is not quite true. One cannot do general mix-in classes with Cython.\n> But the following works:\n> \n> \n> ```\n> diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py\n> index edb52ecd95..83883394f2 100644\n> --- a/src/sage/manifolds/scalarfield.py\n> +++ b/src/sage/manifolds/scalarfield.py\n> @@ -40,12 +40,12 @@ REFERENCES:\n>  #                  https://www.gnu.org/licenses/\n>  # *****************************************************************************\n>  \n> -from sage.structure.element import CommutativeAlgebraElement\n> +from sage.structure.element import CommutativeAlgebraElement, ModuleElementWithMutability\n>  from sage.symbolic.expression import Expression\n>  from sage.manifolds.chart_func import ChartFunction\n>  \n>  \n> -class ScalarField(CommutativeAlgebraElement):\n> +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):\n>      r\"\"\"\n>      Scalar field on a topological manifold.\n>  \n> ```\n> \n> This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.\n> \n> \n> ```\n> sage: M = Manifold(2, 'M', structure='topological') # the 2-dimensional sphere S^2\n> sage: U = M.open_subset('U') # complement of the North pole\n> sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole\n> sage: g = U.scalar_field(x*y, chart=c_xy, name='g') ; g\n> Scalar field g on the Open subset U of the 2-dimensional topological manifold M\n> sage: g.set_immutable()\n> sage: g.is_immutable()\n> True\n> ```\n\n\nDo you think this is a reasonable way to go? I am afraid that potential changes in the intermediated classes might break this whole construct down...",
    "created_at": "2020-07-31T13:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424878",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:21 mkoeppe]:
> > Would you mind to add this condition here?

> 
> I would prefer it if this could be done on follow-up tickets to keep this technical ticket small.


This makes sense.

> There are some more changes that you could consider: `vector` supports an optional argument `immutable`; and hashing of immutable tensors should be implemented.


That's right. More importantly, connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.

Replying to [comment:22 mkoeppe]: 
> Actually this is not quite true. One cannot do general mix-in classes with Cython.
> But the following works:
> 
> 
> ```
> diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py
> index edb52ecd95..83883394f2 100644
> --- a/src/sage/manifolds/scalarfield.py
> +++ b/src/sage/manifolds/scalarfield.py
> @@ -40,12 +40,12 @@ REFERENCES:
>  #                  https://www.gnu.org/licenses/
>  # *****************************************************************************
>  
> -from sage.structure.element import CommutativeAlgebraElement
> +from sage.structure.element import CommutativeAlgebraElement, ModuleElementWithMutability
>  from sage.symbolic.expression import Expression
>  from sage.manifolds.chart_func import ChartFunction
>  
>  
> -class ScalarField(CommutativeAlgebraElement):
> +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):
>      r"""
>      Scalar field on a topological manifold.
>  
> ```
> 
> This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.
> 
> 
> ```
> sage: M = Manifold(2, 'M', structure='topological') # the 2-dimensional sphere S^2
> sage: U = M.open_subset('U') # complement of the North pole
> sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
> sage: g = U.scalar_field(x*y, chart=c_xy, name='g') ; g
> Scalar field g on the Open subset U of the 2-dimensional topological manifold M
> sage: g.set_immutable()
> sage: g.is_immutable()
> True
> ```


Do you think this is a reasonable way to go? I am afraid that potential changes in the intermediated classes might break this whole construct down...



---

archive/issue_comments_424879.json:
```json
{
    "body": "Replying to [comment:24 gh-mjungmath]:\n> connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.\n\n\nYes, I think this is a defect.\n\n> Replying to [comment:22 mkoeppe]: \n> > {{{\n> > diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py\n> > -class ScalarField(CommutativeAlgebraElement):\n> > +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):\n> > }}}\n> > \n> > This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.\n\n> \n> Do you think this is a reasonable way to go?\n\n\nYes. But actually - should an `AffineConnection` not be an element of some module too? \n\n> I am afraid that potential changes in the intermediated classes might break this whole construct down...\n\n\nDon't worry about this. It would be highly controversial to add additional slots to these classes.",
    "created_at": "2020-07-31T13:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424879",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 gh-mjungmath]:
> connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.


Yes, I think this is a defect.

> Replying to [comment:22 mkoeppe]: 
> > {{{
> > diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py
> > -class ScalarField(CommutativeAlgebraElement):
> > +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):
> > }}}
> > 
> > This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.

> 
> Do you think this is a reasonable way to go?


Yes. But actually - should an `AffineConnection` not be an element of some module too? 

> I am afraid that potential changes in the intermediated classes might break this whole construct down...


Don't worry about this. It would be highly controversial to add additional slots to these classes.



---

archive/issue_comments_424880.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> Replying to [comment:24 gh-mjungmath]:\n> > connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.\n\n> \n> Yes, I think this is a defect.\n> \n> > Replying to [comment:22 mkoeppe]: \n> > > {{{\n> > > diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py\n> > > -class ScalarField(CommutativeAlgebraElement):\n> > > +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):\n> > > }}}\n> > > \n> > > This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.\n\n> > \n> > Do you think this is a reasonable way to go?\n\n> \n> Yes. But actually - should an `AffineConnection` not be an element of some module too? \n\n\nActually, on the second thought, I don't think that connections constitute a vector space. There is no zero element since this would contradict the Leibniz rule. Furthermore, in fact, only convex linear combinations are connections again.\n\nI wonder why `Mutability` does not inherit from `SageObject`. If it would, one could let connections directly inherit from `Mutability`. Is there a particular reason?",
    "created_at": "2020-07-31T14:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424880",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:25 mkoeppe]:
> Replying to [comment:24 gh-mjungmath]:
> > connections already support hashing even though they cannot be considered immutable. Strictly speaking, this is a defect.

> 
> Yes, I think this is a defect.
> 
> > Replying to [comment:22 mkoeppe]: 
> > > {{{
> > > diff --git a/src/sage/manifolds/scalarfield.py b/src/sage/manifolds/scalarfield.py
> > > -class ScalarField(CommutativeAlgebraElement):
> > > +class ScalarField(CommutativeAlgebraElement, ModuleElementWithMutability):
> > > }}}
> > > 
> > > This works because between none of the intermediate classes between `ModuleElement` and `CommutativeAlgebraElement` add slots.

> > 
> > Do you think this is a reasonable way to go?

> 
> Yes. But actually - should an `AffineConnection` not be an element of some module too? 


Actually, on the second thought, I don't think that connections constitute a vector space. There is no zero element since this would contradict the Leibniz rule. Furthermore, in fact, only convex linear combinations are connections again.

I wonder why `Mutability` does not inherit from `SageObject`. If it would, one could let connections directly inherit from `Mutability`. Is there a particular reason?



---

archive/issue_comments_424881.json:
```json
{
    "body": "Replying to [comment:26 gh-mjungmath]:\n> I wonder why `Mutability` does not inherit from `SageObject`. If it would, one could let connections directly inherit from `Mutability`. Is there a particular reason?\n\n\nHard to know. It was added in #14524. I don't know if it was ever used",
    "created_at": "2020-07-31T18:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424881",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:26 gh-mjungmath]:
> I wonder why `Mutability` does not inherit from `SageObject`. If it would, one could let connections directly inherit from `Mutability`. Is there a particular reason?


Hard to know. It was added in #14524. I don't know if it was ever used



---

archive/issue_comments_424882.json:
```json
{
    "body": "The invokation of `__init__` via `super()` here seems to cause some troubles on the level of manifolds. Anyway, I think the discussion can be closed and should be shifted to #30261. I will add the dependence.",
    "created_at": "2020-07-31T19:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424882",
    "user": "https://github.com/mjungmath"
}
```

The invokation of `__init__` via `super()` here seems to cause some troubles on the level of manifolds. Anyway, I think the discussion can be closed and should be shifted to #30261. I will add the dependence.



---

archive/issue_comments_424883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-07T19:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29944#issuecomment-424883",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077852.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-07T19:07:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29944",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29944#event-77852"
}
```
