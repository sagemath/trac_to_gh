# Issue 17498: runsnake() cleanup

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2015-02-05 16:34:25

CC:  ncohen

This ticket aims at cleaning `runsnake()` function to:
- update the installation documentation
- behave consistently with the state of the preparser


---

Comment by nbruin created at 2015-02-05 22:11:24

See also #14414. In fact, I'm inclined to close this ticket as "dupe" and address the issues mentioned here on that ticket.


---

Comment by tmonteil created at 2015-02-06 22:01:22

Changing status from new to needs_review.


---

Comment by tmonteil created at 2015-02-06 22:01:22

New commits:


---

Comment by tmonteil created at 2015-02-06 22:06:18

Replying to [comment:2 nbruin]:
> See also #14414. 

Thanks for the pointer, i did not see it.

> In fact, I'm inclined to close this ticket as "dupe" and address the issues mentioned here on that ticket.

This ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.


---

Comment by nbruin created at 2015-02-06 23:49:32

Replying to [comment:5 tmonteil]:
> This ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.

OK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.

In that case, you would need to do something along the lines of [http://trac.sagemath.org/ticket/14414#comment:23](http://trac.sagemath.org/ticket/14414#comment:23) because checking if runsnake is available and then invoking it in an inappropriate fashion is not an improvement. I have tested that the following works for me (the code on the #14414 comment needed some adjustments)

```
    ...
    import os, subprocess
    cProfile.runctx(preparse(command.lstrip().rstrip()), get_main_globals(), locals(), filename=tmpfile)
    if os.path.exists(os.path.join(os.environ['SAGE_LOCAL'],'bin','runsnake')):
        subprocess.call(["runsnake",tmpfile])
    else:
        os.system("""sh -c "
          LD_LIBRARY_PATH=$SAGE_ORIG_LD_LIBRARY_PATH; export LD_LIBRARY_PATH
          if [ `uname` = 'Darwin' ]; then
              DYLD_LIBRARY_PATH=$SAGE_ORIG_DYLD_LIBRARY_PATH
          fi
          unset PYTHONHOME
          unset PYTHONPATH
          runsnake %s
        "    
        """%tmpfile)

```

I really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.

Failure depends on `/usr/bin/python` and `$SAGE_LOCAL/bin/python` being binary incompatible, so this is something that needs to be tested on a bunch of platforms.

I can help testing/reviewing if you're ok with that approach (but we need to test on multiple platforms).


---

Comment by tmonteil created at 2015-02-08 11:25:14

Replying to [comment:6 nbruin]:
> OK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.

Why not.

> I really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.

I like the `sage-native-execute` approach of Jeroen since it solves the issue for other similar calls, and i wonder whether we could also take the opportunity to also reset the `PATH` to `$SAGE_ORIG_PATH` there.


---

Comment by nbruin created at 2015-02-16 16:10:52

Changing status from needs_review to needs_work.


---

Comment by nbruin created at 2015-02-16 16:10:52

Setting #9386 as a dependency, since that now offers a saner `sage-native-execute`. Branch here needs rebasing, by the way. Otherwise, should be good to go. It's probably easiest to rebase on #14414 right away, since that already has the rather small fix in place to properly run `runsnake` either installed in `SAGE_LOCAL` or via `sage-native-execute`.


---

Comment by nbruin created at 2015-02-16 21:19:38

Looking at the implementation of sage.misc.sage_ostools.have_program, we might want to change:

```diff
-           if os.access(os.path.join(p, program), os.X_OK):
+           pth=os.path.join(p, program)
+           if os.path.isfile(pth) and os.access(pth, os.X_OK):
```

since `os.access(..., os.X_OK)` might return true for a directory and yet this would not be picked up as an executable by the operating system.
