# Issue 27055: aligned_malloc and realloc for MemoryAllocator

archive/issues_027055.json:
```json
{
    "body": "Adding realloc and aligned_alloc to `MemoryAllocator`.\n\n`realloc` is available in `cysignals.memory` anyway, so we might as well have it in `MemoryAllocator`.\n\n`aligned_malloc` is useful for intrinsics, when memory up to 64-byte aligned is required. There are also similar functions in C, but its nice to have the memory taken care of by `MemoryAllocator`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27292\n\n",
    "created_at": "2019-02-15T11:13:33Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "title": "aligned_malloc and realloc for MemoryAllocator",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27055",
    "user": "@kliem"
}
```
Adding realloc and aligned_alloc to `MemoryAllocator`.

`realloc` is available in `cysignals.memory` anyway, so we might as well have it in `MemoryAllocator`.

`aligned_malloc` is useful for intrinsics, when memory up to 64-byte aligned is required. There are also similar functions in C, but its nice to have the memory taken care of by `MemoryAllocator`.

Issue created by migration from https://trac.sagemath.org/ticket/27292





---

archive/issue_comments_381135.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-15T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381135",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_381136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-15T15:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381136",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381137.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-15T15:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381137",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381138.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-15T15:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381138",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_381139.json:
```json
{
    "body": "This is mostly looking good. Just a few comments:\n\n1. Can you also add `aligned_allocarray` and maybe `aligned_calloc` for completeness?\n\n2. You could actually consider implementing the non-aligned functions as special case of the aligned functions.\n\n3. You could add a small inline helper function (in the `.pxd` file) to implement the \"lookup the pointer for realloc\" feature. In that helper function, it would also be useful to support the special case of reallocating a `NULL` pointer, which would then work like a normal allocation.\n\n4. What's the point of `cdef size_t align = alignment`\n\n5. Add a test for the pointer-not-found case of `realloc`\n\n6. Use Python 3 compatible `print()` syntax.\n\n7. Remove the superfluous blank lines at the end of docstrings and use normal `\"` quotes for exceptions.",
    "created_at": "2019-02-15T17:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381139",
    "user": "jdemeyer"
}
```

This is mostly looking good. Just a few comments:

1. Can you also add `aligned_allocarray` and maybe `aligned_calloc` for completeness?

2. You could actually consider implementing the non-aligned functions as special case of the aligned functions.

3. You could add a small inline helper function (in the `.pxd` file) to implement the "lookup the pointer for realloc" feature. In that helper function, it would also be useful to support the special case of reallocating a `NULL` pointer, which would then work like a normal allocation.

4. What's the point of `cdef size_t align = alignment`

5. Add a test for the pointer-not-found case of `realloc`

6. Use Python 3 compatible `print()` syntax.

7. Remove the superfluous blank lines at the end of docstrings and use normal `"` quotes for exceptions.



---

archive/issue_comments_381140.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-15T17:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381140",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_381141.json:
```json
{
    "body": "While you're at it, could you move `enlarge_if_needed` to the `.pxd` file? It's more common to put such small `inline` functions in the `.pxd` file.",
    "created_at": "2019-02-15T17:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381141",
    "user": "jdemeyer"
}
```

While you're at it, could you move `enlarge_if_needed` to the `.pxd` file? It's more common to put such small `inline` functions in the `.pxd` file.



---

archive/issue_comments_381142.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-15T20:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381142",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381143.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-15T20:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381143",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_381144.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-16T20:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381144",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381145.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-17T07:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381145",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381146.json:
```json
{
    "body": "\n```\nReturns the index of ptr plus 1.\n```\n\nWhy the plus 1? Isn't that making it more complicated than it should be?",
    "created_at": "2019-02-20T08:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381146",
    "user": "jdemeyer"
}
```


```
Returns the index of ptr plus 1.
```

Why the plus 1? Isn't that making it more complicated than it should be?



---

archive/issue_comments_381147.json:
```json
{
    "body": "Instead of returning an index in `find_pointer`, it might be more natural to return a pointer, i.e. a `void**`",
    "created_at": "2019-02-20T08:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381147",
    "user": "jdemeyer"
}
```

Instead of returning an index in `find_pointer`, it might be more natural to return a pointer, i.e. a `void**`



---

archive/issue_comments_381148.json:
```json
{
    "body": "I'll work on this.",
    "created_at": "2019-02-20T08:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381148",
    "user": "jdemeyer"
}
```

I'll work on this.



---

archive/issue_comments_381149.json:
```json
{
    "body": "> {{{\n> Returns the index of ptr plus 1.\n> }}}\n> Why the plus 1? Isn't that making it more complicated than it should be?\n\nI wanted to reserve an except value. It turns out that -1 would work just as good and is more natural.\n\nThere are never `max_size_t -1` objects around.\n\nReplying to [comment:12 jdemeyer]:\n> Instead of returning an index in `find_pointer`, it might be more natural to return a pointer, i.e. a `void**`\n\nYes, indeed. I never thought about returning the actual place where the pointer is stored.",
    "created_at": "2019-02-20T08:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381149",
    "user": "@kliem"
}
```

> {{{
> Returns the index of ptr plus 1.
> }}}
> Why the plus 1? Isn't that making it more complicated than it should be?

I wanted to reserve an except value. It turns out that -1 would work just as good and is more natural.

There are never `max_size_t -1` objects around.

Replying to [comment:12 jdemeyer]:
> Instead of returning an index in `find_pointer`, it might be more natural to return a pointer, i.e. a `void**`

Yes, indeed. I never thought about returning the actual place where the pointer is stored.



---

archive/issue_comments_381150.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-20T10:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381150",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381151.json:
```json
{
    "body": "After seeing the code, I made some changes to the design, mainly to simplify things. I implemented `aligned_malloc()` (and similar) in terms of `malloc()` instead of the other way around.\n\nNeeds review.",
    "created_at": "2019-02-20T10:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381151",
    "user": "jdemeyer"
}
```

After seeing the code, I made some changes to the design, mainly to simplify things. I implemented `aligned_malloc()` (and similar) in terms of `malloc()` instead of the other way around.

Needs review.



---

archive/issue_comments_381152.json:
```json
{
    "body": "Doesn't `posix_memalign` do this? Is that not available on all supported platforms? If not, shouldn't we defer to posix_memalign when it is available?",
    "created_at": "2019-02-20T13:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381152",
    "user": "nbruin"
}
```

Doesn't `posix_memalign` do this? Is that not available on all supported platforms? If not, shouldn't we defer to posix_memalign when it is available?



---

archive/issue_comments_381153.json:
```json
{
    "body": "Replying to [comment:17 nbruin]:\n> Doesn't `posix_memalign` do this?\n\nWhat I don't like about `posix_memalign` is that it doesn't offer variants like `calloc` or `realloc`. This branch implements also `aligned_calloc` and we could (but don't for now) implement also `aligned_realloc`.",
    "created_at": "2019-02-20T13:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381153",
    "user": "jdemeyer"
}
```

Replying to [comment:17 nbruin]:
> Doesn't `posix_memalign` do this?

What I don't like about `posix_memalign` is that it doesn't offer variants like `calloc` or `realloc`. This branch implements also `aligned_calloc` and we could (but don't for now) implement also `aligned_realloc`.



---

archive/issue_comments_381154.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:17 nbruin]:\n> > Doesn't `posix_memalign` do this?\n> \n> What I don't like about `posix_memalign` is that it doesn't offer variants like `calloc`\n\ncalloc functionality would be trivial to build on top of posix_memalign: a simply API conversion and zero out the memory block.\n\n> or `realloc`. This branch implements also `aligned_calloc` and we could (but don't for now) implement also `aligned_realloc`.\n\nIndeed, `realloc` in some cases might be more efficient because it could happen that the memory block doesn't need to be moved. Otherwise, a \"malloc-memcpy-free\" would do the same, so posix_memalign could be used as a primitive as well.\n\nIt looks to me you're paying a rather hefty penalty with the current design:\n* you are wasting \"alignment -1\" memory for each allocation\n* you are incurring overhead for storing pointers and looking them up in order to free the memory blocks.\nA good implementation of posix_memalign that can work with the internals of the system malloc should be able to avoid both in most cases.\n\nI doubt that the occasional \"realloc\" that might be satisfied without relocating the memory block will be worth paying the other penalties all the time.",
    "created_at": "2019-02-20T14:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381154",
    "user": "nbruin"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 nbruin]:
> > Doesn't `posix_memalign` do this?
> 
> What I don't like about `posix_memalign` is that it doesn't offer variants like `calloc`

calloc functionality would be trivial to build on top of posix_memalign: a simply API conversion and zero out the memory block.

> or `realloc`. This branch implements also `aligned_calloc` and we could (but don't for now) implement also `aligned_realloc`.

Indeed, `realloc` in some cases might be more efficient because it could happen that the memory block doesn't need to be moved. Otherwise, a "malloc-memcpy-free" would do the same, so posix_memalign could be used as a primitive as well.

It looks to me you're paying a rather hefty penalty with the current design:
* you are wasting "alignment -1" memory for each allocation
* you are incurring overhead for storing pointers and looking them up in order to free the memory blocks.
A good implementation of posix_memalign that can work with the internals of the system malloc should be able to avoid both in most cases.

I doubt that the occasional "realloc" that might be satisfied without relocating the memory block will be worth paying the other penalties all the time.



---

archive/issue_comments_381155.json:
```json
{
    "body": "Replying to [comment:19 nbruin]:\n> calloc functionality would be trivial to build on top of posix_memalign: a simply API conversion and zero out the memory block.\n\nIt's a common misconception that `calloc` is just `malloc` + `memset`. This is not true in the case of memory allocated with `mmap` (which is typically used for large allocations): the memory is already pre-zeroed by the OS so there is no need to zero it a second time. In fact, zeroing it a second time implies actually bringing in physical memory for that region, which is not needed when doing just a `mmap`. This is especially bad when not all the allocated is eventually used.\n\n> * you are wasting \"alignment -1\" memory for each allocation\n\nIndeed, this is a penalty to pay. But if the alignment value is relatively small to the size of the allocation (which I expect to be the typical case), then it doesn't matter so much.\n\n> * you are incurring overhead for storing pointers and looking them up in order to free the memory blocks.\n\nWe're already doing that in `MemoryAllocator` before this ticket. So it's not worse than other usages of `MemoryAllocator` in that sense.",
    "created_at": "2019-02-20T15:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381155",
    "user": "jdemeyer"
}
```

Replying to [comment:19 nbruin]:
> calloc functionality would be trivial to build on top of posix_memalign: a simply API conversion and zero out the memory block.

It's a common misconception that `calloc` is just `malloc` + `memset`. This is not true in the case of memory allocated with `mmap` (which is typically used for large allocations): the memory is already pre-zeroed by the OS so there is no need to zero it a second time. In fact, zeroing it a second time implies actually bringing in physical memory for that region, which is not needed when doing just a `mmap`. This is especially bad when not all the allocated is eventually used.

> * you are wasting "alignment -1" memory for each allocation

Indeed, this is a penalty to pay. But if the alignment value is relatively small to the size of the allocation (which I expect to be the typical case), then it doesn't matter so much.

> * you are incurring overhead for storing pointers and looking them up in order to free the memory blocks.

We're already doing that in `MemoryAllocator` before this ticket. So it's not worse than other usages of `MemoryAllocator` in that sense.



---

archive/issue_comments_381156.json:
```json
{
    "body": "Replying to [comment:19 nbruin]:\n> Otherwise, a \"malloc-memcpy-free\" would do the same\n\nSimilarly, for large allocations `mremap` would be used which doesn't need to do any copying, even if the allocation address moves.",
    "created_at": "2019-02-20T15:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381156",
    "user": "jdemeyer"
}
```

Replying to [comment:19 nbruin]:
> Otherwise, a "malloc-memcpy-free" would do the same

Similarly, for large allocations `mremap` would be used which doesn't need to do any copying, even if the allocation address moves.



---

archive/issue_comments_381157.json:
```json
{
    "body": "To me, this looks fine and good to go. But I am a newbie.",
    "created_at": "2019-02-20T16:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381157",
    "user": "@kliem"
}
```

To me, this looks fine and good to go. But I am a newbie.



---

archive/issue_comments_381158.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-22T00:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381158",
    "user": "nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_381159.json:
```json
{
    "body": "Looks OK to me too. It would seem to me the allocator could use a \"free\" too, but that's perhaps something for another ticket (and perhaps doesn't come up in its applications).",
    "created_at": "2019-02-22T00:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381159",
    "user": "nbruin"
}
```

Looks OK to me too. It would seem to me the allocator could use a "free" too, but that's perhaps something for another ticket (and perhaps doesn't come up in its applications).



---

archive/issue_comments_381160.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-23T23:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27055#issuecomment-381160",
    "user": "vbraun"
}
```

Resolution: fixed
