# Issue 30707: tox: Improve local-sudo-ubuntu-standard

Issue created by migration from https://trac.sagemath.org/ticket/30944

Original creator: @tobiasdiez

Original creation time: 2020-11-22 17:52:52

CC:  mkoeppe dimpase @kliem

As a follow up to #30923, we improve the `local-sudo-ubuntu-standard` environment as follows:
- Remove `sudo` requirement (which is not installed on github actions and not needed there)
- Add `DEBIAN_FRONTEND: noninteractive` to the installation of packages via `apt get` (otherwise installation of `tzdata` blocks CI)
- Make `tox -e local-sudo-standard -- config.status` stop after `configure` (and don't run `make`)
- Enable `--enable-build-as-root` for tox (Tobias: not sure about this one)


---

Comment by mkoeppe created at 2020-11-22 19:52:35

The variant could be called `local-root-ubuntu-standard`, I guess


---

Comment by mkoeppe created at 2020-11-22 20:13:14

Replying to [ticket:30944 gh-tobiasdiez]:
> - Make `tox -e local-sudo-standard -- config.status` stop after `configure` (and don't run `make`)

Right, I forgot about the mess with `TARGETS_PRE` and `TARGETS_OPTIONAL` in `tox.ini`, which do not get the same defaults for `local` as they do for `docker` - I'll fix this
----
New commits:


---

Comment by mkoeppe created at 2020-11-24 05:52:47

Replying to [comment:1 mkoeppe]:
> The variant could be called `local-root-ubuntu-standard`, I guess
Adding this in #29124


---

Comment by mkoeppe created at 2020-11-24 18:41:20

Replying to [gh-tobiasdiez in #29124](https://trac.sagemath.org/ticket/29124?replyto=22#comment:22):
> I'm not sure about the naming of the `local-` environments. Why should I expect as a developer that `local-sudo` installs system packages? What about `local-system-packages-ubuntu` (for root) and `local-sudo-system-packages-ubuntu` (for sudo)?
All of these environments install system packages... The only one that does not is `local-direct`


---

Comment by @tobiasdiez created at 2020-11-25 16:31:26

Ah ok...than it makes sense.


---

Comment by git created at 2020-11-25 22:01:59

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-11-25 22:14:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-25 22:34:03

To simplify the build rule for `local`, the next step is to do #30721 so we can eliminate the separate `make base-toolchain` step.


---

Comment by git created at 2020-11-25 22:35:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-26 05:11:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-26 05:12:59

Replying to [comment:13 mkoeppe]:
> To simplify the build rule for `local`, the next step is to do #30721 so we can eliminate the separate `make base-toolchain` step.
Well, I'll work on that another time. For now I have implemented it in a different way, special casing on "config*" targets.


---

Comment by mkoeppe created at 2020-11-26 05:12:59

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-11-26 08:26:36

Thanks! Looks good to me, as far as I understand the changes.

Just to make sure:
> Make tox -e local-sudo-standard -- config.status stop after configure

Is fixed as well?


---

Comment by mkoeppe created at 2020-11-26 18:32:31

Replying to [comment:17 gh-tobiasdiez]:
> Thanks! Looks good to me, as far as I understand the changes.
> 
> Just to make sure:
> > Make tox -e local-sudo-standard -- config.status stop after configure
> 
> Is fixed as well?

Yes. This is what I meant in the previous comment - "special casing on `config*` targets"


---

Comment by @tobiasdiez created at 2020-11-26 20:57:22

Replying to [comment:18 mkoeppe]:
> Replying to [comment:17 gh-tobiasdiez]:
> > Thanks! Looks good to me, as far as I understand the changes.
> > 
> > Just to make sure:
> > > Make tox -e local-sudo-standard -- config.status stop after configure
> > 
> > Is fixed as well?
> 
> Yes. This is what I meant in the previous comment - "special casing on `config*` targets"

Ok, then is good! Me with my limited bash knowledge thought that the final `make` that builds the sage packages is still invoked even though `-- config.status` is specified.


---

Comment by mkoeppe created at 2020-11-26 21:32:52

It's only invoked on nonempty `$TARGETS_OPTIONAL`


---

Comment by @tobiasdiez created at 2020-12-02 20:41:38

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-12-02 20:41:38

Running `tox -e local-sudo-ubuntu-standard -- SAGE_NUM_THREADS=16 build` (in WLS) yields

```
Reading package lists... Done
E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)
E: Unable to lock directory /var/lib/apt/lists/
W: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)
W: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)
ERROR: InvocationError for command /usr/bin/bash -c '$(build/bin/sage-print-system-package-command debian update) #' (exited with code 100)
```

Running the same command with sudo is successful, so I guess a `--sudo` is missing somewhere.


Moreover, `./bootstrap` didn't run with following error:

```
/mnt/d/Programming/sage/src/bin/sage-env: line 133: cd: /mnt/d/Programming/Projects/sage: No such file or directory
Warning: overwriting SAGE_ROOT environment variable:
Old SAGE_ROOT=/mnt/d/Programming/Projects/sage
New SAGE_ROOT=
Error: You must set either the SAGE_LOCAL or SAGE_SCRIPTS_DIR environment variable to run this
Error setting environment variables by sourcing '/mnt/d/Programming/sage/src/bin/sage-env';
possibly contact sage-devel (see http://groups.google.com/group/sage-devel).
```

until I deleted src/bin/sage-env manually. And the root version `sudo tox -e local-root-ubuntu-standard -- SAGE_NUM_THREADS=10 build` yields

```
local-root-ubuntu-standard run-test: commands[2] | bash -c 'PACKAGES=$(build/bin/sage-get-system-packages debian $(PATH=build/bin:$PATH build/bin/sage-package list --has-file=spkg-configure.m4 :standard:) _bootstrap); $(build/bin/sage-print-system-package-command debian  --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" '
/usr/bin/bash: DEBIAN_FRONTEND=noninteractive: command not found
ERROR: InvocationError for command /usr/bin/bash -c 'PACKAGES=$(build/bin/sage-get-system-packages debian $(PATH=build/bin:$PATH build/bin/sage-package list --has-file=spkg-configure.m4 :standard:) _bootstrap); $(build/bin/sage-print-system-package-command debian  --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ' (exited with code 1)
```



---

Comment by git created at 2020-12-02 21:48:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-03 01:08:59

Replying to [comment:21 gh-tobiasdiez]:
> Moreover, `./bootstrap` didn't run with following error:
> {{{
> /mnt/d/Programming/sage/src/bin/sage-env: line 133: cd: /mnt/d/Programming/Projects/sage: No such file or directory
> Warning: overwriting SAGE_ROOT environment variable:
> Old SAGE_ROOT=/mnt/d/Programming/Projects/sage
> New SAGE_ROOT=
> Error: You must set either the SAGE_LOCAL or SAGE_SCRIPTS_DIR environment variable to run this
> Error setting environment variables by sourcing '/mnt/d/Programming/sage/src/bin/sage-env';
> possibly contact sage-devel (see http://groups.google.com/group/sage-devel).
> }}}
> until I deleted src/bin/sage-env manually.

This is fixed by #22731, I think. I'll merge it


---

Comment by git created at 2020-12-03 01:09:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-03 01:14:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-03 01:14:43

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-06 21:49:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-06 21:49:57

Rebased on top of 9.3.beta3 and rebased #29124


---

Comment by git created at 2020-12-10 06:41:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-16 23:27:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-16 23:27:55

Merged newest version of #29124. Still needs review


---

Comment by mkoeppe created at 2020-12-29 00:16:26

Changing priority from major to critical.


---

Comment by git created at 2020-12-29 19:13:14

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-29 19:13:32

Merged newest #29124, needs review


---

Comment by mkoeppe created at 2021-01-06 19:14:02

Let's get this in please (dependency of #31064 and #31099)


---

Comment by @kliem created at 2021-01-06 20:04:00

I think #29124 isn't merged completely.


---

Comment by @kliem created at 2021-01-06 20:28:42

What does


```diff
+    local:             case "{posargs:}" in \
+    local:                 config*) ;; \
+    local:                 *)       make -k V=0 base-toolchain ;; \
+    local:             esac && \
-    local:                     make -k V=0 base-toolchain && \
```


do? (That is not the diff, but I think morally it is.)


---

Comment by mkoeppe created at 2021-01-06 20:41:58

It implements the last bullet point of the ticket description: 
When something like `config.status` is given as the target, `make base-toolchain` should not be run.


---

Comment by @kliem created at 2021-01-06 20:43:45

Thanks. But does it stop then or are the other things still run?:


```diff
+    local:             make -k V=0 SAGE_SPKG="sage-spkg -y -o" SAGE_CHECK=warn SAGE_CHECK_PACKAGES="!cython,!r,!python3,!nose,!gap,!cysignals,!linbox,!git,!ppl,!cmake,!networkx,!symengine_py" {env:TARGETS_PRE:} {posargs:build} && \
+    local:             ([ -z "{env:TARGETS_OPTIONAL:}" ] || make -k V=0 SAGE_SPKG="sage-spkg -y -o" SAGE_CHECK=warn SAGE_CHECK_PACKAGES="!cython,!r,!python3,!nose,!gap,!cysignals,!linbox,!git,!ppl,!cmake" {env:TARGETS_OPTIONAL:} || echo "(error ignored)" ) '
 }}}


---

Comment by mkoeppe created at 2021-01-06 21:29:26

I have reworded the ticket description to clarify it.


---

Comment by @kliem created at 2021-01-07 06:08:13

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-07 06:08:13

LGTM.


---

Comment by mkoeppe created at 2021-01-07 06:36:04

Thank you!


---

Comment by vbraun created at 2021-01-24 10:38:10

Resolution: fixed
