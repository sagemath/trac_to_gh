# Issue 11275: python spkg build fails on Ubuntu 11.04 derivative Mint 11

Issue created by migration from https://trac.sagemath.org/ticket/11447

Original creator: pipedream

Original creation time: 2011-06-08 04:28:43

Assignee: GeorgSWeber

CC:  drkirkby jpflori

Linux Mint 11 fails to build python.

This is a known issue in #11243 on Ubuntu 11.04, and any derivatives such as Mint 11 will suffer from this as well.

A patch will follow shortly to change the #11243 patch to also apply on Linux Mint 11.


---

Attachment

Patch for building crypt module on Linux Mint 11


---

Comment by pipedream created at 2011-06-08 04:48:00

Changing status from new to needs_review.


---

Comment by pipedream created at 2011-06-08 04:48:00

Please test http://users.aims.ac.za/~jan/python-2.6.4.p11.spkg
on Ubuntu 11.04, Linux Mint 11, and other systems.

( Dave: I changed a grep to egrep. Is this POSIX? Is grep -E better?
Is splitting it into two separate greps better? )


---

Comment by pipedream created at 2011-06-08 04:48:16

Changing assignee from GeorgSWeber to pipedream.


---

Comment by kcrisman created at 2011-06-08 18:50:35

Jan, if you want to make sure someone sees a ticket, you will need to cc: them like I am doing with drkirkby now.

You could also put the person for whom it worked properly (as you mentioned on sage-devel) as a reviewer - why not?  They helped, after all, even if they can't check that the code is fine (which it certainly seems to me, but I don't know what etc/issue is for sure).


---

Comment by drkirkby created at 2011-06-08 22:49:27

Changing status from needs_review to needs_work.


---

Comment by drkirkby created at 2011-06-08 22:49:27

These should not be two '|' characters in the egrep expression. 



```
drkirkby@hawk:~$ echo foo | egrep "Ubuntu 11.04||Linux Mint 11 Katya"
egrep: syntax error
drkirkby@hawk:~$ 
```


There should be only one. 

You also need to create a new package, so we can test the complete package, but this looks pretty simple to me. 

It would be good if we could attempt to find other popular Ubuntu derivatives that will get the problem and include the patch for them too. But that's not important - just nice if possible to do easily. 

Dave


---

Comment by pipedream created at 2011-06-09 04:29:29

Changing status from needs_work to needs_review.


---

Comment by pipedream created at 2011-06-09 04:29:29

Thanks Dave, new patch following. I made a typo with the pipe, but it 
did not throw a syntax error on Ubuntu (I think it parsed 
"Ubuntu 11.04" or "" or "Linux Mint 11 Katya". The empty string matched
every line though which is another problem. This is however why
the spkg compiled properly for the Linux Mint tester/reviewer.

I'm not sure he has a trac account (for reviewing).

New patch attached for review purposes, and spkg at 
http://users.aims.ac.za/~jan/python-2.6.4.p11.spkg


---

Comment by pipedream created at 2011-06-09 04:30:17

Replaces previous patch to build on Linux Mint 11


---

Attachment

> I'm not sure he has a trac account (for reviewing).

What I meant was that you could put his name down as a reviewer, assuming you do not have actual access to a Mint machine and neither does David.


---

Comment by pipedream created at 2011-06-09 16:55:14

Bill Odefey reports that the new spkg worked for him again on Linux Mint 11.


---

Comment by drkirkby created at 2011-06-10 11:22:22

egrep is not a POSIX command, but I think in this instance it is acceptable to use it. 

The use of 'grep -E' confirms to the latest POSIX, but would fail on Solaris if someone has /usr/bin in their path before /usr/xpg4/bin. This is because to maintain backwards compatibility with older Solaris releases, whilst still conforming to the various POSIX versions, there are two or sometimes three versions of some commands on Solaris. 

More portable would be to split the two greps up, but I think that would unnecessarily complicate things.

Positive review.


---

Comment by drkirkby created at 2011-06-10 11:22:22

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-06-14 21:02:54

Looking at `/etc/issue` is a _very bad_ way of checking the system.  This is a file which is sometimes customized by system administrators.  You should try to understand _why_ Python doesn't build on such a system and check for the true cause.


---

Comment by pipedream created at 2011-06-15 05:18:49

Yes, it is hidden in the original thread which lead to ticket #11243.
http://trac.sagemath.org/sage_trac/ticket/11243
http://groups.google.com/group/sage-devel/browse_thread/thread/593b9a4124f5075d

If the way to check for Linux Release/Distribution it is suboptimal, do you know of a better way?
(It is a patch that Debian and Ubuntu and therefore all derivatives apply to their own python debs for python to build.)

It comes down to this http://bugs.python.org/issue9762 .
It may be fixed in python 2.7 http://hg.python.org/cpython/rev/bd0f73a9538e
but those are beyond my experience.


---

Comment by jdemeyer created at 2011-06-15 07:22:10

Replying to [comment:11 pipedream]:
> If the way to check for Linux Release/Distribution it is suboptimal, do you know of a better way?
Well, it is dead simple: *don't* check the Linux Release/Distribution.  Would it make sense to apply the workaround on all Linux systems or could that break things?


---

Comment by jdemeyer created at 2011-06-15 07:22:10

Changing status from positive_review to needs_work.


---

Comment by medlock created at 2011-06-17 04:31:55

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 pipedream]:
> > If the way to check for Linux Release/Distribution it is suboptimal, do you know of a better way?
> Well, it is dead simple: *don't* check the Linux Release/Distribution.  Would it make sense to apply the workaround on all Linux systems or could that break things?

The solution that's in Python 2.7 and in Debian's patches to Python 2.6 (patch deb-setup.diff attached) is to use `dpkg-architecture -qDEB_HOST_MULTIARCH`.  These packages use this command to set the library paths correctly.

This requires that the optional package dpkg-dev is installed.  A wrapper should probably be written that complains if `lsb_release -i` is (Debian|Ubuntu|Mint) and `dpkg-architecture` is not present, otherwise the build will fail without the user knowing why...


---

Comment by medlock created at 2011-06-17 04:33:47

Replying to [comment:13 medlock]:
> ...
> The solution that's in Python 2.7 and in Debian's patches to Python 2.6 (patch deb-setup.diff attached) is to use `dpkg-architecture -qDEB_HOST_MULTIARCH`.  These packages use this command to set the library paths correctly.
> 
> This requires that the optional package dpkg-dev is installed.  A wrapper should probably be written that complains if `lsb_release -i` is (Debian|Ubuntu|Mint) and `dpkg-architecture` is not present, otherwise the build will fail without the user knowing why...

All this can get ripped out when Sage upgrades to Python 2.7, where this issue is fixed...


---

Comment by medlock created at 2011-06-17 04:35:25

Debian patch to Python 2.6 to fix paths


---

Attachment

Replying to [comment:14 medlock]:
> Replying to [comment:13 medlock]:
> > ...
> > The solution that's in Python 2.7 and in Debian's patches to Python 2.6 (patch deb-setup.diff attached) is to use `dpkg-architecture -qDEB_HOST_MULTIARCH`.  These packages use this command to set the library paths correctly.
> > 
> > This requires that the optional package dpkg-dev is installed.  A wrapper should probably be written that complains if `lsb_release -i` is (Debian|Ubuntu|Mint) and `dpkg-architecture` is not present, otherwise the build will fail without the user knowing why...
> 
> All this can get ripped out when Sage upgrades to Python 2.7, where this issue is fixed...

See also [http://lists.debian.org/debian-devel/2011/06/msg00431.html](http://lists.debian.org/debian-devel/2011/06/msg00431.html).


---

Comment by pipedream created at 2011-06-17 06:25:13

Note that in #11243 we realised lsb_release does not work -- it tries to import an underlying system python package; but SAGE spkg installs run in a SAGE python environment and does not know
the path to import lsb_release. That is why we switched to check whether /etc/issue exists, and then to use that. 

It is a good question whether the patch to use -lcrypt will break other Linux distros? Then a standard uname check for Linux could be used and the patch applied on all Linux patched while SAGE still uses python 2.6.

What is the timeline for SAGE to get to python 2.7?


---

Attachment

Patch to python-2.6.4.p10.spkg to fix multiarch build.  Solution copied from Python 2.7.


---

Comment by medlock created at 2011-06-17 23:26:00

11447-Python-Debian-multiarch.patch uses the solution from Python 2.7 to fix build on Debian and derivatives with multiarch.

The patch to python-2.6.4.p10/src/setup.py is applied on all hosts, not just Debian and derivatives, but the new code will end up doing nothing on non-Debian-derived hosts.  This is how the build is set up in Python 2.7.

Note that on Debian and derivatives, if the command dpkg-architecture, from the package dpkg-dev, is not available, the build will fail as before.  Again, this is how Python 2.7 is set up.

This looks like the best solution to me.


---

Comment by pipedream created at 2011-06-18 10:09:47

Changing status from needs_work to needs_review.


---

Comment by pipedream created at 2011-06-18 10:09:47

Looks good to me. This does mean -lcrypt in Setup.dist is uncommented on all
systems, Debian or not, Linux or not. Does that have unintended side effects?


---

Comment by medlock created at 2011-06-18 17:04:50

Replying to [comment:18 pipedream]:
> Looks good to me. This does mean -lcrypt in Setup.dist is uncommented on all
> systems, Debian or not, Linux or not. Does that have unintended side effects?

No, -lcrypt is not uncommented in Setup.dist on any system.

The library search directories are now set up in setup.py on Debian and derivatives to correctly find libcrypt automatically.  There is no change to the library search directories on other systems.  This is done by testing for the presence of the command 'dpkg-architecture'.

I don't see any side effects and this is how it is done in Python 2.7.

(Setup.dist is a work around for setup.py not automatically finding the libraries.)


---

Comment by leif created at 2011-07-01 12:53:41

Changing status from needs_review to needs_work.


---

Comment by leif created at 2011-07-01 12:53:41

Changing keywords from "" to "crypt library".


---

Comment by leif created at 2011-07-01 12:53:41

Replying to [comment:17 medlock]:
> The patch to python-2.6.4.p10/src/setup.py is applied on all hosts, not just Debian and derivatives, but the new code will end up doing nothing on non-Debian-derived hosts.  This is how the build is set up in Python 2.7.

Just to make it a bit clearer: The code also doesn't change the search paths on _older Debian / Ubuntu systems_, regardless if `dpkg-architecture` is installed or not, so won't break anything there.

(Tested with Ubuntu 9.04 and 10.04; `dpkg-architecture` there doesn't know `DEB_HOST_MULTIARCH` and therefore exits with a non-zero status such that nothing gets added to the paths.)




> Note that on Debian and derivatives, if the command `dpkg-architecture`, from the package dpkg-dev, is not available, the build will fail as before.

Again, of course the build will only fail on _newer_ Debian derivatives which require a change (more precisely: additions) to the search paths.

----

Could someone please update the p11 / provide a new p11 spkg (by applying only [attachment:11447-Python-Debian-multiarch.patch] to p10 I guess)?

*http://users.aims.ac.za/~jan/python-2.6.4.p11.spkg (and also the ticket description) is not current.*


---

Comment by leif created at 2011-07-01 13:24:39

P.S.:

I think if the test importing the `crypt` module (in `spkg-install`) fails and `dpkg-architecture` isn't installed, the user should get a hint on installing it (i.e., `dpkg-dev`; maybe only on newer Debian derivatives, but this could also just be part of the message.)

Otherwise we should at least document this in the Sage Installation Guide, and perhaps also on one of the wiki pages.


---

Comment by leif created at 2011-07-01 15:28:53

Changing status from needs_work to needs_review.


---

Comment by leif created at 2011-07-01 15:28:53

Replying to [comment:22 leif]:
> Could someone please update the p11 / provide a new p11 spkg (by applying only [attachment:11447-Python-Debian-multiarch.patch] to p10 I guess)?
> 
> *http://users.aims.ac.za/~jan/python-2.6.4.p11.spkg (and also the ticket description) is not current.*


Ok, did it myself:

*Updated spkg: http://spkg-upload.googlecode.com/files/python-2.6.4.p11.spkg*

*md5sum:* `5bc63c1814fc7ae34f4fed5a8fffe380  python-2.6.4.p11.spkg`

(I haven't made any changes, just applied Jan Medlock's patch of June 17th.)


---

Comment by medlock created at 2011-07-01 16:24:24

Replying to [comment:22 leif]:
> Replying to [comment:17 medlock]:
> > The patch to python-2.6.4.p10/src/setup.py is applied on all hosts, not just Debian and derivatives, but the new code will end up doing nothing on non-Debian-derived hosts.  This is how the build is set up in Python 2.7.
> 
> Just to make it a bit clearer: The code also doesn't change the search paths on _older Debian / Ubuntu systems_, regardless if `dpkg-architecture` is installed or not, so won't break anything there.
> 
> (Tested with Ubuntu 9.04 and 10.04; `dpkg-architecture` there doesn't know `DEB_HOST_MULTIARCH` and therefore exits with a non-zero status such that nothing gets added to the paths.)
> 
> 

> 
> > Note that on Debian and derivatives, if the command `dpkg-architecture`, from the package dpkg-dev, is not available, the build will fail as before.
> 
> Again, of course the build will only fail on _newer_ Debian derivatives which require a change (more precisely: additions) to the search paths.
> 
> ----
> 
> Could someone please update the p11 / provide a new p11 spkg (by applying only [attachment:11447-Python-Debian-multiarch.patch] to p10 I guess)?
> 
> *http://users.aims.ac.za/~jan/python-2.6.4.p11.spkg (and also the ticket description) is not current.*

Thanks for the clarification.  I can confirm for the record that this is the intended behavior.


---

Comment by jdemeyer created at 2011-07-05 07:36:48

I will test the new package on the buildbots and give positive_review if these are successful.


---

Comment by jdemeyer created at 2011-07-05 07:38:36

Changing keywords from "crypt library" to "python spkg crypt library".


---

Comment by jdemeyer created at 2011-07-05 07:38:36

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2011-07-05 07:38:36

Changing component from build to packages.


---

Comment by leif created at 2011-07-05 07:55:12

Replying to [comment:27 jdemeyer]:
> I will test the new package on the buildbots and give positive_review if these are successful.

So adding a note on installing `dpkg-dev` to the "Known Issues" / wiki page(s) is sufficient? (I can't judge how common it is to _not_ have it installed.)

It's perhaps to specific to get into the Sage Installation Guide.


P.S.: You don't need to add keywords that are already in the ticket's title.


---

Comment by pipedream created at 2011-07-05 08:01:20

It would be great if the patch included a suggestion to "sudo apt-get install dpkg-dev" if it is not installed.


---

Comment by pipedream created at 2011-07-05 08:01:53

Changing assignee from pipedream to jdemeyer.


---

Comment by leif created at 2011-07-05 08:02:24

P.S.:

To detect Debian and any of its derivatives (in order to give an appropriate message if importing `crypt` fails) testing `command -v dpkg` should suffice.


---

Comment by leif created at 2011-07-05 09:07:35

Replying to [comment:30 pipedream]:
> It would be great if the patch included a suggestion to "sudo apt-get install dpkg-dev" if it is not installed.

Patch is on the way...

Cannot really test it myself though, as I have no newer Debian here.


---

Comment by leif created at 2011-07-05 09:51:33

SPKG patch. Adds message, some minor changes. Apply on top of Jan Medlock's patch.


---

Attachment

Patch is up. Relevant part:

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -242,12 +248,28 @@
 # All these modules are important and if any one 
 # fails to build, Sage will not work. 
 
+import_errors=false
 for module in math hashlib crypt ; do 
    "$SAGE_LOCAL/bin/python" -c "import $module"
    if [ $? -eq 0 ] ; then
       echo "$module module imported OK"
    else
-      echo "$module module failed to import"
-      exit 1
+      echo >&2 "$module module failed to import"
+      import_errors=true
+      # exit 1 # not yet
    fi
 done
+
+if $import_errors; then
+    echo >&2 "Error: One or more modules failed to import."
+    # Check if we are on Debian or one of its derivatives:
+    if command -v dpkg && ! command -v dpkg-architecture >/dev/null; then
+        echo >&2 "You may have to install 'dpkg-architecture'"
+        echo >&2 "which is part of the Debian package 'dpkg-dev'."
+        echo >&2 "Try installing it by typing"
+        echo >&2 "    sudo apt-get install dpkg-dev"
+        echo >&2 "and rerun 'make'."
+    fi
+    exit 1
+fi
```


*I haven't uploaded the new spkg to G**gle code yet.*

Maybe Jeroen wants to create it on `sage.math`. (My patch [attachment:trac_11447-give_hint_on_dpkg-dev.patch] is based on the p11 I previously uploaded.)


---

Comment by leif created at 2011-07-05 10:09:12

Ooops, I just noticed the output of `command -v dpkg` is not redirected. But IMHO negligible.


---

Comment by leif created at 2011-07-05 11:14:45

Replying to [comment:34 leif]:
> *I haven't uploaded the new spkg to G**gle code yet.*

Ok, will do now...


---

Comment by leif created at 2011-07-05 11:44:19

Replying to [comment:37 leif]:
> Replying to [comment:34 leif]:
> > *I haven't uploaded the new spkg to G**gle code yet.*
> 
> Ok, will do now...

Done. New `md5sum: e808dc5edba8c82c098f0c9641b34634` (Same name, same place.)


---

Comment by jdemeyer created at 2011-07-07 09:50:05

Messy in various places, but at least it improves over the existing version, so positive_review.


---

Comment by jdemeyer created at 2011-07-07 09:50:05

Changing status from needs_review to positive_review.


---

Comment by leif created at 2011-07-07 09:58:06

Replying to [comment:39 jdemeyer]:
> Messy in various places, 

Details, please. ;-)


---

Comment by jdemeyer created at 2011-07-07 10:15:39

Replying to [comment:40 leif]:
> Replying to [comment:39 jdemeyer]:
> Details, please. ;-)


```
if command -v dpkg && ! command -v dpkg-architecture >/dev/null; then
```

should be

```
if command -v dpkg >/dev/null && ! command -v dpkg-architecture >/dev/null; then
```

or

```
if ( command -v dpkg && ! command -v dpkg-architecture ) >/dev/null; then
```


Mixed usage of `cp` of `patch`, better always use `patch`.

On SunOS, you first patch `setup.py` and then copy a different version over it.

Patching is better done using one `for` loop to prevent an error-prone laundry list of patches to be applied.

Why call `./configure` with arguments `CC="$CC $CFLAGS" CXX="$CXX $CXXFLAGS"`?  Any why only on certain systems?


```
MAKE=make; export MAKE
make -i install
```

should be

```
$MAKE -j1 -i install
```


Remove this:

```
# Do not exit script if there is an error, but instead print an
# informative error message. This is helps in determining why the
# configuration, compilation or installation failed. So put this before the
# build() function.
set +e # This is redundant here, but doesn't hurt to keep it... ;-)
```


Why this:

```
echo "Sleeping for three seconds before testing python"
sleep 3
```


I guess `EXTRAFLAGS` is only used inside the `spkg-install` script, so why export it?

On SunOS, do we need the configure flag `--with-gcc="gcc -m64"` given that `-m64` is already inside `$OPT`?  Or, if `$OPT` does nothing, why specify `$OPT`?


---

Comment by leif created at 2011-07-07 11:49:43

Replying to [comment:41 jdemeyer]:
> Replying to [comment:40 leif]:
> > Replying to [comment:39 jdemeyer]:
> > Details, please. ;-)
> 

```
if command -v dpkg && ! command -v dpkg-architecture >/dev/null; then
```

> should be

```
if command -v dpkg >/dev/null && ! command -v dpkg-architecture >/dev/null; then
```

Yes, I mentioned on the ticket that I forgot it; minor.

> Mixed usage of `cp` of `patch`, better always use `patch`.

Agreed, but didn't want to change too much, since it is a blocker and needs quick review.

> On SunOS, you first patch `setup.py` and then copy a different version over it.

No idea. Ask Dave. (The real patch is only necessary on Debian Linuces, so at least that shouldn't break anything.)

> Patching is better done using one `for` loop to prevent an error-prone laundry list of patches to be applied.

Hmmm, depends on the situation. Order might matter, and not all patches are applied on all systems. You'd also have to delete (or rename) patches that [currently] don't get applied anymore. Having a bit of redundancy in `spkg-install` and `SPKG.txt` also isn't that bad, as it should reduce the risk of unintentional changes.

But we still have the `cp`s in there anyway, so this should be changed when all patches get real patches.



> Why call `./configure` with arguments `CC="$CC $CFLAGS" CXX="$CXX $CXXFLAGS"`?  Any why only on certain systems?

Guess that's some libtool issue, which sometimes drops e.g. `-m64`, but apparently not on all systems (or it doesn't matter on all).

>

```
MAKE=make; export MAKE
make -i install
```

should be

```
$MAKE -j1 -i install
```

I know. I always get beaten when I change such, as some people consider it to be a "dangerous change"... (I put a comment on that in.)

> Remove this:

```
# Do not exit script if there is an error, but instead print an
# informative error message. This is helps in determining why the
# configuration, compilation or installation failed. So put this before the
# build() function.
set +e # This is redundant here, but doesn't hurt to keep it... ;-)
```

Orrr.
 
> Why this:

```
echo "Sleeping for three seconds before testing python"
sleep 3
```

See above ("dangerous change"). I added a comment that this is certainly no longer necessary, on the other hand it doesn't hurt much.

> I guess `EXTRAFLAGS` is only used inside the `spkg-install` script, so why export it?

Typical stupidity. Only one of N instances of that.

> On SunOS, do we need the configure flag `--with-gcc="gcc -m64"` given that `-m64` is already inside `$OPT`?  Or, if `$OPT` does nothing, why specify `$OPT`?

That's again related to libtool I think.

----

If you come across such things and don't want to fix them immediately, it's IMHO best to simply put comments into the files or `SPKG.txt`. Comments don't hurt and don't have to be tested, so no reviewer should complain about them (as opposed to too many or "difficult" functional changes).

Also, the next one touching the spkg (or files in general) hopefully will take them into account, and doesn't have to search trac for older tickets with open issues.


---

Comment by jdemeyer created at 2011-07-08 12:00:38

Resolution: fixed
