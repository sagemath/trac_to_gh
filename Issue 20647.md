# Issue 20647: line buffering in sage-logger causes "hang" due to invisible prompt when installing experimental packages

archive/issues_020647.json:
```json
{
    "body": "CC:  @jdemeyer @embray @vbraun @kcrisman @dimpase @videlec @novoselt\n\n(Observed on Mac OS X.)\n\nAs I reported in http://trac.sagemath.org/ticket/20708#comment:8:\n\nWhen installing an \"experimental\" package, Sage warns a lot and then prompts the user. \nBecause of line buffering, one does not see the prompt, but Sage just waits indefinitely.\n\n```\nsage -f latte_int\n...\n[latte_int-1.7.3] =========================== WARNING ===========================\n[latte_int-1.7.3] You are about to download and install an experimental package.\n[latte_int-1.7.3] This probably won't work at all for you! There is no guarantee\n[latte_int-1.7.3] that it will build correctly, or behave as expected.\n[latte_int-1.7.3] Use at your own risk!\n[latte_int-1.7.3] ===============================================================\n```\n\n<--- This is where it asks \"[latte_int-1.7.3] Are you sure you want to continue [Y/n]?\" but this is line-buffered and not visible to the user.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20884\n\n",
    "created_at": "2016-06-26T22:19:41Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "line buffering in sage-logger causes \"hang\" due to invisible prompt when installing experimental packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20647",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jdemeyer @embray @vbraun @kcrisman @dimpase @videlec @novoselt

(Observed on Mac OS X.)

As I reported in http://trac.sagemath.org/ticket/20708#comment:8:

When installing an "experimental" package, Sage warns a lot and then prompts the user. 
Because of line buffering, one does not see the prompt, but Sage just waits indefinitely.

```
sage -f latte_int
...
[latte_int-1.7.3] =========================== WARNING ===========================
[latte_int-1.7.3] You are about to download and install an experimental package.
[latte_int-1.7.3] This probably won't work at all for you! There is no guarantee
[latte_int-1.7.3] that it will build correctly, or behave as expected.
[latte_int-1.7.3] Use at your own risk!
[latte_int-1.7.3] ===============================================================
```

<--- This is where it asks "[latte_int-1.7.3] Are you sure you want to continue [Y/n]?" but this is line-buffered and not visible to the user.

Issue created by migration from https://trac.sagemath.org/ticket/20884





---

archive/issue_comments_284542.json:
```json
{
    "body": "IMHO we just shouldn't ask questions here, a (potentially) parallel make session is just not an interactive process. Either do it or bail out and require a command line switch `--experimental` to opt-in.",
    "created_at": "2016-06-26T23:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284542",
    "user": "https://github.com/vbraun"
}
```

IMHO we just shouldn't ask questions here, a (potentially) parallel make session is just not an interactive process. Either do it or bail out and require a command line switch `--experimental` to opt-in.



---

archive/issue_comments_284543.json:
```json
{
    "body": "I think so too.",
    "created_at": "2016-06-26T23:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284543",
    "user": "https://github.com/mkoeppe"
}
```

I think so too.



---

archive/issue_comments_284544.json:
```json
{
    "body": "+1, just keep the message.",
    "created_at": "2016-06-27T08:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284544",
    "user": "https://github.com/embray"
}
```

+1, just keep the message.



---

archive/issue_comments_284545.json:
```json
{
    "body": "I also think it's fine for *experimental* packages to just run and fail.  As long as there isn't any potential to mess up the rest of Sage (like with messed up runs of `make`).",
    "created_at": "2016-06-28T14:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284545",
    "user": "https://github.com/kcrisman"
}
```

I also think it's fine for *experimental* packages to just run and fail.  As long as there isn't any potential to mess up the rest of Sage (like with messed up runs of `make`).



---

archive/issue_comments_284546.json:
```json
{
    "body": "Here's a patch to remove the prompt entirely.\n\nMight be good to find a fix to the underlying problem, since in principle there could be some other prompt somewhere that would be hidden in the same way.  I'm not sure how best to fix this though--would have to disable line-buffering on such prompts somehow.\n----\nNew commits:",
    "created_at": "2016-06-28T14:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284546",
    "user": "https://github.com/embray"
}
```

Here's a patch to remove the prompt entirely.

Might be good to find a fix to the underlying problem, since in principle there could be some other prompt somewhere that would be hidden in the same way.  I'm not sure how best to fix this though--would have to disable line-buffering on such prompts somehow.
----
New commits:



---

archive/issue_comments_284547.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-28T14:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284547",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_284548.json:
```json
{
    "body": "This would be fine with me. But it could be argued that this warning is too easy to overlook (and comes too late) and so the point of distinguishing between optional and experimental packages is lost.",
    "created_at": "2016-06-28T17:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284548",
    "user": "https://github.com/mkoeppe"
}
```

This would be fine with me. But it could be argued that this warning is too easy to overlook (and comes too late) and so the point of distinguishing between optional and experimental packages is lost.



---

archive/issue_comments_284549.json:
```json
{
    "body": "I don't think simply removing this dialog is the right thing to do.",
    "created_at": "2016-06-29T07:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284549",
    "user": "https://github.com/dimpase"
}
```

I don't think simply removing this dialog is the right thing to do.



---

archive/issue_comments_284550.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-29T07:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284550",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_284551.json:
```json
{
    "body": "> This would be fine with me. But it could be argued that this warning is too easy to overlook (and comes too late) and so the point of distinguishing between optional and experimental packages is lost.\n\nI'm not sure what you suggest differently, other than moving the warning a little earlier?\n\nBut if someone doesn't read their build output it will be lost on them anyways.  That's okay, because it's \"merely\" a warning.",
    "created_at": "2016-06-29T08:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284551",
    "user": "https://github.com/embray"
}
```

> This would be fine with me. But it could be argued that this warning is too easy to overlook (and comes too late) and so the point of distinguishing between optional and experimental packages is lost.

I'm not sure what you suggest differently, other than moving the warning a little earlier?

But if someone doesn't read their build output it will be lost on them anyways.  That's okay, because it's "merely" a warning.



---

archive/issue_comments_284552.json:
```json
{
    "body": "Dima has a point that removing the prompt outright is potentially disruptive.  \n\nWhat if we moved the warning so that there's no prompt if running `make <packagename>` directly, as a package developer might do.  But running `./sage -i` for an experimental package both displays the warning and the prompt (before ever even running `make`, much less `sage-logger`).",
    "created_at": "2016-06-29T08:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284552",
    "user": "https://github.com/embray"
}
```

Dima has a point that removing the prompt outright is potentially disruptive.  

What if we moved the warning so that there's no prompt if running `make <packagename>` directly, as a package developer might do.  But running `./sage -i` for an experimental package both displays the warning and the prompt (before ever even running `make`, much less `sage-logger`).



---

archive/issue_comments_284553.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> Dima has a point that removing the prompt outright is potentially disruptive.  \n> \n> What if we moved the warning so that there's no prompt if running `make <packagename>` directly, as a package developer might do.  But running `./sage -i` for an experimental package both displays the warning and the prompt (before ever even running `make`, much less `sage-logger`).\n\nI think `./sage -i PACKAGENAMES...` should display the warning and the prompt before at the very beginning, before installing any package.\n\nAs per Volker's initial suggestion, a command-line switch `--experimental` should override the prompt. This would be useful in a script. I didn't know that `make PACKAGENAME` works; but in any case it would be better to be able to use \"sage -i\" also from a script.",
    "created_at": "2016-06-29T16:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284553",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:13 embray]:
> Dima has a point that removing the prompt outright is potentially disruptive.  
> 
> What if we moved the warning so that there's no prompt if running `make <packagename>` directly, as a package developer might do.  But running `./sage -i` for an experimental package both displays the warning and the prompt (before ever even running `make`, much less `sage-logger`).

I think `./sage -i PACKAGENAMES...` should display the warning and the prompt before at the very beginning, before installing any package.

As per Volker's initial suggestion, a command-line switch `--experimental` should override the prompt. This would be useful in a script. I didn't know that `make PACKAGENAME` works; but in any case it would be better to be able to use "sage -i" also from a script.



---

archive/issue_comments_284554.json:
```json
{
    "body": "`make <packagename>` is how all packages are built.  `sage -i` is just a thin front-end over that.\n\nIt appears the warning/prompt comes from the `sage-spkg` (which is the program responsible for unpacking the package, running `spkg-install`, etc) which is in turn called by make.  \n\nI tried reworking this yesterday in a way that didn't change `sage-spkg`, but to make that prompt happen *right* away it would have to moved either into the makefile itself, or into the `sage` command, though I think it's good to have the warning when running `sage-spkg` too.  So I'd hate to have duplicate copies of the warning.\n\nIn other words it's not exactly clear where the best place would be for it.  Jeroen might have some ideas but he's on holiday right now so we won't bug him about it.",
    "created_at": "2016-06-30T08:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284554",
    "user": "https://github.com/embray"
}
```

`make <packagename>` is how all packages are built.  `sage -i` is just a thin front-end over that.

It appears the warning/prompt comes from the `sage-spkg` (which is the program responsible for unpacking the package, running `spkg-install`, etc) which is in turn called by make.  

I tried reworking this yesterday in a way that didn't change `sage-spkg`, but to make that prompt happen *right* away it would have to moved either into the makefile itself, or into the `sage` command, though I think it's good to have the warning when running `sage-spkg` too.  So I'd hate to have duplicate copies of the warning.

In other words it's not exactly clear where the best place would be for it.  Jeroen might have some ideas but he's on holiday right now so we won't bug him about it.



---

archive/issue_comments_284555.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-30T12:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284555",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284556.json:
```json
{
    "body": "Welp, this is definitely more complicated than it was before, but I think it's pretty good.",
    "created_at": "2016-06-30T12:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284556",
    "user": "https://github.com/embray"
}
```

Welp, this is definitely more complicated than it was before, but I think it's pretty good.



---

archive/issue_comments_284557.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-30T12:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284557",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284558.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-30T12:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284558",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284559.json:
```json
{
    "body": "looks good to me",
    "created_at": "2016-06-30T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284559",
    "user": "https://github.com/dimpase"
}
```

looks good to me



---

archive/issue_comments_284560.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-30T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284560",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_284561.json:
```json
{
    "body": "On OSX:\n\n```\nconfig.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/lib\nconfig.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/share\nconfig.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/var/lib/sage/installed\nbuild/bin/sage-logger \\\n\t\t\"cd build/make && ./install 'start'\" logs/install.log\nbuild/bin/sage-logger: line 48: read: -N: invalid option\nread: usage: read [-ers] [-u fd] [-t timeout] [-p prompt] [-a array] [-n nchars] [-d delim] [name ...]\nmake: *** [start] Error 141\nprogram finished with exit code 2\n```\n",
    "created_at": "2016-06-30T19:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284561",
    "user": "https://github.com/vbraun"
}
```

On OSX:

```
config.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/lib
config.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/share
config.status: creating directory /Users/buildslave-sage/slave/sage_git/build/local/var/lib/sage/installed
build/bin/sage-logger \
		"cd build/make && ./install 'start'" logs/install.log
build/bin/sage-logger: line 48: read: -N: invalid option
read: usage: read [-ers] [-u fd] [-t timeout] [-p prompt] [-a array] [-n nchars] [-d delim] [name ...]
make: *** [start] Error 141
program finished with exit code 2
```




---

archive/issue_comments_284562.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-06-30T19:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284562",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_284563.json:
```json
{
    "body": "oops... perhaps one can just replace `-N` with `-n` ?",
    "created_at": "2016-06-30T19:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284563",
    "user": "https://github.com/dimpase"
}
```

oops... perhaps one can just replace `-N` with `-n` ?



---

archive/issue_comments_284564.json:
```json
{
    "body": "With `IFS` unset, at least, `-n` appears to be equivalent to `-N`.",
    "created_at": "2016-07-01T07:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284564",
    "user": "https://github.com/dimpase"
}
```

With `IFS` unset, at least, `-n` appears to be equivalent to `-N`.



---

archive/issue_comments_284565.json:
```json
{
    "body": "And here I thought by relying entirely on bash features this would be portable.  Leave it to OSX to \"think different\"!\n\nMysteriously, on my bash `-n` is not quite the same as `-N` even with `IFS` unset.  I think the key is that for `-N` it reads \"Delimiter characters  encountered  in  the input are not treated specially and do not cause `read` to return until `nchars` are read\".  So in other words, hitting \"Enter\" with `-N 1` will cause read to return a newline literal.  Whereas for `-n` the delimiter is still treated specially and is *not* returned.  Hitting Enter causes `read` to return with no characters read.  It should be made clear that here \"delimiter\" is referring to the delimiter that `read` should read up to, not the delimiter(s) used to split a line, which is what `IFS` is.\n\nThe solution is to use `-n`, but treat an empty string has having received a newline.",
    "created_at": "2016-07-01T11:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284565",
    "user": "https://github.com/embray"
}
```

And here I thought by relying entirely on bash features this would be portable.  Leave it to OSX to "think different"!

Mysteriously, on my bash `-n` is not quite the same as `-N` even with `IFS` unset.  I think the key is that for `-N` it reads "Delimiter characters  encountered  in  the input are not treated specially and do not cause `read` to return until `nchars` are read".  So in other words, hitting "Enter" with `-N 1` will cause read to return a newline literal.  Whereas for `-n` the delimiter is still treated specially and is *not* returned.  Hitting Enter causes `read` to return with no characters read.  It should be made clear that here "delimiter" is referring to the delimiter that `read` should read up to, not the delimiter(s) used to split a line, which is what `IFS` is.

The solution is to use `-n`, but treat an empty string has having received a newline.



---

archive/issue_comments_284566.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-01T11:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284566",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284567.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-01T14:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284567",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284568.json:
```json
{
    "body": "the last commit did not make it into the branch! Never seen such a strange thing before...",
    "created_at": "2016-07-03T06:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284568",
    "user": "https://github.com/dimpase"
}
```

the last commit did not make it into the branch! Never seen such a strange thing before...



---

archive/issue_comments_284569.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-03T06:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284569",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_284570.json:
```json
{
    "body": "sorry, in fact there is still -N left in sage-logger, and I get on OSX\n\n`build/bin/sage-logger: line 48: read: -N: invalid option`",
    "created_at": "2016-07-03T06:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284570",
    "user": "https://github.com/dimpase"
}
```

sorry, in fact there is still -N left in sage-logger, and I get on OSX

`build/bin/sage-logger: line 48: read: -N: invalid option`



---

archive/issue_comments_284571.json:
```json
{
    "body": "Ah, right.",
    "created_at": "2016-07-04T13:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284571",
    "user": "https://github.com/embray"
}
```

Ah, right.



---

archive/issue_comments_284572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-04T13:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284573.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-04T13:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284573",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284574.json:
```json
{
    "body": "Fixed `sage-logger` to not use `read -N 1` as well.\n----\nNew commits:",
    "created_at": "2016-07-04T13:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284574",
    "user": "https://github.com/embray"
}
```

Fixed `sage-logger` to not use `read -N 1` as well.
----
New commits:



---

archive/issue_comments_284575.json:
```json
{
    "body": "OK, this works on OSX.",
    "created_at": "2016-07-04T14:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284575",
    "user": "https://github.com/dimpase"
}
```

OK, this works on OSX.



---

archive/issue_comments_284576.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-04T14:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284576",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_284577.json:
```json
{
    "body": "Follow up: #20937",
    "created_at": "2016-07-04T17:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284577",
    "user": "https://github.com/mkoeppe"
}
```

Follow up: #20937



---

archive/issue_comments_284578.json:
```json
{
    "body": "I'm getting this failure\n\n```\nsage -t --long src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 219, in sage.tests.cmdline.test_executable\nFailed example:\n    print(out)\nExpected:\n    Found local metadata for sqlite-...\n    = SQLite =\n    ...\n    SQLite is a software library that implements a self-contained,\n    serverless, zero-configuration, transactional SQL database engine.\n    ...\nGot:\n    Found local metadata for sqliteautoconf3130000\n    = SQLite =\n    <BLANKLINE>\n    == Description ==\n    <BLANKLINE>\n    SQLite is a software library that implements a selfcontained,\n    serverless, zeroconfiguration, transactional SQL database engine.\n    <BLANKLINE>\n    == License ==\n    <BLANKLINE>\n    Public Domain\n    <BLANKLINE>\n    == Upstream contact ==\n    <BLANKLINE>\n     * http://www.sqlite.org\n    <BLANKLINE>\n    == Dependencies ==\n    <BLANKLINE>\n    * readline\n    <BLANKLINE>\n    == Special Update/Build Instructions ==\n    <BLANKLINE>\n    * Use the autoconf version of sqlite.\n    <BLANKLINE>\n**********************************************************************\n1 item had failures:\n   1 of 239 in sage.tests.cmdline.test_executable\n    [238 tests, 1 failure, 142.30 s]\n```\n",
    "created_at": "2016-07-04T21:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284578",
    "user": "https://github.com/vbraun"
}
```

I'm getting this failure

```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 219, in sage.tests.cmdline.test_executable
Failed example:
    print(out)
Expected:
    Found local metadata for sqlite-...
    = SQLite =
    ...
    SQLite is a software library that implements a self-contained,
    serverless, zero-configuration, transactional SQL database engine.
    ...
Got:
    Found local metadata for sqliteautoconf3130000
    = SQLite =
    <BLANKLINE>
    == Description ==
    <BLANKLINE>
    SQLite is a software library that implements a selfcontained,
    serverless, zeroconfiguration, transactional SQL database engine.
    <BLANKLINE>
    == License ==
    <BLANKLINE>
    Public Domain
    <BLANKLINE>
    == Upstream contact ==
    <BLANKLINE>
     * http://www.sqlite.org
    <BLANKLINE>
    == Dependencies ==
    <BLANKLINE>
    * readline
    <BLANKLINE>
    == Special Update/Build Instructions ==
    <BLANKLINE>
    * Use the autoconf version of sqlite.
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of 239 in sage.tests.cmdline.test_executable
    [238 tests, 1 failure, 142.30 s]
```




---

archive/issue_comments_284579.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-07-04T21:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284579",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_284580.json:
```json
{
    "body": "looks like a monster is eating up all `-` in there: in `sqlite-autoconf3130000`, in `self-contained`, in `zero-configuration`. So there is something wrong in the update of `build/bin/sage-logger`. (The problem is reproducible on Linux as well as on OSX).",
    "created_at": "2016-07-04T22:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284580",
    "user": "https://github.com/dimpase"
}
```

looks like a monster is eating up all `-` in there: in `sqlite-autoconf3130000`, in `self-contained`, in `zero-configuration`. So there is something wrong in the update of `build/bin/sage-logger`. (The problem is reproducible on Linux as well as on OSX).



---

archive/issue_comments_284581.json:
```json
{
    "body": "Perhaps it's best to use a simple solution that doesn't try to be interactive...",
    "created_at": "2016-07-04T22:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284581",
    "user": "https://github.com/mkoeppe"
}
```

Perhaps it's best to use a simple solution that doesn't try to be interactive...



---

archive/issue_comments_284582.json:
```json
{
    "body": "indeed, `-` does not get echoed:\n\n```\n$ cat blah\noh-oh\n\n$ while IFS= read -d'' -s -n 1 char; do echo -n \"$char\"; done <blah\nohoh\n\n```\n",
    "created_at": "2016-07-05T09:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284582",
    "user": "https://github.com/dimpase"
}
```

indeed, `-` does not get echoed:

```
$ cat blah
oh-oh

$ while IFS= read -d'' -s -n 1 char; do echo -n "$char"; done <blah
ohoh

```




---

archive/issue_comments_284583.json:
```json
{
    "body": "Fantastic.  I'm this close to just rewriting this script in Python....",
    "created_at": "2016-07-05T09:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284583",
    "user": "https://github.com/embray"
}
```

Fantastic.  I'm this close to just rewriting this script in Python....



---

archive/issue_comments_284584.json:
```json
{
    "body": "Incidentally, `read -N 1` (as it was before) does *not* inexplicably eat `-`.",
    "created_at": "2016-07-05T09:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284584",
    "user": "https://github.com/embray"
}
```

Incidentally, `read -N 1` (as it was before) does *not* inexplicably eat `-`.



---

archive/issue_comments_284585.json:
```json
{
    "body": "This is so effing bizarre I had to ask about it on Stack Overflow: http://stackoverflow.com/questions/38199974/bash-read-mystery-read-d-s-n-1-eats-hyphens\n\nI think it's a bug in bash, personally, or at least  very ill-documented behavior.  In the meantime I do have a work-around.",
    "created_at": "2016-07-05T09:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284585",
    "user": "https://github.com/embray"
}
```

This is so effing bizarre I had to ask about it on Stack Overflow: http://stackoverflow.com/questions/38199974/bash-read-mystery-read-d-s-n-1-eats-hyphens

I think it's a bug in bash, personally, or at least  very ill-documented behavior.  In the meantime I do have a work-around.



---

archive/issue_comments_284586.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-05T09:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284586",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284587.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-05T09:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284587",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284588.json:
```json
{
    "body": "Fixed the issue with `sage-logger` eating hyphens.",
    "created_at": "2016-07-05T09:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284588",
    "user": "https://github.com/embray"
}
```

Fixed the issue with `sage-logger` eating hyphens.



---

archive/issue_comments_284589.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> This is so effing bizarre I had to ask about it on Stack Overflow: http://stackoverflow.com/questions/38199974/bash-read-mystery-read-d-s-n-1-eats-hyphens\n> \n> I think it's a bug in bash, personally, or at least  very ill-documented behavior.  In the meantime I do have a work-around.\n\nThe internet has solved your problem - you must have a space between `-d` and `''` !\n(so this must also be fixed in the other place where you use `-d*` instead of `-d *`)",
    "created_at": "2016-07-05T11:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284589",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:40 embray]:
> This is so effing bizarre I had to ask about it on Stack Overflow: http://stackoverflow.com/questions/38199974/bash-read-mystery-read-d-s-n-1-eats-hyphens
> 
> I think it's a bug in bash, personally, or at least  very ill-documented behavior.  In the meantime I do have a work-around.

The internet has solved your problem - you must have a space between `-d` and `''` !
(so this must also be fixed in the other place where you use `-d*` instead of `-d *`)



---

archive/issue_comments_284590.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-05T11:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284590",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_284591.json:
```json
{
    "body": "Wow, I feel silly.  But not too silly either--bash's behavior here is really quite silly IMO.  But very nice.\n\nI actually didn't use `-d*` anywhere else--at least in the current version of this patch the `-d` flag is not used at all.  But I'll still update the patch once more time to use this, since it will simplify things *slightly''.",
    "created_at": "2016-07-05T12:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284591",
    "user": "https://github.com/embray"
}
```

Wow, I feel silly.  But not too silly either--bash's behavior here is really quite silly IMO.  But very nice.

I actually didn't use `-d*` anywhere else--at least in the current version of this patch the `-d` flag is not used at all.  But I'll still update the patch once more time to use this, since it will simplify things *slightly''.



---

archive/issue_comments_284592.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-05T12:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284592",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284593.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-05T12:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284593",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284594.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-05T12:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284594",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284595.json:
```json
{
    "body": "OK, good.",
    "created_at": "2016-07-05T12:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284595",
    "user": "https://github.com/dimpase"
}
```

OK, good.



---

archive/issue_comments_284596.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-05T12:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284596",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_284597.json:
```json
{
    "body": "Replying to [comment:44 embray]:\n> Wow, I feel silly.  But not too silly either--bash's behavior here is really quite silly IMO.  But very nice.\n\nIt's not silly, it's as documented.  `read -d'' -s ...` is equivalent to `read -d '-s' ...` (where only the first character of the string argument `'-s'` is taken as the delimiter, as documented).",
    "created_at": "2016-07-05T21:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284597",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:44 embray]:
> Wow, I feel silly.  But not too silly either--bash's behavior here is really quite silly IMO.  But very nice.

It's not silly, it's as documented.  `read -d'' -s ...` is equivalent to `read -d '-s' ...` (where only the first character of the string argument `'-s'` is taken as the delimiter, as documented).



---

archive/issue_comments_284598.json:
```json
{
    "body": "That's clearly the wrong solution to the problem.\n\nDid anyone even *think* of performance when replacing `sed` by a character-by-character *shell loop* (in addition with two conditionals in it)?\n\nOne should probably try this on a single-, maybe dual-core machine.\n\n----\n\nHow about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?",
    "created_at": "2016-07-05T23:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284598",
    "user": "https://github.com/nexttime"
}
```

That's clearly the wrong solution to the problem.

Did anyone even *think* of performance when replacing `sed` by a character-by-character *shell loop* (in addition with two conditionals in it)?

One should probably try this on a single-, maybe dual-core machine.

----

How about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?



---

archive/issue_comments_284599.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-07-05T23:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284599",
    "user": "https://github.com/nexttime"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_284600.json:
```json
{
    "body": "I didn't want to wait for the latter to finish, but now it did:\n\n```sh\n$ time ./sage-logger-7.3.beta6 -p \"cat logs/install.log\" test-current.log >/dev/null\n\nreal\t0m0.311s\nuser\t0m0.170s\nsys\t0m0.160s\n$ time ./sage-logger-20884 -p \"cat logs/install.log\" test-new.log >/dev/null\n\nreal\t25m12.620s\nuser\t24m20.680s\nsys\t0m51.900s\n```\n\n\n(Note that the comparison isn't even exactly fair, since `sed` had to output a longer prefix, and the second time, `install.log` was already in the filesystem cache. ;-) )",
    "created_at": "2016-07-05T23:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284600",
    "user": "https://github.com/nexttime"
}
```

I didn't want to wait for the latter to finish, but now it did:

```sh
$ time ./sage-logger-7.3.beta6 -p "cat logs/install.log" test-current.log >/dev/null

real	0m0.311s
user	0m0.170s
sys	0m0.160s
$ time ./sage-logger-20884 -p "cat logs/install.log" test-new.log >/dev/null

real	25m12.620s
user	24m20.680s
sys	0m51.900s
```


(Note that the comparison isn't even exactly fair, since `sed` had to output a longer prefix, and the second time, `install.log` was already in the filesystem cache. ;-) )



---

archive/issue_comments_284601.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-06T07:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284601",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_284602.json:
```json
{
    "body": "> How about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?\n\nThose scripts don't necessarily have any way to know that `sage-logger` is being used, nor should they.\n\nI think the test of just `cat`ting is not quite fair either.  In a real build the overhead of the commands being run far outweighs the overhead of the logger.  For example running `make patch` on current `develop` I got:\n\n\n```\nreal    2m14.225s\nuser    0m29.614s\nsys     1m2.397s\n```\n\n\nwhile on my branch:\n\n\n```\nreal    2m18.844s\nuser    0m38.751s\nsys     1m4.341s\n```\n\n\nSo maybe possibly a little slower but hard to say from a single data point.\n\nThere's no need to emphasize *shell loop* since it's using only shell built-ins, or should be, so that shouldn't be a significant source of overhead.  Ultimately `sed` is looping over one character at a time too.  One thing that might speed this up a bit is to not `printf` for every character, but at least buffer that.\n\nStill, point partly taken.  I might prefer to go with my earlier instinct and just rewrite it in Python.  I think using `sed` just to prepend to a line also feels like a blunt instrument.",
    "created_at": "2016-07-06T10:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284602",
    "user": "https://github.com/embray"
}
```

> How about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?

Those scripts don't necessarily have any way to know that `sage-logger` is being used, nor should they.

I think the test of just `cat`ting is not quite fair either.  In a real build the overhead of the commands being run far outweighs the overhead of the logger.  For example running `make patch` on current `develop` I got:


```
real    2m14.225s
user    0m29.614s
sys     1m2.397s
```


while on my branch:


```
real    2m18.844s
user    0m38.751s
sys     1m4.341s
```


So maybe possibly a little slower but hard to say from a single data point.

There's no need to emphasize *shell loop* since it's using only shell built-ins, or should be, so that shouldn't be a significant source of overhead.  Ultimately `sed` is looping over one character at a time too.  One thing that might speed this up a bit is to not `printf` for every character, but at least buffer that.

Still, point partly taken.  I might prefer to go with my earlier instinct and just rewrite it in Python.  I think using `sed` just to prepend to a line also feels like a blunt instrument.



---

archive/issue_comments_284603.json:
```json
{
    "body": "> It's not silly, it's as documented. read -d'' -s ... is equivalent to read -d '-s' ... (where only the first character of the string argument '-s' is taken as the delimiter, as documented).\n\nJust because it's as documented (which I see now, on very careful read, that the syntax must be `-d<space><delimiter>`).  That's not *unreasonable*, just different from how other commands (specifically `cut`, which is why I was mentally comparing to) take their arguments.  You can't well argue that the syntax of shell commands is always logical or consistent.",
    "created_at": "2016-07-06T10:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284603",
    "user": "https://github.com/embray"
}
```

> It's not silly, it's as documented. read -d'' -s ... is equivalent to read -d '-s' ... (where only the first character of the string argument '-s' is taken as the delimiter, as documented).

Just because it's as documented (which I see now, on very careful read, that the syntax must be `-d<space><delimiter>`).  That's not *unreasonable*, just different from how other commands (specifically `cut`, which is why I was mentally comparing to) take their arguments.  You can't well argue that the syntax of shell commands is always logical or consistent.



---

archive/issue_comments_284604.json:
```json
{
    "body": "FWIW, I also tried running `make patch` with a version that doesn't add the prefix at all and the result from `time` was roughly the same there too.  The point is that the overhead of adding the prefix, regardless how it's done, pales in comparison to the time to run most commands that produce output during the build.",
    "created_at": "2016-07-06T14:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284604",
    "user": "https://github.com/embray"
}
```

FWIW, I also tried running `make patch` with a version that doesn't add the prefix at all and the result from `time` was roughly the same there too.  The point is that the overhead of adding the prefix, regardless how it's done, pales in comparison to the time to run most commands that produce output during the build.



---

archive/issue_comments_284605.json:
```json
{
    "body": "Volker, I don't understand why you merged this when it was labeled as \"needs_work\". At one point, yes, it was marked as \"positive_review\", but when you merged it, it had gone back to \"needs_work\" and had been that way for 12 hours.",
    "created_at": "2016-07-06T14:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284605",
    "user": "https://github.com/jhpalmieri"
}
```

Volker, I don't understand why you merged this when it was labeled as "needs_work". At one point, yes, it was marked as "positive_review", but when you merged it, it had gone back to "needs_work" and had been that way for 12 hours.



---

archive/issue_comments_284606.json:
```json
{
    "body": "I can confirm Leif's timings. On an OS X machine:\n\n- `make build` from a fresh tarball: 73 minutes. Within that build, it took 19m53s to build `gcc`.\n- `make build` from a fresh tarball + this branch: 93 minutes. Within that build, it took 29m57s to build `gcc`.\n\nFollowing that:\n- `./sage -f gcc` took 20m39s without this branch.\n- `./sage -f gcc` took 29m15s with this branch.\n\nSo the timing difference can be significant. It will be more significant for larger log files, which is why it doesn't make that much difference when building `patch`.",
    "created_at": "2016-07-06T18:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284606",
    "user": "https://github.com/jhpalmieri"
}
```

I can confirm Leif's timings. On an OS X machine:

- `make build` from a fresh tarball: 73 minutes. Within that build, it took 19m53s to build `gcc`.
- `make build` from a fresh tarball + this branch: 93 minutes. Within that build, it took 29m57s to build `gcc`.

Following that:
- `./sage -f gcc` took 20m39s without this branch.
- `./sage -f gcc` took 29m15s with this branch.

So the timing difference can be significant. It will be more significant for larger log files, which is why it doesn't make that much difference when building `patch`.



---

archive/issue_comments_284607.json:
```json
{
    "body": "Perhaps Erik can explain the need to patch `build/bin/sage-logger` - this is the part that causes the slowdown.",
    "created_at": "2016-07-06T19:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284607",
    "user": "https://github.com/dimpase"
}
```

Perhaps Erik can explain the need to patch `build/bin/sage-logger` - this is the part that causes the slowdown.



---

archive/issue_comments_284608.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2016-07-06T19:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284608",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_284609.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2016-07-06T19:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284609",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_284610.json:
```json
{
    "body": "Okay, thanks for the full `make build` comparison.  That's definitely more convincing.  I'll see what I can do to tinker.\n\n> Perhaps Erik can explain the need to patch build/bin/sage-logger - this is the part that causes the slowdown.\n\nI could--there are good reasons.  But regardless as this stands now it's adding more overhead than any explanation I have justifies, so back to the drawing board.",
    "created_at": "2016-07-07T07:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284610",
    "user": "https://github.com/embray"
}
```

Okay, thanks for the full `make build` comparison.  That's definitely more convincing.  I'll see what I can do to tinker.

> Perhaps Erik can explain the need to patch build/bin/sage-logger - this is the part that causes the slowdown.

I could--there are good reasons.  But regardless as this stands now it's adding more overhead than any explanation I have justifies, so back to the drawing board.



---

archive/issue_comments_284611.json:
```json
{
    "body": "Replying to [comment:53 embray]:\n> > How about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?\n> \n> Those scripts don't necessarily have any way to know that `sage-logger` is being used, nor should they.\n\nWhile you could set some env var in \"non-interactive\" mode (or when the sage-logger is used), what's the problem with having a newline after `\"... [Y/n]?\"`?\n\n\\\\\n\n> I think the test of just `cat`ting is not quite fair either.  In a real build the overhead of the commands being run far outweighs the overhead of the logger.\n\nThe timings I listed are (the lower bound of) *consumed CPU time you get in addition* with every build from scratch (not taking into account a GCC build btw.); on a single-core that's what adds to the wall time (plus presumably the overhead of more context switches), and regardless of whether you build any experimental package (or any other question is asked). \n\n\\\\\n\n> There's no need to emphasize *shell loop* since it's using only shell built-ins, or should be,\n\nYou were not using bash's built-in test (`[This is the Trac macro *... * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#... -macro)`), but the speed-up with the latter isn't huge either:\n\n\n```sh\n$ time ./sage-logger-20884-bt -p \"cat logs/install.log\" test-nw2.log >/dev/null\n\nreal\t21m51.249s\nuser\t21m15.210s\nsys\t0m36.170s\n```\n\n(i.e., ~22 minutes vs. previously ~25 minutes, saving about 3.5 minutes, and all tests were performed on the same, a *relatively fast* machine; note that `sys` though dropped by nearly one third.)\n\n\\\\\n\n> so that shouldn't be a significant source of overhead.  Ultimately `sed` is looping over one character at a time too.\n\nBut it's not an interpreter, it compiles the regular expressions instead of rereading and interpreting them over and over, and btw. operates on lines of input -- you've seen the difference (orders of magnitude).\n\n\\\\\n\n> [...] I might prefer to go with my earlier instinct and just rewrite it in Python.  I think using `sed` just to prepend to a line also feels like a blunt instrument.\n\nPlease don't, `sed` is IMHO pretty adequate in lack of other portable tools for this trivial task (prepending something to each line); regarding that we meanwhile have separate log files for each package it's a bit superfluous though, even for parallel builds.  But *as is* (with `sed`), it doesn't hurt much.\n\n(If at all, I'd personally rewrite the whole sage-logger in C.)",
    "created_at": "2016-07-08T16:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284611",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:53 embray]:
> > How about simply changing the scripts to output a newline when prompting the user for something, at least when the sage-logger is used?
> 
> Those scripts don't necessarily have any way to know that `sage-logger` is being used, nor should they.

While you could set some env var in "non-interactive" mode (or when the sage-logger is used), what's the problem with having a newline after `"... [Y/n]?"`?

\\

> I think the test of just `cat`ting is not quite fair either.  In a real build the overhead of the commands being run far outweighs the overhead of the logger.

The timings I listed are (the lower bound of) *consumed CPU time you get in addition* with every build from scratch (not taking into account a GCC build btw.); on a single-core that's what adds to the wall time (plus presumably the overhead of more context switches), and regardless of whether you build any experimental package (or any other question is asked). 

\\

> There's no need to emphasize *shell loop* since it's using only shell built-ins, or should be,

You were not using bash's built-in test (`[This is the Trac macro *... * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#... -macro)`), but the speed-up with the latter isn't huge either:


```sh
$ time ./sage-logger-20884-bt -p "cat logs/install.log" test-nw2.log >/dev/null

real	21m51.249s
user	21m15.210s
sys	0m36.170s
```

(i.e., ~22 minutes vs. previously ~25 minutes, saving about 3.5 minutes, and all tests were performed on the same, a *relatively fast* machine; note that `sys` though dropped by nearly one third.)

\\

> so that shouldn't be a significant source of overhead.  Ultimately `sed` is looping over one character at a time too.

But it's not an interpreter, it compiles the regular expressions instead of rereading and interpreting them over and over, and btw. operates on lines of input -- you've seen the difference (orders of magnitude).

\\

> [...] I might prefer to go with my earlier instinct and just rewrite it in Python.  I think using `sed` just to prepend to a line also feels like a blunt instrument.

Please don't, `sed` is IMHO pretty adequate in lack of other portable tools for this trivial task (prepending something to each line); regarding that we meanwhile have separate log files for each package it's a bit superfluous though, even for parallel builds.  But *as is* (with `sed`), it doesn't hurt much.

(If at all, I'd personally rewrite the whole sage-logger in C.)



---

archive/issue_comments_284612.json:
```json
{
    "body": "Replying to [comment:54 embray]:\n> > It's not silly, it's as documented. read -d'' -s ... is equivalent to read -d '-s' ... (where only the first character of the string argument '-s' is taken as the delimiter, as documented).\n> \n> Just because it's as documented (which I see now, on very careful read, that the syntax must be `-d<space><delimiter>`).  That's not *unreasonable*, just different from how other commands (specifically `cut`, which is why I was mentally comparing to) take their arguments.  You can't well argue that the syntax of shell commands is always logical or consistent.\n\nYou were also passing an **empty** string, which *there* gets removed altogether in shell preparsing (`-d*` => `-d`).  (You could likely have written `re*ad ...` for example... 8-) )",
    "created_at": "2016-07-08T16:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284612",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:54 embray]:
> > It's not silly, it's as documented. read -d'' -s ... is equivalent to read -d '-s' ... (where only the first character of the string argument '-s' is taken as the delimiter, as documented).
> 
> Just because it's as documented (which I see now, on very careful read, that the syntax must be `-d<space><delimiter>`).  That's not *unreasonable*, just different from how other commands (specifically `cut`, which is why I was mentally comparing to) take their arguments.  You can't well argue that the syntax of shell commands is always logical or consistent.

You were also passing an **empty** string, which *there* gets removed altogether in shell preparsing (`-d*` => `-d`).  (You could likely have written `re*ad ...` for example... 8-) )



---

archive/issue_comments_284613.json:
```json
{
    "body": "Anyhow, perhaps we should keep `sage-logger` as it is, and proceed with the rest of the patch.",
    "created_at": "2016-07-09T15:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284613",
    "user": "https://github.com/dimpase"
}
```

Anyhow, perhaps we should keep `sage-logger` as it is, and proceed with the rest of the patch.



---

archive/issue_comments_284614.json:
```json
{
    "body": "I have rewritten `sage-logger` in Python.  I'm still doing some performance tests (i.e. on a full build) but all indication so far is that performance is the same or slightly better than the current version.",
    "created_at": "2016-07-11T11:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284614",
    "user": "https://github.com/embray"
}
```

I have rewritten `sage-logger` in Python.  I'm still doing some performance tests (i.e. on a full build) but all indication so far is that performance is the same or slightly better than the current version.



---

archive/issue_comments_284615.json:
```json
{
    "body": "> You were not using bash's built-in test `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)`\n\nNo, I was using bash's built-in test `[ ]`.  This is still a bash built-in--it does not run as a separate process.  The only difference between `[ ]` and `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)` is that the latter is bash-specific and less portable.  But when run explicitly in bash, as opposed to an arbitrary shell, `test` is still a shell built-in.",
    "created_at": "2016-07-11T11:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284615",
    "user": "https://github.com/embray"
}
```

> You were not using bash's built-in test `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)`

No, I was using bash's built-in test `[ ]`.  This is still a bash built-in--it does not run as a separate process.  The only difference between `[ ]` and `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)` is that the latter is bash-specific and less portable.  But when run explicitly in bash, as opposed to an arbitrary shell, `test` is still a shell built-in.



---

archive/issue_comments_284616.json:
```json
{
    "body": "> (If at all, I'd personally rewrite the whole sage-logger in C.)\n\nI considered that too.  In fact it might be good to take the Python version I wrote as a prototype for a faster C version.  That said, having a Python version is easier for bootstrapping purposes, and the Python version I wrote is just as fast as the current version, by all indications.",
    "created_at": "2016-07-11T11:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284616",
    "user": "https://github.com/embray"
}
```

> (If at all, I'd personally rewrite the whole sage-logger in C.)

I considered that too.  In fact it might be good to take the Python version I wrote as a prototype for a faster C version.  That said, having a Python version is easier for bootstrapping purposes, and the Python version I wrote is just as fast as the current version, by all indications.



---

archive/issue_comments_284617.json:
```json
{
    "body": "Replying to [comment:61 leif]:\n> (If at all, I'd personally rewrite the whole sage-logger in C.)\n\nI considered that too.  In fact it might be good to take the Python version I wrote as a prototype for a faster C version.  That said, having a Python version is easier for bootstrapping purposes, and the Python version I wrote is just as fast as the current version, by all indications (and can certainly be sped up more than the current naive version).",
    "created_at": "2016-07-11T11:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284617",
    "user": "https://github.com/embray"
}
```

Replying to [comment:61 leif]:
> (If at all, I'd personally rewrite the whole sage-logger in C.)

I considered that too.  In fact it might be good to take the Python version I wrote as a prototype for a faster C version.  That said, having a Python version is easier for bootstrapping purposes, and the Python version I wrote is just as fast as the current version, by all indications (and can certainly be sped up more than the current naive version).



---

archive/issue_comments_284618.json:
```json
{
    "body": "Replying to [comment:65 embray]:\n> > You were not using bash's built-in test `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)`\n> \n> No, I was using bash's built-in test `[ ]`.  This is still a bash built-in--it does not run as a separate process.  The only difference between `[ ]` and `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)` is that the latter is bash-specific and less portable.  But when run explicitly in bash, as opposed to an arbitrary shell, `test` is still a shell built-in.\n\nOh, that's new (to me m) and presumably to bash versions that aren't ages old)...\n\nStill, `[[` is reproducibly faster for me (bash 4.1.5) -- just retested ten times each (with just 0.5 MB input).",
    "created_at": "2016-07-11T13:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284618",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:65 embray]:
> > You were not using bash's built-in test `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)`
> 
> No, I was using bash's built-in test `[ ]`.  This is still a bash built-in--it does not run as a separate process.  The only difference between `[ ]` and `[This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro)` is that the latter is bash-specific and less portable.  But when run explicitly in bash, as opposed to an arbitrary shell, `test` is still a shell built-in.

Oh, that's new (to me m) and presumably to bash versions that aren't ages old)...

Still, `[[` is reproducibly faster for me (bash 4.1.5) -- just retested ten times each (with just 0.5 MB input).



---

archive/issue_comments_284619.json:
```json
{
    "body": "re-introduced branch name\n----\nNew commits:",
    "created_at": "2016-07-12T09:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284619",
    "user": "https://github.com/fchapoton"
}
```

re-introduced branch name
----
New commits:



---

archive/issue_comments_284620.json:
```json
{
    "body": "IMHO we cannot solve this other than by either\n\n* disabling prompting the user, or\n* simply printing a newline after the prompt.\n\n(I think the latter solution to users is the less surprising, as it doesn't change the behaviour.)\n\n\\\\\n\nIf the sage-logger *did* print incomplete lines (such as a prompt from `read`), this would just mess up other output where `echo -n` is used, especially from `configure`.  We'd (again) end up with (now *wrongly* prefixed!) lines like for example\n\n\n```\n...\n[ foo ] checking whether make supports nested variables... /bin/grep\n[ bar ] checking build system type... yes\n[ baz ] checking for C/C++ restrict keyword... x86_64-unknown-linux-gnu\n...\n```\n\nwhere a prefix usually correctly refers to the package from which *the first part of a line* originated, but the result (at the end of the line) comes from another, so doesn't belong to the first part.  (When building in parallel that is, on the terminal, and in `install.log`.)\n\nIn fact, even the left part of a line wouldn't necessarily belong to the package the prefix tells.",
    "created_at": "2016-07-12T14:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284620",
    "user": "https://github.com/nexttime"
}
```

IMHO we cannot solve this other than by either

* disabling prompting the user, or
* simply printing a newline after the prompt.

(I think the latter solution to users is the less surprising, as it doesn't change the behaviour.)

\\

If the sage-logger *did* print incomplete lines (such as a prompt from `read`), this would just mess up other output where `echo -n` is used, especially from `configure`.  We'd (again) end up with (now *wrongly* prefixed!) lines like for example


```
...
[ foo ] checking whether make supports nested variables... /bin/grep
[ bar ] checking build system type... yes
[ baz ] checking for C/C++ restrict keyword... x86_64-unknown-linux-gnu
...
```

where a prefix usually correctly refers to the package from which *the first part of a line* originated, but the result (at the end of the line) comes from another, so doesn't belong to the first part.  (When building in parallel that is, on the terminal, and in `install.log`.)

In fact, even the left part of a line wouldn't necessarily belong to the package the prefix tells.



---

archive/issue_comments_284621.json:
```json
{
    "body": "IMHO we should never have y/n prompts in parallel output. Its pretty much by definition not interactive. The way to pass options to non-interactive processes is via command line options.",
    "created_at": "2016-07-12T20:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284621",
    "user": "https://github.com/vbraun"
}
```

IMHO we should never have y/n prompts in parallel output. Its pretty much by definition not interactive. The way to pass options to non-interactive processes is via command line options.



---

archive/issue_comments_284622.json:
```json
{
    "body": "+1",
    "created_at": "2016-07-12T22:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284622",
    "user": "https://github.com/mkoeppe"
}
```

+1



---

archive/issue_comments_284623.json:
```json
{
    "body": "`@`vbraun, `@`mkoeppe:  It's still not clear to me what you propose.\n\nDisable/remove any prompting?  Disable it depending on how `sage-spkg` got invoked?\n\n(Shouldn't `sage -f ...` -- as given in the example -- proceed anyway, since `-f` means *force*? ;-)",
    "created_at": "2016-07-12T23:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284623",
    "user": "https://github.com/nexttime"
}
```

`@`vbraun, `@`mkoeppe:  It's still not clear to me what you propose.

Disable/remove any prompting?  Disable it depending on how `sage-spkg` got invoked?

(Shouldn't `sage -f ...` -- as given in the example -- proceed anyway, since `-f` means *force*? ;-)



---

archive/issue_comments_284624.json:
```json
{
    "body": "Replying to [comment:71 vbraun]:\n> IMHO we should never have y/n prompts in parallel output. Its pretty much by definition not interactive. The way to pass options to non-interactive processes is via command line options.\n\nI had this discussion with Dima and we agreed that there should be no prompts when running `make` directly, and that there should only be such a prompt when using the high level interface of `./sage -i`.  So that's a large part of what this patch does, before getting mired in all the issues with the prompt itself.\n\nMaybe I should just refactor things further so that `sage-spkg` itself never prompts (and hence the prompt is never raised during `make`, which calls `sage-spkg`), and instead the prompt is `only` issued by the `sage` script itself before any calls to `make`.",
    "created_at": "2016-07-13T08:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284624",
    "user": "https://github.com/embray"
}
```

Replying to [comment:71 vbraun]:
> IMHO we should never have y/n prompts in parallel output. Its pretty much by definition not interactive. The way to pass options to non-interactive processes is via command line options.

I had this discussion with Dima and we agreed that there should be no prompts when running `make` directly, and that there should only be such a prompt when using the high level interface of `./sage -i`.  So that's a large part of what this patch does, before getting mired in all the issues with the prompt itself.

Maybe I should just refactor things further so that `sage-spkg` itself never prompts (and hence the prompt is never raised during `make`, which calls `sage-spkg`), and instead the prompt is `only` issued by the `sage` script itself before any calls to `make`.



---

archive/issue_comments_284625.json:
```json
{
    "body": "Replying to [comment:70 leif]:\n> If the sage-logger *did* print incomplete lines (such as a prompt from `read`), this would just mess up other output where `echo -n` is used, especially from `configure`.  We'd (again) end up with (now *wrongly* prefixed!) lines like for example\n\nPoint taken on this--I didn't believe this would happen as I did't think `make` would interleave the output of individual commands but it definitely can if it's waiting for output for some command, as is wont to happen with `configure`.  Though if you `make` is new enough (>=4.0) you can enable this behavior with `-Oline`. \n\nThat said, this isn't just an issue with sage-logger.  This can happen even without it, and also happened with the previous version of the logger before I added the prefixing (and the line-buffering that came with it).\n\nI do agree with Volker and others though that there's no reason for user input prompts in make.  So I'll go with my proposed solution above and move the prompt entirely to the top-level user interface, and that will simplify this whole matter greatly.\n\nI would still propose keeping my Python implementation of sage-logger because why not?  I can change it to be line-based instead of character-based and that should actually make it faster than the current version by a bit, I think.",
    "created_at": "2016-07-13T09:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284625",
    "user": "https://github.com/embray"
}
```

Replying to [comment:70 leif]:
> If the sage-logger *did* print incomplete lines (such as a prompt from `read`), this would just mess up other output where `echo -n` is used, especially from `configure`.  We'd (again) end up with (now *wrongly* prefixed!) lines like for example

Point taken on this--I didn't believe this would happen as I did't think `make` would interleave the output of individual commands but it definitely can if it's waiting for output for some command, as is wont to happen with `configure`.  Though if you `make` is new enough (>=4.0) you can enable this behavior with `-Oline`. 

That said, this isn't just an issue with sage-logger.  This can happen even without it, and also happened with the previous version of the logger before I added the prefixing (and the line-buffering that came with it).

I do agree with Volker and others though that there's no reason for user input prompts in make.  So I'll go with my proposed solution above and move the prompt entirely to the top-level user interface, and that will simplify this whole matter greatly.

I would still propose keeping my Python implementation of sage-logger because why not?  I can change it to be line-based instead of character-based and that should actually make it faster than the current version by a bit, I think.



---

archive/issue_comments_284626.json:
```json
{
    "body": "+1 for python implementation instead of some untestable bash noise.",
    "created_at": "2016-07-13T10:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284626",
    "user": "https://github.com/vbraun"
}
```

+1 for python implementation instead of some untestable bash noise.



---

archive/issue_comments_284627.json:
```json
{
    "body": "Replying to [comment:76 vbraun]:\n> +1 for python implementation instead of some untestable bash noise.\n\nThe only change I'd perhaps make to the sage-logger (which works and is sufficiently short and simple enough) is to replace `$SED \"s/^/$prefix/\"` by `cat` if the prefix is empty (i.e., no `-p` given), in order to win a *useless use of cat* award.  (More precisely, also move the argument to `sed` into `SED`, and let `SED=cat` if the prefix is empty.  Otherwise we'd have to nearly duplicate a line in case the prefix is empty.)\n\nAlso, it's fast enough with `sed` (see figures above), so reimplementing it in Python would IMHO be just yet another case of *needless use of Python* -- in a script that would be executed by *both* the system's Python and (later) Sage's.\n\n----\n\nI'd be happy with the current branch if Erik just removed the changes to sage-logger from it.",
    "created_at": "2016-07-13T13:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284627",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:76 vbraun]:
> +1 for python implementation instead of some untestable bash noise.

The only change I'd perhaps make to the sage-logger (which works and is sufficiently short and simple enough) is to replace `$SED "s/^/$prefix/"` by `cat` if the prefix is empty (i.e., no `-p` given), in order to win a *useless use of cat* award.  (More precisely, also move the argument to `sed` into `SED`, and let `SED=cat` if the prefix is empty.  Otherwise we'd have to nearly duplicate a line in case the prefix is empty.)

Also, it's fast enough with `sed` (see figures above), so reimplementing it in Python would IMHO be just yet another case of *needless use of Python* -- in a script that would be executed by *both* the system's Python and (later) Sage's.

----

I'd be happy with the current branch if Erik just removed the changes to sage-logger from it.



---

archive/issue_comments_284628.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2016-07-16T12:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284628",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_284629.json:
```json
{
    "body": "Replying to [comment:78 mkoeppe]:\n> *** Priority** changed from critical to blocker\n\nCould we then postpone beautifying the sage-logger to another ticket?\n\nOr do we want to wait with the next release until Erik had a *\"quiet, rainy day\"*? ;-)",
    "created_at": "2016-07-16T12:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284629",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:78 mkoeppe]:
> *** Priority** changed from critical to blocker

Could we then postpone beautifying the sage-logger to another ticket?

Or do we want to wait with the next release until Erik had a *"quiet, rainy day"*? ;-)



---

archive/issue_comments_284630.json:
```json
{
    "body": "I have not followed the details of this implementation.\nBut in any case breaking the installation of all experimental packages is a blocker, IMO.",
    "created_at": "2016-07-16T12:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284630",
    "user": "https://github.com/mkoeppe"
}
```

I have not followed the details of this implementation.
But in any case breaking the installation of all experimental packages is a blocker, IMO.



---

archive/issue_comments_284631.json:
```json
{
    "body": "It isn't really broken, you just have to hit return when installation stops with the warning, or do e.g.\n\n```sh\n  echo yes | ./sage -i latte_int\n```\n",
    "created_at": "2016-07-16T13:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284631",
    "user": "https://github.com/nexttime"
}
```

It isn't really broken, you just have to hit return when installation stops with the warning, or do e.g.

```sh
  echo yes | ./sage -i latte_int
```




---

archive/issue_comments_284632.json:
```json
{
    "body": "Instead of fixing this, could as well revert #20640, #20708, which caused this problem.",
    "created_at": "2016-07-16T18:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284632",
    "user": "https://github.com/mkoeppe"
}
```

Instead of fixing this, could as well revert #20640, #20708, which caused this problem.



---

archive/issue_comments_284633.json:
```json
{
    "body": "I'm leaving tomorrow on vacation (originally today but my travel plans were diverted from the events in Turkey).\n\nIf someone else wants to fix this a very easy workaround (in fact, I would say a solution) without even touching sage-logger is to move the code that prompts the user out of `build/bin/sage-spkg` and into the `sage` script itself which is the \"user interface\" and the only script that should be prompting anything.",
    "created_at": "2016-07-18T09:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284633",
    "user": "https://github.com/embray"
}
```

I'm leaving tomorrow on vacation (originally today but my travel plans were diverted from the events in Turkey).

If someone else wants to fix this a very easy workaround (in fact, I would say a solution) without even touching sage-logger is to move the code that prompts the user out of `build/bin/sage-spkg` and into the `sage` script itself which is the "user interface" and the only script that should be prompting anything.



---

archive/issue_comments_284634.json:
```json
{
    "body": "> so reimplementing it in Python would IMHO be just yet another case of needless use of Python -- in a script that would be executed by both the system's Python and (later) Sage's.\n\nIt's already been done.  And this is a moot point because Python is a requirement now for bootstrapping the build system, so while it may be \"needless\" the more we get rid of piles of bash noise the better.  I agree with Volker here.",
    "created_at": "2016-07-18T09:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284634",
    "user": "https://github.com/embray"
}
```

> so reimplementing it in Python would IMHO be just yet another case of needless use of Python -- in a script that would be executed by both the system's Python and (later) Sage's.

It's already been done.  And this is a moot point because Python is a requirement now for bootstrapping the build system, so while it may be "needless" the more we get rid of piles of bash noise the better.  I agree with Volker here.



---

archive/issue_comments_284635.json:
```json
{
    "body": "Even easier is to modify `sage-spkg` so it still handles the prompting (otherwise a lot of package parsing stuff needs to be duplicated), but for `./sage -i` first have it run `sage-spkg -d` (download-only) which is the only context in which those prompts are displayed, then run `make` (which in turn calls `sage-spkg`) but with the package already downloaded, it won't prompt.  I might add some options to `sage-spkg` to make extra sure it doesn't prompt.",
    "created_at": "2016-07-18T10:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284635",
    "user": "https://github.com/embray"
}
```

Even easier is to modify `sage-spkg` so it still handles the prompting (otherwise a lot of package parsing stuff needs to be duplicated), but for `./sage -i` first have it run `sage-spkg -d` (download-only) which is the only context in which those prompts are displayed, then run `make` (which in turn calls `sage-spkg`) but with the package already downloaded, it won't prompt.  I might add some options to `sage-spkg` to make extra sure it doesn't prompt.



---

archive/issue_comments_284636.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-18T12:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284636",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_284637.json:
```json
{
    "body": "Okay, give this a look.  I've pushed a new branch with a different approach.\n\nThe one downside I see to this approach is that if you run `./sage -i <pkg>` for an experimental package, while it *will* display the warning prompt for that package, if `<pkg>` has any dependencies that are also experimental packages it will not display the prompt for those packages as well (it will still display a warning message).\n\nI think this is acceptable--if the user is accepting to install one experimental package that can include everything that comes along with it.\n\n(Sorry for the noise below--I made a few mistakes in rebasing that I had to fix)\n----\nNew commits:",
    "created_at": "2016-07-18T12:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284637",
    "user": "https://github.com/embray"
}
```

Okay, give this a look.  I've pushed a new branch with a different approach.

The one downside I see to this approach is that if you run `./sage -i <pkg>` for an experimental package, while it *will* display the warning prompt for that package, if `<pkg>` has any dependencies that are also experimental packages it will not display the prompt for those packages as well (it will still display a warning message).

I think this is acceptable--if the user is accepting to install one experimental package that can include everything that comes along with it.

(Sorry for the noise below--I made a few mistakes in rebasing that I had to fix)
----
New commits:



---

archive/issue_comments_284638.json:
```json
{
    "body": "I still want to add my Python implementation of `sage-logger` but that can be kept back for later.",
    "created_at": "2016-07-18T12:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284638",
    "user": "https://github.com/embray"
}
```

I still want to add my Python implementation of `sage-logger` but that can be kept back for later.



---

archive/issue_comments_284639.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-18T12:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284639",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_284640.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-18T12:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_284641.json:
```json
{
    "body": "I just tried `sage -f latte_int` and I observe the following three things (this is with `MAKE='make -j12'` in case that matters:\n- Sage banner in color, interleaved with environment variables in color due to competing output\n- a visible prompt \"Are you sure you want to continue [Y/n]? \"\n- building the dependency 4ti2\n- another warning about experimental packages, but no visible prompt.\n- \"hang\" as before",
    "created_at": "2016-07-18T17:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284641",
    "user": "https://github.com/mkoeppe"
}
```

I just tried `sage -f latte_int` and I observe the following three things (this is with `MAKE='make -j12'` in case that matters:
- Sage banner in color, interleaved with environment variables in color due to competing output
- a visible prompt "Are you sure you want to continue [Y/n]? "
- building the dependency 4ti2
- another warning about experimental packages, but no visible prompt.
- "hang" as before



---

archive/issue_comments_284642.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-18T17:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284642",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_284643.json:
```json
{
    "body": "You can avoid `SED=cat` if you put the pipe into the/a variable (`POSTPROCESS`, say), leaving it empty if no prefix was given, i.e.\n\n```sh\n    POSTPROCESS=\"| $SED 's/^/$prefix/'\"\n    ...\n    ( trap '' SIGINT; eval tee -a \"$logfile\" $POSTPROCESS )\n    ...\n```\n\n\n(I *think*.)",
    "created_at": "2016-07-18T18:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284643",
    "user": "https://github.com/nexttime"
}
```

You can avoid `SED=cat` if you put the pipe into the/a variable (`POSTPROCESS`, say), leaving it empty if no prefix was given, i.e.

```sh
    POSTPROCESS="| $SED 's/^/$prefix/'"
    ...
    ( trap '' SIGINT; eval tee -a "$logfile" $POSTPROCESS )
    ...
```


(I *think*.)



---

archive/issue_comments_284644.json:
```json
{
    "body": "You don't have to install packages in a loop; you can download them one-by-one, and afterwards run `make` on all of them.\n\nIn any case, the following is wrong:\n\n```sh\n        sage-logger \"sage-spkg $INSTALL_OPTIONS -d '$PKG'\" logs/install.log\n\n        # Then make / install the package with no prompts\n        $MAKE SAGE_SPKG=\"sage-spkg $INSTALL_OPTIONS -y\" \"$OPT\"\n```\n\n(`\"$OPT\"` should be `\"$PKG\"`.)\n\n----\n\nUnrelated to this ticket:\n\n\n```sh\n# First of all, make sure that the toolchain is up-to-date\n# (which is a dependency of every package)\n./sage --location\n$MAKE all-toolchain\n```\n\n\nis pretty stupid before we know the package(s) at all exist(s), can be downloaded if needed, whatever.  (And IIRC one gets `*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***` etc. twice for no reason, the first time *before* any relevant processing happens.)",
    "created_at": "2016-07-18T18:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284644",
    "user": "https://github.com/nexttime"
}
```

You don't have to install packages in a loop; you can download them one-by-one, and afterwards run `make` on all of them.

In any case, the following is wrong:

```sh
        sage-logger "sage-spkg $INSTALL_OPTIONS -d '$PKG'" logs/install.log

        # Then make / install the package with no prompts
        $MAKE SAGE_SPKG="sage-spkg $INSTALL_OPTIONS -y" "$OPT"
```

(`"$OPT"` should be `"$PKG"`.)

----

Unrelated to this ticket:


```sh
# First of all, make sure that the toolchain is up-to-date
# (which is a dependency of every package)
./sage --location
$MAKE all-toolchain
```


is pretty stupid before we know the package(s) at all exist(s), can be downloaded if needed, whatever.  (And IIRC one gets `*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***` etc. twice for no reason, the first time *before* any relevant processing happens.)



---

archive/issue_comments_284645.json:
```json
{
    "body": "Replying to [comment:93 leif]:\n> You don't have to install packages in a loop; you can download them one-by-one, and afterwards run `make` on all of them.\n\n+1",
    "created_at": "2016-07-19T11:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284645",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:93 leif]:
> You don't have to install packages in a loop; you can download them one-by-one, and afterwards run `make` on all of them.

+1



---

archive/issue_comments_284646.json:
```json
{
    "body": "I've implemented a \"good enough for next release\" solution.\nMaking it prettier can be on a follow-up ticket.\nNeeds review.\n----\nNew commits:",
    "created_at": "2016-07-20T21:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284646",
    "user": "https://github.com/mkoeppe"
}
```

I've implemented a "good enough for next release" solution.
Making it prettier can be on a follow-up ticket.
Needs review.
----
New commits:



---

archive/issue_comments_284647.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-20T21:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284647",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_284648.json:
```json
{
    "body": "Replying to [comment:96 mkoeppe]:\n> I've implemented a \"good enough for next release\" solution.\n> Making it prettier can be on a follow-up ticket.\n> Needs review.\n> ----\n> New commits:\n> ||[0b1acc2](https://git.sagemath.org/sage.git/commit?id=0b1acc2e58162075755f52e941bcb537d8f33d30)||`Simple (not pretty) solution for #20884`||\n\nOk for me, modulo indentation... (tabs instead of spaces perhaps?)",
    "created_at": "2016-07-20T22:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284648",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:96 mkoeppe]:
> I've implemented a "good enough for next release" solution.
> Making it prettier can be on a follow-up ticket.
> Needs review.
> ----
> New commits:
> ||[0b1acc2](https://git.sagemath.org/sage.git/commit?id=0b1acc2e58162075755f52e941bcb537d8f33d30)||`Simple (not pretty) solution for #20884`||

Ok for me, modulo indentation... (tabs instead of spaces perhaps?)



---

archive/issue_comments_284649.json:
```json
{
    "body": "(At least in theory, we'd have to make sure the prompting message doesn't vanish due to other output when building in parallel though.  But I think in practice this is very unlikely.)",
    "created_at": "2016-07-20T22:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284649",
    "user": "https://github.com/nexttime"
}
```

(At least in theory, we'd have to make sure the prompting message doesn't vanish due to other output when building in parallel though.  But I think in practice this is very unlikely.)



---

archive/issue_comments_284650.json:
```json
{
    "body": "Replying to [comment:98 leif]:\n> (At least in theory, we'd have to make sure the prompting message doesn't vanish due to other output when building in parallel though.  But I think in practice this is very unlikely.)\n\nYes, I hope that a follow-up ticket will do a proper solution, which prompts early (or just bails out and requires an extra flag), rather than prompting in the middle of a parallel build.\n\nMy simple solution just restores (except for cosmetics) the status quo before #20640, #20708 broke the prompting.",
    "created_at": "2016-07-21T07:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284650",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:98 leif]:
> (At least in theory, we'd have to make sure the prompting message doesn't vanish due to other output when building in parallel though.  But I think in practice this is very unlikely.)

Yes, I hope that a follow-up ticket will do a proper solution, which prompts early (or just bails out and requires an extra flag), rather than prompting in the middle of a parallel build.

My simple solution just restores (except for cosmetics) the status quo before #20640, #20708 broke the prompting.



---

archive/issue_comments_284651.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-21T07:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284651",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_284652.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-22T23:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284652",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_284653.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-23T18:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284653",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_284654.json:
```json
{
    "body": "Follow-up ticket - #21082. This is where work on the patch by Erik Bray can continue.",
    "created_at": "2016-07-24T13:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20647#issuecomment-284654",
    "user": "https://github.com/mkoeppe"
}
```

Follow-up ticket - #21082. This is where work on the patch by Erik Bray can continue.
