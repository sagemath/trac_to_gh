# Issue 34346: Upgrade giac to 1.9.0.21

Issue created by migration from https://trac.sagemath.org/ticket/34583

Original creator: mkoeppe

Original creation time: 2022-09-25 01:45:24

CC:  @collares vdelecroix parisse fbissey chapoton




---

Comment by mkoeppe created at 2022-09-25 01:55:50

This new version does not contain a fix for the incompatibility with pari 2.15 (#34537)
----
New commits:


---

Comment by @collares created at 2022-09-30 01:54:34

I am sure this is not the right place to report the bug, but for the record: PARI 2.15.0 seems to segfault when running the giac 1.9.0.21 testsuite via `make check`. This is with the ANYARG patch applied.


```
[...]
  ***   the thread stack overflows !
  current stack size: 1024000 (0.977 Mbytes)
  [hint] set 'threadsizemax' to a nonzero value in your GPRC
  *** matdet: Warning: increasing stack size to 2048000.
  ***   at top-level: matdet([-10,-7,6,-7,1,4,-1,-2,-2,-5,1,7,-6,7,-
  ***                 ^----------------------------------------------
  *** matdet: the thread stack overflows !
  current stack size: 1024000 (0.977 Mbytes)
  [hint] set 'threadsizemax' to a nonzero value in your GPRC
Error in PARI subsystem
Segmentation fault (core dumped)
[...]
FAIL chk_fhan4 (exit status: 1)
```



---

Comment by tornaria created at 2022-10-17 03:06:11

To avoid the segfault I am applying the patch below.

```
Fix a failing test due to thread stack overflow

--- a/check/chk_fhan4	2018-03-13 15:27:11.000000000 -0300
+++ b/check/chk_fhan4	2022-10-14 18:51:12.604731890 -0300
@@ -1,4 +1,5 @@
 #! /bin/sh
 unset LANG
+export PARI_SIZE=2048000
 ../src/icas TP04-sol.cas > TP04.tst
 diff TP04.tst TP04-sol.cas.out1
```


A better fix for upstream is probably to set `threadsizemax` to a good multiple of `parisize`.

Is there a public repo of giac where to follow the code? A place to report bugs or make PR? I still have to apply a few more patches for the voidlinux pkg, it would be nice if those could be upstreamed (please ping me for more info).


---

Comment by mkoeppe created at 2022-10-17 03:22:56

Replying to [comment:5 Gonzalo Tornaría]:
> Is there a public repo of giac where to follow the code?

See #31563#comment:64


---

Comment by strogdon created at 2022-10-20 16:21:43

Should the main configure be revised so that system `giac` that are too old are not used? On gentoo with `giac-1.7.0.13-r1` installed I have in `config.log`

```
configure:26431: checking for giac >= 1.5.0, <= 1.9.999
configure:26551: result: /usr/bin/giac
configure:26557: checking for giac/giac.h
configure:26557: g++ -std=gnu++11 -c    -Dlinux   -I/usr/include conftest.cpp >&5
configure:26557: $? = 0
configure:26557: result: yes
```

and also

```
configure:26590: g++ -std=gnu++11 -o conftest    -Dlinux   -I/usr/include -Wl,-O1 -Wl,--as-needed conftest.cpp -lgiac  -lecm -lpari -lcurl -lcliquer -lcddgmp -lbz2 -larb -lflint -lmpfr -lglpk -lgmp -lm  -lntl >&5
configure:26590: $? = 0
configure:26610: result: -lgiac
configure:26638: will use system package and not install SPKG giac
```



---

Comment by mkoeppe created at 2022-10-20 16:31:38

how old is too old?


---

Comment by strogdon created at 2022-10-20 16:57:19

Replying to [comment:9 Matthias Köppe]:
> how old is too old?
Not sure. But the `1.7.0.13-r1` gives failing doctests (see https://github.com/cschwan/sage-on-gentoo/issues/721).


---

Comment by fbissey created at 2022-10-20 18:52:18

The thing is, #32354 silently raised the minimum version needed to `1.7.0-27` but did not translate it to a configure check.


---

Comment by chapoton created at 2022-10-21 06:44:13

see #34679 for a motivated demand from Giac's main author ; maybe this could be handled here too ?


---

Comment by fbissey created at 2022-10-21 07:03:08

Replying to [comment:12 Frédéric Chapoton]:
> see #34679 for a motivated demand from Giac's main author ; maybe this could be handled here too ?

We could depend on it. But then it is imperative to have the scope of `USE_OBJET_BIDON` fixed. At the moment we use `--disable-gui` and we know we have to use the work around. We could demand `fltk` as dependency and never have to worry about the work around. But leaving it automagical depending on the system, we cannot predict when we need to add it or not.


---

Comment by parisse created at 2022-10-23 20:42:19

I have released 1.9.0-25 this evening, it now includes FLTK 1.3.8 and compiles it if there is no valid FLTK header available on the system.


---

Comment by fbissey created at 2022-10-23 20:52:14

Replying to [comment:14 Bernard Parisse]:
> I have released 1.9.0-25 this evening, it now includes FLTK 1.3.8 and compiles it if there is no valid FLTK header available on the system.

So, GUI is now mandatory? You always get FLTK one way or another?


---

Comment by git created at 2022-10-23 21:08:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-10-23 21:08:55

fails to build on macOS


---

Comment by fbissey created at 2022-10-23 21:09:45

Replying to [comment:18 Matthias Köppe]:
> fails to build on macOS

Is it failing to build fltk by any chance?


---

Comment by fbissey created at 2022-10-23 21:55:08

From `./configure --help` in 1.9.0-25

```
  --enable-gui            The disable-gui option has no more effect because
                          FLTK 1.3.8 is now included in Giac/Xcas. If FLTK
                          compilation fails or if your local FLTK install is
                          incompatible, you should configure with
                          --disable-fltk
  --enable-fltk           enable FLTK [[default=yes]]
```

But disabling `fltk` doesn't. It just skip the autodetection and automatic compiling of fltk-1.3.8 if no suitable fltk is detected. If fltk is not available or your configuration flags are not properly set for it, compilation will fail because of missing fltk stuff.


---

Attachment

It built fltk stuff during the configure run.


---

Comment by fbissey created at 2022-10-23 22:02:09

Replying to [comment:21 Matthias Köppe]:
> It built fltk stuff during the configure run. 

That's consistent with what I saw in `configure.ac`.

```
AC_CHECK_HEADERS(FL/Fl.H,[],[tar xfj fltk-1.3.8-source.tar.bz2 ; cd fltk-1.3.8 && ./configure --disable-shared && make && cd .. && CXXFLAGS="$CXXFLAGS -I../fltk-1.3.8" && LDFLAGS="$LDFLAGS -L../fltk-1.3.8/lib"] ) 
```



---

Comment by fbissey created at 2022-10-23 22:12:23

Very hard to figure things out with all those deprecation warnings (and I got plenty of those on linux with gcc-12 as well) but I found this bit

```
Xcas1.cc:3725:29: error: unknown type name 'Fl_Widget'
  void Menu_Insert_ItemName(Fl_Widget * w , void*) {
```

which seems to imply some flags are not properly passed/set correctly for fltk.


---

Comment by fbissey created at 2022-10-23 22:14:52

I don't know if that would have an impact, but you should also remove the `OBJET_BIDON` work around. It is not useful anymore and may actually interfere with fltk.


---

Comment by git created at 2022-10-23 22:23:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-23 22:24:35

4f4c358 cherry-picked from #34679


---

Comment by git created at 2022-10-23 22:30:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-23 22:30:51

Backing out these old fixes does not seem to change anything


---

Comment by fbissey created at 2022-10-24 00:00:49

Replying to [comment:28 Matthias Köppe]:
> Backing out these old fixes does not seem to change anything

That would have been nice if it was that simple. I'll have a go on linux with internal fltk to see what happens later this afternoon.


---

Comment by fbissey created at 2022-10-24 02:37:00

I can reproduce in linux, and I did it at `-j1` to have a nice trace

```
libtool: compile:  g++ -std=c++14 -DHAVE_CONFIG_H -I. -I.. -DIN_GIAC -I. -I.. -I. -I.. -g -O2 -I../fltk-1.3.8 -fno-strict-aliasing -DGIAC_GENERIC_CONSTANTS -DTIMEOUT -MT Xcas1.lo -MD -MP -MF .deps/Xcas1.Tpo -c Xcas1.cc  -fPIC -DPIC -o .libs/Xcas1.o
## a bunch of gcc-12 warnings about deprecation
Xcas1.cc:3725:8: error: variable or field 'Menu_Insert_ItemName' declared void
 3725 |   void Menu_Insert_ItemName(Fl_Widget * w , void*) {
      |        ^~~~~~~~~~~~~~~~~~~~
Xcas1.cc:3725:29: error: 'Fl_Widget' was not declared in this scope
 3725 |   void Menu_Insert_ItemName(Fl_Widget * w , void*) {
      |                             ^~~~~~~~~
Xcas1.cc:3725:41: error: 'w' was not declared in this scope
 3725 |   void Menu_Insert_ItemName(Fl_Widget * w , void*) {
      |                                         ^
Xcas1.cc:3725:45: error: expected primary-expression before 'void'
 3725 |   void Menu_Insert_ItemName(Fl_Widget * w , void*) {
      |                                             ^~~~
Xcas1.cc:3791:3: error: 'Fl_Menu_Item' does not name a type
 3791 |   Fl_Menu_Item icas_xcas_menu[] = {
      |   ^~~~~~~~~~~~
```

Something is going wrong with the header inclusion.


---

Comment by fbissey created at 2022-10-24 03:26:24

This is a bit silly but easy to overlook when not paying attention. 

`@`parisse your trick to ship fltk internally has a serious shortcomings. From `configure.ac`

```
	dnl force FLTK static compilation if FLTK not present
	AC_CHECK_HEADERS(FL/Fl.H,[],[tar xfj fltk-1.3.8-source.tar.bz2 ; cd fltk-1.3.8 && ./configure --disable-shared && make && cd .. && CXXFLAGS="$CXXFLAGS -I../fltk-1.3.8" && LDFLAGS="$LDFLAGS -L../fltk-1.3.8/lib"] ) 
	dnl X11, check for opengl, fltk
	AC_CHECK_LIB(X11,main)
	AC_CHECK_LIB(Xinerama, main)
	AC_CHECK_LIB(fontconfig, main)
	AC_CHECK_LIB(Xft, main)
	AC_CHECK_LIB(Xext, main)
	AC_CHECK_LIB(Xrender, main)
	AC_CHECK_LIB(fltk_gl, main)
	AC_CHECK_LIB(fltk, main)
	if test "$HAVE_LIBFLTK" = "1"; then
	   AC_DEFINE([HAVE_LIBFLVW],1, [Now defined if fltk is available])
	fi
	AC_CHECK_LIB(z,main)
	AC_CHECK_HEADERS(png.h, AC_CHECK_LIB(png,main))
	AC_CHECK_LIB(jpeg, main)
	AC_CHECK_LIB(fltk_images, main)
	FLTK_LIBS="$LIBS $X_LIBS"
	AC_SUBST(FLTK_LIBS)
```

At the end of the day I found that `config.h` was listing `HAVE_LIBFLTK` as undefined, which in turn means that inclusion of fltk headers in `Xcas1.cc`, where we see the failure is not happening because there is still a guard `ifdef HAVE_LIBFLTK` - which should go if fltk is mandatory (and it really is).

But let's figure why it happens. So, inspection of `config.log`

```
configure:21818: checking for main in -lfltk
configure:21840: g++ -std=c++14 -o conftest -g -O2 -I../fltk-1.3.8   -L../fltk-1.3.8/lib conftest.cpp -lfltk  -lXrender -lXext -lXft -lfontconfig -lXinerama -lX11 -lGL -lcurl -lglpk -lao -ldl -lpng16 -lm -lecm -lmpfi -lmpfr -lgmp  >&5
/usr/lib/gcc/x86_64-pc-linux-gnu/12/../../../../x86_64-pc-linux-gnu/bin/ld: cannot find -lfltk
```

Well, `-I../fltk-1.3.8` and `-L../fltk-1.3.8/lib` will work very well once you go to the subfolder `src`, but it doesn't from the top level source directory from which `configure` is run. In effect, you probably want to replace `../fltk-1.3.8` by something that does `${srcdir}/fltk-1.3.8` which would be an absolute path that would be right in both cases.


---

Comment by fbissey created at 2022-10-24 04:19:27

I should add one more thing. Removing the guards that prevents the inclusion of headers will enable you to compile the like of `Xcas1.cc` which are using fltk headers. But if that's the only thing you do, you will fail at linking time. `AC_CHECK_LIB(fltk, main)` failed so `-lftlk` has not been added to `LIBS` and you will get missing symbols.


---

Comment by fbissey created at 2022-10-24 20:17:19

1.9.0.27 out but I cannot see changes that would make a difference to vendored fltk.

I may prepare something for upstream, `configure.ac` needs touching.


---

Comment by fbissey created at 2022-11-01 23:20:42

I got further with 

```
diff --git a/configure.ac b/configure.ac
index 1d77ab8..cd789ad 100644
--- a/configure.ac
+++ b/configure.ac
@@ -449,6 +449,8 @@ dnl		AC_CHECK_LIB(GLU, main)
 	AC_CHECK_LIB(Xft, main)
 	AC_CHECK_LIB(Xext, main)
 	AC_CHECK_LIB(Xrender, main)
+	save_LDFLAGS="$LDFLAGS"
+	LDFLAGS="$LDFLAGS -L./fltk-1.3.8/lib"
 	AC_CHECK_LIB(fltk_gl, main)
 	AC_CHECK_LIB(fltk, main)
 	if test "$HAVE_LIBFLTK" = "1"; then
@@ -458,6 +460,7 @@ dnl		AC_CHECK_LIB(GLU, main)
 	AC_CHECK_HEADERS(png.h, AC_CHECK_LIB(png,main))
 	AC_CHECK_LIB(jpeg, main)
 	AC_CHECK_LIB(fltk_images, main)
+	LDFLAGS="$save_LDFLAGS"
 	FLTK_LIBS="$LIBS $X_LIBS"
 	AC_SUBST(FLTK_LIBS)
   fi
```

but it failed linking on my box because the libraries collected by the configure script were not complete compared to what the vendored fltk found and used on my system. The next step is either to minimise the configuration of the vendored fltk or use `fltk-config`. For info that's what my vendored fltk needs once built

```
fbissey@tarazed /home/portage/sci-mathematics/giac-1.9.0.27/work/giac-1.9.0 $ ./fltk-1.3.8/fltk-config --ldflags
-L./fltk-1.3.8/lib -lfltk -lXrender -lXcursor -lXfixes -lXext -lXft -lfontconfig -lXinerama -lpthread -lm -lX11
```

Things could be really simplified if `fltk-config` is looked for and used.


---

Comment by fbissey created at 2022-11-01 23:34:21

OK that got me through

```
diff --git a/configure.ac b/configure.ac
index 1d77ab8..c0ab350 100644
--- a/configure.ac
+++ b/configure.ac
@@ -444,11 +444,15 @@ dnl		AC_CHECK_LIB(GLU, main)
 	AC_CHECK_HEADERS(FL/Fl.H,[],[tar xfj fltk-1.3.8-source.tar.bz2 ; cd fltk-1.3.8 && ./configure --disable-shared && make && cd .. && CXXFLAGS="$CXXFLAGS -I../fltk-1.3.8" && LDFLAGS="$LDFLAGS -L../fltk-1.3.8/lib"] ) 
 	dnl X11, check for opengl, fltk
 	AC_CHECK_LIB(X11,main)
+	AC_CHECK_LIB(Xcursor,main)
+	AC_CHECK_LIB(Xfixes,main)
 	AC_CHECK_LIB(Xinerama, main)
 	AC_CHECK_LIB(fontconfig, main)
 	AC_CHECK_LIB(Xft, main)
 	AC_CHECK_LIB(Xext, main)
 	AC_CHECK_LIB(Xrender, main)
+	save_LDFLAGS="$LDFLAGS"
+	LDFLAGS="$LDFLAGS -L./fltk-1.3.8/lib"
 	AC_CHECK_LIB(fltk_gl, main)
 	AC_CHECK_LIB(fltk, main)
 	if test "$HAVE_LIBFLTK" = "1"; then
@@ -458,6 +462,7 @@ dnl		AC_CHECK_LIB(GLU, main)
 	AC_CHECK_HEADERS(png.h, AC_CHECK_LIB(png,main))
 	AC_CHECK_LIB(jpeg, main)
 	AC_CHECK_LIB(fltk_images, main)
+	LDFLAGS="$save_LDFLAGS"
 	FLTK_LIBS="$LIBS $X_LIBS"
 	AC_SUBST(FLTK_LIBS)
   fi
```

but checking for `fltk-config`, building fltk if it is absent, and then querying it properly would tidy up the configure script in my opinion.


---

Comment by mkoeppe created at 2022-11-01 23:37:11

Can a "headless" version of fltk be built when no GUI libraries are available (no X11, no Wayland, ...)? If no, then this is a problem for Sage. We definitely want to be able to build it in a server environment without GUI libraries.


---

Comment by fbissey created at 2022-11-01 23:43:14

Good question. Looking into it.


---

Comment by fbissey created at 2022-11-01 23:47:12

On Linux, needs `libX11` at a minimum as far as I can tell.


---

Comment by fbissey created at 2022-11-02 00:07:53

GUI stuff is for xcas. libgiac itself is free from gui stuff. If we could do a lib only build and not use pexpect at all we could achieve that goal.


---

Comment by fbissey created at 2022-11-07 01:04:33

1.9.0.29 is out - it doesn't fix the flaws that I pointed out in configure.ac to find a vendored fltk. But in this version `--disable-fltk` works. So, we can have a headless install without any dependencies on X11.


---

Comment by git created at 2022-11-12 03:23:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by parisse created at 2022-11-24 09:13:54

Why not make the default with GUI enabled and use the environment variable for server installs?

I'm making changes to configure.ac, thanks for pointing to the broken path to fltk-1.3.8 while configure runs, I'm modifying to
AC_CHECK_HEADERS(FL/Fl.H,[],[tar xfj fltk-1.3.8-source.tar.bz2 ; cd fltk-1.3.8 && ./configure --disable-shared && make && cd .. && CXXFLAGS="$CXXFLAGS -I../fltk-1.3.8 -I./fltk-1.3.8" && LDFLAGS="$LDFLAGS -L../fltk-1.3.8/lib -L./fltk-1.3.8/lib"] )


---

Comment by fbissey created at 2022-11-24 09:21:04

Replying to [comment:43 Bernard Parisse]:
> I'm making changes to configure.ac, thanks for pointing to the broken path to fltk-1.3.8 while configure runs, I'm modifying to
> AC_CHECK_HEADERS(FL/Fl.H,[],[tar xfj fltk-1.3.8-source.tar.bz2 ; cd fltk-1.3.8 && ./configure --disable-shared && make && cd .. && CXXFLAGS="$CXXFLAGS -I../fltk-1.3.8 -I./fltk-1.3.8" && LDFLAGS="$LDFLAGS -L../fltk-1.3.8/lib -L./fltk-1.3.8/lib"] ) 
> 

Do not forget the extra checks from comment:35 for `Xcursor` and `Xfixes`. If fltk finds them at configure time they will be needed to link xcas as well. Also note that you do not need to change `CXXFLAGS` because you do no test for headers again. Only `LDFLAGS` needs adjusting.


---

Comment by mkoeppe created at 2022-11-24 20:18:05

Replying to [comment:43 Bernard Parisse]:
> Why not make the default with GUI enabled and use the environment variable for server installs?

I'm not aware of a use case for the GUI within Sage; maybe you can explain what functionality it would give to Sage users?


---

Comment by parisse created at 2022-11-29 19:38:27

If you think of a researcher in maths, it's probably not useful, many are probably working with the commandline interface or nohup scripts in non interactive mode. A college student might find useful some GUI features of Xcas like wizards to help enter some commands, or the recently introduced tracemode for function and parametric plots, or interactive analytic geometry 2d/3d, etc.

But to be honest, that's not my main motivation. Sage has some benefits using some features of Giac. Now I would appreciate if Giac could benefit from being included inside Sage: and that means here a straightforward compilation path, this is especially important for systems where Giac/Xcas is not packaged. I would really appreciate if Sage developers could reward my involvment in math software implementation by enabling by default the full version of Giac/Xcas with GUI inside Sagemaths, instead of a stripped version without GUI.

Thanks!
