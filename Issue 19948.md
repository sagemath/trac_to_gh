# Issue 19948: Upgrade to SymPy-1.0

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2016-03-10 14:25:21

https://github.com/sympy/sympy/wiki/Release-Notes-for-1.0

It could be installed as usually or via `pip install -U sympy`.


---

Comment by rws created at 2016-03-10 16:32:35


```
$ ./sage -p mpmath
Successfully installed mpmath-0.19
$ ./sage -p sympy
building sympy
Please install the mpmath package with a version >= 0.19
Error building sympy
```

Any hints?
----
New commits:


---

Comment by fbissey created at 2016-03-11 06:18:52

Replying to [comment:3 rws]:
> {{{
> $ ./sage -p mpmath
> Successfully installed mpmath-0.19
> $ ./sage -p sympy
> building sympy
> Please install the mpmath package with a version >= 0.19
> Error building sympy
> }}}
> Any hints?
> ----
> New commits:
> ||[6971607](http://git.sagemath.org/sage.git/commit/?id=6971607ce1b72388e57a742ab8f5f0ffb4af1c0e)||`pkg version/chksum/patch removed`||

I think I have. In the past (prior to this version) `sympy`'s `setup.py` was importing `sympy` itself. The danger then was to import the previously installed `sympy` rather the new `sympy`. So we add this

```
export PYTHONPATH="."
echo "building sympy"
python -S setup.py build
```

The `-S` is the cause of your trouble, look it up. So you should remove the `PYTHONPATH` stuff, the `-S` and remove the corresponding comments in `spkg-install`.


---

Comment by git created at 2016-03-11 08:09:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-03-11 08:10:04

Thanks, that was it. So there are changes that affect doctests:

```
sage -t --warn-long 27.4 src/sage/symbolic/integration/integral.py  # 1 doctest failed
sage -t --warn-long 27.4 src/sage/symbolic/expression.pyx  # 3 doctests failed
sage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed
```

That's only from a partial quick scan.


---

Comment by rws created at 2016-03-11 08:47:51

> {{{
> sage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed
> }}}
This can be minimized to

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: sympy.sympify(3*u(n), evaluate=False)
NotImplementedError: SymPy function 'u' doesn't exist
```

which disappears when `3*u(n)` is changed to `u(n)*3` or `u(n)`

EDIT: I will just change the order in the muls for the doctest, and open a ticket. The case is rare and can be fixed after the upgrade.


---

Comment by git created at 2016-03-11 09:11:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-03-11 09:52:45

IMO comment:7 (#20194) is a serious regression and it should be fixed with the upgrade.


---

Comment by git created at 2016-03-11 16:03:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-03-11 16:15:58

The doctest is fixed but something seems not right in the sympification of undefined Sage functions. The case in #20194 crashes Sympy's parser and I have reported in https://github.com/sympy/sympy/issues/10795


---

Comment by rws created at 2016-03-11 16:16:55

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-03-11 23:03:30

Do I understand you correctly that [0391252](http://git.sagemath.org/sage.git/commit/?id=03912520043631024635c3d6d09b86743b6c411e) means you do not have to change the test in the French book?


---

Comment by tscrim created at 2016-03-11 23:53:30

Now that my Sage has finished rebuilding, the answer to my question is no, we still have a regression.


---

Comment by tscrim created at 2016-03-12 01:11:46

With this branch, we have:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: x = int(3)
sage: x*u(n)
3*u(n)
sage: sympy.sympify(x*u(n))
3*u(n)
sage: sympy.sympify(x*u(n), evaluate=False)
3*u(n)

sage: x = 3._sympy_()
sage: sympy.sympify(x*u(n), evaluate=False)
3*u(n)
```

However, I think this is the problem:

```
sage: type(3*u(n))
<type 'sage.symbolic.expression.Expression'>
sage: type(u(n)*3)
<class 'sympy.core.mul.Mul'>

sage: x = int(3)
sage: type(x*u(n))
<class 'sympy.core.mul.Mul'>
sage: type(u(n)*x)
<class 'sympy.core.mul.Mul'>
```

So it is probably something on our end.


---

Comment by tscrim created at 2016-03-12 01:13:01

Yes, that is the behavior change. Contrast that with the current 7.1.rc0:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: type(3*u(n))
<class 'sympy.core.mul.Mul'>
sage: type(u(n)*3)
<class 'sympy.core.mul.Mul'>
```



---

Comment by tscrim created at 2016-03-12 01:17:33

I also get the same behavior in comment:15 when I am at commit [f92f927](http://git.sagemath.org/sage.git/commit/?id=f92f927e44e1638efb08f01f2136010d236daaef).


---

Comment by rws created at 2016-03-13 08:52:12

This is SymPy-0.7.6.1:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: cm = sage.structure.element.get_coercion_model()
sage: steps,res = cm.analyse(ZZ, parent(u))
sage: steps
['Will try _r_action and _l_action']
```

This is 1.0:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: cm = sage.structure.element.get_coercion_model()
sage: steps,res = cm.analyse(ZZ, parent(u))
sage: steps
['Right operand is not Sage element, will try _sage_.',
 'Will try _r_action and _l_action']

Conversion map:
  From: Integer Ring
  To:   Symbolic Ring, None))
```



---

Comment by tscrim created at 2016-03-13 11:33:03

So it seems the issue is coming from the fact that in 0.7.6.1, we have `type(parent(u)) is type` returning `False` before but with 1.0, it is `True`. Which, AFAICS, is only involved in `discover_action`, but the result is still a `None`.

```
sage: cm.discover_action(ZZ, parent(u(n)), operator.mul)   # Same in 0.7.6.1
```

Although to be fair, I think we should test against `u(n)` since parentheses get evaluated before `*`. In that case, I get the same result in both versions:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: parent(u(n))
u
sage: steps,res = cm.analyse(ZZ, parent(u(n))); steps
['Will try _r_action and _l_action']
```


I'm thinking we will need someone who is much more familiar with the coercion framework than I am.


---

Comment by rws created at 2016-03-13 14:08:02

And indeed, it was #14723 which prompted the addition of `_sage_` methods to many SymPy classes. So no way out of fixing coercion here.


---

Comment by git created at 2016-03-13 16:39:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-03-13 16:44:31

As you can see from #14723 the `UndefFunction._sage_` addition only affects future changes. This branch now has this removed from SymPy-1.0 to make it work with current Sage. Any changes to the coercion system because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly. I didn't do a full test on this, so I'll have to have a final look at this tomorrow.


---

Comment by tscrim created at 2016-03-13 22:38:28

Okay, I think I have a better understanding of things. So here's what I think is going on. The coercion system is working fine:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: import operator
sage: cm = sage.structure.element.get_coercion_model()

sage: cm.common_parent(3, u(n))
Symbolic Ring
sage: cm.common_parent(u(n), 3)
Symbolic Ring
sage: type(cm.bin_op(3, u(n), operator.mul))
<type 'sage.symbolic.expression.Expression'>
sage: type(cm.bin_op(u(n), 3, operator.mul))
<type 'sage.symbolic.expression.Expression'>
```

That is now returning something rather than erroring out. This is coming from

```
sage: (u(n))._sage_()
u(n)
sage: type(_)
<type 'sage.symbolic.expression.Expression'>
```

We go to the coercion framework because of `__mul__` from integers. Previously, because it was erroring out, the multiplication code then tried `__rmul__` from the SymPy function, which resulted in a SymPy object. Now, we get different behaviors because when the SymPy object is on the left, we call its `__mul__`, which results in a SymPy object.

I'm also retracting the last part of comment:15, and the issue might be in SymPy and how it tries to parse our symbolic expressions:

```
sage: f = function('f')
sage: x = var('x')
sage: sympy.sympify(f(x), evaluate=False)
f(x)
sage: sympy.sympify(3*f(x), evaluate=False)
AttributeError: 'Call' object has no attribute 'id'
```

However, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:

```
sage: f._sympy_()
sage: f(x)._sympy_()
sage: (f(x)+3)._sympy_()
```


I'm okay with your patch. Although we typically set the first patched version to `p0`.


---

Comment by tscrim created at 2016-03-13 23:16:06

I changed the version to `p0`, but this is likely to only affect you (and really, doesn't do anything). I also fixed a failing doctest in `unicode_art.py` as it sends things to SymPy to create teh art. Otherwise all tests pass for me.
----
New commits:


---

Comment by rws created at 2016-03-14 07:10:51

Your changes are fine. Consider them as reviewed.


---

Comment by rws created at 2016-03-14 07:51:21

> ...Any changes ~~to the coercion system~~ because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly.
See #20204.


---

Comment by tscrim created at 2016-03-14 20:41:21

Thank you.


---

Comment by tscrim created at 2016-03-14 20:41:21

Changing status from needs_review to positive_review.


---

Comment by rws created at 2016-03-15 07:09:12

Thanks for the review.


---

Comment by vbraun created at 2016-03-20 20:14:53

PDF docs fail

```
! Emergency stop.
<inserted text> 
                $
l.22231 \PYG{g+go}{    ⎮   √x}
```



---

Comment by vbraun created at 2016-03-20 20:14:53

Changing status from positive_review to needs_work.


---

Comment by rws created at 2016-03-21 07:28:11

Cannot confirm with `./sage --docbuild all pdf`. This is on OpenSuSE Leap with TeXLive 201384.


---

Comment by rws created at 2016-03-21 07:28:11

Changing status from needs_work to needs_info.


---

Comment by tscrim created at 2016-03-22 03:28:49

I am unable to reproduce this either on my laptop either. Volker, can you post the logs if the buildbot fails again, along with its latex setup? Otherwise what we will have to do is change the test...


---

Comment by tscrim created at 2016-03-22 03:28:49

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2016-03-22 15:28:16


```
$ rpm -q texlive
texlive-2014-19.20140525_r34255.fc23.x86_64
```



---

Comment by vbraun created at 2016-03-22 15:28:16

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-03-22 15:45:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-03-22 15:46:39

How could that have worked for you, `\sqrt` in text mode should be illegal in all TeX versions.


---

Comment by vbraun created at 2016-03-22 15:46:39

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-03-22 19:14:27

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-03-22 19:14:27

Hmm...strange. With your changes, everything works. Thank you for figuring out what the root of the problem is. :P


---

Comment by vbraun created at 2016-03-23 12:46:48

Resolution: fixed
