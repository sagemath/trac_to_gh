# Issue 29676: Upgrade OpenBLAS 0.3.10

Issue created by migration from https://trac.sagemath.org/ticket/29913

Original creator: slelievre

Original creation time: 2020-06-20 10:42:08

CC:  slelievre dimpase fbissey arojas @kliem

Keywords: upgrade, openblas

This is to upgrade to OpenBLAS 0.3.10.


---

Comment by slelievre created at 2020-06-20 10:42:19

This would solve #28768.


---

Comment by mkoeppe created at 2020-11-17 03:09:02

Numpy is having trouble with OpenBLAS 0.3.12 - https://numpy.org/devdocs/release/1.19.4-notes.html

So we should probably wait before we make updates to OpenBLAS


---

Comment by dunfield created at 2020-12-05 01:59:58

Just commenting to note that upgrading to the (as yet unreleased) 0.3.13 would close #31007.


---

Comment by mkoeppe created at 2020-12-20 00:38:17

Our current OpenBLAS 0.3.9 also does not build on `cygwin-minimal` (https://github.com/mkoeppe/sage/runs/1582256022):

```
  [openblas-0.3.9]   gcc -O2 -g -O2 -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -DNO_AVX512 -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=2 -DMAX_PARALLEL_NUMBER=1 -DUSE_TLS -DVERSION=\"0.3.9\" -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I. -O2 -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -DNO_AVX512 -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=2 -DMAX_PARALLEL_NUMBER=1 -DUSE_TLS -DVERSION=\"0.3.9\" -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I.. -L/opt/sage-cf31b79036db96b5fd9e0b22f44c3692bc22356b/lib -Wl,-rpath,/opt/sage-cf31b79036db96b5fd9e0b22f44c3692bc22356b/lib  cygopenblas.def dllinit.o \
  [openblas-0.3.9]   -shared -o ../cygopenblas.dll -Wl,--out-implib,../libopenblas.dll.a \
  [openblas-0.3.9]   -Wl,--whole-archive ../cygopenblas_atomp-r0.3.9.a -Wl,--no-whole-archive -L/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64/opt/lib -L/c/mingw810/prerequisites/x86_64-zlib-static/lib -L/c/mingw810/prerequisites/x86_64-w64-mingw32-static/lib -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0 -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/../lib -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../lib -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib -LC:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../..  -lgfortran -lmingw32 -lmoldname -lmingwex -lmsvcrt -lquadmath -lm -lmingw32 -lmoldname -lmingwex -lmsvcrt -lpthread -liconv -lmingw32 -lmoldname -lmingwex -lmsvcrt   -lgfortran -lgfortran
  [openblas-0.3.9]   C:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgfortran.a(read.o):(.text$_gfortrani_convert_real+0x6e): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `strtoflt128'
  [openblas-0.3.9]   C:/ProgramData/Chocolatey/lib/mingw/tools/install/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgfortran.a(read.o):(.text$_gfortrani_convert_infnan+0x46): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `strtoflt128'
  [openblas-0.3.9]   collect2: error: ld returned 1 exit status
  [openblas-0.3.9]   make[4]: *** [Makefile:98: ../cygopenblas.dll] Error 1
```

It should be checked whether the proposed upgrades fix this error.


---

Comment by mkoeppe created at 2020-12-20 01:07:54

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-12-20 01:07:54

New commits:


---

Comment by mkoeppe created at 2020-12-20 19:16:58

Replying to [comment:7 mkoeppe]:
> Our current OpenBLAS 0.3.9 also does not build on `cygwin-minimal` [...]
> It should be checked whether the proposed upgrades fix this error. 

Same error with 0.3.13


---

Comment by mkoeppe created at 2020-12-20 19:20:19

Otherwise this update looks unproblematic.


---

Comment by mkoeppe created at 2020-12-21 18:59:51

Replying to [comment:11 mkoeppe]:
> Replying to [comment:7 mkoeppe]:
> > Our current OpenBLAS 0.3.9 also does not build on `cygwin-minimal` [...]
> > It should be checked whether the proposed upgrades fix this error. 
> 
> Same error with 0.3.13 

This really had nothing to do with openblas; see #31091.


---

Comment by @kliem created at 2021-01-06 09:31:42

The testsuite on ubuntu bionic was not run

https://github.com/mkoeppe/sage/runs/1583194874?check_suite_focus=true


```
 ./sage -t -p --all --logfile=logs/ptest.log
no stored timings available
Running doctests with ID 2020-12-20-03-25-13-c92ee485.
Using --optional=debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting entire Sage library.
Traceback (most recent call last):
  File "/sage/src/bin/sage-runtests", line 182, in <module>
    err = DC.run()
  File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 1233, in run
    self.expand_files_into_sources()
  File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 816, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 816, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 811, in expand
    if not skipfile(os.path.join(root,file)):
  File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 228, in skipfile
    for line in F:
  File "/usr/lib/python3.6/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 5109: ordinal not in range(128)
Makefile:189: recipe for target 'ptest' failed
make: *** [ptest] Error 1
(error ignored)
```


Is this related to this ticket?


---

Comment by @kliem created at 2021-01-06 09:51:04

Never mind. openblas isn't installed in this case, so it can't be the cause.


---

Comment by dimpase created at 2021-01-06 09:56:43

seems like an unrelated update broke python 3.6. Maybe we should stop foolong around with 3.6 already in 9.3?

If that 1% of Sage users without a better Python want to build Sage, they can first install a better Python.


---

Comment by @kliem created at 2021-01-06 10:05:41

This ticket looks good to me.

There are a few occasions where https://github.com/mkoeppe/sage/actions/runs/433187403

fails, but it looks like github related failures (running out of disk space etc). I can't discover any new failures and I checked that the doctests still look good.


---

Comment by @kliem created at 2021-01-06 10:05:41

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-01-06 18:53:29

Thanks!


---

Comment by mkoeppe created at 2021-01-06 18:58:43

Replying to [comment:16 gh-kliem]:
> The testsuite on ubuntu bionic was not run
> 
> https://github.com/mkoeppe/sage/runs/1583194874?check_suite_focus=true
> 
> {{{
>  ./sage -t -p --all --logfile=logs/ptest.log
> no stored timings available
> Running doctests with ID 2020-12-20-03-25-13-c92ee485.
> Using --optional=debian,dochtml,memlimit,pip,sage,sage_spkg
> Doctesting entire Sage library.
> Traceback (most recent call last):
>   File "/sage/src/bin/sage-runtests", line 182, in <module>
>     err = DC.run()
>   File "/sage/local/lib/python3.6/site-packages/sage/doctest/control.py", line 1233, in run
> ....
> UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 5109: ordinal not in range(128)
> Makefile:189: recipe for target 'ptest' failed
> make: *** [ptest] Error 1
> (error ignored)
> }}}

Thanks for catching this - I did not see it because unfortunately it does not show up in a log file. I have created #31191 for it.


---

Comment by vbraun created at 2021-01-17 13:46:06

Resolution: fixed
