# Issue 14766: calling factorials of RIF

Issue created by migration from https://trac.sagemath.org/ticket/15003

Original creator: dkrenn

Original creation time: 2013-08-06 07:00:09

Keywords: factorial RIF RealIntervalField calling inconsistent beginner

One can calculate factorials of RIF-Elements with

```
sage: factorial(RIF(2.3,5.7))
1.?e3
```

but calling it by

```
sage: (RIF(2.3,5.7)).factorial()
Traceback (click to the left of this block for traceback)
...
AttributeError: 'sage.rings.real_mpfi.RealIntervalFieldElement' object
has no attribute 'factorial'
```

does not work. This is in contrast to `.log()`, `.sqrt()`, etc., where it works.



---

Comment by dkrenn created at 2013-08-06 07:00:47

Changing priority from major to minor.


---

Comment by amitjamadagni created at 2014-02-13 06:06:17

Okay I get it the implementation fails for  this 

sage: factorial(RIF(2.3))

2.683437381955768?

sage: gamma(RIF(2.3))

1.166711905198161?

so if the gamma is incremented that sets the factorial function.

Any comments on this would be helpful.


---

Comment by amitjamadagni created at 2014-02-15 01:41:43

Changing status from new to needs_review.


---

Comment by amitjamadagni created at 2014-02-15 01:41:43

New commits:


---

Comment by ppurka created at 2014-02-18 03:11:53

Looking at your code, I have a question - why don't you simply return the gamma like this? It avoids creating yet another variable.

```
def factorial(self):
    return (self+1).gamma()
```



---

Comment by amitjamadagni created at 2014-02-18 05:00:32

Did you mean only this without defining the other function , then would it work on intervals ?? I need to check that out


---

Comment by ppurka created at 2014-02-18 07:13:48

It does work on intervals.

By doing what I wrote above, you can avoid doing new memory allocations. The addition operation `self+1` already does a new memory allocation. There is no need to do so yet again with defining `x` and doing `x._new()`.

This is just my understanding of the code in `RIF`. I have personally never used this field before.


---

Comment by git created at 2014-02-18 08:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by amitjamadagni created at 2014-02-18 08:08:36

Yeah I get the explanation. I was just following the other methods defined. Please let me know if any other changes are required. Thanks.


---

Comment by ppurka created at 2014-02-18 15:29:48

Thanks for the changes! I have some reservations in giving this a positive review in its _current_ form. This needs a review by someone who knows why the factorial function is implemented as it is currently -- it is implemented as a class. So, let's hope someone knowledgeable comes along and takes a look at this ticket. :)

I have been looking at the different fields. Except for `ZZ` and `SR`, none of them have `factorial()` method defined. If indeed this method is introduced, it should be introduced in many places where it makes sense (e.g. `CC`, `RR`, `RDF`, `QQ`, etc), if only to redirect to the generic function call `factorial(self)`; like

```
def factorial(self):
    return sage.functions.other.factorial(self)
```


About your implementation: there is no need to call `RIF`. The addition already returns an element of RIF. I am saying this just for any future modifications you make to the functions; in some cases (but not this factorial function) it can make improvements :)

```
sage: a = RIF(2.5, 4.5)
sage: a+1     
1.?e1
sage: %timeit RIF(a+1)
100000 loops, best of 3: 7.54 us per loop
sage: %timeit a+1     
100000 loops, best of 3: 4.75 us per loop
```

For the factorial function itself, speed wise there is no difference since the gamma function is much slower than this `RIF` call!

```
sage: %timeit (a+1).gamma()
1000 loops, best of 3: 240 us per loop
sage: %timeit RIF(a+1).gamma()
1000 loops, best of 3: 243 us per loop
```



---

Comment by dkrenn created at 2014-02-18 16:11:25

Replying to [comment:11 ppurka]:
> I have been looking at the different fields. Except for `ZZ` and `SR`, none of them have `factorial()` method defined. 
> If indeed this method is introduced, it should be introduced in many places where it makes sense (e.g. `CC`, `RR`, `RDF`, `QQ`, etc), if only to redirect to the generic function call `factorial(self)`; like
> {{{
> def factorial(self):
>     return sage.functions.other.factorial(self)
> }}}

Hmm...IMHO this is not ideal. It should be the other way around, i.e., the general `factorial`-function should check if the element has `.factorial` and executes it. Only if not, it comes up with solution on its own. (I have not checked the current implementations; its just came in my mind by thinking about it).


---

Comment by ppurka created at 2014-02-18 16:16:40

Replying to [comment:12 dkrenn]:
> Hmm...IMHO this is not ideal. It should be the other way around, i.e., the general `factorial`-function should check if the element has `.factorial` and executes it. Only if not, it comes up with solution on its own. (I have not checked the current implementations; its just came in my mind by thinking about it).

I was thinking about that too, but it seems that the generic factorial function is in cython -- the one in `sage/functions/other.py` is just a shell function/class to use `ZZ.factorial()` if it is an integer.


---

Comment by amitjamadagni created at 2014-02-18 17:02:08

This being my first patch I still do not have the in depth knowledge of placing of various methods and classes. I am still not getting the part that is being discussed , is it that the main factorial function should check for whether the element has .factorial and do the necessary and if not available it is left to its own. I may be completely wrong but if they could be some comments on my understanding it would be of great help. Thanks.


---

Comment by ppurka created at 2014-02-19 00:39:32

Replying to [comment:14 amitjamadagni]:
> This being my first patch I still do not have the in depth knowledge of placing of various methods and classes. I am still not getting the part that is being discussed , is it that the main factorial function should check for whether the element has .factorial and do the necessary and if not available it is left to its own. I may be completely wrong but if they could be some comments on my understanding it would be of great help. Thanks.
What dkrenn mentioned is to add the following to the `factorial()` call in `sage/functions/other.py`

```
try:
    number.factorial()
except AttributeError:
    <do the rest>
```

instead of what I wrote in comment:11. But don't try to modify the main factorial function right now. It is unclear to me at least what is the right thing to do here.


---

Comment by rws created at 2014-04-14 07:35:01

Replying to [comment:15 ppurka]:
> But don't try to modify the main factorial function right now. It is unclear to me at least what is the right thing to do here.

Well, as that's still unclear it would not hurt to implement at least the `RIF` member function. I rebased the branch on 6.2.beta7.

Please open a ticket for the refactoring of `functions/other.py:factorial()` if you think it necessary.
----
New commits:


---

Comment by rws created at 2014-04-14 07:35:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-04-14 19:59:03

Is amitjamadagni really your full name?


---

Comment by ppurka created at 2014-04-15 07:58:07

`@`rws: I think it is necessary to make the general change to `sage.functions.other.factorial`. I was waiting for a reply from `@`dkrenn or someone familiar with the implementation of factorial before proceeding to give this a positive review. It will be helpful if you open such tickets as necessary before giving a positive review - otherwise it will remain lost in the discussion.

`@`vbraun: I think the the full name should be "Amit Jamadagni", but I will let the author clarify.

`@`amitjamadagni: Please add your name alphabetically to the page http://trac.sagemath.org That way we will not have to guess your full name in future tickets. It will also help if in the future you have your full name in the `Author` field of git commits.


---

Comment by rws created at 2014-04-15 08:16:31

Replying to [comment:19 ppurka]:
> `@`rws: I think it is necessary to make the general change to `sage.functions.other.factorial`.
But that is an enhancement while this is a defect. And this is not only independent from that but the refactoring will also benefit from this ticket being separate and not waited on until eternity. 

Please see #16166.


---

Comment by ppurka created at 2014-04-15 08:36:19

Replying to [comment:20 rws]:
> But that is an enhancement while this is a defect. And this is not only independent from that but the refactoring will also benefit from this ticket being separate and not waited on until eternity. 
> 
> Please see #16166.

Thanks for opening the new ticket. This ticket is also an enhancement to `RIF`. And the implementation here is not complete because the same change should happen to, for example, `CIF`. Even after the current ticket, we still have inconsistent behavior depending on whether the element is in `RIF` or `RR` or `ZZ`, etc.

For example, suppose you run a long program or sequence of functions where the output happens to become an element of `QQ`:

```
sage: a = QQ(2)  # suppose "a" is got as an output of a function
sage: a.factorial()
...
AttributeError: 'sage.rings.rational.Rational' object has no attribute 'factorial'

sage: a = ZZ(2)  # for another input to the function, output is an element of ZZ
sage: a.factorial()
2
```

From the end user point of view, the behavior is very inconsistent and depends on whether after all the computations you get back an element from `QQ` or `ZZ`. This needs to be fixed more generally, and this is why I said I wasn't ready to give it positive review in comment:11

My question was: should we fix all these different fields just by patching them one by one, OR is there a general way to fix all the fields at one go?


---

Comment by rws created at 2014-04-15 08:46:46

Replying to [comment:21 ppurka]:
> From the end user point of view, the behavior is very inconsistent and depends on whether after all the computations you get back an element from `QQ` or `ZZ`. This needs to be fixed more generally, and this is why I said I wasn't ready to give it positive review in comment:11
Well it's not the scope of this ticket, and warrants yet another ticket which I will happily open in your name.
> My question was: should we fix all these different fields just by patching them one by one, OR is there a general way to fix all the fields at one go?
The author has resolved one of these and this deserves a positive review. It shows that there was a need for it in RIF. We don't know about the others. Many thanks for bringing up the big picture.

Let me finally remind you of this note in the development manuals:

“The perfect is the enemy of the good”

The point of the review is to ensure that the Sage code guidelines are followed and that the the implementation is mathematically correct. Please refrain from aditional feature requests or open-ended discussion about alternative implementations. If you want the patch written differently, your suggestion should be a clear and actionable request.


---

Comment by ppurka created at 2014-04-15 10:20:56

Replying to [comment:22 rws]:
> “The perfect is the enemy of the good”
> Please refrain from aditional feature requests or open-ended discussion about alternative implementations.

The whole point of my argument was to highlight that we should not introduce more inconsistency, if possible. I agree that the ticket fixes this for `RIF`; primarily because the author happened to use it and discovered one place where it is inconsistent with the behavior of other functions.

I have taught a course with Sage, and I have seen students struggle with the way things are implemented. The pain points were not whether something is slow or incorrect - it was mostly about the fact that the behavior varied wildly depending on what field the students were working on. Now, try to explain to non-computer science students why things work different in reals, integers, and rationals, what is the difference between a symbolic expression and a symbolic function, etc.

As developers, we have got used to the way certain things work, and we tend to automatically write code that behaves properly. If you really want to find more such inconsistencies, then ask a person who is unfamiliar with Sage and observe what they write, and how they expect some newly written code to behave.

> If you want the patch written differently, your suggestion should be a clear and actionable request.

I was quite clear in stating that I sought the opinion of someone knowledgeable about the `factorial` implementation. I didn't implement that function and I do not know why it is implemented the way it is.


---

Comment by jdemeyer created at 2014-04-15 11:55:06

This patch is bad. Why the extra call to the `RIF` constructor? Simply `(self+1).gamma()` should work.


```
sage: x = RealIntervalField(100)(100).factorial()
sage: parent(x)
Real Interval Field with 53 bits of precision
```



---

Comment by jdemeyer created at 2014-04-15 11:55:06

Changing status from positive_review to needs_work.


---

Comment by amitjamadagni created at 2014-04-15 11:59:21

Replying to [comment:24 jdemeyer]:
> This patch is bad. Why the extra call to the `RIF` constructor? Simply `(self+1).gamma()` should work.

That was already mentioned in the comment 11. The benchmarks were worked out. I will submit a patch with the edit. Thanks 
> 
> {{{
> sage: x = RealIntervalField(100)(100).factorial()
> sage: parent(x)
> Real Interval Field with 53 bits of precision
> }}}


---

Comment by jdemeyer created at 2014-04-15 12:00:32

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-04-15 12:02:17

Replying to [comment:25 amitjamadagni]:
> That was already mentioned in the comment 11.
It's not just about speed, but also about different parents, as my example shows.


---

Comment by jdemeyer created at 2014-04-15 12:02:49

Anyway, this patch should fix it.


---

Comment by git created at 2014-04-15 12:03:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by amitjamadagni created at 2014-04-15 12:21:14

That was my first attempt at fixing a bug for Sage. Thanks for all the comments, help and reviews. I hope I can contribute more to the project.


---

Comment by amitjamadagni created at 2014-04-15 13:00:58

Replying to [comment:19 ppurka]:
> `@`rws: I think it is necessary to make the general change to `sage.functions.other.factorial`. I was waiting for a reply from `@`dkrenn or someone familiar with the implementation of factorial before proceeding to give this a positive review. It will be helpful if you open such tickets as necessary before giving a positive review - otherwise it will remain lost in the discussion.
> 
> `@`vbraun: I think the the full name should be "Amit Jamadagni", but I will let the author clarify.
> 
> `@`amitjamadagni: Please add your name alphabetically to the page http://trac.sagemath.org That way we will not have to guess your full name in future tickets. It will also help if in the future you have your full name in the `Author` field of git commits.

`@`ppurka
I guess as jdemeyer has sent in the patch I am refraining myself from adding to the author list, as I did not solve it in a better way.


---

Comment by ppurka created at 2014-04-15 13:08:48

Replying to [comment:32 amitjamadagni]:
> `@`ppurka
> I guess as jdemeyer has sent in the patch I am refraining myself from adding to the author list, as I did not solve it in a better way.
No problem. Add yourself in. Just put in your real name and not your login.

Edit: By "Add yourself in" I mean, to make the "Author" field look like "<your name>, Jeroen Demeyer".


---

Comment by jdemeyer created at 2014-04-16 06:39:09

Can anybody review my patch please?


---

Comment by ppurka created at 2014-04-16 08:41:01

Replying to [comment:35 jdemeyer]:
> Can anybody review my patch please?
Looks good to me. The other concerns can be addressed in #16166 that `@`rws created.


---

Comment by ppurka created at 2014-04-16 08:41:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-04-20 23:37:57

Resolution: fixed
