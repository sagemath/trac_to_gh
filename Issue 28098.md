# Issue 28098: Cythonize Yen_k_shortest_simple_paths and feng_k_shortest_simple_paths

Issue created by migration from https://trac.sagemath.org/ticket/28335

Original creator: @rajat1433

Original creation time: 2019-08-09 04:13:37

CC:  dcoudert

Keywords: gsoc2019

This ticket aims to implement these methods in Cython for speed up and performance gains.


---

Comment by git created at 2019-08-10 04:27:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @rajat1433 created at 2019-08-10 04:31:35

I have cythonized the Yen and Feng's methods here as can be seen from the last commit in the list of above commits.

In short I have used cython variables and cython data structures where ever possible in these methods.

Also I have named the cython methods as yen_k_shortest_simple_paths_cython and feng_k_shortest_simple_paths_cython to separate them from yen_k_shortest_simple_paths and feng_k_shortest_simple_paths for consistency and speed checks.
feng_k_shortest_simple_paths
Changes will be more clear once #27859 gets included.


---

Comment by dcoudert created at 2019-08-10 11:00:21

The way you declare the priority queue is incorrect. This will fail if edge weights are not integers.

The list `idx_to_path` stores all paths, and you never remove any. So it can become giant. Can't you instead use a dictionary and a counter to assign each new path a unique id, and remove paths that are no longer useful ? In fact, you can certainly combine `idx_to_path` and `heap_paths` in a unique dictionary, no ?


---

Comment by git created at 2019-08-10 19:29:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-10 19:31:29

Replying to [comment:4 dcoudert]:
> The way you declare the priority queue is incorrect. This will fail if edge weights are not integers.
> 
> The list `idx_to_path` stores all paths, and you never remove any. So it can become giant. Can't you instead use a dictionary and a counter to assign each new path a unique id, and remove paths that are no longer useful ? In fact, you can certainly combine `idx_to_path` and `heap_paths` in a unique dictionary, no ?

I agree with both the statements and made the changes appropriately


---

Comment by dcoudert created at 2019-08-11 07:46:38

Seems correct.
The next step is to speed up the test `hash_path not in idx_to_path.values()`, but I don't have good ideas yet on how to do that.


---

Comment by git created at 2019-08-12 04:05:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-12 04:05:42


```
sage: from sage.graphs.path_enumeration import feng_k_shortest_simple_paths_cyth
....: on
sage: from sage.graphs.path_enumeration import feng_k_shortest_simple_paths
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths_cytho
....: n
sage: sage: G = digraphs.RandomDirectedGNP(30, .05)
....:         sage: while not G.is_strongly_connected():
....:         ....:     G = digraphs.RandomDirectedGNP(30, .1)
....:         sage: for u, v in list(G.edges(labels=False, sort=False)):
....:         ....:     G.set_edge_label(u, v, randint(1, 10))
....:         sage: V = G.vertices()
....:         sage: shuffle(V)
....:         sage: u, v = V[:2]
sage: it_Y = feng_k_shortest_simple_paths_cython(G, u, v, by_weight=True, report
....: _weight=True)
sage: it_F = feng_k_shortest_simple_paths(G, u, v, by_weight=True, report_weight
....: =True)
sage: for i in range(205):
....:     if(it_F.next()[0]!=it_Y.next()[0]):
....:         print("wrong")
....:         
....:     
....: 
sage: it_Y = yen_k_shortest_simple_paths_cython(G, u, v, by_weight=True, report_
....: weight=True)
sage: it_F = yen_k_shortest_simple_paths(G, u, v, by_weight=True, report_weight=
....: True)
sage: for i in range(205):
....:     if(it_F.next()[0]!=it_Y.next()[0]):
....:         print("wrong")
....:         
....:     
....:
```



---

Comment by @rajat1433 created at 2019-08-12 04:08:55

After thinking about the utility of the hash_path not in idx_to_path.values() test , it seems like we don't really require it as per our algorithm as we are working on graphs without multiedges hence the path will no be repeated into the heap. So this test is unnecessary here.

Also the test supporting it is shown in the above comment.


---

Comment by git created at 2019-08-12 04:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-12 04:48:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-12 08:40:40

I'm not fully convinced by the removal of this test. It is part of the algorithm for a reason. Consider an unweighted graph with many paths from u to v with same cost. For instance a complete graph. A same path might certainly been found several times, no ?


---

Comment by @rajat1433 created at 2019-08-12 11:57:27

Replying to [comment:13 dcoudert]:
> I'm not fully convinced by the removal of this test. It is part of the algorithm for a reason. Consider an unweighted graph with many paths from u to v with same cost. For instance a complete graph. A same path might certainly been found several times, no ?

Actual algorithm never specify to do this test. I added this test thinking that a path may be repeated in the heap, but the way Yen's algorithm unfolds its not possible to add the same path twice.





```
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths_cython
sage: g = graphs.CompleteGraph(5)
sage: it_Y = yen_k_shortest_simple_paths_cython(g, 0, 4)
sage: list(it_Y)
[[0, 4],
 [0, 1, 4],
 [0, 2, 4],
 [0, 3, 4],
 [0, 3, 1, 4],
 [0, 3, 2, 4],
 [0, 2, 1, 4],
 [0, 2, 3, 4],
 [0, 1, 2, 4],
 [0, 1, 3, 4],
 [0, 1, 3, 2, 4],
 [0, 1, 2, 3, 4],
 [0, 2, 3, 1, 4],
 [0, 2, 1, 3, 4],
 [0, 3, 2, 1, 4],
 [0, 3, 1, 2, 4]]

```



```
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths
sage: g = graphs.CompleteGraph(5)
sage: it_Y = yen_k_shortest_simple_paths(g, 0, 4)
sage: list(it_Y)
[[0, 4],
 [0, 1, 4],
 [0, 2, 4],
 [0, 3, 4],
 [0, 1, 2, 4],
 [0, 1, 3, 4],
 [0, 2, 1, 4],
 [0, 2, 3, 4],
 [0, 3, 1, 4],
 [0, 3, 2, 4],
 [0, 1, 2, 3, 4],
 [0, 1, 3, 2, 4],
 [0, 2, 1, 3, 4],
 [0, 2, 3, 1, 4],
 [0, 3, 1, 2, 4],
 [0, 3, 2, 1, 4]]

```



---

Comment by @rajat1433 created at 2019-08-12 12:02:46


```
sage: g = g.to_directed()
sage: show(g)
Launched png viewer for Graphics object consisting of 30 graphics primitives
sage: from sage.graphs.path_enumeration import feng_k_shortest_simple_paths_cython
sage: it_F = feng_k_shortest_simple_paths_cython(g, 0, 4)
sage: list(it_F)
[[0, 4],
 [0, 3, 4],
 [0, 2, 4],
 [0, 1, 4],
 [0, 1, 3, 4],
 [0, 1, 2, 4],
 [0, 2, 3, 4],
 [0, 2, 1, 4],
 [0, 3, 2, 4],
 [0, 3, 1, 4],
 [0, 3, 1, 2, 4],
 [0, 3, 2, 1, 4],
 [0, 2, 1, 3, 4],
 [0, 2, 3, 1, 4],
 [0, 1, 2, 3, 4],
 [0, 1, 3, 2, 4]]
```



---

Comment by @rajat1433 created at 2019-08-12 12:03:02

Changing status from new to needs_review.


---

Comment by git created at 2019-08-13 11:09:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-13 11:11:16

I did some changes in Yen. I think it is cleaner this way. I have not touched Feng. You can certainly try to follow what I did to start improving it.


---

Comment by git created at 2019-08-14 03:49:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-16 04:54:18

Following are the comparisons results between:
There's a slight improvement observed.

```
sage: g = DiGraph(graphs.Grid2dGraph(10, 10))
sage: from sage.graphs.path_enumeration import feng_k_shortest_simple_paths_cyth
....: on
sage: from sage.graphs.path_enumeration import feng_k_shortest_simple_paths
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths
sage: from sage.graphs.path_enumeration import yen_k_shortest_simple_paths_cytho
....: n
sage:  p = yen_k_shortest_simple_paths(g, (0, 0), (9, 9))
sage: %timeit [p.next() for i in range(1000)]
1 loop, best of 3: 1.25 s per loop
sage:  p = yen_k_shortest_simple_paths_cython(g, (0, 0), (9, 9))
sage: %timeit [p.next() for i in range(1000)]
1 loop, best of 3: 1.24 s per loop
sage:  p = feng_k_shortest_simple_paths(g, (0, 0), (9, 9))
sage: %timeit [p.next() for i in range(5000)]
1 loop, best of 3: 4.62 s per loop
sage:  p = feng_k_shortest_simple_paths_cython(g, (0, 0), (9, 9))
sage: %timeit [p.next() for i in range(5000)]
1 loop, best of 3: 4.72 s per loop

sage: g = DiGraph()
sage: for i in range(120):
....: ....:     g.add_edge(i,i+1,i%5)
....:     
sage: for i in range(30, 40, 1):
....: ....:     g.add_edge(i,120,i%2)
....:     
sage:  %timeit list(yen_k_shortest_simple_paths_directed(g, 0, 120, by_weight=Tr
....: ue))
sage:  %timeit list(yen_k_shortest_simple_paths(g, 0, 120, by_weight=True))
10 loops, best of 3: 46.6 ms per loop
sage:  %timeit list(yen_k_shortest_simple_paths_cython(g, 0, 120, by_weight=True
....: ))
10 loops, best of 3: 45.6 ms per loop
sage:  %timeit list(feng_k_shortest_simple_paths_cython(g, 0, 120, by_weight=Tru
....: e))
100 loops, best of 3: 7.62 ms per loop
sage:  %timeit list(feng_k_shortest_simple_paths(g, 0, 120, by_weight=True))
100 loops, best of 3: 7.74 ms per loop

```



---

Comment by git created at 2019-08-16 04:56:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-19 16:14:19

Now that #27859 has been merged, it's much easier to check the code ;)

Instead of creating new methods, I propose to replace the code of the previous Yen's method by the code of the Cython version, and to do the same for Feng.


---

Comment by git created at 2019-08-19 17:05:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-20 16:45:55

LGTM. We have a better code for Yen, and I propose to postpone to another ticket possible improvements for Feng (it should be much faster, but it's not).


---

Comment by dcoudert created at 2019-08-20 16:45:55

Changing status from needs_review to positive_review.


---

Comment by git created at 2019-08-20 18:06:14

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-08-20 18:06:14

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by @rajat1433 created at 2019-08-20 18:08:04

I think it was necessary to rebase this tkt on 8.9beta7 otherwise some merge conflict might happen.
Can you please set it to positive review again.


---

Comment by dcoudert created at 2019-08-21 08:02:32

It was not necessary ! Firstly, I tested the ticket over beta 7, and secondly this does not prevent possible conflicts with other tickets (depends on the order in which the tickets are merged for next release).


---

Comment by dcoudert created at 2019-08-21 08:02:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-08-29 20:02:10

Resolution: fixed
