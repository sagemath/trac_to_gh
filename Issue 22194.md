# Issue 22194: py3: sagenb is not python3 compatible

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-02-24 09:56:14

CC:  dimpase vbraun jdemeyer kcrisman embray

at least in the current version 0.13

maybe the latest git version is slightly better in this respect


---

Comment by jdemeyer created at 2017-02-24 10:44:37

Given that sagenb is essentially a dead project, I don't think that it will ever be Python3 compliant.


---

Comment by chapoton created at 2017-02-24 10:45:42

I did a lot of work on python3 compliance of sagenb since the last release. At least this should prevent the build to stop on syntax errors.


---

Comment by dimpase created at 2017-02-24 10:55:20

IMHO one does not need supernatural resurrection powers to port a dead python2 project of sagenb size to python3---given that all of its python components are python3 compatible (which was not true for Twisted until a couple of years back).


---

Comment by chapoton created at 2017-02-27 13:09:31

The update of sagenb is probably dependent of #20922.


---

Comment by chapoton created at 2017-04-04 19:18:41

can we hope to make a (maybe last) release of the legacy notebook ?


---

Comment by kcrisman created at 2017-04-04 19:43:27

At the least https://github.com/sagemath/sagenb/pull/416 and your own https://github.com/sagemath/sagenb/pull/423 would need to be merged first, right?

I don't really see any reason to not keep the legacy notebook around for quite some time, granting that it will not receive much attention.   We just got a support request from someone using Sage 4.6 (!) who really didn't want to upgrade; this is positively new compared to that.

But I definitely agree that whatever the absolute minimum needed to get sagenb to work minimally with python3 is fine.


---

Comment by chapoton created at 2017-04-06 12:09:39

​https://github.com/sagemath/sagenb/pull/423 should now be ready


---

Comment by chapoton created at 2017-05-03 13:18:59

Would it be possible to make a new release of sagenb, please ?


---

Comment by dimpase created at 2017-05-03 13:45:12

Replying to [comment:11 chapoton]:
> Would it be possible to make a new release of sagenb, please ?

I'll try.


---

Comment by dimpase created at 2017-05-10 14:11:15

Please test https://github.com/sagemath/sagenb/tree/1.0.rc0
(copy of the current master)
before I go ahead with making a new Sage package.
It works for me following the instructions in HACKING (updated, to take care of changed names and of the need to deal with mathjax).

Report issues on github, please


---

Comment by dimpase created at 2017-05-24 22:11:55

the new sagenb is on #23066 and needs review.


---

Comment by kcrisman created at 2017-05-24 23:44:39

> the new sagenb is on #23066 and needs review.
Reading the comments there and at #22787 make it unclear to me whether this one is, in fact, py3 compatible.  

What about comment:6 about #20922 - still valid?


---

Comment by dimpase created at 2017-05-25 04:59:57

Replying to [comment:15 kcrisman]:
> > the new sagenb is on #23066 and needs review.
> Reading the comments there and at #22787 make it unclear to me whether this one is, in fact, py3 compatible.  

Given that Sage does not run with Python 3 yet, it's a bit early to say, no?

> 
> What about comment:6 about #20922 - still valid?

Probably not really, for it does work without #20922 - I don't get doctest failures mentoined in comment 4 on #20922.

```
$ sage -t --long local/lib/python2.7/site-packages/sagenb/notebook/challenge.py
Running doctests with ID 2017-05-25-05-57-19-d9e71fa3.
Git branch: sagenb10
Using --optional=ccache,database_gap,gap_packages,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 117.7 local/lib/python2.7/site-packages/sagenb/notebook/challenge.py
    [113 tests, 0.38 s]
----------------------------------------------------------------------
All tests passed!
```


I also do not see any mention of `click` package in sagenb's installation log.


---

Comment by kcrisman created at 2017-05-25 14:06:42

> > > the new sagenb is on #23066 and needs review.
> > Reading the comments there and at #22787 make it unclear to me whether this one is, in fact, py3 compatible.  
> 
> Given that Sage does not run with Python 3 yet, it's a bit early to say, no?

Haha, I thought we were closer to that now.  No worries, just checking in.


---

Comment by dimpase created at 2018-04-16 12:32:58

see also https://github.com/sagemath/sagenb/issues/440
- some of these dependencies should go, indeed.


---

Comment by chapoton created at 2018-05-16 09:54:24

We should also get rid of the sagenb documentation building, which does not work in the python3 sage..

See

https://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/4.15.0-20-generic/petitbonum/2018-05-15%2012:37:45?plugin=docbuild


---

Comment by chapoton created at 2018-05-17 08:46:56

see #25382


---

Comment by kcrisman created at 2018-05-17 12:26:58

What is the current status of this ticket (as opposed to the documentation build)?  I thought at least some of these issues were dealt with.  If it's just the graph functionality those can certainly be disabled, as I don't think they have worked properly for some time.  If it's certain dependencies that is required for py3 that is somewhat different.


---

Comment by chapoton created at 2018-05-18 11:23:39

trying to install sagenb, one gets

```
[sagenb-1.0.1]   Removing source in /tmp/pip-pzy8td0f-build
[sagenb-1.0.1] Successfully installed sagenb-1.0.1
[sagenb-1.0.1] Cleaning up...
[sagenb-1.0.1] ./spkg-install: line 56: cd: /home/chapoton/sage3/local/lib/python2.7/site-packages/sagenb/data: No such file or directory
[sagenb-1.0.1] Error: Cannot find SageNB data directory.
[sagenb-1.0.1] 
```

because it is looking for sageNB data in the python2 library..


---

Comment by chapoton created at 2018-05-18 11:44:02

Dima, could you please make a new release of sagenb ?

Currently (apart from the mathjax issue above in spkg-install) sagenb 1.0.1 installs with sage3, but fails to run because of 

```
Traceback (most recent call last):
  File "/home/chapoton/sage3/src/bin/sage-notebook", line 268, in <module>
    launcher(unknown)
  File "/home/chapoton/sage3/src/bin/sage-notebook", line 69, in __init__
    from sagenb.notebook.notebook_object import notebook
  File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sagenb/notebook/notebook_object.py", line 23, in <module>
    from . import run_notebook
  File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sagenb/notebook/run_notebook.py", line 21, in <module>
    from exceptions import SystemExit
ModuleNotFoundError: No module named 'exceptions'
```

which has been fixed after the release of 1.0.1


---

Comment by dimpase created at 2018-05-18 12:58:28

OK, I'll try today. Sorry for sitting on this...


---

Comment by chapoton created at 2018-05-18 18:58:50

see also #25394


---

Comment by dimpase created at 2018-05-22 16:00:38

shouldn't the description say "current 1.0.1" ? 
(sorry, I'm still not done with a new release)


---

Comment by dimpase created at 2018-05-22 16:52:13

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-05-22 16:52:13

here is the latest master from sagenb repo
----
New commits:


---

Comment by chapoton created at 2018-05-22 17:46:35

Thanks for the release, Dima. It will not yet be fully py3-compatible, but this should not prevent us from being able to install sagenb in py3-sage.

This second part means : first remove the conditional statement on PYTHON3 in spkg_install (on top of the changes in #25394) and do something for the lines about mathjax in this spkg-install. I managed to install sagenb in py3 sage by commenting out these mathjax lines, but this is obviously not a correct solution.


---

Comment by chapoton created at 2018-05-22 18:56:09

I have put a tentative branch at public/ticket/22431 for the changes in spkg-install (it needs work).


---

Comment by kcrisman created at 2018-05-22 19:51:00

What would "full py3 compatibility" entail?  Just curious.  THANK YOU for this work.


---

Comment by git created at 2018-05-22 21:31:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-05-22 21:33:41

Replying to [comment:32 chapoton]:
> I have put a tentative branch at public/ticket/22431 for the changes in spkg-install (it needs work).

OK, I've merged this branch into the branch on the ticket.


---

Comment by chapoton created at 2018-05-23 06:08:30

Then there probably just remains to understand what to do with the line

```
ln -s ../../../../../share/mathjax/ mathjax
```

This way to find the mathjax package seem to be very ugly... Maybe Erik would have an idea for a better replacement that would also work for python3 ?


---

Comment by chapoton created at 2018-05-23 09:40:37

Replying to [comment:33 kcrisman]:
> What would "full py3 compatibility" entail?  Just curious.  THANK YOU for this work.

Well, this just means that somebody has to install sagenb on py3-sage (using the branch here and also the hacking instructions for sagenb to work with a git branch for sagenb) and try running "sage -n=sagenb", fixing step by step all errors (in sagenb code) that occurs until the notebook finally starts. This probably implies caring about unicode (str versus bytes). But there could also be other bad surprises as well. I have started to do that, but have very urgent other matters to handle.


---

Comment by jhpalmieri created at 2018-05-23 16:06:57

Replying to [comment:36 chapoton]:
> Then there probably just remains to understand what to do with the line
> {{{
> ln -s ../../../../../share/mathjax/ mathjax
> }}}
> This way to find the mathjax package seem to be very ugly... Maybe Erik would have an idea for a better replacement that would also work for python3 ?

Why don't we use `ln -s $SAGE_LOCAL/share/mathjax mathjax`? Or use `$SAGE_SHARE/mathjax`? And are those any better?


---

Comment by kcrisman created at 2018-05-23 16:11:40

Probably that's what should have been done in the first place, but removing MathJax from sagenb proper was done pretty quickly and this "just worked"?  That's my guess.


---

Comment by jhpalmieri created at 2018-05-23 18:14:35

Also, on OS X at least, the command should be `ln -s -h ...` – as it is, if the mathjax link already exists, then the current command creates another link within that linked folder. It is okay if the `sagenb/data` directory contains

```
mathjax -> ../../../../../share/mathjax/
```

but it doesn't make sense for `$SAGE_LOCAL/share/mathjax` to contain this.

(On OS X, the documentation for the `-h` flag says "If the target_file or target_dir is a symbolic link, do not follow it." There is also a `-n` flag: "Same as -h, for compatibility with other ln implementations.")


---

Comment by chapoton created at 2018-05-27 07:41:31

I have modified the ln to mathjax. This seems to work well with python2. Not yet tested with python3. 

We need people that test if the new proposed release of sagenb works well enough. Not much has changed since the last release.
----
New commits:


---

Comment by chapoton created at 2018-05-27 14:46:47

I have checked that with this branch, the install of sagenb is successful with python3 on sage 8.3.b2.


---

Comment by chapoton created at 2018-06-01 11:55:29

ping ?


---

Comment by dimpase created at 2018-06-01 12:17:29

I can try building the latest beta with python3,what should I pull in, besides the branch on this ticket?


---

Comment by chapoton created at 2018-06-01 13:54:25

Nothing else to pull, the develop branch itself build fine with python3.


---

Comment by dimpase created at 2018-06-01 14:20:54

and how do I  start sagenb so that the underlying python is python 3?


---

Comment by chapoton created at 2018-06-01 16:10:51

Well, just `sage -n=sagenb`. But it will fail to start, because of twisted or some of the latest commited changes, not yet in the release here.

We only need to make sure that sage3 builds and starts with the branch here.

We also need to make sure that for sage2, the upgrade of sagenb does not break something inside the notebook.


---

Comment by chapoton created at 2018-06-01 17:26:55

I propose to rename this ticket to "upgrade sagenb and build sagenb in sage/python3"

and keep for another ticket the goal of being able to run sagenb in sage/python3


---

Comment by kcrisman created at 2018-06-01 17:49:31

I was going to try this today on py2 to test the notebook but had some troubles upgrading Sage, see sage-devel.


---

Comment by dimpase created at 2018-06-03 06:40:42

With python3 sage, I get

```
$ ./sage -n sagenb
SageMath version 8.3.beta3, Release Date: 2018-05-27
Please wait while the old SageNB Notebook server starts...
/home/dima/sagepy3/local/lib/python3.6/site-packages/sage/misc/inline_fortran.py:8: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
  import imp
Traceback (most recent call last):
  File "/home/dima/sagepy3/src/bin/sage-notebook", line 268, in <module>
    launcher(unknown)
  File "/home/dima/sagepy3/src/bin/sage-notebook", line 74, in __init__
    notebook(*self.args, **self.kwds)
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/notebook/notebook_object.py", line 243, in __call__
    return self.notebook(*args, **kwds)
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/notebook/run_notebook.py", line 535, in notebook_run
    nb = notebook.load_notebook(directory)
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/notebook/notebook.py", line 1839, in load_notebook
    nb = Notebook(dir)
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/notebook/notebook.py", line 151, in __init__
    self.__conf = S.load_server_conf()
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/storage/filesystem_storage.py", line 265, in load_server_conf
    return self._basic_to_server_conf(self._load('conf.pickle'))
  File "/home/dima/sagepy3/local/lib/python3.6/site-packages/sagenb/storage/filesystem_storage.py", line 187, in _load
    result = pickle.load(f)
TypeError: a bytes-like object is required, not 'str'
```



---

Comment by chapoton created at 2018-06-03 06:45:07

Thanks Dima. It seems that you got a hard time doing that..

Failing is as expected. Maybe this specific issue is already fixed by the pull request done after you made the release. But this is not so important : let us keep that for another ticket.

Do you confirm that sage3 builds and starts with the branch here ? I think I did check that also. So it seems to be good to go from this point of view.

So now, there only remains to see if the branch here is not going to break anything in the sage2 sagenb.


---

Comment by chapoton created at 2018-06-03 08:45:47

I have just checked again with sage3 release 8.3.b4 that sage3 builds and starts.


---

Comment by dimpase created at 2018-06-03 09:20:21

also, for me with beta4. You can give it a positive review, I think.


---

Comment by chapoton created at 2018-06-03 09:46:05

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-06-03 09:46:05

ok, let it be. I change the title and description to be more adequate to what is done here.


---

Comment by vbraun created at 2018-06-06 19:53:38

Resolution: fixed


---

Comment by kcrisman created at 2018-06-21 15:41:11

As a followup, in 8.3.beta6 I am having some troubles - see [this post](https://groups.google.com/d/msg/sage-release/P6weuTHdIbE/DDKYLrUsBgAJ) for details.   I am pretty sure this isn't due to some stale process.


---

Comment by dimpase created at 2018-06-21 16:56:04

Replying to [comment:56 kcrisman]:
> As a followup, in 8.3.beta6 I am having some troubles - see [this post](https://groups.google.com/d/msg/sage-release/P6weuTHdIbE/DDKYLrUsBgAJ) for details.   I am pretty sure this isn't due to some stale process.

Does sagenb still open for you directly, via `sage -n sagenb` ?


---

Comment by kcrisman created at 2018-06-21 19:49:39

> > As a followup, in 8.3.beta6 I am having some troubles - see [this post](https://groups.google.com/d/msg/sage-release/P6weuTHdIbE/DDKYLrUsBgAJ) for details.   I am pretty sure this isn't due to some stale process.
> 
> Does sagenb still open for you directly, via `sage -n sagenb` ?

Yes, or at least with `sage -notebook=sagenb` it does.  I think there is something with the browser + token not opening.


---

Comment by chapoton created at 2018-06-21 20:07:51

could you try when undoing #25548 ?


---

Comment by kcrisman created at 2018-06-21 20:31:14

> could you try when undoing #25548 ?

You are oracular.

It would be interesting to trace where exactly `quit_sage` is even called that it would be necessary ...


---

Comment by kcrisman created at 2018-06-25 18:55:35

> > could you try when undoing #25548 ?
> 
> You are oracular.

Maybe I wasn't clear; that fixes it.  Shouldn't we have a blocker for 8.3 that includes that?


---

Comment by dimpase created at 2018-06-26 13:34:10

I can only say that the description of the issue you give it too vague.
Please feel free to open a ticket with details on how to reproduce this.


---

Comment by kcrisman created at 2018-06-26 20:55:31

Ok; see #25667.
