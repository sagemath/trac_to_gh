# Issue 21840: Upgrade eclib to version 20161219

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2016-12-19 14:01:24

CC:  wuthrich

Keywords: eclib

The current eclib version in Sage (as of 7.5.beta5) is v20160720.

This ticket updates to v20161920 from http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/eclib-20161219.tar.bz2

Of relevance to Sage are a bugfix and some extra functionality related to modular symbols, see #10256 and #21046.


---

Comment by cremona created at 2016-12-19 14:01:50

I will upload a branch as soon as I have tested the new build and all doctests.


---

Comment by cremona created at 2016-12-19 16:20:38

Changing status from new to needs_review.


---

Comment by cremona created at 2016-12-19 16:20:38

OK, please review.  As well as the new package code I made some small changes to the output of some modular symbol doctests.  In each case I checked that the change is exactly that which one would expect from the new eclib code (a few integers fivided by 2).


---

Comment by jdemeyer created at 2016-12-19 19:36:13

So, what about https://github.com/JohnCremona/eclib/issues/10

Do we still need the `NTL_ALL` macro?


---

Comment by cremona created at 2016-12-19 19:56:04

Replying to [comment:3 jdemeyer]:
> So, what about https://github.com/JohnCremona/eclib/issues/10
> 
> Do we still need the `NTL_ALL` macro?

If you look here: https://github.com/JohnCremona/eclib/commits/master, specifically at the commits made in January this year, you will see that the code now works (at least it is supposed to) with or without NTL_ALL being set.  This is controlled by the --enable-mpfp flag to ./configure.  That was quite a lot of work since there were quite a lot of tests whose output was trivially different with/without that option set.

Note that the default configurations is to have --enable-mpfp set and hence NTL_ALL set, you have to turn it off using --disable-mpfp.  Since Sage's spkg-install does not turn it off, it is on in Sage.

So I think the only thing I did not do is update and close that Issue.  Sorry!


---

Comment by jdemeyer created at 2016-12-20 07:48:00

If so, can you apply this additional patch

```diff
diff --git a/src/sage/libs/eclib/__init__.pxd b/src/sage/libs/eclib/__init__.pxd
index a666ec1..e42d0cc 100644
--- a/src/sage/libs/eclib/__init__.pxd
+++ b/src/sage/libs/eclib/__init__.pxd
`@``@` -1,5 +1,4 `@``@`
 # distutils: language = c++
-# distutils: extra_compile_args = -DNTL_ALL
 # distutils: libraries = ec ntl pari gmp m
 
 # NOTE: eclib includes have specific dependencies and must be included
```



---

Comment by jdemeyer created at 2016-12-20 07:50:50

Regarding the changed doctests, I cannot really review those. But I'm happy to assume that you know what you are doing and just accept the changed output.


---

Comment by cremona created at 2016-12-20 09:21:10

OK, I can make that additional change.  After that I'll force a rebuild of eclib in Sage and watch: it should be that -DNTL_ALL is set during compilation anyway.  However I just looked at the log from my build of the new spkg yesterday and every compile line only contains "-D NTL_ALL" and no other instances of "NTL_ALL".

About the doctests: I ran them past Rob Pollack and Chris Wuthrich who are experts, and also the remarks I made above were supposed to be a justification for the correctness of the new values.


---

Comment by cremona created at 2016-12-20 09:37:18

After writing that I realised that I did not know when the presence of the line you suggest deleting has any effect.  It has nothing to do with building libec at build time, I realise, but rather is there to make sure that the cython compilations which read eclib's header files have the right macros set.  And that must be crucial given that the compiled code must then link to the library libec!  So I now think that we must continue to set NTL_ALL in this cython file, otherwise there will be errors which including eclib's header files.

I checked to see what other compiler flags are set at eclib build time.  There is one other (apart from lots put there by autotools):  FLINT_LEVEL=1.  But that one is not an issue since it controls some implementations (in some eclib .cc files) and not headers.

Does this make sense?  If so, no further patching is needed.


---

Comment by jdemeyer created at 2016-12-20 13:32:52

Replying to [comment:8 cremona]:
> It has nothing to do with building libec at build time, I realise, but rather is there to make sure that the cython compilations which read eclib's header files have the right macros set.

Exactly. This is about compiling Sage library files (Cython extensions) against `libec`.

> And that must be crucial given that the compiled code must then link to the library libec!  So I now think that we must continue to set NTL_ALL in this cython file, otherwise there will be errors which including eclib's header files.

That's a pity because `-DNTL_ALL` should not be needed. That was precisely the point that I was trying to make at https://github.com/JohnCremona/eclib/issues/10: eclib should not force other packages (like Sage) to use certain compiler flags. The `NTL_ALL` macro should be considered an implementation detail of `eclib` and it should not influence other software built against `eclib`.

But this is a minor point which won't influence this Sage ticket.


---

Comment by cremona created at 2016-12-20 13:45:50

I understand your point, but it is more than just an implementation detail, as it affects the interface.  When compiled with the NTL_ALL option, functions which compute real or complex values (e.g. periods of elliptic curves) do so to arbitrary precision, returning values with type RR (NTL reals) for example, while without that option the same named function will return a C double.

I do understand that this can be viewed as bad design on my part and not a feature which a professional library should have.  eclib has undergone a lot of transition since it was just "my code" (until 2007) so that by now it is almost respectable.  One of the remaining issues is this one: users should not have to decide at build time whether they want to use doubles or arbitrary precision for a large collection of functions; the library should provide both and allow the uers to use whichever is most appropriate in the circumstances.  In some cases, because of overloading, the same function name can be re-used; but in others different names would be necessary (e.g. for periods of elliptic curves, where the input is the same exact data whether ones wants low or high precision).  It will happen one day.

I will copy some of this discussions to https://github.com/JohnCremona/eclib/issues/10


---

Comment by cremona created at 2016-12-22 09:18:11

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2016-12-22 09:18:11

I am resetting this to "needs work" just so I can work some more on adding functions to make the interface for modular symbols better as in #10256.  (There was also a test output file committed to the last eclib release by mistake).  It looks as if this missed the 7.5 release anyway.


---

Comment by jdemeyer created at 2016-12-22 12:54:04

Do you mean you want to keep working on `eclib` itself or on the Sage interface?


---

Comment by cremona created at 2016-12-22 13:46:25

Both.   There are normalization issues around modular symbols that I am sorting out on the eclib side as well as giving access to them via Sage.  So there will be a new eclib release (possibly today if I can finish) and at the same time I have   branch for #10256 which will depend on that (hence #10256 has this ticket as a dependency).


---

Comment by jdemeyer created at 2016-12-22 13:47:30

Fine for me. In case you want to change your mind, feel free to set this back to needs_review.


---

Comment by git created at 2016-12-22 20:36:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2016-12-22 20:40:12

OK, so here is another new version.  I don't expect to need to make more changes as I work on #10256.  On the other hand there is perhaps little point in getting this in before that anyway: I made some more changes to modular symbol doctest output just so they pass but those tests will all be reworked in #10256 anyway.  It would not hurt for someone else to check that the new release still works OK rather than having to deal with both tickets at once.  I don't know.  Anyway, #10256 will depend on this as it is now.


---

Comment by jdemeyer created at 2016-12-23 07:02:01

Needs review then?


---

Comment by cremona created at 2016-12-23 10:40:19

Replying to [comment:18 jdemeyer]:
> Needs review then?

Not yet.  I uploaded that new version last night but then realised that I have yet to ensure that the modular symbols are normalised as to sign (I dealt with the factor of 2 ok, touch wood).  This probably means a delay of several days now...


---

Comment by git created at 2016-12-23 15:51:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2016-12-30 17:54:21

With luck this version (v20161230) will be the last bugfix version with the new modular symbols functionality.  Right now this all works fine with the branch soon to be uploaded to #10256, but I should make a version here which passes all tests even if the relevant tests will all be superseded there.


---

Comment by git created at 2016-12-30 18:03:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2016-12-30 18:06:10

Please review, using v20161230 of eclib (as in the link).  The only doctest changes are to do with scaling of modular symbols, which will be dealt with properly in #10256, so the only thing to do is check that the new source builds OK and all test pass.


---

Comment by cremona created at 2016-12-30 18:06:10

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-01-01 19:10:32

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2017-01-03 10:39:39

Very sorry, JD -- see #10256


---

Comment by cremona created at 2017-01-03 10:39:39

Changing status from positive_review to needs_work.


---

Comment by cremona created at 2017-01-03 15:14:15

Another version will appear shortly.  For the record: the sign of plus modular symbols was being set correctly when L(E,1) is nonzero but not otherwise (random) and the sign of the minus symbol was not being set at all.  Now both are dealt with.

The new tarball is in place, and I will update the branch soon.

I suggest that when this has yet again had a review by Jeroen, we do not set it to positive review until Chris is happy over at #10256.


---

Comment by git created at 2017-01-03 16:36:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-01-03 16:37:48

OK, ready for review again.  Apart from a general check that nothing is broken this should wait until #10256 is also good.


---

Comment by cremona created at 2017-01-04 09:08:51

I fear I am losing all credibility here.  Scrap v20170103 and watch this space.


---

Comment by git created at 2017-01-04 19:55:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-01-04 19:58:45

Another attempt, with more testing this time.
----
New commits:


---

Comment by cremona created at 2017-01-04 19:59:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-01-05 13:29:09

Can you squash all those commits? I see little point in keeping all those incremental upgrades as separate commits.


---

Comment by wuthrich created at 2017-01-05 13:33:53

Probably, I would not be happy at #10256 if you squash commits here. Does it really harm having them?


---

Comment by jdemeyer created at 2017-01-05 13:35:14

Replying to [comment:37 wuthrich]:
> Probably, I would not be happy at #10256 if you squash commits here.

Never mind then.


---

Comment by cremona created at 2017-01-05 14:19:56

Yes, sorry about the tangle.  We certainly could disentangle: on this ticket that's what you were suggesting anyway, and on the other one I think there are <6 files affected and one could always use the non-git route of copying those 6 files elsewhere first and starting a new branch...
I can do that if necessary.


---

Comment by cremona created at 2017-01-05 19:10:00

I made a clean single commit on top of 7.5.rc1 which is at u/cremona/22077new.  It could be used instead of the original u/cremona/22077, but only if #10256 is also cleaned up.  Next...


---

Comment by cremona created at 2017-01-05 19:29:07

Jeroen, how about using my clean branch here, and at #10256 using one I just made which merges this with the current branch there (u/wuthrich/ticket/10256)?  I resolved the merge conflicts in 3 files, so now have a version of that branch which is no worse than before, while this one is simpler.


---

Comment by jdemeyer created at 2017-01-05 19:41:10

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-01-05 19:41:10

That's all fine for me. Just change branches and set this one back to needs_review.


---

Comment by wuthrich created at 2017-01-05 20:47:51

Changing status from needs_work to needs_review.


---

Comment by wuthrich created at 2017-01-05 20:47:51

New commits:


---

Comment by cremona created at 2017-01-05 21:02:57

Thanks.  Now I'll replace the branch at #10256 with a tidied one too.


---

Comment by cremona created at 2017-01-05 21:30:45

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2017-01-05 21:30:45

Apologies, I messed up -- the new branch is certainly a cleaned up version of its predecessor but that one was wrong.  I will fix this in the morning.

Ignore the above comment, this (=branch u/cremona/22077new = commit cb3fd05)  is fine.  Just note that the additional work on #10256 will involve changes to sage/libs/eclib as well as sage/schemes/elliptic_curves, in order to expose some new functionality in eclib.  This one *only* does the minimum to make eclib c20170104 work OK and pass tests.


---

Comment by cremona created at 2017-01-06 09:52:19

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2017-01-09 09:22:47

Note that #10256 which depends on this has a postive review.  I don't know if this proprty is inherited!


---

Comment by jdemeyer created at 2017-01-09 09:33:17

Good. I'll try to review this today.


---

Comment by jdemeyer created at 2017-01-09 09:58:15

I didn't check the mathematics. But the package builds fine.


---

Comment by jdemeyer created at 2017-01-09 09:58:15

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2017-01-09 10:10:54

Thanks.  The mathematical changes are effectively reviewed (already) at #10256.


---

Comment by vbraun created at 2017-01-21 16:34:58

Resolution: fixed
