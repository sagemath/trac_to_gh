# Issue 30363: fix ecm on macOS Xcode 12

Issue created by migration from https://trac.sagemath.org/ticket/30600

Original creator: dimpase

Original creation time: 2020-09-18 15:27:51

CC:  mkoeppe jhpalmieri zimmerma

as discussed on #30494
and fixed upstream on 
https://gforge.inria.fr/tracker/index.php?func=detail&aid=21856&group_id=135&atid=623


---

Comment by dimpase created at 2020-09-18 15:34:35

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-18 15:34:35

New commits:


---

Comment by jhpalmieri created at 2020-09-18 16:10:02

I think that most of the changes to `./configure` are unnecessary, and it would be cleaner to use just

```
diff -u a/configure b/configure
--- a/configure	2016-10-11 02:27:12.000000000 -0700
+++ b/configure	2020-09-18 09:03:06.000000000 -0700
@@ -13265,8 +13253,10 @@
   cat >conftes1.c <<EOF
 #ifdef __cplusplus
 extern "C" { void underscore_test(); }
+#else
+extern void underscore_test();
 #endif
-main () { underscore_test(); }
+int main () { underscore_test(); return 1;}
 EOF
 for tmp_underscore in "" "_"; do
   cat >conftes2.s <<EOF
```

(I assume that you got this by running `autoreconf` after making the changes to `acinclude.m4`. Maybe upstream's `configure` was already out of sync, which is where the other changes came from?)


---

Comment by dimpase created at 2020-09-18 17:47:13

sure, it's just the result of an autoreconf run. I don't think we should  be bothered by this, it's clearly a temporary patch, to go away with a new `ecm` release.


---

Comment by jhpalmieri created at 2020-09-18 18:02:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-19 10:26:12

Build depends on autotools:

```
Building ecm-7.0.4.p2
CDPATH="${ZSH_VERSION+.}:" && cd . && /bin/bash /var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/ecm-7.0.4.p2/src/missing aclocal-1.16 -I m4
/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/ecm-7.0.4.p2/src/missing: line 81: aclocal-1.16: command not found
WARNING: 'aclocal-1.16' is missing on your system.
         You should only need it if you modified 'acinclude.m4' or
         'configure.ac' or m4 files included by 'configure.ac'.
         The 'aclocal' program is part of the GNU Automake package:
         <http://www.gnu.org/software/automake>
         It also requires GNU Autoconf, GNU m4 and Perl in order to run:
         <http://www.gnu.org/software/autoconf>
         <http://www.gnu.org/software/m4/>
         <http://www.perl.org/>
Makefile:808: recipe for target 'aclocal.m4' failed
make[5]: *** [aclocal.m4] Error 127
make[5]: Failed to remake makefile 'Makefile'.
make[5]: Target 'all' not remade because of errors.
```



---

Comment by vbraun created at 2020-09-19 10:26:12

Changing status from positive_review to needs_work.


---

Comment by zimmerma created at 2020-09-19 10:51:26

> Build depends on autotools: [...]

[speaking as upstream developer] I believe this has to be fixed on the Sage side, since the vanilla 7.0.4 tarball should not depend on autotools.


---

Comment by jhpalmieri created at 2020-09-19 17:10:47

I think we can just patch `configure`, not `acinclude.m4`, and that shouldn't trigger running `aclocal`. I see this problem intermittently (running `make ecm-clean; make`), but if I remove the part of the patch for `acinclude.m4`, I don't see it any more.


---

Comment by jhpalmieri created at 2020-09-19 17:12:40

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2020-09-19 17:12:40

New commits:


---

Comment by dimpase created at 2020-09-19 17:22:03

ok, good catch!


---

Comment by zimmerma created at 2020-09-19 18:33:31

it would be cleaner to run `autoreconf` after having patched `acinclude.m4`, and use the updated `configure` file (which is auto-generated)


---

Comment by jhpalmieri created at 2020-09-19 18:51:02

Replying to [comment:12 zimmerma]:
> it would be cleaner to run `autoreconf` after having patched `acinclude.m4`, and use the updated `configure` file (which is auto-generated)

I think that's how Dima produced the patch in the first place. I just removed the part of the patch affecting `acinclude.m4`.


---

Comment by dimpase created at 2020-09-19 20:01:34

Replying to [comment:12 zimmerma]:
> it would be cleaner to run `autoreconf` after having patched `acinclude.m4`, and use the updated `configure` file (which is auto-generated)

this what I did - but I only took updates of acinclude.m4  and ./configure, not the complete stuff. My fault.


---

Comment by vbraun created at 2020-09-21 20:15:40

Resolution: fixed


---

Comment by mkoeppe created at 2021-02-01 21:21:45

Paul, is there any chance that a new release will be made soon with these updates?


---

Comment by zimmerma created at 2021-02-02 05:19:51

I've put a candidate tarball at https://members.loria.fr/PZimmermann/ecm-7.0.5-dev.tar.gz, please can you confirm it is ok? If so, I will make a new release.


---

Comment by zimmerma created at 2022-04-25 06:13:10

Replying to [comment:17 zimmerma]:
> I've put a candidate tarball at https://members.loria.fr/PZimmermann/ecm-7.0.5-dev.tar.gz, please can you confirm it is ok? If so, I will make a new release.

still waiting for an answer...


---

Comment by mkoeppe created at 2022-04-25 06:29:43

Sorry, let's take this to #31325
