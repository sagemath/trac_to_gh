# Issue 22713: combinat/posets/posets.py fails when the optional package dot2tex is installed

Issue created by migration from https://trac.sagemath.org/ticket/22950

Original creator: strogdon

Original creation time: 2017-05-05 02:30:21

CC:  chapoton jmantysalo kdilks tscrim

As reported at https://groups.google.com/d/msg/sage-release/UdllnAJFufA/-e8ArqwFBAAJ there is often a failure when
testing `combinat/posets/posets.py`

```
sage -t --long src/sage/combinat/posets/posets.py
**********************************************************************
File "src/sage/combinat/posets/posets.py", line 1742, in sage.combinat.posets.posets.FinitePoset.?
Failed example:
    L.plot(figsize=12, border=True, element_shape='s',
           element_size=400, element_color='white',
           element_colors={'blue': F, 'green': L.double_irreducibles()},
           cover_color='lightgray', cover_colors={'black': F_internal},
           title='The Frattini\nsublattice in blue', fontsize=10)
Exception raised:

    Traceback (most recent call last):
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.posets.posets.FinitePoset.?[12]>", line 5, in <module>
        title='The Frattini\nsublattice in blue', fontsize=Integer(10))
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/combinat/posets/posets.py", line 1834, in plot
        **kwds)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 564, in wrapper
        return func(*args, **options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18733, in plot
        return self.graphplot(**options).plot()
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18384, in graphplot
        return GraphPlot(graph=self, options=options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/graph_plot.py", line 262, in __init__
        self.set_pos()
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/graph_plot.py", line 346, in set_pos
        self._pos = self._graph.layout(**self._options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 17847, in layout
        pos = getattr(self, "layout_%s"%layout)(dim = dim, **options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/digraph.py", line 2915, in layout_acyclic
        return self.layout_graphviz(rankdir=rankdir, **options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18315, in layout_graphviz
        positions = dot2tex.dot2tex(self.graphviz_string(**options), format = "positions", prog = prog)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 564, in wrapper
        return func(*args, **options)
      File "/usr/local/sage-8/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 19532, in graphviz_string
        "%s is not a valid format for edge"%(edge)
    AssertionError: [0, 4] is not a valid format for edge
```

The failure occurs when `dot2tex` has been installed and was probably the result of #18545.


---

Comment by tscrim created at 2017-05-05 02:35:28

This was not _caused_ by #18545 but instead simply _exposed_.


---

Comment by strogdon created at 2017-05-05 02:37:45

Replying to [comment:1 tscrim]:
> This was not _caused_ by #18545 but instead simply _exposed_.
Yes, you are correct.


---

Comment by strogdon created at 2017-05-05 02:40:10

That portion of the `L.plot(...)` call that appears to be the problem is `cover_colors={'black': F_internal}`. If it is removed then the `posets.py` test passes even with `dot2tex` installed.


---

Comment by tscrim created at 2017-05-05 02:41:58

Okay, it might not be as simple as exposing a bug but bad input. If I use

```
F_internal = [(c[0],c[1],None) for c in F.cover_relations() if c in L.cover_relations()]
```

then I can see the plot.


---

Comment by tscrim created at 2017-05-05 02:43:00

<self-hatred>It's amazing how useful error messages are...</self-hatred>


---

Comment by tscrim created at 2017-05-05 02:45:28

Actually, this even works:

```
sage: F_internal = [tuple(c) for c in F.cover_relations() if c in L.cover_relations()]
```

Which makes sense considering the assertion is checking `assert isinstance(edge, tuple)`. What I suggest is making it also allow `list`.


---

Comment by tscrim created at 2017-05-05 02:52:35

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-05-05 02:52:35

Here's a branch with a MWE as a doctest.
----
New commits:


---

Comment by jmantysalo created at 2017-05-05 04:07:14

I can check this.


---

Comment by jmantysalo created at 2017-05-05 04:23:55

Works. Thanks!


---

Comment by jmantysalo created at 2017-05-05 04:23:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-08 21:18:34

Resolution: fixed
