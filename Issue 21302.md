# Issue 21302: make V=0 should silence the build

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-09-19 04:15:04

CC:  embray jdemeyer vbraun vdelecroix dimpase leif kcrisman novoselt fbissey

Building sage outputs a lot. Especially in highly parallelized builds, the output is not very useful. 

We should have an option to silence the build. 
Then it should simply say:

```
[cvxopt-1.1.8.p1] Logging to '/Users/mkoeppe/cvs/sage/logs/pkgs/cvxopt-1.1.8.p1.log'
[cvxopt-1.1.8.p1] Using cached file /Users/mkoeppe/cvs/sage/upstream/cvxopt-1.1.8.tar.gz
[cvxopt-1.1.8.p1] Setting up build directory for cvxopt-1.1.8.p1
[cvxopt-1.1.8.p1] Building and installing
[cvxopt-1.1.8.p1] Installation completed
```


A possible interface is to mimic [Automake silent rules](https://www.gnu.org/software/automake/manual/html_node/Automake-Silent-Rules.html#Automake-Silent-Rules):
`make V=0` 
would request the silent mode. `./configure --enable-silent-rules` would make this the default.


---

Comment by mkoeppe created at 2016-09-24 21:52:35

New commits:


---

Comment by mkoeppe created at 2016-09-24 21:52:35

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-09-27 18:52:19

Needs review.


---

Comment by jdemeyer created at 2016-09-27 20:06:18

I think the `/dev/tty` thing should be a separate ticket, since it's very specific and might require a specific reviewer who knows what it is about.


---

Comment by jdemeyer created at 2016-09-27 20:11:36

I really dislike ``@`` in Makefiles (unless the rule is truly trivial). It has happened to me several times that I was debugging some build issue and the ``@`` was hiding important stuff.


---

Comment by mkoeppe created at 2016-09-27 20:28:14

Replying to [comment:7 jdemeyer]:
> I think the `/dev/tty` thing should be a separate ticket, since it's very specific and might require a specific reviewer who knows what it is about.
If Erik doesn't mind, I could repurpose #21082 for that.


---

Comment by git created at 2016-09-27 21:08:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-27 21:09:29

Replying to [comment:8 jdemeyer]:
> I really dislike ``@`` in Makefiles (unless the rule is truly trivial). It has happened to me several times that I was debugging some build issue and the ``@`` was hiding important stuff.

OK, I've changed it so this is only done in V=0 mode.


---

Comment by jhpalmieri created at 2016-09-27 22:09:39

Two comments: 

- in the past (see #12729, for example), there were objections (by Jeroen, and maybe others) to not producing the full `install.log` file as is done now: this can be useful for debugging race conditions.

- I think the output hard to read. I would like something like the proposed output at #12729 better. That is, change

```
Running 'sage-spkg mpc-1.0.3.p0', output appears in /path/to/SAGE_ROOT/log/pkgs/mpc-1.0.3.p0.log ...
Running 'sage-spkg mpc-1.0.3.p0', output appears in /path/to/SAGE_ROOT/log/pkgs/mpc-1.0.3.p0.log ... done
```

 to something like

```
[mpc-1.0.3.p0] installing. Log file: logs/pkgs/mpc-1.0.3.p0.log
  [mpc-1.0.3.p0] installed successfully.
```

 The path to the log file should be given relative to `SAGE_ROOT`, which shortens the message, making it less likely that the line wraps, since line-wrapping is part of what makes the output hard to read.


---

Comment by jhpalmieri created at 2016-09-27 22:49:53

For the output, I'm thinking of something like this change (although I cheat in constructing the shortened path for the logfile here -- there should be a more robust solution):

```diff
diff --git a/build/bin/sage-logger b/build/bin/sage-logger
index c6afae1..de6cff8 100755
--- a/build/bin/sage-logger
+++ b/build/bin/sage-logger
`@``@` -57,15 +57,15 `@``@` mkdir -p "$logdir"
 if [This is the Trac macro *"$V" = 0 && $use_prefix = true * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#"$V" = 0 && $use_prefix = true -macro); then
     # Silent build.
     # Similar to https://www.gnu.org/software/automake/manual/html_node/Automake-Silent-Rules.html#Automake-Silent-Rules
-    echo "Running '$cmd', output appears in $logfile..."
+    echo "[$logname] installing. Log file: logs/pkg/$logname"
     # Use verbose mode for output to logfiles.
     export V=1
     ( exec> $logfile 2>&1 ; eval "$cmd" )
     status=$?
     if [This is the Trac macro *$status != 0 * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#$status != 0 -macro); then
-       echo "Running '$cmd', output appears in $logfile... exit status $status"
+       echo "  [$logname] error installing, exit status $status. Log file: $logfile"
     else
-       echo "Running '$cmd', output appears in $logfile... done"
+       echo "  [$logname] successfully installed"
     fi
     exit $status
 else
```



---

Comment by mkoeppe created at 2016-09-27 22:54:04

Feel free to push (a more robust version of) this to the ticket


---

Comment by jdemeyer created at 2016-09-28 08:38:14

Replying to [comment:12 jhpalmieri]:
> - in the past (see #12729, for example), there were objections (by Jeroen, and maybe others) to not producing the full `install.log` file as is done now: this can be useful for debugging race conditions.

Right. However, in this case the logs are still there by default. This ticket will only affect people who explicitly set `V=0`.


---

Comment by jhpalmieri created at 2016-09-28 17:06:56

Here's a branch that makes the easy parts of those changes but does not change how the log file is printed.
----
New commits:


---

Comment by jhpalmieri created at 2016-09-28 17:57:03

I would also be tempted to silence the `sage-logger` commands to build each package when `V=0`:

```diff
--- configure	2016-09-27 16:34:53.000000000 -0700
+++ configure	2016-09-28 10:47:33.000000000 -0700
`@``@` -7311,7 +7311,7 `@``@`
     else
         # Normal Sage packages
         echo >&7 "\$(INST)/$PKG_VERSION:$DEPS"
-        echo >&7 "	+sage-logger -p '\$(SAGE_SPKG) $PKG_VERSION' '\$(SAGE_LOGS)/$PKG_VERSION.log'"
+        echo >&7 "	\$(AM_V_at)+sage-logger -p '\$(SAGE_SPKG) $PKG_VERSION' '\$(SAGE_LOGS)/$PKG_VERSION.log'"
         echo >&7
 
         # Add a target with just the bare package name for "sage -i"
```

I don't know anything about `configure` scripts or how they are produced, so I don't know what would be required to make this change. Is it even a good idea?


---

Comment by mkoeppe created at 2016-09-28 19:03:16

Configure.ac already does that.
Just do sage -i autotools and the regenerate the script using autoreconf.


---

Comment by jhpalmieri created at 2016-09-28 22:32:39

Okay, so I assume that if this is merged, `configure` will automatically be updated.

This doesn't silence warnings, maybe it's not silencing STDERR, only STDOUT. So I see messages on the screen like

```
make[3]: warning: -jN forced in submake: disabling jobserver mode.
make[3]: `/Users/jpalmier/Desktop/Sage_stuff/sage_builds/TESTING/sage/local/var/lib/sage/installed/zlib-1.2.8.p0' is up to date.
```

I want to see warnings if there is a serious problem, but it would be nice if I didn't have to see these minor ones.

I'm also seeing many lines of the form

```
cp /Users/jpalmier/Desktop/Sage_stuff/sage_builds/TESTING/sage/src/ext/doctest/invalid/syntax_error.tachyon /Users/jpalmier/Desktop/Sage_stuff/sage_builds/TESTING/sage/local/share/sage/ext/doctest/invalid/syntax_error.tachyon
```

I guess they come from the target `$(SAGE_EXTCODE)`. I think that output should be silenced, too, or at least abbreviated ("[sage-extcode] installing...").


---

Comment by jdemeyer created at 2016-09-29 06:08:07

Replying to [comment:20 jhpalmieri]:
> Okay, so I assume that if this is merged, `configure` will automatically be updated.

The release manager takes care of this.


---

Comment by mkoeppe created at 2016-09-29 06:37:10

Replying to [comment:20 jhpalmieri]:
> I see messages on the screen like
> {{{
> make[3]: warning: -jN forced in submake: disabling jobserver mode.
> }}}

I think this indicates we are using $(MAKE) or $(MAKEFLAGS) wrong.


---

Comment by mkoeppe created at 2016-09-29 06:53:50

I've created #21610 for that.


---

Comment by mkoeppe created at 2016-09-29 06:56:01

To silence even more `make` output, one can of course do `make -s V=0`.


---

Comment by mkoeppe created at 2016-10-03 18:37:47

Replying to [comment:20 jhpalmieri]:
> I'm also seeing many lines of the form
> {{{
> cp /Users/jpalmier/Desktop/Sage_stuff/sage_builds/TESTING/sage/src/ext/doctest/invalid/syntax_error.tachyon /Users/jpalmier/Desktop/Sage_stuff/sage_builds/TESTING/sage/local/share/sage/ext/doctest/invalid/syntax_error.tachyon
> }}}
> I guess they come from the target `$(SAGE_EXTCODE)`. I think that output should be silenced, too, or at least abbreviated ("[sage-extcode] installing...").

I've added some more `$(AM_V_at)` for that.

----
New commits:


---

Comment by mkoeppe created at 2016-10-09 18:13:43

Needs review.


---

Comment by jhpalmieri created at 2016-10-10 23:15:23

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2016-10-10 23:15:23

When I use `make V=0`, the log files seem to be overwritten, not appended to. For example, `sagelib-7.4.beta6.log` contains a lot of information before docbuilding, but then after docbuilding it gets overwritten and is nearly empty at the end. To reproduce:

```
$ make   # produces full log files
$ make V=0   # overwrites at least sagelib-...log and dochtml.log
```



---

Comment by git created at 2016-10-11 01:03:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-10-11 16:20:15

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-10-11 16:20:15

Thanks for catching this. Fixed.


---

Comment by jhpalmieri created at 2016-10-11 16:28:05

This looks okay to me now. Jeroen, any objections to a positive review?


---

Comment by jhpalmieri created at 2016-10-18 04:15:26

Jeroen, please add yourself as a reviewer if you would like.


---

Comment by jhpalmieri created at 2016-10-18 04:15:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-21 07:04:08

Resolution: fixed


---

Comment by jdemeyer created at 2017-02-23 07:55:33

Related: #22418
