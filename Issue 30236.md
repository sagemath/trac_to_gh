# Issue 30236: Unicode art for sage.manifolds

Issue created by migration from https://trac.sagemath.org/ticket/30473

Original creator: mkoeppe

Original creation time: 2020-08-30 16:45:36

CC:  egourgoulhon tscrim @mwageringel chapoton

replacing
 * `/\` by ∧ (U+2227)
 * `*` by ⊗ (U+2297) for tensor products  
 * `-->` by → (U+2192), `|-->` by ↦ (U+21A6)


---

Comment by egourgoulhon created at 2020-08-30 19:33:43

Sounds a good idea!


---

Comment by @mjungmath created at 2021-01-23 10:45:28

That's a really nice idea! Is it also possible to entail the first two characters as operators in Python code?


---

Comment by @mwageringel created at 2021-01-23 13:26:41

Replying to [comment:4 gh-mjungmath]:
> Is it also possible to entail the first two characters as operators in Python code?

That is not possible in Python, but it could be added to the Sage preparser, as has been done for the [backslash operator](https://gitlab.com/sagemath/sage/-/blob/13b40902a9a8c7157957cbc61ebc5e3934c331fc/src/sage/repl/preparse.py#L1836). Some people at sd109 voiced an interest in such custom unicode operators.

There is also a [decorator](https://doc.sagemath.org/html/en/reference/misc/sage/misc/decorators.html#sage.misc.decorators.infix_operator) that turns functions into infix operators which works similarly to the backslash operator, but, as unicode operators are not valid function names, that does not really help.


---

Comment by @mjungmath created at 2021-01-23 14:42:25

Replying to [comment:5 gh-mwageringel]:
> Replying to [comment:4 gh-mjungmath]:
> > Is it also possible to entail the first two characters as operators in Python code?
> 
> That is not possible in Python, but it could be added to the Sage preparser, as has been done for the [backslash operator](https://gitlab.com/sagemath/sage/-/blob/13b40902a9a8c7157957cbc61ebc5e3934c331fc/src/sage/repl/preparse.py#L1836). Some people at sd109 voiced an interest in such custom unicode operators.
> 

I'd like that very much, too. Is the preparser also capable of something like

type "\otimes" -> press `TAB` -> unicode character pops up

similarly to Greek letters in Py3 right now?


---

Comment by @mwageringel created at 2021-01-23 14:50:48

Replying to [comment:6 gh-mjungmath]:
> Is the preparser also capable of something like
> 
> type "\otimes" -> press `TAB` -> unicode character pops up
> 
> similarly to Greek letters in Py3 right now?

That is an IPython feature, which does not seem to be implemented for operators like `\otimes`. The preparser is not capable of this.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by egourgoulhon created at 2021-06-25 09:54:50

I gave it a try, by changing line 736 of `src/sage/tensor/modules/free_module_tensor.py`:

```diff
-                basis_term_txt = "*".join(bases_txt)
+                basis_term_txt = "\u2297".join(bases_txt)
```

and changing doctests accordingly. Everything seems OK with doctests and the html documentation.
However, generating the pdf documentation by 

```
sage -docbuild reference/tensor_free_modules pdf
```

failed, with the error:

```
! Package inputenc Error: Unicode character ⊗ (U+2297)
(inputenc)                not set up for use with LaTeX.
```

I had to add the following line in `src/sage/docs/conf.py` (after line 407):

```
    \DeclareUnicodeCharacter{2297}{\ensuremath{\otimes}}
```

to make the pdf documentation build without any error. The pdf output is fine (the tensor product operator is correctly displayed). However, before to proceed, I would like to know if this the correct way to fix the pdf doc building...


---

Comment by chapoton created at 2021-06-25 10:40:21

There is already a tensor product somewhere, with no pdf problem:

```
sage: A=algebras.FreeDendriform(QQ,'a')  
sage: %display unicode_art                                                      
sage: a=A.an_element()                                                          
sage: A.coproduct(a)                                                            
1 ⨂ B  + 2*1 ⨂ B    + 2*1 ⨂ B    + B  ⨂ 1 + 4*B  ⨂ B  + 2*B    ⨂ 1 + 2*B    ⨂ 1
     a          a              a    a          a    a      a              a    
                 ╲            ╱                             ╲            ╱     
                  a          a                               a          a   
```


***EDIT***


```
git grep "⨂" src/sage
src/sage/categories/signed_tensor.py:    unicode_symbol = " ⨂ "
src/sage/categories/tensor.py:    unicode_symbol = " ⨂ "
src/sage/combinat/free_module.py:                R    ⨂ R
```


*EDIT* : But in fact, it does not appear in pdf doc, because it's only in hidden methods.


---

Comment by egourgoulhon created at 2021-06-25 12:45:33

Replying to [comment:11 chapoton]:
> There is already a tensor product somewhere, with no pdf problem:
> > 
> *EDIT* : But in fact, it does not appear in pdf doc, because it's only in hidden methods.

Thank you for pointing out the existence of ⨂ in `src/sage/categories/tensor.py`. It is U+2A02 (unicode name: _n-ary circled times operator_), while U+2297 is for ⊗ (unicode name: _circled times_). In terms of readability, U+2A02 is much better than U+2297, so we should definitely use U+2A02.


---

Comment by egourgoulhon created at 2021-06-25 12:57:19

With U+2A02, I had to perform the following change to `src/sage/docs/conf.py` to get the pdf doc built:

```diff
-    \DeclareUnicodeCharacter{2A02}{\otimes}
+    \DeclareUnicodeCharacter{2A02}{\ensuremath{\otimes}}
```

The output pdf looks OK.


---

Comment by mkoeppe created at 2021-06-25 18:28:28

You may want to make this change on top of the branch of #31880, which touches the same file, to avoid merge conflicts


---

Comment by @mwageringel created at 2021-06-25 20:55:50

Replying to [comment:12 egourgoulhon]:
> In terms of readability, U+2A02 is much better than U+2297, so we should definitely use U+2A02. 

I am in favor of U+2297, as it is used as a binary operator. The n-ary operator would correspond to `\bigotimes` in tex instead. At least with the Dejavu Sans Mono font, the binary operator looks good to me, whereas the n-ary operator U+2A02 is too wide for a monospaced font (which could lead to misaligned unicode art).

Replying to [comment:10 egourgoulhon]:
> However, before to proceed, I would like to know if this the correct way to fix the pdf doc building...

Yes, this is the correct way to add support for unicode characters to the pdf documentation.


---

Attachment


---

Attachment


---

Attachment

Replying to [comment:17 gh-mwageringel]:
> Replying to [comment:12 egourgoulhon]:
> > In terms of readability, U+2A02 is much better than U+2297, so we should definitely use U+2A02. 
> 
> I am in favor of U+2297, as it is used as a binary operator. The n-ary operator would correspond to `\bigotimes` in tex instead. At least with the Dejavu Sans Mono font, the binary operator looks good to me, whereas the n-ary operator U+2A02 is too wide for a monospaced font (which could lead to misaligned unicode art).

My initial preference for U+2A02 came from the appearance in Sage's console in the Ubuntu terminal (font: Monospace Regular 13): 

- for U+2A02: ![](tensor_product-2A02.png)
- for U+2297: ![](tensor_product-2297.png) 

However, when cutting and pasting to gedit (font: Ubuntu Mono 13), we get:

![](tensor_product_Ubuntu_Mono_13.png)

As you said, U+2A02 appears too large. So, unless someone argues against it, I am going to revert to U+2297. It's also more natural since U+2297 is the standard symbol for tensor product as a binary operator, as your pointed out. Thanks for your advice!

> 
> Replying to [comment:10 egourgoulhon]:
> > However, before to proceed, I would like to know if this the correct way to fix the pdf doc building...
> 
> Yes, this is the correct way to add support for unicode characters to the pdf documentation.

Thanks for your answer!


---

Comment by egourgoulhon created at 2021-06-26 17:51:25

Replying to [comment:16 mkoeppe]:
> You may want to make this change on top of the branch of #31880, which touches the same file, to avoid merge conflicts
Thanks for the advice; however this ticket has no logical connection with #31880 and the merge conflict in `src/sage/docs/conf.py` will be a trivial one. Moreover, since I am touching almost all files in `src/sage/manifolds` and `src/sage/tensor/modules`, there will be merge conflicts with the next beta anyway.


---

Comment by egourgoulhon created at 2021-06-27 15:35:54

Here is a preliminary version, which implements `⊗` and `∧`. There remains to implement `→`, `↦` and `∂` (I shall do it tomorrow).
----
New commits:


---

Comment by @mjungmath created at 2021-06-27 17:47:01

Perhaps it might be a good idea to refactor the code in such a way that the symbols can be changed easily? Something like global variables such as `wedge_symbol`?

This might have the following benefits:

- Unification throughout Sage, i.e. tensor products are used not only for free modules.
- It is easier to change if we are not quite satisfied with the result at a later point.


---

Comment by tscrim created at 2021-06-27 23:22:39

Replying to [comment:21 gh-mjungmath]:
> Perhaps it might be a good idea to refactor the code in such a way that the symbols can be changed easily? Something like global variables such as `wedge_symbol`?

+1


---

Comment by egourgoulhon created at 2021-06-28 06:56:51

Replying to [comment:21 gh-mjungmath]:
> Perhaps it might be a good idea to refactor the code in such a way that the symbols can be changed easily? Something like global variables such as `wedge_symbol`?
> 
I don't think it's worth to clutter Sage's global variables for such a thing. There aren't actually so many unicode options. For instance, for the tensor product of tensor fields, there are two of them: U+2297 and U+2A02 and the discussion in comment:17 and comment:18 reveals that U+2A02 is not appropriate. Moreover, it is quite easy to spot where the symbols are implemented in Sage's code: from `src/sage`,

```
git grep 'u2297'
```

yields

```
tensor/modules/free_module_tensor.py:                basis_term_txt = "\u2297".join(bases_txt)
tensor/modules/free_module_tensor.py:            result._name = format_mul_txt(self._name, '\u2297', other._name)
```

By the way, this is the reason why I used `basis_term_txt = "\u2297".join(bases_txt)` instead of `basis_term_txt = "⊗".join(bases_txt)`, which would have been equivalent in terms of output.

In any case, I would vote for the discussion about global variables to be deferred to another ticket. To minimize merge conflicts, it would be helpful to have the current ticket merged not too late.


---

Comment by slelievre created at 2021-06-28 08:34:26

Maybe add a comment? And use single quotes both times?

```diff
-                basis_term_txt = "\u2297".join(bases_txt)
+                # Unicode character '\u2297' is '⊗'; see ticket #30473
+                basis_term_txt = '\u2297'.join(bases_txt)
```


```diff
+            # Unicode character '\u2297' is '⊗'; see ticket #30473
             result._name = format_mul_txt(self._name, '\u2297', other._name)
```



---

Comment by @mjungmath created at 2021-06-28 09:19:12

I just see that all three `display` methods basically contain the same code. I think some common parts should be outsourced for example in `sage.tensor.format_utilities`.

This might also be useful in view of mixed forms, which have their own `display` method as well.


---

Comment by @mjungmath created at 2021-06-28 09:26:26

`@`Eric: Could you change the wedge symbol in `mixed_form.py` as well please?


---

Comment by egourgoulhon created at 2021-06-28 10:22:39

Replying to [comment:26 gh-mjungmath]:
> `@`Eric: Could you change the wedge symbol in `mixed_form.py` as well please?
This is already done, see https://git.sagemath.org/sage.git/diff/src/sage/manifolds/differentiable/mixed_form.py?id=f6bcc9d7e94ee770679c58d9e06ed0ed6f29f94b&id2=a60179ab6b642246ee54120e43fdf9663afe5638


---

Comment by tscrim created at 2021-06-28 10:46:12

I wasn't thinking of adding this to the global namespace, but having a file where people can import the symbols to use in their string outputs.


---

Comment by @mjungmath created at 2021-06-28 11:06:50

Replying to [comment:27 egourgoulhon]:
> Replying to [comment:26 gh-mjungmath]:
> > `@`Eric: Could you change the wedge symbol in `mixed_form.py` as well please?
> This is already done, see https://git.sagemath.org/sage.git/diff/src/sage/manifolds/differentiable/mixed_form.py?id=f6bcc9d7e94ee770679c58d9e06ed0ed6f29f94b&id2=a60179ab6b642246ee54120e43fdf9663afe5638

Ah perfect. Sorry, haven't noticed. Thanks! :)


---

Comment by egourgoulhon created at 2021-06-28 13:07:31

Replying to [comment:28 tscrim]:
> I wasn't thinking of adding this to the global namespace, but having a file where people can import the symbols to use in their string outputs.
Yes, that's what I understood, but IMHO this implies some discussion: 
- where to put this file?
- shall we homogenize between various parts of Sage? (for instance as pointed out in comment:11, tensor products of modules use U+2A02 (\bigotimes), while here, we are using here U+2297 (\otimes) for tensor products of elements)
- how to name the Python variables? (I would suggest a naming convention from the LaTeX names of the symbols, e.g. something like `unicode_otimes`, `unicode_mapsto`, etc.)
- how to articulate this file with `src/sage/docs/conf.py`? (i.e. ensure that each time a new variable is added to this file, it will be taken into account in `conf.py`)

For this reason, I would prefer this to be done in another ticket.


---

Comment by egourgoulhon created at 2021-06-28 13:08:48

Replying to [comment:25 gh-mjungmath]:
> I just see that all three `display` methods basically contain the same code. I think some common parts should be outsourced for example in `sage.tensor.format_utilities`.

Yes certainly, but in another ticket.


---

Comment by git created at 2021-06-28 15:20:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-28 15:26:01

Here is a new provisory version, implementing `→`, `↦`, as well as `ℝ` and `ℂ` for the codomains of scalar fields on respectively real and complex manifolds. 

There remains to implement `∂` for coordinate frames.


---

Comment by egourgoulhon created at 2021-06-28 15:29:17

Replying to [comment:24 slelievre]:
> Maybe add a comment? And use single quotes both times?
> {{{#!diff
> -                basis_term_txt = "\u2297".join(bases_txt)
> +                # Unicode character '\u2297' is '⊗'; see ticket #30473
> +                basis_term_txt = '\u2297'.join(bases_txt)
> }}}

Thanks for the suggestion. This is done in the latest version (comment:32).


---

Comment by git created at 2021-06-29 11:53:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-29 12:06:28

Replying to [comment:30 egourgoulhon]:
> Replying to [comment:28 tscrim]:
> > I wasn't thinking of adding this to the global namespace, but having a file where people can import the symbols to use in their string outputs.
> Yes, that's what I understood, but IMHO this implies some discussion [...]
> 
> For this reason, I would prefer this to be done in another ticket.

Having slept on it, I've finally included this in the current ticket ;-)  

I've put the file defining Python identifiers for Unicode characters in `src/sage/typeset` and named it `unicode_characters.py`, cf. 
https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/typeset/unicode_characters.py?id=4e13ffa05615e91d6b266660481516c72c39d25e

I've also included it in the reference manual, in the section "Programming -> Utilities -> Formatted Output -> Unicode characters".

Regarding the last point of :comment:30, there is no (automatic) articulation with `src/sage/docs/conf.py` yet.


---

Comment by git created at 2021-06-29 14:00:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-29 14:06:09

In the above commit, I used the new file `unicode_characters.py` to deal with the symbol ⨂ (bigotimes) pointed out in comment:11. Frédéric, Travis, do you agree?


---

Comment by slelievre created at 2021-06-29 15:43:19

Have you considered formatted strings instead of additions?

```diff
-    unicode_symbol = " " + unicode_bigotimes + " "
+    unicode_symbol = f" {unicode_bigotimes} "
```



---

Comment by git created at 2021-06-29 17:35:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-29 17:38:22

Replying to [comment:41 slelievre]:
> Have you considered formatted strings instead of additions?
> {{{#!diff
> -    unicode_symbol = " " + unicode_bigotimes + " "
> +    unicode_symbol = f" {unicode_bigotimes} "
> }}}
Thanks for the tip; this is done in the latest version.


---

Comment by egourgoulhon created at 2021-06-29 17:44:28

I've added ∂/∂... for the vector fields of coordinate frames and ℝ for the real line. So I think this is ready for review now.


---

Comment by egourgoulhon created at 2021-06-29 17:44:28

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2021-06-29 18:36:21

Shouldn't unicode output only be used if `%display unicode_art` is set? It is not set by default, which means that it would not be necessary to touch all the doctests in this ticket.

As unicode output requires the presence of suitable fonts, I think it might be best if it stays optional.


---

Comment by mkoeppe created at 2021-06-29 18:52:12

Replying to [comment:45 gh-mwageringel]:
> Shouldn't unicode output only be used if `%display unicode_art` is set? It is not set by default, which means that it would not be necessary to touch all the doctests in this ticket.

No, I don't think so. "Unicode art", in extension of "ASCII art", means to use multiline character art. Merely using non-ASCII characters does not make something unicode art.


---

Comment by mkoeppe created at 2021-06-29 18:54:01

(The title of the ticket should probably be changed.)


---

Comment by @mwageringel created at 2021-06-29 19:04:31

Replying to [comment:46 mkoeppe]:
> No, I don't think so. "Unicode art", in extension of "ASCII art", means to use multiline character art. Merely using non-ASCII characters does not make something unicode art. 

Ok, thanks for clarifying.


---

Comment by egourgoulhon created at 2021-06-29 20:18:13

Replying to [comment:48 gh-mwageringel]:
> Replying to [comment:46 mkoeppe]:
> > No, I don't think so. "Unicode art", in extension of "ASCII art", means to use multiline character art. Merely using non-ASCII characters does not make something unicode art. 
> 
> Ok, thanks for clarifying.
I've updated the ticket description to show the purpose of this ticket via some examples.


---

Comment by tscrim created at 2021-06-29 23:28:08

I think in `*TensorProductFunctor`, we should use `U+2297` -- i.e., `unicode_otimes` -- since it is a binary operator.


---

Comment by nbruin created at 2021-06-30 01:55:14

Replying to [comment:7 gh-mwageringel]:
> Replying to [comment:6 gh-mjungmath]:
> > Is the preparser also capable of something like
> > 
> > type "\otimes" -> press `TAB` -> unicode character pops up
> > 
> > similarly to Greek letters in Py3 right now?
> 
> That is an IPython feature, which does not seem to be implemented for operators like `\otimes`. The preparser is not capable of this.

Th IPython feature could be hooked into. The relevant dictionaries are `IPython.core.latex_symbols.latex_symbols` and `IPython.core.latex_symbols.reverse_latex_symbols`. You could install new translations by updating those dictionaries. It would probably be worth trialing it a bit to see if there are unwanted side-effects (the dictionary may be used for other purposes -- the source mentions it's a list borrowed from Julia, with entries removed that do not yield valid Python identifiers)


---

Comment by git created at 2021-06-30 19:58:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-30 20:05:35

Replying to [comment:52 tscrim]:
> I think in `*TensorProductFunctor`, we should use `U+2297` -- i.e., `unicode_otimes` -- since it is a binary operator.

Done in the latest commit. Incidently, note that this is doctested by only one test, in `src/sage/combinat/free_module.py`, and never shows up in the reference manual, as pointed out in comment:11.


---

Comment by @mjungmath created at 2021-07-05 09:08:37

What's wrong with the patchbot? I'm looking forward for a positive review due to #30272.


---

Comment by slelievre created at 2021-07-05 09:12:06

Some patchbots are stuck due to #29977.


---

Comment by mkoeppe created at 2021-07-05 16:47:32


```
sage -t --random-seed=0 src/sage/manifolds/differentiable/diff_map.py
**********************************************************************
File "src/sage/manifolds/differentiable/diff_map.py", line 933, in sage.manifolds.differentiable.diff_map.DiffMap.pullback
Failed example:
    gM.display()
Expected:
    (2*cos(t) + 2) dt*dt
Got:
    (2*cos(t) + 2) dt⊗dt
```



---

Comment by mkoeppe created at 2021-07-05 16:47:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-05 17:14:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-07-05 17:16:44

Replying to [comment:58 mkoeppe]:
> {{{
> sage -t --random-seed=0 src/sage/manifolds/differentiable/diff_map.py
> **********************************************************************
> File "src/sage/manifolds/differentiable/diff_map.py", line 933, in sage.manifolds.differentiable.diff_map.DiffMap.pullback
> Failed example:
>     gM.display()
> Expected:
>     (2*cos(t) + 2) dt*dt
> Got:
>     (2*cos(t) + 2) dt⊗dt
> }}}
Thanks for pointing this out (this was due to the merge of #31904 in 9.4.beta4).


---

Comment by egourgoulhon created at 2021-07-05 17:16:44

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-05 17:38:46

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-07-05 20:10:36

Thank you for the review!


---

Comment by vbraun created at 2021-07-07 20:55:02

I'm getting a lot of test failures of the form 

```
**********************************************************************
File "src/sage/calculus/functional.py", line 145, in sage.calculus.functional.derivative
Failed example:
    derivative(a).display()
Expected:
    da = 2 dx/\dy
Got:
    da = 2 dx∧dy
**********************************************************************
```

can you please do a whole `make ptestlong`


---

Comment by vbraun created at 2021-07-07 20:55:02

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-07-07 22:15:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-07-07 22:19:14

Replying to [comment:63 vbraun]:
> I'm getting a lot of test failures of the form 
> [...]
> can you please do a whole `make ptestlong`

Thanks for pointing this out. This is fixed in the latest commit.


---

Comment by egourgoulhon created at 2021-07-07 22:19:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-07 23:06:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-18 22:53:38

Resolution: fixed
