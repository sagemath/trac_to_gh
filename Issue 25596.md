# Issue 25596: Upgrade to MathJax 3

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2018-07-11 18:57:57

CC:  arojas egourgoulhon embray fbissey @timokau jdemeyer jhpalmieri kcrisman mmarco novoselt schilly slelievre tmonteil vbraun mjo

Keywords: upgrade, mathjax

Mathjax v3 beta was released, see [MathJax news](https://www.mathjax.org/news).


---

Comment by slelievre created at 2018-10-24 23:21:36

The second public beta release for MathJax v3 was released.

- [announcement on the MathJax Users list](https://groups.google.com/d/topic/mathjax-users/tkGOgWJV2bM/discussion)

The announcement ends with this note:

> MathJax v3 is in beta release. Do not use this in production,
> but please test it and report issues on the MathJax v3 issue tracker!
>
> We are continuing to add more functionality to version 3, and will be
> releasing additional beta versions as new features become available.
> So watch this site for more news to come!


---

Comment by tmonteil created at 2018-10-25 08:09:17

Do you know how light it will be compared to https://katex.org/ ?


---

Comment by slelievre created at 2018-12-14 17:59:37

Replying to [comment:2 tmonteil]:
> Do you know how light it will be compared to https://katex.org/ ?

No. This might be a good question to ask on the [mathjax-users mailing list](https://groups.google.com/d/topic/mathjax-users/).

Meanwhile the [third public beta for MathJax 3 was announced](https://groups.google.com/d/topic/mathjax-users/NmUrM3i9lNc/discussion) on 28 Nov 2018.


---

Comment by slelievre created at 2019-05-24 04:06:01

MathJax v3 beta.4 released 2019-05-21.


---

Comment by slelievre created at 2020-04-11 19:03:29

MathJax 3.0.5 was released (2020-04).


---

Comment by was created at 2021-06-13 19:14:52

It's worth paying attention to the fact that Mathjax 3 is missing a significant feature that might be really critical for Sage, which is "automatic line breaking".  See the discussion here:

https://github.com/mathjax/MathJax/issues/2312#issuecomment-692695446

E.g., "So line breaking and other features will most likely have to wait until next year."  "That's the reason why nearly nobody is using MathJax 3."   etc.

I think this is very important to be aware of, and it's one reason why CoCalc doesn't use MathJax 3, and uses KaTeX by default.   For some applications automatic line breaking probably isn't so important, but it might be very important for Sage, due to people often printing out polynomials and big formulas.


---

Comment by klee created at 2021-06-14 01:52:15

Replying to [comment:9 was]:
> It's worth paying attention to the fact that Mathjax 3 is missing a significant feature that might be really critical for Sage, which is "automatic line breaking".  

It is jupyter people who decides what math rendering web engine is used in jupyter, which is the official frontend of Sage. I think whether Sage will be moving to MathJax3 or something else is dependent on what they do.


---

Comment by was created at 2021-06-14 02:05:21

Replying to [comment:10 klee]:
> Replying to [comment:9 was]:
> > It's worth paying attention to the fact that Mathjax 3 is missing a significant feature that might be really critical for Sage, which is "automatic line breaking".  
> 
> It is jupyter people who decides what math rendering web engine is used in jupyter, which is the official frontend of Sage. I think whether Sage will be moving to MathJax3 or something else is dependent on what they do.

Thanks.  Here's their plan regarding this issue: https://github.com/jupyterlab/jupyterlab/issues/7218#issuecomment-532146044


---

Comment by kcrisman created at 2021-06-14 11:47:47

> It's worth paying attention to the fact that Mathjax 3 is missing a significant feature that might be really critical for Sage, which is "automatic line breaking".  See the discussion here:
> 

Thanks, William, I'll pass that on upstream to PreTeXt.


---

Comment by git created at 2022-04-07 04:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-07 05:03:18

To support #33600, I prepared a new package for mathjax3.

I've never done creating a spkg before and don't understand everything about this business. So please help. This is a public branch!

I used the mathjax2 spkg as a template, and managed to place a tarball in `upstream/` directory and install from it to `local/share/mathjax3` by `sage -i mathjax3`.


---

Comment by git created at 2022-04-07 05:08:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-07 05:09:11

Fixed first mistake.


---

Comment by klee created at 2022-04-07 05:21:52

To the uninitiated (like me):

First

```
cd build/pkgs/mathjax3/
spkg-src 
}}} 
to make the tarball `upstream/mathjax-3.2.0.tar.gz`.


---

Comment by git created at 2022-04-07 07:35:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-07 07:38:06

After installed, mathjax files are in `local/share/mathjax3/mathjax/...`. This is necessary to put mathjax files into `_static/mathjax/...` for sage documentation.


---

Comment by jhpalmieri created at 2022-04-07 15:05:18

When it's convenient, could you please upload the tarball somewhere? (As you've observed, I think we've always built our own mathjax tarball, so we can't use the "upstream_url" field in `checksums.ini` to download from a standard location.)


---

Comment by klee created at 2022-04-08 00:33:49

Replying to [comment:23 jhpalmieri]:
> When it's convenient, could you please upload the tarball somewhere? (As you've observed, I think we've always built our own mathjax tarball, so we can't use the "upstream_url" field in `checksums.ini` to download from a standard location.)

Right. Presently the tarball is just a slight repackaging of the official mathjax3 distribution. Fortunately the size of the tarball (around 4.8Mb) is just slightly larger than our mathjax2 tarball. But they have plans to add more fonts to mathjax3 and then we would be forced to reduce the size by cutting unnecessary fonts from the distribution.


---

Comment by klee created at 2022-04-08 00:35:54

Do we need a sage-devel discussion to add mathjax3 as a standard spkg?


---

Comment by git created at 2022-04-08 01:06:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-08 07:55:09

Replying to [comment:27 klee]:
> Do we need a sage-devel discussion to add mathjax3 as a standard spkg?

I thought of adding mathjax3 side by side with mathjax(2). But it seems that we don't need to keep mathjax(2) once we have mathjax3 in sage.

So now I am thinking of replacing the mathjax(2) with the new mathjax(3). Then we don't need a sage-devel discussion...


---

Comment by git created at 2022-04-08 12:39:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-04-08 14:15:16

Replying to [comment:31 klee]:
> 
> So now I am thinking of replacing the mathjax(2) with the new mathjax(3). Then we don't need a sage-devel discussion...

What about the line breaking issue pointed out in comment:9 ?


---

Comment by klee created at 2022-04-08 14:53:29

Replying to [comment:34 egourgoulhon]:
> Replying to [comment:31 klee]:
> > 
> > So now I am thinking of replacing the mathjax(2) with the new mathjax(3). Then we don't need a sage-devel discussion...
> 
> What about the line breaking issue pointed out in comment:9 ?

As I understand it, it is only relevant with the mathjax used with jupyter.

Presently the mathjax used by Sphinx for sage documentation is different from the mathjax used by jupyter. So we don't need to worry about the issue.


---

Comment by @tobiasdiez created at 2022-04-08 18:30:06

Isn't it enough to only copy the `tex-chtml.js` file from the mathjax release? It looks like this file is self-contained (hard to say as its minified).


---

Comment by klee created at 2022-04-08 23:25:40

Replying to [comment:36 gh-tobiasdiez]:
> Isn't it enough to only copy the `tex-chtml.js` file from the mathjax release? It looks like this file is self-contained (hard to say as its minified).

It is self-contained. But it does not contain all extensions. To be future safe, I think we should not minimize our tarball. The tarball is not big...yet.


---

Comment by git created at 2022-04-08 23:35:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-08 23:52:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-04-08 23:57:23

After a discussion in #33600 (Configure mathjax in sphinx config and upgrade to Mathjax v3), we decided to merge both tickets to here.


---

Comment by git created at 2022-04-09 02:45:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-09 02:48:26

The mathjax3 bug was also reported here: https://github.com/mathjax/MathJax/issues/2861


---

Comment by @tobiasdiez created at 2022-04-09 11:52:04

Replying to [comment:37 klee]:
> Replying to [comment:36 gh-tobiasdiez]:
> > Isn't it enough to only copy the `tex-chtml.js` file from the mathjax release? It looks like this file is self-contained (hard to say as its minified).
> 
> It is self-contained. But it does not contain all extensions. To be future safe, I think we should not minimize our tarball. The tarball is not big...yet.

Okay, makes sense to leave the tar untouched. What about only copying the tex-chtml file to `SAGE_SHARE` in `spkg-install.in`? This could then be easily extended to include other extensions etc if needed in the future.

Also I think the uncommented code in `spkg-src` can be safely deleted. The folder structure of the mathjax releases changed completely, so the mathjax 2 stuff is outdated. And if there is something useful in it, one could also use git history to recover it easily.


---

Comment by @tobiasdiez created at 2022-04-09 11:52:25

Otherwise it looks good to me. Is there still something to do?


---

Comment by git created at 2022-04-09 12:08:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-09 12:20:27

Replying to [comment:47 gh-tobiasdiez]:
> Okay, makes sense to leave the tar untouched. What about only copying the tex-chtml file to `SAGE_SHARE` in `spkg-install.in`? 

Why do that? Do you worry the performance of the documentation website? Having the whole mathjax files has nothing to do with the performance. The html files only load `tex-chtml.js`.

> This could then be easily extended to include other extensions etc if needed in the future.

It would be "easy" only if all mathjax files are already in `local/share/mathjax`. The size of this directory only slightly increases with this ticket.

> Also I think the uncommented code in `spkg-src` can be safely deleted. The folder structure of the mathjax releases changed completely, so the mathjax 2 stuff is outdated. And if there is something useful in it, one could also use git history to recover it easily.

Okay. Done.


---

Comment by klee created at 2022-04-09 12:26:56

Replying to [comment:48 gh-tobiasdiez]:
> Otherwise it looks good to me. Is there still something to do?

Perhaps no. But before we go to "needs review", I want that more people check the documentation built with mathjax3 (with CDN and without) to find any degradation or regression of the doc compared with the doc built with mathjax2. Let's not rush.


---

Comment by @tobiasdiez created at 2022-04-09 19:47:12

Replying to [comment:50 klee]:
> Replying to [comment:47 gh-tobiasdiez]:
> > Okay, makes sense to leave the tar untouched. What about only copying the tex-chtml file to `SAGE_SHARE` in `spkg-install.in`? 
> 
> Why do that? Do you worry the performance of the documentation website? Having the whole mathjax files has nothing to do with the performance. The html files only load `tex-chtml.js`.

Mainly for clarity, because then in sage_share/mathjax there are only files that are also actually used. But it's not a big issue.

> > Also I think the uncommented code in `spkg-src` can be safely deleted. The folder structure of the mathjax releases changed completely, so the mathjax 2 stuff is outdated. And if there is something useful in it, one could also use git history to recover it easily.
> 
> Okay. Done.

Thanks!


---

Comment by @tobiasdiez created at 2022-04-09 19:48:53

Replying to [comment:51 klee]:
> Replying to [comment:48 gh-tobiasdiez]:
> > Otherwise it looks good to me. Is there still something to do?
> 
> Perhaps no. But before we go to "needs review", I want that more people check the documentation built with mathjax3 (with CDN and without) to find any degradation or regression of the doc compared with the doc built with mathjax2. Let's not rush.

Sure!
The documentation workflow on github fails with this ticket since the mathjax tar cannot be downloaded. Is this to be expected? Should/can the script not fallback to get mathjax from github instead of trying to download it from mirrors?


---

Comment by mkoeppe created at 2022-04-09 20:40:16

Replying to [comment:23 jhpalmieri]:
> When it's convenient, could you please upload the tarball somewhere? (As you've observed, I think we've always built our own mathjax tarball, so we can't use the "upstream_url" field in `checksums.ini` to download from a standard location.)

The temporary URL should be put in checksums.ini, then all the automated tools will work.


---

Comment by klee created at 2022-04-10 09:49:20

Replying to [comment:54 mkoeppe]:
> Replying to [comment:23 jhpalmieri]:
> > When it's convenient, could you please upload the tarball somewhere? (As you've observed, I think we've always built our own mathjax tarball, so we can't use the "upstream_url" field in `checksums.ini` to download from a standard location.)
> 
> The temporary URL should be put in checksums.ini, then all the automated tools will work.

In fact, that doesn't work (with me). Perhaps because Google Drive is not an ftp server...


---

Comment by mkoeppe created at 2022-04-10 21:25:01

If the file is not too big, you can attach it to this ticket and use the resulting URL instead.


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-11 00:35:20

Replying to [comment:58 mkoeppe]:
> If the file is not too big, 

I am not sure how big is "too big".

> you can attach it to this ticket and use the resulting URL instead. 

Anyway, done. Would this be a temporary (to be deleted before the branch is merged) or permanent (keep the tarball in trac) url?


---

Comment by mkoeppe created at 2022-04-11 00:37:17

Replying to [comment:60 klee]:
> Replying to [comment:58 mkoeppe]:
> > If the file is not too big, 
> 
> I am not sure how big is "too big".

It worked, so it was not too big


---

Comment by mkoeppe created at 2022-04-11 00:38:51

Replying to [comment:60 klee]:
> Replying to [comment:58 mkoeppe]:
> > If the file is not too big, 
> 
> I am not sure how big is "too big".
> 
> > you can attach it to this ticket and use the resulting URL instead. 
> 
> Anyway, done. Would this be a temporary (to be deleted before the branch is merged) or permanent (keep the tarball in trac) url?

Either permanent or kept at least until the release manager has made the next beta. The release management scripts make use of the `upstream_url` to send files to the file server.


---

Comment by @tobiasdiez created at 2022-04-11 17:58:58

The github action still fails with the same error (no mirror found): https://github.com/sagemath/sagetrac-mirror/runs/5964659669?check_suite_focus=true


---

Comment by klee created at 2022-04-12 00:22:43

Replying to [comment:63 mkoeppe]:
> > Anyway, done. Would this be a temporary (to be deleted before the branch is merged) or permanent (keep the tarball in trac) url?
> 
> Either permanent or kept at least until the release manager has made the next beta. The release management scripts make use of the `upstream_url` to send files to the file server.

That's good to know. Then I would not remove the `upstream_url` and the tarball attached.


---

Comment by klee created at 2022-04-12 10:45:05

While I see no difference in the quality of typeset maths in mathjax3 docs from mathjax2 docs, I observe mathjax3 docs load slightly slower than mathjax2 docs. Do you see the same? This is strange because mathjax3 is supposed (said) to load faster than mathjax2...


---

Comment by mjo created at 2022-04-13 20:20:04

With MathJax3, the docs actually load for me, so I think #18596 has been fixed as a side effect. One thing I've noticed though is that, even with the default value of `--use-cdns=False`, I get references to a few CDNs in my docs. For example,


```
$ grep '<script.*src=' ./local/share/doc/sage/html/en/reference/index.html
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/`@`jupyter-widgets/html-manager`@`^0.20.0/dist/embed-amd.js"></script>
    <script defer="defer" src="_static/mathjax/tex-chtml.js"></script>
  <!-- <script src="_static/thebe.js" type="text/javascript"></script> -->
  <!-- <script src="_static/thebe-sage.js" type="text/javascript"></script> -->
```


I don't know if those are related to this ticket, but I figured I'd mention it.


---

Comment by @tobiasdiez created at 2022-04-13 20:22:04

Replying to [comment:66 klee]:
> While I see no difference in the quality of typeset maths in mathjax3 docs from mathjax2 docs, I observe mathjax3 docs load slightly slower than mathjax2 docs. Do you see the same? This is strange because mathjax3 is supposed (said) to load faster than mathjax2...

If you please could fix the documentation github workflow, then one can easily test this by running some benchmarks (e.g. using https://pagespeed.web.dev/).


---

Comment by klee created at 2022-04-14 00:13:53

Replying to [comment:67 mjo]:
> With MathJax3, the docs actually load for me, so I think #18596 has been fixed as a side effect. 

Good. 

> One thing I've noticed though is that, even with the default value of `--use-cdns=False`, I get references to a few CDNs in my docs. For example,
> 
> {{{
> $ grep '<script.*src=' ./local/share/doc/sage/html/en/reference/index.html
>     <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
>     <script src="_static/jquery.js"></script>
>     <script src="_static/underscore.js"></script>
>     <script src="_static/doctools.js"></script>
>     <script src="_static/thebelab-helper.js"></script>
>     <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
>     <script src="https://unpkg.com/`@`jupyter-widgets/html-manager`@`^0.20.0/dist/embed-amd.js"></script>
>     <script defer="defer" src="_static/mathjax/tex-chtml.js"></script>
>   <!-- <script src="_static/thebe.js" type="text/javascript"></script> -->
>   <!-- <script src="_static/thebe-sage.js" type="text/javascript"></script> -->
> }}}
> 
> I don't know if those are related to this ticket, but I figured I'd mention it.

See ticket:33320#comment:82.


---

Comment by klee created at 2022-04-14 00:21:16

Replying to [comment:68 gh-tobiasdiez]:
> Replying to [comment:66 klee]:
> > While I see no difference in the quality of typeset maths in mathjax3 docs from mathjax2 docs, I observe mathjax3 docs load slightly slower than mathjax2 docs. Do you see the same? This is strange because mathjax3 is supposed (said) to load faster than mathjax2...
> 
> If you please could fix the documentation github workflow, then one can easily test this by running some benchmarks (e.g. using https://pagespeed.web.dev/).

I have no experience with github workflow, but I will see it. 

For the issue, I am waiting for an answer to https://github.com/mathjax/MathJax/issues/2862.


---

Comment by klee created at 2022-04-14 02:34:29

Replying to [comment:64 gh-tobiasdiez]:
> The github action still fails with the same error (no mirror found): https://github.com/sagemath/sagetrac-mirror/runs/5964659669?check_suite_focus=true

I don't know what is going on with github workflow, but I cannot find something like this in the log:

```
[mathjax-3.2.0] ERROR [transfer|run:135]: [Errno socket error] [Errno 404] Not Found: '//sagepad.org/spkg/upstream/mathjax/mathjax-3.2.0.tar.gz'
[mathjax-3.2.0] Attempting to download from https://trac.sagemath.org/raw-attachment/ticket/25833/mathjax-3.2.0.tar.gz
[mathjax-3.2.0] [......................................................................]
[mathjax-3.2.0] mathjax-3.2.0
[mathjax-3.2.0] ====================================================
[mathjax-3.2.0] Setting up build directory for mathjax-3.2.0
[mathjax-3.2.0] Finished extraction
[mathjax-3.2.0] No patch files found in ../patches
[mathjax-3.2.0] ****************************************************
[mathjax-3.2.0] Host system:
[mathjax-3.2.0] Darwin Hera.local 21.4.0 Darwin Kernel Version 21.4.0: Fri Mar 18 00:45:05 PDT 2022; root:xnu-8020.101.4~15/RELEASE_X86_64 x86_64
[mathjax-3.2.0] ****************************************************
[mathjax-3.2.0] C compiler: gcc
[mathjax-3.2.0] C compiler version:
[mathjax-3.2.0] Apple clang version 13.1.6 (clang-1316.0.21.2.3)
[mathjax-3.2.0] Target: x86_64-apple-darwin21.4.0
[mathjax-3.2.0] Thread model: posix
[mathjax-3.2.0] InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
[mathjax-3.2.0] ****************************************************
[mathjax-3.2.0] Package 'mathjax' is currently not installed
[mathjax-3.2.0] No legacy uninstaller found for 'mathjax'; nothing to do
[mathjax-3.2.0] src/mathjax -> /Users/kwankyu/GitHub/sage-dev/local/var/tmp/sage/build/mathjax-3.2.0/inst/Users/kwankyu/GitHub/sage-dev/local/share/mathjax
[mathjax-3.2.0] 
[mathjax-3.2.0] real	0m0.117s
[mathjax-3.2.0] user	0m0.015s
[mathjax-3.2.0] sys	0m0.099s
[mathjax-3.2.0] Copying package files from temporary location /Users/kwankyu/GitHub/sage-dev/local/var/tmp/sage/build/mathjax-3.2.0/inst to /Users/kwankyu/GitHub/sage-dev/local
[mathjax-3.2.0] Successfully installed mathjax-3.2.0
[mathjax-3.2.0] Deleting temporary build directory
[mathjax-3.2.0] /Users/kwankyu/GitHub/sage-dev/local/var/tmp/sage/build/mathjax-3.2.0
[mathjax-3.2.0] Finished installing mathjax-3.2.0
```



---

Comment by klee created at 2022-04-14 04:08:53

Ah, you need `./configure --enable-download-from-upstream-url`.


---

Comment by git created at 2022-04-14 07:48:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-14 07:51:12

The last commit is to lessen flickering in the reference main page because of slow mathjax rendering.


---

Comment by klee created at 2022-04-14 07:54:09

Changing status from new to needs_review.


---

Comment by klee created at 2022-04-14 07:54:09

It seems there is nothing for us to do for a bit slow loading of mathjax3.

Let's move on.


---

Comment by @tobiasdiez created at 2022-04-14 17:33:03

Replying to [comment:72 klee]:
> Ah, you need `./configure --enable-download-from-upstream-url`.

Okay! Matthias (and everyone else), would it make sense to add this flag to the github actions?


---

Comment by mkoeppe created at 2022-04-14 17:51:18

Yes, we already use it everywhere. Did we forget to add it in the ones that you added?


---

Comment by klee created at 2022-04-15 07:05:11

Replying to [comment:77 mkoeppe]:
> Yes, we already use it everywhere. 

A patchbot also failed in the same way.


---

Comment by git created at 2022-04-16 17:32:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-16 19:18:07

Replying to [comment:77 mkoeppe]:
> Yes, we already use it everywhere. Did we forget to add it in the ones that you added?

Thanks, I've now added it to the Build & Test and Build documentation workflows. The latter works now (the former has currently some issues with the ubuntu server, but that's not specific to this ticket).


---

Comment by @tobiasdiez created at 2022-04-16 19:19:44

Replying to [comment:66 klee]:
> While I see no difference in the quality of typeset maths in mathjax3 docs from mathjax2 docs, I observe mathjax3 docs load slightly slower than mathjax2 docs. Do you see the same? This is strange because mathjax3 is supposed (said) to load faster than mathjax2...

I cannot confirm these performance issues. On the contrary, the mathjax 3 version seems to load faster.

- Mathjax3: https://7b43a317c103400d467a6c8d65fb6d6181d4ee37--sagemath-tobias.netlify.app/reference/manifolds/sage/manifolds/differentiable/vectorfield.html
- Mathjax2: https://625315e3e8aca22301c90442--sagemath-tobias.netlify.app/reference/manifolds/sage/manifolds/differentiable/vectorfield.html


---

Comment by @tobiasdiez created at 2022-04-16 19:21:31

I'm fine with your changes! Thanks


---

Comment by mkoeppe created at 2022-04-16 19:42:38

Replying to [comment:80 gh-tobiasdiez]:
> Replying to [comment:77 mkoeppe]:
> > Yes, we already use it everywhere. Did we forget to add it in the ones that you added?
> 
> Thanks, I've now added it to the Build & Test and Build documentation workflows. The latter works now (the former has currently some issues with the ubuntu server, but that's not specific to this ticket).

I've cherry-picked this onto #33724.


---

Comment by @tobiasdiez created at 2022-04-16 21:36:56

Okay, thanks!


---

Comment by klee created at 2022-04-16 23:37:30

Replying to [comment:81 gh-tobiasdiez]:
> I cannot confirm these performance issues. On the contrary, the mathjax 3 version seems to load faster.
> 
> - Mathjax3: https://7b43a317c103400d467a6c8d65fb6d6181d4ee37--sagemath-tobias.netlify.app/reference/manifolds/sage/manifolds/differentiable/vectorfield.html
> - Mathjax2: https://625315e3e8aca22301c90442--sagemath-tobias.netlify.app/reference/manifolds/sage/manifolds/differentiable/vectorfield.html

Okay. That seems depend.


---

Comment by klee created at 2022-04-19 04:59:02

Replying to [comment:70 klee]:
> For the issue, I am waiting for an answer to https://github.com/mathjax/MathJax/issues/2862.

According to the answer, mathjax3 is not to blame if the performance issue is ever real. It's also not clear if the performance issue really exists. 

As there is no other issue raised with the mathjax3 documentation, let's get this in.


---

Comment by klee created at 2022-04-19 04:59:02

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-04-20 19:24:49

Thanks! 

For the performance issues, there are a few things not related to mathjax that could be improved: https://pagespeed.web.dev/report?url=https%3A%2F%2F7b43a317c103400d467a6c8d65fb6d6181d4ee37--sagemath-tobias.netlify.app%2Freference%2Fmanifolds%2Fsage%2Fmanifolds%2Fdifferentiable%2Fvectorfield.html

Notably, the `require` script is quite expensive to load.


---

Comment by klee created at 2022-04-21 00:06:21

Replying to [comment:88 gh-tobiasdiez]:
> Notably, the `require` script is quite expensive to load.

Yes. I noticed that. See ticket:33320#comment:82.


---

Comment by klee created at 2022-04-29 02:12:21

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-04-29 02:25:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-04-29 02:26:35

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-04-29 02:26:35

Rebased on the dependency #33763.


---

Comment by git created at 2022-04-29 03:52:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-29 18:06:35

The dependency got positive review.


---

Comment by klee created at 2022-04-29 18:06:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-05-24 22:45:06

Resolution: fixed


---

Comment by arojas created at 2022-05-30 19:51:14

Why the double `mathjax/mathjax` subdir in the installation path? This looks weird and it will break using distro packages (so far only Arch seems to be shipping mathjax 3, but I doubt any distro will install it to `/usr/share/mathjax/mathjax`)


---

Comment by klee created at 2022-05-31 00:33:22

Replying to [comment:96 arojas]:
> Why the double `mathjax/mathjax` subdir in the installation path? This looks weird 

If I remember correctly, that was the result of wishing to put the (second) `mathjax` directory into `_static` so that all mathjax files are kept in `_static/mathjax` and not mixed with other static files (unlike the situation with mathjax2), while not touching the spkg installation procedure (specifically `build/pkgs/mathjax/spkg-install.in`). Hence the tarball of spkg `mathjax` consists of a single directory `mathjax`.

> and it will break using distro packages (so far only Arch seems to be shipping mathjax 3, but I doubt any distro will install it to `/usr/share/mathjax/mathjax`)

I don't know how the distro package works. Can't they change the installation script to install the package as they want, that is, into `/usr/share/mathjax`?

If they can't, would it solve the problem that the spkg tarball consists of mathjax files instead of the single directory? If we do so, then we need to touch the spkg installation procedure.


---

Comment by arojas created at 2022-05-31 07:53:28

Replying to [comment:97 klee]:
> I don't know how the distro package works. Can't they change the installation script to install the package as they want, that is, into `/usr/share/mathjax`?
> 
> If they can't, would it solve the problem that the spkg tarball consists of mathjax files instead of the single directory? If we do so, then we need to touch the spkg installation procedure. 

OK, I see. The problem is that, if mathjax is installed in `/usr/share/mathjax` (as it is on Arch, and I assume other distros once they upgrade), sphinx will copy its content to `_static`, which is not what Sage expects, so mathjax won't work in docs. And setting `MATHJAX_DIR=/usr/share` is not an option, as this would copy the entire contents of `/usr/share` into `_static`.

It's unfortunate that sphinx doesn't allow to specify a single dir to be copied into `_static`, this would allow the issue to be solved cleanly. I've opened a ticket upstream for this https://github.com/sphinx-doc/sphinx/issues/10499 so we can have a reasonable solution eventually.

For now, if we can't come up with a better solution, I guess I can just copy the mathjax dir to some temporary location at build time and set that as `MATHJAX_DIR`


---

Comment by klee created at 2022-05-31 13:09:17

Replying to [comment:98 arojas]:
> It's unfortunate that sphinx doesn't allow to specify a single dir to be copied into `_static`, this would allow the issue to be solved cleanly. I've opened a ticket upstream for this https://github.com/sphinx-doc/sphinx/issues/10499 so we can have a reasonable solution eventually.

True. Thanks.
 
> For now, if we can't come up with a better solution, I guess I can just copy the mathjax dir to some temporary location at build time and set that as `MATHJAX_DIR`

I experimented with the idea of using a symbolic link instead of copying, but it didn't work. Still no better solution. Thanks.
