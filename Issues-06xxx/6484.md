# Issue 6484: sage.combinat.ranker improvements

archive/issues_006484.json:
```json
{
    "assignees": [
        "https://github.com/nthiery"
    ],
    "body": "sage.combinat.ranker needs improvements:\n-  With:\n\n    ```\n    sage: f = sage.combinat.ranker.rank_from_list([...]) \n   ```\n\n   f uses `list.index`, and is therefore `O(n)`. This should be made `O(1)` with a hash table.\n\nFurther potential improvement (for a later ticket?):\n\n- make the rank / unrank objects produced by this library picklable.\n\n\nCC:  @sagetrac-sage-combinat @tscrim @hivert @avirmaux\n\nKeywords: **rank, unrank**\n\nBranch/Commit: **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**\n\nReviewer: **Vincent Delecroix**\n\nAuthor: **Nicolas M. Thi\u00e9ry**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/6484_\n\n",
    "closed_at": "2015-05-06T21:03:26Z",
    "created_at": "2009-07-08T16:48:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage.combinat.ranker improvements",
    "type": "issue",
    "updated_at": "2015-05-06T21:03:26Z",
    "url": "https://github.com/sagemath/sage/issues/6484",
    "user": "https://github.com/nthiery"
}
```
sage.combinat.ranker needs improvements:
-  With:

    ```
    sage: f = sage.combinat.ranker.rank_from_list([...]) 
   ```

   f uses `list.index`, and is therefore `O(n)`. This should be made `O(1)` with a hash table.

Further potential improvement (for a later ticket?):

- make the rank / unrank objects produced by this library picklable.


CC:  @sagetrac-sage-combinat @tscrim @hivert @avirmaux

Keywords: **rank, unrank**

Branch/Commit: **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**

Reviewer: **Vincent Delecroix**

Author: **Nicolas M. Thi√©ry**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/6484_





---

archive/issue_events_078282.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-07-08T16:48:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78282"
}
```



---

archive/issue_events_078283.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-07-08T16:48:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78283"
}
```



---

archive/issue_events_078284.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-07-08T16:48:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78284"
}
```



---

archive/issue_events_078285.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-07-08T16:48:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78285"
}
```



---

archive/issue_events_078286.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-07-08T16:48:08Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "subject": "https://github.com/nthiery",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78286"
}
```



---

archive/issue_events_078287.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78287"
}
```



---

archive/issue_events_078288.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78288"
}
```



---

archive/issue_events_078289.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78289"
}
```



---

archive/issue_events_078290.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78290"
}
```



---

archive/issue_events_078291.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78291"
}
```



---

archive/issue_events_078292.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78292"
}
```



---

archive/issue_events_078293.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78293"
}
```



---

archive/issue_events_078294.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78294"
}
```



---

archive/issue_comments_044164.json:
```json
{
    "body": "Branch: **[u/nthiery/sage_combinat_ranker_improvements](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/sage_combinat_ranker_improvements)**",
    "created_at": "2015-04-27T17:25:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44164",
    "user": "https://github.com/nthiery"
}
```

Branch: **[u/nthiery/sage_combinat_ranker_improvements](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/sage_combinat_ranker_improvements)**



---

archive/issue_events_078295.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-04-27T17:27:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78295"
}
```



---

archive/issue_comments_044165.json:
```json
{
    "body": "Commit: **[`32d5cea`](https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305)**",
    "created_at": "2015-04-27T17:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44165",
    "user": "https://github.com/nthiery"
}
```

Commit: **[`32d5cea`](https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305)**



---

archive/issue_comments_044166.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,10 +5,10 @@\n     sage: f = sage.combinat.ranker.rank_from_list([...]) \n    ```\n \n-   f uses list.index, and is therefore O(n). This should be made O(1) with a hash table.\n+   f uses ``list.index``, and is therefore `O(n)`. This should be made `O(1)` with a hash table.\n \n-- The rank / unrank objects produced by this library should be picklable.\n+Further potential improvement (for a later ticket?):\n \n-- ...?\n+- make the rank / unrank objects produced by this library picklable.\n \n-patch under construction on the sage-combinat patch server.\n+\n``````\n",
    "created_at": "2015-04-27T17:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44166",
    "user": "https://github.com/nthiery"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,10 +5,10 @@
     sage: f = sage.combinat.ranker.rank_from_list([...]) 
    ```
 
-   f uses list.index, and is therefore O(n). This should be made O(1) with a hash table.
+   f uses ``list.index``, and is therefore `O(n)`. This should be made `O(1)` with a hash table.
 
-- The rank / unrank objects produced by this library should be picklable.
+Further potential improvement (for a later ticket?):
 
-- ...?
+- make the rank / unrank objects produced by this library picklable.
 
-patch under construction on the sage-combinat patch server.
+
``````




---

archive/issue_comments_044167.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305\">32d5cea</a></td><td><code>6484: implementation of sage.combinat.ranker.rank_from_list to be constant time</code></td></tr></table>\n",
    "created_at": "2015-04-27T17:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44167",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:6"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305">32d5cea</a></td><td><code>6484: implementation of sage.combinat.ranker.rank_from_list to be constant time</code></td></tr></table>




---

archive/issue_comments_044168.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThis is essentially ``trac_6484-ranker-improvements-nt.patch`` from the Sage-Combinat queue, with further cleanup and doc.",
    "created_at": "2015-04-27T17:28:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44168",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:7" align="right">comment:7</div>

This is essentially ``trac_6484-ranker-improvements-nt.patch`` from the Sage-Combinat queue, with further cleanup and doc.



---

archive/issue_comments_044169.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,10 +5,9 @@\n     sage: f = sage.combinat.ranker.rank_from_list([...]) \n    ```\n \n-   f uses ``list.index``, and is therefore `O(n)`. This should be made `O(1)` with a hash table.\n+   f uses `list.index`, and is therefore `O(n)`. This should be made `O(1)` with a hash table.\n \n Further potential improvement (for a later ticket?):\n \n - make the rank / unrank objects produced by this library picklable.\n \n-\n``````\n",
    "created_at": "2015-04-27T17:29:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44169",
    "user": "https://github.com/nthiery"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,10 +5,9 @@
     sage: f = sage.combinat.ranker.rank_from_list([...]) 
    ```
 
-   f uses ``list.index``, and is therefore `O(n)`. This should be made `O(1)` with a hash table.
+   f uses `list.index`, and is therefore `O(n)`. This should be made `O(1)` with a hash table.
 
 Further potential improvement (for a later ticket?):
 
 - make the rank / unrank objects produced by this library picklable.
 
-
``````




---

archive/issue_comments_044170.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nShould we worry about backward compatibility and revert to l.index if any of the object is not hashable?",
    "created_at": "2015-04-27T17:29:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44170",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:8" align="right">comment:8</div>

Should we worry about backward compatibility and revert to l.index if any of the object is not hashable?



---

archive/issue_comments_044171.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHow much do we care about picklability right now? I am not sure how to implement it. On the other hand, fast rank would be very useful for #18311, ...",
    "created_at": "2015-04-27T17:32:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44171",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:9" align="right">comment:9</div>

How much do we care about picklability right now? I am not sure how to implement it. On the other hand, fast rank would be very useful for #18311, ...



---

archive/issue_comments_044172.json:
```json
{
    "body": "Changed author from **nthiery** to **Nicolas M. Thi\u00e9ry**",
    "created_at": "2015-04-27T17:32:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44172",
    "user": "https://github.com/nthiery"
}
```

Changed author from **nthiery** to **Nicolas M. Thi√©ry**



---

archive/issue_comments_044173.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI'm okay with the hashability as we assume all elements to be hashable, nor is picklability important to me. However this now makes `rank_from_list` to be the `O(n)` function, and the function itself is not cached. So for large lists (or worse, say for a crystal where iteration is relatively expensive), this could lead to a pretty large slowdown. How about we just return the original implementation of `rank` as a cached function?",
    "created_at": "2015-04-27T17:46:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44173",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:11" align="right">comment:11</div>

I'm okay with the hashability as we assume all elements to be hashable, nor is picklability important to me. However this now makes `rank_from_list` to be the `O(n)` function, and the function itself is not cached. So for large lists (or worse, say for a crystal where iteration is relatively expensive), this could lead to a pretty large slowdown. How about we just return the original implementation of `rank` as a cached function?



---

archive/issue_comments_044174.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI Travis!\n\nReplying to [@tscrim](#comment:11):\n> I'm okay with the hashability as we assume all elements to be hashable\n\nWell, this hashabilitiy assumption was not there before this ticket. So technically speaking that's a backward incompatible change. I agree that in all use cases I can think of, the objects are hashable, so it probably is not a big deal.\n\n>, nor is picklability important to me. However this now makes `rank_from_list` to be the `O(n)` function, and the function itself is not cached. So for large lists (or worse, say for a crystal where iteration is relatively expensive), this could lead to a pretty large slowdown. How about we just return the original implementation of `rank` as a cached function?\n\nWhen `rank_from_list` is called, that's usually with the intention of calling it intensively afterward; in particular the ranker is typically stored in the calling object for all later reuse. At least, that's the case in all the current calls in the Sage library.\n\nBeing completely lazy and implementhing `rank_from_list` as a cached function on top of `list.index` would imply an overhead of `O(n^2)` instead of `O(n)` before we reach the limit state where the complexity in `O(1)`; not great. We could introduce some partial lazyness, making sure that the first time an object `x` is looked up, the cache is set for all objects before `x` in the list. What do you think? Is it worth it?\n\nA note: the name `from_list` makes it relatively explicit that the iterable will be expanded anyway.\n\nCheers,\n                          Nicolas",
    "created_at": "2015-04-27T20:06:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44174",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:12" align="right">comment:12</div>

I Travis!

Replying to [@tscrim](#comment:11):
> I'm okay with the hashability as we assume all elements to be hashable

Well, this hashabilitiy assumption was not there before this ticket. So technically speaking that's a backward incompatible change. I agree that in all use cases I can think of, the objects are hashable, so it probably is not a big deal.

>, nor is picklability important to me. However this now makes `rank_from_list` to be the `O(n)` function, and the function itself is not cached. So for large lists (or worse, say for a crystal where iteration is relatively expensive), this could lead to a pretty large slowdown. How about we just return the original implementation of `rank` as a cached function?

When `rank_from_list` is called, that's usually with the intention of calling it intensively afterward; in particular the ranker is typically stored in the calling object for all later reuse. At least, that's the case in all the current calls in the Sage library.

Being completely lazy and implementhing `rank_from_list` as a cached function on top of `list.index` would imply an overhead of `O(n^2)` instead of `O(n)` before we reach the limit state where the complexity in `O(1)`; not great. We could introduce some partial lazyness, making sure that the first time an object `x` is looked up, the cache is set for all objects before `x` in the list. What do you think? Is it worth it?

A note: the name `from_list` makes it relatively explicit that the iterable will be expanded anyway.

Cheers,
                          Nicolas



---

archive/issue_comments_044175.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9\">220cf7c</a></td><td><code>6484: make rank_from_list's ValueError message for string objects identical to the previous one</code></td></tr></table>\n",
    "created_at": "2015-04-27T20:22:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44175",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9">220cf7c</a></td><td><code>6484: make rank_from_list's ValueError message for string objects identical to the previous one</code></td></tr></table>




---

archive/issue_comments_044176.json:
```json
{
    "body": "Changed commit from **[`32d5cea`](https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305)** to **[`220cf7c`](https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9)**",
    "created_at": "2015-04-27T20:22:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44176",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`32d5cea`](https://github.com/sagemath/sagetrac-mirror/commit/32d5cea664e153895d663b5913e45d03b8c0a305)** to **[`220cf7c`](https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9)**



---

archive/issue_comments_044177.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThis should fix the single error reported by the patchbot.",
    "created_at": "2015-04-27T20:23:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44177",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:14" align="right">comment:14</div>

This should fix the single error reported by the patchbot.



---

archive/issue_comments_044178.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nTrue, that would end up being `O(n^2)`. Since this seems to only be used in 2 places, `combinat.free_module.py` and `sets.finite_set_maps.py`, and in both places, the resulting function is cached, I think this would be okay as is. However, would you mind putting a warning about repeatedly recreating the function?",
    "created_at": "2015-04-28T04:59:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44178",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

True, that would end up being `O(n^2)`. Since this seems to only be used in 2 places, `combinat.free_module.py` and `sets.finite_set_maps.py`, and in both places, the resulting function is cached, I think this would be okay as is. However, would you mind putting a warning about repeatedly recreating the function?



---

archive/issue_comments_044179.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nYou know that with `@cached_function` instead of a plain dictionary you are building a 2-tuple containg a tuple enclosing the object and an empty tuple?\n\n```\nsage: r = rank_from_list(range(10))\nsage: r.get_cache()\n{((0,), ()): 0,\n ((1,), ()): 1,\n ((2,), ()): 2,\n ((3,), ()): 3,\n ((4,), ()): 4,\n ((5,), ()): 5,\n ((6,), ()): 6,\n ((7,), ()): 7,\n ((8,), ()): 8,\n ((9,), ()): 9}\n```\n\nWhat is wrong with\n\n```\ndef rank_from_list(l):\n    my_dict = {j:i for i,j in enumerate(l)}\n    def rank(i):\n        return my_dict[i]\n```\nIt is not very clean, but at least cleaner. And also faster by the way.\n\nVincent",
    "created_at": "2015-04-28T21:18:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44179",
    "user": "https://github.com/videlec"
}
```

<div id="comment:16" align="right">comment:16</div>

You know that with `@cached_function` instead of a plain dictionary you are building a 2-tuple containg a tuple enclosing the object and an empty tuple?

```
sage: r = rank_from_list(range(10))
sage: r.get_cache()
{((0,), ()): 0,
 ((1,), ()): 1,
 ((2,), ()): 2,
 ((3,), ()): 3,
 ((4,), ()): 4,
 ((5,), ()): 5,
 ((6,), ()): 6,
 ((7,), ()): 7,
 ((8,), ()): 8,
 ((9,), ()): 9}
```

What is wrong with

```
def rank_from_list(l):
    my_dict = {j:i for i,j in enumerate(l)}
    def rank(i):
        return my_dict[i]
```
It is not very clean, but at least cleaner. And also faster by the way.

Vincent



---

archive/issue_comments_044180.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nAh, good point; I thought our cached functions had a special case for\none parameter functions. Other than that, using a cached function was\nmostly a (failed) attempt at having something picklable as well.\n\nSo, let's see about speed with various implementations:\n\n```\nsage: l = range(100);\nsage: d = { x:i for i,x in enumerate(l) }\nsage: @cached_function\n....: def rank_cached(): pass\nsage: for i,x in enumerate(l):\n....:     rank_cached.set_cache(i, x)\nsage: def rank_dict(x):\n....:     return d[x]\nsage: rank_dict_getitem = d.__getitem__\n\nsage: cython(\"\"\"\nl = range(100);\nd = { x:i for i,x in enumerate(l) }\ncpdef int rank_dict_cython(x):\n    return d[x]\n\"\"\")\nsage: cython(\"\"\"\nl = range(100);\nd = { x:i for i,x in enumerate(l) }\ncpdef int rank_dict_cython_exception(x):\n    try:\n        return d[x]\n    except KeyError:\n        raise ValueError(\"%s is not blah blah blah\"%x)\n\"\"\")\n\nsage: cython(\"\"\"\ncdef class RankFromList(dict):\n    def __call__(self, x):\n        try:\n            return self[x]\n        except KeyError:\n            raise ValueError(\"%s is not blah blah blah\"%x)\n\"\"\")\nsage: rank_dict_cython_class = RankFromList((x,i) for i,x in enumerate(l))\n```\n\nHere are the timings, in decreasing order:\n\n```\nsage: sage: %timeit rank_cached(50)\nThe slowest run took 41.96 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 381 ns per loop\nsage: sage: %timeit rank_dict(50)\nThe slowest run took 15.56 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 245 ns per loop\nsage: sage: %timeit rank_dict_cython_class(50)\nThe slowest run took 22.12 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 226 ns per loop\nsage: sage: %timeit rank_dict_cython_exception(50)\nThe slowest run took 36.63 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 195 ns per loop\nsage: sage: %timeit rank_dict_cython(50)\nThe slowest run took 31.18 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 191 ns per loop\nsage: sage: %timeit rank_dict_getitem(50)\nThe slowest run took 17.96 times longer than the fastest. This could mean that an intermediate result is being cached \n1000000 loops, best of 3: 173 ns per loop\n```\n\nThose timing seem to be consistent from one call to the other. Most of\nthe time this feature is used with non trivial objects where the\nbottleneck is the computation of hash/equality of the objects. So we\ndon't necessarily need to optimize to the last bit.\n\nIn view of the above, the fastest is to return the `__getitem__`\nmethod of the dictionary. The main caveat is that we don't have\ncontrol on the exception (a `KeyError` instead of a\n`ValueError`). Maybe it is not so bad since a `KeyError` is a special\nkind of `ValueError`.\n\nThe most flexible is to use a class. In particular, this would make\nthe ranker picklable (this can be useful: I have had cases where an\nobject would not pickle properly because one of it's attribute was a\nranker). This also opens the door for reintroducing laziness later\non. It's 30% slower than `getitem` which could be acceptable (I was in\nfact expecting a smaller overhead; maybe I missed something in the\ncythonization).\n\nWhat do you think?\n\nCheers,\n                         Nicolas",
    "created_at": "2015-04-30T07:55:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44180",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:17" align="right">comment:17</div>

Ah, good point; I thought our cached functions had a special case for
one parameter functions. Other than that, using a cached function was
mostly a (failed) attempt at having something picklable as well.

So, let's see about speed with various implementations:

```
sage: l = range(100);
sage: d = { x:i for i,x in enumerate(l) }
sage: @cached_function
....: def rank_cached(): pass
sage: for i,x in enumerate(l):
....:     rank_cached.set_cache(i, x)
sage: def rank_dict(x):
....:     return d[x]
sage: rank_dict_getitem = d.__getitem__

sage: cython("""
l = range(100);
d = { x:i for i,x in enumerate(l) }
cpdef int rank_dict_cython(x):
    return d[x]
""")
sage: cython("""
l = range(100);
d = { x:i for i,x in enumerate(l) }
cpdef int rank_dict_cython_exception(x):
    try:
        return d[x]
    except KeyError:
        raise ValueError("%s is not blah blah blah"%x)
""")

sage: cython("""
cdef class RankFromList(dict):
    def __call__(self, x):
        try:
            return self[x]
        except KeyError:
            raise ValueError("%s is not blah blah blah"%x)
""")
sage: rank_dict_cython_class = RankFromList((x,i) for i,x in enumerate(l))
```

Here are the timings, in decreasing order:

```
sage: sage: %timeit rank_cached(50)
The slowest run took 41.96 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 381 ns per loop
sage: sage: %timeit rank_dict(50)
The slowest run took 15.56 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 245 ns per loop
sage: sage: %timeit rank_dict_cython_class(50)
The slowest run took 22.12 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 226 ns per loop
sage: sage: %timeit rank_dict_cython_exception(50)
The slowest run took 36.63 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 195 ns per loop
sage: sage: %timeit rank_dict_cython(50)
The slowest run took 31.18 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 191 ns per loop
sage: sage: %timeit rank_dict_getitem(50)
The slowest run took 17.96 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 173 ns per loop
```

Those timing seem to be consistent from one call to the other. Most of
the time this feature is used with non trivial objects where the
bottleneck is the computation of hash/equality of the objects. So we
don't necessarily need to optimize to the last bit.

In view of the above, the fastest is to return the `__getitem__`
method of the dictionary. The main caveat is that we don't have
control on the exception (a `KeyError` instead of a
`ValueError`). Maybe it is not so bad since a `KeyError` is a special
kind of `ValueError`.

The most flexible is to use a class. In particular, this would make
the ranker picklable (this can be useful: I have had cases where an
object would not pickle properly because one of it's attribute was a
ranker). This also opens the door for reintroducing laziness later
on. It's 30% slower than `getitem` which could be acceptable (I was in
fact expecting a smaller overhead; maybe I missed something in the
cythonization).

What do you think?

Cheers,
                         Nicolas



---

archive/issue_comments_044181.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nIf pickling is an issue then I would go for `cdef class RankFromList` but with a more appropriated name. It is not possible to set `tp_getitem = tp_call` since the signatures are different.\n\nIf you create a Cython class, then please replace the `sage.combinat.words.morphism.CallableDict` with the new one.\n\nVincent",
    "created_at": "2015-04-30T08:33:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44181",
    "user": "https://github.com/videlec"
}
```

<div id="comment:18" align="right">comment:18</div>

If pickling is an issue then I would go for `cdef class RankFromList` but with a more appropriated name. It is not possible to set `tp_getitem = tp_call` since the signatures are different.

If you create a Cython class, then please replace the `sage.combinat.words.morphism.CallableDict` with the new one.

Vincent



---

archive/issue_comments_044182.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c\">d50b0c5</a></td><td><code>6484: extract and Cythonize CallableDict from sage.combinat.words.morphism and use it in sage.combinat.ranker.rank_from_list</code></td></tr></table>\n",
    "created_at": "2015-05-03T23:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44182",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c">d50b0c5</a></td><td><code>6484: extract and Cythonize CallableDict from sage.combinat.words.morphism and use it in sage.combinat.ranker.rank_from_list</code></td></tr></table>




---

archive/issue_comments_044183.json:
```json
{
    "body": "Changed commit from **[`220cf7c`](https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9)** to **[`d50b0c5`](https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c)**",
    "created_at": "2015-05-03T23:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44183",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`220cf7c`](https://github.com/sagemath/sagetrac-mirror/commit/220cf7c58941afb5e775842da73e2291a800e0d9)** to **[`d50b0c5`](https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c)**



---

archive/issue_comments_044184.json:
```json
{
    "body": "Changed commit from **[`d50b0c5`](https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c)** to **[`584209b`](https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9)**",
    "created_at": "2015-05-03T23:30:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44184",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d50b0c5`](https://github.com/sagemath/sagetrac-mirror/commit/d50b0c5721d1ffc28be1eca451dd1e6a6786e84c)** to **[`584209b`](https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9)**



---

archive/issue_comments_044185.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9\">584209b</a></td><td><code>6484: extract and Cythonize CallableDict from sage.combinat.words.morphism and use it in sage.combinat.ranker.rank_from_list</code></td></tr></table>\n",
    "created_at": "2015-05-03T23:30:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44185",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9">584209b</a></td><td><code>6484: extract and Cythonize CallableDict from sage.combinat.words.morphism and use it in sage.combinat.ranker.rank_from_list</code></td></tr></table>




---

archive/issue_comments_044186.json:
```json
{
    "body": "Changed commit from **[`584209b`](https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9)** to **[`5adb289`](https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b)**",
    "created_at": "2015-05-03T23:39:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`584209b`](https://github.com/sagemath/sagetrac-mirror/commit/584209beeb7a7785d78cd24ac89c0aff04499bb9)** to **[`5adb289`](https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b)**



---

archive/issue_comments_044187.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b\">5adb289</a></td><td><code>Merge remote-tracking branch 'origin/develop' into combinat/rank_cached-6484</code></td></tr></table>\n",
    "created_at": "2015-05-03T23:39:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44187",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b">5adb289</a></td><td><code>Merge remote-tracking branch 'origin/develop' into combinat/rank_cached-6484</code></td></tr></table>




---

archive/issue_events_078296.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-04T06:24:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78296"
}
```



---

archive/issue_events_078297.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-04T06:24:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78297"
}
```



---

archive/issue_comments_044188.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nHello,\n\nThe final picture looks good. One good thing would be to clean the git history.\n\nThe fastest way to create a dictionary from a list is\n\n```\ncdef dict d = {x:i for i,x in enumerate(l)}\n```\nI guess it avoids the creation of the pair `(i,x)`.\n\nThe documentation can be more precise\n\n```\nNo error is issued in case of duplicate value in ``l``. Instead,\nthe rank function returns the position of some of the duplicates::\n```\nThe rank of the **last value** is returned not just **some**. It would possible to use `PyDict_MergeFromSeq2` to return the first though. But it is not clear to me that it is what we want.\n\nSided note: I am pretty sure that with #18330 that something better can be done so that `__call__` becomes as fast as `__getitem__` (up to a C function call). But not for this ticket.\n\nVincent",
    "created_at": "2015-05-04T06:24:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44188",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">comment:22</div>

Hello,

The final picture looks good. One good thing would be to clean the git history.

The fastest way to create a dictionary from a list is

```
cdef dict d = {x:i for i,x in enumerate(l)}
```
I guess it avoids the creation of the pair `(i,x)`.

The documentation can be more precise

```
No error is issued in case of duplicate value in ``l``. Instead,
the rank function returns the position of some of the duplicates::
```
The rank of the **last value** is returned not just **some**. It would possible to use `PyDict_MergeFromSeq2` to return the first though. But it is not clear to me that it is what we want.

Sided note: I am pretty sure that with #18330 that something better can be done so that `__call__` becomes as fast as `__getitem__` (up to a C function call). But not for this ticket.

Vincent



---

archive/issue_comments_044189.json:
```json
{
    "body": "Changed commit from **[`5adb289`](https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b)** to **[`6fdc7e5`](https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662)**",
    "created_at": "2015-05-04T20:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44189",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5adb289`](https://github.com/sagemath/sagetrac-mirror/commit/5adb28949227305b4ace3a15675549554f237a4b)** to **[`6fdc7e5`](https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662)**



---

archive/issue_comments_044190.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662\">6fdc7e5</a></td><td><code>6484: minor documentation improvements</code></td></tr></table>\n",
    "created_at": "2015-05-04T20:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44190",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662">6fdc7e5</a></td><td><code>6484: minor documentation improvements</code></td></tr></table>




---

archive/issue_comments_044191.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@videlec](#comment:22):\n> The fastest way to create a dictionary from a list is\n> \n> ```\n> cdef dict d = {x:i for i,x in enumerate(l)}\n> ```\n> I guess it avoids the creation of the pair `(i,x)`.\n\nI hesitated about this; however we are creating a `CallableDict` not a\ndict at the end. So using this notation means we are first\nconstructing a dictionary and then copying it into the `CallableDict`.\nThis is indeed slightly faster for lists of trivial objects:\n\n```\nsage: l = range(1000)\nsage: %timeit rank_from_list(l)           # using generator expression\n1000 loops, best of 3: 145 \u00b5s per loop\n\nsage: %timeit rank_from_list(l)           # using {...}\n10000 loops, best of 3: 109 \u00b5s per loop\n```\n\nBut not anymore for lists of objects with non trivial hash/eq:\n\n```\nsage: l = list(Permutations(8))\nsage: %timeit rank_from_list(l)           # using generator expression\nThe slowest run took 10.96 times longer than the fastest. This could mean that an intermediate result is being cached \n1 loops, best of 3: 18.8 ms per loop\n\nsage: %timeit rank_from_list(l)           # using {..}\nThe slowest run took 10.08 times longer than the fastest. This could mean that an intermediate result is being cached \n1 loops, best of 3: 21.7 ms per loop\n```\n\nNote that we can hope for the generator expression to be optimized in\nthe long run when ranker.py will be cythonized.\n\n> The documentation can be more precise\n> \n> ```\n> No error is issued in case of duplicate value in ``l``. Instead,\n> the rank function returns the position of some of the duplicates::\n> ```\n> The rank of the **last value** is returned not just **some**.\n\nThis is on purpose: I don't want to set this behavior in stone, in\norder to leave room for future reimplementations. In any cases it's\nexplicitly said that this function is meant for lists without\nduplicates.\n\n> Sided note: I am pretty sure that with #18330 that something better can be done so that `__call__` becomes as fast as `__getitem__` (up to a C function call). But not for this ticket.\n\nGreat!\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662\">6fdc7e5</a></td><td><code>6484: minor documentation improvements</code></td></tr></table>\n",
    "created_at": "2015-05-04T20:31:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44191",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@videlec](#comment:22):
> The fastest way to create a dictionary from a list is
> 
> ```
> cdef dict d = {x:i for i,x in enumerate(l)}
> ```
> I guess it avoids the creation of the pair `(i,x)`.

I hesitated about this; however we are creating a `CallableDict` not a
dict at the end. So using this notation means we are first
constructing a dictionary and then copying it into the `CallableDict`.
This is indeed slightly faster for lists of trivial objects:

```
sage: l = range(1000)
sage: %timeit rank_from_list(l)           # using generator expression
1000 loops, best of 3: 145 ¬µs per loop

sage: %timeit rank_from_list(l)           # using {...}
10000 loops, best of 3: 109 ¬µs per loop
```

But not anymore for lists of objects with non trivial hash/eq:

```
sage: l = list(Permutations(8))
sage: %timeit rank_from_list(l)           # using generator expression
The slowest run took 10.96 times longer than the fastest. This could mean that an intermediate result is being cached 
1 loops, best of 3: 18.8 ms per loop

sage: %timeit rank_from_list(l)           # using {..}
The slowest run took 10.08 times longer than the fastest. This could mean that an intermediate result is being cached 
1 loops, best of 3: 21.7 ms per loop
```

Note that we can hope for the generator expression to be optimized in
the long run when ranker.py will be cythonized.

> The documentation can be more precise
> 
> ```
> No error is issued in case of duplicate value in ``l``. Instead,
> the rank function returns the position of some of the duplicates::
> ```
> The rank of the **last value** is returned not just **some**.

This is on purpose: I don't want to set this behavior in stone, in
order to leave room for future reimplementations. In any cases it's
explicitly said that this function is meant for lists without
duplicates.

> Sided note: I am pretty sure that with #18330 that something better can be done so that `__call__` becomes as fast as `__getitem__` (up to a C function call). But not for this ticket.

Great!

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662">6fdc7e5</a></td><td><code>6484: minor documentation improvements</code></td></tr></table>




---

archive/issue_comments_044192.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n\n```\nsage -t --long src/sage/sets/finite_set_map_cy.pyx\n**********************************************************************\nFile \"src/sage/sets/finite_set_map_cy.pyx\", line 491,\nin sage.sets.finite_set_map_cy.FiniteSetMap_Set.setimage\nFailed example:\n    with fs.clone() as fs3:\n          fs3.setimage(\"z\", 2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: 'z' is not in list\nGot:\n    Traceback (most recent call last):\n    ....\n    ValueError: 'z' is not in dict\n**********************************************************************\nFile \"src/sage/sets/finite_set_map_cy.pyx\", line 497,\nin sage.sets.finite_set_map_cy.FiniteSetMap_Set.setimage\nFailed example:\n    with fs.clone() as fs3:\n          fs3.setimage(1, 4)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: 1 is not in list\nGot:\n    Traceback (most recent call last):\n    ...\n    ValueError: 1 is not in dict\n```",
    "created_at": "2015-05-05T06:50:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44192",
    "user": "https://github.com/videlec"
}
```

<div id="comment:25" align="right">comment:25</div>


```
sage -t --long src/sage/sets/finite_set_map_cy.pyx
**********************************************************************
File "src/sage/sets/finite_set_map_cy.pyx", line 491,
in sage.sets.finite_set_map_cy.FiniteSetMap_Set.setimage
Failed example:
    with fs.clone() as fs3:
          fs3.setimage("z", 2)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: 'z' is not in list
Got:
    Traceback (most recent call last):
    ....
    ValueError: 'z' is not in dict
**********************************************************************
File "src/sage/sets/finite_set_map_cy.pyx", line 497,
in sage.sets.finite_set_map_cy.FiniteSetMap_Set.setimage
Failed example:
    with fs.clone() as fs3:
          fs3.setimage(1, 4)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: 1 is not in list
Got:
    Traceback (most recent call last):
    ...
    ValueError: 1 is not in dict
```



---

archive/issue_events_078298.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T06:50:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78298"
}
```



---

archive/issue_events_078299.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T06:50:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78299"
}
```



---

archive/issue_comments_044193.json:
```json
{
    "body": "Reviewer: **Vincent Delecroix**",
    "created_at": "2015-05-05T06:50:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44193",
    "user": "https://github.com/videlec"
}
```

Reviewer: **Vincent Delecroix**



---

archive/issue_comments_044194.json:
```json
{
    "body": "Changed commit from **[`6fdc7e5`](https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662)** to **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**",
    "created_at": "2015-05-05T08:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44194",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6fdc7e5`](https://github.com/sagemath/sagetrac-mirror/commit/6fdc7e5e63016dadc4bab6bfbc47e5a5c0c0e662)** to **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**



---

archive/issue_comments_044195.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098\">27189ca</a></td><td><code>6484: trivial doctest update</code></td></tr></table>\n",
    "created_at": "2015-05-05T08:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44195",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098">27189ca</a></td><td><code>6484: trivial doctest update</code></td></tr></table>




---

archive/issue_events_078300.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-05-05T08:27:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78300"
}
```



---

archive/issue_events_078301.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-05-05T08:27:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78301"
}
```



---

archive/issue_comments_044196.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nAh, shoot, I knew I had to update the doctests there ... Thanks for the report. Fixed!\n\nSpeaking of patchbot blues: do we care about lazy importing the module? Or should it be `words` and `ranker` that should be lazy imported in the first place? Also, I am surprised about the warning about non ascii character given that I declared the encoding of the file to be utf-8.",
    "created_at": "2015-05-05T08:27:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44196",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:27" align="right">comment:27</div>

Ah, shoot, I knew I had to update the doctests there ... Thanks for the report. Fixed!

Speaking of patchbot blues: do we care about lazy importing the module? Or should it be `words` and `ranker` that should be lazy imported in the first place? Also, I am surprised about the warning about non ascii character given that I declared the encoding of the file to be utf-8.



---

archive/issue_comments_044197.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nFor the record: I opened an issue about the false positive report by the ascii plugin of the patchbot: https://github.com/robertwb/sage-patchbot/issues/65",
    "created_at": "2015-05-05T08:41:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44197",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:28" align="right">comment:28</div>

For the record: I opened an issue about the false positive report by the ascii plugin of the patchbot: https://github.com/robertwb/sage-patchbot/issues/65



---

archive/issue_events_078302.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T14:16:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78302"
}
```



---

archive/issue_events_078303.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T14:16:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78303"
}
```



---

archive/issue_events_078304.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-06T21:03:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78304"
}
```



---

archive/issue_events_078305.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "7d1c72bd0fde34b7a835a9dc507d63e71cb63614",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-05-06T21:03:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6484#event-78305"
}
```



---

archive/issue_comments_044198.json:
```json
{
    "body": "Changed branch from **[u/nthiery/sage_combinat_ranker_improvements](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/sage_combinat_ranker_improvements)** to **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**",
    "created_at": "2015-05-06T21:03:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6484#issuecomment-44198",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/nthiery/sage_combinat_ranker_improvements](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/sage_combinat_ranker_improvements)** to **[`27189ca`](https://github.com/sagemath/sagetrac-mirror/commit/27189ca136b4045619df60093647341119fc1098)**
