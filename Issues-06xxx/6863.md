# Issue 6863: Implement cusps over number fields

archive/issues_006863.json:
```json
{
    "assignees": [
        "https://github.com/craigcitro"
    ],
    "body": "This is related to, but not dependent on, #6829.\n\nCusps over a number field K are elements of `P^1(K)`.  Support for these is to be provided as part of the general implementation of modular symbols and related matters over number fields.\n\nA patch which will be available shortly will supply this implementation, together with related utilities such as testing Gamma_0(N)-equivalence etc.\n\nThis work has been done by Maite Aranes, under the supervision of John Cremona.\n\nCC:  @sagetrac-mtaranes\n\nKeywords: **number field modular**\n\nComponent: **modular forms**\n\nAuthor: **Maite Aranes, John Cremona**\n\nReviewer: **Craig Citro, John Cremona**\n\nMerged: **sage-4.3.2.alpha0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/6863_\n\n",
    "closed_at": "2010-01-24T02:51:34Z",
    "created_at": "2009-09-02T13:00:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.3.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Implement cusps over number fields",
    "type": "issue",
    "updated_at": "2010-01-24T02:51:34Z",
    "url": "https://github.com/sagemath/sage/issues/6863",
    "user": "https://github.com/JohnCremona"
}
```
This is related to, but not dependent on, #6829.

Cusps over a number field K are elements of `P^1(K)`.  Support for these is to be provided as part of the general implementation of modular symbols and related matters over number fields.

A patch which will be available shortly will supply this implementation, together with related utilities such as testing Gamma_0(N)-equivalence etc.

This work has been done by Maite Aranes, under the supervision of John Cremona.

CC:  @sagetrac-mtaranes

Keywords: **number field modular**

Component: **modular forms**

Author: **Maite Aranes, John Cremona**

Reviewer: **Craig Citro, John Cremona**

Merged: **sage-4.3.2.alpha0**

_Issue created by migration from https://trac.sagemath.org/ticket/6863_





---

archive/issue_events_083321.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "milestone_number": null,
    "milestone_title": "sage-4.3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83321"
}
```



---

archive/issue_events_083322.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
    "label_color": "0000ff",
    "label_name": "c: modular forms",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83322"
}
```



---

archive/issue_events_083323.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83323"
}
```



---

archive/issue_events_083324.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83324"
}
```



---

archive/issue_events_083325.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83325"
}
```



---

archive/issue_events_083326.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2009-09-02T13:00:01Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "subject": "https://github.com/JohnCremona",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83326"
}
```



---

archive/issue_comments_048736.json:
```json
{
    "body": "Patch based on 4.1.1",
    "created_at": "2009-09-02T17:00:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48736",
    "user": "https://github.com/sagetrac-mtaranes"
}
```

Patch based on 4.1.1



---

archive/issue_comments_048737.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[cusps_nf.patch.gz](https://github.com/sagemath/sage/files/ticket6863/cusps_nf.patch.gz)**",
    "created_at": "2009-09-02T17:02:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48737",
    "user": "https://github.com/sagetrac-mtaranes"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[cusps_nf.patch.gz](https://github.com/sagemath/sage/files/ticket6863/cusps_nf.patch.gz)**



---

archive/issue_comments_048738.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI just checked that the patch applies fine to 4.3.alpha 1, and it does.",
    "created_at": "2009-12-10T21:29:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48738",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:2" align="right">comment:2</div>

I just checked that the patch applies fine to 4.3.alpha 1, and it does.



---

archive/issue_comments_048739.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSo this code looks **really** nice -- I'm really happy to see this functionality in Sage, and I'm very impressed with the completeness of the functionality, and the documentation/doctests.\n\nHowever, I think this code does need some purely cosmetic changes before we merge it. Here are my first thoughts:\n\n* I think that we shouldn't provide a separate \"NFCusp\" function to the user -- they should just call Cusp, which could deduce the base ring from the arguments, and take an optional `base_ring=` parameter.\n\n* For that matter, we should probably just have a `Cusp_rationals` and `Cusp_number_field` class which both inherit from a `Cusp_generic`, and unify as much of this code as possible with the existing cusps code. \n\n* Similar comments to the previous two also apply to `NFCusps`, i.e. the parent for cusps. \n\n* I really like that there are convenient functions for getting a corresponding number field element from a cusp -- however, we should probably do the extra work to make the coercion framework know about these, so that you could simply do something like `K(c)` to get a representative for the cusp. \n\n* In fact, I might go one step further and say that we shouldn't really need to add any new functions into the global namespace -- i.e. `sage/modular/all.py` shouldn't need to import anything directly, except maybe the `_clear_cache` functions. All of the things that do get imported are analogues for number fields of existing bits, which should be able to be handled transparently. As far as the `_clear_cache` stuff, maybe we could just have those be available as methods on the parents? I wouldn't mind `_Cusp_clear_cache_` or something at top-level, as long as it was prefixed with `_`. \n\nI think that's it at a first go, but it's probably enough to get started moving in the right direction. John and/or Maite, do you want to make these changes, or would you rather I do it? I won't get to it for about two weeks, but I'm happy to do it if you won't have time before then.",
    "created_at": "2010-01-17T23:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48739",
    "user": "https://github.com/craigcitro"
}
```

<div id="comment:3" align="right">comment:3</div>

So this code looks **really** nice -- I'm really happy to see this functionality in Sage, and I'm very impressed with the completeness of the functionality, and the documentation/doctests.

However, I think this code does need some purely cosmetic changes before we merge it. Here are my first thoughts:

* I think that we shouldn't provide a separate "NFCusp" function to the user -- they should just call Cusp, which could deduce the base ring from the arguments, and take an optional `base_ring=` parameter.

* For that matter, we should probably just have a `Cusp_rationals` and `Cusp_number_field` class which both inherit from a `Cusp_generic`, and unify as much of this code as possible with the existing cusps code. 

* Similar comments to the previous two also apply to `NFCusps`, i.e. the parent for cusps. 

* I really like that there are convenient functions for getting a corresponding number field element from a cusp -- however, we should probably do the extra work to make the coercion framework know about these, so that you could simply do something like `K(c)` to get a representative for the cusp. 

* In fact, I might go one step further and say that we shouldn't really need to add any new functions into the global namespace -- i.e. `sage/modular/all.py` shouldn't need to import anything directly, except maybe the `_clear_cache` functions. All of the things that do get imported are analogues for number fields of existing bits, which should be able to be handled transparently. As far as the `_clear_cache` stuff, maybe we could just have those be available as methods on the parents? I wouldn't mind `_Cusp_clear_cache_` or something at top-level, as long as it was prefixed with `_`. 

I think that's it at a first go, but it's probably enough to get started moving in the right direction. John and/or Maite, do you want to make these changes, or would you rather I do it? I won't get to it for about two weeks, but I'm happy to do it if you won't have time before then.



---

archive/issue_events_083327.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2010-01-17T23:40:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83327"
}
```



---

archive/issue_events_083328.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2010-01-17T23:40:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83328"
}
```



---

archive/issue_comments_048740.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nCraig, Thanks for your comments.  Since it's quite a long time since Maite actually wrote this I don't think we are in a hurry to start reorganising the code as you suggest.  I think that, while we realised that the best thing in the long term would be to unify code as you suggest, we did not want to do anything which made classical cusps slower, hence the parallel implementation.  So if you unify the cusps code (which I would like to see in the long run) it will be necessary to test carefully that there is no speed regression for Q-cusps.",
    "created_at": "2010-01-18T09:16:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48740",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:4" align="right">comment:4</div>

Craig, Thanks for your comments.  Since it's quite a long time since Maite actually wrote this I don't think we are in a hurry to start reorganising the code as you suggest.  I think that, while we realised that the best thing in the long term would be to unify code as you suggest, we did not want to do anything which made classical cusps slower, hence the parallel implementation.  So if you unify the cusps code (which I would like to see in the long run) it will be necessary to test carefully that there is no speed regression for Q-cusps.



---

archive/issue_events_083329.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-01-18T09:37:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83329"
}
```



---

archive/issue_events_083330.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-01-18T09:37:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83330"
}
```



---

archive/issue_comments_048741.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOn second thoughts, why don't we let this code get merged now, and make a new ticket for the refactoring?  That way this code will not languish any longer just in case we don't get around to making your suggested improvements for a while.\n\nTo assist this process I'm putting it back to \"needs review\".  Craig, you can signal your answer by either moving it back to \"needs work\" or on to \"positive review\" :)",
    "created_at": "2010-01-18T09:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48741",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:5" align="right">comment:5</div>

On second thoughts, why don't we let this code get merged now, and make a new ticket for the refactoring?  That way this code will not languish any longer just in case we don't get around to making your suggested improvements for a while.

To assist this process I'm putting it back to "needs review".  Craig, you can signal your answer by either moving it back to "needs work" or on to "positive review" :)



---

archive/issue_comments_048742.json:
```json
{
    "body": "Author: **Maite Aranes, John Cremona**",
    "created_at": "2010-01-20T20:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48742",
    "user": "https://github.com/craigcitro"
}
```

Author: **Maite Aranes, John Cremona**



---

archive/issue_comments_048743.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nYeah, that's a good point. I'd rather have this code merged and waiting on a cleanup than have it sitting and waiting for the same cleanup. I've made #8015 as a reminder to merge these two.\n\n(John, I'm listing you as a reviewer because I know you reviewed much of the content of this code as it was being developed.)",
    "created_at": "2010-01-20T20:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48743",
    "user": "https://github.com/craigcitro"
}
```

<div id="comment:6" align="right">comment:6</div>

Yeah, that's a good point. I'd rather have this code merged and waiting on a cleanup than have it sitting and waiting for the same cleanup. I've made #8015 as a reminder to merge these two.

(John, I'm listing you as a reviewer because I know you reviewed much of the content of this code as it was being developed.)



---

archive/issue_comments_048744.json:
```json
{
    "body": "Reviewer: **Craig Citro, John Cremona**",
    "created_at": "2010-01-20T20:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48744",
    "user": "https://github.com/craigcitro"
}
```

Reviewer: **Craig Citro, John Cremona**



---

archive/issue_events_083331.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2010-01-20T20:08:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83331"
}
```



---

archive/issue_events_083332.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2010-01-20T20:08:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83332"
}
```



---

archive/issue_comments_048745.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@craigcitro](#comment:6):\n> Yeah, that's a good point. I'd rather have this code merged and waiting on a cleanup than have it sitting and waiting for the same cleanup. I've made #8015 as a reminder to merge these two.\n> \n> (John, I'm listing you as a reviewer because I know you reviewed much of the content of this code as it was being developed.)\n\nThat's fair.  My involvement should be recorded somewhere, but it was Maite who did all the code writing.\n\nThanks for the review!",
    "created_at": "2010-01-20T20:28:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48745",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@craigcitro](#comment:6):
> Yeah, that's a good point. I'd rather have this code merged and waiting on a cleanup than have it sitting and waiting for the same cleanup. I've made #8015 as a reminder to merge these two.
> 
> (John, I'm listing you as a reviewer because I know you reviewed much of the content of this code as it was being developed.)

That's fair.  My involvement should be recorded somewhere, but it was Maite who did all the code writing.

Thanks for the review!



---

archive/issue_events_083333.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-01-24T02:51:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83333"
}
```



---

archive/issue_events_083334.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-01-24T02:51:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6863#event-83334"
}
```



---

archive/issue_comments_048746.json:
```json
{
    "body": "Merged: **sage-4.3.2.alpha0**",
    "created_at": "2010-01-24T02:51:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6863#issuecomment-48746",
    "user": "https://github.com/sagetrac-mvngu"
}
```

Merged: **sage-4.3.2.alpha0**
