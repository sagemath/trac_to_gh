# Issue 6255: update doc system to jsmath and improve build system (parallel doc builds)

archive/issues_006255.json:
```json
{
    "assignees": [
        "https://github.com/mwhansen"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nThis is a reminder ticket for mhansen.\n\nCC:  @mwhansen @craigcitro\n\nComponent: **documentation**\n\nKeywords: **documentation build sphinx parallel**\n\nReviewer: **Florent Hivert**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/6255_\n\n",
    "closed_at": "2013-08-13T08:41:09Z",
    "created_at": "2009-06-10T00:32:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/duplicate"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "update doc system to jsmath and improve build system (parallel doc builds)",
    "type": "issue",
    "updated_at": "2013-08-13T08:41:09Z",
    "url": "https://github.com/sagemath/sage/issues/6255",
    "user": "https://github.com/ncalexan"
}
```
<div id="comment:0"></div>

This is a reminder ticket for mhansen.

CC:  @mwhansen @craigcitro

Component: **documentation**

Keywords: **documentation build sphinx parallel**

Reviewer: **Florent Hivert**

_Issue created by migration from https://trac.sagemath.org/ticket/6255_





---

archive/issue_events_074499.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74499"
}
```



---

archive/issue_events_074500.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74500"
}
```



---

archive/issue_events_074501.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74501"
}
```



---

archive/issue_events_074502.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74502"
}
```



---

archive/issue_events_074503.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74503"
}
```



---

archive/issue_events_074504.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-06-10T00:32:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74504"
}
```



---

archive/issue_events_074505.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-06-10T00:36:07Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "title_is": "update doc system to jsmath and improve build system (parallel doc builds)",
    "title_was": "update doc system to latex sphinx and improve build system",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74505"
}
```



---

archive/issue_events_074506.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-06-10T00:36:07Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "subject": "https://github.com/mwhansen",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74506"
}
```



---

archive/issue_comments_041525.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nPlease see #6495 for a tentative approach to parallel doc builds",
    "created_at": "2009-11-29T20:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41525",
    "user": "https://github.com/qed777"
}
```

<div id="comment:3" align="right">comment:3</div>

Please see #6495 for a tentative approach to parallel doc builds



---

archive/issue_comments_041526.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI made an attempt to have parallel doc build. It seems that I have it for the **write** part of the doc generation process. Here is the diff\n\n```diff\ndiff --git a/builders/__init__.py b/builders/__init__.py\n--- a/builders/__init__.py\n+++ b/builders/__init__.py\n@@ -286,14 +286,27 @@ class Builder(object):\n         # write target files\n         warnings = []\n         self.env.set_warnfunc(lambda *args: warnings.append(args))\n+        #for docname in self.status_iterator(\n+        #    sorted(docnames), 'writing output... ', darkgreen, len(docnames)):\n+        #    doctree = self.env.get_and_resolve_doctree(docname, self)\n+        #    self.write_doc(docname, doctree)\n+        from sage.parallel.decorate import parallel\n+        import itertools\n+        worker = parallel('fork')(self.write_doc_parallel_worker)\n+        pariter = itertools.imap(lambda x:x[1], worker(sorted(docnames)))\n         for docname in self.status_iterator(\n-            sorted(docnames), 'writing output... ', darkgreen, len(docnames)):\n-            doctree = self.env.get_and_resolve_doctree(docname, self)\n-            self.write_doc(docname, doctree)\n+            pariter, 'writing output... ', darkgreen, len(docnames)):\n+            # done in the iterator !!!\n+            pass\n         for warning in warnings:\n             self.warn(*warning)\n         self.env.set_warnfunc(self.warn)\n \n+    def write_doc_parallel_worker(self, docname):\n+        doctree = self.env.get_and_resolve_doctree(docname, self)\n+        self.write_doc(docname, doctree)\n+        return docname\n+\n     def prepare_writing(self, docnames):\n         raise NotImplementedError\n``` \n\nThe read part could be more tricky but it doesn't seems unfeasible. Note that I may be dreaming here.",
    "created_at": "2012-04-20T22:16:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41526",
    "user": "https://github.com/hivert"
}
```

<div id="comment:4" align="right">comment:4</div>

I made an attempt to have parallel doc build. It seems that I have it for the **write** part of the doc generation process. Here is the diff

```diff
diff --git a/builders/__init__.py b/builders/__init__.py
--- a/builders/__init__.py
+++ b/builders/__init__.py
@@ -286,14 +286,27 @@ class Builder(object):
         # write target files
         warnings = []
         self.env.set_warnfunc(lambda *args: warnings.append(args))
+        #for docname in self.status_iterator(
+        #    sorted(docnames), 'writing output... ', darkgreen, len(docnames)):
+        #    doctree = self.env.get_and_resolve_doctree(docname, self)
+        #    self.write_doc(docname, doctree)
+        from sage.parallel.decorate import parallel
+        import itertools
+        worker = parallel('fork')(self.write_doc_parallel_worker)
+        pariter = itertools.imap(lambda x:x[1], worker(sorted(docnames)))
         for docname in self.status_iterator(
-            sorted(docnames), 'writing output... ', darkgreen, len(docnames)):
-            doctree = self.env.get_and_resolve_doctree(docname, self)
-            self.write_doc(docname, doctree)
+            pariter, 'writing output... ', darkgreen, len(docnames)):
+            # done in the iterator !!!
+            pass
         for warning in warnings:
             self.warn(*warning)
         self.env.set_warnfunc(self.warn)
 
+    def write_doc_parallel_worker(self, docname):
+        doctree = self.env.get_and_resolve_doctree(docname, self)
+        self.write_doc(docname, doctree)
+        return docname
+
     def prepare_writing(self, docnames):
         raise NotImplementedError
``` 

The read part could be more tricky but it doesn't seems unfeasible. Note that I may be dreaming here.



---

archive/issue_comments_041527.json:
```json
{
    "body": "Experimental timing patch",
    "created_at": "2012-04-21T15:59:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41527",
    "user": "https://github.com/hivert"
}
```

Experimental timing patch



---

archive/issue_comments_041528.json:
```json
{
    "body": "Attachment: **[timing.patch.gz](https://github.com/sagemath/sage/files/ticket6255/timing.patch.gz)**\n\nExperimental parallel doc output patch",
    "created_at": "2012-04-21T16:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41528",
    "user": "https://github.com/hivert"
}
```

Attachment: **[timing.patch.gz](https://github.com/sagemath/sage/files/ticket6255/timing.patch.gz)**

Experimental parallel doc output patch



---

archive/issue_comments_041529.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAttachment: **[paral.patch.gz](https://github.com/sagemath/sage/files/ticket6255/paral.patch.gz)**\n\nHi there,\n\nI just attached two patches. They need to be applied in\n\n```\n$SAGE_ROOT/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/\n```\n(I didn't regenerate a spkg yet). Those two packages are very experimental and\nthey certainly break a lot of things. The goal of `timing.patch` is to\nimprove Sphinx timning and progress report. The second one uses\n`@parallel` to parallelize the writing part of the doc generation. This is\nvery raw and could certainly be optimized using Pool, Queue and the\nlike. Still the improvement is allready here:\nOn a intel i7 8 multithreaded core:\n- serie:\n\n```\nreading sources...  Elapsed time = 385.334967136\nwriting output...  Elapsed time = 1903.10733795\n```\n- parallel:\n\n```\nreading sources...  Elapsed time = 418.675282001\nwriting output...  Elapsed time = 253.907614946\n```\nOn a 24 core server:\n- serie:\n\n```\nreading sources...  Elapsed time = 243.982397079\nwriting output...  Elapsed time = 1366.98643208\n```\n- parallel:\n\n```\nreading sources...  Elapsed time = 243.729380131\nwriting output...  Elapsed time = 176.76424408\n```\n\nFlorent",
    "created_at": "2012-04-21T16:09:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41529",
    "user": "https://github.com/hivert"
}
```

<div id="comment:5" align="right">comment:5</div>

Attachment: **[paral.patch.gz](https://github.com/sagemath/sage/files/ticket6255/paral.patch.gz)**

Hi there,

I just attached two patches. They need to be applied in

```
$SAGE_ROOT/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/
```
(I didn't regenerate a spkg yet). Those two packages are very experimental and
they certainly break a lot of things. The goal of `timing.patch` is to
improve Sphinx timning and progress report. The second one uses
`@parallel` to parallelize the writing part of the doc generation. This is
very raw and could certainly be optimized using Pool, Queue and the
like. Still the improvement is allready here:
On a intel i7 8 multithreaded core:
- serie:

```
reading sources...  Elapsed time = 385.334967136
writing output...  Elapsed time = 1903.10733795
```
- parallel:

```
reading sources...  Elapsed time = 418.675282001
writing output...  Elapsed time = 253.907614946
```
On a 24 core server:
- serie:

```
reading sources...  Elapsed time = 243.982397079
writing output...  Elapsed time = 1366.98643208
```
- parallel:

```
reading sources...  Elapsed time = 243.729380131
writing output...  Elapsed time = 176.76424408
```

Florent



---

archive/issue_comments_041530.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWith a little tunning I managed to have\n\n```\nserie    writing output...  Elapsed time = 1366.98643208\nparallel writing output...  Elapsed time = 106.421586037\n```\nLooks efficient !",
    "created_at": "2012-04-21T20:40:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41530",
    "user": "https://github.com/hivert"
}
```

<div id="comment:6" align="right">comment:6</div>

With a little tunning I managed to have

```
serie    writing output...  Elapsed time = 1366.98643208
parallel writing output...  Elapsed time = 106.421586037
```
Looks efficient !



---

archive/issue_comments_041531.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThis should be closed as a duplicate for #6495.",
    "created_at": "2013-06-28T22:04:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41531",
    "user": "https://github.com/hivert"
}
```

<div id="comment:7" align="right">comment:7</div>

This should be closed as a duplicate for #6495.



---

archive/issue_events_074507.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2013-06-28T22:04:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74507"
}
```



---

archive/issue_events_074508.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2013-06-28T22:05:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74508"
}
```



---

archive/issue_events_074509.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2013-06-28T22:05:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74509"
}
```



---

archive/issue_comments_041532.json:
```json
{
    "body": "Reviewer: **Florent Hivert**",
    "created_at": "2013-06-28T22:05:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6255#issuecomment-41532",
    "user": "https://github.com/hivert"
}
```

Reviewer: **Florent Hivert**



---

archive/issue_events_074510.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-21T21:05:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74510"
}
```



---

archive/issue_events_074511.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T08:41:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74511"
}
```



---

archive/issue_events_074512.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T08:41:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74512"
}
```



---

archive/issue_events_074513.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T08:41:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74513"
}
```



---

archive/issue_events_074514.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T08:41:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6255",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6255#event-74514"
}
```
