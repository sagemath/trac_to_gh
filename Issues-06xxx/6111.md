# Issue 6111: [with patch; positive review] review symbolics in sage-4.0 (switch to pynac)

archive/issues_006111.json:
```json
{
    "body": "Get sage-4.0.rc0 from \n\nhttp://sage.math.washington.edu/home/wstein/build/sage-4.0.rc0/dist/\n\nwhich is stable and has all the new symbolics code in it. \n\nYou can also do:\n\n./sage -upgrade http://sage.math.washington.edu/home/wstein/build/sage-4.0.rc0/\n\nNote that the code for symbolics is one big flattened patch.  The only way to referee it is is to read straight through all of devel/sage/sage/symbolics, devel/sage/sage/calculus, and also look at the diff outside of those two directories at the patch to see what else was changed. \n\n\n\nAssignee: @mwhansen\n\nCC:  @mwhansen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/6111\n\n",
    "closed_at": "2009-05-28T06:41:30Z",
    "created_at": "2009-05-21T09:44:00Z",
    "labels": [
        "component: calculus",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.0",
    "title": "[with patch; positive review] review symbolics in sage-4.0 (switch to pynac)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/6111",
    "user": "https://github.com/williamstein"
}
```
Get sage-4.0.rc0 from 

http://sage.math.washington.edu/home/wstein/build/sage-4.0.rc0/dist/

which is stable and has all the new symbolics code in it. 

You can also do:

./sage -upgrade http://sage.math.washington.edu/home/wstein/build/sage-4.0.rc0/

Note that the code for symbolics is one big flattened patch.  The only way to referee it is is to read straight through all of devel/sage/sage/symbolics, devel/sage/sage/calculus, and also look at the diff outside of those two directories at the patch to see what else was changed. 



Assignee: @mwhansen

CC:  @mwhansen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/6111





---

archive/issue_comments_054070.json:
```json
{
    "body": "<a id='comment:1'></a>TODO: This doctest in infinity.py was commented out.  When uncommented we get a total hang:\n\n```\n            sage: bool(SR(oo) == sympy.oo)\n```\n\nThis is what we get:\n\n```\nsage:             sage: bool(SR(oo) == sympy.oo)\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  indeterminate expression: Infinity - Infinity encountered.\n\n\n^V^C^C^C^C^C^C^Z\n```\n\nI'm uncomenting this in my referee patch.",
    "created_at": "2009-05-21T21:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54070",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>TODO: This doctest in infinity.py was commented out.  When uncommented we get a total hang:

```
            sage: bool(SR(oo) == sympy.oo)
```

This is what we get:

```
sage:             sage: bool(SR(oo) == sympy.oo)
terminate called after throwing an instance of 'std::runtime_error'
  what():  indeterminate expression: Infinity - Infinity encountered.


^V^C^C^C^C^C^C^Z
```

I'm uncomenting this in my referee patch.



---

archive/issue_comments_054071.json:
```json
{
    "body": "<a id='comment:2'></a>I read through the first 2500 lines of expression.pyx earlier today, and it's looking good so far (collecting minor fixes into a patch). I won't be looking at it again until much later tonight.",
    "created_at": "2009-05-22T02:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54071",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:2'></a>I read through the first 2500 lines of expression.pyx earlier today, and it's looking good so far (collecting minor fixes into a patch). I won't be looking at it again until much later tonight.



---

archive/issue_comments_054072.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [6111-expression-referee.patch](tarball://root/attachments/some-uuid/ticket6111/6111-expression-referee.patch) by @robertwb created at 2009-05-23 07:06:21\n\nFinished reading expression.pyx, it looks good. Should this work:\n\n```\nsage: ((x+y)^9).polynomial(None, ring=ZZ['x']['y']).list()\n------------------------------------------------------------\nTraceback (most recent call last):\n  File \"<ipython console>\", line 1, in <module>\n  File \"expression.pyx\", line 3616, in sage.symbolic.expression.Expression.polynomial (sage/symbolic/expression.cpp:17320)\n  File \"/home/robertwb/sage-4.0.rc0-x86_64-Linux/local/lib/python2.5/site-packages/sage/symbolic/expression_conversions.py\", line 975, in polynomial\n    converter = PolynomialConverter(ex, base_ring=base_ring, ring=ring)\n  File \"/home/robertwb/sage-4.0.rc0-x86_64-Linux/local/lib/python2.5/site-packages/sage/symbolic/expression_conversions.py\", line 833, in __init__\n    raise TypeError, \"%s is not a variable of %s\" %(v, ring)\nTypeError: y is not a variable of Univariate Polynomial Ring in y over Univariate Polynomial Ring in x over Integer Ring\n```\n\nAlso, there are a lot (too many IMHO) aliases for simplify_radical\n\n```\n    radical_simplify = simplify_log = log_simplify = simplify_radical\n    simplify_exp = exp_simplify = simplify_radical\n```",
    "created_at": "2009-05-23T07:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54072",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:3'></a>Attachment [6111-expression-referee.patch](tarball://root/attachments/some-uuid/ticket6111/6111-expression-referee.patch) by @robertwb created at 2009-05-23 07:06:21

Finished reading expression.pyx, it looks good. Should this work:

```
sage: ((x+y)^9).polynomial(None, ring=ZZ['x']['y']).list()
------------------------------------------------------------
Traceback (most recent call last):
  File "<ipython console>", line 1, in <module>
  File "expression.pyx", line 3616, in sage.symbolic.expression.Expression.polynomial (sage/symbolic/expression.cpp:17320)
  File "/home/robertwb/sage-4.0.rc0-x86_64-Linux/local/lib/python2.5/site-packages/sage/symbolic/expression_conversions.py", line 975, in polynomial
    converter = PolynomialConverter(ex, base_ring=base_ring, ring=ring)
  File "/home/robertwb/sage-4.0.rc0-x86_64-Linux/local/lib/python2.5/site-packages/sage/symbolic/expression_conversions.py", line 833, in __init__
    raise TypeError, "%s is not a variable of %s" %(v, ring)
TypeError: y is not a variable of Univariate Polynomial Ring in y over Univariate Polynomial Ring in x over Integer Ring
```

Also, there are a lot (too many IMHO) aliases for simplify_radical

```
    radical_simplify = simplify_log = log_simplify = simplify_radical
    simplify_exp = exp_simplify = simplify_radical
```



---

archive/issue_comments_054073.json:
```json
{
    "body": "<a id='comment:5'></a>Some comments after reading the changesets to pynac after the unreleased 0.1.6 version (numbers next to the bullets refer to changesets in the repository from the pynac-0.1.7.spkg file):\n\n\n* 90:fb6582f9bd81 \n\n isn't this already handled by the first lines of pyExpression_to_ex() in pynac.pyx?\n* 88:25d02eeb427d \n\n we should add error checking to py_get_constant() call, we can't guarantee that a constant with the same name will be available between different versions of Sage\n* 84:7b3272f4b4bf  is mine, author field lists Mike\n* 82:da7d7a220723  evalf for constants using a lookup table\n\n I already commented on this on IRC and the devel list. ginac/pynac already provides a framework to handle this, I would like to revert this in a future version. My previous message:\n http://groups.google.com/group/sage-devel/msg/dc46d9d94dd31b5e (scroll to the paragraph below the bullet items)\n\nI will try to prepare a new package which fixes the version numbers of the library and error handling of py_get_constant().",
    "created_at": "2009-05-24T15:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54073",
    "user": "https://github.com/burcin"
}
```

<a id='comment:5'></a>Some comments after reading the changesets to pynac after the unreleased 0.1.6 version (numbers next to the bullets refer to changesets in the repository from the pynac-0.1.7.spkg file):


* 90:fb6582f9bd81 

 isn't this already handled by the first lines of pyExpression_to_ex() in pynac.pyx?
* 88:25d02eeb427d 

 we should add error checking to py_get_constant() call, we can't guarantee that a constant with the same name will be available between different versions of Sage
* 84:7b3272f4b4bf  is mine, author field lists Mike
* 82:da7d7a220723  evalf for constants using a lookup table

 I already commented on this on IRC and the devel list. ginac/pynac already provides a framework to handle this, I would like to revert this in a future version. My previous message:
 http://groups.google.com/group/sage-devel/msg/dc46d9d94dd31b5e (scroll to the paragraph below the bullet items)

I will try to prepare a new package which fixes the version numbers of the library and error handling of py_get_constant().



---

archive/issue_comments_054074.json:
```json
{
    "body": "<a id='comment:6'></a>New package which adds error handling for py_get_constant() and changes the library version to 0.1.7 is here:\n\nhttp://sage.math.washington.edu/home/burcin/pynac/pynac-0.1.7-r1.spkg\n\nChanging the version numbers of the library might expose some modules in the Sage library which should be rebuilt when the package is updated. The fix is to add a dependency to the pynac header in module_list.py. I didn't try to see which files need this, since my tree wasn't clean and all the relevant files (sage/symbolic/* is more than enough) got rebuilt for me.\n\nAnswering my own comments above, I see that the patch I sent Mike for changeset 84 didn't have hg headers, and returning None from eval or derivative methods is a good trick to halt the evaluation. The evalf function for constants is still as it is, I don't think it's a good idea to introduce big changes at this stage.\n\nThanks everyone for all the work to make the switch, I still can't believe we're almost there.\n\nCheers,\n\nBurcin",
    "created_at": "2009-05-24T19:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54074",
    "user": "https://github.com/burcin"
}
```

<a id='comment:6'></a>New package which adds error handling for py_get_constant() and changes the library version to 0.1.7 is here:

http://sage.math.washington.edu/home/burcin/pynac/pynac-0.1.7-r1.spkg

Changing the version numbers of the library might expose some modules in the Sage library which should be rebuilt when the package is updated. The fix is to add a dependency to the pynac header in module_list.py. I didn't try to see which files need this, since my tree wasn't clean and all the relevant files (sage/symbolic/* is more than enough) got rebuilt for me.

Answering my own comments above, I see that the patch I sent Mike for changeset 84 didn't have hg headers, and returning None from eval or derivative methods is a good trick to halt the evaluation. The evalf function for constants is still as it is, I don't think it's a good idea to introduce big changes at this stage.

Thanks everyone for all the work to make the switch, I still can't believe we're almost there.

Cheers,

Burcin



---

archive/issue_comments_054075.json:
```json
{
    "body": "<a id='comment:7'></a>Attachment [trac6111-reviewer-cwitty.patch](tarball://root/attachments/some-uuid/ticket6111/trac6111-reviewer-cwitty.patch) by cwitty created at 2009-05-24 22:13:33\n\nI like it!  I quickly read through all of sage/symbolic except for expression.pyx, and attached a patch fixing the issues I found.  Technically somebody else should review sage/symbolic/random_tests.py, since I wrote the original version; but if you do, be sure to review rc0+my reviewer patch, since the reviewer patch adds doctests.\n\nSo: positive review for sage/symbolic/* except for expression.pyx (which I didn't look at) and random_tests.py (which I can't review since I wrote it).",
    "created_at": "2009-05-24T22:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54075",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:7'></a>Attachment [trac6111-reviewer-cwitty.patch](tarball://root/attachments/some-uuid/ticket6111/trac6111-reviewer-cwitty.patch) by cwitty created at 2009-05-24 22:13:33

I like it!  I quickly read through all of sage/symbolic except for expression.pyx, and attached a patch fixing the issues I found.  Technically somebody else should review sage/symbolic/random_tests.py, since I wrote the original version; but if you do, be sure to review rc0+my reviewer patch, since the reviewer patch adds doctests.

So: positive review for sage/symbolic/* except for expression.pyx (which I didn't look at) and random_tests.py (which I can't review since I wrote it).



---

archive/issue_comments_054076.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_6111-stein_referee.patch](tarball://root/attachments/some-uuid/ticket6111/trac_6111-stein_referee.patch) by @williamstein created at 2009-05-25 04:28:55\n\nI read through most everything outside of symbolics/ and made a few little touchups in my attached patch.  Positive review for this part as well.",
    "created_at": "2009-05-25T04:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54076",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>Attachment [trac_6111-stein_referee.patch](tarball://root/attachments/some-uuid/ticket6111/trac_6111-stein_referee.patch) by @williamstein created at 2009-05-25 04:28:55

I read through most everything outside of symbolics/ and made a few little touchups in my attached patch.  Positive review for this part as well.



---

archive/issue_comments_054077.json:
```json
{
    "body": "Attachment [trac_6111-sympy_oo.patch](tarball://root/attachments/some-uuid/ticket6111/trac_6111-sympy_oo.patch) by @mwhansen created at 2009-05-28 02:41:40",
    "created_at": "2009-05-28T02:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54077",
    "user": "https://github.com/mwhansen"
}
```

Attachment [trac_6111-sympy_oo.patch](tarball://root/attachments/some-uuid/ticket6111/trac_6111-sympy_oo.patch) by @mwhansen created at 2009-05-28 02:41:40



---

archive/issue_comments_054078.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2009-05-28T02:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54078",
    "user": "https://github.com/mwhansen"
}
```

Changing status from new to assigned.



---

archive/issue_comments_054079.json:
```json
{
    "body": "<a id='comment:9'></a>I looked over the first three patches, and they look good to me.\n\nI added a fourth patch which fixes a segfault that wstein's patch uncovers.",
    "created_at": "2009-05-28T02:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54079",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:9'></a>I looked over the first three patches, and they look good to me.

I added a fourth patch which fixes a segfault that wstein's patch uncovers.



---

archive/issue_comments_054080.json:
```json
{
    "body": "Changing assignee from @burcin to @mwhansen.",
    "created_at": "2009-05-28T02:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54080",
    "user": "https://github.com/mwhansen"
}
```

Changing assignee from @burcin to @mwhansen.



---

archive/issue_comments_054081.json:
```json
{
    "body": "<a id='comment:10'></a>Regarding, `sage: ((x+y)^9).polynomial(None, ring=ZZ['x']['y']).list()` --> boom, none of the above patches address this.  However, this ring option didn't even exist in sage < 4.0, so I'm not going to hold this ticket up for this.",
    "created_at": "2009-05-28T06:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54081",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>Regarding, `sage: ((x+y)^9).polynomial(None, ring=ZZ['x']['y']).list()` --> boom, none of the above patches address this.  However, this ring option didn't even exist in sage < 4.0, so I'm not going to hold this ticket up for this.



---

archive/issue_comments_054082.json:
```json
{
    "body": "<a id='comment:11'></a>Merged in 4.0.rc1.",
    "created_at": "2009-05-28T06:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54082",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:11'></a>Merged in 4.0.rc1.



---

archive/issue_events_014385.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-05-28T06:41:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6111#event-14385"
}
```



---

archive/issue_comments_054083.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-05-28T06:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6111#issuecomment-54083",
    "user": "https://github.com/mwhansen"
}
```

Resolution: fixed
