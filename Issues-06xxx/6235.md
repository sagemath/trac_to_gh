# Issue 6235: set MPLCONFIGDIR environment variable when Sage starts up

archive/issues_006235.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-cwitty"
    ],
    "body": "<div id=\"comment:0\"></div>\n\n\n\nCC:  @nexttime @qed777 @RalphieBoy\n\nComponent: **misc**\n\nAuthor: **John Palmieri**\n\nReviewer: **Leif Leonhardy**\n\nMerged: **sage-4.6.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/6235_\n\n",
    "closed_at": "2010-10-21T10:07:34Z",
    "created_at": "2009-06-06T19:45:56Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "set MPLCONFIGDIR environment variable when Sage starts up",
    "type": "issue",
    "updated_at": "2010-10-23T18:35:40Z",
    "url": "https://github.com/sagemath/sage/issues/6235",
    "user": "https://github.com/williamstein"
}
```
<div id="comment:0"></div>



CC:  @nexttime @qed777 @RalphieBoy

Component: **misc**

Author: **John Palmieri**

Reviewer: **Leif Leonhardy**

Merged: **sage-4.6.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/6235_





---

archive/issue_events_074260.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-06-06T19:45:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "milestone_number": null,
    "milestone_title": "sage-4.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74260"
}
```



---

archive/issue_events_074261.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-06-06T19:45:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74261"
}
```



---

archive/issue_events_074262.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-06-06T19:45:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74262"
}
```



---

archive/issue_events_074263.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-06-06T19:45:56Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "subject": "https://github.com/williamstein",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74263"
}
```



---

archive/issue_comments_041315.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\n\n```\n\n\n2009/6/6 Brian Granger <>:\n>\n>> I want to reopen this thread.\n>\n> Great!  matplotlib under Sage is still broken for me because of this\n> issue - I would love to see this resolved.\n>\n>> I have a build farm with many (nearly 20) different OS's that all build and test\n>> Sage in parallel.  My home directory on each of those machines is NFS exported\n>> and shared.  I sometimes have tests fail because all these different\n>> Sage's are trying to write to the same $HOME/.matplotlib directory\n>> (for temp files, configuration, etc.).\n>> For Sage itself, I set SAGE_HOME to a fast local scratch disk (on each\n>> machine), which completely solves any contention problems for\n>> *everything* related to Sage temp files, configuration, etc., with the\n>> notable exception of matplotlib.\n>\n> I hadn't thought of this issue, but it is another good reason to not\n> use $HOME/.matplotlib for the Sage matplotlib.\n>\n>> Thus I would also prefer it if\n>> Sage's matplotlib directory were under SAGE_HOME instead of it being\n>> the default $HOME/.matplotlib.\n>>\n>> Thoughts?\n>\n> I think the simplest solution is to have Sage set:\n>\n> export MPLCONFIGDIR=$SAGE_HOME/matplotlib\n>\n> But, wait, does SAGE_HOME point to $HOME/.sage by default?  That is\n> the right place for this, I just don't remember exactly where\n> SAGE_HOME points.\n\nYep, it does.  We can make sure easily enough by running Sage and asking:\n\nsage: DOT_SAGE\n'/Users/wstein/.sage/'\n\nBy the way, I just realized it is called \"DOT_SAGE\", not \"SAGE_HOME\".\n\nThis is now:\n\nhttps://github.com/sagemath/sage/issues/6235\n\n -- William\n\n\n>\n> I don't even think we need to put a default matplotlibrc file there,\n> so we don't have to worry about it becoming out of date.  If people\n> want to add their own matplotlibrc file to this directory they can,\n> but the default will be that matplotlib works.\n>\n> Cheers,\n>\n> Brian\n>\n>> William\n>>\n>>\n>>>> In the mailing list thread, the option was brought up to have the user\n>>>> put in a command in their init.sage file if they wanted a custom Sage\n>>>> initialization for matplotlib.  Setting the MATPLOTLIBRC variable in the\n>>>> init.sage file should work, I think.\n>>>\n>>> Yes, but I don't see this file in my .sage directory.  Where would it be?\n>>>\n>>>> In reality, (I think) the people this affects are the people that have\n>>>> already customized their system install of matplotlib.  Those are the\n>>>> people that (I think) would be capable of writing another command in\n>>>> their init.sage or something to have Sage have a custom matplotlibrc file.\n>>>\n>>> Yes, for the most part I agree with this.  But it is not quite that\n>>> simple.  I still need/want to be able to configure matplotlib for Sage\n>>> and my own install separately.  That means I have to copy my own\n>>> matplotlibrc file into .sage, make edits and set variables in\n>>> init.sage.\n>>>\n>>>> On the other hand, I can see the nice thing about Sage being totally\n>>>> self-contained and not pulling settings from a user's home directory for\n>>>> options.\n>>>\n>>> Yes, I think Sage should \"Just Work\", even for users that have\n>>> matplotlib installed previously.  This is simple enough to fix, I\n>>> don't see why we wouldn't.  The only thing is that the matplotlibrc\n>>> file needs to be updated anytime that matplotlib itself is updated.\n>>>\n>>> Cheers,\n>>>\n>>> Brian\n>>>\n>>> >\n>>>\n>>\n>>\n>>\n\n```",
    "created_at": "2009-06-06T19:47:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41315",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:1" align="right">comment:1</div>


```


2009/6/6 Brian Granger <>:
>
>> I want to reopen this thread.
>
> Great!  matplotlib under Sage is still broken for me because of this
> issue - I would love to see this resolved.
>
>> I have a build farm with many (nearly 20) different OS's that all build and test
>> Sage in parallel.  My home directory on each of those machines is NFS exported
>> and shared.  I sometimes have tests fail because all these different
>> Sage's are trying to write to the same $HOME/.matplotlib directory
>> (for temp files, configuration, etc.).
>> For Sage itself, I set SAGE_HOME to a fast local scratch disk (on each
>> machine), which completely solves any contention problems for
>> *everything* related to Sage temp files, configuration, etc., with the
>> notable exception of matplotlib.
>
> I hadn't thought of this issue, but it is another good reason to not
> use $HOME/.matplotlib for the Sage matplotlib.
>
>> Thus I would also prefer it if
>> Sage's matplotlib directory were under SAGE_HOME instead of it being
>> the default $HOME/.matplotlib.
>>
>> Thoughts?
>
> I think the simplest solution is to have Sage set:
>
> export MPLCONFIGDIR=$SAGE_HOME/matplotlib
>
> But, wait, does SAGE_HOME point to $HOME/.sage by default?  That is
> the right place for this, I just don't remember exactly where
> SAGE_HOME points.

Yep, it does.  We can make sure easily enough by running Sage and asking:

sage: DOT_SAGE
'/Users/wstein/.sage/'

By the way, I just realized it is called "DOT_SAGE", not "SAGE_HOME".

This is now:

https://github.com/sagemath/sage/issues/6235

 -- William


>
> I don't even think we need to put a default matplotlibrc file there,
> so we don't have to worry about it becoming out of date.  If people
> want to add their own matplotlibrc file to this directory they can,
> but the default will be that matplotlib works.
>
> Cheers,
>
> Brian
>
>> William
>>
>>
>>>> In the mailing list thread, the option was brought up to have the user
>>>> put in a command in their init.sage file if they wanted a custom Sage
>>>> initialization for matplotlib.  Setting the MATPLOTLIBRC variable in the
>>>> init.sage file should work, I think.
>>>
>>> Yes, but I don't see this file in my .sage directory.  Where would it be?
>>>
>>>> In reality, (I think) the people this affects are the people that have
>>>> already customized their system install of matplotlib.  Those are the
>>>> people that (I think) would be capable of writing another command in
>>>> their init.sage or something to have Sage have a custom matplotlibrc file.
>>>
>>> Yes, for the most part I agree with this.  But it is not quite that
>>> simple.  I still need/want to be able to configure matplotlib for Sage
>>> and my own install separately.  That means I have to copy my own
>>> matplotlibrc file into .sage, make edits and set variables in
>>> init.sage.
>>>
>>>> On the other hand, I can see the nice thing about Sage being totally
>>>> self-contained and not pulling settings from a user's home directory for
>>>> options.
>>>
>>> Yes, I think Sage should "Just Work", even for users that have
>>> matplotlib installed previously.  This is simple enough to fix, I
>>> don't see why we wouldn't.  The only thing is that the matplotlibrc
>>> file needs to be updated anytime that matplotlib itself is updated.
>>>
>>> Cheers,
>>>
>>> Brian
>>>
>>> >
>>>
>>
>>
>>

```



---

archive/issue_comments_041316.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nDiscussion: http://www.mail-archive.com/sage-devel@googlegroups.com/msg23608.html",
    "created_at": "2010-09-30T04:51:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41316",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:2" align="right">comment:2</div>

Discussion: http://www.mail-archive.com/sage-devel@googlegroups.com/msg23608.html



---

archive/issue_comments_041317.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nProblems are cropping up at #9122 dealing with configuration files and font caches, etc.  Any comment on setting MPLCONFIGDIR to be something inside of the Sage hierarchy, maybe SAGE_LOCAL/etc/matplotlib?  For example, the font caches should point to the matplotlib directory in the current Sage being run, but this would not happen usually with multiple Sage instances laying around (or a system matplotlib install) and a global MPLCONFIGDIR (even if that global directory was in the .sage directory).",
    "created_at": "2010-09-30T13:17:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41317",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:3" align="right">comment:3</div>

Problems are cropping up at #9122 dealing with configuration files and font caches, etc.  Any comment on setting MPLCONFIGDIR to be something inside of the Sage hierarchy, maybe SAGE_LOCAL/etc/matplotlib?  For example, the font caches should point to the matplotlib directory in the current Sage being run, but this would not happen usually with multiple Sage instances laying around (or a system matplotlib install) and a global MPLCONFIGDIR (even if that global directory was in the .sage directory).



---

archive/issue_comments_041318.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well.  The issue on this ticket still stands, but it is not urgent for #9221 anymore.",
    "created_at": "2010-10-20T13:21:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41318",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:5" align="right">comment:5</div>

The problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well.  The issue on this ticket still stands, but it is not urgent for #9221 anymore.



---

archive/issue_comments_041319.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jasongrout](#comment%3A5):\n> The problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well.  The issue on this ticket still stands, but it is not urgent for #9221 anymore.\n\nI just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...\n\n(And especially made testing #9896 totally useless. :( )",
    "created_at": "2010-10-20T13:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41319",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jasongrout](#comment%3A5):
> The problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well.  The issue on this ticket still stands, but it is not urgent for #9221 anymore.

I just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...

(And especially made testing #9896 totally useless. :( )



---

archive/issue_comments_041320.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@nexttime](#comment%3A6):\n\n\n> I just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...\n\nCan you elaborate?  What do you mean \"due to `~/.matplotlib/`\"?",
    "created_at": "2010-10-20T13:34:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41320",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@nexttime](#comment%3A6):


> I just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...

Can you elaborate?  What do you mean "due to `~/.matplotlib/`"?



---

archive/issue_comments_041321.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@jasongrout](#comment%3A7):\n> Replying to [@nexttime](#comment%3A6):\n> \n> \n> > I just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...\n> \n> \n> Can you elaborate?  What do you mean \"due to `~/.matplotlib/`\"?\n\nWithout deleting `~/.matplotlib/`, I get the doctest errors in `sage/plot/` mentioned [here](https://github.com/sagemath/sage/issues/9896#comment:128).\n\nAlso, I did get compilation errors related to freetype [like you reported](https://github.com/sagemath/sage/issues/9221#comment:24).",
    "created_at": "2010-10-20T13:49:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41321",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@jasongrout](#comment%3A7):
> Replying to [@nexttime](#comment%3A6):
> 
> 
> > I just noticed that *some* (I don't know yet which, i.e. the one from alpha2 or alpha3) matplotlib 1.0.0 spkg broke **all** previous Sage installations, due to `~/.matplotlib/`...
> 
> 
> Can you elaborate?  What do you mean "due to `~/.matplotlib/`"?

Without deleting `~/.matplotlib/`, I get the doctest errors in `sage/plot/` mentioned [here](https://github.com/sagemath/sage/issues/9896#comment:128).

Also, I did get compilation errors related to freetype [like you reported](https://github.com/sagemath/sage/issues/9221#comment:24).



---

archive/issue_comments_041322.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@nexttime](#comment%3A8):\n> Also, I did get compilation errors related to freetype [like you reported](https://github.com/sagemath/sage/issues/9221#comment:24).\n\n(Even rebuilding Sage 4.5.3 from scratch failed.)",
    "created_at": "2010-10-20T13:51:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41322",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@nexttime](#comment%3A8):
> Also, I did get compilation errors related to freetype [like you reported](https://github.com/sagemath/sage/issues/9221#comment:24).

(Even rebuilding Sage 4.5.3 from scratch failed.)



---

archive/issue_comments_041323.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nCan we just do\n\n```\nMPLCONFIGDIR=\"$DOT_SAGE/matplotlib\"\nexport MPLCONFIGDIR\n```\nin sage-env?  I suppose we could add yet another environment variable, like SAGE_MPLCONFIGDIR, and do\n\n```\nif [ \"$SAGE_MPLCONFIGDIR\" = \"\" ]; then\n    MPLCONFIGDIR=$DOT_SAGE/matplotlib\nelse\n    MPLCONFIGDIR=$SAGE_MPLCONFIGDIR\nfi\nexport MPLCONFIGDIR\n```\nbut I don't think that's necessary.  We already have too many environment variables.  I suppose we could test whether MPLCONFIGDIR is set, and if so, print a warning (once) that Sage is not using the user's setting of this variable.  I'm not sure where to test this, though.\n\nIf we export our setting for MPLCONFIGDIR, then we also need to document it, probably in the installation guide, saying that Sage uses its own matplotlib config directory, not the default one or whatever the user may have set.",
    "created_at": "2010-10-20T20:20:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41323",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Can we just do

```
MPLCONFIGDIR="$DOT_SAGE/matplotlib"
export MPLCONFIGDIR
```
in sage-env?  I suppose we could add yet another environment variable, like SAGE_MPLCONFIGDIR, and do

```
if [ "$SAGE_MPLCONFIGDIR" = "" ]; then
    MPLCONFIGDIR=$DOT_SAGE/matplotlib
else
    MPLCONFIGDIR=$SAGE_MPLCONFIGDIR
fi
export MPLCONFIGDIR
```
but I don't think that's necessary.  We already have too many environment variables.  I suppose we could test whether MPLCONFIGDIR is set, and if so, print a warning (once) that Sage is not using the user's setting of this variable.  I'm not sure where to test this, though.

If we export our setting for MPLCONFIGDIR, then we also need to document it, probably in the installation guide, saying that Sage uses its own matplotlib config directory, not the default one or whatever the user may have set.



---

archive/issue_comments_041324.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jhpalmieri](#comment%3A10):\n> Can we just do\n\n\n```\nMPLCONFIGDIR=\"$DOT_SAGE/matplotlib\"\nexport MPLCONFIGDIR\n```\n> in sage-env? \n\nAs mentioned above, the configuration should be inside a *specific Sage installation* hierarchy, not just yet another *user-specific* directory, which is (usually) the same for all Sage installations.\n\nI don't understand why the matplotlib developers broke compatibility with older versions; I think it's likely to have different MPL installations included in other software packages, but I might be wrong. IMHO bad design anyway; also the exceptions raised are odd.",
    "created_at": "2010-10-20T20:40:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41324",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jhpalmieri](#comment%3A10):
> Can we just do


```
MPLCONFIGDIR="$DOT_SAGE/matplotlib"
export MPLCONFIGDIR
```
> in sage-env? 

As mentioned above, the configuration should be inside a *specific Sage installation* hierarchy, not just yet another *user-specific* directory, which is (usually) the same for all Sage installations.

I don't understand why the matplotlib developers broke compatibility with older versions; I think it's likely to have different MPL installations included in other software packages, but I might be wrong. IMHO bad design anyway; also the exceptions raised are odd.



---

archive/issue_comments_041325.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@nexttime](#comment%3A11):\n> Replying to [@jhpalmieri](#comment%3A10):\n> > Can we just do\n> \n> \n> ```\n> MPLCONFIGDIR=\"$DOT_SAGE/matplotlib\"\n> export MPLCONFIGDIR\n> ```\n> > in sage-env? \n> \n> \n> As mentioned above, the configuration should be inside a *specific Sage installation* hierarchy, not just yet another *user-specific* directory, which is (usually) the same for all Sage installations.\n\nAt the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?\n\n\n> \n> I don't understand why the matplotlib developers broke compatibility with older versions; I think it's likely to have different MPL installations included in other software packages, but I might be wrong. IMHO bad design anyway; also the exceptions raised are odd.",
    "created_at": "2010-10-20T20:53:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41325",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@nexttime](#comment%3A11):
> Replying to [@jhpalmieri](#comment%3A10):
> > Can we just do
> 
> 
> ```
> MPLCONFIGDIR="$DOT_SAGE/matplotlib"
> export MPLCONFIGDIR
> ```
> > in sage-env? 
> 
> 
> As mentioned above, the configuration should be inside a *specific Sage installation* hierarchy, not just yet another *user-specific* directory, which is (usually) the same for all Sage installations.

At the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?


> 
> I don't understand why the matplotlib developers broke compatibility with older versions; I think it's likely to have different MPL installations included in other software packages, but I might be wrong. IMHO bad design anyway; also the exceptions raised are odd.



---

archive/issue_comments_041326.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jasongrout](#comment%3A12):\n> At the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?\n\nI was thinking of that, too. Not that easy, though. (E.g. using the Sage version as an \"index\" isn't reliable either.)\n\nIs the font cache the only problem? If so, we could just delete it upon every Sage [script] start-up... (quite ugly, of course)\n\nBut older versions of MPL should simply recognize config files from newer versions and e.g. (partially) ignore them. Or at least print an *appropriate* error message. (Not very pythonic, I know. *SCNR*)",
    "created_at": "2010-10-20T21:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41326",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jasongrout](#comment%3A12):
> At the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?

I was thinking of that, too. Not that easy, though. (E.g. using the Sage version as an "index" isn't reliable either.)

Is the font cache the only problem? If so, we could just delete it upon every Sage [script] start-up... (quite ugly, of course)

But older versions of MPL should simply recognize config files from newer versions and e.g. (partially) ignore them. Or at least print an *appropriate* error message. (Not very pythonic, I know. *SCNR*)



---

archive/issue_comments_041327.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@nexttime](#comment%3A13):\n> Replying to [@jasongrout](#comment%3A12):\n> > At the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?\n> \n> \n> I was thinking of that, too. Not that easy, though. (E.g. using the Sage version as an \"index\" isn't reliable either.)\n> \n> Is the font cache the only problem? If so, we could just delete it upon every Sage [script] start-up... (quite ugly, of course)\n\nI believe (off the top of my head) that the error \"    TypeError: coercing to Unicode: need string or buffer, dict found\" comes from the newer matplotlib including some stix fonts, and so it updates the font cache file to include those files.  However, older versions of matplotlib did not deal gracefully with font cache files that referred to nonexistant directories.  So if you install the new Sage, then matplotlib updates the font cache file to include the new fonts in the new matplotlib, then you move the new Sage install, the old Sage install will probably die when trying to open the nonexistant new font.  Of course, matplotlib should just silently regenerate the cache file, and that is what the bugfix in the 1.0.0 spkg is.",
    "created_at": "2010-10-20T21:23:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41327",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@nexttime](#comment%3A13):
> Replying to [@jasongrout](#comment%3A12):
> > At the same time, this directory should not be inside a specific Sage installation (i.e., below SAGE_ROOT) since that means system-wide installs can't have individual customizations, and it also breaks system-wide font cache generation (i.e., matplotlib assumes that a user can update the font cache file, I believe).  So where are we now?  Separate matplotlib config directories for each version of Sage inside of the .sage directory?
> 
> 
> I was thinking of that, too. Not that easy, though. (E.g. using the Sage version as an "index" isn't reliable either.)
> 
> Is the font cache the only problem? If so, we could just delete it upon every Sage [script] start-up... (quite ugly, of course)

I believe (off the top of my head) that the error "    TypeError: coercing to Unicode: need string or buffer, dict found" comes from the newer matplotlib including some stix fonts, and so it updates the font cache file to include those files.  However, older versions of matplotlib did not deal gracefully with font cache files that referred to nonexistant directories.  So if you install the new Sage, then matplotlib updates the font cache file to include the new fonts in the new matplotlib, then you move the new Sage install, the old Sage install will probably die when trying to open the nonexistant new font.  Of course, matplotlib should just silently regenerate the cache file, and that is what the bugfix in the 1.0.0 spkg is.



---

archive/issue_comments_041328.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nHow about separate matplotlib config directories for each version of matplotlib?  We could read the version from the file `SAGE_ROOT/local/lib/python/site-packages/matplotlib/__init__.py` -- search for `\"__version__ = ...\"`.  If the file `matplotlib/__init__.py` does not exist, then matplotlib hasn't been installed yet, so we don't care what we set MPLCONFIGDIR to, but if it exists, we can set MPLCONFIGDIR to something like \"$DOT_SAGE/matplotlib-$VER\".\n\n(We could instead look at the name of the file SAGE_ROOT/local/lib/python/site-packages/matplotlib-VER-py2.6.egg-info, although if we upgrade, there could be several of these files present, and this doesn't seem as safe to me.)",
    "created_at": "2010-10-20T21:34:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41328",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

How about separate matplotlib config directories for each version of matplotlib?  We could read the version from the file `SAGE_ROOT/local/lib/python/site-packages/matplotlib/__init__.py` -- search for `"__version__ = ..."`.  If the file `matplotlib/__init__.py` does not exist, then matplotlib hasn't been installed yet, so we don't care what we set MPLCONFIGDIR to, but if it exists, we can set MPLCONFIGDIR to something like "$DOT_SAGE/matplotlib-$VER".

(We could instead look at the name of the file SAGE_ROOT/local/lib/python/site-packages/matplotlib-VER-py2.6.egg-info, although if we upgrade, there could be several of these files present, and this doesn't seem as safe to me.)



---

archive/issue_comments_041329.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nOf course, by the reasoning in my previous post, simply moving an old sage version directory should have caused the same problem.  So I guess my explanation doesn't seem right anymore.",
    "created_at": "2010-10-20T21:35:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41329",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:16" align="right">comment:16</div>

Of course, by the reasoning in my previous post, simply moving an old sage version directory should have caused the same problem.  So I guess my explanation doesn't seem right anymore.



---

archive/issue_comments_041330.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIn case my idea works, when you install the matplotlib spkg, does it need to know the value of MPLCONFIGDIR, or is it safe to set that only after matplotlib has been installed?",
    "created_at": "2010-10-20T21:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41330",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

In case my idea works, when you install the matplotlib spkg, does it need to know the value of MPLCONFIGDIR, or is it safe to set that only after matplotlib has been installed?



---

archive/issue_comments_041331.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jhpalmieri](#comment%3A15):\n> How about separate matplotlib config directories for each version of matplotlib?\n> [...]\n> we can set `MPLCONFIGDIR` to something like `$DOT_SAGE/matplotlib-$VER`.\n\nSounds like a good idea to me. (You should suggest similar upstream; they could *read* `MPLCONFIGDIR` but *write* incompatible things to a versioned subdirectory of that.)\n\n> In case my idea works, when you install the matplotlib spkg, does it need to know the value of `MPLCONFIGDIR`, or is it safe to set that only after matplotlib has been installed?\n\nI'm not sure if MPL writes anything to that during installation; it's perhaps sufficient to set MPLCONFIGDIR before *using* MPL (i.e., after installation) to fix the `TypeError` issue with parallel installations of older versions.",
    "created_at": "2010-10-20T22:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41331",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jhpalmieri](#comment%3A15):
> How about separate matplotlib config directories for each version of matplotlib?
> [...]
> we can set `MPLCONFIGDIR` to something like `$DOT_SAGE/matplotlib-$VER`.

Sounds like a good idea to me. (You should suggest similar upstream; they could *read* `MPLCONFIGDIR` but *write* incompatible things to a versioned subdirectory of that.)

> In case my idea works, when you install the matplotlib spkg, does it need to know the value of `MPLCONFIGDIR`, or is it safe to set that only after matplotlib has been installed?

I'm not sure if MPL writes anything to that during installation; it's perhaps sufficient to set MPLCONFIGDIR before *using* MPL (i.e., after installation) to fix the `TypeError` issue with parallel installations of older versions.



---

archive/issue_comments_041332.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@nexttime](#comment%3A18):\n> I'm not sure if MPL writes anything to that during installation; it's perhaps sufficient to set MPLCONFIGDIR before *using* MPL (i.e., after installation) to fix the `TypeError` issue with parallel installations of older versions.\n\nAt least our current 1.0.0 doesn't write to / create `$HOME/.matplotlib/` during *installation*.\n\n(I simply renamed the directory and did `./sage -f matplotlib-1.0.0`.)\n\nDoing\n\n```\nsage: import matplotlib\n```\nrecreates the directory (`$HOME/.matplotlib/`).",
    "created_at": "2010-10-20T22:19:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41332",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@nexttime](#comment%3A18):
> I'm not sure if MPL writes anything to that during installation; it's perhaps sufficient to set MPLCONFIGDIR before *using* MPL (i.e., after installation) to fix the `TypeError` issue with parallel installations of older versions.

At least our current 1.0.0 doesn't write to / create `$HOME/.matplotlib/` during *installation*.

(I simply renamed the directory and did `./sage -f matplotlib-1.0.0`.)

Doing

```
sage: import matplotlib
```
recreates the directory (`$HOME/.matplotlib/`).



---

archive/issue_comments_041333.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\n:-) Try:\n\n```sh\n$ export MPLCONFIGDIR=/some/non-existent/dir/ && ./sage -c \"import matplotlib\"\n```\n(The trailing slash doesn't matter. Also, using `$HOME/non-existent/` doesn't make a difference.)",
    "created_at": "2010-10-20T22:29:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41333",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:20" align="right">comment:20</div>

:-) Try:

```sh
$ export MPLCONFIGDIR=/some/non-existent/dir/ && ./sage -c "import matplotlib"
```
(The trailing slash doesn't matter. Also, using `$HOME/non-existent/` doesn't make a difference.)



---

archive/issue_comments_041334.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@nexttime](#comment%3A20):\n> :-) Try:\n\n\n```sh\n$ export MPLCONFIGDIR=/some/non-existent/dir/ && ./sage -c \"import matplotlib\"\n```\n> (The trailing slash doesn't matter. Also, using `$HOME/non-existent/` doesn't make a difference.)\n\nCool.",
    "created_at": "2010-10-20T22:36:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41334",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@nexttime](#comment%3A20):
> :-) Try:


```sh
$ export MPLCONFIGDIR=/some/non-existent/dir/ && ./sage -c "import matplotlib"
```
> (The trailing slash doesn't matter. Also, using `$HOME/non-existent/` doesn't make a difference.)

Cool.



---

archive/issue_events_074264.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-10-20T22:40:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74264"
}
```



---

archive/issue_comments_041335.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nHere's a patch.  The \"sed\" business could be done more efficiently by someone who actually knows how to use sed.  You can consider this a first draft if you want, but I'm marking it as ready for review.",
    "created_at": "2010-10-20T22:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41335",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

Here's a patch.  The "sed" business could be done more efficiently by someone who actually knows how to use sed.  You can consider this a first draft if you want, but I'm marking it as ready for review.



---

archive/issue_comments_041336.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jhpalmieri](#comment%3A22):\n> Here's a patch.  The \"sed\" business could be done more efficiently by someone who actually knows how to use sed.  You can consider this a first draft if you want, but I'm marking it as ready for review.\n\n```sh\n...\n\n    MPLVER=`sed -n \"/^__version__[ ]*=[ ]*'[^']*'/s/[^']*'\\([^']*\\)'.*$/\\1/p\" \"$SAGE_LOCAL\"/lib/python/site-packages/matplotlib/__init__.py`\n    # Or just (if we check the result):\n    # MPLVER=`sed -n \"/^__version__[ ]*=/s/[^']*'\\([^']*\\)'.*$/\\1/p\" \"$SAGE_LOCAL\"/lib/python/site-packages/matplotlib/__init__.py`\n\n    # Hopefully they never switch to double quotes...\n\n...\n\n$MKDIR -p \"$MPLCONFIGDIR\" # better quote the dir\n```\n\nPerhaps also check that `\"$MPLVER\"` is non-empty.",
    "created_at": "2010-10-20T23:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41336",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jhpalmieri](#comment%3A22):
> Here's a patch.  The "sed" business could be done more efficiently by someone who actually knows how to use sed.  You can consider this a first draft if you want, but I'm marking it as ready for review.

```sh
...

    MPLVER=`sed -n "/^__version__[ ]*=[ ]*'[^']*'/s/[^']*'\([^']*\)'.*$/\1/p" "$SAGE_LOCAL"/lib/python/site-packages/matplotlib/__init__.py`
    # Or just (if we check the result):
    # MPLVER=`sed -n "/^__version__[ ]*=/s/[^']*'\([^']*\)'.*$/\1/p" "$SAGE_LOCAL"/lib/python/site-packages/matplotlib/__init__.py`

    # Hopefully they never switch to double quotes...

...

$MKDIR -p "$MPLCONFIGDIR" # better quote the dir
```

Perhaps also check that `"$MPLVER"` is non-empty.



---

archive/issue_comments_041337.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2010-10-20T23:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41337",
    "user": "https://github.com/nexttime"
}
```

Author: **John Palmieri**



---

archive/issue_comments_041338.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nMore funny:\n\n```sh\n    eval `sed -n \"/^__version__[ ]*=/s/ //gp\" \"$SAGE_LOCAL\"/lib/python/site-packages/matplotlib/__init__.py`\n    MPLVER=$__version__\n```",
    "created_at": "2010-10-20T23:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41338",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:25" align="right">comment:25</div>

More funny:

```sh
    eval `sed -n "/^__version__[ ]*=/s/ //gp" "$SAGE_LOCAL"/lib/python/site-packages/matplotlib/__init__.py`
    MPLVER=$__version__
```



---

archive/issue_comments_041339.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nHere's a new patch using leif's less funny version.  It also does not set MPLCONFIGDIR if the file `matplotlib/__init__.py` is not found, partly because I don't want to have to create $DOT_SAGE/matplotlib early in the installation process.  One small drawback to the current approach is that perhaps during an upgrade from a version of Sage using matplotlib-0.99 to a version using matplotlib-1.0.0, the directory $DOT_SAGE/matplotlib-0.99 will be created first but will remain empty and will never be used.  But I seem to have various subdirectories in $DOT_SAGE which I never pay attention to, so having one more doesn't seem like a big deal.",
    "created_at": "2010-10-21T00:00:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41339",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

Here's a new patch using leif's less funny version.  It also does not set MPLCONFIGDIR if the file `matplotlib/__init__.py` is not found, partly because I don't want to have to create $DOT_SAGE/matplotlib early in the installation process.  One small drawback to the current approach is that perhaps during an upgrade from a version of Sage using matplotlib-0.99 to a version using matplotlib-1.0.0, the directory $DOT_SAGE/matplotlib-0.99 will be created first but will remain empty and will never be used.  But I seem to have various subdirectories in $DOT_SAGE which I never pay attention to, so having one more doesn't seem like a big deal.



---

archive/issue_comments_041340.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\ns/MPLCONFIGIDIR/MPLCONFIGDIR/ (minor; in the comment)\n\nIn principle, you can now omit the outer test (`if [ -f ... ]; then`) and simply redirect stderr to `/dev/null` inside the backquotes.\n\nAccording to Dave, we no longer use variables for simple (POSIX) commands like `mkdir` and `cp` etc., but I don't mind.",
    "created_at": "2010-10-21T00:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41340",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:27" align="right">comment:27</div>

s/MPLCONFIGIDIR/MPLCONFIGDIR/ (minor; in the comment)

In principle, you can now omit the outer test (`if [ -f ... ]; then`) and simply redirect stderr to `/dev/null` inside the backquotes.

According to Dave, we no longer use variables for simple (POSIX) commands like `mkdir` and `cp` etc., but I don't mind.



---

archive/issue_comments_041341.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@nexttime](#comment%3A27):\n> s/MPLCONFIGIDIR/MPLCONFIGDIR/ (minor; in the comment)\n\nFixed.\n\n> In principle, you can now omit the outer test (`if [ -f ... ]; then`) and simply redirect stderr to `/dev/null` inside the backquotes.\n\nOkay, but it also works this way, and seems readable to me this way, so I'm leaving it as is.\n\n> According to Dave, we no longer use variables for simple (POSIX) commands like `mkdir` and `cp` etc., but I don't mind.\n\nYou're right, the scripts in local/bin use \"mkdir\", not \"$MKDIR\", so I've changed that, too.",
    "created_at": "2010-10-21T01:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41341",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@nexttime](#comment%3A27):
> s/MPLCONFIGIDIR/MPLCONFIGDIR/ (minor; in the comment)

Fixed.

> In principle, you can now omit the outer test (`if [ -f ... ]; then`) and simply redirect stderr to `/dev/null` inside the backquotes.

Okay, but it also works this way, and seems readable to me this way, so I'm leaving it as is.

> According to Dave, we no longer use variables for simple (POSIX) commands like `mkdir` and `cp` etc., but I don't mind.

You're right, the scripts in local/bin use "mkdir", not "$MKDIR", so I've changed that, too.



---

archive/issue_comments_041342.json:
```json
{
    "body": "Attachment: **[trac_6235-MPLCONFIGDIR.patch.gz](https://github.com/sagemath/sage/files/ticket6235/trac_6235-MPLCONFIGDIR.patch.gz)**\n\nscripts repo",
    "created_at": "2010-10-21T01:35:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41342",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[trac_6235-MPLCONFIGDIR.patch.gz](https://github.com/sagemath/sage/files/ticket6235/trac_6235-MPLCONFIGDIR.patch.gz)**

scripts repo



---

archive/issue_comments_041343.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nOk, \"dry\" positive review. (Not yet tested, but should work and fix the issue). \n\n(Using also the second minor version number is certainly an overkill though.)",
    "created_at": "2010-10-21T01:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41343",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:29" align="right">comment:29</div>

Ok, "dry" positive review. (Not yet tested, but should work and fix the issue). 

(Using also the second minor version number is certainly an overkill though.)



---

archive/issue_comments_041344.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nTested with Sage 4.6.alpha3.\n\nAlso works after deletion of `$HOME/.sage/` (i.e., dirs get properly recreated s.t. MPL doesn't raise an error).\n\nReplying to [@jasongrout](#comment%3A5):\n> The problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well. The issue on this ticket still stands, but it is not urgent for #9221 anymore. \n\nSince this fixes MPL 1.0.0 (#9221) breaking other, older Sage installations, I'm increasing the priority.",
    "created_at": "2010-10-21T02:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41344",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:30" align="right">comment:30</div>

Tested with Sage 4.6.alpha3.

Also works after deletion of `$HOME/.sage/` (i.e., dirs get properly recreated s.t. MPL doesn't raise an error).

Replying to [@jasongrout](#comment%3A5):
> The problems in #9221 (I mistakenly said #9122 above) were fixed with a patch to the matplotlib spkg that has been applied upstream as well. The issue on this ticket still stands, but it is not urgent for #9221 anymore. 

Since this fixes MPL 1.0.0 (#9221) breaking other, older Sage installations, I'm increasing the priority.



---

archive/issue_events_074265.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2010-10-21T02:35:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74265"
}
```



---

archive/issue_events_074266.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2010-10-21T02:35:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74266"
}
```



---

archive/issue_events_074267.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2010-10-21T02:35:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74267"
}
```



---

archive/issue_events_074268.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2010-10-21T02:35:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74268"
}
```



---

archive/issue_comments_041345.json:
```json
{
    "body": "Reviewer: **Leif Leonhardy**",
    "created_at": "2010-10-21T02:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41345",
    "user": "https://github.com/nexttime"
}
```

Reviewer: **Leif Leonhardy**



---

archive/issue_events_074269.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T08:44:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74269"
}
```



---

archive/issue_events_074270.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T08:44:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74270"
}
```



---

archive/issue_events_074271.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T10:07:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74271"
}
```



---

archive/issue_events_074272.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T10:07:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6235#event-74272"
}
```



---

archive/issue_comments_041346.json:
```json
{
    "body": "Merged: **sage-4.6.rc0**",
    "created_at": "2010-10-21T10:07:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41346",
    "user": "https://github.com/qed777"
}
```

Merged: **sage-4.6.rc0**



---

archive/issue_comments_041347.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nSee #10154 for a follow-up: documenting Sage's use of MPLCONFIGDIR.",
    "created_at": "2010-10-22T15:30:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41347",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

See #10154 for a follow-up: documenting Sage's use of MPLCONFIGDIR.



---

archive/issue_comments_041348.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nJustin Walker [reports](http://groups.google.com/group/sage-release/browse_thread/thread/daa80febef383120/328ebbaffc728a92#328ebbaffc728a92) a doctest failure in `doc/en/constructions/plotting.rst`:\n\n```python\nsage -t  -long -force_lib devel/sage/doc/en/constructions/plotting.rst\n**********************************************************************\nFile \"/Users/Sage/sage-4.6.alpha0/devel/sage-main/doc/en/constructions/plotting.rst\", line 42:\n    sage: f.plot()\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/Sage/sage-4.6.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Users/Sage/sage-4.6.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Users/Sage/sage-4.6.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[7]>\", line 1, in <module>\n        f.plot()###line 42:\n    sage: f.plot()\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/misc/displayhook.py\", line 174, in displayhook\n        print_obj(sys.stdout, obj)\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/misc/displayhook.py\", line 142, in print_obj\n        print >>out_stream, `obj`\n      File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1341)\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py\", line 1080, in _repr_\n        self.show()\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/misc.py\", line 84, in wrapper\n        return func(*args, **kwds)\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py\", line 1727, in show\n        self.save(DOCTEST_MODE_FILE, **options)\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py\", line 2388, in save\n        figure=self.matplotlib(*args, **kwds)\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py\", line 1927, in matplotlib\n        from matplotlib.figure import Figure, figaspect\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/figure.py\", line 18, in <module>\n        from axes import Axes, SubplotBase, subplot_class_factory\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/axes.py\", line 18, in <module>\n        import matplotlib.contour as mcontour\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/contour.py\", line 21, in <module>\n        import matplotlib.texmanager as texmanager\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/texmanager.py\", line 72, in <module>\n        class TexManager:\n      File \"/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/texmanager.py\", line 92, in TexManager\n        os.mkdir(texcache)\n    OSError: [Errno 17] File exists: '/Users/justin/.sage//matplotlib-1.0.0/tex.cache'\n```",
    "created_at": "2010-10-22T21:58:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41348",
    "user": "https://github.com/qed777"
}
```

<div id="comment:34" align="right">comment:34</div>

Justin Walker [reports](http://groups.google.com/group/sage-release/browse_thread/thread/daa80febef383120/328ebbaffc728a92#328ebbaffc728a92) a doctest failure in `doc/en/constructions/plotting.rst`:

```python
sage -t  -long -force_lib devel/sage/doc/en/constructions/plotting.rst
**********************************************************************
File "/Users/Sage/sage-4.6.alpha0/devel/sage-main/doc/en/constructions/plotting.rst", line 42:
    sage: f.plot()
Exception raised:
    Traceback (most recent call last):
      File "/Users/Sage/sage-4.6.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/Sage/sage-4.6.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/Sage/sage-4.6.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[7]>", line 1, in <module>
        f.plot()###line 42:
    sage: f.plot()
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/misc/displayhook.py", line 174, in displayhook
        print_obj(sys.stdout, obj)
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/misc/displayhook.py", line 142, in print_obj
        print >>out_stream, `obj`
      File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1341)
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py", line 1080, in _repr_
        self.show()
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/misc.py", line 84, in wrapper
        return func(*args, **kwds)
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py", line 1727, in show
        self.save(DOCTEST_MODE_FILE, **options)
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py", line 2388, in save
        figure=self.matplotlib(*args, **kwds)
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/sage/plot/plot.py", line 1927, in matplotlib
        from matplotlib.figure import Figure, figaspect
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/figure.py", line 18, in <module>
        from axes import Axes, SubplotBase, subplot_class_factory
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/axes.py", line 18, in <module>
        import matplotlib.contour as mcontour
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/contour.py", line 21, in <module>
        import matplotlib.texmanager as texmanager
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/texmanager.py", line 72, in <module>
        class TexManager:
      File "/Users/Sage/sage-4.6.alpha0/local/lib/python/site-packages/matplotlib/texmanager.py", line 92, in TexManager
        os.mkdir(texcache)
    OSError: [Errno 17] File exists: '/Users/justin/.sage//matplotlib-1.0.0/tex.cache'
```



---

archive/issue_comments_041349.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nI wonder if Justin's error occured because matplotlib tried to create `tex.cache` in two or more \"simultaneous\" test processes.",
    "created_at": "2010-10-22T22:01:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41349",
    "user": "https://github.com/qed777"
}
```

<div id="comment:35" align="right">comment:35</div>

I wonder if Justin's error occured because matplotlib tried to create `tex.cache` in two or more "simultaneous" test processes.



---

archive/issue_comments_041350.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@qed777](#comment%3A35):\n> I wonder if Justin's error occured because matplotlib tried to create `tex.cache` in two or more \"simultaneous\" test processes.\n\nThat's just what I posted to sage-release.  The relevant lines in matplotlib/texmanager.py are\n\n```\n    if not os.path.exists(texcache):\n        os.mkdir(texcache)\n```\nso that seems a likely explanation.",
    "created_at": "2010-10-22T22:12:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41350",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@qed777](#comment%3A35):
> I wonder if Justin's error occured because matplotlib tried to create `tex.cache` in two or more "simultaneous" test processes.

That's just what I posted to sage-release.  The relevant lines in matplotlib/texmanager.py are

```
    if not os.path.exists(texcache):
        os.mkdir(texcache)
```
so that seems a likely explanation.



---

archive/issue_comments_041351.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSee #10159 for a followup, dealing with the race condition.",
    "created_at": "2010-10-23T18:35:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/6235",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6235#issuecomment-41351",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:37" align="right">comment:37</div>

See #10159 for a followup, dealing with the race condition.
