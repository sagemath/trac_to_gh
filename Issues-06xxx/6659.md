# Issue 6659: cores() is broken for some digraphs, and is *way* too slow

archive/issues_006659.json:
```json
{
    "body": "Here is a patch, based on the networkx code, which implements some of the optimizations noted in the paper referenced in the networkx documentation.  This leads to what I think are asymptotic speedups.\n\nAs for the bug, before, the doctest added would fail from an error in the networkx code.  Now it does not.\n\nAssignee: @rlmill\n\nCC:  @rlmill @rbeezer hartke\n\nResolution: fixed\n\nAuthor: Jason Grout\n\nReviewer: Robert Miller, Minh Van Nguyen\n\nMerged: Sage 4.1.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/6659\n\n",
    "closed_at": "2009-08-25T03:04:27Z",
    "created_at": "2009-07-30T08:38:51Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.1.2",
    "title": "cores() is broken for some digraphs, and is *way* too slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/6659",
    "user": "https://github.com/jasongrout"
}
```
Here is a patch, based on the networkx code, which implements some of the optimizations noted in the paper referenced in the networkx documentation.  This leads to what I think are asymptotic speedups.

As for the bug, before, the doctest added would fail from an error in the networkx code.  Now it does not.

Assignee: @rlmill

CC:  @rlmill @rbeezer hartke

Resolution: fixed

Author: Jason Grout

Reviewer: Robert Miller, Minh Van Nguyen

Merged: Sage 4.1.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/6659





---

archive/issue_comments_068033.json:
```json
{
    "body": "<a id='comment:1'></a>\nI fixed a bug (the doctest I added used to fail), implemented some optimizations that massively sped things up, and cleaned up the documentation.\n\nRobert or Rob, can one of you review this so it can go into 4.1.1?",
    "created_at": "2009-07-30T09:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68033",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:1'></a>
I fixed a bug (the doctest I added used to fail), implemented some optimizations that massively sped things up, and cleaned up the documentation.

Robert or Rob, can one of you review this so it can go into 4.1.1?



---

archive/issue_comments_068034.json:
```json
{
    "body": "<a id='comment:2'></a>\nAn example of a speedup:\n\nBEFORE:\n\n```\nsage: a=random_matrix(GF(2), 50000, density=0.0001,sparse=True)\nsage: len(a.nonzero_positions())\n125063\nsage: c=DiGraph(50000)\nsage: c.add_edges(a.nonzero_positions())\nsage: %time\nsage: e=c.cores(with_labels=True)\nCPU time: 429.14 s,  Wall time: 430.89 s\n```\n\nAFTER:\n\n```\nsage: d=c.cores(with_labels=True)\nCPU time: 1.86 s,  Wall time: 1.86 s\nsage: e==d\nTrue\n```",
    "created_at": "2009-07-30T09:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68034",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'></a>
An example of a speedup:

BEFORE:

```
sage: a=random_matrix(GF(2), 50000, density=0.0001,sparse=True)
sage: len(a.nonzero_positions())
125063
sage: c=DiGraph(50000)
sage: c.add_edges(a.nonzero_positions())
sage: %time
sage: e=c.cores(with_labels=True)
CPU time: 429.14 s,  Wall time: 430.89 s
```

AFTER:

```
sage: d=c.cores(with_labels=True)
CPU time: 1.86 s,  Wall time: 1.86 s
sage: e==d
True
```



---

archive/issue_comments_068035.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2009-07-30T09:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68035",
    "user": "https://github.com/jasongrout"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_068036.json:
```json
{
    "body": "<a id='comment:5'></a>\nAttachment [trac_6659-graph-cores.patch](tarball://root/attachments/some-uuid/ticket6659/trac_6659-graph-cores.patch) by @jasongrout created at 2009-07-31 07:28:59\n\nI added a couple of comments to help the reader see what is happening in the source code.",
    "created_at": "2009-07-31T07:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68036",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:5'></a>
Attachment [trac_6659-graph-cores.patch](tarball://root/attachments/some-uuid/ticket6659/trac_6659-graph-cores.patch) by @jasongrout created at 2009-07-31 07:28:59

I added a couple of comments to help the reader see what is happening in the source code.



---

archive/issue_comments_068037.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-08-03T01:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68037",
    "user": "https://github.com/rlmill"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_068038.json:
```json
{
    "body": "Reviewer: Robert Miller",
    "created_at": "2009-08-03T01:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68038",
    "user": "https://github.com/rlmill"
}
```

Reviewer: Robert Miller



---

archive/issue_comments_068039.json:
```json
{
    "body": "reviewer patch; typo fix",
    "created_at": "2009-08-25T02:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68039",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

reviewer patch; typo fix



---

archive/issue_comments_068040.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [trac_6659-reviewer.patch](tarball://root/attachments/some-uuid/ticket6659/trac_6659-reviewer.patch) by mvngu created at 2009-08-25 02:22:16\n\nThe patch `trac_6659-reviewer.patch` fixes a typo found in `trac_6659-graph-cores.patch`.",
    "created_at": "2009-08-25T02:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68040",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:7'></a>
Attachment [trac_6659-reviewer.patch](tarball://root/attachments/some-uuid/ticket6659/trac_6659-reviewer.patch) by mvngu created at 2009-08-25 02:22:16

The patch `trac_6659-reviewer.patch` fixes a typo found in `trac_6659-graph-cores.patch`.



---

archive/issue_comments_068041.json:
```json
{
    "body": "Changing reviewer from \"Robert Miller\" to \"Robert Miller, Minh Van Nguyen\"",
    "created_at": "2009-08-25T03:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68041",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing reviewer from "Robert Miller" to "Robert Miller, Minh Van Nguyen"



---

archive/issue_comments_068042.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-08-25T03:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68042",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Resolution: fixed



---

archive/issue_events_020133.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-08-25T03:04:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6659#event-20133"
}
```



---

archive/issue_comments_068043.json:
```json
{
    "body": "Merged: Sage 4.1.2.alpha0",
    "created_at": "2009-08-25T03:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68043",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Merged: Sage 4.1.2.alpha0



---

archive/issue_comments_068044.json:
```json
{
    "body": "<a id='comment:9'></a>\nMerged both patches.",
    "created_at": "2009-08-25T03:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6659#issuecomment-68044",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:9'></a>
Merged both patches.
