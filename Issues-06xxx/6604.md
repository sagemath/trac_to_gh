# Issue 6604: Polish the use of iterators in C graphs

archive/issues_006604.json:
```json
{
    "body": "http://groups.google.com/group/sage-devel/browse_thread/thread/2bdfa75d401575f2\n\n**Assignee:** @rlmill\n\n**CC:**  @kliem @tscrim\n\n**Branch/Commit:** [c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** David Coudert\n\nIssue created by migration from https://trac.sagemath.org/ticket/6604\n\n",
    "closed_at": "2021-12-12T15:09:10Z",
    "created_at": "2009-07-23T15:56:41Z",
    "labels": [
        "component: graph theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "title": "Polish the use of iterators in C graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/6604",
    "user": "https://github.com/rlmill"
}
```
http://groups.google.com/group/sage-devel/browse_thread/thread/2bdfa75d401575f2

**Assignee:** @rlmill

**CC:**  @kliem @tscrim

**Branch/Commit:** [c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)

**Reviewer:** Travis Scrimshaw

**Author:** David Coudert

Issue created by migration from https://trac.sagemath.org/ticket/6604





---

archive/issue_comments_047384.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+http://groups.google.com/group/sage-devel/browse_thread/thread/2bdfa75d401575f2\n``````\n",
    "created_at": "2009-07-23T16:16:49Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47384",
    "user": "https://github.com/rlmill"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+http://groups.google.com/group/sage-devel/browse_thread/thread/2bdfa75d401575f2
``````




---

archive/issue_comments_047385.json:
```json
{
    "body": "<a id='comment:3'></a>\nI am right now watching a talk on closures in Cython, which are all but finished. Then, yield statements in Cython will soon follow! So don't work on this ticket for now...",
    "created_at": "2010-01-09T00:08:48Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47385",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:3'></a>
I am right now watching a talk on closures in Cython, which are all but finished. Then, yield statements in Cython will soon follow! So don't work on this ticket for now...



---

archive/issue_events_043613.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-03-17T05:26:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "bug",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43613"
}
```



---

archive/issue_events_043614.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-03-17T05:26:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "enhancement",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43614"
}
```



---

archive/issue_events_043615.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43615"
}
```



---

archive/issue_events_043616.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43616"
}
```



---

archive/issue_events_043617.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43617"
}
```



---

archive/issue_events_043618.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43618"
}
```



---

archive/issue_events_043619.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43619"
}
```



---

archive/issue_events_043620.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43620"
}
```



---

archive/issue_events_043621.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43621"
}
```



---

archive/issue_events_043622.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43622"
}
```



---

archive/issue_events_043623.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2021-12-03T17:39:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43623"
}
```



---

archive/issue_events_043624.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2021-12-03T17:39:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43624"
}
```



---

archive/issue_events_043625.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2021-12-03T17:39:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43625"
}
```



---

archive/issue_comments_047386.json:
```json
{
    "body": "**Branch:** [public/graphs/6604_iterators](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/6604_iterators)",
    "created_at": "2021-12-03T17:39:45Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47386",
    "user": "https://github.com/dcoudert"
}
```

**Branch:** [public/graphs/6604_iterators](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/6604_iterators)



---

archive/issue_comments_047387.json:
```json
{
    "body": "<a id='comment:9'></a>\nIt seems there is little remaining to do for iterators in backends now, so let's do it.\n\nBefore\n\n```\nsage: a = DiGraph(graphs.CompleteGraph(100))\nsage: b = a._backend\nsage: %timeit L = list(b.iterator_nbrs(30))\n28.3 \u00b5s \u00b1 1.44 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\nAfter\n\n```\nsage: a = DiGraph(graphs.CompleteGraph(100))\nsage: b = a._backend\nsage: %timeit L = list(b.iterator_nbrs(30))\n18.6 \u00b5s \u00b1 698 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6\">07d52d9</a></td><td><code>trac #6604: polish some iterators in backends</code></td></tr></table>\n",
    "created_at": "2021-12-03T17:39:45Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47387",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:9'></a>
It seems there is little remaining to do for iterators in backends now, so let's do it.

Before

```
sage: a = DiGraph(graphs.CompleteGraph(100))
sage: b = a._backend
sage: %timeit L = list(b.iterator_nbrs(30))
28.3 µs ± 1.44 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```

After

```
sage: a = DiGraph(graphs.CompleteGraph(100))
sage: b = a._backend
sage: %timeit L = list(b.iterator_nbrs(30))
18.6 µs ± 698 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6">07d52d9</a></td><td><code>trac #6604: polish some iterators in backends</code></td></tr></table>




---

archive/issue_comments_047388.json:
```json
{
    "body": "**Commit:** [07d52d955bd71c87bcb175814b155c5d0c57b3a6](https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6)",
    "created_at": "2021-12-03T17:39:45Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47388",
    "user": "https://github.com/dcoudert"
}
```

**Commit:** [07d52d955bd71c87bcb175814b155c5d0c57b3a6](https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6)



---

archive/issue_comments_047389.json:
```json
{
    "body": "**Author:** David Coudert",
    "created_at": "2021-12-03T17:39:45Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47389",
    "user": "https://github.com/dcoudert"
}
```

**Author:** David Coudert



---

archive/issue_comments_047390.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2021-12-04T04:47:56Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47390",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_047391.json:
```json
{
    "body": "<a id='comment:10'></a>\nThat is quite a decent speedup and will likely have effects in other methods. Looks like some trivial failures due to slight differences in how the iteration is done:\n\n```\nsage -t --long --random-seed=210304412354021215508062896360889570175 src/sage/graphs/generic_graph.py\n**********************************************************************\nFile \"src/sage/graphs/generic_graph.py\", line 10654, in sage.graphs.generic_graph.GenericGraph.neighbor_iterator\nFailed example:\n    list(D.neighbor_iterator(0))\nExpected:\n    [1, 2, 3]\nGot:\n    [3, 1, 2]\n**********************************************************************\nFile \"src/sage/graphs/generic_graph.py\", line 17591, in sage.graphs.generic_graph.GenericGraph.?\nFailed example:\n    list(D.depth_first_search(1, ignore_direction=True, edges=True))\nExpected:\n    [(1, 4), (4, 5), (5, 6), (5, 2), (4, 3)]\nGot:\n    [(1, 3), (3, 4), (4, 5), (5, 6), (5, 2)]\n```\nThis one I am not sure if it is because of the random seed or this ticket:\n\n```\nsage -t --long --random-seed=210304412354021215508062896360889570175 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 950, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n```\nin either case, it should be a trivial fix.",
    "created_at": "2021-12-04T04:47:56Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47391",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>
That is quite a decent speedup and will likely have effects in other methods. Looks like some trivial failures due to slight differences in how the iteration is done:

```
sage -t --long --random-seed=210304412354021215508062896360889570175 src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 10654, in sage.graphs.generic_graph.GenericGraph.neighbor_iterator
Failed example:
    list(D.neighbor_iterator(0))
Expected:
    [1, 2, 3]
Got:
    [3, 1, 2]
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 17591, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    list(D.depth_first_search(1, ignore_direction=True, edges=True))
Expected:
    [(1, 4), (4, 5), (5, 6), (5, 2), (4, 3)]
Got:
    [(1, 3), (3, 4), (4, 5), (5, 6), (5, 2)]
```
This one I am not sure if it is because of the random seed or this ticket:

```
sage -t --long --random-seed=210304412354021215508062896360889570175 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 950, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
```
in either case, it should be a trivial fix.



---

archive/issue_comments_047392.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5\">c7dc1b1</a></td><td><code>trac #6604: fix doctests in genenric_graph.py</code></td></tr></table>\n",
    "created_at": "2021-12-04T10:09:53Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47392",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5">c7dc1b1</a></td><td><code>trac #6604: fix doctests in genenric_graph.py</code></td></tr></table>




---

archive/issue_comments_047393.json:
```json
{
    "body": "**Changing commit** from \"[07d52d955bd71c87bcb175814b155c5d0c57b3a6](https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6)\" to \"[c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)\".",
    "created_at": "2021-12-04T10:09:53Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47393",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[07d52d955bd71c87bcb175814b155c5d0c57b3a6](https://github.com/sagemath/sagetrac-mirror/commit/07d52d955bd71c87bcb175814b155c5d0c57b3a6)" to "[c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)".



---

archive/issue_comments_047394.json:
```json
{
    "body": "<a id='comment:12'></a>\nI fixed the doctests in `generic_graph.py`. \n\nI cannot reproduce the error in `klyachko.py`. It occurs in method `random_deformation`. Some help might be helpful here.",
    "created_at": "2021-12-04T10:14:54Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47394",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:12'></a>
I fixed the doctests in `generic_graph.py`. 

I cannot reproduce the error in `klyachko.py`. It occurs in method `random_deformation`. Some help might be helpful here.



---

archive/issue_comments_047395.json:
```json
{
    "body": "<a id='comment:13'></a>\nActually, this random error in `klyachko.py` has already been reported in #32773.",
    "created_at": "2021-12-04T11:28:22Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47395",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:13'></a>
Actually, this random error in `klyachko.py` has already been reported in #32773.



---

archive/issue_comments_047396.json:
```json
{
    "body": "<a id='comment:14'></a>\nThank you. LGTM.",
    "created_at": "2021-12-05T07:28:56Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47396",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Thank you. LGTM.



---

archive/issue_events_043626.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-12-05T07:28:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43626"
}
```



---

archive/issue_events_043627.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-12-05T07:28:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43627"
}
```



---

archive/issue_events_043628.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43628"
}
```



---

archive/issue_events_043629.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "91b2153b8f33c36f4aae0d2226f2633d0d02513b",
    "created_at": "2021-12-12T15:09:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6604#event-43629"
}
```



---

archive/issue_comments_047397.json:
```json
{
    "body": "**Changing branch** from \"[public/graphs/6604_iterators](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/6604_iterators)\" to \"[c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)\".",
    "created_at": "2021-12-12T15:09:10Z",
    "issue": "https://github.com/sagemath/sage/issues/6604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6604#issuecomment-47397",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/graphs/6604_iterators](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/6604_iterators)" to "[c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5](https://github.com/sagemath/sagetrac-mirror/commit/c7dc1b1f01ad53ef1e7e1e1be3e926ae714d18f5)".
