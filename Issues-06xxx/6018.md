# Issue 6018: Confusing behaviour with Dirichlet characters

archive/issues_006018.json:
```json
{
    "body": "Funny things happen if you have two Dirichlet groups with the same modulus and the same base ring, but different roots of unity. This can happen if you use base_extend:\n\n```\nsage: G = DirichletGroup(10, QQ).base_extend(CyclotomicField(4))\nsage: H = DirichletGroup(10, CyclotomicField(4))\n```\n\nNow G and H look pretty similar:\n\n```\nsage: G\nGroup of Dirichlet characters of modulus 10 over Cyclotomic Field of order 4 and degree 2\nsage: H\nGroup of Dirichlet characters of modulus 10 over Cyclotomic Field of order 4 and degree 2\n```\n\nBut they don't compare as equal and the generators of H don't live in G:\n\n```\nsage: G == H\nFalse\nsage: H.0 in G\nFalse\n```\n\nHere G only actually contains those characters which factor through its original base ring, namely QQ. This is probably going to be a bit mystifying for the end-user.\n\nSimilar phenomena can make it next to impossible to do arithmetic with characters obtained by base extension, which somehow are second-class citizens:\n\n```\nsage: K5 = CyclotomicField(5); K3 = CyclotomicField(3); K30 = CyclotomicField(30)\nsage: (DirichletGroup(31, K5).0).base_extend(K30) * (DirichletGroup(31, K3).0).base_extend(K30)\nTypeError: unsupported operand parent(s) for '*': \n'Group of Dirichlet characters of modulus 31 over Cyclotomic Field of order 30 and degree 8' and \n'Group of Dirichlet characters of modulus 31 over Cyclotomic Field of order 30 and degree 8'\n```\n\nThis is a particularly mystifying error for the uninitiated, since it's asserting that it can't find a common parent, but the string representations of the parents it already has are identical.\n\nThere are a couple of solutions:\n\n- Change base_extend for Dirichlet groups to pick a maximal order root of unity in the new base ring, rather than just base-extending the root of unity it already has. This is nice and transparent, but it could be slow in some cases, and it prevents us constructing Dirichlet characters with values in rings where the unit group isn't cyclic or we can't compute a generator (e.g. we'd lose the ability to base extend elements of `DirichletGroup(N, ZZ)` to `DirichletGroup(N, Integers(15))`).\n\n- Change the `_repr_` method for Dirichlet groups so it explicitly prints the root of unity involved. I don't like this idea much.\n\n- Some combination of the above two, with a special class for Dirichlet groups over domains where a unique root of unity of maximal order dividing `euler_phi(N)` doesn't exist or can't be calculated. This might be fiddly to write and maintain.\n\n- Make `zeta` optional (implemented in the current branch); see [comment:18](#comment%3A18) for details\n\n**Assignee:** @craigcitro\n\n**Keywords:** Dirichlet characters, days71\n\n**Branch/Commit:** [3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)\n\n**Reviewer:** Aly Deines\n\n**Author:** David Loeffler, Peter Bruin\n\n**Dependencies:** #18540\n\nIssue created by migration from https://trac.sagemath.org/ticket/6018\n\n",
    "closed_at": "2016-03-27T07:44:21Z",
    "created_at": "2009-05-11T09:18:29Z",
    "labels": [
        "component: modular forms",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Confusing behaviour with Dirichlet characters",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/6018",
    "user": "https://github.com/loefflerd"
}
```
Funny things happen if you have two Dirichlet groups with the same modulus and the same base ring, but different roots of unity. This can happen if you use base_extend:

```
sage: G = DirichletGroup(10, QQ).base_extend(CyclotomicField(4))
sage: H = DirichletGroup(10, CyclotomicField(4))
```

Now G and H look pretty similar:

```
sage: G
Group of Dirichlet characters of modulus 10 over Cyclotomic Field of order 4 and degree 2
sage: H
Group of Dirichlet characters of modulus 10 over Cyclotomic Field of order 4 and degree 2
```

But they don't compare as equal and the generators of H don't live in G:

```
sage: G == H
False
sage: H.0 in G
False
```

Here G only actually contains those characters which factor through its original base ring, namely QQ. This is probably going to be a bit mystifying for the end-user.

Similar phenomena can make it next to impossible to do arithmetic with characters obtained by base extension, which somehow are second-class citizens:

```
sage: K5 = CyclotomicField(5); K3 = CyclotomicField(3); K30 = CyclotomicField(30)
sage: (DirichletGroup(31, K5).0).base_extend(K30) * (DirichletGroup(31, K3).0).base_extend(K30)
TypeError: unsupported operand parent(s) for '*': 
'Group of Dirichlet characters of modulus 31 over Cyclotomic Field of order 30 and degree 8' and 
'Group of Dirichlet characters of modulus 31 over Cyclotomic Field of order 30 and degree 8'
```

This is a particularly mystifying error for the uninitiated, since it's asserting that it can't find a common parent, but the string representations of the parents it already has are identical.

There are a couple of solutions:

- Change base_extend for Dirichlet groups to pick a maximal order root of unity in the new base ring, rather than just base-extending the root of unity it already has. This is nice and transparent, but it could be slow in some cases, and it prevents us constructing Dirichlet characters with values in rings where the unit group isn't cyclic or we can't compute a generator (e.g. we'd lose the ability to base extend elements of `DirichletGroup(N, ZZ)` to `DirichletGroup(N, Integers(15))`).

- Change the `_repr_` method for Dirichlet groups so it explicitly prints the root of unity involved. I don't like this idea much.

- Some combination of the above two, with a special class for Dirichlet groups over domains where a unique root of unity of maximal order dividing `euler_phi(N)` doesn't exist or can't be calculated. This might be fiddly to write and maintain.

- Make `zeta` optional (implemented in the current branch); see [comment:18](#comment%3A18) for details

**Assignee:** @craigcitro

**Keywords:** Dirichlet characters, days71

**Branch/Commit:** [3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)

**Reviewer:** Aly Deines

**Author:** David Loeffler, Peter Bruin

**Dependencies:** #18540

Issue created by migration from https://trac.sagemath.org/ticket/6018





---

archive/issue_comments_052517.json:
```json
{
    "body": "<a id='comment:1'></a>\nDavid, I like your analysis of the situation a lot.  I'm going to do what you suggest first.  Regarding performance issues, I think if the user really is worried about that in some case, they can be explicit about the relevant spaces and zeta's.",
    "created_at": "2010-01-19T02:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52517",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>
David, I like your analysis of the situation a lot.  I'm going to do what you suggest first.  Regarding performance issues, I think if the user really is worried about that in some case, they can be explicit about the relevant spaces and zeta's.



---

archive/issue_comments_052518.json:
```json
{
    "body": "**Upstream:** N/A",
    "created_at": "2010-01-19T02:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52518",
    "user": "https://github.com/williamstein"
}
```

**Upstream:** N/A



---

archive/attachments_007023.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_6018.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket6018/trac_6018.patch",
    "created_at": "2010-01-19T03:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_052519.json:
```json
{
    "body": "",
    "created_at": "2010-01-19T03:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52519",
    "user": "https://github.com/williamstein"
}
```





---

archive/issue_comments_052520.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-01-19T03:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52520",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_052521.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis looks like a nice clean fix -- my only worry would be that a few subtle choices cause mayhem with some random modular symbols code. William, did you run doctests on the `modular/` directory? \n\nAlso, one potentially silly comment: your fix assumes that the constructor for `DirichletGroup` always chooses a maximal order and an appropriate zeta if one isn't given. While I can't imagine us ever changing that constructor to do anything different, should we either (1) explicitly choose the maximal order or (2) check and/or document this in some way? I think it's unlikely, but should it ever come up, a comment near that line of code pointing someone in the right direction could be a huge help ...",
    "created_at": "2010-01-19T05:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52521",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:3'></a>
This looks like a nice clean fix -- my only worry would be that a few subtle choices cause mayhem with some random modular symbols code. William, did you run doctests on the `modular/` directory? 

Also, one potentially silly comment: your fix assumes that the constructor for `DirichletGroup` always chooses a maximal order and an appropriate zeta if one isn't given. While I can't imagine us ever changing that constructor to do anything different, should we either (1) explicitly choose the maximal order or (2) check and/or document this in some way? I think it's unlikely, but should it ever come up, a comment near that line of code pointing someone in the right direction could be a huge help ...



---

archive/issue_comments_052522.json:
```json
{
    "body": "<a id='comment:4'></a>\nI am running sage -testall on this patch at the moment. \n\nThe key question, I think, is what we want to happen in the following situation:\n\n```\nsage: f = DirichletGroup(17, ZZ).0\nsage: f.base_extend(Integers(15))\n```\nThis worked under the old approach, because the parent of the base-extended thing was the Dirichlet group of modulus 17 and `zeta = ZZ(15)(-1)`, of order 2. But I suspect that with this patch it will fail now, with an error message about not being able to compute roots of unity mod 15.\n\nI suggest a further modification which makes the constructor raise a more intelligent error message if the root of unity isn't specified and the base ring is one where we can't do factorisation. If the tests pass I will write such a patch, and give William's patch a positive review conditional on that.",
    "created_at": "2010-01-20T18:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52522",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:4'></a>
I am running sage -testall on this patch at the moment. 

The key question, I think, is what we want to happen in the following situation:

```
sage: f = DirichletGroup(17, ZZ).0
sage: f.base_extend(Integers(15))
```
This worked under the old approach, because the parent of the base-extended thing was the Dirichlet group of modulus 17 and `zeta = ZZ(15)(-1)`, of order 2. But I suspect that with this patch it will fail now, with an error message about not being able to compute roots of unity mod 15.

I suggest a further modification which makes the constructor raise a more intelligent error message if the root of unity isn't specified and the base ring is one where we can't do factorisation. If the tests pass I will write such a patch, and give William's patch a positive review conditional on that.



---

archive/attachments_007024.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_6018-2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket6018/trac_6018-2.patch",
    "created_at": "2010-01-20T19:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/loefflerd"
}
```



---

archive/issue_comments_052523.json:
```json
{
    "body": "apply over previous patch",
    "created_at": "2010-01-20T19:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52523",
    "user": "https://github.com/loefflerd"
}
```

apply over previous patch



---

archive/issue_comments_052524.json:
```json
{
    "body": "<a id='comment:5'></a>\nAs promised, here is a second patch. This takes a compromise approach where base_extend tries to calculate a maximal order root of unity in the new base ring if it's an integral domain, but otherwise uses the base-extension. I've added a couple of doctests, including one to illustrate the perils of the `zeta_order` argument.\n\nIf someone else can approve the new patch I think we're sorted.",
    "created_at": "2010-01-20T19:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52524",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:5'></a>
As promised, here is a second patch. This takes a compromise approach where base_extend tries to calculate a maximal order root of unity in the new base ring if it's an integral domain, but otherwise uses the base-extension. I've added a couple of doctests, including one to illustrate the perils of the `zeta_order` argument.

If someone else can approve the new patch I think we're sorted.



---

archive/issue_comments_052525.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis looks good -- I just have two questions:\n\n* In the last example, you show that weirdness ensues when the provided `zeta` doesn't have order `zeta_order`. Couldn't we (optionally, with a `check=...` parameter) check this? Having it on by default definitely seems like it'd stop users from shooting themselves in the foot.\n\n* Is it possible for the call to `base_ring(zeta)` to raise an exception? If so, do we want to catch that and provide a more direct error message, or just let it go?",
    "created_at": "2010-01-20T19:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52525",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:6'></a>
This looks good -- I just have two questions:

* In the last example, you show that weirdness ensues when the provided `zeta` doesn't have order `zeta_order`. Couldn't we (optionally, with a `check=...` parameter) check this? Having it on by default definitely seems like it'd stop users from shooting themselves in the foot.

* Is it possible for the call to `base_ring(zeta)` to raise an exception? If so, do we want to catch that and provide a more direct error message, or just let it go?



---

archive/issue_comments_052526.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe docs state several times that you don't actually need to supply zeta_order, so nobody's going to use the option in the first place unless they've got a pretty good reason to do so. I'd rather not make the code still more complicated! (Would it actually cause that much harm to get rid of the zeta_order argument entirely?)\n\nIf base_ring(zeta) raises an exception, the error message will say something like \"Unable to coerce foo into bar\", and it should be reasonably clear what the problem is. With these patches, the constructor will almost always be getting called without specifying zeta and zeta_order anyway.\n\nDavid",
    "created_at": "2010-01-20T21:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52526",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:7'></a>
The docs state several times that you don't actually need to supply zeta_order, so nobody's going to use the option in the first place unless they've got a pretty good reason to do so. I'd rather not make the code still more complicated! (Would it actually cause that much harm to get rid of the zeta_order argument entirely?)

If base_ring(zeta) raises an exception, the error message will say something like "Unable to coerce foo into bar", and it should be reasonably clear what the problem is. With these patches, the constructor will almost always be getting called without specifying zeta and zeta_order anyway.

David



---

archive/issue_comments_052527.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'm a big fan of just removing the `zeta_order` argument -- looking at the code, there's no real reason to specify it, and it'll clean up a few statements in the constructor.",
    "created_at": "2010-01-20T22:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52527",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:8'></a>
I'm a big fan of just removing the `zeta_order` argument -- looking at the code, there's no real reason to specify it, and it'll clean up a few statements in the constructor.



---

archive/attachments_007025.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_6018-3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket6018/trac_6018-3.patch",
    "created_at": "2010-01-20T22:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/loefflerd"
}
```



---

archive/issue_comments_052528.json:
```json
{
    "body": "",
    "created_at": "2010-01-20T22:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52528",
    "user": "https://github.com/loefflerd"
}
```





---

archive/issue_comments_052529.json:
```json
{
    "body": "<a id='comment:9'></a>\nHere's a third patch that kills zeta_order. All doctests in modular/ pass, I'm running a full test cycle now.",
    "created_at": "2010-01-20T22:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52529",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:9'></a>
Here's a third patch that kills zeta_order. All doctests in modular/ pass, I'm running a full test cycle now.



---

archive/issue_comments_052530.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-01-20T22:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52530",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_052531.json:
```json
{
    "body": "<a id='comment:10'></a>\nTwo thumbs up! Apply all three.",
    "created_at": "2010-01-20T22:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52531",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:10'></a>
Two thumbs up! Apply all three.



---

archive/issue_comments_052532.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2010-01-20T23:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52532",
    "user": "https://github.com/loefflerd"
}
```

apply only this patch



---

archive/attachments_007026.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_6018_folded.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket6018/trac_6018_folded.patch",
    "created_at": "2010-01-20T23:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_052533.json:
```json
{
    "body": "<a id='comment:11'></a>\nHey, why, wait, what happens if you create a zeta such that zeta.multiplicative_order() doesn't work?!\n\n```\nsage: a = CDF(CyclotomicField(5).0)\nsage: G = DirichletGroup(11, base_ring=a.parent(), zeta=a, zeta_order=5)\nsage: G\nGroup of Dirichlet characters of modulus 11 over Complex Double Field\nsage: G.0\n[0.309016994375 + 0.951056516295*I]\nsage: G.0(2)\n0.309016994375 + 0.951056516295*I\n```\n\nPlease revert getting rid of zeta_order and make that part of another ticket, keeping in mind that you can't exactly do that, since it is important.  The above doctest should be put in that ticket since this problem wouldn't have happened if I had included the above test.",
    "created_at": "2010-01-20T23:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52533",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Hey, why, wait, what happens if you create a zeta such that zeta.multiplicative_order() doesn't work?!

```
sage: a = CDF(CyclotomicField(5).0)
sage: G = DirichletGroup(11, base_ring=a.parent(), zeta=a, zeta_order=5)
sage: G
Group of Dirichlet characters of modulus 11 over Complex Double Field
sage: G.0
[0.309016994375 + 0.951056516295*I]
sage: G.0(2)
0.309016994375 + 0.951056516295*I
```

Please revert getting rid of zeta_order and make that part of another ticket, keeping in mind that you can't exactly do that, since it is important.  The above doctest should be put in that ticket since this problem wouldn't have happened if I had included the above test.



---

archive/issue_comments_052534.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2010-01-20T23:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52534",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_052535.json:
```json
{
    "body": "<a id='comment:12'></a>\nOK, so would you be happy with applying just the first two patches? \n\nDavid",
    "created_at": "2010-01-21T09:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52535",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:12'></a>
OK, so would you be happy with applying just the first two patches? 

David



---

archive/issue_comments_052536.json:
```json
{
    "body": "<a id='comment:13'></a>\nOn reflection, the issue is surprisingly subtle.\n\nConsider taking a Dirichlet group with values in the integers of a cyclotomic field K, and base_extending to: (1) the complex double field; (2) the residue field of a prime of K.\n\nIn case (1), your example shows that we can't expect the constructor of the new group to calculate the order of a given zeta. But case (2) shows that the order of the base-extended zeta might not be the same as the order of the original zeta, and one can easily get nonsense if one assumes this.\n\nCase (1) is actually OK if we don't pass zeta as an argument at all, because we can factor polynomials in CDF. This is more or less what applying Craig's patch and mine will give: zeta_order is still available as an argument, but it's not used by the base extension code, which relies on the base ring supporting *either* polynomial factoring or `multiplicative_order`.",
    "created_at": "2010-01-21T09:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52536",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:13'></a>
On reflection, the issue is surprisingly subtle.

Consider taking a Dirichlet group with values in the integers of a cyclotomic field K, and base_extending to: (1) the complex double field; (2) the residue field of a prime of K.

In case (1), your example shows that we can't expect the constructor of the new group to calculate the order of a given zeta. But case (2) shows that the order of the base-extended zeta might not be the same as the order of the original zeta, and one can easily get nonsense if one assumes this.

Case (1) is actually OK if we don't pass zeta as an argument at all, because we can factor polynomials in CDF. This is more or less what applying Craig's patch and mine will give: zeta_order is still available as an argument, but it's not used by the base extension code, which relies on the base ring supporting *either* polynomial factoring or `multiplicative_order`.



---

archive/issue_events_017795.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17795"
}
```



---

archive/issue_events_017796.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17796"
}
```



---

archive/issue_events_017797.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17797"
}
```



---

archive/issue_events_017798.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17798"
}
```



---

archive/issue_events_017799.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17799"
}
```



---

archive/issue_events_017800.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17800"
}
```



---

archive/issue_events_017801.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17801"
}
```



---

archive/issue_comments_052537.json:
```json
{
    "body": "**Author:** David Loeffler, Peter Bruin",
    "created_at": "2015-06-05T12:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52537",
    "user": "https://github.com/pjbruin"
}
```

**Author:** David Loeffler, Peter Bruin



---

archive/issue_comments_052538.json:
```json
{
    "body": "**Dependencies:** #18540",
    "created_at": "2015-06-05T12:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52538",
    "user": "https://github.com/pjbruin"
}
```

**Dependencies:** #18540



---

archive/issue_comments_052539.json:
```json
{
    "body": "<a id='comment:18'></a>\nHere is a branch implementing a solution which is somewhat like the third option in the ticket description.  The idea is to introduce two different variants of `DirichletGroup`:\n- `DirichletGroup(N, base_ring)`, corresponding to the group Hom((**Z**/*N***Z**)<sup>*</sup>, *R*<sup>*</sup>);\n- `DirichletGroup(N, base_ring, zeta[, zeta_order])` corresponding to the group Hom((**Z**/*N***Z**)<sup>*</sup>, \u3008\u03b6\u3009).\nIf *R* is a domain, we also allow the user to only specify `zeta_order`, in which case the `DirichletGroup` factory tries to compute a suitable `zeta`.\n\nThe difference between the two variants is visible from the string representation:\n\n```\nsage: R.<x> = PolynomialRing(QQ)\nsage: K.<a> = NumberField(x^4 + 1)\nsage: DirichletGroup(5, K)\nGroup of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1\nsage: DirichletGroup(5, K, a)\nGroup of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a\n```\n\nBecause it is no longer mandatory to have a distinguished `zeta`, Dirichlet characters are by default specified by their values instead of a vector of integers modulo the order of `zeta`.  For efficiency reasons, this vector is still used whenever a `zeta` is known (whether it has been specified as in the second syntax above or has been computed at a later stage).\n\nBesides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.  This is because `zeta` is only computed when needed, and hence factoring cyclotomic polynomials is avoided.  This factoring will still happen when one asks for things like generators or a list of all elements.\n\nDavid: part of the branch (including some doctests) is based on your patches; I hope you don't mind me adding you as an author.",
    "created_at": "2015-06-05T12:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52539",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:18'></a>
Here is a branch implementing a solution which is somewhat like the third option in the ticket description.  The idea is to introduce two different variants of `DirichletGroup`:
- `DirichletGroup(N, base_ring)`, corresponding to the group Hom((**Z**/*N***Z**)<sup>*</sup>, *R*<sup>*</sup>);
- `DirichletGroup(N, base_ring, zeta[, zeta_order])` corresponding to the group Hom((**Z**/*N***Z**)<sup>*</sup>, 〈ζ〉).
If *R* is a domain, we also allow the user to only specify `zeta_order`, in which case the `DirichletGroup` factory tries to compute a suitable `zeta`.

The difference between the two variants is visible from the string representation:

```
sage: R.<x> = PolynomialRing(QQ)
sage: K.<a> = NumberField(x^4 + 1)
sage: DirichletGroup(5, K)
Group of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1
sage: DirichletGroup(5, K, a)
Group of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a
```

Because it is no longer mandatory to have a distinguished `zeta`, Dirichlet characters are by default specified by their values instead of a vector of integers modulo the order of `zeta`.  For efficiency reasons, this vector is still used whenever a `zeta` is known (whether it has been specified as in the second syntax above or has been computed at a later stage).

Besides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.  This is because `zeta` is only computed when needed, and hence factoring cyclotomic polynomials is avoided.  This factoring will still happen when one asks for things like generators or a list of all elements.

David: part of the branch (including some doctests) is based on your patches; I hope you don't mind me adding you as an author.



---

archive/issue_comments_052540.json:
```json
{
    "body": "**Branch:** [u/pbruin/6018-DirichletGroup_zeta](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/6018-DirichletGroup_zeta)",
    "created_at": "2015-06-05T12:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52540",
    "user": "https://github.com/pjbruin"
}
```

**Branch:** [u/pbruin/6018-DirichletGroup_zeta](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/6018-DirichletGroup_zeta)



---

archive/issue_comments_052541.json:
```json
{
    "body": "**Commit:** [b03524d51a87612922108e137132f7d55ef13646](https://github.com/sagemath/sagetrac-mirror/commit/b03524d51a87612922108e137132f7d55ef13646)",
    "created_at": "2015-06-05T12:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52541",
    "user": "https://github.com/pjbruin"
}
```

**Commit:** [b03524d51a87612922108e137132f7d55ef13646](https://github.com/sagemath/sagetrac-mirror/commit/b03524d51a87612922108e137132f7d55ef13646)



---

archive/issue_comments_052542.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2015-06-05T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52542",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_052543.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -37,7 +37,7 @@\n \n This is a particularly mystifying error for the uninitiated, since it's asserting that it can't find a common parent, but the string representations of the parents it already has are identical.\n \n-I can see a couple of solutions:\n+There are a couple of solutions:\n \n - Change base_extend for Dirichlet groups to pick a maximal order root of unity in the new base ring, rather than just base-extending the root of unity it already has. This is nice and transparent, but it could be slow in some cases, and it prevents us constructing Dirichlet characters with values in rings where the unit group isn't cyclic or we can't compute a generator (e.g. we'd lose the ability to base extend elements of `DirichletGroup(N, ZZ)` to `DirichletGroup(N, Integers(15))`).\n \n@@ -45,4 +45,4 @@\n \n - Some combination of the above two, with a special class for Dirichlet groups over domains where a unique root of unity of maximal order dividing `euler_phi(N)` doesn't exist or can't be calculated. This might be fiddly to write and maintain.\n \n-\n+- Make `zeta` optional (implemented in the current branch); see [comment:18](#comment%3A18) for details\n``````\n",
    "created_at": "2015-06-05T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52543",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -37,7 +37,7 @@
 
 This is a particularly mystifying error for the uninitiated, since it's asserting that it can't find a common parent, but the string representations of the parents it already has are identical.
 
-I can see a couple of solutions:
+There are a couple of solutions:
 
 - Change base_extend for Dirichlet groups to pick a maximal order root of unity in the new base ring, rather than just base-extending the root of unity it already has. This is nice and transparent, but it could be slow in some cases, and it prevents us constructing Dirichlet characters with values in rings where the unit group isn't cyclic or we can't compute a generator (e.g. we'd lose the ability to base extend elements of `DirichletGroup(N, ZZ)` to `DirichletGroup(N, Integers(15))`).
 
@@ -45,4 +45,4 @@
 
 - Some combination of the above two, with a special class for Dirichlet groups over domains where a unique root of unity of maximal order dividing `euler_phi(N)` doesn't exist or can't be calculated. This might be fiddly to write and maintain.
 
-
+- Make `zeta` optional (implemented in the current branch); see [comment:18](#comment%3A18) for details
``````




---

archive/issue_comments_052544.json:
```json
{
    "body": "<a id='comment:20'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a\">f81b0e8</a></td><td><code>Trac 6018: fix doctests</code></td></tr></table>\n",
    "created_at": "2015-06-05T14:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a">f81b0e8</a></td><td><code>Trac 6018: fix doctests</code></td></tr></table>




---

archive/issue_comments_052545.json:
```json
{
    "body": "**Changing commit** from \"[b03524d51a87612922108e137132f7d55ef13646](https://github.com/sagemath/sagetrac-mirror/commit/b03524d51a87612922108e137132f7d55ef13646)\" to \"[f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a](https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a)\".",
    "created_at": "2015-06-05T14:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52545",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[b03524d51a87612922108e137132f7d55ef13646](https://github.com/sagemath/sagetrac-mirror/commit/b03524d51a87612922108e137132f7d55ef13646)" to "[f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a](https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a)".



---

archive/issue_comments_052546.json:
```json
{
    "body": "**Changing commit** from \"[f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a](https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a)\" to \"[0fa9dd593cc81144b8abb3f7b9da9a431318d0a9](https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9)\".",
    "created_at": "2015-06-22T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52546",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a](https://github.com/sagemath/sagetrac-mirror/commit/f81b0e808b716df3d4ee0e6e18ba85ec7c4eba0a)" to "[0fa9dd593cc81144b8abb3f7b9da9a431318d0a9](https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9)".



---

archive/issue_comments_052547.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a2a89bb893a95c3ecd4c2731dee45e190464881\">3a2a89b</a></td><td><code>Trac 18540: reviewer comments</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9\">0fa9dd5</a></td><td><code>Merge branch 'ticket/18540-DirichletGroup_Parent' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>\n",
    "created_at": "2015-06-22T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52547",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a2a89bb893a95c3ecd4c2731dee45e190464881">3a2a89b</a></td><td><code>Trac 18540: reviewer comments</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9">0fa9dd5</a></td><td><code>Merge branch 'ticket/18540-DirichletGroup_Parent' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>




---

archive/issue_comments_052548.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c\">d0bb0e4</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>\n",
    "created_at": "2015-07-16T08:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52548",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c">d0bb0e4</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>




---

archive/issue_comments_052549.json:
```json
{
    "body": "**Changing commit** from \"[0fa9dd593cc81144b8abb3f7b9da9a431318d0a9](https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9)\" to \"[d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c](https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c)\".",
    "created_at": "2015-07-16T08:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52549",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0fa9dd593cc81144b8abb3f7b9da9a431318d0a9](https://github.com/sagemath/sagetrac-mirror/commit/0fa9dd593cc81144b8abb3f7b9da9a431318d0a9)" to "[d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c](https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c)".



---

archive/issue_comments_052550.json:
```json
{
    "body": "<a id='comment:23'></a>\nThis is just a detail, but instead of\n\n```\nGroup of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a\n```\nI would prefer\n\n```\nGroup of Dirichlet characters of modulus 5 with values in the group of order 8 generated by a over Number Field in a with defining polynomial x^4 + 1\n```",
    "created_at": "2015-07-17T20:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52550",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
This is just a detail, but instead of

```
Group of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a
```
I would prefer

```
Group of Dirichlet characters of modulus 5 with values in the group of order 8 generated by a over Number Field in a with defining polynomial x^4 + 1
```



---

archive/issue_comments_052551.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [pbruin](#comment%3A18):\n> Besides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.\n\n\nI assume that this is the main motivation for making `zeta` optional, right? I am not really convinced though that this extra complexity is needed...\n\nIt is true that `zeta()` for number fields is slow, but that can easily be improved (#18917).",
    "created_at": "2015-07-17T20:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52551",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Replying to [pbruin](#comment%3A18):
> Besides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.


I assume that this is the main motivation for making `zeta` optional, right? I am not really convinced though that this extra complexity is needed...

It is true that `zeta()` for number fields is slow, but that can easily be improved (#18917).



---

archive/issue_comments_052552.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [jdemeyer](#comment%3A24):\n> Replying to [pbruin](#comment%3A18):\n> > Besides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.\n\n> \n> I assume that this is the main motivation for making `zeta` optional, right? I am not really convinced though that this extra complexity is needed...\n\nThis is not really true; it also makes more sense conceptually if one does not have to make a choice of root of unity.  I think the problems related to base extension do deserve to be solved and are at least as important as the speed-up.\n> It is true that `zeta()` for number fields is slow, but that can easily be improved (#18917).\n\nIt would be great if it could, but when making a speed improvement to `zeta()` in #15486, I found out that it was necessary to avoid calling PARI's `nfinit()`, because it was too slow for the number fields involved.  This unfortunately precludes using PARI's `nfrootsof1()`...",
    "created_at": "2015-07-18T10:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52552",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:25'></a>
Replying to [jdemeyer](#comment%3A24):
> Replying to [pbruin](#comment%3A18):
> > Besides solving the problems in the ticket description, this ticket greatly speeds up constructing Dirichlet groups over number fields.

> 
> I assume that this is the main motivation for making `zeta` optional, right? I am not really convinced though that this extra complexity is needed...

This is not really true; it also makes more sense conceptually if one does not have to make a choice of root of unity.  I think the problems related to base extension do deserve to be solved and are at least as important as the speed-up.
> It is true that `zeta()` for number fields is slow, but that can easily be improved (#18917).

It would be great if it could, but when making a speed improvement to `zeta()` in #15486, I found out that it was necessary to avoid calling PARI's `nfinit()`, because it was too slow for the number fields involved.  This unfortunately precludes using PARI's `nfrootsof1()`...



---

archive/issue_comments_052553.json:
```json
{
    "body": "<a id='comment:26'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a\">1431319</a></td><td><code>Trac 6018: improve repr() of Dirichlet groups</code></td></tr></table>\n",
    "created_at": "2015-07-20T16:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a">1431319</a></td><td><code>Trac 6018: improve repr() of Dirichlet groups</code></td></tr></table>




---

archive/issue_comments_052554.json:
```json
{
    "body": "**Changing commit** from \"[d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c](https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c)\" to \"[1431319a94f2c5d221e9018d3e6b150e5548fb5a](https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a)\".",
    "created_at": "2015-07-20T16:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52554",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c](https://github.com/sagemath/sagetrac-mirror/commit/d0bb0e4bc7c13e5b6b8a4c6d188b65b6d501eb2c)" to "[1431319a94f2c5d221e9018d3e6b150e5548fb5a](https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a)".



---

archive/issue_comments_052555.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A23):\n> This is just a detail, but instead of\n> \n> ```\n> Group of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a\n> ```\n> I would prefer\n> \n> ```\n> Group of Dirichlet characters of modulus 5 with values in the group of order 8 generated by a over Number Field in a with defining polynomial x^4 + 1\n> ```\n\nI took the opportunity to make a more general improvement to the wording; the format is now\n\n```\nGroup of Dirichlet characters modulo N with values in [the group of order M generated by Z in ]R",
    "created_at": "2015-07-20T16:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52555",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A23):
> This is just a detail, but instead of
> 
> ```
> Group of Dirichlet characters of modulus 5 over Number Field in a with defining polynomial x^4 + 1 with values in the group of order 8 generated by a
> ```
> I would prefer
> 
> ```
> Group of Dirichlet characters of modulus 5 with values in the group of order 8 generated by a over Number Field in a with defining polynomial x^4 + 1
> ```

I took the opportunity to make a more general improvement to the wording; the format is now

```
Group of Dirichlet characters modulo N with values in [the group of order M generated by Z in ]R



---

archive/issue_comments_052556.json:
```json
{
    "body": "<a id='comment:28'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228\">36dcdc3</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>\n",
    "created_at": "2016-01-22T00:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52556",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228">36dcdc3</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>




---

archive/issue_comments_052557.json:
```json
{
    "body": "**Changing commit** from \"[1431319a94f2c5d221e9018d3e6b150e5548fb5a](https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a)\" to \"[36dcdc3f41690cc74fd3cae39e869bd898605228](https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228)\".",
    "created_at": "2016-01-22T00:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52557",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1431319a94f2c5d221e9018d3e6b150e5548fb5a](https://github.com/sagemath/sagetrac-mirror/commit/1431319a94f2c5d221e9018d3e6b150e5548fb5a)" to "[36dcdc3f41690cc74fd3cae39e869bd898605228](https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228)".



---

archive/issue_comments_052558.json:
```json
{
    "body": "<a id='comment:29'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf\">08052f9</a></td><td><code>Trac 6018: replace arith.gcd() and arith.lcm() by gcd() and lcm()</code></td></tr></table>\n",
    "created_at": "2016-01-22T08:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52558",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf">08052f9</a></td><td><code>Trac 6018: replace arith.gcd() and arith.lcm() by gcd() and lcm()</code></td></tr></table>




---

archive/issue_comments_052559.json:
```json
{
    "body": "**Changing commit** from \"[36dcdc3f41690cc74fd3cae39e869bd898605228](https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228)\" to \"[08052f9be7cffccc5f9795bc78153cb2bee58eaf](https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf)\".",
    "created_at": "2016-01-22T08:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52559",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[36dcdc3f41690cc74fd3cae39e869bd898605228](https://github.com/sagemath/sagetrac-mirror/commit/36dcdc3f41690cc74fd3cae39e869bd898605228)" to "[08052f9be7cffccc5f9795bc78153cb2bee58eaf](https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf)".



---

archive/issue_comments_052560.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d\">cbc5d7f</a></td><td><code>Trac 6018: fix doctest failures</code></td></tr></table>\n",
    "created_at": "2016-01-22T14:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52560",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d">cbc5d7f</a></td><td><code>Trac 6018: fix doctest failures</code></td></tr></table>




---

archive/issue_comments_052561.json:
```json
{
    "body": "**Changing commit** from \"[08052f9be7cffccc5f9795bc78153cb2bee58eaf](https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf)\" to \"[cbc5d7fac5807c2ce284ce722231f9fe8c37f90d](https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d)\".",
    "created_at": "2016-01-22T14:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52561",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[08052f9be7cffccc5f9795bc78153cb2bee58eaf](https://github.com/sagemath/sagetrac-mirror/commit/08052f9be7cffccc5f9795bc78153cb2bee58eaf)" to "[cbc5d7fac5807c2ce284ce722231f9fe8c37f90d](https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d)".



---

archive/issue_comments_052562.json:
```json
{
    "body": "<a id='comment:31'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad\">3b51d5d</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>\n",
    "created_at": "2016-02-25T23:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52562",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad">3b51d5d</a></td><td><code>Merge branch 'develop' into ticket/6018-DirichletGroup_zeta</code></td></tr></table>




---

archive/issue_comments_052563.json:
```json
{
    "body": "**Changing commit** from \"[cbc5d7fac5807c2ce284ce722231f9fe8c37f90d](https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d)\" to \"[3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)\".",
    "created_at": "2016-02-25T23:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52563",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[cbc5d7fac5807c2ce284ce722231f9fe8c37f90d](https://github.com/sagemath/sagetrac-mirror/commit/cbc5d7fac5807c2ce284ce722231f9fe8c37f90d)" to "[3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)".



---

archive/issue_comments_052564.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2016-03-25T00:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52564",
    "user": "https://github.com/adeines"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_052565.json:
```json
{
    "body": "**Reviewer:** Aly Deines",
    "created_at": "2016-03-25T00:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52565",
    "user": "https://github.com/adeines"
}
```

**Reviewer:** Aly Deines



---

archive/issue_comments_052566.json:
```json
{
    "body": "<a id='comment:32'></a>\nLooks good to me.",
    "created_at": "2016-03-25T00:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52566",
    "user": "https://github.com/adeines"
}
```

<a id='comment:32'></a>
Looks good to me.



---

archive/issue_comments_052567.json:
```json
{
    "body": "**Changing keywords** from \"Dirichlet characters\" to \"Dirichlet characters, days71\".",
    "created_at": "2016-03-25T00:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52567",
    "user": "https://github.com/adeines"
}
```

**Changing keywords** from "Dirichlet characters" to "Dirichlet characters, days71".



---

archive/issue_comments_052568.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2016-03-25T17:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52568",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_052569.json:
```json
{
    "body": "<a id='comment:33'></a>\nDoctests fail",
    "created_at": "2016-03-25T17:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52569",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>
Doctests fail



---

archive/issue_comments_052570.json:
```json
{
    "body": "<a id='comment:34'></a>\nhttp://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/439/steps/shell_4/logs/stdio",
    "created_at": "2016-03-25T17:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52570",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>
http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/439/steps/shell_4/logs/stdio



---

archive/issue_comments_052571.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [vbraun](#comment%3A34):\n> http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/439/steps/shell_4/logs/stdio\n\nFrom the failing doctest in `cachefunc.pyx`, it seems that #15692 is also merged in that branch; I suspect the failure is actually due to that ticket (cf. [comment:48](#comment%3A48):ticket:15692).",
    "created_at": "2016-03-26T09:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52571",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:35'></a>
Replying to [vbraun](#comment%3A34):
> http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/439/steps/shell_4/logs/stdio

From the failing doctest in `cachefunc.pyx`, it seems that #15692 is also merged in that branch; I suspect the failure is actually due to that ticket (cf. [comment:48](#comment%3A48):ticket:15692).



---

archive/issue_comments_052572.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2016-03-26T09:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52572",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_events_017802.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-03-27T07:44:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/6018#event-17802"
}
```



---

archive/issue_comments_052573.json:
```json
{
    "body": "**Changing branch** from \"[u/pbruin/6018-DirichletGroup_zeta](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/6018-DirichletGroup_zeta)\" to \"[3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)\".",
    "created_at": "2016-03-27T07:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/6018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/6018#issuecomment-52573",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/pbruin/6018-DirichletGroup_zeta](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/6018-DirichletGroup_zeta)" to "[3b51d5d1df89e46e310e0bbc985c73ae06e01bad](https://github.com/sagemath/sagetrac-mirror/commit/3b51d5d1df89e46e310e0bbc985c73ae06e01bad)".
