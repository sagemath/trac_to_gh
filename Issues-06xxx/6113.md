# Issue 6113: segfault in division_points and factoring torsion_polynomial

archive/issues_006113.json:
```json
{
    "body": "John Cremona reports:\n\nIn 4.0.alpha0, this causes a segmentation fault:\n\n```\n----------------------------------------------------------------------\n| Sage Version 4.0.alpha0, Release Date: 2009-05-15                  |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: K.<a>=NumberField(x^2-x+22)\nsage: w=-13*a-14\nsage: E=EllipticCurve([0,0,0,0,-1728*w])\nsage: P1 = E.lift_x(-3*a-66)\nsage: P2 = E.lift_x((-21*a-93)/4)\nsage: P2.division_points(19)\n```\n\nIt works fine to do\n\n```\nsage: g = P2.division_points(19, poly_only=True)\n```\nwhich defines a polynomial of degree 361 over Q(sqrt(-87)), but then\ng.roots() goes Boom.\n\nncalexan verified this on Mac OS X; it looks like the crash is in an NTL function:\n\n```\n(gdb) bt\n#0  0x01293247 in modii ()\n#1  0x014278bc in FpX_red ()\n```\n\n**CC:**  jcremona\n\n**Keywords:** segfault division points torsion polynomial\n\nIssue created by migration from https://trac.sagemath.org/ticket/6113\n\n",
    "closed_at": "2010-10-03T16:27:00Z",
    "created_at": "2009-05-21T15:41:55Z",
    "labels": [
        "component: elliptic curves",
        "bug",
        "duplicate"
    ],
    "title": "segfault in division_points and factoring torsion_polynomial",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/6113",
    "user": "https://github.com/ncalexan"
}
```
John Cremona reports:

In 4.0.alpha0, this causes a segmentation fault:

```
----------------------------------------------------------------------
| Sage Version 4.0.alpha0, Release Date: 2009-05-15                  |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: K.<a>=NumberField(x^2-x+22)
sage: w=-13*a-14
sage: E=EllipticCurve([0,0,0,0,-1728*w])
sage: P1 = E.lift_x(-3*a-66)
sage: P2 = E.lift_x((-21*a-93)/4)
sage: P2.division_points(19)
```

It works fine to do

```
sage: g = P2.division_points(19, poly_only=True)
```
which defines a polynomial of degree 361 over Q(sqrt(-87)), but then
g.roots() goes Boom.

ncalexan verified this on Mac OS X; it looks like the crash is in an NTL function:

```
(gdb) bt
#0  0x01293247 in modii ()
#1  0x014278bc in FpX_red ()
```

**CC:**  jcremona

**Keywords:** segfault division points torsion polynomial

Issue created by migration from https://trac.sagemath.org/ticket/6113





---

archive/issue_comments_041745.json:
```json
{
    "body": "<a id='comment:1'></a>\nNick, do you know what the roots function is actually doing in this case (univariate poly over a number field)?  I think it is calling factor(), but NTL has no support for polynomials over number fields so I thought it must be calling pari after that.",
    "created_at": "2009-05-21T15:48:31Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41745",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
Nick, do you know what the roots function is actually doing in this case (univariate poly over a number field)?  I think it is calling factor(), but NTL has no support for polynomials over number fields so I thought it must be calling pari after that.



---

archive/issue_comments_041746.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [cremona](#comment%3A1):\n> Nick, do you know what the roots function is actually doing in this case (univariate poly over a number field)?  I think it is calling factor(), but NTL has no support for polynomials over number fields so I thought it must be calling pari after that.\n\n\nI recently ran into a similar problem trying to factor over the field generated by the hilbert class polynomial over QQ. For small degree (< 50 or so) it's okay but for larger degree polynomials it gives a segmentation fault with PARI. If there's a way I can help here and get a patch up for this I want to know about it!",
    "created_at": "2009-06-23T01:24:30Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41746",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```

<a id='comment:2'></a>
Replying to [cremona](#comment%3A1):
> Nick, do you know what the roots function is actually doing in this case (univariate poly over a number field)?  I think it is calling factor(), but NTL has no support for polynomials over number fields so I thought it must be calling pari after that.


I recently ran into a similar problem trying to factor over the field generated by the hilbert class polynomial over QQ. For small degree (< 50 or so) it's okay but for larger degree polynomials it gives a segmentation fault with PARI. If there's a way I can help here and get a patch up for this I want to know about it!



---

archive/issue_comments_041747.json:
```json
{
    "body": "<a id='comment:3'></a>\nIf we can come up with an example which fails in gp then it would be easy to send a bug report to the pari developers.  It is harder if we can only get the error using the pari library, since then they might want a C program in the report.  I think (quite reasonably) that the pari developers cannot be expected to debug things which can only be demonstrated in a Sage run -- even if the use of pari in Sage has increased the number of pari users worldwide by a lot!",
    "created_at": "2009-06-23T08:30:31Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41747",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>
If we can come up with an example which fails in gp then it would be easy to send a bug report to the pari developers.  It is harder if we can only get the error using the pari library, since then they might want a C program in the report.  I think (quite reasonably) that the pari developers cannot be expected to debug things which can only be demonstrated in a Sage run -- even if the use of pari in Sage has increased the number of pari users worldwide by a lot!



---

archive/issue_comments_041748.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [cremona](#comment%3A3):\n> If we can come up with an example which fails in gp then it would be easy to send a bug report to the pari developers.  It is harder if we can only get the error using the pari library, since then they might want a C program in the report.  I think (quite reasonably) that the pari developers cannot be expected to debug things which can only be demonstrated in a Sage run -- even if the use of pari in Sage has increased the number of pari users worldwide by a lot!\n\n\nWell, I ran it on gp and it worked just fine. The results are included in the text file I've attached along with the same example failing in sage. When I -gdb it I get pointed to /usr/local/sage/local/LIB/libpari-gmp.so.2\n\nThat in addition to the fact that the code for factoring a univariate polynomial over a number field appears to essentially consist of \"make PARI do it\" is why it appeared that PARI was causing the SegFault.",
    "created_at": "2009-06-23T15:29:52Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41748",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```

<a id='comment:4'></a>
Replying to [cremona](#comment%3A3):
> If we can come up with an example which fails in gp then it would be easy to send a bug report to the pari developers.  It is harder if we can only get the error using the pari library, since then they might want a C program in the report.  I think (quite reasonably) that the pari developers cannot be expected to debug things which can only be demonstrated in a Sage run -- even if the use of pari in Sage has increased the number of pari users worldwide by a lot!


Well, I ran it on gp and it worked just fine. The results are included in the text file I've attached along with the same example failing in sage. When I -gdb it I get pointed to /usr/local/sage/local/LIB/libpari-gmp.so.2

That in addition to the fact that the code for factoring a univariate polynomial over a number field appears to essentially consist of "make PARI do it" is why it appeared that PARI was causing the SegFault.



---

archive/attachments_007470.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "ProblematicPari.txt",
    "asset_url": "tarball://root/attachments/ticket6113/ProblematicPari.txt",
    "created_at": "2009-06-23T15:31:11Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket6113/ProblematicPari.txt",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```



---

archive/issue_comments_041749.json:
```json
{
    "body": "**Attachment:** [ProblematicPari.txt](https://github.com/sagemath/sage/files/ticket6113/ProblematicPari.txt)\n\nA run of identical jobs, one in gp which succeeds and one in sage which results in a SegFault",
    "created_at": "2009-06-23T15:31:11Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41749",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```

**Attachment:** [ProblematicPari.txt](https://github.com/sagemath/sage/files/ticket6113/ProblematicPari.txt)

A run of identical jobs, one in gp which succeeds and one in sage which results in a SegFault



---

archive/attachments_007471.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "nffactorsegfault.txt",
    "asset_url": "tarball://root/attachments/ticket6113/nffactorsegfault.txt",
    "created_at": "2009-06-25T19:59:10Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket6113/nffactorsegfault.txt",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```



---

archive/issue_comments_041750.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Attachment:** [nffactorsegfault.txt](https://github.com/sagemath/sage/files/ticket6113/nffactorsegfault.txt)\n\nReplying to [stankewicz](#comment%3A4):\n\nAh ha!. The problem is nonexistent with factornf, but that uses a different algorithm than nffactor, which is the pari command that sage uses for factoring. This is indeed a problem with Pari and will be reported.\n\nWould it be possible to call factornf through gp and pull the factorization back to sage?",
    "created_at": "2009-06-25T19:59:10Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41750",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```

<a id='comment:5'></a>
**Attachment:** [nffactorsegfault.txt](https://github.com/sagemath/sage/files/ticket6113/nffactorsegfault.txt)

Replying to [stankewicz](#comment%3A4):

Ah ha!. The problem is nonexistent with factornf, but that uses a different algorithm than nffactor, which is the pari command that sage uses for factoring. This is indeed a problem with Pari and will be reported.

Would it be possible to call factornf through gp and pull the factorization back to sage?



---

archive/issue_comments_041751.json:
```json
{
    "body": "<a id='comment:6'></a>\nhttp://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=979\n\nAt the next upgrade of PARI this problem should be fixed(it's already fixed in the unstable version).",
    "created_at": "2009-06-29T16:50:58Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41751",
    "user": "https://trac.sagemath.org/admin/accounts/users/stankewicz"
}
```

<a id='comment:6'></a>
http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=979

At the next upgrade of PARI this problem should be fixed(it's already fixed in the unstable version).



---

archive/issue_comments_041752.json:
```json
{
    "body": "**Changing assignee** from @williamstein to @loefflerd.",
    "created_at": "2009-07-21T08:15:22Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41752",
    "user": "https://github.com/loefflerd"
}
```

**Changing assignee** from @williamstein to @loefflerd.



---

archive/issue_events_039683.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2009-07-21T08:15:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "label": "component: number theory",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6113#event-39683"
}
```



---

archive/issue_events_039684.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2009-07-21T08:15:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "label": "component: elliptic curves",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6113#event-39684"
}
```



---

archive/issue_comments_041753.json:
```json
{
    "body": "**Remove assignee** @loefflerd.",
    "created_at": "2009-10-09T09:09:25Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41753",
    "user": "https://github.com/loefflerd"
}
```

**Remove assignee** @loefflerd.



---

archive/issue_comments_041754.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis probably has the same cause as #7097:  see the comments there.  I am going to check if the patch I put up there works here too.",
    "created_at": "2009-12-30T18:25:02Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41754",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
This probably has the same cause as #7097:  see the comments there.  I am going to check if the patch I put up there works here too.



---

archive/issue_comments_041755.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [cremona](#comment%3A9):\n> This probably has the same cause as #7097:  see the comments there.  I am going to check if the patch I put up there works here too.\n\nIt does not...",
    "created_at": "2009-12-30T18:32:05Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41755",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>
Replying to [cremona](#comment%3A9):
> This probably has the same cause as #7097:  see the comments there.  I am going to check if the patch I put up there works here too.

It does not...



---

archive/issue_comments_041756.json:
```json
{
    "body": "<a id='comment:11'></a>\nIn 4.6.alpha1:\n\n```\n\nsage: K.<a>=NumberField(x^2-x+22)\nsage: sage: w=-13*a-14\nsage: sage: E=EllipticCurve([0,0,0,0,-1728*w])\nsage: sage: P1 = E.lift_x(-3*a-66)\nsage: sage: P2 = E.lift_x((-21*a-93)/4)\nsage: sage: P2.division_points(19)\n[]\nsage: g = P2.division_points(19, poly_only=True)\nsage: g.roots()\n[]\n```\nso this can be closed as fixed.",
    "created_at": "2010-10-03T16:27:00Z",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/6113#issuecomment-41756",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:11'></a>
In 4.6.alpha1:

```

sage: K.<a>=NumberField(x^2-x+22)
sage: sage: w=-13*a-14
sage: sage: E=EllipticCurve([0,0,0,0,-1728*w])
sage: sage: P1 = E.lift_x(-3*a-66)
sage: sage: P2 = E.lift_x((-21*a-93)/4)
sage: sage: P2.division_points(19)
[]
sage: g = P2.division_points(19, poly_only=True)
sage: g.roots()
[]
```
so this can be closed as fixed.



---

archive/issue_events_039685.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-10-03T16:27:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6113#event-39685"
}
```



---

archive/issue_events_039686.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-09T00:05:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "milestone": "sage-4.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6113#event-39686"
}
```



---

archive/issue_events_039687.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-09T00:05:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/6113",
    "label": "duplicate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/6113#event-39687"
}
```
