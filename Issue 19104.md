# Issue 19104: Cleaning/Fix in combinat/matrices/hadamard_matrix

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2015-10-03 21:50:07

CC:  dimpase

As the title says. Generalizes the existing constructions, and fixes a bug in normalised_hadamard.

Nathann


---

Comment by ncohen created at 2015-10-03 21:51:20

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-10-03 21:51:20

New commits:


---

Comment by git created at 2015-10-03 22:06:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-10-04 23:51:48

I pushed a branch at u/vdelecroix/19340 with one commit which creates a function hadamard_matrix_flint using flint.


---

Comment by ncohen created at 2015-10-05 07:11:10

Then you will also have ton integrate it into `hadamard_matrix` if you want it to be merged with this branch. You can then write a doctest to compare it with the 'current' (i.e. after this branch) implementation of the paley matrices, which should be correct (but slower) now.

Nathann


---

Comment by dimpase created at 2015-10-14 18:10:57

please don't use the coersion, unless really needed:

```
sage: # your implementation:
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')
5 loops, best of 3: 269 ms per loop
sage: # a direct one:
sage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')
25 loops, best of 3: 27.9 ms per loop
```

(this timing is for `p=3^5`)


---

Comment by ncohen created at 2015-10-14 18:13:10

How am I supposed to write it instead?


---

Comment by ncohen created at 2015-10-14 18:14:07

`O_o`

Really?... That's only because of float->ZZ ? `O_o`


---

Comment by dimpase created at 2015-10-14 18:19:20

Replying to [comment:6 ncohen]:
> How am I supposed to write it instead?

```
1 if (x-y).is_square() else -1
```

instead of 

```
2*((x-y).is_square()-.5)
```


much more readable too... ;-)


---

Comment by ncohen created at 2015-10-14 18:20:12

What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`


---

Comment by ncohen created at 2015-10-14 18:21:23

Anyway. You are right. But I really did not expect such a diffrence `O_o`

Nathann


---

Comment by dimpase created at 2015-10-14 18:23:18

Replying to [comment:9 ncohen]:
> What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`

`python_digesting_a_rabbit`

well, there is also a float involved...


---

Comment by git created at 2015-10-14 18:23:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-10-14 18:32:53

why are there tests marked `# random` ?


---

Comment by dimpase created at 2015-10-14 18:36:22

by the way, `bool` is only a smaller part of the slowness:

```
sage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')
25 loops, best of 3: 27.9 ms per loop
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-5) for x in K_list] for y in K_list])')
5 loops, best of 3: 57.1 ms per loop
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')
5 loops, best of 3: 265 ms per loop
```

appearance of `float` causes most of the slowness.


---

Comment by dimpase created at 2015-10-14 18:58:08

Replying to [comment:13 dimpase]:
> why are there tests marked `# random` ?

the only possible source of randomness here I can imagine is in the construction of
the finite fields. But if you add `conway=True` then it's deterministic for sure, for Conway polynomial is unique for any given order...


---

Comment by ncohen created at 2015-10-14 19:21:48

The random is indeed caused by the finite field, and the order in which the elements are enumerated. Also these functions are now tested heavily, so whatever is returned by those functions should be what the user expects.


---

Comment by dimpase created at 2015-10-14 19:43:17

OK, let's deal with FLINT matrices on another ticket.


---

Comment by dimpase created at 2015-10-14 19:43:17

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-10-15 06:15:00

Yep. At least it is correct now.

Thanks,

Nathann


---

Comment by vbraun created at 2015-10-16 08:22:17

Resolution: fixed
