# Issue 23355: Faster comparison of manifold points

archive/issues_023355.json:
```json
{
    "body": "CC:  karimvanaelst tscrim\n\nKeywords: manifold point\n\nComparison of manifold points, as implemented in `ManifoldPoint.__eq__`, relies on comparison of coordinate values in a common chart. When coordinates are symbolic, this goes through Maxima and can take a lot of time. Now, comparison of points is involved in the unique representation of tangent spaces. When many tangent spaces are created (as for instance when plotting a vector field), this has a non-neglible cost. This ticket makes `ManifoldPoint.__eq__` faster by invoking `(a-b).is_trivial_zero()` when `a` and `b` are symbolic coordinates of two points, while the previous version was using `a == b`. Note that for non-symbolic values (i.e. numerical values), `a == b` is still used.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23592\n\n",
    "created_at": "2017-08-07T20:26:22Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "title": "Faster comparison of manifold points",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23355",
    "user": "egourgoulhon"
}
```
CC:  karimvanaelst tscrim

Keywords: manifold point

Comparison of manifold points, as implemented in `ManifoldPoint.__eq__`, relies on comparison of coordinate values in a common chart. When coordinates are symbolic, this goes through Maxima and can take a lot of time. Now, comparison of points is involved in the unique representation of tangent spaces. When many tangent spaces are created (as for instance when plotting a vector field), this has a non-neglible cost. This ticket makes `ManifoldPoint.__eq__` faster by invoking `(a-b).is_trivial_zero()` when `a` and `b` are symbolic coordinates of two points, while the previous version was using `a == b`. Note that for non-symbolic values (i.e. numerical values), `a == b` is still used.

Issue created by migration from https://trac.sagemath.org/ticket/23592





---

archive/issue_comments_326880.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-08-07T20:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326880",
    "user": "egourgoulhon"
}
```

New commits:



---

archive/issue_comments_326881.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-07T20:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326881",
    "user": "egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_326882.json:
```json
{
    "body": "Shouldn't you also short-circuit the for loop in case you ever get False?",
    "created_at": "2017-08-07T20:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326882",
    "user": "roed"
}
```

Shouldn't you also short-circuit the for loop in case you ever get False?



---

archive/issue_comments_326883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-07T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326883",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_326884.json:
```json
{
    "body": "Replying to [comment:3 roed]:\n> Shouldn't you also short-circuit the for loop in case you ever get False?\nYou are perfectly right! Thanks for pointing this. The latest commit takes it into account.",
    "created_at": "2017-08-07T20:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326884",
    "user": "egourgoulhon"
}
```

Replying to [comment:3 roed]:
> Shouldn't you also short-circuit the for loop in case you ever get False?
You are perfectly right! Thanks for pointing this. The latest commit takes it into account.



---

archive/issue_comments_326885.json:
```json
{
    "body": "The only other comment that I have is that you have three nested if statements, e.g.\n\n```python\nif isinstance(diff_c, Expression):\n    if not diff_c.is_trivial_zero():\n        return False\n```\n\n\nI think it's clearer if such statements are phrased as\n\n```python\nif isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n    return False\n```\n\nsince there are fewer nested blocks this way.\n\nOther than that, looks good once tests pass!",
    "created_at": "2017-08-07T21:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326885",
    "user": "roed"
}
```

The only other comment that I have is that you have three nested if statements, e.g.

```python
if isinstance(diff_c, Expression):
    if not diff_c.is_trivial_zero():
        return False
```


I think it's clearer if such statements are phrased as

```python
if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
    return False
```

since there are fewer nested blocks this way.

Other than that, looks good once tests pass!



---

archive/issue_comments_326886.json:
```json
{
    "body": "Replying to [comment:6 roed]:\n> The only other comment that I have is that you have three nested if statements, e.g.\n> {{{\n> #!python\n> if isinstance(diff_c, Expression):\n>     if not diff_c.is_trivial_zero():\n>         return False\n> }}}\n> \n> I think it's clearer if such statements are phrased as\n> {{{\n> #!python\n> if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n>     return False\n> }}}\n> since there are fewer nested blocks this way.\n> \n\nI wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only \nif the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)\n\n> Other than that, looks good once tests pass!\n\nThe failures reported by the patchbot do not pertain to this ticket; on my computer all tests passed within Sage 8.1.beta1.",
    "created_at": "2017-08-07T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326886",
    "user": "egourgoulhon"
}
```

Replying to [comment:6 roed]:
> The only other comment that I have is that you have three nested if statements, e.g.
> {{{
> #!python
> if isinstance(diff_c, Expression):
>     if not diff_c.is_trivial_zero():
>         return False
> }}}
> 
> I think it's clearer if such statements are phrased as
> {{{
> #!python
> if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
>     return False
> }}}
> since there are fewer nested blocks this way.
> 

I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)

> Other than that, looks good once tests pass!

The failures reported by the patchbot do not pertain to this ticket; on my computer all tests passed within Sage 8.1.beta1.



---

archive/issue_comments_326887.json:
```json
{
    "body": "Replying to [comment:7 egourgoulhon]:\n> Replying to [comment:6 roed]:\n> > The only other comment that I have is that you have three nested if statements, e.g.\n> > {{{\n> > #!python\n> > if isinstance(diff_c, Expression):\n> >     if not diff_c.is_trivial_zero():\n> >         return False\n> > }}}\n> > \n> > I think it's clearer if such statements are phrased as\n> > {{{\n> > #!python\n> > if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n> >     return False\n> > }}}\n> > since there are fewer nested blocks this way.\n> > \n> \n> I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only \n> if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)\n\nYep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.",
    "created_at": "2017-08-07T23:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326887",
    "user": "roed"
}
```

Replying to [comment:7 egourgoulhon]:
> Replying to [comment:6 roed]:
> > The only other comment that I have is that you have three nested if statements, e.g.
> > {{{
> > #!python
> > if isinstance(diff_c, Expression):
> >     if not diff_c.is_trivial_zero():
> >         return False
> > }}}
> > 
> > I think it's clearer if such statements are phrased as
> > {{{
> > #!python
> > if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
> >     return False
> > }}}
> > since there are fewer nested blocks this way.
> > 
> 
> I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
> if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)

Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.



---

archive/issue_comments_326888.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-08T10:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326888",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_326889.json:
```json
{
    "body": "Replying to [comment:8 roed]:\n> Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.\n\nVery good, thanks. I've updated the code accordingly. I've also slightly simplified it, since there was no need to create a list of coordinate differences.",
    "created_at": "2017-08-08T10:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326889",
    "user": "egourgoulhon"
}
```

Replying to [comment:8 roed]:
> Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.

Very good, thanks. I've updated the code accordingly. I've also slightly simplified it, since there was no need to create a list of coordinate differences.



---

archive/issue_comments_326890.json:
```json
{
    "body": "The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.\n\nLooks good to me.",
    "created_at": "2017-08-09T07:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326890",
    "user": "roed"
}
```

The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.

Looks good to me.



---

archive/issue_comments_326891.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-09T07:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326891",
    "user": "roed"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_326892.json:
```json
{
    "body": "Replying to [comment:11 roed]:\n> The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.\n> \n> Looks good to me.\n\nThanks for the review!",
    "created_at": "2017-08-09T09:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326892",
    "user": "egourgoulhon"
}
```

Replying to [comment:11 roed]:
> The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.
> 
> Looks good to me.

Thanks for the review!



---

archive/issue_comments_326893.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-11T18:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23355",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23355#issuecomment-326893",
    "user": "vbraun"
}
```

Resolution: fixed
