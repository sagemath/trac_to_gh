# Issue 23355: Faster comparison of manifold points

Issue created by migration from Trac.

Original creator: egourgoulhon

Original creation time: 2017-08-07 20:26:22

CC:  karimvanaelst tscrim

Keywords: manifold point

Comparison of manifold points, as implemented in `ManifoldPoint.__eq__`, relies on comparison of coordinate values in a common chart. When coordinates are symbolic, this goes through Maxima and can take a lot of time. Now, comparison of points is involved in the unique representation of tangent spaces. When many tangent spaces are created (as for instance when plotting a vector field), this has a non-neglible cost. This ticket makes `ManifoldPoint.__eq__` faster by invoking `(a-b).is_trivial_zero()` when `a` and `b` are symbolic coordinates of two points, while the previous version was using `a == b`. Note that for non-symbolic values (i.e. numerical values), `a == b` is still used.


---

Comment by egourgoulhon created at 2017-08-07 20:29:47

New commits:


---

Comment by egourgoulhon created at 2017-08-07 20:31:19

Changing status from new to needs_review.


---

Comment by roed created at 2017-08-07 20:34:00

Shouldn't you also short-circuit the for loop in case you ever get False?


---

Comment by git created at 2017-08-07 20:56:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-08-07 20:57:48

Replying to [comment:3 roed]:
> Shouldn't you also short-circuit the for loop in case you ever get False?
You are perfectly right! Thanks for pointing this. The latest commit takes it into account.


---

Comment by roed created at 2017-08-07 21:18:40

The only other comment that I have is that you have three nested if statements, e.g.

```python
if isinstance(diff_c, Expression):
    if not diff_c.is_trivial_zero():
        return False
```


I think it's clearer if such statements are phrased as

```python
if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
    return False
```

since there are fewer nested blocks this way.

Other than that, looks good once tests pass!


---

Comment by egourgoulhon created at 2017-08-07 22:56:12

Replying to [comment:6 roed]:
> The only other comment that I have is that you have three nested if statements, e.g.
> {{{
> #!python
> if isinstance(diff_c, Expression):
>     if not diff_c.is_trivial_zero():
>         return False
> }}}
> 
> I think it's clearer if such statements are phrased as
> {{{
> #!python
> if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
>     return False
> }}}
> since there are fewer nested blocks this way.
> 

I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)

> Other than that, looks good once tests pass!

The failures reported by the patchbot do not pertain to this ticket; on my computer all tests passed within Sage 8.1.beta1.


---

Comment by roed created at 2017-08-07 23:17:21

Replying to [comment:7 egourgoulhon]:
> Replying to [comment:6 roed]:
> > The only other comment that I have is that you have three nested if statements, e.g.
> > {{{
> > #!python
> > if isinstance(diff_c, Expression):
> >     if not diff_c.is_trivial_zero():
> >         return False
> > }}}
> > 
> > I think it's clearer if such statements are phrased as
> > {{{
> > #!python
> > if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
> >     return False
> > }}}
> > since there are fewer nested blocks this way.
> > 
> 
> I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
> if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)

Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.


---

Comment by git created at 2017-08-08 10:02:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-08-08 10:05:43

Replying to [comment:8 roed]:
> Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.

Very good, thanks. I've updated the code accordingly. I've also slightly simplified it, since there was no need to create a list of coordinate differences.


---

Comment by roed created at 2017-08-09 07:02:11

The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.

Looks good to me.


---

Comment by roed created at 2017-08-09 07:02:11

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2017-08-09 09:11:09

Replying to [comment:11 roed]:
> The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.
> 
> Looks good to me.

Thanks for the review!


---

Comment by vbraun created at 2017-08-11 18:17:32

Resolution: fixed
