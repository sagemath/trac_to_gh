# Issue 23469: gap class for matrices

Issue created by migration from https://trac.sagemath.org/ticket/23706

Original creator: vdelecroix

Original creation time: 2017-08-25 00:05:44

CC:  jipilab simonking

Implement a generic matrix class using libgap as a backend and revamp the `MatrixSpace` constructor in order to be able to choose the implementation.


---

Comment by vdelecroix created at 2017-08-25 00:08:01

Changing keywords from "" to "sd88".


---

Comment by jipilab created at 2017-08-25 02:16:10

Changing keywords from "sd88" to "days88".


---

Comment by vdelecroix created at 2017-08-25 02:17:39

experimental branch ready!
----
New commits:


---

Comment by jipilab created at 2017-08-25 02:32:31

The title of the ticket could be a bit more specific.


---

Comment by git created at 2017-08-25 02:49:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-08-25 03:49:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 03:52:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 04:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 04:27:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 21:13:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-08-25 21:14:01

Changing status from new to needs_review.


---

Comment by git created at 2017-08-25 21:40:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-08-25 21:56:14

hum... got a lot of failures

```
combinat/root_system/root_lattice_realizations.py  # 1 doctest failed
combinat/root_system/root_system.py  # 1 doctest failed
combinat/root_system/weight_space.py  # 3 doctests failed
combinat/root_system/type_affine.py  # 3 doctests failed
combinat/root_system/ambient_space.py  # 1 doctest failed
combinat/root_system/root_space.py  # 1 doctest failed
combinat/root_system/cartan_type.py  # 2 doctests failed
categories/crystals.py  # 2 doctests failed
combinat/root_system/weight_lattice_realizations.py  # 12 doctests failed
combinat/root_system/cartan_matrix.py  # 5 doctests failed
combinat/root_system/type_relabel.py  # 1 doctest failed
combinat/root_system/dynkin_diagram.py  # 4 doctests failed
combinat/root_system/type_marked.py  # 1 doctest failed
combinat/root_system/type_reducible.py  # 2 doctests failed
```



---

Comment by vdelecroix created at 2017-08-25 22:35:08

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-08-25 22:35:08

Needs to fix #23721 first.


---

Comment by git created at 2017-09-03 17:44:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-09-03 17:47:01

I postponed the introduction of `Matrix_gap` in ticket #23714


---

Comment by vdelecroix created at 2017-09-03 17:47:01

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-09-03 17:53:11

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-09-03 17:53:11

... wrong commits


---

Comment by git created at 2017-09-03 20:53:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-09-03 20:57:31

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-09-03 21:04:52

JP, do you feel up for the review?


---

Comment by vdelecroix created at 2017-09-04 04:40:30

Fucking root systems

```
sage -t --long src/sage/combinat/root_system/cartan_type.py  # 2 doctests failed
sage -t --long src/sage/combinat/root_system/weight_lattice_realizations.py  # 12 doctests failed
sage -t --long src/sage/combinat/root_system/ambient_space.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/root_lattice_realizations.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/type_marked.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/type_reducible.py  # 2 doctests failed
sage -t --long src/sage/combinat/root_system/root_space.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/cartan_matrix.py  # 5 doctests failed
sage -t --long src/sage/combinat/root_system/dynkin_diagram.py  # 4 doctests failed
sage -t --long src/sage/combinat/root_system/weight_space.py  # 3 doctests failed
sage -t --long src/sage/combinat/root_system/type_relabel.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/type_affine.py  # 3 doctests failed
sage -t --long src/sage/combinat/root_system/root_system.py  # 1 doctest failed
sage -t --long src/sage/categories/crystals.py  # 2 doctests failed
```



---

Comment by git created at 2017-09-04 05:16:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-04 05:38:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-09-04 05:39:30

Cartan matrices are fixed... waiting for patchbot verdict again.


---

Comment by jipilab created at 2017-09-04 09:42:03

Ok, I'm "back on trac"!

I'll give a look at this today.

Where should I throw in the benchmarking script? I guess it is not a good idea to hard code the best implementation, but at least, in the tests, we could add some relevant benchmarks to keep track of the evolution?


---

Comment by jipilab created at 2017-09-04 13:20:50

In the description of the test:


```
+        Check that multiplication for matrices with different backends are not allowed::
```


I would also mention that sparsity is checked ( the reason why there is no X appearing in row 2, column 3...)

The changes in the CartanMatrix look good.

In one of the bot's report, I get an error here:


```
**********************************************************************
File "src/sage/matrix/matrix_gfpn_dense.pyx", line 1484, in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense._echelon_in_place_classical
Failed example:
    type(X)
Expected:
    <type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>
Got:
    <type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
**********************************************************************
```


Other errors look to be unrelated. I'm still looking into the changes.


---

Comment by jipilab created at 2017-09-04 13:40:26

I ran the test on the file `src/sage/matrix/matrix_gfpn_dense.pyx` and all tests passed...


---

Comment by jipilab created at 2017-09-04 14:36:47

Just did some pep8 corrections... Otherwise, it looks good. Perhaps we should wait to get a proper bot to go over the changes as they touch many files...
----
New commits:


---

Comment by vdelecroix created at 2017-09-04 16:16:45

Replying to [comment:34 jipilab]:
> I ran the test on the file `src/sage/matrix/matrix_gfpn_dense.pyx` and all tests passed...

This need to be fixed. It depends whether `meataxe` is installed or not.


---

Comment by vdelecroix created at 2017-09-04 16:46:34

New commits:


---

Comment by vdelecroix created at 2017-09-04 16:46:50

Much cleaner now!!


---

Comment by vdelecroix created at 2017-09-10 16:13:24

Replying to [comment:32 jipilab]:
> Ok, I'm "back on trac"!
> 
> I'll give a look at this today.
> 
> Where should I throw in the benchmarking script? I guess it is not a good idea to hard code the best implementation, but at least, in the tests, we could add some relevant benchmarks to keep track of the evolution?

Not here. You should open a new ticket (and you can add it to the follow-up list of this ticket). Moreover the concept of "best implementation" depends on what you intend to do (e.g. matrix multiplication, Gauss elimination, determinant, etc).


---

Comment by jipilab created at 2017-09-13 07:57:56

The ticket does not apply on beta5. I'm compiling b5 right now and I'll check if I can diagnose further. I have to install `meataxe` and checkout testing. Give my machine some time and I get back here!


---

Comment by jipilab created at 2017-09-13 07:59:48

Is there a dependency to #23721?


---

Comment by vdelecroix created at 2017-09-13 08:19:06

Replying to [comment:42 jipilab]:
> Is there a dependency to #23721?

Not that I know of...


---

Comment by vdelecroix created at 2017-09-13 08:21:59

Replying to [comment:41 jipilab]:
> The ticket does not apply on beta5. I'm compiling b5 right now and I'll check if I can diagnose further. I have to install `meataxe` and checkout testing. Give my machine some time and I get back here!

The problem comes from something that has changed in `matrix_space.py`. The merge is simple but I have to leave in 5 minutes... will fix that first thing this afternoon.


---

Comment by git created at 2017-09-13 12:30:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-09-13 12:31:50

Replying to [comment:44 vdelecroix]:
> Replying to [comment:41 jipilab]:
> > The ticket does not apply on beta5. I'm compiling b5 right now and I'll check if I can diagnose further. I have to install `meataxe` and checkout testing. Give my machine some time and I get back here!
> 
> The problem comes from something that has changed in `matrix_space.py`. The merge is simple but I have to leave in 5 minutes... will fix that first thing this afternoon.

Damn, I just read this comment... Hope I did not create any trouble.


---

Comment by vdelecroix created at 2017-09-13 12:34:24

It's ok.


---

Comment by jipilab created at 2017-09-14 06:30:33

There are some spurious doc errors, otherwise, it looks good.


---

Comment by git created at 2017-09-14 07:28:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-09-14 07:46:35

j'ai poussé... reste plus qu'à attendre les verdicts de madame patchbot.


---

Comment by vdelecroix created at 2017-10-24 15:54:33

New commits:


---

Comment by jdemeyer created at 2017-10-25 09:23:55

Conflicts with #24096


---

Comment by git created at 2017-11-11 19:09:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-11-11 19:10:56

rebased on 8.1.rc0


---

Comment by vdelecroix created at 2017-11-12 20:18:32

patchbot is happy! jipilab?


---

Comment by tscrim created at 2017-11-13 00:51:18

I have a few comments:

```diff
-    def matrix_space(self, nrows=None, ncols=None, sparse=None):
+    def matrix_space(self, nrows=None, ncols=None, sparse=True):
         r"""
         Return a matrix space over the integers.
 
         INPUT:
 
-        - ``nrows`` - number of rows
+        - ``nrows`` -- number of rows
 
-        - ``ncols`` - number of columns
+        - ``ncols`` -- number of columns
 
-        - ``sparse`` - (boolean) sparseness
+        - ``sparse`` -- (boolean) sparseness
 
         EXAMPLES::
 
             sage: cm = CartanMatrix(['A', 3])
             sage: cm.matrix_space()
             Full MatrixSpace of 3 by 3 sparse matrices over Integer Ring
             sage: cm.matrix_space(2, 2)
             Full MatrixSpace of 2 by 2 sparse matrices over Integer Ring
             sage: cm[:2,1:]   # indirect doctest
             [-1  0]
             [ 2 -1]
         """
         if nrows is None:
             nrows = self.nrows()
         if ncols is None:
             ncols = self.ncols()
-        if sparse is None:
-            sparse = True
 
         if nrows == self.nrows() and ncols == self.ncols() and sparse:
             return self.parent()
         else:
             from sage.matrix.matrix_space import MatrixSpace
             return MatrixSpace(ZZ, nrows, ncols, sparse is None or bool(sparse))
```


I would make this into a more 2/3 compatible test:

```
            sage: for i in range(3):
            ....:     for j in range(3):
            ....:         try:
            ....:             s = M[i].an_element() * M[j].an_element()
            ....:             print('X', end='')
            ....:         except TypeError:
            ....:             print(' ', end='')
            ....:     print()
```

I would instead create a 0/1-matrix and output that. Another option would be creating an appropriate string with `'\n'.join(...)`. Similar for another test.

These tests should not be marked as meataxe if it really is using the generic implementation:

```
            sage: MS = MatrixSpace(M.base_ring(), M.nrows(), M.ncols(), implementation='generic')
            sage: X = MS(M)                         # optional: meataxe
            sage: type(X)                           # optional: meataxe
            sage: X.echelon_form() # optional: meataxe
```

Otherwise that would be a bug.

Do we want m4ri to have precedence over trying meataxe when no implementation is given? (I'm cc-ing Simon to note that there might be a change in behavior.)

I'm also split on documenting about when we use a non-generic implementation by default. It feels too much like an implementation detail that it should be hidden from the more casual users, but I think it is good for the more advanced users to have it in the public doc. Thoughts?

I'm also not 100% convinced about having to explicitly convert matrices of different implementations, but since things are likely to be incompatible and it seems unlikely that this would be a problem (I think a user who is choosing implementations will probably be careful and might even appreciate this error). I do not have a good reason to make this an objection, but I am just noting that this might come up from a user.


---

Comment by tscrim created at 2017-11-13 00:51:18

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-11-13 07:03:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-11-13 07:11:22

Thanks Travis for having a look.

Replying to [comment:56 tscrim]:
> [SNIP]

agreed and changed in eeeba32

> Do we want m4ri to have precedence over trying meataxe when no implementation is given? (I'm cc-ing Simon to note that there might be a change in behavior.)

There should not be any change. It concerns only the case `characteristic = 2`.

```
if implementation is None:
    if R.characteristic() == 2 and R.order() <= 65536:
        implementation = 'm4ri'
    elif R.order() <= 255:
        try:
            from . import matrix_gfpn_dense
        except ImportError:
            implementation = 'generic'
        else:
            implementation = 'meataxe'
    else:
        implementation = 'generic'
```

where it used to be

```
if R.characteristic() == 2:
    if R.order() <= 65536:
        return matrix_gf2e_dense.Matrix_gf2e_dense
elif R.order() <= 255:
    try:
        from . import matrix_gfpn_dense
        return matrix_gfpn_dense.Matrix_gfpn_dense
    except ImportError:
        pass
```


> I'm also split on documenting about when we use a non-generic implementation by default. It feels too much like an implementation detail that it should be hidden from the more casual users, but I think it is good for the more advanced users to have it in the public doc. Thoughts?

What would you expect exactly? It would be a nightmare to keep the documentation up to date.

> I'm also not 100% convinced about having to explicitly convert matrices of different implementations, but since things are likely to be incompatible and it seems unlikely that this would be a problem (I think a user who is choosing implementations will probably be careful and might even appreciate this error). I do not have a good reason to make this an objection, but I am just noting that this might come up from a user.

It should be possible to implement coercion to the default implementation (with conversion). Anyway, I would like to keep such changes for later.


---

Comment by vdelecroix created at 2017-11-13 07:11:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-11-13 07:29:40

Replying to [comment:58 vdelecroix]:
> Thanks Travis for having a look.
> > Do we want m4ri to have precedence over trying meataxe when no implementation is given? (I'm cc-ing Simon to note that there might be a change in behavior.)
> 
> There should not be any change. It concerns only the case `characteristic = 2`.
> [snip]

Right, actually I might have misread what meataxe is for and it's a non-issue because it is not meant for characteristic 2. Sorry for the noise.

> > I'm also split on documenting about when we use a non-generic implementation by default. It feels too much like an implementation detail that it should be hidden from the more casual users, but I think it is good for the more advanced users to have it in the public doc. Thoughts?
> 
> What would you expect exactly? It would be a nightmare to keep the documentation up to date.

Keeping it up to date would not be such a problem; at least I don't expect it to change that much. However, I tried a few different ways to present the info and nothing really worked too well. There's just a few too many little cases for the finite fields. I guess if someone cares enough they are good enough to just look at the code.

Thanks. Positive review.


---

Comment by tscrim created at 2017-11-13 07:29:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-09 12:59:17

Documentation doesn't build


---

Comment by vbraun created at 2017-12-09 12:59:17

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-12-14 11:28:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-12-14 11:30:03

With the rebasing I do not have any problem with the documentation.


---

Comment by vdelecroix created at 2017-12-14 11:30:03

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-12-14 23:19:27

found out

```
[dochtml] [matrices ] docstring of sage.matrix.action.MatrixMatrixAction:24: WARNING: Unexpected indentation.
[dochtml] [matrices ] docstring of sage.matrix.action.MatrixMatrixAction:25: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [matrices ] /opt/sage/local/lib/python2.7/site-packages/sage/matrix/special.py:docstring of sage.matrix.special:48: WARNING: undefined label: sage.combinat.matrices.hadamard_matrix (if the link has no caption the label must precede a section header)
[dochtml] [matrices ] /opt/sage/local/lib/python2.7/site-packages/sage/matrix/special.py:docstring of sage.matrix.special:49: WARNING: undefined label: sage.combinat.matrices.latin (if the link has no caption the label must precede a section header)
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/opt/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/opt/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml]     builder()
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 260, in build_many
[dochtml]     results.append(target(arg))
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 71, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 720, in _wrapper
[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 105, in f
[dochtml]     runsphinx()
[dochtml]   File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 218, in runsphinx
[dochtml]     raise exception
[dochtml] OSError: [matrices ] docstring of sage.matrix.action.MatrixMatrixAction:24: WARNING: Unexpected indentation.
[dochtml] 
[dochtml] [matrices ] WARNING: Error building the documentation.
[dochtml] [matrices ] Traceback (most recent call last):
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml] [matrices ] "__main__", fname, loader, pkg_name)
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml] [matrices ] exec code in run_globals
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml] [matrices ] main()
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml] [matrices ] builder()
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
[dochtml] [matrices ] getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml] [matrices ] build_many(build_ref_doc, L)
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 260, in build_many
[dochtml] [matrices ] results.append(target(arg))
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 71, in build_ref_doc
[dochtml] [matrices ] getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 720, in _wrapper
[dochtml] [matrices ] getattr(DocBuilder, build_type)(self, *args, **kwds)
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 105, in f
[dochtml] [matrices ] runsphinx()
[dochtml] [matrices ] File "/opt/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 218, in runsphinx
[dochtml] [matrices ] raise exception
[dochtml] [matrices ] OSError: [matrices ] docstring of sage.matrix.action.MatrixMatrixAction:24: WARNING: Unexpected indentation.
```



---

Comment by vdelecroix created at 2017-12-14 23:19:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-12-14 23:47:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-12-14 23:48:25

I don't understand why, but sphinx was in trouble with `NOTE` and `TESTS` being in the same documentation string.


---

Comment by vdelecroix created at 2017-12-14 23:48:25

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-12-15 04:50:48

It may not be Sphinx but our custom handling of the `TESTS` block (at least, IIRC we do something special there in order to hide the block).


---

Comment by tscrim created at 2017-12-15 04:59:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-12-15 04:59:29

Anyways, the workaround is fine with me and there is a green patchbot. Back to positive review.


---

Comment by vdelecroix created at 2017-12-15 14:12:29

thanks Travis.


---

Comment by vbraun created at 2017-12-18 19:39:30

Resolution: fixed
