# Issue 18020: fix symbolic/pynac.pyx doctests

archive/issues_018020.json:
```json
{
    "body": "CC:  @kcrisman\n\nSeveral doctests in `symbolic/pynac.pyx` iterate over `range(get_ginac_serial(), get_ginac_serial()+100)`. You guess it (sigh), `100` is arbitrary and, right now with some new tickets that introduce new functions, it has become too small, leading to unrelated doctest fails in `symbolic/pynac.pyx`. This ticket should make sure that this does not happen again.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18257\n\n",
    "created_at": "2015-04-20T07:54:04Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "fix symbolic/pynac.pyx doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18020",
    "user": "https://github.com/rwst"
}
```
CC:  @kcrisman

Several doctests in `symbolic/pynac.pyx` iterate over `range(get_ginac_serial(), get_ginac_serial()+100)`. You guess it (sigh), `100` is arbitrary and, right now with some new tickets that introduce new functions, it has become too small, leading to unrelated doctest fails in `symbolic/pynac.pyx`. This ticket should make sure that this does not happen again.

Issue created by migration from https://trac.sagemath.org/ticket/18257





---

archive/issue_comments_242237.json:
```json
{
    "body": "I agree that this is worth fixing permanently, but unless there is an obvious fix we shouldn't let this hold up adding more symbolic functions.",
    "created_at": "2015-05-22T12:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242237",
    "user": "https://github.com/kcrisman"
}
```

I agree that this is worth fixing permanently, but unless there is an obvious fix we shouldn't let this hold up adding more symbolic functions.



---

archive/issue_comments_242238.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2015-05-22T12:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242238",
    "user": "https://github.com/kcrisman"
}
```

Changing priority from major to minor.



---

archive/issue_comments_242239.json:
```json
{
    "body": "Replying to [comment:1 kcrisman]:\n> I agree that this is worth fixing permanently, but unless there is an obvious fix we shouldn't let this hold up adding more symbolic functions.\nThis is not really difficult.\n\nThe central database is a dictionary globally defined in `symbolic/function.pyx` named `sfunction_serial_dict`. It has pairs with key of type `unsigned` and values of `Function` objects (which can be `GinacFunctions` or `BuiltinFunctions`). Accordingly this database is filled with all known Pynac `function`s (which have the `GinacFunction` fa\u00e7ade) first and then those defined via `BuiltinFunction`. The `unsigned` key is the serial number which, on each new function registration, is incremented by one, namely in `GiNaC::function::register_new()`(https://github.com/pynac/pynac/blob/master/ginac/function.cpp#L1445) by just adding to the Pynac registry and reporting its size minus one. After the GiNaC functions have been added, the global `GINAC_FN_SERIAL` is set which is then accessed via `get_ginac_serial()` to get the start key of the Sage defined functions.\n\nThere is a problem if ever a function is deregistered. Can this happen? No mechanism in Pynac exists for this at the moment, so it's  not a practical consideration.\n\nSo the solution is easy: instead of simply adding `100` to the start point, we try all keys from the start key to the latest key used---this need not be a static variable set on registration. Since functions are never deregistered the latest is, again, just the size of the GiNaC registry minus one. This can be had from a call to `g_registered_functions().size()` in `symbolic/pynac.pyx`. \n\n```\ncdef get_fn_serial_c():\n    return g_registered_functions().size()\n\ndef get_fn_serial():\n    return get_fn_serial_c()\n\nsage: from sage.symbolic.pynac import get_fn_serial\nsage: get_fn_serial()\n127\nsage: from sage.symbolic.pynac import get_ginac_serial\nsage: get_ginac_serial()\n40\nsage: from sage.symbolic.function import get_sfunction_from_serial\nsage: for i in range(get_ginac_serial(), get_fn_serial()):\n    print get_sfunction_from_serial(i)\n... // prints all known functions\nsage: print get_sfunction_from_serial(get_fn_serial()+1)\nNone\n```\n",
    "created_at": "2015-05-25T08:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242239",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:1 kcrisman]:
> I agree that this is worth fixing permanently, but unless there is an obvious fix we shouldn't let this hold up adding more symbolic functions.
This is not really difficult.

The central database is a dictionary globally defined in `symbolic/function.pyx` named `sfunction_serial_dict`. It has pairs with key of type `unsigned` and values of `Function` objects (which can be `GinacFunctions` or `BuiltinFunctions`). Accordingly this database is filled with all known Pynac `function`s (which have the `GinacFunction` fa√ßade) first and then those defined via `BuiltinFunction`. The `unsigned` key is the serial number which, on each new function registration, is incremented by one, namely in `GiNaC::function::register_new()`(https://github.com/pynac/pynac/blob/master/ginac/function.cpp#L1445) by just adding to the Pynac registry and reporting its size minus one. After the GiNaC functions have been added, the global `GINAC_FN_SERIAL` is set which is then accessed via `get_ginac_serial()` to get the start key of the Sage defined functions.

There is a problem if ever a function is deregistered. Can this happen? No mechanism in Pynac exists for this at the moment, so it's  not a practical consideration.

So the solution is easy: instead of simply adding `100` to the start point, we try all keys from the start key to the latest key used---this need not be a static variable set on registration. Since functions are never deregistered the latest is, again, just the size of the GiNaC registry minus one. This can be had from a call to `g_registered_functions().size()` in `symbolic/pynac.pyx`. 

```
cdef get_fn_serial_c():
    return g_registered_functions().size()

def get_fn_serial():
    return get_fn_serial_c()

sage: from sage.symbolic.pynac import get_fn_serial
sage: get_fn_serial()
127
sage: from sage.symbolic.pynac import get_ginac_serial
sage: get_ginac_serial()
40
sage: from sage.symbolic.function import get_sfunction_from_serial
sage: for i in range(get_ginac_serial(), get_fn_serial()):
    print get_sfunction_from_serial(i)
... // prints all known functions
sage: print get_sfunction_from_serial(get_fn_serial()+1)
None
```




---

archive/issue_comments_242240.json:
```json
{
    "body": "As they say the first thing that goes down the drain is the planning. The above solution does not account for user defined Python functions that do not inherit from `BuiltinFunction` or `Function`.",
    "created_at": "2015-05-25T09:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242240",
    "user": "https://github.com/rwst"
}
```

As they say the first thing that goes down the drain is the planning. The above solution does not account for user defined Python functions that do not inherit from `BuiltinFunction` or `Function`.



---

archive/issue_comments_242241.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-25T13:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242241",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242242.json:
```json
{
    "body": "No, that was an off-by-one error. Please review.\n----\nNew commits:",
    "created_at": "2015-05-25T13:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242242",
    "user": "https://github.com/rwst"
}
```

No, that was an off-by-one error. Please review.
----
New commits:



---

archive/issue_comments_242243.json:
```json
{
    "body": "Trivial - duplicate lines in test\n\n```\n+        sage: from sage.symbolic.pynac import get_fn_serial\n+        sage: from sage.symbolic.function import get_sfunction_from_serial\n+        sage: from sage.symbolic.pynac import get_fn_serial\n```\n\nThis patch seems reasonable.  What was comment:3 about?  I sense that it was a red herring, but if it could be useful for test-driving this I would love to try it.  I assume that since this isn't actually called in Sage but is really just for doctesting, it shouldn't have any speed implications.",
    "created_at": "2015-05-28T15:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242243",
    "user": "https://github.com/kcrisman"
}
```

Trivial - duplicate lines in test

```
+        sage: from sage.symbolic.pynac import get_fn_serial
+        sage: from sage.symbolic.function import get_sfunction_from_serial
+        sage: from sage.symbolic.pynac import get_fn_serial
```

This patch seems reasonable.  What was comment:3 about?  I sense that it was a red herring, but if it could be useful for test-driving this I would love to try it.  I assume that since this isn't actually called in Sage but is really just for doctesting, it shouldn't have any speed implications.



---

archive/issue_comments_242244.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-29T07:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242244",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242245.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> ...  What was comment:3 about?  I sense that it was a red herring, but if it could be useful for test-driving this I would love to try it.  I assume that since this isn't actually called in Sage but is really just for doctesting, it shouldn't have any speed implications.\nIt's taken care of in the doctests.",
    "created_at": "2015-05-29T07:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242245",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:6 kcrisman]:
> ...  What was comment:3 about?  I sense that it was a red herring, but if it could be useful for test-driving this I would love to try it.  I assume that since this isn't actually called in Sage but is really just for doctesting, it shouldn't have any speed implications.
It's taken care of in the doctests.



---

archive/issue_comments_242246.json:
```json
{
    "body": "I'm not sure why but I still get\n\n```\nsage -t src/sage/symbolic/pynac.pyx\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 512, in sage.symbolic.pynac.py_latex_function_pystring\nFailed example:\n    get_sfunction_from_serial(i) == foo\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 514, in sage.symbolic.pynac.py_latex_function_pystring\nFailed example:\n    py_latex_function_pystring(i, (x,y^z))\nExpected:\n    'my args are: x, y^z'\nGot:\n    '\\\\mathrm{bar}\\\\left(x, y^{z}\\\\right)'\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 603, in sage.symbolic.pynac.py_print_fderivative_for_doctests\nFailed example:\n    get_sfunction_from_serial(i) == foo\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 605, in sage.symbolic.pynac.py_print_fderivative_for_doctests\nFailed example:\n    py_print_fderivative(i, (0, 1, 0, 1), (x, y^z))\nExpected:\n    D[0, 1, 0, 1]func_with_args(x, y^z)\nGot:\n    D[0, 1, 0, 1](foo)(x, y^z)\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 665, in sage.symbolic.pynac.py_latex_fderivative_for_doctests\nFailed example:\n    get_sfunction_from_serial(i) == foo\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/symbolic/pynac.pyx\", line 667, in sage.symbolic.pynac.py_latex_fderivative_for_doctests\nFailed example:\n    py_latex_fderivative(i, (0, 1, 0, 1), (x, y^z))\nExpected:\n    D[0, 1, 0, 1]func_with_args(x, y^z)\nGot:\n    D[0, 1, 0, 1]\\left(\\mathrm{bar}\\right)\\left(x, y^{z}\\right)\n**********************************************************************\n```\n\nwhen I have both this ticket and #15024 together.  Did I do something wrong?  (Note: this is based off of 6.8.beta1, if it matters.)",
    "created_at": "2015-05-29T13:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242246",
    "user": "https://github.com/kcrisman"
}
```

I'm not sure why but I still get

```
sage -t src/sage/symbolic/pynac.pyx
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 512, in sage.symbolic.pynac.py_latex_function_pystring
Failed example:
    get_sfunction_from_serial(i) == foo
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 514, in sage.symbolic.pynac.py_latex_function_pystring
Failed example:
    py_latex_function_pystring(i, (x,y^z))
Expected:
    'my args are: x, y^z'
Got:
    '\\mathrm{bar}\\left(x, y^{z}\\right)'
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 603, in sage.symbolic.pynac.py_print_fderivative_for_doctests
Failed example:
    get_sfunction_from_serial(i) == foo
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 605, in sage.symbolic.pynac.py_print_fderivative_for_doctests
Failed example:
    py_print_fderivative(i, (0, 1, 0, 1), (x, y^z))
Expected:
    D[0, 1, 0, 1]func_with_args(x, y^z)
Got:
    D[0, 1, 0, 1](foo)(x, y^z)
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 665, in sage.symbolic.pynac.py_latex_fderivative_for_doctests
Failed example:
    get_sfunction_from_serial(i) == foo
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/symbolic/pynac.pyx", line 667, in sage.symbolic.pynac.py_latex_fderivative_for_doctests
Failed example:
    py_latex_fderivative(i, (0, 1, 0, 1), (x, y^z))
Expected:
    D[0, 1, 0, 1]func_with_args(x, y^z)
Got:
    D[0, 1, 0, 1]\left(\mathrm{bar}\right)\left(x, y^{z}\right)
**********************************************************************
```

when I have both this ticket and #15024 together.  Did I do something wrong?  (Note: this is based off of 6.8.beta1, if it matters.)



---

archive/issue_comments_242247.json:
```json
{
    "body": "Cannot confirm in a first attempt (I branched from #18257, merged #15024 with `git trac pull`, then merged develop).",
    "created_at": "2015-05-29T15:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242247",
    "user": "https://github.com/rwst"
}
```

Cannot confirm in a first attempt (I branched from #18257, merged #15024 with `git trac pull`, then merged develop).



---

archive/issue_comments_242248.json:
```json
{
    "body": "Same branch does work with pynac-0.3.9 (in case you left that installed and that was the difference between us).",
    "created_at": "2015-05-29T15:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242248",
    "user": "https://github.com/rwst"
}
```

Same branch does work with pynac-0.3.9 (in case you left that installed and that was the difference between us).



---

archive/issue_comments_242249.json:
```json
{
    "body": "Your line numbers also don't match #18257.",
    "created_at": "2015-05-29T15:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242249",
    "user": "https://github.com/rwst"
}
```

Your line numbers also don't match #18257.



---

archive/issue_comments_242250.json:
```json
{
    "body": "Okay, I'll trash the branches I made locally and try again - may not be immediately, I'm at a conference.",
    "created_at": "2015-05-29T18:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242250",
    "user": "https://github.com/kcrisman"
}
```

Okay, I'll trash the branches I made locally and try again - may not be immediately, I'm at a conference.



---

archive/issue_comments_242251.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-01T14:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242251",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242252.json:
```json
{
    "body": "I must have either not merged this one or perhaps in the wrong order or something... Anyway, all systems are go, and as expected #15024 fails without this and works with it.  Great!",
    "created_at": "2015-06-01T14:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242252",
    "user": "https://github.com/kcrisman"
}
```

I must have either not merged this one or perhaps in the wrong order or something... Anyway, all systems are go, and as expected #15024 fails without this and works with it.  Great!



---

archive/issue_comments_242253.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-06-01T14:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242253",
    "user": "https://github.com/rwst"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_242254.json:
```json
{
    "body": "Hold on. I have a necessary addition because of a commit in Pynac where I removed the registry entries for some defunct functions which makes two of the doctest here fail. This would fit in nicely here.",
    "created_at": "2015-06-01T14:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242254",
    "user": "https://github.com/rwst"
}
```

Hold on. I have a necessary addition because of a commit in Pynac where I removed the registry entries for some defunct functions which makes two of the doctest here fail. This would fit in nicely here.



---

archive/issue_comments_242255.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-01T14:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242255",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242256.json:
```json
{
    "body": "Could you please have a last quick look?",
    "created_at": "2015-06-01T14:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242256",
    "user": "https://github.com/rwst"
}
```

Could you please have a last quick look?



---

archive/issue_comments_242257.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-01T14:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242257",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242258.json:
```json
{
    "body": "I don't understand why this fails, though?  (I mean it shouldn't currently, nothing failed for me.) Surely it would be better to put that commit with the next Pynac upgrade ticket?  Easier for the reviewer to test, then (i.e. first upgrade Pynac, run tests (fail), then add branch, watch tests pass).",
    "created_at": "2015-06-01T14:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242258",
    "user": "https://github.com/kcrisman"
}
```

I don't understand why this fails, though?  (I mean it shouldn't currently, nothing failed for me.) Surely it would be better to put that commit with the next Pynac upgrade ticket?  Easier for the reviewer to test, then (i.e. first upgrade Pynac, run tests (fail), then add branch, watch tests pass).



---

archive/issue_comments_242259.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-01T15:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242259",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_017298.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2015-06-02T20:18:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18020#event-17298"
}
```



---

archive/issue_comments_242260.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-02T20:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18020",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18020#issuecomment-242260",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
