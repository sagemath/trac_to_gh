# Issue 30666: Fix broken symlink to documentation in the Sage jupyter kernelspec

archive/issues_030666.json:
```json
{
    "body": "CC:  @EmmanuelCharpentier @malb @jcamp0x2a @dimpase @jhpalmieri @egourgoulhon @kiwifb @slel\n\nFollow-up from #30299 (Minimal fix for broken jupyter notebook):\n\nSage creates a broken symlink\n\n```\nlocal/share/jupyter/kernels/sagemath/doc -> /doesnotexist/html/en\n```\n\nwhich blocks `jupyter kernelspec install` into a system Jupyter using the instructions from #30476:\n\n```\n  File \"/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/shutil.py\", line 368, in copytree\n    raise Error(errors)\nshutil.Error: [('/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/share/jupyter/kernels/sagemath/doc', '/usr/local/share/jupyter/kernels/sagemath/doc', \"[Errno 2] No such file or directory: '/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/share/jupyter/kernels/sagemath/doc'\")]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30903\n\n",
    "created_at": "2020-11-12T17:59:38Z",
    "labels": [
        "component: notebook",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Fix broken symlink to documentation in the Sage jupyter kernelspec",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30666",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @EmmanuelCharpentier @malb @jcamp0x2a @dimpase @jhpalmieri @egourgoulhon @kiwifb @slel

Follow-up from #30299 (Minimal fix for broken jupyter notebook):

Sage creates a broken symlink

```
local/share/jupyter/kernels/sagemath/doc -> /doesnotexist/html/en
```

which blocks `jupyter kernelspec install` into a system Jupyter using the instructions from #30476:

```
  File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/shutil.py", line 368, in copytree
    raise Error(errors)
shutil.Error: [('/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/share/jupyter/kernels/sagemath/doc', '/usr/local/share/jupyter/kernels/sagemath/doc', "[Errno 2] No such file or directory: '/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/share/jupyter/kernels/sagemath/doc'")]
```


Issue created by migration from https://trac.sagemath.org/ticket/30903





---

archive/issue_comments_437853.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-11-15T20:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437853",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_437854.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-15T20:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437854",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_437855.json:
```json
{
    "body": "It is not completely clear to me why we \"poison\" all of these directory names. The comment \"# We also poison all directories below SAGE_LOCAL\" seems like an aside, as if this may not be necessary. Any comments?\n\nAlso, does this affect bdist production?",
    "created_at": "2020-12-01T05:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437855",
    "user": "https://github.com/jhpalmieri"
}
```

It is not completely clear to me why we "poison" all of these directory names. The comment "# We also poison all directories below SAGE_LOCAL" seems like an aside, as if this may not be necessary. Any comments?

Also, does this affect bdist production?



---

archive/issue_comments_437856.json:
```json
{
    "body": "We poison them so that it becomes harder to reintroduce bad code that breaks the separation of the sage distribution from the sage library. I introduced this in #21480.",
    "created_at": "2020-12-01T05:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437856",
    "user": "https://github.com/mkoeppe"
}
```

We poison them so that it becomes harder to reintroduce bad code that breaks the separation of the sage distribution from the sage library. I introduced this in #21480.



---

archive/issue_comments_437857.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> Also, does this affect bdist production?\n\nI don't know if the bdist does anything special about these symlinks. If it does not, then it is broken currently and will be fixed by this ticket as well.",
    "created_at": "2020-12-01T05:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437857",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:5 jhpalmieri]:
> Also, does this affect bdist production?

I don't know if the bdist does anything special about these symlinks. If it does not, then it is broken currently and will be fixed by this ticket as well.



---

archive/issue_comments_437858.json:
```json
{
    "body": "I think this is a bad-enough problem that we should release a 9.2.1 patch release, since this broke using help in the Jupyter kernel for users.  Not a good look.",
    "created_at": "2020-12-01T10:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437858",
    "user": "https://github.com/embray"
}
```

I think this is a bad-enough problem that we should release a 9.2.1 patch release, since this broke using help in the Jupyter kernel for users.  Not a good look.



---

archive/issue_comments_437859.json:
```json
{
    "body": "Is this really the right approach?  It also poisons `SAGE_SHARE` which is used in `sage.env` to set `SAGE_DOC`.  I think if we really want this environment variable \"poisoning\" to be used to catch problems like this, there should be something in `sage_setup` which imports `sage.env` and ~~makes sure none of the variables start with `/doesnotexist`~~ what I wrote before doesn't make sense.  But maybe it should somehow actually crash when using any of those variables during `setup.py`.",
    "created_at": "2020-12-01T10:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437859",
    "user": "https://github.com/embray"
}
```

Is this really the right approach?  It also poisons `SAGE_SHARE` which is used in `sage.env` to set `SAGE_DOC`.  I think if we really want this environment variable "poisoning" to be used to catch problems like this, there should be something in `sage_setup` which imports `sage.env` and ~~makes sure none of the variables start with `/doesnotexist`~~ what I wrote before doesn't make sense.  But maybe it should somehow actually crash when using any of those variables during `setup.py`.



---

archive/issue_comments_437860.json:
```json
{
    "body": "I see now that it's ok since when running this script in the sage shell `SAGE_DOC` is already set explicitly, so it doesn't need to be derived from `SAGE_SHARE`.  But I think this is still a bit of a mess.  Either the variables in `sage.env` should work and have sane values when running `setup.py`, or not.  And simply setting them to bogus values does not guarantee that they are not being used somewhere during build/installation.  Since `SAGE_SRC` and `SAGE_LOCAL` are also used in a number of places, what exactly is the goal here?",
    "created_at": "2020-12-01T11:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437860",
    "user": "https://github.com/embray"
}
```

I see now that it's ok since when running this script in the sage shell `SAGE_DOC` is already set explicitly, so it doesn't need to be derived from `SAGE_SHARE`.  But I think this is still a bit of a mess.  Either the variables in `sage.env` should work and have sane values when running `setup.py`, or not.  And simply setting them to bogus values does not guarantee that they are not being used somewhere during build/installation.  Since `SAGE_SRC` and `SAGE_LOCAL` are also used in a number of places, what exactly is the goal here?



---

archive/issue_comments_437861.json:
```json
{
    "body": "Instead of \"poisoning\" these variables, why don't we unset them instead, and then let `sage.env` derive the correct defaults it would use when installing sagelib independently of the sage distribution?\n\nThe one exception would be SAGE_ROOT, but I think instead of setting it to a bogus value it, and another other paths derived from it, should be set to `None`.  Then we'll most likely get a crash if any of those variables are used during build/installation.",
    "created_at": "2020-12-01T11:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437861",
    "user": "https://github.com/embray"
}
```

Instead of "poisoning" these variables, why don't we unset them instead, and then let `sage.env` derive the correct defaults it would use when installing sagelib independently of the sage distribution?

The one exception would be SAGE_ROOT, but I think instead of setting it to a bogus value it, and another other paths derived from it, should be set to `None`.  Then we'll most likely get a crash if any of those variables are used during build/installation.



---

archive/issue_comments_437862.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> Instead of \"poisoning\" these variables, why don't we unset them instead, and then let `sage.env` derive the correct defaults it would use when installing sagelib independently of the sage distribution?\n\nThe point of the poisoning is that defaults are NOT used.",
    "created_at": "2020-12-01T15:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437862",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:11 embray]:
> Instead of "poisoning" these variables, why don't we unset them instead, and then let `sage.env` derive the correct defaults it would use when installing sagelib independently of the sage distribution?

The point of the poisoning is that defaults are NOT used.



---

archive/issue_comments_437863.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> I see now that it's ok since when running this script in the sage shell `SAGE_DOC` is already set explicitly, so it doesn't need to be derived from `SAGE_SHARE`.  But I think this is still a bit of a mess.  \n\nThat's right. The core of the mess is that the build system (`setup.py` + `sage_setup`) (still) uses `sage.env` at all and therefore has access to various variables (and their defaulting behavior) including those that are intended for runtime use only. This is what the poisoning addresses.",
    "created_at": "2020-12-01T16:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437863",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:10 embray]:
> I see now that it's ok since when running this script in the sage shell `SAGE_DOC` is already set explicitly, so it doesn't need to be derived from `SAGE_SHARE`.  But I think this is still a bit of a mess.  

That's right. The core of the mess is that the build system (`setup.py` + `sage_setup`) (still) uses `sage.env` at all and therefore has access to various variables (and their defaulting behavior) including those that are intended for runtime use only. This is what the poisoning addresses.



---

archive/issue_comments_437864.json:
```json
{
    "body": "In any case, this ticket here is a simple fix. The real action is happening in Meta-ticket #30306.",
    "created_at": "2020-12-01T16:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437864",
    "user": "https://github.com/mkoeppe"
}
```

In any case, this ticket here is a simple fix. The real action is happening in Meta-ticket #30306.



---

archive/issue_comments_437865.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-03T23:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437865",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_437866.json:
```json
{
    "body": "lgtm",
    "created_at": "2020-12-03T23:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437866",
    "user": "https://github.com/dimpase"
}
```

lgtm



---

archive/issue_comments_437867.json:
```json
{
    "body": "Thanks.",
    "created_at": "2020-12-03T23:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437867",
    "user": "https://github.com/mkoeppe"
}
```

Thanks.



---

archive/issue_comments_437868.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-06T12:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437868",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_437869.json:
```json
{
    "body": "Changing keywords from \"\" to \"jupyter kernel, documentation, symlink\".",
    "created_at": "2020-12-07T06:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30666#issuecomment-437869",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "jupyter kernel, documentation, symlink".
