# Issue 23482: MatrixSpace: replace _matrix_class with element_class

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2017-08-25 21:39:02

CC:  tscrim

MatrixSpace do not play well with the category framework. One step forward is to set properly `Element` and have `element_class` pointing to the element class.


---

Comment by jdemeyer created at 2018-02-15 15:19:36

Changing component from linear algebra to coercion.


---

Comment by jdemeyer created at 2018-03-08 09:34:44

If you want progress on this, it would be good to review #24742.


---

Comment by jdemeyer created at 2018-06-04 09:37:16

Working on this...


---

Comment by jdemeyer created at 2018-06-04 09:47:21

Vincent, since you created this ticket: are there any concrete issues that would be fixed by this?


---

Comment by vdelecroix created at 2018-06-04 09:50:42

My aim was to allow matrices on semi-rings (ie structure having `+` and `*` but not necessarily `-` and `/`). We are far away from there though. So only a wishlist.


---

Comment by jdemeyer created at 2018-06-04 10:42:59

Replying to [comment:9 vdelecroix]:
> My aim was to allow matrices on semi-rings

What do you mean with "allow"? And how would that be related to changing `element_class`?


---

Comment by git created at 2018-06-04 14:43:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-08 15:03:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by jdemeyer created at 2018-06-08 18:09:43

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-06-09 07:57:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-09 07:57:05

Doctest failures


---

Comment by git created at 2018-06-11 10:44:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-11 12:31:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-11 13:02:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-11 13:16:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-06-11 14:56:06

All tests passed!


---

Comment by vdelecroix created at 2018-06-17 09:46:02

What is the cause of this change

```
     sage: A[4055]*v
-    (k002*k003)
+    (k001*k003)
```



---

Comment by jdemeyer created at 2018-06-17 11:04:36

Replying to [comment:26 vdelecroix]:
> What is the cause of this change
> {{{
>      sage: A[4055]*v
> -    (k002*k003)
> +    (k001*k003)
> }}}

I guess the answer is random and the random number state is different at that point because of this ticket.


---

Comment by jdemeyer created at 2018-06-29 10:15:12

I just realized that this hasn't been reviewed yet...

Ping?


---

Comment by jdemeyer created at 2018-06-29 10:16:00

Oops, merge failure...


---

Comment by jdemeyer created at 2018-06-29 10:16:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-29 10:35:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-29 10:38:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-29 10:39:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-06-29 10:46:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-06-29 10:48:08

LGTM assuming a patchbot comes back clean. Vincent, any other comments?


---

Comment by git created at 2018-06-29 10:50:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-29 13:09:18

Changing keywords from "" to "days94".


---

Comment by jdemeyer created at 2018-06-30 16:57:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-04 08:06:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-07-04 08:06:41

I'm getting this error when running the testsuite on 32-bit but can't reproduced it when running the test in isolation. But its definitely from this ticket:

```
File "src/sage/schemes/elliptic_curves/padics.py", line 315, in sage.schemes.elliptic_curves.padics.padic_regulator
Failed example:
    E.padic_regulator(int(5))
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.padics.padic_regulator[14]>", line 1, in <module>
        E.padic_regulator(int(Integer(5)))
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 339, in padic_regulator
        height = self.padic_height(p, prec, check_hypotheses=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 756, in padic_height
        sigma = self.padic_sigma(p, adjusted_prec, check_hypotheses=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1095, in padic_sigma
        E2 = self.padic_E2(p, N-2, check_hypotheses=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1503, in padic_E2
        frob_p = self.matrix_of_frobenius(p, prec, check, check_hypotheses, algorithm).change_ring(Integers(p**prec))
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1653, in matrix_of_frobenius
        Q, p, adjusted_prec, trace)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 1658, in matrix_of_frobenius
        F1_reduced = reduce_all(Q, p, F1_coeffs, offset)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 1024, in reduce_all
        exact_form = reduce_negative(Q, p, coeffs, offset, exact_form)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 800, in reduce_negative
        a[1] = base_ring(lift(a[1]) / (j+1))
      File "sage/structure/parent.pyx", line 920, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9734)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4555)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4423)
        return C._element_constructor(x)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py", line 1167, in _element_constructor_
        return integer_mod.IntegerMod(self, x)
      File "sage/rings/finite_rings/integer_mod.pyx", line 197, in sage.rings.finite_rings.integer_mod.IntegerMod (build/cythonized/sage/rings/finite_rings/integer_mod.c:4558)
        return t(parent, value)
      File "sage/rings/finite_rings/integer_mod.pyx", line 361, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.__init__ (build/cythonized/sage/rings/finite_rings/integer_mod.c:5739)
        z = value % self.__modulus.sageInteger
      File "sage/rings/rational.pyx", line 2869, in sage.rings.rational.Rational.__mod__ (build/cythonized/sage/rings/rational.c:25810)
        d = d.inverse_mod(other)
      File "sage/rings/integer.pyx", line 6574, in sage.rings.integer.Integer.inverse_mod (build/cythonized/sage/rings/integer.c:41104)
        raise ZeroDivisionError("Inverse does not exist.")
    ZeroDivisionError: Inverse does not exist.
```



---

Comment by git created at 2018-07-26 10:58:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-07-26 22:44:32

I can confirm [comment:38] in the sense that I can reproduce the error. I don't see how it could be caused by this ticket though. It might be related to GC for example where a different internal state causes a GC at a different time. To check that, I'm rebasing to #25871.


---

Comment by git created at 2018-07-26 22:46:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-07-29 18:51:14

The error seems unrelated to this ticket. Somebody also got it because of the Singular upgrade, see #25969.


---

Comment by jdemeyer created at 2018-07-29 18:51:34

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by git created at 2018-08-16 09:21:10

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-08-16 09:21:10

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by tscrim created at 2018-08-16 23:01:32

Is #25969 still a dependency? It seems from the comments like #25969 is not coming from this ticket.


---

Comment by tscrim created at 2018-08-16 23:01:32

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-08-17 05:59:38

Replying to [comment:46 tscrim]:
> Is #25969 still a dependency?

I don't know. We can test again whether the problem magically went away.


---

Comment by jdemeyer created at 2018-08-17 06:01:10

Replying to [comment:46 tscrim]:
> It seems from the comments like #25969 is not coming from this ticket.

Well, define "coming from". The problem is certainly unrelated and not directly caused by this ticket, but merging this ticket did cause #25969 to appear.


---

Comment by jdemeyer created at 2018-08-25 07:52:13

I just tested again and this no longer causes #25969.


---

Comment by vbraun created at 2018-08-26 09:38:13

Resolution: fixed
