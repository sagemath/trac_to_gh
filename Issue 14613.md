# Issue 14613: Inefficiency in copying PARI objects to the heap

archive/issues_014613.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  jpflori\n\nWhen PARI objects are wrapped into Python objects, they are copied from the PARI stack to a `malloc`'ed memory block.  This is done by the function `deepcopy_to_python_heap()` in `sage/libs/pari/gen.pyx`.  To determine how much memory to allocate, this function creates a dummy copy on the stack and measures by how much the stack pointer goes down.  This is inefficient and can be improved by calling PARI's `gsizebyte()` function, which does exactly what we want.\n\nAlso, copying the object to the `malloc`'ed block is done inelegantly by temporarily changing the global variables `top`, `bot` and `avma` defining the PARI stack.  Again, there is a PARI function that does what we want: `gcopy_avma()` does the same as `gcopy()`, but copies to a user-specified address.\n\nI am attaching a patch that replaces `deepcopy_to_python_heap()` by a simpler and faster implementation.  (It also deletes a comment that seems to refer to code that no longer exists.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/14817\n\n",
    "created_at": "2013-06-25T13:06:38Z",
    "labels": [
        "performance",
        "minor",
        "enhancement"
    ],
    "title": "Inefficiency in copying PARI objects to the heap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14613",
    "user": "pbruin"
}
```
Assignee: tbd

CC:  jpflori

When PARI objects are wrapped into Python objects, they are copied from the PARI stack to a `malloc`'ed memory block.  This is done by the function `deepcopy_to_python_heap()` in `sage/libs/pari/gen.pyx`.  To determine how much memory to allocate, this function creates a dummy copy on the stack and measures by how much the stack pointer goes down.  This is inefficient and can be improved by calling PARI's `gsizebyte()` function, which does exactly what we want.

Also, copying the object to the `malloc`'ed block is done inelegantly by temporarily changing the global variables `top`, `bot` and `avma` defining the PARI stack.  Again, there is a PARI function that does what we want: `gcopy_avma()` does the same as `gcopy()`, but copies to a user-specified address.

I am attaching a patch that replaces `deepcopy_to_python_heap()` by a simpler and faster implementation.  (It also deletes a comment that seems to refer to code that no longer exists.)

Issue created by migration from https://trac.sagemath.org/ticket/14817





---

archive/issue_comments_185863.json:
```json
{
    "body": "Attachment [trac14817-copy_pari_objects.patch](tarball://root/attachments/some-uuid/ticket14817/trac14817-copy_pari_objects.patch) by pbruin created at 2013-06-25 13:08:44\n\nbased on 5.11.beta3",
    "created_at": "2013-06-25T13:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185863",
    "user": "pbruin"
}
```

Attachment [trac14817-copy_pari_objects.patch](tarball://root/attachments/some-uuid/ticket14817/trac14817-copy_pari_objects.patch) by pbruin created at 2013-06-25 13:08:44

based on 5.11.beta3



---

archive/issue_comments_185864.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-25T13:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185864",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_185865.json:
```json
{
    "body": "The patch looks and applies fine.\n\nCould you provide some timing here demonstrating the speed up?\nIt would be nice to keep track of it at least here (obviously theres no way to provide doctests for that).",
    "created_at": "2013-07-08T11:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185865",
    "user": "jpflori"
}
```

The patch looks and applies fine.

Could you provide some timing here demonstrating the speed up?
It would be nice to keep track of it at least here (obviously theres no way to provide doctests for that).



---

archive/issue_comments_185866.json:
```json
{
    "body": "(For later tickets: I don't think you have to mention the ticket number in the commit message because Jeroen's script automatically add them.)",
    "created_at": "2013-07-08T11:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185866",
    "user": "jpflori"
}
```

(For later tickets: I don't think you have to mention the ticket number in the commit message because Jeroen's script automatically add them.)



---

archive/issue_comments_185867.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-09T03:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185867",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_185868.json:
```json
{
    "body": "I don't really see why we need to further justify using the built-in function instead of hacking our own. With a useless stack copy to boot. Its obviously better.",
    "created_at": "2013-07-09T03:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185868",
    "user": "vbraun"
}
```

I don't really see why we need to further justify using the built-in function instead of hacking our own. With a useless stack copy to boot. Its obviously better.



---

archive/issue_comments_185869.json:
```json
{
    "body": "My main motivation was to make this function do The Right Thing(tm) instead of the ugly hack that is currently there.  There is actually a speed-up, though; I did some unscientific tests and came to the conclusion that it is negligible for very small PARI objects (like integers), around 10-15% for (small) number fields or elliptic curves, and 25% for a 100 x 100 matrix over the integers.",
    "created_at": "2013-07-09T09:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185869",
    "user": "pbruin"
}
```

My main motivation was to make this function do The Right Thing(tm) instead of the ugly hack that is currently there.  There is actually a speed-up, though; I did some unscientific tests and came to the conclusion that it is negligible for very small PARI objects (like integers), around 10-15% for (small) number fields or elliptic curves, and 25% for a 100 x 100 matrix over the integers.



---

archive/issue_comments_185870.json:
```json
{
    "body": "Great, anyway, I agree with Volker's move and your first justification: it's the right thing to do.",
    "created_at": "2013-07-09T09:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185870",
    "user": "jpflori"
}
```

Great, anyway, I agree with Volker's move and your first justification: it's the right thing to do.



---

archive/issue_comments_185871.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-02T14:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14613",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14613#issuecomment-185871",
    "user": "jdemeyer"
}
```

Resolution: fixed
