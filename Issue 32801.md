# Issue 32801: pari(2^64) crashes Sage

archive/issues_032801.json:
```json
{
    "body": "CC:  @kliem @videlec\n\nIn SageMath 9.5.beta8:\n\n```\nsage: pari(2^64)\nTraceback (most recent call last):\n...\nSignalError: Segmentation fault\n```\n\nAnother attempt:\n\n```\nsage: pari(2^64)\n1334420292954149376986524197863817216\npython3: malloc.c:3252: __libc_malloc: Assertion `!victim || chunk_is_mmapped (mem2chunk (victim)) || ar_ptr == arena_for_chunk (mem2chunk (victim))' failed.\n------------------------------------------------------------------------\n/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7dbb)[0x7f2f4da9ddbb]\n/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7e69)[0x7f2f4da9de69]\n/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0xac9d)[0x7f2f4daa0c9d]\n/lib64/libpthread.so.0(+0x121d0)[0x7f2f51aa31d0]\n/lib64/libc.so.6(gsignal+0x13e)[0x7f2f517c263e]\n/lib64/libc.so.6(abort+0x112)[0x7f2f517ac536]\n/lib64/libc.so.6(+0x81818)[0x7f2f5180b818]\n/lib64/libc.so.6(__libc_malloc+0x237)[0x7f2f518101e7]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(PyThread_allocate_lock+0x16)[0x7f2f51cb4b06]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x20ac13)[0x7f2f51d08c13]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0xe3936)[0x7f2f51be1936]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x590f)[0x7f2f51b6a23f]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x6478)[0x7f2f51b6ada8]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x6478)[0x7f2f51b6ada8]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0xab42c)[0x7f2f51ba942c]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x20a378)[0x7f2f51d08378]\n/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x1b67b7)[0x7f2f51cb47b7]\n/lib64/libpthread.so.0(+0x7d4e)[0x7f2f51a98d4e]\n/lib64/libc.so.6(clone+0x3f)[0x7f2f51881faf]\n------------------------------------------------------------------------\nAttaching gdb to process id 22853.\n```\n\nNote that the number printed before the crash is a multiple of 2<sup>64</sup>.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33038\n\n",
    "created_at": "2021-12-17T14:28:38Z",
    "labels": [
        "component: interfaces",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "pari(2^64) crashes Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32801",
    "user": "https://github.com/pjbruin"
}
```
CC:  @kliem @videlec

In SageMath 9.5.beta8:

```
sage: pari(2^64)
Traceback (most recent call last):
...
SignalError: Segmentation fault
```

Another attempt:

```
sage: pari(2^64)
1334420292954149376986524197863817216
python3: malloc.c:3252: __libc_malloc: Assertion `!victim || chunk_is_mmapped (mem2chunk (victim)) || ar_ptr == arena_for_chunk (mem2chunk (victim))' failed.
------------------------------------------------------------------------
/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7dbb)[0x7f2f4da9ddbb]
/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7e69)[0x7f2f4da9de69]
/home/peter/src/sage/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0xac9d)[0x7f2f4daa0c9d]
/lib64/libpthread.so.0(+0x121d0)[0x7f2f51aa31d0]
/lib64/libc.so.6(gsignal+0x13e)[0x7f2f517c263e]
/lib64/libc.so.6(abort+0x112)[0x7f2f517ac536]
/lib64/libc.so.6(+0x81818)[0x7f2f5180b818]
/lib64/libc.so.6(__libc_malloc+0x237)[0x7f2f518101e7]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(PyThread_allocate_lock+0x16)[0x7f2f51cb4b06]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x20ac13)[0x7f2f51d08c13]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0xe3936)[0x7f2f51be1936]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x590f)[0x7f2f51b6a23f]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x6478)[0x7f2f51b6ada8]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x6478)[0x7f2f51b6ada8]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x659e9)[0x7f2f51b639e9]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0xab42c)[0x7f2f51ba942c]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x20a378)[0x7f2f51d08378]
/home/peter/src/sage/local/lib/libpython3.9.so.1.0(+0x1b67b7)[0x7f2f51cb47b7]
/lib64/libpthread.so.0(+0x7d4e)[0x7f2f51a98d4e]
/lib64/libc.so.6(clone+0x3f)[0x7f2f51881faf]
------------------------------------------------------------------------
Attaching gdb to process id 22853.
```

Note that the number printed before the crash is a multiple of 2<sup>64</sup>.

Issue created by migration from https://trac.sagemath.org/ticket/33038





---

archive/issue_comments_467170.json:
```json
{
    "body": "FWIW, I am not seeing this problem (with 9.5b8 on MacOS 11.5.2):\n\n```\nsage: pari(2^64)\n18446744073709551616\nsage: pari(2^64+1)\n18446744073709551617\nsage: pari(2^64+1)\n18446744073709551617\n```\n",
    "created_at": "2021-12-17T17:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32801#issuecomment-467170",
    "user": "https://github.com/DaveWitteMorris"
}
```

FWIW, I am not seeing this problem (with 9.5b8 on MacOS 11.5.2):

```
sage: pari(2^64)
18446744073709551616
sage: pari(2^64+1)
18446744073709551617
sage: pari(2^64+1)
18446744073709551617
```




---

archive/issue_comments_467171.json:
```json
{
    "body": "Also no problem with 9.5b8 on Ubuntu 20.04 (CoCalc).",
    "created_at": "2021-12-18T07:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32801#issuecomment-467171",
    "user": "https://github.com/DaveWitteMorris"
}
```

Also no problem with 9.5b8 on Ubuntu 20.04 (CoCalc).



---

archive/issue_comments_467172.json:
```json
{
    "body": "Indeed, this crash only happens on one of the two (Linux) machines I am using.\n\nFrom the stack trace, it looks like it might be related to the fact that PARI is now configured to use `libpthread`; see #30537.  Also comment:98:ticket:30423 might be related.",
    "created_at": "2021-12-21T18:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32801#issuecomment-467172",
    "user": "https://github.com/pjbruin"
}
```

Indeed, this crash only happens on one of the two (Linux) machines I am using.

From the stack trace, it looks like it might be related to the fact that PARI is now configured to use `libpthread`; see #30537.  Also comment:98:ticket:30423 might be related.
