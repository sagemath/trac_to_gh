# Issue 24034: py3: allow flexibility in exception message formatting in doctests on Python 3

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-11-23 09:33:37

On Python 2 exception messages are printed, along with the exception class name, like


```
SignError: cannot multiply infinity by zero
```


whereas on Python 3 they're printed with the exception class's fully qualified name (for non-builtin exceptions):


```
sage.rings.infinity.SignError: cannot multiply infinity by zero
```


Therefore any doctest that expects a traceback fails, due to this slight formatting difference.  One can go through all such tests and insert ellipses.  But it's simpler if we just normalize for this trivial formatting difference, similarly to #24258.

In this case it isn't done directly in the `OutputChecker` since, in order to make this normalization as restrictive as possible, we need access to the exception info which is not normally passed to `OutputChecker`.  So this is handled directly in `SageDocTestRunner`'s result handling.

This made a lot of previously "failing" tests pass for me.  But it should be made clear that this normalization does not in any way take away from the validity of the tests.


---

Comment by embray created at 2017-11-23 09:34:04

Changing status from new to needs_review.


---

Comment by git created at 2017-11-23 11:16:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-11-23 13:07:00

see also #16088


---

Comment by embray created at 2017-11-23 14:00:43

Interesting--it might also be worth addressing some of those common differences between built-in exception messages.  Are there any other examples besides `ZeroDivision`?


---

Comment by chapoton created at 2017-11-23 15:09:35

NO idea. I was keeping that for stage C (make the doctests pass) after stage B (make vanilla-sage start with python 3). Stage A (make vanilla-sage build with python 3) is done already. We have some hope to see stage B completed soon, maybe.


---

Comment by embray created at 2017-11-23 15:57:19

I'm still pretty near to having the doctester 100% working too.  I'm just working out a few more small kinks.


---

Comment by jdemeyer created at 2017-11-24 09:57:44

1. Why this check?

```
if exc_info[0].__module__
```

Are there any cases where `__module__` would _not_ be a `True` value?

2. You really want to use `__qualname__` instead of `__name__` on Python 3, since that is what the `traceback` module uses.

For reference, this is the relevant code from the `traceback` module:

```
        stype = self.exc_type.__qualname__
        smod = self.exc_type.__module__
        if smod not in ("__main__", "builtins"):
            stype = smod + '.' + stype
```



---

Comment by jdemeyer created at 2017-11-24 09:57:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-24 09:59:31

3. `exc_qualname` is a confusing name. Better use `exc_fullname` or something.


---

Comment by embray created at 2017-11-24 11:15:18

Replying to [comment:7 jdemeyer]:
> 1. Why this check?
> {{{
> if exc_info[0].__module__
> }}}
> Are there any cases where `__module__` would _not_ be a `True` value?

While I can't name an exact case off the top of my head, I've seen pathological cases (especially in the context of dynamically created classes) where `__module__` can be `None`.  For functions and methods it can definitely be `None`.  Whether or not that's "valid" for classes is less clear.  Anyways it's unlikely to occur, but safer to check for anyways.  You're right about `__qualname__`.


---

Comment by git created at 2017-11-24 11:21:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-11-24 11:21:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-24 11:30:14

Analogously, why

```
getattr(exc_cls, '__qualname__', exc_cls.__name__)
```

instead of

```
exc_cls.__qualname__
```

Are there any cases where `__qualname__` wouldn't exist?

For both the `__module__` check and `__qualname__` check: the Python standard `traceback` module doesn't do anything fancy here, it just uses the `__qualname__` and `__module__` attributes as-is. If that's good enough for the `traceback` module, it should be good enough for Sage.


---

Comment by embray created at 2017-11-24 12:07:52

That specific code is run on both Python 2 and 3.  There is no `__qualname__` on Python 2.  I guess I could move all the code under a `if not six.PY2` since none of that is currently used on Python 2 anyways (it could be used though if we ever wanted to make the opposite transformation).


---

Comment by jdemeyer created at 2017-11-24 12:29:52

Replying to [comment:13 embray]:
> That specific code is run on both Python 2 and 3.

Right, I missed that.

> I guess I could move all the code under a `if not six.PY2`

That makes sense.


---

Comment by git created at 2017-11-27 09:56:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-11-27 13:13:51

Fixed up a bit more and squashed.


---

Comment by embray created at 2017-11-27 13:27:51

Actually, I just noticed one other little thing that would be nice to add to this.


---

Comment by embray created at 2017-11-27 13:27:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-11-27 13:33:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-11-27 13:35:17

New commits:


---

Comment by embray created at 2017-11-27 13:35:17

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-28 13:31:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-13 17:38:05

Resolution: fixed
