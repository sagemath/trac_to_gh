# Issue 19289: Certain methods fail on immutable graphs

archive/issues_019289.json:
```json
{
    "body": "CC:  ncohen\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19526\n\n",
    "created_at": "2015-11-04T17:07:23Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Certain methods fail on immutable graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19289",
    "user": "jaanos"
}
```
CC:  ncohen



Issue created by migration from https://trac.sagemath.org/ticket/19526





---

archive/issue_comments_264917.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264917",
    "user": "jaanos"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_264918.json:
```json
{
    "body": "Changing keywords from \"\" to \"graphs, immutable\".",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264918",
    "user": "jaanos"
}
```

Changing keywords from "" to "graphs, immutable".



---

archive/issue_comments_264919.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264919",
    "user": "jaanos"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_264920.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264920",
    "user": "jaanos"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_264921.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-05T15:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264921",
    "user": "ncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_264922.json:
```json
{
    "body": "Helloooooo Janos,\n\nHere is a first-pass review.\n\n- Modification to `DiGraph.to_undirected` -- adding a `immutable` flag as you do\n  it in this function is problematic. What is the intended behavior of\n  `g.to_undirected(sparse=False,immutable=True)` ? `:-/`\n\n  This kind of compatibilities should be handled by the constructor. So, to\n  avoid to do its job again, the best is probably to give it all the arguments\n  you get and hope that it does its job.\n\n- Could you write this `is_immutable` function? Then this\n  {{{\n  +        if getattr(self, '_immutable', False):\n  +            G = copy(self)\n  +        else:\n  +            G = self\n  }}}\n  Could become\n  {{{\n  G = self.copy(immutable=False) if self.is_immutable() else self\n  }}}\n\n- I don't think it is worth testing if we work on a copy here `^^;`\n  {{{\n  -        self.add_edge(u,v,label)\n  +        if not getattr(self, '_immutable', False):\n  +            G.add_edge(u,v,label)\n  }}}\n\n- `Graph.to_directed` -- same remark as for `DiGraph.to_undirected`\n\n- Same function -- the documentation of `immutable` is not indented right. You\n  can build the doc to observe it with\n  `sage -b && sage -docbuild reference/graphs html`\n\nThanks,\n\nNathann",
    "created_at": "2015-11-05T15:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264922",
    "user": "ncohen"
}
```

Helloooooo Janos,

Here is a first-pass review.

- Modification to `DiGraph.to_undirected` -- adding a `immutable` flag as you do
  it in this function is problematic. What is the intended behavior of
  `g.to_undirected(sparse=False,immutable=True)` ? `:-/`

  This kind of compatibilities should be handled by the constructor. So, to
  avoid to do its job again, the best is probably to give it all the arguments
  you get and hope that it does its job.

- Could you write this `is_immutable` function? Then this
  {{{
  +        if getattr(self, '_immutable', False):
  +            G = copy(self)
  +        else:
  +            G = self
  }}}
  Could become
  {{{
  G = self.copy(immutable=False) if self.is_immutable() else self
  }}}

- I don't think it is worth testing if we work on a copy here `^^;`
  {{{
  -        self.add_edge(u,v,label)
  +        if not getattr(self, '_immutable', False):
  +            G.add_edge(u,v,label)
  }}}

- `Graph.to_directed` -- same remark as for `DiGraph.to_undirected`

- Same function -- the documentation of `immutable` is not indented right. You
  can build the doc to observe it with
  `sage -b && sage -docbuild reference/graphs html`

Thanks,

Nathann



---

archive/issue_comments_264923.json:
```json
{
    "body": "Hi!\n\nThanks for the review. I'll implement the suggestions shortly.\n\nI guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.\n\nAs for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.\n\nWhat about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?\n\nJano\u0161",
    "created_at": "2015-11-05T19:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264923",
    "user": "jaanos"
}
```

Hi!

Thanks for the review. I'll implement the suggestions shortly.

I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.

As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.

What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?

Janoš



---

archive/issue_comments_264924.json:
```json
{
    "body": "Yooooooooooo,\n\n> I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.\n\nYep. And it convinces me even more that we should remove those functions totally. In another ticket, if you don't feel like doing it.\n\n> As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.\n\nWhat I meant is that this prameter-checking is/should be done in the constructor anyway. So let us not double this administrative code.\n\n> What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?\n\nYepyep, that should be good.\n\nNathann",
    "created_at": "2015-11-05T20:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264924",
    "user": "ncohen"
}
```

Yooooooooooo,

> I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.

Yep. And it convinces me even more that we should remove those functions totally. In another ticket, if you don't feel like doing it.

> As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.

What I meant is that this prameter-checking is/should be done in the constructor anyway. So let us not double this administrative code.

> What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?

Yepyep, that should be good.

Nathann



---

archive/issue_comments_264925.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-11-06T13:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264925",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_264926.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-06T13:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264926",
    "user": "jaanos"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_264927.json:
```json
{
    "body": "OK, I fixed the issues. I haven't removed `to_(un)directed`, since these functions are used all over the place and I don't feel I'm in position to remove them :) (plus, I see the benefit of not creating a copy of an immutable graph when one isn't needed).",
    "created_at": "2015-11-06T13:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264927",
    "user": "jaanos"
}
```

OK, I fixed the issues. I haven't removed `to_(un)directed`, since these functions are used all over the place and I don't feel I'm in position to remove them :) (plus, I see the benefit of not creating a copy of an immutable graph when one isn't needed).



---

archive/issue_comments_264928.json:
```json
{
    "body": "Hellooooooooooooooo,\n\nIt all looks good, but I have one question left about this modification:\n\n```diff\n-    G = G.relabel(inplace=False) # making sure the vertices are integers\n+    if G.is_immutable():\n+        G = G.copy(immutable=False)\n+        G.relabel(inplace=True)\n+    else:\n+        G = G.relabel(inplace=False) # making sure the vertices are integers\n```\n\n\nWhy wouldn't you add the same argument 'immutable' to 'relabel' instead? It seems that you only want something like `G.relabel(inplace=False,immutable=False)`?..\n\nNathann",
    "created_at": "2015-11-06T14:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264928",
    "user": "ncohen"
}
```

Hellooooooooooooooo,

It all looks good, but I have one question left about this modification:

```diff
-    G = G.relabel(inplace=False) # making sure the vertices are integers
+    if G.is_immutable():
+        G = G.copy(immutable=False)
+        G.relabel(inplace=True)
+    else:
+        G = G.relabel(inplace=False) # making sure the vertices are integers
```


Why wouldn't you add the same argument 'immutable' to 'relabel' instead? It seems that you only want something like `G.relabel(inplace=False,immutable=False)`?..

Nathann



---

archive/issue_comments_264929.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-06T14:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264929",
    "user": "ncohen"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_264930.json:
```json
{
    "body": "Hi!\n\nNo problem, I can do that.\n\nJano\u0161",
    "created_at": "2015-11-06T15:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264930",
    "user": "jaanos"
}
```

Hi!

No problem, I can do that.

Janoš



---

archive/issue_comments_264931.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-06T16:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264931",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_264932.json:
```json
{
    "body": "OK, here you go.",
    "created_at": "2015-11-06T16:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264932",
    "user": "jaanos"
}
```

OK, here you go.



---

archive/issue_comments_264933.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-06T16:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264933",
    "user": "jaanos"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_264934.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-07T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264934",
    "user": "ncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_264935.json:
```json
{
    "body": "WOoooooorks for me ! THanks `:-)`\n\nNathann",
    "created_at": "2015-11-07T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264935",
    "user": "ncohen"
}
```

WOoooooorks for me ! THanks `:-)`

Nathann



---

archive/issue_comments_264936.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-08T15:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264936",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_264937.json:
```json
{
    "body": "Thank you guys! I'll be back with a new ticket soon:)",
    "created_at": "2015-11-09T11:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19289#issuecomment-264937",
    "user": "jaanos"
}
```

Thank you guys! I'll be back with a new ticket soon:)
