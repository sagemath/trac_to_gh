# Issue 19289: Certain methods fail on immutable graphs

Issue created by migration from Trac.

Original creator: jaanos

Original creation time: 2015-11-04 17:07:23

CC:  ncohen




---

Comment by jaanos created at 2015-11-04 17:51:44

Changing component from PLEASE CHANGE to graph theory.


---

Comment by jaanos created at 2015-11-04 17:51:44

Changing keywords from "" to "graphs, immutable".


---

Comment by jaanos created at 2015-11-04 17:51:44

Changing status from new to needs_review.


---

Comment by jaanos created at 2015-11-04 17:51:44

Changing type from PLEASE CHANGE to defect.


---

Comment by ncohen created at 2015-11-05 15:07:53

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-11-05 15:07:53

Helloooooo Janos,

Here is a first-pass review.

- Modification to `DiGraph.to_undirected` -- adding a `immutable` flag as you do
  it in this function is problematic. What is the intended behavior of
  `g.to_undirected(sparse=False,immutable=True)` ? `:-/`

  This kind of compatibilities should be handled by the constructor. So, to
  avoid to do its job again, the best is probably to give it all the arguments
  you get and hope that it does its job.

- Could you write this `is_immutable` function? Then this
  {{{
  +        if getattr(self, '_immutable', False):
  +            G = copy(self)
  +        else:
  +            G = self
  }}}
  Could become
  {{{
  G = self.copy(immutable=False) if self.is_immutable() else self
  }}}

- I don't think it is worth testing if we work on a copy here `^^;`
  {{{
  -        self.add_edge(u,v,label)
  +        if not getattr(self, '_immutable', False):
  +            G.add_edge(u,v,label)
  }}}

- `Graph.to_directed` -- same remark as for `DiGraph.to_undirected`

- Same function -- the documentation of `immutable` is not indented right. You
  can build the doc to observe it with
  `sage -b && sage -docbuild reference/graphs html`

Thanks,

Nathann


---

Comment by jaanos created at 2015-11-05 19:05:01

Hi!

Thanks for the review. I'll implement the suggestions shortly.

I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.

As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.

What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?

Janoš


---

Comment by ncohen created at 2015-11-05 20:57:45

Yooooooooooo,

> I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.

Yep. And it convinces me even more that we should remove those functions totally. In another ticket, if you don't feel like doing it.

> As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.

What I meant is that this prameter-checking is/should be done in the constructor anyway. So let us not double this administrative code.

> What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?

Yepyep, that should be good.

Nathann


---

Comment by git created at 2015-11-06 13:46:31

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by jaanos created at 2015-11-06 13:51:44

Changing status from needs_work to needs_review.


---

Comment by jaanos created at 2015-11-06 13:51:44

OK, I fixed the issues. I haven't removed `to_(un)directed`, since these functions are used all over the place and I don't feel I'm in position to remove them :) (plus, I see the benefit of not creating a copy of an immutable graph when one isn't needed).


---

Comment by ncohen created at 2015-11-06 14:05:29

Hellooooooooooooooo,

It all looks good, but I have one question left about this modification:

```diff
-    G = G.relabel(inplace=False) # making sure the vertices are integers
+    if G.is_immutable():
+        G = G.copy(immutable=False)
+        G.relabel(inplace=True)
+    else:
+        G = G.relabel(inplace=False) # making sure the vertices are integers
```


Why wouldn't you add the same argument 'immutable' to 'relabel' instead? It seems that you only want something like `G.relabel(inplace=False,immutable=False)`?..

Nathann


---

Comment by ncohen created at 2015-11-06 14:05:29

Changing status from needs_review to needs_info.


---

Comment by jaanos created at 2015-11-06 15:59:55

Hi!

No problem, I can do that.

Janoš


---

Comment by git created at 2015-11-06 16:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jaanos created at 2015-11-06 16:13:30

OK, here you go.


---

Comment by jaanos created at 2015-11-06 16:13:30

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2015-11-07 19:29:39

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-11-07 19:29:39

WOoooooorks for me ! THanks `:-)`

Nathann


---

Comment by vbraun created at 2015-11-08 15:56:03

Resolution: fixed


---

Comment by jaanos created at 2015-11-09 11:18:47

Thank you guys! I'll be back with a new ticket soon:)
