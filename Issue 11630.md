# Issue 11630: Generation of Lucas sequences modulo an integer

Issue created by migration from Trac.

Original creator: somindu

Original creation time: 2011-09-15 15:43:45

Assignee: AlexGhitza

CC:  jpflori robertwb zimmerma

Keywords: Lucas sequence

The Lucas sequence modulo an integer n is given by `V_k = PV_{k-1} - Q V_{k-2} mod n` with `V_0 = 2 and V_1 = P`. This is not implemented in Sage. There are algorithms `fast_lucas` and `slow_lucas` that compute this sequence only for the special case `Q=1`.

```
sage: from sage.rings.finite_rings.integer_mod import fast_lucas
sage: [fast_lucas(i, Mod(8,11)) for i in range(15)]
[2, 8, 7, 4, 3, 9, 3, 4, 7, 8, 2, 8, 7, 4, 3]
```


```
sage: from sage.rings.finite_rings.integer_mod import slow_lucas
sage: [slow_lucas(i, Mod(8,11)) for i in range(15)]
[2, 8, 7, 4, 3, 9, 3, 4, 7, 8, 2, 8, 7, 4, 3]
```



---

Attachment


---

Attachment

Add the patches for function `lucas(k,p,q,n)` which generates Lucas sequence V_k mod n (k >= 0) defined by `V_k = PV_{k-1} - QV_{k-2} with V_0 = 2 and V_1 = P`.

Tests::

```
        sage: from sage.rings.finite_rings.integer_mod import lucas
        sage: p = randint(0,100000)
        sage: q = randint(0,100000)
        sage: n = randint(0,100)
        sage: all([lucas(k,p,q,n)[0] == Mod(lucas_number2(k,p,q),n)
        ...        for k in Integers(20)])
        True
```



```
        sage: from sage.rings.finite_rings.integer_mod import lucas
        sage: p = randint(0,100000)
        sage: q = randint(0,100000)
        sage: n = randint(0,100)
        sage: k = randint(0,100)
        sage: lucas(k,p,q,n) == [Mod(lucas_number2(k,p,q),n),Mod(q^(int(k/2)),n)]
        True
```


Examples::

```
        sage: [lucas(k,4,5,11)[0] for k in range(30)]
        [2, 4, 6, 4, 8, 1, 8, 5, 2, 5, 10, 4, 10, 9, 8, 9, 7, 5, 7, 3, 10, 3, 6, 9, 6, 1, 7, 1, 2, 3]

        sage: lucas(20,4,5,11)
        [10, 1]
```



---

Comment by zimmerma created at 2011-09-16 12:24:31

Changing keywords from "Lucas sequence" to "Lucas sequence ecc2011".


---

Comment by jpflori created at 2011-09-16 12:30:31

Changing status from new to needs_review.


---

Comment by jpflori created at 2011-09-16 13:07:37

The code looks ok to me.

Not sure that we should keep both the code in fast_lucas just for the case Q=1 and lucas function for the generic case.

Of course the specialized version for Q=1 is faster, so it might be a reason to keep it, even if I'm more inclined not to.

I provided two "reviewer" patches and if Robert has any preference, let him decide.


---

Attachment

Patch with both functions.


---

Attachment

Patch where fast_lucas is just a wrapper to the new implementation.


---

Comment by ncohen created at 2013-12-26 19:08:15

Probably needs to be rebased `O_o`

Nathann


---

Comment by ncohen created at 2013-12-26 19:08:15

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-12-27 09:49:01

Sure.
What's your opiinon about comment:4?


---

Comment by ncohen created at 2013-12-27 10:06:02

Well I know absolutely nothing about Lucas number, so I do not know how useful this is when `Q=1` `O_o`

This being said, it looks like there are two `lucas_*` functions in combinat 

```
sage: sage.combinat.combinat.lucas_number1
<function sage.combinat.combinat.lucas_number1>
sage: sage.combinat.combinat.lucas_number2
<function sage.combinat.combinat.lucas_number2>
```

And all lucas functions should probably be linked toward each other (with `.. seealso::` sections) if not implemented at the same place. If they do not do the same job already.

Perhaps it would even be better to change the current `lucas_*` functions so that one can compute the numbers themselves, or modulo something depending on the input.

Then again, having `slow_lucas`, `fast_lucas` and `lucas` definitely looks too much. Couldn't all three implementations be available in the same function ? With a flag to decide which one should be used ? All the code could be in the same function by the way..

And well. Given that this code is 2yo, perhaps an email should be sent to sage-devel to find guys who know what this code does and review it. 2years is a long time `^^;`

Nathann


---

Comment by jpflori created at 2013-12-27 10:14:57

I more or less know what the code does (and on top of that need it for some computations and quite sure other people could benefit from it), it's just I've been too lazy to refactor since it was originally written by some nice students at ECC 2011.

Maybe Paul would be interested and he surely knows what this is about.


---

Comment by tscrim created at 2013-12-27 18:20:38

Here's a branch version of this (no rebasing was required) and I fixed up some docstring formatting and deprecated `slow_lucas()` (see below).

Currently in Sage, `slow_lucas` uses the recursive definition which works for arbitrary integers, whereas the fast `Q=1` and general both only work in modular arithmetic? Although from the code, there doesn't seem to be anything that explicitly uses `n`, so I would (naively) think that this could work for general integers. I haven't tested this; please correct me if I'm wrong. Also I vote to keep the specialized `Q=1` implementation since it is faster.

I've deprecated `slow_lucas` since the more general `BinaryRecurrenceSequence` is faster:

```
sage: from sage.rings.finite_rings.integer_mod import slow_lucas
sage: %timeit L = [slow_lucas(k,1,-1) for k in range(20)]
10 loops, best of 3: 16.4 ms per loop
sage: %timeit L = [slow_lucas(k,1,-1) for k in range(20)]
10 loops, best of 3: 16 ms per loop

sage: %timeit B = BinaryRecurrenceSequence(1, 1, 2, 1)
100000 loops, best of 3: 4.67 us per loop
sage: B = BinaryRecurrenceSequence(1, 1, 2, 1)
sage: %timeit LB = [B(k) for k in range(20)]
1 loops, best of 3: 15.1 ms per loop
sage: %timeit LB = [B(k) for k in range(20)] # There's caching going on
100 loops, best of 3: 7.7 ms per loop
```


Best,

Travis
----
New commits:


---

Comment by jpflori created at 2013-12-28 20:12:14

Thanks for the gitification.

I'm mostly happy with the code.
And with Travis changes.
Let's keep the two fast functions and deprecate the slow one.
I just think we should rename the fast_lucas function to something like lucas_q1.


---

Comment by jpflori created at 2013-12-28 20:15:23

And to answer Travis question, the three functions are only meant for modular integers I think, they live in integer_mod.pyx, though the old one worked for arbirtrary inputs and the math definition completely makes sense.


---

Comment by git created at 2013-12-29 07:16:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2013-12-29 07:18:37

Okay, I've renamed the function (and deprecated the old name just incase). Anything else that we should do?


---

Comment by jpflori created at 2013-12-29 16:22:25

Changing status from needs_work to positive_review.


---

Comment by jpflori created at 2013-12-29 16:22:25

Looks good to me, let's merge it.


---

Comment by zimmerma created at 2014-01-03 09:21:39

> Maybe Paul would be interested and he surely knows what this is about.

sorry with the change to git I am unable to figure out what is the diff with respect to Sage 6.0.
Thus I can only give general comments:

1) it makes no sense to have a `slow_lucas` and a `fast_lucas` function. The philosophy in Sage is to use `algorithm='recurrence'` or `algorithm='matrix_exponentiation'` instead (for example).

2) I don't see why the case Q<>1 could not be implemented either by the recurrence or the matrix
exponentiation.

3) instead of separate functions for ZZ and IntegerModRing(n), it would be nicer to have a single function with an option `ring=ZZ` (default) and `ring=IntegerModRing(15)`.

Paul


---

Comment by jpflori created at 2014-01-03 09:45:18

Thanks for the suggestions Paul.
All of them make sense, ... but note that the code was already structured as it is now witht he fast/slow and Q=1(only for fast)/Q=whatever(only for slow) before this ticket.
This ticket mostly provides a fast and general implementation.
So I suggest to move the refactoring to a follow up ticket (hopefully one of us will take care of it).
If that suits you, I'll open the follow up ticket.


---

Comment by zimmerma created at 2014-01-03 09:47:31

> If that suits you, I'll open the follow up ticket. 

yes please proceed!

Paul


---

Comment by tscrim created at 2014-01-03 15:24:40

Replying to [comment:16 zimmerma]:
> sorry with the change to git I am unable to figure out what is the diff with respect to Sage 6.0.

In trac, you can click on the branch (and wait until all time ends) and see the diff wrt the current beta version (which is the `develop` branch). You can also view the diff from the commits by `git diff <sha1_commit1> <sha1_commit2>`, for example: `git diff ​7c11ef2	​d8c854c` should give you everything that was changed in this ticket.

Best,

Travis


---

Comment by vbraun created at 2014-01-05 00:32:16

Resolution: fixed
