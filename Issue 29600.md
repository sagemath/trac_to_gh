# Issue 29600: Improvement for incidence matrix of polyhedra

Issue created by migration from https://trac.sagemath.org/ticket/29837

Original creator: @kliem

Original creation time: 2020-06-10 10:09:27

CC:  jipilab @laisrast

Keywords: polyhedra, incidence matrix

This ticket collects some improvements for obtaining incidence matrices:

- The method `self._is_zero` is called many times and we can save plenty of time by obtaining it beforehand.
- We can obtain the slack matrix by multiplying the Vrepresentation matrix with the homogenous Vrepresentation. From this we can obtain the incidence matrix (strangely this last step takes up most of the time).

  Unfortunately, matrix multiplication for algebraic fields isn't very efficient. So we need to keep the old method in this case.

Before this ticket:


```
sage: P = polytopes.permutahedron(7)
sage: %time _ = P.incidence_matrix()
CPU times: user 751 ms, sys: 7.95 ms, total: 759 ms
Wall time: 758 ms
sage: P = polytopes.associahedron(['A', 9])
sage: %time _ = P.incidence_matrix()
CPU times: user 1.94 s, sys: 4.03 ms, total: 1.94 s
Wall time: 1.94 s
sage: P = polytopes.hypercube(14)
sage: %time _ = P.incidence_matrix()
CPU times: user 670 ms, sys: 0 ns, total: 670 ms
Wall time: 669 ms
sage: K.<sqrt2> = QuadraticField(2)
sage: P = polytopes.permutahedron(7).dilation(sqrt2)
sage: %time _ = P.incidence_matrix()
CPU times: user 4.1 s, sys: 0 ns, total: 4.1 s
Wall time: 4.1 s
```


With this ticket:


```
sage: P = polytopes.permutahedron(7)
sage: %time _ = P.incidence_matrix()
CPU times: user 236 ms, sys: 15.8 ms, total: 252 ms
Wall time: 251 ms
sage: P = polytopes.associahedron(['A', 9])
sage: %time _ = P.incidence_matrix()
CPU times: user 1.21 s, sys: 52.1 ms, total: 1.27 s
Wall time: 1.27 s
sage: P = polytopes.hypercube(14)
sage: %time _ = P.incidence_matrix()
CPU times: user 247 ms, sys: 8.1 ms, total: 256 ms
Wall time: 255 ms
sage: K.<sqrt2> = QuadraticField(2)
sage: P = polytopes.permutahedron(7).dilation(sqrt2)
sage: %time _ = P.incidence_matrix()
CPU times: user 3.77 s, sys: 3.81 ms, total: 3.77 s
Wall time: 3.77 s
```


Possible follow up: Set up incidence matrix etc. with base ring `GF(2)`.


---

Comment by @kliem created at 2020-06-10 10:10:09

New commits:


---

Comment by @kliem created at 2020-06-10 10:10:09

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-06-10 10:10:09

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @kliem created at 2020-06-10 12:00:05

This should be rebased on #29838 and another ticket that speeds up getting the incidence matrix from the slack matrix.


---

Comment by @kliem created at 2020-06-10 12:00:05

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-06-10 17:06:37

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-06-10 17:06:37

New commits:


---

Comment by mkoeppe created at 2020-06-10 19:55:06

I don't think changing the interface so that GF(2) matrices are returned is a good idea. How about leaving it as ZZ by default, and using a keyword argument for the base ring so it can be overridden.


---

Comment by @kliem created at 2020-06-10 20:00:18

Replying to [comment:7 mkoeppe]:
> I don't think changing the interface so that GF(2) matrices are returned is a good idea. How about leaving it as ZZ by default, and using a keyword argument for the base ring so it can be overridden.
> 

I don't think the change to `GF(2)` was needed to make things better. So I can rewrite some stuff and remove #29839, that would also do it, I think. `sage.matrix.matrix_integer_dense` is probably just as fast or faster than the other one.

I really only thought that this is the more natural thing for a 0/1 matrix. If the more natural thing is base ring integer or `GF(2)` really performs awful, I can just revert that decision.


---

Comment by mkoeppe created at 2020-06-10 20:01:26

See my comment in #29840


---

Comment by @kliem created at 2020-06-10 20:04:32

Changing the base ring of incidence matrices was rejected in #29340.


---

Comment by @kliem created at 2020-06-10 20:04:32

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-06-10 21:07:09

I wish this was implemented using numpy matrices (knows as arrays), which provide faster linear algebra and have built-in methods to manipulate zero patterns of their matrices.


---

Comment by @kliem created at 2020-06-10 22:19:21

I don't know how fast conversion back and forth works. It is true, that numpy is a bit faster, but that doesn't help me if I cannot convert things.

E.g.

```
sage: P = polytopes.associahedron(['A', 9])
sage: %time a = np.array(P.Vrepresentation())
CPU times: user 383 ms, sys: 0 ns, total: 383 ms
Wall time: 382 ms
```


This is already longer than it takes to obtain the entire incidence matrix. Of course this is most likely not an ideal way to convert, but I don't know any better way at the moment.

And conversion back is also slow.

Replying to [comment:11 dimpase]:
> I wish this was implemented using numpy matrices (knows as arrays), which provide faster linear algebra and have built-in methods to manipulate zero patterns of their matrices.


---

Comment by @kliem created at 2020-06-10 22:43:03

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-06-10 22:43:03

New commits:


---

Comment by git created at 2020-06-10 22:43:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-11 09:39:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-17 09:29:51

Last 10 new commits:


---

Comment by @kliem created at 2020-06-30 05:19:54

Needs review.

The the ticket itself is only 3 commits on top of #29838 and #29839, which are both closed now.


---

Comment by tscrim created at 2020-07-01 02:02:06

You might be able to get a little more speed out by doing

```diff
-return x == 0
+return (not x)
```



---

Comment by tscrim created at 2020-07-01 02:05:34

However, whether you make that change or not, you can set a positive review on my behalf.


---

Comment by @kliem created at 2020-07-01 04:29:33

About three percent for `P = polytopes.permutahedron(7).dilation(sqrt2)`.

Thank you.


---

Comment by git created at 2020-07-01 04:30:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-07-01 04:30:26

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-07-05 02:22:48

I am getting this with this ticket in sage-on-gentoo

```
sage -t --long --warn-long 101.0 /usr/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_cdd.py
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_cdd.py", line 508, in sage.geometry.polyhedron.backend_cdd.Polyhedron_RDF_cdd.__init__
Failed example:
    TestSuite(p).run()
Expected nothing
Got:
    Failure in _test_an_affine_basis:
    Traceback (most recent call last):
      File "/usr/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
        test_method(tester=tester)
      File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 2122, in _test_an_affine_basis
        b = self.an_affine_basis()
      File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 2085, in an_affine_basis
        chain = self.a_maximal_chain()[1:]  # we exclude the empty face
      File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 3098, in a_maximal_chain
        comb_chain = self.combinatorial_polyhedron().a_maximal_chain()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/cythonized/sage/misc/cachefunc.c:12875)
        self.cache = f(self._instance)
      File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 3362, in combinatorial_polyhedron
        return CombinatorialPolyhedron(self)
      File "sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx", line 367, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.__init__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/cythonized/sage/geometry/polyhedron/combinatorial_polyhedron/base.c:6786)
        data = data.incidence_matrix()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/cythonized/sage/misc/cachefunc.c:12875)
        self.cache = f(self._instance)
      File "/usr/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 2749, in incidence_matrix
        is_zero == self._is_zero
    UnboundLocalError: local variable 'is_zero' referenced before assignment
    ------------------------------------------------------------
    The following tests failed: _test_an_affine_basis
**********************************************************************
```

seems circular.


---

Comment by tscrim created at 2020-07-05 03:45:21


```diff
-is_zero == self._is_zero
+is_zero = self._is_zero
```



---

Comment by tscrim created at 2020-07-05 03:45:21

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2020-07-05 06:17:33

The problem is that usually the cdd backend figures out the incidence matrix itself for inexact polyhedra. So you don't notice, because `incidence_matrix` is never run (except for the empty polyhedron, hence the error). I should add a doctest for this.


---

Comment by @kliem created at 2020-07-05 07:28:15

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-07-05 07:28:15

I rebased as well.
----
New commits:


---

Comment by tscrim created at 2020-07-05 07:33:30

Trivial tweak, but the formatting is better:

```diff
         Test that this method works for inexact base ring
-        (`cdd` sets the cache already)::
+        (``cdd`` sets the cache already)::
```



---

Comment by git created at 2020-07-05 07:50:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-07-05 07:54:20

Done.

Replying to [comment:28 tscrim]:
> Trivial tweak, but the formatting is better:
> {{{#!diff
>          Test that this method works for inexact base ring
> -        (`cdd` sets the cache already)::
> +        (``cdd`` sets the cache already)::
> }}}


---

Comment by tscrim created at 2020-07-05 09:20:24

Thanks.


---

Comment by tscrim created at 2020-07-05 09:20:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-10 19:34:05

Resolution: fixed
