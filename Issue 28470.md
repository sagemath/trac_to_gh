# Issue 28470: More control on the numerical ODE solver for integrated curves and geodesics

Issue created by migration from https://trac.sagemath.org/ticket/28707

Original creator: egourgoulhon

Original creation time: 2019-11-08 13:45:28

CC:  @florentinj karimvanaelst

Keywords: manifolds, integrated_curve, geodesic

This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters. 

Besides, this ticket makes the `odeint` solver (introduced in #25936) the default one, instead of `rk4_maxima`, since the former is much faster than
the latter, as already noticed in #25936. The method name `'ode_int'` has been changed to `'odeint'`, in order to match with `desolve_odeint()` and the [SciPy name](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) (for backward compatibility, `method='ode_int'` is still accepted though).

Moreover, this ticket performs some improvement of the documentation of integrated curves.


---

Attachment


---

Attachment

In Sage 8.9, when integrating a null geodesic in Schwarzschild spacetime with an impact parameter close to critical (all details are in [this notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb)), the solution obtained with `solve(method='ode_int')` (green in the figure below) differs significantly from those obtained by means of other solvers, for instance the `rkf45` solver (red in the figure below):

![](test_geod_bad.png)

The geodesic arises from the upper right (_(x,y)_ approx. (10, 5)), circles twice around the black hole (the grey area) and then departs away to the lower left (`rkf45` "exact" solution) or to the lower right (`ode_int` bad solution). 
This issue is due to the default values of 1.49012e-8 for the parameters `rtol` and `atol` of
[scipy.integrate.odeint](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) being not sufficient in the present case. Now, with the Sage 8.9 implementation of `IntegratedCurve.solve()`, there is no way to change the values of  `rtol` and `atol`. Thanks to the new argument `**control_param` introduced here this becomes possible. Morevoer, the default values of 
`rtol` and `atol` are changed to 1.e-10. Accordingly, the curves obtained from the `odeint` and  `rkf45` become almost undistinguishable:

![](test_geod.png)

See the [notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb) for a detailed study of the agreement between `odeint` and the other solvers when using the code of this ticket branch.


---

Comment by egourgoulhon created at 2019-11-08 14:27:03

New commits:


---

Comment by egourgoulhon created at 2019-11-08 14:29:17

Changing status from new to needs_review.


---

Comment by git created at 2019-11-08 19:55:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-11 08:25:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-11-11 08:28:45

The above commit fixes a merge conflict with Sage 9.0.beta5, due to #28669.


---

Comment by @FlorentinJ created at 2019-11-12 21:51:51

Changing status from needs_review to positive_review.


---

Comment by @FlorentinJ created at 2019-11-12 21:51:51

Seems perfect to me. Many thanks Éric.

(The failed plugins are only there because of the merge with #28669, no issue here)


---

Comment by egourgoulhon created at 2019-11-12 22:12:30

Replying to [comment:7 gh-FlorentinJ]:
> Seems perfect to me. Many thanks Éric.
> 

Thank you for the review!

> (The failed plugins are only there because of the merge with #28669, no issue here)

I think it's rather an issue with this patchbot: there are many errors and all reports say that they happen "on 0 non-empty lines". The "0" is highly suspicious here...


---

Comment by @FlorentinJ created at 2019-11-12 22:21:22

The diff for the failed plugin only contain 2 lines:



```
--- 9.0.beta5
+++ 9.0.beta5 + #28707
```



Isn't that the reason it failed ?


---

Comment by vbraun created at 2019-11-16 20:15:40

Resolution: fixed
