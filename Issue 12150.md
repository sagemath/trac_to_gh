# Issue 12150: invalid simplification of complex logarithm

archive/issues_012150.json:
```json
{
    "body": "Assignee: @burcin\n\nAs pointed out by J.H. Davenport in this sage-support thread,\n\nhttp://groups.google.com/group/sage-support/browse_thread/thread/f9d2209041775c3e\n\nthe following (invalid) log simplification is made:\n\n\n```\nsage: t = var('t')                        \nsage: assume(t, 'complex')               \nsage: assumptions()                      \n[t is complex]\nsage: f = (1/2)*log(2*t) + (1/2)*log(1/t)\nsage: f.full_simplify()                  \n1/2*log(2)\n```\n\n\nWhen, for example, t=-1,\n\n\n```\nsage: f(t = -1)\nI*pi + 1/2*log(2)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12322\n\n",
    "created_at": "2012-01-18T16:22:09Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "invalid simplification of complex logarithm",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12150",
    "user": "https://github.com/orlitzky"
}
```
Assignee: @burcin

As pointed out by J.H. Davenport in this sage-support thread,

http://groups.google.com/group/sage-support/browse_thread/thread/f9d2209041775c3e

the following (invalid) log simplification is made:


```
sage: t = var('t')                        
sage: assume(t, 'complex')               
sage: assumptions()                      
[t is complex]
sage: f = (1/2)*log(2*t) + (1/2)*log(1/t)
sage: f.full_simplify()                  
1/2*log(2)
```


When, for example, t=-1,


```
sage: f(t = -1)
I*pi + 1/2*log(2)
```


Issue created by migration from https://trac.sagemath.org/ticket/12322





---

archive/issue_comments_141185.json:
```json
{
    "body": "Well, simplification is just that - simplification.  You could investigate each of the various parts of `full_simplify`, but I suspect that `log_simplify` is the culprit, and Maxima's documentation on the function we use for that probably is clear that this kind of thing can happen.  Of course, there could be a Maxima bug lurking as well...",
    "created_at": "2012-01-18T16:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141185",
    "user": "https://github.com/kcrisman"
}
```

Well, simplification is just that - simplification.  You could investigate each of the various parts of `full_simplify`, but I suspect that `log_simplify` is the culprit, and Maxima's documentation on the function we use for that probably is clear that this kind of thing can happen.  Of course, there could be a Maxima bug lurking as well...



---

archive/issue_comments_141186.json:
```json
{
    "body": "Replying to [comment:2 kcrisman]:\n\nThe simplification should always be equivalent to the original expression, though, or it isn't a simplification, it's a truncation (or something else). It doesn't make much sense to have a `simplify()` that doesn't return something equivalent to its argument: if I don't have to give you the right answer, I can simplify anything to zero!\n\nI did check simplify_log() back when this was reported, and that wasn't the culprit. I dug a little deeper and found that it's `simplify_exp()` or `simplify_radical()` that does it. They both use the same maxima function. From the docs:\n\n\n```\nALGORITHM:\n\n       This uses the Maxima \"radcan()\" command. From the Maxima\n       documentation: \"All functionally equivalent forms are mapped into a\n       unique form. For a somewhat larger class of expressions, produces a\n       regular form. Two equivalent expressions in this class do not\n       necessarily have the same appearance, but their difference can be\n       simplified by radcan to zero. For some expressions radcan is quite\n       time consuming. This is the cost of exploring certain relationships\n       among the components of the expression for simplifications based on\n       factoring and partial fraction expansions of exponents.\"\n```\n\n\nThat, at least, doesn't make any mention of invalid simplifications.",
    "created_at": "2012-01-18T17:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141186",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:2 kcrisman]:

The simplification should always be equivalent to the original expression, though, or it isn't a simplification, it's a truncation (or something else). It doesn't make much sense to have a `simplify()` that doesn't return something equivalent to its argument: if I don't have to give you the right answer, I can simplify anything to zero!

I did check simplify_log() back when this was reported, and that wasn't the culprit. I dug a little deeper and found that it's `simplify_exp()` or `simplify_radical()` that does it. They both use the same maxima function. From the docs:


```
ALGORITHM:

       This uses the Maxima "radcan()" command. From the Maxima
       documentation: "All functionally equivalent forms are mapped into a
       unique form. For a somewhat larger class of expressions, produces a
       regular form. Two equivalent expressions in this class do not
       necessarily have the same appearance, but their difference can be
       simplified by radcan to zero. For some expressions radcan is quite
       time consuming. This is the cost of exploring certain relationships
       among the components of the expression for simplifications based on
       factoring and partial fraction expansions of exponents."
```


That, at least, doesn't make any mention of invalid simplifications.



---

archive/issue_comments_141187.json:
```json
{
    "body": "Ah, [radcan](http://trac.sagemath.org/sage_trac/search?q=radcan).  Our favorite [problem](http://ask.sagemath.org/question/767/simplification-errors-in-simple-expressions) in Sage simplification - see #8497 for the last time this became a brouhaha.  See #11912 for the followup to that, and #11668 for why this probably is happening (temporarily going to reals for the domain), and #3520 for yet another example.\n\nBasically, we have a difference of opinion between some users and Maxima as to what a simplification is.  Is it a simplification of *symbolic expressions* which may be multivalued, or a simplification of functions?\n\nGood luck finding a resolution; I have no good ideas on these issues right now, having wrestled with the other tickets in vain.  I think it would be unfortunate to remove `radcan` from full simplification.",
    "created_at": "2012-01-18T17:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141187",
    "user": "https://github.com/kcrisman"
}
```

Ah, [radcan](http://trac.sagemath.org/sage_trac/search?q=radcan).  Our favorite [problem](http://ask.sagemath.org/question/767/simplification-errors-in-simple-expressions) in Sage simplification - see #8497 for the last time this became a brouhaha.  See #11912 for the followup to that, and #11668 for why this probably is happening (temporarily going to reals for the domain), and #3520 for yet another example.

Basically, we have a difference of opinion between some users and Maxima as to what a simplification is.  Is it a simplification of *symbolic expressions* which may be multivalued, or a simplification of functions?

Good luck finding a resolution; I have no good ideas on these issues right now, having wrestled with the other tickets in vain.  I think it would be unfortunate to remove `radcan` from full simplification.



---

archive/issue_comments_141188.json:
```json
{
    "body": "I'm of the opinion that a `simplify` that sometimes makes invalid simplifications is like a car whose brakes work only 9/10 times. It's better than a car with no brakes, I guess, but unless they work essentially 100% of the time, I'm walking.\n\nHow do I as a user know whether or not I can trust the result? Can I trust the results for e.g. publication (or even homework)? Or should I treat them like `random_element()`? In some cases the results can be checked by hand, but in many, they can't -- that's why I'm using sage in the first place!\n\nAnyway, thanks for finding those other tickets for me. I'm ranting in general and not at you =) I'll read through them all when I have some free time and coffee. Maybe there's a way to make everyone happy.",
    "created_at": "2012-01-18T17:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141188",
    "user": "https://github.com/orlitzky"
}
```

I'm of the opinion that a `simplify` that sometimes makes invalid simplifications is like a car whose brakes work only 9/10 times. It's better than a car with no brakes, I guess, but unless they work essentially 100% of the time, I'm walking.

How do I as a user know whether or not I can trust the result? Can I trust the results for e.g. publication (or even homework)? Or should I treat them like `random_element()`? In some cases the results can be checked by hand, but in many, they can't -- that's why I'm using sage in the first place!

Anyway, thanks for finding those other tickets for me. I'm ranting in general and not at you =) I'll read through them all when I have some free time and coffee. Maybe there's a way to make everyone happy.



---

archive/issue_comments_141189.json:
```json
{
    "body": "Hee hee :)\n\nAgain, the real problem is that we are trying to treat \"expressions\" as \"functions\", I think.  You should feel free to create a Maxima-only example and ask their list; I'd be intrigued to see what they say.  Again, I have not looked into this closely; it could be an actual bug.",
    "created_at": "2012-01-18T20:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141189",
    "user": "https://github.com/kcrisman"
}
```

Hee hee :)

Again, the real problem is that we are trying to treat "expressions" as "functions", I think.  You should feel free to create a Maxima-only example and ask their list; I'd be intrigued to see what they say.  Again, I have not looked into this closely; it could be an actual bug.



---

archive/issue_comments_141190.json:
```json
{
    "body": "I reported this upstream at,\n\nhttps://sourceforge.net/tracker/?func=detail&aid=3476031&group_id=4933&atid=104933",
    "created_at": "2012-01-19T13:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141190",
    "user": "https://github.com/orlitzky"
}
```

I reported this upstream at,

https://sourceforge.net/tracker/?func=detail&aid=3476031&group_id=4933&atid=104933



---

archive/issue_comments_141191.json:
```json
{
    "body": "Doctest the fix from #12737.",
    "created_at": "2012-03-24T00:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141191",
    "user": "https://github.com/orlitzky"
}
```

Doctest the fix from #12737.



---

archive/issue_comments_141192.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-24T00:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141192",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141193.json:
```json
{
    "body": "Attachment [sage-trac_12322.patch](tarball://root/attachments/some-uuid/ticket12322/sage-trac_12322.patch) by @orlitzky created at 2012-03-24 00:17:43\n\nThis is undoubtedly what the doctest will look like, but it probably doesn't make much sense to review this until #12737 is finished.",
    "created_at": "2012-03-24T00:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141193",
    "user": "https://github.com/orlitzky"
}
```

Attachment [sage-trac_12322.patch](tarball://root/attachments/some-uuid/ticket12322/sage-trac_12322.patch) by @orlitzky created at 2012-03-24 00:17:43

This is undoubtedly what the doctest will look like, but it probably doesn't make much sense to review this until #12737 is finished.



---

archive/issue_comments_141194.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-06-12T19:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141194",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141195.json:
```json
{
    "body": "This probably needs an update about the word 'unsafe', that having left #12737.  Trivial to change.  I've also inquired again about the upstream, in case this ends up being orthogonal.",
    "created_at": "2013-06-12T19:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141195",
    "user": "https://github.com/kcrisman"
}
```

This probably needs an update about the word 'unsafe', that having left #12737.  Trivial to change.  I've also inquired again about the upstream, in case this ends up being orthogonal.



---

archive/issue_comments_141196.json:
```json
{
    "body": "I must have missed this in the great trac email blackout. I'll try to figure out the git workflow and update the patch.",
    "created_at": "2013-12-07T02:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141196",
    "user": "https://github.com/orlitzky"
}
```

I must have missed this in the great trac email blackout. I'll try to figure out the git workflow and update the patch.



---

archive/issue_comments_141197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-07T04:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_141198.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-12-07T04:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141198",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141199.json:
```json
{
    "body": "Needs to be rebased.",
    "created_at": "2013-12-20T10:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141199",
    "user": "https://github.com/jdemeyer"
}
```

Needs to be rebased.



---

archive/issue_comments_141200.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-12-20T10:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141200",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141201.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:",
    "created_at": "2013-12-20T16:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141201",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:



---

archive/issue_comments_141202.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-12-20T16:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141202",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141203.json:
```json
{
    "body": "Replying to [comment:21 git]:\n> ||[55eb0aa](http://git.sagemath.org/sage.git/commit/?id=55eb0aa)||`Trac #12322: Add a doctest for the correct behavior introduced in trac #12737.`||\n\nNice, git will let me be bad. Since this is a trivial patch, I rebased (that's `git rebase`) on top of master.",
    "created_at": "2013-12-20T16:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141203",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:21 git]:
> ||[55eb0aa](http://git.sagemath.org/sage.git/commit/?id=55eb0aa)||`Trac #12322: Add a doctest for the correct behavior introduced in trac #12737.`||

Nice, git will let me be bad. Since this is a trivial patch, I rebased (that's `git rebase`) on top of master.



---

archive/issue_comments_141204.json:
```json
{
    "body": "I'd remove the call to `assume()` from the test, since I think there is a consensus that symbolic variables are complex by default. What do you think?",
    "created_at": "2013-12-21T19:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141204",
    "user": "https://github.com/mezzarobba"
}
```

I'd remove the call to `assume()` from the test, since I think there is a consensus that symbolic variables are complex by default. What do you think?



---

archive/issue_comments_141205.json:
```json
{
    "body": "The symbolic domain situation is pretty muddy. We want variables to be complex by default, and we set the Maxima \"domain\" to complex for each new symbolic variable. But, that isn't always enough to affect simplifications. Some parts of Maxima use the \"domain\", others use assumptions, some use neither, and I'll bet one or two use both.\n\nThe complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.",
    "created_at": "2013-12-21T20:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141205",
    "user": "https://github.com/orlitzky"
}
```

The symbolic domain situation is pretty muddy. We want variables to be complex by default, and we set the Maxima "domain" to complex for each new symbolic variable. But, that isn't always enough to affect simplifications. Some parts of Maxima use the "domain", others use assumptions, some use neither, and I'll bet one or two use both.

The complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.



---

archive/issue_comments_141206.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-21T20:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141206",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141207.json:
```json
{
    "body": "Replying to [comment:24 mjo]:\n> The complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.\n\nSure; I am only a bit concerned that having the assumption in the test gives the impression that the variable is real by default. But it's no big deal.",
    "created_at": "2013-12-21T20:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141207",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:24 mjo]:
> The complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.

Sure; I am only a bit concerned that having the assumption in the test gives the impression that the variable is real by default. But it's no big deal.



---

archive/issue_comments_141208.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-22T16:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12150#issuecomment-141208",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
