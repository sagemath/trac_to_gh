# Issue 12150: invalid simplification of complex logarithm

Issue created by migration from https://trac.sagemath.org/ticket/12322

Original creator: mjo

Original creation time: 2012-01-18 16:22:09

Assignee: burcin

As pointed out by J.H. Davenport in this sage-support thread,

http://groups.google.com/group/sage-support/browse_thread/thread/f9d2209041775c3e

the following (invalid) log simplification is made:


```
sage: t = var('t')                        
sage: assume(t, 'complex')               
sage: assumptions()                      
[t is complex]
sage: f = (1/2)*log(2*t) + (1/2)*log(1/t)
sage: f.full_simplify()                  
1/2*log(2)
```


When, for example, t=-1,


```
sage: f(t = -1)
I*pi + 1/2*log(2)
```



---

Comment by kcrisman created at 2012-01-18 16:40:30

Well, simplification is just that - simplification.  You could investigate each of the various parts of `full_simplify`, but I suspect that `log_simplify` is the culprit, and Maxima's documentation on the function we use for that probably is clear that this kind of thing can happen.  Of course, there could be a Maxima bug lurking as well...


---

Comment by mjo created at 2012-01-18 17:15:00

Replying to [comment:2 kcrisman]:

The simplification should always be equivalent to the original expression, though, or it isn't a simplification, it's a truncation (or something else). It doesn't make much sense to have a `simplify()` that doesn't return something equivalent to its argument: if I don't have to give you the right answer, I can simplify anything to zero!

I did check simplify_log() back when this was reported, and that wasn't the culprit. I dug a little deeper and found that it's `simplify_exp()` or `simplify_radical()` that does it. They both use the same maxima function. From the docs:


```
ALGORITHM:

       This uses the Maxima "radcan()" command. From the Maxima
       documentation: "All functionally equivalent forms are mapped into a
       unique form. For a somewhat larger class of expressions, produces a
       regular form. Two equivalent expressions in this class do not
       necessarily have the same appearance, but their difference can be
       simplified by radcan to zero. For some expressions radcan is quite
       time consuming. This is the cost of exploring certain relationships
       among the components of the expression for simplifications based on
       factoring and partial fraction expansions of exponents."
```


That, at least, doesn't make any mention of invalid simplifications.


---

Comment by kcrisman created at 2012-01-18 17:21:43

Ah, [radcan](http://trac.sagemath.org/sage_trac/search?q=radcan).  Our favorite [problem](http://ask.sagemath.org/question/767/simplification-errors-in-simple-expressions) in Sage simplification - see #8497 for the last time this became a brouhaha.  See #11912 for the followup to that, and #11668 for why this probably is happening (temporarily going to reals for the domain), and #3520 for yet another example.

Basically, we have a difference of opinion between some users and Maxima as to what a simplification is.  Is it a simplification of _symbolic expressions_ which may be multivalued, or a simplification of functions?

Good luck finding a resolution; I have no good ideas on these issues right now, having wrestled with the other tickets in vain.  I think it would be unfortunate to remove `radcan` from full simplification.


---

Comment by mjo created at 2012-01-18 17:40:33

I'm of the opinion that a `simplify` that sometimes makes invalid simplifications is like a car whose brakes work only 9/10 times. It's better than a car with no brakes, I guess, but unless they work essentially 100% of the time, I'm walking.

How do I as a user know whether or not I can trust the result? Can I trust the results for e.g. publication (or even homework)? Or should I treat them like `random_element()`? In some cases the results can be checked by hand, but in many, they can't -- that's why I'm using sage in the first place!

Anyway, thanks for finding those other tickets for me. I'm ranting in general and not at you =) I'll read through them all when I have some free time and coffee. Maybe there's a way to make everyone happy.


---

Comment by kcrisman created at 2012-01-18 20:37:52

Hee hee :)

Again, the real problem is that we are trying to treat "expressions" as "functions", I think.  You should feel free to create a Maxima-only example and ask their list; I'd be intrigued to see what they say.  Again, I have not looked into this closely; it could be an actual bug.


---

Comment by mjo created at 2012-01-19 13:14:44

I reported this upstream at,

https://sourceforge.net/tracker/?func=detail&aid=3476031&group_id=4933&atid=104933


---

Comment by mjo created at 2012-03-24 00:15:06

Doctest the fix from #12737.


---

Comment by mjo created at 2012-03-24 00:17:43

Changing status from new to needs_review.


---

Attachment

This is undoubtedly what the doctest will look like, but it probably doesn't make much sense to review this until #12737 is finished.


---

Comment by kcrisman created at 2013-06-12 19:42:34

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2013-06-12 19:42:34

This probably needs an update about the word 'unsafe', that having left #12737.  Trivial to change.  I've also inquired again about the upstream, in case this ends up being orthogonal.


---

Comment by mjo created at 2013-12-07 02:43:52

I must have missed this in the great trac email blackout. I'll try to figure out the git workflow and update the patch.


---

Comment by git created at 2013-12-07 04:26:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2013-12-07 04:28:53

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-12-20 10:47:34

Needs to be rebased.


---

Comment by jdemeyer created at 2013-12-20 10:47:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2013-12-20 16:46:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:


---

Comment by mjo created at 2013-12-20 16:49:18

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2013-12-20 16:49:18

Replying to [comment:21 git]:
> ||[55eb0aa](http://git.sagemath.org/sage.git/commit/?id=55eb0aa)||`Trac #12322: Add a doctest for the correct behavior introduced in trac #12737.`||

Nice, git will let me be bad. Since this is a trivial patch, I rebased (that's `git rebase`) on top of master.


---

Comment by mmezzarobba created at 2013-12-21 19:56:44

I'd remove the call to `assume()` from the test, since I think there is a consensus that symbolic variables are complex by default. What do you think?


---

Comment by mjo created at 2013-12-21 20:17:37

The symbolic domain situation is pretty muddy. We want variables to be complex by default, and we set the Maxima "domain" to complex for each new symbolic variable. But, that isn't always enough to affect simplifications. Some parts of Maxima use the "domain", others use assumptions, some use neither, and I'll bet one or two use both.

The complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.


---

Comment by mmezzarobba created at 2013-12-21 20:36:45

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2013-12-21 20:36:45

Replying to [comment:24 mjo]:
> The complex assumption in the test case wasn't strictly necessary to make it fail, but it highlights the fact that this is a bug only when `t` is complex, and makes it clear that we have done all we can to indicate to sage that `t` is complex.

Sure; I am only a bit concerned that having the assumption in the test gives the impression that the variable is real by default. But it's no big deal.


---

Comment by vbraun created at 2013-12-22 16:53:28

Resolution: fixed
