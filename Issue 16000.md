# Issue 16000: IncidenceStructureFromMatrix bug

Issue created by migration from Trac.

Original creator: knsam

Original creation time: 2014-04-25 14:10:10

CC:  ncohen

The method IncidenceStructureFromMatrix has a serious bug, and it leads to serious errors in computations. We should fix it ASAP. For example, one may test with HadamardDesign (which uses the buggy implementation of IncidenceStructureFromMatrix). Consider the following output:


```
sage: D = designs.HadamardDesign(11); N = D.incidence_matrix()
sage: J = matrix(ZZ, 11, 11, [1]*11*11); N*J
[6 6 6 6 6 6 6 6 6 6 6]
[6 6 6 6 6 6 6 6 6 6 6]
[6 6 6 6 6 6 6 6 6 6 6]
[6 6 6 6 6 6 6 6 6 6 6]
[6 6 6 6 6 6 6 6 6 6 6]
[5 5 5 5 5 5 5 5 5 5 5]
[4 4 4 4 4 4 4 4 4 4 4]
[4 4 4 4 4 4 4 4 4 4 4]
[4 4 4 4 4 4 4 4 4 4 4]
[4 4 4 4 4 4 4 4 4 4 4]
[4 4 4 4 4 4 4 4 4 4 4]
```


The bug is the indexing used in the if-testing in the method. 


---

Comment by ncohen created at 2014-04-25 14:14:43

Are you working on fixing it ?

Nathann


---

Comment by knsam created at 2014-04-25 17:01:28

I have a fix but my GIT foo is not sufficient to upload it! :-( There is only one line of change to make: the if testing condition should be 

```
if M[j, i] != 0
```


as opposed to the `if M[i, j] != 0`. :-) Similarly, I also have code for the HadamardThreeDesign too. :-)


---

Comment by ncohen created at 2014-04-26 15:02:40

You can ask on sage-devel if you have problems with GIT. They are writing a tutorial right now, it may give them ideas...


---

Comment by knsam created at 2014-05-01 08:16:37

New commits:


---

Comment by git created at 2014-05-01 08:22:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by knsam created at 2014-05-01 11:04:33

Changing type from PLEASE CHANGE to defect.


---

Comment by knsam created at 2014-05-01 11:14:40

Firstly, the bug described is mathematical. And, that it is a bug is evident from following the code.  This ticket fixes it and ALL doctests pass. However, the reason I have discovered this bug is itself another bug. So, I think, this ticket can double itself to fix this bug too.

So, the new bug is HadamardDesign method assumes that hadamard_matrix returns a Hadamard matrix whose first row and first column is the all-1 vector while hadamard_matrix method does not. This is why the example given in the method works but the example I describe does not: 


```
sage: hadamard_matrix(8)
[ 1  1  1  1  1  1  1  1]
[ 1 -1  1 -1  1 -1  1 -1]
[ 1  1 -1 -1  1  1 -1 -1]
[ 1 -1 -1  1  1 -1 -1  1]
[ 1  1  1  1 -1 -1 -1 -1]
[ 1 -1  1 -1 -1  1 -1  1]
[ 1  1 -1 -1 -1 -1  1  1]
[ 1 -1 -1  1 -1  1  1 -1]
sage: hadamard_matrix(12)
[ 1  1  1  1  1  1|-1  1  1  1  1  1]
[ 1  1  1 -1 -1  1| 1 -1  1 -1 -1  1]
[ 1  1  1  1 -1 -1| 1  1 -1  1 -1 -1]
[ 1 -1  1  1  1 -1| 1 -1  1 -1  1 -1]
[ 1 -1 -1  1  1  1| 1 -1 -1  1 -1  1]
[ 1  1 -1 -1  1  1| 1  1 -1 -1  1 -1]
[-----------------+-----------------]
[-1  1  1  1  1  1|-1 -1 -1 -1 -1 -1]
[ 1 -1  1 -1 -1  1|-1 -1 -1  1  1 -1]
[ 1  1 -1  1 -1 -1|-1 -1 -1 -1  1  1]
[ 1 -1  1 -1  1 -1|-1  1 -1 -1 -1  1]
[ 1 -1 -1  1 -1  1|-1  1  1 -1 -1 -1]
[ 1  1 -1 -1  1 -1|-1 -1  1  1 -1 -1]
```

 
So, to get the ball rolling, should there be a new method called normalised_hadamard_matrix or should we let the method hadamard_matrix take an optional argument like normalised=True or sth like that? 

Any suggestions would be welcome.


---

Comment by ncohen created at 2014-05-01 12:19:08

Yooooooooo !!

> So, to get the ball rolling, should there be a new method called normalised_hadamard_matrix or should we let the method hadamard_matrix take an optional argument like normalised=True or sth like that?

Your idea is cool ! I would vote for the optional argument. Though it does not make a lot of sense to set it to "True" by default... So perhaps we can also normalize them automatically before returning them ?

Nathann


---

Comment by knsam created at 2014-05-01 12:23:45

Replying to [comment:8 ncohen]:

> Your idea is cool ! I would vote for the optional argument. Though it does not make a lot of sense to set it to "True" by default... So perhaps we can also normalize them automatically before returning them ?

May be not, because, this is going to take 2n steps for a Hadamard Matrix of order n. And, for many purposes, this is not necessary. So, may be we can have an optional argument and set it to False instead. 

Do you agree?


---

Comment by ncohen created at 2014-05-01 12:28:00

Ahahahah. Okay, as you want. But I do not think these 2n steps will make a difference in any code. Are you sure that creating the matrix takes a linear time ? Or may Python reallocate a partial matrix several times ? Either way is fine !

Nathann


---

Comment by knsam created at 2014-05-02 18:44:20

Changing status from new to needs_review.


---

Comment by knsam created at 2014-05-02 18:44:20

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by knsam created at 2014-05-02 18:44:20

New commits:


---

Comment by knsam created at 2014-05-02 18:47:59

Indeed, the bug that motivated my search is now fixed; with the patch, we have: 

```
sage: D = designs.HadamardDesign(11); N = D.incidence_matrix()
sage: J = matrix(ZZ, 11, 11, [1]*11*11); N*J
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
[5 5 5 5 5 5 5 5 5 5 5]
```



---

Comment by ncohen created at 2014-05-02 19:48:30

Hello !

Several remarks:

1) I do not think you should change the definition of the Paley matrices... I believe they are well-defined, and if you want a normalized version of them you should not change their definition but rather normalize them when you need them. At the very least, you could have an optional argument "normalize" set to False by default in these functions.

2) You seem to use twice the code to normalize a matrix. I guess the best would be to write a function that does that, as it can be useful later, and also useful to the users.

3) There may be a smart way to test if a element of a field is a quadratic residue, but if you need to enumerate all of them anyway you could begin by computing the square of all elements of the field, then decide if each element is a square by testing if it belongs to that list ?... 

Nathann


---

Comment by ncohen created at 2014-05-02 19:48:43

Changing status from needs_review to needs_info.


---

Comment by knsam created at 2014-05-02 20:07:09

Replying to [comment:13 ncohen]:
> Hello !
> 
> Several remarks:
> 
> 1) I do not think you should change the definition of the Paley matrices... I believe they are well-defined, and if you want a normalized version of them you should not change their definition but rather normalize them when you need them. At the very least, you could have an optional argument "normalize" set to False by default in these functions. 

No, I have modified only so much as to remove the edge cases that do not arise. I am not really changing the definition of Paley matrices. There are several floating around in the Literature. I have chosen Horadam's Paley Type I, Type II (I think!). But, this is not standard at all! We could probably have this put explicitly in the documentation. And, this document is not included in the combinat docs! Should we try to add it ? :-) 
 
> 
> 2) You seem to use twice the code to normalize a matrix. I guess the best would be to write a function that does that, as it can be useful later, and also useful to the users.
> 

Good suggestion, I will implement it! 

> 3) There may be a smart way to test if a element of a field is a quadratic residue, but if you need to enumerate all of them anyway you could begin by computing the square of all elements of the field, then decide if each element is a square by testing if it belongs to that list ?... 

There are several faster ways to do this! I am planning on implementing this in a later ticket! But, for now, it shall be a TODO notice!  

Kannappan.


---

Comment by git created at 2014-05-02 20:24:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2014-05-02 21:16:53

Hello Kannappan !!!

Okayokayokayokay, so you implement more or less Horadam's construction with a couple of changes of signs. Okay. It would be nice to clean this file a bit in the future, because right now there is a "return 0" in functions who claim to return entries of Hadamard matrices `:-P`

Anyway. I agree with what your branch does, and I added a reviewer's commit in public/16237 to fix a couple of typoes.

1) The first line of the documentation of a function should be a one-line description of what it does

2) Some people complain where a line ends with spaces ("trailing whitespaces")

3) Some people complain (the same) when the lines are longer than 80 characters.

4) Some people fight over american/english spelling (but as I never remember which ones, I did nothing about that `:-P`

Sooooooooo well.

If you agree with my changes, you can either :

1) Add my commit to your branch

2) Change the branch to public/16237 (remember that you are the only one with writing access to u/knsam/* branches and that everybody can write to public/* branches

About the doc : it seems to be included already http://www.sagemath.org/doc/reference/combinat/sage/combinat/matrices/hadamard_matrix.html

HMmmmmmm... Okay, nothing else to say. Good work !

Nathann

P.S. : The custom is the following : usually, the reviewer sets the ticket to `positive_review`, but in this case I added a commit with small modifications. So if you agree with what it does, you can set the ticket to `positive_review` yourself, as you reviewed my changes and I reviewed yours. And if you do not like something in my commits, the custom is to discuss it and fight to the death.


---

Comment by git created at 2014-05-03 16:49:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by knsam created at 2014-05-03 16:51:11

Changing status from needs_info to positive_review.


---

Comment by knsam created at 2014-05-03 16:51:52

Hi Nathann, 

I have set this ticket to positive review, as we discussed! 

Kannappan.


---

Comment by ncohen created at 2014-05-03 17:19:22

Okayyyyyyyyyy... Well, in this context it is better to add a commit rather than rewrite the last one. Because this way the reviewer can easily see what exactly you changed since the previous commit. If I want to do it now, I have to re-read the whole branch again and try to find out if everything is there `:-P`

Nathann


---

Comment by knsam created at 2014-05-03 20:11:24

Sorry about it, I will do it from the next time! 

Kannappan.


---

Comment by vbraun created at 2014-05-07 06:27:34

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-05-07 06:27:34

Documentation does not build


---

Comment by ncohen created at 2014-05-07 06:57:56

Fixed.
----
New commits:


---

Comment by ncohen created at 2014-05-07 06:57:56

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-05-12 23:17:10

docbuild fails


---

Comment by vbraun created at 2014-05-12 23:17:10

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-05-13 09:06:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-05-13 09:06:42

Changing status from needs_work to positive_review.


---

Comment by ncohen created at 2014-05-13 09:06:42

Fixed.


---

Comment by vbraun created at 2014-05-13 13:11:35

Resolution: fixed
