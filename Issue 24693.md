# Issue 24693: py3: some cmp removal in pyx files

Issue created by migration from https://trac.sagemath.org/ticket/24930

Original creator: chapoton

Original creation time: 2018-03-08 19:27:42

part of #16537


---

Comment by chapoton created at 2018-03-08 19:28:08

New commits:


---

Comment by chapoton created at 2018-03-08 19:28:08

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-03-08 19:31:03

Changing keywords from "" to "python3, richcmp".


---

Comment by tscrim created at 2018-03-08 23:18:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-03-08 23:18:06

LGTM.


---

Comment by jdemeyer created at 2018-03-09 08:59:02

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2018-03-09 09:06:13

1. In `__richcmp__`, you really should deal with the case of different classes. Typically, this is done by adding

```
if not isinstance(other, TheClassThatYouWant):
    return NotImplemented
```

Otherwise, things might break sooner or later (see #19628 for an example of such breakage).

2. Once you did check the class with `isinstance()`, you can do a cast. So replace

```
cdef TheClassThatYouWant x = other
```

by

```
x = <TheClassThatYouWant>other
```

(you can still add `cdef TheClassThatYouWant` but that is redundant).

3. In the light of Cython 0.28, I would prefer to see

```
def __richcmp__(TheClassThatYouWant self, other, int op)
    ...
```

instead of

```
def __richcmp__(self, other, int op)
    cdef TheClassThatYouWant s = self
```

Ideally, Cython should know that `self` is of type `TheClassThatYouWant`. But this is not the case due to a Cython bug which is fixed in version 0.28.


---

Comment by jdemeyer created at 2018-03-09 09:09:34

4. I believe that the code in `intlist.pyx` is actually wrong. The second argument to `rich_to_bool()` must be -1, 0 or 1. If you want to support other integers, you need `rich_to_bool_sgn()`.


---

Comment by embray created at 2018-03-09 10:46:32

FWIW this was my fix for intlist from my Python 3 branch:


```diff
diff --git a/src/sage/stats/intlist.pyx b/src/sage/stats/intlist.pyx
index 6076475..c6d3f8f 100644
--- a/src/sage/stats/intlist.pyx
+++ b/src/sage/stats/intlist.pyx
@@ -32,6 +32,7 @@ from libc.string cimport memcpy
 from cysignals.memory cimport sig_malloc, sig_free
 from cysignals.signals cimport sig_on, sig_off

+from sage.structure.richcmp import rich_to_bool
 from sage.rings.integer import Integer
 from sage.finance.time_series cimport TimeSeries
 from cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString
@@ -116,7 +117,7 @@ cdef class IntList:
             for i in range(self._length):
                 self._values[i] = values[i]

-    def __cmp__(self, _other):
+    def __richcmp__(left, right, op):
         """
         Compare self and other.  This has the same semantics
         as list comparison.
@@ -133,19 +134,22 @@ cdef class IntList:
             sage: w == w
             True
         """
-        cdef IntList other
+        cdef IntList l, r
         cdef Py_ssize_t c, i
         cdef int d
-        if not isinstance(_other, IntList):
-            _other = IntList(_other)
-        other = _other
-        for i in range(min(self._length, other._length)):
-            d = self._values[i] - other._values[i]
-            if d: return -1 if d < 0 else 1
-        c = self._length - other._length
-        if c < 0: return -1
-        elif c > 0: return 1
-        return 0
+        if not isinstance(right, IntList):
+            right = IntList(right)
+        l, r = left, right
+        for i in range(min(l._length, r._length)):
+            d = l._values[i] - r._values[i]
+            if d:
+                return rich_to_bool(op, -1 if d < 0 else 1)
+        c = l._length - r._length
+        if c < 0:
+            return rich_to_bool(op, -1)
+        elif c > 0:
+            return rich_to_bool(op, +1)
+        return rich_to_bool(op, 0)
```



---

Comment by git created at 2018-03-09 18:19:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-03-09 18:21:53

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-11 10:54:03

There is an rc of Cython 0.28 (#24111), so you might as well wait for that.


---

Comment by chapoton created at 2018-03-11 19:04:22

Well, time is flying, and there is no really good reason to wait..


---

Comment by jdemeyer created at 2018-03-13 14:42:25

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-03-13 14:50:55

It looks good to me--we can revisit some of the `__richcmp__ -> __eq__` rewrites once we can fully depend on Cython 0.28.


---

Comment by vbraun created at 2018-03-22 19:23:35

Resolution: fixed
