# Issue 34356: Document and manage temporary directories

Issue created by migration from https://trac.sagemath.org/ticket/34593

Original creator: jhpalmieri

Original creation time: 2022-09-27 19:10:39

This is a followup to #33212. Some users prefer (or need) to control where temporary files are created, and we should document this:

- as described at https://docs.python.org/3/library/tempfile.html#tempfile.gettempdir, users can set the environment variable `TMPDIR`

Also, according to https://manpages.ubuntu.com/manpages/bionic/man8/tmpreaper.8.html, at least on some systems it would be helpful to create a non-writable file `.tmpreaper` in the directory to prevent the system from doing automatic cleanup on it.


---

Comment by jhpalmieri created at 2022-09-27 19:12:54

Of course I don't know _where_ we should document this, since it's a Python feature which may be used in various components of Sage. I don't know the natural home for it.


---

Comment by egourgoulhon created at 2022-09-28 11:52:37

Regarding the ticket title, IMHO the objective should be more "manage" than "document" since 3D plots are badly broken in Sage 9.7 for (at least) Ubuntu 22.04 users with the default settings, as revealed by https://ask.sagemath.org/question/64192/temporary-html-files-location-in-sage-97/


---

Comment by egourgoulhon created at 2022-09-28 11:53:22

Changing priority from major to critical.


---

Comment by jhpalmieri created at 2022-09-28 19:39:02

Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)


---

Comment by egourgoulhon created at 2022-09-29 12:12:13

Replying to [comment:4 John Palmieri]:
> Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)
This could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends?


---

Comment by dimpase created at 2022-10-13 10:29:03

Replying to [comment:5 Eric Gourgoulhon]:
> Replying to [comment:4 John Palmieri]:
> > Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)
> This could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends? 

I beleive that the cleanup is automatic, using Python's `atexit` callback.
https://docs.python.org/3/library/atexit.html

(there is of course always a chance of a segfault-like abnormal exit, which might leave
rubbish after itself:

```
The functions registered via this module are not called when the program is killed
by a signal not handled by Python, when a Python fatal internal error is detected,
or when os._exit() is called.
```


This is what we have in `src/misc/temporary_file.py`:


```python
import tempfile

import atexit

# Until tmp_dir() and tmp_filename() are removed, we use this directory
# as the parent for all temporary files & directories created by them.
# This lets us clean up after those two functions when sage exits normally
# using an atexit hook
TMP_DIR_FILENAME_BASE=tempfile.TemporaryDirectory()
atexit.register(lambda: TMP_DIR_FILENAME_BASE.cleanup())
```



---

Comment by dimpase created at 2022-10-13 10:54:42

In an environment such as [SageMathCell](SageMathCell), I think one user runs many Sage instances, so one cannot clean anything on startup without risking to affect other instances.


---

Comment by mkoeppe created at 2022-11-21 20:36:18

Let's move the documentation of runtime environment variables, starting at "Sage uses the following environment variables when it runs:" https://doc.sagemath.org/html/en/installation/source.html  to the "Launching section" and add TMPDIR there (perhaps pointer to Python runtime environment variables)


---

Comment by jhpalmieri created at 2022-11-21 20:42:57

It's not just Sage, it's a general Jupyter problem. See https://github.com/ContinuumIO/anaconda-issues/issues/12891 and https://askubuntu.com/questions/1389798/how-to-correctly-configure-snapd-firefox-to-open-local-html-file-generated-by.


---

Comment by jhpalmieri created at 2022-11-21 20:47:18

And also https://github.com/jupyter/notebook/issues/4500.


---

Comment by jhpalmieri created at 2022-11-23 19:40:16

Here is an addition to the documentation.
----
New commits:


---

Comment by jhpalmieri created at 2022-11-23 19:40:16

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-11-24 22:13:42

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-11-25 18:14:54

Thank you!


---

Comment by vbraun created at 2022-12-11 11:11:54

Resolution: fixed
