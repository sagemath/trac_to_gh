# Issue 34356: Document and manage temporary directories

archive/issues_034356.json:
```json
{
    "body": "This is a followup to #33212. Some users prefer (or need) to control where temporary files are created, and we should document this:\n\n- as described at https://docs.python.org/3/library/tempfile.html#tempfile.gettempdir, users can set the environment variable `TMPDIR`\n\nAlso, according to https://manpages.ubuntu.com/manpages/bionic/man8/tmpreaper.8.html, at least on some systems it would be helpful to create a non-writable file `.tmpreaper` in the directory to prevent the system from doing automatic cleanup on it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34593\n\n",
    "created_at": "2022-09-27T19:10:39Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Document and manage temporary directories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34356",
    "user": "https://github.com/jhpalmieri"
}
```
This is a followup to #33212. Some users prefer (or need) to control where temporary files are created, and we should document this:

- as described at https://docs.python.org/3/library/tempfile.html#tempfile.gettempdir, users can set the environment variable `TMPDIR`

Also, according to https://manpages.ubuntu.com/manpages/bionic/man8/tmpreaper.8.html, at least on some systems it would be helpful to create a non-writable file `.tmpreaper` in the directory to prevent the system from doing automatic cleanup on it.

Issue created by migration from https://trac.sagemath.org/ticket/34593





---

archive/issue_comments_486553.json:
```json
{
    "body": "Of course I don't know *where* we should document this, since it's a Python feature which may be used in various components of Sage. I don't know the natural home for it.",
    "created_at": "2022-09-27T19:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486553",
    "user": "https://github.com/jhpalmieri"
}
```

Of course I don't know *where* we should document this, since it's a Python feature which may be used in various components of Sage. I don't know the natural home for it.



---

archive/issue_comments_486554.json:
```json
{
    "body": "Regarding the ticket title, IMHO the objective should be more \"manage\" than \"document\" since 3D plots are badly broken in Sage 9.7 for (at least) Ubuntu 22.04 users with the default settings, as revealed by https://ask.sagemath.org/question/64192/temporary-html-files-location-in-sage-97/",
    "created_at": "2022-09-28T11:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486554",
    "user": "https://github.com/egourgoulhon"
}
```

Regarding the ticket title, IMHO the objective should be more "manage" than "document" since 3D plots are badly broken in Sage 9.7 for (at least) Ubuntu 22.04 users with the default settings, as revealed by https://ask.sagemath.org/question/64192/temporary-html-files-location-in-sage-97/



---

archive/issue_comments_486555.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-09-28T11:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486555",
    "user": "https://github.com/egourgoulhon"
}
```

Changing priority from major to critical.



---

archive/issue_comments_486556.json:
```json
{
    "body": "Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)",
    "created_at": "2022-09-28T19:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486556",
    "user": "https://github.com/jhpalmieri"
}
```

Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)



---

archive/issue_comments_486557.json:
```json
{
    "body": "Replying to [comment:4 John Palmieri]:\n> Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)\n\nThis could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends?",
    "created_at": "2022-09-29T12:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486557",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:4 John Palmieri]:
> Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)

This could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends?



---

archive/issue_comments_486558.json:
```json
{
    "body": "Replying to [comment:5 Eric Gourgoulhon]:\n> Replying to [comment:4 John Palmieri]:\n> > Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)\n\n> This could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends? \n\nI beleive that the cleanup is automatic, using Python's `atexit` callback.\nhttps://docs.python.org/3/library/atexit.html\n\n(there is of course always a chance of a segfault-like abnormal exit, which might leave\nrubbish after itself:\n\n```\nThe functions registered via this module are not called when the program is killed\nby a signal not handled by Python, when a Python fatal internal error is detected,\nor when os._exit() is called.\n```\n\nThis is what we have in `src/misc/temporary_file.py`:\n\n```python\nimport tempfile\n\nimport atexit\n\n# Until tmp_dir() and tmp_filename() are removed, we use this directory\n# as the parent for all temporary files & directories created by them.\n# This lets us clean up after those two functions when sage exits normally\n# using an atexit hook\nTMP_DIR_FILENAME_BASE=tempfile.TemporaryDirectory()\natexit.register(lambda: TMP_DIR_FILENAME_BASE.cleanup())\n```",
    "created_at": "2022-10-13T10:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486558",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:5 Eric Gourgoulhon]:
> Replying to [comment:4 John Palmieri]:
> > Should Sage itself set the environment variable `TMPDIR`? (If the user hasn't set it, I mean.)

> This could a solution, for instance defining `TMPDIR` to be a subdirectory of `DOT_SAGE`. But there may be some undesirable effects, e.g. for Sage running on servers or [SageMathCell](SageMathCell). Also would it be desirable/doable to clean that directory when the Sage session ends? 

I beleive that the cleanup is automatic, using Python's `atexit` callback.
https://docs.python.org/3/library/atexit.html

(there is of course always a chance of a segfault-like abnormal exit, which might leave
rubbish after itself:

```
The functions registered via this module are not called when the program is killed
by a signal not handled by Python, when a Python fatal internal error is detected,
or when os._exit() is called.
```

This is what we have in `src/misc/temporary_file.py`:

```python
import tempfile

import atexit

# Until tmp_dir() and tmp_filename() are removed, we use this directory
# as the parent for all temporary files & directories created by them.
# This lets us clean up after those two functions when sage exits normally
# using an atexit hook
TMP_DIR_FILENAME_BASE=tempfile.TemporaryDirectory()
atexit.register(lambda: TMP_DIR_FILENAME_BASE.cleanup())
```



---

archive/issue_comments_486559.json:
```json
{
    "body": "In an environment such as [SageMathCell](SageMathCell), I think one user runs many Sage instances, so one cannot clean anything on startup without risking to affect other instances.",
    "created_at": "2022-10-13T10:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486559",
    "user": "https://github.com/dimpase"
}
```

In an environment such as [SageMathCell](SageMathCell), I think one user runs many Sage instances, so one cannot clean anything on startup without risking to affect other instances.



---

archive/issue_comments_486560.json:
```json
{
    "body": "Let's move the documentation of runtime environment variables, starting at \"Sage uses the following environment variables when it runs:\" https://doc.sagemath.org/html/en/installation/source.html  to the \"Launching section\" and add TMPDIR there (perhaps pointer to Python runtime environment variables)",
    "created_at": "2022-11-21T20:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486560",
    "user": "https://github.com/mkoeppe"
}
```

Let's move the documentation of runtime environment variables, starting at "Sage uses the following environment variables when it runs:" https://doc.sagemath.org/html/en/installation/source.html  to the "Launching section" and add TMPDIR there (perhaps pointer to Python runtime environment variables)



---

archive/issue_comments_486561.json:
```json
{
    "body": "It's not just Sage, it's a general Jupyter problem. See https://github.com/ContinuumIO/anaconda-issues/issues/12891 and https://askubuntu.com/questions/1389798/how-to-correctly-configure-snapd-firefox-to-open-local-html-file-generated-by.",
    "created_at": "2022-11-21T20:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486561",
    "user": "https://github.com/jhpalmieri"
}
```

It's not just Sage, it's a general Jupyter problem. See https://github.com/ContinuumIO/anaconda-issues/issues/12891 and https://askubuntu.com/questions/1389798/how-to-correctly-configure-snapd-firefox-to-open-local-html-file-generated-by.



---

archive/issue_comments_486562.json:
```json
{
    "body": "And also https://github.com/jupyter/notebook/issues/4500.",
    "created_at": "2022-11-21T20:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486562",
    "user": "https://github.com/jhpalmieri"
}
```

And also https://github.com/jupyter/notebook/issues/4500.



---

archive/issue_comments_486563.json:
```json
{
    "body": "Here is an addition to the documentation.\n\n---\nNew commits:",
    "created_at": "2022-11-23T19:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486563",
    "user": "https://github.com/jhpalmieri"
}
```

Here is an addition to the documentation.

---
New commits:



---

archive/issue_comments_486564.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-23T19:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486564",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486565.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-24T22:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486565",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486566.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-11-25T18:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486566",
    "user": "https://github.com/jhpalmieri"
}
```

Thank you!



---

archive/issue_comments_486567.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-12-11T11:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34356#issuecomment-486567",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_089671.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-12-11T11:11:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34356",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34356#event-89671"
}
```
