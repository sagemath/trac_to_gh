# Issue 32936: Off-by-one error in CFiniteSequence slices

archive/issues_032936.json:
```json
{
    "body": "Keywords: CFiniteSequence, recurrence, rings, slice\n\nI was trying to calculate the finite differences of http://oeis.org/A000127 as follows:\n\n\n\n```sage\nC.<x> = CFiniteSequences(QQ)\nS = C.guess([1, 2, 4, 8, 16, 31, 57, 99, 163, 256, 386, 562, 794, 1093])\nX = C(x)\n\nS[0:10]         # [ 1, 2, 4, 8, 16, 31, 57, 99, 163, 256 ]\n(X*S)[0:10]     # [ 0, 1, 2, 4, 8, 16, 31, 31, 57, 99 ]\n(S - X*S)[0:10] # [ 1, 1, 2, 4, 8, 26, 42, 64, 93, 130 ]\n\nf(n) = (S - X*S).closed_form()\n[f(n) for n in range(10)] # [ 0, 1, 2, 4, 8, 15, 26, 42, 64, 93 ]\n```\n\n\nFor some reason, the slice operator is skipping `S[5] = 15` and yielding `26` instead. Here is the sequence in recurrence form:\n\n\n\n```sage\nT = C.from_recurrence([-1,4,-6,4],[1,1,2,4,8])\nT == S - X*S # True\n4 * T[4] - 6 * T[3] + 4 * T[2] - T[1] == T[5] # 15 == 26\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33173\n\n",
    "created_at": "2022-01-14T20:47:41Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "title": "Off-by-one error in CFiniteSequence slices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32936",
    "user": "@trevorgunn"
}
```
Keywords: CFiniteSequence, recurrence, rings, slice

I was trying to calculate the finite differences of http://oeis.org/A000127 as follows:



```sage
C.<x> = CFiniteSequences(QQ)
S = C.guess([1, 2, 4, 8, 16, 31, 57, 99, 163, 256, 386, 562, 794, 1093])
X = C(x)

S[0:10]         # [ 1, 2, 4, 8, 16, 31, 57, 99, 163, 256 ]
(X*S)[0:10]     # [ 0, 1, 2, 4, 8, 16, 31, 31, 57, 99 ]
(S - X*S)[0:10] # [ 1, 1, 2, 4, 8, 26, 42, 64, 93, 130 ]

f(n) = (S - X*S).closed_form()
[f(n) for n in range(10)] # [ 0, 1, 2, 4, 8, 15, 26, 42, 64, 93 ]
```


For some reason, the slice operator is skipping `S[5] = 15` and yielding `26` instead. Here is the sequence in recurrence form:



```sage
T = C.from_recurrence([-1,4,-6,4],[1,1,2,4,8])
T == S - X*S # True
4 * T[4] - 6 * T[3] + 4 * T[2] - T[1] == T[5] # 15 == 26
```


Issue created by migration from https://trac.sagemath.org/ticket/33173





---

archive/issue_comments_469871.json:
```json
{
    "body": "The error seems to occur when the length of the initial values is 1 more than the coefficients.\n\n\n\n```sage\nC.from_recurrence([1,1],[1,1,1])[0:10]   # [ 1, 1, 1, 3, 5, 8, 13, 21, 34, 55 ]\nC.from_recurrence([1,1],[1,1,1,1])[0:10] # [ 1, 1, 1, 1, 2, 3, 5, 8, 13, 21 ]\n```\n",
    "created_at": "2022-01-14T22:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469871",
    "user": "@trevorgunn"
}
```

The error seems to occur when the length of the initial values is 1 more than the coefficients.



```sage
C.from_recurrence([1,1],[1,1,1])[0:10]   # [ 1, 1, 1, 3, 5, 8, 13, 21, 34, 55 ]
C.from_recurrence([1,1],[1,1,1,1])[0:10] # [ 1, 1, 1, 1, 2, 3, 5, 8, 13, 21 ]
```




---

archive/issue_comments_469872.json:
```json
{
    "body": "I believe I've tracked down the problem.\n\n\n\n```python\n# determine start values (may be different from _get_item_ values)\nalen = max(self._deg, num.degree() + 1)\nR = LaurentSeriesRing(br, parent.variable_name(), default_prec=alen)\nrem = num % den\nif den != 1:\n    self._a = R(num / den).list()\n    self._aa = R(rem / den).list()[:self._deg]  # needed for _get_item_\nelse:\n    self._a = num.list()\nif len(self._a) < alen:\n    self._a.extend([0] * (alen - len(self._a)))\n```\n\n\nIn the initializer, `R(rem / den).list()` starts at the first non-zero coefficient. For the example above `C.from_recurrence([1,1],[1,1,1])` has `rem = x` and the extra 0 isn't accounted for in the list. This is necessary for `self._aa` in order to get the correct answers.\n\nI will see if I can write a patch.",
    "created_at": "2022-01-15T20:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469872",
    "user": "@trevorgunn"
}
```

I believe I've tracked down the problem.



```python
# determine start values (may be different from _get_item_ values)
alen = max(self._deg, num.degree() + 1)
R = LaurentSeriesRing(br, parent.variable_name(), default_prec=alen)
rem = num % den
if den != 1:
    self._a = R(num / den).list()
    self._aa = R(rem / den).list()[:self._deg]  # needed for _get_item_
else:
    self._a = num.list()
if len(self._a) < alen:
    self._a.extend([0] * (alen - len(self._a)))
```


In the initializer, `R(rem / den).list()` starts at the first non-zero coefficient. For the example above `C.from_recurrence([1,1],[1,1,1])` has `rem = x` and the extra 0 isn't accounted for in the list. This is necessary for `self._aa` in order to get the correct answers.

I will see if I can write a patch.



---

archive/issue_comments_469873.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-15T21:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469873",
    "user": "@trevorgunn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-15T22:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469874",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469875.json:
```json
{
    "body": "New tests are failing (these errors have something to do with the offset rather than the `_aa` vector)\n\n\n```\n**********************************************************************\nFile \"cfinite_sequence.py\", line 644, in sage.rings.cfinite_sequence.?.__getitem__\nFailed example:\n    s = x^2 * C.guess([1,2,3,4,5,6]); s[0:10]\nExpected:\n    [0, 0, 1, 2, 3, 4, 5, 6, 7, 8]\nGot:\n    [0, 0, 1, 2, 3, 2, 3, 4, 5, 6]\n**********************************************************************\nFile \"cfinite_sequence.py\", line 646, in sage.rings.cfinite_sequence.?.__getitem__\nFailed example:\n    s = x^3 * C.guess([1,2,3,4,5,6]); s[0:10]\nExpected:\n    [0, 0, 0, 1, 2, 3, 4, 5, 6, 7]\nGot:\n    [0, 0, 0, 1, 2, 3, 4, 2, 3, 4]\n**********************************************************************\n\n```\n",
    "created_at": "2022-01-16T00:27:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469875",
    "user": "@trevorgunn"
}
```

New tests are failing (these errors have something to do with the offset rather than the `_aa` vector)


```
**********************************************************************
File "cfinite_sequence.py", line 644, in sage.rings.cfinite_sequence.?.__getitem__
Failed example:
    s = x^2 * C.guess([1,2,3,4,5,6]); s[0:10]
Expected:
    [0, 0, 1, 2, 3, 4, 5, 6, 7, 8]
Got:
    [0, 0, 1, 2, 3, 2, 3, 4, 5, 6]
**********************************************************************
File "cfinite_sequence.py", line 646, in sage.rings.cfinite_sequence.?.__getitem__
Failed example:
    s = x^3 * C.guess([1,2,3,4,5,6]); s[0:10]
Expected:
    [0, 0, 0, 1, 2, 3, 4, 5, 6, 7]
Got:
    [0, 0, 0, 1, 2, 3, 4, 2, 3, 4]
**********************************************************************

```




---

archive/issue_comments_469876.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-16T00:27:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469876",
    "user": "@trevorgunn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_469877.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-16T00:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469877",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469878.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-16T00:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469878",
    "user": "@trevorgunn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_469879.json:
```json
{
    "body": "Each commit addresses a separate bug. The first bug is that `R(rem / den).list()` needs to include the initial zeroes from the Taylor series. This causes the test\n\n\n```sage\nsage: s = C.from_recurrence([1,1],[1,1,1])\nsage: s[0:5]\n[1, 1, 1, 2, 3]\n```\n\n\nto fail.\n\nThe second bug is that when we are using `self._aa` it is because we are computing from degree 0 and this needs to be addressed by resetting the offset to 0. This causes the tests\n\n\n```sage\nsage: s = C(x^2 * (1 - x)^-2); s[0:10]\n[0, 0, 1, 2, 3, 4, 5, 6, 7, 8]\nsage: s = C(x^3 * (1 - x)^-2); s[0:10]\n[0, 0, 0, 1, 2, 3, 4, 5, 6, 7]\n```\n\n\nto fail.",
    "created_at": "2022-01-16T00:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469879",
    "user": "@trevorgunn"
}
```

Each commit addresses a separate bug. The first bug is that `R(rem / den).list()` needs to include the initial zeroes from the Taylor series. This causes the test


```sage
sage: s = C.from_recurrence([1,1],[1,1,1])
sage: s[0:5]
[1, 1, 1, 2, 3]
```


to fail.

The second bug is that when we are using `self._aa` it is because we are computing from degree 0 and this needs to be addressed by resetting the offset to 0. This causes the tests


```sage
sage: s = C(x^2 * (1 - x)^-2); s[0:10]
[0, 0, 1, 2, 3, 4, 5, 6, 7, 8]
sage: s = C(x^3 * (1 - x)^-2); s[0:10]
[0, 0, 0, 1, 2, 3, 4, 5, 6, 7]
```


to fail.



---

archive/issue_comments_469880.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-01-16T01:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469880",
    "user": "@trevorgunn"
}
```

Changing priority from major to critical.



---

archive/issue_comments_469881.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-29T09:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469881",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469882.json:
```json
{
    "body": "ok, let it be. When you want a review, you may add somebody interested in cc",
    "created_at": "2022-01-29T09:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469882",
    "user": "chapoton"
}
```

ok, let it be. When you want a review, you may add somebody interested in cc



---

archive/issue_comments_469883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-31T23:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32936#issuecomment-469883",
    "user": "vbraun"
}
```

Resolution: fixed
