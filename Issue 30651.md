# Issue 30651: Remove unused env variable SAGE_SCRIPTS_DIR

Issue created by migration from https://trac.sagemath.org/ticket/30888

Original creator: mkoeppe

Original creation time: 2020-11-11 02:15:04

CC:  mjo dimpase jhpalmieri

After #30128 (enforce sourcing of `sage-env-config` before `src/bin/sage-env`) and #29850, `SAGE_SCRIPTS_DIR`, set in `sage-env`, is not used for anything. We remove it.


---

Comment by mkoeppe created at 2020-11-11 02:21:26

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-11-11 02:21:26

Last 10 new commits:


---

Comment by mkoeppe created at 2020-11-11 18:48:26

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-11-11 18:53:17

Turns out that `SAGE_SCRIPTS_DIR` is unused because the feature introduced in #25486 (Discover `SAGE_SCRIPTS_DIR` to make `$SAGE_LOCAL/bin/sage` work from any directory, in an environment without `SAGE_*` variables) was killed by #30128, as part of the quest to remove bashisms.


---

Comment by mkoeppe created at 2020-11-11 18:58:03

Unfortunately I did not notice it when I reviewed #30128.


---

Comment by mkoeppe created at 2020-11-11 18:58:03

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2020-11-12 19:21:54

Any takers for this one?


---

Comment by mjo created at 2020-11-12 21:15:12

What kind of solution is acceptable here? I've lost track of the big picture, but it looks like all of the important `./configure`-time settings are in `sage-env-config`, but `local/bin/sage` can't find `sage-env-config` because the path to it (determined during `./configure`) is contained in `sage-env-config`.

Are we allowed to stick autoconf values directly into `local/bin/sage` (after renaming with an `.in` suffix), like


```
: ${SAGE_ROOT:=@abs_top_srcdir@}
```


which would set a default value of `SAGE_ROOT` at `./configure`-time, but still allow custom values of `SAGE_ROOT` to be set in the environment?


---

Comment by mkoeppe created at 2020-11-12 21:19:00

Replying to [comment:8 mjo]:
> What kind of solution is acceptable here? I've lost track of the big picture, but it looks like all of the important `./configure`-time settings are in `sage-env-config`, but `local/bin/sage` can't find `sage-env-config` because the path to it (determined during `./configure`) is contained in `sage-env-config`.

The directory can be found from $0, with resolving symlinks.
Similar to what used to be in `sage-env`, but not bash-specific because it's for an executed script rather than a sourced script.

> Are we allowed to stick autoconf values directly into `local/bin/sage` (after renaming with an `.in` suffix), like
> 
> {{{
> : ${SAGE_ROOT:=`@`abs_top_srcdir`@`}
> }}}
> 
> which would set a default value of `SAGE_ROOT` at `./configure`-time, but still allow custom values of `SAGE_ROOT` to be set in the environment?

No, because the `sage` script is installed by `setup.py` and we plan to make this work even when `configure` has not been run.


---

Comment by mkoeppe created at 2020-11-13 03:10:42

It could be done on top of #29852, just adding code to resolve a $0 symlink instead of using $0 directly.


---

Comment by mjo created at 2020-11-13 13:11:47

We can fake `realpath` by copy & pasting the 70-line `resolvelinks()` function from sage-env, but I think that's pretty ugly:

* It's copy/pasting a ton of code. We can't source sage-env for it, because we don't know where sage-env lives.
* The function still doesn't work in some common cases, like hardlinks into the tree or symlinks out of the tree.
* It's a waste of time recomputing the same paths every time "sage" is run, in slow shell script.

If setup.py installs the script, it knows the correct location. It could replace a placeholder at install-time as in e.g. https://git.launchpad.net/dkimpy-milter/tree/setup.py


---

Comment by mkoeppe created at 2020-11-13 16:38:38

Replying to [comment:12 mjo]:
> We can fake `realpath` by copy & pasting the 70-line `resolvelinks()` function from sage-env, but I think that's pretty ugly:
> 
> * It's copy/pasting a ton of code. We can't source sage-env for it, because we don't know where sage-env lives.

I agree it's a bit ugly... that would be the third copy of the code (another one is in SAGE_ROOT/sage). Perhaps we can get rid of the copy in `sage-env`?

> * The function still doesn't work in some common cases, like hardlinks into the tree or symlinks out of the tree.

Hardlinks - granted.

What do you mean by "symlinks out of the tree"?

We would just document what is supported. The installation manual already has some guidance regarding "system wide installation" that needs updating anyway.

> * It's a waste of time recomputing the same paths every time "sage" is run, in slow shell script.

True, but perhaps the resolving code would only be run if the files cannot be found without resolving. Then it would impose the runtime penalty only if symlinks are in use.

> If setup.py installs the script, it knows the correct location. It could replace a placeholder at install-time as in e.g. https://git.launchpad.net/dkimpy-milter/tree/setup.py

No, this is unfortunately not true. The final install location of the Python package is not known at `setup.py` time. When we build a wheel (which is the default installation mechanism in modern pip), the resulting wheel can be installed in any venv location (and the wheel format does not support post-install hooks of any kind).


---

Comment by mjo created at 2020-11-13 21:15:09

Replying to [comment:13 mkoeppe]:
> 
> What do you mean by "symlinks out of the tree"?

If you move `local/bin/sage` elsewhere, and then create a symlink from `local/bin/sage` to that location. In that case, you don't want to use the absolute physical path of the script that's being run to find `SAGE_ROOT`, rather the absolute physical path of its original install location.

 
> > If setup.py installs the script, it knows the correct location. It could replace a placeholder at install-time as in e.g. https://git.launchpad.net/dkimpy-milter/tree/setup.py
> 
> No, this is unfortunately not true. The final install location of the Python package is not known at `setup.py` time. When we build a wheel (which is the default installation mechanism in modern pip), the resulting wheel can be installed in any venv location (and the wheel format does not support post-install hooks of any kind).

Ok, I don't know enough about how this works to propose anything else. Copy/paste it is, then.


---

Comment by mkoeppe created at 2020-11-13 21:37:43

Replying to [comment:14 mjo]:
> Replying to [comment:13 mkoeppe]:
> > 
> > What do you mean by "symlinks out of the tree"?
> 
> If you move `local/bin/sage` elsewhere, and then create a symlink from `local/bin/sage` to that location. In that case, you don't want to use the absolute physical path of the script that's being run to find `SAGE_ROOT`, rather the absolute physical path of its original install location.

Right, let's just say that this is not supported.


---

Comment by mkoeppe created at 2020-11-20 20:54:57

Best to work on it on top of #30013


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-18 00:26:27

User bug report - https://groups.google.com/g/sage-devel/c/tejOsRxfC9w/m/ulKTsowHBAAJ


---

Comment by mkoeppe created at 2021-03-20 00:44:54

Replying to [comment:14 mjo]:
> Copy/paste it is, then.

Got time to work on this for Sage 9.3?


---

Comment by mjo created at 2021-03-21 01:10:15

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-03-21 01:10:15

Further cleanup is possible, but I think this fixes the issue and makes the diff nice and clear.
----
New commits:


---

Comment by mkoeppe created at 2021-03-21 05:08:14

This works well, thanks very much.


---

Comment by mkoeppe created at 2021-03-21 05:08:14

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-28 18:45:40

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Setting priority to blocker to bring this ticket to the attention of the release bot.


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Changing priority from critical to blocker.


---

Comment by vbraun created at 2021-04-02 15:42:53

Resolution: fixed
