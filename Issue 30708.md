# Issue 30708: segmentation fault in pexpect for singular

archive/issues_030708.json:
```json
{
    "body": "CC:  @dimpase @slel tmonteil @kiwifb\n\nAt least two patchbots, one Linux and one MacOs, meet a failure related to pexpect interface for singular, namely:\n\nsage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault\n\nThe tested file also fails when run alone, but the copy-pasted test works fine.\n\nFr\u00e9d\u00e9ric\n\nPS : for full logs, see\n\nhttps://patchbot.sagemath.org/log/0/Darwin/Darwin%20Kernel%20Version%2018.5.0:%20Mon%20Mar%2011%2020:40:32%20PDT%202019;%20root:xnu-4903.251.3~3/RELEASE_X86_64/x86_64/18.5.0/steenrod/2020-11-07%2019:50:32?short\n\nhttps://patchbot.sagemath.org/log/0/Linux/57-Ubuntu_SMP_Thu_Oct_15_10:57:00_UTC_2020/x86_64/5.4.0-52-generic/petitbonum/2020-11-07%2020:48:10?short\n\nIssue created by migration from https://trac.sagemath.org/ticket/30945\n\n",
    "created_at": "2020-11-22T19:15:05Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "segmentation fault in pexpect for singular",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30708",
    "user": "https://github.com/fchapoton"
}
```
CC:  @dimpase @slel tmonteil @kiwifb

At least two patchbots, one Linux and one MacOs, meet a failure related to pexpect interface for singular, namely:

sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault

The tested file also fails when run alone, but the copy-pasted test works fine.

Frédéric

PS : for full logs, see

https://patchbot.sagemath.org/log/0/Darwin/Darwin%20Kernel%20Version%2018.5.0:%20Mon%20Mar%2011%2020:40:32%20PDT%202019;%20root:xnu-4903.251.3~3/RELEASE_X86_64/x86_64/18.5.0/steenrod/2020-11-07%2019:50:32?short

https://patchbot.sagemath.org/log/0/Linux/57-Ubuntu_SMP_Thu_Oct_15_10:57:00_UTC_2020/x86_64/5.4.0-52-generic/petitbonum/2020-11-07%2020:48:10?short

Issue created by migration from https://trac.sagemath.org/ticket/30945





---

archive/issue_comments_438517.json:
```json
{
    "body": "changing alarm(0.5) to either alarm(0.5*256) or alarm(0.5/256) does not fix the issue",
    "created_at": "2020-11-22T19:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438517",
    "user": "https://github.com/fchapoton"
}
```

changing alarm(0.5) to either alarm(0.5*256) or alarm(0.5/256) does not fix the issue



---

archive/issue_comments_438518.json:
```json
{
    "body": "I have sometimes seen that failure too.",
    "created_at": "2020-11-23T11:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438518",
    "user": "https://github.com/slel"
}
```

I have sometimes seen that failure too.



---

archive/issue_comments_438519.json:
```json
{
    "body": "Changing keywords from \"\" to \"singular, segfault\".",
    "created_at": "2020-11-23T11:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438519",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "singular, segfault".



---

archive/issue_comments_438520.json:
```json
{
    "body": "Je suis preneur de toute suggestion.",
    "created_at": "2020-11-23T13:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438520",
    "user": "https://github.com/fchapoton"
}
```

Je suis preneur de toute suggestion.



---

archive/issue_comments_438521.json:
```json
{
    "body": "Some date points, in case it might be useful: on my Ubuntu 20.04 computer, running `sage -t --long src/sage/interfaces/singular.py`\n\n- triggers the segfault with Sage 9.3.beta2 and 9.2\n- returns \"All tests passed!\" with Sage 9.1",
    "created_at": "2020-11-26T06:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438521",
    "user": "https://github.com/egourgoulhon"
}
```

Some date points, in case it might be useful: on my Ubuntu 20.04 computer, running `sage -t --long src/sage/interfaces/singular.py`

- triggers the segfault with Sage 9.3.beta2 and 9.2
- returns "All tests passed!" with Sage 9.1



---

archive/issue_comments_438522.json:
```json
{
    "body": "pexpect was last updated in #29240, included in Sage 9.2.beta11",
    "created_at": "2020-11-26T13:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438522",
    "user": "https://github.com/fchapoton"
}
```

pexpect was last updated in #29240, included in Sage 9.2.beta11



---

archive/issue_comments_438523.json:
```json
{
    "body": "Perhaps this test failure has nothing to do Singular.\n\n`singular`'s is the only pexpect interface on which this test is carried out. One could also have same for `GAP`, say:\n\n```\nsage: a = gap(1)\nsage: _ = gap._expect.sendline('1+')  # unfinished input\nsage: try:\n....:     alarm(0.5)\n....:     gap._expect_expr('gap>')  # interrupt this\n....: except KeyboardInterrupt:\n....:     pass                                                                                                                                                                                \nControl-C pressed. Interrupting Gap. Please wait a few seconds...\nsage: 2*a                                                                                                                                                                      \n2\n```\n\n\nCould someone who has a box where this is reliably reproduced, try adding somewhere the doctest for GAP above, and see if it fails too?",
    "created_at": "2020-11-26T14:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438523",
    "user": "https://github.com/dimpase"
}
```

Perhaps this test failure has nothing to do Singular.

`singular`'s is the only pexpect interface on which this test is carried out. One could also have same for `GAP`, say:

```
sage: a = gap(1)
sage: _ = gap._expect.sendline('1+')  # unfinished input
sage: try:
....:     alarm(0.5)
....:     gap._expect_expr('gap>')  # interrupt this
....: except KeyboardInterrupt:
....:     pass                                                                                                                                                                                
Control-C pressed. Interrupting Gap. Please wait a few seconds...
sage: 2*a                                                                                                                                                                      
2
```


Could someone who has a box where this is reliably reproduced, try adding somewhere the doctest for GAP above, and see if it fails too?



---

archive/issue_comments_438524.json:
```json
{
    "body": "Bug fails with gap too, when running doctests. In the command line, provokes a very bad crash of sage.\n\nrunning in the doctests:\n\n```\nFile \"src/sage/interfaces/singular.py\", line 511, in sage.interfaces.singular.Singular._send_interrupt\nFailed example:\n    2*a\nException raised:\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py\", line 763, in _eval_line\n        raise RuntimeError(\"%s produced error output\\n%s\\n   executing %s\"%(self, error,line))\n    RuntimeError: Gap produced error output\n    Error, no method found! For debugging hints type ?Recovery from NoMethodFound\n    Error, no 1st choice method found for `*' on 2 arguments\n\n       executing \\$sage3:=\\$sage2 * \\$sage1;;\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/expect.py\", line 1469, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/interface.py\", line 501, in _create\n        self.set(name, value)\n      File \"/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py\", line 1422, in set\n        self._eval_line(cmd, allow_use_file=True)\n      File \"/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py\", line 797, in _eval_line\n        raise RuntimeError(exc)\n    RuntimeError: Gap produced error output\n    Error, no method found! For debugging hints type ?Recovery from NoMethodFound\n    Error, no 1st choice method found for `*' on 2 arguments\n\n       executing \\$sage3:=\\$sage2 * \\$sage1;;\netc\n```\n\n\nin the console, one gets\n\n```\nsage: a                                                                                                                                     \n(invalid Gap object -- The gap session in which this object was defined is no longer running.)\nsage: 2*a\nbig mess as above\n```\n",
    "created_at": "2020-11-26T15:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438524",
    "user": "https://github.com/fchapoton"
}
```

Bug fails with gap too, when running doctests. In the command line, provokes a very bad crash of sage.

running in the doctests:

```
File "src/sage/interfaces/singular.py", line 511, in sage.interfaces.singular.Singular._send_interrupt
Failed example:
    2*a
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py", line 763, in _eval_line
        raise RuntimeError("%s produced error output\n%s\n   executing %s"%(self, error,line))
    RuntimeError: Gap produced error output
    Error, no method found! For debugging hints type ?Recovery from NoMethodFound
    Error, no 1st choice method found for `*' on 2 arguments

       executing \$sage3:=\$sage2 * \$sage1;;

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/expect.py", line 1469, in __init__
        self._name = parent._create(value, name=name)
      File "/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/interface.py", line 501, in _create
        self.set(name, value)
      File "/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py", line 1422, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/home/chapoton/sage/local/lib/python3.8/site-packages/sage/interfaces/gap.py", line 797, in _eval_line
        raise RuntimeError(exc)
    RuntimeError: Gap produced error output
    Error, no method found! For debugging hints type ?Recovery from NoMethodFound
    Error, no 1st choice method found for `*' on 2 arguments

       executing \$sage3:=\$sage2 * \$sage1;;
etc
```


in the console, one gets

```
sage: a                                                                                                                                     
(invalid Gap object -- The gap session in which this object was defined is no longer running.)
sage: 2*a
big mess as above
```




---

archive/issue_comments_438525.json:
```json
{
    "body": "OK, actually I should have checked, for me such GAP pexpect test in Sage console also results in\n`(invalid Gap object -- The gap session in which this object was defined is no longer running.)`\n\nThis makes me wonder why it's important to have such a test in Singular. Only Singular has a custom `_send_interrupt`; GAP\nuses the default one, below, and you see it sends `_quit_string`; it kills the GAP session if it lands in the main loop, rather than in the break loop (doing `quit;` in GAP's break loop brings you to the main loop, so in this case it's OK). \n\n\n```\n    def _send_interrupt(self):\n        \"\"\"\n        Send an interrupt to the application.  This is used internally\n        by :meth:`interrupt`.\n\n        First CTRL-C to stop the current command, then quit.\n        \"\"\"\n        self._expect.sendline(chr(3))\n        self._expect.sendline(self._quit_string())\n```\n\nSingular custom one was added along with the test in question, and no `_quit_string()` is sent (which is `quit;` for GAP, as\nyou can see by looking at the value of `gap._quit_string()`).\nFor Singular one has the following in `_send_interrupt()`:\n\n```\n        sleep(0.1)\n\n        E = self._expect\n        E.sendline(chr(3))\n        for i in range(5):\n            try:\n                E.expect_upto(self._prompt, timeout=1.0)\n                return\n            except Exception:\n                pass\n            E.sendline(\";\")\n```\n\n\nWe can try just to erase Singular's `_send_interrupt()`, set its `_quit_string()` to proper value (it's  `quit` rather than `quit;`, \nas it should be) and be done with.",
    "created_at": "2020-11-26T17:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438525",
    "user": "https://github.com/dimpase"
}
```

OK, actually I should have checked, for me such GAP pexpect test in Sage console also results in
`(invalid Gap object -- The gap session in which this object was defined is no longer running.)`

This makes me wonder why it's important to have such a test in Singular. Only Singular has a custom `_send_interrupt`; GAP
uses the default one, below, and you see it sends `_quit_string`; it kills the GAP session if it lands in the main loop, rather than in the break loop (doing `quit;` in GAP's break loop brings you to the main loop, so in this case it's OK). 


```
    def _send_interrupt(self):
        """
        Send an interrupt to the application.  This is used internally
        by :meth:`interrupt`.

        First CTRL-C to stop the current command, then quit.
        """
        self._expect.sendline(chr(3))
        self._expect.sendline(self._quit_string())
```

Singular custom one was added along with the test in question, and no `_quit_string()` is sent (which is `quit;` for GAP, as
you can see by looking at the value of `gap._quit_string()`).
For Singular one has the following in `_send_interrupt()`:

```
        sleep(0.1)

        E = self._expect
        E.sendline(chr(3))
        for i in range(5):
            try:
                E.expect_upto(self._prompt, timeout=1.0)
                return
            except Exception:
                pass
            E.sendline(";")
```


We can try just to erase Singular's `_send_interrupt()`, set its `_quit_string()` to proper value (it's  `quit` rather than `quit;`, 
as it should be) and be done with.



---

archive/issue_comments_438526.json:
```json
{
    "body": "here is a tentative, just removing the `_send_interrupt` method\n----\nNew commits:",
    "created_at": "2020-11-26T19:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438526",
    "user": "https://github.com/fchapoton"
}
```

here is a tentative, just removing the `_send_interrupt` method
----
New commits:



---

archive/issue_comments_438527.json:
```json
{
    "body": "Did you mean that `exit` is the singular quit command ??",
    "created_at": "2020-11-27T07:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438527",
    "user": "https://github.com/fchapoton"
}
```

Did you mean that `exit` is the singular quit command ??



---

archive/issue_comments_438528.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-28T07:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438528",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_438529.json:
```json
{
    "body": "hmm, this seems to have a side effect, see the latest patchbot report",
    "created_at": "2020-11-28T16:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438529",
    "user": "https://github.com/fchapoton"
}
```

hmm, this seems to have a side effect, see the latest patchbot report



---

archive/issue_comments_438530.json:
```json
{
    "body": "the side effect could be that hitting `^C` during a computation involving a session with pexpect Singular is no longer only (probably) interrupted, but the whole session is killed.  \n\nI am not sure it is safe do interrupt Singular - note the warning at the end\n\n```\n^C// ** Interrupt at cmd:`load` in line:';return();'\nabort after this command(a), abort immediately(r), print backtrace(b), continue(c) or quit Singular(q) ?// ** Interrupt at cmd:`load` in line:';return();'\nabort after this command(a), abort immediately(r), print backtrace(b), continue(c) or quit Singular(q) ?r\n** Warning: Singular should be restarted as soon as possible **\n```\n\nin a console Singular session.",
    "created_at": "2020-11-29T08:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438530",
    "user": "https://github.com/dimpase"
}
```

the side effect could be that hitting `^C` during a computation involving a session with pexpect Singular is no longer only (probably) interrupted, but the whole session is killed.  

I am not sure it is safe do interrupt Singular - note the warning at the end

```
^C// ** Interrupt at cmd:`load` in line:';return();'
abort after this command(a), abort immediately(r), print backtrace(b), continue(c) or quit Singular(q) ?// ** Interrupt at cmd:`load` in line:';return();'
abort after this command(a), abort immediately(r), print backtrace(b), continue(c) or quit Singular(q) ?r
** Warning: Singular should be restarted as soon as possible **
```

in a console Singular session.



---

archive/issue_comments_438531.json:
```json
{
    "body": "I encountered this in #31404 as well.  I believe I have isolated it to a possible bug in cysignals: https://github.com/sagemath/cysignals/issues/126",
    "created_at": "2021-03-04T17:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438531",
    "user": "https://github.com/embray"
}
```

I encountered this in #31404 as well.  I believe I have isolated it to a possible bug in cysignals: https://github.com/sagemath/cysignals/issues/126



---

archive/issue_comments_438532.json:
```json
{
    "body": "I am able to reproduce this pretty reliably on the current develop branch with\n\n\n```\n./sage -t --file-iterations=2 -T 0 --verbose src/sage/interfaces/singular.py\n```\n",
    "created_at": "2021-03-04T17:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438532",
    "user": "https://github.com/embray"
}
```

I am able to reproduce this pretty reliably on the current develop branch with


```
./sage -t --file-iterations=2 -T 0 --verbose src/sage/interfaces/singular.py
```




---

archive/issue_comments_438533.json:
```json
{
    "body": "This now has a possible fix at https://github.com/sagemath/cysignals/pull/127\n\nThe segfault is not caused by Singular (if it were this would crash pexpect, not cause a segfault in Sage).  It's caused by cysignals itself.",
    "created_at": "2021-03-05T17:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438533",
    "user": "https://github.com/embray"
}
```

This now has a possible fix at https://github.com/sagemath/cysignals/pull/127

The segfault is not caused by Singular (if it were this would crash pexpect, not cause a segfault in Sage).  It's caused by cysignals itself.



---

archive/issue_comments_438534.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-01T08:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438534",
    "user": "https://github.com/slel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_438535.json:
```json
{
    "body": "Likely solved by cysignals 1.10.3 upgrade at #31474,\nmerged in Sage 9.3.rc0, released 2021-03-24.\n\nIf we get no more reports on sage-release in a while,\nthis ticket should be closed.\n\nCan the branch `public/singular_pexpect` improving\n`interfaces/singular.py` go to a new ticket?",
    "created_at": "2021-04-01T08:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438535",
    "user": "https://github.com/slel"
}
```

Likely solved by cysignals 1.10.3 upgrade at #31474,
merged in Sage 9.3.rc0, released 2021-03-24.

If we get no more reports on sage-release in a while,
this ticket should be closed.

Can the branch `public/singular_pexpect` improving
`interfaces/singular.py` go to a new ticket?



---

archive/issue_comments_438536.json:
```json
{
    "body": "Branch improving the pexpect interface to Singular now at #31846.",
    "created_at": "2021-05-22T17:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438536",
    "user": "https://github.com/slel"
}
```

Branch improving the pexpect interface to Singular now at #31846.



---

archive/issue_comments_438537.json:
```json
{
    "body": "Addressed in #31474 and #31846.",
    "created_at": "2021-10-04T23:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438537",
    "user": "https://github.com/orlitzky"
}
```

Addressed in #31474 and #31846.



---

archive/issue_comments_438538.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-04T23:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438538",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438539.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-10-04T23:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30708#issuecomment-438539",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_028177.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-04T23:44:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30708",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30708#event-28177"
}
```
