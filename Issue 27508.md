# Issue 27508: Upgrade lrslib to 7.0

Issue created by migration from https://trac.sagemath.org/ticket/27745

Original creator: mkoeppe

Original creation time: 2019-04-29 08:11:05

CC:  slelievre yzh @kliem vdelecroix fbissey dimpase simonking




---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by mkoeppe created at 2020-05-01 18:16:15

Moving some tickets to 9.2. This is not a promise that I will be working on them.


---

Comment by slelievre created at 2020-08-19 21:25:45

Changing keywords from "" to "upgrade, lrslib".


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-05-17 20:08:58

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-05-17 20:08:58

New commits:


---

Comment by mkoeppe created at 2021-05-17 20:14:14

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-05-17 20:14:14

Various failures in `./sage -tp src/sage/game_theory/`, needs work


---

Comment by mkoeppe created at 2021-05-17 20:20:33

Does anyone already have patches to support lrslib 071a in the Sage library?


---

Comment by git created at 2021-05-17 20:34:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-17 20:38:40

This is better, but the rather shocking lrs format parser in `src/sage/game_theory/parser.py` will need fixing


---

Comment by git created at 2021-05-17 20:56:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-17 23:14:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-17 23:14:31

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-18 01:23:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-18 01:40:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-05-18 16:21:27

Should #28435 be dependent on this ticket, not the other way around?


---

Comment by git created at 2021-05-18 16:45:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-05-18 16:45:32

FYI polymake 4.4 was just released


---

Comment by dimpase created at 2021-05-18 16:49:40

should we do a bump to 4.4 here now?


---

Comment by mkoeppe created at 2021-05-18 16:55:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-18 16:57:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-18 18:22:19

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-05-18 18:41:05

tested on macOS Catalina only


---

Comment by tmonteil created at 2021-05-18 20:03:50

`lrslib` does not compile on my Debian buster x86_64, see the attached log.


---

Comment by tmonteil created at 2021-05-18 20:03:50

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by dimpase created at 2021-05-18 20:16:27

it build for me on Fedora.
Something is not right with openmpi in your log.


---

Comment by mkoeppe created at 2021-05-18 20:34:14

I haven't tested at all with openmpi yet -- PRs are welcome


---

Comment by git created at 2021-05-18 23:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-18 23:19:36

OK, mpi is fixed now


---

Comment by mkoeppe created at 2021-05-18 23:20:49

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-19 05:31:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-19 05:43:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2021-05-19 07:57:31

The `lrslib` issue with `openmpi` is fixed (self-tests pass).

If i do `export MAKE='make -j4'` before running `sage -i -f polymake`, the compilation still eats all my CPU, though `spkg-install.in` relies on `sdh_make`.

Also, i have 6G free on my machine, and the compilation ends up with a `No space left on device`. How much disk space is required to build and install `polymake` ?


---

Comment by tscrim created at 2021-05-19 08:56:12

Matthias linked it to `SAGE_NUM_THREADS`, but it is might indeed be better to link it to what `MAKE` sets. I am letting mine compile with 2 threads right now since 4 still ate through 10+Gb RAM.


---

Comment by dimpase created at 2021-05-19 10:16:55

use `make -j4 polymake`, do not export MAKE. Time is high to drop `sage -i`, it is an extra hassle.


---

Comment by tmonteil created at 2021-05-19 10:20:34

Replying to [comment:46 dimpase]:
> use `make -j4 polymake`, do not export MAKE. Time is high to drop `sage -i`, it is an extra hassle.

But then, how to i run self tests ?


---

Comment by dimpase created at 2021-05-19 10:21:13

Polymake is huge, it's about as big as Sage, I think. Go figure.


---

Comment by dimpase created at 2021-05-19 10:24:38

Replying to [comment:47 tmonteil]:
> Replying to [comment:46 dimpase]:
> > use `make -j4 polymake`, do not export MAKE. Time is high to drop `sage -i`, it is an extra hassle.
> 
> But then, how to i run self tests ?
`SAGE_CHECK=yes make -j4 polymake`


---

Comment by @kliem created at 2021-05-19 14:55:09

How do I link perl after having installed it with

`cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp Term::ReadLine::Gnu JSON SVG MongoDB`?

I'm on a debian buster and don't know how to install polymake into sage.


---

Comment by mkoeppe created at 2021-05-19 15:09:24

Replying to [comment:45 tscrim]:
> Matthias linked it to `SAGE_NUM_THREADS`, but it is might indeed be better to link it to what `MAKE` sets.

During build, `SAGE_NUM_THREADS` is actually initialized from the MAKE setting.
See `build/bin/sage-build-num-threads` and `build/make/install`.


---

Comment by mkoeppe created at 2021-05-19 15:10:11

Replying to [comment:50 gh-kliem]:
> How do I link perl after having installed it with
> 
> `cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp Term::ReadLine::Gnu JSON SVG MongoDB`?
> 
> I'm on a debian buster and don't know how to install polymake into sage.

On Debian, you can just install the prerequisite packages listed in `build/pkgs/perl_cpan_polymake_prereq/distros/debian.txt`


---

Comment by mkoeppe created at 2021-05-19 15:12:09

Replying to [comment:46 dimpase]:
> use `make -j4 polymake`, do not export MAKE. Time is high to drop `sage -i`, it is an extra hassle.

The correct way to install an optional package is, of course,

```
eval ./configure $(./config.status --config) --enable-jupymake && make build
```



---

Comment by @kliem created at 2021-05-19 19:33:07

Replying to [comment:52 mkoeppe]:
> Replying to [comment:50 gh-kliem]:
> > How do I link perl after having installed it with
> > 
> > `cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp Term::ReadLine::Gnu JSON SVG MongoDB`?
> > 
> > I'm on a debian buster and don't know how to install polymake into sage.
> 
> On Debian, you can just install the prerequisite packages listed in `build/pkgs/perl_cpan_polymake_prereq/distros/debian.txt`

Thanks. Well that requires root access, but I guess we have a nice IT so they'll do it.

That sage itself can be just installed without root access is a wonderful thing... (But they also have installed the generated list of recommended packages for me, which makes things a lot faster.)


---

Comment by tscrim created at 2021-05-20 00:42:30

I was able to build both packages (thank you Matthias for your help with this). However, there are issues with `interfaces/polymake.py` (make sure you run `sage -tp --optional=sage,polymake`). The biggest issue is that it doesn't even finish evaluating the first doctest:

```
polymake.eval('print foo;')
```

It timed out after running for 5 minutes.

I tried running this directly in my Sage shell, which it is still taking seemingly forever. I also tried `C = polymake('cube(3)')`, which after I hit ctrl-c, any additional attempt to run the interface results in multiple errors of the form:

```
TypeError: argument should be integer or bytes-like object, not 'str'
```


Is this an issue with the interface? Is this something with polymake trying to do something for the first time? Something else?

The branch just has one commit that cleans up the interface file a bit.
----
New commits:


---

Comment by mkoeppe created at 2021-05-20 00:59:07

Sounds like you are testing the old pexpect version of the interface.
If you install package `jupymake`, it will test the current version


---

Comment by tscrim created at 2021-05-20 01:10:56

No, I did not. Once I installed that, then it worked. Since that is a requirement to using the interface, I think we should have `jupymake` as a dependency.


---

Comment by tscrim created at 2021-05-20 01:13:38

Now it is stuck on line 128:

```
p = polymake_expect.rand_sphere(4, 20, seed=5)
```

I guess we have to rewrite the interface file to remove all tests involving the old interface?


---

Comment by tscrim created at 2021-05-20 01:27:22

Actually, do we want to just scrap the pexpect interface altogether?


---

Comment by mkoeppe created at 2021-05-20 01:33:48

Replying to [comment:57 tscrim]:
> No, I did not. Once I installed that, then it worked. Since that is a requirement to using the interface, I think we should have `jupymake` as a dependency.

jupymake can't be a dependency of polymake because it depends on polymake


---

Comment by mkoeppe created at 2021-05-20 02:00:43

Replying to [comment:58 tscrim]:
> Now it is stuck on line 128:
> {{{
> p = polymake_expect.rand_sphere(4, 20, seed=5)
> }}}

Here's how to debug this:

```
sage: from sage.interfaces.polymake import PolymakeExpect
sage: polymake = PolymakeExpect(logfile="POLYMAKE.log")
sage: polymake.rand_sphere(4, 20, seed=5)
```


Then, in a separate terminal, use `tail -f POLYMAKE.log`


---

Comment by mkoeppe created at 2021-05-20 02:01:15

There is indeed something going on with bytes vs strings.


---

Comment by git created at 2021-05-20 03:22:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-20 03:43:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-20 05:23:19

More fixes are needed


---

Comment by mkoeppe created at 2021-05-20 05:23:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-20 16:15:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-20 16:49:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-05-21 00:30:05

Thank you. That has gotten it down to one failure for me:

```
**********************************************************************
File "src/sage/interfaces/polymake.py", line 2098, in sage.interfaces.polymake.PolymakeExpect._eval_line
Failed example:
    c.N_VERTICES                      # optional - polymake
Expected:
    32768
Got:
    Can't locate object method "description" via package "32768" (perhaps you forgot to load "32768"?) at input line 1.
```

However, I cannot reproduce this in an interactive session, so it is probably something with the doctester setup. I propose marking it as `# known bug` with an explanation that it works interactively if it is failing for someone else.


---

Comment by mkoeppe created at 2021-05-21 00:46:41

Yes, there's something wrong with error recovery still.

For me, also `src/sage/geometry/polyhedron/backend_polymake.py` reveals additional errors. So there's more work


---

Comment by @kliem created at 2021-05-21 06:14:46

Thanks for the help above. So I have polymake installed now and it works in `sage -sh`.

However, I'm getting an EOF error whenever I want to do something in sage, e.g. `polytopes.cube(backend='polymake').


```
TypeError: unable to start polymake: End Of File (EOF). Exception style platform.
Polymake with PID 27045 running /usr/bin/env TERM=dumb polymake
command: /usr/bin/env
args: ['/usr/bin/env', 'TERM=dumb', 'polymake']
buffer (last 100 chars): b''
before (last 100 chars): b'dLine::Gnu" at /srv/public/kliem/sage/local/share/polymake/perllib/Polymake/Core/Shell.pm line 30.\r\n'
after: <class 'pexpect.exceptions.EOF'>
match: None
match_index: None
exitstatus: None
flag_eof: True
pid: 27045
child_fd: 16
closed: False
timeout: None
delimiter: <class 'pexpect.exceptions.EOF'>
logfile: None
logfile_read: None
logfile_send: None
maxread: 4194304
ignorecase: False
searchwindowsize: None
delaybeforesend: None
delayafterclose: 0.1
delayafterterminate: 0.1
searcher: searcher_re:
    0: re.compile(b'polytope > ')
```



---

Comment by @sheerluck created at 2021-05-21 08:20:31

Replying to [comment:71 gh-kliem]:
> However, I'm getting an EOF error whenever I want to do something in sage, e.g. `polytopes.cube(backend='polymake').

in `sage.interfaces.polymake` we have both `polymake_expect` and `polymake_jupymake` so which one is used in `polytopes.cube(backend='polymake')`?

How to tell `sage` I always want `polymake_jupymake` for every `something(backend='polymake')`?


---

Comment by @sheerluck created at 2021-05-21 08:23:53

oh I see

```
if PythonModule("JuPyMake").is_present():
    polymake = polymake_jupymake
else:
    polymake = polymake_expect
```



---

Comment by @kliem created at 2021-05-21 08:28:31

For me it is `PolymakeExpect` apparently.


---

Comment by git created at 2021-05-23 19:43:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-23 20:24:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-23 20:26:13

With `jupymake` installed, `./sage -t  --optional=sage,polymake,jupymake,perl_mongodb src/sage/geometry/polyhedron/backend_polymake.py` now is down to 1 failure:

```
sage -t --random-seed=0 src/sage/geometry/polyhedron/backend_polymake.py
**********************************************************************
File "src/sage/geometry/polyhedron/backend_polymake.py", line 220, in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake.__init__
Failed example:
    TestSuite(p).run()                                 # optional - polymake
Expected nothing
Got:
    Failure in _test_lawrence:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/geometry/polyhedron/base.py", line 6312, in _test_lawrence
        tester.assertTrue(Q.is_combinatorially_isomorphic(R))
      File "/usr/local/Cellar/python@3.9/3.9.4/Frameworks/Python.framework/Versions/3.9/lib/python3.9/unittest/case.py", line 682, in assertTrue
        raise self.failureException(msg)
    AssertionError: False is not true
    ------------------------------------------------------------
    The following tests failed: _test_lawrence
**********************************************************************
1 item had failures:
   1 of   7 in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake.__init__
    [91 tests, 1 failure, 27.73 s]
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/geometry/polyhedron/backend_polymake.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2021-05-23 20:28:36

Same without `jupymake`.


---

Comment by mkoeppe created at 2021-05-23 20:29:04

Help with the lawrence testcase would be welcome...


---

Comment by git created at 2021-05-23 21:30:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-23 23:42:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-23 23:44:53

I don't know how to fix the remaining errors with the pexpect version of the interface.


---

Comment by mkoeppe created at 2021-05-23 23:46:14

Given that `polymake` is marked experimental, perhaps this ticket is good enough for review though.


---

Comment by mkoeppe created at 2021-05-23 23:46:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-24 00:00:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-05-24 01:18:26

I believe the issue with `_test_lawrence()` is numerical instability. Consider

```
sage: p = Polyhedron(vertices=[(-1,-1), (1,0), (1,1), (0,1)], backend='polymake')
sage: from sage.misc.prandom import randint 
sage: v = p.vertices()[randint(0, p.n_vertices()-1)].vector()
sage: Q = p.lawrence_extension(2*v - p.center())
sage: R = p.lawrence_extension(2.0*v - p.center())
```

Using floating point numbers seems to lead to issues with the conversion back and forth as

```
sage: Q.Hrepresentation()                                                                                 
(An inequality (0, 0, 1) x + 0 >= 0,
 An inequality (8, -4, 5) x + 4 >= 0,
 An inequality (11, -3, 0) x + 8 >= 0,
 An inequality (-8, 16, -19) x + 8 >= 0,
 An inequality (-8, 0, -5) x + 8 >= 0,
 An inequality (-3, -5, 0) x + 8 >= 0,
 An inequality (0, -4, 3) x + 4 >= 0)
sage: R.Hrepresentation()                                                                                 
(An inequality (-1.0, 2.0, -2.375) x + 1.0 >= 0,
 An inequality (3.66666666666667, -1.0, 0.0) x + 2.66666666666667 >= 0,
 An inequality (2.0, -1.0, 1.25) x + 1.0 >= 0,
 An inequality (0.0, -1.33333333333333, 1.0) x + 1.33333333333333 >= 0,
 An inequality (-1.0, -1.66666666666667, -2.96059473233375e-16) x + 2.66666666666667 >= 0,
 An inequality (-1.6, -1.86984930463184e-16, -1.0) x + 1.6 >= 0,
 An inequality (0.0, 0.0, 1.0) x + 0.0 >= 0)
```

This agrees with the backend information created from polymake, but how the faces are computed in Sage are different:

```
sage: Q.facets()                                                                                          
(A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 3 vertices,
 A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 4 vertices)
sage: R.facets()                                                                                          
(A 2-dimensional face of a Polyhedron in RDF^3 defined as the convex hull of 4 vertices,)
```

which is based off `R.combinatorial_polyhedron()`. In particular, if we try

```
sage: R.combinatorial_polyhedron().hasse_diagram()
...
ValueError: not all facets are joins of vertices
sage: R.combinatorial_polyhedron().hasse_diagram()
```

----
Based off this, what I would do is explicitly skip the test and state that it is a known issue with numerical instability. I am not sure what else we can do about fixing it at this point `:/`.


---

Comment by SimonKing created at 2021-05-24 06:38:15

Replying to [comment:82 mkoeppe]:
> I don't know how to fix the remaining errors with the pexpect version of the interface.

Do I understand correctly that Travis' remarks explain the error?


---

Comment by mkoeppe created at 2021-05-24 06:45:46

Replying to [comment:87 SimonKing]:
> Replying to [comment:82 mkoeppe]:
> > I don't know how to fix the remaining errors with the pexpect version of the interface.
> 
> Do I understand correctly that Travis' remarks explain the error?

No, the failure in `_test_lawrence` shows up both for the `PolymakeExpect` and for the `PolymakeJupymake` interface.

`PolymakeExpect` has additional failures, which I do not know how to fix.


---

Comment by tscrim created at 2021-05-24 06:46:56

Replying to [comment:87 SimonKing]:
> Replying to [comment:82 mkoeppe]:
> > I don't know how to fix the remaining errors with the pexpect version of the interface.
> 
> Do I understand correctly that Travis' remarks explain the error?

I wouldn't say it fully explains it, but it at least gives an indication about what is going on. It definitely doesn't provide a fix, which should eventually be IMO (but not on this ticket).


---

Comment by git created at 2021-05-24 23:18:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-25 07:32:34

Ok, with `jupymake` things are working now for me.


---

Comment by @kliem created at 2021-05-25 07:56:01

Well it works well except for all doctests in `interfaces/polymake.py` involing `PolymakeExpect`. Maybe we should mark them as `not tested` until the bug is fixed?

Also we could catch the long `EOF` traceback, which has the deprecation warning hidden all the way at the top with something like:


```diff
-            self._change_prompt("polytope > ")
-            Expect._start(self, alt_message=None)
+            try:
+                self._change_prompt("polytope > ")
+                Expect._start(self, alt_message=None)
+            except RuntimeError:
+                raise RuntimeError("runtime error with deprecated pexpect-base interface to polymake; please install jupymake")
```



---

Comment by mkoeppe created at 2021-05-25 16:46:43

I can't reproduce what you report about EOF.
Could you please obtain a log as explained in comment 61?


---

Comment by @kliem created at 2021-05-26 05:59:03


```
kliem@cofio:~/localhome/sage/src/sage/geometry/polyhedron$ tail -f POLYMAKE.log
Welcome to polymake version 4.4
Copyright (c) 1997-2021
Ewgenij Gawrilow, Michael Joswig, and the polymake team
Technische Universität Berlin, Germany
https://polymake.org

This is free software licensed under GPL; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Loading applications now...Can't locate object method "new" via package "Term::ReadLine::Gnu" at /srv/public/kliem/sage/local/share/polymake/perllib/Polymake/Core/Shell.pm line 30.
```



---

Comment by @kliem created at 2021-05-26 06:01:14

As mentioned above, this needs not to be fixed here (experimental and deprecated). However, I was just thinking that a more meaningful error message could be nicer. There is the deprecation message all the way on the top, so theoretically people should figure what the problem is either way (as I did; I didn't follow the discussion and so this deprecation message told me what to do).


---

Comment by git created at 2021-05-26 06:14:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-26 06:15:12

Replying to [comment:93 gh-kliem]:
> Well it works well except for all doctests in `interfaces/polymake.py` involing `PolymakeExpect`. Maybe we should mark them as `not tested` until the bug is fixed?

Done


---

Comment by mkoeppe created at 2021-05-26 06:16:09

Replying to [comment:96 gh-kliem]:
> [...] I was just thinking that a more meaningful error message could be nicer. 

I agree, so please feel free to push this change to the ticket. Thanks!


---

Comment by mkoeppe created at 2021-05-26 06:16:56

Replying to [comment:95 gh-kliem]:
> {{{
> kliem`@`cofio:~/localhome/sage/src/sage/geometry/polyhedron$ tail -f POLYMAKE.log
> [...]
> Loading applications now...Can't locate object method "new" via package "Term::ReadLine::Gnu" at /srv/public/kliem/sage/local/share/polymake/perllib/Polymake/Core/Shell.pm line 30.
> }}}

Looks like `perl_term_readline_gnu` is not installed correctly.


---

Comment by @kliem created at 2021-05-26 07:17:33

Replying to [comment:100 mkoeppe]:
> Replying to [comment:95 gh-kliem]:
> > {{{
> > kliem`@`cofio:~/localhome/sage/src/sage/geometry/polyhedron$ tail -f POLYMAKE.log
> > [...]
> > Loading applications now...Can't locate object method "new" via package "Term::ReadLine::Gnu" at /srv/public/kliem/sage/local/share/polymake/perllib/Polymake/Core/Shell.pm line 30.
> > }}}
> 
> Looks like `perl_term_readline_gnu` is not installed correctly.
> 
> 
> 
According to `dpkg -s libterm-readline-gnu-perl` I have version 1.36-1 installed. But anyway, it is not a huge issue to me, as installiing `jupymake` solved this all.


---

Comment by @kliem created at 2021-05-26 07:20:22

New commits:


---

Comment by git created at 2021-05-26 09:13:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-26 09:22:23

`polymake` has specific options for precomputed data, so that it takes the input unconditionally.

If we do not use it, our pickling/unpickling is even worse than recreating the polytope:

Before my commits:


```
sage: %time P = polytopes.hypercube(8, backend='polymake')                                                                                                                                                                                                                                                                                                                 
CPU times: user 3.16 s, sys: 200 ms, total: 3.36 s
Wall time: 3.36 s
sage: %time P1 = loads(dumps(P))                                                                                                                                                                                                                                                                                                                                           
CPU times: user 828 ms, sys: 35.9 ms, total: 864 ms
Wall time: 863 ms
sage: %time P._polymake_polytope.F_VECTOR                                                                                                                                                                                                                                                                                                                                  
CPU times: user 18.4 ms, sys: 162 µs, total: 18.6 ms
Wall time: 18.5 ms
256 1024 1792 1792 1120 448 112 16
sage: %time P1._polymake_polytope.F_VECTOR                                                                                                                                                                                                                                                                                                                                 
CPU times: user 12.5 s, sys: 0 ns, total: 12.5 s
Wall time: 12.5 s
256 1024 1792 1792 1120 448 112 16
```


After:


```
sage: %time P = polytopes.hypercube(8, backend='polymake')                                                                                                                                                                                                                                                                                                                 
CPU times: user 4.63 s, sys: 287 ms, total: 4.92 s
Wall time: 4.92 s
sage: %time P1 = loads(dumps(P))                                                                                                                                                                                                                                                                                                                                           
CPU times: user 842 ms, sys: 39.8 ms, total: 882 ms
Wall time: 881 ms
sage: %time P._polymake_polytope.F_VECTOR                                                                                                                                                                                                                                                                                                                                  
CPU times: user 18.7 ms, sys: 168 µs, total: 18.8 ms
Wall time: 18.7 ms
256 1024 1792 1792 1120 448 112 16
sage: %time P1._polymake_polytope.F_VECTOR                                                                                                                                                                                                                                                                                                                                 
CPU times: user 27.3 ms, sys: 0 ns, total: 27.3 ms
Wall time: 27.1 ms
256 1024 1792 1792 1120 448 112 16
```



---

Comment by git created at 2021-05-26 09:40:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-26 14:20:31

Looks like commit ba0a479 got lost


---

Comment by git created at 2021-05-26 14:36:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-26 14:36:25

Thanks for catching this.


---

Comment by mkoeppe created at 2021-05-26 17:14:09

I'm happy with these changes.


---

Comment by tscrim created at 2021-05-27 07:57:52

I am also happy with the current state. We can do more work later on with any specific issue (in particular, the `_test_lawrence` as I suspect that was already an issue before this). Based on everything, I am setting to a positive review. If there are any objections, feel free to revert.


---

Comment by tscrim created at 2021-05-27 07:57:52

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-05-27 16:31:13

Thanks!


---

Comment by vbraun created at 2021-06-07 23:04:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-07 23:04:46


```
**********************************************************************
File "src/sage/interfaces/polymake.py", line 187, in sage.interfaces.polymake.PolymakeAbstract.version
Failed example:
    Polymake(command='foobar').version()
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: unable to start polymake because the command 'foobar' failed:
    The command was not found or was not executable: foobar.
    Please install the optional polymake package for sage (but read its SPKG.txt first!)
    or install polymake system-wide
Got:
    doctest:warning
      File "/home/release/Sage/src/bin/sage-runtests", line 144, in <module>
        err = DC.run()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/control.py", line 1207, in run
        self.run_doctests()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/control.py", line 909, in run_doctests
        self.dispatcher.dispatch()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 2040, in dispatch
        self.parallel_dispatch()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1935, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 2207, in start
        super(DocTestWorker, self).start()
      File "/usr/lib64/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib64/python3.9/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib64/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib64/python3.9/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib64/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib64/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 2179, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 2508, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 2555, in _run
        result = runner.run(test)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 906, in run
        return self._run(test, compileflags, out)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.PolymakeAbstract.version[1]>", line 1, in <module>
        Polymake(command='foobar').version()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 196, in version
        return self.get('$Polymake::Version')
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 617, in get
        return self.eval("print {};".format(cmd)).strip()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 1381, in eval
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 1381, in <listcomp>
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 2120, in _eval_line
        self._start()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 1851, in _start
        deprecation(27745, "the pexpect-based interface to polymake is deprecated. Install package jupymake so that Sage can use the more robust jupymake-based interface to polymake")
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/superseded.py", line 145, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/lib64/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: the pexpect-based interface to polymake is deprecated. Install package jupymake so that Sage can use the more robust jupymake-based interface to polymake
    See https://trac.sagemath.org/27745 for details.
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 492, in _start
        self._expect = SageSpawn(cmd,
      File "sage/interfaces/sagespawn.pyx", line 65, in sage.interfaces.sagespawn.SageSpawn.__init__ (build/cythonized/sage/interfaces/sagespawn.c:1984)
        with ContainChildren(silent=True):
      File "sage/interfaces/sagespawn.pyx", line 66, in sage.interfaces.sagespawn.SageSpawn.__init__ (build/cythonized/sage/interfaces/sagespawn.c:1938)
        spawn.__init__(self, *args, **kwds)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/pexpect/pty_spawn.py", line 205, in __init__
        self._spawn(command, args, preexec_fn, dimensions)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/pexpect/pty_spawn.py", line 276, in _spawn
        raise ExceptionPexpect('The command was not found or was not ' +
    pexpect.exceptions.ExceptionPexpect: The command was not found or was not executable: foobar.
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 1856, in _start
        Expect._start(self, alt_message=None)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 503, in _start
        raise RuntimeError("unable to start %s because the command %r failed: %s\n%s" %
    RuntimeError: unable to start polymake because the command 'foobar' failed: The command was not found or was not executable: foobar.
    Please install the optional polymake package for sage  (but read its SPKG.txt first!)
    or install polymake system-wide
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.PolymakeAbstract.version[1]>", line 1, in <module>
        Polymake(command='foobar').version()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12906)
        self.cache = f(self._instance)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 196, in version
        return self.get('$Polymake::Version')
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 617, in get
        return self.eval("print {};".format(cmd)).strip()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 1381, in eval
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/expect.py", line 1381, in <listcomp>
        return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 2120, in _eval_line
        self._start()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/interfaces/polymake.py", line 1858, in _start
        raise RuntimeError("runtime error with deprecated pexpect-base interface to polymake; please install jupymake")
    RuntimeError: runtime error with deprecated pexpect-base interface to polymake; please install jupymake
**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.polymake.PolymakeAbstract.version
    [54 tests, 1 failure, 0.03 s]
----------------------------------------------------------------------
sage -t --long --warn-long 47.5 --random-seed=0 src/sage/interfaces/polymake.py  # 1 doctest failed
----------------------------------------------------------------------

```



---

Comment by mkoeppe created at 2021-06-11 19:52:44

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-11 19:52:44

New commits:


---

Comment by tscrim created at 2021-06-12 08:47:15

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-12 13:45:56

Thanks!


---

Comment by vbraun created at 2021-06-20 07:26:14

When testing with --optional=lrslib I get

```
sage -t --long --random-seed=0 src/sage/game_theory/catalog_normal_form_games.py  # 16 doctests failed
sage -t --long --random-seed=0 src/sage/game_theory/parser.py  # 6 doctests failed
sage -t --long --random-seed=0 src/sage/game_theory/normal_form_game.py  # 19 doctests failed
```

E.g.

```
File "src/sage/game_theory/parser.py", line 158, in sage.game_theory.parser.Parser.format_lrs
Failed example:
    lrs_output[5:16]  # optional - lrslib
Expected:
    ['\n',
     '***** 4 4 rational\n',
     '2  0  1  2 \n',
     '1  1/2  1/2 -2 \n',
     '\n',
     '2  0  1  2 \n',
     '1  0  1 -2 \n',
     '\n',
     '\n',
     '*Number of equilibria found: 2\n',
     '*Player 1: vertices=3 bases=3 pivots=5\n']
Got:
    []
```



---

Comment by vbraun created at 2021-06-20 07:26:14

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-06-20 15:36:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-20 15:38:52

I only got these failures:

```
sage -t --long --random-seed=0 src/sage/game_theory/parser.py  # 2 doctests failed
```

which are now fixed by aa028b7


---

Comment by mkoeppe created at 2021-06-20 15:43:17

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-20 15:43:50

Details for the other failures please?


---

Comment by tscrim created at 2021-07-09 05:53:44

I am getting all of the failures that Volker is encountering. Running the block of lines 137-152 in `game_theory/parser.py`, I get

```
sage: lrs_output
['\n',
 '*nash:lrslib v.7.1 2020.10.17(64bit,lrsgmp.h,hybrid arithmetic) gmp v.6.2\n',
 '*Input taken from  /home/uqtscrim/.sage/temp/SMP-36PQ8T2/14500/tmp_ey7z4keh']
```

As an intermediate check

```
sage: g._Hrepresentation(A, -A)
('H-representation\nlinearity 1 5\nbegin\n5 4 rational\n0 1 0 0 \n0 0 1 0 \n0 1 3  1 \n0 2 2  1 \n-1 1 1 0 \nend\n',
 'H-representation\nlinearity 1 5\nbegin\n5 4 rational\n0 -1 -2  1 \n0 -3 -2  1 \n0 1 0 0 \n0 0 1 0 \n-1 1 1 0 \nend\n')
```



---

Comment by mkoeppe created at 2021-07-09 06:59:16

Help with fixing this is very welcome...


---

Comment by tscrim created at 2021-07-09 07:02:29

Do you get the same for `g._Hrepresentation(A, -A)` in that code block?


---

Comment by mkoeppe created at 2021-07-11 00:08:42

Thanks for testing. The `lrs_output` that you're getting there is too short. 
So this looks like the installed `lrsnash` is broken. Is this from a system installation of lrslib, or from a Sage-installed lrslib? (see config.log)


---

Comment by mkoeppe created at 2021-07-11 01:17:42

OK, I have reproduced this failure using `tox -e docker-ubuntu-focal-standard`.
`lrsnash` is crashing with SIGSEGV on the given input.


---

Comment by mkoeppe created at 2021-07-11 02:25:15

I have added a basic test for `lrsnash` to the autoconfiscated lrslib at https://github.com/mkoeppe/lrslib (the real upstream has no automated tests); the SIGSEGV can be seen on many platforms, for example
https://github.com/mkoeppe/lrslib/runs/3038293301


---

Comment by mkoeppe created at 2021-07-11 02:38:05

It may be relevant that `lrsnash` indicates on stderr that it is "Processing legacy input files. Alternatively, you may skip setupnash and pass its input file to this program".

It seems `lrsnash`, at least for this type of input, is broken. Using the lrslib package on `ubuntu-focal` (lrslib 0.70-3), I get `free(): double free detected in tcache 2\n` and an error exit with status 6.


---

Comment by mkoeppe created at 2021-07-11 02:45:34

I'm not sure how to proceed here. We could relabel the uses of `lrslib` in the neglected `sage.game_theory` package with `lrsnash`, disabling these tests. We simply do not seem to have a working backend for game theory. 

(The uses of `lrslib` for volume computation in `sage.geometry` are likely OK.)


---

Comment by mkoeppe created at 2021-07-11 03:50:39

The new input format is explained in http://cgm.cs.mcgill.ca/~avis/C/lrslib/USERGUIDE.html#nash


---

Comment by mkoeppe created at 2021-07-13 23:19:16

The new format works better - https://github.com/mkoeppe/lrslib/runs/3060863149


---

Comment by git created at 2021-07-13 23:44:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-14 00:03:35

Ready for testing


---

Comment by git created at 2021-07-14 00:23:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 00:53:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-14 00:59:33

Tests at https://github.com/mkoeppe/sage/actions/runs/1028577144, https://github.com/mkoeppe/sage/actions/runs/1028577149, https://github.com/mkoeppe/sage/actions/runs/1028577148


---

Comment by tscrim created at 2021-07-14 02:13:34

Thank you for fixing that. I have made a few changes to the parser file so that it tests the new format. I also added it to the doc and did some very slight cleanup of that file too.

I am happy with everything. If my changes are good, then we can set this to a positive review. All tests pass for me.
----
New commits:


---

Comment by mkoeppe created at 2021-07-14 03:22:13

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-14 03:22:13

Thanks, LGTM.

For the record, I tested the `spkg-configure.m4` using `tox -e docker-ubuntu-xenial-maximal -- config.status` (correctly does not accept lrslib) and `tox -e docker-ubuntu-bionic-maximal -- config.status` (correctly accepts lrslib).


---

Comment by mkoeppe created at 2021-07-19 00:12:50

Changing priority from major to critical.


---

Comment by vbraun created at 2021-07-23 20:11:59

Resolution: fixed
