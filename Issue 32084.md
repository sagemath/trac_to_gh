# Issue 32084: is_prime() always returns False for rational numbers

Issue created by migration from https://trac.sagemath.org/ticket/32321

Original creator: lorenz

Original creation time: 2021-08-01 07:19:21

CC:  slelievre

Keywords: rationals, integers, primality

Using `is_prime()` on rational numbers currently always returns `False`. This patch implements an `is_prime()` method for rationals that returns `True` iff the rational is a prime integer.

I know it's debatable what the correct behaviour _should_ be in this case, but here are three arguments in favour of this change:

* It's what number fields already do:
  {{{
  sage: K.<t> = NumberField(x**2+1)
  sage: K(7).is_prime()
  True
  }}}
  In other words, Sage's definition of prime elements in a number field is already different from the definition of prime elements in a general ring. There doesn't seem to be a good reason why we can't also change it for rationals.

* The current behaviour can cause significant headache: Just having one `/` anywhere in a long sequence of operations turns everything into `QQ`s, which makes primality testing fail unconditionally later on. I've personally programmed quite a few infinite loops due to this kind of heisenbug, and I know others who've fallen prey to the same issue.
  
  On the flipside, there appears to be no reason anyone would _want_ to intentionally invoke the current implementation of the function, as it's just a convoluted way of writing `False`. Indeed, in support of this theory, none of the existing doctests relied on the current behaviour.

* The documentation of the global `is_prime()` function, which calls into the argument's `.is_prime()` method, currently states: "Return `True` if `n` is a prime number". This is again a matter of interpretation, but I suspect many people would think that `QQ(5)` is as much a "prime number" as `ZZ(5)` is.


---

Comment by lorenz created at 2021-08-01 07:19:32

Changing status from new to needs_review.


---

Comment by slelievre created at 2021-08-01 13:30:18

I agree making `is_prime` return `True` for prime integers,
even if represented as rationals, has merit.

I disagree with calling `-3` or `-7` non-prime.


---

Comment by slelievre created at 2021-08-01 13:39:03

This deserves starting a discussion on sage-devel
and advertising it on sage-nt.


---

Comment by lorenz created at 2021-08-01 16:36:45

I agree that `-7` is prime, but I'm not sure about `-3`. (Just kidding.)

This patch simply reduces `is_prime` for `QQ` to `is_prime` on `ZZ`. Changing the behaviour of `is_prime` on negative integers feels somewhat orthogonal, and I expect this to be more controversial and more likely to break existing software (it contradicts currently documented behaviour). Practically speaking, my guess would be that anyone who really needs negative integers to be prime is already computing with ideals anyway.

I'd suggest keeping this patch as is and discussing the primality of negative integers in a new ticket.


---

Comment by nbruin created at 2021-08-01 17:06:10

Nonzero elements in QQ are not primes because they are units: if you take QQ/3QQ, you get the zero ring, which is not an integral domain. On the other hand, ZZ/(-3ZZ) is an integral domain, so negative integers can be primes.

The definition on number fields is indeed a bit problematic.

For the second argument mentioned in the ticket description: Python and Sage do have multiple division operations. The operator `//` will perform an integer division (and `%` produces the corresponding remainder, so if you need both you should call a routine that returns both at once.

If the behaviour of the global `is_prime` is confusing, it would need to be fixed and documented (i.e., "if `is_prime` is passed a rational number that can be converted to an integer, it will be converted to an integer before its primeness is determined. An error is raised if a rational number is passed in that does not lie in the integers")


---

Comment by slelievre created at 2021-08-01 18:10:41

Thanks for emailing sage-devel.

Leaving out the case of negative numbers here seems right.


---

Comment by soehms created at 2021-08-01 21:11:47

This has been discussed 3 years ago: [see this sage-devel thread](https://groups.google.com/g/sage-devel/c/NN0VP-OVZLw/m/xgbA73PsBAAJ). The conclusion was that the behavior should be kept but should produce a warning!


---

Comment by lorenz created at 2021-08-02 10:03:40

Thanks for your responses. The linked email thread makes it obvious that there won't be universal consensus about this.

The behavior of `.is_prime()` in number fields follows from the fact that `NumberField`s override most of the ideal machinery with fractional ideals, which is mathematically "wrong" in a very similar way as `QQ(5).is_prime()` is. Fixing _that_ is guaranteed to break lots of existing code, though; see for example comment 14 of #7596. So number fields are allowed to violate the general `Ring` interface for convenience, but `QQ` — despite _being_ a number field — isn't?

To reiterate:
* *Any code that relies on the current behavior is already broken* (namely, for number fields).
* I expect the proportion of users for whom this change will make things worse to be zero.

That said, I would personally be fine with making the global `is_prime()` coerce everything into `ZZ` and throw errors if this is impossible. Presumably though, effects like `is_prime(4/2) != (4/2).is_prime()` would be controversial.


---

Comment by soehms created at 2021-08-02 15:59:29

Replying to [comment:8 lorenz]:

> That said, I would personally be fine with making the global `is_prime()` coerce everything into `ZZ` and throw errors if this is impossible. Presumably though, effects like `is_prime(4/2) != (4/2).is_prime()` would be controversial.

If the name of the function would be `is_prime_number` I would agree. But as long as it could be interpreted in the sense of `is_prime_element`, too, I don't think that it would make things better. It would only change the asumption about the context in which the adjective `prime` is used. My suggestion in the thread linked above was:

> Deprecation of "is_prime" as function (not as method!!! since there is no ambiguity here) and replace it by two new functions "is_prime_number" and "is_prime_element" (according to the corresponding Wikipedia articles). The first function should try to coerce the input into ZZ and raise an error if this it not possible or not positive. The second one should raise an error if the input is not an element of a unital commutative ring and a warning in the case the ring is a field (according to #25046).


---

Comment by nbruin created at 2021-08-02 16:46:58

Replying to [comment:8 lorenz]:
> The behavior of `.is_prime()` in number fields follows from the fact that `NumberField`s override most of the ideal machinery with fractional ideals, which is mathematically "wrong" in a very similar way as `QQ(5).is_prime()` is. Fixing _that_ is guaranteed to break lots of existing code, though; see for example comment 14 of #7596. So number fields are allowed to violate the general `Ring` interface for convenience, but `QQ` — despite _being_ a number field — isn't?

I don't think all that much high-quality code will be asking of *elements* of number fields whether they are prime: I'd expect that question will mainly be asked of fractional ideals (which, in the case of number fields are indeed often conflated with integral ideals). But expectations about what users do (and how they perceive changes!) is often wrong.

Regardless of what the behaviour of `is_prime` on number field elements should be, it presently definitely has confusing documentation because it presently doesn't clarify whether it uses "ideal" in the sense of fractional ideal or as ideal of the ring of integers. In fact, the documentation _literally_ says:

```
In fields, an element is never prime::
```

The documentation of `NumberField.ideal` clarifies that ideals in NumberFields are fractional ideals relative to the ring of integers, but that is not referred to in `is_prime`. This is a problem if you inherit from a superclass (Rings in this case), but then don't compatibly implement all the related protocols (here, replacing ideals with fractional ideals). It means there are all kind of routines that may *seem* like they are inherited properly, but are not. In this case, it's the documentation that breaks :-).

In principle, `QQ(a).is_prime` could be documented analogously to say it returns 'True" if `a` generates a fractional ideal that is a prime ideal in ZZ. I still think that would be wrong because the `(5/3).is_prime()` would almost certainly result from an error of the user, where `5/3` is the result of an expression that was meant to result in an integer.

> That said, I would personally be fine with making the global `is_prime()` coerce everything into `ZZ` and throw errors if this is impossible. Presumably though, effects like `is_prime(4/2) != (4/2).is_prime()` would be controversial.

+1 for that. That is in step with its documentation already.


---

Comment by git created at 2021-08-05 10:30:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-05 10:33:19

Replying to [comment:9 soehms]:
> > Deprecation of "is_prime" as function (not as method!!! since there is no ambiguity here) and replace it by two new functions "is_prime_number" and "is_prime_element" (according to the corresponding Wikipedia articles).

I think this would make things worse for everyone:
* Non-algebraists will type `is_prime()` without even realizing this is ambiguous, then be confused about why the function doesn't exist, then be confused about which of the two similarly-named functions they want (especially given that they behave identically in many cases they might try out!).

* Some algebraists may disagree with `is_prime()` being a function that's restricted to integers, but they'll easily remember this and that's the end of the story. I imagine the extra keystrokes of having to type `_number` every time they really just want to test an integer for primality would be much more annoying to everyone than the cognitive dissonance resulting from the name being _wrong_.


Replying to [comment:10 nbruin]:
> Replying to [comment:8 lorenz]:
> > That said, I would personally be fine with making the global `is_prime()` coerce everything into `ZZ` and throw errors if this is impossible. Presumably though, effects like `is_prime(4/2) != (4/2).is_prime()` would be controversial.
> 
> +1 for that. That is in step with its documentation already.

Thanks. I've updated the patch to leave `Rational.is_prime()` alone and change only the global `is_prime()` function instead.


---

Comment by soehms created at 2021-08-06 21:29:18

Replying to [comment:12 lorenz]:
> Replying to [comment:9 soehms]:
> * Some algebraists may disagree with `is_prime()` being a function that's restricted to integers, but they'll easily remember this and that's the end of the story.

But probably some more may disagree if answers like this are going to change:


```sage
sage: is_prime(5 + O(7^20))                                                                                                                                                                          
False
sage: is_prime(ZZ(5 + O(7^20)))                                                                                                                                                                      
True
```



---

Comment by lorenz created at 2021-08-19 14:11:42

Replying to [comment:13 soehms]:
> But probably some more may disagree if answers like this are going to change:
> 
> {{{#!sage
> sage: is_prime(5 + O(7^20))                                                                                                                                                                          
> False
> sage: is_prime(ZZ(5 + O(7^20)))                                                                                                                                                                      
> True
> }}}

Would you be happier with the proposed change if we first issued a deprecation warning in `is_prime()` when non‑`Integer`s are passed, then made the change after a few releases?


---

Comment by soehms created at 2021-08-30 17:18:28

Replying to [comment:14 lorenz]:
> Replying to [comment:13 soehms]:
> > But probably some more may disagree if answers like this are going to change:
> > 
> > {{{#!sage
> > sage: is_prime(5 + O(7^20))                                                                                                                                                                          
> > False
> > sage: is_prime(ZZ(5 + O(7^20)))                                                                                                                                                                      
> > True
> > }}}
> 
> Would you be happier with the proposed change if we first issued a deprecation warning in `is_prime()` when non‑`Integer`s are passed, then made the change after a few releases?


In a former post you mentioned users that are not aware of the ambiguity. IMHO, whatever solution you may find here, one aim must be that these people have learned about this ambiguity after applying the function in such a situation. Otherwise, Sage did a bad job on its educational mission. 

I can agree to any solution, that still makes the user become aware of that, but more comfortably as it is currently. Did you already think about a once per session warning, as suggested in the 2018 sage-devel thread (see for example #25046)?

Anyway, I think the participants of the 2018 discussion should have a chance to be involved in the decisions that will be done here.


---

Comment by wuthrich created at 2021-08-31 09:27:27

For what it is worth: I am in favour of is_prime_number to return True in ZZ or QQ if it is a positive prime and is_prime_element in any ring to test for that property. For number fields is_prime_ideal.


---

Comment by kcrisman created at 2021-08-31 10:17:43

The old behavior has been there a long time.  I only see soehms mentioning the warning proposal of #25046, but that probably should be discussed more here.


---

Comment by lorenz created at 2021-10-14 05:37:03

I had a shot at #25046.

Given that there clearly won't be any consensus on changing the behaviour of `is_prime()`, I think this can be closed.


---

Comment by klee created at 2022-09-23 02:32:08

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-09-23 02:32:08

#25046 is the final solution for this long standing discussion.

I agree to closing this ticket.


---

Comment by mkoeppe created at 2022-11-14 19:36:43

Resolution: invalid
