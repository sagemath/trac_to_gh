# Issue 25913: fraction field: fix conversion from symbolic ring

Issue created by migration from https://trac.sagemath.org/ticket/26150

Original creator: dkrenn

Original creation time: 2018-08-28 11:14:46

CC:  cheuberg mmezzarobba


```
sage: z = SR.var('z')
sage: CyclotomicField(2)['z'].fraction_field()(2*(4*z + 5)/((z + 1)*(z - 1)^4))
```

raises an error but shouldn't. This issue is also mentioned on #24539.

AFAICS it worked in earlier [SageMath](SageMath) versions, but probably due to #23664 (unchecked) it stopped working.


---

Comment by dkrenn created at 2018-08-28 11:19:10

New commits:


---

Comment by dkrenn created at 2018-08-28 11:19:10

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2018-08-28 11:58:54

Thanks for the fix! You can set the ticket to positive_review on my behalf if the patchbot is happy.


---

Comment by dkrenn created at 2018-08-29 08:08:25

Unfortunately, there is one doctest failing:

```
File "src/sage/rings/function_field/function_field.py", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom
Failed example:
    L.hom(r, base_morphism=phi)
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: invalid literal for int() with base 10: "Error in dput(length(sage1)) : object 'sage1' not foun"
```

I have no idea what is going on here.


---

Comment by dkrenn created at 2018-08-29 08:08:25

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-08-29 08:30:29

Nitpick: `:trac:`#26150`` -> `:trac:`26150``


---

Comment by git created at 2018-08-29 08:33:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2018-08-29 08:34:12

Replying to [comment:6 jdemeyer]:
> Nitpick: `:trac:`#26150`` -> `:trac:`26150``

Thanks. Changed.


---

Comment by dkrenn created at 2018-08-29 11:13:17

Replying to [comment:5 dkrenn]:
> Unfortunately, there is one doctest failing:
> {{{
> File "src/sage/rings/function_field/function_field.py", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom
> Failed example:
>     L.hom(r, base_morphism=phi)
> Exception raised:
>     Traceback (most recent call last):
>     ...
>     ValueError: invalid literal for int() with base 10: "Error in dput(length(sage1)) : object 'sage1' not foun"
> }}}

Follow up at #26155.


---

Comment by git created at 2018-08-30 07:41:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2018-08-30 07:46:59

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2018-08-30 07:46:59

This is now an alternative fix for the issue. Needs review again and let's see what the patchbot says :)


---

Comment by dkrenn created at 2018-08-30 12:52:14

Changing status from needs_review to needs_work.


---

Comment by dkrenn created at 2018-08-30 12:52:14

Again some failing doctests... :(


---

Comment by git created at 2018-08-30 14:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-30 14:46:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2018-08-30 14:49:34

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2018-08-30 14:49:34

There is some underlying problem with a recursive call when creating an element out of `int(1)`. This was somehow hidden before. I rewrote the element constructor a bit to adapt; also fixing an issue raised on #24539. The behavior is now more consistent with remaining [SageMath](SageMath).

So again, let us see what the patchbot says...


---

Comment by git created at 2018-09-15 10:07:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-15 17:24:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2018-09-16 18:15:56

Finally, I've written a fix that solves the issues and with which the patchbot is happy as well. To be more accurate, I've took the liberty to slightly rewrite the element constructor so that it covers a broader spectrum of inputs for the conversion. Now it should also be "correct" in the sense what it does at which point ;)

Please Review (again)


---

Comment by dkrenn created at 2019-03-27 20:16:13

`@`mmezzarobba: You already have reviewed this ticket, but a small change was done after that. I would appreciate a review of the changes :)


---

Comment by mmezzarobba created at 2019-04-03 08:04:03

Thanks for the notice.

I agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?


---

Comment by git created at 2019-04-03 12:15:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2019-04-03 12:18:14

Replying to [comment:20 mmezzarobba]:
> Thanks for the notice.
> 
> I agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?

Added a doctest:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[1a3cc58](https://git.sagemath.org/sage.git/commit/?id=1a3cc587543fd5d4636ab33685ab27d2e9767721)|`Trac #26150: add another doctest`|

```diff
+            sage: T.<t> = ZZ[]
+            sage: S.<s> = ZZ[]
+            sage: S.fraction_field()(s/(s+1), (t-1)/(t+2))
+            (s^2 + 2*s)/(s^2 - 1)
```

Note that there is a conversion between `S` and `T`, so this conversion should be used also in the fraction field, at least in the case nothing else (proper coercion) works.


---

Comment by mmezzarobba created at 2019-04-07 10:13:05

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2019-04-07 10:13:05

If you are really sure you want that, I won't oppose...


---

Comment by vbraun created at 2019-04-08 21:34:13

Resolution: fixed
