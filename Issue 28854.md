# Issue 28854: Build failure of  fplll-5.3.2 on Raspbian Buster (ARM)

Issue created by migration from https://trac.sagemath.org/ticket/29091

Original creator: jsp

Original creation time: 2020-01-28 09:52:03

CC:  malb slelievre chapoton @kliem


```
On Raspberry Pi 4 4GB on Raspbian Buster build failed with fplll:

libtool: link: g++ -std=gnu++11 -std=c++11 -fPIC -I/home/pi/sagemath/sage-9.1.be
ta1/local/include/ -O3 -Wl,-rpath -Wl,/home/pi/sagemath/sage-9.1.beta1/local/lib
 -o .libs/fplll main.o  -L/home/pi/sagemath/sage-9.1.beta1/local/lib -L/lib ./.l
ibs/libfplll.so -lmpfr -lgmp -pthread -Wl,-rpath -Wl,/home/pi/sagemath/sage-9.1.
beta1/local/lib
/usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_store_8'
/usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_load_8'
collect2: error: ld returned 1 exit status

```



---

Attachment

I have added `raspbian-jessie` and `raspbian-stretch` to #29143. There appears to be no Docker image for raspbian-buster.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by chapoton created at 2020-05-13 11:22:15

Changing keywords from "" to "raspberry".


---

Comment by malb created at 2020-06-24 10:31:56

This *might* be fixed upstream, can you try again? See https://github.com/fplll/fplll/issues/418


---

Comment by jsp created at 2020-06-24 13:55:36

Replying to [comment:4 malb]:
> This *might* be fixed upstream, can you try again? See https://github.com/fplll/fplll/issues/418

Building sage-9.1 I get still the same ailure:

```
/bin/bash ../libtool  --tag=CXX   --mode=link g++ -std=gnu++11 -std=c++11  -fPIC -I/home/pi/sagemath/sage-9.1/local/include/ -L/home/pi/sagemath/sage-9.1/local/lib -O3  -Wl,-rpath-link,/home/pi/sagemath/sage-9.1/local/lib -L/home/pi/sagemath/sage-9.1/local/lib -Wl,-rpath,/home/pi/sagemath/sage-9.1/local/lib  -L/lib -o fplll main.o libfplll.la -lmpfr -lmpfr -lgmp -lgmp 
libtool: link: g++ -std=gnu++11 -std=c++11 -fPIC -I/home/pi/sagemath/sage-9.1/local/include/ -O3 -Wl,-rpath-link -Wl,/home/pi/sagemath/sage-9.1/local/lib -Wl,-rpath -Wl,/home/pi/sagemath/sage-9.1/local/lib -o .libs/fplll main.o  -L/home/pi/sagemath/sage-9.1/local/lib -L/lib ./.libs/libfplll.so -lmpfr -lgmp -pthread -Wl,-rpath -Wl,/home/pi/sagemath/sage-9.1/local/lib
/usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_store_8'
/usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_load_8'
collect2: error: ld returned 1 exit status
make[7]: *** [Makefile:1165: fplll] Error 1
make[7]: Leaving directory '/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2/src/fplll'
make[6]: *** [Makefile:739: all] Error 2
make[6]: Leaving directory '/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2/src/fplll'
make[5]: *** [Makefile:483: all-recursive] Error 1
make[5]: Leaving directory '/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2/src'
make[4]: *** [Makefile:370: all] Error 2
make[4]: Leaving directory '/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2/src'
********************************************************************************
Error building fplll-5.3.2
********************************************************************************

real	51m45.333s
user	67m10.859s
sys	1m31.680s
************************************************************************
Error installing package fplll-5.3.2
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /home/pi/sagemath/sage-9.1/logs/pkgs/fplll-5.3.2.log
Describe your computer, operating system, etc.
If you want to try to fix the problem yourself, *don't* just cd to
/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2 and type 'make' or whatever is appropriate.
Instead, the following commands setup all environment variables
correctly and load a subshell for you to debug the error:
  (cd '/home/pi/sagemath/sage-9.1/local/var/tmp/sage/build/fplll-5.3.2' && '/home/pi/sagemath/sage-9.1/sage' --buildsh)
When you are done debugging, you can type "exit" to leave the subshell.
************************************************************************
```



---

Comment by malb created at 2020-06-24 14:09:17

Sorry that fix isn't in Sage (or an upstream release yet). I meant trying upstream `master`. I should cut a new release, though.


---

Comment by slelievre created at 2020-06-24 16:31:13

I opened this issue in the fplll issue tracker

- Fix ARM-specific problem with new multicore code in fplll 5.3.x

  https://github.com/fplll/fplll/issues/432

but apparently this issue might have been relevant

- add `-latomic` when needed

  https://github.com/fplll/fplll/issues/418

and it was fixed in Apr 2020 by this pull request

- check for -latomic

  https://github.com/fplll/fplll/pull/419

The current latest release, fplll 5.3.2, is from Jan 2020.
Thus the fix should be tried by using the master branch.
I hope it fixes things and the next release works on ARM.
Sorry for the extra noise.


---

Comment by mkoeppe created at 2020-06-24 20:22:41

I have just added a test environment for `raspbian-buster`.
You can try

```
tox -e docker-raspbian-buster-standard -- fplll
```

----
New commits:


---

Comment by mkoeppe created at 2020-06-24 20:23:19

Tests running at https://github.com/mkoeppe/sage/actions/runs/146618564


---

Comment by mkoeppe created at 2020-06-24 22:15:32

Running this on my Mac, I was able to reproduce the error:

```
  [fplll-5.3.2] error installing, exit status 1. End of log file:
  [fplll-5.3.2]   make[5]: *** [Makefile:1175: latsieve] Error 1
  [fplll-5.3.2]   /usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_store_8'
  [fplll-5.3.2]   /usr/bin/ld: ./.libs/libfplll.so: undefined reference to `__atomic_load_8'
  [fplll-5.3.2]   collect2: error: ld returned 1 exit status
  [fplll-5.3.2]   make[5]: *** [Makefile:1165: fplll] Error 1
  [fplll-5.3.2]   make[5]: Target 'all-am' not remade because of errors.
  [fplll-5.3.2]   make[5]: Leaving directory '/sage/local/var/tmp/sage/build/fplll-5.3.2/src/fplll'
  [fplll-5.3.2]   make[4]: *** [Makefile:739: all] Error 2
```



---

Comment by mkoeppe created at 2020-06-25 04:37:29

Replying to [comment:9 mkoeppe]:
> I have just added a test environment for `raspbian-buster`.
> You can try
> {{{
> tox -e docker-raspbian-buster-standard -- fplll
> }}}

Actually, it is

```
  tox -e docker-raspbian-buster-armhf-standard -- fplll
```

which will also work on Linux Docker.

Tests with fplll`@`master run at https://github.com/mkoeppe/fplll/actions/runs/146958161


---

Comment by slelievre created at 2020-06-25 13:06:57

Replying to [comment:13 mkoeppe]:
> Tests with fplll`@`master run at https://github.com/mkoeppe/fplll/actions/runs/146958161

It says:
> The job running on runner [GitHub](GitHub) Actions 36 has exceeded the maximum execution time of 360. 

Could a tox environment install most dependencies using Conda via miniforge?

Miniforge provides Conda on ARM:

- https://github.com/conda-forge/miniforge/


---

Comment by mkoeppe created at 2020-06-25 17:15:51

fplll`@`master on `raspbian-buster-armhf-standard` succeeded in 5h 7m 1s at
 https://github.com/mkoeppe/fplll/runs/805921434 

This confirms that master contains the correct fix.


---

Comment by mkoeppe created at 2020-06-25 17:28:40

https://github.com/fplll/fplll/pull/433


---

Comment by git created at 2020-06-26 00:10:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-26 00:11:41

Removed 714bdce from the branch - the build is so slow because of the emulation that it does not make sense to test the sage distribution on this platform on GH Actions.


---

Comment by malb created at 2020-06-29 15:59:10

See https://github.com/fplll/fplll/releases/tag/5.3.3 and #30021.


---

Comment by git created at 2020-07-03 04:30:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-03 04:30:32

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-03 20:25:43

Changing priority from major to minor.


---

Comment by jsp created at 2020-07-09 14:06:56

Changing status from needs_review to positive_review.


---

Comment by jsp created at 2020-07-09 14:06:56

Works for me on a Raspberry Pi 4 4GB, Raspbian Buster


---

Comment by mkoeppe created at 2020-07-09 14:12:51

Here you can read more about how we address portability testing. One does not need an actual Raspberry Pi. https://doc.sagemath.org/html/en/developer/portability_testing.html#testing-sage-on-a-different-platform-using-docker


---

Comment by dimpase created at 2020-07-09 14:58:31

I noted on some other ticket that [GitHub](GitHub) Actions offer an ARM platform.


---

Comment by vbraun created at 2020-07-11 23:26:05

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-07-11 23:26:05

Reviewer name is missing


---

Comment by slelievre created at 2020-07-11 23:38:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-07-15 22:25:15

Resolution: fixed
