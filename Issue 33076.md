# Issue 33076: schur functions construct elements with coefficients in the wrong base ring

archive/issues_033076.json:
```json
{
    "body": "CC:  @tscrim\n\n\n```\nsage: Sym = SymmetricFunctions(QQ['t'])\nsage: Sym.schur()([[2], [1]]) / 2\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\nInput In [51], in <module>\n----> 1 Sym.schur()([[Integer(2)], [Integer(1)]]) / Integer(2)\n\nFile /usr/lib/python3.10/site-packages/sage/modules/with_basis/indexed_element.pyx:896, in sage.modules.with_basis.indexed_element.IndexedFreeModuleElement.__truediv__ (build/cythonized/sage/modules/with_basis/indexed_element.c:9578)()\n\nFile /usr/lib/python3.10/site-packages/sage/categories/rings.py:1349, in Rings.ElementMethods._divide_if_possible(self, y)\n   1347 q, r = self.quo_rem(y)\n   1348 if r != 0:\n-> 1349     raise ValueError(\"%s is not divisible by %s\"%(self, y))\n   1350 return q\n\nValueError: 1 is not divisible by 2\n```\n\nThe underlying reason for this error is that coefficients are stored as integers\n\n```\nsage: Sym.schur()([[2], [1]]).coefficients()[0].parent()\nInteger Ring\n```\n\n\n\nOriginal report https://groups.google.com/g/sage-support/c/vxgtsSwJxXE\n\nIssue created by migration from https://trac.sagemath.org/ticket/33313\n\n",
    "created_at": "2022-02-08T07:27:39Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "schur functions construct elements with coefficients in the wrong base ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33076",
    "user": "https://github.com/videlec"
}
```
CC:  @tscrim


```
sage: Sym = SymmetricFunctions(QQ['t'])
sage: Sym.schur()([[2], [1]]) / 2
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
Input In [51], in <module>
----> 1 Sym.schur()([[Integer(2)], [Integer(1)]]) / Integer(2)

File /usr/lib/python3.10/site-packages/sage/modules/with_basis/indexed_element.pyx:896, in sage.modules.with_basis.indexed_element.IndexedFreeModuleElement.__truediv__ (build/cythonized/sage/modules/with_basis/indexed_element.c:9578)()

File /usr/lib/python3.10/site-packages/sage/categories/rings.py:1349, in Rings.ElementMethods._divide_if_possible(self, y)
   1347 q, r = self.quo_rem(y)
   1348 if r != 0:
-> 1349     raise ValueError("%s is not divisible by %s"%(self, y))
   1350 return q

ValueError: 1 is not divisible by 2
```

The underlying reason for this error is that coefficients are stored as integers

```
sage: Sym.schur()([[2], [1]]).coefficients()[0].parent()
Integer Ring
```



Original report https://groups.google.com/g/sage-support/c/vxgtsSwJxXE

Issue created by migration from https://trac.sagemath.org/ticket/33313





---

archive/issue_comments_470927.json:
```json
{
    "body": "Technically speaking, it shouldn\u2019t matter that they are stored as integers as coercion should allow that to work. That being said, we can be more careful about how we build these things without a loss of optimization during the construction.\n\nWithout testing the code, I am a bit skeptical that there is not also a bug in the input because it should be a partition. I don\u2019t quite understand why this is even constructing an element of the Schur functions, but I don\u2019t have the code in front of me right now.\n\nI will take a more detailed look tomorrow.",
    "created_at": "2022-02-08T10:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470927",
    "user": "https://github.com/tscrim"
}
```

Technically speaking, it shouldn’t matter that they are stored as integers as coercion should allow that to work. That being said, we can be more careful about how we build these things without a loss of optimization during the construction.

Without testing the code, I am a bit skeptical that there is not also a bug in the input because it should be a partition. I don’t quite understand why this is even constructing an element of the Schur functions, but I don’t have the code in front of me right now.

I will take a more detailed look tomorrow.



---

archive/issue_comments_470928.json:
```json
{
    "body": "Ah, the input should be treated as a skew partition. This is where our problems comes from. Here is a more minimal example:\n\n```\nsage: s = SymmetricFunctions(GF(2)).s()\nsage: s([[3,2,1],[2,1]])\ns[1, 1, 1] + 2*s[2, 1] + s[3]\nsage: s.skew_schur([[3,2,1],[2,1]])\ns[1, 1, 1] + 2*s[2, 1] + s[3]\n```\n",
    "created_at": "2022-02-09T00:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470928",
    "user": "https://github.com/tscrim"
}
```

Ah, the input should be treated as a skew partition. This is where our problems comes from. Here is a more minimal example:

```
sage: s = SymmetricFunctions(GF(2)).s()
sage: s([[3,2,1],[2,1]])
s[1, 1, 1] + 2*s[2, 1] + s[3]
sage: s.skew_schur([[3,2,1],[2,1]])
s[1, 1, 1] + 2*s[2, 1] + s[3]
```




---

archive/issue_comments_470929.json:
```json
{
    "body": "Here is a fix, where this is exposing a deeper issue with not converting the coefficients correctly. So working over, say, `GF(2)` leads to coefficients with 2 appearing because they were integers. Now everything is coerced into the base ring and computations are done there.\n\nI also did some optimizations for `skew_by()` and `_apply_multi_module_morphism()`, which came up when I was looking into this ticket.\n\n```\nsage: s = SymmetricFunctions(QQ).s()\nsage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])\n366 \u00b5s \u00b1 2.25 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\nversus with #33267:\n\n```\nsage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])\n391 \u00b5s \u00b1 3.62 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\nversus 9.5:\n\n```\nsage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])\n404 \u00b5s \u00b1 2.91 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\n\n#33267 dependency is for a trivial conflict.\n----\nNew commits:",
    "created_at": "2022-02-09T01:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470929",
    "user": "https://github.com/tscrim"
}
```

Here is a fix, where this is exposing a deeper issue with not converting the coefficients correctly. So working over, say, `GF(2)` leads to coefficients with 2 appearing because they were integers. Now everything is coerced into the base ring and computations are done there.

I also did some optimizations for `skew_by()` and `_apply_multi_module_morphism()`, which came up when I was looking into this ticket.

```
sage: s = SymmetricFunctions(QQ).s()
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
366 µs ± 2.25 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

versus with #33267:

```
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
391 µs ± 3.62 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

versus 9.5:

```
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
404 µs ± 2.91 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


#33267 dependency is for a trivial conflict.
----
New commits:



---

archive/issue_comments_470930.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-09T01:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470930",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470931.json:
```json
{
    "body": "In `coerce_remove_zeros` you do not apply a coercion but simply call the parent `R`. It would make more sense to either call it `convert_remove_zeros` or really use coercion `val = R.coerce(D[index])`.",
    "created_at": "2022-02-09T07:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470931",
    "user": "https://github.com/videlec"
}
```

In `coerce_remove_zeros` you do not apply a coercion but simply call the parent `R`. It would make more sense to either call it `convert_remove_zeros` or really use coercion `val = R.coerce(D[index])`.



---

archive/issue_comments_470932.json:
```json
{
    "body": "pyflakes plugin is not happy about the remaining\n\n```\n         zero = s.zero()\n```\n",
    "created_at": "2022-02-09T10:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470932",
    "user": "https://github.com/fchapoton"
}
```

pyflakes plugin is not happy about the remaining

```
         zero = s.zero()
```




---

archive/issue_comments_470933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-10T00:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470934.json:
```json
{
    "body": "I have chosen to call is convert to be more flexible. I also removed the unused `zero`.",
    "created_at": "2022-02-10T00:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470934",
    "user": "https://github.com/tscrim"
}
```

I have chosen to call is convert to be more flexible. I also removed the unused `zero`.



---

archive/issue_comments_470935.json:
```json
{
    "body": "Patchbot is morally green (failure is due to #32773).",
    "created_at": "2022-02-12T00:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470935",
    "user": "https://github.com/tscrim"
}
```

Patchbot is morally green (failure is due to #32773).



---

archive/issue_comments_470936.json:
```json
{
    "body": "Thanks for writing a fix.",
    "created_at": "2022-02-12T21:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470936",
    "user": "https://github.com/videlec"
}
```

Thanks for writing a fix.



---

archive/issue_comments_470937.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-12T21:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470937",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470938.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-20T13:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33076#issuecomment-470938",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087918.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-20T13:27:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33076#event-87918"
}
```
