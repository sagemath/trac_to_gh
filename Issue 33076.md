# Issue 33076: schur functions construct elements with coefficients in the wrong base ring

Issue created by migration from https://trac.sagemath.org/ticket/33313

Original creator: vdelecroix

Original creation time: 2022-02-08 07:27:39

CC:  tscrim


```
sage: Sym = SymmetricFunctions(QQ['t'])
sage: Sym.schur()([[2], [1]]) / 2
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
Input In [51], in <module>
----> 1 Sym.schur()([[Integer(2)], [Integer(1)]]) / Integer(2)

File /usr/lib/python3.10/site-packages/sage/modules/with_basis/indexed_element.pyx:896, in sage.modules.with_basis.indexed_element.IndexedFreeModuleElement.__truediv__ (build/cythonized/sage/modules/with_basis/indexed_element.c:9578)()

File /usr/lib/python3.10/site-packages/sage/categories/rings.py:1349, in Rings.ElementMethods._divide_if_possible(self, y)
   1347 q, r = self.quo_rem(y)
   1348 if r != 0:
-> 1349     raise ValueError("%s is not divisible by %s"%(self, y))
   1350 return q

ValueError: 1 is not divisible by 2
```

The underlying reason for this error is that coefficients are stored as integers

```
sage: Sym.schur()([[2], [1]]).coefficients()[0].parent()
Integer Ring
```



Original report https://groups.google.com/g/sage-support/c/vxgtsSwJxXE


---

Comment by tscrim created at 2022-02-08 10:31:07

Technically speaking, it shouldn’t matter that they are stored as integers as coercion should allow that to work. That being said, we can be more careful about how we build these things without a loss of optimization during the construction.

Without testing the code, I am a bit skeptical that there is not also a bug in the input because it should be a partition. I don’t quite understand why this is even constructing an element of the Schur functions, but I don’t have the code in front of me right now.

I will take a more detailed look tomorrow.


---

Comment by tscrim created at 2022-02-09 00:19:11

Ah, the input should be treated as a skew partition. This is where our problems comes from. Here is a more minimal example:

```
sage: s = SymmetricFunctions(GF(2)).s()
sage: s([[3,2,1],[2,1]])
s[1, 1, 1] + 2*s[2, 1] + s[3]
sage: s.skew_schur([[3,2,1],[2,1]])
s[1, 1, 1] + 2*s[2, 1] + s[3]
```



---

Comment by tscrim created at 2022-02-09 01:43:55

Here is a fix, where this is exposing a deeper issue with not converting the coefficients correctly. So working over, say, `GF(2)` leads to coefficients with 2 appearing because they were integers. Now everything is coerced into the base ring and computations are done there.

I also did some optimizations for `skew_by()` and `_apply_multi_module_morphism()`, which came up when I was looking into this ticket.

```
sage: s = SymmetricFunctions(QQ).s()
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
366 µs ± 2.25 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

versus with #33267:

```
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
391 µs ± 3.62 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

versus 9.5:

```
sage: %timeit s[5,4,2,2,1].skew_by(s[3,2,2,1] + s[3,1])
404 µs ± 2.91 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


#33267 dependency is for a trivial conflict.
----
New commits:


---

Comment by tscrim created at 2022-02-09 01:43:55

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2022-02-09 07:14:00

In `coerce_remove_zeros` you do not apply a coercion but simply call the parent `R`. It would make more sense to either call it `convert_remove_zeros` or really use coercion `val = R.coerce(D[index])`.


---

Comment by chapoton created at 2022-02-09 10:03:06

pyflakes plugin is not happy about the remaining

```
         zero = s.zero()
```



---

Comment by git created at 2022-02-10 00:44:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-10 00:44:53

I have chosen to call is convert to be more flexible. I also removed the unused `zero`.


---

Comment by tscrim created at 2022-02-12 00:40:57

Patchbot is morally green (failure is due to #32773).


---

Comment by vdelecroix created at 2022-02-12 21:52:26

Thanks for writing a fix.


---

Comment by vdelecroix created at 2022-02-12 21:52:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-20 13:27:30

Resolution: fixed
