# Issue 21025: Center related classes and methods in Skew Polynomials

archive/issues_021025.json:
```json
{
    "body": "CC:  @tscrim @xcaruso @johanrosenkilde dlucas\n\nWe propose the addition of the following methods and classes to skew polynomials: \n1. class CenterSkewPolynomial_generic_dense\n2. class SectionSkewPolynomialCenterInjection\n3. class SkewPolynomialCenterInjection\n4. class CenterSkewPolynomialRing\n\n5. def center in `class SkewPolynomialRing_general`\n\n6. Following methods to the class `SkewPolynomial_finite_field_dense`:\n- def reduced_norm\n- def reduced_norm_factor\n- def is_central\n- def optimal_bound\n\n\nNote: The original ticket #13215 first introduced this functionality. That was subsequently modified to support the basic implementation of skew polynomials and the center based methods from that ticket that were removed are being reintroduced here.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21262\n\n",
    "created_at": "2016-08-17T09:56:30Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Center related classes and methods in Skew Polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21025",
    "user": "https://github.com/arpitdm"
}
```
CC:  @tscrim @xcaruso @johanrosenkilde dlucas

We propose the addition of the following methods and classes to skew polynomials: 
1. class CenterSkewPolynomial_generic_dense
2. class SectionSkewPolynomialCenterInjection
3. class SkewPolynomialCenterInjection
4. class CenterSkewPolynomialRing

5. def center in `class SkewPolynomialRing_general`

6. Following methods to the class `SkewPolynomial_finite_field_dense`:
- def reduced_norm
- def reduced_norm_factor
- def is_central
- def optimal_bound


Note: The original ticket #13215 first introduced this functionality. That was subsequently modified to support the basic implementation of skew polynomials and the center based methods from that ticket that were removed are being reintroduced here.

Issue created by migration from https://trac.sagemath.org/ticket/21262





---

archive/issue_comments_290936.json:
```json
{
    "body": "Please also note that the current code is more or less just what was in the original patch for #13215 related to Center related methods and classes. No effort has e.g. been made yet to accommodate for changes in #13215 since this addition was factored out.\n----\nLast 10 new commits:",
    "created_at": "2016-08-17T10:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290936",
    "user": "https://github.com/arpitdm"
}
```

Please also note that the current code is more or less just what was in the original patch for #13215 related to Center related methods and classes. No effort has e.g. been made yet to accommodate for changes in #13215 since this addition was factored out.
----
Last 10 new commits:



---

archive/issue_comments_290937.json:
```json
{
    "body": "The methods `is_central` and `optimal_bound` make sense for skew polynomials over any ring, right? So it is a bit weird (according to me) to define them only in the class `SkewPolynomial_finite_field_dense` (through *I* very probably do this first).\n\nSimilarly the reduced norm makes sense as soon as the twist map has finite order (and in addition I am very interested in using it over a finite extension of Qp). So, I would suggest to move it to the class `SkewPolynomial_generic_dense` and to raise `ValueError` or `TypeError` when the twist map has not finite order.",
    "created_at": "2016-08-17T12:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290937",
    "user": "https://github.com/xcaruso"
}
```

The methods `is_central` and `optimal_bound` make sense for skew polynomials over any ring, right? So it is a bit weird (according to me) to define them only in the class `SkewPolynomial_finite_field_dense` (through *I* very probably do this first).

Similarly the reduced norm makes sense as soon as the twist map has finite order (and in addition I am very interested in using it over a finite extension of Qp). So, I would suggest to move it to the class `SkewPolynomial_generic_dense` and to raise `ValueError` or `TypeError` when the twist map has not finite order.



---

archive/issue_comments_290938.json:
```json
{
    "body": "As I said before, the features provided by this ticket do not only make sense for finite fields but more generally for fields on which the twisting endomorphism has finite order. I then renamed the class `SkewPolynomial_finite_field_dense` and called it `SkewPolynomial_finite_order_dense`. \nMoreover, I polished the code and made all methods work (e.g. some imports were missing). \n\nTicket ready for review.\n----\nNew commits:",
    "created_at": "2016-08-25T22:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290938",
    "user": "https://github.com/xcaruso"
}
```

As I said before, the features provided by this ticket do not only make sense for finite fields but more generally for fields on which the twisting endomorphism has finite order. I then renamed the class `SkewPolynomial_finite_field_dense` and called it `SkewPolynomial_finite_order_dense`. 
Moreover, I polished the code and made all methods work (e.g. some imports were missing). 

Ticket ready for review.
----
New commits:



---

archive/issue_comments_290939.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-25T22:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290939",
    "user": "https://github.com/xcaruso"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_290940.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-07T06:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290940",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_290941.json:
```json
{
    "body": "branch does not merge.",
    "created_at": "2017-01-07T06:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290941",
    "user": "https://github.com/cheuberg"
}
```

branch does not merge.



---

archive/issue_comments_290942.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-02T16:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290942",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-02T19:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290943",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290944.json:
```json
{
    "body": "Ready for review again?",
    "created_at": "2020-04-02T23:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290944",
    "user": "https://github.com/tscrim"
}
```

Ready for review again?



---

archive/issue_comments_290945.json:
```json
{
    "body": "Not yet. There are issues with pickling, I'm working on this.\n\nSome of these problems come from issues with Frobenius endomorphisms and embeddings which are fixed in ticket #29452. So meanwhile, I encourage you to review #29452 :-)",
    "created_at": "2020-04-03T07:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290945",
    "user": "https://github.com/xcaruso"
}
```

Not yet. There are issues with pickling, I'm working on this.

Some of these problems come from issues with Frobenius endomorphisms and embeddings which are fixed in ticket #29452. So meanwhile, I encourage you to review #29452 :-)



---

archive/issue_comments_290946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-03T16:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290947.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-03T16:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290947",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290948.json:
```json
{
    "body": "There are still some issues with `_test_category` for the embedding `Z(K[X;theta]) -> K[X;theta]` and its section. But I don't know how to fix it (I poorly understand the mecanism of categories), so I skip the test :-). If you know how one has to fix this, please teach me.",
    "created_at": "2020-04-03T16:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290948",
    "user": "https://github.com/xcaruso"
}
```

There are still some issues with `_test_category` for the embedding `Z(K[X;theta]) -> K[X;theta]` and its section. But I don't know how to fix it (I poorly understand the mecanism of categories), so I skip the test :-). If you know how one has to fix this, please teach me.



---

archive/issue_comments_290949.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-04T09:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290949",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290950.json:
```json
{
    "body": "I am a strong -1 on using `UniqueFactory` in place of `UniqueRepresentation`. All of that code should be in `SkewPolynomialRing_general`, and it would be better to make it a `__classcall_private__` so you don't have to handle the `element_class` in the key and the input data is only normalized on the main entry point. Actually, I don't immediately see the need for this and why it cannot just be set in subclasses...\n\nYou can also do away with the `self._polynomial_class` attribute in place of `self.Element`.\n\nFor the coercions, it probably would be better to use\n\n```\ncenter_inject.register_as_coercion()\n```\n\nThere also is a new mechanism for doing base ring injections. See #29247 and #19225. So you should use\n\n```\ndef _coerce_map_from_base_ring(self):\n```\n",
    "created_at": "2020-04-04T12:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290950",
    "user": "https://github.com/tscrim"
}
```

I am a strong -1 on using `UniqueFactory` in place of `UniqueRepresentation`. All of that code should be in `SkewPolynomialRing_general`, and it would be better to make it a `__classcall_private__` so you don't have to handle the `element_class` in the key and the input data is only normalized on the main entry point. Actually, I don't immediately see the need for this and why it cannot just be set in subclasses...

You can also do away with the `self._polynomial_class` attribute in place of `self.Element`.

For the coercions, it probably would be better to use

```
center_inject.register_as_coercion()
```

There also is a new mechanism for doing base ring injections. See #29247 and #19225. So you should use

```
def _coerce_map_from_base_ring(self):
```




---

archive/issue_comments_290951.json:
```json
{
    "body": "I have no problem with switching back to `UniqueRepresentation` but why don't you like `UniqueFactory`? It seems that it offers more flexibility and, at least for me, it is more comprehensible than `__classcall__`",
    "created_at": "2020-04-04T19:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290951",
    "user": "https://github.com/xcaruso"
}
```

I have no problem with switching back to `UniqueRepresentation` but why don't you like `UniqueFactory`? It seems that it offers more flexibility and, at least for me, it is more comprehensible than `__classcall__`



---

archive/issue_comments_290952.json:
```json
{
    "body": "Replying to [comment:16 caruso]:\n> I have no problem with switching back to `UniqueRepresentation` but why don't you like `UniqueFactory`? It seems that it offers more flexibility and, at least for me, it is more comprehensible than `__classcall__`\n\nMany reasons. You don't need the flexibility of `UniqueFactory`. It spreads out the implementation, entry point, and functionality. For instance, the entry point is a separate class from the actual object, and the unpickling is not handled within either object. Since the implementation is separate from the entry point, you get this:\n\n```\nsage: F.<x,y> = FreeAlgebra(QQ)\nsage: isinstance(F, FreeAlgebra)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-22-ca61107e1024> in <module>()\n----> 1 isinstance(F, FreeAlgebra)\n\nTypeError: isinstance() arg 2 must be a type or tuple of types\n```\n\nThis makes code maintenance harder since there is no indication within the particular class that it should have the unique representation behavior. I find more black magic is involved with `UniqueFactory` than `UniqueRepresentation`. I don't see what is harder to comprehend either; both require someone telling you about the magic. You have to implement a `__reduce__`, which if you are not careful and feed back into the factory could make copies (which is a bug IMO, but an easy one to introduce). The behavior is not inherited by subclasses automatically.\n\nTL;DR: IMHO it makes it more complicated than it needs to be for no benefit.",
    "created_at": "2020-04-05T12:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290952",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:16 caruso]:
> I have no problem with switching back to `UniqueRepresentation` but why don't you like `UniqueFactory`? It seems that it offers more flexibility and, at least for me, it is more comprehensible than `__classcall__`

Many reasons. You don't need the flexibility of `UniqueFactory`. It spreads out the implementation, entry point, and functionality. For instance, the entry point is a separate class from the actual object, and the unpickling is not handled within either object. Since the implementation is separate from the entry point, you get this:

```
sage: F.<x,y> = FreeAlgebra(QQ)
sage: isinstance(F, FreeAlgebra)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-22-ca61107e1024> in <module>()
----> 1 isinstance(F, FreeAlgebra)

TypeError: isinstance() arg 2 must be a type or tuple of types
```

This makes code maintenance harder since there is no indication within the particular class that it should have the unique representation behavior. I find more black magic is involved with `UniqueFactory` than `UniqueRepresentation`. I don't see what is harder to comprehend either; both require someone telling you about the magic. You have to implement a `__reduce__`, which if you are not careful and feed back into the factory could make copies (which is a bug IMO, but an easy one to introduce). The behavior is not inherited by subclasses automatically.

TL;DR: IMHO it makes it more complicated than it needs to be for no benefit.



---

archive/issue_comments_290953.json:
```json
{
    "body": "Before this ticket, `SkewPolynomialRing` was a function (the constructor) and not the class. So, the behaviour you reported with `FreeAlgebra` also applies to skew polynomials. So, do you mean that we should put all the code normalizing entries in the method `__classcall__` (or `__new__`?) of `SkewPolynomialRing` and, especially, let this code return an instance of a subclass if necessary?",
    "created_at": "2020-04-06T06:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290953",
    "user": "https://github.com/xcaruso"
}
```

Before this ticket, `SkewPolynomialRing` was a function (the constructor) and not the class. So, the behaviour you reported with `FreeAlgebra` also applies to skew polynomials. So, do you mean that we should put all the code normalizing entries in the method `__classcall__` (or `__new__`?) of `SkewPolynomialRing` and, especially, let this code return an instance of a subclass if necessary?



---

archive/issue_comments_290954.json:
```json
{
    "body": "Replying to [comment:18 caruso]:\n> Before this ticket, `SkewPolynomialRing` was a function (the constructor) and not the class. So, the behaviour you reported with `FreeAlgebra` also applies to skew polynomials.\n\nI don't like the previous code with it being a separate function and would want to change that.\n\n> So, do you mean that we should put all the code normalizing entries in the method `__classcall__` (or `__new__`?) of `SkewPolynomialRing` and, especially, let this code return an instance of a subclass if necessary?\n\nYes that is correct, and make it a `__classcall_private__` so there is only one normalization (which will also let the subclasses do their own normalization independently). You don't need to modify anything with `__new__`. You can return a subclass object. This is done in a number of places in the combinatorics code.",
    "created_at": "2020-04-06T06:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290954",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:18 caruso]:
> Before this ticket, `SkewPolynomialRing` was a function (the constructor) and not the class. So, the behaviour you reported with `FreeAlgebra` also applies to skew polynomials.

I don't like the previous code with it being a separate function and would want to change that.

> So, do you mean that we should put all the code normalizing entries in the method `__classcall__` (or `__new__`?) of `SkewPolynomialRing` and, especially, let this code return an instance of a subclass if necessary?

Yes that is correct, and make it a `__classcall_private__` so there is only one normalization (which will also let the subclasses do their own normalization independently). You don't need to modify anything with `__new__`. You can return a subclass object. This is done in a number of places in the combinatorics code.



---

archive/issue_comments_290955.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-06T13:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290955",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290956.json:
```json
{
    "body": "OK. I re-read the documentation in `sage.strcture.unique_representation` and I now understand better the mecanism behind `__classcall__` and `__classcall_private__`. I'm still not entirely convinced that it's better/simpler than `UniqueFactory` (especially I'm still not that confortable with using metaclasses), but I followed your recommandations.",
    "created_at": "2020-04-06T13:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290956",
    "user": "https://github.com/xcaruso"
}
```

OK. I re-read the documentation in `sage.strcture.unique_representation` and I now understand better the mecanism behind `__classcall__` and `__classcall_private__`. I'm still not entirely convinced that it's better/simpler than `UniqueFactory` (especially I'm still not that confortable with using metaclasses), but I followed your recommandations.



---

archive/issue_comments_290957.json:
```json
{
    "body": "Also, today, I don't completely agree with the design choices I made about 8 years ago, e.g.:\n- now, I don't think that it's a good idea to have specific classes for the centre (namely `CenterSkewPolynomialRing` and `CenterSkewPolynomial_generic_dense`) because they don't inherit extra methods when the base ring has extra structures (for example, if we are working over a finite field, the center is a polynomial ring over a finite field for which more functionalities are available); on the other hand, the benefit of having a separate class is (I think) to provide tools to handle coercion properly (since currently the center remembers the skew ring); a solution could be to let the `center` method return a classical polynomial ring together with the embedding into the skew ring, I don't know\n- on a related note, I don't think that it's a good idea either to use the name `(x^r)` for the name of the central variable because it is not alphanumeric, which could be the source of many problems, e.g.:\n\n```\nsage: k.<a> = GF(5^3)\nsage: Frob = k.frobenius_endomorphism()\nsage: S.<x> = k['x',Frob]\nsage: Z = S.center()\nsage: Z.change_ring(k)\nTraceback (most recent call last):\n...\nValueError: variable name '(x^3)' is not alphanumeric\n```\n\n- I'm not sure that it's a good idea to have two spellings for the same method (`center` and `centre`): it's not really useful and it appears to be quite annoying for tab-completion\n\nWhat's your opinion on these points?",
    "created_at": "2020-04-07T08:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290957",
    "user": "https://github.com/xcaruso"
}
```

Also, today, I don't completely agree with the design choices I made about 8 years ago, e.g.:
- now, I don't think that it's a good idea to have specific classes for the centre (namely `CenterSkewPolynomialRing` and `CenterSkewPolynomial_generic_dense`) because they don't inherit extra methods when the base ring has extra structures (for example, if we are working over a finite field, the center is a polynomial ring over a finite field for which more functionalities are available); on the other hand, the benefit of having a separate class is (I think) to provide tools to handle coercion properly (since currently the center remembers the skew ring); a solution could be to let the `center` method return a classical polynomial ring together with the embedding into the skew ring, I don't know
- on a related note, I don't think that it's a good idea either to use the name `(x^r)` for the name of the central variable because it is not alphanumeric, which could be the source of many problems, e.g.:

```
sage: k.<a> = GF(5^3)
sage: Frob = k.frobenius_endomorphism()
sage: S.<x> = k['x',Frob]
sage: Z = S.center()
sage: Z.change_ring(k)
Traceback (most recent call last):
...
ValueError: variable name '(x^3)' is not alphanumeric
```

- I'm not sure that it's a good idea to have two spellings for the same method (`center` and `centre`): it's not really useful and it appears to be quite annoying for tab-completion

What's your opinion on these points?



---

archive/issue_comments_290958.json:
```json
{
    "body": "Thank you. I appreciate you going back to `UniqueRepresentation` here. Actually, below reminded me of another good thing: you don't get either duplicate or two separate documentations for the same object. Here are my answers to your questions.\n\n1 - It might be worthwhile to make a fa\u00e7ade parent for the center, which can have some extra methods attached to it by the elements are just normal polynomials. I guess it depends on how much extra features you want the center to have. If it is just about how they retract to the full skew polynomial ring, then I would just do as you suggest and return a normal polynomial ring over a finite field and implement the to/from maps in the skew poly ring.\n2 - I concur. Maybe `xpr` for the variables?\n3 - I agree. We generally use the American spellings in Sage.\n\nSome of these comments below might not apply as you refactor the code.\n\nAnother suggestion I have would be moving the doc from `SkewPolynomial_finite_order_dense.__init__` to the class level. This way you could also add a test for the `__init__` that runs the `TestSuite(foo).run()`. This also makes it easier in the compiled doc and using `?`.\n\n\n```diff\n-We check that the reduced trace is additive:\n+We check that the reduced trace is additive::\n```\n\n\n```diff\n-`K[X,\\sigma] / K[X,\\sigma]*P` (which is a `K`-vector space\n+`K[X,\\sigma] / K[X,\\sigma] P` (which is a `K`-vector space\n```\n\n(At least, I think you don't want the `*` here in the latex result, but maybe you do.)\n\nThe `EXAMPLES of VARIABLE NAME CONTEXT::` block is over-indented.\n\nThe `__classcall_private__` will need some doctests that check that it handles the uniqueness well or raises errors in cases you want it to.\n\nA good option might be\n\n```python\ncategory = Algebras(base_ring).or_subcategory(category)\n```\n\nas this handles `None` as an input in the way you'd expect and makes sure nobody passes something strange like `Manifolds()`.\n\nYou still have `self._polynomial_class` in the center class.\n\nSee comment:15 with `_coerce_map_from_base_ring`. This could simplify your `CenterSkewPolynomialRing.__init__` implementation.",
    "created_at": "2020-04-07T23:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290958",
    "user": "https://github.com/tscrim"
}
```

Thank you. I appreciate you going back to `UniqueRepresentation` here. Actually, below reminded me of another good thing: you don't get either duplicate or two separate documentations for the same object. Here are my answers to your questions.

1 - It might be worthwhile to make a façade parent for the center, which can have some extra methods attached to it by the elements are just normal polynomials. I guess it depends on how much extra features you want the center to have. If it is just about how they retract to the full skew polynomial ring, then I would just do as you suggest and return a normal polynomial ring over a finite field and implement the to/from maps in the skew poly ring.
2 - I concur. Maybe `xpr` for the variables?
3 - I agree. We generally use the American spellings in Sage.

Some of these comments below might not apply as you refactor the code.

Another suggestion I have would be moving the doc from `SkewPolynomial_finite_order_dense.__init__` to the class level. This way you could also add a test for the `__init__` that runs the `TestSuite(foo).run()`. This also makes it easier in the compiled doc and using `?`.


```diff
-We check that the reduced trace is additive:
+We check that the reduced trace is additive::
```


```diff
-`K[X,\sigma] / K[X,\sigma]*P` (which is a `K`-vector space
+`K[X,\sigma] / K[X,\sigma] P` (which is a `K`-vector space
```

(At least, I think you don't want the `*` here in the latex result, but maybe you do.)

The `EXAMPLES of VARIABLE NAME CONTEXT::` block is over-indented.

The `__classcall_private__` will need some doctests that check that it handles the uniqueness well or raises errors in cases you want it to.

A good option might be

```python
category = Algebras(base_ring).or_subcategory(category)
```

as this handles `None` as an input in the way you'd expect and makes sure nobody passes something strange like `Manifolds()`.

You still have `self._polynomial_class` in the center class.

See comment:15 with `_coerce_map_from_base_ring`. This could simplify your `CenterSkewPolynomialRing.__init__` implementation.



---

archive/issue_comments_290959.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-08T12:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290959",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290960.json:
```json
{
    "body": "OK, I addressed all your comments. I finally decided to remove the class `CenterSkewPolynomialRing` and to add the keyword argument `coerce` to the method `center` to let the user choose if he/she wants to set a coercion map or not.\n\nI don't understand why:\n\n```\nElement = sage.rings.polynomial.skew_polynomial_finite_order.SkewPolynomial_finite_order_dense\n```\n\nfails (see line 1301 of `skew_polynomial_ring.py`), giving the error\n\n```\nAttributeError: module 'sage.rings.polynomial' has no attribute 'skew_polynomial_finite_order'\n```\n\nAny idea?",
    "created_at": "2020-04-08T13:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290960",
    "user": "https://github.com/xcaruso"
}
```

OK, I addressed all your comments. I finally decided to remove the class `CenterSkewPolynomialRing` and to add the keyword argument `coerce` to the method `center` to let the user choose if he/she wants to set a coercion map or not.

I don't understand why:

```
Element = sage.rings.polynomial.skew_polynomial_finite_order.SkewPolynomial_finite_order_dense
```

fails (see line 1301 of `skew_polynomial_ring.py`), giving the error

```
AttributeError: module 'sage.rings.polynomial' has no attribute 'skew_polynomial_finite_order'
```

Any idea?



---

archive/issue_comments_290961.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-08T13:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290961",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290962.json:
```json
{
    "body": "I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of\n\n```python\nfrom sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense\n```\n\nand then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.\n\nBeyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?",
    "created_at": "2020-04-08T23:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290962",
    "user": "https://github.com/tscrim"
}
```

I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of

```python
from sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense
```

and then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.

Beyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?



---

archive/issue_comments_290963.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-09T07:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290963",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290964.json:
```json
{
    "body": "Replying to [comment:27 tscrim]:\n> I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of\n> {{{#!python\n> from sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense\n> }}}\n> and then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.\n\nThere was actually circular dependencies passing through `sage.matrix.matrix_dense.Matrix_dense` but I removed this import and rewrote the methods `_matphir_c` and `_matmul_c` accordingly.\n\n> Beyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?\n\nI've hesitated but I think it's safer like this. The reason is that if the user has already created (in the same session) a polynomial ring over the fixed field with the same variable name, then his ring will be automatically endowed with my coercion map, which could be not desired.",
    "created_at": "2020-04-09T08:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290964",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:27 tscrim]:
> I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of
> {{{#!python
> from sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense
> }}}
> and then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.

There was actually circular dependencies passing through `sage.matrix.matrix_dense.Matrix_dense` but I removed this import and rewrote the methods `_matphir_c` and `_matmul_c` accordingly.

> Beyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?

I've hesitated but I think it's safer like this. The reason is that if the user has already created (in the same session) a polynomial ring over the fixed field with the same variable name, then his ring will be automatically endowed with my coercion map, which could be not desired.



---

archive/issue_comments_290965.json:
```json
{
    "body": "Another question: the patchbot reports:\n\n```\nstartup_modules Failed\n```\n\nI don't know what it means exactly (is it annoying?) but I was wondering if using `__classcall__` (instead of a constructor or a factory) couldn't slow down the startup since it a priori makes more imports.",
    "created_at": "2020-04-09T08:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290965",
    "user": "https://github.com/xcaruso"
}
```

Another question: the patchbot reports:

```
startup_modules Failed
```

I don't know what it means exactly (is it annoying?) but I was wondering if using `__classcall__` (instead of a constructor or a factory) couldn't slow down the startup since it a priori makes more imports.



---

archive/issue_comments_290966.json:
```json
{
    "body": "Replying to [comment:30 caruso]:\n> Replying to [comment:27 tscrim]:\n> > I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of\n> > {{{#!python\n> > from sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense\n> > }}}\n> > and then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.\n> \n> There was actually circular dependencies passing through `sage.matrix.matrix_dense.Matrix_dense` but I removed this import and rewrote the methods `_matphir_c` and `_matmul_c` accordingly.\n\nCan you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.\n\n> > Beyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?\n> \n> I've hesitated but I think it's safer like this. The reason is that if the user has already created (in the same session) a polynomial ring over the fixed field with the same variable name, then his ring will be automatically endowed with my coercion map, which could be not desired.\n\nI don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring. That sounds like a logic bug. Being able to turn off the coercion is good to find this and fix it, but I don't see how this would be applied incorrectly and not be a true bug. Plus I would naively expect this coercion map to be there as it is suppose to represent a subobject.\n\nYou can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.",
    "created_at": "2020-04-09T08:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290966",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:30 caruso]:
> Replying to [comment:27 tscrim]:
> > I think that is a little sketchy because it depends on the order the modules are imported. I would make an explicit top-level import of
> > {{{#!python
> > from sage.rings.polynomial.skew_polynomial_finite_order import SkewPolynomial_finite_order_dense
> > }}}
> > and then do `Element = SkewPolynomial_finite_order_dense`. There shouldn't be a circular dependency as the element classes (usually) do not need to know generically about the precise parent class, and the methods that do can just import it locally.
> 
> There was actually circular dependencies passing through `sage.matrix.matrix_dense.Matrix_dense` but I removed this import and rewrote the methods `_matphir_c` and `_matmul_c` accordingly.

Can you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.

> > Beyond that, it looks good. Thank you. I do have one last question: Why is the default for the center to not have it as a coercion map?
> 
> I've hesitated but I think it's safer like this. The reason is that if the user has already created (in the same session) a polynomial ring over the fixed field with the same variable name, then his ring will be automatically endowed with my coercion map, which could be not desired.

I don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring. That sounds like a logic bug. Being able to turn off the coercion is good to find this and fix it, but I don't see how this would be applied incorrectly and not be a true bug. Plus I would naively expect this coercion map to be there as it is suppose to represent a subobject.

You can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.



---

archive/issue_comments_290967.json:
```json
{
    "body": "Replying to [comment:32 tscrim]:\n> Can you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.\n\nWell, simply adding\n\n```\nfrom sage.matrix.matrix_dense cimport Matrix_dense\n```\n\nat the top of `skew_polynomial_finite_order.pyx`, I get this error when I start sage:\n\n```\nhome/xcaruso/sage/local/lib/python3.7/site-packages/sage/rings/polynomial/skew_polynomial_ring.py in SkewPolynomialRing_finite_order()\n   1292         :mod:`sage.rings.polynomial.skew_polynomial_finite_order`\n   1293     \"\"\"\n-> 1294     import sage.rings.polynomial.skew_polynomial_finite_order\n        global sage.rings.polynomial.skew_polynomial_finite_order = undefined\n   1295     Element = sage.rings.polynomial.skew_polynomial_finite_order.SkewPolynomial_finite_order_dense\n   1296 \n\n/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/matrix0.pxd in init sage.rings.polynomial.skew_polynomial_finite_order (build/cythonized/sage/rings/polynomial/skew_polynomial_finite_order.c:9134)()\n     16 cimport sage.structure.mutability\n     17 \n---> 18 cdef class Matrix(sage.structure.element.Matrix):\n        global cdef = undefined\n        global Matrix = undefined\n        global sage.structure.element.Matrix = undefined\n     19     # Properties of any matrix  (plus _parent, inherited from base class)\n     20     cdef public object _subdivisions\n\n/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/__init__.py in <module>()\n      1 # Resolve a cyclic import\n----> 2 import sage.matrix.args\n        global sage.matrix.args = undefined\n\n/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/args.pyx in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21255)()\n     22 \n     23 from .matrix_space import MatrixSpace\n---> 24 from sage.rings.all import ZZ, RDF, CDF\n        global sage.rings.all = undefined\n        global ZZ = Integer Ring\n        global RDF = Real Double Field\n        global CDF = undefined\n     25 from sage.structure.coerce cimport (coercion_model,\n     26         is_numpy_type, py_scalar_parent)\nImportError: cannot import name CDF\n\n```\n\n\n> I don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring.\n\nWell, it's a common operator to create a polynomial ring over a finite field (at least for me). So I easily imagine I create a polynomial ring over `GF(5)` for some reason and, later on in the same session (for some related reason), create a skew polynomial ring over `GF(5^3)` and compute its center. In that case, I won't probably want the two constructions to implicitely interfere.\n(But I confess that coercion into the skew ring won't probably cause many troubles.)\n\n> You can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.\n\nIt's fixed (hopefully).",
    "created_at": "2020-04-09T09:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290967",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:32 tscrim]:
> Can you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.

Well, simply adding

```
from sage.matrix.matrix_dense cimport Matrix_dense
```

at the top of `skew_polynomial_finite_order.pyx`, I get this error when I start sage:

```
home/xcaruso/sage/local/lib/python3.7/site-packages/sage/rings/polynomial/skew_polynomial_ring.py in SkewPolynomialRing_finite_order()
   1292         :mod:`sage.rings.polynomial.skew_polynomial_finite_order`
   1293     """
-> 1294     import sage.rings.polynomial.skew_polynomial_finite_order
        global sage.rings.polynomial.skew_polynomial_finite_order = undefined
   1295     Element = sage.rings.polynomial.skew_polynomial_finite_order.SkewPolynomial_finite_order_dense
   1296 

/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/matrix0.pxd in init sage.rings.polynomial.skew_polynomial_finite_order (build/cythonized/sage/rings/polynomial/skew_polynomial_finite_order.c:9134)()
     16 cimport sage.structure.mutability
     17 
---> 18 cdef class Matrix(sage.structure.element.Matrix):
        global cdef = undefined
        global Matrix = undefined
        global sage.structure.element.Matrix = undefined
     19     # Properties of any matrix  (plus _parent, inherited from base class)
     20     cdef public object _subdivisions

/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/__init__.py in <module>()
      1 # Resolve a cyclic import
----> 2 import sage.matrix.args
        global sage.matrix.args = undefined

/home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/args.pyx in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21255)()
     22 
     23 from .matrix_space import MatrixSpace
---> 24 from sage.rings.all import ZZ, RDF, CDF
        global sage.rings.all = undefined
        global ZZ = Integer Ring
        global RDF = Real Double Field
        global CDF = undefined
     25 from sage.structure.coerce cimport (coercion_model,
     26         is_numpy_type, py_scalar_parent)
ImportError: cannot import name CDF

```


> I don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring.

Well, it's a common operator to create a polynomial ring over a finite field (at least for me). So I easily imagine I create a polynomial ring over `GF(5)` for some reason and, later on in the same session (for some related reason), create a skew polynomial ring over `GF(5^3)` and compute its center. In that case, I won't probably want the two constructions to implicitely interfere.
(But I confess that coercion into the skew ring won't probably cause many troubles.)

> You can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.

It's fixed (hopefully).



---

archive/issue_comments_290968.json:
```json
{
    "body": "Replying to [comment:33 caruso]:\n> Replying to [comment:32 tscrim]:\n> > Can you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.\n> {{{\n> [snip]\n> /home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/args.pyx in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21255)()\n>      22 \n>      23 from .matrix_space import MatrixSpace\n> ---> 24 from sage.rings.all import ZZ, RDF, CDF\n>         global sage.rings.all = undefined\n>         global ZZ = Integer Ring\n>         global RDF = Real Double Field\n>         global CDF = undefined\n>      25 from sage.structure.coerce cimport (coercion_model,\n>      26         is_numpy_type, py_scalar_parent)\n> ImportError: cannot import name CDF\n> }}}\n\nSo the issue comes from the call to `sage.rings.all` rather than the individual files that define these fields. The `sage.rings.all` calls `sage.rings.polynomials.all`, which then tries to import the skew polynomial ring, and hence the cycle. So to me there are two \"good\" ways to break this:\n\n1. Make the skew polynomial rings a lazy import.\n2. Change the `sage.matrix.args` to import from the specific files that define `ZZ, RDF, CDF`:\n   {{{#!python\nfrom sage.rings.integer_ring import ZZ\nfrom sage.rings.real_double import RDF\nfrom sage.rings.complex_double import CDF\n   }}}\n\n> > I don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring.\n> \n> Well, it's a common operator to create a polynomial ring over a finite field (at least for me). So I easily imagine I create a polynomial ring over `GF(5)` for some reason and, later on in the same session (for some related reason), create a skew polynomial ring over `GF(5^3)` and compute its center. In that case, I won't probably want the two constructions to implicitely interfere.\n> (But I confess that coercion into the skew ring won't probably cause many troubles.)\n\nThat is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there. Could this be a problem though: **F**<sub>5</sub>[x][y,\\sigma] and then the center is **F**<sub>5</sub>[x]?\n\n> > You can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.\n> \n> It's fixed (hopefully).\n\nSeems like you got it.",
    "created_at": "2020-04-09T23:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290968",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:33 caruso]:
> Replying to [comment:32 tscrim]:
> > Can you explain a bit more about the circular import you got? It seems like there shouldn't be one and I would think removing the `matrix_dense` import is not the best strategy.
> {{{
> [snip]
> /home/xcaruso/sage/local/lib/python3.7/site-packages/sage/matrix/args.pyx in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21255)()
>      22 
>      23 from .matrix_space import MatrixSpace
> ---> 24 from sage.rings.all import ZZ, RDF, CDF
>         global sage.rings.all = undefined
>         global ZZ = Integer Ring
>         global RDF = Real Double Field
>         global CDF = undefined
>      25 from sage.structure.coerce cimport (coercion_model,
>      26         is_numpy_type, py_scalar_parent)
> ImportError: cannot import name CDF
> }}}

So the issue comes from the call to `sage.rings.all` rather than the individual files that define these fields. The `sage.rings.all` calls `sage.rings.polynomials.all`, which then tries to import the skew polynomial ring, and hence the cycle. So to me there are two "good" ways to break this:

1. Make the skew polynomial rings a lazy import.
2. Change the `sage.matrix.args` to import from the specific files that define `ZZ, RDF, CDF`:
   {{{#!python
from sage.rings.integer_ring import ZZ
from sage.rings.real_double import RDF
from sage.rings.complex_double import CDF
   }}}

> > I don't see why they would reasonably have a separate polynomial ring that would not behave like the center, call the center, but then do something coerce into the skew polynomial ring.
> 
> Well, it's a common operator to create a polynomial ring over a finite field (at least for me). So I easily imagine I create a polynomial ring over `GF(5)` for some reason and, later on in the same session (for some related reason), create a skew polynomial ring over `GF(5^3)` and compute its center. In that case, I won't probably want the two constructions to implicitely interfere.
> (But I confess that coercion into the skew ring won't probably cause many troubles.)

That is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there. Could this be a problem though: **F**<sub>5</sub>[x][y,\sigma] and then the center is **F**<sub>5</sub>[x]?

> > You can ignore the startup modules as that is not always the most reliable patchbot module. (It passed on one of the patchbot reports.) The bigger issue is the docbuild failure.
> 
> It's fixed (hopefully).

Seems like you got it.



---

archive/issue_comments_290969.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-10T15:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290969",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290970.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-10T15:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290971.json:
```json
{
    "body": "Replying to [comment:34 tscrim]:\n\n> So the issue comes from the call to `sage.rings.all` rather than the individual files that define these fields. The `sage.rings.all` calls `sage.rings.polynomials.all`, which then tries to import the skew polynomial ring, and hence the cycle. So to me there are two \"good\" ways to break this:\n> \n> 1. Make the skew polynomial rings a lazy import.\n> 2. Change the `sage.matrix.args` to import from the specific files that define `ZZ, RDF, CDF`:\n>    {{{#!python\n> from sage.rings.integer_ring import ZZ\n> from sage.rings.real_double import RDF\n> from sage.rings.complex_double import CDF\n>    }}}\n\nIf you agree, I prefer delaying this for another ticket as it touches other parts of sage.\n\n> > (But I confess that coercion into the skew ring won't probably cause many troubles.)\n> \n> That is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there.\n\nYes, probably; I let `coerce=True` to be the default.\n\n> Could this be a problem though: **F**<sub>5</sub>[x][y,\\sigma] and then the center is **F**<sub>5</sub>[x]?\n\nI think not. Because **F**<sub>5</sub>[x] coerces to **F**<sub>5</sub>[x][y,\\sigma] and therefore creation another coercion or conversion map from **F**<sub>5</sub>[x] to **F**<sub>5</sub>[x][y,\\sigma] will raise an error in both cases.",
    "created_at": "2020-04-10T15:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290971",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:34 tscrim]:

> So the issue comes from the call to `sage.rings.all` rather than the individual files that define these fields. The `sage.rings.all` calls `sage.rings.polynomials.all`, which then tries to import the skew polynomial ring, and hence the cycle. So to me there are two "good" ways to break this:
> 
> 1. Make the skew polynomial rings a lazy import.
> 2. Change the `sage.matrix.args` to import from the specific files that define `ZZ, RDF, CDF`:
>    {{{#!python
> from sage.rings.integer_ring import ZZ
> from sage.rings.real_double import RDF
> from sage.rings.complex_double import CDF
>    }}}

If you agree, I prefer delaying this for another ticket as it touches other parts of sage.

> > (But I confess that coercion into the skew ring won't probably cause many troubles.)
> 
> That is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there.

Yes, probably; I let `coerce=True` to be the default.

> Could this be a problem though: **F**<sub>5</sub>[x][y,\sigma] and then the center is **F**<sub>5</sub>[x]?

I think not. Because **F**<sub>5</sub>[x] coerces to **F**<sub>5</sub>[x][y,\sigma] and therefore creation another coercion or conversion map from **F**<sub>5</sub>[x] to **F**<sub>5</sub>[x][y,\sigma] will raise an error in both cases.



---

archive/issue_comments_290972.json:
```json
{
    "body": "Replying to [comment:37 caruso]:\n> Replying to [comment:34 tscrim]:\n> If you agree, I prefer delaying this for another ticket as it touches other parts of sage.\n\nI would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.\n\n> > > (But I confess that coercion into the skew ring won't probably cause many troubles.)\n> > \n> > That is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there.\n> \n> Yes, probably; I let `coerce=True` to be the default.\n\nThank you.\n\n> > Could this be a problem though: **F**<sub>5</sub>[x][y,\\sigma] and then the center is **F**<sub>5</sub>[x]?\n> \n> I think not. Because **F**<sub>5</sub>[x] coerces to **F**<sub>5</sub>[x][y,\\sigma] and therefore creation another coercion or conversion map from **F**<sub>5</sub>[x] to **F**<sub>5</sub>[x][y,\\sigma] will raise an error in both cases.\n\nAh, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring. Here is another potential situation (although more contrived):\n\n**F**<sub>5</sub>[x] => **F**<sub>5</sub>[y,\\sigma] -> **F**<sub>5</sub>[y,\\sigma][z,\\tau] <= **F**<sub>5</sub>[x]\n\nwhere -> denotes base ring injection and => is the center coercion. Perhaps this is impossible because I have forgotten a requirement of the base ring, but I don't think this is a likely enough thing to happen to warrant changing the default.",
    "created_at": "2020-04-11T02:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290972",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:37 caruso]:
> Replying to [comment:34 tscrim]:
> If you agree, I prefer delaying this for another ticket as it touches other parts of sage.

I would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.

> > > (But I confess that coercion into the skew ring won't probably cause many troubles.)
> > 
> > That is the point. This will not cause any problems in the computations that you would do. This wouldn't create some strange different coercion path or override an action that otherwise would be there.
> 
> Yes, probably; I let `coerce=True` to be the default.

Thank you.

> > Could this be a problem though: **F**<sub>5</sub>[x][y,\sigma] and then the center is **F**<sub>5</sub>[x]?
> 
> I think not. Because **F**<sub>5</sub>[x] coerces to **F**<sub>5</sub>[x][y,\sigma] and therefore creation another coercion or conversion map from **F**<sub>5</sub>[x] to **F**<sub>5</sub>[x][y,\sigma] will raise an error in both cases.

Ah, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring. Here is another potential situation (although more contrived):

**F**<sub>5</sub>[x] => **F**<sub>5</sub>[y,\sigma] -> **F**<sub>5</sub>[y,\sigma][z,\tau] <= **F**<sub>5</sub>[x]

where -> denotes base ring injection and => is the center coercion. Perhaps this is impossible because I have forgotten a requirement of the base ring, but I don't think this is a likely enough thing to happen to warrant changing the default.



---

archive/issue_comments_290973.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-11T15:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290973",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290974.json:
```json
{
    "body": "Replying to [comment:38 tscrim]:\n> > If you agree, I prefer delaying this for another ticket as it touches other parts of sage.\n> \n> I would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.\n\nActually, I'm happier with my new implementation of `_matphir_c` and `_matmul_c` which doesn't use `MatrixSpace`, and so the faulty import is no longer required.\n\n> Ah, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring.\n\nI changed the error message if the creation of the coercion/conversion map fails (although I think that this case won't happen shortly because the method `center` is only available when the twisting map implements the methods `order` and `fixed_points`, which is only the case for Frobenius endomorphisms so far).",
    "created_at": "2020-04-11T15:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290974",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:38 tscrim]:
> > If you agree, I prefer delaying this for another ticket as it touches other parts of sage.
> 
> I would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.

Actually, I'm happier with my new implementation of `_matphir_c` and `_matmul_c` which doesn't use `MatrixSpace`, and so the faulty import is no longer required.

> Ah, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring.

I changed the error message if the creation of the coercion/conversion map fails (although I think that this case won't happen shortly because the method `center` is only available when the twisting map implements the methods `order` and `fixed_points`, which is only the case for Frobenius endomorphisms so far).



---

archive/issue_comments_290975.json:
```json
{
    "body": "Replying to [comment:40 caruso]:\n> Replying to [comment:38 tscrim]:\n> > > If you agree, I prefer delaying this for another ticket as it touches other parts of sage.\n> > \n> > I would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.\n> \n> Actually, I'm happier with my new implementation of `_matphir_c` and `_matmul_c` which doesn't use `MatrixSpace`, and so the faulty import is no longer required.\n\nOkay...but I don't really understand why. However, this is your code, so if this is what you want, then so be it.\n\n> > Ah, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring.\n> \n> I changed the error message if the creation of the coercion/conversion map fails (although I think that this case won't happen shortly because the method `center` is only available when the twisting map implements the methods `order` and `fixed_points`, which is only the case for Frobenius endomorphisms so far).\n\nThank you. Sorry, just a few more tests I would like to see added. This should be it. Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center, as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?",
    "created_at": "2020-04-12T04:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290975",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:40 caruso]:
> Replying to [comment:38 tscrim]:
> > > If you agree, I prefer delaying this for another ticket as it touches other parts of sage.
> > 
> > I would rather do it either on this ticket or as a dependency. I can do this as a dependency if you agree.
> 
> Actually, I'm happier with my new implementation of `_matphir_c` and `_matmul_c` which doesn't use `MatrixSpace`, and so the faulty import is no longer required.

Okay...but I don't really understand why. However, this is your code, so if this is what you want, then so be it.

> > Ah, right, very good point. However, that would be a strange error message for the uninformed, so there probably should be a `.. WARNING::` about this and to tell the user that they should choose a different variable name than one in the base ring.
> 
> I changed the error message if the creation of the coercion/conversion map fails (although I think that this case won't happen shortly because the method `center` is only available when the twisting map implements the methods `order` and `fixed_points`, which is only the case for Frobenius endomorphisms so far).

Thank you. Sorry, just a few more tests I would like to see added. This should be it. Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center, as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?



---

archive/issue_comments_290976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-12T07:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290977.json:
```json
{
    "body": "Replying to [comment:41 tscrim]:\n\n> Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center\n\nActually it doesn't because it's not allowed (for safety, as explained in the documention of the method `sage.structure.parent.Parent.register_coercion`) by the general coercion mecanism.\nSo, I added a doctest showing that this raises an error.\n\n> as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?\n\nDone.",
    "created_at": "2020-04-12T07:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290977",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:41 tscrim]:

> Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center

Actually it doesn't because it's not allowed (for safety, as explained in the documention of the method `sage.structure.parent.Parent.register_coercion`) by the general coercion mecanism.
So, I added a doctest showing that this raises an error.

> as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?

Done.



---

archive/issue_comments_290978.json:
```json
{
    "body": "Replying to [comment:43 caruso]:\n> Replying to [comment:41 tscrim]:\n> \n> > Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center\n> \n> Actually it doesn't because it's not allowed (for safety, as explained in the documention of the method `sage.structure.parent.Parent.register_coercion`) by the general coercion mecanism.\n> So, I added a doctest showing that this raises an error.\n\nI am not too surprised it does that, but I would have thought Sage would allow the promotion of a conversion map to a coercion. Well, at least it is documented so users are aware of it.\n\n> > as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?\n> \n> Done.\n\nThank you.",
    "created_at": "2020-04-12T07:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290978",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:43 caruso]:
> Replying to [comment:41 tscrim]:
> 
> > Can you also add a test first showing that the conversion to the center **F**<sub>q</sub>[x] followed by a coercion works to the same center
> 
> Actually it doesn't because it's not allowed (for safety, as explained in the documention of the method `sage.structure.parent.Parent.register_coercion`) by the general coercion mecanism.
> So, I added a doctest showing that this raises an error.

I am not too surprised it does that, but I would have thought Sage would allow the promotion of a conversion map to a coercion. Well, at least it is documented so users are aware of it.

> > as well as a similar test in the other way? Also, can you also add one to the same polynomial ring from a different skew polynomial ring (with, say, a different variable)?
> 
> Done.

Thank you.



---

archive/issue_comments_290979.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-12T07:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290979",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290980.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-04-12T08:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290980",
    "user": "https://github.com/xcaruso"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290981.json:
```json
{
    "body": "Replying to [comment:44 tscrim]:\n> I am not too surprised it does that, but I would have thought Sage would allow the promotion of a conversion map to a coercion.\n\nI agree that it could be nice to have this in sage; a possibility could be to implement a new method `promote_to_coercion(self, ring)` in the `Parent` class.\nIf you agree, I propose to open another ticket to discuss this.\n\nAlso, thinking again at all of this, I am worried by the following: if the default variable name `z` leads to an error for some reason, then the methods `reduced_trace` and `reduced_norm` won't work. At least, I think we should add a keyword argument `var` in those methods to let the user specify the variable name he wants. Going further, I also think that it would be nice to allow for customizing the default central variable name. Maybe, we can have a method for this and/or update it each time a new center (i.e. with a new variable name) is created.",
    "created_at": "2020-04-12T08:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290981",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:44 tscrim]:
> I am not too surprised it does that, but I would have thought Sage would allow the promotion of a conversion map to a coercion.

I agree that it could be nice to have this in sage; a possibility could be to implement a new method `promote_to_coercion(self, ring)` in the `Parent` class.
If you agree, I propose to open another ticket to discuss this.

Also, thinking again at all of this, I am worried by the following: if the default variable name `z` leads to an error for some reason, then the methods `reduced_trace` and `reduced_norm` won't work. At least, I think we should add a keyword argument `var` in those methods to let the user specify the variable name he wants. Going further, I also think that it would be nice to allow for customizing the default central variable name. Maybe, we can have a method for this and/or update it each time a new center (i.e. with a new variable name) is created.



---

archive/issue_comments_290982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-13T17:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290982",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290983.json:
```json
{
    "body": "Replying to [comment:45 caruso]:\n> Also, thinking again at all of this, I am worried by the following: if the default variable name `z` leads to an error for some reason, then the methods `reduced_trace` and `reduced_norm` won't work. At least, I think we should add a keyword argument `var` in those methods to let the user specify the variable name he wants. Going further, I also think that it would be nice to allow for customizing the default central variable name. Maybe, we can have a method for this and/or update it each time a new center (i.e. with a new variable name) is created.\n\nI just pushed an implementation of this.\nAnd I also deciced to abandon the option `coerce=False` because it causes too much troubles (especially in the methods `reduced_norm` and `reduced_trace` which are both calling `center`, it was not clear which value should be passed in).",
    "created_at": "2020-04-13T17:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290983",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:45 caruso]:
> Also, thinking again at all of this, I am worried by the following: if the default variable name `z` leads to an error for some reason, then the methods `reduced_trace` and `reduced_norm` won't work. At least, I think we should add a keyword argument `var` in those methods to let the user specify the variable name he wants. Going further, I also think that it would be nice to allow for customizing the default central variable name. Maybe, we can have a method for this and/or update it each time a new center (i.e. with a new variable name) is created.

I just pushed an implementation of this.
And I also deciced to abandon the option `coerce=False` because it causes too much troubles (especially in the methods `reduced_norm` and `reduced_trace` which are both calling `center`, it was not clear which value should be passed in).



---

archive/issue_comments_290984.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-13T17:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290984",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290985.json:
```json
{
    "body": "I agree that it is causing too many problems.\n\nYou can get rid of the gender issue by\n\n```diff\n-However, the user can speciy a different variable name if he/she wish::\n+However, the user can specify a different variable name if desired::\n```\n\n(Note also the typo.)\n\nI think you should explain a little bit more about `default` in the `INPUT:` block, perhaps saying something like `if ``True`` then set the default variable name for the cener to be ``name```",
    "created_at": "2020-04-13T23:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290985",
    "user": "https://github.com/tscrim"
}
```

I agree that it is causing too many problems.

You can get rid of the gender issue by

```diff
-However, the user can speciy a different variable name if he/she wish::
+However, the user can specify a different variable name if desired::
```

(Note also the typo.)

I think you should explain a little bit more about `default` in the `INPUT:` block, perhaps saying something like `if ``True`` then set the default variable name for the cener to be ``name```



---

archive/issue_comments_290986.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-14T08:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290986",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290987.json:
```json
{
    "body": "Done.",
    "created_at": "2020-04-14T08:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290987",
    "user": "https://github.com/xcaruso"
}
```

Done.



---

archive/issue_comments_290988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-14T11:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290989.json:
```json
{
    "body": "Hmm, there was still a problem:\n\n\n```\nsage: k.<a> = GF(7^4)\nsage: phi = k.frobenius_endomorphism()\nsage: S.<x> = k['x', phi]\nsage: (x^4).is_central()\nTrue\nsage: Z.<u> = S.center(); Z\nUnivariate Polynomial Ring in u over Finite Field of size 7\nsage: S.center()\nUnivariate Polynomial Ring in z over Finite Field of size 7\n```\n\n\nOn the last line, the variable name is `z` but it should be `u`. The reason is that the call to `is_central` creates a center and then sets the default variable name.\n\nMy last commit fixes this.",
    "created_at": "2020-04-14T11:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290989",
    "user": "https://github.com/xcaruso"
}
```

Hmm, there was still a problem:


```
sage: k.<a> = GF(7^4)
sage: phi = k.frobenius_endomorphism()
sage: S.<x> = k['x', phi]
sage: (x^4).is_central()
True
sage: Z.<u> = S.center(); Z
Univariate Polynomial Ring in u over Finite Field of size 7
sage: S.center()
Univariate Polynomial Ring in z over Finite Field of size 7
```


On the last line, the variable name is `z` but it should be `u`. The reason is that the call to `is_central` creates a center and then sets the default variable name.

My last commit fixes this.



---

archive/issue_comments_290990.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-14T12:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290990",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290991.json:
```json
{
    "body": "This is dangerous:\n\n```\nsage: a.reduced_norm(var=False)\n[4, 0, 4, 1]\n```\n\nYou could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).\n\nPerhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?",
    "created_at": "2020-04-14T12:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290991",
    "user": "https://github.com/tscrim"
}
```

This is dangerous:

```
sage: a.reduced_norm(var=False)
[4, 0, 4, 1]
```

You could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).

Perhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?



---

archive/issue_comments_290992.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-14T14:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290993.json:
```json
{
    "body": "Replying to [comment:54 tscrim]:\n> This is dangerous:\n> {{{\n> sage: a.reduced_norm(var=False)\n> [4, 0, 4, 1]\n> }}}\n> You could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).\n\nGood point. I made `_norm` a tuple as you suggested. (But then I return a tuple instead of a list, I don't know whether it's good or bad.)\n\n> Perhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?\n\nI can certainly do it. But what's the benefit?",
    "created_at": "2020-04-14T14:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290993",
    "user": "https://github.com/xcaruso"
}
```

Replying to [comment:54 tscrim]:
> This is dangerous:
> {{{
> sage: a.reduced_norm(var=False)
> [4, 0, 4, 1]
> }}}
> You could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).

Good point. I made `_norm` a tuple as you suggested. (But then I return a tuple instead of a list, I don't know whether it's good or bad.)

> Perhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?

I can certainly do it. But what's the benefit?



---

archive/issue_comments_290994.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-14T22:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290994",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290995.json:
```json
{
    "body": "Replying to [comment:56 caruso]:\n> Replying to [comment:54 tscrim]:\n> > This is dangerous:\n> > {{{\n> > sage: a.reduced_norm(var=False)\n> > [4, 0, 4, 1]\n> > }}}\n> > You could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).\n> \n> Good point. I made `_norm` a tuple as you suggested. (But then I return a tuple instead of a list, I don't know whether it's good or bad.)\n\nI don't think it makes a difference other than 1 line for other users if they want to modify it.\n\n> > Perhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?\n> \n> I can certainly do it. But what's the benefit?\n\nIt won't have random failures. For example, it could choose a variable that is already used one time then work the next. With a specific variable like this, there is almost surely no chance of it being selected. Granted, 10 random letters is highly unlikely to produce something used. The other argument would be consistency across sessions.\n\nAlso, don't you want to actually create the `_working_center` in this case? Actually, why not just use this fixed (dummy) variable as `_working_center` instead of the current try-except? One extra parent for each instance isn't going to make much difference in terms of memory.",
    "created_at": "2020-04-14T23:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290995",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:56 caruso]:
> Replying to [comment:54 tscrim]:
> > This is dangerous:
> > {{{
> > sage: a.reduced_norm(var=False)
> > [4, 0, 4, 1]
> > }}}
> > You could modify a cached value. Either return a copy or make the `_norm` a tuple (I would do the latter).
> 
> Good point. I made `_norm` a tuple as you suggested. (But then I return a tuple instead of a list, I don't know whether it's good or bad.)

I don't think it makes a difference other than 1 line for other users if they want to modify it.

> > Perhaps instead of a random variable name, you choose something specific that is likely not to be used (except by the most heinous of users), like `DUMMY_SKEW_CENTER_VAR`?
> 
> I can certainly do it. But what's the benefit?

It won't have random failures. For example, it could choose a variable that is already used one time then work the next. With a specific variable like this, there is almost surely no chance of it being selected. Granted, 10 random letters is highly unlikely to produce something used. The other argument would be consistency across sessions.

Also, don't you want to actually create the `_working_center` in this case? Actually, why not just use this fixed (dummy) variable as `_working_center` instead of the current try-except? One extra parent for each instance isn't going to make much difference in terms of memory.



---

archive/issue_comments_290996.json:
```json
{
    "body": "Actually, I see a problem with always using the same variable name for the \"working\" center.\nAssume that, for some reason, somebody needs to implement a method like this in the class `SkewPolynomialRing` (or one of its derivative):\n\n\n```\n    def my_method(self):\n        center = self._working_center\n        z = center.gen()  # z = DUMMY_SKEW_VAR_CENTER\n        ring = center.quo(z^2 + 1)\n        twist = ring.hom([-z])\n        skew.<T> = SkewPolynomialRing(ring, twist)\n        ...\n```\n\n\nand assume that the user runs the following session:\n\n\n```\nsage: k.<a> = GF(5^3)\nsage: Frob = k.frobenius_endomorphism()\nsage: S.<x> = k['x', Frob]\nsage: S.my_method()\n```\n\n\nThen, when `S` is defined, Sage creates the ring `GF(5)[DUMMY_SKEW_CENTER_VAR]` together with a coercion map into `S`. Now when we call `my_method`, the fixed point of `twist` is again `GF(5)` and so the call to `SkewPolynomialRing` recreates the ring `GF(5)[DUMMY_SKEW_CENTER_VAR]` and now set a coercion map into `skew`, taking `DUMMY_SKEW_CENTER_VAR` to `T^2`. But we also have coercion maps `GF(5)[DUMMY_SKEW_CENTER_VAR] -> ring -> skew` where the composite maps `DUMMY_SKEW_CENTER_VAR` to `z`...\n\nI confess that, currently, this bug can't happen because `twist` does not have a method `order` but it clearly shows that using always the same variable name for the center may cause subtle troubles.\n\nBelow, I propose a new implementation avoiding random choices of variable names (and thus being more canonical and reproducible in some sense).",
    "created_at": "2020-04-15T12:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290996",
    "user": "https://github.com/xcaruso"
}
```

Actually, I see a problem with always using the same variable name for the "working" center.
Assume that, for some reason, somebody needs to implement a method like this in the class `SkewPolynomialRing` (or one of its derivative):


```
    def my_method(self):
        center = self._working_center
        z = center.gen()  # z = DUMMY_SKEW_VAR_CENTER
        ring = center.quo(z^2 + 1)
        twist = ring.hom([-z])
        skew.<T> = SkewPolynomialRing(ring, twist)
        ...
```


and assume that the user runs the following session:


```
sage: k.<a> = GF(5^3)
sage: Frob = k.frobenius_endomorphism()
sage: S.<x> = k['x', Frob]
sage: S.my_method()
```


Then, when `S` is defined, Sage creates the ring `GF(5)[DUMMY_SKEW_CENTER_VAR]` together with a coercion map into `S`. Now when we call `my_method`, the fixed point of `twist` is again `GF(5)` and so the call to `SkewPolynomialRing` recreates the ring `GF(5)[DUMMY_SKEW_CENTER_VAR]` and now set a coercion map into `skew`, taking `DUMMY_SKEW_CENTER_VAR` to `T^2`. But we also have coercion maps `GF(5)[DUMMY_SKEW_CENTER_VAR] -> ring -> skew` where the composite maps `DUMMY_SKEW_CENTER_VAR` to `z`...

I confess that, currently, this bug can't happen because `twist` does not have a method `order` but it clearly shows that using always the same variable name for the center may cause subtle troubles.

Below, I propose a new implementation avoiding random choices of variable names (and thus being more canonical and reproducible in some sense).



---

archive/issue_comments_290997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-15T12:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290997",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290998.json:
```json
{
    "body": "Okay, that is a reasonable enough thing to happen, and I am okay with this solution. Thank you.",
    "created_at": "2020-04-15T22:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290998",
    "user": "https://github.com/tscrim"
}
```

Okay, that is a reasonable enough thing to happen, and I am okay with this solution. Thank you.



---

archive/issue_comments_290999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-15T22:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-290999",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291000.json:
```json
{
    "body": "I made some experiments, demonstrating that the coercion system in Sage does not perform all basic checks. Indeed, compare the two following sessions (I've just permuted the two last lines):\n\n\n```\nsage: A.<t> = GF(3)[]\nsage: P = t^5 + 2*t^3 + 2*t^2 + 3*t + 2\nsage: K = A.quo(P)\nsage: L.<a> = K.extension(x^2 + 1)\nsage: phi = A.hom([a])\nsage: phi.register_as_coercion()\nsage: L.coerce_map_from(A)\nRing morphism:\n  From: Univariate Polynomial Ring in t over Finite Field of size 3\n  To:   Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1\n  Defn: t |--> a\n```\n\n\n\n```\nsage: A.<t> = GF(3)[]\nsage: P = t^5 + 2*t^3 + 2*t^2 + 3*t + 2\nsage: K = A.quo(P)\nsage: L.<a> = K.extension(x^2 + 1)\nsage: phi = A.hom([a])\nsage: L.coerce_map_from(A)\nCoercion map:\n  From: Univariate Polynomial Ring in t over Finite Field of size 3\n  To:   Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1\nsage: phi.register_as_coercion()\nTraceback (most recent call last):\n...\nAssertionError: coercion from Univariate Polynomial Ring in t over Finite Field of size 3 to Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1 already registered or discovered\n```\n\n\nI don't know if it's a bug in `register_as_coercion` or if the user is supposed to check by himself consistency of the coercion model before calling it.",
    "created_at": "2020-04-16T07:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291000",
    "user": "https://github.com/xcaruso"
}
```

I made some experiments, demonstrating that the coercion system in Sage does not perform all basic checks. Indeed, compare the two following sessions (I've just permuted the two last lines):


```
sage: A.<t> = GF(3)[]
sage: P = t^5 + 2*t^3 + 2*t^2 + 3*t + 2
sage: K = A.quo(P)
sage: L.<a> = K.extension(x^2 + 1)
sage: phi = A.hom([a])
sage: phi.register_as_coercion()
sage: L.coerce_map_from(A)
Ring morphism:
  From: Univariate Polynomial Ring in t over Finite Field of size 3
  To:   Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1
  Defn: t |--> a
```



```
sage: A.<t> = GF(3)[]
sage: P = t^5 + 2*t^3 + 2*t^2 + 3*t + 2
sage: K = A.quo(P)
sage: L.<a> = K.extension(x^2 + 1)
sage: phi = A.hom([a])
sage: L.coerce_map_from(A)
Coercion map:
  From: Univariate Polynomial Ring in t over Finite Field of size 3
  To:   Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1
sage: phi.register_as_coercion()
Traceback (most recent call last):
...
AssertionError: coercion from Univariate Polynomial Ring in t over Finite Field of size 3 to Univariate Quotient Polynomial Ring in a over Univariate Quotient Polynomial Ring in tbar over Finite Field of size 3 with modulus t^5 + 2*t^3 + 2*t^2 + 2 with modulus a^2 + 1 already registered or discovered
```


I don't know if it's a bug in `register_as_coercion` or if the user is supposed to check by himself consistency of the coercion model before calling it.



---

archive/issue_comments_291001.json:
```json
{
    "body": "Maybe the right thing to do is to use to construction `over` I've introduced in ticket #21413. However, if so, I perfer delaying this for another ticket.",
    "created_at": "2020-04-16T07:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291001",
    "user": "https://github.com/xcaruso"
}
```

Maybe the right thing to do is to use to construction `over` I've introduced in ticket #21413. However, if so, I perfer delaying this for another ticket.



---

archive/issue_comments_291002.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-04-16T09:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_291003.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-04-16T09:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291003",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_291004.json:
```json
{
    "body": "So, I added a test to ensure that no coercion map already exists. (See also ticket #29517)",
    "created_at": "2020-04-16T09:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291004",
    "user": "https://github.com/xcaruso"
}
```

So, I added a test to ensure that no coercion map already exists. (See also ticket #29517)



---

archive/issue_comments_291005.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-16T14:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291005",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291006.json:
```json
{
    "body": "Thanks.\n\nCould you please also give a positive review to #29517 so that all of this could be merged.",
    "created_at": "2020-04-16T14:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291006",
    "user": "https://github.com/xcaruso"
}
```

Thanks.

Could you please also give a positive review to #29517 so that all of this could be merged.



---

archive/issue_comments_291007.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-04-16T14:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291007",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_291008.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-04-16T14:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_291009.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-16T14:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291009",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291010.json:
```json
{
    "body": "I give back a positive review to this ticket.",
    "created_at": "2020-04-16T14:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291010",
    "user": "https://github.com/xcaruso"
}
```

I give back a positive review to this ticket.



---

archive/issue_comments_291011.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-19T19:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21025#issuecomment-291011",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
