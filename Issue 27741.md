# Issue 27741: implement ./bootstrap --save-head

Issue created by migration from https://trac.sagemath.org/ticket/27978

Original creator: dimpase

Original creation time: 2019-06-12 19:48:59

CC:  embray vbraun

as [proposed](https://groups.google.com/d/msg/sage-release/E4vp20O2FN0/j0LfoSUtBAAJ) by Volker, 
extend the bootstrap script to save/load based on the git head sha1, e.g.:

```
    ./bootstrap --save-head

saves upstream/configure-<sha1>.tag.gz

    ./bootstrap  --load-head http://path/to/upstream/

loads http://path/to/upstream/configure-<sha1>.tag.gz
```



---

Comment by dimpase created at 2019-06-13 06:55:04

Is there any need to keep the numeric version numbers?

How about simply switching from version numbers for configure to sha1 versions?

Then `-i` should be just removed, and `-s` would mean `--save-head`, as in the proposal ?
 
So then the main change would be implementing `--load-head` (perhaps, `--load-from-url` is a better name).


---

Comment by vbraun created at 2019-06-13 07:03:59

Yes, we don't need consecutive numeric version numbers at all


---

Comment by embray created at 2019-06-13 08:43:17

This was a good suggestion, thanks.  Would we still need to distribute all the tarball on the mirror though?  I'm not sure exactly how this will work.


---

Comment by dimpase created at 2019-06-13 08:57:04

New commits:


---

Comment by dimpase created at 2019-06-13 09:01:09

So far, the branch just does the switch to sha1 from "number".

The url to download the configure tarball may be stored somewhere, maybe in `build/pkgs/configure/checksum.ini` ?


---

Comment by vbraun created at 2019-06-13 10:35:32

In my proposal the download base url is a parameter to bootstrap, since the buildbot and patchbots may want to use different servers. And its then easy enough to supply the location in the build step configuration, and you don't need to distribute the confballs on the mirror network.


---

Comment by embray created at 2019-06-13 10:54:55

But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?


---

Comment by git created at 2019-06-13 11:15:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-06-13 11:16:42

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-06-13 11:16:42

OK, so here it is.


---

Comment by dimpase created at 2019-06-13 11:19:55

basically, `-u <URL>` triggers uploading the URL to upstream/, 
and it implies `-D`.

if the resulting tarball does not match the present branch, too bad, it will fail
(unless it succeeds to download from the "usual" Sage mirrors)


---

Comment by dimpase created at 2019-06-13 11:31:36

Replying to [comment:8 embray]:
> But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?

a package tarball is a package tarball. Is there a special-casing for configure package in patch/buildbot configs? 

I presume mentioning its URL in the ticket description should be equivalent to what we do with the "normal" packages (for this the new `-u` feature doesn't seem to be needed). And release tools can make use of it in some way too.


---

Comment by vbraun created at 2019-06-13 12:43:57

I've asked Harald & Wiliam for what a good "default" serving url is in the current webserver, but we don't necessarily have to implement that fallback here.


---

Comment by vbraun created at 2019-06-13 13:11:14

We'll go with http://old.files.sagemath.org/configure/


---

Comment by vbraun created at 2019-07-01 18:39:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-01 19:48:46

/src/bin/sage-update-version calls bootstrap -i which is now an illegal argument error


---

Comment by vbraun created at 2019-07-01 19:48:46

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-07-01 20:10:58

would just removing that “-i” there be good enough?


---

Comment by vbraun created at 2019-07-01 20:33:31

Yes, just needs to be removed I think

Also:

```
    if [ $CONFTARBALL_URL != "" ]; then
        [...]
    fi
    bootstrap-download || exit $?
```

always ends up calling bootstrap-download, should be in an else branch


---

Comment by git created at 2019-07-01 20:53:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-07-01 20:54:07

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-07-02 17:04:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2019-07-02 17:09:55

There was also the following logic error: The confball checksum needs to be checked in, changing the sha1. So when restoring we need to use the sha1 from package-version.txt and not the current HEAD sha1.

Also, sage-download-file used to ignore error.


---

Comment by dimpase created at 2019-07-02 18:07:59

I merely assumed that with CONFTARBALL_URL one can install an arbitrary configure verrsion, not one in any way related to the current repo state. Certainly if your need the latter, this is fine too.


---

Comment by vbraun created at 2019-07-02 19:12:03

I think its better to have bootstrap figure out the confball to download, otherwise the buildbot needs to rummage around in the sources which is all rather complicated.


---

Comment by vbraun created at 2019-07-02 19:12:14

Resolution: fixed


---

Comment by embray created at 2019-07-03 11:24:33

So now what are we supposed to do for building in a fresh Sage repository when we need the configure tarball?  Just running `make configure` blows up with an error that the relevant tarball can't be found.


---

Comment by dimpase created at 2019-07-03 11:31:42

Are you talking about the transition from old versioning to the new one?


---

Comment by embray created at 2019-07-03 11:44:42

Replying to [comment:28 dimpase]:
> Are you talking about the transition from old versioning to the new one?

I don't know. Am I?  On a fresh VM in a fresh build of Sage I just get sage-download blowing up that it can't find `configure-<sha1>.tar.gz`.


---

Comment by embray created at 2019-07-03 11:51:29

I think I must be seeing #28099.  Likewise on my buildbot:


```
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'
************************************************************************
Traceback (most recent call last):
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py", line 118, in run_safe
    run()
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py", line 98, in run
    app.download_url(args.url_or_tarball, args.destination)
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/app.py", line 39, in download_url
    Download(url, destination, progress=not self.quiet, ignore_errors=False).run()
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/transfer.py", line 137, in run
    raise error
DownloadError: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'
************************************************************************
Error: downloading configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz from http://old.files.sagemath.org/configure/ failed
```



---

Comment by dimpase created at 2019-07-03 11:52:34

could it be that Volker did not upload the configure tarball to mirrors yet?


---

Comment by dimpase created at 2019-07-03 11:56:55

yeah I guess #28099 will fix this.
