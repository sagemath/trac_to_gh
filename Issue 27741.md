# Issue 27741: implement ./bootstrap --save-head

archive/issues_027741.json:
```json
{
    "body": "CC:  @embray @vbraun\n\nas [proposed](https://groups.google.com/d/msg/sage-release/E4vp20O2FN0/j0LfoSUtBAAJ) by Volker, \nextend the bootstrap script to save/load based on the git head sha1, e.g.:\n\n```\n    ./bootstrap --save-head\n\nsaves upstream/configure-<sha1>.tag.gz\n\n    ./bootstrap  --load-head http://path/to/upstream/\n\nloads http://path/to/upstream/configure-<sha1>.tag.gz\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27978\n\n",
    "created_at": "2019-06-12T19:48:59Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "implement ./bootstrap --save-head",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27741",
    "user": "https://github.com/dimpase"
}
```
CC:  @embray @vbraun

as [proposed](https://groups.google.com/d/msg/sage-release/E4vp20O2FN0/j0LfoSUtBAAJ) by Volker, 
extend the bootstrap script to save/load based on the git head sha1, e.g.:

```
    ./bootstrap --save-head

saves upstream/configure-<sha1>.tag.gz

    ./bootstrap  --load-head http://path/to/upstream/

loads http://path/to/upstream/configure-<sha1>.tag.gz
```


Issue created by migration from https://trac.sagemath.org/ticket/27978





---

archive/issue_comments_391498.json:
```json
{
    "body": "Is there any need to keep the numeric version numbers?\n\nHow about simply switching from version numbers for configure to sha1 versions?\n\nThen `-i` should be just removed, and `-s` would mean `--save-head`, as in the proposal ?\n \nSo then the main change would be implementing `--load-head` (perhaps, `--load-from-url` is a better name).",
    "created_at": "2019-06-13T06:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391498",
    "user": "https://github.com/dimpase"
}
```

Is there any need to keep the numeric version numbers?

How about simply switching from version numbers for configure to sha1 versions?

Then `-i` should be just removed, and `-s` would mean `--save-head`, as in the proposal ?
 
So then the main change would be implementing `--load-head` (perhaps, `--load-from-url` is a better name).



---

archive/issue_comments_391499.json:
```json
{
    "body": "Yes, we don't need consecutive numeric version numbers at all",
    "created_at": "2019-06-13T07:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391499",
    "user": "https://github.com/vbraun"
}
```

Yes, we don't need consecutive numeric version numbers at all



---

archive/issue_comments_391500.json:
```json
{
    "body": "This was a good suggestion, thanks.  Would we still need to distribute all the tarball on the mirror though?  I'm not sure exactly how this will work.",
    "created_at": "2019-06-13T08:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391500",
    "user": "https://github.com/embray"
}
```

This was a good suggestion, thanks.  Would we still need to distribute all the tarball on the mirror though?  I'm not sure exactly how this will work.



---

archive/issue_comments_391501.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-06-13T08:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391501",
    "user": "https://github.com/dimpase"
}
```

New commits:



---

archive/issue_comments_391502.json:
```json
{
    "body": "So far, the branch just does the switch to sha1 from \"number\".\n\nThe url to download the configure tarball may be stored somewhere, maybe in `build/pkgs/configure/checksum.ini` ?",
    "created_at": "2019-06-13T09:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391502",
    "user": "https://github.com/dimpase"
}
```

So far, the branch just does the switch to sha1 from "number".

The url to download the configure tarball may be stored somewhere, maybe in `build/pkgs/configure/checksum.ini` ?



---

archive/issue_comments_391503.json:
```json
{
    "body": "In my proposal the download base url is a parameter to bootstrap, since the buildbot and patchbots may want to use different servers. And its then easy enough to supply the location in the build step configuration, and you don't need to distribute the confballs on the mirror network.",
    "created_at": "2019-06-13T10:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391503",
    "user": "https://github.com/vbraun"
}
```

In my proposal the download base url is a parameter to bootstrap, since the buildbot and patchbots may want to use different servers. And its then easy enough to supply the location in the build step configuration, and you don't need to distribute the confballs on the mirror network.



---

archive/issue_comments_391504.json:
```json
{
    "body": "But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?",
    "created_at": "2019-06-13T10:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391504",
    "user": "https://github.com/embray"
}
```

But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?



---

archive/issue_comments_391505.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-13T11:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391505",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391506.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-13T11:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391506",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391507.json:
```json
{
    "body": "OK, so here it is.",
    "created_at": "2019-06-13T11:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391507",
    "user": "https://github.com/dimpase"
}
```

OK, so here it is.



---

archive/issue_comments_391508.json:
```json
{
    "body": "basically, `-u <URL>` triggers uploading the URL to upstream/, \nand it implies `-D`.\n\nif the resulting tarball does not match the present branch, too bad, it will fail\n(unless it succeeds to download from the \"usual\" Sage mirrors)",
    "created_at": "2019-06-13T11:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391508",
    "user": "https://github.com/dimpase"
}
```

basically, `-u <URL>` triggers uploading the URL to upstream/, 
and it implies `-D`.

if the resulting tarball does not match the present branch, too bad, it will fail
(unless it succeeds to download from the "usual" Sage mirrors)



---

archive/issue_comments_391509.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?\n\na package tarball is a package tarball. Is there a special-casing for configure package in patch/buildbot configs? \n\nI presume mentioning its URL in the ticket description should be equivalent to what we do with the \"normal\" packages (for this the new `-u` feature doesn't seem to be needed). And release tools can make use of it in some way too.",
    "created_at": "2019-06-13T11:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391509",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:8 embray]:
> But what would be that location?  Say for the patchbots you'd want to have them get the configure tarball from a ticket attachment.  That could be done, but we'd have to modify the patchbot code to do that (doesn't sound too hard, I just want to make sure I understand properly).  What would be the standard location for the buildbots to check?

a package tarball is a package tarball. Is there a special-casing for configure package in patch/buildbot configs? 

I presume mentioning its URL in the ticket description should be equivalent to what we do with the "normal" packages (for this the new `-u` feature doesn't seem to be needed). And release tools can make use of it in some way too.



---

archive/issue_comments_391510.json:
```json
{
    "body": "I've asked Harald & Wiliam for what a good \"default\" serving url is in the current webserver, but we don't necessarily have to implement that fallback here.",
    "created_at": "2019-06-13T12:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391510",
    "user": "https://github.com/vbraun"
}
```

I've asked Harald & Wiliam for what a good "default" serving url is in the current webserver, but we don't necessarily have to implement that fallback here.



---

archive/issue_comments_391511.json:
```json
{
    "body": "We'll go with http://old.files.sagemath.org/configure/",
    "created_at": "2019-06-13T13:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391511",
    "user": "https://github.com/vbraun"
}
```

We'll go with http://old.files.sagemath.org/configure/



---

archive/issue_comments_391512.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-01T18:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391512",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_391513.json:
```json
{
    "body": "/src/bin/sage-update-version calls bootstrap -i which is now an illegal argument error",
    "created_at": "2019-07-01T19:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391513",
    "user": "https://github.com/vbraun"
}
```

/src/bin/sage-update-version calls bootstrap -i which is now an illegal argument error



---

archive/issue_comments_391514.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-07-01T19:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391514",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_391515.json:
```json
{
    "body": "would just removing that \u201c-i\u201d there be good enough?",
    "created_at": "2019-07-01T20:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391515",
    "user": "https://github.com/dimpase"
}
```

would just removing that “-i” there be good enough?



---

archive/issue_comments_391516.json:
```json
{
    "body": "Yes, just needs to be removed I think\n\nAlso:\n\n```\n    if [ $CONFTARBALL_URL != \"\" ]; then\n        [...]\n    fi\n    bootstrap-download || exit $?\n```\n\nalways ends up calling bootstrap-download, should be in an else branch",
    "created_at": "2019-07-01T20:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391516",
    "user": "https://github.com/vbraun"
}
```

Yes, just needs to be removed I think

Also:

```
    if [ $CONFTARBALL_URL != "" ]; then
        [...]
    fi
    bootstrap-download || exit $?
```

always ends up calling bootstrap-download, should be in an else branch



---

archive/issue_comments_391517.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-01T20:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391518.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-01T20:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391518",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_391519.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-02T17:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391519",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391520.json:
```json
{
    "body": "There was also the following logic error: The confball checksum needs to be checked in, changing the sha1. So when restoring we need to use the sha1 from package-version.txt and not the current HEAD sha1.\n\nAlso, sage-download-file used to ignore error.",
    "created_at": "2019-07-02T17:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391520",
    "user": "https://github.com/vbraun"
}
```

There was also the following logic error: The confball checksum needs to be checked in, changing the sha1. So when restoring we need to use the sha1 from package-version.txt and not the current HEAD sha1.

Also, sage-download-file used to ignore error.



---

archive/issue_comments_391521.json:
```json
{
    "body": "I merely assumed that with CONFTARBALL_URL one can install an arbitrary configure verrsion, not one in any way related to the current repo state. Certainly if your need the latter, this is fine too.",
    "created_at": "2019-07-02T18:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391521",
    "user": "https://github.com/dimpase"
}
```

I merely assumed that with CONFTARBALL_URL one can install an arbitrary configure verrsion, not one in any way related to the current repo state. Certainly if your need the latter, this is fine too.



---

archive/issue_comments_391522.json:
```json
{
    "body": "I think its better to have bootstrap figure out the confball to download, otherwise the buildbot needs to rummage around in the sources which is all rather complicated.",
    "created_at": "2019-07-02T19:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391522",
    "user": "https://github.com/vbraun"
}
```

I think its better to have bootstrap figure out the confball to download, otherwise the buildbot needs to rummage around in the sources which is all rather complicated.



---

archive/issue_comments_391523.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-02T19:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391523",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069336.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-02T19:12:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27741#event-69336"
}
```



---

archive/issue_comments_391524.json:
```json
{
    "body": "So now what are we supposed to do for building in a fresh Sage repository when we need the configure tarball?  Just running `make configure` blows up with an error that the relevant tarball can't be found.",
    "created_at": "2019-07-03T11:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391524",
    "user": "https://github.com/embray"
}
```

So now what are we supposed to do for building in a fresh Sage repository when we need the configure tarball?  Just running `make configure` blows up with an error that the relevant tarball can't be found.



---

archive/issue_comments_391525.json:
```json
{
    "body": "Are you talking about the transition from old versioning to the new one?",
    "created_at": "2019-07-03T11:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391525",
    "user": "https://github.com/dimpase"
}
```

Are you talking about the transition from old versioning to the new one?



---

archive/issue_comments_391526.json:
```json
{
    "body": "Replying to [comment:28 dimpase]:\n> Are you talking about the transition from old versioning to the new one?\n\nI don't know. Am I?  On a fresh VM in a fresh build of Sage I just get sage-download blowing up that it can't find `configure-<sha1>.tar.gz`.",
    "created_at": "2019-07-03T11:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391526",
    "user": "https://github.com/embray"
}
```

Replying to [comment:28 dimpase]:
> Are you talking about the transition from old versioning to the new one?

I don't know. Am I?  On a fresh VM in a fresh build of Sage I just get sage-download blowing up that it can't find `configure-<sha1>.tar.gz`.



---

archive/issue_comments_391527.json:
```json
{
    "body": "I think I must be seeing #28099.  Likewise on my buildbot:\n\n\n```\n[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\nERROR [transfer|run:135]: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'\n************************************************************************\nTraceback (most recent call last):\n  File \"/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py\", line 118, in run_safe\n    run()\n  File \"/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py\", line 98, in run\n    app.download_url(args.url_or_tarball, args.destination)\n  File \"/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/app.py\", line 39, in download_url\n    Download(url, destination, progress=not self.quiet, ignore_errors=False).run()\n  File \"/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/transfer.py\", line 137, in run\n    raise error\nDownloadError: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'\n************************************************************************\nError: downloading configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz from http://old.files.sagemath.org/configure/ failed\n```\n",
    "created_at": "2019-07-03T11:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391527",
    "user": "https://github.com/embray"
}
```

I think I must be seeing #28099.  Likewise on my buildbot:


```
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'
************************************************************************
Traceback (most recent call last):
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py", line 118, in run_safe
    run()
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/cmdline.py", line 98, in run
    app.download_url(args.url_or_tarball, args.destination)
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/app.py", line 39, in download_url
    Download(url, destination, progress=not self.quiet, ignore_errors=False).run()
  File "/home/Admin/sage-buildbot-worker/sage_git/build/build/bin/../sage_bootstrap/download/transfer.py", line 137, in run
    raise error
DownloadError: [Errno 404] Not Found: '//old.files.sagemath.org/configure//configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz'
************************************************************************
Error: downloading configure-6fd12b83387b4658062ce7af6ddf23d68d9da17e.tar.gz from http://old.files.sagemath.org/configure/ failed
```




---

archive/issue_comments_391528.json:
```json
{
    "body": "could it be that Volker did not upload the configure tarball to mirrors yet?",
    "created_at": "2019-07-03T11:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391528",
    "user": "https://github.com/dimpase"
}
```

could it be that Volker did not upload the configure tarball to mirrors yet?



---

archive/issue_comments_391529.json:
```json
{
    "body": "yeah I guess #28099 will fix this.",
    "created_at": "2019-07-03T11:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27741#issuecomment-391529",
    "user": "https://github.com/dimpase"
}
```

yeah I guess #28099 will fix this.
