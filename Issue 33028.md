# Issue 33028: Some TypeError occurred some reasons in Complex Plots.

Issue created by migration from https://trac.sagemath.org/ticket/33265

Original creator: @umedoblock

Original creation time: 2022-01-31 22:19:00

CC:  slelievre

I tried to run all of the EXAMPLE in [Complex Plots](https://doc.sagemath.org/html/en/reference/plotting/sage/plot/complex_plot.html)

## environment

```
macOS Monterey
Version 12.1
```



```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.rc2, Release Date: 2022-01-16                 │
│ Using Python 3.9.9. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```


# Some TypeError occurred after run below EXAMPLES:

## TypeError1

```
sage: sage: complex_plot(sqrt(x), (-5, 5), (-5, 5)) 
....:                                                                           
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-49-248579947237> in <module>
----> 1 complex_plot(sqrt(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/misc/functional.py in sqrt(x, *args, **kwds)
   1977     except (AttributeError, TypeError):
   1978         pass
-> 1979     return _do_sqrt(x, *args, **kwds)
   1980 
   1981 

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/misc/functional.py in _do_sqrt(x, prec, extend, all)
   1877     else:
   1878         from sage.symbolic.ring import SR
-> 1879         z = SR(x).sqrt()
   1880 
   1881     if all:

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9388)()
    896         if mor is not None:
    897             if no_extra_args:
--> 898                 return mor._call_(x)
    899             else:
    900                 return mor._call_with_args(x, args, kwds)

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4665)()
    159                 print(type(C), C)
    160                 print(type(C._element_constructor), C._element_constructor)
--> 161             raise
    162 
    163     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4557)()
    154         cdef Parent C = self._codomain
    155         try:
--> 156             return C._element_constructor(x)
    157         except Exception:
    158             if print_warnings:

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/ring.pyx in sage.symbolic.ring.SymbolicRing._element_constructor_ (build/cythonized/sage/symbolic/ring.c:5685)()
    384             TypeError: Malformed expression: λ + * !!!  1
    385         """
--> 386         return new_Expression(self, x)
    387 
    388     def _force_pyobject(self, x, bint force=False, bint recursive=True):

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.new_Expression (build/cythonized/sage/symbolic/expression.cpp:100951)()
  13677             raise TypeError(f"unable to convert {x!r} to a symbolic expression")
  13678     else:
> 13679         raise TypeError(f"unable to convert {x!r} to a symbolic expression")
  13680 
  13681     return new_Expression_from_GEx(parent, exp)

TypeError: unable to convert <function <lambda> at 0x161437ca0> to a symbolic expression
```


## TypeError2

```
sage: sage: complex_plot(sin(x), (-5, 5), (-5, 5)) 
....:                                                                           
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5691)()
    526             try:
--> 527                 args = [SR.coerce(a) for a in args]
    528             except TypeError as err:

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11047)()
   1183 
-> 1184     cpdef coerce(self, x):
   1185         """

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10973)()
   1213                     _record_exception()
-> 1214             raise TypeError(_LazyString(_lazy_format, ("no canonical coercion from %s to %s", parent(x), self), {}))
   1215         else:

TypeError: no canonical coercion from <class 'function'> to Symbolic Ring

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-50-f09f3d13a823> in <module>
----> 1 complex_plot(sin(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.c:10903)()
   1031             res = self._evalf_try_(*args)
   1032             if res is None:
-> 1033                 res = super(BuiltinFunction, self).__call__(
   1034                         *args, coerce=coerce, hold=hold)
   1035 

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5853)()
    538                     if callable(method):
    539                         return method()
--> 540                 raise TypeError("cannot coerce arguments: %s" % (err))
    541 
    542         else: # coerce == False

TypeError: cannot coerce arguments: no canonical coercion from <class 'function'> to Symbolic Ring
```


## TypeError3

```
sage: sage: complex_plot(log(x), (-10, 10), (-10, 10)) 
....:                                                                           
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5691)()
    526             try:
--> 527                 args = [SR.coerce(a) for a in args]
    528             except TypeError as err:

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11047)()
   1183 
-> 1184     cpdef coerce(self, x):
   1185         """

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10973)()
   1213                     _record_exception()
-> 1214             raise TypeError(_LazyString(_lazy_format, ("no canonical coercion from %s to %s", parent(x), self), {}))
   1215         else:

TypeError: no canonical coercion from <class 'function'> to Symbolic Ring

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-51-ec243f9b54fb> in <module>
----> 1 complex_plot(log(x), (-Integer(10), Integer(10)), (-Integer(10), Integer(10)))

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/misc/functional.py in log(*args, **kwds)
   1168     if len(args) == 1:
   1169         from sage.functions.log import ln
-> 1170         return ln(args[0], **kwds)
   1171     if len(args) > 2:
   1172         raise TypeError("log takes at most 2 arguments (%s given)" % (len(args) + 1 - (base is not None)))

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.c:10903)()
   1031             res = self._evalf_try_(*args)
   1032             if res is None:
-> 1033                 res = super(BuiltinFunction, self).__call__(
   1034                         *args, coerce=coerce, hold=hold)
   1035 

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5853)()
    538                     if callable(method):
    539                         return method()
--> 540                 raise TypeError("cannot coerce arguments: %s" % (err))
    541 
    542         else: # coerce == False

TypeError: cannot coerce arguments: no canonical coercion from <class 'function'> to Symbolic Ring
```


## TypeError4

```
sage: sage: complex_plot(exp(x), (-10, 10), (-10, 10)) 
....:                                                                           
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5691)()
    526             try:
--> 527                 args = [SR.coerce(a) for a in args]
    528             except TypeError as err:

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11047)()
   1183 
-> 1184     cpdef coerce(self, x):
   1185         """

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10973)()
   1213                     _record_exception()
-> 1214             raise TypeError(_LazyString(_lazy_format, ("no canonical coercion from %s to %s", parent(x), self), {}))
   1215         else:

TypeError: no canonical coercion from <class 'function'> to Symbolic Ring

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-52-c14e7865c628> in <module>
----> 1 complex_plot(exp(x), (-Integer(10), Integer(10)), (-Integer(10), Integer(10)))

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.c:10903)()
   1031             res = self._evalf_try_(*args)
   1032             if res is None:
-> 1033                 res = super(BuiltinFunction, self).__call__(
   1034                         *args, coerce=coerce, hold=hold)
   1035 

/private/var/tmp/sage-9.5-current/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:5853)()
    538                     if callable(method):
    539                         return method()
--> 540                 raise TypeError("cannot coerce arguments: %s" % (err))
    541 
    542         else: # coerce == False

TypeError: cannot coerce arguments: no canonical coercion from <class 'function'> to Symbolic Ring
```



---

Comment by slelievre created at 2022-02-01 12:41:26

All the examples work fine for me in a fresh Sage session

- using the Sage-macOS 9.5 prerelease
- or using Sage 9.5 final, built from source

If I first redefine `x` as a function, e.g.

```
sage: x = lambda t: t + 1
```

then the failures in the ticket description arise.

Resetting `x` to its starting value with

```
sage: reset('x')
```

solves the issues, and the examples work fine again.


---

Comment by slelievre created at 2022-02-01 12:41:26

Changing type from PLEASE CHANGE to defect.


---

Comment by slelievre created at 2022-02-01 12:41:26

Changing component from PLEASE CHANGE to graphics.


---

Comment by slelievre created at 2022-02-01 12:41:26

Changing status from new to needs_review.


---

Comment by tscrim created at 2022-02-15 06:37:43

I think something got accidentally changed from the default (although IMO the doctests should specify what `x` is; I think there was a ticket about that recently?). Perhaps you have something in your `init.sage`?


---

Comment by tscrim created at 2022-02-15 06:37:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-02-26 18:53:04

Resolution: invalid
