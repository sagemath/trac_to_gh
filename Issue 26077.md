# Issue 26077: py3: Fix interfaces modules for python3

Issue created by migration from Trac.

Original creator: vklein

Original creation time: 2018-09-19 15:39:11

CC:  embray jdemeyer




---

Comment by vklein created at 2018-09-19 15:55:45

New commits:


---

Comment by vklein created at 2018-09-19 15:55:45

Changing status from new to needs_info.


---

Comment by chapoton created at 2018-09-19 17:50:00

see #26311 for the sleep problem


---

Comment by vklein created at 2018-09-20 07:30:36

Thanks !


---

Comment by vklein created at 2018-09-27 07:50:33

Changing status from needs_info to needs_review.


---

Comment by vklein created at 2018-09-27 07:51:19

This ticket don't manage the walltime case.


---

Comment by git created at 2018-10-02 09:30:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-10-02 09:34:23

Remove some unused variable to make pyflakes more happy (`AsciiArtString` is needed by `macaulay2.py`).


---

Comment by chapoton created at 2018-10-02 12:16:15

`@`embray and `@`jdemeyer, any opinion on the simple changes proposed here ?


---

Comment by vklein created at 2018-10-02 13:04:18

... or an opinion about the "walltime" test ...


---

Comment by embray created at 2018-10-02 13:09:11

For cases like:


```diff
diff --git a/src/sage/interfaces/sagespawn.pyx b/src/sage/interfaces/sagespawn.pyx
index 9b44d3a..1600d70 100644
--- a/src/sage/interfaces/sagespawn.pyx
+++ b/src/sage/interfaces/sagespawn.pyx
`@``@` -145,8 +145,10 `@``@` class SageSpawn(spawn):
             sage: from sage.interfaces.sagespawn import SageSpawn
             sage: E = SageSpawn("sh", ["-c", "echo hello world"])
             sage: _ = E.expect_peek("w")
-            sage: E.read()
+            sage: E.read() # py2
             'hello world\r\n'
+            sage: E.read() # py3
+            b'hello world\r\n'
```


where Python 3 returns bytes, instead of making two separate cases, in the past I have done something like `print(E.read().decode('ascii'))`.  This will have the same result in both cases.


I wonder if Sage shouldn't include its own `sleep()` built-in that isn't broken :/


---

Comment by vklein created at 2018-10-02 13:31:26

Replying to [comment:12 embray]:
> where Python 3 returns bytes, instead of making two separate cases, in the past I have done something like `print(E.read().decode('ascii'))`.  This will have the same result in both cases.
> 
I know, i hesitated between the two syntax and, as it is an `EXAMPLES::`, have think that the `# py2`-`# py3` syntax might be clearer for the end-user.

I don't have a strong opinion on it, tell me what you prefer. If the past cases you talk about are also `EXAMPLES::` we should stick with the `decode('ascii')` solution for consistency.


---

Comment by embray created at 2018-10-02 13:40:53

Yes, I think consistency is best.  There are a few other cases that also, rather than relying on the `repr`, just do like


```
sage: E.read() == b'Hello\r\n'
True
```


or whatever.  This will also work the same on Python 2 and 3.

I have thought of adding a helper to the test framework to deal with `b`-prefixed strings as it does with `u`-strings, but it turns out they are relatively uncommon in the majority of the test suite.


---

Comment by git created at 2018-10-02 14:28:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-10-02 14:32:22

`# py2`-`# py3` cases replaced using `decode(ascii)` syntax.


---

Comment by chapoton created at 2018-10-05 09:59:26

probably you do not need the initial `u` that you add to some doctests.


---

Comment by embray created at 2018-10-05 10:29:46

Replying to [comment:17 chapoton]:
> probably you do not need the initial `u` that you add to some doctests.

I think it is needed because on Python 2 `.decode(...)` will return a unicode string literal, and the doctest parser _does_ treat this as relevant on Python 2.  The only thing it does w.r.t. u-prefixes is on Python 3 it strips them from the expected output.

I usually avoid the issue by using `print(...)` instead, but i think this is fine as-is.


---

Comment by vklein created at 2018-10-05 11:18:57

It is as Eric says, these tests as they are won't work on py2 without the initial `u`


---

Comment by chapoton created at 2018-10-21 14:02:24

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-10-21 14:02:24

ok, let it be


---

Comment by vbraun created at 2018-10-22 22:40:52

Resolution: fixed


---

Comment by embray created at 2018-10-28 14:52:23

This should be re-targeted for 8.5.
