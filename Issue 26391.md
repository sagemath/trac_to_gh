# Issue 26391: py3: some partial fix for sandpiles

Issue created by migration from https://trac.sagemath.org/ticket/26628

Original creator: chapoton

Original creation time: 2018-11-03 18:11:56

CC:  tscrim vklein

the rest will have to wait for more fixes in generic graph


---

Comment by chapoton created at 2018-11-03 18:12:29

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-11-03 18:12:29

New commits:


---

Comment by git created at 2018-11-03 18:15:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-11-04 09:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-11-04 13:07:41

bot is morally green, please review


---

Comment by tscrim created at 2018-11-04 14:32:36

LGTM.


---

Comment by tscrim created at 2018-11-04 14:32:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-07 11:27:42

Resolution: fixed


---

Comment by vbraun created at 2018-11-11 10:13:41

Resolution changed from fixed to 


---

Comment by vbraun created at 2018-11-11 10:13:41

Changing status from closed to new.


---

Comment by vbraun created at 2018-11-11 10:13:41

I'm randomly getting this

```
**********************************************************************
File "src/doc/en/thematic_tutorials/sandpile.rst", line 4678, in doc.en.thematic_tutorials.sandpile
Failed example:
    D
Expected:
    {1: 2, 'a': 0, 'b': 1}
Got:
    {'a': 0, 'b': 1, 1: 2}
**********************************************************************
1 item had failures:
   1 of 706 in doc.en.thematic_tutorials.sandpile
    [705 tests, 1 failure, 93.88 s]
**********************************************************************
File "src/sage/sandpiles/sandpile.py", line 4769, in sage.sandpiles.sandpile.SandpileDivisor.values
Failed example:
    D
Expected:
    {1: 2, 'a': 0, 'b': 1}
Got:
    {'a': 0, 'b': 1, 1: 2}
**********************************************************************
1 item had failures:
   1 of   6 in sage.sandpiles.sandpile.SandpileDivisor.values
    [941 tests, 1 failure, 54.14 s]
```



---

Comment by vbraun created at 2018-11-11 10:18:11

Also, for consistency I'd recommend using src.sage.repl.display.pretty_print.SagePrettyPrinter if you want to manually stringify an object


---

Comment by chapoton created at 2018-11-12 08:54:12

Changing status from new to needs_info.


---

Comment by chapoton created at 2018-11-12 08:54:17

Changing status from needs_info to needs_work.


---

Comment by git created at 2018-12-03 13:22:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-12-03 13:23:08

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-12-03 13:23:08

Is this what you suggested, Volker ?


---

Comment by chapoton created at 2018-12-07 09:35:38

`@`vbraun:

or should I rather use `from sage.repl.rich_output.pretty_print import pretty_print` ?


---

Comment by chapoton created at 2018-12-14 10:28:33

Changing status from needs_review to needs_info.


---

Comment by chapoton created at 2018-12-29 14:24:32

ok, the alternative with pretty_print does not make sense. Back to needs_review..


---

Comment by chapoton created at 2018-12-29 14:24:32

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2018-12-29 16:54:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-30 13:31:54

I'm still getting this on the OSX buildbot:

```
**********************************************************************
File "src/doc/en/thematic_tutorials/sandpile.rst", line 4678, in doc.en.thematic_tutorials.sandpile
Failed example:
    D
Expected:
    {1: 2, 'a': 0, 'b': 1}
Got:
    {'a': 0, 'b': 1, 1: 2}
**********************************************************************
1 item had failures:
   1 of 706 in doc.en.thematic_tutorials.sandpile
    [705 tests, 1 failure, 86.65 s]
**********************************************************************
File "src/sage/sandpiles/sandpile.py", line 4771, in sage.sandpiles.sandpile.SandpileDivisor.values
Failed example:
    D
Expected:
    {1: 2, 'a': 0, 'b': 1}
Got:
    {'a': 0, 'b': 1, 1: 2}
**********************************************************************
1 item had failures:
   1 of   6 in sage.sandpiles.sandpile.SandpileDivisor.values
    [941 tests, 1 failure, 43.18 s]
----------------------------------------------------------------------
sage -t --long src/doc/en/thematic_tutorials/sandpile.rst  # 1 doctest failed
sage -t --long src/sage/sandpiles/sandpile.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-12-30 13:31:54

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2018-12-31 18:17:22

*NOTE*: I am going to recycle this ticket right now.
----
New commits:


---

Comment by chapoton created at 2018-12-31 18:17:22

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-12-31 20:25:52

green bot, please review (ticket has been recycled to do something related)


---

Comment by tscrim created at 2019-01-04 20:13:21

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-10 15:09:51

Changing status from positive_review to needs_info.


---

Comment by embray created at 2019-01-10 15:09:51

Something about this still smells off.  For example:


```diff
@@ -3595,14 +3595,14 @@ boolean
 
 EXAMPLES::
 
-    sage: S = Sandpile({'a':[1,'b'], 'b':[1,'a'], 1:['a']},'a')
-    sage: c = SandpileConfig(S, {'b':1, 1:2})
+    sage: S = Sandpile({'a':['c','b'], 'b':['c','a'], 'c':['a']},'a')
+    sage: c = SandpileConfig(S, {'b':1, 'c':2})
     sage: c
-    {1: 2, 'b': 1}
+    {'c': 2, 'b': 1}
```


I'm not sure that last change is always going to be correct.  If `c` were a dict it would be pretty-printed with its keys sorted.  I haven't looked at `SandpileConfig` but it should probably do the same.


---

Comment by embray created at 2019-01-10 15:11:16

And does this relate in any way to #26722?


---

Comment by chapoton created at 2019-01-10 16:02:15

This is a preliminary cleanup work, certainly not the last word. Your concern should go to #26722. Sandpiles is a big mess, and I hope to move forward by small steps.

Can I set back to positive ?


---

Comment by embray created at 2019-01-10 16:16:38

Replying to [comment:24 chapoton]:
> This is a preliminary cleanup work, certainly not the last word. Your concern should go to #26722. Sandpiles is a big mess, and I hope to move forward by small steps.
> 
> Can I set back to positive ?

Unfortunately not: The problem is that since this is being repr'd like a dict, the output order is completely arbitrary, and this ticket is just changing it to a different arbitrary order that is not guaranteed to be the same between Python versions or even platforms.

If you give me a sec, I think I have a solution...


---

Comment by git created at 2019-01-10 16:42:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-01-10 16:42:30

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2019-01-10 16:44:26

this will probably trigger the import of IPython at startup, no ?


---

Comment by embray created at 2019-01-10 16:46:31

I'm not sure what you mean.


---

Comment by chapoton created at 2019-01-10 16:49:20

I mean that the line

```
from IPython.lib import pretty
```

maybe will have a negative impact on sage startup time (if it imports all of IPython)

I am asking because I tried to import sage pretty-printer in some ticket, and then the startup time got 10% longer (import of Ipython..)


---

Comment by embray created at 2019-01-10 16:52:28

That's odd that you found that to be the case, because the Sage REPL _is_ IPython:


```
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.6.rc0, Release Date: 2019-01-03                 │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import sys
sage: sys.modules['IPython.lib.pretty']
<module 'IPython.lib.pretty' from '/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc'>
sage: sys.modules['sage.sandpiles.sandpile']
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-4-8624d4f52316> in <module>()
----> 1 sys.modules['sage.sandpiles.sandpile']

KeyError: 'sage.sandpiles.sandpile'
```



---

Comment by chapoton created at 2019-01-10 16:57:24

Yes, strange indeed, but see bottom report here:

https://patchbot.sagemath.org/ticket/26967/

and in particular the startup plugins..

EDIT: Apparently triggered by

```
+from sage.repl.rich_output.backend_base import BackendBase
+from sage.repl.display.pretty_print import SagePrettyPrinter
```



---

Comment by embray created at 2019-01-10 17:13:44

Well, `sage -c` is different because it doesn't load the REPL, but it does `import sage.all`.  However, I still _usually_ get:


```
$ ./sage -c 'import sys; print("IPython" in sys.modules)'
False
```


This might be in part because `sage.sandpiles` is lazy-imported.

For some odd reason though, immediately after a `./sage -b` I get:


```
$ ./sage -c 'import sys; print("IPython" in sys.modules)'
True
```


But then not thereafter. Something must change immediately after a re-build that somehow triggers IPython from being imported.


---

Comment by embray created at 2019-01-10 17:16:19

As my note says, it would be good to rework `sage.repl.display.pretty_print` so that this kind of thing can be avoided in the first place since it's pretty ugly anyways.


---

Comment by embray created at 2019-01-10 17:27:32

Replying to [comment:33 embray]:
> But then not thereafter. Something must change immediately after a re-build that somehow triggers IPython from being imported.

I see: That's in order to rebuild the star imports cache.


---

Comment by chapoton created at 2019-01-11 07:44:06

ok, then.


---

Comment by chapoton created at 2019-01-11 07:44:06

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-11 11:47:46

Thanks.  It's still a good point you raise though: Merely importing those modules shouldn't cause `IPython` to be imported if it can be avoided (e.g. it's pointless to do so if we're not in IPython).

I'll open a ticket for that.


---

Comment by vbraun created at 2019-01-20 19:34:37

On OSX:

```
**********************************************************************
File "src/sage/sandpiles/sandpile.py", line 3486, in sage.sandpiles.sandpile.SandpileConfig.values
Failed example:
    c
Expected:
    {1: 2, 'b': 1}
Got:
    {'b': 1, 1: 2}
**********************************************************************
File "src/sage/sandpiles/sandpile.py", line 4765, in sage.sandpiles.sandpile.SandpileDivisor.values
Failed example:
    D
Expected:
    {1: 2, 'a': 0, 'b': 1}
Got:
    {'a': 0, 'b': 1, 1: 2}
**********************************************************************
```



---

Comment by vbraun created at 2019-01-20 19:34:37

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-01-20 20:38:40

Damnation...


---

Comment by git created at 2019-01-21 09:53:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-21 09:53:29

ok, this should fix it.


---

Comment by chapoton created at 2019-01-21 09:53:29

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-01-21 12:20:04

green bot. I have no way to test on OSX.


---

Comment by chapoton created at 2019-01-22 07:29:15

Vincent, would you please check the OsX behaviour ?


---

Comment by vklein created at 2019-01-22 10:01:21

Yes ! The two OSX errors from [comment:38](https://trac.sagemath.org/ticket/26628#comment:38) are fixed.


---

Comment by chapoton created at 2019-01-22 10:18:32

Merci beaucoup, Vincent. Je repasse en positif.


---

Comment by chapoton created at 2019-01-22 10:18:32

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-23 12:20:27

Weird. I'd have to take a closer look at how IPython's pretty-print module orders heterogeneous types when printing dictionaries.  If it's doing something id-based then it's not going to reliable (at least not the default implementation ...)


---

Comment by embray created at 2019-01-23 12:24:45

Ugh, so it's using this:


```
def _sorted_for_pprint(items):
    """
    Sort the given items for pretty printing. Since some predictable
    sorting is better than no sorting at all, we sort on the string
    representation if normal sorting fails.
    """
    items = list(items)
    try:
        return sorted(items)
    except Exception:
        try:
            return sorted(items, key=str)
        except Exception:
            return items
```


Ironically this will give more-or-less deterministic results on Python 3 (<3.7, where it relies on built-in dict ordering), but non-deterministic results on Python 2 where `sorted(items)` will not raise an exception, and instead rely on Python 2's crappy fallback ordering which is not deterministic.

This might explain some other tests that expect dicts in their output, but where we've struggled to get consistent results across platforms.  I'll look into fixing this.


---

Comment by vbraun created at 2019-01-24 18:17:58

Resolution: fixed
