# Issue 12656: get_memory_usage and top under FreeBSD

Issue created by migration from Trac.

Original creator: stephen

Original creation time: 2012-04-11 03:44:35

Assignee: pjeremy

CC:  jpflori

Suggested changes to sage/misc/getusage.py:


```
--- sage-5.0.beta13/sage/misc/getusage.py-orig  2012-04-11 00:14:47.000000000 +0000
+++ sage-5.0.beta13/sage/misc/getusage.py       2012-04-11 00:47:03.000000000 +0000
`@``@` -20,6 +20,8 `@``@`
     """
     Return the 'top' or 'prstat' line that contains this running Sage
     process.
+    For FreeBSD, return the line containing this running Sage process from
+    'ps -axwww -o pid,user,vsz,rss,state,pri,nice,time,cpu,comm'.

     OUTPUT:

`@``@` -53,6 +55,8 `@``@`
         cmd = 'top -l 1 |grep "^ *%s "' % pid
     elif U == 'sunos':
         cmd = '/usr/bin/prstat -n 100000 1 1  | grep "^ *%s "' % pid
+    elif U == 'freebsd':
+        cmd = 'ps -axwww -o pid,user,vsz,rss,state,pri,nice,time,cpu,comm | grep "^ *%s "' % pid
     else:
         raise NotImplementedError("top not implemented on platform %s" % U)

`@``@` -83,6 +87,9 `@``@`
       usage, ``prstat`` will output the data in KB, MB or GB. In each
       case, the value returned by this function will always be in MB.

+    - ``FreeBSD`` - Returns float number (in megabytes) that matches
+      RSS column of ``ps -auxwww``
+
     - ``other`` - not implemented for any other operating systems

     EXAMPLES::
`@``@` -129,6 +136,9 `@``@`
             m = float(memory_in_KB_MB_or_GB.strip("M"))
         elif memory_in_KB_MB_or_GB.endswith("G"):
             m = float(memory_in_KB_MB_or_GB.strip("G")) * 1024
+    elif U == 'freebsd':
+        memory_in_KB = top().split()[3]
+        m = float(memory_in_KB) / 1024
     else:
         raise NotImplementedError("memory usage not implemented on platform %s" % U)
```



---

Comment by kcrisman created at 2012-06-20 19:16:46

This just needs to be a patch for us to review it.  Thanks for all the work on this.


---

Comment by kcrisman created at 2013-01-16 01:18:41

This comment is mostly a reminder to myself to turn this into a patch file.  Nice find, though, and hopefully it will help us with #9170 as well.


---

Comment by kcrisman created at 2013-03-12 14:30:17

I guess it was a patch all along.


---

Attachment


---

Comment by kcrisman created at 2013-03-12 14:31:08

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-03-12 14:33:33

I don't there is anyone else currently doing much with FreeBSD that is active enough to review this (JP?), so let's say we trust Stephen :)

Unfortunately, it will need rebase on 5.8.beta4 and #9170, but that should be pretty easy.


---

Comment by kcrisman created at 2013-03-12 14:33:33

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2013-03-12 14:34:22

> Unfortunately, it will need rebase on 5.8.beta4 and #9170, but that should be pretty easy.
I don't know why I said that.


---

Comment by kcrisman created at 2013-03-12 14:34:22

Changing status from needs_work to positive_review.


---

Comment by kcrisman created at 2013-03-12 14:35:34

Also, to release manager... this shouldn't affect any other platform, and we have no such buildbot yet, so it could still make it into 5.8 if you are amenable to this.


---

Comment by stephen created at 2013-03-13 01:16:13

Actually I am in no hurry.  I have hit a road block in sage-5.8.beta4 in that document building is not working correctly.  It is probably something wrong with semaphores.  It may take me a while to figure it out.


---

Comment by jdemeyer created at 2013-03-14 08:11:15

Resolution: fixed
