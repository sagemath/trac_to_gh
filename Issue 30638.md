# Issue 30638: Random elements of AA aren't random

archive/issues_030638.json:
```json
{
    "body": "The `AA.random_element()` method only returns integers between `-2` and `2`, inclusive:\n\n\n```\nsage: [AA.random_element() for i in range(100) ]                                                                                                                             \n[2,\n 0,\n 0,\n 2,\n 1,\n 2,\n -1,\n 0,\n -2,\n -2,\n -2,\n 0,\n -2,\n 0,\n 2,\n -1,\n 1,\n 0,\n 0,\n 1,\n 1,\n -1,\n 2,\n -1,\n 0,\n 2,\n 1,\n 0,\n 0,\n 2,\n 1,\n 2,\n 0,\n -1,\n -2,\n -2,\n -1,\n 2,\n -2,\n 1,\n -1,\n -2,\n -2,\n 2,\n -1,\n 0,\n 1,\n -1,\n 2,\n 2,\n 0,\n -2,\n -1,\n -1,\n 1,\n -2,\n 2,\n 0,\n 2,\n -2,\n 0,\n -2,\n 1,\n -2,\n 0,\n -2,\n -2,\n -2,\n -1,\n -2,\n -1,\n 2,\n 0,\n 0,\n 1,\n 0,\n 0,\n -2,\n 0,\n -1,\n 2,\n -2,\n 0,\n -2,\n 2,\n -1,\n -1,\n 1,\n 1,\n -2,\n -1,\n 0,\n -2,\n -2,\n -1,\n 2,\n -2,\n -1,\n -2,\n -2]\n```\n\n\nThat's a bit un-random, even by sage standards. A simple improvement would be to return the real part of `QQbar.random_element()`:\n\n\n```\n\n}}}sage: [QQbar.random_element().real() for i in range(5) ]                                                                                                                     \n[-5.372281323269015?,\n -0.2000000000000000?,\n 0.50000000000000000?,\n -0.50000000000000000?,\n 0.1906845620110298?]\n\nIssue created by migration from https://trac.sagemath.org/ticket/30875\n\n",
    "created_at": "2020-11-08T21:44:39Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Random elements of AA aren't random",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30638",
    "user": "@orlitzky"
}
```
The `AA.random_element()` method only returns integers between `-2` and `2`, inclusive:


```
sage: [AA.random_element() for i in range(100) ]                                                                                                                             
[2,
 0,
 0,
 2,
 1,
 2,
 -1,
 0,
 -2,
 -2,
 -2,
 0,
 -2,
 0,
 2,
 -1,
 1,
 0,
 0,
 1,
 1,
 -1,
 2,
 -1,
 0,
 2,
 1,
 0,
 0,
 2,
 1,
 2,
 0,
 -1,
 -2,
 -2,
 -1,
 2,
 -2,
 1,
 -1,
 -2,
 -2,
 2,
 -1,
 0,
 1,
 -1,
 2,
 2,
 0,
 -2,
 -1,
 -1,
 1,
 -2,
 2,
 0,
 2,
 -2,
 0,
 -2,
 1,
 -2,
 0,
 -2,
 -2,
 -2,
 -1,
 -2,
 -1,
 2,
 0,
 0,
 1,
 0,
 0,
 -2,
 0,
 -1,
 2,
 -2,
 0,
 -2,
 2,
 -1,
 -1,
 1,
 1,
 -2,
 -1,
 0,
 -2,
 -2,
 -1,
 2,
 -2,
 -1,
 -2,
 -2]
```


That's a bit un-random, even by sage standards. A simple improvement would be to return the real part of `QQbar.random_element()`:


```

}}}sage: [QQbar.random_element().real() for i in range(5) ]                                                                                                                     
[-5.372281323269015?,
 -0.2000000000000000?,
 0.50000000000000000?,
 -0.50000000000000000?,
 0.1906845620110298?]

Issue created by migration from https://trac.sagemath.org/ticket/30875





---

archive/issue_comments_437913.json:
```json
{
    "body": "What's happening is that the class aliased to `AA`, `sage.rings.qqbar:AlgebraicRealField`, doesn't have a `random_element` method, which is causing its base class's (`sage.rings:Ring`'s) `random_element` to be called. I'm going to look into why this is happening.",
    "created_at": "2020-11-09T04:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437913",
    "user": "@bmlivin"
}
```

What's happening is that the class aliased to `AA`, `sage.rings.qqbar:AlgebraicRealField`, doesn't have a `random_element` method, which is causing its base class's (`sage.rings:Ring`'s) `random_element` to be called. I'm going to look into why this is happening.



---

archive/issue_comments_437914.json:
```json
{
    "body": "Set assignee to @bmlivin.",
    "created_at": "2020-11-09T04:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437914",
    "user": "@bmlivin"
}
```

Set assignee to @bmlivin.



---

archive/issue_comments_437915.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-11-10T19:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437915",
    "user": "@bmlivin"
}
```

New commits:



---

archive/issue_comments_437916.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-10T19:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437916",
    "user": "@bmlivin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_437917.json:
```json
{
    "body": "This works, but I'm curious why you wanted to use a superclass method instead of\n\n\n```python\ndef random_element(self, poly_degree=2, *args, **kwds):\n    r\"\"\"\n    ...\n    \"\"\"\n    return QQbar.random_element(poly_degree, *args, **kwds).real()\n```\n\n\nEither way works, but your version moves some things into the \"common\" class that aren't common to the two fields (they only work for `QQbar`, and have to be overridden for `AA`). I didn't write these classes, but that seems to go against the design; e.g. nothing else in the \"common\" class is overridden in the subclasses.",
    "created_at": "2020-11-17T14:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437917",
    "user": "@orlitzky"
}
```

This works, but I'm curious why you wanted to use a superclass method instead of


```python
def random_element(self, poly_degree=2, *args, **kwds):
    r"""
    ...
    """
    return QQbar.random_element(poly_degree, *args, **kwds).real()
```


Either way works, but your version moves some things into the "common" class that aren't common to the two fields (they only work for `QQbar`, and have to be overridden for `AA`). I didn't write these classes, but that seems to go against the design; e.g. nothing else in the "common" class is overridden in the subclasses.



---

archive/issue_comments_437918.json:
```json
{
    "body": "patchbot tells you that the added doctest should start with `r\"\"\"`",
    "created_at": "2021-01-18T10:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437918",
    "user": "@fchapoton"
}
```

patchbot tells you that the added doctest should start with `r"""`



---

archive/issue_comments_437919.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437919",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_437920.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437920",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_437921.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-18T09:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437921",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_437922.json:
```json
{
    "body": "Moving to needs_work based on the last few comments.",
    "created_at": "2021-09-18T09:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437922",
    "user": "@mezzarobba"
}
```

Moving to needs_work based on the last few comments.



---

archive/issue_comments_437923.json:
```json
{
    "body": "Thanks for working on this ticket,\nthis would be a welcome improvement.\n\nSeems almost good to go. Please:\n\n- simplify as suggested by `@`mjo\n- use raw string for new method's docstring as suggested by `@`chapoton\n- use `TESTS::` rather than `TESTS:` for test blocks",
    "created_at": "2021-12-29T23:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437923",
    "user": "@slel"
}
```

Thanks for working on this ticket,
this would be a welcome improvement.

Seems almost good to go. Please:

- simplify as suggested by `@`mjo
- use raw string for new method's docstring as suggested by `@`chapoton
- use `TESTS::` rather than `TESTS:` for test blocks



---

archive/issue_comments_437924.json:
```json
{
    "body": "Replying to [comment:10 slelievre]:\n> Thanks for working on this ticket,\n> this would be a welcome improvement.\n> \n> Seems almost good to go. Please:\n> \n> - simplify as suggested by `@`mjo\n\nI don't think my suggestion is any simpler; in fact, if I were writing the module from scratch I would probably try to do what Ben did.\n\nThe `AlgebraicField_common` class, even though it is technically a superclass of `QQbar`/`AA`, is used more like a \"mix-in\" than a parent. Its methods don't delegate to subclass implementations; instead, it contains only the few methods that are literally the same in its subclasses. For an example of what I mean, see `polynomial_root()` whose implementations differ only by one word, but are not abstracted into the superclass.\n\nAt this point I just don't think we should try to change the design without serious thought (and personally, I'd like this to be an easy ticket). So (re)implementing `random_element()` in `AA` would appear the path of least resistance.",
    "created_at": "2021-12-30T00:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437924",
    "user": "@orlitzky"
}
```

Replying to [comment:10 slelievre]:
> Thanks for working on this ticket,
> this would be a welcome improvement.
> 
> Seems almost good to go. Please:
> 
> - simplify as suggested by `@`mjo

I don't think my suggestion is any simpler; in fact, if I were writing the module from scratch I would probably try to do what Ben did.

The `AlgebraicField_common` class, even though it is technically a superclass of `QQbar`/`AA`, is used more like a "mix-in" than a parent. Its methods don't delegate to subclass implementations; instead, it contains only the few methods that are literally the same in its subclasses. For an example of what I mean, see `polynomial_root()` whose implementations differ only by one word, but are not abstracted into the superclass.

At this point I just don't think we should try to change the design without serious thought (and personally, I'd like this to be an easy ticket). So (re)implementing `random_element()` in `AA` would appear the path of least resistance.



---

archive/issue_comments_437925.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-12-30T02:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437925",
    "user": "@orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_437926.json:
```json
{
    "body": "Let's see if patchbot likes this.\n----\nLast 10 new commits:",
    "created_at": "2021-12-30T02:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437926",
    "user": "@orlitzky"
}
```

Let's see if patchbot likes this.
----
Last 10 new commits:



---

archive/issue_comments_437927.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-30T02:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437927",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437928.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-30T02:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437928",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_437929.json:
```json
{
    "body": "The patch looks good. The only thing I'm concerned about is that using degree 2 by default is perhaps a little (too?) small: Experimentally, the output lies in `QQ` about 62% of the time (is this 5/8?), and only ever returning quadratic numbers is kind of restrictive too. Of course, higher degrees make things slower, so I don't know what the perfect balance is. It looks like `poly_degree=4` might be a reasonable choice.",
    "created_at": "2021-12-30T08:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437929",
    "user": "@yyyyx4"
}
```

The patch looks good. The only thing I'm concerned about is that using degree 2 by default is perhaps a little (too?) small: Experimentally, the output lies in `QQ` about 62% of the time (is this 5/8?), and only ever returning quadratic numbers is kind of restrictive too. Of course, higher degrees make things slower, so I don't know what the perfect balance is. It looks like `poly_degree=4` might be a reasonable choice.



---

archive/issue_comments_437930.json:
```json
{
    "body": "Replying to [comment:15 lorenz]:\n> The patch looks good. The only thing I'm concerned about is that using degree 2 by default is perhaps a little (too?) small: Experimentally, the output lies in `QQ` about 62% of the time (is this 5/8?), and only ever returning quadratic numbers is kind of restrictive too. Of course, higher degrees make things slower, so I don't know what the perfect balance is. It looks like `poly_degree=4` might be a reasonable choice.\n\nI had this same thought last night, but when I tried it, using `poly_degree=4` took almost 3x as long to generate a number:\n\n\n```\nsage: %timeit AA.random_element(poly_degree=2)\n2.67 ms \u00b1 53 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit AA.random_element(poly_degree=3)\n4.24 ms \u00b1 80.1 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit AA.random_element(poly_degree=4)\n7.3 ms \u00b1 1.04 ms per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n\n~2.5ms is already a horrendous amount of time to generate a number, especially if you plan to e.g. fill a matrix with them. I'd hate to make `matrix.random(AA,5)` take ~175ms more than I hate the slight loss of randomness.",
    "created_at": "2021-12-30T12:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437930",
    "user": "@orlitzky"
}
```

Replying to [comment:15 lorenz]:
> The patch looks good. The only thing I'm concerned about is that using degree 2 by default is perhaps a little (too?) small: Experimentally, the output lies in `QQ` about 62% of the time (is this 5/8?), and only ever returning quadratic numbers is kind of restrictive too. Of course, higher degrees make things slower, so I don't know what the perfect balance is. It looks like `poly_degree=4` might be a reasonable choice.

I had this same thought last night, but when I tried it, using `poly_degree=4` took almost 3x as long to generate a number:


```
sage: %timeit AA.random_element(poly_degree=2)
2.67 ms ± 53 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit AA.random_element(poly_degree=3)
4.24 ms ± 80.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit AA.random_element(poly_degree=4)
7.3 ms ± 1.04 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


~2.5ms is already a horrendous amount of time to generate a number, especially if you plan to e.g. fill a matrix with them. I'd hate to make `matrix.random(AA,5)` take ~175ms more than I hate the slight loss of randomness.



---

archive/issue_comments_437931.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-30T16:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437931",
    "user": "@yyyyx4"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_437932.json:
```json
{
    "body": "Alright!",
    "created_at": "2021-12-30T16:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437932",
    "user": "@yyyyx4"
}
```

Alright!



---

archive/issue_comments_437933.json:
```json
{
    "body": "If speed matters, for degree bound two,\nwould the following be faster:\n\n- pick random integers `a`, `b`, `c`, `d`\n  (with nonzero `d `)\n- return `(a + b * AA(c).sqrt()) / d`\n\n(with `c > 0` for `AA`, any `c` for `QQbar`)\nand if so, is it worth special casing it?",
    "created_at": "2021-12-31T01:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437933",
    "user": "@slel"
}
```

If speed matters, for degree bound two,
would the following be faster:

- pick random integers `a`, `b`, `c`, `d`
  (with nonzero `d `)
- return `(a + b * AA(c).sqrt()) / d`

(with `c > 0` for `AA`, any `c` for `QQbar`)
and if so, is it worth special casing it?



---

archive/issue_comments_437934.json:
```json
{
    "body": "Maybe similar recipes for degree 3 and 4\nwould have acceptable speeds?\n\nRandom expressible-by-radicals algebraics of a\nwider range of degrees might be cheap-ish too?",
    "created_at": "2021-12-31T01:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437934",
    "user": "@slel"
}
```

Maybe similar recipes for degree 3 and 4
would have acceptable speeds?

Random expressible-by-radicals algebraics of a
wider range of degrees might be cheap-ish too?



---

archive/issue_comments_437935.json:
```json
{
    "body": "I think so. For example (this is on a faster machine):\n\n\n```\nsage: %timeit QQbar.random_element().real()\n1.17 ms \u00b1 7.19 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\n\nversus\n\n\n```\nsage: def random_AA(degree):\n....:     exponents = [0] + [1/k for k in range(1,degree+1)]\n....:     return sum( QQ.random_element()*AA(ZZ.random_element(0,10))^k\n....:                 for k in exponents )\n....:\nsage: %timeit random_AA(2)\n715 \u00b5s \u00b1 15 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\n\nThat's a subtly different kind of random, but does anyone care?",
    "created_at": "2021-12-31T02:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437935",
    "user": "@orlitzky"
}
```

I think so. For example (this is on a faster machine):


```
sage: %timeit QQbar.random_element().real()
1.17 ms ± 7.19 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


versus


```
sage: def random_AA(degree):
....:     exponents = [0] + [1/k for k in range(1,degree+1)]
....:     return sum( QQ.random_element()*AA(ZZ.random_element(0,10))^k
....:                 for k in exponents )
....:
sage: %timeit random_AA(2)
715 µs ± 15 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


That's a subtly different kind of random, but does anyone care?



---

archive/issue_comments_437936.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-04T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30638#issuecomment-437936",
    "user": "@vbraun"
}
```

Resolution: fixed
