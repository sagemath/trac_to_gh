# Issue 29544: properly catch exceptions in Dijkstra_Boost

Issue created by migration from https://trac.sagemath.org/ticket/29781

Original creator: dimpase

Original creation time: 2020-06-02 10:45:34

CC:  dcoudert arojas fbissey

with a recent Boost (1.73 on Gentoo) I see doctest errors like

```
File "src/sage/graphs/base/boost_graph.pyx", line 915, in sage.graphs.base.boost_graph.shortest_paths
Failed example:
    shortest_paths(g, 1, algorithm='Dijkstra')
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: Dijkstra algorithm does not work with negative weights, use Bellman-Ford instead
Got:
    terminate called after throwing an instance of 'boost::wrapexcept<boost::negative_edge>'
      what():  The graph may not contain an edge with negative weight.
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.base.boost_graph.shortest_paths[13]>", line 1, in <module>
        shortest_paths(g, Integer(1), algorithm='Dijkstra')
      File "sage/graphs/base/boost_graph.pyx", line 827, in sage.graphs.base.boost_graph.shortest_paths (build/cythonized/sage/graphs
/base/boost_graph.cpp:12063)
        cpdef shortest_paths(g, start, weight_function=None, algorithm=None):
      File "sage/graphs/base/boost_graph.pyx", line 983, in sage.graphs.base.boost_graph.shortest_paths (build/cythonized/sage/graphs
/base/boost_graph.cpp:11320)
        sig_on()
    RuntimeError: Aborted
```

we fix these by using proper try/catch block.


---

Comment by dimpase created at 2020-06-02 10:49:37

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-06-02 10:49:37

The diff, ignoring whitespace change, is just

```diff
--- a/src/sage/graphs/base/boost_graph.pyx
+++ b/src/sage/graphs/base/boost_graph.pyx
@@ -977,6 +977,7 @@ cpdef shortest_paths(g, start, weight_function=None, algorithm=None):
             raise ValueError("the graph contains a negative cycle")
 
     elif algorithm in ['Dijkstra', 'Dijkstra_Boost']:
+        try:
             if g.is_directed():
                 boost_weighted_graph_from_sage_graph(&g_boost_dir, g, v_to_int, weight_function)
                 vi = v_to_int[start]
@@ -991,6 +992,8 @@ cpdef shortest_paths(g, start, weight_function=None, algorithm=None):
                 sig_off()
             if not result.distances.size():
                 raise RuntimeError("Dijkstra algorithm does not work with negative weights, use Bellman-Ford instead")
+        except RuntimeError:
+            raise RuntimeError("Dijkstra algorithm does not work with negative weights, use Bellman-Ford instead")
 
     else:
         raise ValueError(f"unknown algorithm {algorithm!r}")
```



---

Comment by dcoudert created at 2020-06-02 10:56:12

LGTM.

I added a note in #29657 since the usage of weights must be strengthen in `boost_graph.pyx` and unified with other weighted methods.


---

Comment by dcoudert created at 2020-06-02 10:56:29

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-06-02 10:56:29

LGTM


---

Comment by vbraun created at 2020-06-05 22:12:30

Resolution: fixed
