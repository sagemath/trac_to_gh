# Issue 23053: Graph.merge_vertices() destroys loops

archive/issues_023053.json:
```json
{
    "body": "CC:  @dcoudert @tscrim stefan\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23290\n\n",
    "created_at": "2017-06-21T01:57:33Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Graph.merge_vertices() destroys loops",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23053",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```
CC:  @dcoudert @tscrim stefan



Issue created by migration from https://trac.sagemath.org/ticket/23290





---

archive/issue_comments_322000.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2017-06-21T02:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322000",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_322001.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-06-21T02:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322001",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_322002.json:
```json
{
    "body": "\n```\nsage: edgelist = [(0,0,'a'), (0,1,'b'), (1,1,'c')]\nsage: G = Graph(edgelist, loops=True, multiedges=True)\nsage: G.merge_vertices([0,1]); G.edges()\n[(0,0,'a')]\n```\n\n\nIt looks like merge_vertices() works by computing the edge boundary between the specified set of vertices and the rest of the graph, then deleting all the vertices except the first one, then putting the edges back in.\n\nSo there are actually two issues here. (1) Loops not on the first vertex will be lost (because they're not in the edge boundary and their vertices get deleted), and (2) we'll lose other edges that are not in the edge boundary so they should become loops.\n\n(1) is certainly a defect. I'm not so certain about (2) because I don't know if it's appropriate for this method to create loops. In fact, it's probably not.",
    "created_at": "2017-06-21T02:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322002",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```


```
sage: edgelist = [(0,0,'a'), (0,1,'b'), (1,1,'c')]
sage: G = Graph(edgelist, loops=True, multiedges=True)
sage: G.merge_vertices([0,1]); G.edges()
[(0,0,'a')]
```


It looks like merge_vertices() works by computing the edge boundary between the specified set of vertices and the rest of the graph, then deleting all the vertices except the first one, then putting the edges back in.

So there are actually two issues here. (1) Loops not on the first vertex will be lost (because they're not in the edge boundary and their vertices get deleted), and (2) we'll lose other edges that are not in the edge boundary so they should become loops.

(1) is certainly a defect. I'm not so certain about (2) because I don't know if it's appropriate for this method to create loops. In fact, it's probably not.



---

archive/issue_comments_322003.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2017-06-21T02:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322003",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Changing priority from major to minor.



---

archive/issue_comments_322004.json:
```json
{
    "body": "It is not an easy task to decide on the good behavior. See #10357 #9807 #7304 #7159.",
    "created_at": "2017-06-21T07:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322004",
    "user": "https://github.com/dcoudert"
}
```

It is not an easy task to decide on the good behavior. See #10357 #9807 #7304 #7159.



---

archive/issue_comments_322005.json:
```json
{
    "body": "In that case, I'll fix (1) and leave (2) for one of the other tickets.",
    "created_at": "2017-06-21T21:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322005",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

In that case, I'll fix (1) and leave (2) for one of the other tickets.



---

archive/issue_comments_322006.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-21T22:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322006",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_322007.json:
```json
{
    "body": "It now checks if any of the (di)graph's loops are on the vertices to be deleted before deleting them, and it only adds a few steps if loops are disabled.\n----\nNew commits:",
    "created_at": "2017-06-21T22:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322007",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

It now checks if any of the (di)graph's loops are on the vertices to be deleted before deleting them, and it only adds a few steps if loops are disabled.
----
New commits:



---

archive/issue_comments_322008.json:
```json
{
    "body": "Before this gets closed: There's code at the beginning of `merge_vertices()` to check if the first vertex label is `None`, but I don't think this will ever happen because of #9362. Should I take those lines out?\n\nNevermind. A user may wish to input `None` as the first item in the list because this will give the merged vertex a new name.",
    "created_at": "2017-06-22T17:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322008",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Before this gets closed: There's code at the beginning of `merge_vertices()` to check if the first vertex label is `None`, but I don't think this will ever happen because of #9362. Should I take those lines out?

Nevermind. A user may wish to input `None` as the first item in the list because this will give the merged vertex a new name.



---

archive/issue_comments_322009.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-23T04:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322009",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322010.json:
```json
{
    "body": "Works as advertised!",
    "created_at": "2017-06-23T04:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322010",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Works as advertised!



---

archive/issue_comments_322011.json:
```json
{
    "body": "This could be more efficient\n\n```\n        u = vertices[0]\n        for v in vertices[1:]:\n            if self.has_edge(v, v):\n                if self.allows_multiple_edges():\n                    for l in self.edge_label(v, v):\n                        self.add_edge(u, u, l)\n                else:\n                    self.add_edge(u, u, self.edge_label(v, v))\n```\n\n\n\nCould you add a test to do nothing when `len(vertices) < 2`.\n\n```\nsage: G = Graph()\nsage: G.merge_vertices([None])\nsage: G\nGraph on 1 vertex\nsage: G.merge_vertices([None])\nsage: G\nGraph on 2 vertices\n```\n\n\n\nOther issue: `TESTS::` -> `TESTS:`",
    "created_at": "2017-06-24T08:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322011",
    "user": "https://github.com/dcoudert"
}
```

This could be more efficient

```
        u = vertices[0]
        for v in vertices[1:]:
            if self.has_edge(v, v):
                if self.allows_multiple_edges():
                    for l in self.edge_label(v, v):
                        self.add_edge(u, u, l)
                else:
                    self.add_edge(u, u, self.edge_label(v, v))
```



Could you add a test to do nothing when `len(vertices) < 2`.

```
sage: G = Graph()
sage: G.merge_vertices([None])
sage: G
Graph on 1 vertex
sage: G.merge_vertices([None])
sage: G
Graph on 2 vertices
```



Other issue: `TESTS::` -> `TESTS:`



---

archive/issue_comments_322012.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-06-24T08:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322012",
    "user": "https://github.com/dcoudert"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_322013.json:
```json
{
    "body": "Also, when multiedges are not allowed, the behavior must be documented.\n\n```\nsage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c')]\nsage: G = Graph(edgelist, loops=True, multiedges=False)\nsage: G.merge_vertices([0,1]); G.edges()\n[(0, 0, 'c')]\nsage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c'), (1, 2, 'd'), (2, 2, 'e')]\nsage: G = Graph(edgelist, loops=True, multiedges=False)\nsage: G.merge_vertices([0,1,2]); G.edges()\n[(0, 0, 'e')]\nsage: G = Graph(edgelist, loops=True, multiedges=False)\nsage: G.merge_vertices([0,2,1]); G.edges()\n[(0, 0, 'e')]\n```\n",
    "created_at": "2017-06-24T08:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322013",
    "user": "https://github.com/dcoudert"
}
```

Also, when multiedges are not allowed, the behavior must be documented.

```
sage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c')]
sage: G = Graph(edgelist, loops=True, multiedges=False)
sage: G.merge_vertices([0,1]); G.edges()
[(0, 0, 'c')]
sage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c'), (1, 2, 'd'), (2, 2, 'e')]
sage: G = Graph(edgelist, loops=True, multiedges=False)
sage: G.merge_vertices([0,1,2]); G.edges()
[(0, 0, 'e')]
sage: G = Graph(edgelist, loops=True, multiedges=False)
sage: G.merge_vertices([0,2,1]); G.edges()
[(0, 0, 'e')]
```




---

archive/issue_comments_322014.json:
```json
{
    "body": "Replying to [comment:8 dcoudert]:\n> This could be more efficient\n> {{{\n>         u = vertices[0]\n>         for v in vertices[1:]:\n>             if self.has_edge(v, v):\n>                 if self.allows_multiple_edges():\n>                     for l in self.edge_label(v, v):\n>                         self.add_edge(u, u, l)\n>                 else:\n>                     self.add_edge(u, u, self.edge_label(v, v))\n> }}}\n\nIs this faster because it specifies the vertices, rather than iterating over a list of edges to get the loops?\n\n> \n> Could you add a test to do nothing when `len(vertices) < 2`.\n> {{{\n> sage: G = Graph()\n> sage: G.merge_vertices([None])\n> sage: G\n> Graph on 1 vertex\n> sage: G.merge_vertices([None])\n> sage: G\n> Graph on 2 vertices\n> }}}\n\nIt's an undocumented feature that `None` as the first entry will give the vertex a new name, and a bug that it will create a new vertex if there's nothing to merge. I'll addressed both.\n\n> Other issue: `TESTS::` -> `TESTS:`\n\nIs there a guide where I can see how to correctly mark up documentation? The developer's guide doesn't seem to cover it all, and many of the other methods I've looked at use `TESTS::` and not `TESTS:`. This doesn't seem to be a standard thing for Python docstrings so I'm not sure where to look.",
    "created_at": "2017-06-25T16:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322014",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Replying to [comment:8 dcoudert]:
> This could be more efficient
> {{{
>         u = vertices[0]
>         for v in vertices[1:]:
>             if self.has_edge(v, v):
>                 if self.allows_multiple_edges():
>                     for l in self.edge_label(v, v):
>                         self.add_edge(u, u, l)
>                 else:
>                     self.add_edge(u, u, self.edge_label(v, v))
> }}}

Is this faster because it specifies the vertices, rather than iterating over a list of edges to get the loops?

> 
> Could you add a test to do nothing when `len(vertices) < 2`.
> {{{
> sage: G = Graph()
> sage: G.merge_vertices([None])
> sage: G
> Graph on 1 vertex
> sage: G.merge_vertices([None])
> sage: G
> Graph on 2 vertices
> }}}

It's an undocumented feature that `None` as the first entry will give the vertex a new name, and a bug that it will create a new vertex if there's nothing to merge. I'll addressed both.

> Other issue: `TESTS::` -> `TESTS:`

Is there a guide where I can see how to correctly mark up documentation? The developer's guide doesn't seem to cover it all, and many of the other methods I've looked at use `TESTS::` and not `TESTS:`. This doesn't seem to be a standard thing for Python docstrings so I'm not sure where to look.



---

archive/issue_comments_322015.json:
```json
{
    "body": "Replying to [comment:10 zgershkoff]:\n> Replying to [comment:8 dcoudert]:\n> > This could be more efficient\n> > {{{\n> >         u = vertices[0]\n> >         for v in vertices[1:]:\n> >             if self.has_edge(v, v):\n> >                 if self.allows_multiple_edges():\n> >                     for l in self.edge_label(v, v):\n> >                         self.add_edge(u, u, l)\n> >                 else:\n> >                     self.add_edge(u, u, self.edge_label(v, v))\n> > }}}\n> \n> Is this faster because it specifies the vertices, rather than iterating over a list of edges to get the loops?\nThe `loop_edges` method calls the `loop_vertices` method which returns `[v for v in self if self.has_edge(v,v)]` if loops are allowed.\n\nSince `vertices` is a subset of the vertices of the graph, and we can expect this set to be small most of the time (e.g., 2), what I propose should be faster than your first proposal.\n\n \n \n\n> > Could you add a test to do nothing when `len(vertices) < 2`.\n \n> > {{{\n> > sage: G = Graph()\n> > sage: G.merge_vertices([None])\n> > sage: G\n> > Graph on 1 vertex\n> > sage: G.merge_vertices([None])\n> > sage: G\n> > Graph on 2 vertices\n> > }}}\n> \n> It's an undocumented feature that `None` as the first entry will give the vertex a new name, and a bug that it will create a new vertex if there's nothing to merge. I'll addressed both.\n\nIt's documented in the method, 3rd paragraph: `The new vertex is named after the first vertex in the list given in argument. If this first name is None, a new vertex is created.`\n  \n> > Other issue: `TESTS::` -> `TESTS:`\n> \n> Is there a guide where I can see how to correctly mark up documentation? The developer's guide doesn't seem to cover it all, and many of the other methods I've looked at use `TESTS::` and not `TESTS:`. This doesn't seem to be a standard thing for Python docstrings so I'm not sure where to look.\n\nTo be honest, I don't know. I checked on recent ticket, and #23255 suggests that `TESTS::` is the good form. So keep it as is.",
    "created_at": "2017-06-25T17:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322015",
    "user": "https://github.com/dcoudert"
}
```

Replying to [comment:10 zgershkoff]:
> Replying to [comment:8 dcoudert]:
> > This could be more efficient
> > {{{
> >         u = vertices[0]
> >         for v in vertices[1:]:
> >             if self.has_edge(v, v):
> >                 if self.allows_multiple_edges():
> >                     for l in self.edge_label(v, v):
> >                         self.add_edge(u, u, l)
> >                 else:
> >                     self.add_edge(u, u, self.edge_label(v, v))
> > }}}
> 
> Is this faster because it specifies the vertices, rather than iterating over a list of edges to get the loops?
The `loop_edges` method calls the `loop_vertices` method which returns `[v for v in self if self.has_edge(v,v)]` if loops are allowed.

Since `vertices` is a subset of the vertices of the graph, and we can expect this set to be small most of the time (e.g., 2), what I propose should be faster than your first proposal.

 
 

> > Could you add a test to do nothing when `len(vertices) < 2`.
 
> > {{{
> > sage: G = Graph()
> > sage: G.merge_vertices([None])
> > sage: G
> > Graph on 1 vertex
> > sage: G.merge_vertices([None])
> > sage: G
> > Graph on 2 vertices
> > }}}
> 
> It's an undocumented feature that `None` as the first entry will give the vertex a new name, and a bug that it will create a new vertex if there's nothing to merge. I'll addressed both.

It's documented in the method, 3rd paragraph: `The new vertex is named after the first vertex in the list given in argument. If this first name is None, a new vertex is created.`
  
> > Other issue: `TESTS::` -> `TESTS:`
> 
> Is there a guide where I can see how to correctly mark up documentation? The developer's guide doesn't seem to cover it all, and many of the other methods I've looked at use `TESTS::` and not `TESTS:`. This doesn't seem to be a standard thing for Python docstrings so I'm not sure where to look.

To be honest, I don't know. I checked on recent ticket, and #23255 suggests that `TESTS::` is the good form. So keep it as is.



---

archive/issue_comments_322016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-25T18:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322017.json:
```json
{
    "body": "Replying to [comment:11 dcoudert]:\n> To be honest, I don't know. I checked on recent ticket, and #23255 suggests that `TESTS::` is the good form. So keep it as is.\n\nJudging from that ticket, the convention is to use `::` when `sage:` follows and `:` when text follows. So in this instance, I should indeed use `TESTS:`. The usage isn't consistent throughout the file but I'm not going to try and fix it within this ticket.\n\nI made the changes you suggested, but I had to change one of the tests:\n\n\n```\nsage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c'), (1, 2, 'd'), (2, 2, 'e')]\nsage: G = Graph(edgelist, loops=True, multiedges=False)\nsage: G.merge_vertices([0,1,2]); G.edges()\n[(0, 0, 'e')]\nsage: G = Graph(edgelist, loops=True, multiedges=False)\nsage: G.merge_vertices([0,2,1]); G.edges()\n[(0, 0, 'e')]\n```\n\n\nI think the last output should be `[(0, 0, 'c')]`, and that's what the code currently returns, since it evaluates vertex `1` last and finds the label `'c'` last.",
    "created_at": "2017-06-25T18:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322017",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Replying to [comment:11 dcoudert]:
> To be honest, I don't know. I checked on recent ticket, and #23255 suggests that `TESTS::` is the good form. So keep it as is.

Judging from that ticket, the convention is to use `::` when `sage:` follows and `:` when text follows. So in this instance, I should indeed use `TESTS:`. The usage isn't consistent throughout the file but I'm not going to try and fix it within this ticket.

I made the changes you suggested, but I had to change one of the tests:


```
sage: edgelist = [(0,0,'a'),(0,1,'b'),(1,1,'c'), (1, 2, 'd'), (2, 2, 'e')]
sage: G = Graph(edgelist, loops=True, multiedges=False)
sage: G.merge_vertices([0,1,2]); G.edges()
[(0, 0, 'e')]
sage: G = Graph(edgelist, loops=True, multiedges=False)
sage: G.merge_vertices([0,2,1]); G.edges()
[(0, 0, 'e')]
```


I think the last output should be `[(0, 0, 'c')]`, and that's what the code currently returns, since it evaluates vertex `1` last and finds the label `'c'` last.



---

archive/issue_comments_322018.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-25T18:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322018",
    "user": "https://trac.sagemath.org/admin/accounts/users/zgershkoff"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322019.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-25T19:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322019",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322020.json:
```json
{
    "body": "That's much better now. Thanks.",
    "created_at": "2017-06-25T19:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322020",
    "user": "https://github.com/dcoudert"
}
```

That's much better now. Thanks.



---

archive/issue_events_021651.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-26T21:24:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23053#event-21651"
}
```



---

archive/issue_comments_322021.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-26T21:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23053#issuecomment-322021",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
