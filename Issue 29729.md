# Issue 29729: integrate(sqrt(x + sqrt(x)), x, algorithm='giac') raises RuntimeError

archive/issues_029729.json:
```json
{
    "body": "CC:  chapoton dimpase frederichan parisse slabbe slelievre\n\nFrom https://ask.sagemath.org/question/50885/is-there-a-way-to-integrate-sqrtxsqrtx-in-sage/, the command\n\n```\nsage: integrate(sqrt(x + sqrt(x)), x, algorithm='giac')\n```\n\nreturns\n\n```\nTraceback (most recent call last):\n...\nAttributeError: \n...\nDuring handling of the above exception, another exception occurred:\n...\nRuntimeError: An error occurred running a Giac command:\nINPUT:\nsage2\nOUTPUT:\nWarning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [-97]\nWarning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.\nThe choice was done assuming [x]=[9]\nWarning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.\nThe choice was done assuming [x]=[54]\n  ***   bug in PARI/GP (Bus Error), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value\nWarning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.\nThe choice was done assuming [x]=[64]\n\n  ***   bug in PARI/GP (Segmentation Fault), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value\n\n  ***   bug in PARI/GP (Segmentation Fault), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value\n\n  ***   Warning: normalizing a polynomial with 0 leading term.\n  ***   Warning: normalizing a polynomial with 0 leading term.\nWarning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [6.38357630698]\n  ***   Warning: normalizing a polynomial with 0 leading term.\n  ***   Warning: normalizing a polynomial with 0 leading term.\nWarning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [82.1195442914]\n2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(sqrt(4*sqrt(x)+1-4*sqrt(x)*cos((pi*sign(im(sqrt(x)))*sign(x+re(sqrt(x)))-pi*sign(im(sqrt(x)))-2*atan(im(sqrt(x))/(x+re(sqrt(x)))))/2)+rootof([[-4,-4,0],[1,0,0,4*x,4*x^2-x]])*cos(1/2*(atan(im(sqrt(x))/(x+re(sqrt(x))))+(1-sign(x+re(sqrt(x))))*sign(im(sqrt(x)))*pi/2)))))\n```\n\nThis was not fixed by #28913.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29966\n\n",
    "created_at": "2020-06-24T20:16:09Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "integrate(sqrt(x + sqrt(x)), x, algorithm='giac') raises RuntimeError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29729",
    "user": "slabbe"
}
```
CC:  chapoton dimpase frederichan parisse slabbe slelievre

From https://ask.sagemath.org/question/50885/is-there-a-way-to-integrate-sqrtxsqrtx-in-sage/, the command

```
sage: integrate(sqrt(x + sqrt(x)), x, algorithm='giac')
```

returns

```
Traceback (most recent call last):
...
AttributeError: 
...
During handling of the above exception, another exception occurred:
...
RuntimeError: An error occurred running a Giac command:
INPUT:
sage2
OUTPUT:
Warning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [-97]
Warning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.
The choice was done assuming [x]=[9]
Warning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.
The choice was done assuming [x]=[54]
  ***   bug in PARI/GP (Bus Error), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value
Warning, need to choose a branch for the root of a polynomial with parameters. This might be wrong.
The choice was done assuming [x]=[64]

  ***   bug in PARI/GP (Segmentation Fault), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value

  ***   bug in PARI/GP (Segmentation Fault), please report.sym2poly exception caught Error in PARI subsystem Error: Bad Argument Value

  ***   Warning: normalizing a polynomial with 0 leading term.
  ***   Warning: normalizing a polynomial with 0 leading term.
Warning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [6.38357630698]
  ***   Warning: normalizing a polynomial with 0 leading term.
  ***   Warning: normalizing a polynomial with 0 leading term.
Warning, choosing root of [1,0,0,%%%{4,[1]%%%},%%%{4,[2]%%%}+%%%{-1,[1]%%%}] at parameters values [82.1195442914]
2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(sqrt(4*sqrt(x)+1-4*sqrt(x)*cos((pi*sign(im(sqrt(x)))*sign(x+re(sqrt(x)))-pi*sign(im(sqrt(x)))-2*atan(im(sqrt(x))/(x+re(sqrt(x)))))/2)+rootof([[-4,-4,0],[1,0,0,4*x,4*x^2-x]])*cos(1/2*(atan(im(sqrt(x))/(x+re(sqrt(x))))+(1-sign(x+re(sqrt(x))))*sign(im(sqrt(x)))*pi/2)))))
```

This was not fixed by #28913.

Issue created by migration from https://trac.sagemath.org/ticket/29966





---

archive/issue_comments_422304.json:
```json
{
    "body": "Changing keywords from \"\" to \"integral\".",
    "created_at": "2020-09-24T15:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422304",
    "user": "chapoton"
}
```

Changing keywords from "" to "integral".



---

archive/issue_comments_422305.json:
```json
{
    "body": "Changing keywords from \"integral\" to \"integral, giac, pari\".",
    "created_at": "2021-01-03T14:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422305",
    "user": "slelievre"
}
```

Changing keywords from "integral" to "integral, giac, pari".



---

archive/issue_comments_422306.json:
```json
{
    "body": "Now returns\n\n```\n2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(abs(2*(sqrt(x+sqrt(x))-sqrt(x))-1)))\n```\n\nabs inside the ln was ineffective",
    "created_at": "2021-01-03T16:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422306",
    "user": "parisse"
}
```

Now returns

```
2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(abs(2*(sqrt(x+sqrt(x))-sqrt(x))-1)))
```

abs inside the ln was ineffective



---

archive/issue_comments_422307.json:
```json
{
    "body": "dans quelle version de giac ?",
    "created_at": "2021-01-03T17:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422307",
    "user": "chapoton"
}
```

dans quelle version de giac ?



---

archive/issue_comments_422308.json:
```json
{
    "body": "[https://dev.geogebra.org/trac/changeset/69712/#file1](https://dev.geogebra.org/trac/changeset/69712/#file1)",
    "created_at": "2021-01-03T17:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422308",
    "user": "parisse"
}
```

[https://dev.geogebra.org/trac/changeset/69712/#file1](https://dev.geogebra.org/trac/changeset/69712/#file1)



---

archive/issue_comments_422309.json:
```json
{
    "body": "Do we know the version of some release of giac which will solve the bug?\n\nThe current version with the bug is:\n\n```\n$ sage -standard | grep giac\ngiac....................................1.5.0.87p2.p1 (1.5.0.87p2.p1)\n```\n",
    "created_at": "2021-01-06T09:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422309",
    "user": "slabbe"
}
```

Do we know the version of some release of giac which will solve the bug?

The current version with the bug is:

```
$ sage -standard | grep giac
giac....................................1.5.0.87p2.p1 (1.5.0.87p2.p1)
```




---

archive/issue_comments_422310.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422310",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_422311.json:
```json
{
    "body": "Parsing warnings from giac would make sense. Do they always are of the form\n\n```\nWarning, {msg}\\n\n```\n",
    "created_at": "2021-05-17T08:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422311",
    "user": "vdelecroix"
}
```

Parsing warnings from giac would make sense. Do they always are of the form

```
Warning, {msg}\n
```




---

archive/issue_comments_422312.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-29T09:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422312",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_422313.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-29T09:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422313",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422314.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-29T17:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422314",
    "user": "slelievre"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422315.json:
```json
{
    "body": "Thanks for adding this doctest.",
    "created_at": "2021-08-29T17:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422315",
    "user": "slelievre"
}
```

Thanks for adding this doctest.



---

archive/issue_comments_422316.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-08-31T22:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422316",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_422317.json:
```json
{
    "body": "This fails with giac 1.7:\n\n```\nFile \"/usr/lib/python3.9/site-packages/sage/symbolic/integration/external.py\", line 247, in sage.symbolic.integration.external.giac_integrator\nFailed example:\n    giac_integrator(sqrt(x + sqrt(x)), x)\nExpected:\n    1/12*(2*sqrt(x)*(4*sqrt(x) + 1) - 3)*sqrt(x + sqrt(x))\n    - 1/8*log(abs(2*sqrt(x + sqrt(x)) - 2*sqrt(x) - 1))\nGot:\n    1/12*(2*sqrt(x)*(4*sqrt(x) + 1) - 3)*sqrt(x + sqrt(x)) - 1/8*log(-2*sqrt(x + sqrt(x)) + 2*sqrt(x) + 1)\n```\n",
    "created_at": "2021-09-01T16:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422317",
    "user": "arojas"
}
```

This fails with giac 1.7:

```
File "/usr/lib/python3.9/site-packages/sage/symbolic/integration/external.py", line 247, in sage.symbolic.integration.external.giac_integrator
Failed example:
    giac_integrator(sqrt(x + sqrt(x)), x)
Expected:
    1/12*(2*sqrt(x)*(4*sqrt(x) + 1) - 3)*sqrt(x + sqrt(x))
    - 1/8*log(abs(2*sqrt(x + sqrt(x)) - 2*sqrt(x) - 1))
Got:
    1/12*(2*sqrt(x)*(4*sqrt(x) + 1) - 3)*sqrt(x + sqrt(x)) - 1/8*log(-2*sqrt(x + sqrt(x)) + 2*sqrt(x) + 1)
```




---

archive/issue_comments_422318.json:
```json
{
    "body": "I've opened #32449 for this",
    "created_at": "2021-09-01T21:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29729#issuecomment-422318",
    "user": "mkoeppe"
}
```

I've opened #32449 for this
