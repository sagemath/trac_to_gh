# Issue 30425: Update conda package information

Issue created by migration from https://trac.sagemath.org/ticket/30662

Original creator: mkoeppe

Original creation time: 2020-09-25 14:36:40

CC:  dimpase isuruf

1) `build/pkgs/conda.txt` still has `"python<3.8"`

2) Some trouble involving libpng as reported in https://groups.google.com/d/msg/sage-devel/LMFRiG9Y0ZM/1FIyE5P4CAAJ




---

Comment by dimpase created at 2020-09-25 15:12:58

yes, I'm currently trying to reproduce this, and ran so far into a similar error.
I am not sure whether there  always was the recommendation to use Conda's compilers, 
c-compiler, cxx-compiler, and fortran-compiler.

What I see atm is

```
libtool: compile:  /home/scratch2/dimpase/miniconda3/bin/x86_64-conda-linux-gnu-cc -DPACKAGE_NAME=\"libhomfly\" -DPACKAGE_TARNAME=\"libhomfly\" -DPACKAGE_VERSION=\"1.02r6\" "-DPACKAGE_STRING=\"libhomfly 1.02r6\"" -DPACKAGE_BUGREPORT=\"mmarco@unizar.es\" -DPACKAGE_URL=\"\" -DPACKAGE=\"libhomfly\" -DVERSION=\"1.02r6\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -I. -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /home/scratch2/dimpase/miniconda3/include -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /home/scratch2/dimpase/miniconda3/include -c control.c  -fPIC -DPIC -o .libs/control.o
bound.c:10:10: fatal error: gc.h: No such file or directory
 #include <gc.h>
          ^~~~~~
}}} 
in
{{{
Setting up build directory for libhomfly-1.02r6
Finished extraction
No patch files found in ../patches
****************************************************
Host system:
Linux clpc171.cs.ox.ac.uk 5.2.18-200.fc30.x86_64 #1 SMP Tue Oct 1 13:14:07 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
****************************************************
C compiler: /home/scratch2/dimpase/miniconda3/bin/x86_64-conda-linux-gnu-cc
C compiler version:
Reading specs from /home/scratch2/dimpase/miniconda3/bin/../lib/gcc/x86_64-conda-linux-gnu/7.5.0/specs
COLLECT_GCC=/home/scratch2/dimpase/miniconda3/bin/x86_64-conda-linux-gnu-cc
COLLECT_LTO_WRAPPER=/home/scratch2/dimpase/miniconda3/bin/../libexec/gcc/x86_64-conda-linux-gnu/7.5.0/lto-wrapper
Target: x86_64-conda-linux-gnu
Configured with: /home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/.build/x86_64-conda-linux-gnu/src/gcc/configure --build=x86_64-build_pc-linux-gnu --host=x86_64-build_pc-linux-gnu --target=x86_64-conda-linux-gnu --prefix=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/gcc_built --with-sysroot=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/gcc_built/x86_64-conda-linux-gnu/sysroot --enable-languages=c,c++,fortran,objc,obj-c++ --with-pkgversion='crosstool-NG 1.24.0.131_87df0e6_dirty' --enable-__cxa_atexit --disable-libmudflap --enable-libgomp --disable-libssp --enable-libquadmath --enable-libquadmath-support --enable-libsanitizer --enable-libmpx --with-gmp=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/.build/x86_64-conda-linux-gnu/buildtools --with-mpfr=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/.build/x86_64-conda-linux-gnu/buildtools --with-mpc=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/.build/x86_64-conda-linux-gnu/buildtools --with-isl=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/.build/x86_64-conda-linux-gnu/buildtools --enable-lto --enable-threads=posix --enable-target-optspace --enable-plugin --enable-gold --disable-nls --disable-multilib --with-local-prefix=/home/conda/feedstock_root/build_artifacts/ctng-compilers_1598124794965/work/gcc_built/x86_64-conda-linux-gnu/sysroot --enable-long-long --enable-default-pie
Thread model: posix
gcc version 7.5.0 (crosstool-NG 1.24.0.131_87df0e6_dirty) 
...
}}}

yes, this one is probably fixable by installing conda gc package (if there is one) - but the question is why the compiler does not want to see anything in /usr/include?

(here Sage is configured to use system gc package)


---

Comment by isuruf created at 2020-09-25 15:18:19

> but the question is why the compiler does not want to see anything in /usr/include? 

This is intentional with the compilers shipped by conda. Mixing system packages and conda packages almost always breaks stuff. (For eg: the pillow issue `@`mkoeppe had). You need to add `-I/usr/include` for the compiler to find it.

> (here Sage is configured to use system gc package)

How did sage find the system gc package if the compiler doesn't? Does sage by default look in `/usr/include`?


---

Comment by dimpase created at 2020-09-25 15:37:03

Replying to [comment:2 isuruf]:
> > but the question is why the compiler does not want to see anything in /usr/include? 
> 
> This is intentional with the compilers shipped by conda. Mixing system packages and conda packages almost always breaks stuff. (For eg: the pillow issue `@`mkoeppe had). You need to add `-I/usr/include` for the compiler to find it.
> 
> > (here Sage is configured to use system gc package)
> 
> How did sage find the system gc package if the compiler doesn't? Does sage by default look in `/usr/include`?

it's done by calling autoconf macro `PKG_CHECK_MODULES`, which basically calls pkg-config and checks the version. Discovering that `gc.h` is not easy, as `$pkg-config -cflags bdw-gc`
does not return anything. (Arguably it is a `bdw-gc` bug, but it does not make it easier).


---

Comment by dimpase created at 2020-09-25 15:59:15

one can do something like

```
$ pkg-config --variable=includedir bdw-gc
/usr/include
```

or from the autoconf is would be `PKG_CHECK_VAR([GCINCLUDEDIR],[bdw-gc], [includedir])`


---

Comment by dimpase created at 2020-09-25 16:39:05

another sort of trouble is coming from pkg-config not looking in <conda-root>/lib/pkgconfig

this is something that leads to a problem in buidling linbox, if fflas-ffpack is installed in conda

Something in `build/pkgs/pkgconf/spkg-configure.m4` should be fixed. It has

```
       AC_SUBST(SAGE_PKG_CONFIG_PATH, ['$SAGE_LOCAL/lib/pkgconfig'])
```

so the list should be extended with `<conda-root>/lib/pkgconfig`. So this leads the questions:

1. how to find out in autoconf that we're on Conda
2. how to find <conda-root>


---

Comment by dimpase created at 2020-09-25 16:42:59

Replying to [comment:4 dimpase]:
> one can do something like
> {{{
> $ pkg-config --variable=includedir bdw-gc
> /usr/include
> }}}
> or from the autoconf is would be `PKG_CHECK_VAR([GCINCLUDEDIR],[bdw-gc], [includedir])`
> 
there is even a gh issue for this: https://github.com/miguelmarco/libhomfly/issues/10


---

Comment by dimpase created at 2020-09-25 17:16:35

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2020-09-25 17:30:02

Replying to [comment:5 dimpase]:
> another sort of trouble is coming from pkg-config not looking in <conda-root>/lib/pkgconfig

Which pkg-config is that?


---

Comment by dimpase created at 2020-09-25 17:54:28

Replying to [comment:8 mkoeppe]:
> Replying to [comment:5 dimpase]:
> > another sort of trouble is coming from pkg-config not looking in <conda-root>/lib/pkgconfig
> 
> Which pkg-config is that?

the system's one. Perhaps installing conda's pkg-config (if it has one) is an easier way out.

One more thing: 
there is a similar to libgc problem with libgd, which is used only in sagelib.
(headers and the dylib are not found at /usr/ by conda's compiler and linker)


---

Comment by mkoeppe created at 2020-09-25 17:58:18

Replying to [comment:9 dimpase]:
> Replying to [comment:8 mkoeppe]:
> > Replying to [comment:5 dimpase]:
> > > another sort of trouble is coming from pkg-config not looking in <conda-root>/lib/pkgconfig
> > 
> > Which pkg-config is that?
> 
> the system's one. Perhaps installing conda's pkg-config (if it has one) is an easier way out.

Yes, it is already listed in `build/pkgs/conda-bootstrap.txt`. Probably should add somewhere else too.


---

Comment by mkoeppe created at 2020-09-25 17:58:57

Replying to [comment:5 dimpase]:
> 1. how to find out in autoconf that we're on Conda
> 2. how to find <conda-root>

Basically, don't.


---

Comment by git created at 2020-09-25 18:00:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-25 18:04:42

We could also extend `m4/sage_check_conda_compilers.m4` to make it a hard error if conda's pkg-config is not installed.


---

Comment by git created at 2020-09-25 18:39:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-25 18:59:28

configure doesn't work:

```
...
checking whether a conda environment is active... yes
configure: error: A conda environment (base) is active, but
the pkg-config command is not provided by the conda environment,
which indicates that the conda environment is missing
the following conda packages required for building Sage:
     pkg-config
For building Sage, either:
- activate a conda environment that has these packages, using:
    conda activate ENVIRONMENT
- or install these conda packages, using
    conda install  pkg-config
- or deactivate conda by
    conda deactivate
  (this command may need to be repeated).
(base) clpc171[/home/scratch2/dimpase/miniconda3/sage]$ 
(base) clpc171[/home/scratch2/dimpase/miniconda3/sage]$ which pkg-config
pkg-config is /home/scratch2/dimpase/miniconda3/bin/pkg-config
```



---

Comment by dimpase created at 2020-09-25 19:05:29

maybe because conda installs a script pkg-config and a binary pkg-config.bin (at least on Linux this is the case)


---

Comment by git created at 2020-09-25 19:45:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-25 19:45:47

Here's a better version (only tested on macOS)


---

Comment by dimpase created at 2020-09-25 20:34:27

OK, this works, but how about adding `pkg-config` to `build/pkgs/conda.txt`, in order to make sure it's not missing?


---

Comment by git created at 2020-09-25 20:48:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-25 20:48:24

Good idea, done.


---

Comment by mkoeppe created at 2020-09-25 21:00:10

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-25 21:03:36

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-09-25 21:03:36

lgtm


---

Comment by mkoeppe created at 2020-09-25 21:04:12

Thanks!


---

Comment by isuruf created at 2020-09-25 21:07:23

Btw, we need to add `bdw-gc` to `build/pkgs/gc/distros/conda.txt`


---

Comment by git created at 2020-09-25 21:09:06

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-09-25 21:09:06

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by isuruf created at 2020-09-25 21:10:07

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-25 21:29:45

I'm getting 

```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG libatomic_ops...
checking for atomic_ops >= 7.6.2... no
configure: no suitable system package found for SPKG libatomic_ops
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG gc...
checking whether any of libatomic_ops is installed as or will be installed as SPKG... yes; install gc as well
configure: no suitable system package found for SPKG gc
-----------------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2020-09-25 21:39:39

(previously discussed in #28991)


---

Comment by git created at 2020-09-25 21:49:18

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-09-25 21:49:18

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-09-25 21:49:29

Trying now with this change.


---

Comment by mkoeppe created at 2020-09-25 21:50:38


```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG libatomic_ops...
checking for atomic_ops >= 7.6.2... yes
configure: will use system package and not install SPKG libatomic_ops
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG gc...
checking whether any of libatomic_ops is installed as or will be installed as SPKG... no
checking for bdw-gc-threaded >= 7.6.4... no
checking for bdw-gc >= 7.6.4... yes
configure: will use system package and not install SPKG gc
```



---

Comment by mkoeppe created at 2020-09-25 22:47:38

`tox -e docker-conda-forge-standard` builds without problem now.


---

Comment by isuruf created at 2020-09-25 22:49:31

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2020-09-25 22:49:31

Thanks


---

Comment by vbraun created at 2020-09-30 22:30:25

Resolution: fixed
