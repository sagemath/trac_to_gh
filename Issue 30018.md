# Issue 30018: FiniteRankFreeModule: Move all module identifications to methods exterior_power, dual_exterior_power, tensor_module

Issue created by migration from https://trac.sagemath.org/ticket/30255

Original creator: mkoeppe

Original creation time: 2020-07-30 17:41:32

CC:  egourgoulhon tscrim @mjungmath

Currently, the identification of a base module `M` with `M.tensor_module(1, 0)` and `M.exterior_power(1)` is implemented in `FiniteRankFreeModule.__init__` but the identification of `M.base_ring()` with `M.exterior_power(0)` is implemented in `exterior_power`.

In this ticket, we move all identifications to the methods `tensor_module`, `exterior_power`, `dual_exterior_power`.

We also rewrite these methods in try/except style.




---

Comment by mkoeppe created at 2020-07-30 18:29:55

New commits:


---

Comment by mkoeppe created at 2020-07-30 18:29:55

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-30 18:31:04

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-07-30 18:36:07

Ha! This one did not pass the `sage.manifolds` doctests. Hold on...


---

Comment by git created at 2020-07-30 18:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-30 18:53:00

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-30 19:02:21

The code duplication between these three methods of `FiniteRankFreeModule` and `VectorFieldFreeModule` could of course be removed by using class attributes `_exterior_power_class`, `_exterior_dual_power_class`, `_tensor_module_class`. I can do that on a follow-up ticket if you like.


---

Comment by egourgoulhon created at 2020-07-30 20:35:41

Thanks for this cleaning. 

What is the advantage of 

```
try:
    return d[k]
except KeyError:
    d[k] = ...
    return d[k]
```

over

```
if k not in d:
    d[k] = ...
return d[k]
```

?
The latter looks easier to read.


---

Comment by mkoeppe created at 2020-07-30 22:05:55

It's more than twice as fast in the fast path.

before:

```
sage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: sage: M.exterior_power(2)
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %timeit M.exterior_power(2)
The slowest run took 9.54 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 5: 2.23 µs per loop
```


after:

```
sage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: sage: M.exterior_power(2)
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %timeit M.exterior_power(2)
The slowest run took 13.09 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 5: 929 ns per loop
```



---

Comment by tscrim created at 2020-07-30 23:53:37

How does it compare in the slow path?


---

Comment by mkoeppe created at 2020-07-31 00:07:05

The slow path is 2 orders of magnitude slower than the fast path because a heavy weight object is created:

```
sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: %time M.exterior_power(1)
CPU times: user 729 µs, sys: 692 µs, total: 1.42 ms
Wall time: 891 µs
Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(2)
CPU times: user 685 µs, sys: 18 µs, total: 703 µs
Wall time: 707 µs
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(3)
CPU times: user 239 µs, sys: 11 µs, total: 250 µs
Wall time: 254 µs
3rd exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(4)
CPU times: user 229 µs, sys: 0 ns, total: 229 µs
Wall time: 233 µs
4th exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(5)
CPU times: user 269 µs, sys: 14 µs, total: 283 µs
Wall time: 303 µs
5th exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(0)
CPU times: user 15 µs, sys: 1 µs, total: 16 µs
Wall time: 16.7 µs
Integer Ring
```

So whatever the changes to this method do does not matter for the slow path.


---

Comment by egourgoulhon created at 2020-07-31 20:59:53

Replying to [comment:10 mkoeppe]:
> It's more than twice as fast in the fast path.
> 
Thanks for the explanation.


---

Comment by mkoeppe created at 2020-08-04 19:44:56

Ready for review


---

Comment by @mjungmath created at 2020-08-06 10:21:00

Very nice changes.

First, the import in the doctest is obsolete now:


```diff
- sage: from sage.tensor.modules.tensor_free_module import TensorFreeModule
```


More comments follow...


---

Comment by @mjungmath created at 2020-08-06 10:57:12

No okay, that's all. LGTM.


---

Comment by @mjungmath created at 2020-08-06 10:57:12

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2020-08-06 10:58:12

Sorry. I'll give positive review when the line is removed.


---

Comment by @mjungmath created at 2020-08-06 10:58:12

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-08-06 11:32:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-08-06 16:26:48

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2020-08-06 16:26:48

LGTM. Patchbot is now full green, too.


---

Comment by mkoeppe created at 2020-08-06 16:51:45

Thanks!


---

Comment by vbraun created at 2020-08-09 08:47:27

Resolution: fixed
