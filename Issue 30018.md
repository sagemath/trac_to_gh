# Issue 30018: FiniteRankFreeModule: Move all module identifications to methods exterior_power, dual_exterior_power, tensor_module

archive/issues_030018.json:
```json
{
    "body": "CC:  egourgoulhon tscrim @mjungmath\n\nCurrently, the identification of a base module `M` with `M.tensor_module(1, 0)` and `M.exterior_power(1)` is implemented in `FiniteRankFreeModule.__init__` but the identification of `M.base_ring()` with `M.exterior_power(0)` is implemented in `exterior_power`.\n\nIn this ticket, we move all identifications to the methods `tensor_module`, `exterior_power`, `dual_exterior_power`.\n\nWe also rewrite these methods in try/except style.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30255\n\n",
    "created_at": "2020-07-30T17:41:32Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "title": "FiniteRankFreeModule: Move all module identifications to methods exterior_power, dual_exterior_power, tensor_module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30018",
    "user": "mkoeppe"
}
```
CC:  egourgoulhon tscrim @mjungmath

Currently, the identification of a base module `M` with `M.tensor_module(1, 0)` and `M.exterior_power(1)` is implemented in `FiniteRankFreeModule.__init__` but the identification of `M.base_ring()` with `M.exterior_power(0)` is implemented in `exterior_power`.

In this ticket, we move all identifications to the methods `tensor_module`, `exterior_power`, `dual_exterior_power`.

We also rewrite these methods in try/except style.



Issue created by migration from https://trac.sagemath.org/ticket/30255





---

archive/issue_comments_426719.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-30T18:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426719",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_426720.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-30T18:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426720",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_426721.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-30T18:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426721",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_426722.json:
```json
{
    "body": "Ha! This one did not pass the `sage.manifolds` doctests. Hold on...",
    "created_at": "2020-07-30T18:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426722",
    "user": "mkoeppe"
}
```

Ha! This one did not pass the `sage.manifolds` doctests. Hold on...



---

archive/issue_comments_426723.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T18:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426723",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426724.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-30T18:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426724",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_426725.json:
```json
{
    "body": "The code duplication between these three methods of `FiniteRankFreeModule` and `VectorFieldFreeModule` could of course be removed by using class attributes `_exterior_power_class`, `_exterior_dual_power_class`, `_tensor_module_class`. I can do that on a follow-up ticket if you like.",
    "created_at": "2020-07-30T19:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426725",
    "user": "mkoeppe"
}
```

The code duplication between these three methods of `FiniteRankFreeModule` and `VectorFieldFreeModule` could of course be removed by using class attributes `_exterior_power_class`, `_exterior_dual_power_class`, `_tensor_module_class`. I can do that on a follow-up ticket if you like.



---

archive/issue_comments_426726.json:
```json
{
    "body": "Thanks for this cleaning. \n\nWhat is the advantage of \n\n```\ntry:\n    return d[k]\nexcept KeyError:\n    d[k] = ...\n    return d[k]\n```\n\nover\n\n```\nif k not in d:\n    d[k] = ...\nreturn d[k]\n```\n\n?\nThe latter looks easier to read.",
    "created_at": "2020-07-30T20:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426726",
    "user": "egourgoulhon"
}
```

Thanks for this cleaning. 

What is the advantage of 

```
try:
    return d[k]
except KeyError:
    d[k] = ...
    return d[k]
```

over

```
if k not in d:
    d[k] = ...
return d[k]
```

?
The latter looks easier to read.



---

archive/issue_comments_426727.json:
```json
{
    "body": "It's more than twice as fast in the fast path.\n\nbefore:\n\n```\nsage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')\nsage: sage: M.exterior_power(2)\n2nd exterior power of the Rank-3 free module M over the Integer Ring\nsage: %timeit M.exterior_power(2)\nThe slowest run took 9.54 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 5: 2.23 \u00b5s per loop\n```\n\n\nafter:\n\n```\nsage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')\nsage: sage: M.exterior_power(2)\n2nd exterior power of the Rank-3 free module M over the Integer Ring\nsage: %timeit M.exterior_power(2)\nThe slowest run took 13.09 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 5: 929 ns per loop\n```\n",
    "created_at": "2020-07-30T22:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426727",
    "user": "mkoeppe"
}
```

It's more than twice as fast in the fast path.

before:

```
sage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: sage: M.exterior_power(2)
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %timeit M.exterior_power(2)
The slowest run took 9.54 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 5: 2.23 µs per loop
```


after:

```
sage: sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: sage: M.exterior_power(2)
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %timeit M.exterior_power(2)
The slowest run took 13.09 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 5: 929 ns per loop
```




---

archive/issue_comments_426728.json:
```json
{
    "body": "How does it compare in the slow path?",
    "created_at": "2020-07-30T23:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426728",
    "user": "tscrim"
}
```

How does it compare in the slow path?



---

archive/issue_comments_426729.json:
```json
{
    "body": "The slow path is 2 orders of magnitude slower than the fast path because a heavy weight object is created:\n\n```\nsage: M = FiniteRankFreeModule(ZZ, 3, name='M')\nsage: %time M.exterior_power(1)\nCPU times: user 729 \u00b5s, sys: 692 \u00b5s, total: 1.42 ms\nWall time: 891 \u00b5s\nRank-3 free module M over the Integer Ring\nsage: %time M.exterior_power(2)\nCPU times: user 685 \u00b5s, sys: 18 \u00b5s, total: 703 \u00b5s\nWall time: 707 \u00b5s\n2nd exterior power of the Rank-3 free module M over the Integer Ring\nsage: %time M.exterior_power(3)\nCPU times: user 239 \u00b5s, sys: 11 \u00b5s, total: 250 \u00b5s\nWall time: 254 \u00b5s\n3rd exterior power of the Rank-3 free module M over the Integer Ring\nsage: %time M.exterior_power(4)\nCPU times: user 229 \u00b5s, sys: 0 ns, total: 229 \u00b5s\nWall time: 233 \u00b5s\n4th exterior power of the Rank-3 free module M over the Integer Ring\nsage: %time M.exterior_power(5)\nCPU times: user 269 \u00b5s, sys: 14 \u00b5s, total: 283 \u00b5s\nWall time: 303 \u00b5s\n5th exterior power of the Rank-3 free module M over the Integer Ring\nsage: %time M.exterior_power(0)\nCPU times: user 15 \u00b5s, sys: 1 \u00b5s, total: 16 \u00b5s\nWall time: 16.7 \u00b5s\nInteger Ring\n```\n\nSo whatever the changes to this method do does not matter for the slow path.",
    "created_at": "2020-07-31T00:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426729",
    "user": "mkoeppe"
}
```

The slow path is 2 orders of magnitude slower than the fast path because a heavy weight object is created:

```
sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: %time M.exterior_power(1)
CPU times: user 729 µs, sys: 692 µs, total: 1.42 ms
Wall time: 891 µs
Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(2)
CPU times: user 685 µs, sys: 18 µs, total: 703 µs
Wall time: 707 µs
2nd exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(3)
CPU times: user 239 µs, sys: 11 µs, total: 250 µs
Wall time: 254 µs
3rd exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(4)
CPU times: user 229 µs, sys: 0 ns, total: 229 µs
Wall time: 233 µs
4th exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(5)
CPU times: user 269 µs, sys: 14 µs, total: 283 µs
Wall time: 303 µs
5th exterior power of the Rank-3 free module M over the Integer Ring
sage: %time M.exterior_power(0)
CPU times: user 15 µs, sys: 1 µs, total: 16 µs
Wall time: 16.7 µs
Integer Ring
```

So whatever the changes to this method do does not matter for the slow path.



---

archive/issue_comments_426730.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> It's more than twice as fast in the fast path.\n> \nThanks for the explanation.",
    "created_at": "2020-07-31T20:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426730",
    "user": "egourgoulhon"
}
```

Replying to [comment:10 mkoeppe]:
> It's more than twice as fast in the fast path.
> 
Thanks for the explanation.



---

archive/issue_comments_426731.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-08-04T19:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426731",
    "user": "mkoeppe"
}
```

Ready for review



---

archive/issue_comments_426732.json:
```json
{
    "body": "Very nice changes.\n\nFirst, the import in the doctest is obsolete now:\n\n\n```diff\n- sage: from sage.tensor.modules.tensor_free_module import TensorFreeModule\n```\n\n\nMore comments follow...",
    "created_at": "2020-08-06T10:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426732",
    "user": "@mjungmath"
}
```

Very nice changes.

First, the import in the doctest is obsolete now:


```diff
- sage: from sage.tensor.modules.tensor_free_module import TensorFreeModule
```


More comments follow...



---

archive/issue_comments_426733.json:
```json
{
    "body": "No okay, that's all. LGTM.",
    "created_at": "2020-08-06T10:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426733",
    "user": "@mjungmath"
}
```

No okay, that's all. LGTM.



---

archive/issue_comments_426734.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-06T10:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426734",
    "user": "@mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426735.json:
```json
{
    "body": "Sorry. I'll give positive review when the line is removed.",
    "created_at": "2020-08-06T10:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426735",
    "user": "@mjungmath"
}
```

Sorry. I'll give positive review when the line is removed.



---

archive/issue_comments_426736.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-08-06T10:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426736",
    "user": "@mjungmath"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_426737.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-06T11:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426737",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426738.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-06T16:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426738",
    "user": "@mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426739.json:
```json
{
    "body": "LGTM. Patchbot is now full green, too.",
    "created_at": "2020-08-06T16:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426739",
    "user": "@mjungmath"
}
```

LGTM. Patchbot is now full green, too.



---

archive/issue_comments_426740.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-08-06T16:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426740",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_426741.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-09T08:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30018#issuecomment-426741",
    "user": "vbraun"
}
```

Resolution: fixed
