# Issue 16066: 'make doc-clean' calls system-wide 'git'

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2014-05-07 13:51:33

CC:  jhpalmieri vbraun jguzman

From sage-devel:

```
sage-6.2 build successfully, but perhaps the make doc-clean was not successful

make doc-clean
cd src/doc && make -j4 clean
Deleting generated docs...
rm -rf en/reference/*/sage
rm -rf en/reference/*/sagenb
rm -rf en/reference/sage
rm -rf en/reference/sagenb
rm -rf output
git clean -f -d .
make[1]: git: No such file or directory
make[1]: *** [clean] Error 1
make: *** [doc-clean] Error 2


What am I supposed to do?
```


In `src/doc/Makefile` we have:

```make
all:
        `@`echo "Please build the doc using either 'make doc' from SAGE_ROOT, or"
        `@`echo "'sage -docbuild all html'. See 'sage -docbuild help' for more informations."
clean:
        `@`echo "Deleting generated docs..."
        rm -rf en/reference/*/sage
        rm -rf en/reference/*/sagenb
        rm -rf en/reference/sage
        rm -rf en/reference/sagenb
        rm -rf output
        git clean -f -d .
```


and that's called from the top-level `Makefile` (outside a Sage subshell).



---

Comment by leif created at 2014-05-07 13:58:42

Thoughts?

Try to call Sage's `git` if present otherwise?

Just add a dash to the last line?  (What does `git` remove we couldn't by other means?)


---

Comment by aschilling created at 2014-05-07 16:35:20

Actually, I think I do have git installed systemwide. At least this works outside sage

```
lolita-4:/ anne$ git --version
git version 1.8.4.2
```



---

Comment by leif created at 2014-05-07 16:55:46

Replying to [comment:2 aschilling]:
> Actually, I think I do have git installed systemwide. At least this works outside sage
> {{{
> lolita-4:/ anne$ git --version
> git version 1.8.4.2
> }}}

Hmmm, but it apparently wasn't in your `PATH` when you were running `make doc-clean`.


---

Comment by jhpalmieri created at 2014-05-07 17:12:17

I like the idea of adding a dash to the last line. That git command looks like a last resort anyway: the earlier part of the recipe deletes all of the autogenerated stuff. In the past, if someone did `sage --docbuild reference/junk html`, then it would create a directory `doc/en/reference/junk` (I think) which would then mess up later docbuilding, but this was fixed recently. I'm not sure how else we'd get anything that git would need to clean up.


---

Comment by leif created at 2014-05-07 17:26:40

I like one-character fixes.


---

Comment by leif created at 2014-05-07 17:32:56

And while doing so doesn't fix anything related to docbuilding, it will indeed fix `make distclean` (in the cases where no system-wide `git` is available)... :-)


---

Comment by leif created at 2014-05-07 17:35:41

Changing priority from minor to critical.


---

Comment by leif created at 2014-05-07 17:51:17

Haha, apparently actually Volker added that... XD


---

Comment by leif created at 2014-05-07 19:08:34

Alternate "solution":

```diff
diff --git a/src/doc/Makefile b/src/doc/Makefile
index a4a15b3..fc0e269 100644
--- a/src/doc/Makefile
+++ b/src/doc/Makefile
`@``@` -8,5 +8,5 `@``@` clean:
        rm -rf en/reference/sage
        rm -rf en/reference/sagenb
        rm -rf output
-       git clean -f -d .
-
+       `@`git clean -f -d . 2>/dev/null || \
+       echo "It is recommended to have a git version installed outside of Sage."
```



---

Comment by aschilling created at 2014-06-01 14:29:36

Replying to [comment:9 leif]:
> Haha, apparently actually Volker added that... XD

I still get the above error in the latest development version. Was this fixed? If so, I am still having trouble!


---

Comment by vbraun created at 2014-06-01 17:10:46

I don't see any branch here, hence it has not been fixed. I'm fine with hiding the git error; if you can post code instead of comments then we can fix it ;-)


---

Comment by leif created at 2014-06-01 17:44:43

Replying to [comment:4 jhpalmieri]:
> I like the idea of adding a dash to the last line. That git command looks like a last resort anyway: the earlier part of the recipe deletes all of the autogenerated stuff.

If that was true, why am I getting

```
cd src/doc && make clean
Deleting generated docs...
rm -rf en/reference/*/sage
rm -rf en/reference/*/sagenb
rm -rf en/reference/sage
rm -rf en/reference/sagenb
rm -rf output
git clean -f -d .
Removing common/static/
Removing de/thematische_anleitungen/static/
Removing de/thematische_anleitungen/templates/
Removing de/tutorial/static/
Removing de/tutorial/templates/
Removing en/a_tour_of_sage/static/
Removing en/a_tour_of_sage/templates/
Removing en/bordeaux_2008/static/
Removing en/bordeaux_2008/templates/
Removing en/constructions/static/
Removing en/constructions/templates/
Removing en/developer/templates/
Removing en/faq/static/
Removing en/faq/templates/
Removing en/installation/static/
Removing en/installation/templates/
Removing en/numerical_sage/static/
Removing en/numerical_sage/templates/
Removing en/prep/static/
Removing en/prep/templates/
Removing en/reference/algebras/static/
Removing en/reference/algebras/templates/
Removing en/reference/arithgroup/static/
Removing en/reference/arithgroup/templates/
Removing en/reference/calculus/static/
Removing en/reference/calculus/templates/
Removing en/reference/categories/static/
Removing en/reference/categories/templates/
Removing en/reference/coding/static/
Removing en/reference/coding/templates/
Removing en/reference/coercion/static/
Removing en/reference/coercion/templates/
Removing en/reference/combinat/static/
Removing en/reference/combinat/templates/
Removing en/reference/constants/static/
Removing en/reference/constants/templates/
Removing en/reference/cryptography/static/
Removing en/reference/cryptography/templates/
Removing en/reference/databases/static/
Removing en/reference/databases/templates/
Removing en/reference/dev/static/
Removing en/reference/dev/templates/
Removing en/reference/doctest/static/
Removing en/reference/doctest/templates/
Removing en/reference/dynamics/static/
Removing en/reference/dynamics/templates/
Removing en/reference/finance/static/
Removing en/reference/finance/templates/
Removing en/reference/finite_rings/static/
Removing en/reference/finite_rings/templates/
Removing en/reference/function_fields/static/
Removing en/reference/function_fields/templates/
Removing en/reference/functions/static/
Removing en/reference/functions/templates/
Removing en/reference/games/static/
Removing en/reference/games/templates/
Removing en/reference/geometry/static/
Removing en/reference/geometry/templates/
Removing en/reference/graphs/static/
Removing en/reference/graphs/templates/
Removing en/reference/groups/static/
Removing en/reference/groups/templates/
Removing en/reference/hecke/static/
Removing en/reference/hecke/templates/
Removing en/reference/history_and_license/static/
Removing en/reference/history_and_license/templates/
Removing en/reference/homology/static/
Removing en/reference/homology/templates/
Removing en/reference/interfaces/static/
Removing en/reference/interfaces/templates/
Removing en/reference/lfunctions/static/
Removing en/reference/lfunctions/templates/
Removing en/reference/libs/static/
Removing en/reference/libs/templates/
Removing en/reference/logic/static/
Removing en/reference/logic/templates/
Removing en/reference/matrices/static/
Removing en/reference/matrices/templates/
Removing en/reference/matroids/static/
Removing en/reference/matroids/templates/
Removing en/reference/misc/static/
Removing en/reference/misc/templates/
Removing en/reference/modabvar/static/
Removing en/reference/modabvar/templates/
Removing en/reference/modfrm/static/
Removing en/reference/modfrm/templates/
Removing en/reference/modmisc/static/
Removing en/reference/modmisc/templates/
Removing en/reference/modsym/static/
Removing en/reference/modsym/templates/
Removing en/reference/modules/static/
Removing en/reference/modules/templates/
Removing en/reference/monoids/static/
Removing en/reference/monoids/templates/
Removing en/reference/notebook/static/
Removing en/reference/notebook/templates/
Removing en/reference/number_fields/static/
Removing en/reference/number_fields/templates/
Removing en/reference/numerical/static/
Removing en/reference/numerical/templates/
Removing en/reference/padics/static/
Removing en/reference/padics/templates/
Removing en/reference/parallel/static/
Removing en/reference/parallel/templates/
Removing en/reference/plane_curves/static/
Removing en/reference/plane_curves/templates/
Removing en/reference/plot3d/static/
Removing en/reference/plot3d/templates/
Removing en/reference/plotting/static/
Removing en/reference/plotting/templates/
Removing en/reference/polynomial_rings/static/
Removing en/reference/polynomial_rings/templates/
Removing en/reference/power_series/static/
Removing en/reference/power_series/templates/
Removing en/reference/probability/static/
Removing en/reference/probability/templates/
Removing en/reference/quadratic_forms/static/
Removing en/reference/quadratic_forms/templates/
Removing en/reference/quat_algebras/static/
Removing en/reference/quat_algebras/templates/
Removing en/reference/quivers/static/
Removing en/reference/quivers/templates/
Removing en/reference/repl/static/
Removing en/reference/repl/templates/
Removing en/reference/riemannian_geometry/static/
Removing en/reference/riemannian_geometry/templates/
Removing en/reference/rings/static/
Removing en/reference/rings/templates/
Removing en/reference/rings_numerical/static/
Removing en/reference/rings_numerical/templates/
Removing en/reference/rings_standard/static/
Removing en/reference/rings_standard/templates/
Removing en/reference/sat/static/
Removing en/reference/sat/templates/
Removing en/reference/schemes/static/
Removing en/reference/schemes/templates/
Removing en/reference/semirings/static/
Removing en/reference/semirings/templates/
Removing en/reference/static/
Removing en/reference/stats/static/
Removing en/reference/stats/templates/
Removing en/reference/structure/static/
Removing en/reference/structure/templates/
Removing en/reference/templates/
Removing en/reference/tensor/static/
Removing en/reference/tensor/templates/
Removing en/thematic_tutorials/static/
Removing en/thematic_tutorials/templates/
Removing en/tutorial/static/
Removing en/tutorial/templates/
Removing fr/a_tour_of_sage/static/
Removing fr/a_tour_of_sage/templates/
Removing fr/tutorial/static/
Removing fr/tutorial/templates/
Removing pt/a_tour_of_sage/static/
Removing pt/a_tour_of_sage/templates/
Removing ru/tutorial/static/
Removing ru/tutorial/templates/
Removing tr/a_tour_of_sage/static/
Removing tr/a_tour_of_sage/templates/
```

?

> [...] I'm not sure how else we'd get anything that git would need to clean up.

I mean removing those (empty?) folders might not be necessary (I don't know), but certainly the `git clean` there isn't a nop.


---

Comment by leif created at 2014-06-01 17:50:46

We could of course add `find . -name static -o -name templates -exec rm -rf {} \;` (above the `[-]git clean ...`), but should we?


---

Comment by leif created at 2014-06-01 17:51:06

Changing status from new to needs_info.


---

Comment by jhpalmieri created at 2014-06-01 18:06:03

We certainly don't want to delete `common/themes/sage/static`, for example. But maybe 

```
rm -rf common/static
rm -rf en/*/static
rm -rf en/*/templates
rm -rf en/reference/*/static
rm -rf en/reference/*/templates
```

?

In any case, it looks like these are empty directories, so I don't think their presence should break docbuilding.


---

Comment by vbraun created at 2014-06-01 18:07:29

Git does not try to remove empty directories when changing branches, but sphinx is sensitive to empty directories and they will break docbuilds.

There are various ways to clean up empty directories, but imho there is no portable and readable way in a shell script.


---

Comment by leif created at 2014-06-01 19:00:03

Replying to [comment:17 vbraun]:
> There are various ways to clean up empty directories, but imho there is no portable and readable way in a shell script. 

Depends on what you consider "readable", which IMHO isn't _that_ relevant here either.

We can use `rmdir` (which _is_ portable) and just (silently) ignore errors on non-empty directories.


---

Comment by leif created at 2014-06-01 19:12:21

Replying to [comment:16 jhpalmieri]:
> We certainly don't want to delete `common/themes/sage/static`, for example.

We could `-prune` that, or one of its parent directories.


---

Comment by leif created at 2014-06-01 19:25:50

Replying to [comment:17 vbraun]:
> Git does not try to remove empty directories when changing branches, but sphinx is sensitive to empty directories and they will break docbuilds.

Do you mean we should in addition have a "light" version of `make doc-clean` (only removing empty folders) to be run after switching branches for those who don't want to run `make doc-clean` each time but want to be on the "safe side" w.r.t. doc(re)building?

IMHO probably rather Sphinx should get fixed if that's a/the problem.


---

Comment by vbraun created at 2014-06-01 19:28:04

We could erase empty directories in `custom-sphinx-build.py`...


---

Comment by leif created at 2014-06-01 19:39:01

Replying to [comment:21 vbraun]:
> We could erase empty directories in `custom-sphinx-build.py`...

If that solves potential problems, certainly the RTTD.

Or is it a general Sphinx (upstream) problem?


---

Comment by jhpalmieri created at 2014-06-01 20:33:03

I think using `rmdir` makes things pretty readable. I personally hate the `find` command, but if other people can get it to work in a portable way, I wouldn't object to using that instead.

Have you seen an empty `static` or `templates` directory breaking docbuilding? I understand that creating `reference/foo` might break it, because our docbuild system will then try to build a `foo` document, but I wasn't aware of any problems with these Sphinx-created directories.

I think we should have some `rmdir` commands and also the current `git clean` command, all ignoring errors. `make distclean` will be the last resort if these don't fix the problem for someone. (After trying `./sage -f git` and `make doc-clean`.)


---

Comment by jhpalmieri created at 2014-06-01 22:56:32

I'm thinking of this:

```diff
diff --git a/src/doc/Makefile b/src/doc/Makefile
index a4a15b3..e0f9f99 100644
--- a/src/doc/Makefile
+++ b/src/doc/Makefile
`@``@` -8,5 +8,9 `@``@` clean:
        rm -rf en/reference/sage
        rm -rf en/reference/sagenb
        rm -rf output
-       git clean -f -d .
-
+       -rmdir common/static 2>/dev/null
+       -rmdir en/reference/*/static 2>/dev/null
+       -rmdir en/reference/*/templates 2>/dev/null
+       -rmdir [a-z][a-z]/*/static 2>/dev/null
+       -rmdir [a-z][a-z]/*/templates 2>/dev/null
+       -git clean -f -d .
```

Comments? Should I create a branch?


---

Comment by leif created at 2014-06-01 23:33:34

Replying to [comment:24 jhpalmieri]:
> I'm thinking of this:
> {{{
> #!diff
> diff --git a/src/doc/Makefile b/src/doc/Makefile
> index a4a15b3..e0f9f99 100644
> --- a/src/doc/Makefile
> +++ b/src/doc/Makefile
> `@``@` -8,5 +8,9 `@``@` clean:
>         rm -rf en/reference/sage
>         rm -rf en/reference/sagenb
>         rm -rf output
> -       git clean -f -d .
> -
> +       -rmdir common/static 2>/dev/null
> +       -rmdir en/reference/*/static 2>/dev/null
> +       -rmdir en/reference/*/templates 2>/dev/null
> +       -rmdir [a-z][a-z]/*/static 2>/dev/null
> +       -rmdir [a-z][a-z]/*/templates 2>/dev/null
> +       -git clean -f -d .
> }}}
> Comments? Should I create a branch?

I'd be ok with that, although I can't tell whether that'll be sufficient (regarding potential docbuilding brokenness).

And I think doing some consistency checks / removing stuff that may disturb Sphinx could really be done _before docbuilding_ (i.e., in some of our builder scripts, as Volker suggested).  Maybe in addition, and on another ticket.  (As mentioned on sage-devel, I think there is currently more broken with Sphinx, e.g. `sage --docbuild reference html` apparently does no longer work.)


---

Comment by vbraun created at 2014-06-02 12:04:23

`sage --docbuild reference html` is the second stage of the reference manual docbuild and works as long as you have a pre-built intersphinx inventory. If you don't you need to run the first stage, that is, `sage --docbuild reference inventory`, before that. If you think that is too complicated then you should stick to `make doc`.


---

Comment by vbraun created at 2014-06-02 12:21:57

Changing status from needs_info to needs_review.


---

Comment by vbraun created at 2014-06-02 12:21:57

New commits:


---

Comment by leif created at 2014-06-02 13:56:37

Replying to [comment:29 vbraun]:
> New commits:
> ||[2118554](http://git.sagemath.org/sage.git/commit/?id=2118554d2c99f30350e7867aebe126da6fbb7236)||`use Python to delete empty directories`||

Not sure whether modifying `builder.py` really belongs to this ticket (as already mentioned).

In any case, deleting folders should IMHO be done _after_ option parsing.


---

Comment by leif created at 2014-06-02 14:00:50

(And I'd rather go with John's suggestion, as `make doc-clean` is supposed to clean up, _plus_ perhaps the deletion in `builder.py` as well, although probably more could be done / checked there.)


---

Comment by git created at 2014-06-02 14:01:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-06-02 14:05:30

Replying to [comment:27 vbraun]:
> `sage --docbuild reference html` is the second stage of the reference manual docbuild and works as long as you have a pre-built intersphinx inventory. If you don't you need to run the first stage, that is, `sage --docbuild reference inventory`, before that.

IIRC that didn't always work either, but anyway, it's not documented (at least not where it should be), but instead odd errors are raised in case one hasn't (re)built the inventory prior to trying to build the reference manual.

----
New commits:


---

Comment by leif created at 2014-06-02 14:09:24

Dear trac, I didn't make a new commit...

Besides that, it's ok.  I still would do more in the `make` receipt.


---

Comment by vbraun created at 2014-06-02 14:17:36

IMHO at least the `sage --docbuild reference html` error is spot-on, is says that it can't load the inventory.

With my patch there is no need to clean up empty directories from the `doc-clean` target, nor do we do that for any other `*-clean` target.


---

Comment by leif created at 2014-06-02 14:24:40

Replying to [comment:35 vbraun]:
> With my patch there is no need to clean up empty directories from the `doc-clean` target, nor do we do that for any other `*-clean` target. 

Well, the difference is _when_ a clean-up is made.

I'd expect `make doc-clean` to clean up docs (and doc-related folders).  Just like I expect `make distclean` to clean up immediately, not upon the next attempt to build Sage.

I don't care if it's partially redundant to call `make doc-clean` before actually (re)building docs; it's just triple-safe and shouldn't be too expensive.


---

Comment by vbraun created at 2014-06-02 15:10:42

The real issue is that the docs should be built under `SAGE_LOCAL`. 

Triple-safe is bullshit, do it once right.


---

Comment by leif created at 2014-06-02 16:05:19

Replying to [comment:37 vbraun]:
> The real issue is that the docs should be built under `SAGE_LOCAL`.

Well, then go ahead.  But on a follow-up I'd say.


---

Comment by leif created at 2014-06-02 16:09:31

P.S.:  John should be up soon; waiting for his opinion... (and of course those of any others)


---

Comment by jhpalmieri created at 2014-06-02 18:02:03

I've been up for a while, actually. I tried (not very hard) to build the docs in `SAGE_LOCAL` but ran into problems. Is the issue moving just the output directory there, or also the other temporary directories (like `static` and `templates`) into `SAGE_LOCAL`?

Anyway, I think the proposed change is fine, although I would also include `-git clean -f -d .` in the `Makefile` recipe.


---

Comment by vbraun created at 2014-06-02 18:10:50

I'm against independent code paths that depend on whether or not there is a system-wide git installed. That'll just be unnecessarily difficult to debug if it breaks. Do it once, and do it right.


---

Comment by leif created at 2014-06-02 18:22:27

Replying to [comment:40 jhpalmieri]:
> I tried (not very hard) to build the docs in `SAGE_LOCAL` but ran into problems. Is the issue moving just the output directory there, or also the other temporary directories (like `static` and `templates`) into `SAGE_LOCAL`?

Well, ideally `src/` should be read-only w.r.t. building/testing/running Sage, including docbuilding.  But that's certainly beyond the scope of this ticket.


---

Comment by jhpalmieri created at 2014-06-02 18:43:21

There was a conflicting idea to build the Sage library in place, rather than copy it to `local/lib/python/site-package/sage`. I forget which ticket that is, but in any case, I'm not sure everyone agrees that "ideally `src/` should be read-only ..."


---

Comment by vbraun created at 2014-06-18 12:56:08

Any news on reviewing this ticket?


---

Comment by aschilling created at 2014-06-18 15:17:38

Replying to [comment:44 vbraun]:
> Any news on reviewing this ticket?

For me everything worked again with this branch applied! So I am happy to give a positive review. But some of the other reviewers might have technical comments!

Anne


---

Comment by leif created at 2014-06-18 18:06:23

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-06-18 18:06:23

Well, as John P., I would have left the `git clean`, ignoring errors, but I don't care much.

Better than no fix....


---

Comment by leif created at 2014-06-18 18:22:11

P.S.:  And Volker now has the necessary pence to work on a follow-up ticket for building the docs below `$SAGE_LOCAL/`...  Glückwunsch auch von mir!


---

Comment by vbraun created at 2014-06-19 13:12:43

Resolution: fixed
