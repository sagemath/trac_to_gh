# Issue 26788: NULL and multiple output from R

Issue created by migration from https://trac.sagemath.org/ticket/27025

Original creator: novoselt

Original creation time: 2019-01-06 22:39:24

CC:  @timokau fbissey

In Sage 8.4 we had

```
sage: r.eval("graphics.off()")
''
sage: r.eval("""
....: 1
....: 2
....: """)
'[1] 1\n[1] 2'
```

in Sage 8.5 this gives

```
sage: r.eval("graphics.off()")
'NULL'
sage: r.eval("""
....: 1
....: 2
....: """)
'[1] 2'
```

which is annoying and inconsistent with the output one gets from R using these commands:

```
> graphics.off()
> 1
[1] 1
> 2
[1] 2
```

I've also seen this example in the documentation:

```
sage: r.png(filename='"%s"'%filename)             # optional -- rgraphics
NULL
```

which again I think is wrong - there should be no NULL output when saving a file.


---

Comment by novoselt created at 2019-01-06 22:53:06

As an example of why this NULL is annoying:
http://faculty.sfasu.edu/judsontw/math-s304/section-16.html

Also, if there were cells relying on multiple output from multiple commands, they behave differently now as well.


---

Comment by embray created at 2019-01-14 09:55:20

I agree this should definitely be fixed.

Incidentally, this is the opposite of what I did in the recent updates to the libgap interface (#22626): Previously, void-returning GAP functions would have their "return value" wrapped in a null `GapElement` that actually repr'd as `NULL` which was obviously annoying and distracting.  

In this case, the old behavior still returned an empty string, which still looks wrong to me.  It should check whether the expression in question has an actual return value or not, and if not then `r.eval` should just return `None`.


---

Comment by @timokau created at 2019-01-14 19:51:33

Right, thanks for reporting. The `eval` function actually just hands of to `rpy2`:


```
def eval(self, code, *args, **kwds):
    self._lazy_init()
    return str(robjects.r(code)).rstrip()
```


In this case `robjects.r("graphics.off()")` is `rpy2.rinterface.NULL`, which unfortunately is implemented to have a string representation of `NULL`. I'd argue this is an upstream bug bug since I think upstream doesn't want to do new python2 releases, we need to fix it ourselves here.

The fix should be trivial. Just add a `if result == rpy2.rinterface.NULL` to `eval`. However do you know why


```
sage: r.png(filename='"%s"'%filename)             # optional -- rgraphics
NULL
```


is different? I didn't touch that in my recent R changes, so that always returned NULL.


---

Comment by @timokau created at 2019-01-14 20:17:31

Tested only the `r.py` file without any optionals though.
----
New commits:


---

Comment by @timokau created at 2019-01-14 20:17:31

Changing status from new to needs_review.


---

Comment by novoselt created at 2019-01-14 20:42:44

No idea about `r.png` returning NULL before and after - I thought it was a recent change.

But apart from NULL there is also change in behaviour for multi-line input. For SageMathCell, that adds that extra graphics command, this means that default output of single commands is not shown at all: https://sagecell.sagemath.org/?z=eJwzBAAAMgAy&lang=r Is it easy to restore old behaviour for this case?


---

Comment by @timokau created at 2019-01-14 21:19:32

I'm not entirely sure what you mean. Do you mean multiline input to `eval()`? How should that behave? Just pass each line to R separately? Does R have some sort of line-continuation that must be considered?


---

Comment by novoselt created at 2019-01-14 23:14:37

I gave an example in the description of how things worked before and what happens now. I don't know how it should be implemented as my knowledge of R is extremely limited, I only learned enough to save graphics to a file ;-)


---

Comment by @timokau created at 2019-01-15 09:00:02

For your examples just splitting on newline would work. But the same issue seems to appear any time you eval more than one statement, for example `r.eval("1;3")`.

I'd personally argue that is out of scope for eval, but since it was supported before...

I don't know much about R myself, I only messed with it in the first place because it was stuck on an old version for so long and nobody else was doing anything.


---

Comment by embray created at 2019-01-15 15:54:48

In


```diff
         """
         self._lazy_init()
-        return str(robjects.r(code)).rstrip()
+        result = robjects.r(code)
+        if result == rinterface.NULL:
+            # trac #27025
+            result = None
+        else:
+            result = str(result)
+
+        if isinstance(result, str):
+            # no trailing newlines
+            result = result.rstrip()
 
+        return result
```


This looks like it could be simplified: If `result != NULL` then you always do `result = str(result)` anyways, so why not just move the `.rstrip()` into the statement in the `else:` block and get rid of the superfluous `isinstance(result, str)`?

I'm also surprised now, upon reading the docs for the eval method, that it _always_ returns the result s a string, and not the actual wrapped R object itself (as the libgap interface would do).  Why is this?  That makes me rethink having it ever return `None` in the first place.  Though I'd be more inclined to say the eval-returns-a-string interface is a mistake in the first place and should be done away with.


---

Comment by @timokau created at 2019-01-15 17:17:26

Replying to [comment:9 embray]:
> In
> 
> {{{
> #!diff
>          """
>          self._lazy_init()
> -        return str(robjects.r(code)).rstrip()
> +        result = robjects.r(code)
> +        if result == rinterface.NULL:
> +            # trac #27025
> +            result = None
> +        else:
> +            result = str(result)
> +
> +        if isinstance(result, str):
> +            # no trailing newlines
> +            result = result.rstrip()
>  
> +        return result
> }}}
> 
> This looks like it could be simplified: If `result != NULL` then you always do `result = str(result)` anyways, so why not just move the `.rstrip()` into the statement in the `else:` block and get rid of the superfluous `isinstance(result, str)`?

I think I had a reason for that, but I can't remember it and I can't see any reason now. So it can probably be changed.

> I'm also surprised now, upon reading the docs for the eval method, that it _always_ returns the result s a string, and not the actual wrapped R object itself (as the libgap interface would do).  Why is this?  That makes me rethink having it ever return `None` in the first place.  Though I'd be more inclined to say the eval-returns-a-string interface is a mistake in the first place and should be done away with.

If you wanted a proper object, you'd use `__call__` instead: `r("42")`. Not sure why its done that way, I assume its just a symptom of having been a pexpect interface before. There it was natural to eval first and then translate to an object. Now we do it the other way around: get an object first, then produce a string if requested.

Gap does the same thing:


```
sage: type(gap.eval('42;'))
<type: 'str'>
```



---

Comment by embray created at 2019-01-15 17:21:40

Right, I believe we talked about that before on the mailing list.  I understand that the existing interface makes sense in light of its origin as a pexpect interface.  Perhaps this should in fact be moved into `sage.lib` instead of `sage.interfaces` and updated to a more common interface, while deprecating the old interface.  Now that I think about it I think it should have been done that way in the first place, but I didn't speak up in time so oh well.  Could you please open a ticket for that?  I think we should make a stronger effort to be consistent.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by @timokau created at 2019-01-15 19:14:05

Replying to [comment:11 embray]:
> Right, I believe we talked about that before on the mailing list.  I understand that the existing interface makes sense in light of its origin as a pexpect interface.  Perhaps this should in fact be moved into `sage.lib` instead of `sage.interfaces` and updated to a more common interface, while deprecating the old interface.  Now that I think about it I think it should have been done that way in the first place, but I didn't speak up in time so oh well.  Could you please open a ticket for that?  I think we should make a stronger effort to be consistent.

I don't think it should have been done like that. The point was to provide a drop-in replacement for the old interface. If we just want an R interface without backward compatibility concerns, I'd just tell users to use rpy2 directly.


---

Comment by embray created at 2019-01-16 10:43:38

Except it's clearly not just a drop-in replacement; it's a rather different way to go about things.  Regardless, what's done is done, and it's still by far a net positive so I'm not complaining :)


---

Comment by @timokau created at 2019-01-16 11:20:17

It mostly is. Due to my little R usage and a lack of tests, some issues were probably inevitable. I'm only aware of this issue (the multiline thing may be hard to fix depending on how R handles these) and the multiple instances issue (wontfix from me).

I wouldn't be opposed to deprecating the old api altogether and using rpy2 (maybe a very thin wrapper) instead. But I don't want to fight that fight myself :)


---

Comment by novoselt created at 2019-01-17 01:31:18

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2019-01-17 01:31:18

If someone is just interested in using R, then Sage is probably not the best way to do it. If someone just wants to use R from !Sage/Python specifically, then rpy2 is quite sensible with whatever decisions it comes. But the point of particular output from `eval` etc. is that every interface in Sage (at least in theory), behaves this way. In particular, it is supposed to return a string and it used to return the empty string rather than `None` as "no output". I think this definitely has to be the case again.

Regarding multiline treatment - it may be less important as notebooks often show only the last output from commands in a single "cell" and a single call to `eval` is kind of like executing a "cell". It is still unfortunate that old behaviour is changed without deprecation period, but if nobody else complains and nobody wants to work on it, well then...


---

Comment by embray created at 2019-01-18 10:40:18

I will look into it at some point but it's definitely not a priority for me right now.  As you said, while it's absolutely useful to have an R interface in Sage, that's useful more as a glue layer, and not for doing serious R programming, which should just be done in an R-specific UI.


---

Comment by novoselt created at 2019-01-18 17:07:03

Except, of course, for using it via SageMathCell where Sage is a necessary proxy between browser and R ;-) So I do hope that the issue will be solved in the next 8.7 release...


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
