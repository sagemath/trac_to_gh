# Issue 32792: tests depend on library development files

Issue created by migration from https://trac.sagemath.org/ticket/33029

Original creator: thansen

Original creation time: 2021-12-15 22:10:22

CC:  fbissey arojas slabbe

While updating the sagemath Debian package I noticed that when running the doctests for the installed sagemath package I get many failing tests such as the one below if library development files are not installed (in the example libm4ri-dev is not installed). The sagemath packages should not depend on lib*-dev packages, but sagemath is looking for pkgconfig files which are in these packages. Could this check for pkgconfig files in the test suite be avoided?



```
sage -t --long --random-seed=0 sage/src/sage/arith/long.pxd
**********************************************************************
File "sage/src/sage/arith/long.pxd", line 116, in sage.arith.long.integer_check_long
Failed example:
    cython('''
    from sage.arith.long cimport *
    from sage.rings.integer cimport smallInteger
    def check_long(x):
        cdef long value
        cdef int err
        cdef bint c = integer_check_long(x, &value, &err)
        if c:
            if err == 0:
                return value
            elif err == ERR_OVERFLOW:
                raise OverflowError("integer_check_long: overflow")
        elif err == ERR_TYPE:
            raise TypeError("integer_check_long: wrong type")
        elif err == ERR_INDEX:
            raise TypeError("integer_check_long: bad __index__")
        assert False
    from libc.limits cimport LONG_MIN, LONG_MAX
    def long_min():
        return smallInteger(LONG_MIN)
    def long_max():
        return smallInteger(LONG_MAX)
    ''')
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5970)
        return self.cache[k]
    KeyError: ((), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/usr/lib/python3/dist-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3/dist-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.arith.long.integer_check_long[0]>", line 1, in <module>
        cython('''
      File "sage/misc/lazy_import.pyx", line 362, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4049)
        return self.get_object()(*args, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 526, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 284, in cython
        standard_libs, standard_libdirs, standard_includes, aliases = _standard_libs_libdirs_incdirs_aliases()
      File "sage/misc/cachefunc.pyx", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6098)
        w = self.f(*args, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 50, in _standard_libs_libdirs_incdirs_aliases
        aliases = cython_aliases()
      File "/usr/lib/python3/dist-packages/sage/env.py", line 475, in cython_aliases
        aliases[var + "CFLAGS"] = pkgconfig.cflags(lib).split()
      File "/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py", line 144, in cflags
        _raise_if_not_exists(package)
      File "/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
        raise PackageNotFoundError(package)
    pkgconfig.pkgconfig.PackageNotFoundError: m4ri not found
```




---

Comment by mkoeppe created at 2021-12-15 22:20:05

Run-time use of compilers is a feature of some parts of the Sage library - in this case `sage.misc.cython.cython`. These tests necessarily depend on dev headers (and the compilers!).

We should conditionalize these doctests on a `Feature`.


---

Comment by thansen created at 2021-12-15 22:30:59

That would help. Or would you say the sagemath Debian packages should depend on the dev packages to provide this feature?


---

Comment by mkoeppe created at 2021-12-15 22:42:14

If currently Sage is monolithic in Debian, then you should probably add these as runtime dependencies -- because the `cython` function is part of the standard Sage library.


---

Comment by fbissey created at 2021-12-15 22:54:28

One interesting question is how used is this feature of sage, that you can compile bit of code inside it? This is clearly advanced use but if it is widespread, you definitely need to install matching dev packages.

It is not unlike R packages. Debian provides quite a lot of them by default, but if you want something not provided, you may have to install dev packages.


---

Comment by mkoeppe created at 2021-12-16 05:35:33

Here's a beginning. More doctests that use `cython` can be marked up in the same way
----
Last 10 new commits:


---

Comment by arojas created at 2021-12-16 07:08:44

How useful is this given that tests don't run at all if cython is not present?

https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n27


---

Comment by mkoeppe created at 2021-12-16 07:36:48

This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files


---

Comment by mkoeppe created at 2021-12-16 07:46:09

Another import from `Cython` in `sage.doctest.parsing` is being removed in #32938.


---

Comment by mkoeppe created at 2021-12-16 17:16:04

Replying to [comment:11 mkoeppe]:
> This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files

I've opened #33033 for this


---

Comment by git created at 2021-12-16 19:58:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-17 06:16:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-28 18:28:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-09 04:42:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-09 04:43:11

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-05-09 04:47:43

Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `


---

Comment by git created at 2022-06-09 20:26:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-06-24 08:07:08

Replying to [comment:25 mkoeppe]:
> Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `

The above command works for me:


```
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 70.5 seconds
    cpu time: 158.9 seconds
    cumulative wall time: 240.4 seconds
Features detected for doctesting: sage.groups,sage.rings.padics,sagemath_doc_html,sphinx
```



---

Comment by slabbe created at 2022-06-24 08:13:27

The only reported test failure is:

```
----------------------------------------------------------------------
sage -t --long --random-seed=338071419821968503909259763280493589917 src/sage/modular/overconvergent/hecke_series.py  # Timed out
----------------------------------------------------------------------
```

which is not related to this ticket.


---

Comment by slabbe created at 2022-06-24 08:16:02

Patchbot pyflakes suggests 4 corrections:

```
src/sage/env.py:32:1 'sage' imported but unused
src/sage/misc/cython.py:295:9 'setuptools' imported but unused
src/sage/misc/sagedoc.py:791:9 'sage.all' imported but unused
src/sage/misc/sagedoc.py:969:5 local variable 'html_results' is assigned to but never used
```

but I suggest to fix them in another ticket : #34061.


---

Comment by slabbe created at 2022-06-24 08:16:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-03 22:06:06

Resolution: fixed
