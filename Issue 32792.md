# Issue 32792: tests depend on library development files

archive/issues_032792.json:
```json
{
    "body": "CC:  @kiwifb @antonio-rojas @seblabbe\n\nWhile updating the sagemath Debian package I noticed that when running the doctests for the installed sagemath package I get many failing tests such as the one below if library development files are not installed (in the example libm4ri-dev is not installed). The sagemath packages should not depend on lib*-dev packages, but sagemath is looking for pkgconfig files which are in these packages. Could this check for pkgconfig files in the test suite be avoided?\n\n\n```\nsage -t --long --random-seed=0 sage/src/sage/arith/long.pxd\n**********************************************************************\nFile \"sage/src/sage/arith/long.pxd\", line 116, in sage.arith.long.integer_check_long\nFailed example:\n    cython('''\n    from sage.arith.long cimport *\n    from sage.rings.integer cimport smallInteger\n    def check_long(x):\n        cdef long value\n        cdef int err\n        cdef bint c = integer_check_long(x, &value, &err)\n        if c:\n            if err == 0:\n                return value\n            elif err == ERR_OVERFLOW:\n                raise OverflowError(\"integer_check_long: overflow\")\n        elif err == ERR_TYPE:\n            raise TypeError(\"integer_check_long: wrong type\")\n        elif err == ERR_INDEX:\n            raise TypeError(\"integer_check_long: bad __index__\")\n        assert False\n    from libc.limits cimport LONG_MIN, LONG_MAX\n    def long_min():\n        return smallInteger(LONG_MIN)\n    def long_max():\n        return smallInteger(LONG_MAX)\n    ''')\nException raised:\n    Traceback (most recent call last):\n      File \"sage/misc/cachefunc.pyx\", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5970)\n        return self.cache[k]\n    KeyError: ((), ())\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/usr/lib/python3/dist-packages/sage/doctest/forker.py\", line 718, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3/dist-packages/sage/doctest/forker.py\", line 1137, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.arith.long.integer_check_long[0]>\", line 1, in <module>\n        cython('''\n      File \"sage/misc/lazy_import.pyx\", line 362, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4049)\n        return self.get_object()(*args, **kwds)\n      File \"/usr/lib/python3/dist-packages/sage/misc/cython.py\", line 661, in cython_compile\n        return cython_import_all(tmpfile, get_globals(), **kwds)\n      File \"/usr/lib/python3/dist-packages/sage/misc/cython.py\", line 551, in cython_import_all\n        m = cython_import(filename, **kwds)\n      File \"/usr/lib/python3/dist-packages/sage/misc/cython.py\", line 526, in cython_import\n        name, build_dir = cython(filename, **kwds)\n      File \"/usr/lib/python3/dist-packages/sage/misc/cython.py\", line 284, in cython\n        standard_libs, standard_libdirs, standard_includes, aliases = _standard_libs_libdirs_incdirs_aliases()\n      File \"sage/misc/cachefunc.pyx\", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6098)\n        w = self.f(*args, **kwds)\n      File \"/usr/lib/python3/dist-packages/sage/misc/cython.py\", line 50, in _standard_libs_libdirs_incdirs_aliases\n        aliases = cython_aliases()\n      File \"/usr/lib/python3/dist-packages/sage/env.py\", line 475, in cython_aliases\n        aliases[var + \"CFLAGS\"] = pkgconfig.cflags(lib).split()\n      File \"/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py\", line 144, in cflags\n        _raise_if_not_exists(package)\n      File \"/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py\", line 103, in _raise_if_not_exists\n        raise PackageNotFoundError(package)\n    pkgconfig.pkgconfig.PackageNotFoundError: m4ri not found\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33029\n\n",
    "created_at": "2021-12-15T22:10:22Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "tests depend on library development files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32792",
    "user": "https://github.com/tobihan"
}
```
CC:  @kiwifb @antonio-rojas @seblabbe

While updating the sagemath Debian package I noticed that when running the doctests for the installed sagemath package I get many failing tests such as the one below if library development files are not installed (in the example libm4ri-dev is not installed). The sagemath packages should not depend on lib*-dev packages, but sagemath is looking for pkgconfig files which are in these packages. Could this check for pkgconfig files in the test suite be avoided?


```
sage -t --long --random-seed=0 sage/src/sage/arith/long.pxd
**********************************************************************
File "sage/src/sage/arith/long.pxd", line 116, in sage.arith.long.integer_check_long
Failed example:
    cython('''
    from sage.arith.long cimport *
    from sage.rings.integer cimport smallInteger
    def check_long(x):
        cdef long value
        cdef int err
        cdef bint c = integer_check_long(x, &value, &err)
        if c:
            if err == 0:
                return value
            elif err == ERR_OVERFLOW:
                raise OverflowError("integer_check_long: overflow")
        elif err == ERR_TYPE:
            raise TypeError("integer_check_long: wrong type")
        elif err == ERR_INDEX:
            raise TypeError("integer_check_long: bad __index__")
        assert False
    from libc.limits cimport LONG_MIN, LONG_MAX
    def long_min():
        return smallInteger(LONG_MIN)
    def long_max():
        return smallInteger(LONG_MAX)
    ''')
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5970)
        return self.cache[k]
    KeyError: ((), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/usr/lib/python3/dist-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3/dist-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.arith.long.integer_check_long[0]>", line 1, in <module>
        cython('''
      File "sage/misc/lazy_import.pyx", line 362, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4049)
        return self.get_object()(*args, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 526, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 284, in cython
        standard_libs, standard_libdirs, standard_includes, aliases = _standard_libs_libdirs_incdirs_aliases()
      File "sage/misc/cachefunc.pyx", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6098)
        w = self.f(*args, **kwds)
      File "/usr/lib/python3/dist-packages/sage/misc/cython.py", line 50, in _standard_libs_libdirs_incdirs_aliases
        aliases = cython_aliases()
      File "/usr/lib/python3/dist-packages/sage/env.py", line 475, in cython_aliases
        aliases[var + "CFLAGS"] = pkgconfig.cflags(lib).split()
      File "/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py", line 144, in cflags
        _raise_if_not_exists(package)
      File "/usr/lib/python3/dist-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
        raise PackageNotFoundError(package)
    pkgconfig.pkgconfig.PackageNotFoundError: m4ri not found
```


Issue created by migration from https://trac.sagemath.org/ticket/33029





---

archive/issue_comments_467078.json:
```json
{
    "body": "Run-time use of compilers is a feature of some parts of the Sage library - in this case `sage.misc.cython.cython`. These tests necessarily depend on dev headers (and the compilers!).\n\nWe should conditionalize these doctests on a `Feature`.",
    "created_at": "2021-12-15T22:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467078",
    "user": "https://github.com/mkoeppe"
}
```

Run-time use of compilers is a feature of some parts of the Sage library - in this case `sage.misc.cython.cython`. These tests necessarily depend on dev headers (and the compilers!).

We should conditionalize these doctests on a `Feature`.



---

archive/issue_comments_467079.json:
```json
{
    "body": "That would help. Or would you say the sagemath Debian packages should depend on the dev packages to provide this feature?",
    "created_at": "2021-12-15T22:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467079",
    "user": "https://github.com/tobihan"
}
```

That would help. Or would you say the sagemath Debian packages should depend on the dev packages to provide this feature?



---

archive/issue_comments_467080.json:
```json
{
    "body": "If currently Sage is monolithic in Debian, then you should probably add these as runtime dependencies -- because the `cython` function is part of the standard Sage library.",
    "created_at": "2021-12-15T22:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467080",
    "user": "https://github.com/mkoeppe"
}
```

If currently Sage is monolithic in Debian, then you should probably add these as runtime dependencies -- because the `cython` function is part of the standard Sage library.



---

archive/issue_comments_467081.json:
```json
{
    "body": "One interesting question is how used is this feature of sage, that you can compile bit of code inside it? This is clearly advanced use but if it is widespread, you definitely need to install matching dev packages.\n\nIt is not unlike R packages. Debian provides quite a lot of them by default, but if you want something not provided, you may have to install dev packages.",
    "created_at": "2021-12-15T22:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467081",
    "user": "https://github.com/kiwifb"
}
```

One interesting question is how used is this feature of sage, that you can compile bit of code inside it? This is clearly advanced use but if it is widespread, you definitely need to install matching dev packages.

It is not unlike R packages. Debian provides quite a lot of them by default, but if you want something not provided, you may have to install dev packages.



---

archive/issue_comments_467082.json:
```json
{
    "body": "Here's a beginning. More doctests that use `cython` can be marked up in the same way\n\n---\nLast 10 new commits:",
    "created_at": "2021-12-16T05:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467082",
    "user": "https://github.com/mkoeppe"
}
```

Here's a beginning. More doctests that use `cython` can be marked up in the same way

---
Last 10 new commits:



---

archive/issue_comments_467083.json:
```json
{
    "body": "How useful is this given that tests don't run at all if cython is not present?\n\nhttps://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n27",
    "created_at": "2021-12-16T07:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467083",
    "user": "https://github.com/antonio-rojas"
}
```

How useful is this given that tests don't run at all if cython is not present?

https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n27



---

archive/issue_comments_467084.json:
```json
{
    "body": "This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files",
    "created_at": "2021-12-16T07:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467084",
    "user": "https://github.com/mkoeppe"
}
```

This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files



---

archive/issue_comments_467085.json:
```json
{
    "body": "Another import from `Cython` in `sage.doctest.parsing` is being removed in #32938.",
    "created_at": "2021-12-16T07:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467085",
    "user": "https://github.com/mkoeppe"
}
```

Another import from `Cython` in `sage.doctest.parsing` is being removed in #32938.



---

archive/issue_comments_467086.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files\n\n\nI've opened #33033 for this",
    "created_at": "2021-12-16T17:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467086",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:11 mkoeppe]:
> This use of `is_package_dir` will have to be eliminated when we change packages to namespace packages in 9.6 by removing `__init__.py` files


I've opened #33033 for this



---

archive/issue_comments_467087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-16T19:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467088.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-17T06:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467088",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_087277.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32792#event-87277"
}
```



---

archive/issue_events_087278.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32792#event-87278"
}
```



---

archive/issue_events_087279.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32792#event-87279"
}
```



---

archive/issue_comments_467089.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-28T18:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467089",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467090.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-05-09T04:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467090",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467091.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-09T04:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467091",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467092.json:
```json
{
    "body": "Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `",
    "created_at": "2022-05-09T04:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467092",
    "user": "https://github.com/mkoeppe"
}
```

Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `



---

archive/issue_comments_467093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-06-09T20:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467094.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `\n\n\nThe above command works for me:\n\n```\n...\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 70.5 seconds\n    cpu time: 158.9 seconds\n    cumulative wall time: 240.4 seconds\nFeatures detected for doctesting: sage.groups,sage.rings.padics,sagemath_doc_html,sphinx\n```",
    "created_at": "2022-06-24T08:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467094",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:25 mkoeppe]:
> Test with `git grep -l 'sage:.*cython(' | xargs ./sage -tp --long --optional 'sage,!sage.misc.cython' `


The above command works for me:

```
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 70.5 seconds
    cpu time: 158.9 seconds
    cumulative wall time: 240.4 seconds
Features detected for doctesting: sage.groups,sage.rings.padics,sagemath_doc_html,sphinx
```



---

archive/issue_comments_467095.json:
```json
{
    "body": "The only reported test failure is:\n\n```\n----------------------------------------------------------------------\nsage -t --long --random-seed=338071419821968503909259763280493589917 src/sage/modular/overconvergent/hecke_series.py  # Timed out\n----------------------------------------------------------------------\n```\nwhich is not related to this ticket.",
    "created_at": "2022-06-24T08:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467095",
    "user": "https://github.com/seblabbe"
}
```

The only reported test failure is:

```
----------------------------------------------------------------------
sage -t --long --random-seed=338071419821968503909259763280493589917 src/sage/modular/overconvergent/hecke_series.py  # Timed out
----------------------------------------------------------------------
```
which is not related to this ticket.



---

archive/issue_comments_467096.json:
```json
{
    "body": "Patchbot pyflakes suggests 4 corrections:\n\n```\nsrc/sage/env.py:32:1 'sage' imported but unused\nsrc/sage/misc/cython.py:295:9 'setuptools' imported but unused\nsrc/sage/misc/sagedoc.py:791:9 'sage.all' imported but unused\nsrc/sage/misc/sagedoc.py:969:5 local variable 'html_results' is assigned to but never used\n```\nbut I suggest to fix them in another ticket : #34061.",
    "created_at": "2022-06-24T08:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467096",
    "user": "https://github.com/seblabbe"
}
```

Patchbot pyflakes suggests 4 corrections:

```
src/sage/env.py:32:1 'sage' imported but unused
src/sage/misc/cython.py:295:9 'setuptools' imported but unused
src/sage/misc/sagedoc.py:791:9 'sage.all' imported but unused
src/sage/misc/sagedoc.py:969:5 local variable 'html_results' is assigned to but never used
```
but I suggest to fix them in another ticket : #34061.



---

archive/issue_comments_467097.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-06-24T08:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467097",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467098.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-03T22:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32792#issuecomment-467098",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087280.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-07-03T22:06:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32792",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32792#event-87280"
}
```
