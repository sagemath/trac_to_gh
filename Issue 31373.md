# Issue 31373: PolyBori-Bug

archive/issues_031373.json:
```json
{
    "body": "CC:  @kiwifb @fchapoton\n\nKeywords: BRiAL, PyPolyBoRi, degrevlex\n\nHello all,\n\nI'd just like to report a bug inside the interface of PolyBori (BRiAL). It seems, that the load command doesn't work correctly when the term ordering is 'revlex' or 'degrevlex'. \n\nFor example using the following commands, one can create a Boolean ideal, store and again load it into the work space.\n\n```\nnames = ['x%d' % i for i in [0 .. 100]]\nBPR = BooleanPolynomialRing(names=names, order='deglex')\nrandom_samples = [BPR.random_element() for _ in [0 .. 100]]\nrandom_ideal = ideal(random_samples)\nsave(random_ideal, 'random_ideal')\nreset()\nID = load('random_ideal.sobj')\n```\n\nHowever, as you can see in the following lines, if the term ordering is set to 'degrevlex', the `load` command produces an error.\n\n```\nnames = ['x%d' % i for i in [0 .. 100]]\nBPR = BooleanPolynomialRing(names=names, order='degrevlex')\nrandom_samples = [BPR.random_element() for _ in [0 .. 100]]\nrandom_ideal = ideal(random_samples)\nsave(random_ideal, 'random_ideal')\nreset()\nID = load('random_ideal.sobj')\n```\n\nError: \n\n```\nKeyError                                  Traceback (most recent call last)\nsage-9-1/SageMath/local/lib/python3.7/site-packages/sage/all_cmdline.py in <module>()\n      5 save(random_ideal, 'random_ideal')\n      6 reset()\n\n---\n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (build/cythonized/sage/misc/persist.c:2900)()\n    156 \n    157     ## Load file by absolute filename\n--> 158     with open(filename, 'rb') as fobj:\n    159         X = loads(fobj.read(), compress=compress, **kwargs)\n    160     try:\n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (build/cythonized/sage/misc/persist.c:2850)()\n    157     ## Load file by absolute filename\n    158     with open(filename, 'rb') as fobj:\n--> 159         X = loads(fobj.read(), compress=compress, **kwargs)\n    160     try:\n    161         X._default_filename = os.path.abspath(filename)\n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7424)()\n   1042 \n   1043     unpickler = SageUnpickler(io.BytesIO(s), **kwargs)\n-> 1044     return unpickler.load()\n   1045 \n   1046 \n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/sage/rings/polynomial/pbori.pyx in sage.rings.polynomial.pbori.unpickle_BooleanPolynomial0 (build/cythonized/sage/rings/polynomial/pbori.cpp:59767)()\n   7837     \"\"\"\n   7838     from brial.parallel import _decode_polynomial\n-> 7839     return _decode_polynomial(l)\n   7840 \n   7841 \n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/brial/parallel.py in _decode_polynomial(code)\n    154 \n    155 def _decode_polynomial(code):\n--> 156     return from_fast_pickable(*code)[0]\n    157 \n    158 \n\nsage-9-1/SageMath/local/lib/python3.7/site-packages/brial/parallel.py in from_fast_pickable(l, r)\n    137     for i in reversed(range(len(terms))):\n    138         (v, t, e) = terms[i]\n--> 139         t = i2poly[t]\n    140         e = i2poly[e]\n    141         terms[i] = if_then_else(v, t, e)\n\nKeyError: 3\n```\n\nThe version of [SageMath](SageMath) as well as the specification of the operating system for which the above issue has been observed are as follows:\n\n```\nSageMath version 9.1, Release Date: 2020-05-20\nLinux hosein 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\n```\n\nIt should be noted that the same issue exists for [SageMath](SageMath) version 9.1 running on Windows 10.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31610\n\n",
    "created_at": "2021-04-05T11:59:05Z",
    "labels": [
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "PolyBori-Bug",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31373",
    "user": "https://github.com/hadipourh"
}
```
CC:  @kiwifb @fchapoton

Keywords: BRiAL, PyPolyBoRi, degrevlex

Hello all,

I'd just like to report a bug inside the interface of PolyBori (BRiAL). It seems, that the load command doesn't work correctly when the term ordering is 'revlex' or 'degrevlex'. 

For example using the following commands, one can create a Boolean ideal, store and again load it into the work space.

```
names = ['x%d' % i for i in [0 .. 100]]
BPR = BooleanPolynomialRing(names=names, order='deglex')
random_samples = [BPR.random_element() for _ in [0 .. 100]]
random_ideal = ideal(random_samples)
save(random_ideal, 'random_ideal')
reset()
ID = load('random_ideal.sobj')
```

However, as you can see in the following lines, if the term ordering is set to 'degrevlex', the `load` command produces an error.

```
names = ['x%d' % i for i in [0 .. 100]]
BPR = BooleanPolynomialRing(names=names, order='degrevlex')
random_samples = [BPR.random_element() for _ in [0 .. 100]]
random_ideal = ideal(random_samples)
save(random_ideal, 'random_ideal')
reset()
ID = load('random_ideal.sobj')
```

Error: 

```
KeyError                                  Traceback (most recent call last)
sage-9-1/SageMath/local/lib/python3.7/site-packages/sage/all_cmdline.py in <module>()
      5 save(random_ideal, 'random_ideal')
      6 reset()

---

sage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (build/cythonized/sage/misc/persist.c:2900)()
    156 
    157     ## Load file by absolute filename
--> 158     with open(filename, 'rb') as fobj:
    159         X = loads(fobj.read(), compress=compress, **kwargs)
    160     try:

sage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (build/cythonized/sage/misc/persist.c:2850)()
    157     ## Load file by absolute filename
    158     with open(filename, 'rb') as fobj:
--> 159         X = loads(fobj.read(), compress=compress, **kwargs)
    160     try:
    161         X._default_filename = os.path.abspath(filename)

sage-9-1/SageMath/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7424)()
   1042 
   1043     unpickler = SageUnpickler(io.BytesIO(s), **kwargs)
-> 1044     return unpickler.load()
   1045 
   1046 

sage-9-1/SageMath/local/lib/python3.7/site-packages/sage/rings/polynomial/pbori.pyx in sage.rings.polynomial.pbori.unpickle_BooleanPolynomial0 (build/cythonized/sage/rings/polynomial/pbori.cpp:59767)()
   7837     """
   7838     from brial.parallel import _decode_polynomial
-> 7839     return _decode_polynomial(l)
   7840 
   7841 

sage-9-1/SageMath/local/lib/python3.7/site-packages/brial/parallel.py in _decode_polynomial(code)
    154 
    155 def _decode_polynomial(code):
--> 156     return from_fast_pickable(*code)[0]
    157 
    158 

sage-9-1/SageMath/local/lib/python3.7/site-packages/brial/parallel.py in from_fast_pickable(l, r)
    137     for i in reversed(range(len(terms))):
    138         (v, t, e) = terms[i]
--> 139         t = i2poly[t]
    140         e = i2poly[e]
    141         terms[i] = if_then_else(v, t, e)

KeyError: 3
```

The version of [SageMath](SageMath) as well as the specification of the operating system for which the above issue has been observed are as follows:

```
SageMath version 9.1, Release Date: 2020-05-20
Linux hosein 5.4.0-70-generic #78-Ubuntu SMP Fri Mar 19 13:29:52 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
```

It should be noted that the same issue exists for [SageMath](SageMath) version 9.1 running on Windows 10.

Issue created by migration from https://trac.sagemath.org/ticket/31610





---

archive/issue_comments_448294.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2021-04-05T16:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31373#issuecomment-448294",
    "user": "https://github.com/mkoeppe"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_448295.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2021-04-05T16:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31373#issuecomment-448295",
    "user": "https://github.com/mkoeppe"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_comments_448296.json:
```json
{
    "body": "OK, it still happens in 9.3.rc1\n\n```\nsage: names = ['x%d' % i for i in [0 .. 100]]\n....: BPR = BooleanPolynomialRing(names=names, order='degrevlex')\n....: random_samples = [BPR.random_element() for _ in [0 .. 100]]\n....: random_ideal = ideal(random_samples)\n....: save(random_ideal, 'random_ideal')\n....: reset()\nsage: load('random_ideal.sobj')\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n/usr/lib/python3.9/site-packages/sage/all_cmdline.py in <module>\n----> 1 load('random_ideal.sobj')\n\n/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:2923)()\n    155 \n    156     ## Load file by absolute filename\n--> 157     with open(filename, 'rb') as fobj:\n    158         X = loads(fobj.read(), compress=compress, **kwargs)\n    159     try:\n\n/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:2873)()\n    156     ## Load file by absolute filename\n    157     with open(filename, 'rb') as fobj:\n--> 158         X = loads(fobj.read(), compress=compress, **kwargs)\n    159     try:\n    160         X._default_filename = os.path.abspath(filename)\n\n/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:7540)()\n    933 \n    934     unpickler = SageUnpickler(io.BytesIO(s), **kwargs)\n--> 935     return unpickler.load()\n    936 \n    937 \n\n/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/pbori.pyx in sage.rings.polynomial.pbori.pbori.unpickle_BooleanPolynomial0 (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/rings/polynomial/pbori/pbori.cpp:61426)()\n   7781     \"\"\"\n   7782     from sage.rings.polynomial.pbori.parallel import _decode_polynomial\n-> 7783     return _decode_polynomial(l)\n   7784 \n   7785 \n\n/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/parallel.py in _decode_polynomial(code)\n    166 \n    167 def _decode_polynomial(code):\n--> 168     return from_fast_pickable(*code)[0]\n    169 \n    170 \n\n/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/parallel.py in from_fast_pickable(l, r)\n    149     for i in reversed(range(len(terms))):\n    150         (v, t, e) = terms[i]\n--> 151         t = i2poly[t]\n    152         e = i2poly[e]\n    153         terms[i] = if_then_else(v, t, e)\n\nKeyError: 8\n```\nNot really my area of expertise, which is another reason it needed merging in sage. Fr\u00e9d\u00e9ric Chapoton may have a better idea of where the problem may be.",
    "created_at": "2021-04-05T20:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31373#issuecomment-448296",
    "user": "https://github.com/kiwifb"
}
```

OK, it still happens in 9.3.rc1

```
sage: names = ['x%d' % i for i in [0 .. 100]]
....: BPR = BooleanPolynomialRing(names=names, order='degrevlex')
....: random_samples = [BPR.random_element() for _ in [0 .. 100]]
....: random_ideal = ideal(random_samples)
....: save(random_ideal, 'random_ideal')
....: reset()
sage: load('random_ideal.sobj')
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/usr/lib/python3.9/site-packages/sage/all_cmdline.py in <module>
----> 1 load('random_ideal.sobj')

/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:2923)()
    155 
    156     ## Load file by absolute filename
--> 157     with open(filename, 'rb') as fobj:
    158         X = loads(fobj.read(), compress=compress, **kwargs)
    159     try:

/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.load (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:2873)()
    156     ## Load file by absolute filename
    157     with open(filename, 'rb') as fobj:
--> 158         X = loads(fobj.read(), compress=compress, **kwargs)
    159     try:
    160         X._default_filename = os.path.abspath(filename)

/usr/lib/python3.9/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/misc/persist.c:7540)()
    933 
    934     unpickler = SageUnpickler(io.BytesIO(s), **kwargs)
--> 935     return unpickler.load()
    936 
    937 

/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/pbori.pyx in sage.rings.polynomial.pbori.pbori.unpickle_BooleanPolynomial0 (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/build/cythonized/sage/rings/polynomial/pbori/pbori.cpp:61426)()
   7781     """
   7782     from sage.rings.polynomial.pbori.parallel import _decode_polynomial
-> 7783     return _decode_polynomial(l)
   7784 
   7785 

/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/parallel.py in _decode_polynomial(code)
    166 
    167 def _decode_polynomial(code):
--> 168     return from_fast_pickable(*code)[0]
    169 
    170 

/usr/lib/python3.9/site-packages/sage/rings/polynomial/pbori/parallel.py in from_fast_pickable(l, r)
    149     for i in reversed(range(len(terms))):
    150         (v, t, e) = terms[i]
--> 151         t = i2poly[t]
    152         e = i2poly[e]
    153         terms[i] = if_then_else(v, t, e)

KeyError: 8
```
Not really my area of expertise, which is another reason it needed merging in sage. Frédéric Chapoton may have a better idea of where the problem may be.



---

archive/issue_events_083185.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83185"
}
```



---

archive/issue_comments_448297.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31373#issuecomment-448297",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_083186.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83186"
}
```



---

archive/issue_events_083187.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83187"
}
```



---

archive/issue_events_083188.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83188"
}
```



---

archive/issue_events_083189.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83189"
}
```



---

archive/issue_events_083190.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83190"
}
```



---

archive/issue_events_083191.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83191"
}
```



---

archive/issue_events_083192.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83192"
}
```



---

archive/issue_events_083193.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31373",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31373#event-83193"
}
```
