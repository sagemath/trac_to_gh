# Issue 24814: Add DESTDIR support to additional Python packages

archive/issues_024814.json:
```json
{
    "body": "Keywords: destdir cysignals pip setuptools pillow numpy\n\nThese are packages for which the `spkg-install` requires more than just `sdh_pip_install`.  See commit message for more details.\n\nImplements #23023 for:\n\n* cysignals\n* numpy\n* pillow\n* pip\n* setuptools\n\nIssue created by migration from https://trac.sagemath.org/ticket/25051\n\n",
    "created_at": "2018-03-28T13:59:11Z",
    "labels": [
        "build",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "Add DESTDIR support to additional Python packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24814",
    "user": "embray"
}
```
Keywords: destdir cysignals pip setuptools pillow numpy

These are packages for which the `spkg-install` requires more than just `sdh_pip_install`.  See commit message for more details.

Implements #23023 for:

* cysignals
* numpy
* pillow
* pip
* setuptools

Issue created by migration from https://trac.sagemath.org/ticket/25051





---

archive/issue_comments_348522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-28T13:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348522",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348523.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-03-28T14:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348523",
    "user": "embray"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_348524.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-28T22:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348524",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348525.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-29T09:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348525",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348526.json:
```json
{
    "body": "Rebased.\n----\nNew commits:",
    "created_at": "2018-03-29T09:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348526",
    "user": "embray"
}
```

Rebased.
----
New commits:



---

archive/issue_comments_348527.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-29T09:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348527",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348528.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-03-29T10:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348528",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_348529.json:
```json
{
    "body": "For `numpy`, the \"touching all includes\" should be obsolete because of the changes to tarball extraction.",
    "created_at": "2018-03-29T10:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348529",
    "user": "jdemeyer"
}
```

For `numpy`, the "touching all includes" should be obsolete because of the changes to tarball extraction.



---

archive/issue_comments_348530.json:
```json
{
    "body": "`--root` implies `--single-version-externally-managed`:\n\n```python\n    def finalize_options(self):\n        orig.install.finalize_options(self)\n        if self.root:\n            self.single_version_externally_managed = True\n        elif self.single_version_externally_managed:\n            if not self.root and not self.record:\n                raise DistutilsArgError(\n                    \"You must specify --record or --root when building system\"\n                    \" packages\"\n                )\n```\n\n\nMaybe you want to keep `--single-version-externally-managed` for clarity, but there is no need to.",
    "created_at": "2018-03-29T10:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348530",
    "user": "jdemeyer"
}
```

`--root` implies `--single-version-externally-managed`:

```python
    def finalize_options(self):
        orig.install.finalize_options(self)
        if self.root:
            self.single_version_externally_managed = True
        elif self.single_version_externally_managed:
            if not self.root and not self.record:
                raise DistutilsArgError(
                    "You must specify --record or --root when building system"
                    " packages"
                )
```


Maybe you want to keep `--single-version-externally-managed` for clarity, but there is no need to.



---

archive/issue_comments_348531.json:
```json
{
    "body": "If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?\n\nhttps://pypi.python.org/pypi/pip",
    "created_at": "2018-03-29T10:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348531",
    "user": "jdemeyer"
}
```

If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?

https://pypi.python.org/pypi/pip



---

archive/issue_comments_348532.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> For `numpy`, the \"touching all includes\" should be obsolete because of the changes to tarball extraction.\n\n+1\n\nReplying to [comment:8 jdemeyer]:\n> `--root` implies `--single-version-externally-managed`\n\nWhat I'm not sure about here (I haven't tried it) is if `--root=\"\"` (e.g. if `$SAGE_DESTDIR`) were empty.  What I do know in that case is that if defaults `/`, but I don't know if it still automatically implies `--single-version-blah`.  I'd say it *should* but I don't know.  I think it's fine just to keep it.\n\nReplying to [comment:10 jdemeyer]:\n> If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?\n\nYeah, the thought did cross my mind.  Might as well.",
    "created_at": "2018-03-29T14:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348532",
    "user": "embray"
}
```

Replying to [comment:7 jdemeyer]:
> For `numpy`, the "touching all includes" should be obsolete because of the changes to tarball extraction.

+1

Replying to [comment:8 jdemeyer]:
> `--root` implies `--single-version-externally-managed`

What I'm not sure about here (I haven't tried it) is if `--root=""` (e.g. if `$SAGE_DESTDIR`) were empty.  What I do know in that case is that if defaults `/`, but I don't know if it still automatically implies `--single-version-blah`.  I'd say it *should* but I don't know.  I think it's fine just to keep it.

Replying to [comment:10 jdemeyer]:
> If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?

Yeah, the thought did cross my mind.  Might as well.



---

archive/issue_comments_348533.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-29T15:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348533",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348534.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-29T15:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348534",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_348535.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-03-29T15:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348535",
    "user": "embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_348536.json:
```json
{
    "body": "Testing...",
    "created_at": "2018-03-30T10:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348536",
    "user": "jdemeyer"
}
```

Testing...



---

archive/issue_comments_348537.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-30T15:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348537",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348538.json:
```json
{
    "body": "I'm instead dealing with cysignals in #25092.",
    "created_at": "2018-04-06T13:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348538",
    "user": "jdemeyer"
}
```

I'm instead dealing with cysignals in #25092.



---

archive/issue_comments_348539.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-04-06T13:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348539",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_348540.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-04-06T13:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348540",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_348541.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-04-06T13:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348541",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_348542.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-04-13T16:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348542",
    "user": "slelievre"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_348543.json:
```json
{
    "body": "Making this ticket a blocker: after PyPI disabled TLSv1 in early April 2018,\none can no longer pip-install anything with pip < 9.0.3 under macOS < 10.13.\nFor more detail on this, see\n\n- [StackOverflow answer 49748494](https://stackoverflow.com/a/49748494)",
    "created_at": "2018-04-13T16:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348543",
    "user": "slelievre"
}
```

Making this ticket a blocker: after PyPI disabled TLSv1 in early April 2018,
one can no longer pip-install anything with pip < 9.0.3 under macOS < 10.13.
For more detail on this, see

- [StackOverflow answer 49748494](https://stackoverflow.com/a/49748494)



---

archive/issue_comments_348544.json:
```json
{
    "body": "Have you actually verified this? We don't use system python...",
    "created_at": "2018-04-13T22:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348544",
    "user": "vbraun"
}
```

Have you actually verified this? We don't use system python...



---

archive/issue_comments_348545.json:
```json
{
    "body": "This doesn't have anything to do with the system Python.  It has to do with the server settings on PyPI itself, and hence how pip connects to it.  I was aware of this issue myself but I didn't really think about it in terms of Sage.\n\nAnyways, one can also manually download a tarball from PyPI and install it with pip.",
    "created_at": "2018-04-16T07:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348545",
    "user": "embray"
}
```

This doesn't have anything to do with the system Python.  It has to do with the server settings on PyPI itself, and hence how pip connects to it.  I was aware of this issue myself but I didn't really think about it in terms of Sage.

Anyways, one can also manually download a tarball from PyPI and install it with pip.



---

archive/issue_comments_348546.json:
```json
{
    "body": "Replying to [comment:20 vbraun]:\n> Have you actually verified this? We don't use system python...\n\nWithout this ticket, on macOS 10.10.5, since ~10 April 2018,\ntrying `sage --pip install jupyterlab` resulted in an error.\n\nAfter applying this ticket, it became possible again.",
    "created_at": "2018-04-16T11:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348546",
    "user": "slelievre"
}
```

Replying to [comment:20 vbraun]:
> Have you actually verified this? We don't use system python...

Without this ticket, on macOS 10.10.5, since ~10 April 2018,
trying `sage --pip install jupyterlab` resulted in an error.

After applying this ticket, it became possible again.



---

archive/issue_comments_348547.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-04-16T22:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24814#issuecomment-348547",
    "user": "vbraun"
}
```

Resolution: fixed
