# Issue 24814: Add DESTDIR support to additional Python packages

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-03-28 13:59:11

Keywords: destdir cysignals pip setuptools pillow numpy

These are packages for which the `spkg-install` requires more than just `sdh_pip_install`.  See commit message for more details.

Implements #23023 for:

* cysignals
* numpy
* pillow
* pip
* setuptools


---

Comment by embray created at 2018-03-28 13:59:20

Changing status from new to needs_review.


---

Comment by embray created at 2018-03-28 14:27:16

Changing type from PLEASE CHANGE to enhancement.


---

Comment by saraedum created at 2018-03-28 22:32:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-29 09:23:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-03-29 09:23:22

Rebased.
----
New commits:


---

Comment by embray created at 2018-03-29 09:23:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-29 10:39:48

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-03-29 10:39:48

For `numpy`, the "touching all includes" should be obsolete because of the changes to tarball extraction.


---

Comment by jdemeyer created at 2018-03-29 10:42:43

`--root` implies `--single-version-externally-managed`:

```python
    def finalize_options(self):
        orig.install.finalize_options(self)
        if self.root:
            self.single_version_externally_managed = True
        elif self.single_version_externally_managed:
            if not self.root and not self.record:
                raise DistutilsArgError(
                    "You must specify --record or --root when building system"
                    " packages"
                )
```


Maybe you want to keep `--single-version-externally-managed` for clarity, but there is no need to.


---

Comment by jdemeyer created at 2018-03-29 10:47:46

If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?

https://pypi.python.org/pypi/pip


---

Comment by embray created at 2018-03-29 14:04:31

Replying to [comment:7 jdemeyer]:
> For `numpy`, the "touching all includes" should be obsolete because of the changes to tarball extraction.

+1

Replying to [comment:8 jdemeyer]:
> `--root` implies `--single-version-externally-managed`

What I'm not sure about here (I haven't tried it) is if `--root=""` (e.g. if `$SAGE_DESTDIR`) were empty.  What I do know in that case is that if defaults `/`, but I don't know if it still automatically implies `--single-version-blah`.  I'd say it _should_ but I don't know.  I think it's fine just to keep it.

Replying to [comment:10 jdemeyer]:
> If you're changing `pip` anyway, would it make sense to upgrade to 9.0.3 while you're at it?

Yeah, the thought did cross my mind.  Might as well.


---

Comment by git created at 2018-03-29 15:12:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-29 15:13:12

New commits:


---

Comment by embray created at 2018-03-29 15:13:12

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2018-03-30 10:45:17

Testing...


---

Comment by jdemeyer created at 2018-03-30 15:29:25

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-04-06 13:12:08

I'm instead dealing with cysignals in #25092.


---

Comment by jdemeyer created at 2018-04-06 13:12:08

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2018-04-06 13:46:52

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2018-04-06 13:46:52

New commits:


---

Comment by slelievre created at 2018-04-13 16:08:03

Changing priority from major to blocker.


---

Comment by slelievre created at 2018-04-13 16:08:03

Making this ticket a blocker: after PyPI disabled TLSv1 in early April 2018,
one can no longer pip-install anything with pip < 9.0.3 under macOS < 10.13.
For more detail on this, see

- [StackOverflow answer 49748494](https://stackoverflow.com/a/49748494)


---

Comment by vbraun created at 2018-04-13 22:38:48

Have you actually verified this? We don't use system python...


---

Comment by embray created at 2018-04-16 07:42:28

This doesn't have anything to do with the system Python.  It has to do with the server settings on PyPI itself, and hence how pip connects to it.  I was aware of this issue myself but I didn't really think about it in terms of Sage.

Anyways, one can also manually download a tarball from PyPI and install it with pip.


---

Comment by slelievre created at 2018-04-16 11:12:18

Replying to [comment:20 vbraun]:
> Have you actually verified this? We don't use system python...

Without this ticket, on macOS 10.10.5, since ~10 April 2018,
trying `sage --pip install jupyterlab` resulted in an error.

After applying this ticket, it became possible again.


---

Comment by vbraun created at 2018-04-16 22:06:25

Resolution: fixed
