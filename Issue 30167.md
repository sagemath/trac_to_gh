# Issue 30167: Add pyright and pycodestyle checks as Github actions

Issue created by migration from https://trac.sagemath.org/ticket/30404

Original creator: @tobiasdiez

Original creation time: 2020-08-20 11:33:38

CC:  saraedum mkoeppe chapoton @mjungmath embray slelievre dimpase

Currently, the linters (pycodestyle, pyflakes, ...) run as plugins of patchbot. This has a few disadvantages: a) the lint results depend on the version of the tools installed by the owner of the patchbot b) it takes quite some time until the results are available and c) you need people to run the patchbot.

At https://github.com/sagemath/sage/pull/95 I added the pyright and pycodestyle checks as Github actions. They run really fast (about 10min), have reliable results as the version of the linters can be controlled and uses Github server instead of people's machines.

The pyright check currently fails, as there is no configuration file (which is added in #30361). The pycodestyle check also fails as there are currently over 600 errors that for some reason were missed by the patchbot (see https://github.com/tobiasdiez/sage/runs/1007221345?check_suite_focus=true) (I only activated those rules that are also run by the patchbot).

**Question 1:** What should be done about these errors?

**Question 2:** What is the best way apply the Github actions to new code contributions?

_Option A:_ Switch from trac to pull requests via Github (refs #30363)

_Option B:_ Mirror every branch on trac to Github (it's not clear to me how to best integrate the results from the Github actions then here on trac; one option would be to use the Github API to create pull requests automatically for each trac ticket)

_Option C:_ Integrate the Github actions directly in the patchbot (how?)


---

Comment by saraedum created at 2020-08-20 11:59:30

Option A: I think this is politically impossible. I know that some of the contributors here have (or at least had) strong feelings about github. That likely did not improve with Microsoft buying them.

Option B*: Every branch here is already mirrored on [GitLab](GitLab). I believe what's missing here is better docs: https://gitlab.com/sagemath/dev/trac

Option C*: You could add the linter to [GitLab](GitLab) CI. If I remember embray's comments correctly it's really easy to write a trac plugin that shows the gitlab CI status here on trac.


---

Comment by mkoeppe created at 2020-08-20 12:44:14

Note there's also https://github.com/sagemath/sagetrac-mirror - but I don't know at what intervals it is mirrored.


---

Comment by @tobiasdiez created at 2020-08-20 13:33:34

Perfect `@`mkoeppe! In this case, the integration should be fairly straightforward and amounts to adding the adding a link to the badge, by



```
<a href="https://github.com/sagemath/sagetrac-mirror/actions?query=workflow%3ALint+branch%3BRANCH"><img src="https://github.com/sagemath/sagetrac-mirror/workflows/Lint/badge.svg?branch=BRANCH&event=push"/></a>
```



Giving something similar to

![](https://github.com/tobiasdiez/sage/workflows/Lint/badge.svg?branch=patch-2&event=push)

with a link to https://github.com/tobiasdiez/sage/actions?query=workflow%3ALint+branch%3Apatch-2
(its sadly not possible to directly link to the workflow output)

This leaves the following todo list:
- Restrict current github actions to master and develop branch
- Activate gitub actions in sagetrac-mirror
- Add the link to the badge to trac

I can do the first task. Could somebody else then do point 2 and 3?


---

Comment by mkoeppe created at 2020-08-20 13:35:01

My suggestion is to first focus on local operation. For example, finding a place for the  pycodestyle configuration in the Sage source tree (this should not be configured in  `.github/workflows/`, nor in the patchbot sources!) -- perhaps this should go to `src/tox.ini`, and then provide corresponding documentation on how to run it and why. Next, change the patchbot so that it uses the configuration from that file. This will make sure that things don't fall out of sync.


---

Comment by slelievre created at 2020-08-20 14:28:19

Changing keywords from "" to "code style, lint".


---

Comment by slelievre created at 2020-08-20 14:28:19

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @tobiasdiez created at 2020-08-20 18:58:22

Moving the config to src/tox.ini is done in #30408.

Should I continue with the above plan and restrict the current github workflows to the master & develop branch?


---

Comment by mkoeppe created at 2020-08-21 00:18:52

Take a look at the other workflows from my portability tests. They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow


---

Comment by mkoeppe created at 2020-08-21 00:19:24

Replying to [comment:7 gh-tobiasdiez]:
> Moving the config to src/tox.ini is done in #30408.

You could make #30408 a dependency of this ticket & merge in the branch


---

Comment by @tobiasdiez created at 2020-08-22 11:12:57

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-08-22 11:12:57

I've now changed the workflow to use tox, which is enabled by #30408. Moreover, I realized based on the above comment by mkoeppe that the other Github actions are already restricted to only run on pushes with tags. Thus, they don't run on normal pushes to sagetrac-mirror, so no further action needed there.




> They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow

I think the lint workflow should run on every push and pull request. In this way, the developer gets immediate feedback, and this is similar to the patchbot that also runs on every "push".
Moreover, they run very quickly so there is no problem in running them on every push.

So this leaves the following todo's.
- Peer-review this ticket
- Activate gitub actions in sagetrac-mirror
- Merge the dependencies #30408, #30361
- Double check that the workflow runs successful on sagetrac-mirror
- Merge
- Add the link to the badge to trac as described above

Afterwards, the workflow can be extended to include further linters. It might also be good to later add a basic build & doctest workflow that runs on every push.
----
New commits:


---

Comment by mkoeppe created at 2020-09-05 18:49:57

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-09-05 20:09:58

`@`mkoeppe, what should I do here? The dependencies are rather indirect (it works without #30361, it just tests more code). Moreover, this github action is currently nowhere invoked and hence not checked / tested....


---

Comment by mkoeppe created at 2020-09-05 20:13:59

Ticket description: "The pyright check currently fails, as there is no configuration file"


---

Comment by @tobiasdiez created at 2020-09-06 11:36:08

Yes, but even with the configuration files added the github workflow fails as there is no typing information yet(and the one added in #29775 is not complete) and pycodestyle reports over 600 errors as well.

Fixing these points requires more effort from the whole sage community.

The aim of this ticket is to add the github actions so that one has a consistent check, which at some point in the future hopefully turns green.


---

Comment by @tobiasdiez created at 2020-09-06 11:36:08

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-09-18 21:52:24

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-09-18 21:52:24

Should invoke relint as well (added in #30467).


---

Comment by mkoeppe created at 2020-09-18 21:54:09

Could just run all tox environments...


---

Comment by git created at 2020-11-08 14:21:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-08 14:31:39

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-11-08 14:31:39

I've now added relint. This is now ready for review.


---

Comment by mkoeppe created at 2020-11-09 04:03:55

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-11-09 04:03:55

This seems to work well. 

I have moved the part of the ticket description that describes Trac integration to the new ticket #30877. But actually, given that the new push mirror for Trac ended up using GitLab instead of GitHub (see #30736), you should probably look into creating [GitLab](GitLab) pipelines for the same checks.


---

Comment by @tobiasdiez created at 2020-11-09 11:22:47

Thanks for the review!

I think you can make a good argument to have both Gitlab as well as Github as push mirrors.


---

Comment by chapoton created at 2020-11-09 14:36:48

reviewer name missing


---

Comment by vbraun created at 2020-11-20 22:15:09

Resolution: fixed
