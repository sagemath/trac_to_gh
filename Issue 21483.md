# Issue 21483: Fix some memory allocations in sparse_graph.pyx

Issue created by migration from https://trac.sagemath.org/ticket/21720

Original creator: jdemeyer

Original creation time: 2016-10-18 09:07:23

CC:  jmantysalo




---

Comment by jdemeyer created at 2016-10-18 10:22:08

New commits:


---

Comment by jdemeyer created at 2016-10-18 10:22:08

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2016-10-18 13:43:24

I don't know enough cython to review this, but at least it seems to work. With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`, with `2` the error message is `MemoryError: failed to allocate 1342177280 * 8 bytes`.


---

Comment by jmantysalo created at 2016-10-18 14:07:26

Btw, is there same problem for example in `src/sage/combinat/degree_sequences.pyx`


```
    sig_on()
    seq = <unsigned char *> sig_malloc((n+1)*sizeof(unsigned char))
    memset(seq,0,(n+1)*sizeof(unsigned char))
    sig_off()
```


?


---

Comment by jdemeyer created at 2016-10-18 14:42:35

I can't fix all problems in Sage...


---

Comment by jmantysalo created at 2016-10-18 14:56:43

Replying to [comment:10 jdemeyer]:
> I can't fix all problems in Sage...

I know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?


---

Comment by jdemeyer created at 2016-10-18 14:59:55

Replying to [comment:11 jmantysalo]:
> Replying to [comment:10 jdemeyer]:
> > I can't fix all problems in Sage...
> 
> I know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?

To be honest... unless you plan to fix it yourself, there is probably not much point.


---

Comment by jdemeyer created at 2016-10-18 15:01:03

Replying to [comment:8 jmantysalo]:
> With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`

What is "it" in the sentence above?


---

Comment by jmantysalo created at 2016-10-18 15:27:47

Replying to [comment:13 jdemeyer]:
> Replying to [comment:8 jmantysalo]:
> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`
> 
> What is "it" in the sentence above?

Error message.


---

Comment by jdemeyer created at 2016-10-18 15:53:07

Replying to [comment:14 jmantysalo]:
> Replying to [comment:13 jdemeyer]:
> > Replying to [comment:8 jmantysalo]:
> > > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`
> > 
> > What is "it" in the sentence above?
> 
> Error message.

The error message when doing _what_?


---

Comment by jmantysalo created at 2016-10-18 15:56:09

Uh, sorry. I tested `Graph(10^10)`, but wrote that only in sage-devel, not here.


---

Comment by jdemeyer created at 2016-10-18 20:21:58

Replying to [comment:13 jdemeyer]:
> Replying to [comment:8 jmantysalo]:
> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`

By the way, this number shows that some integer overflow is happening also (a different issue from this ticket).

The number 18446744072098938880 equals `<size_t><int>(10 << 28)` where the correct value would be just `<size_t>(10 << 28)` = 2684354560.


---

Comment by jdemeyer created at 2016-11-02 11:15:09

Please review...


---

Comment by mmezzarobba created at 2016-11-02 12:52:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-07 18:27:42

Resolution: fixed
