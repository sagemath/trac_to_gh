# Issue 23672: GCD for univariate polynomials over fraction fields

archive/issues_023672.json:
```json
{
    "body": "CC:  @mezzarobba\n\nKeywords: gcd, univariate polynomials, fraction fields as coefficients\n\nSome of the sagemath packages we use requires us to compute the GCD of univariate polynomials whose coefficient ring is the fraction field of multivariate polynomials over integral domains like Z, e.g: polynomials in the ring Frac(Z[x,y])[z]. \n\\\\\nRight now in Sagemath if we run  the following example, the regular Euclidean algorithm implemented in rings.py for computing gcd is called. It is very slow and the implementation hangs for degrees >4. \n\\\\\n**Example :**\n\\\\\nsage: A.<x,y>=ZZ[]\n\\\\\nsage: B= Frac(A)\n\\\\\nsage: C.<z> = B[]\n\\\\\nsage: p = C.random_element(6)\n\\\\\nsage: q = C.random_element(6)\n\\\\\nsage: gcd(p,q)\n\\\\\nHangs!\n\\\\\n**Reason for the function to hang :** It repeatedly has to call the multiplication function which calls  the gcd function in multi_polynomial_libsingular.pyx and therefore is slow. \n\\\\\n**Proposed Change:** Add a new function _gcd_univariate_polynomial()  inside the class, class FractionField_generic(ring.Field). It can be found in /src/sage/rings/fraction_field.py.\n\\\\\n\\\\\nThis new function flattens the polynomial (which has coefficients from a fractional field of a multivariate polynomial ring) by dividing with the GCD of the coefficient polynomials. It then considers the polynomial as a multivariate polynomial in all the variables and therefore there is only one call to the multivariate gcd function. Hence this new implementation even for degree = 30 returns the gcd within seconds.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23909\n\n",
    "created_at": "2017-09-21T09:32:32Z",
    "labels": [
        "component: algebra",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "GCD for univariate polynomials over fraction fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23672",
    "user": "https://trac.sagemath.org/admin/accounts/users/mfrancis"
}
```
CC:  @mezzarobba

Keywords: gcd, univariate polynomials, fraction fields as coefficients

Some of the sagemath packages we use requires us to compute the GCD of univariate polynomials whose coefficient ring is the fraction field of multivariate polynomials over integral domains like Z, e.g: polynomials in the ring Frac(Z[x,y])[z]. 
\\
Right now in Sagemath if we run  the following example, the regular Euclidean algorithm implemented in rings.py for computing gcd is called. It is very slow and the implementation hangs for degrees >4. 
\\
**Example :**
\\
sage: A.<x,y>=ZZ[]
\\
sage: B= Frac(A)
\\
sage: C.<z> = B[]
\\
sage: p = C.random_element(6)
\\
sage: q = C.random_element(6)
\\
sage: gcd(p,q)
\\
Hangs!
\\
**Reason for the function to hang :** It repeatedly has to call the multiplication function which calls  the gcd function in multi_polynomial_libsingular.pyx and therefore is slow. 
\\
**Proposed Change:** Add a new function _gcd_univariate_polynomial()  inside the class, class FractionField_generic(ring.Field). It can be found in /src/sage/rings/fraction_field.py.
\\
\\
This new function flattens the polynomial (which has coefficients from a fractional field of a multivariate polynomial ring) by dividing with the GCD of the coefficient polynomials. It then considers the polynomial as a multivariate polynomial in all the variables and therefore there is only one call to the multivariate gcd function. Hence this new implementation even for degree = 30 returns the gcd within seconds.

Issue created by migration from https://trac.sagemath.org/ticket/23909





---

archive/issue_comments_331193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-21T09:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331193",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331194.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-21T11:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331194",
    "user": "https://trac.sagemath.org/admin/accounts/users/mfrancis"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_331195.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-25T18:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331195",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_331196.json:
```json
{
    "body": "This change breaks many gcd computations that now work.  For example\n\n```\nsage: Q.<x> = B[]\nsage: F = Q.fraction_field()\nsage: R.<y> = F[]\nsage: f = (y + x)^2 * (y - 1/x)^3\nsage: g = (y + x)^4 * (y - 1/x)^2\nsage: gcd(f,g)\n```\n\nWhen `B` is `ZZ` or `Zmod(5)` or `GaussianIntegers()`, we get answers in Sage as it is. With your change, all of them raise a `TypeError` on some internal `gcd` call.\n\nMoreover, the result of `gcd` should be in the same ring as the arguments.  We do not always get that with this change.",
    "created_at": "2017-09-25T18:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331196",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

This change breaks many gcd computations that now work.  For example

```
sage: Q.<x> = B[]
sage: F = Q.fraction_field()
sage: R.<y> = F[]
sage: f = (y + x)^2 * (y - 1/x)^3
sage: g = (y + x)^4 * (y - 1/x)^2
sage: gcd(f,g)
```

When `B` is `ZZ` or `Zmod(5)` or `GaussianIntegers()`, we get answers in Sage as it is. With your change, all of them raise a `TypeError` on some internal `gcd` call.

Moreover, the result of `gcd` should be in the same ring as the arguments.  We do not always get that with this change.



---

archive/issue_comments_331197.json:
```json
{
    "body": "Made the changes : 1. Corrected it for Z, finite fields ( fields defined as Z mod p call the previous implementation, the usual Euclidean algorithm), and the returned gcd is the same ring as the input polynomials. \n----\nNew commits:",
    "created_at": "2018-02-24T21:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331197",
    "user": "https://trac.sagemath.org/admin/accounts/users/mfrancis"
}
```

Made the changes : 1. Corrected it for Z, finite fields ( fields defined as Z mod p call the previous implementation, the usual Euclidean algorithm), and the returned gcd is the same ring as the input polynomials. 
----
New commits:



---

archive/issue_comments_331198.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-25T11:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331198",
    "user": "https://trac.sagemath.org/admin/accounts/users/mfrancis"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_331199.json:
```json
{
    "body": "The documentation is badly misformatted. See http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings\n\nAnd this is completely unreadable:\n\n```\nif (is_IntegerRing(f.base_ring().base_ring()) == True or is_IntegerRing(g.base_ring().base_ring())== True or (f.base_ring().base_ring().is_field() == True and (is_IntegerModRing(f.base_ring().base_ring()) == False or is_FiniteField(f.base_ring().base_ring()) == True)) or (g.base_ring().base_ring().is_field() == True and (is_IntegerModRing(g.base_ring().base_ring()) == False or is_FiniteField(g.base_ring().base_ring()) == True)) ) :\n```\n",
    "created_at": "2018-02-26T06:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331199",
    "user": "https://github.com/jdemeyer"
}
```

The documentation is badly misformatted. See http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings

And this is completely unreadable:

```
if (is_IntegerRing(f.base_ring().base_ring()) == True or is_IntegerRing(g.base_ring().base_ring())== True or (f.base_ring().base_ring().is_field() == True and (is_IntegerModRing(f.base_ring().base_ring()) == False or is_FiniteField(f.base_ring().base_ring()) == True)) or (g.base_ring().base_ring().is_field() == True and (is_IntegerModRing(g.base_ring().base_ring()) == False or is_FiniteField(g.base_ring().base_ring()) == True)) ) :
```




---

archive/issue_comments_331200.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-26T06:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331200",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_331201.json:
```json
{
    "body": "Hi Maria,\n\nAs it turns out, most of the necessary work had already been done in the implementation of `gcd()` for polynomials over polynomial rings. Here is a simpler implementation that takes advantage of that.\n\n(Sorry that it took me so incredibly long to have a stab at this as promised!)\n----\nNew commits:",
    "created_at": "2018-04-23T16:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331201",
    "user": "https://github.com/mezzarobba"
}
```

Hi Maria,

As it turns out, most of the necessary work had already been done in the implementation of `gcd()` for polynomials over polynomial rings. Here is a simpler implementation that takes advantage of that.

(Sorry that it took me so incredibly long to have a stab at this as promised!)
----
New commits:



---

archive/issue_comments_331202.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-23T16:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331202",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_331203.json:
```json
{
    "body": "~~Note: this does break~~\n\n```\nsage: Pol = Frac(QQ['x'])['x']\nsage: p = Frac(QQ['x'])['x'].one()\nsage: p.gcd(p)\n...\nValueError: variable name 'x' appears more than once\n```\n\n~~because the same thing with polynomials over a *polynomial* ring is already broken, see #25233. I think this is an acceptable regression, at least temporarily...~~ Edit: fixed at #25233!",
    "created_at": "2018-04-23T16:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331203",
    "user": "https://github.com/mezzarobba"
}
```

~~Note: this does break~~

```
sage: Pol = Frac(QQ['x'])['x']
sage: p = Frac(QQ['x'])['x'].one()
sage: p.gcd(p)
...
ValueError: variable name 'x' appears more than once
```

~~because the same thing with polynomials over a *polynomial* ring is already broken, see #25233. I think this is an acceptable regression, at least temporarily...~~ Edit: fixed at #25233!



---

archive/issue_comments_331204.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-24T08:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331204",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_331205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-24T08:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331205",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_331206.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-24T09:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331206",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_331207.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-24T11:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331207",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_331208.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-26T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331208",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331209.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-11T18:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331209",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_331210.json:
```json
{
    "body": "See also #25318 for an additional improvement.",
    "created_at": "2018-05-11T19:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331210",
    "user": "https://github.com/mezzarobba"
}
```

See also #25318 for an additional improvement.



---

archive/issue_comments_331211.json:
```json
{
    "body": "As far as I can tell, the last two patchbot failures are not related to this ticket\u2014i.e. the tests still pass with sage-8.3.beta3.",
    "created_at": "2018-05-29T09:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331211",
    "user": "https://github.com/mezzarobba"
}
```

As far as I can tell, the last two patchbot failures are not related to this ticketâ€”i.e. the tests still pass with sage-8.3.beta3.



---

archive/issue_comments_331212.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-10T09:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331212",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_331213.json:
```json
{
    "body": "Looks good to me, except the docstring. Could you add a short description?",
    "created_at": "2018-06-18T17:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331213",
    "user": "https://github.com/bgrenet"
}
```

Looks good to me, except the docstring. Could you add a short description?



---

archive/issue_comments_331214.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-19T07:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331214",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331215.json:
```json
{
    "body": "Replying to [comment:20 bruno]:\n> Looks good to me, except the docstring. Could you add a short description?\n\nDone, thanks for your commment!",
    "created_at": "2018-06-19T07:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331215",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:20 bruno]:
> Looks good to me, except the docstring. Could you add a short description?

Done, thanks for your commment!



---

archive/issue_comments_331216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-19T07:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331216",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331217.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-06-21T17:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331217",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_331218.json:
```json
{
    "body": "Reviewer name is missing",
    "created_at": "2018-06-21T17:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331218",
    "user": "https://github.com/vbraun"
}
```

Reviewer name is missing



---

archive/issue_comments_331219.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-06-21T19:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331219",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_331220.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-23T19:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23672#issuecomment-331220",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_022173.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-23T19:58:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23672",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23672#event-22173"
}
```
