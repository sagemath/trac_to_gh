# Issue 27950: Make _derivative consistent

Issue created by migration from https://trac.sagemath.org/ticket/28187

Original creator: bruno

Original creation time: 2019-07-13 08:48:53

Keywords: polynomial derivative

Derivation with respect to `var` has different behaviors for polynomials. Basically, the first test that is performed is whether `var` is the generator of the polynomial ring. But the test is performed in two different ways depending on the implementations:

* Either `var is self._parent.gen()` (or equivalent);
* Or `var == self._parent.gen()`.

The consequence is as follows:


```python
sage: R = PolynomialRing(ZZ, 'x')
sage: R.gen().derivative(x) # implemented with ==
1 
sage: R = PolynomialRing(ZZ, 'x', sparse=True)
sage: R.gen().derivative(x) # implemented with is
Traceback (most recent call last):
...
AttributeError: 'sage.rings.integer.Integer' object has no attribute '_derivative'
```


My proposal is to replace all the `is`'s by `==`'s. It also solves problems with derivatives of rational functions, see #26844. 

In the same ticket, I'd like to make the derivative with respect to a non existing variable return `0` rather than raising an exception.

Altogether, the behavior for univariate polynomials is the following after my changes, consistently:

* `p.derivative(x)` returns the derivative of `p` if `bool(x == p.parent().gen())` returns `True` (it includes the case where `x` is not the generator itself, but the string used for the variable of the polynomial ring is `'x'` for instance);
* `p.derivative(t)` (with `t != p.parent().gen()`) returns the polynomial obtained after derivation of each coefficient of `p` with respect to `t` (extra care must be taken since one cannot always use a derivative on the coefficients, so exceptions must be caught).


---

Comment by git created at 2019-07-13 15:22:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2019-07-13 15:27:18

Changing status from new to needs_review.


---

Comment by git created at 2019-07-13 15:48:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-08-29 13:29:34

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-08-29 13:29:34

red branch, needs rebase


---

Comment by git created at 2019-09-12 13:29:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by bruno created at 2019-09-12 13:30:17

Changing status from needs_work to needs_review.


---

Comment by bruno created at 2019-09-12 13:30:17

Rebased!


---

Comment by tscrim created at 2019-09-13 01:12:57

It definitely should not be using `is` for comparison as

```
sage: R.<x> = ZZ[]
sage: 1*x is x
False
sage: 1*x == x
True
```

So I think it is too easy to pass something that `==` to a generator but not `is` a generator.

Two little things that once done you can set a positive review on my behalf. This needs a blank line:

```diff
         Check that :trac:`28187` is fixed::
+
             sage: x = var("x")
             sage: f._derivative(x)
             4*x^3 - 1
```

This is just some PEP8 cleanup to make the code look nicer (while we are at it):

```diff
-                return P({n:self.__coeffs[n]._derivative(var) \
-                            for n in self.__coeffs})
+                return P({n:self.__coeffs[n]._derivative(var)
+                           for n in self.__coeffs})
```



---

Comment by git created at 2019-09-13 12:44:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2019-09-13 12:45:30

Changing status from needs_review to positive_review.


---

Comment by bruno created at 2019-09-13 12:45:30

Thank you!


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-06 23:06:54

Resolution: fixed
