# Issue 27950: Make _derivative consistent

archive/issues_027950.json:
```json
{
    "body": "Keywords: polynomial derivative\n\nDerivation with respect to `var` has different behaviors for polynomials. Basically, the first test that is performed is whether `var` is the generator of the polynomial ring. But the test is performed in two different ways depending on the implementations:\n\n* Either `var is self._parent.gen()` (or equivalent);\n* Or `var == self._parent.gen()`.\n\nThe consequence is as follows:\n\n\n```python\nsage: R = PolynomialRing(ZZ, 'x')\nsage: R.gen().derivative(x) # implemented with ==\n1 \nsage: R = PolynomialRing(ZZ, 'x', sparse=True)\nsage: R.gen().derivative(x) # implemented with is\nTraceback (most recent call last):\n...\nAttributeError: 'sage.rings.integer.Integer' object has no attribute '_derivative'\n```\n\n\nMy proposal is to replace all the `is`'s by `==`'s. It also solves problems with derivatives of rational functions, see #26844. \n\nIn the same ticket, I'd like to make the derivative with respect to a non existing variable return `0` rather than raising an exception.\n\nAltogether, the behavior for univariate polynomials is the following after my changes, consistently:\n\n* `p.derivative(x)` returns the derivative of `p` if `bool(x == p.parent().gen())` returns `True` (it includes the case where `x` is not the generator itself, but the string used for the variable of the polynomial ring is `'x'` for instance);\n* `p.derivative(t)` (with `t != p.parent().gen()`) returns the polynomial obtained after derivation of each coefficient of `p` with respect to `t` (extra care must be taken since one cannot always use a derivative on the coefficients, so exceptions must be caught).\n\nIssue created by migration from https://trac.sagemath.org/ticket/28187\n\n",
    "created_at": "2019-07-13T08:48:53Z",
    "labels": [
        "algebra",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Make _derivative consistent",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27950",
    "user": "@bgrenet"
}
```
Keywords: polynomial derivative

Derivation with respect to `var` has different behaviors for polynomials. Basically, the first test that is performed is whether `var` is the generator of the polynomial ring. But the test is performed in two different ways depending on the implementations:

* Either `var is self._parent.gen()` (or equivalent);
* Or `var == self._parent.gen()`.

The consequence is as follows:


```python
sage: R = PolynomialRing(ZZ, 'x')
sage: R.gen().derivative(x) # implemented with ==
1 
sage: R = PolynomialRing(ZZ, 'x', sparse=True)
sage: R.gen().derivative(x) # implemented with is
Traceback (most recent call last):
...
AttributeError: 'sage.rings.integer.Integer' object has no attribute '_derivative'
```


My proposal is to replace all the `is`'s by `==`'s. It also solves problems with derivatives of rational functions, see #26844. 

In the same ticket, I'd like to make the derivative with respect to a non existing variable return `0` rather than raising an exception.

Altogether, the behavior for univariate polynomials is the following after my changes, consistently:

* `p.derivative(x)` returns the derivative of `p` if `bool(x == p.parent().gen())` returns `True` (it includes the case where `x` is not the generator itself, but the string used for the variable of the polynomial ring is `'x'` for instance);
* `p.derivative(t)` (with `t != p.parent().gen()`) returns the polynomial obtained after derivation of each coefficient of `p` with respect to `t` (extra care must be taken since one cannot always use a derivative on the coefficients, so exceptions must be caught).

Issue created by migration from https://trac.sagemath.org/ticket/28187





---

archive/issue_comments_394745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-13T15:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394745",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394746.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-13T15:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394746",
    "user": "@bgrenet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_394747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-13T15:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394747",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394748.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-29T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394748",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_394749.json:
```json
{
    "body": "red branch, needs rebase",
    "created_at": "2019-08-29T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394749",
    "user": "@fchapoton"
}
```

red branch, needs rebase



---

archive/issue_comments_394750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-12T13:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394750",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_394751.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-12T13:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394751",
    "user": "@bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_394752.json:
```json
{
    "body": "Rebased!",
    "created_at": "2019-09-12T13:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394752",
    "user": "@bgrenet"
}
```

Rebased!



---

archive/issue_comments_394753.json:
```json
{
    "body": "It definitely should not be using `is` for comparison as\n\n```\nsage: R.<x> = ZZ[]\nsage: 1*x is x\nFalse\nsage: 1*x == x\nTrue\n```\n\nSo I think it is too easy to pass something that `==` to a generator but not `is` a generator.\n\nTwo little things that once done you can set a positive review on my behalf. This needs a blank line:\n\n```diff\n         Check that :trac:`28187` is fixed::\n+\n             sage: x = var(\"x\")\n             sage: f._derivative(x)\n             4*x^3 - 1\n```\n\nThis is just some PEP8 cleanup to make the code look nicer (while we are at it):\n\n```diff\n-                return P({n:self.__coeffs[n]._derivative(var) \\\n-                            for n in self.__coeffs})\n+                return P({n:self.__coeffs[n]._derivative(var)\n+                           for n in self.__coeffs})\n```\n",
    "created_at": "2019-09-13T01:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394753",
    "user": "@tscrim"
}
```

It definitely should not be using `is` for comparison as

```
sage: R.<x> = ZZ[]
sage: 1*x is x
False
sage: 1*x == x
True
```

So I think it is too easy to pass something that `==` to a generator but not `is` a generator.

Two little things that once done you can set a positive review on my behalf. This needs a blank line:

```diff
         Check that :trac:`28187` is fixed::
+
             sage: x = var("x")
             sage: f._derivative(x)
             4*x^3 - 1
```

This is just some PEP8 cleanup to make the code look nicer (while we are at it):

```diff
-                return P({n:self.__coeffs[n]._derivative(var) \
-                            for n in self.__coeffs})
+                return P({n:self.__coeffs[n]._derivative(var)
+                           for n in self.__coeffs})
```




---

archive/issue_comments_394754.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T12:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394754",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-13T12:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394755",
    "user": "@bgrenet"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_394756.json:
```json
{
    "body": "Thank you!",
    "created_at": "2019-09-13T12:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394756",
    "user": "@bgrenet"
}
```

Thank you!



---

archive/issue_comments_394757.json:
```json
{
    "body": "moving milestone to 9.0 (after release of 8.9)",
    "created_at": "2019-09-30T08:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394757",
    "user": "@fchapoton"
}
```

moving milestone to 9.0 (after release of 8.9)



---

archive/issue_comments_394758.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-06T23:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27950#issuecomment-394758",
    "user": "@vbraun"
}
```

Resolution: fixed
