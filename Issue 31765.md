# Issue 31765: wrong selection of integrator in some cases

Issue created by migration from https://trac.sagemath.org/ticket/32002

Original creator: chapoton

Original creation time: 2021-06-18 07:08:46

CC:  tscrim slelievre

Keywords: integral

namely, when there is a common factor, maxima factors this out of the result. This prevents the automatic choice of integrator to work correctly, as it only looks wether the outer operator of the symbolic expression is an integral or not.


```
sage: integral(min(x,2*x),x,-1,1)                                               
-1/2
sage: integral(2*min(x,2*x),x,-1,1)                                             
2*integrate(min(2*x, x), x, -1, 1)
sage: integral(2*min(x,2*x),x,-1,1, algorithm='giac')                           
-1
```



---

Comment by chapoton created at 2021-06-18 07:30:58

New commits:


---

Comment by chapoton created at 2021-06-18 07:30:58

Changing status from new to needs_review.


---

Comment by git created at 2021-06-18 07:33:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-18 07:52:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-18 13:58:07

bot is morally green, please review

this may be just so slightly controversial, as it may replace "partial answers still containing an unknown integral" by just the initial unevaluated integral. One can still use the algorithm keyword to see the partial answers.


---

Comment by tscrim created at 2021-06-18 22:48:26

Do you have an example where this behavior changed? It's not so important, but perhaps you had something offhand about this to add an explanation about what to do for potentially getting partial answers.

Also, can you break the one really long line integral output?


---

Comment by git created at 2021-06-19 06:46:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-19 06:49:44

I have cut off the long doctest.

I have also added an example of partially-integrated answer returned by maxima. In this example, giac will give a full answer.


---

Comment by slelievre created at 2021-06-19 09:22:33

PEP8 recommends breaking lines before binary operators:

- [PEP8: Should a line break before or after a binary operator?](https://www.python.org/dev/peps/pep-0008/#should-a-line-break-before-or-after-a-binary-operator)

That's just a recommendation of course.


---

Comment by tscrim created at 2021-06-20 03:50:02

Thank you. I am good with this. If you want to incorporate Samuel's change, then go ahead. Either way you decide, you can set a positive review.


---

Comment by git created at 2021-06-20 06:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-20 06:22:18

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-06-20 06:22:18

ok, thanks. Done and now setting to positive


---

Comment by slelievre created at 2021-06-20 08:02:58

Slightly expanding the ticket description.
I agree with the positive review.


---

Comment by vbraun created at 2021-07-06 21:29:29

Resolution: fixed


---

Comment by arojas created at 2021-07-19 16:59:44

This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)

```
sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py", line 620, in sage.symbolic.integration.integral.integrate
Failed example:
    A = integral(1/ ((x-4) * (x^3+2*x+1)), x); A
Expected:
    integrate(1/((x^3 + 2*x + 1)*(x - 4)), x)
Got:
    -1/73*integrate((x^2 + 4*x + 18)/(x^3 + 2*x + 1), x) + 1/73*log(x - 4)
**********************************************************************
```



---

Comment by arojas created at 2021-07-19 19:40:26

The problem is that giac 1.7 can do the integral, but Sage doesn't understand the answer

```
sage: giac_integrator(1/((x^3 + 2*x + 1)*(x - 4)), x)
[...]
NotImplementedError: Unable to parse Giac output: 1/73*ln(abs(sageVARx-4))+((-292/9*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]])-3796)/(3*(1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])))/15987-1/219*ln(abs(sageVARx^3+2*sageVARx+1))
```



---

Comment by arojas created at 2021-07-25 11:30:50

Replying to [comment:16 arojas]:
> This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)

Fixed in #32275


---

Comment by slelievre created at 2021-08-09 22:54:25

Follow-up at #32184.
