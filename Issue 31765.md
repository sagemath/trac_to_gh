# Issue 31765: wrong selection of integrator in some cases

archive/issues_031765.json:
```json
{
    "body": "CC:  @tscrim @slel\n\nKeywords: integral\n\nnamely, when there is a common factor, maxima factors this out of the result. This prevents the automatic choice of integrator to work correctly, as it only looks wether the outer operator of the symbolic expression is an integral or not.\n\n\n```\nsage: integral(min(x,2*x),x,-1,1)                                               \n-1/2\nsage: integral(2*min(x,2*x),x,-1,1)                                             \n2*integrate(min(2*x, x), x, -1, 1)\nsage: integral(2*min(x,2*x),x,-1,1, algorithm='giac')                           \n-1\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32002\n\n",
    "created_at": "2021-06-18T07:08:46Z",
    "labels": [
        "component: calculus",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "wrong selection of integrator in some cases",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31765",
    "user": "https://github.com/fchapoton"
}
```
CC:  @tscrim @slel

Keywords: integral

namely, when there is a common factor, maxima factors this out of the result. This prevents the automatic choice of integrator to work correctly, as it only looks wether the outer operator of the symbolic expression is an integral or not.


```
sage: integral(min(x,2*x),x,-1,1)                                               
-1/2
sage: integral(2*min(x,2*x),x,-1,1)                                             
2*integrate(min(2*x, x), x, -1, 1)
sage: integral(2*min(x,2*x),x,-1,1, algorithm='giac')                           
-1
```


Issue created by migration from https://trac.sagemath.org/ticket/32002





---

archive/issue_comments_453366.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-18T07:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453366",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_453367.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-18T07:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453367",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T07:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453368",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453369.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T07:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453369",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453370.json:
```json
{
    "body": "bot is morally green, please review\n\nthis may be just so slightly controversial, as it may replace \"partial answers still containing an unknown integral\" by just the initial unevaluated integral. One can still use the algorithm keyword to see the partial answers.",
    "created_at": "2021-06-18T13:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453370",
    "user": "https://github.com/fchapoton"
}
```

bot is morally green, please review

this may be just so slightly controversial, as it may replace "partial answers still containing an unknown integral" by just the initial unevaluated integral. One can still use the algorithm keyword to see the partial answers.



---

archive/issue_comments_453371.json:
```json
{
    "body": "Do you have an example where this behavior changed? It's not so important, but perhaps you had something offhand about this to add an explanation about what to do for potentially getting partial answers.\n\nAlso, can you break the one really long line integral output?",
    "created_at": "2021-06-18T22:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453371",
    "user": "https://github.com/tscrim"
}
```

Do you have an example where this behavior changed? It's not so important, but perhaps you had something offhand about this to add an explanation about what to do for potentially getting partial answers.

Also, can you break the one really long line integral output?



---

archive/issue_comments_453372.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-19T06:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453372",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453373.json:
```json
{
    "body": "I have cut off the long doctest.\n\nI have also added an example of partially-integrated answer returned by maxima. In this example, giac will give a full answer.",
    "created_at": "2021-06-19T06:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453373",
    "user": "https://github.com/fchapoton"
}
```

I have cut off the long doctest.

I have also added an example of partially-integrated answer returned by maxima. In this example, giac will give a full answer.



---

archive/issue_comments_453374.json:
```json
{
    "body": "PEP8 recommends breaking lines before binary operators:\n\n- [PEP8: Should a line break before or after a binary operator?](https://www.python.org/dev/peps/pep-0008/#should-a-line-break-before-or-after-a-binary-operator)\n\nThat's just a recommendation of course.",
    "created_at": "2021-06-19T09:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453374",
    "user": "https://github.com/slel"
}
```

PEP8 recommends breaking lines before binary operators:

- [PEP8: Should a line break before or after a binary operator?](https://www.python.org/dev/peps/pep-0008/#should-a-line-break-before-or-after-a-binary-operator)

That's just a recommendation of course.



---

archive/issue_comments_453375.json:
```json
{
    "body": "Thank you. I am good with this. If you want to incorporate Samuel's change, then go ahead. Either way you decide, you can set a positive review.",
    "created_at": "2021-06-20T03:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453375",
    "user": "https://github.com/tscrim"
}
```

Thank you. I am good with this. If you want to incorporate Samuel's change, then go ahead. Either way you decide, you can set a positive review.



---

archive/issue_comments_453376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-20T06:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453376",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453377.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-20T06:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453377",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453378.json:
```json
{
    "body": "ok, thanks. Done and now setting to positive",
    "created_at": "2021-06-20T06:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453378",
    "user": "https://github.com/fchapoton"
}
```

ok, thanks. Done and now setting to positive



---

archive/issue_comments_453379.json:
```json
{
    "body": "Slightly expanding the ticket description.\nI agree with the positive review.",
    "created_at": "2021-06-20T08:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453379",
    "user": "https://github.com/slel"
}
```

Slightly expanding the ticket description.
I agree with the positive review.



---

archive/issue_events_028926.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-06T21:29:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31765#event-28926"
}
```



---

archive/issue_comments_453380.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-06T21:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453380",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_453381.json:
```json
{
    "body": "This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)\n\n```\nsage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py\n**********************************************************************\nFile \"/usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py\", line 620, in sage.symbolic.integration.integral.integrate\nFailed example:\n    A = integral(1/ ((x-4) * (x^3+2*x+1)), x); A\nExpected:\n    integrate(1/((x^3 + 2*x + 1)*(x - 4)), x)\nGot:\n    -1/73*integrate((x^2 + 4*x + 18)/(x^3 + 2*x + 1), x) + 1/73*log(x - 4)\n**********************************************************************\n```\n",
    "created_at": "2021-07-19T16:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453381",
    "user": "https://github.com/antonio-rojas"
}
```

This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)

```
sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/symbolic/integration/integral.py", line 620, in sage.symbolic.integration.integral.integrate
Failed example:
    A = integral(1/ ((x-4) * (x^3+2*x+1)), x); A
Expected:
    integrate(1/((x^3 + 2*x + 1)*(x - 4)), x)
Got:
    -1/73*integrate((x^2 + 4*x + 18)/(x^3 + 2*x + 1), x) + 1/73*log(x - 4)
**********************************************************************
```




---

archive/issue_comments_453382.json:
```json
{
    "body": "The problem is that giac 1.7 can do the integral, but Sage doesn't understand the answer\n\n```\nsage: giac_integrator(1/((x^3 + 2*x + 1)*(x - 4)), x)\n[...]\nNotImplementedError: Unable to parse Giac output: 1/73*ln(abs(sageVARx-4))+((-292/9*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]])-3796)/(3*(1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])))/15987-1/219*ln(abs(sageVARx^3+2*sageVARx+1))\n```\n",
    "created_at": "2021-07-19T19:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453382",
    "user": "https://github.com/antonio-rojas"
}
```

The problem is that giac 1.7 can do the integral, but Sage doesn't understand the answer

```
sage: giac_integrator(1/((x^3 + 2*x + 1)*(x - 4)), x)
[...]
NotImplementedError: Unable to parse Giac output: 1/73*ln(abs(sageVARx-4))+((-292/9*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]])-3796)/(3*(1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/27*rootof([[-3,0,-30,0,-48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,27,48],[1,0,12,0,36,0,59]]))+(-146/9*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])-3796)/(3*(1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]]))^2+2)*ln(sageVARx-1/54*rootof([[3,0,30,-27,48],[1,0,12,0,36,0,59]])))/15987-1/219*ln(abs(sageVARx^3+2*sageVARx+1))
```




---

archive/issue_comments_453383.json:
```json
{
    "body": "Replying to [comment:16 arojas]:\n> This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)\n\nFixed in #32275",
    "created_at": "2021-07-25T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453383",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:16 arojas]:
> This is causing one test failure here, with system giac 1.7.0-21 (but reproducible with any giac version >=1.7)

Fixed in #32275



---

archive/issue_comments_453384.json:
```json
{
    "body": "Follow-up at #32184.",
    "created_at": "2021-08-09T22:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31765",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31765#issuecomment-453384",
    "user": "https://github.com/slel"
}
```

Follow-up at #32184.
