# Issue 18001: Options ignored in show() of 3D objects

Issue created by migration from Trac.

Original creator: egourgoulhon

Original creation time: 2015-04-17 12:54:49

CC:  vbraun ncohen

Since Sage 6.6, the options passed to show() are not taken into account in 3D rendering:

```
sage: show(sphere(), figsize=10, frame=False, aspect_ratio=(1,1,0.5))
```

yields exactly the same result as

```
sage: show(sphere())
```

See this [sage-devel post](https://groups.google.com/d/msg/sage-devel/gcNhbllumg4/ECy5_wUgRqcJ).


---

Comment by egourgoulhon created at 2015-04-17 12:59:33

New commits:


---

Comment by egourgoulhon created at 2015-04-17 13:01:31

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-04-17 13:54:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-17 13:54:10

lgtm


---

Comment by ncohen created at 2015-04-17 14:06:43

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2015-04-17 14:06:43

Hellooooooooooo,

The problem is fixed indeed, but the way this `_process_viewing_options` function works it only stores in `opt` the function that are actually used later. It is well implemented: your original dictionary has been stripped of what is now in 'opt', but as a result we get:


```
sage: show(sphere(), heyheyhey=35) # no problem
```


Could you raise an exception whenever `kwds` is not empty after `_process_viewing_options` reduced it? Sometimes you type `fgisize=4` and can look for a while before you notice what exactly is going wrong.

Thanks,

Nathann


---

Comment by vbraun created at 2015-04-17 14:23:11

show shouldn't validate keyword arguments since it may have to fall back to another viewer. E.g if you don't have java then it'll fall back to tachyon and has to ignore jmol-specific arguments.


---

Comment by ncohen created at 2015-04-17 14:30:32

Hello,

> show shouldn't validate keyword arguments since it may have to fall back to another viewer. E.g if you don't have java then it'll fall back to tachyon and has to ignore jmol-specific arguments.

In the code there is a dictionary `kwds` which potentially contains parameters given by the user, yet it is never used.

It is easy to make everything work even when different viewers are available: if viewer X is used, send it all the arguments given by the user. If there is one that it does not understand, it will raise an exception.

Nathann


---

Comment by vbraun created at 2015-04-17 14:34:38

As I said, that is not desirable here since we might change the viewer depending on UI capabilities.

There should be some framework for keyword options, especially for plottig options, that can deal with this. But right now we have nothing better than passing dictionaries around, so we can't easily validate if *some* viewer uses an argument or not.


---

Comment by vbraun created at 2015-04-17 14:35:36

Changing status from needs_work to positive_review.


---

Comment by ncohen created at 2015-04-17 14:41:45

Hello,

> As I said, that is not desirable here since we might change the viewer depending on UI capabilities.
> 
> There should be some framework for keyword options, especially for plottig options, that can deal with this. But right now we have nothing better than passing dictionaries around, so we can't easily validate if *some* viewer uses an argument or not.

We do not have to validate it in this function. Here is an example


```
def viewerA(some_option=4):
    print "Plot with some_option={}".format(some_option)

def viewerB(some_other_option=4):
    print "Plot with some_other_option={}".format(some_other_option)

def plot(viewer="A",**args):
    r"""
    Plot an object with the selected viewer.

    All other options are forwarded to the actual viewer. See their
    documentation for more information.
    """
    if viewer=="A":
        viewerA(**args)
    elif viewer=="B":
        viewerB(**args)
    else:
        raise ValueError("viewer must be A or B")
```


As you can see no verification is done in the generic 'plot'. Then, everything works as expected:


```
sage: plot("A",some_option=4)
Plot with some_option=4
sage: plot("B",some_other_option=4)
Plot with some_other_option=4
sage: plot("A",some_other_option=4)
...
TypeError: viewerA() got an unexpected keyword argument 'some_other_option'
```


Nathann


---

Comment by ncohen created at 2015-04-17 14:41:45

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-17 15:56:40

As I said, that is not desirable here since we might change the viewer (A/B) depending on UI capabilities.


---

Comment by vbraun created at 2015-04-17 15:56:55

Changing status from needs_work to positive_review.


---

Comment by ncohen created at 2015-04-17 16:02:19

> As I said, that is not desirable here since we might change the viewer (A/B) depending on UI capabilities. 

How is that a problem? As the endfunctions will accept a different set of parameters they will also raise exceptions for the parameters that they do not accept, won't they?


---

Comment by ncohen created at 2015-04-17 16:33:55

Changing status from positive_review to needs_info.


---

Comment by vdelecroix created at 2015-04-17 17:12:33

Replying to [comment:5 vbraun]:
> show shouldn't validate keyword arguments since it may have to fall back to another viewer. E.g if you don't have java then it'll fall back to tachyon and has to ignore jmol-specific arguments.

Then there is something wrong. The point of the method `_process_viewing_options` is precisely to *select* the valid keywords and modify some of their values. The remaining keywords are just ignored (as Nathann already mentioned). And as far as I see, `_process_viewing_options` is one method in `Graphics3d` which is completely independent of the viewer. And it makes sense to have viewer specific options.

And in `_save_image_png` (line 1367-1397), it seems to me that we have the very same kind of problem

```
opts = self._process_viewing_options(kwds)
viewer = opts['viewer']
    ...
    render = self._rich_repr_tachyon(OutputImagePng, **kwds)
    ...
    scene = self._rich_repr_jmol(**kwds)
    ...
```



---

Comment by kcrisman created at 2015-04-17 17:38:29

Hi!  I don't have tons of time, but I have a few questions.
1. It looks like what happened here is that there was some error somewhere in all the zillions of viewing changes that should have used the dictionary `opts` and instead used the dictionary `kwds`, but that the current branch fixes this oversight.  Is that correct?  If so, that sounds awesome.
1. Is the comment above correct that `kwds` is incorrectly used and `opts` should be in another function too?  Or is that referring to some other issue?  In that event this should be "needs work", of course.
1. Is the issue about unhandled keywords (possibly for sending to other viewer commands) a new regression in 6.6?  I get

```

$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.5, Release Date: 2015-02-17                         │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
sage: show(sphere(), heyheyhey=35) 
sage: 
```

  with no problems (also tested in 6.4.1) so I assume that, although I can see both sides of this argument (validation/not validating), maybe this isn't the place to have that discussion, and a new ticket is warranted for that.

Okay, grading and writing an exam beckon and must be finished within 1.5 hours, so I hope this helps clarify things.  (?)


---

Comment by vbraun created at 2015-04-17 17:45:20

I agree that there are a couple of places where I used kwds instead of pts when refactoring. This is what this ticket is about.

The entire option handling for plots is IMHO badly done. Its quite complicated and independent from the actual plotting, so it should be factored out and tested separately. 

As for `_process_viewing_options`, its not clear to me whether it is supposed to remove ALL valid keywords or only the ones for the particular viewer. I can read the code to see what it does right now, and you can probably build a bandaid around it to warn about unused options, but thats IMHO not a well-designed solution.


---

Comment by git created at 2015-04-17 17:50:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-17 18:21:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-04-17 18:25:18

Is the zoom*100 no longer necessary?  It was fairly recently.


---

Comment by vbraun created at 2015-04-18 01:45:27

`zoom` is already passed in `**opts`. I just removed the wonky convention of passing 100*zoom instead of zoom in `export_jmol`. This is also the only place in Sage that calls `export_jmol`. And of course the zoom argument is not documented in `export_jmol`, so we don't even have to change the docs...


---

Comment by vbraun created at 2015-04-18 01:46:07

Changing status from needs_info to needs_review.


---

Comment by kcrisman created at 2015-04-18 03:38:43

Yes, I see now what you did.  I can't test it now, but I think the code pieces look fine as they are, and if Vincent or Eric were to finish the review that would be great.  See #18245 for the discussion about undesired options still working.


---

Comment by vdelecroix created at 2015-04-18 09:38:22

looks good to me.


---

Comment by egourgoulhon created at 2015-04-18 10:33:28

There is still an issue: the option `figsize` seems ineffective with jmol, while it was effective in Sage 6.5. For tachyon viewer, that's OK.


---

Comment by git created at 2015-04-18 12:52:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2015-04-18 12:58:16

With the above commit, the option `figsize` is effective again for jmol in Sage notebook. It is still ineffective in the IPython notebook though, but this is not a regression since in Sage 6.5, there were no jmol rendering at all in that notebook.


---

Comment by vbraun created at 2015-04-19 01:49:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-19 01:49:28

Thats terrible, `JmolData.export_image` doesn't handle separate x/y figsize and then internally forces a square aspect ratio. Oh well...


---

Comment by vbraun created at 2015-04-19 11:05:12

Resolution: fixed
