# Issue 29274: Broken coercion between cyclotomic fields

Issue created by migration from https://trac.sagemath.org/ticket/29511

Original creator: kedlaya

Original creation time: 2020-04-15 17:51:55

CC:  roed

Try this out (I tried both 8.2 and 9.1beta9):

```
sage: K.<z> = CyclotomicField(12)
sage: K1.<z1> = CyclotomicField(3)
sage: K(z1) in K1
True
sage: K1(K(z1))
z1
```

So far so good. But now:

```
sage: K(2) in K1
False
```

and correspondingly `K1(K(2))` breaks. 

More data points: 

```
sage: QQ(K(2)) in K1
True
sage: K(K1(2)) in K1
False
sage: K(2*z1) in K1
False
```




---

Comment by vdelecroix created at 2020-04-19 14:29:28

The second example is definitely broken since `K(2) == K1(2)` is `True`.


---

Comment by vdelecroix created at 2020-04-19 14:30:44

This is more interesting

```
sage: K1(K(2))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
/opt/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element._mod_ (build/cythonized/sage/structure/element.c:13836)()
   1949         try:
-> 1950             python_op = (<object>self)._mod_
   1951         except AttributeError:

/opt/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4613)()
    486         """
--> 487         return self.getattr_from_category(name)
    488 

/opt/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4722)()
    499             cls = P._abstract_element_class
--> 500         return getattr_from_other_class(self, cls, name)
    501 

/opt/sage/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)()
    393         dummy_error_message.name = name
--> 394         raise AttributeError(dummy_error_message)
    395     attribute = <object>attr

AttributeError: 'InfinityRing_class_with_category' object has no attribute '__custom_name'

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-12-9059484dde66> in <module>()
----> 1 K1(K(Integer(2)))

/opt/sage/local/lib/python3.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9218)()
    898         if mor is not None:
    899             if no_extra_args:
--> 900                 return mor._call_(x)
    901             else:
    902                 return mor._call_with_args(x, args, kwds)

/opt/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)()
    159                 print(type(C), C)
    160                 print(type(C._element_constructor), C._element_constructor)
--> 161             raise
    162 
    163     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/opt/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)()
    154         cdef Parent C = self._codomain
    155         try:
--> 156             return C._element_constructor(x)
    157         except Exception:
    158             if print_warnings:

/opt/sage/local/lib/python3.7/site-packages/sage/rings/number_field/number_field.py in _element_constructor_(self, x, check)
  10529         if isinstance(x, number_field_element.NumberFieldElement):
  10530             if isinstance(x.parent(), NumberField_cyclotomic):
> 10531                 return self._coerce_from_other_cyclotomic_field(x)
  10532             else:
  10533                 return NumberField_absolute._element_constructor_(self, x)

/opt/sage/local/lib/python3.7/site-packages/sage/rings/number_field/number_field.py in _coerce_from_other_cyclotomic_field(self, x, only_canonical)
  10673             n = x.multiplicative_order()
  10674             m = self.zeta_order()
> 10675             if m % n == 0:
  10676                 # Harder case.  E.g., x = (zeta_42)^7 and
  10677                 # self.__zeta = zeta_6, so it is possible to

/opt/sage/local/lib/python3.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__mod__ (build/cythonized/sage/rings/integer.c:22335)()
   3435 
   3436         # Use the coercion model
-> 3437         return coercion_model.bin_op(x, y, operator.mod)
   3438 
   3439     def quo_rem(Integer self, other):

/opt/sage/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10140)()
   1209             self._record_exception()
   1210         else:
-> 1211             return PyObject_CallObject(op, xy)
   1212 
   1213         if op is mul:

/opt/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__mod__ (build/cythonized/sage/structure/element.c:13615)()
   1915         cdef int cl = classify_elements(left, right)
   1916         if HAVE_SAME_PARENT(cl):
-> 1917             return (<Element>left)._mod_(right)
   1918         if BOTH_ARE_ELEMENT(cl):
   1919             return coercion_model.bin_op(left, right, mod)

/opt/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element._mod_ (build/cythonized/sage/structure/element.c:13908)()
   1950             python_op = (<object>self)._mod_
   1951         except AttributeError:
-> 1952             raise bin_op_exception('%', self, other)
   1953         else:
   1954             return python_op(other)

TypeError: unsupported operand parent(s) for %: 'The Infinity Ring' and 'The Infinity Ring'
```



---

Comment by vdelecroix created at 2020-04-19 14:41:01

I think the best way to solve this is to implement sections of number field morphisms

```
sage: K.coerce_map_from(K1)
Generic morphism:
  From: Cyclotomic Field of order 3 and degree 2
  To:   Cyclotomic Field of order 12 and degree 4
  Defn: z1 -> z^2 - 1
sage: K.coerce_map_from(K1).section() # should be the partial map K1 -> K
```



---

Comment by vdelecroix created at 2020-04-19 14:48:28

This is actually implemented in `sage.rings.number_field.homomorphism`

```
sage: phi = K1.hom([K.gen()**2 - 1])
sage: phi.preimage(K(2))
2
```

But the `phi` above **is not** the same as the coercion map!

```
sage: type(phi)
class 'sage.rings.number_field.homset.CyclotomicFieldHomset_with_category.element_class'
sage: type(K.coerce_map_from(K1))
<class 'sage.rings.number_field.number_field_morphisms.CyclotomicFieldEmbedding'>
```



---

Comment by kedlaya created at 2020-04-19 14:49:11

So clearly `CyclotomicField._coerce_from_other_cyclotomic_field()` is broken. It looks like someone tried to fix this earlier (possibly many years ago by now), but that caused a bunch of broken doctests in modular forms and so they gave up.

It may be that this code predates the current coercion model and thus would need an overhaul to bring it inline with what we do elsewhere. Cc'ing roed since he'll know whether or not this is true.


---

Comment by kedlaya created at 2020-08-12 01:03:42

Changing status from new to needs_review.


---

Comment by kedlaya created at 2020-08-12 01:03:42

Here is a patch based on vdelecroix's observation about `preimage` already being implemented for a homomorphism of cyclotomic fields. I ran some tests, but I really need to see a patchbot run for this because it's such a basic operation.
----
New commits:


---

Comment by tscrim created at 2020-08-14 06:06:50

Patchbot comes back green. I do have one small comment: I would like to see a one-line docstring of something like `Return the section of ``self``.` for `section()` (if you also feel willing, for the other methods of the map class too, but less important since it is not in the docs). Once changed, you can set a positive review on my behalf.


---

Comment by git created at 2020-08-14 14:24:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2020-08-14 15:55:43

Done!


---

Comment by kedlaya created at 2020-08-14 15:55:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-15 09:41:39

Resolution: fixed
