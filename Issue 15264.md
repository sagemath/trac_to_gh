# Issue 15264: AA should have .floor() method

Issue created by migration from https://trac.sagemath.org/ticket/15501

Original creator: ppurka

Original creation time: 2013-12-09 12:31:14

From google spreadsheet which no one reads `X-(`

It happens that an algebraic number minus itself `(b-b)` is not printed as 0, but something like `0.?e-18`. Usually it is not a big problem, because `b - b == 0` evaluates to `True`. But interestingly `floor(b-b)` is sometimes 0, sometimes a symbolic expression, so weird things can happen.


```
sage: a = QQbar((-1)^(1/4)).real()
sage: floor(a-a) + a
---------------------------------------------------------------------------
TypeError Traceback (most recent call last)
<ipython-input-337-107a1ad8256f> in <module>()
----> 1 floor(a-a) + a

/Applications/sage/local/lib/python2.7/site-packages/sage/structure/element.so in sage.structure.element.RingElement.__add__ (sage/structure/element.c:13884)()

/Applications/sage/local/lib/python2.7/site-packages/sage/structure/coerce.so in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:8169)()

TypeError: unsupported operand parent(s) for '+': 'Symbolic Ring' and 'Algebraic Real Field'
```



---

Comment by mmezzarobba created at 2013-12-18 20:19:28

New commits:


---

Comment by mmezzarobba created at 2013-12-18 20:19:28

Changing status from new to needs_review.


---

Comment by git created at 2013-12-18 20:24:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ppurka created at 2013-12-19 04:22:18

I am not really familiar with the implementation or concepts involved in the `Algebraic Reals`. Anyone familiar with the concepts is free to review this ticket (efficiency of implementation, etc).

I can confirm, however, that the patch works very well.


---

Comment by git created at 2013-12-28 09:16:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-15 13:59:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gagern created at 2014-03-27 20:12:20

Had a look at the code, not sure whether I'd officially call this a review. The diff here on trac looks broken, but after merging develop my local changes look fine. The general approach looks sound. I wonder whether we should support different rounding modes, the way rational numbers do. But one can always add that in a later commit. Since rounding mode is only an issue for actual rational numbers, this should be easy to implement outside the candidate finding method.

I also wonder whether always calling `more_precision` is the right thing to do. I fear there might be situations where this could lead to an infinite loop, although I don't claim to understand all the details. Nevertheless, perhaps at some point we should stop iterating and do bisection on the candidate range. That is, actually compare given integers against the algebraic number. As far as I understand it, comparison can be done exactly in finite (although possibly long) time. Since I have no clue as to when switching to that approach would be appropriate, I wonder whether interleaving things might make sense: keep low and high integer candidate bounds, and in each iteration, see whether added precision can narrow these bounds, but also use the middle of the range to bisect it. Sooner or later, one of these methods should succeed in narrowing the candidate range down to one element. I guess doing this approach would mean passing a second function to `_floor_ceil` which does the appropriate comparison.


---

Comment by gagern created at 2014-03-27 20:20:18

I guess I should have thought two more minutes before pressing Submit. Since you do call `_rational_` early in the loop, you can be sure that you either detect critical integer or half-integer values, or there is some finite difference between the value of self and the nearest critical distance, so a finite number of added precision steps will be enough to make the decision. Now things look pretty good to me.


---

Comment by ppurka created at 2014-03-28 02:38:59

Replying to [comment:9 gagern]:
> Had a look at the code, not sure whether I'd officially call this a review.
If you are referring to my statement in comment:3, then let me clarify that I definitely did not review this ticket. The patch looked good to me and it worked well for me. But I am unfamiliar with the `AA` code, so I did not perform a full review.

If the patch looks ok to you, then please feel free to set it to positive review.


---

Comment by tscrim created at 2014-04-02 20:50:22

I made a couple of review changes/fixes. So if people are happy with my changes, then we can set this to a positive review.
----
New commits:


---

Comment by mmezzarobba created at 2014-04-03 05:11:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-04-04 15:55:35

Resolution: fixed
