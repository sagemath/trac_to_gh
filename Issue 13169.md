# Issue 13169: Gap spkg fails on recent Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/13341

Original creator: jpflori

Original creation time: 2012-08-05 09:45:12

Assignee: tbd

CC:  dimpase

Keywords: cygwin gap spkg

The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.


---

Attachment

Spkg diff, for review only.


---

Comment by jpflori created at 2012-08-05 10:04:44

Changing status from new to needs_review.


---

Comment by leif created at 2012-08-05 18:55:36

Rather than expressing hope, how about testing for the presence of `gap`? ;-)

You could also just use `ln -sf ...` ("force"), which doesn't fail if the source (second parameter) already exists, i.e., with `-f` a new link is created regardless.  No idea how that behaves on Cygwin with "virtual" files; it may create a cycle (symbolic link from 'gap.exe' to itself), or fail in other ways, then hopefully raising an error...

(Note that `ln -s <non-existent-1> <non-existent-2>` does *not* fail, but instead creates a "dead" symbolic link [although not sure about that on Cygwin, since we use `touch` to create a dummy target].  So you may also have to check whether the target, `gap.exe`, really exists, i.e., the "build" so far succeeded, here meaning `mkdir`, `cd` and `touch` worked... :-) )


If you don't want to use the "force" option, you could instead do

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe &&
        (test -f gap || ln -s gap.exe gap)   # Probably don't use '-x'
                                             # since 'gap.exe' is yet a dummy.

        if [[ $? -ne 0 ]]; then
           # *Something* really went wrong...
           ...
           exit 1
```


But perhaps it's better to at least slightly untangle the command chain:

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe

        if [[ $? -ne 0 ]]; then
            # Some serious error...
            ...
            exit 1
        fi

        # We may need a link from 'gap' to 'gap.exe', since the former later gets
        # stripped by GAP.
        # On newer Cygwins, 'gap' is automatically "translated" to 'gap.exe',
        # such that 'ln' (without '-f') would fail (and we don't have to create the
        # link on these systems anyway, since 'strip gap' there works without it).
        if [[ ! -f gap ]]; then
            ln -s gap.exe gap
            # May check exit status here, since the above should never fail.
        fi
```



---

Comment by jpflori created at 2012-08-05 19:18:22

Replying to [comment:2 leif]:
> Rather than expressing hope, how about testing for the presence of `gap`? ;-)

Good point, let's do something more sensible.
I prefer your two second solutions.
Maybe more the last one, although I'm not sure the first exit code test is really needed.
But ok it does not hurt.


---

Comment by jpflori created at 2012-08-05 19:18:56

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2012-08-05 19:38:40

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2012-08-05 19:38:40

Spkg updated.


---

Attachment

spkg diff, for review only


---

Comment by jpflori created at 2012-08-05 19:45:23

Mmm something got broken in the last spkg, please disregard it.


---

Comment by jpflori created at 2012-08-05 19:50:40

This should be fixed now.


---

Comment by jpflori created at 2012-08-20 09:06:16

Anyone reviewing this?


---

Comment by dimpase created at 2012-08-20 09:26:37

Replying to [comment:8 jpflori]:
> Anyone reviewing this?

I'll test that it builds on CYGWIN, and that ./sage -gap works. That's the best I can do on the current Win7 system I have access to.


---

Comment by dimpase created at 2012-08-20 11:39:24

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2012-08-20 11:39:24

All good, as far as I see.


---

Comment by jdemeyer created at 2012-08-27 10:38:23

Resolution: fixed
