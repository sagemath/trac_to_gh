# Issue 13169: Gap spkg fails on recent Cygwin

archive/issues_013169.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  dimpase\n\nKeywords: cygwin gap spkg\n\nThe ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13341\n\n",
    "created_at": "2012-08-05T09:45:12Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "title": "Gap spkg fails on recent Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13169",
    "user": "jpflori"
}
```
Assignee: tbd

CC:  dimpase

Keywords: cygwin gap spkg

The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.

Issue created by migration from https://trac.sagemath.org/ticket/13341





---

archive/issue_comments_160717.json:
```json
{
    "body": "Attachment [spkg.diff](tarball://root/attachments/some-uuid/ticket13341/spkg.diff) by jpflori created at 2012-08-05 10:02:35\n\nSpkg diff, for review only.",
    "created_at": "2012-08-05T10:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160717",
    "user": "jpflori"
}
```

Attachment [spkg.diff](tarball://root/attachments/some-uuid/ticket13341/spkg.diff) by jpflori created at 2012-08-05 10:02:35

Spkg diff, for review only.



---

archive/issue_comments_160718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-05T10:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160718",
    "user": "jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160719.json:
```json
{
    "body": "Rather than expressing hope, how about testing for the presence of `gap`? ;-)\n\nYou could also just use `ln -sf ...` (\"force\"), which doesn't fail if the source (second parameter) already exists, i.e., with `-f` a new link is created regardless.  No idea how that behaves on Cygwin with \"virtual\" files; it may create a cycle (symbolic link from 'gap.exe' to itself), or fail in other ways, then hopefully raising an error...\n\n(Note that `ln -s <non-existent-1> <non-existent-2>` does **not** fail, but instead creates a \"dead\" symbolic link [although not sure about that on Cygwin, since we use `touch` to create a dummy target].  So you may also have to check whether the target, `gap.exe`, really exists, i.e., the \"build\" so far succeeded, here meaning `mkdir`, `cd` and `touch` worked... :-) )\n\n\nIf you don't want to use the \"force\" option, you could instead do\n\n```sh\n        mkdir -p bin/i686-pc-cygwin-gcc &&\n        cd bin/i686-pc-cygwin-gcc &&\n        touch gap.exe &&\n        (test -f gap || ln -s gap.exe gap)   # Probably don't use '-x'\n                                             # since 'gap.exe' is yet a dummy.\n\n        if [[ $? -ne 0 ]]; then\n           # *Something* really went wrong...\n           ...\n           exit 1\n```\n\n\nBut perhaps it's better to at least slightly untangle the command chain:\n\n```sh\n        mkdir -p bin/i686-pc-cygwin-gcc &&\n        cd bin/i686-pc-cygwin-gcc &&\n        touch gap.exe\n\n        if [[ $? -ne 0 ]]; then\n            # Some serious error...\n            ...\n            exit 1\n        fi\n\n        # We may need a link from 'gap' to 'gap.exe', since the former later gets\n        # stripped by GAP.\n        # On newer Cygwins, 'gap' is automatically \"translated\" to 'gap.exe',\n        # such that 'ln' (without '-f') would fail (and we don't have to create the\n        # link on these systems anyway, since 'strip gap' there works without it).\n        if [[ ! -f gap ]]; then\n            ln -s gap.exe gap\n            # May check exit status here, since the above should never fail.\n        fi\n```\n",
    "created_at": "2012-08-05T18:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160719",
    "user": "leif"
}
```

Rather than expressing hope, how about testing for the presence of `gap`? ;-)

You could also just use `ln -sf ...` ("force"), which doesn't fail if the source (second parameter) already exists, i.e., with `-f` a new link is created regardless.  No idea how that behaves on Cygwin with "virtual" files; it may create a cycle (symbolic link from 'gap.exe' to itself), or fail in other ways, then hopefully raising an error...

(Note that `ln -s <non-existent-1> <non-existent-2>` does **not** fail, but instead creates a "dead" symbolic link [although not sure about that on Cygwin, since we use `touch` to create a dummy target].  So you may also have to check whether the target, `gap.exe`, really exists, i.e., the "build" so far succeeded, here meaning `mkdir`, `cd` and `touch` worked... :-) )


If you don't want to use the "force" option, you could instead do

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe &&
        (test -f gap || ln -s gap.exe gap)   # Probably don't use '-x'
                                             # since 'gap.exe' is yet a dummy.

        if [[ $? -ne 0 ]]; then
           # *Something* really went wrong...
           ...
           exit 1
```


But perhaps it's better to at least slightly untangle the command chain:

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe

        if [[ $? -ne 0 ]]; then
            # Some serious error...
            ...
            exit 1
        fi

        # We may need a link from 'gap' to 'gap.exe', since the former later gets
        # stripped by GAP.
        # On newer Cygwins, 'gap' is automatically "translated" to 'gap.exe',
        # such that 'ln' (without '-f') would fail (and we don't have to create the
        # link on these systems anyway, since 'strip gap' there works without it).
        if [[ ! -f gap ]]; then
            ln -s gap.exe gap
            # May check exit status here, since the above should never fail.
        fi
```




---

archive/issue_comments_160720.json:
```json
{
    "body": "Replying to [comment:2 leif]:\n> Rather than expressing hope, how about testing for the presence of `gap`? ;-)\n\nGood point, let's do something more sensible.\nI prefer your two second solutions.\nMaybe more the last one, although I'm not sure the first exit code test is really needed.\nBut ok it does not hurt.",
    "created_at": "2012-08-05T19:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160720",
    "user": "jpflori"
}
```

Replying to [comment:2 leif]:
> Rather than expressing hope, how about testing for the presence of `gap`? ;-)

Good point, let's do something more sensible.
I prefer your two second solutions.
Maybe more the last one, although I'm not sure the first exit code test is really needed.
But ok it does not hurt.



---

archive/issue_comments_160721.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-08-05T19:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160721",
    "user": "jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160722.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-08-05T19:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160722",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160723.json:
```json
{
    "body": "Spkg updated.",
    "created_at": "2012-08-05T19:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160723",
    "user": "jpflori"
}
```

Spkg updated.



---

archive/issue_comments_160724.json:
```json
{
    "body": "Attachment [spkg.2.diff](tarball://root/attachments/some-uuid/ticket13341/spkg.2.diff) by jpflori created at 2012-08-05 19:39:08\n\nspkg diff, for review only",
    "created_at": "2012-08-05T19:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160724",
    "user": "jpflori"
}
```

Attachment [spkg.2.diff](tarball://root/attachments/some-uuid/ticket13341/spkg.2.diff) by jpflori created at 2012-08-05 19:39:08

spkg diff, for review only



---

archive/issue_comments_160725.json:
```json
{
    "body": "Mmm something got broken in the last spkg, please disregard it.",
    "created_at": "2012-08-05T19:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160725",
    "user": "jpflori"
}
```

Mmm something got broken in the last spkg, please disregard it.



---

archive/issue_comments_160726.json:
```json
{
    "body": "This should be fixed now.",
    "created_at": "2012-08-05T19:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160726",
    "user": "jpflori"
}
```

This should be fixed now.



---

archive/issue_comments_160727.json:
```json
{
    "body": "Anyone reviewing this?",
    "created_at": "2012-08-20T09:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160727",
    "user": "jpflori"
}
```

Anyone reviewing this?



---

archive/issue_comments_160728.json:
```json
{
    "body": "Replying to [comment:8 jpflori]:\n> Anyone reviewing this?\n\nI'll test that it builds on CYGWIN, and that ./sage -gap works. That's the best I can do on the current Win7 system I have access to.",
    "created_at": "2012-08-20T09:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160728",
    "user": "dimpase"
}
```

Replying to [comment:8 jpflori]:
> Anyone reviewing this?

I'll test that it builds on CYGWIN, and that ./sage -gap works. That's the best I can do on the current Win7 system I have access to.



---

archive/issue_comments_160729.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-08-20T11:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160729",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160730.json:
```json
{
    "body": "All good, as far as I see.",
    "created_at": "2012-08-20T11:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160730",
    "user": "dimpase"
}
```

All good, as far as I see.



---

archive/issue_comments_160731.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-27T10:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13169#issuecomment-160731",
    "user": "jdemeyer"
}
```

Resolution: fixed
