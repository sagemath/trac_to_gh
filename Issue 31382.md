# Issue 31382: Cholesky factorization and positive-definite testing over inexact rings

Issue created by migration from https://trac.sagemath.org/ticket/31619

Original creator: mjo

Original creation time: 2021-04-08 13:09:03

CC:  dimpase vdelecroix rbeezer @mwageringel mmezzarobba

As promised in #13674, I refactor some things to support `cholesky()` and `is_positive_definite()` over inexact rings. The main idea is to use the `block_ldlt()` method that supports inexact rings instead of `indefinite_factorization()` which does not.

Controversial bits:

1. The `certificate` argument to `is_positive_definite()` has been removed. This lets us unify the interface and implementation with `is_positive_semidefinite()`. If the user wants the factorization (which is all the certificate was), he can still ask for it directly.

2. I've left the `indefinite_factorization` method alone even though it is largely superseded by `block_ldlt(classical=True)`. Does anyone want to factorize complex matrices that are symmetric but not hermitian? How about symmetric matrices over finite fields where "conjugate" is meaningless? If not, we could deprecate/remove `indefinite_factorization()`. But I know little about what people do with matrices over finite fields.

3. I've declared that every constant, non-relational symbolic expression is a square in `SR`. This is not really principled; it just sounds true, and makes `cholesky()` work with symbolic matrices whose entries are "numbers".



---

Comment by mjo created at 2021-04-08 13:14:55

I still need to go through the documentation carefully, but any early feedback would be welcome.


---

Comment by mjo created at 2021-04-08 13:14:55

Changing status from new to needs_review.


---

Comment by tscrim created at 2021-04-11 23:28:51

I am not sure about dropping the `certificate` from `is_positive_definite()`. I would lean towards adding one for `is_positive_semidefinite()` to make it consistent. At the very least, it will require a deprecation.

I cannot comment on 2 or 3.

I would change this block:

```
-        for d_i in d:
-            if d_i.nrows() == 1:
-                if semi:
-                    if d_i < 0:
-                        return False
-                else:
-                    if d_i <= 0:
-                        return False
-            else:
-                # There's a 2x2 block
-                return False
-        return True
+        if semi:
+            return not any(d_i.nrows() > 1 or d_i < 0 for d_i in d)
+        else:
+            return not any(d_i.nrows() > 1 or d_i <= 0 for d_i in d)
```

Also, would it be better to do `d_i[0,0]` so the actual entry is checked? Another alternative would be

```
return all(d_i.nrows() == 1 and d_i >= 0 for d_i in d)
```

and similarly for the positive definite case. IMO this is a more clear than the negative test.


---

Comment by dimpase created at 2021-04-12 00:24:28

2 - factorising symmetrical complex matrices might make sense over exact fields.

For finite fields conjugate often makes sense, e.g. if characteristic is p then taking p-th power is a field automorphism.


---

Comment by mjo created at 2021-04-14 13:13:48

Replying to [comment:2 tscrim]:
> I am not sure about dropping the `certificate` from `is_positive_definite()`. I would lean towards adding one for `is_positive_semidefinite()` to make it consistent. At the very least, it will require a deprecation.
> 

The real problem here is that `certificate` is returning an implementation detail, namely the `indefinite_factorization()` that was computed to check the eigenvalues.In order to make `is_positive_definite()` numerically stable, I've already changed that implementation detail -- there's no indefinite factorization to return. I could return the `block_ldlt()` factorization, but if anyone is actually using the certificate, that's still going to mess them up. So the interface is broken either way. (And if no one was using `certificate`, it makes a lot more sense in the future for users to compute the factorization themselves.)

A related problem is that the `certificate` argument to the superclass method can't always be honored in subclasses. There is no `certificate` argument for `RDF` or `CDF` matrices, for example. If `is_positive_definite()` is ever implemented for some other subclass using a C library, that C library is certainly not going to return an `indefinite_factorization()`, so what can we do if the user wants a certificate?

If we have to deprecate it first, then we have to continue using `indefinite_factorization()`, which means we can't make it numerically stable (or work with rings like `SR` and `RR`) until the deprecation period is over.


---

Comment by dimpase created at 2021-04-14 13:48:46

I would not be worried about `certificate`. The existing functionality is next to useless, so I don't expect any real uses out there.


---

Comment by git created at 2021-04-15 01:27:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-04-15 01:30:50

Replying to [comment:2 tscrim]:
>
> Also, would it be better to do `d_i[0,0]` so the actual entry is checked?

That wasn't intentional so I'm glad you noticed it.


> Another alternative would be
> {{{
> return all(d_i.nrows() == 1 and d_i >= 0 for d_i in d)
> }}}
> and similarly for the positive definite case. IMO this is a more clear than the negative test.

I went one further and replaced this with


```python
       import operator
       op = operator.gt
       if semi:
           op = operator.ge
       return all(d_i.nrows() == 1 and op(d_i[0,0], 0) for d_i in d)
```


to minimize duplication. It's a lot clearer now, thanks.


---

Comment by tscrim created at 2021-04-15 07:28:00

Okay, I agree that we should remove the certificate. I would suggest making the `certificate=True` return a pair as before, but just return the `block_ldlt()` as the certificate with the deprecation message saying we changed. This is at least the minimal breakage and intrusive change to the current branch. How does that sound?


---

Comment by git created at 2021-04-27 00:03:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2021-04-27 00:04:56

Making this depend on #31594 so that I don't have to rebuild the copy of giac I already have installed.


---

Comment by mjo created at 2021-04-27 00:09:15

Replying to [comment:8 tscrim]:
> Okay, I agree that we should remove the certificate. I would suggest making the `certificate=True` return a pair as before, but just return the `block_ldlt()` as the certificate with the deprecation message saying we changed. This is at least the minimal breakage and intrusive change to the current branch. How does that sound?

I don't really like it, but I've added a commit that implements this to minimize the amount of back-and-forth that we have to do. I feel like a two-stage deprecation/removal cycle is just going to annoy people _twice_ -- once when the format of the certificate changes on them, and then again when it goes away for real.

I've also finally taken the time to go over the documentation of `is_positive_definite()` and `cholesky()`, updated in two new commits.


---

Comment by mjo created at 2021-04-27 00:17:24

Replying to [comment:3 dimpase]:
> 2 - factorising symmetrical complex matrices might make sense over exact fields.
> 
> For finite fields conjugate often makes sense, e.g. if characteristic is p then taking p-th power is a field automorphism.
> 

I'm not sure what to do about this. I agree that it makes sense, but I really don't want to make  `block_ldlt()` as awkward as `indefinite_factorization()` without a good reason.


---

Comment by mjo created at 2021-04-27 00:21:17

`block_ldlt()` does work with many finite fields... the only issue is that you can't force it to use the standard transpose when the conjugate-transpose doesn't exist (when there's no `conjugate()` in the field).


---

Comment by tscrim created at 2021-04-28 02:32:02

Replying to [comment:11 mjo]:
> Replying to [comment:8 tscrim]:
> > Okay, I agree that we should remove the certificate. I would suggest making the `certificate=True` return a pair as before, but just return the `block_ldlt()` as the certificate with the deprecation message saying we changed. This is at least the minimal breakage and intrusive change to the current branch. How does that sound?
> 
> I don't really like it, but I've added a commit that implements this to minimize the amount of back-and-forth that we have to do. I feel like a two-stage deprecation/removal cycle is just going to annoy people _twice_ -- once when the format of the certificate changes on them, and then again when it goes away for real.

Thank you. If they get annoyed twice, then they didn't read the deprecation message and it is their own fault IMO.

I am happy with the current patch. Dima, how about you? (If I really wanted to quibble, we could change the `Returns` -> `Return` in `cholesky()` since we are modifying its docstring anyways. However, that can be done only if there is another commit.)


---

Comment by dimpase created at 2021-04-28 17:38:58

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-04-28 17:38:58

lgtm


---

Comment by mjo created at 2021-04-29 00:28:16

Thanks!


---

Comment by git created at 2021-05-09 11:19:16

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-05-09 11:19:16

Changing status from positive_review to needs_review.


---

Comment by mjo created at 2021-05-09 11:20:21

I dropped the dependency on #31594 because new (impossible to detect) giac versions are going to break some tests.


---

Comment by tscrim created at 2021-05-11 00:00:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-05-11 00:05:57

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2021-05-11 00:05:57

Sorry, I was too quick. Looks like there is an issue on 9.3.rc5 (that was not on 9.3.rc4) with the matrix constructed in line  12338, which causes the subsequent failures. This was almost certainly caused by #31628.


---

Comment by tscrim created at 2021-05-11 00:39:45

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2021-05-11 00:39:45

The issue is from #31808. So this ticket is good, but we need to solve #31808 before this is merged.


---

Comment by mjo created at 2021-05-11 14:38:22

Thanks for taking care of that! The giac issues should now also be fixed, but there's no reason to mess with this ticket further.


---

Comment by vbraun created at 2021-06-06 13:18:19

Resolution: fixed
