# Issue 33670: interfaces/expect.py random test failure

Issue created by migration from https://trac.sagemath.org/ticket/33907

Original creator: @collares

Original creation time: 2022-05-25 22:48:52

CC:  slelievre chapoton jdemeyer dimpase tscrim

I've been getting this very frequently when running tests under heavy CPU load. This happens on Sage 9.5 too but curiously I only started seeing this on March 18th, even though Nixpkgs updated to Sage 9.5 on January 31st. I don't have a full list of packages updated between those two dates, but Tachyon was updated from 0.99b6 to 0.99.3 around this time. I'd be happy to provide extra information.


```
sage -t --long --random-seed=233407191301051614325254530123917684827 /nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py
**********************************************************************
File "/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py", line 920, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular.interrupt()
Expected:
    True
Got:
    False
**********************************************************************
File "/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py", line 926, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular('2+3')
Expected:
    Singular crashed -- automatically restarting.
    5
Got:
    5
```



---

Comment by tornaria created at 2022-12-14 16:10:50

I've just got the exact same issue when building/doctesting the sagemath void package on github actions. Happened with x86_64 and i686 (but not with x86_64-musl).

Not copying the log since it is identical.

Edit: in case it is relevant, we use singular 4.3.1p2 from system.


---

Comment by tornaria created at 2022-12-14 16:16:12

Cf https://github.com/void-linux/void-packages/pull/41085#issuecomment-1351712588


---

Comment by tornaria created at 2022-12-14 16:34:49

Here's a way to reproduce it:

```
sage: for i in range(1_000_000):
....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)
....:     if not singular.interrupt(tries=1, timeout=1e-6):
....:         print(f"FAIL in step {i} ")
....:         break
....:     _ = singular('2+3')
....: 
^[[A''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
FAIL in step 7 
```


The "Singular crashed" output is expected.

As reported, this fails more if there is a heavy load, and I think using `tries=1` and `timeout=1e-6` also helps it. For the heavy load, right now I am running `sage -tp 8 --all --long` (8 core / 8 thread box)


---

Comment by tornaria created at 2022-12-14 16:38:51

A comment before the doctest says:

```
        For reasons which are currently not understood, the ``interrupt``
        test usually returns immediately, but sometimes it takes a very
        long time on the same system. ::
```

I guess "takes a very long time" sometimes is more than the default `timeout=2.0` seconds repeated more than the default `tries=5` times in a row.


---

Comment by tornaria created at 2022-12-14 16:50:53

Not really: I tried the same with `tries=1` and `timeout=100` and still under heavy load. Eventually, the loop got stuck for 100 seconds and then failed. So I guess the correct statement is "for unknown reasons sometimes the interrupt is missed and the thing only finishes because of the timeout". Which means increasing `timeout` won't solve the issue.

In fact, `tries` doesn't help either in the sense that if the first attempt gets stuck then the remaining tries will also get stuck. Indeed, when I run several times the code below which uses `tries=5` and `timeout=3`, it always finishes in < 1ms except when it fails it takes ~ 15 seconds. It never succeeds in the second or later tries.

```
sage: for i in range(1_000_000):
....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)
....:     t = time.clock_gettime(time.CLOCK_MONOTONIC)
....:     if not singular.interrupt(tries=5, timeout=3):
....:         t = time.clock_gettime(time.CLOCK_MONOTONIC) - t
....:         print(f"FAIL in step {i} after {t} seconds ")
....:         break
....:     t = time.clock_gettime(time.CLOCK_MONOTONIC) - t
....:     print(f"DONE in {t} seconds")
....:     _ = singular('2+3')
```



---

Comment by tornaria created at 2022-12-15 15:08:40

I think this might be caused by #31846.


---

Comment by tornaria created at 2022-12-16 18:42:56

New commits:


---

Comment by tornaria created at 2022-12-16 18:42:56

Changing status from new to needs_review.


---

Comment by tornaria created at 2022-12-16 18:42:56

Changing priority from minor to major.


---

Comment by tornaria created at 2022-12-16 18:46:43

This essentially reverts 85f65bf and a10d19d from trac #31846.
It turns out this was originaly written for #30945, but that issue was
fixed by upgrading cysignals.
    
Singular really needs a custom `_send_interrupt()` method, because the
default one will quit singular. Moreover, this handles two quirks of
singular:
    
 - a small delay before sending `chr(3)` works around a bug in singular.
 - sometimes one needs to send `;` a few times after interrupt to get
   back a prompt.
    
The original author of the custom `_send_interrupt()` is Jeroen Demeyer
in commit 17d23e9 (trac #10476). I changed the timeout for a smaller
one, and rewrote the doctest to call `interrupt()` explicitly instead of
using `alarm()` which introduces more noise.


---

Comment by mkoeppe created at 2022-12-16 22:51:06

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-12-16 22:51:06

LGTM.
