# Issue 14642: CycleIndexSeries derivative, integral, exponential methods are not combinatorial

Issue created by migration from Trac.

Original creator: agd

Original creation time: 2013-07-01 16:13:26

Assignee: agd

The _CycleIndexSeries_ class inherits _derivative_, _integral_, and _exponential_ methods from its parent class _LazyPowerSeries_. However, these operations (which are perfectly reasonable at the _LazyPowerSeries_ level) are combinatorially natural. In fact, there is a differentiation operator on cycle index series, but it's something entirely different, and anti-differentiation is in general impossible!

In addition to being confusing, this discrepancy has the potential to hinder work using the _CycleIndexSeries_ class. The combinatorial operation of cycle index differentiation is very useful in enumerative work.

All that said, the existing _exponential_ and _derivative_ methods are used for algebraic magic tricks in some of the existing code, so it's important not to take it away altogether.

The attached patch makes the following changes:

* Adds __lps_derivative_, __lps_integral_, and __lps_exponential_ methods to _CycleIndexSeries_ which call up using _super_.

* Refactors the internal code which previously used _exponential_ and _derivative_ to use __lps_exponential_ and __lps_derivative_ instead.

* Implements a new _derivative_ method which computes the combinatorial derivative of a cycle index series.

* Implements a new _pointing_ method which implements a related combinatorial operation.

* Implements a new _integral_ method which raises a _NotImplementedError_ to prevent any user confusion (since, as explained in the docstring, there may be infinitely many very distinct cycle indices with a given derivative).

* Implements a new _exponential_ method which returns the composition E(self) for E the cycle index series of _SetSpecies_. 

* Implements a new _logarithm_ method which returns the composition Ω(self) for Ω the cycle index series implemented in _CombinatorialLogarithmSeries_.

Docstrings and doctests are included for everything but the _lps_* methods, which just call up to ``super``. I'm not sure what a doctest for these would even look like, but I'm open to suggestions.


---

Comment by agd created at 2013-07-01 16:15:02

For the patchbot:

apply trac_14846_cis_deriv_int_exp_methods.patch


---

Comment by agd created at 2013-07-01 16:15:29

Changing status from new to needs_review.


---

Comment by agd created at 2013-07-17 17:44:50

I have uploaded a new version of the patch which makes a small change: rather than building the terms of the _derivative_ of a _CycleIndexSeries_ using an opaque list concatenation, I have used the _CycleIndexSeriesRing.term_ method.


---

Comment by jdemeyer created at 2013-08-19 06:37:14

Please make it clear whether the patch or the git branch should be merged. In the latter case, change the milestone to sage-6.0.


---

Comment by agd created at 2013-09-03 16:51:59

Rebased patch to apply over 5.12.beta4.


---

Attachment

Could you please add doctests to the three _lps functions ?


---

Comment by chapoton created at 2013-10-24 10:14:31

Changing status from needs_review to needs_work.


---

Comment by agd created at 2013-11-23 17:01:42

Skeletal doctests added for the three _lps_* functions. I have no idea whether this is the *right* way to test this sort of method, but at least it's *a* test.

Additionally, I've switched back over to using Git to manage this—the old Mercurial workflow is just too confusing. How do I tell the build bot to ignore the attachments and only use the branch?


---

Comment by agd created at 2013-11-23 17:01:42

Changing status from needs_work to needs_review.


---

Comment by git created at 2013-12-25 19:54:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2013-12-31 22:49:03

Hi Andrew,

I'd suggest to really remove access to the three inherited methods, and rewrite the methods that use _lps_exponential accordingly:

* in set_species, we really want to return the "true" exponential cycle index series
* in partition_species, the "true" exponential of the "true" exponential - 1
* in subset_species, the square of the "true" exponential

Finally, the implementation of the "true" exponential can be taken from what's in set_species in sage 6.0.

As far as I can see, the other two methods _lps_derivative and _lps_integral are not used anywhere.

This might have a speed penalty, but I'd worry about that only if it's serious.  I think it's not a good idea to make the cycle index series depend on the species code, as in the proposed patch.

I would perhaps also put the definition for the combinatorial logarithm into the same file.  I think at some point we should reorganise the files in the species directory..

Martin


---

Comment by git created at 2014-01-01 02:14:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by agd created at 2014-01-01 02:17:21

Thanks for the suggestions!

Replying to [comment:14 mantepse]:
> I'd suggest to really remove access to the three inherited methods, and rewrite the methods that use _lps_exponential accordingly:

Sounds good to me. Done, in the latest push.

> * in set_species, we really want to return the "true" exponential cycle index series
> * in partition_species, the "true" exponential of the "true" exponential - 1
> * in subset_species, the square of the "true" exponential

I have rewritten all of these to use algebraic operations on the exponential CIS.

> As far as I can see, the other two methods _lps_derivative and _lps_integral are not used anywhere.

Seems to be true. I just included them for completeness. They're gone now.
 
> This might have a speed penalty, but I'd worry about that only if it's serious.  I think it's not a good idea to make the cycle index series depend on the species code, as in the proposed patch.

Actually, I think the new way should actually be *faster*, there's just one instance of the exponential series which gets cached and handed around.

> I would perhaps also put the definition for the combinatorial logarithm into the same file.

Once I wrote the other stuff, this seemed very reasonable, so I've done that as well.


---

Comment by mantepse created at 2014-01-01 21:26:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-01-06 04:44:31

Reviewer name must be full name. Also please fill in your name on the trac.sagemath.org homepage.


---

Comment by mantepse created at 2014-01-14 20:24:55

Changing keywords from "" to "LazyPowerSeries, species".


---

Comment by mhansen created at 2014-01-15 16:19:11

One (minor) issue is the removal of combinatorial_logarithm.py which might need to be deprecated.  I've also done a "rebase" of this on top of #15673 which makes the code a little bit cleaner.  This is in branch "u/mhansen/ticket/14846" .  Ideally, I'd prefer to have #15673 go in first since the rebase/merge of this ticket is easier than the other way around.

See http://git.sagemath.org/sage.git/log/?h=u/mhansen/ticket/14846


---

Comment by mhansen created at 2014-01-15 16:19:11

Changing status from positive_review to needs_info.


---

Comment by git created at 2014-02-09 19:48:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2014-02-09 20:18:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by agd created at 2014-02-09 20:19:41

Replying to [comment:21 mhansen]:
> One (minor) issue is the removal of combinatorial_logarithm.py which might need to be deprecated.  

Ah, yes, this is an important point. I sometimes forget that other people might have used my code… =D

> I've also done a "rebase" of this on top of #15673 which makes the code a little bit cleaner.  This is in branch "u/mhansen/ticket/14846" .  Ideally, I'd prefer to have #15673 go in first since the rebase/merge of this ticket is easier than the other way around.

I don't yet understand everything that's happening with #15673, but I'm starting to take a look at it. I'm definitely open to the idea, though—better series code will make all our work easier! I've taken a look at your rebased version of this, and have a few thoughts up-front:

* In the docstring for the deprecated `CombinatorialLogarithmSeries()`, you point the reader to `CycleIndexSeriesRing(R).exponential()`, but in fact this should be to `CycleIndexSeriesRing(R).omega()`.

* Relatedly, I'd argue that the `CycleIndexSeriesRing(R).omega()` and `CycleIndexSeriesRing(R).exponential()` methods should instead be named `logarithm_series()` and `exponential_series()`. In the first place, the Ω notation is not totally standard (it's used by Labelle, but other authors have called this virtual species "Con" or other things); in the second, I think it's conceptually important to emphasize that these objects are //series// and not //operations//, since the operations are implemented as `CycleIndexSeries().exponential()` and `CycleIndexSeries().logarithm()` respectively. (Of course, the documentation should mention the relationship between the two!)

* `CycleIndexSeriesRing.LogarithmStream` appears to be internal, so the docstring of `CycleIndexSeries.logarithm()` should refer instead to `CycleIndexSeriesRing.logarithm_series`.

I've updated the ticket branch to use your code with these changes. I've also set a dependency on #15673. (Evidently, I bungled the ticket modifications a bit, but I think it's all sorted now.)
----
New commits:
> ||[6989f3f](http://git.sagemath.org/sage.git/commit/?id=6989f3f5240b91bfb3d9cdfe62612bddf5e9adfd)||`Merge remote-tracking branch 'origin/develop' into cis-deriv`||
> ||[2d3b466](http://git.sagemath.org/sage.git/commit/?id=2d3b46683d9cd567a75a9c737f248fd95b69354b)||`Merge remote-tracking branch 'origin/u/mhansen/ticket/14846' into cis-deriv`||
> ||[4efe9b0](http://git.sagemath.org/sage.git/commit/?id=4efe9b08164bf688e15ef3729858a4eb2996e7c2)||`Rename CycleIndexSeriesRing.omega() to logarithm_series`||
> ||[334c095](http://git.sagemath.org/sage.git/commit/?id=334c0956250038eae2d6efc915231e650b13be79)||`Rename CycleIndexSeriesRing().exponential() to exponential_series()`||


---

Comment by git created at 2014-02-10 15:23:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mhansen created at 2014-02-10 15:32:54

Cool, your changes look good to me!


---

Comment by agd created at 2014-08-01 14:20:51

While #15673 looks like it will bring some much-needed improvements to the algebraic machinery of species in Sage, it also looks like it's going to take a while to implement. I've been fielding questions from other researchers who would like to use the code in #14347, which definitely depends on this one, so I'd be very grateful if we could move forward on this one now. I will, of course, be happy to revisit the issue in the context of #15673 once that situation stabilizes!


---

Comment by mantepse created at 2014-08-13 09:41:23

I agree.  I wonder what happened to #16137.


---

Comment by git created at 2015-05-29 22:39:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by agd created at 2015-05-29 22:51:46

Since #15673 seems to have died on the vine, I have rebuilt the code for this commit on top of current mainline Sage 6.7. All doctests in `combinat/species` pass.


---

Comment by agd created at 2015-05-31 22:40:34

Changing status from needs_info to needs_review.


---

Comment by mantepse created at 2015-08-12 15:22:46

I played with the code and the examples, and found myself happy.  For example,


```
sage: T = CombinatorialSpecies()
sage: X = species.SingletonSpecies()
sage: E = species.SetSpecies()
sage: T.define(X*E(T))
sage: s = T.cycle_index_series()
sage: oeis(s.logarithm().generating_series().counts(12))
0: A133297: a(n) = n!*Sum_{k=1..n} (-1)^(k+1)*n^(n-k-1)/(n-k)!.
sage: oeis(s.pointing().generating_series().counts(12)[1:])
0: A000312: Number of labeled mappings from n points to themselves (endofunctions): n^n.
1: A177885: (1-n)^(n-1).
2: A086783: Discriminant of the polynomial x^n - 1.
sage: oeis(s.pointing().isotype_generating_series().counts(12)[1:])
0: A000107: Number of rooted trees with n nodes and a single labeled node; pointed rooted trees; vertebrates.
```


Thanks for the code and thanks for the patience!


---

Comment by mantepse created at 2015-08-12 15:22:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-13 18:35:25

Resolution: fixed
