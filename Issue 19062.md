# Issue 19062: product of elements of a cartesian products is very slow

Issue created by migration from https://trac.sagemath.org/ticket/19299

Original creator: vdelecroix

Original creation time: 2015-09-28 13:17:33

CC:  ncohen

As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow

```
sage: X = cartesian_product([IntegerModRing(2)] * 8)
sage: A = X.addition_table() # very very long
```

One problem is the default implementation of `cartesian_factors` for element of such product provided by `sage.categories.sets_cat`

```
def cartesian_factors(self):
   # TODO: optimize
   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())
```



---

Comment by vdelecroix created at 2015-09-28 13:23:00

New commits:


---

Comment by vdelecroix created at 2015-09-28 13:25:34

I am still annoyed that `%prun` returns that most time is taken by the `index` method of tuple... which has no reason to be used.


---

Comment by git created at 2015-09-28 13:43:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-28 13:44:00

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-09-28 13:44:00

Nathann,

Could you see if this is enough speedup for your purpose?

Vincent


---

Comment by ncohen created at 2015-09-28 13:46:11

Hello !

The speedup is cool indeed, thanks! My constructions are still very slow but while I was trying to figure out why exactly I noticed that `Graph.complement` was rather slow too. I'll finish that and get back to the constructions, to this patch and to my slow code.

Nathann


---

Comment by ncohen created at 2015-09-28 14:21:06

Yo !

My graph generation is still slow, but 10 seconds for a 1024-nodes graph is, well, not as bad as some gap-based construction.

I could save a couple of seconds on the graph side, however, but that would require some rewrite of the dense graph backend. I'll get to that.

Is there any reason why you stored the dictionary as a parameter of `self`? I added a small commit on top of yours at u/ncohen/19299 which avoid lambda functions. It also removes the caching of the dictionary, but if you really think it can be useful, well, that can be reverted.

Thanks,

Nathann


---

Comment by vdelecroix created at 2015-09-28 14:31:56

I do prefer your version!

An index attribute might be useful for the method `OperationTable.__getitem__`. But as it is not used intensively for building the table I did not touched it.

Vincent
----
New commits:


---

Comment by ncohen created at 2015-09-28 14:33:20

Okayyy. Well, then if it's good for you, let it go!

Nathann


---

Comment by vdelecroix created at 2015-09-28 14:35:32

Changing status from needs_review to positive_review.


---

Comment by jsrn created at 2015-09-28 15:03:59

There's a duplicated line `sage: A((1, 1.23)).cartesian_factors()` in the `EXAMPLE` of `cartesian_factors`, it seems.


---

Comment by vdelecroix created at 2015-09-28 16:15:35

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2015-09-28 16:15:35

Indeed...


---

Comment by vdelecroix created at 2015-09-28 18:15:23

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-09-28 18:15:23

New commits:


---

Comment by ncohen created at 2015-09-28 19:14:49

The patchbot says that everything is cool, so `positive_review` again. Sorry 'bout the previous one.

Nathann


---

Comment by ncohen created at 2015-09-28 19:14:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-10-12 07:15:49

Resolution: fixed
