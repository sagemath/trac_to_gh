# Issue 18144: Cholesky decomposition should be real

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-05-08 09:06:03

CC:  tdumont

Currently, given a rational matrix the answer of the cholesky decomposition has base ring `QQbar` and not `AA`. This can lead to troubles when someone asks for a floating point approximation since `QQbar` does some exactification to be sure that the imaginary part is zero!

See [the original post on sage-support](https://groups.google.com/forum/#!topic/sage-support/sUdDwW9A8f0).


---

Comment by vdelecroix created at 2015-05-08 14:54:25

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-05-08 14:54:25

New commits:


---

Comment by slelievre created at 2015-05-10 14:10:29

Just a grammatical suggestion, instead of


```
raise ValueError("{} seems not be a subring of the "
                 "real or complex numbers".format(R))
```


could we have


```
raise ValueError("Could not see {} as a subring of the "
                 "real or complex numbers".format(R))
```



---

Comment by git created at 2015-08-09 21:01:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-09 21:02:12

Replying to [comment:2 slelievre]:
> Just a grammatical suggestion, 
> ...

done. And rebased on sage-6.9.beta1.

Vincent


---

Comment by slelievre created at 2015-08-11 09:22:56

You missed the word "as" in commit ​ff2a05d.


---

Comment by git created at 2015-08-13 13:19:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-13 13:21:54

Replying to [comment:5 slelievre]:
> You missed the word "as" in commit ​ff2a05d.

Right right right


---

Comment by dimpase created at 2016-04-25 15:30:27

a formatting issue to fix for the latest beta:

```
sage -t src/sage/matrix/matrix2.pyx
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 11289, in sage.matrix.matrix2.Matrix.diagonal.cholesky
Failed example:
    L
Expected:
    [                       1.414213562373095?         0                     0]
    [2.828427124746190? - 1.414213562373095?*I         1                     0]
    [4.242640687119285? + 2.828427124746190?*I   2 - 2*I    1.732050807568878?]
Got:
    [                       1.414213562373095?                                         0                                         0]
    [2.828427124746190? - 1.414213562373095?*I                                         1                                         0]
    [4.242640687119285? + 2.828427124746190?*I                                  -2*I + 2                        1.732050807568878?]
**********************************************************************
1 item had failures:
   1 of  61 in sage.matrix.matrix2.Matrix.diagonal.cholesky
```



---

Comment by dimpase created at 2016-04-25 15:32:35

by the way, do you know how to fix the following wrong error message:

```
sage: m=matrix(RDF,[[2,1],[1,2]],sparse=True)
sage: m.cholesky()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-4-18ff9bf78b55> in <module>()
----> 1 m.cholesky()

/home/dima/software/sage/src/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.cholesky (/home/dima/software/sage/src/build/cythonized/sage/matrix/matrix2.c:80453)()
  11429             if not self.base_ring().is_exact():
  11430                 msg = 'base ring of the matrix must be exact, not {0}'
> 11431                 raise TypeError(msg.format(self.base_ring()))
  11432             if not self.is_positive_definite():
  11433                 msg = 'matrix is not positive definite, so cannot compute Cholesky decomposition'

TypeError: base ring of the matrix must be exact, not Real Double Field 
```

(it should say that the matrix must be dense...)


---

Comment by vdelecroix created at 2016-04-27 00:59:08

Why would you like to make cholesky work only for sparse matrices. The following works fine

```
sage: m=matrix(ZZ,[[2,1],[1,2]],sparse=True)
sage: m.cholesky()
[ 1.414213562373095?                   0]
[0.7071067811865475?  1.224744871391589?]
```

Of course the output should always be dense but it makes sense for the input to either be sparse or dense.


---

Comment by git created at 2016-04-27 01:00:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-04-27 01:01:14

rebased on last beta


---

Comment by dimpase created at 2016-04-27 05:09:40

dense RDF input works:

```
sage: m=matrix(RDF,[[2,1],[1,2]])
sage: m.cholesky()
[1.4142135623730951                0.0]
[0.7071067811865476  1.224744871391589]
```

so this message about `exact` is misleading.


---

Comment by vdelecroix created at 2016-04-27 12:49:36

It reflects the reality: the dense `RDF` case is handled by numpy. While the Sage algorithm is not numerically stable (?) and should not be used for non exact rings.


---

Comment by dimpase created at 2016-04-27 13:20:34

Replying to [comment:14 vdelecroix]:
> It reflects the reality: the dense `RDF` case is handled by numpy. While the Sage algorithm is not numerically stable (?) and should not be used for non exact rings.

the reality is that while Sage does have code that can do Cholesky of sparse RDF matrices, and even of sparse CDF matrices (hidden in CVXOPT, that packages suitesparse with its cholmod), it just needs to be exposed the way numpy dense matrices are exposed. 

Anyhow, the error message  is wrong, it should say that either the matrix should be dense over  RDF, or sparse/dense over an exact field.


---

Comment by dimpase created at 2016-04-27 14:30:39

OK, as far as the branch at hand is concerned, it's all good.


---

Comment by dimpase created at 2016-04-27 14:30:39

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-04-27 14:31:43

Thanks!

If you open a ticket for making available floating point cholesky for sparse matrices, put me in cc.


---

Comment by tdumont created at 2016-04-27 15:33:49

I don't think that Cholesky decomposition of sparse matrices would be so interesting here.  suitesparse
works with _very_ sparse matrices we encounter for example when discretizing PDEs: that is, for a n x n matrix, we have O(n) non zero terms. As LU and Cholesky decomposition create new non zero terms, one must reorganise the graph of the matrix to minimize the amount of new terms created when factorizing. This is for example what SuperLU does, and  the successors of SuperLU too.These are quite specialized softwares.


---

Comment by dimpase created at 2016-04-27 16:26:49

Replying to [comment:18 tdumont]:
> I don't think that Cholesky decomposition of sparse matrices would be so interesting here.  suitesparse
> works with _very_ sparse matrices we encounter for example when discretizing PDEs: that is, for a n x n matrix, we have O(n) non zero terms. As LU and Cholesky decomposition create new non zero terms, one must reorganise the graph of the matrix to minimize the amount of new terms created when factorizing. This is for example what SuperLU does, and  the successors of SuperLU too.These are quite specialized softwares.

suitesparse has amd (also packages in cvxopt) to get a kind of reordering you are talking about. Anyway it is a secondary question how to compute Cholesky, or perhaps a more general factorisation involving a permutation/reording, of a sparse [R,C]DF-matrix. It's more important to fix a backend for computations with sparse [R,C]DF-matrices.


---

Comment by vbraun created at 2016-04-28 15:36:26

Resolution: fixed
