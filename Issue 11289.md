# Issue 11289: make @parallel work with class/instance methods

archive/issues_011289.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  kcrisman simonking niles\n\nKeywords: parallel decorator\n\nThe ``@`parallel` decorator currently cannot be used with methods that implicitly prepend their arguments with a class instance, because ``@`parallel` requires that the first argument be a list (or iterable) of arguments to pass to the function.\n\nMore details can be found at this [asksage question](http://ask.sagemath.org/question/585/can-i-use-parallel-for-classinstance-methods).\n\nIssue created by migration from https://trac.sagemath.org/ticket/11461\n\n",
    "created_at": "2011-06-10T17:25:59Z",
    "labels": [
        "performance",
        "major",
        "bug"
    ],
    "title": "make @parallel work with class/instance methods",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11289",
    "user": "niles"
}
```
Assignee: tbd

CC:  kcrisman simonking niles

Keywords: parallel decorator

The ``@`parallel` decorator currently cannot be used with methods that implicitly prepend their arguments with a class instance, because ``@`parallel` requires that the first argument be a list (or iterable) of arguments to pass to the function.

More details can be found at this [asksage question](http://ask.sagemath.org/question/585/can-i-use-parallel-for-classinstance-methods).

Issue created by migration from https://trac.sagemath.org/ticket/11461





---

archive/issue_comments_124481.json:
```json
{
    "body": "Attachment\n\nthis patch breaks `@`parallel, but prints information about how it's broken",
    "created_at": "2011-06-10T18:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124481",
    "user": "niles"
}
```

Attachment

this patch breaks `@`parallel, but prints information about how it's broken



---

archive/issue_comments_124482.json:
```json
{
    "body": "I wish I could tell buildbot not to apply [attachment:parallel.patch] -- I put it here only to share what I've learned about how ``@`parallel` works:  The object that gets passed to `Parallel` is no longer a method, but only a plain function.  Here's how I'm testing this:  \n\nFirst, the following goes in a separate file\n\n\n```\n@parallel\ndef func(n):\n    sleep(.2)\n    return prime_pi(n)\n\nclass PTest(SageObject):\n    attr = 'red'\n    def meth0(self,n):\n        return n\n    @parallel\n    def meth1(self,n):\n        \"long and complicated class method\"\n        sleep(.5)\n        return [prime_pi(n),self.attr]\n\nN = PTest()\nM = [1000,2000,3000,4000,5000]\nL = [(N,x) for x in [1000,2000,3000,4000,5000]]\n```\n\n\nThen I apply the patch and do this:\n\n```\nsage: N.meth1(100)\nargs: (<class '__main__.PTest'>, 100)\nbranch 2.5.1\n...\nNotImplementedError: this branch not finished\n\nsage: func(100)\nargs: (100,)\nbranch 2.5.1\n...\nNotImplementedError: this branch not finished\n```\n\n\nSo the function and method are being treated the same by `Parallel`.  None of the ideas for detecting the difference: `.__self__`, `ismethod`, or `isfunction` seem to work.  So I guess this means something earlier in the application of ``@`parallel` needs to be fixed.",
    "created_at": "2011-06-10T18:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124482",
    "user": "niles"
}
```

I wish I could tell buildbot not to apply [attachment:parallel.patch] -- I put it here only to share what I've learned about how ``@`parallel` works:  The object that gets passed to `Parallel` is no longer a method, but only a plain function.  Here's how I'm testing this:  

First, the following goes in a separate file


```
@parallel
def func(n):
    sleep(.2)
    return prime_pi(n)

class PTest(SageObject):
    attr = 'red'
    def meth0(self,n):
        return n
    @parallel
    def meth1(self,n):
        "long and complicated class method"
        sleep(.5)
        return [prime_pi(n),self.attr]

N = PTest()
M = [1000,2000,3000,4000,5000]
L = [(N,x) for x in [1000,2000,3000,4000,5000]]
```


Then I apply the patch and do this:

```
sage: N.meth1(100)
args: (<class '__main__.PTest'>, 100)
branch 2.5.1
...
NotImplementedError: this branch not finished

sage: func(100)
args: (100,)
branch 2.5.1
...
NotImplementedError: this branch not finished
```


So the function and method are being treated the same by `Parallel`.  None of the ideas for detecting the difference: `.__self__`, `ismethod`, or `isfunction` seem to work.  So I guess this means something earlier in the application of ``@`parallel` needs to be fixed.



---

archive/issue_comments_124483.json:
```json
{
    "body": "I put up an initial patch which shows how this sort of thing should be done.  The key is the __get__ method which gets the bound/class/static method when it's accessed as an attribute.  I still need to add documentation / tests / etc. but for those who need it now, there's a patch.",
    "created_at": "2011-06-11T23:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124483",
    "user": "mhansen"
}
```

I put up an initial patch which shows how this sort of thing should be done.  The key is the __get__ method which gets the bound/class/static method when it's accessed as an attribute.  I still need to add documentation / tests / etc. but for those who need it now, there's a patch.



---

archive/issue_comments_124484.json:
```json
{
    "body": "Thanks!  This seems to be working well.  There are some failures applying to 4.7.1.alpha2, which seem related to ticket #9976 (improving introspection for decorators).  I simply dropped those two hunks of the patch and it is working fine (with introspection!) in simple examples.",
    "created_at": "2011-06-12T14:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124484",
    "user": "niles"
}
```

Thanks!  This seems to be working well.  There are some failures applying to 4.7.1.alpha2, which seem related to ticket #9976 (improving introspection for decorators).  I simply dropped those two hunks of the patch and it is working fine (with introspection!) in simple examples.



---

archive/issue_comments_124485.json:
```json
{
    "body": "I posted a patch which applies on top of #9976.",
    "created_at": "2011-06-12T16:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124485",
    "user": "mhansen"
}
```

I posted a patch which applies on top of #9976.



---

archive/issue_comments_124486.json:
```json
{
    "body": "Attachment",
    "created_at": "2011-06-13T02:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124486",
    "user": "mhansen"
}
```

Attachment



---

archive/issue_comments_124487.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-06-13T02:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124487",
    "user": "mhansen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_124488.json:
```json
{
    "body": "Apply trac_11461.patch",
    "created_at": "2011-06-13T02:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124488",
    "user": "mhansen"
}
```

Apply trac_11461.patch



---

archive/issue_comments_124489.json:
```json
{
    "body": "Changing keywords from \"parallel decorator\" to \"parallel decorator sd31\".",
    "created_at": "2011-06-13T02:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124489",
    "user": "mhansen"
}
```

Changing keywords from "parallel decorator" to "parallel decorator sd31".



---

archive/issue_comments_124490.json:
```json
{
    "body": "Formatting things:\n* This needs very minor rebasing with respect to #11467.   \n* It should also have at least one example in the ParallelFunction class definition (there should be a docstring) so that something shows up in the reference manual.\n* The end of the ``__call__`` docstring seems to have the triple quote misindented.\n* `except AtrributeError:` this isn't really a formatting error, but just an error.  There should be a doctest for this?\n* `anqd` is not a word\n\nIt looks good, though.  I don't feel quite comfortable enough with the parallel stuff to review it completely, but if the doctests work then this makes sense, and the getdoc etc. certainly is right.\n\nI'm cc:ing Niles in because he originally asked about this, so hopefully he can positively review the rest.",
    "created_at": "2011-06-14T02:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124490",
    "user": "kcrisman"
}
```

Formatting things:
* This needs very minor rebasing with respect to #11467.   
* It should also have at least one example in the ParallelFunction class definition (there should be a docstring) so that something shows up in the reference manual.
* The end of the ``__call__`` docstring seems to have the triple quote misindented.
* `except AtrributeError:` this isn't really a formatting error, but just an error.  There should be a doctest for this?
* `anqd` is not a word

It looks good, though.  I don't feel quite comfortable enough with the parallel stuff to review it completely, but if the doctests work then this makes sense, and the getdoc etc. certainly is right.

I'm cc:ing Niles in because he originally asked about this, so hopefully he can positively review the rest.



---

archive/issue_comments_124491.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-06-14T03:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124491",
    "user": "kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_124492.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n> I'm cc:ing Niles in because he originally asked about this, so hopefully he can positively review the rest.\n\nI've been looking at this, and it's working well for me.  I hope to have time for a thorough review soon.  One minor issue (from #9976): the author section has \"8 apr 2011\" which should be \"8 Apr 2011\".",
    "created_at": "2011-06-14T11:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124492",
    "user": "niles"
}
```

Replying to [comment:7 kcrisman]:
> I'm cc:ing Niles in because he originally asked about this, so hopefully he can positively review the rest.

I've been looking at this, and it's working well for me.  I hope to have time for a thorough review soon.  One minor issue (from #9976): the author section has "8 apr 2011" which should be "8 Apr 2011".



---

archive/issue_comments_124493.json:
```json
{
    "body": "rebased to 4.7.1",
    "created_at": "2011-09-07T02:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124493",
    "user": "niles"
}
```

rebased to 4.7.1



---

archive/issue_comments_124494.json:
```json
{
    "body": "Attachment\n\nPasses all long tests on 4.7.1.\n\nPatchbot: apply trac_11461_rebase.patch",
    "created_at": "2011-09-08T01:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124494",
    "user": "niles"
}
```

Attachment

Passes all long tests on 4.7.1.

Patchbot: apply trac_11461_rebase.patch



---

archive/issue_comments_124495.json:
```json
{
    "body": "Attachment\n\nrebased to 4.7.2",
    "created_at": "2012-01-16T18:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124495",
    "user": "niles"
}
```

Attachment

rebased to 4.7.2



---

archive/issue_comments_124496.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-16T18:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124496",
    "user": "niles"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_124497.json:
```json
{
    "body": "Rebased again; comments of Karl have also been addressed; anyone else who could review this?\n\nPatchbot: apply trac_11461_rebase.patch",
    "created_at": "2012-01-16T18:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124497",
    "user": "niles"
}
```

Rebased again; comments of Karl have also been addressed; anyone else who could review this?

Patchbot: apply trac_11461_rebase.patch



---

archive/issue_comments_124498.json:
```json
{
    "body": "I meant to say:\n\nPatchbot: apply trac_11461_rebase_2.patch",
    "created_at": "2012-01-16T18:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124498",
    "user": "niles"
}
```

I meant to say:

Patchbot: apply trac_11461_rebase_2.patch



---

archive/issue_comments_124499.json:
```json
{
    "body": "See also #11462.  My guess is that that has priority due to the prior positive review...\n\nNiles, my sense is that you only rebased, but give positive review to Mike's patch.  What would still have to be reviewed?",
    "created_at": "2012-01-16T19:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124499",
    "user": "kcrisman"
}
```

See also #11462.  My guess is that that has priority due to the prior positive review...

Niles, my sense is that you only rebased, but give positive review to Mike's patch.  What would still have to be reviewed?



---

archive/issue_comments_124500.json:
```json
{
    "body": "Indeed, I see no problems with Mike's patch.  The descriptor protocol is the right way to fix this, and the implementation of `sage.misc.sageinspect` methods is straightforward.  Rebase 3 fixes a minor issue with the documentation: Positive review!\n\nPatchbot: apply trac_11461_rebase_3.patch",
    "created_at": "2012-01-16T20:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124500",
    "user": "niles"
}
```

Indeed, I see no problems with Mike's patch.  The descriptor protocol is the right way to fix this, and the implementation of `sage.misc.sageinspect` methods is straightforward.  Rebase 3 fixes a minor issue with the documentation: Positive review!

Patchbot: apply trac_11461_rebase_3.patch



---

archive/issue_comments_124501.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-16T20:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124501",
    "user": "niles"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_124502.json:
```json
{
    "body": "rebased to 4.7.2, minor typos fixed, now depends on #11462",
    "created_at": "2012-01-16T20:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124502",
    "user": "niles"
}
```

rebased to 4.7.2, minor typos fixed, now depends on #11462



---

archive/issue_comments_124503.json:
```json
{
    "body": "Attachment\n\nSorry for the many updates; this patch is now compatible with (depends on) #11462.",
    "created_at": "2012-01-16T20:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124503",
    "user": "niles"
}
```

Attachment

Sorry for the many updates; this patch is now compatible with (depends on) #11462.



---

archive/issue_comments_124504.json:
```json
{
    "body": "Patchbot:  apply #11462 and trac_11461_rebase_3.patch",
    "created_at": "2012-01-16T20:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124504",
    "user": "niles"
}
```

Patchbot:  apply #11462 and trac_11461_rebase_3.patch



---

archive/issue_comments_124505.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-18T08:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11289#issuecomment-124505",
    "user": "jdemeyer"
}
```

Resolution: fixed
