# Issue 19882: More typical dmg for Mac distribution

Issue created by migration from https://trac.sagemath.org/ticket/20119

Original creator: mgoerner

Original creation time: 2016-02-26 04:10:38

CC:  mgoerner kcrisman iandrus vbraun

Most Mac applications come in a dmg with an arrow pointing to a symlink of Applications. I have taken one of the dmg's and added the necessary files to make this work:

![](http://unhyperbolic.org/macSage/screenshot.png)

http://unhyperbolic.org/macSage/

Could we change the sage Mac distribution to be like that?

All that is necessary is copying two files (.DT_store and .background/background.png) to the directory from which the dmg is created by hditutil in local/bin/sage-bdist.

I got the background image above from the Apache project, we should probably design one for sage, for some inspiration, here is the FireFox one:
http://i.stack.imgur.com/joTDs.png



---

Comment by mgoerner created at 2016-02-26 04:17:44

I left out some fine print when I said "all the is necessary". It is not quiet as easy, but solvable!

The problem is that the volume name in the dmg we are creating is changing since it contains the sage version number. And the .DT_store doesn't save a relative path to the background image but a pair (volume name, absolute path within volume), so we need to update the .DT_store for every release.

Luckily, there are pure python tools to update the .DT_store file such as [ds_store](https://pypi.python.org/pypi/ds_store) and [mac_alias](https://pypi.python.org/pypi/mac_alias) so that we can create a .DT_store file by hand once in finder and then do the update programmatically for subsequent releases or flavors.

dmg-builder for example does that [here](https://bitbucket.org/al45tair/dmgbuild/src/b08746ed79385ccc512cc23342cf698c5ba0bd3e/dmgbuild/core.py?at=default&fileviewer=file-view-default#core.py-355)

We can write a little python script invoked by local/bin/sage-bdist to use the above libraries to:
- ds_store.DSStore.open the file
- get the value at the key [ '.' ][ 'icvp' ][ 'backgroundImageAlias' ]
- deserialize to a mac_alias.Alias object
- change the volume name in that object's volume info
- write it all back

mac_alias seems to use Mac OS X specific API, so we might need to use the system's python for that.

One question I have if I were to implement it: this would mean that the dmg build process becomes dependent on the above packages ds_store and mac_alias, where should these be installed?


---

Comment by mgoerner created at 2016-02-26 04:20:15

And another suggestion about the Mac App: I think we should add a symlink into the Sage-VERSION.app folder sage -> Contents/Resources/sage/sage so that people who have the app installed but for some reason need to use it from the command line do not need to descend down Contents/Resources.


---

Comment by kcrisman created at 2016-02-26 15:44:35

> One question I have if I were to implement it: this would mean that the dmg build process becomes dependent on the above packages ds_store and mac_alias, where should these be installed?

Hmm, that might not be something easy to deal with, since usually we like "batteries included" including for anyone to build.  But maybe the release manager would be able to incorporate something like this in build scripts that aren't intended for everyone's consumption?


---

Comment by vbraun created at 2016-02-26 17:01:35

If you just need to change a path in the template `.DT_store` then I'd just use sed. Alternatively make a virtualenv Python package install with the necessary packages somewhere e.g. in `src/mac-app/tools/`.

Note that the mac app is built with the Makefile in #19673 and not with anything in the Sage repo until somebody manages to review that trivial ticket. In particular `sage-bdist` is not used.


---

Comment by mgoerner created at 2016-02-26 17:36:10

Replying to [comment:4 vbraun]:
> If you just need to change a path in the template `.DT_store` then I'd just use sed.


Unfortunately, it is a binary format and not that easy :( But I got it to work.


> Alternatively make a virtualenv Python package install with the necessary packages somewhere e.g. in `src/mac-app/tools/`.

Just to make sure, you mean in, e.g., the Makefile, creating a virtualenv, installing the needed packages in there and then run it or you mean creating a virtualenv and checking it into the sage repository?

> Note that the mac app is built with the Makefile in #19673 and not with anything in the Sage repo until somebody manages to review that trivial ticket. In particular `sage-bdist` is not used.

Thanks for letting me know.


---

Comment by kcrisman created at 2016-02-26 19:07:56

But `sage-bdist` is still possible for local builds?  (E.g. providing builds for older Mac platforms...)


---

Comment by vbraun created at 2016-02-26 21:26:10

No, sage-bdist won't work. You need https://github.com/sagemath/binary-pkg to make relocatable binaries. The latter should also work on reasonably old OSX versions but we don't have any to test. Considering that anything but the most recent OSX version has unpatched root exploits its not a priority for me.


---

Comment by iandrus created at 2016-02-28 04:45:37

Could we perhaps always name the volume the same thing, and change the name of the dmg file?


---

Comment by mgoerner created at 2016-02-28 08:10:54

Replying to [comment:8 iandrus]:
> Could we perhaps always name the volume the same thing, and change the name of the dmg file?

Yes, but then we also need to stick to the same name for the .app directory in the dmg file (which is what SnapPy does) because the icon positions stored in the .DT_store are keyed by file name. Right now, it is named Sage-VERSION.app, so it is changing.
And I would like to keep the .app name as is including the version number, especially since once it is installed, a user cannot change the name, so cannot keep an old version while installing a new version.


---

Comment by mgoerner created at 2016-02-28 18:11:23

New commits:


---

Comment by git created at 2016-03-01 20:18:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mgoerner created at 2016-03-01 20:54:26

Here is a screenshot:
![](http://unhyperbolic.org/macSage/screenshot2.png)

It is done, though we might want to wait until [ticket 19673](http://trac.sagemath.org/ticket/19673) is reviewed and rebase the changes off that branch.


---

Comment by mgoerner created at 2016-03-02 22:23:16

Changing status from new to needs_review.


---

Comment by vbraun created at 2016-03-03 21:27:24

Lgtm


---

Comment by vbraun created at 2016-03-03 21:27:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-04 22:52:30

Resolution: fixed


---

Comment by kcrisman created at 2016-03-11 04:24:37

I realize now that this requires a slight change to some documentation - see #20189


---

Comment by kcrisman created at 2016-06-08 17:30:04

Matthias:
This broke dmg construction on some older Mac OS versions.  See [here](https://groups.google.com/d/msg/sage-release/J-OTLt5ac-g/CchvvuykAwAJ).

Any ideas for a quick workaround?  I really just need to make the "old" app bundle and then drop in the binary and then hdiutil it to a dmg, as in the old script.  It would _also_ be good to see if there was a fix that worked for older OS X but my immediate need is to make a binary for upload before they take this older computer away from me (because I don't think a lot of people will be making binaries for 10.7 much longer but some will still have it).

Thanks!


---

Comment by mgoerner created at 2016-06-08 17:51:45

I think you can just remove $(TARGET)/.DS_store from the non_app_files: target in src/mac-app/Makefile and then build it on 10.7  -without the nice arrangement of the icons and background image :(

I am not sure how you can tell binary_pkg to pick up that change. I would commit that change to a local repository and point binary_pkg's sage_yaml to that local repository.

Replying to [comment:21 kcrisman]:
> Matthias:
> This broke dmg construction on some older Mac OS versions.  See [here](https://groups.google.com/d/msg/sage-release/J-OTLt5ac-g/CchvvuykAwAJ).
> 
> Any ideas for a quick workaround?  I really just need to make the "old" app bundle and then drop in the binary and then hdiutil it to a dmg, as in the old script.  It would _also_ be good to see if there was a fix that worked for older OS X but my immediate need is to make a binary for upload before they take this older computer away from me (because I don't think a lot of people will be making binaries for 10.7 much longer but some will still have it).
> 
> Thanks!


---

Comment by kcrisman created at 2016-06-08 19:11:44

> I think you can just remove $(TARGET)/.DS_store from the non_app_files: target in src/mac-app/Makefile and then build it on 10.7  -without the nice arrangement of the icons and background image :(

Well, hopefully someone would still be able to use it.

> I am not sure how you can tell binary_pkg to pick up that change. I would commit that change to a local repository and point binary_pkg's sage_yaml to that local repository.
> 

Hmm, I didn't think of that.  Hopefully I can get the syntax right.  Thanks!

It would really be nice if one wasn't forced to use binary-pkg, though I understand why that change was made.   No one would have been hurt by keeping sage-bdist around.


---

Comment by kcrisman created at 2016-06-08 19:19:33

> > I am not sure how you can tell binary_pkg to pick up that change. I would commit that change to a local repository and point binary_pkg's sage_yaml to that local repository.
> > 
> 
> Hmm, I didn't think of that.  Hopefully I can get the syntax right.  Thanks!

Unfortunately I can't get the syntax right - I'll followup on sage-release again.


---

Comment by vbraun created at 2016-06-08 19:40:51

This ticket is closed, can you open a new one? I have a suggestion but I'm not going to make it on a closed ticket.


---

Comment by kcrisman created at 2016-06-09 01:16:18

> This ticket is closed, can you open a new one? I have a suggestion but I'm not going to make it on a closed ticket.

Ok, though thanks for your comment [here](https://groups.google.com/forum/#!topic/sage-release/J-OTLt5ac-g) unclear if it solved my problem yet.
