# Issue 27058: Add GAP's Semigroups package to gap_packages

Issue created by migration from https://trac.sagemath.org/ticket/27295

Original creator: nthiery

Original creation time: 2019-02-15 15:00:34

CC:  dimpase isuruf




---

Comment by dimpase created at 2019-03-01 13:25:53

of these, only Semigroups doesn't want to get installed.

```
#W dlopen() error: libsemigroups.so.0: cannot open shared object file: No such file or directory
Error, module '/mnt/opt/Sage/sage-dev/local/share/gap/pkg/semigroups-3.0.20/bin/x86_64-pc-linux-gnu-default64/semigroups.so' not found in
  if not LOAD_DYN( arg[1], false ) then
    Error( "no support for dynamic loading" );
fi; at /mnt/opt/Sage/sage-dev/local/share/gap/lib/files.gd:583 called from 
<function "LoadDynamicModule">( <arguments> )
 called from read-eval loop at /mnt/opt/Sage/sage-dev/local/share/gap/pkg/semigroups-3.0.20/init.g:26
Error, was not in any namespace at /mnt/opt/Sage/sage-dev/local/share/gap/lib/variable.g:291 called from
LEAVE_NAMESPACE(  ); at /mnt/opt/Sage/sage-dev/local/share/gap/lib/package.gi:1253 called from
ReadPackage( pkgname, "init.g" ); at /mnt/opt/Sage/sage-dev/local/share/gap/lib/package.gi:1616 called from
<function "LoadPackage">( <arguments> )
 called from read-eval loop at *stdin*:1
...
```

And indeed:

```
$ find local/ -name semigroups.so
local/lib/gap/pkg/semigroups-3.0.20/bin/x86_64-pc-linux-gnu-default64/semigroups.so
$ find local/ -name libsemigroups.so
local/lib/gap/pkg/semigroups-3.0.20/bin/lib/libsemigroups.so
$ ldd `find local/ -name libsemigroups.so`
	linux-vdso.so.1 (0x00007ffd85de3000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fa1ffc9e000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/libstdc++.so.6 (0x00007fa1ffa95000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fa1ff91a000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fa1ff74b000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/libgcc_s.so.1 (0x00007fa1ff731000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fa1ffd35000)
$ ldd `find local/ -name semigroups.so`
	linux-vdso.so.1 (0x00007ffd8e160000)
	libsemigroups.so.0 => not found
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd7baaf4000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/libstdc++.so.6 (0x00007fd7ba8eb000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fd7ba770000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fd7ba5a1000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/8.3.0/libgcc_s.so.1 (0x00007fd7ba585000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fd7bab88000)
```



---

Comment by dimpase created at 2019-03-01 13:27:01

This is after applying

```diff
diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index d8260b9aa0..4592675553 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
@@ -19,6 +19,7 @@ sdh_install \
     crystcat \
     design \
     gbnp \
+    genss-* \
     Hap* \
     HAPcryst \
     hecke-* \
@@ -76,7 +77,7 @@ done
 # These packages have a new-style autoconf ./configure
 # that takes --with-gaproot
 
-for pkg in nq-* io-*
+for pkg in nq-* io-* orb-* digraphs-* semigroups-*
 do
     cd "$PKG_SRC_DIR/$pkg"
     sdh_configure --with-gaproot="$GAP_ROOT"
```

to the branch of #26930.


---

Comment by dimpase created at 2019-03-01 13:53:54

This is a sort of upstream issue - they install a libsemigroup, a C++ library, in the tree, etc etc. I've opened https://github.com/gap-packages/Semigroups/issues/580
---a clean way would be to install in advance, libsemigroup separately.


---

Comment by dimpase created at 2019-03-02 07:46:19

upstream welcomes PRs, so I'll try doing this in a proper way.


---

Comment by dimpase created at 2019-03-02 08:19:19

Changing keywords from "" to "GAP packages, semigroups".


---

Comment by fbissey created at 2019-03-04 01:09:03

`digraphs` includes its own copy of `bliss` and just trying to do the right thing they just digraphs name_spaced bliss functions.

```
fbissey@moonloop ~/sandbox/gap-4.10.0/pkg/digraphs-0.13.0 $ diff -u /dev/shm/portage/sci-libs/bliss-0.73-r1/work/bliss-0.73/bliss_C.h src/bliss-0.73/bliss_C.h 
--- /dev/shm/portage/sci-libs/bliss-0.73-r1/work/bliss-0.73/bliss_C.h   2015-09-01 19:23:10.000000000 +1200
+++ src/bliss-0.73/bliss_C.h    2018-11-02 11:56:12.000000000 +1300
@@ -1,5 +1,5 @@
-#ifndef BLISS_C_H
-#define BLISS_C_H
+#ifndef bliss_digraphs_C_H
+#define bliss_digraphs_C_H
 
 /*
   Copyright (c) 2003-2015 Tommi Junttila
@@ -37,14 +37,14 @@
 /**
  * \brief The true bliss graph is hiding behind this typedef.
  */
-typedef struct bliss_graph_struct BlissGraph;
+typedef struct bliss_digraphs_graph_struct BlissGraph;
....
```



---

Comment by dimpase created at 2019-03-04 07:12:55

I don't seem to have a problem with digraphs, it installs just fine, and uses a static copy of bliss, it seems. 

Do you mean to say one has to watch out for something, still?


---

Comment by fbissey created at 2019-03-04 07:27:50

Replying to [comment:9 dimpase]:
> I don't seem to have a problem with digraphs, it installs just fine, and uses a static copy of bliss, it seems. 
> 
> Do you mean to say one has to watch out for something, still?

No, just don't like it I guess.


---

Comment by dimpase created at 2019-03-07 11:58:07

At least with semigroups, hopefully after my https://github.com/gap-packages/Semigroups/pull/584 is in, it can be done in a clean way.


---

Comment by fbissey created at 2019-03-07 20:01:25

Replying to [comment:11 dimpase]:
> At least with semigroups, hopefully after my https://github.com/gap-packages/Semigroups/pull/584 is in, it can be done in a clean way.

Looks good. It looks like that will have to wait gap-4.10.2 for it. I just finished updating all my sage-on-gentoo gap packages to offer 4.10.1 and I must say I was shocked when `orb` ditched autotools for a `gac` setup a la `crypting` which I think is an inferior solution. I hope it doesn't become a standard practise across gap packages.


---

Comment by dimpase created at 2019-03-19 12:09:27

Upstream has https://github.com/gap-packages/Semigroups/tree/v3.1.2 which has all the needed changes. Should we make a separate optional package for this?


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by dimpase created at 2019-07-01 15:11:55

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-07-01 15:11:55

New commits:


---

Comment by git created at 2019-07-01 15:13:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2019-07-02 17:32:08

Doesn't Digraphs have the same problem with planarity?


---

Comment by dimpase created at 2019-07-02 17:56:37

Replying to [comment:19 isuruf]:
> Doesn't Digraphs have the same problem with planarity?

sorry, what problem?


---

Comment by embray created at 2019-07-04 13:12:30

Replying to [comment:20 dimpase]:
> Replying to [comment:19 isuruf]:
> > Doesn't Digraphs have the same problem with planarity?
> 
> sorry, what problem?

This: https://github.com/gap-packages/Digraphs/pull/207

Any version of Digraphs we include in Sage should have this patch, and should be built with `--with-external-planarity` (as such, libplanarity then needs to be a dependency of gap_packages, assuming it isn't already).


---

Comment by embray created at 2019-07-04 13:13:05

IIRC there are also some patches to libplanarity that are needed by digraphs.  Isuru would know what they are since he included them in the conda package.


---

Comment by dimpase created at 2019-07-04 13:38:49

Does this imply that this ticket is (abot) broken, as it adds Digraphs in an "old" way?
How does one test?

Note that https://github.com/gap-packages/Digraphs/pull/207 isn't even in a released version of Digraphs.


---

Comment by isuruf created at 2019-07-04 13:47:45

Only patch needed by planarity is extern patch that sage already has.

> Does this imply that this ticket is (abot) broken, as it adds Digraphs in an "old" way? How does one test? 

Probably. Digraphs adds planarity as a subdirectory just like semigroups does with libsemigroups and therefore planarity inside digraphs is not installed. Since planarity is installed in sage and the two versions of planarity are ABI compatible, you might not see a missing planarity issue. This would break if planarity versions differ in Digraphs and Sage which is pretty unlikely since planarity changes rarely.


---

Comment by dimpase created at 2019-07-04 15:33:17

Replying to [comment:24 isuruf]:
> Only patch needed by planarity is extern patch that sage already has.
> 
> > Does this imply that this ticket is (abot) broken, as it adds Digraphs in an "old" way? How does one test? 
> 
> Probably. Digraphs adds planarity as a subdirectory just like semigroups does with libsemigroups and therefore planarity inside digraphs is not installed. Since planarity is installed in sage and the two versions of planarity are ABI compatible, you might not see a missing planarity issue. This would break if planarity versions differ in Digraphs and Sage which is pretty unlikely since planarity changes rarely.

You're right that `Digraphs` pick up Sage's libplanarity.so:

```
$ ldd local/lib/gap/pkg/digraphs-0.15.2/bin/x86_64-pc-linux-gnu-default64-kv3/digraphs.so
	linux-vdso.so.1 (0x00007fff9bdb7000)
	libplanarity.so.0 => /mnt/opt/Sage/sage-dev/local/lib/libplanarity.so.0 (0x00007f55c349d000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/libstdc++.so.6 (0x00007f55c3200000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f55c30c3000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f55c2ef3000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/libgcc_s.so.1 (0x00007f55c2ed9000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f55c350e000)
```


So in this sense the only thing to fix is to add `planarity` to dependencies of `gap_packages`. I've checked that `Digraphs` passes its own testsuite, just in case.


---

Comment by embray created at 2019-07-04 15:55:26

Would still be best to use `--with-external-planarity` if possible.  Or if nothing else, delete the vendored copy it builds before installing into Sage if we definitely don't need it.


---

Comment by isuruf created at 2019-07-04 16:00:12

Since there hasn't been a release of Digraphs, it wouldn't work, but it's still okay to add `--with-external-planarity` and released Digraph's configure just ignores it and you wouldn't have to do anything when a new release comes in.


---

Comment by git created at 2019-07-04 16:09:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-04 16:11:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-04 16:15:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-04 16:56:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-07-04 16:59:08

Replying to [comment:27 isuruf]:
> Since there hasn't been a release of Digraphs, it wouldn't work, but it's still okay to add `--with-external-planarity` and released Digraph's configure just ignores it and you wouldn't have to do anything when a new release comes in.

I've added this, and missing deps, and the correct tarball checksum for libsemigroups from #27396. I didn't try to remove dead wood copy of planarity installed by
Digraph, as this appears to be harmless, and won't be needed once we get updated Digraph.


---

Comment by fbissey created at 2019-07-04 20:58:21

Dear me, I forgot those horrors so fast. No only does Digraphs use plain "planarity" it also include its own vendored (and prefixed so it doesn't clash) version of bliss-0.73. I had some fun patching that in 0.13.0 and 0.15.0. No I may have to reproduce it for 0.15.2.


---

Comment by isuruf created at 2019-07-17 16:46:37

This package vendors bliss. Is that okay?


---

Comment by dimpase created at 2019-07-17 16:52:59

We know about vendored bliss. It builds it statically, so it should not be a show-stopper. It should be unvendored upstream. 

Some of us actually do research in semigroup algorithms, so we want it in...


---

Comment by isuruf created at 2019-07-17 16:54:45

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2019-07-17 16:54:45

Do you mind creating a new trac ticket for unvendoring bliss?


---

Comment by dimpase created at 2019-07-17 17:06:04

To be more precise, it's Digraphs, a dependency of Semigroups, that vendors bliss.

So this is  in fact https://github.com/gap-packages/Digraphs/issues/205


---

Comment by fbissey created at 2019-07-17 20:37:52

I have an unvendoring patch in sage-on-gentoo, but it is minimal. I pass `LIBS="-lbliss -lplanarity -lgap"` to configure, it should be improved to get configure to figure it itself. https://github.com/cschwan/sage-on-gentoo/blob/master/dev-gap/digraphs/files/digraphs-0.15.2-system_pkg.patch


---

Comment by fbissey created at 2019-07-17 23:29:55

Improved unvendoring patch: https://github.com/cschwan/sage-on-gentoo/blob/master/dev-gap/digraphs/files/digraphs-0.15.2-system_pkg-r1.patch

`configure` now searches for the libraries by itself.


---

Comment by vbraun created at 2019-08-10 13:08:42

Resolution: fixed


---

Comment by embray created at 2019-08-15 18:09:27

Seems to work on Cygwin too, FWIW.
