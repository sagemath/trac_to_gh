# Issue 33413: Set JUPYTER_CONFIG_DIR during docbuild

Issue created by migration from https://trac.sagemath.org/ticket/33650

Original creator: mkoeppe

Original creation time: 2022-04-06 04:36:28

CC:  klee dimpase @collares

After #33507, jupyter gets invoked during the docbuild.
This can lead to a new class of errors as seen in #33507#comment:75 and #33507#comment:86

We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.


---

Comment by mkoeppe created at 2022-04-06 04:56:39

This could be done, for example, in `build/pkgs/sagemath_doc_html/spkg-install`


---

Comment by klee created at 2022-04-06 04:57:13

> We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.

Dima had the same issue with `./sage -n`. So we should not focus on the docbuild.


---

Comment by mkoeppe created at 2022-04-06 05:00:35

Well, `sage -n` is for running Jupyter, so I'd think it's correct to use the user's configuration - so it's the user's problem if their personal configuration in `~/.jupyter` is overriding our kernel.

But for the build process we should do better.


---

Comment by mkoeppe created at 2022-04-06 05:10:19

New commits:


---

Comment by mkoeppe created at 2022-04-06 05:10:19

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-04-06 05:14:55

In addition, I suppose in `sage -n` we could warn the user if `jupyter kernelspec list` reveals that our kernels are shadowed by user configuration.


---

Comment by mkoeppe created at 2022-04-06 05:17:09

I've opened #33651 for this.


---

Comment by klee created at 2022-04-06 05:56:50

Why not `unset VAR` instead of pointing jupyter to non-existing directory or path?


---

Comment by mkoeppe created at 2022-04-06 07:09:16

When unset, it uses the default directories, which can contain the bad user configuration.


---

Comment by klee created at 2022-04-06 08:16:44

Replying to [comment:11 mkoeppe]:
> When unset, it uses the default directories, which can contain the bad user configuration.

I see.

Then it looks good to me. Now I am simulating the failing situation to see that the branch works as expected. 

Meanwhile let me note that #33320 (which supersedes #33507) circumvents this bug since it does not run jupyter to build the live doc.


---

Comment by klee created at 2022-04-06 09:08:10

In `/Users/kwankyu/GitHub/sage-dev`:

After 

```
(sage-sh) kwankyu@Hera:sage-dev$ ipython kernel install --name "sagemath" --user
Installed kernelspec sagemath in /Users/kwankyu/Library/Jupyter/kernels/sagemath
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list
Available kernels:
  sagemath        /Users/kwankyu/Library/Jupyter/kernels/sagemath
  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3
```


`make` fails even with the branch.

After

```
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec remove sagemath
Kernel specs to remove:
  sagemath            	/Users/kwankyu/Library/Jupyter/kernels/sagemath
Remove 1 kernel specs [y/N]: y
[RemoveKernelSpec] Removed /Users/kwankyu/Library/Jupyter/kernels/sagemath
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list
Available kernels:
  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3
  sagemath        /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/sagemath
```

`make` does not fail.


---

Comment by klee created at 2022-04-06 09:30:17

This

```
export JUPYTER_DATA_DIR=/doesnotexist  
```

worked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel. Fortunately that directory does not exist either, in my case. 

A safe solution would be to add the real path to our kernel at the front...


---

Comment by klee created at 2022-04-06 09:47:21

Replying to [comment:14 klee]:
> A safe solution would be to add the real path to our kernel at the front...

Thus 

```
export JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, "share", "jupyter")???
```


This is rather cumbersome though...


---

Comment by dimpase created at 2022-04-06 09:52:07

Perhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.


---

Comment by klee created at 2022-04-06 11:11:47

Replying to [comment:16 dimpase]:
> Perhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.

+1


---

Comment by klee created at 2022-04-06 13:04:22

New commits:


---

Comment by klee created at 2022-04-06 13:05:36

Versioned kernel works well.


---

Comment by git created at 2022-04-06 13:25:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-06 17:20:21

This is not getting better with versioning because it does not distinguish kernels from different installations of Sage.


---

Comment by git created at 2022-04-06 17:25:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-04-06 17:29:45

Replying to [comment:15 klee]:
> Replying to [comment:14 klee]:
> {{{
> export JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, "share", "jupyter")???
> }}}

I don't think it's necessary to set it to the location of our jupyter installation because that is always active.


---

Comment by mkoeppe created at 2022-04-06 17:31:37

Replying to [comment:14 klee]:
> This
> {{{
> export JUPYTER_DATA_DIR=/doesnotexist  
> }}}
> worked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.

Where would that directory be coming from?


---

Comment by klee created at 2022-04-06 21:06:32

Replying to [comment:24 mkoeppe]:
> But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.
> 
> Where would that directory be coming from?

I don't know... I don't have it anymore since I deleted the `.sage` directory for experiments. It didn't have kernel definitions in it, and didn't cause a problem.


---

Comment by klee created at 2022-04-06 22:21:42

I confirm that the current branch works well. I am positive.


---

Comment by klee created at 2022-04-07 13:58:21

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-04-07 17:35:56

Thank you!


---

Comment by vbraun created at 2022-04-10 13:13:05

Resolution: fixed


---

Comment by @collares created at 2022-05-04 08:32:30

On NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.


---

Comment by fbissey created at 2022-05-04 09:48:20

Replying to [comment:32 gh-collares]:
> On NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.

For the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.
https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.6-makefile_and_parallel.patch

I think we are at a point where ditching `./sage --docbuild` in favor of what I am currently doing in vanilla sage is not only possible but probably inevitable in the short term.


---

Comment by mkoeppe created at 2022-05-04 16:52:54

Replying to [comment:32 gh-collares]:
> The fact that `--docbuild` is handled by `sage-site`

I propose to move it back to `src/bin/sage` in #33795


---

Comment by mkoeppe created at 2022-05-04 16:56:49

Replying to [comment:33 fbissey]:
> For the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.

+1, that's the way.
