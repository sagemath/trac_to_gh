# Issue 23578: Upgrade to Python 2.7.14

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2017-09-09 20:01:16

Python 2.7.14 release candidate 1 is out:

    https://www.python.org/downloads/release/python-2714rc1/

If I remember correctly upgrades to 2.7.12 (#19735) and 2.7.13 (#22037)
involved reverting some changes in Python.

Testing 2.7.14.rc1 would increase chances to detect such problems in advance.


---

Comment by jdemeyer created at 2017-09-10 08:20:09

OK, I am testing it...


---

Comment by jhpalmieri created at 2017-09-10 14:54:03

On OS X it builds, and I get

```
sage -t --long --warn-long 38.4 src/sage/misc/weak_dict.pyx  # 1 doctest failed
sage -t --long --warn-long 38.4 src/sage/parallel/use_fork.py  # 1 doctest failed
sage -t --long --warn-long 38.4 src/sage/misc/fast_methods.pyx  # 1 doctest failed
```

In detail:

```
File "src/sage/misc/weak_dict.pyx", line 37, in sage.misc.weak_dict
Failed example:
    del ValList, v
Expected:
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    ...
Got:
    <BLANKLINE>
```

and

```
File "src/sage/parallel/use_fork.py", line 146, in sage.parallel.use_fork.p_iter_fork.__call__
Failed example:
    L
Expected:
    [(((Rational Field,), {}),
      "INVALID DATA ('__init__() takes at most 2 positional arguments (4 given)', <type 'sage.rings.integer.Integer'>, (Univariate Polynomial Ring in x over Rational Field, [0, 1], False, True))")]
Got:
    [(((Rational Field,), {}),
      'INVALID DATA __init__() takes at most 2 positional arguments (4 given)')]
```

and

```
File "src/sage/misc/fast_methods.pyx", line 305, in sage.misc.fast_methods.Singleton
Failed example:
    loads(dumps(c))
Expected:
    Traceback (most recent call last):
    ...
    AssertionError: (("<class '__main__.D'> is not a direct
    subclass of <class 'sage.misc.fast_methods.Singleton'>",),
    <class '__main__.D'>, ())
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.fast_methods.Singleton[12]>", line 1, in <module>
        loads(dumps(c))
      File "sage/structure/sage_object.pyx", line 1491, in sage.structure.sage_object.loads (/Users/palmieri/Desktop/Sage_stuff/git/sage/src/build/cythonized/sage/structure/sage_object.c:16071)
        return unpickler.load()
      File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (/Users/palmieri/Desktop/Sage_stuff/git/sage/src/build/cythonized/sage/misc/classcall_metaclass.c:1469)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/fast_methods.pyx", line 333, in sage.misc.fast_methods.Singleton.__classcall__ (/Users/palmieri/Desktop/Sage_stuff/git/sage/src/build/cythonized/sage/misc/fast_methods.c:1749)
        assert cls.mro()[1] == Singleton, "{} is not a direct subclass of {}".format(cls, Singleton)
    AssertionError: <class '__main__.D'> is not a direct subclass of <class 'sage.misc.fast_methods.Singleton'>
```



---

Comment by jdemeyer created at 2017-09-10 15:25:00

Same here:


```
sage -t --long src/sage/parallel/use_fork.py
**********************************************************************
File "src/sage/parallel/use_fork.py", line 146, in sage.parallel.use_fork.p_iter_fork.__call__
Failed example:
    L
Expected:
    [(((Rational Field,), {}),
      "INVALID DATA ('__init__() takes at most 2 positional arguments (4 given)', <type 'sage.rings.integer.Integer'>, (Univariate Polynomial Ring in x over Rational Field, [0, 1], False, True))")]
Got:
    [(((Rational Field,), {}),
      'INVALID DATA __init__() takes at most 2 positional arguments (4 given)')]
**********************************************************************
1 item had failures:
   1 of  12 in sage.parallel.use_fork.p_iter_fork.__call__
    [28 tests, 1 failure, 0.70 s]
sage -t --long src/sage/misc/fast_methods.pyx
**********************************************************************
File "src/sage/misc/fast_methods.pyx", line 305, in sage.misc.fast_methods.Singleton
Failed example:
    loads(dumps(c))
Expected:
    Traceback (most recent call last):
    ...
    AssertionError: (("<class '__main__.D'> is not a direct
    subclass of <class 'sage.misc.fast_methods.Singleton'>",),
    <class '__main__.D'>, ())
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.fast_methods.Singleton[12]>", line 1, in <module>
        loads(dumps(c))
      File "sage/structure/sage_object.pyx", line 1491, in sage.structure.sage_object.loads (build/cythonized/sage/structure/sage_object.c:16071)
        return unpickler.load()
      File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1468)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/fast_methods.pyx", line 333, in sage.misc.fast_methods.Singleton.__classcall__ (build/cythonized/sage/misc/fast_methods.c:1748)
        assert cls.mro()[1] == Singleton, "{} is not a direct subclass of {}".format(cls, Singleton)
    AssertionError: <class '__main__.D'> is not a direct subclass of <class 'sage.misc.fast_methods.Singleton'>
**********************************************************************
1 item had failures:
   1 of  14 in sage.misc.fast_methods.Singleton
    [79 tests, 1 failure, 0.79 s]
sage -t --long src/sage/misc/weak_dict.pyx
**********************************************************************
File "src/sage/misc/weak_dict.pyx", line 37, in sage.misc.weak_dict
Failed example:
    del ValList, v
Expected:
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    Exception KeyError: (<__main__.Keys instance at ...>,) in <function remove at ...> ignored
    ...
Got:
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of  28 in sage.misc.weak_dict
    [239 tests, 1 failure, 1.66 s]
----------------------------------------------------------------------
sage -t --long src/sage/parallel/use_fork.py  # 1 doctest failed
sage -t --long src/sage/misc/fast_methods.pyx  # 1 doctest failed
sage -t --long src/sage/misc/weak_dict.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by jdemeyer created at 2017-09-10 15:27:28

The failures in `use_fork.py` and `fast_methods.pyx` are due to different exception propagation in unpickling, that is nothing serious.


---

Comment by slelievre created at 2017-09-18 14:46:34

Python 2.7.14 is out.


---

Comment by jdemeyer created at 2017-09-22 14:49:36

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-22 14:49:36

In all cases, the doctest failures were because an actual bug in Python was fixed. So it looks right to just update the doctests.
----
New commits:


---

Comment by jdemeyer created at 2017-09-22 14:49:36

Changing type from task to enhancement.


---

Comment by vbraun created at 2017-10-03 23:34:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-05 06:53:56

Resolution: fixed
