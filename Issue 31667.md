# Issue 31667: Pullback silently fails in some cases with multiple charts

Issue created by migration from https://trac.sagemath.org/ticket/31904

Original creator: egourgoulhon

Original creation time: 2021-06-04 07:41:04

CC:  tscrim @mjungmath mkoeppe

Keywords: pullback

In Sage 9.3, we have

```
sage: E.<x,y> = EuclideanSpace()
sage: polar.<r,ph> = E.polar_coordinates()
sage: g = E.metric()
sage: M = Manifold(1, 'M')
sage: Ct.<t> = M.chart()
sage: F = M.diff_map(E, coord_functions={(Ct, polar): (1 + cos(t), t)})
sage: gM = F.pullback(g)
sage: gM
Field of symmetric bilinear forms on the 1-dimensional differentiable
manifold M
```

So far so good, but

```
sage: gM.display()
ValueError: no basis could be found for computing the components in 
 the Coordinate frame (M, (d/dt)
```

Actually, `gM` has not been initialized as a tensor field object, but its components have not been evaluated in any frame:

```
sage: gM._components
{}
```

Forcing the coordinate expression of the map `F` in the Cartesian chart (for instance by a call to `F.display()`) fixes the issue:

```
sage: F.display()
M --> E^2
   t |--> (x, y) = (cos(t)^2 + cos(t), (cos(t) + 1)*sin(t))
   t |--> (r, ph) = (cos(t) + 1, t)
sage: gM = F.pullback(g)
sage: gM.display()
(2*cos(t) + 2) dt*dt
```

However, the expression of `F` in Cartesian coordinates should not be required to compute the pullback of `g` since the latter is known in polar coordinates: 

```
sage: g.display(polar)
g = dr*dr + r^2 dph*dph
```

This bug has been reported at https://ask.sagemath.org/question/57431/


---

Comment by egourgoulhon created at 2021-06-04 08:59:42

New commits:


---

Comment by egourgoulhon created at 2021-06-04 08:59:42

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2021-06-04 09:15:09

The fix consisted in making the internal function `_pullback_chart` of the method `pullback` to operate for a single pair of charts (now added as arguments), which is determined in the main part of `pullback`, based on the knowledge of the map's coordinate expressions.


---

Comment by rburing created at 2021-06-04 11:38:24

The `return partial` statement in the parallel code has seemingly accidentally been indented too far.


---

Comment by git created at 2021-06-05 17:12:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-05 17:17:41

Replying to [comment:5 rburing]:
> The `return partial` statement in the parallel code has seemingly accidentally been indented too far.
Good catch, thanks! (it was not revealed by the parallel doctest because `local_list_ind` had a single element in that case). 
This is corrected in the above commit (as well as a pyflakes error reported by the patchbot).


---

Comment by egourgoulhon created at 2021-06-17 20:16:21

Ricardo, do you agree with the last version?


---

Comment by rburing created at 2021-06-17 21:17:11

Yes, looks good now.


---

Comment by rburing created at 2021-06-17 21:17:11

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-06-17 22:42:03

Thank you!


---

Comment by vbraun created at 2021-06-29 17:40:40

Resolution: fixed
