# Issue 23545: fricas output and sage conversion bug

Issue created by migration from https://trac.sagemath.org/ticket/23782

Original creator: mantepse

Original creation time: 2017-09-04 19:24:04

CC:  simonking chapoton rws

In 'SageMath version 8.1.beta0, Release Date: 2017-07-29' I have the following behaviour, (at least with FriCAS 1.2.5)

```
def elementary(k, j):
    """
    sage: f = fricas.guessRat([elementary(5,j) for j in range(15)])[0]; f
    10      9      8      7       6      5       4      3       2
    3n   - 25n  + 50n  + 62n  - 229n  - 25n  + 320n  - 12n  - 144n
    ---------------------------------------------------------------
                                 11520

    sage: print fricas.get(f._name)
      10      9      8      7       6      5       4      3       2
    3n   - 25n  + 50n  + 62n  - 229n  - 25n  + 320n  - 12n  - 144n
    ---------------------------------------------------------------
                                 11520

    sage: f.sage()
    NotImplementedError: The translation of the FriCAS Expression "(3*n^10+-25*n^9+50*n^8+62*n^7+-229*n^6+-25*n^5+320*n^4+-12*n^3+-144*n^2)/11520 to sage is not yet implemented.
    """
    return stirling_number1(j+1, j+1-k)
```

Note the bad indentation in the second line and the weird quotation mark in the third.

Fixing #22525 would probably fix this, too.


---

Comment by chapoton created at 2017-09-05 06:13:36

Changing keywords from "" to "FriCAS".


---

Comment by chapoton created at 2017-09-06 11:45:19

This seems to work after #21377


---

Comment by mantepse created at 2017-09-06 16:31:57

After #21377 I still get the bad indentation, but the error is gone.  So I vote to close...

I'll put the remark concerning the bad indentation on #21377.


---

Comment by mantepse created at 2017-09-12 06:16:15

I just realised that I had a sage 7.5.beta3 lying around:

the display bug was introduced **after** 7.5.beta3 - the bug with the quotation mark existed **already** in 7.5.beta3!


---

Comment by mantepse created at 2017-09-12 06:16:15

Changing type from PLEASE CHANGE to defect.


---

Comment by mantepse created at 2017-09-12 06:24:58

Moreover, there is no change in the code of `fricas.py` between sage 7.5.beta3 and 8.0.beta12, which is the first version I have on my computer where the bug appears.

I have no idea what could have changed - I'm afraid I need to bisect.


---

Comment by mantepse created at 2017-09-12 06:33:08


```
sage:  fricas('(1 + sqrt(2))^5')

+-+
29\|2  + 41
sage: a= fricas('(1 + sqrt(2))^5')
sage: print a
+-+
29\|2  + 41
sage: print fricas.get(a._name)
   +-+
29\|2  + 41
sage: repr(a)
'+-+\r\n29\\|2  + 41'
sage: fricas.get(a._name)
'   +-+\r\n29\\|2  + 41'
```



---

Comment by mantepse created at 2017-09-12 06:43:22

OK, I found it:

```
commit 5082c96e79a15b34779a0c9b0b43d652cdade31c
Author: Simon King <simon.king@uni-jena.de>
Date:   Tue Mar 14 14:53:36 2017 +0100

    Use single underscore _repr_ in interfaces, add more documentation concerning eval and get
```

introduced this change in #22501:

```
+    def _repr_(self):
+        """
+        Default implementation of a helper method for string representation.
...
+        """
+        P = self.parent()
+        try:
+            if self._get_using_file:
+                return P.get_using_file(self._name).strip()
+        except AttributeError:
+            return self.parent().get(self._name).strip()
```


I think the strip should go away.  The other solution is to override it in `fricas.py`, but I really cannot think of a situation where we really want the `strip`.  Output will often be ascii-art in interfaces, and this is a default implementation.


---

Comment by mantepse created at 2017-09-12 06:59:03

I want to add that I commented on #22501 that fricas tests would be passing.  This means that I made a mistake then, so the blame is on me.


---

Comment by mantepse created at 2017-09-12 08:22:06

New commits:


---

Comment by mantepse created at 2017-09-12 08:22:06

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-09-12 08:27:19

I would suggest to use rstrip instead of strip.


---

Comment by git created at 2017-09-12 08:30:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 08:32:30

Replying to [comment:11 chapoton]:
> I would suggest to use rstrip instead of strip.

I agree that this is a sensible possibility, but I'm not completely sure.

Can you think of any surprising results with rstrip?


---

Comment by git created at 2017-09-12 09:37:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 09:39:09

I tested fricas, lie and gap3.  Unfortunately, gap3 is failing, but I do not know yet whether the failures are related to this ticket.


---

Comment by mantepse created at 2017-09-12 09:44:04

I get the same failures in all other versions of sage I have lying around...  So I think that this is really ready to go.  Please review!


---

Comment by chapoton created at 2017-09-12 09:53:32

`Check that #23782 is fixed:`

should be

`Check that :trac:`23782` is fixed::`


---

Comment by chapoton created at 2017-09-12 10:09:44

note also that "atan" will be converted to "arctan" after #22525


---

Comment by git created at 2017-09-12 10:13:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 10:14:57

Replying to [comment:18 chapoton]:
> note also that "atan" will be converted to "arctan" after #22525

yes, I just looked at it, and have a branch that only adds some testcases - I would set it to positive review there and make this one a dependency.  Or would you prefer it the other way round?


---

Comment by chapoton created at 2017-09-12 10:18:49

The branch here is slightly more problematic, because you change the behaviour of all the interfaces and this needs serious checking. The other one should be easier and go first, imho.


---

Comment by mantepse created at 2017-09-12 10:19:50

I agree.  So let's do the other one first.  I have problems with checking out right now, though.


---

Comment by mantepse created at 2017-09-12 10:34:04

I'll undo the modified line in integral.py after recompiling.


---

Comment by git created at 2017-09-12 11:48:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 11:49:51

I think this is ready now.


---

Comment by mantepse created at 2017-09-12 11:55:29

There will be a merge conflict - I guess it's easiest to fix it when #22525 is merged.


---

Comment by git created at 2017-09-22 06:24:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-26 07:22:02

ping?


---

Comment by rws created at 2017-09-26 07:39:01

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-09-26 07:39:01

Using --optional=fricas I get

`sage -t --warn-long 40.1 src/sage/interfaces/fricas.py  # 3 doctests failed`


---

Comment by mantepse created at 2017-09-26 08:00:37

I was told to use
`sage -t --optional fricas,sage src/sage/interfaces/fricas.py`


---

Comment by mantepse created at 2017-09-26 08:30:02

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-09-26 13:09:18

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-09-26 13:09:18

Alright, interesting, thanks. It passes now and looks good.


---

Comment by mantepse created at 2017-09-26 13:59:27

Thank you!


---

Comment by vbraun created at 2017-10-01 00:19:04

Resolution: fixed
