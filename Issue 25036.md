# Issue 25036: Unprefixed libGAP interface

Issue created by migration from https://trac.sagemath.org/ticket/25273

Original creator: jdemeyer

Original creation time: 2018-05-01 09:43:19

CC:  slelievre




---

Comment by dimpase created at 2018-05-01 09:55:23

Does this mean that `libgap.Blah` syntax won't be needed, too?


---

Comment by jdemeyer created at 2018-05-01 11:04:48

New commits:


---

Comment by jdemeyer created at 2018-05-01 11:04:48

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-05-01 11:21:35

In libgap.pyx you have

```
The ``foobar`` methods are
the original GAP methods simply prefixed with the string
````.
```

which looks like an artefact of non-interactive editing...

I presume there is no prefix any more.


---

Comment by git created at 2018-05-01 11:36:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-01 11:38:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2018-05-01 11:44:05

The only `libGAP_` things left are `libGAP_True/False`. There are also `libgap_`-things, but this is another story. The docs about `libGAP_` ought to be more explicit about this.


---

Comment by jdemeyer created at 2018-05-02 07:33:52

I'm not sure anymore that we should do this because it's not at all clear what upstream GAP is going to do. Now that merging libGAP upstream looks further away, they might be convinced to change (some of) these names.


---

Comment by dimpase created at 2018-05-02 10:00:03

But it's just two names that need special treatment - I don't see why you want to postpone this.

As well, I think that if one tells GAP people that a couple of macros need to be renamed to be able to inter-operate with Python etc, they would be happy with such a change.


---

Comment by dimpase created at 2018-09-18 09:17:35

rebased over the latest beta, fixed bug. We could perhaps finish and merge this, as an intermediate step towards #22626.
----
New commits:


---

Comment by jdemeyer created at 2018-09-18 09:41:12

Is it clear what upstream's policy on the naming and prefixing is? See #22626#comment:66


---

Comment by jdemeyer created at 2018-09-18 09:41:21

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2018-09-18 12:17:45

Well, GAP people are reluctant to change names; in particular T_NUM is merely a C enum, and we don't even need to use it (certainly not with the new, since GAP 4.9, functions).


---

Comment by jdemeyer created at 2018-09-18 15:42:46

Replying to [comment:19 dimpase]:
> Well, GAP people are reluctant to change names

Did anybody actually try to convince them? Ideally, they would change their names to reduce changes of name collisions. Since this is C, this matters regardless of whether we actually _use_ those names.


---

Comment by dimpase created at 2018-09-18 16:01:42

I am at https://www.gapdays.de/gapdays2018-fall/ and spent some time yesterday and today talking about this issue with Markus and Max. They say that as they have no control over their packages, changing API is tricky. 

If you can come up with a convincing argument, please do, I'd do my best to communicate it while here. Are there any name clashes in exported symbols in their new libgap-API? IMHO there are none.


---

Comment by dimpase created at 2018-10-04 12:03:06

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2018-10-04 12:03:06

While we at it, are `libgap_enter()` and `libgap_exit()` needed? GAP people told me that they are not. I tried removing them and running ptestlong (with gap_packages installed for a better coverage), no errors (apart from the expected one in libs/gap/util.pyx).

I suggest we proceed with this ticket - it does not look as if #22626 will be ready soon, perhaps we should rather try rebasing libGAP to GAP 4.10, which looks a less daunting task now than a total replacement with "native" GAP's libgap.


---

Comment by jdemeyer created at 2018-10-04 12:18:36

(sorry I seem to have missed your previous comment)

Replying to [comment:21 dimpase]:
> They say that as they have no control over their packages, changing API is tricky.

Changing API should not be tricky if you add a compatibility layer changing the new names to the old names. My proposal should literally be 100% API-compatible for GAP packages.

> Are there any name clashes in exported symbols in their new libgap-API?

I haven't tried the new libgap-API, so I cannot tell. But it's not only about exported symbols, it's about anything defined in the GAP header files. In particular `T_INT` is problematic that way (assuming that it still exists in the new libgap-API).


---

Comment by dimpase created at 2018-10-04 12:21:53

What I did on #22626 is just simply not use `T_INT` (this is a constant equal to 0), I just used 0 instead.


---

Comment by jdemeyer created at 2018-10-04 12:25:27

Replying to [comment:24 dimpase]:
> What I did on #22626 is just simply not use `T_INT` (this is a constant equal to 0), I just used 0 instead.

First of all, I'd consider that very bad style. For example, what if GAP suddenly decided to change the value of `T_INT`?

Second, the question is not whether `T_INT` is _used_. The question is whether it's defined in a header file.


---

Comment by dimpase created at 2018-10-04 12:33:33

`T_INT` won't change "suddenly", for sure, as these `T_*` things are heavily used in GAP's low-level type system.

As I said, as I didn't understand the problem fully (and still don't), I wasn't able to convince GAP devs that something needs to be done about it.


---

Comment by dimpase created at 2018-10-04 12:42:43

For the record, in GAP `T_INT` is a part of  `enum` type `TNUM` in `src/objects.h`, i.e. one sees there 

```
enum TNUM {
 ....
 T_INT;
 ...
};
```



---

Comment by jdemeyer created at 2018-10-04 13:01:12

The problem is that the Python header `structmember.h` file also does

```
#define T_INT       1
```


You can hope that the GAP headers won't be included after that Python header, but that seems dangerous to me especially because we cannot really control the code that Cython generates.


---

Comment by dimpase created at 2018-10-04 13:38:52

Replying to [comment:28 jdemeyer]:
> The problem is that the Python header `structmember.h` file also does
> {{{
> #define T_INT       1
> }}}
> 
> You can hope that the GAP headers won't be included after that Python header, but that seems dangerous to me especially because we cannot really control the code that Cython generates.

If GAP's headers are included after Python's, you'd get a compilation error. Indeed

```
#include <stdio.h>
#define T_INT 42
enum TNUM { T_INT, T_FOO };
int main(){
    int i;
    i = T_INT;
    printf("%d\n", i);
    return 0;}
```

and

```
$ gcc t.c 
t.c:2:15: error: expected identifier before numeric constant
 #define T_INT 42
               ^~
t.c:3:13: note: in expansion of macro ‘T_INT’
 enum TNUM { T_INT, T_FOO };
             ^~~~~
```


But if you swap the inclusion order, then yes, everything compiles, and overrides the enum. Indeed

```
#include <stdio.h>
enum TNUM { T_INT, T_FOO };
#define T_INT 42
int main(){
    int i;
    i = T_INT;
    printf("%d\n", i);
    return 0;}
```

compiles and outputs 42.

Not sure whether and how this could affect libgap...


---

Comment by jdemeyer created at 2018-10-04 13:42:04

I'd rather not make the compilation of Sage depend on a specific order of includes.


---

Comment by dimpase created at 2018-10-04 15:49:26

I'd be more concerned about Python's `#define` shadowing `T_INT`: a compilation error is much easier to deal with than a vague runtime one...

I'd also say that here Python is the bad guy, not using `enum` for its `T_*` constants.
(I'd say it should rather be using `enum`, no?)


---

Comment by jdemeyer created at 2019-01-11 14:30:05

Obsolete by #22626


---

Comment by jdemeyer created at 2019-01-11 14:30:05

Resolution: invalid
