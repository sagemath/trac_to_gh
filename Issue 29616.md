# Issue 29616: Do not go through Python for gf2e dense matrices in word_to_poly

Issue created by migration from https://trac.sagemath.org/ticket/29853

Original creator: tscrim

Original creation time: 2020-06-13 00:53:26

CC:  malb roed jhpalmieri caruso

This is called in the very low level `get_unsafe`, and there is no reason to go through the (Python) parent to get what is something ultimately done by the backend.


---

Comment by tscrim created at 2020-12-15 03:54:36

With the branch:

```
sage: K.<a> = GF(2^4)
sage: A = random_matrix(K,100,100)
sage: %timeit [A[i,j] for i in range(100) for j in range(100)]
3.82 ms ± 24.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: K.<a> = GF(2^13)
sage: A = random_matrix(K,100,100)
sage: %timeit [A[i,j] for i in range(100) for j in range(100)]
4.94 ms ± 26.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```

before:

```
5.35 ms ± 10.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^4
6.59 ms ± 27 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^13
```

Thus we are seeing a speedup of ~25% via `__getitem__`. Isolating it to a direct `get_unsafe` call:

```
sage: %%cython 
....: from sage.matrix.matrix cimport Matrix 
....: def test_unsafe(A, m, n): 
....:      return [(<Matrix> A).get_unsafe(i,j) for i in range(m) for j in range(n)] 
```

With branch:

```
sage: %timeit test_unsafe(A, 100, 100)
2.23 ms ± 52.8 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^4
3.09 ms ± 12.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^13
```

vs before:

```
3.4 ms ± 4.18 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^4
4.61 ms ± 46.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^13
```

Without the extra overhead, we see a speedup of ~35%.
----
New commits:


---

Comment by tscrim created at 2020-12-15 03:54:36

Changing keywords from "" to "gf2e, matrix".


---

Comment by tscrim created at 2020-12-15 03:54:36

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-12-17 20:29:27

triggers many failing doctests, see patchbots


---

Comment by chapoton created at 2020-12-17 20:29:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-18 05:36:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-18 05:42:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2020-12-18 05:46:49

This should fix the doctest failres. I also found some places that I could make some additional optimizations.

With the updated branch, I get additional major speed improvements:

```
673 µs ± 2.87 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)  # 2^4
1.33 ms ± 8.11 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)  # 2^13
```

So it is roughly a 3x speedup versus the previous commit.

Running with NTL:

```
4.42 ms ± 11.9 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^4
4.94 ms ± 34.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^13
```

versus vanilla with NTL:

```
8.28 ms ± 49.2 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^4
9.03 ms ± 103 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)  # 2^13
```



---

Comment by chapoton created at 2020-12-19 18:09:25

needs review ? looks good and the bot is green


---

Comment by tscrim created at 2020-12-20 23:32:43

Ah, yes, sorry. I forgot to set it back to needs review.


---

Comment by tscrim created at 2020-12-20 23:32:43

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-12-21 07:46:20

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-12-21 07:46:20

ok, let it be. Nice speedup, thanks for your work.


---

Comment by tscrim created at 2020-12-23 09:04:07

Thank you for the review.


---

Comment by vbraun created at 2020-12-27 00:23:26

Resolution: fixed
