# Issue 29674: sage.rings.integer, integer_ring: Remove dependencies on sage.libs.ntl

Issue created by migration from https://trac.sagemath.org/ticket/29911

Original creator: mkoeppe

Original creation time: 2020-06-20 04:09:41

CC:  vdelecroix chapoton alexjbest â€‹mmezzarobba @kliem @mwageringel tscrim

The two Cython modules depend on NTL in a very minor way that could be eliminated:

 - `sage.rings.integer.Integer` depends on `sage.libs.ntl` to provide method `_to_ZZ`. 

 - `sage.rings.integer_ring._coerce_ZZ` depends on `sage.libs.ntl` to provide the method `_coerce_ZZ`.

These methods are only used in `sage.libs.ntl` and in `sage.rings.number_field.number_field_element` and `rings.polynomial.polynomial_zz_pex`.


---

Comment by fbissey created at 2020-06-20 05:11:41

Hum, `sage.rings.integer.integer` and `sage.rings.integer_ring` don't link to `ntl` directly at least.

```
readelf -d /usr/lib/python3.7/site-packages/sage/rings/integer_ring.cpython-37m-x86_64-linux-gnu.so 

Dynamic section at offset 0x35ca0 contains 26 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libpython3.7m.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x7000
```

and 

```
readelf -d /usr/lib/python3.7/site-packages/sage/rings/finite_rings/element_givaro.cpython-37m-x86_64-linux-gnu.so 

Dynamic section at offset 0x4db78 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libgivaro.so.9]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython3.7m.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0xd000
```

on Gentoo compiled with `--as-needed`. Some headers may still be used though.


---

Comment by mkoeppe created at 2020-06-20 05:51:37

It's a compile time dependency. It's possible that it is all macros or inlined functions.


---

Comment by mkoeppe created at 2020-06-23 00:27:12

Would it make sense to make these two methods functions in `sage.libs.ntl.conversion`?


---

Comment by mkoeppe created at 2020-06-27 05:07:17

New commits:


---

Comment by git created at 2020-06-27 05:35:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-27 05:35:57

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-27 05:40:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-27 05:41:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-27 05:42:18

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-08 15:30:18

The dependency has been merged in 9.2.beta3. Needs review


---

Comment by @mwageringel created at 2020-07-10 19:54:48

Replying to [comment:5 mkoeppe]:
> Would it make sense to make these two methods functions in `sage.libs.ntl.conversion`?

This sounds like a good idea to me. Why do you remove the calls to `sig_on`/`sig_off`?


---

Comment by git created at 2020-07-13 00:08:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-13 00:08:34

Rebased on 9.2.beta5


---

Comment by mkoeppe created at 2020-07-13 00:14:18

Replying to [comment:16 gh-mwageringel]:
> Why do you remove the calls to `sig_on`/`sig_off`?

Good question. I am not sure against what kind of errors these calls were supposed to be guarding.


---

Comment by mkoeppe created at 2020-07-26 00:44:12

Hoping for a Cython expert to take a look...


---

Comment by git created at 2020-07-26 05:34:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-27 06:01:12

While I would not count myself as a Cython expert, my guess would be if the denominator was somehow not something that could be handled? Perhaps some kind of overflow or unable to allocate memory? I am really unsure.


---

Comment by tscrim created at 2020-08-10 22:56:08

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-08-10 22:56:08

Well, let's put this into practice as I cannot find a reason for it. Well, perhaps we should just put it into Sage to get some broader testing as it seems safe enough to me.


---

Comment by mkoeppe created at 2020-08-10 23:07:22

Thanks!


---

Comment by vbraun created at 2020-08-14 22:23:43

Resolution: fixed
