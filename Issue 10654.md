# Issue 10654: Adding a weighted_degree function to Singular multivariate polynomials

Issue created by migration from Trac.

Original creator: jsrn

Original creation time: 2011-01-30 12:50:30

Assignee: AlexGhitza

CC:  novoselt

Keywords: multivariate polynomials,degree,Singular

Multivariate polynomials over the Singular interface have several degree methods but not a weighted_degree function, often used in certain branches of discrete mathematics. This should be implemented.


---

Comment by jsrn created at 2011-01-30 12:58:33

I have implemented the best I could easily do. I am sure that by utilising Singular, one can make a much faster implementation of weighted_degree; indeed, as far as I could gather, Singular has weighted degree functionality as part of the deg()-function, but I don't have the prerequisites for writing this code.

The patch I have uploaded uses Sage methods to iterate through all monomials of the polynomial, calculating each one's weighted degree, and selects the maximal of these.


---

Comment by jsrn created at 2011-01-30 12:58:33

Changing status from new to needs_review.


---

Comment by jsrn created at 2011-02-15 14:15:22

Straight-forward all-Sage implementation (not using Singular).


---

Attachment

I just uploaded a new patch which makes it possible not to specify the weights in a tuple. That was pretty silly with the old patch, where you would have to write something like

```
  Q.weighted_degree((1, 2))
```

Now you can omit the double-parenthesis, but also use the previous calls:

```
  Q.weighted_degree(1, 2)
  Q.weighted_degree((1, 2))
  Q.weighted_degree({x:1, y:2})
```



---

Comment by mhampton created at 2011-04-28 15:34:27

In the docstring, instead of "INPUT::" it should be "INPUT:".  The double colon indicates a literal block, which isn't what you want there.  I changed this and one other instance of "INPUT::", which is in the attached cumulative patch.  I think you (jsm) can give this a positive review if it looks OK.


---

Comment by mhampton created at 2011-04-28 15:35:49

Cumulative patch with minor docstring fixes.


---

Attachment


---

Comment by malb created at 2011-04-29 13:36:05

It seems the patchbot got confused by the apply command.


---

Comment by jsrn created at 2011-05-02 07:31:44

Replying to [comment:4 mhampton]:
> In the docstring, instead of "INPUT::" it should be "INPUT:".  The double colon indicates a literal block, which isn't what you want there.  I changed this and one other instance of "INPUT::", which is in the attached cumulative patch.  I think you (jsm) can give this a positive review if it looks OK.

Ah, ok, thanks. It looks fine. If the less-than-perfect performance can be tolerated until someone more Singular-savvy comes along, is the ticket then accepted? Related to that, sage-devel never agreed to a systematic way of marking TODOs (which could be used here), right?


---

Comment by john_perry created at 2011-09-20 19:46:02

Is there a reason you convert everything to vectors & use a dot_product? Seeing the concerns about performance -- is type conversion less expensive than calling prod() or something similar? I don't know about Cython, but my impression is that in some languages it would be more efficient to assume you have an iterable & just iterate.

FWIW, this functionality is available in Sage 4.7:

```
sage: R.<x,y,z> = GF(7)[]
sage: p = x^3 + y + x*z^2
sage: p.degree()
3
sage: P = PolynomialRing(GF(7),'x,y,z',
....: order=TermOrder(matrix([1,4,2,1,1,0,1,0,0])))
sage: q = P(p)
sage: q.degree()
4
```

The relevant code is in sage/libs/singular/polynomial.pyx, where singular_polynomial_deg manually changes the ring of `p` if it isn't equal to ring it has at first.


---

Comment by davidloeffler created at 2012-03-11 14:38:11

Apply trac_10716_adding_weighted_degree_v2.patch

(for the patchbot)


---

Comment by lftabera created at 2013-02-19 23:06:00

Changing status from needs_review to needs_work.


---

Comment by lftabera created at 2013-02-19 23:06:00

You should also add the same function to MPolynomial_polydict, so it is available to more general polynomial rings.

I will take a look to see if we can easily use libsingular here.


---

Comment by lftabera created at 2013-02-20 15:42:57

Alternative patch


---

Comment by lftabera created at 2013-02-20 15:50:43

Changing status from needs_work to needs_review.


---

Attachment

I propose an alternative patch. It implements the weighted degree for all MPolynomial, not just Singular ones. It is also faster than the original patch. I think that, in general, it is better to use a polynomial ring with weighted degree if one is really interested so I have added a hint in the documentation.


---

Comment by lftabera created at 2013-02-24 18:23:29

Apply trac_10716_adding_weighted_degree_alternative.patch


---

Comment by lftabera created at 2014-05-13 14:45:16

Move my alternative patch to a git branch
----
New commits:


---

Comment by malb created at 2014-05-13 15:43:33


```python
if self.is_zero():
  #Corner case, note that the degree of zero is a python int
  return -1
```


Why not fix the bug?


```python
weigths = map(int, weights)
```


Why `int` and not `ZZ`?



```python
cdef int deg = -1
cdef int n = self.parent().ngens()
cdef int i, l
```


This is sets you up for integer overflows, why not avoid them by using `ZZ`?  The function is going to be slow in any case.

Also, doesn't Singular have an internal function which would allow to calculate this?


---

Comment by lftabera created at 2014-05-13 17:30:37

I would not say that zero.degree() == -1 is a bug, but a feature.

The use of `int`s instead of `ZZ` is just for compatibility with the current degree method. In both `MPolynomial_libsingular` and `MPolynomial_polydict` polynomials the degree returns an `int`.

This method is intended for casual computations with weighted degree or with several weighted degrees at one. If the user is going to use heavy computations with the same weight on a Singular ring, it is better to set up a ring with the appropiated weighted degree as term order. This would use Singular internal method.

I should check, but if I recall correctly, to use Singular inner function one has the change the degree of the underlying ring, which is bad. Moreover, this patch also work for `MPolynomial_polydict`, not only rings mapped to Singular.


---

Comment by malb created at 2014-05-13 17:42:47

Replying to [comment:20 lftabera]:
> I would not say that zero.degree() == -1 is a bug, but a feature.

I meant that it is returned as a Python int.

> The use of `int`s instead of `ZZ` is just for compatibility with the current degree method. In both `MPolynomial_libsingular` and `MPolynomial_polydict` polynomials the degree returns an `int`.

`MPolynomial_libsingular` can only represent a total degree `< INT_MAX`, as far as I recall. Hence, using int there is fine. However, this function accepts a weights array which may contain arbitrary integers. Hence, this function can overflow, where  `MPolynomial_libsingular.total_degree()` cannot (as far as I can tell).


---

Comment by lftabera created at 2014-05-14 13:07:20

I see your point. Should we allow negative or rational weights also?


---

Comment by malb created at 2014-05-14 14:24:33

If this question was directed at me, I never used weighted degrees, so I wouldn't know. Doesn't seem to cost much to add it, though (?)


---

Comment by git created at 2014-07-14 12:43:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by john_perry created at 2014-07-17 16:44:00

Replying to [comment:24 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[a695d7d](http://git.sagemath.org/sage.git/commit/?id=a695d7d7938e67d7ef1b615d504d73b02b8463a1)||`Use Integer instead of int to avoid overflows`||

Is "weights" supposed to be misspelled as "weigths"? Notice that this is a change from an earlier spelling.

Also, Singular doesn't accepted anything larger than 32-bit integers (confirmed w/Singular developer the other day). Will this change be practically useful?


---

Comment by git created at 2014-07-18 13:40:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lftabera created at 2014-07-18 13:43:40

Thanks for catch the typo, I had a hard time finding it! Added a test that shows it was indeed a bug.

This patch is intended for arbitrary polynomials, I am not aware non-Singular degrees that admits such large exponents, bur someone might want to create one. Even if the degree of the polynomial is smaller than 32-bit the weighted degree might be.

I have not a strong opinion on this issue and taking an int would probably be safe for most users.
----
New commits:


---

Comment by john_perry created at 2014-07-18 14:24:21

Replying to [comment:27 lftabera]:
> This patch is intended for arbitrary polynomials, I am not aware non-Singular degrees that admits such large exponents, bur someone might want to create one.

I do, actually. My current solution is to used marked polynomials instead.

> Even if the degree of the polynomial is smaller than 32-bit the weighted degree might be.

That's true, but if I recall correctly, Singular won't work even then, because it assigns a weight to every monomial. You can have a sufficiently small weighted ordering, but with large exponents it will choke.

> I have not a strong opinion on this issue and taking an int would probably be safe for most users.

My main concern is the performance penalty of converting from `Integer` to `int`. If it's just a one-time penalty (when creating a ring) then I wouldn't worry about it myself. But if it occurs with the creation of every polynomial, let alone every monomial, that could introduce a penalty for algorithms that create & manipulate polynomials. I think it's just the one-time penalty, but I don't actually know.


---

Comment by lftabera created at 2014-07-22 10:55:37

Changing status from needs_review to needs_work.


---

Comment by lftabera created at 2014-07-22 10:55:37

The conversion is the other way around, from int to Integer. You are right that there is a performance penalty. I do not have the numbers at hand right now but I will look at it and check if there is a more clever way.

The method is not cached in any way, the degree is computed any time that the method is called.

If the user want to use a ring that is mapped to singular as is worried about performance, because it will call the method a lot of times or over huge polynomials, the recommendation in the documentation is to create a ring with that term order and then just call degree inside that ring. It will be orders of magnitude faster. That is, this method is intended to use for a weighted degree different from the one in the base ring.

I have found further problems with the patch:

The patch is intended to work over every multivariate polynomial ring out there. But generic multivariate rings do not have an as_Etuple option in the exponents method. This means that the exponents are ETuples by default and I cannot use as_ETuple. This will impose a performance penalty greater than the int to Integer conversion.

The degree in generic multivariate rings do not return the weighted degree. This is a bug in my opinion. Because it makes sage non consistent. This is for another ticket.


---

Comment by git created at 2014-07-29 15:58:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lftabera created at 2014-07-29 16:06:07

Changing status from needs_work to needs_review.


---

Comment by lftabera created at 2014-07-29 16:06:07

I managed to use as_ETuples=False in any case. Concerning the performance, I have made some not serious test:

2 variables, 5 terms

- int:      2.38 µs
- Integer:  4.26 µs

5 variables, 20 terms

- int:      16 µs
- Integer:  25.8 µs

30 variables, ~80000 terms

- int: 208 ms
- Integer: 350 ms

I think it is reasonable for such a generic method.


---

Comment by john_perry created at 2014-07-29 16:21:01

Replying to [comment:31 lftabera]:
> Concerning the performance, I have made some not serious test:

A penalty factor of ~1.7: what test did you perform?


---

Comment by lftabera created at 2014-07-29 18:21:06

I created another method substitutying the Integer with int. Then used the following code. To get an idea.


```
sage: K1=QQ['x,y']
sage: K2=PolynomialRing(QQ,'a',5)
sage: K3=PolynomialRing(QQ,'b',30)
sage: f=K1.random_element()
sage: g=K2.random_element(degree=10,terms=24)
sage: h=K3.random_element(degree=100,terms=10**5) #quite long time
sage: vf=random_vector(ZZ,2)
sage: vg=random_vector(ZZ,20)
sage: vh=random_vector(ZZ,30)
sage: %timeit f.weighted_degree(vf)
sage: %timeit f.weighted_degree_int(vf)
sage: %timeit g.weighted_degree(vg)
sage: %timeit g.weighted_degree_int(vg)
sage: %timeit h.weighted_degree(vh)
sage: %timeit h.weighted_degree(vh)
```


I do not have a strong opinion. Integer does not overflow, but int is faster (but also slow) and behaves like degree method (also returns int).


---

Comment by john_perry created at 2014-07-29 18:44:49

Replying to [comment:33 lftabera]:
> I created another method substitutying the Integer with int. Then used the following code. To get an idea.

Can you test addition & multiplication of polynomials? That's the one that concerns me. It probably won't matter, but...


---

Comment by lftabera created at 2014-07-29 18:54:44

Do you mean comparing the cost of weighted_degree with addition/multiplication? That depends *a lot* on the underlying ring. Do you have a specific ring in mind?

This patch will have absolutely not impact on addition and mult. I expect that addition can be in fact faster that weighted degree for "nice" rings and multiplication will be much slower.


---

Comment by john_perry created at 2014-07-29 19:01:46

Replying to [comment:35 lftabera]:
> Do you mean comparing the cost of weighted_degree with addition/multiplication?

I mean comparing the cost of, say, addition in a ring with Integer weighted orders vs. addition in a ring with int weighted orders. Use the same polynomials in the same base field. Then try with multiplication.

I have no particular ring in mind; I'm curious about all the "usual" rings: QQ[*x*], *F*<sub>_p_</sub>[*x*], etc.

> I expect that addition can be in fact faster that weighted degree for "nice" rings and multiplication will be much slower.

Why?


---

Comment by lftabera created at 2014-07-29 19:29:02

This patch will have no effect on that. There are no rings with int weighted order or Integer weighted order.

When you create a multivariate polynomial ring, you select a TermOrder, with degrevlex as default.

However, in some cases, a user may want to compute the degree of a polynomial with a weighted term order that is *different* from the term order of the underlying ring. In this, and only in this case the weighted_degree method will play a role. In `QQ['x,y']` and `GF(p)['x,y']` singular will be used, so for usual operations of addition and multiplication will use the singular implementation of term orders. This patch will not change that.


```
sage: K=PolynomialRing(QQ, 'a,b,c', order=TermOrder('wdeglex',(7,8,9)))
sage: a,b,c=K.gens()
sage: f = a+b**3+c**4
sage: f.degree() # uses the weights of K, it is singular who compute this.
36
sage: f.weighted_degree([7,8,9]) #My patch, not computed using singular.
36
sage: f.weighted_degree([1,3,-3]) #My patch, not computed using singular.
9
sage: #The term order of the underlying ring does not change.
sage: f.parent().term_order()
Weighted degree lexicographic term order with weights (7, 8, 9)
```



---

Comment by john_perry created at 2014-07-29 19:36:44

Replying to [comment:37 lftabera]:
> However, in some cases, a user may want to compute the degree of a polynomial with a weighted term order that is *different* from the term order of the underlying ring.

Right. I get that. I didn't realize how `weighted_degree` was being used. I get that now.

I'll like to review this, but I haven't taken the time to work out the new development system. I'll try to figure out git & give this a careful review within the next few days. If nothing happens by next week, remind me.


---

Comment by lftabera created at 2014-07-29 20:02:37

Thanks!


---

Comment by john_perry created at 2014-08-26 16:12:10

Sorry it took so long; no one reminded me. ;-)

I've tested it, & everything seems to be in order. I just need to look over the source code.

So, now that we're on this new-fangled git system, *How do I see the actual diff?* The attachments don't show the most recent changes. When I click on the branch, it shows 1593 lines removed from `src/sage/rings/polynomial/multi_polynomial.pyx`, and 29 changes to `src/sage/rings/polynomial/multi_polynomial_element.py`. None of them involves `weighted_degree()`, & in fact the things removed from the first file look frightening. I'm guessing that branch has changed? But when I look at the source code in sage (`f.weighted_degree()??`) it looks fine.


---

Comment by novoselt created at 2014-08-26 16:22:15

If you click on commits, they look more sensible. Perhaps you need to merge this branch with the current devel to make things look better? Or, when everything else fails, you have to ask Volker ;-)


---

Comment by john_perry created at 2014-08-26 16:36:05

Replying to [comment:42 novoselt]:
> If you click on commits, they look more sensible.

Not at first, but eventually :-) After that, the highlighted box is very appealing to click on, but doesn't give information. You have to click on _completely plain text_ to get a diff.

But even that isn't right. The diff I get is a diff from previous work on this ticket, not from pre-ticket source. Is it possible to see the cumulative result of all the changes, just as we used to recommend on simpler tickets that someone combine all the tickets into one?

> Perhaps you need to merge this branch with the current devel to make things look better?

I don't even know what that means. :-( I just did a sage -dev checkout --ticket 10716.


---

Comment by novoselt created at 2014-08-26 16:42:47

If you do something like

```
git merge develop
git trac push
```

the branch should be based on current develop rather than 6.2. However, clicking on the branch on tickets should show precisely what will be changed after merging this ticket and develop. Perhaps that file was completely removed in another ticket?.. But then there should be conflicts and the branch should not apply, I think. So it may really make sense to inquire on sage-devel what's going on here.


---

Comment by john_perry created at 2014-08-26 16:47:17

Replying to [comment:44 novoselt]:
> If you do something like
> {{{
> git merge develop
> }}}

Hmm, now _git_ doesn't know what that means.

```
sage$ git merge develop
merge: develop - not something we can merge

Did you mean this?
	origin/develop
```


> However, clicking on the branch on tickets should show precisely what will be changed after merging this ticket and develop.

For some reason, the links to both branch and commits disappear after I reload this webpage. I'll try posting & looking at this again.


---

Comment by novoselt created at 2014-08-26 16:51:48

Links disappear if you start editing the ticket, that's to be expected! And if you don't have your own checked out develop branch, then yes, you want to merge with origin/develop.


---

Comment by john_perry created at 2014-08-26 17:13:16

Replying to [comment:46 novoselt]:
> Links disappear if you start editing the ticket, that's to be expected!

_I_ don't see why they should disappear if I'm merely writing comments.

> And if you don't have your own checked out develop branch, then yes, you want to merge with origin/develop.

OK, now `git trac push` wants git`@`trac.sagemath.org's password.


---

Comment by john_perry created at 2014-08-26 17:16:04

So far I'm tracing through the four commits. It looks OK, but I'd prefer if this could be rewritten so that there's only one commit to study; it's not a very difficult change to make, as there isn't very much code. So, I'm changing the status to `Needs work.` If someone else wants to referee this ticket & disagrees, I'm not wedded to it, but if I can't see the entire set of changes, I'm reluctant to say, "it's OK." & this has been done to me once or twice before, so I don't feel I'm asking anything unusual :-)


---

Comment by john_perry created at 2014-08-26 17:16:14

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2014-08-26 17:18:15

I am not saying it makes sense, rather that's just how it works ;-) Perhaps because when you are editing a ticket, you may change the branch as well and it is difficult to see what exactly you are doing.

Anyway, for password setup: [http://sagemath.org/doc/developer/git_trac.html#git-and-trac-configuration](http://sagemath.org/doc/developer/git_trac.html#git-and-trac-configuration)


---

Comment by novoselt created at 2014-08-26 17:20:22

With git there is no reason to clamp commits together, since it is possible to see "the cumulative effect". And usually this is exactly what happens when you click on the branch name on the ticket page, I am not sure what's going on here.


---

Comment by john_perry created at 2014-08-26 17:50:04

Replying to [comment:50 novoselt]:
> Anyway, for password setup: [http://sagemath.org/doc/developer/git_trac.html#git-and-trac-configuration](http://sagemath.org/doc/developer/git_trac.html#git-and-trac-configuration)

I have already done that, substituting my information for USERNAME and PASSWORD. It seems to think I have a different username for some reason (i.e., 'git' instead of 'john_perry').


---

Comment by john_perry created at 2014-08-26 17:53:00

Oh, no, I haven't. There's more that I hadn't read. Okay, hold on.


---

Comment by john_perry created at 2014-08-26 18:07:52

OK, I can now see the entire set of changes in one go (yay!) although I'm troubled by the branch being changed. I'm changing the status back to `Needs review` for the time being.

1. Is that a problem?
1. Should I worry about doctests that have no obvious relation to this ticket? I'm getting failures in doctests like `f.resultant(g) == fh.macaulay_resultant(gh)`. I'm thinking those are caused by other tickets that have been worked into this branch for some mysterious reason (i.e., all those deleted lines I was seeing earlier).
----
New commits:


---

Comment by john_perry created at 2014-08-26 18:07:52

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2014-08-26 18:23:07

Changing branch is perfectly fine - prior commits are still recorded as done by the original author, only the merge one is marked as yours. But all tests should certainly pass, unless it is a known failure of the current beta release (check out sage-release, I guess).


---

Comment by john_perry created at 2014-08-26 18:34:04

When I switch to the master branch (which doesn't have this ticket, or shouldn't) & rebuild, I get a huge number of changes; a lot of "Cythonizing", basically. Is that supposed to happen?


---

Comment by novoselt created at 2014-08-26 18:37:16

Yes, since master is 6.3 and the ticket is now based on latest beta. Given that packages may change between betas, it is generally better not to switch between them. And if you do, you should run make, not just sage -b.


---

Comment by john_perry created at 2014-08-26 18:41:23

Replying to [comment:58 novoselt]:
> Yes, since master is 6.3 and the ticket is now based on latest beta. Given that packages may change between betas, it is generally better not to switch between them. And if you do, you should run make, not just sage -b.

Great, so not only am I waiting a long time to rebuild (contra "This should be quite fast" on the developer guide), I'm looking at the wrong thing. Alright, once it's ready, I'll move to sage-release.

Is there a faster way to do this? In the old system, I downloaded the ticket, checked it, gave it a positive review, done. Now it seems the entire system has to rebuild for just a few lines of code. Surely I'm doing something wrong.


---

Comment by novoselt created at 2014-08-26 19:03:25

There were some discussions about speeding up on sage-devel, but basically for fast work you want to keep building up-to-date develop branch and when you check out a ticket - merge your current develop into it before sage -b. If the merge was automatic and you don't want to make any changes - don't push the updated branch to track. If the merge required conflict resolution or you want to make changes - do changes on top of the merged branch and then push it to trac. This may be written in the current guide, but may be not.


---

Comment by john_perry created at 2014-08-26 19:19:58

Replying to [comment:60 novoselt]:
> ...basically for fast work you want to keep building up-to-date develop branch and when you check out a ticket - merge your current develop into it before sage -b.

Fast for whom? In the old system, I'd either have given this a positive review, or have confirmed within a matter of minutes (at most) that the doctest failures were due to this ticket, & marked it `Needs work`. Simple, fast, efficient.

In the new system, *I'm still waiting for sage to finish building, half an hour after invoking `sage -br`.* I'm pretty sure I'll be waiting at least that much longer -- yet in order to verify the cause of the failing doctests, I still have to checkout `sage-release` and go through that.

Was I supposed to checkout sage-release before checking out the ticket? Am I supposed to do that before every ticket I referee? I don't see how this is an improvement. That's why I say, "Surely I'm doing something wrong."

(Sorry for the completely unrelated & probably pointless noise in a ticket, by the way -- I'm just frustrated at having nothing productive to do while I wait.)


---

Comment by john_perry created at 2014-08-26 21:01:59

I have tested Sage 4.beta1. These doctests do not fail. I'm trying to figure out what's going on.


---

Comment by john_perry created at 2014-08-26 21:10:18

*Great news.* Using the hint from `sage-devel` listed below [1], I was able to checkout the ticket on top of development branch 6.4.beta1, build _very quickly_, then test those files. They work.

I'm now rebuilding the documentation, to make sure it's okay, too. Once that's done, we'll have a positive review. :-)

[1] https://groups.google.com/d/msg/sage-devel/5d9NfgZJDmw/06R3bFOkeYIJ


---

Comment by john_perry created at 2014-08-26 22:07:10

Changing status from needs_review to positive_review.


---

Comment by john_perry created at 2014-08-26 22:07:10

PDF docs build. HTML docs do not, but HTML docs do not build even without this patch. POSITIVE REVIEW.


---

Comment by novoselt created at 2014-08-26 23:24:23

I imagine "Reviewers" field has to be changed ;-)


---

Comment by john_perry created at 2014-08-27 00:10:55

And there I was, hoping someone else would get the blame for my shoddy work.


---

Comment by vbraun created at 2014-08-27 17:58:06

Resolution: fixed
