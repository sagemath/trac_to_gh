# Issue 31340: Move SAGE_ROOT/build/pkgs/{sagelib,sage_conf,sage_sws2rst,sage_docbuild}/src to SAGE_ROOT/src/pkgs/...

Issue created by migration from https://trac.sagemath.org/ticket/31577

Original creator: mkoeppe

Original creation time: 2021-03-29 04:50:47

CC:  jhpalmieri dimpase fbissey

In the current layout, these embedded source trees are a little difficult to find.

The proposed location is:

```
SAGE_ROOT
 - src
   - pkgs
     - sage_conf
     - sage_docbuild
     - sage_sws2rst
     - sagemath_standard
```



---

Comment by mkoeppe created at 2021-03-29 15:33:28

Alternatively, these directories could just be put into SAGE_ROOT:

```
SAGE_ROOT
 - sage_conf
 - sage_docbuild
 - sage_sws2rst
 - sagemath_standard
```



---

Comment by mkoeppe created at 2021-03-30 23:07:59

(made this change in the ticket description)


---

Comment by mkoeppe created at 2021-04-12 04:39:42

Last 10 new commits:


---

Comment by mkoeppe created at 2021-04-12 04:39:42

Changing status from new to needs_review.


---

Comment by git created at 2021-04-12 04:48:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-04-12 04:54:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-12 05:47:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-04-12 18:33:57


```
sage_docbuild   -> symlinks to SAGE_ROOT/src/sage_docbuild
```

Would it make sense to reverse this: put the files in `SAGE_ROOT/sage_docbuild` and then make `SAGE_ROOT/src/sage_docbuild` into a link? Is there any reason to keep `SAGE_ROOT/src/sage_docbuild`? If so, why also create the top-level directory?

What about `SAGE_ROOT/src/sage_setup`, along the same lines?


---

Comment by mkoeppe created at 2021-04-12 18:50:35

This is a great question.

There is no technical reason for keeping `SAGE_ROOT/src/sage_docbuild` at all.
Likewise, after #29847, there will be no technical reason for keeping `SAGE_ROOT/src/sage_setup`.

But in #29705, I promised not to change the structure of the source tree, which I interpret as keeping the monolithic tree `SAGE_ROOT/src` unchanged.  It is so that we don't overwhelm the developer community by making too many changes at the same time. 

Of course, it could be argued that `sage_docbuild` is a new name anyway, and very few people will know or care about this package.

So if you think that's better, I can just move the `sage_docbuild` sources to `SAGE_ROOT/sage_docbuild/sage_docbuild` on this ticket.

(I'd rather not put reverse symlinks.)


---

Comment by git created at 2021-04-12 19:11:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-12 19:16:59

I will make another change, renaming the top-level directories from using underscores to using dashes. This will emphasize that these are the names of distribution packages (PyPI normalizes to dashes).


---

Comment by mkoeppe created at 2021-04-12 19:19:03

(This change is making the kludge that I had to add to the top-level Makefile unnecessary. The command for building `make sage_conf`, will no longer be fooled by the existence of a top-level directory of that name.)


---

Comment by git created at 2021-04-12 19:26:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-12 19:42:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-12 19:52:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-12 23:28:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-04-13 00:58:17

`make ptestlong` fails to run any doctests because of this error:

```
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting entire Sage library.
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/src/bin/sage-runtests", line 144, in <module>
    err = DC.run()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1204, in run
    self.expand_files_into_sources()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/local/lib/python3.9/site-packages/sage/doctest/control.py", line 788, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/local/lib/python3.9/site-packages/sage/doctest/control.py", line 788, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc2/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 528, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
make: *** [ptestlong] Error 1
```

I believe the problem is that it trying to doctest `src/sage_docbuild`.


---

Comment by mkoeppe created at 2021-04-13 01:08:13

OK, I guess I have to retract my claim that there is no technical reason for having `src/sage_docbuild`. In part that's #31352 though


---

Comment by jhpalmieri created at 2021-04-13 01:10:04

I'm currently testing this change:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index afb0d6cbcf..45ec2263fb 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -695,7 +695,7 @@ class DocTestController(SageObject):
             # don't make sense to run outside a build environment
             if have_git:
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
-                self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
+                self.files.append(opj(SAGE_ROOT, 'sage-docbuild'))
             self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
```



---

Comment by mkoeppe created at 2021-04-13 01:11:28

I think I'd rather undo the change in 12df870 and keep it for another ticket.

I think it's better to keep everything that is subject to Sage doctesting in one physical tree


---

Comment by mkoeppe created at 2021-04-13 01:12:56

(Modularization of doctesting is a separate issue.)


---

Comment by fbissey created at 2021-04-13 01:16:23

Replying to [comment:30 jhpalmieri]:
> I'm currently testing this change:
> {{{
> #!diff
> diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
> index afb0d6cbcf..45ec2263fb 100644
> --- a/src/sage/doctest/control.py
> +++ b/src/sage/doctest/control.py
> `@``@` -695,7 +695,7 `@``@` class DocTestController(SageObject):
>              # don't make sense to run outside a build environment
>              if have_git:
>                  self.files.append(opj(SAGE_SRC, 'sage_setup'))
> -                self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
> +                self.files.append(opj(SAGE_ROOT, 'sage-docbuild'))
>              self.files.append(SAGE_DOC_SRC)
>  
>          if self.options.all or (self.options.new and not have_git):
> }}}

I really don't like that kind of changes. In sage-on-distro `SAGE_SRC` becomes `SAGE_LIB` at runtime when `SAGE_ROOT` is undefined. That would break things there. Not to mention I am against introducing more `SAGE_ROOT` outside of the build system as a matter of principle. As Matthias says modularization of doctesting is a separate issue and that's what would be most appropriate there.


---

Comment by jhpalmieri created at 2021-04-13 01:27:02

Replying to [comment:33 fbissey]:
> Replying to [comment:30 jhpalmieri]:
> > I'm currently testing this change:
> > {{{
> > #!diff
> > diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
> > index afb0d6cbcf..45ec2263fb 100644
> > --- a/src/sage/doctest/control.py
> > +++ b/src/sage/doctest/control.py
> > `@``@` -695,7 +695,7 `@``@` class DocTestController(SageObject):
> >              # don't make sense to run outside a build environment
> >              if have_git:
> >                  self.files.append(opj(SAGE_SRC, 'sage_setup'))
> > -                self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
> > +                self.files.append(opj(SAGE_ROOT, 'sage-docbuild'))
> >              self.files.append(SAGE_DOC_SRC)
> >  
> >          if self.options.all or (self.options.new and not have_git):
> > }}}
> 
> I really don't like that kind of changes. In sage-on-distro `SAGE_SRC` becomes `SAGE_LIB` at runtime when `SAGE_ROOT` is undefined. That would break things there. Not to mention I am against introducing more `SAGE_ROOT` outside of the build system as a matter of principle. As Matthias says modularization of doctesting is a separate issue and that's what would be most appropriate there.

I think that on distros, `have_git` will be false (it tests whether `SAGE_ROOT/.git` exists), so this block, and the resulting doctests, will be skipped entirely.


---

Comment by git created at 2021-04-13 01:28:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2021-04-13 01:29:01

You are right, it will skipped. Although technically they could be run if present.


---

Comment by mkoeppe created at 2021-04-13 01:29:56

Nevertheless I have removed that change. Too complicated for 1 ticket.


---

Comment by jhpalmieri created at 2021-04-13 01:36:00

Replying to [comment:36 fbissey]:
> You are right, it will skipped. Although technically they could be run if present.

One of the goals of that particular method is to exclude files if in a distro. I don't know enough about distros to know if the method is well-implemented, though. (I didn't write it.)

Some related questions about this ticket: how does this new organization affect distros, and should we be doctesting any of the pieces that are being moved to `SAGE_ROOT`?


---

Comment by mkoeppe created at 2021-04-13 01:42:58

Replying to [comment:39 jhpalmieri]:
> should we be doctesting any of the pieces that are being moved to `SAGE_ROOT`?

`sage-sws2rst` has its own simple test script, not related to the Sage doctester.

The other packages do not have separate tests but are doctested as part of the Sage.
The assumption is here that the doctester is run after all of these packages are installed. This assumption would continue to hold even as the modularization goes forward. I don't really have a plan for modularizing the doctesting, other than #30778.


---

Comment by mkoeppe created at 2021-04-13 01:45:08

Replying to [comment:39 jhpalmieri]:
> how does this new organization affect distros

I would hope, not at all. All paths that were valid before are still valid afterwards thanks to the symlinks `build/pkgs/SOME_SPKG/src -> /SOME-SPKG`


---

Comment by fbissey created at 2021-04-13 02:09:50

Replying to [comment:41 mkoeppe]:
> Replying to [comment:39 jhpalmieri]:
> > how does this new organization affect distros
> 
> I would hope, not at all. All paths that were valid before are still valid afterwards thanks to the symlinks `build/pkgs/SOME_SPKG/src -> /SOME-SPKG`

As far as I am concerned, anything living under `build/pkgs/` should have a separate tarball and be installed as a separate package. This has been somewhat challenged by the way Matthias is conducting the modularization. But that's the goal at the end of the day. If it is there it is not supposed to be anything special anymore. 

That being said `sage_conf` is being a pain because it is still very special as far as I can see. It still need a real SAGE_ROOT tree. But that is a different conversation and ticket.


---

Comment by mkoeppe created at 2021-04-13 02:16:44

That's right, after this ticket, `SAGE_ROOT/sage-docbuild`, `SAGE_ROOT/sage-sws2rst`, `SAGE_ROOT/sagemath-standard`, and `SAGE_ROOT/sage-conf` are standard source trees of Python distribution packages, containing nothing that is specific to Sage-the-distribution. 

It is possible to build sdists from each of these source trees using `setup.py sdist`, and wheels using `setup.py bdist_wheel`. 

Actually also `sage-conf` has the same status: You can build an sdist or a wheel from it. However, this version of `sage-conf` is not useful for putting it on PyPI. #29039 and #31396 create separate versions of `sage-conf` that are suitable for distribution.


---

Comment by fbissey created at 2021-04-13 02:23:10

Replying to [comment:46 mkoeppe]:
> Actually also `sage-conf` has the same status: You can build an sdist or a wheel from it. However, this version of `sage-conf` is not useful for putting it on PyPI. #29039 and #31396 create separate versions of `sage-conf` that are suitable for distribution.
> 

That's right, I had to remove a lot of stuff from the PyPI version before I could make it do the bits that would be useful to me properly as someone who build stuff from source. Considering the amount of stuff I just want to throw out, it is almost a different package altogether.


---

Comment by mkoeppe created at 2021-04-13 02:27:55

Yes, downstream packaging is encouraged to write a separate `sage_conf` for their purposes.


---

Comment by fbissey created at 2021-04-13 02:32:43

Replying to [comment:48 mkoeppe]:
> Yes, downstream packaging is encouraged to write a separate `sage_conf` for their purposes.

Beurk. Anyway, we should have another meeting may be the next sage-days. I think there are things we should do to the design of "those" configuration files at large, and that could make it easier for distros in the process. I need to figure if what I think of who be easily doable python side. And it is definitely a separate conversation from this ticket.


---

Comment by mkoeppe created at 2021-04-13 02:36:20

It's really very easy: 
- You want to run our `configure` -> use one of our files which comes from configure.
- You don't want to run `configure` -> write your `sage_conf.py` in which you hardcode your stuff.


---

Comment by fbissey created at 2021-04-13 02:46:35

Replying to [comment:50 mkoeppe]:
> It's really very easy: 
> - You don't want to run `configure` -> write your `sage_conf.py` in which you hardcode your stuff.

This is probably the best solution and it is also incredibly dirty once you get QA and multi-python support involved. In short this is cheap and easy if your packaging is somewhat ad hoc. Once you want this to go inside a framework with rules, there is a higher price than you may expect. 

But we are getting incredibly off-topic and should stop polluting this ticket.


---

Comment by mkoeppe created at 2021-04-13 02:50:07

Yes, let's continue with this at another time and on another ticket.


---

Comment by jhpalmieri created at 2021-04-13 05:39:58


```
% ./sage -t src/sage/misc/package.py 
Running doctests with ID 2021-04-12-22-39-35-af3c76ef.
Git branch: t/31577/move_sage_root_build_pkgs___src_to_sage_root____rename_sage_root_build_to_sage_root_sage_bootstrap
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 125.4 --random-seed=0 src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 336, in sage.misc.package.installed_packages
Failed example:
    installed_packages()['sage_conf']  # optional - build
Expected:
    'none'
Got:
    '9.3.rc3'
**********************************************************************
1 item had failures:
   1 of   4 in sage.misc.package.installed_packages
    [50 tests, 1 failure, 2.86 s]
----------------------------------------------------------------------
sage -t --warn-long 125.4 --random-seed=0 src/sage/misc/package.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by git created at 2021-04-13 05:44:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-13 05:44:40

Thanks for testing!


---

Comment by git created at 2021-04-13 16:41:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-04-14 05:36:28

What are the files `Pipfile`, `Pipfile.m4`, etc. for? I just build Sage, and for example, `sagemath-standard/Pipfile` is currently a link pointing to a nonexistent target, and the same for `sagemath-standard/Pipfile-dist`.


---

Comment by mkoeppe created at 2021-04-14 05:39:55

If you run `./bootstrap`, the targets of these symlinks should be generated.

These files were introduced in #30913. They are not used in a normal build. They are for users who want to use https://pypi.org/project/pipenv/ to set up a virtual environment.


---

Comment by jhpalmieri created at 2021-04-15 00:20:56

I might prefer this in place of, or in addition to, the fixed `installed_packages()` doctest:

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index e402293baf..f9a3f9fc9e 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -335,6 +335,8 @@ def installed_packages(exclude_pip=True):
         '0.7.12'
         sage: installed_packages()['sage_conf']  # optional - build, random
         '9.3'
+        sage: installed_packages()['sage_conf'] == sage.env.SAGE_VERSION # optional - build
+        True
 
     .. SEEALSO::
 
```



---

Comment by mkoeppe created at 2021-04-15 00:23:02

That's a good idea


---

Comment by git created at 2021-04-15 00:27:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-15 00:31:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-15 01:33:57

Unfortunately I have a bit of trouble to make this layout work well with the tox-docker build.

How about pushing the new directories down one level, to something like `SAGE_ROOT/pkgs/sage-conf` etc.?


---

Comment by jhpalmieri created at 2021-04-15 02:52:50

Should the Sage source be in the same place? Or rather, should everything be in `src`? I don't know if there is any standard way to do this or any particular logic behind it.


---

Comment by mkoeppe created at 2021-04-15 03:10:34

I don't think there is a standard for this.

I initially had made it `SAGE_ROOT/src/pkgs/sage-conf` but I think it would be cleaner if `src` only contained the monolithic Sage library.


---

Comment by jhpalmieri created at 2021-04-15 04:07:51

Then sure, `SAGE_ROOT/pkgs/sage-conf` sounds good.


---

Comment by mkoeppe created at 2021-04-22 16:06:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-24 23:20:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-25 00:03:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 00:14:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 00:29:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-25 00:39:46

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-25 01:48:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-25 19:40:45

Looks good.


---

Comment by dimpase created at 2021-06-25 19:40:45

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-25 19:44:40

Thanks!


---

Comment by vbraun created at 2021-06-29 17:56:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-29 17:56:17

Merge conflict


---

Comment by mkoeppe created at 2021-06-29 21:42:44

Merges cleanly with af326a8c9a (vbraun/develop)


---

Comment by mkoeppe created at 2021-06-29 21:42:44

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-06-29 23:10:43

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-29 23:10:43

then wait for the next beta


---

Comment by git created at 2021-07-01 22:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-01 22:05:34

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-07-06 21:50:00

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-07-06 21:50:00

whats going on here?

```
    STDOUT: CONFLICT (directory/file): There is a directory with name build/pkgs/sagelib/src in HEAD. Adding build/pkgs/sagelib/src as build/pkgs/sagelib/src~7568dc6dc7a2325525aaa4618ec1bc0bc417917b
    STDOUT: Removing build/pkgs/sage_sws2rst/src/sage_sws2rst/__init__.py
    STDOUT: Adding build/pkgs/sage_sws2rst/src
    STDOUT: Removing build/pkgs/sage_docbuild/src/sage_docbuild
    STDOUT: Removing build/pkgs/sage_docbuild/src/VERSION.txt
    STDOUT: CONFLICT (directory/file): There is a directory with name build/pkgs/sage_docbuild/src in HEAD. Adding build/pkgs/sage_docbuild/src as build/pkgs/sage_docbuild/src~7568dc6dc7a2325525aaa4618ec1bc0bc417917b
    STDOUT: Removing build/pkgs/sage_conf/src/bin/sage-env-config
    STDOUT: Removing build/pkgs/sage_conf/src/README.rst
    STDOUT: CONFLICT (directory/file): There is a directory with name build/pkgs/sage_conf/src in HEAD. Adding build/pkgs/sage_conf/src as build/pkgs/sage_conf/src~7568dc6dc7a2325525aaa4618ec1bc0bc417917b
    STDOUT: Auto-merging build/bin/write-dockerfile.sh
    STDOUT: Automatic merge failed; fix conflicts and then commit the result.
[release@zen Sage]$ git --version
git version 2.31.1
```



---

Comment by vbraun created at 2021-07-06 21:51:39

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-07-06 21:51:39

ok those were previously not-checked in build artifacts


---

Comment by vbraun created at 2021-07-09 20:23:50

Resolution: fixed
