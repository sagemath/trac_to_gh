# Issue 11387: Speed up Posets and toric Chow group

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2011-06-30 20:38:15

Assignee: AlexGhitza

CC:  sage-combinat

To my surprise, computing the Chow group spends most of the time comparing cones instead of doing linear algebra. 3/4 of the time is spent in `PosetElement.__eq__()`:

```
   return self.parent() == other.parent() \
          and self.element == other.element \
          and self.vertex == other.vertex
```

Reordering this to first compare `self.vertex == other.vertex` speeds it up dramatically.

Patch has some other fixes. Changes the chow group to use sparse matrices.


---

Comment by vbraun created at 2011-06-30 20:52:52

Updated patch


---

Attachment

Can you clarify why `hermit_form` was replaced with `echelon_form`?

Also I don't like the very last change with forceful passing of `check=False` to the parent constructor. I think the correct way is to always pass whatever was received from the user and if it leads to a slowdown somewhere, then in that somewhere one should use `check=False`.


---

Comment by rbeezer created at 2011-07-01 04:04:35

I took a look at this earlier, so I'll add my 2 cents worth.

`hermite_form` is a straight replacement for `echelon_form`.  Now that we have a `rref` command to obtain results over fields, I personally think it would be nice if "hermite form" went away, I think it confuses too many non-specialists.

I was going to vouch for the posets and linear algebra, but I don't know the Chow group stuff, so it is good that Andrey is on this one.

Rob


---

Comment by vbraun created at 2011-07-01 08:41:26

`hermite_form` is an alias for `echelon_form` for dense ZZ-matrices. Sparse ZZ-matrices currently don't have a `hermite_form` method, though I'll add that back in #11558.

I'm passing `check=False` to the element constructor because the input for the base constructor is computed. Usually when you extend some element class, you pass user-specified arguments through to the base constructor and its necessary to check their validity. Though I didn't see it taking much time when benchmarking, so if you insist I'll be happy to take it out again.


---

Comment by vbraun created at 2011-07-01 09:49:39

Changing status from new to needs_review.


---

Comment by hivert created at 2011-07-02 10:51:14

Remove assignee AlexGhitza.


---

Comment by hivert created at 2011-07-02 10:51:14

What kind of parents are you using. Normally they should be unique so that
parent comparisons should be done with is and thus instantaneous. Moreover, I
don't think your solution is correct because in some case you will end up
comparing things where eq will simply break. I'll try to cook an example.

Florent


---

Comment by hivert created at 2011-07-02 10:56:24

I should also mention that before touching anything in posets you should test you code with #10998 applied. There where a major rewrite in posets with a lot of speedups and cleanups.

Florent


---

Comment by vbraun created at 2011-07-02 11:17:54

I agree that parents should be unique. The original code compared parents with `==` and I didn't change it.

My point is that the `PosetElement.element` comparison is potentially slow. In fact, I don't understand why `PosetElement.__eq__` compares both `vertex` and `element`, I am under the impression that there is a bijection between vertices and elements. 

The reordering does break comparison between `PosetElement`s and other classes, though I'm not sure if we care. The patch does conflict with #10998, so that one needs to be reviewed first.


---

Comment by slabbe created at 2012-01-26 22:19:53

Same lines are edited by #12351. One will have to adapt to the other one.


---

Comment by novoselt created at 2012-02-15 22:31:12

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2012-02-15 22:31:12

Does not apply on Sage-5.0.beta4!


---

Comment by nthiery created at 2012-02-16 10:08:08

Replying to [comment:10 novoselt]:
> Does not apply on Sage-5.0.beta4!

If it's the hunk in the poset code that fails, that's normal. #10998 already integrates this change (in fact a slightly better one).


---

Comment by novoselt created at 2012-05-25 00:07:14

Hey Volker,

Changing posets to compare again vertices first still shaves off a second on testing Chow group module - do you have an example where it used to be crucial? In any case if you are fine with my rebasing let's merge it!


---

Comment by novoselt created at 2012-05-25 00:07:14

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2012-05-27 20:22:47

Changing keywords from "" to "toric, sd40.5".


---

Attachment

Rebased for Sage-5.1.beta0


---

Comment by novoselt created at 2012-05-28 02:20:13

Now works fine after file move.


---

Attachment


---

Comment by chapoton created at 2013-07-22 14:32:47

for the bot:

apply trac_11559_fix_Chow_group.2.patch trac_11559_hasattr_vertex_fc.patch

If you do not want to check the parent first, you need to make sure that other has the attribute "vertex" !

This ticket needs benchmarking, to see if something significant is still gained in term of time or not.


---

Attachment

here a patch correcting the failing doctests

Apply trac_11559_fix_Chow_group.2.patch trac_11559_fixdoctest.patch trac_11559_hasattr_vertex_fc.patch


---

Comment by nthiery created at 2013-11-04 20:18:32

I just noticed this ticket. Has someone tried using have_same_parent(self, other) ?


---

Comment by chapoton created at 2014-02-21 13:17:02

here is a git branch
----
New commits:


---

Comment by pbruin created at 2014-05-07 14:07:15

From the patchbot report:

```
File "src/sage/geometry/fan.py", line 158, in sage.geometry.fan
Failed example:
    sorted(L.hasse_diagram().neighbors(cone))
Expected:
    [1-d cone of Rational polyhedral fan in 3-d lattice M,
     1-d cone of Rational polyhedral fan in 3-d lattice M,
     3-d cone of Rational polyhedral fan in 3-d lattice M,
     3-d cone of Rational polyhedral fan in 3-d lattice M]
Got:
    [1-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 1-d cone of Rational polyhedral fan in 3-d lattice M]
```



---

Comment by pbruin created at 2014-05-07 14:07:15

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-07-09 20:11:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-07-09 20:12:10

Changing status from needs_work to needs_review.


---

Comment by jkeitel created at 2014-07-09 21:48:56

Changing status from needs_review to positive_review.


---

Comment by jkeitel created at 2014-07-09 21:48:56

Hi, the patch looks good to me and seems to make sensible changes. However, I can't tell whether the patch is actually bringing any speed benefits. Volker, Andrey, what exactly is it that should be benchmarked?
----
New commits:


---

Comment by jkeitel created at 2014-07-09 21:49:18

Changing status from positive_review to needs_review.


---

Comment by chapoton created at 2015-03-25 19:28:55

This ticket seems to confuse the patchbot. But maybe any ticket would..


---

Comment by chapoton created at 2015-03-25 19:31:47

Put to need info just to stop the bots loop-testing this ticket.


---

Comment by chapoton created at 2015-03-25 19:31:47

Changing status from needs_review to needs_info.


---

Comment by novoselt created at 2015-03-25 22:25:42

Related or not - when I click on the branch name to see the differences, it shows the intent to DELETE TWO MODULES completely!!! I do not see commits that attempt to do it, however.


---

Comment by chapoton created at 2015-05-05 18:19:33

New commits:


---

Comment by pbruin created at 2015-06-04 11:40:32

Changing status from needs_info to needs_work.


---

Comment by pbruin created at 2015-06-04 11:40:32

Some patchbots are still testing this ticket, but there are various doctest failures; setting this back to "needs_work".


---

Comment by git created at 2017-09-14 12:02:53

Branch pushed to git repo; I updated commit sha1. New commits:
