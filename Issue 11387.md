# Issue 11387: Speed up Posets and toric Chow group

archive/issues_011387.json:
```json
{
    "body": "Assignee: AlexGhitza\n\nCC:  sage-combinat\n\nTo my surprise, computing the Chow group spends most of the time comparing cones instead of doing linear algebra. 3/4 of the time is spent in `PosetElement.__eq__()`:\n\n```\n   return self.parent() == other.parent() \\\n          and self.element == other.element \\\n          and self.vertex == other.vertex\n```\n\nReordering this to first compare `self.vertex == other.vertex` speeds it up dramatically.\n\nPatch has some other fixes. Changes the chow group to use sparse matrices.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11559\n\n",
    "created_at": "2011-06-30T20:38:15Z",
    "labels": [
        "algebraic geometry",
        "major",
        "enhancement"
    ],
    "title": "Speed up Posets and toric Chow group",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11387",
    "user": "vbraun"
}
```
Assignee: AlexGhitza

CC:  sage-combinat

To my surprise, computing the Chow group spends most of the time comparing cones instead of doing linear algebra. 3/4 of the time is spent in `PosetElement.__eq__()`:

```
   return self.parent() == other.parent() \
          and self.element == other.element \
          and self.vertex == other.vertex
```

Reordering this to first compare `self.vertex == other.vertex` speeds it up dramatically.

Patch has some other fixes. Changes the chow group to use sparse matrices.

Issue created by migration from https://trac.sagemath.org/ticket/11559





---

archive/issue_comments_126387.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-06-30T20:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126387",
    "user": "vbraun"
}
```

Updated patch



---

archive/issue_comments_126388.json:
```json
{
    "body": "Attachment\n\nCan you clarify why `hermit_form` was replaced with `echelon_form`?\n\nAlso I don't like the very last change with forceful passing of `check=False` to the parent constructor. I think the correct way is to always pass whatever was received from the user and if it leads to a slowdown somewhere, then in that somewhere one should use `check=False`.",
    "created_at": "2011-07-01T00:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126388",
    "user": "novoselt"
}
```

Attachment

Can you clarify why `hermit_form` was replaced with `echelon_form`?

Also I don't like the very last change with forceful passing of `check=False` to the parent constructor. I think the correct way is to always pass whatever was received from the user and if it leads to a slowdown somewhere, then in that somewhere one should use `check=False`.



---

archive/issue_comments_126389.json:
```json
{
    "body": "I took a look at this earlier, so I'll add my 2 cents worth.\n\n`hermite_form` is a straight replacement for `echelon_form`.  Now that we have a `rref` command to obtain results over fields, I personally think it would be nice if \"hermite form\" went away, I think it confuses too many non-specialists.\n\nI was going to vouch for the posets and linear algebra, but I don't know the Chow group stuff, so it is good that Andrey is on this one.\n\nRob",
    "created_at": "2011-07-01T04:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126389",
    "user": "rbeezer"
}
```

I took a look at this earlier, so I'll add my 2 cents worth.

`hermite_form` is a straight replacement for `echelon_form`.  Now that we have a `rref` command to obtain results over fields, I personally think it would be nice if "hermite form" went away, I think it confuses too many non-specialists.

I was going to vouch for the posets and linear algebra, but I don't know the Chow group stuff, so it is good that Andrey is on this one.

Rob



---

archive/issue_comments_126390.json:
```json
{
    "body": "`hermite_form` is an alias for `echelon_form` for dense ZZ-matrices. Sparse ZZ-matrices currently don't have a `hermite_form` method, though I'll add that back in #11558.\n\nI'm passing `check=False` to the element constructor because the input for the base constructor is computed. Usually when you extend some element class, you pass user-specified arguments through to the base constructor and its necessary to check their validity. Though I didn't see it taking much time when benchmarking, so if you insist I'll be happy to take it out again.",
    "created_at": "2011-07-01T08:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126390",
    "user": "vbraun"
}
```

`hermite_form` is an alias for `echelon_form` for dense ZZ-matrices. Sparse ZZ-matrices currently don't have a `hermite_form` method, though I'll add that back in #11558.

I'm passing `check=False` to the element constructor because the input for the base constructor is computed. Usually when you extend some element class, you pass user-specified arguments through to the base constructor and its necessary to check their validity. Though I didn't see it taking much time when benchmarking, so if you insist I'll be happy to take it out again.



---

archive/issue_comments_126391.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-07-01T09:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126391",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_126392.json:
```json
{
    "body": "Remove assignee AlexGhitza.",
    "created_at": "2011-07-02T10:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126392",
    "user": "hivert"
}
```

Remove assignee AlexGhitza.



---

archive/issue_comments_126393.json:
```json
{
    "body": "What kind of parents are you using. Normally they should be unique so that\nparent comparisons should be done with is and thus instantaneous. Moreover, I\ndon't think your solution is correct because in some case you will end up\ncomparing things where eq will simply break. I'll try to cook an example.\n\nFlorent",
    "created_at": "2011-07-02T10:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126393",
    "user": "hivert"
}
```

What kind of parents are you using. Normally they should be unique so that
parent comparisons should be done with is and thus instantaneous. Moreover, I
don't think your solution is correct because in some case you will end up
comparing things where eq will simply break. I'll try to cook an example.

Florent



---

archive/issue_comments_126394.json:
```json
{
    "body": "I should also mention that before touching anything in posets you should test you code with #10998 applied. There where a major rewrite in posets with a lot of speedups and cleanups.\n\nFlorent",
    "created_at": "2011-07-02T10:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126394",
    "user": "hivert"
}
```

I should also mention that before touching anything in posets you should test you code with #10998 applied. There where a major rewrite in posets with a lot of speedups and cleanups.

Florent



---

archive/issue_comments_126395.json:
```json
{
    "body": "I agree that parents should be unique. The original code compared parents with `==` and I didn't change it.\n\nMy point is that the `PosetElement.element` comparison is potentially slow. In fact, I don't understand why `PosetElement.__eq__` compares both `vertex` and `element`, I am under the impression that there is a bijection between vertices and elements. \n\nThe reordering does break comparison between `PosetElement`s and other classes, though I'm not sure if we care. The patch does conflict with #10998, so that one needs to be reviewed first.",
    "created_at": "2011-07-02T11:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126395",
    "user": "vbraun"
}
```

I agree that parents should be unique. The original code compared parents with `==` and I didn't change it.

My point is that the `PosetElement.element` comparison is potentially slow. In fact, I don't understand why `PosetElement.__eq__` compares both `vertex` and `element`, I am under the impression that there is a bijection between vertices and elements. 

The reordering does break comparison between `PosetElement`s and other classes, though I'm not sure if we care. The patch does conflict with #10998, so that one needs to be reviewed first.



---

archive/issue_comments_126396.json:
```json
{
    "body": "Same lines are edited by #12351. One will have to adapt to the other one.",
    "created_at": "2012-01-26T22:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126396",
    "user": "slabbe"
}
```

Same lines are edited by #12351. One will have to adapt to the other one.



---

archive/issue_comments_126397.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-15T22:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126397",
    "user": "novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_126398.json:
```json
{
    "body": "Does not apply on Sage-5.0.beta4!",
    "created_at": "2012-02-15T22:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126398",
    "user": "novoselt"
}
```

Does not apply on Sage-5.0.beta4!



---

archive/issue_comments_126399.json:
```json
{
    "body": "Replying to [comment:10 novoselt]:\n> Does not apply on Sage-5.0.beta4!\n\nIf it's the hunk in the poset code that fails, that's normal. #10998 already integrates this change (in fact a slightly better one).",
    "created_at": "2012-02-16T10:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126399",
    "user": "nthiery"
}
```

Replying to [comment:10 novoselt]:
> Does not apply on Sage-5.0.beta4!

If it's the hunk in the poset code that fails, that's normal. #10998 already integrates this change (in fact a slightly better one).



---

archive/issue_comments_126400.json:
```json
{
    "body": "Hey Volker,\n\nChanging posets to compare again vertices first still shaves off a second on testing Chow group module - do you have an example where it used to be crucial? In any case if you are fine with my rebasing let's merge it!",
    "created_at": "2012-05-25T00:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126400",
    "user": "novoselt"
}
```

Hey Volker,

Changing posets to compare again vertices first still shaves off a second on testing Chow group module - do you have an example where it used to be crucial? In any case if you are fine with my rebasing let's merge it!



---

archive/issue_comments_126401.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-25T00:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126401",
    "user": "novoselt"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_126402.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric, sd40.5\".",
    "created_at": "2012-05-27T20:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126402",
    "user": "novoselt"
}
```

Changing keywords from "" to "toric, sd40.5".



---

archive/issue_comments_126403.json:
```json
{
    "body": "Attachment\n\nRebased for Sage-5.1.beta0",
    "created_at": "2012-05-28T02:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126403",
    "user": "novoselt"
}
```

Attachment

Rebased for Sage-5.1.beta0



---

archive/issue_comments_126404.json:
```json
{
    "body": "Now works fine after file move.",
    "created_at": "2012-05-28T02:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126404",
    "user": "novoselt"
}
```

Now works fine after file move.



---

archive/issue_comments_126405.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-07-22T14:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126405",
    "user": "chapoton"
}
```

Attachment



---

archive/issue_comments_126406.json:
```json
{
    "body": "for the bot:\n\napply trac_11559_fix_Chow_group.2.patch trac_11559_hasattr_vertex_fc.patch\n\nIf you do not want to check the parent first, you need to make sure that other has the attribute \"vertex\" !\n\nThis ticket needs benchmarking, to see if something significant is still gained in term of time or not.",
    "created_at": "2013-07-22T14:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126406",
    "user": "chapoton"
}
```

for the bot:

apply trac_11559_fix_Chow_group.2.patch trac_11559_hasattr_vertex_fc.patch

If you do not want to check the parent first, you need to make sure that other has the attribute "vertex" !

This ticket needs benchmarking, to see if something significant is still gained in term of time or not.



---

archive/issue_comments_126407.json:
```json
{
    "body": "Attachment\n\nhere a patch correcting the failing doctests\n\nApply trac_11559_fix_Chow_group.2.patch trac_11559_fixdoctest.patch trac_11559_hasattr_vertex_fc.patch",
    "created_at": "2013-11-04T20:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126407",
    "user": "chapoton"
}
```

Attachment

here a patch correcting the failing doctests

Apply trac_11559_fix_Chow_group.2.patch trac_11559_fixdoctest.patch trac_11559_hasattr_vertex_fc.patch



---

archive/issue_comments_126408.json:
```json
{
    "body": "I just noticed this ticket. Has someone tried using have_same_parent(self, other) ?",
    "created_at": "2013-11-04T20:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126408",
    "user": "nthiery"
}
```

I just noticed this ticket. Has someone tried using have_same_parent(self, other) ?



---

archive/issue_comments_126409.json:
```json
{
    "body": "here is a git branch\n----\nNew commits:",
    "created_at": "2014-02-21T13:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126409",
    "user": "chapoton"
}
```

here is a git branch
----
New commits:



---

archive/issue_comments_126410.json:
```json
{
    "body": "From the patchbot report:\n\n```\nFile \"src/sage/geometry/fan.py\", line 158, in sage.geometry.fan\nFailed example:\n    sorted(L.hasse_diagram().neighbors(cone))\nExpected:\n    [1-d cone of Rational polyhedral fan in 3-d lattice M,\n     1-d cone of Rational polyhedral fan in 3-d lattice M,\n     3-d cone of Rational polyhedral fan in 3-d lattice M,\n     3-d cone of Rational polyhedral fan in 3-d lattice M]\nGot:\n    [1-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 1-d cone of Rational polyhedral fan in 3-d lattice M]\n```\n",
    "created_at": "2014-05-07T14:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126410",
    "user": "pbruin"
}
```

From the patchbot report:

```
File "src/sage/geometry/fan.py", line 158, in sage.geometry.fan
Failed example:
    sorted(L.hasse_diagram().neighbors(cone))
Expected:
    [1-d cone of Rational polyhedral fan in 3-d lattice M,
     1-d cone of Rational polyhedral fan in 3-d lattice M,
     3-d cone of Rational polyhedral fan in 3-d lattice M,
     3-d cone of Rational polyhedral fan in 3-d lattice M]
Got:
    [1-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 3-d cone of Rational polyhedral fan in 3-d lattice M, 1-d cone of Rational polyhedral fan in 3-d lattice M]
```




---

archive/issue_comments_126411.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-07T14:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126411",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_126412.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-09T20:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126412",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_126413.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-07-09T20:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126413",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_126414.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-07-09T21:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126414",
    "user": "jkeitel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_126415.json:
```json
{
    "body": "Hi, the patch looks good to me and seems to make sensible changes. However, I can't tell whether the patch is actually bringing any speed benefits. Volker, Andrey, what exactly is it that should be benchmarked?\n----\nNew commits:",
    "created_at": "2014-07-09T21:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126415",
    "user": "jkeitel"
}
```

Hi, the patch looks good to me and seems to make sensible changes. However, I can't tell whether the patch is actually bringing any speed benefits. Volker, Andrey, what exactly is it that should be benchmarked?
----
New commits:



---

archive/issue_comments_126416.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-07-09T21:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126416",
    "user": "jkeitel"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_126417.json:
```json
{
    "body": "This ticket seems to confuse the patchbot. But maybe any ticket would..",
    "created_at": "2015-03-25T19:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126417",
    "user": "chapoton"
}
```

This ticket seems to confuse the patchbot. But maybe any ticket would..



---

archive/issue_comments_126418.json:
```json
{
    "body": "Put to need info just to stop the bots loop-testing this ticket.",
    "created_at": "2015-03-25T19:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126418",
    "user": "chapoton"
}
```

Put to need info just to stop the bots loop-testing this ticket.



---

archive/issue_comments_126419.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-03-25T19:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126419",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_126420.json:
```json
{
    "body": "Related or not - when I click on the branch name to see the differences, it shows the intent to DELETE TWO MODULES completely!!! I do not see commits that attempt to do it, however.",
    "created_at": "2015-03-25T22:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126420",
    "user": "novoselt"
}
```

Related or not - when I click on the branch name to see the differences, it shows the intent to DELETE TWO MODULES completely!!! I do not see commits that attempt to do it, however.



---

archive/issue_comments_126421.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-05-05T18:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126421",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_126422.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-06-04T11:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126422",
    "user": "pbruin"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_126423.json:
```json
{
    "body": "Some patchbots are still testing this ticket, but there are various doctest failures; setting this back to \"needs_work\".",
    "created_at": "2015-06-04T11:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126423",
    "user": "pbruin"
}
```

Some patchbots are still testing this ticket, but there are various doctest failures; setting this back to "needs_work".



---

archive/issue_comments_126424.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-14T12:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11387#issuecomment-126424",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
