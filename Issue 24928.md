# Issue 24928: Showing a plot overwrites matplotlib global options

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2018-04-13 18:00:59

CC:  strogdon


```
sage: from matplotlib import rcParams
sage: rcParams['font.family'] = 'serif'
sage: p = plot(sin, 0, 1)
sage: rcParams['font.family']
[u'serif']
sage: p.show() # or save(), or matplotlib()
Launched png viewer for Graphics object consisting of 1 graphics primitive
sage: rcParams['font.family']
[u'sans-serif']
```


I think this is because `Graphics.matplotlib()` always loads a matplotlib stylesheet—usually `'classic'`—, but I'm not sure what the right thing to do would be.


---

Comment by strogdon created at 2018-04-13 18:45:47

Probably any of the defaults in `matplotlib/mpl-data/stylelib/classic.mplstyle` if changed through `rcParams[]` will be overwritten if `matplotlib` is called. I don't know what would have happened prior to the `matplotlib` upgrade.


---

Comment by strogdon created at 2018-04-13 19:03:12

Yes, prior to commit [d109b7593e](https://git.sagemath.org/sage.git/commit/?h=ca3b242e6d7ca2ce22d8d23ef62d0cecd95b585f&id=d109b7593ef7d1e8d3e234d554524e99c7e92b5e) user changes via `rcParams[]` were not altered after calls to `matplotlib`.


---

Comment by fbissey created at 2018-04-13 21:56:12

I had not tested that particular scenario I must say. I thought it would work, there may be an ordering issue. One of the issue that lead to the inclusion of that style in matplotlib calls is that the default style changed between 1.5.x and 2.1.x. I got comments that plots after the upgrade to 2.1.x were not looking very good. 

Including the style restored the default of 1.5.x and restored the general quality of the plots.

In effect I have been torn between importing a style sheet before every graphics call and documenting it somewhere that you needed it for nice plots (how many graphics calls for the documentation? A few hundreds probably). Or just applying it blindly.

Anyway, I'll have to dig that code again to see what is the right thing to do to over-ride style sheet options. I added the option to change the style sheet but you want something more fine grained than that.


---

Comment by mmezzarobba created at 2018-04-14 09:20:49

I really like the option to specify a style sheet, it is a great way to give more control to the user on the appearance of the plots at a low development effort and without duplicating the functionality of matplotlib. And it could be enough to document prominently that this is the recommended way to set matplotlib options in sage (at the moment, there are several answers on ask.sage that suggest using `matplotlib.rc` or similar).


---

Comment by strogdon created at 2018-04-14 15:46:38

We could keep track of user changes. Something like

```diff
diff --git a/src/sage/plot/graphics.py b/src/sage/plot/graphics.py
index 58ece044f6..8d68b0a681 100644
--- a/src/sage/plot/graphics.py
+++ b/src/sage/plot/graphics.py
`@``@` -2527,10 +2527,23 `@``@` class Graphics(WithEqualityById, SageObject):
         if not isinstance(ticks, (list, tuple)):
             ticks = (ticks, None)
 
+        from matplotlib import rcParams, style
+
+        #  save rcParams changed by the user
+        userdefaults = rcParams.items()
+        style.use('default')
+        l = []
+        for i in range(0, len(userdefaults)):
+            if userdefaults[i] != rcParams.items()[i]:
+                l.append(userdefaults[i])
+
         import matplotlib.pyplot as plt
         if stylesheet not in plt.style.available:
             stylesheet = 'classic'
         plt.style.use(stylesheet)
+        #  add user changed rcParams to current stylesheet
+        for i in range(0, len(l)):
+            rcParams[l[i][0]] = l[i][1]
 
         from sage.symbolic.ring import SR
         if not isinstance(tick_formatter, (list, tuple)):  # make sure both formatters typeset or both don't
`@``@` -3005,6 +3018,11 `@``@` class Graphics(WithEqualityById, SageObject):
         for g in self._objects:
             g.set_options(old_opts[g])
 
+        #  switch to the 'default' stylesheet and add back user changed rcParams
+        style.use('default')
+        for i in range(0, len(l)):
+            rcParams[l[i][0]] = l[i][1]
+
         return figure
 
     def save_image(self, filename=None, *args, **kwds):
```

I'm not sure it is robust enough, particularly with how the user changes are added in. And it will increase overhead if there are a lot of user changes. Before the patch

```
sage: from matplotlib import rcParams
sage: rcParams['font.size']
10.0
sage: p = plot(sin, 0, 1)
sage: p.matplotlib()
<matplotlib.figure.Figure object at 0x7f76037d2490>
sage: rcParams['font.size']
12.0
```

and after the patch

```
sage: from matplotlib import rcParams
sage: rcParams['font.size']
10.0
sage: p = plot(sin, 0, 1)
sage: p.matplotlib()
<matplotlib.figure.Figure object at 0x7f1928dff410>
sage: rcParams['font.size']
10.0
```



---

Comment by strogdon created at 2018-04-14 18:26:11

This

```
rcParams[l[i][0]] = l[i][1]
```

is not correct in all cases, in particular the `l[i][1]`. But at the least we should restore the defaults.


---

Comment by strogdon created at 2018-04-14 19:07:48

Well, may be better than I thought

```
sage: from matplotlib import rcParams, rc
sage: rc('font', size=9.0, family='serif')
sage: rcParams['font.family']
[u'serif']
sage: rcParams['font.size']
9.0
sage: p = plot(sin, 0, 1)
sage: p.matplotlib()
<matplotlib.figure.Figure object at 0x7f7ff24a2350>
sage: rcParams['font.family']
[u'serif']
sage: rcParams['font.size']
9.0
```

