# Issue 28489: py3: cysignals fails its test suite

archive/issues_028489.json:
```json
{
    "body": "CC:  jdemeyer\n\nWith a Python 3 build of Sage, `./sage -f -c cysignals` fails because the test suite doesn't use the correct version of Python.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28726\n\n",
    "created_at": "2019-11-13T19:50:28Z",
    "labels": [
        "packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3: cysignals fails its test suite",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28489",
    "user": "jhpalmieri"
}
```
CC:  jdemeyer

With a Python 3 build of Sage, `./sage -f -c cysignals` fails because the test suite doesn't use the correct version of Python.

Issue created by migration from https://trac.sagemath.org/ticket/28726





---

archive/issue_comments_402346.json:
```json
{
    "body": "The change\n\n```diff\ndiff --git a/build/pkgs/cysignals/spkg-check b/build/pkgs/cysignals/spkg-check\nindex c94041e096..37fa0dddfc 100644\n--- a/build/pkgs/cysignals/spkg-check\n+++ b/build/pkgs/cysignals/spkg-check\n@@ -4,4 +4,4 @@ if [ -z \"$SAGE_LOCAL\" ]; then\n     exit 1\n fi\n \n-cd src && $MAKE check-install\n+cd src && $MAKE check-install PYTHON=sage-python23\n```\n\nhelps testing get started, but the test suite still fails on OS X. I see this message in the log file:\n\n```\nTraceback (most recent call last):\n  File \"rundoctests.py\", line 74, in <module>\n    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\nValueError: current limit exceeds maximum limit\n```\n",
    "created_at": "2019-11-13T19:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402346",
    "user": "jhpalmieri"
}
```

The change

```diff
diff --git a/build/pkgs/cysignals/spkg-check b/build/pkgs/cysignals/spkg-check
index c94041e096..37fa0dddfc 100644
--- a/build/pkgs/cysignals/spkg-check
+++ b/build/pkgs/cysignals/spkg-check
@@ -4,4 +4,4 @@ if [ -z "$SAGE_LOCAL" ]; then
     exit 1
 fi
 
-cd src && $MAKE check-install
+cd src && $MAKE check-install PYTHON=sage-python23
```

helps testing get started, but the test suite still fails on OS X. I see this message in the log file:

```
Traceback (most recent call last):
  File "rundoctests.py", line 74, in <module>
    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
ValueError: current limit exceeds maximum limit
```




---

archive/issue_comments_402347.json:
```json
{
    "body": "I'm seeing that one, too. Only admins can increase the stack size, there is nothing that the testsuite can do about it (except not running the test, does it really need that big a stack?)",
    "created_at": "2019-11-14T09:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402347",
    "user": "vbraun"
}
```

I'm seeing that one, too. Only admins can increase the stack size, there is nothing that the testsuite can do about it (except not running the test, does it really need that big a stack?)



---

archive/issue_comments_402348.json:
```json
{
    "body": "Maybe you can turn your diff already into a patch, we should surely be using the correct python version.",
    "created_at": "2019-11-15T12:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402348",
    "user": "vbraun"
}
```

Maybe you can turn your diff already into a patch, we should surely be using the correct python version.



---

archive/issue_comments_402349.json:
```json
{
    "body": "I don't understand the stack size issue. The following patch is a bad idea since it completely disables the stack size limitation put in by cysignals' `rundoctests.py`, but with it, the test suite passes for me with OS X + py3:\n\n```diff\ndiff --git a/build/pkgs/cysignals/patches/stacksize.patch b/build/pkgs/cysignals/patches/stacksize.patch\nnew file mode 100644\nindex 0000000000..63a11ba07f\n--- /dev/null\n+++ b/build/pkgs/cysignals/patches/stacksize.patch\n@@ -0,0 +1,13 @@\n+diff --git a/rundoctests.py b/rundoctests.py\n+index 94d58e1..3c4f8c3 100755\n+--- a/rundoctests.py\n++++ b/rundoctests.py\n+@@ -71,7 +71,7 @@ if os.name != 'nt':\n+     import resource\n+     # Limit stack size to avoid errors in stack overflow doctest\n+     stacksize = 1 << 20\n+-    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\n++    # resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\n+ \n+     # Disable core dumps\n+     resource.setrlimit(resource.RLIMIT_CORE, (0, 0))\n```\n\n----\nNew commits:",
    "created_at": "2019-11-15T18:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402349",
    "user": "jhpalmieri"
}
```

I don't understand the stack size issue. The following patch is a bad idea since it completely disables the stack size limitation put in by cysignals' `rundoctests.py`, but with it, the test suite passes for me with OS X + py3:

```diff
diff --git a/build/pkgs/cysignals/patches/stacksize.patch b/build/pkgs/cysignals/patches/stacksize.patch
new file mode 100644
index 0000000000..63a11ba07f
--- /dev/null
+++ b/build/pkgs/cysignals/patches/stacksize.patch
@@ -0,0 +1,13 @@
+diff --git a/rundoctests.py b/rundoctests.py
+index 94d58e1..3c4f8c3 100755
+--- a/rundoctests.py
++++ b/rundoctests.py
+@@ -71,7 +71,7 @@ if os.name != 'nt':
+     import resource
+     # Limit stack size to avoid errors in stack overflow doctest
+     stacksize = 1 << 20
+-    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
++    # resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
+ 
+     # Disable core dumps
+     resource.setrlimit(resource.RLIMIT_CORE, (0, 0))
```

----
New commits:



---

archive/issue_comments_402350.json:
```json
{
    "body": "I'm not marking this ready for review, because even with the patch specifying the correction version of Python, it doesn't pass its test suite.",
    "created_at": "2019-11-15T18:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402350",
    "user": "jhpalmieri"
}
```

I'm not marking this ready for review, because even with the patch specifying the correction version of Python, it doesn't pass its test suite.



---

archive/issue_comments_402351.json:
```json
{
    "body": "On the other hand, with just this patch, tests do pass on my ubuntu virtual machine. So maybe the stack size issue is OS X only?",
    "created_at": "2019-11-15T20:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402351",
    "user": "jhpalmieri"
}
```

On the other hand, with just this patch, tests do pass on my ubuntu virtual machine. So maybe the stack size issue is OS X only?



---

archive/issue_comments_402352.json:
```json
{
    "body": "So we are trying to reduce the stack size, not increase it. 1MB is pretty low. Whats the output of `ulimit -s` on your OSX machine? I think its 8192 (8MB) by default, which should be plenty. I don't get an error running:\n\n```\nOSX:~ vbraun$ python\nPython 2.7.10 (default, Feb 22 2019, 21:55:15) \n[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import resource\n>>> resource.getrlimit(resource.RLIMIT_STACK)\n(8388608, 67104768)\n>>> stacksize = 1 << 20\n>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\n>>> resource.getrlimit(resource.RLIMIT_STACK)\n(1048576, 1048576)\n```\n",
    "created_at": "2019-11-15T20:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402352",
    "user": "vbraun"
}
```

So we are trying to reduce the stack size, not increase it. 1MB is pretty low. Whats the output of `ulimit -s` on your OSX machine? I think its 8192 (8MB) by default, which should be plenty. I don't get an error running:

```
OSX:~ vbraun$ python
Python 2.7.10 (default, Feb 22 2019, 21:55:15) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
>>> resource.getrlimit(resource.RLIMIT_STACK)
(1048576, 1048576)
```




---

archive/issue_comments_402353.json:
```json
{
    "body": "`ulimit -s` returns 8192. I don't get an error running that with Python 2, but I do with Python 3 on OS X. (On the Ubuntu virtual machine, I don't get an error with Python 3.)",
    "created_at": "2019-11-15T21:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402353",
    "user": "jhpalmieri"
}
```

`ulimit -s` returns 8192. I don't get an error running that with Python 2, but I do with Python 3 on OS X. (On the Ubuntu virtual machine, I don't get an error with Python 3.)



---

archive/issue_comments_402354.json:
```json
{
    "body": "\n```\n$ python\nPython 2.7.16 (default, Oct 16 2019, 00:34:56) \n[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import resource\n>>> resource.getrlimit(resource.RLIMIT_STACK)\n(8388608, 67104768)\n>>> stacksize = 1 << 20\n>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\n>>> resource.getrlimit(resource.RLIMIT_STACK)\n(1048576, 1048576)\n```\n\nand\n\n```\n$ sage --python\nPython 3.7.3 (default, Nov  5 2019, 10:19:31) \n[Clang 11.0.0 (clang-1100.0.33.12)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import resource\n>>> resource.getrlimit(resource.RLIMIT_STACK)\n(8388608, 67104768)\n>>> stacksize = 1 << 20\n>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nValueError: current limit exceeds maximum limit\n```\n\nI get the same error if I use `python3`, but I forget how I installed Python 3 on this machine.",
    "created_at": "2019-11-15T21:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402354",
    "user": "jhpalmieri"
}
```


```
$ python
Python 2.7.16 (default, Oct 16 2019, 00:34:56) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
>>> resource.getrlimit(resource.RLIMIT_STACK)
(1048576, 1048576)
```

and

```
$ sage --python
Python 3.7.3 (default, Nov  5 2019, 10:19:31) 
[Clang 11.0.0 (clang-1100.0.33.12)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ValueError: current limit exceeds maximum limit
```

I get the same error if I use `python3`, but I forget how I installed Python 3 on this machine.



---

archive/issue_comments_402355.json:
```json
{
    "body": "Is this a recurrence of https://github.com/sagemath/cysignals/issues/71?",
    "created_at": "2019-11-15T21:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402355",
    "user": "jhpalmieri"
}
```

Is this a recurrence of https://github.com/sagemath/cysignals/issues/71?



---

archive/issue_comments_402356.json:
```json
{
    "body": "Or maybe it's https://bugs.python.org/issue34602, and upgrading Python will help.",
    "created_at": "2019-11-15T21:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402356",
    "user": "jhpalmieri"
}
```

Or maybe it's https://bugs.python.org/issue34602, and upgrading Python will help.



---

archive/issue_comments_402357.json:
```json
{
    "body": "I installed Python 3.7.5, and I still hit this problem.",
    "created_at": "2019-11-15T22:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402357",
    "user": "jhpalmieri"
}
```

I installed Python 3.7.5, and I still hit this problem.



---

archive/issue_comments_402358.json:
```json
{
    "body": "Do you mind opening a cysignals issue for the OSX kernel oddity / bug? The ValueError should probably just be caught and discarded. But we could merge this in the meantime...",
    "created_at": "2019-11-15T23:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402358",
    "user": "vbraun"
}
```

Do you mind opening a cysignals issue for the OSX kernel oddity / bug? The ValueError should probably just be caught and discarded. But we could merge this in the meantime...



---

archive/issue_comments_402359.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-15T23:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402359",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402360.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-15T23:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402360",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_402361.json:
```json
{
    "body": "Okay, I opened up a cysignals issue.",
    "created_at": "2019-11-16T00:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402361",
    "user": "jhpalmieri"
}
```

Okay, I opened up a cysignals issue.



---

archive/issue_comments_402362.json:
```json
{
    "body": "Thanks! Bug is at https://github.com/sagemath/cysignals/issues/118 for future historians ;-)",
    "created_at": "2019-11-16T12:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402362",
    "user": "vbraun"
}
```

Thanks! Bug is at https://github.com/sagemath/cysignals/issues/118 for future historians ;-)



---

archive/issue_comments_402363.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-16T20:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-402363",
    "user": "vbraun"
}
```

Resolution: fixed
