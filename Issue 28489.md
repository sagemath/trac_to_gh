# Issue 28489: py3: cysignals fails its test suite

Issue created by migration from https://trac.sagemath.org/ticket/28726

Original creator: jhpalmieri

Original creation time: 2019-11-13 19:50:28

CC:  jdemeyer

With a Python 3 build of Sage, `./sage -f -c cysignals` fails because the test suite doesn't use the correct version of Python.


---

Comment by jhpalmieri created at 2019-11-13 19:53:07

The change

```diff
diff --git a/build/pkgs/cysignals/spkg-check b/build/pkgs/cysignals/spkg-check
index c94041e096..37fa0dddfc 100644
--- a/build/pkgs/cysignals/spkg-check
+++ b/build/pkgs/cysignals/spkg-check
@@ -4,4 +4,4 @@ if [ -z "$SAGE_LOCAL" ]; then
     exit 1
 fi
 
-cd src && $MAKE check-install
+cd src && $MAKE check-install PYTHON=sage-python23
```

helps testing get started, but the test suite still fails on OS X. I see this message in the log file:

```
Traceback (most recent call last):
  File "rundoctests.py", line 74, in <module>
    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
ValueError: current limit exceeds maximum limit
```



---

Comment by vbraun created at 2019-11-14 09:00:09

I'm seeing that one, too. Only admins can increase the stack size, there is nothing that the testsuite can do about it (except not running the test, does it really need that big a stack?)


---

Comment by vbraun created at 2019-11-15 12:00:30

Maybe you can turn your diff already into a patch, we should surely be using the correct python version.


---

Comment by jhpalmieri created at 2019-11-15 18:50:28

I don't understand the stack size issue. The following patch is a bad idea since it completely disables the stack size limitation put in by cysignals' `rundoctests.py`, but with it, the test suite passes for me with OS X + py3:

```diff
diff --git a/build/pkgs/cysignals/patches/stacksize.patch b/build/pkgs/cysignals/patches/stacksize.patch
new file mode 100644
index 0000000000..63a11ba07f
--- /dev/null
+++ b/build/pkgs/cysignals/patches/stacksize.patch
@@ -0,0 +1,13 @@
+diff --git a/rundoctests.py b/rundoctests.py
+index 94d58e1..3c4f8c3 100755
+--- a/rundoctests.py
++++ b/rundoctests.py
+@@ -71,7 +71,7 @@ if os.name != 'nt':
+     import resource
+     # Limit stack size to avoid errors in stack overflow doctest
+     stacksize = 1 << 20
+-    resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
++    # resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
+ 
+     # Disable core dumps
+     resource.setrlimit(resource.RLIMIT_CORE, (0, 0))
```

----
New commits:


---

Comment by jhpalmieri created at 2019-11-15 18:51:17

I'm not marking this ready for review, because even with the patch specifying the correction version of Python, it doesn't pass its test suite.


---

Comment by jhpalmieri created at 2019-11-15 20:25:51

On the other hand, with just this patch, tests do pass on my ubuntu virtual machine. So maybe the stack size issue is OS X only?


---

Comment by vbraun created at 2019-11-15 20:42:43

So we are trying to reduce the stack size, not increase it. 1MB is pretty low. Whats the output of `ulimit -s` on your OSX machine? I think its 8192 (8MB) by default, which should be plenty. I don't get an error running:

```
OSX:~ vbraun$ python
Python 2.7.10 (default, Feb 22 2019, 21:55:15) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
>>> resource.getrlimit(resource.RLIMIT_STACK)
(1048576, 1048576)
```



---

Comment by jhpalmieri created at 2019-11-15 21:26:25

`ulimit -s` returns 8192. I don't get an error running that with Python 2, but I do with Python 3 on OS X. (On the Ubuntu virtual machine, I don't get an error with Python 3.)


---

Comment by jhpalmieri created at 2019-11-15 21:29:18


```
$ python
Python 2.7.16 (default, Oct 16 2019, 00:34:56) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.37.14)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
>>> resource.getrlimit(resource.RLIMIT_STACK)
(1048576, 1048576)
```

and

```
$ sage --python
Python 3.7.3 (default, Nov  5 2019, 10:19:31) 
[Clang 11.0.0 (clang-1100.0.33.12)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import resource
>>> resource.getrlimit(resource.RLIMIT_STACK)
(8388608, 67104768)
>>> stacksize = 1 << 20
>>> resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ValueError: current limit exceeds maximum limit
```

I get the same error if I use `python3`, but I forget how I installed Python 3 on this machine.


---

Comment by jhpalmieri created at 2019-11-15 21:31:09

Is this a recurrence of https://github.com/sagemath/cysignals/issues/71?


---

Comment by jhpalmieri created at 2019-11-15 21:47:01

Or maybe it's https://bugs.python.org/issue34602, and upgrading Python will help.


---

Comment by jhpalmieri created at 2019-11-15 22:53:54

I installed Python 3.7.5, and I still hit this problem.


---

Comment by vbraun created at 2019-11-15 23:47:08

Do you mind opening a cysignals issue for the OSX kernel oddity / bug? The ValueError should probably just be caught and discarded. But we could merge this in the meantime...


---

Comment by vbraun created at 2019-11-15 23:47:08

Changing status from new to needs_review.


---

Comment by vbraun created at 2019-11-15 23:47:13

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-11-16 00:21:51

Okay, I opened up a cysignals issue.


---

Comment by vbraun created at 2019-11-16 12:57:25

Thanks! Bug is at https://github.com/sagemath/cysignals/issues/118 for future historians ;-)


---

Comment by vbraun created at 2019-11-16 20:15:19

Resolution: fixed
