# Issue 27587: spkg-configure.m4 for pythons

Issue created by migration from https://trac.sagemath.org/ticket/27824

Original creator: dimpase

Original creation time: 2019-05-13 15:52:41

CC:  jdemeyer embray vbraun fbissey jhpalmieri vdelecroix

do not install pythonX if we are in the virtenv of pythonX.

At the moment I don't know how feasible it is - one small obstacle might be that we really do not want to mess with two pythons at the same time.


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by embray created at 2019-08-14 11:48:42

For Python packages when installing using the system Python we definitely need a well thought out approach, likely with different options for handling questions such as where to install additional Python packages.

`$SAGE_LOCAL` _already_ acts as a sort-of virtualenv, but we might still consider using virtualenv/venv in `$SAGE_LOCAL` (with the `--system-site-packages` option) as a way of extending `sys.path` while still using as many system Python packages as possible.


---

Comment by mkoeppe created at 2020-01-14 22:27:03

See #29013 - "In a python3 build, install all Python packages into a venv"


---

Comment by mkoeppe created at 2020-01-15 02:05:52

Narrowed the ticket to py3.


---

Comment by mkoeppe created at 2020-01-15 04:45:23

Here's a version that works. The venv is created in `build/make/Makefile` target (in #29013, I created the venv in the `spkg-postinst` script of the `python3` spkg.) 
----
New commits:


---

Comment by dimpase created at 2020-01-15 10:32:08

how about checking for Py3 deps: `sqlite libpng bzip2 xz libffi` ?
(I skipped in this list ones that are 2nd order, so no need to check them)


---

Comment by dimpase created at 2020-01-15 11:56:27

On Gentoo Python 3 does not have sqlite module by default. I had to do
`$ pip install pysqlite3 --user`, and still `elliptic_curves` spkg installation errors out.


---

Comment by git created at 2020-01-15 14:37:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-15 14:48:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-15 14:50:07

I've reduced the scope of the ticket, excluding the use of system site packages.


---

Comment by git created at 2020-01-15 16:45:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-15 18:01:08

I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
and it broke at docbuild, with

```
RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
```

even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)


---

Comment by mkoeppe created at 2020-01-15 18:02:58

Thanks for testing!


---

Comment by dimpase created at 2020-01-15 18:03:18

Replying to [comment:14 mkoeppe]:
> I've reduced the scope of the ticket, excluding the use of system site packages.

do you mean pip/etc-installed `site-packages` of system's Python?


---

Comment by mkoeppe created at 2020-01-15 18:55:08

Replying to [comment:18 dimpase]:
> Replying to [comment:14 mkoeppe]:
> > I've reduced the scope of the ticket, excluding the use of system site packages.
> 
> do you mean pip/etc-installed `site-packages` of system's Python?

Yes.


---

Comment by git created at 2020-01-15 20:53:47

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-01-15 21:05:59

Now this is giving

```
[pillow-5.3.0.p0] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/usr/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -g -DHAVE_OPENJPEG -DHAVE_LIBZ -DHAVE_LIBTIFF -DPILLOW_VERSION="5.3.0" -I/usr/local/Cellar/openjpeg/2.3.1/include/openjpeg-2.3 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/var/tmp/sage/build/pillow-5.3.0.p0/src/src/libImaging -I/usr/local/Cellar/jpeg/9c/include -I/usr/local/Cellar/libtiff/4.1.0/include -I/usr/local/Cellar/freetype/2.10.1/include/freetype2 -I/usr/local/Cellar/little-cms2/2.9/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/include -I/usr/local/Cellar/freetype/2.10.1/include -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/Cellar/python/3.7.6_1/Frameworks/Python.framework/Versions/3.7/include/python3.7m -c src/_imaging.c -o build/temp.macosx-10.15-x86_64-3.7/src/_imaging.o
[pillow-5.3.0.p0] error: $MACOSX_DEPLOYMENT_TARGET mismatch: now "10.9" but "10.15" during configure
[pillow-5.3.0.p0] ********************************************************************************
```

This is coming from the fake `MACOSX_DEPLOYMENT_TARGET` set in `sage-env`. See #18272, #7095, #18254, #16312.


---

Comment by git created at 2020-01-15 22:08:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-15 22:09:09

Replying to [comment:16 dimpase]:
> I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
> and it broke at docbuild, with
> {{{
> RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
> }}}
> even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)
Fixed now.


---

Comment by git created at 2020-01-16 00:49:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-01-16 02:03:11

Compiles OK on macOS with homebrew. `make ptestlong` mostly good except for
- GLPK output (spkg-configure should really reject a libglpk that talks too much) - it makes it hard to see actual failures
- and numerical failures in `src/sage/matrix/matrix2.pyx`, `src/sage/finance/time_series.pyx`, and `src/sage/schemes/affine/affine_homset.py` as reported in #29013

```
sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed
sage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed
sage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
```



---

Comment by git created at 2020-01-16 03:05:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-16 08:16:58

Replying to [comment:24 mkoeppe]:
> Replying to [comment:16 dimpase]:
> > I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
> > and it broke at docbuild, with
> > {{{
> > RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
> > }}}
> > even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)
> Fixed now.

after this fix, it builds and passes most tests on Gentoo (some errors related to cryptominisat that I had installed, and it probably got broken in some way)


---

Comment by dimpase created at 2020-01-16 09:33:14

I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)

```
sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
**********************************************************************
File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
Failed example:
    solver = CryptoMiniSat()                                  # optional - cryptominisat
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
        from pycryptosat import Solver
    ModuleNotFoundError: No module named 'pycryptosat'
```

I wonder whether it uses a convoluted way to create python extensions, which got broken.


---

Comment by dimpase created at 2020-01-16 09:56:02

I see (on a system where cryptominisat package works) that it is one of few packages that get installed without a sub-directory named the same as package in site-packages:

```
sage: import pycryptosat
sage: print(pycryptosat.__file__)
/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so
sage: import numpy
sage: print(numpy.__file__)
/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/numpy/__init__.py
```


Not sure whether this is a bug on the package, or a bug in this branch.
On this branch I see (with `local=SAGE_LOCAL`)

```
$ ls local/lib/python3.7/site-packages/*
local/lib/python3.7/site-packages/pycryptosat-0.2.0-py3.7.egg-info  local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so
```

So it seems that this branch does not pick up anything from that location.


---

Comment by git created at 2020-01-16 14:47:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-16 16:29:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-01-16 18:07:39

What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear.  It seems to me another reason to avoid all the venv stuff...


---

Comment by embray created at 2020-01-16 18:36:08

So, all that `$VIRTUAL_ENV/bin/activate` does, essentially, is to set 3 environment variables: `PATH` (to which it inserts `$VIRTUAL_ENV/bin` in the front), `PS1` (which Sage also already sets when activating the sage environment), and the `$VIRTUAL_ENV` environment variable itself.

Other than that, the only thing that really makes a directory a virtualenv (with Python 3 + venv, I'm not counting the old virtualenv) is the presence of `pyvenv.cfg` in the install prefix.  The format of this file is more-or-less documented (albeit not very clearly) in https://docs.python.org/3/library/venv.html.  So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  That, and make `$SAGE_LOCAL/bin/python3` a symlink to the real python3.

Although not strictly necessary, it is also possibly helpful to third-party tools to set the `$VIRTUAL_ENV` environment variable.


---

Comment by mkoeppe created at 2020-01-16 18:47:17

Replying to [comment:34 embray]:
> What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. 

It is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.


---

Comment by mkoeppe created at 2020-01-16 18:52:25

Replying to [comment:35 embray]:
> So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  

This amounts to trying to upgrade python3's `venv` to something like a conda environment. This is what I avoid in #29013 on purpose - the `venv` is only used in a clean, documented way, using the documented tools.


---

Comment by dimpase created at 2020-01-16 18:54:04

writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.
The correct interface to `venv` is to use `venv`, I think.

(By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))


---

Comment by mkoeppe created at 2020-01-16 18:56:43

Replying to [comment:38 dimpase]:
> (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))
Glad we have this on record now for the software historians/archaeologists to discover :)


---

Comment by embray created at 2020-01-16 19:04:44

Replying to [comment:38 dimpase]:
> writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.
> The correct interface to `venv` is to use `venv`, I think.

That's not true.  It's documented both in the documentation for the `venv` module and the `site` module.  If you really want to avoid writing it by hand the `venv` module includes code for that as well.  This (with the _system_ Python 3) is effectively the same (albeit more opaque).  From within SAGE_ROOT, but without the sage environment activated:


```
$ python3 -c 'import venv; b = venv.EnvBuilder(); c = b.ensure_directories("local"); b.create_configuration(c)'
$ cat local/pyvenv.cfg
home = /usr/bin
include-system-site-packages = false
version = 3.6.8
```


but I think even that's overkill for now.


---

Comment by embray created at 2020-01-16 19:09:08

Replying to [comment:36 mkoeppe]:
> Replying to [comment:34 embray]:
> > What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. 
> 
> It is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.

But why do you need to make a virtualenv for that?  Why not run the system python directly?


---

Comment by mkoeppe created at 2020-01-16 19:13:52

Replying to [comment:41 embray]:
> But why do you need to make a virtualenv for that?  Why not run the system python directly?
On this ticket, the system python is not used directly but rather in a venv without site-packages.
Therefore the correct test is to test whether the module will be available in a venv.


---

Comment by mkoeppe created at 2020-01-16 19:14:43

I'll add this documentation to the branch.


---

Comment by dimpase created at 2020-01-16 19:16:22

Replying to [comment:39 mkoeppe]:
> Replying to [comment:38 dimpase]:
> > (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))
> Glad we have this on record now for the software historians/archaeologists to discover :)
it's here:
https://trac.sagemath.org/ticket/27824?version=0


---

Comment by git created at 2020-01-16 19:18:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-16 19:20:42

By the way, should I be checking for the ssl module too?


---

Comment by embray created at 2020-01-16 19:50:12

Replying to [comment:42 mkoeppe]:
> Replying to [comment:41 embray]:
> > But why do you need to make a virtualenv for that?  Why not run the system python directly?
> On this ticket, the system python is not used directly but rather in a venv without site-packages.
> Therefore the correct test is to test whether the module will be available in a venv.

But why?


---

Comment by embray created at 2020-01-16 19:52:55

Replying to [comment:47 embray]:
> Replying to [comment:42 mkoeppe]:
> > Replying to [comment:41 embray]:
> > > But why do you need to make a virtualenv for that?  Why not run the system python directly?
> > On this ticket, the system python is not used directly but rather in a venv without site-packages.
> > Therefore the correct test is to test whether the module will be available in a venv.
> 
> But why?

Wait, I misunderstood what you wrote at first.  I know why it uses a virtualenv.  What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?


---

Comment by mkoeppe created at 2020-01-16 19:59:35

Replying to [comment:48 embray]:
> What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?
Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.


---

Comment by mkoeppe created at 2020-01-16 20:02:29

Replying to [comment:46 mkoeppe]:
> By the way, should I be checking for the ssl module too?
I think I'll check for all modules mentioned in #27705.


---

Comment by embray created at 2020-01-16 20:14:35

Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 embray]:
> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?
> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.

So use `python3 -S` if you really want to be sure.  That disables site-packages.


---

Comment by embray created at 2020-01-16 20:21:07

An interesting discovery while playing around with this:  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.


---

Comment by embray created at 2020-01-16 20:24:08

FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...


---

Comment by git created at 2020-01-16 21:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-16 22:10:49

Replying to [comment:52 embray]:
>  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.
Thanks! I'll add this test.


---

Comment by git created at 2020-01-16 22:36:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-16 22:36:58

Also, of course, one needs the Python headers, on Ubuntu from `libpython3.7-dev`.


---

Comment by mkoeppe created at 2020-01-16 23:13:57

So I'll add a check that the distutils can actually build an extension.


---

Comment by git created at 2020-01-17 01:11:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by mkoeppe created at 2020-01-17 04:03:32

Testing with the attached Dockerfile on ubuntu bionic.

module and distutils checking seems to work correctly.

Got stuck at `scipy` install. 

```
[scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
```


Looks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.


---

Comment by mkoeppe created at 2020-01-17 04:26:32

Replying to [comment:60 mkoeppe]:
> Testing with the attached Dockerfile on ubuntu bionic.
> 
> module and distutils checking seems to work correctly.
> 
> Got stuck at `scipy` install. 
> {{{
> [scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
> }}}
> 
> Looks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.

`@`fbissey, based on your work on scipy configuration in #20157, would you be able to help with this?


---

Comment by fbissey created at 2020-01-17 04:38:05

You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.


---

Comment by dimpase created at 2020-01-17 10:42:32

Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 embray]:
> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?
> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.

I wonder about rationale for disabling system's `site-packages`.
Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?


---

Comment by mkoeppe created at 2020-01-17 12:16:00

> I wonder about rationale for disabling system's `site-packages`.
> Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?

It’s strictly for making this ticket easier because I don’t have to worry about getting the correct versions of all Python packages.
See #29023 for the next step - let’s discuss any issues regarding use of system site packages there.


---

Comment by embray created at 2020-01-17 12:37:54

Replying to [comment:64 mkoeppe]:
> 
> > I wonder about rationale for disabling system's `site-packages`.
> > Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?
> 
> It’s strictly for making this ticket easier because I don’t have to worry about getting the correct versions of all Python packages.
> See #29023 for the next step - let’s discuss any issues regarding use of system site packages there.

I agree here, it's much simpler for now to focus on using a "bare" Python as much as possible.  I think detecting and using system Python packages _is_ where we want to go, but it can get a bit hairier...


---

Comment by embray created at 2020-01-17 14:08:55

For the heck of it, I'm seeing how far I can get with a system Python 3.6.  I think anything less than 3.6 is almost definitely too old, but I have a feeling 3.6 might still be usable as a minimum.  The only major hassle I've had so far is ensuring that it uses UTF-8 encoding by default.


---

Comment by mkoeppe created at 2020-01-17 15:00:14

Replying to [comment:62 fbissey]:
> You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.
Thank you! The file is installed. I'll investigate why it is not enough.


---

Comment by embray created at 2020-01-17 17:14:08

Replying to [comment:53 embray]:
> FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...

Here's a prototype of my alternative approach: #29032

I admit it does not yet address as many issues as this ticket does, like all the site.cfg fixes with Numpy.  Personally I didn't need it, but if those fixes are necessary they can easily be applied to my ticket as well.


---

Comment by git created at 2020-01-17 18:03:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-17 18:04:59

(extracted from Erik's commit at #29032.)


---

Comment by git created at 2020-01-17 18:07:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-17 21:45:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-20 14:39:27

Replying to [comment:68 mkoeppe]:
> Replying to [comment:62 fbissey]:
> > You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.
> Thank you! The file is installed. I'll investigate why it is not enough.

I've created ticket #29051 for this (Paths configured in installed numpy `site.cfg [DEFAULT/ALL]` do not affect scipy)


---

Comment by git created at 2020-03-18 00:09:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-03-18 01:12:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-18 01:25:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-18 01:28:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-18 01:33:18

(pushed to wrong ticket, corrected)


---

Comment by git created at 2020-03-18 23:43:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-18 23:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-19 15:48:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-19 15:56:54

This ticket is no longer on top of #29013.


---

Comment by mkoeppe created at 2020-03-19 16:03:43

Tests run at https://github.com/mkoeppe/sage/actions/runs/58992626 and 
https://github.com/mkoeppe/sage/actions/runs/58992623


---

Comment by mkoeppe created at 2020-03-19 16:25:29

Changing status from new to needs_review.


---

Comment by git created at 2020-03-19 20:00:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-20 01:02:44

A successful test at: https://github.com/mkoeppe/sage/runs/520449412


---

Comment by mkoeppe created at 2020-03-22 03:22:22

Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138


---

Comment by mkoeppe created at 2020-03-22 09:23:43

Breaks python 2 builds


---

Comment by mkoeppe created at 2020-03-22 09:23:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-03-22 16:02:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-22 16:03:15

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-22 17:42:45

Ready for review


---

Comment by mkoeppe created at 2020-03-22 19:48:34

New tests at https://github.com/mkoeppe/sage/actions/runs/60877259; see also #29367


---

Comment by git created at 2020-03-23 00:47:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-23 00:48:18

Tests at https://github.com/mkoeppe/sage/actions/runs/61077298


---

Comment by dimpase created at 2020-03-23 14:04:45

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-23 14:04:45

Let's move this, looks good to me.


---

Comment by mkoeppe created at 2020-03-23 16:59:28

Thanks!


---

Comment by vbraun created at 2020-03-29 00:24:15

Resolution: fixed


---

Comment by mmezzarobba created at 2020-05-18 14:10:34

Hello everyone,

When trying to upgrade to 9.1.rc5, I'm seeing an issue that I suspect could be a side effect of this ticket.

For some reason my `sage/local/bin/python3.7` was a symlink to the system python binary. Sage decided it wanted to install its own python-3.7.3.p1, but that failed with a permission error on the symlink. After deleting the symlink, python builds and installs correctly. (I let the logs be overwritten, so I won't be able to provide much details — sorry.)

The overall Sage build still fails with an error about six not being found while building setuptools that I haven't yet investigated.


---

Comment by dimpase created at 2020-05-18 17:09:10

if you switch to py3 from py2, you probably need to run `./configure --with-python=3`

it is not clear what version you were on, but the changes to the build system were very substantial, so ymmv.


---

Comment by mkoeppe created at 2020-05-18 17:36:15

Yes, this is a known limitation. I have created #29708 (Fix switching between --with-system-python3 and --without-system-python3) for it. We shall fix it in 9.2.
