# Issue 20937: MPIR: Do not install two (almost) identical libraries (with --enable-gmpcompat)

archive/issues_020937.json:
```json
{
    "body": "CC:  @embray\n\nKeywords: libgmpxx libmpirxx gmp.h mpir.h\n\nWhen configuring MPIR with `--enable-gmpcompat` (which we do in Sage by default), (almost) the same files get installed under two different names:\n\n* `mpir.h` and `gmp.h` -- identical copies (no links)\n* `mpirxx.h` and `gmpxx.h` -- identical copies (no links)\n* `libmpir.a` and `libgmp.a` -- identical copies (no links)\n* `libmprixx.a` and `libgmpxx.a` -- identical copies (no links)\n\nMore critical, as of MPIR 2.7.2, on ELF systems:\n\n* `libmpir.so`[`.16`[`.6.2`]] and `libgmp.so`[`.16`[`.6.2`]]\n* `libmpirxx.so`[`.8`[`.4.2`]] and `libgmpxx.so`[`.8`[`.4.2`]]\n (Similar on Darwin and Cygwin.)\n\nThis can lead to weird and hard-to-debug errors if programs or libraries accidentally link to **both** libmpir and libgmp (which may also happen if a program or library links to libraries A and B where A just uses libmpir and B only libgmp); see for example [this thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87968).\n\nIssue created by migration from https://trac.sagemath.org/ticket/21174\n\n",
    "created_at": "2016-08-05T07:47:42Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "MPIR: Do not install two (almost) identical libraries (with --enable-gmpcompat)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20937",
    "user": "https://github.com/nexttime"
}
```
CC:  @embray

Keywords: libgmpxx libmpirxx gmp.h mpir.h

When configuring MPIR with `--enable-gmpcompat` (which we do in Sage by default), (almost) the same files get installed under two different names:

* `mpir.h` and `gmp.h` -- identical copies (no links)
* `mpirxx.h` and `gmpxx.h` -- identical copies (no links)
* `libmpir.a` and `libgmp.a` -- identical copies (no links)
* `libmprixx.a` and `libgmpxx.a` -- identical copies (no links)

More critical, as of MPIR 2.7.2, on ELF systems:

* `libmpir.so`[`.16`[`.6.2`]] and `libgmp.so`[`.16`[`.6.2`]]
* `libmpirxx.so`[`.8`[`.4.2`]] and `libgmpxx.so`[`.8`[`.4.2`]]
 (Similar on Darwin and Cygwin.)

This can lead to weird and hard-to-debug errors if programs or libraries accidentally link to **both** libmpir and libgmp (which may also happen if a program or library links to libraries A and B where A just uses libmpir and B only libgmp); see for example [this thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87968).

Issue created by migration from https://trac.sagemath.org/ticket/21174





---

archive/issue_comments_289272.json:
```json
{
    "body": "Typo.",
    "created_at": "2016-08-05T07:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289272",
    "user": "https://github.com/nexttime"
}
```

Typo.



---

archive/issue_comments_289273.json:
```json
{
    "body": "For the first four instances, we could simply install symbolic links (on systems that support that) from `*mpir*` to their respective `*gmp*` counterparts (maybe also hard links, but symlinks seem more appropriate).\n\nFor the shared libraries, on ELF systems (and presumably analogously on Darwin) it would be sufficient to install just the GMP-named libraries and symbolic links from `libmpir`[`xx`]`.so` to `libgmp`[`xx`]`.so`, respectively.\n\nThen the linker could (still) pick up `-lmpir` (aka `libmpir.so`, in a shared link) and would record `libgmp.so.16` as the soname in the `DT_NEEDED` tag; analogous for `-lmpirxx`.",
    "created_at": "2016-08-05T08:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289273",
    "user": "https://github.com/nexttime"
}
```

For the first four instances, we could simply install symbolic links (on systems that support that) from `*mpir*` to their respective `*gmp*` counterparts (maybe also hard links, but symlinks seem more appropriate).

For the shared libraries, on ELF systems (and presumably analogously on Darwin) it would be sufficient to install just the GMP-named libraries and symbolic links from `libmpir`[`xx`]`.so` to `libgmp`[`xx`]`.so`, respectively.

Then the linker could (still) pick up `-lmpir` (aka `libmpir.so`, in a shared link) and would record `libgmp.so.16` as the soname in the `DT_NEEDED` tag; analogous for `-lmpirxx`.



---

archive/issue_comments_289274.json:
```json
{
    "body": "For the static libraries, it is less likely that accidentally (or unawarely) linking to both (as mentioned in the description, with libraries A and B for example) will cause trouble, although that's not impossible.\n\n(Shared libraries could as well have linked to one of the static libraries, reexporting symbols from GMP/MPIR, but that would presumably be a mistake by itself.)",
    "created_at": "2016-08-05T08:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289274",
    "user": "https://github.com/nexttime"
}
```

For the static libraries, it is less likely that accidentally (or unawarely) linking to both (as mentioned in the description, with libraries A and B for example) will cause trouble, although that's not impossible.

(Shared libraries could as well have linked to one of the static libraries, reexporting symbols from GMP/MPIR, but that would presumably be a mistake by itself.)



---

archive/issue_comments_289275.json:
```json
{
    "body": "I'll probably suggest a patch upstream adding at least a `configure` option `--only-gmpcompat` which would not install any of the `*mpir*` files in addition.",
    "created_at": "2016-08-05T08:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289275",
    "user": "https://github.com/nexttime"
}
```

I'll probably suggest a patch upstream adding at least a `configure` option `--only-gmpcompat` which would not install any of the `*mpir*` files in addition.



---

archive/issue_comments_289276.json:
```json
{
    "body": "+1 to all of the above.\n\nThough within Sage itself, if we have taken care to remove explicit \"mpir\" references then maybe even the symlinks shouldn't be necessary.  I have a patch to Singular that I will post in a separate ticket that removes the dangling \"mpir\" references that caused the problem in the first place.",
    "created_at": "2016-08-05T11:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289276",
    "user": "https://github.com/embray"
}
```

+1 to all of the above.

Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.  I have a patch to Singular that I will post in a separate ticket that removes the dangling "mpir" references that caused the problem in the first place.



---

archive/issue_comments_289277.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> +1 to all of the above.\n> \n> Though within Sage itself, if we have taken care to remove explicit \"mpir\" references then maybe even the symlinks shouldn't be necessary.\n\nI don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate \"Sage libraries\" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed \"system-wide\".\n\n\\\\\n\n> I have a patch to Singular that I will post in a separate ticket that removes the dangling \"mpir\" references that caused the problem in the first place.\n\nCC me then.",
    "created_at": "2016-08-05T14:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289277",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:6 embray]:
> +1 to all of the above.
> 
> Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.

I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed "system-wide".

\\

> I have a patch to Singular that I will post in a separate ticket that removes the dangling "mpir" references that caused the problem in the first place.

CC me then.



---

archive/issue_comments_289278.json:
```json
{
    "body": "Replying to [comment:7 leif]:\n> Replying to [comment:6 embray]:\n> > +1 to all of the above.\n> > \n> > Though within Sage itself, if we have taken care to remove explicit \"mpir\" references then maybe even the symlinks shouldn't be necessary.\n> \n> I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate \"Sage libraries\" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed \"system-wide\".\n\nI don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.",
    "created_at": "2016-08-08T07:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289278",
    "user": "https://github.com/embray"
}
```

Replying to [comment:7 leif]:
> Replying to [comment:6 embray]:
> > +1 to all of the above.
> > 
> > Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.
> 
> I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed "system-wide".

I don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.



---

archive/issue_comments_289279.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Replying to [comment:7 leif]:\n> > Replying to [comment:6 embray]:\n> > > +1 to all of the above.\n> > > \n> > > Though within Sage itself, if we have taken care to remove explicit \"mpir\" references then maybe even the symlinks shouldn't be necessary.\n> > \n> > I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate \"Sage libraries\" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed \"system-wide\".\n> \n> I don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.\n\nNo idea, I thought I had read something like that a while ago.\n\nSo you're in favour of not installing links (which AFAIK wouldn't be possible on Cygwin anyway)?",
    "created_at": "2016-08-08T12:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289279",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:8 embray]:
> Replying to [comment:7 leif]:
> > Replying to [comment:6 embray]:
> > > +1 to all of the above.
> > > 
> > > Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.
> > 
> > I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have *both* MPIR and GMP installed "system-wide".
> 
> I don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.

No idea, I thought I had read something like that a while ago.

So you're in favour of not installing links (which AFAIK wouldn't be possible on Cygwin anyway)?



---

archive/issue_comments_289280.json:
```json
{
    "body": "No, links work in Cygwin.  Hard links and symlinks.",
    "created_at": "2016-08-09T08:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289280",
    "user": "https://github.com/embray"
}
```

No, links work in Cygwin.  Hard links and symlinks.



---

archive/issue_comments_289281.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> No, links work in Cygwin.  Hard links and symlinks.\n\nGood to know, one thing less to care about (in general).",
    "created_at": "2016-08-09T13:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289281",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:11 embray]:
> No, links work in Cygwin.  Hard links and symlinks.

Good to know, one thing less to care about (in general).



---

archive/issue_comments_289282.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-10T20:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289282",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_289283.json:
```json
{
    "body": "outdated after mpir removal in #32549",
    "created_at": "2021-10-10T20:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289283",
    "user": "https://github.com/mkoeppe"
}
```

outdated after mpir removal in #32549



---

archive/issue_events_056492.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-10T20:17:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20937#event-56492"
}
```



---

archive/issue_comments_289284.json:
```json
{
    "body": "Ok.",
    "created_at": "2021-10-25T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289284",
    "user": "https://github.com/slel"
}
```

Ok.



---

archive/issue_comments_289285.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-25T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289285",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_056493.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-25T15:39:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20937#event-56493"
}
```



---

archive/issue_comments_289286.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-10-25T15:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20937#issuecomment-289286",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid
