# Issue 20937: MPIR: Do not install two (almost) identical libraries (with --enable-gmpcompat)

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2016-08-05 07:47:42

CC:  embray

Keywords: libgmpxx libmpirxx gmp.h mpir.h

When configuring MPIR with `--enable-gmpcompat` (which we do in Sage by default), (almost) the same files get installed under two different names:

 * `mpir.h` and `gmp.h` -- identical copies (no links)
 * `mpirxx.h` and `gmpxx.h` -- identical copies (no links)
 * `libmpir.a` and `libgmp.a` -- identical copies (no links)
 * `libmprixx.a` and `libgmpxx.a` -- identical copies (no links)

More critical, as of MPIR 2.7.2, on ELF systems:

 * `libmpir.so`[`.16`[`.6.2`]] and `libgmp.so`[`.16`[`.6.2`]]
 * `libmpirxx.so`[`.8`[`.4.2`]] and `libgmpxx.so`[`.8`[`.4.2`]]
 (Similar on Darwin and Cygwin.)

This can lead to weird and hard-to-debug errors if programs or libraries accidentally link to *both* libmpir and libgmp (which may also happen if a program or library links to libraries A and B where A just uses libmpir and B only libgmp); see for example [this thread on sage-devel](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/87968).


---

Comment by leif created at 2016-08-05 07:49:22

Typo.


---

Comment by leif created at 2016-08-05 08:24:28

For the first four instances, we could simply install symbolic links (on systems that support that) from `*mpir*` to their respective `*gmp*` counterparts (maybe also hard links, but symlinks seem more appropriate).

For the shared libraries, on ELF systems (and presumably analogously on Darwin) it would be sufficient to install just the GMP-named libraries and symbolic links from `libmpir`[`xx`]`.so` to `libgmp`[`xx`]`.so`, respectively.

Then the linker could (still) pick up `-lmpir` (aka `libmpir.so`, in a shared link) and would record `libgmp.so.16` as the soname in the `DT_NEEDED` tag; analogous for `-lmpirxx`.


---

Comment by leif created at 2016-08-05 08:36:25

For the static libraries, it is less likely that accidentally (or unawarely) linking to both (as mentioned in the description, with libraries A and B for example) will cause trouble, although that's not impossible.

(Shared libraries could as well have linked to one of the static libraries, reexporting symbols from GMP/MPIR, but that would presumably be a mistake by itself.)


---

Comment by leif created at 2016-08-05 08:44:15

I'll probably suggest a patch upstream adding at least a `configure` option `--only-gmpcompat` which would not install any of the `*mpir*` files in addition.


---

Comment by embray created at 2016-08-05 11:12:42

+1 to all of the above.

Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.  I have a patch to Singular that I will post in a separate ticket that removes the dangling "mpir" references that caused the problem in the first place.


---

Comment by leif created at 2016-08-05 14:43:28

Replying to [comment:6 embray]:
> +1 to all of the above.
> 
> Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.

I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have _both_ MPIR and GMP installed "system-wide".

\\

> I have a patch to Singular that I will post in a separate ticket that removes the dangling "mpir" references that caused the problem in the first place.

CC me then.


---

Comment by embray created at 2016-08-08 07:49:41

Replying to [comment:7 leif]:
> Replying to [comment:6 embray]:
> > +1 to all of the above.
> > 
> > Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.
> 
> I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have _both_ MPIR and GMP installed "system-wide".

I don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.


---

Comment by leif created at 2016-08-08 12:29:45

Replying to [comment:8 embray]:
> Replying to [comment:7 leif]:
> > Replying to [comment:6 embray]:
> > > +1 to all of the above.
> > > 
> > > Though within Sage itself, if we have taken care to remove explicit "mpir" references then maybe even the symlinks shouldn't be necessary.
> > 
> > I don't have a strong opinion on whether to install links or not; without them, we hopefully won't run into the mess you had again, but I'm open for different solutions on Cygwin anyway (I cannot test myself).  IIRC on Cygwin it's harder to separate "Sage libraries" from the system's, and it's probably not uncommon for Cygwin users to have _both_ MPIR and GMP installed "system-wide".
> 
> I don't agree, no.  It's not harder to separate, and there's no reason Cygwin users should have both installed any more than anyone else.

No idea, I thought I had read something like that a while ago.

So you're in favour of not installing links (which AFAIK wouldn't be possible on Cygwin anyway)?


---

Comment by embray created at 2016-08-09 08:57:56

No, links work in Cygwin.  Hard links and symlinks.


---

Comment by leif created at 2016-08-09 13:06:59

Replying to [comment:11 embray]:
> No, links work in Cygwin.  Hard links and symlinks.

Good to know, one thing less to care about (in general).


---

Comment by mkoeppe created at 2021-10-10 20:17:55

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-10 20:17:55

outdated after mpir removal in #32549


---

Comment by slelievre created at 2021-10-25 10:49:52

Ok.


---

Comment by slelievre created at 2021-10-25 10:49:52

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-25 15:39:21

Resolution: invalid
