# Issue 12390: In Singular spkg-install, disable -pipe on SunOS

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-02-22 10:38:50

Assignee: tbd

CC:  drkirkby

The Sun assembler chokes when large files are sent to it via a pipe.  Singular by default builds with the -pipe option causing trouble.

In the spkg below, I also add a fix for #12311.

*spkg*: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p5.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p5.spkg)


---

Comment by jdemeyer created at 2012-02-22 10:42:42

Diff for the singular spkg, for review only


---

Attachment


---

Comment by jdemeyer created at 2012-02-22 10:43:00

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-03-02 22:31:04

The change here makes sense, although I don't remember seeing a problem with singular on Solaris before. This builds on one OpenSolaris machine, and I'm currently building it on a (slow) Solaris machine. It also works on OS X (as tested in #12369).


---

Comment by jdemeyer created at 2012-03-03 13:46:03

Replying to [comment:2 jhpalmieri]:
> The change here makes sense, although I don't remember seeing a problem with singular on Solaris before.
Probably because you don't use the Sun assembler.

> This builds on one OpenSolaris machine
using the GNU assembler.


---

Comment by jhpalmieri created at 2012-03-03 16:40:24

I didn't know we even supported building Sage on Solaris using gcc and the Sun assembler.


---

Comment by jdemeyer created at 2012-03-04 07:40:18

Replying to [comment:4 jhpalmieri]:
> I didn't know we even supported building Sage on Solaris using gcc and the Sun assembler.

I didn't know either, but I tried it and this ticket is the only issue I encountered.


---

Comment by jhpalmieri created at 2012-03-05 04:29:18

Dave, can you take a look at this?

Jeroen, in case Dave doesn't have time, do you have suggestions about how to test this?  On the skynet machine mark, I can try setting the path so that it uses

```
export PATH=/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld/bin:$PATH

export LD_LIBRARY_PATH=/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld/lib:/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld/lib/sparcv9:/usr/local/flex-2.5.35/sparc-SunOS-ultrasparc3-gcc-4.4.3/lib
```

with corresponding settings for `SAGE_FORTRAN` and `SAGE_FORTRAN_LIB`. Will that use the Sun assembler? (By the way, with the default PATH etc. on that machine, I have troubles building libpng...)


---

Comment by jdemeyer created at 2012-03-05 08:10:21

Replying to [comment:6 jhpalmieri]:
> Will that use the Sun assembler?

No, the assembler/linker executables are hardcoded when GCC is compiled.  You can see this by:

```
jdemeyer`@`mark:~$ gcc -print-prog-name=as
/usr/local/binutils-2.20.1/sparc-SunOS-ultrasparc3-gcc-4.4.3/bin/as
```

This means that gcc will always use that assembler, which is the GNU assembler:

```
jdemeyer`@`mark:~$ /usr/local/binutils-2.20.1/sparc-SunOS-ultrasparc3-gcc-4.4.3/bin/as --version
GNU assembler (GNU Binutils) 2.20.1.20100303
Copyright 2009 Free Software Foundation, Inc.
This program is free software; you may redistribute it under the terms of
the GNU General Public License version 3 or later.
This program has absolutely no warranty.
This assembler was configured for a target of `sparc-sun-solaris2.10'.
```


I encountered the problem on this ticket while testing #12369.  The default `as` in the PATH is

```
jdemeyer`@`mark:~$ which as
/usr/ccs/bin/as
jdemeyer`@`mark:~$ as -V
as: Sun Compiler Common 10 Patch 05/06/2005
```


So, when compiling GCC, that assembler will be used by default.  This can be overridden using the `AS` environment variable (similarly `LD` for the linker).


---

Comment by jhpalmieri created at 2012-03-05 21:30:00

Okay, I'll set `SAGE_INSTALL_GCC` to "yes" on a few machines and build using the tar ball from #12369, and I'll also try to install the old Singular spkg in the resulting Sage installation.


---

Comment by jhpalmieri created at 2012-03-06 02:58:49

On hawk (OpenSolaris on x86), after installing beta7 from #12369 with `SAGE_INSTALL_GCC=yes`, and while running `sage -sh`:

```
$ gcc -print-prog-name=as
/usr/ccs/bin/as
```

Then singular-3-1-3-3.p4 fails to build, while singular-3-1-3-3.p5 succeeds. 

I'm also trying on mark, and things there are a little strange: on one hand, the Sage built took only two hours, which is much faster than usual -- an earlier build took 12 hours. Either they upgraded the machine, or the standard gcc build on mark is badly configured, or something else is strange. Tests seem to be going fine (with the Singular spkg from this ticket). On the other hand, if I just try to run Sage, I see this:

```
$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
/home/palmieri/mark/sage-5.0.beta7-gcc/local/lib/python/site.py:158: Warning: 'with' will become a reserved keyword in Python 2.6
'import site' failed; use -v for traceback
/home/palmieri/mark/sage-5.0.beta7-gcc/local/lib/python/linecache.py:127: Warning: 'with' will become a reserved keyword in Python 2.6
/home/palmieri/mark/sage-5.0.beta7-gcc/local/bin/sage-location:185: Warning: 'with' will become a reserved keyword in Python 2.6
  File "/home/palmieri/mark/sage-5.0.beta7-gcc/local/bin/sage-location", line 185
    with open(filename) as file:
            ^
SyntaxError: invalid syntax
```

If I run `./sage -sh` and then `gcc`, I see this:

```
$ gcc
bash: /home/palmieri/mark/sage-5.0.beta7-gcc/local/bin/gcc: Invalid argument
```

Not related to this ticket, but obviously something strange is happening on mark.


---

Comment by jhpalmieri created at 2012-03-06 20:12:09

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-03-06 20:12:09

The issues with mark seem to have cleared themselves up somehow. My findings:

 - With hawk, the spkg here builds while the old one doesn't.

 - With mark and mark2 (Solaris on sparc), both seem to build.

So I think this can get a positive review.


---

Comment by jdemeyer created at 2012-03-13 08:24:20

Resolution: fixed
