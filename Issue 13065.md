# Issue 13065: Upgrade Singular

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-07-12 14:01:11

Assignee: tbd

CC:  fbissey malb jpflori

Upgrade Singular to version 3-1-5 (release 12 July 2012).


---

Comment by leif created at 2012-07-12 15:26:19

Changing keywords from "" to "spkg".


---

Comment by jdemeyer created at 2012-07-25 14:39:16

Changing keywords from "spkg" to "Singular spkg".


---

Comment by leif created at 2012-07-25 15:07:38


```
checking for FLINT >= 2.3... not found
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
```


:P

And lots of other warnings...


---

Comment by leif created at 2012-07-25 17:14:17

Replying to [comment:6 leif]:
> And lots of other warnings...

These are the ones I get from `configure` and `config.status`:

```
configure: warning: Building of doc might fail. Need Texinfo
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --without-MP, --without-lex, --without-bison, --without-Boost, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-factory, --with-libfac
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
config.status: WARNING:  'GNUmakefile.in' seems to ignore the --datarootdir setting
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --without-MP, --without-lex, --without-bison, --without-Boost, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-factory, --with-libfac
configure: warning: factory.h not found! Install factory before building libfac!
configure: WARNING: unrecognized options: --with-gmp, --with-ntl, --without-bison, --enable-gmp, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-Singular
configure: WARNING: building without lex -- make might fail
configure: WARNING: building without python support
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
configure: WARNING: unrecognized options: --with-gmp, --with-ntl, --without-bison, --enable-gmp, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-Singular
configure: warning: Building of doc might fail. Need Texinfo
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --without-MP, --without-lex, --without-bison, --without-Boost, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-factory, --with-libfac
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
config.status: WARNING:  'GNUmakefile.in' seems to ignore the --datarootdir setting
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --without-MP, --without-lex, --without-bison, --without-Boost, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-factory, --with-libfac
configure: warning: factory.h not found! Install factory before building libfac!
configure: WARNING: unrecognized options: --with-gmp, --with-ntl, --without-bison, --enable-gmp, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-Singular
configure: WARNING: building without lex -- make might fail
configure: WARNING: building without python support
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
configure: WARNING: unrecognized options: --with-gmp, --with-ntl, --without-bison, --enable-gmp, --enable-Singular, --enable-factory, --enable-libfac, --enable-IntegerProgramming, --disable-doc, --with-malloc, --disable-debug, --enable-omalloc, --with-external-config_h, --with-track-custom, --enable-Plural, --with-Singular
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --disable-debug
configure: WARNING: Unable to find FLINT (which is strongly recommended) on your machine: please use --with-flint=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
config.status: WARNING:  'GNUmakefile.in' seems to ignore the --datarootdir setting
configure: WARNING: unrecognized options: --with-apint, --with-ntl, --disable-debug
```


The unrecognized options should be addressed I think.

No idea how to interpret _"`factory.h` not found! Install factory before building libfac!"_, as the build succeeded.

_"Building without python support"_ can safely be ignored I guess, as we use our own Cython wrappers.


---

Comment by jdemeyer created at 2012-07-26 13:26:03

Replying to [comment:7 leif]:
> The unrecognized options should be addressed I think.
I fixed the fixable warnings.  Many of them are caused by recursive calling of `configure`, for example, the top-level `configure` calls `omalloc/configure`.  Many options are supported by some (but not all) `configure` scripts.  These will give warnings and I don't see how to avoid these.


---

Comment by leif created at 2012-07-26 13:46:01

I assume that this is work in progress (i.e., you haven't tried to fix doctest errors yet).

Anyway, here's what I got on Ubuntu 10.04.4 LTS x86_64, with Sage 5.2.rc0 and GCC 4.7.0:

```
The following tests failed:

	sage -t  --long -force_lib devel/sage/doc/en/constructions/polynomials.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/rings/function_field/function_field.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx # 3 doctests failed
	sage -t  --long -force_lib devel/sage/sage/rings/polynomial/multi_polynomial_ideal.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/calculus/wester.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/libs/singular/function.pyx # 2 doctests failed
	sage -t  --long -force_lib devel/sage/sage/combinat/words/words.py # 0 doctests failed
```

(The last failure was a segfault with a large traceback IIRC.  Somewhat surprisingly successfully compiled with `-O3`, although many if not most compile commands override this by `-O2`; looks as if they use `CPPFLAGS` _instead of_ `CXXFLAGS` in some parts.) 

Let me know in case you're interested in further output; I guess you can reproduce most of the errors.


---

Comment by jdemeyer created at 2012-07-26 13:52:15

Replying to [comment:10 leif]:
> I assume that this is work in progress (i.e., you haven't tried to fix doctest errors yet).

Exactly, I mainly worked on `spkg-install`.


---

Comment by jdemeyer created at 2012-07-26 14:05:37

This is a new *bug*, the new answer is incorrect:

```
sage -t  --long -force_lib devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx
**********************************************************************
File "/release/merger/sage-5.2.rc1/devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3856:
    sage: p.factor()
Expected:
    (-2*v^2*u + 4*u^3 + v^2)^2
Got:
    (4) * (-2*v^2*u + 4*u^3 + v^2)^2
**********************************************************************
```



---

Comment by leif created at 2012-07-26 14:15:39

Replying to [comment:12 jdemeyer]:
> This is a new *bug*, the new answer is incorrect:
> {{{
> Expected:
>     (-2*v^2*u + 4*u^3 + v<sup>2)</sup>2
> Got:
>     (4) * (-2*v^2*u + 4*u^3 + v<sup>2)</sup>2
> }}}

Yes, the most obvious one... :-)

Just noticed the failure in `words.py` apparently isn't reproducible.  Traceback was

```

${SAGE_LOCAL}/lib/libcsage.so(print_backtrace+0x31)[0x2abd9e8f6664]
${SAGE_LOCAL}/lib/libcsage.so(sigdie+0x14)[0x2abd9e8f6696]
${SAGE_LOCAL}/lib/libcsage.so(sage_signal_handler+0x218)[0x2abd9e8f6250]
/lib/libpthread.so.0(+0xf8f0)[0x2abd9c9158f0]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(+0x135020)[0x2abd9c628020]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(+0x76aa7)[0x2abd9c569aa7]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(+0x1352b7)[0x2abd9c6282b7]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(_PyObject_GC_Malloc+0x115)[0x2abd9c6292b5]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(_PyObject_GC_New+0xd)[0x2abd9c6292ed]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(PyCFunction_NewEx+0xc5)[0x2abd9c584f05]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(Py_InitModule4_64+0x140)[0x2abd9c60bc60]
${SAGE_LOCAL}/lib/python/site-packages/numpy/core/multiarray.so(initmultiarray+0x2b)[0x2abdcd07186b]
${SAGE_LOCAL}/lib/libpython2.7.so.1.0(_PyImport_LoadDynamicModule+0x99)[0x2abd9c6073b9]
...
Segmentation fault
```



---

Comment by jdemeyer created at 2012-07-26 15:52:17

Another Singular bug:

```
sage -t --long "devel/sage/sage/rings/function_field/function_field.py"
**********************************************************************
File "/release/merger/sage-5.2.rc1/devel/sage/sage/rings/function_field/function_field.py", line 1132:
    sage: f.factor()
Expected:
    (1/t) * (X + 3*t) * (X + 5*t) * (X + 6*t) * (X^2 + 1/t) * (X^2 + 6/t)
Got:
    (1/t) * (X + 3*t) * (X + 5*t) * (X + 6*t) * (X^4 + 6/t^2)
**********************************************************************
```

Reported upstream at [http://www.singular.uni-kl.de:8002/trac/ticket/440](http://www.singular.uni-kl.de:8002/trac/ticket/440).


---

Comment by jdemeyer created at 2012-08-01 11:25:30

New spkg, adds fixes for Singular bugs 439 and 440.


---

Comment by jdemeyer created at 2012-08-01 12:22:10

Reproducible doctest failure:

```
**********************************************************************
File "/release/merger/sage-5.3.beta0/devel/sage-main/sage/libs/singular/function.pyx", line 1569:
    sage: singular_list(2, 3, 6, ring=P)
Exception raised:
    Traceback (most recent call last):
      File "/release/merger/sage-5.3.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/release/merger/sage-5.3.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/release/merger/sage-5.3.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_72[16]>", line 1, in <module>
        singular_list(Integer(2), Integer(3), Integer(6), ring=P)###line 1569:
    sage: singular_list(2, 3, 6, ring=P)
      File "function.pyx", line 1248, in sage.libs.singular.function.SingularFunction.__call__ (sage/libs/singular/function.cpp:11875)
        return call_function(self, args, ring, interruptible, attributes)
      File "function.pyx", line 1438, in sage.libs.singular.function.call_function (sage/libs/singular/function.cpp:13425)
        raise RuntimeError("Error in Singular function call '%s':\n%s"%(self._name,
    RuntimeError: Error in Singular function call 'list':
     list(`int`,`int`,`int`) failed
**********************************************************************
File "/release/merger/sage-5.3.beta0/devel/sage-main/sage/libs/singular/function.pyx", line 1585:
    sage: singular_list((1,2,3),3,[1,2,3], ring=P)
Exception raised:
    Traceback (most recent call last):
      File "/release/merger/sage-5.3.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/release/merger/sage-5.3.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/release/merger/sage-5.3.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_72[26]>", line 1, in <module>
        singular_list((Integer(1),Integer(2),Integer(3)),Integer(3),[Integer(1),Integer(2),Integer(3)], ring=P)###line 1585:
    sage: singular_list((1,2,3),3,[1,2,3], ring=P)
      File "function.pyx", line 1248, in sage.libs.singular.function.SingularFunction.__call__ (sage/libs/singular/function.cpp:11875)
        return call_function(self, args, ring, interruptible, attributes)
      File "function.pyx", line 1438, in sage.libs.singular.function.call_function (sage/libs/singular/function.cpp:13425)
        raise RuntimeError("Error in Singular function call '%s':\n%s"%(self._name,
    RuntimeError: Error in Singular function call 'list':
     list(`intvec`,`int`,`list`) failed
**********************************************************************
```


Non-reproducible doctest failure:

```
**********************************************************************
File "/release/merger/sage-5.3.beta0/devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3921:
    sage: f.factor()
Expected:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a)*x^8 + (a)*y^4)
Got:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a + 1)*x^8 + (a + 1)*y^4)
**********************************************************************
```



---

Comment by leif created at 2012-08-01 15:31:04

So far I only tested the files that previously failed for me (with the new spkg and the Sage library patch applied).

I get the same `list()` errors (although prepended by some debug output it seems, before the doctest error is printed), and sporadically the `f.factor()` error -- with *varying* results:


```
sage -t --long -force_lib "devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx"
**********************************************************************
File "${SAGE_ROOT}/devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3910:
    sage: f.factor()
Expected:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a)*x^8 + (a)*y^4)
Got:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a + 1)*x^8 + (a + 1)*y^4)
**********************************************************************
1 items had failures:
   1 of  86 in __main__.example_77
***Test Failed*** 1 failures.

sage -t --long -force_lib "devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx"
**********************************************************************
File "${SAGE_ROOT}/devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3910:
    sage: f.factor()
Expected:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a)*x^8 + (a)*y^4)
Got:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9)
**********************************************************************
1 items had failures:
   1 of  86 in __main__.example_77
***Test Failed*** 1 failures.

sage -t --long -force_lib "devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx"
**********************************************************************
File "${SAGE_ROOT}/devel/sage/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3910:
    sage: f.factor()
Expected:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a)*x^8 + (a)*y^4)
Got:
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + x^8 + y^4)
**********************************************************************
1 items had failures:
   1 of  86 in __main__.example_77
***Test Failed*** 1 failures.
```


(For me it's line 3910; presumably due to some other patch.  The first variant seems to occur more often.  All tests run sequentially, FWIW.)


P.S.: Run 100 times from the shell, the test failed 51 times.


---

Comment by leif created at 2012-08-01 15:36:43

Replying to [comment:21 leif]:
> P.S.: Run 100 times from the shell, the test failed 51 times.

(Running `sage -t ...` in a `for` loop.)


```
25x
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + (a + 1)*x^8 + (a + 1)*y^4)

15x
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9 + x^8 + y^4)

11x
    x * y^3 * (y^8 + (a)*y^7 + (a + 1)*x) * (x^7*y^3 + x*y^9)
```



---

Comment by jdemeyer created at 2012-08-01 19:45:24

Non-reproducible factoring bug reported upstream: [http://www.singular.uni-kl.de:8002/trac/ticket/441](http://www.singular.uni-kl.de:8002/trac/ticket/441)


---

Attachment

Patch for the Sage library


---

Comment by jdemeyer created at 2012-08-02 10:06:28

New patch fixes all doctest errors (except for the upstream factoring bug).


---

Comment by jdemeyer created at 2012-08-02 14:08:59

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-08-02 14:08:59

I added a patch for Singular Trac 441 (which is in the git sources, even though Trac hasn't been updated yet).

Needs review (the spkg will be committed after positive_review if that's okay).


---

Comment by AlexanderDreyer created at 2012-08-04 22:13:43

spkg and patch apply/install fine. Also the tests are fine. So I'm close to a positive review, just waiting for the patch from #12089.


---

Comment by leif created at 2012-08-04 23:39:15

Just for the record:  Did pass `ptestlong` (with a bit of luck, cf. the "random" factoring) with Sage 5.2[.rc0] (Ubuntu 10.04.4 LTS x86_64, FSF GCC 4.7.0, with `-O3`, see above).

Patch applies to Sage 5.3.beta0 as well (a few lines offset, never mind).

Only just noticed that old installations get removed before we even attempt to build the new one; this should in general only be done if the build succeeded.

(Haven't yet closely looked at [the changes to] `spkg-install`.)


---

Comment by leif created at 2012-08-05 05:01:18

Replying to [comment:35 leif]:
> Patch applies to Sage 5.3.beta0 as well (a few lines offset, never mind).

`ptestlong` also passed without errors, but took longer than usual (despite the machine being otherwise idle).


---

Comment by jpflori created at 2012-08-05 16:23:28

It would be nice to fix #13344 as well in this ticket.
Hopefully the problem should be tracked down quite quickly.


---

Comment by dimpase created at 2012-08-05 18:10:57

Replying to [comment:37 jpflori]:
> It would be nice to fix #13344 as well in this ticket.
> Hopefully the problem should be tracked down quite quickly.

yes, I can confirm that installing this spkg on MacOSX one gets Singular LIB files into `SAGELOCAL/lib/`, as well as in the right place, i.e. `SAGELOCAL/share/singular/`, which is certainly not what one would want.


---

Comment by dimpase created at 2012-08-05 18:10:57

Changing status from needs_review to needs_work.


---

Comment by AlexanderDreyer created at 2012-08-05 18:35:48

Replying to [comment:38 dimpase]:
> yes, I can confirm that installing this spkg on MacOSX one gets Singular LIB files into `SAGELOCAL/lib/`, as well as in the right place, i.e. `SAGELOCAL/share/singular/`, which is certainly not what one would want.
>  
It think the best solution would be to replace `$MAKE` by "$MAKE slibdir=$SAGE_LOCAL/share/singular" in the spkg.


---

Comment by AlexanderDreyer created at 2012-08-05 18:36:58

Or maybe `"$MAKE slibdir=\"$SAGE_LOCAL/share/singular\""`?


---

Comment by AlexanderDreyer created at 2012-08-05 19:13:16

`@`jdemeyer I could take care for the changes, if you don't mind?


---

Comment by AlexanderDreyer created at 2012-08-05 20:59:10

Just in case (won't have time tomorrow), I was so free to propose a changed spkg here: http://boxen.math.washington.edu/home/dreyer/spkg/singular-3-1-5.p0.spkg 

As before, the changes are not committed yet. Also I haven't changes the URL in the description, as Jeroen might continue with other fixes.

The changes are as follows (for review):
{{{ #!diff
--- singular-3-1-5.p0.old.diff	2012-08-05 22:36:36.000000000 +0200
+++ singular-3-1-5.p0.new.diff	2012-08-05 22:47:29.000000000 +0200
`@``@` -9,7 +9,7 `@``@`
 diff -r 1275ac543b53 SPKG.txt
 --- a/SPKG.txt	Sat Mar 17 11:18:23 2012 +0100
 +++ b/SPKG.txt	Sun Aug 05 22:36:36 2012 +0200
-`@``@` -30,14 +30,17 `@``@`
+`@``@` -30,14 +30,19 `@``@`
  See spkg-changes for how to delete unnecessary stuff under src/
  
  Several patches are applied. 
`@``@` -32,10 +32,12 `@``@`
 +   http://www.singular.uni-kl.de:8002/trac/ticket/440
 + * singular_trac_441.patch: fix taken from upstream for
 +   http://www.singular.uni-kl.de:8002/trac/ticket/441
++ * sage_trac_12089.patch: fix (also reported upstream) from
++   https://github.com/alexanderdreyer/SingularSources/commit/7902222
  
  Other notes 
   * The option '--without-dynamic-kernel' is used on *all* 
-`@``@` -51,9 +54,51 `@``@`
+`@``@` -51,9 +56,54 `@``@`
     investigated as a possible cause later. 
   * Be sure that Singular/Singular.rc.in is present, as occasionally this
     was missing, which caused problems on Cygwin (e.g., see #10235)
`@``@` -49,7 +51,7 `@``@`
  
  == ChangeLog ==
  
-+=== singular-3-1-5.p0 (Jeroen Demeyer, 2 August 2012) ===
++=== singular-3-1-5.p0 (Jeroen Demeyer, 5 August 2012) ===
 + * Trac #13237: Upgrade to version 3-1-5.
 + * Removed patches which are now upstreamed:
 +    - patches/Singular.Makefile.in.shared.patch
`@``@` -70,8 +72,11 `@``@`
 +    - singular_trac_439.patch
 +    - singular_trac_440.patch
 +    - singular_trac_441.patch
++    - sage_trac_12089.patch
 + * In spkg-install, remove distclean() step; merge clean_headers() and
 +   part of the old distclean() into remove_old_version().
++ * In spkg-install, added slibdir="$SAGE_LOCAL/share/singular" to 
++   $MAKE install-libsingular .
 + * Only unset LD on Darwin.
 + * Remove the unsetting of TMPDIR (bug fixed upstream).
 + * Do not override user-set CFLAGS and CXXFLAGS.
`@``@` -6812,6 +6817,39 `@``@`
 - #if defined(ix86Mac_darwin)
 - #define HAVE_ELF_SYSTEM
 - #endif
+diff -r 1275ac543b53 patches/sage_trac_12089.patch
+--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
++++ b/patches/sage_trac_12089.patch	Sun Aug 05 22:36:36 2012 +0200
+`@``@` -0,0 +1,29 `@``@`
++From 7902222c6e73d452b3d75576bd9bc0140f5e827a Mon Sep 17 00:00:00 2001
++From: Alexander Dreyer <alexander.dreyer`@`itwm.fraunhofer.de>
++Date: Sat, 4 Aug 2012 21:53:32 +0200
++Subject: [PATCH] fix: apply LDFLAGS fixes from svn#13210/git#b1dfafe to cygwin-specific flags (Sage's trac #12089; reported by Jean-Pierre Flori)
++
++---
++ Singular/Makefile.in |    6 +++---
++ 1 files changed, 3 insertions(+), 3 deletions(-)
++
++diff --git a/Singular/Makefile.in b/Singular/Makefile.in
++index c4a6e78..b907085 100644
++--- a/Singular/Makefile.in
+++++ b/Singular/Makefile.in
++`@``@` -90,9 +90,9 `@``@` LDFLAGSG	= -L`@`prefix`@`/kernel -L../kernel -lkernel_g `@`LD_DYN_FLAGS1`@` `@`LDFLAGS`@`
++ LDFLAGSP	= -L`@`prefix`@`/kernel -L../kernel -lkernel_p `@`LD_DYN_FLAGS1`@` `@`LDFLAGS`@` 
++ else
++ ## -L/usr/local/lib -L`@`prefix`@`/modules/python --> PySingular
++-LDFLAGS		= -L`@`prefix`@`/kernel -L/bin -lkernel `@`LDFLAGS`@` -L/usr/local/lib -L../modules/python 
++-LDFLAGSG	= -L`@`prefix`@`/kernel -L/bin -lkernel_g `@`LDFLAGS`@` 
++-LDFLAGSP	= -L`@`prefix`@`/kernel -L/bin -lkernel_p `@`LDFLAGS`@` 
+++LDFLAGS		= -L`@`prefix`@`/kernel -L../kernel -L/bin -lkernel `@`LDFLAGS`@` -L/usr/local/lib -L../modules/python 
+++LDFLAGSG	= -L`@`prefix`@`/kernel -L../kernel -L/bin -lkernel_g `@`LDFLAGS`@` 
+++LDFLAGSP	= -L`@`prefix`@`/kernel -L../kernel -L/bin -lkernel_p `@`LDFLAGS`@` 
++ endif
++ LD_DYN_FLAGS1	= `@`LD_DYN_FLAGS1`@`
++ LD_DYN_FLAGS2	= `@`LD_DYN_FLAGS2`@`
++-- 
++1.6.0.2
++
 diff -r 1275ac543b53 patches/sing_win.cc.diff
 --- a/patches/sing_win.cc.diff	Sat Mar 17 11:18:23 2012 +0100
 +++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
`@``@` -7330,7 +7368,8 `@``@`
 +    config || return $?
  
      $MAKE clean
-     $MAKE install-libsingular
+-    $MAKE install-libsingular
++    $MAKE slibdir="$SAGE_LOCAL/share/singular" install-libsingular
  
      if [ $? -ne 0 ]; then
 -        echo "Unable to install libsingular."
}}}


---

Comment by jdemeyer created at 2012-08-06 10:16:53

For the slibdir issue, I am patching Makefile.in instead, I think this is the best solution.


---

Comment by jpflori created at 2012-08-06 10:20:37

Just a reminder for not forgetting to close #12089 and #13344. when this one is closed.


---

Comment by jdemeyer created at 2012-08-06 10:21:34

Changing status from needs_work to needs_review.


---

Comment by AlexanderDreyer created at 2012-08-06 10:28:24

Just nitpicking: there a typo in my name.


---

Comment by jdemeyer created at 2012-08-06 10:31:05

Replying to [comment:48 AlexanderDreyer]:
> Just nitpicking: there a typo in my name.
Apologies, fixed.


---

Comment by jdemeyer created at 2012-08-06 11:37:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-08-06 12:33:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-08-06 14:10:12

Replying to [comment:35 leif]:
> Only just noticed that old installations get removed before we even attempt to build the new one; this should in general only be done if the build succeeded.

Unfortunately, Singular doesn't have separate `build` and `install` targets.  So building and installing must happen together.


---

Comment by dimpase created at 2012-08-06 14:26:11

Replying to [comment:51 jdemeyer]:
I can confirm that the latest spkg installs cleanly on MacOSX 10.6.8 and on Cygwin.


---

Comment by jpflori created at 2012-08-06 14:37:05

Replying to [comment:53 dimpase]:
> Replying to [comment:51 jdemeyer]:
> I can confirm that the latest spkg installs cleanly on MacOSX 10.6.8 and on Cygwin.
Same here on Cygwin and Linux (Ubuntu 12.04 x86_64).
And I'm happy with the changes related to #13344.
I've given it positive review.


---

Comment by jdemeyer created at 2012-08-09 06:38:21

This doesn't build on Solaris: http://www.singular.uni-kl.de:8002/trac/ticket/443


---

Comment by jdemeyer created at 2012-08-09 06:38:21

Changing status from needs_review to needs_work.


---

Comment by AlexanderDreyer created at 2012-08-10 11:25:13

Hannes Schönemann of the Singular team has provided a patch for this: https://github.com/Singular/Sources/commit/cf39407a525018da4baffd05e88315bd83075f8c.patch


---

Comment by jdemeyer created at 2012-08-10 20:56:57

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-08-10 20:56:57

Seems to build fine on Solaris now, needs review again.


---

Attachment

Diff for the singular spkg. For reference / review only.


---

Comment by AlexanderDreyer created at 2012-08-10 23:30:06

Installs and tests sage/rings without any problems. So positive review from my side.


---

Comment by jdemeyer created at 2012-08-12 21:23:24

Anybody willing to fully review this ticket?


---

Comment by fbissey created at 2012-08-15 10:16:34

I will push the button. There is a lot of clean up and of course new issues (like one of my colleagues says: exchange old bugs for new ones). I looked carefully at all the changes in spkg-install (make that very carefully for the last 2 days - but I could still have missed something) and am happy with them. Happy with the new patches too.


---

Comment by fbissey created at 2012-08-15 10:16:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-08-15 20:06:59

Replying to [comment:61 fbissey]:
> I looked carefully at all the changes in spkg-install (make that very carefully for the last 2 days - but I could still have missed something) and am happy with them. Happy with the new patches too. 
Thanks a lot for this.


---

Comment by fbissey created at 2012-08-16 02:01:40

That's annoying now that I have pushed the button I found something (that obviously is not impacting sage) that should be reported upstream. The header factory/assert.h is not installed and it is included in factory/templates/ftmpl_{matrix,array,list}.cc.
I don't think there are anymore missing headers.


---

Comment by fbissey created at 2012-08-16 02:44:36

Spoke too soon from factory/templates/ftmpl_inst.cc

```
#include "canonicalform.h"
#include "cf_map.h"
#include "cf_reval.h"
```

None of these are installed either.


---

Comment by AlexanderDreyer created at 2012-08-16 07:34:20

Replying to [comment:64 fbissey]:
Thanks for the hint, I just reported that upstream:
http://www.singular.uni-kl.de:8002/trac/ticket/446


---

Comment by fbissey created at 2012-08-16 09:24:14

Just to be clear. I don't think we should delay this ticket for these headers. If there was an effect on sage we would know by now. But we should definitely have a follow up ticket to pick any upstream patch. Thanks Alexander I was counting on you picking it up :).


---

Comment by zimmerma created at 2012-08-27 08:34:00

I'd like to see non-regression tests in this patch, for all tickets solved by this one:
#13129, #12918, #12928, #12846, #12089, #13344.

Paul


---

Comment by jdemeyer created at 2012-08-27 08:49:04

Replying to [comment:68 zimmerma]:
> I'd like to see non-regression tests in this patch, for all tickets solved by this one:
> #13129, #12918, #12928, #12846, #12089, #13344.

Good suggestion, however #12089, #13344 are about _compiling_ Singular so I don't think we should add a regression test for that (the real test is just checking that any upgrades don't break the build).  Then #12846 is also tricky because it is about a computation which randomly runs slow or gets stuck.

For the other 3 tickets, we should indeed add a regression test.  I'll take care of the patch.


---

Comment by jdemeyer created at 2012-08-27 08:49:04

Changing status from positive_review to needs_work.


---

Comment by jpflori created at 2012-08-27 08:52:50

We could test existence of *.lib files in the LIB directory for #13344, or of $SAGE_LOCAL/LIB directory.
The problem is critical on Cygwin where LIB resolves to lib and messes PyOpenSSL compilation (although that package won't be built anymore soon), but was also present on every platform.

I agree that #12089 cannot really be tested, except for the fact that Singular succeeded to build.


---

Comment by zimmerma created at 2012-08-27 09:25:15

sorry I meant I'd like to see non-regression tests **if possible**. Thank you Jeroen for taking care of them.

Paul


---

Attachment

Additional patch


---

Comment by jdemeyer created at 2012-08-27 10:35:01

Changing priority from major to critical.


---

Comment by jdemeyer created at 2012-08-27 10:35:01

Additional patch [attachment:13237_tests.patch] needs review.


---

Comment by jdemeyer created at 2012-08-27 10:35:01

Changing status from needs_work to needs_review.


---

Comment by AlexanderDreyer created at 2012-08-27 10:46:52

Changing status from needs_review to positive_review.


---

Comment by AlexanderDreyer created at 2012-08-27 10:46:52

Replying to [comment:72 jdemeyer]:
> Additional patch [attachment:13237_tests.patch] needs review.
Indeed, I can confirm that the tests check for recurrence of the solved problems.


---

Comment by SimonKing created at 2012-08-27 15:32:01

There is a small thing that I'd like to change: There is a header table.h, that is currently not installed. However, it is needed by libsing (not libsingular).

libsing is a package allowing GAP to use Singular natively. I don't know if it would be of general interest to have it in Sage. Anyway: Should there be a new ticket for the installation of table.h, or should it be done here?


---

Comment by AlexanderDreyer created at 2012-08-27 15:45:59

Replying to [comment:74 SimonKing]:
> There is a small thing that I'd like to change: There is a header table.h, that is currently not installed. However, it is needed by libsing (not libsingular).
> 
> libsing is a package allowing GAP to use Singular natively. I don't know if it would be of general interest to have it in Sage. Anyway: Should there be a new ticket for the installation of table.h, or should it be done here?
I think this is not related tot he upgrade, so this should be a feature request to the Singular-team. But of course, any resulting patch could be integrated in the next spkg eventually.


---

Comment by SimonKing created at 2012-08-27 17:17:53

It seems to me that the spkg contains uncommitted changes.


---

Comment by jdemeyer created at 2012-08-28 07:11:53

Replying to [comment:76 SimonKing]:
> It seems to me that the spkg contains uncommitted changes.
You are very right, I forgot to do `sage --pkg` after committing the changes.  Should be fixed now.


---

Comment by SimonKing created at 2012-08-28 07:38:36

Replying to [comment:75 AlexanderDreyer]:
> Replying to [comment:74 SimonKing]:
> I think this is not related tot he upgrade,

Granted. But if we upgrade Singular anyway, we could as well use a little patch that installs just one additional header. 

> so this should be a feature request to the Singular-team. But of course, any resulting patch could be integrated in the next spkg eventually.

Here is the suggested change, anyway. Add a file patches/install_table.patch containing
  {{{
--- src/Singular/Makefile.in    2012-07-11 11:00:13.000000000 +0100
+++ src/Singular/Makefile.in    2012-08-27 16:22:26.013159361 +0100
`@``@` -599,7 +599,7 `@``@`
          ${INSTALL_PROGRAM}  $$file ${libdir}; \
        done
        ${INSTALL_PROGRAM} libsingular.h ${includedir}
-       for file in subexpr.h tok.h grammar.h ipid.h lists.h ipshell.h attrib.h; do \
+       for file in subexpr.h tok.h grammar.h ipid.h lists.h ipshell.h attrib.h table.h; do \
        sed -e "s:<kernel/:<singular/:" < $$file |sed -e "s:<Singular/:<singular/:"|sed -e "s:<omalloc/:<:"|sed -e "s:<factory/:<:" >${includedir}/singular/$$file ;\
        done
   }}}


---

Comment by jdemeyer created at 2012-08-28 09:28:18

I agree with AlexanderDreyer that you should make a request to upstream for `table.h` to be installed.  If the patch gets accepted upstream, it will also be easier to review this ticket.


---

Comment by SimonKing created at 2012-08-28 09:43:15

Replying to [comment:79 jdemeyer]:
> I agree with AlexanderDreyer that you should make a request to upstream for `table.h` to be installed.  If the patch gets accepted upstream, it will also be easier to review this ticket.

I asked Hans Schönemann today, and he answered: "Meinetwegen."

In English, I guess that's: "I don't mind."


---

Comment by jdemeyer created at 2012-08-29 09:38:57

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-08-29 09:39:05

Changing status from needs_work to needs_review.


---

Attachment

Diff for the singular spkg p0->p1. For reference / review only.


---

Comment by AlexanderDreyer created at 2012-08-29 09:42:52

Changing status from needs_review to positive_review.


---

Comment by AlexanderDreyer created at 2012-08-29 09:42:52

Replying to [comment:82 jdemeyer]:
I'll give a positive review to this (was discussed before),


---

Comment by SimonKing created at 2012-08-29 09:50:56

One questions regarding [Alexander's comment on #7797](http://trac.sagemath.org/sage_trac/ticket/7797#comment:86): Has it really been the case on Solaris SPARC that an outdated Singular/tok.h was hanging around? And if the answer is yes, a second question: Has the new singular spkg not properly installed the new one?


---

Comment by jdemeyer created at 2012-08-29 09:55:14

I am currently doing a complete build from scratch on Solaris SPARC with the new Singular to find out what's going on.


---

Comment by SimonKing created at 2012-08-30 17:29:13

Replying to [comment:85 jdemeyer]:
> I am currently doing a complete build from scratch on Solaris SPARC with the new Singular to find out what's going on.

What came out of it?


---

Comment by jdemeyer created at 2012-08-30 17:57:58

Replying to [comment:86 SimonKing]:
> What came out of it?

I'll answer at #7797 when it's finished compiling (which should be soon now) :-)


---

Comment by jdemeyer created at 2012-09-03 12:52:54

Resolution: fixed
