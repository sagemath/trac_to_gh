# Issue 29127: Bug in S-class groups of number fields

Issue created by migration from https://trac.sagemath.org/ticket/29364

Original creator: @bmatschke

Original creation time: 2020-03-18 23:30:43

Keywords: S_class_group, fractional_ideal

Coercing a fractional ideal of a number field to an S-class group over the same number field sometimes raises a KeyError and an AssertionError.

Here is a failing example:


```
R.<x> = QQ[]
L.<t> = NumberField(x^2 - 6058)
S = L.primes_above(2)
C = L.S_class_group(S)
J = L.fractional_ideal(1)
print("C(J):", C(J))	# Should print the trivial S-ideal class of C, but raises errors.
```


This was tested in Sage 9.0, 8.8, and 8.6, always yielding the same error.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by @DaveWitteMorris created at 2020-12-16 06:45:58

The bug is in the `NumberField._S_class_group_quotient_matrix()` method. 

```
sage: R.<x> = QQ[] 
....: L.<t> = NumberField(x^2 - 6058) 
....: S = L.primes_above(2) 
....: L._S_class_group_quotient_matrix(tuple(S))                                
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
   ...
During handling of the above exception, another exception occurred:

AssertionError                            Traceback (most recent call last)
    ...
/Applications/math/sage-9.2/local/lib/python3.7/site-packages/sage/rings/number_field/number_field.py in _S_class_group_quotient_matrix(self, S)
   4644         M = matrix(ZZ, M)
   4645         A, Q = M.hermite_form(transformation=True)
-> 4646         assert A[:c] == 1 and A[c:] == 0
   4647         return Q[:c, :a]
   4648 

AssertionError:
```

The rows of the matrix M are generators of <S> and generators of the quotient I/<S>, where I is the ideal class group, so the rows generate I. The algorithm assumed that lifting these generators to Z<sup>n</sup> would provide a set of generators of Z<sup>n</sup>, but that is not usually true. 

The PR adds additional rows to M that are generators of the kernel of the homomorphism from Z<sup>n</sup> to I. (Each generator of the kernel has only one nonzero entry, which is the order of the corresponding generator of I.)  This squashes the bug:

```
sage: R.<x> = QQ[] 
....: L.<t> = NumberField(x^2 - 6058) 
....: S = L.primes_above(2) 
....: C = L.S_class_group(S) 
....: J = L.fractional_ideal(1) 
....: print("C(J):", C(J))                                                               
C(J): Trivial S-ideal class
```

(The fix is only one line of code, but the PR also adds a doctest, and deletes some space-only lines elsewhere in the file.)
----
New commits:


---

Comment by @DaveWitteMorris created at 2020-12-16 06:45:58

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-12-16 12:28:14

doctest failure in src/sage/rings/number_field/number_field.py, see patchbot


---

Comment by chapoton created at 2020-12-16 12:30:49

and the syntax for the trac link is plain wrong


---

Comment by git created at 2020-12-17 03:36:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-12-17 03:40:16

Oops! Thanks for pointing out that I goofed up the trac link. 

I was surprised that the patchbot failed the doctest that I wrote. (It works fine on my computer.) But the matrix is not unique, so maybe it's more surprising that the other doctests of this method don't fail. Anyway, I wrote a new doctest that checks whether the matrix is valid, rather than requiring a certain value. I hope the patchbots will be happy with this one.


---

Comment by chapoton created at 2020-12-17 09:50:55

ok, let it be (not a mathematical review, though)


---

Comment by chapoton created at 2020-12-17 09:50:55

Changing status from needs_review to positive_review.


---

Comment by @DaveWitteMorris created at 2020-12-17 17:55:29

Thanks!


---

Comment by vbraun created at 2020-12-27 00:23:28

Resolution: fixed
