# Issue 33915: Fix broken bootstrap (AC_LIB_RPATH etc.)

Issue created by migration from https://trac.sagemath.org/ticket/34152

Original creator: mkoeppe

Original creation time: 2022-07-11 16:11:57

CC:  culler dimpase fbissey isuruf nbruin

Broken in #29549, because I forgot to add some files.


---

Comment by mkoeppe created at 2022-07-11 16:15:38

New commits:


---

Comment by mkoeppe created at 2022-07-11 16:15:38

Changing component from PLEASE CHANGE to build: configure.


---

Comment by mkoeppe created at 2022-07-11 16:17:06

Changing status from new to needs_review.


---

Comment by git created at 2022-07-11 16:34:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-07-11 18:18:39

vendoring more and more of gnulib...

should we instead install,on demand, gnulib itself?


---

Comment by mkoeppe created at 2022-07-11 19:18:40

This is how Gnulib is designed to be used. 
"Its components are intended to be shared at the source level, rather than being a library that gets built, installed, and linked against. Thus, there is no distribution tarball; the idea is to copy files from Gnulib into your own source tree."
https://www.gnu.org/software/gnulib/


---

Comment by dimpase created at 2022-07-11 22:35:46

it seems that "copying" is meant to be done from an installed `gnulib` version.
That's how I read https://www.mail-archive.com/bug-gnulib`@`gnu.org/msg36476.html
where a way to do this is discussed.
`gnulib` has a script to facilitate such an installation: https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh


---

Comment by mkoeppe created at 2022-07-11 22:38:31

There's no such thing as an "installed" gnulib.


---

Comment by mkoeppe created at 2022-07-11 22:46:01

The workflow with gnulib is documented in https://www.gnu.org/software/gnulib/manual/html_node/Invoking-gnulib_002dtool.html


---

Comment by mkoeppe created at 2022-07-11 22:53:41

Replying to [comment:8 dimpase]:
> `gnulib` has a script to facilitate such an installation: https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh

from https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh#L36:
"The package maintainer may choose to use or not use git submodules." - I chose to not use git submodules.


---

Comment by dimpase created at 2022-07-11 22:54:13

Replying to [comment:9 mkoeppe]:
> There's no such thing as an "installed" gnulib.

there certainly is an executable/script called `gnulib-tool` - which is certainly a part of installed gnulib


---

Comment by mkoeppe created at 2022-07-11 23:04:05

"gnulib-tool is not installed in a standard directory that is contained in the PATH variable. It needs to be run directly in the directory that contains the Gnulib source code." https://www.gnu.org/software/gnulib/manual/html_node/Invoking-gnulib_002dtool.html


---

Comment by dimpase created at 2022-07-11 23:05:48

> gnulib-tool is not installed in a standard directory that is contained in the PATH variable
OK, fine, but its directory has to appear somehow


---

Comment by mkoeppe created at 2022-07-11 23:08:12

Yes, a developer who wants to update the portions of Gnulib that have been copied into the source tree will use a git clone of gnulib and invoke gnulib-tool from there.


---

Comment by dimpase created at 2022-07-11 23:10:13

Replying to [comment:11 mkoeppe]:
> Replying to [comment:8 dimpase]:
> > `gnulib` has a script to facilitate such an installation: https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh
> 
> from https://www.gnu.org/software/gnulib/manual/html_node/Invoking-gnulib_002dtool.html:
> "The package maintainer may choose to use or not use git submodules." - I chose to not use git submodules.
> 

The quote you attribute to `Invoking-gnulib_002dtool.html` is actually from `gitsub.sh`.

`gitsub.sh` can do `subcheckouts` rather than `submodules`.

The docs don't even discuss manual vendoring of files, I think.


---

Comment by mkoeppe created at 2022-07-11 23:11:33

Replying to [comment:16 dimpase]:
> Replying to [comment:11 mkoeppe]:
> > Replying to [comment:8 dimpase]:
> > > `gnulib` has a script to facilitate such an installation: https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh
> > 
> > from https://www.gnu.org/software/gnulib/manual/html_node/Invoking-gnulib_002dtool.html:
> > "The package maintainer may choose to use or not use git submodules." - I chose to not use git submodules.
> > 
> 
> The quote you attribute to `Invoking-gnulib_002dtool.html` is actually from `gitsub.sh`.

Yes, sorry, wrong link.
Fixed now: I meant to paste https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh#L36


---

Comment by mkoeppe created at 2022-07-11 23:13:15

Replying to [comment:16 dimpase]:
> The docs don't even discuss manual vendoring of files, I think.

Please, Dima, the whole manual talks about nothing else.


---

Comment by dimpase created at 2022-07-11 23:13:59

Replying to [comment:15 mkoeppe]:
> Yes, a developer who wants to update the portions of Gnulib that have been copied into the source tree will use a git clone of gnulib and invoke gnulib-tool from there.

but not manually - rather, as a part of pre-configuring a project. Checking in our repo huge chunks of gnulib is suboptimal.


---

Comment by mkoeppe created at 2022-07-11 23:15:50

Replying to [comment:19 dimpase]:
> Replying to [comment:15 mkoeppe]:
> > Yes, a developer who wants to update the portions of Gnulib that have been copied into the source tree will use a git clone of gnulib and invoke gnulib-tool from there.
> 
> but not manually

It's called the "initial import". https://www.gnu.org/software/gnulib/manual/html_node/Initial-import.html
This is what I did in #29549 (except that I forgot to `git add` some files).


---

Comment by dimpase created at 2022-07-11 23:19:46

Replying to [comment:18 mkoeppe]:
> Replying to [comment:16 dimpase]:
> > The docs don't even discuss manual vendoring of files, I think.
> 
> Please, Dima, the whole manual talks about nothing else.

This manual is older than `git`, you know, no wonder it won't mention it.

`gitsub.sh` is for the modern way of doing things, and that's what `gnulib` maintainer uses.


---

Comment by mkoeppe created at 2022-07-11 23:23:30

Replying to [comment:21 dimpase]:
> `gitsub.sh` is for the modern way of doing things, and that's what `gnulib` maintainer uses.

It's a new option of how to work with gnulib, but it offers no benefits for us.


---

Comment by mkoeppe created at 2022-07-11 23:27:43

Replying to [comment:21 dimpase]:
> This manual is older than `git`, you know, no wonder it won't mention it.

Use with git is documented in https://www.gnu.org/software/gnulib/manual/html_node/VCS-Issues.html; it describes several approaches.


---

Comment by mkoeppe created at 2022-07-11 23:31:56

Replying to [comment:19 dimpase]:
> Checking in our repo huge chunks of gnulib is suboptimal.

#29549 added 2 files, the current ticket is adding 4 more.


---

Comment by dimpase created at 2022-07-12 07:03:00

yes, about 5000 loc, likely to cause trouble if not updated on time.

downstreams wouldn't be happy, maintenance is problematic.

why vendor if it can be avoided?


---

Comment by mkoeppe created at 2022-07-12 07:14:21

Once again, this is the standard way to use gnulib.


---

Comment by mkoeppe created at 2022-07-12 07:16:19

Replying to [comment:25 dimpase]:
> why vendor if it can be avoided?

Because the alternative (the `gitsub.sh` -- which is to be copied into the source tree by the way) introduces a ridiculous amount of complexity.


---

Comment by dimpase created at 2022-07-12 08:32:33

How about just requiring `gnulib-tool` ? macOS purists may have to jump an extra hoop, but it's very minor.


---

Comment by dimpase created at 2022-07-12 11:42:34

here is a way to use gnulib-tool instead.

Based on the original branch of this ticket.
By the way, I also noticed that gettext is still mentioned in a lot of `tox`-related and CI-related files.
----
New commits:


---

Comment by mkoeppe created at 2022-07-12 12:57:25

No, we cannot assume that `gnulib-tool` (= all of gnulib) is available in the system.


---

Comment by mkoeppe created at 2022-07-12 13:54:10

... because comment:9


---

Comment by git created at 2022-07-12 14:31:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-07-12 14:34:20

Replying to [comment:32 mkoeppe]:
> ... because comment:9

all the systems I checked either have `gnulib` package (with a reasonably recent, complete, version of `gnuilib`), or none at all, and then
it can be installed (ok, ok, cloned from its repo, and PATH adjusted accordingly)


---

Comment by mkoeppe created at 2022-07-12 15:03:56

Replying to [comment:34 dimpase]:
> or none at all

exactly, that's the problem

> and then
> it can be installed (ok, ok, cloned from its repo, and PATH adjusted accordingly)

But we certainly do not want to force every developer who wants to run `./bootstrap` to do that.


---

Comment by dimpase created at 2022-07-12 16:14:22

Replying to [comment:36 mkoeppe]:
> Replying to [comment:34 dimpase]:
> > or none at all
> 
> exactly, that's the problem
> 
> > and then
> > it can be installed (ok, ok, cloned from its repo, and PATH adjusted accordingly)
> 
> But we certainly do not want to force every developer who wants to run `./bootstrap` to do that.

only these who use macOS and only these who do not use anything but Xcode might have to do this. And among the latter only these who need to  build ./configure

It's certainly not "every developer".


---

Comment by mkoeppe created at 2022-07-12 16:19:37

Assuming that gnulib is installed in the system directly contradicts the intentions of upstream.

And neither homebrew nor conda have a gnulib package.


---

Comment by dimpase created at 2022-07-12 16:35:28

Replying to [comment:38 mkoeppe]:
> Assuming that gnulib is installed in the system directly contradicts the intentions of upstream.

one would expect the system maintainers to update reasonably often.
(indeed, e.g. on Debian stable and Fedora 34 gnulib is dated 2021; it appears that https://repology.org/project/gnulib/versions is not complete/up to date, e.g. is doesn't show Fedora packages).

No need for us to do this maintainance job.

> 
> And neither homebrew nor conda have a gnulib package.
for Homebrew we can actually make one; not sure how hard it's for conda


---

Comment by mkoeppe created at 2022-07-12 16:55:59

Let me try to explain it again:

Upstream states clearly that gnulib is not to be installed.
And indeed, it does not have a `make install` target.

When Debian/Fedora/... are shipping gnulib, it is likely for the purpose of implementing their policy when building packages -- i.e., updating the vendored portions of gnulib of a package before starting the build.


---

Comment by dimpase created at 2022-07-12 17:13:11

Replying to [comment:40 mkoeppe]:
> Let me try to explain it again:
> 
> Upstream states clearly that gnulib is not to be installed.
> And indeed, it does not have a `make install` target.
> 
> When !Debian/Fedora/... are shipping gnulib, it is likely for the purpose of implementing their policy when building packages -- i.e., updating the vendored portions of gnulib of a package before starting the build.

My reading is that gnulib's upstream doesn't want gnulib to be vendored, either, as it leads to using outdated gnulib.
The upstream wants a fresh version to be used (well, this is understandable). That's why they promote `gitsub.sh`.


---

Comment by mkoeppe created at 2022-07-12 17:16:11

Replying to [comment:41 dimpase]:
> My reading is that gnulib's upstream doesn't want gnulib to be vendored

My branch does not "vendor" gnulib. It has imported the needed gnulib modules into our source tree. This is the standard documented usage.


---

Comment by mkoeppe created at 2022-07-12 17:25:02

Replying to [comment:41 dimpase]:
> That's why they promote `gitsub.sh`.

They don't "promote" it. The entire manual only *mentions* the existence of this file. see https://www.gnu.org/software/gnulib/manual/gnulib.html


---

Comment by mkoeppe created at 2022-07-12 17:40:35

Replying to [comment:41 dimpase]:
> The upstream wants a fresh version to be used

But not "fresh" as in "whatever is in upstream gnulib HEAD" whenever someone runs `./bootstrap`.

Updating the imported gnulib modules is something that the maintainer of a package does explicitly. For example, gettext does use `gitsub.sh` (in "submodule" mode): updating is done by a maintainer - that's a commit.


---

Comment by dimpase created at 2022-07-12 18:27:32

the relationship between gettext and gnulib is akin to the relationship between individual strands of pasta in a spaghetti bowl :-)


---

Comment by dimpase created at 2022-07-12 18:31:32

Replying to [comment:44 mkoeppe]:
> Replying to [comment:41 dimpase]:
> > The upstream wants a fresh version to be used
> 
> But not "fresh" as in "whatever is in upstream gnulib HEAD" whenever someone runs `./bootstrap`.
> 

but, how fresh? Do they advice to age a version in a wine cask? 


> Updating the imported gnulib modules is something that the maintainer of a package does explicitly. For example, gettext does use `gitsub.sh` (in "submodule" mode): updating is done by a maintainer - that's a commit.

Aren't they maintained by the same people?


---

Comment by mkoeppe created at 2022-07-12 18:34:55

Replying to [comment:46 dimpase]:
> Replying to [comment:44 mkoeppe]:
> > Replying to [comment:41 dimpase]:
> > > The upstream wants a fresh version to be used
> > 
> > But not "fresh" as in "whatever is in upstream gnulib HEAD" whenever someone runs `./bootstrap`.
> > 
> 
> but, how fresh?

Update, test, commit, as usual


---

Comment by dimpase created at 2022-07-12 18:46:48

the gettext worked for us without committing any files/modules from it, at all. I don't see how using gnulib instead is going to break anything.


---

Comment by mkoeppe created at 2022-07-12 18:57:06

Before #29549, we were getting our files at `./bootstrap` time from a system installation of `gettextize`. `gettextize` has the files that we need because gettext has imported these gnulib modules - see for example https://github.com/autotools-mirror/gettext/blob/master/autogen.sh#L168 for iconv.


---

Comment by mkoeppe created at 2022-07-12 19:04:27

#29549 followed the advice from Bruno Haible that you relayed in #27823#comment:52 (https://trac.sagemath.org/ticket/29549#comment:3). 
Except for the mistake of forgetting `git add` for some of the files, which is entirely my own.


---

Comment by mkoeppe created at 2022-07-12 20:35:45

New commits:


---

Comment by dimpase created at 2022-07-12 20:56:15

I don't see how advice from Haible says that importing means copying+committing, rather than calling gnulib-tool every time autoconf has to be run.


---

Comment by mkoeppe created at 2022-07-12 21:01:20

Replying to [comment:52 dimpase]:
> I don't see how advice from Haible says that importing means copying+committing

That message only says, don't try to get it from gettext, get it from gnulib instead.


---

Comment by mkoeppe created at 2022-07-12 21:02:41

I responded to your question in comment:48.


---

Comment by dimpase created at 2022-07-12 21:44:32

I don't think you responded to my question in comment:48


---

Comment by dimpase created at 2022-07-12 21:47:32

sorry, I see committing a bunch of files from another project as a regression (unneeded vendoring).


---

Comment by mkoeppe created at 2022-07-12 21:56:50

Replying to [comment:55 dimpase]:
> I don't think you responded to my question in comment:48

Try rephrasing your question then please


---

Comment by mkoeppe created at 2022-07-12 22:04:51

Replying to [comment:56 dimpase]:
> sorry, I see committing a bunch of files from another project as a regression (unneeded vendoring).

comment:42.


---

Comment by fbissey created at 2022-07-13 09:22:05

I think Matthias is using gnulib as intended. Making it maintainable is possibly the tricky bit. Had to deal with gnulib before on AIX :( the advantage of using gettext in this case is to rely on a third party to do the maintenance. And then you have to make sure you are up to date yourself.

As to adding bunch of files from another project, yes it is trading them against the gettext dependency as far as I understand. So potentially a tarball with stuff you don't care about.

Dima, do you have a good stated technical opposition to gnulib rather than a philosophical one?


---

Comment by dimpase created at 2022-07-13 09:27:54

I don't have opposition to `gnulib`, I rather want have it installed and used by `./bootstrap` via `gnulib-tool`.


---

Comment by fbissey created at 2022-07-13 09:42:44

Replying to [comment:60 dimpase]:
> I don't have opposition to `gnulib`, I rather want have it installed and used by `./bootstrap` via `gnulib-tool`.

I see, then we'll go round and round. Do I want to have to install gnulib to bootstrap?

```
fbissey@tarazed ~ $ eix gnulib
* dev-libs/gnulib
     Available versions:  ~*2019.03.17.09.24.57 ~*2022.02.12.16.27.05 ~*2022.05.26.07.24.56 **9999-r1*l {doc}
     Homepage:            https://www.gnu.org/software/gnulib
     Description:         Gnulib is a library of common routines intended to be shared at the source level
```

hum stuff that has all the markers for "install at your own risks, you have been warned" and which force to do things that are equivalent to signing a contract saying you understand the risks before you can install. Looking at the package itself it is "grab a tarball and manually copy the files in a potentially arbitrary location". No, I am with Matthias on that one, this is in a different class than autotools and libtools or cmake. You redistribute the bits you need. Having the tools to maintain it in the same package is a must though.


---

Comment by dimpase created at 2022-07-13 09:52:05

"bits" are thousands of lines, in about 10 files. To me it screams that it should be installed and copied as needed,  not copied once and committed in our tree. 

I think gnulib is in such a weird state due to GNU folks having badly failed QA on the gnulib/gettext stuff.


---

Comment by fbissey created at 2022-07-13 10:14:34

Replying to [comment:62 dimpase]:
> I think gnulib is in such a weird state due to GNU folks having badly failed QA on the gnulib/gettext stuff. 

Possibly :) that has never stopped anyone - and I am talking in a professional capacity as someone who helped people install real stinky software on "supercomputers" and computers not really super. Sometimes, I turn to my fellow researcher or a PhD student and go "we are not going to do that one sorry, it stinks because it is real dead. Please reconsider". Not so long ago sagemath was in the stinky pile, it still stinks a bit but not that bad :), using gnulib as Matthias wants will not make it smell much more. At the very least, gnulib and sagemath are very much alive and that counts for a lot.


---

Comment by dimpase created at 2022-07-13 11:00:41

IMHO my branch for the issue, i.e. `u/dimpase/config/gnulib`, is less stinky.

Matthias already caused a bit of havoc in 9.7.beta5 by only keeping in `m4/` some of the files installed by `gnulib-tool --import iconv` and not all (a bug only visible on a box without gettext installed :-(). And still `u/mkoeppe/fix_broken_bootstrap__ac_lib_rpath_etc__` doesn't add them all.

----
New commits:


---

Comment by dimpase created at 2022-07-13 11:06:17

advice to install `gnutls` is missing in this branch, but that's minor, easy to fix.


---

Comment by dimpase created at 2022-07-13 11:21:33

Replying to [comment:61 fbissey]:
> Replying to [comment:60 dimpase]:
> > I don't have opposition to `gnulib`, I rather want have it installed and used by `./bootstrap` via `gnulib-tool`.
> 
> I see, then we'll go round and round. Do I want to have to install gnulib to bootstrap?
> {{{
> fbissey`@`tarazed ~ $ eix gnulib
> * dev-libs/gnulib
>      Available versions:  ~*2019.03.17.09.24.57 ~*2022.02.12.16.27.05 ~*2022.05.26.07.24.56 **9999-r1*l {doc}
>      Homepage:            https://www.gnu.org/software/gnulib
>      Description:         Gnulib is a library of common routines intended to be shared at the source level
> }}}

on gentoo I had to do the "missing keyword" fix for gnulib, in order to install it.
Not sure it's a bug or feature.


---

Comment by fbissey created at 2022-07-13 11:58:28

It is a feature. This is a way to get you to sign off that you know what you are doing. You have to be really explicit that you want to install it.


---

Comment by mkoeppe created at 2022-07-13 14:53:29

Replying to [comment:23 mkoeppe]:
> Replying to [comment:21 dimpase]:
> > This manual is older than `git`, you know, no wonder it won't mention it.
> 
> Use with git is documented in https://www.gnu.org/software/gnulib/manual/html_node/VCS-Issues.html; it describes several approaches.

Dima, let me highlight this link again. It documents 3 approaches how to use gnulib with version control systems. Do you see which of the 3 corresponds to my branch?


---

Comment by dimpase created at 2022-07-13 16:13:07

After all these years trying to unvendor as much as possible, all of a sudden you reverse the course. I don't get it.


---

Comment by mkoeppe created at 2022-07-13 16:22:31

You keep using this word "vendoring" here. This is not what's happening. My branch is using gnulib as documented.

You may find https://lists.gnu.org/archive/html/bug-gnulib/2008-11/msg00083.html helpful.


---

Comment by mkoeppe created at 2022-07-13 16:25:03

New commits:


---

Comment by dimpase created at 2022-07-13 17:18:01

I consider the gnulib manual outdated. OK, it's not vendoring, it's an SCO (Special Copying Operation) :P


---

Comment by mkoeppe created at 2022-07-13 17:20:19

Replying to [comment:72 dimpase]:
> I consider the gnulib manual outdated.

Try taking that to bug-gnulib.


---

Comment by mkoeppe created at 2022-07-13 17:22:44

Pro tip: Use the subject "Gnulib considered harmful"


---

Comment by mkoeppe created at 2022-07-14 14:08:05

Changing priority from blocker to critical.


---

Comment by culler created at 2022-07-15 15:32:08

Adding those four files to the m4 directory fixed all of my problems with the bootstrap script, including the missing .dylib extension on LIBSINGULAR_PATH.  I am now getting a working macOS build with no issues.

It seems completely clear to me that this is the correct approach.  A project distributes an m4 directory containing the exact gnulib .m4 files that are needed to make its build work. By that I mean the exact versions of those files. The gnulib repository changes almost daily and they do not do releases.  So this seems like the only way to ensure a working build.  And it is also what gnulib says to do.


---

Comment by dimpase created at 2022-07-16 19:59:56

Replying to [comment:76 culler]:
> Adding those four files to the m4 directory fixed all of my problems with the bootstrap script, including the missing .dylib extension on LIBSINGULAR_PATH.  I am now getting a working macOS build with no issues.
> 
> It seems completely clear to me that this is the correct approach.  A project distributes an m4 directory containing the exact gnulib .m4 files that are needed to make its build work. By that I mean the exact versions of those files. The gnulib repository changes almost daily and they do not do releases.  So this seems like the only way to ensure a working build.  And it is also what gnulib says to do.

The only way? 
If one wants to follow the gnulib updates then one can use `git submodule` or a similar solution; and this is mentioned in gnulib docs.
Totally no need to follow the 30+ years old way of copying files by hand.


---

Comment by mkoeppe created at 2022-07-16 20:06:35

Gnulib provides `gnulib-tool` for the copying, so copying is not done "by hand".


---

Comment by dimpase created at 2022-07-16 21:03:32

sure - but updating is done by hand; one needs to update gnulib on the box, and launch gnulib-tool


---

Comment by mkoeppe created at 2022-07-16 21:08:44

Yes, the author of an upgrade ticket for these files will have to run `gnulibtool`.


---

Comment by mkoeppe created at 2022-07-16 21:34:36

That's approach 3 of the three approaches explained in the manual (https://www.gnu.org/software/gnulib/manual/html_node/VCS-Issues.html).


---

Comment by dimpase created at 2022-07-17 10:04:50

so you chose the most labour-intensive approach, resulting in extra maintenance to be done.


---

Comment by mkoeppe created at 2022-07-17 18:19:54

No. 

In approach 2 of the three approaches, in the variant with `git submodule`, the author of an upgrade ticket will have to run `git submodule update --remote` and then commit the change. 

For the author of an upgrade ticket for gnulib, it's the same amount of labor as approach 3: One command and one commit.

The drawbacks of this approach: 
- it exposes all developers (not just an author of a gnulib upgrade ticket) to the complexity of git submodules. 
- a source tarball of Sage will have to contain the full copy of gnulib (a copy of the submodule). More "vendoring" ;)


---

Comment by dimpase created at 2022-07-18 11:41:49

why do you insist on committing exact copies of files in gnulib into Sage tree? My approach does not do this.


---

Comment by mkoeppe created at 2022-07-18 16:31:15

Replying to [comment:84 dimpase]:
> why do you insist on committing exact copies of files in gnulib into Sage tree?

It is the documented way to use gnulib, specifically, approach 3.

The Gnulib manual, https://www.gnu.org/software/gnulib/manual/html_node/VCS-Issues.html, introduces the three approaches with this paragraph:

  Here are the three different approaches in common use. Each has its place, and you should use whichever best suits your particular project and development methods.

The approach of your branch is neither of the three documented approaches. Upstream explicitly rejects this approach. It's reflected in: Gnulib not making releases and not having an "install" target (comment:9, comment:40); homebrew and conda not packaging it (comment:38); gentoo marking it as "source only" (comment:67); and the thread linked in comment:70.


---

Comment by dimpase created at 2022-07-18 19:16:01

I think upstream has it wrong. Why do they insist on partial, or even complete, vendoring of their code? This only make sense if one wants to change it, but for 99% of projects it is not the case.


---

Comment by mkoeppe created at 2022-07-18 19:23:39

comment:73, comment:74


---

Comment by dimpase created at 2022-07-19 07:42:14

Replying to [comment:87 mkoeppe]:
> comment:73, comment:74

no, I am not going to try to expain the obvious to upstream. They are either too stubbon, or have an agenda (?), or just don't care. This "gnulib must not be installed" is nonsense - the same can be said about any source-only package.
`gnulib` can be distributed by distributions, as it's done with gettext, and gnulib consumers can just call `gnulib-tool`.

Just revert #29549 if you prefer, it's ugly but at least we don't increase codebase unnecessarily.


---

Comment by mkoeppe created at 2022-07-19 15:21:58

Replying to [comment:88 dimpase]:
> Just revert #29549

No. #29549 solved an actual problem, as explained in the 1st paragraph of the ticket description.


---

Comment by mkoeppe created at 2022-07-19 15:24:07

Replying to [comment:88 dimpase]:
> `gnulib` can be distributed by distributions

But it isn't, and it's beyond the scope of our project to change that.


---

Comment by dimpase created at 2022-07-19 16:53:12

Replying to [comment:90 mkoeppe]:
> Replying to [comment:88 dimpase]:
> > `gnulib` can be distributed by distributions
> 
> But it isn't, and it's beyond the scope of our project to change that.

well, yes, it is distributed by Fedora, !Debian/Ubuntu, Gentoo...


---

Comment by mkoeppe created at 2022-07-19 17:30:54

comment:38, comment:67.


---

Comment by mkoeppe created at 2022-07-19 17:35:41

Replying to [comment:88 dimpase]:
> This "gnulib must not be installed" is nonsense - the same can be said about any source-only package.

What other packages that need to run at bootstrap time do you have in mind?


---

Comment by fbissey created at 2022-07-19 21:27:40

I think we may have to have a vote on what to do on sage-devel. People here have strong opinions on what is the right thing to do and the final decision may have to be done by a third party.


---

Comment by dimpase created at 2022-07-20 09:31:26

Replying to [comment:93 mkoeppe]:
> Replying to [comment:88 dimpase]:
> > This "gnulib must not be installed" is nonsense - the same can be said about any source-only package.
> 
> What other packages that need to run at bootstrap time do you have in mind?

that's not what I had in mind - what I have in mind is an (imaginary, because it'd be insane design) header-only C++ library which comes with a tool to copy some of the headers it provides into the source tree, and the manual saying that you also should commit these copied headers into your tree. All that instead of having it installed and using `#include <...>`...


---

Comment by mkoeppe created at 2022-07-20 16:28:45

Replying to [comment:95 dimpase]:
> what I have in mind is an (imaginary, because it'd be insane design) header-only C++ library which comes with a tool to copy some of the headers it provides into the source tree, and the manual saying that you also should commit these copied headers into your tree.

`nauty` is a real example of this design by upstream. And of course distributions that engage in unvendoring, such as Debian, unvendor nauty from packages that have followed upstream's advice. See for example https://salsa.debian.org/python-team/packages/pynauty/-/tree/debian/latest/debian/patches


---

Comment by dimpase created at 2022-07-20 16:35:33

nauty is designed by Brendan MacKay, who is really very far from software engineering practice - not sure if you know the saga, involving a threat to fork nauty, that resulted in it getting a normal license...


---

Comment by mkoeppe created at 2022-07-20 16:37:32

Yes, everyone agrees that upstream's policy is poorly motivated, and so it makes sense to override it and unvendor nauty from packages that have followed nauty's advice.


---

Comment by mkoeppe created at 2022-07-20 16:38:52

But the situation with Gnulib is different because it has to run at bootstrap time.


---

Comment by mkoeppe created at 2022-07-20 16:39:45

Sorry to explain the obvious, but bootstrap time comes before configure time. It is at configure time that one runs system package discovery.


---

Comment by mkoeppe created at 2022-07-20 16:40:53

Not even Debian overrides the Gnulib maintainers' insight into their package. Well, they tried in 2008(?) -- let me again link https://lists.gnu.org/archive/html/bug-gnulib/2008-11/msg00083.html -- but as of today, Gnulib is not a build dependency of any Debian package. It is packaged as a tool for Debian package maintainers.


---

Comment by mkoeppe created at 2022-07-20 16:43:22

Relevant for the discussion are packages that runs at bootstrap time, not imaginary or real packages that can be discovered at configure time.


---

Comment by mkoeppe created at 2022-07-20 16:43:52

So here's a relevant example: autoconf-archive.


---

Comment by mkoeppe created at 2022-07-20 16:45:19

And we have followed autoconf-archive's documented way to use it: Namely to (manually ðŸ˜±) copy the m4 files into our m4 directory and commit them to our tree.


---

Comment by mkoeppe created at 2022-07-20 16:46:45

Gnulib uses the same model, and in contrast to autoconf-archive it even provides a tool that assists with updating the files.


---

Comment by dimpase created at 2022-07-20 16:47:01

Replying to [comment:102 mkoeppe]:
> Relevant for the discussion are packages that runs at bootstrap time, not imaginary or real packages that can be discovered at configure time.

Certainly, there are already a number of packages which are checked for presence by bootstrap, why not gnulib? It can check for gnulib-tool being available.


---

Comment by dimpase created at 2022-07-20 16:48:17

autoconf-archive is really a collection of independent m4 files, and we actually modify a few of them.


---

Comment by dimpase created at 2022-07-20 16:50:12

gnulib is really much more than a collection of independent m4 files, and we modify none of gnulib-supplied files.


---

Comment by mkoeppe created at 2022-07-20 16:52:55

Replying to [comment:106 dimpase]:
> Certainly, there are already a number of packages which are checked for presence by bootstrap, why not gnulib? It can check for gnulib-tool being available.

What do you imagine would it do if it is not available?


---

Comment by mkoeppe created at 2022-07-20 16:54:51

Replying to [comment:107 dimpase]:
> autoconf-archive is really a collection of independent m4 files, and we actually modify a few of them.

That we modify them without sending the changes upstream is actually a poor practice of our project. See also #29590


---

Comment by mkoeppe created at 2022-07-20 17:07:43

Replying to [comment:108 dimpase]:
> gnulib is really much more than a collection of independent m4 files

Macros in autoconf-archive also have interdependencies. For example, `ax_cxx_compile_stdcxx_11.m4` depends on `ax_cxx_compile_stdcxx.m4`.

> and we modify none of gnulib-supplied files.

I was puzzled before by your comment:86 in the same direction. If there are concerns about maintainability, they should apply to files that are copied in from an upstream and then modified locally! Copying in files and leaving them unmodified is obviously less problematic.


---

Comment by dimpase created at 2022-07-20 17:18:00

Replying to [comment:109 mkoeppe]:
> Replying to [comment:106 dimpase]:
> > Certainly, there are already a number of packages which are checked for presence by bootstrap, why not gnulib? It can check for gnulib-tool being available.
> 
> What do you imagine would it do if it is not available?

the usual for bootstrap thing - resort to downloading configure.spkg


---

Comment by dimpase created at 2022-07-20 17:21:22

Replying to [comment:110 mkoeppe]:
> Replying to [comment:107 dimpase]:
> > autoconf-archive is really a collection of independent m4 files, and we actually modify a few of them.
> 
> That we modify them without sending the changes upstream is actually a poor practice of our project. See also #29590


communication with GNU/FSF greybeards is really above my pay grade. I tried with readline, autoconf, I really don't click with them...


---

Comment by mkoeppe created at 2022-07-20 17:28:01

Replying to [comment:112 dimpase]:
> Replying to [comment:109 mkoeppe]:
> > Replying to [comment:106 dimpase]:
> > > Certainly, there are already a number of packages which are checked for presence by bootstrap, why not gnulib? It can check for gnulib-tool being available.
> > 
> > What do you imagine would it do if it is not available?
> 
> the usual for bootstrap thing - resort to downloading configure.spkg

This would make it harder for developers on macOS (with homebrew or without) or conda to work on tickets that upgrade packages. So they will have to learn about Gnulib even though their package upgrade has nothing to do with it.

And it would make it harder for running our portability CIs: We would no longer be able to bootstrap a source tree from git on all supported platforms without an extra step that downloads/checks out the whole Gnulib.


---

Comment by jhpalmieri created at 2022-07-20 18:10:13

Replying to [comment:94 fbissey]:
> I think we may have to have a vote on what to do on sage-devel. People here have strong opinions on what is the right thing to do and the final decision may have to be done by a third party.

+100


---

Comment by dimpase created at 2022-07-21 08:31:17

Replying to [comment:114 mkoeppe]:
> Replying to [comment:112 dimpase]:
> > Replying to [comment:109 mkoeppe]:
> > > Replying to [comment:106 dimpase]:
> > > > Certainly, there are already a number of packages which are checked for presence by bootstrap, why not gnulib? It can check for gnulib-tool being available.
> > > 
> > > What do you imagine would it do if it is not available?
> > 
> > the usual for bootstrap thing - resort to downloading configure.spkg
> 
> This would make it harder for developers on macOS (with homebrew or without) or conda to work on tickets that upgrade packages. So they will have to learn about Gnulib even though their package upgrade has nothing to do with it.

As far as Homebrew is concerned, it's easy to provide a formula to install gnulib.
Such a formula can be hosted on sagemath GH.
I don't know how easy it is to do the same with Conda.

> 
> And it would make it harder for running our portability CIs: We would no longer be able to bootstrap a source tree from git on all supported platforms without an extra step that downloads/checks out the whole Gnulib.

Come on, that's like 2 lines of shell, to `git clone --depth=1` the `gnulib`, and adjust the path so that  `gnulib-tool` is there. 
We can just add this step to `./bootstrap`, to be run if it can't find `gnulib-tool`.


---

Comment by mkoeppe created at 2022-07-21 16:42:08

This is not getting any better


---

Comment by dimpase created at 2022-07-25 07:19:44

Replying to [comment:117 mkoeppe]:
> This is not getting any better
Why? Because you must blindly follow the upstream's advice?


---

Comment by mkoeppe created at 2022-07-25 16:17:05

comment:27


---

Comment by jhpalmieri created at 2022-07-25 17:42:19

I would have pointed instead to comment:94. I don't see a high likelihood of either Dima or Matthias convincing the other one. Taking the discussion to sage-devel seems like a good solution.


---

Comment by klee created at 2022-07-29 02:40:22

Replying to [comment:37 dimpase]:
> only these who use macOS and only these who do not use anything but Xcode might have to do this. And among the latter only these who need to build ./configure

I am such a developer. I don't know gnulib. I wish that I could upgrade a package without  learning (or struggling to install) gnulib. So I am +1 to Matthias' approach.


---

Comment by dimpase created at 2022-07-29 06:27:51

I never said one must "know" gnulib.
It can all be handled by ./bootstrap script.

But Matthias is against it, as it would violate gnulib overlords commandments...


---

Comment by mkoeppe created at 2022-07-29 06:46:09

Dima, repeating this kind of rhetoric is not helpful for anything.


---

Comment by klee created at 2022-07-29 07:11:35

Replying to [comment:116 dimpase]:
> As far as Homebrew is concerned, it's easy to provide a formula to install gnulib.
> Such a formula can be hosted on sagemath GH.

The gnulib overlord is explicitly against this: https://lists.gnu.org/archive/html/bug-gnulib/2018-02/msg00041.html

Maintaining the homebrew formula ourselves would be as burdensome as keeping a part of gnulib in our source tree.


---

Comment by dimpase created at 2022-07-29 07:52:27

Replying to [comment:124 klee]:
> Replying to [comment:116 dimpase]:
> > As far as Homebrew is concerned, it's easy to provide a formula to install gnulib.
> > Such a formula can be hosted on sagemath GH.
> 
> The gnulib overlord is explicitly against this: https://lists.gnu.org/archive/html/bug-gnulib/2018-02/msg00041.html

that message contains an explict advice against using an outdated gnulib. 

```
Packaging gnulib through a packaging system would have the effect that its
users see an older version of gnulib...
```


Yet your branch does exactly this - as the part of gnulib you copy becomes outdated very soon indeed.


> 
> Maintaining the homebrew formula ourselves would be as burdensome as keeping a part of gnulib in our source tree.

No, no! A brew formula can pull from a git repo. How is it a burden?
https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap


---

Comment by klee created at 2022-07-29 09:05:48

Replying to [comment:125 dimpase]:
> > Maintaining the homebrew formula ourselves would be as burdensome as keeping a part of gnulib in our source tree.
> 
> No, no! A brew formula can pull from a git repo.

I see. Pulling the latest gnulib from the repo sounds nice.

So if gnulib is not available on the system (I guess this is almost always the case), "./configure" would error out saying that I should brew install gnulib before continue. Right? I imagine this would be an extra hurdle for a new user.

> How is it a burden?
> https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap

I guess that practically gnulib in sage would need to be updated very rarely. If so, keeping hombrew formula (and conda formula too?) is a burden unnecessary in Matthias' approach.


---

Comment by dimpase created at 2022-07-29 09:17:23

Replying to [comment:126 klee]:
> Replying to [comment:125 dimpase]:
> > > Maintaining the homebrew formula ourselves would be as burdensome as keeping a part of gnulib in our source tree.
> > 
> > No, no! A brew formula can pull from a git repo.
> 
> I see. Pulling the latest gnulib from the repo sounds nice.
> 
> So if gnulib is not available on the system (I guess this is almost always the case),
no, it's available on !Debian/Ubuntu, Fedora, etc


> "./configure" would error out saying that I should brew install gnulib before continue.
> Right? 

no. It would be done by `./bootstrap`.

configure (and confgure spkg) would already provide what's needed from gnulib.
So anyone who doesn't modify `./configure` won't even notice.

> I imagine this would be an extra hurdle for a new user.
> 
> > How is it a burden?
> > https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap
> 
> I guess that practically gnulib in sage would need to be updated very rarely. If so, keeping hombrew formula (and conda formula too?) is a burden unnecessary in Matthias' approach. 

Matthias' solution dumps a lot of unamended code in Sage git tree, as if there is no internet or a system package to get it from...


---

Comment by klee created at 2022-07-29 11:31:55

Replying to [comment:127 dimpase]:
> Replying to [comment:126 klee]:
> > So if gnulib is not available on the system (I guess this is almost always the case),
> no, it's available on !Debian/Ubuntu, Fedora, etc

I meant mac users...

> > "./configure" would error out saying that I should brew install gnulib before continue.
> > Right? 
> 
> no. It would be done by `./bootstrap`.

So in your solution, `brew install gnulib` will be a prerequisite before `./bootstrap` for a new mac user?

Presently, Xcode is a unique prerequisite to build sage from source. In your solution, `gnulib` will be another one.  

> Matthias' solution dumps a lot of unamended code in Sage git tree, as if there is no internet or a system package to get it from...

I agree that it is not beautiful. But in terms of maintainability, I think unamended code is less problematic than amended. (I am thinking of amended Sphinx extension code in sage)

I guess linux users would prefer your solution, but as a mac user I prefer Matthias' one...


---

Comment by dimpase created at 2022-07-29 11:56:24

I am talking about Homebrew users, not the other macOS users.

Besides, isn't it true that our gfortran doesn't build on the increasingly popular M1 macs, and so just Xcode is not enough any more, anyway.

For mac non-homebrew (and other gnulib-less platforms)  developers we can have few extra lines in bootsrtap to install gnulib into upstream/, if needed.


---

Comment by mkoeppe created at 2022-07-29 18:04:46

Dima, let me try to summarize the approach that you are advocating. Correct me if I get anything wrong.

Dima 1. Start maintaining a homebrew recipe that tracks the `main` branch of Gnulib.

Dima 2. Start maintaining a conda-forge feedstock that tracks the `main` branch of Gnulib.

Dima 3. Extend `bootstrap` so that it uses and runs a `gnulib-tool` found in the system, no matter what version.

Dima 4. Extend `bootstrap` so that if no `gnulib-tool` is found in the system, it uses `git` to checkout the HEAD of the `main` branch of Gnulib, and then runs `gnulib-tool` from there. (This introduces a dependency on `git` for the bootstrapping and a dependency on internet connectivity for bootstrapping.)


---

Comment by dimpase created at 2022-07-29 22:20:19

1 and 2 are optional. 3 and 4 alone would do the job.


---

Comment by mkoeppe created at 2022-07-29 22:27:58

Then would you agree that we leave 1 and 2 out of this discussion altogether? 

These two just seem wildly out of place for our project -- we are not currently maintaining any downstream recipes and for the Sage project to start to do so would require a really good reason, I'd say.

(By the way, homebrew packaging does not work like you suggest. Every package is versioned. There is no package that just goes like "fetch from upstream HEAD". All homebrew recipes that pull from a repository pull from a specific ref. To install a HEAD version instead of the pinned version, there is a special command `brew install --HEAD` that overrides the pin.)


---

Comment by dimpase created at 2022-07-31 09:00:08

Sure we can concentrate on 3 and 4 here.


---

Comment by klee created at 2022-07-31 13:41:11

Replying to [comment:130 mkoeppe]:
> (This introduces a dependency on `git` for the bootstrapping and a dependency on internet connectivity for bootstrapping.)

This is reasonable.


---

Comment by dimpase created at 2022-07-31 13:57:37

Replying to [comment:134 klee]:
> Replying to [comment:130 mkoeppe]:
> > (This introduces a dependency on `git` for the bootstrapping and a dependency on internet connectivity for bootstrapping.)
> 
> This is reasonable.

In fact, `./bootstrap` is already dependent on internet connectivity - if it fails it tries do download `configure.spkg`. For building from git repo, internet connectivity is mandatory too (at least for the 1st build, which fetches tarballs to unstream/).

As well, if someone wants to do a remotely meaningful work on Sage, and that's a reason to run bootstrap, then `git` would already be there.

--------

We should pay more attention to our source tarballs - ideally they should already be configured, and so running bootstrap is never needed.


---

Comment by mkoeppe created at 2022-07-31 15:40:44

Replying to [comment:135 dimpase]:
> We should pay more attention to our source tarballs - ideally they should already be configured, and so running bootstrap is never needed.

You probably mean "they should already be bootstrapped". And yes, they are.


---

Comment by mkoeppe created at 2022-07-31 15:46:12

Given that 4 is necessary to be included in this plan, is there a really a need for 3 or can we eliminate it too and focus on 4?

People don't have gnulib installations in their system installations because even though debian and some other distro do have this package, it is not dependency of any package.


---

Comment by dimpase created at 2022-07-31 16:29:44

Replying to [comment:137 mkoeppe]:
> Given that 4 is necessary to be included in this plan, is there a really a need for 3 or can we eliminate it too and focus on 4?
> 
> People don't have gnulib installations in their system installations because even though debian and some other distro do have this package, it is not dependency of any package.

The plan is to add upstream/gnulib to PATH and check for gnulib-tool in ./bootstrap. 
If found, just call it.

If not, `git clone` gnulib in upstream/ - then gnulib-tool is already there, so it can be called.

This is options 3+4 with almost the same amount of code as for option 4 alone.


---

Comment by mkoeppe created at 2022-07-31 16:41:41

Next question regarding Dima 4: Are you sure you want us to `git clone` from upstream main HEAD? Not checkout a fixed commit?


---

Comment by dimpase created at 2022-08-01 06:56:06

Replying to [comment:139 mkoeppe]:
> Next question regarding Dima 4: Are you sure you want us to `git clone` from upstream main HEAD? Not checkout a fixed commit?

as far as I understand, upstream wants fresh checkouts, in absence of official releases.
So HEAD should it be.


---

Comment by mkoeppe created at 2022-08-01 06:58:28

We are not doing this for any other package. Why do you think it would be OK for `gnulib`?


---

Comment by dimpase created at 2022-08-01 08:46:50

Replying to [comment:141 mkoeppe]:
> We are not doing this for any other package. Why do you think it would be OK for `gnulib`?
Cause that's the advice of upstream, no?


---

Comment by klee created at 2022-08-01 09:10:21

Replying to [comment:142 dimpase]:
> Replying to [comment:141 mkoeppe]:
> > We are not doing this for any other package. Why do you think it would be OK for `gnulib`?
> Cause that's the advice of upstream, no?

It is secure to pull an old one tested for some time.


---

Comment by dimpase created at 2022-08-01 14:24:48

like this? lightly tested, but seems to work
----
New commits:


---

Comment by git created at 2022-08-01 18:18:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-01 19:20:50

Replying to [comment:142 dimpase]:
> Replying to [comment:141 mkoeppe]:
> > We are not doing this [git clone from upstream main HEAD] for any other package. Why do you think it would be OK for `gnulib`?
> Cause that's the advice of upstream, no?

No, it's not. In the message that you refer to in comment:125, they argue against using a random arbitrary version from a package manager (which will be untested for use with the package to be built) -- which is Dima 3.

The Gnulib-provided bootstrap script - https://github.com/coreutils/gnulib/blob/master/top/bootstrap#L84 - does not take an arbitrary version of gnulib-tools from the system. Rather, developers can set the environment variable `GNULIB_SRCDIR` if they want to bring their own copy. 


Dima 4 is equivalent to the "git subcheckout" method of https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh, which we discussed back in comment:16. In https://github.com/coreutils/gnulib/blob/master/top/bootstrap#L98 you can see that it can either check out HEAD or a fixed ref (`GNULIB_REVISION`)

But I see in the current branch you are using a fixed ref, that's great. Could you please add a comment that adds the date of the commit in a comment for reference?


---

Comment by git created at 2022-08-01 20:32:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-08-01 20:38:40

Replying to [comment:146 mkoeppe]:
> Replying to [comment:142 dimpase]:
> > Replying to [comment:141 mkoeppe]:
> > > We are not doing this [git clone from upstream main HEAD] for any other package. Why do you think it would be OK for `gnulib`?
> > Cause that's the advice of upstream, no?
> 
> No, it's not. In the message that you refer to in comment:125, they argue against using a random arbitrary version from a package manager (which will be untested for use with the package to be built) -- which is Dima 3.

How does one know which version is good, and which is not? I presume a version used by Debian or Gentoo is likely to be OK, because it's actually used by many projects. Less sure about an arbitrary commit from the repo, but I expect, as they can't be bothered to tag a release for 9 years, all of them to be OKish.

> 
> The Gnulib-provided bootstrap script - https://github.com/coreutils/gnulib/blob/master/top/bootstrap#L84 - does not take an arbitrary version of gnulib-tools from the system. Rather, developers can set the environment variable `GNULIB_SRCDIR` if they want to bring their own copy. 
> 
> 
> Dima 4 is equivalent to the "git subcheckout" method of https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh, which we discussed back in comment:16. In https://github.com/coreutils/gnulib/blob/master/top/bootstrap#L98 you can see that it can either check out HEAD or a fixed ref (`GNULIB_REVISION`)

maybe. A full checkout of gnulib, submodule or not, is too slow anyway to be useful for us, and it's an overkill.

> 
> But I see in the current branch you are using a fixed ref, that's great. Could you please add a comment that adds the date of the commit in a comment for reference?

done.


---

Comment by mkoeppe created at 2022-08-01 20:47:27

Replying to [comment:148 dimpase]:
> > In the message that you refer to in comment:125, they argue against using a random arbitrary version from a package manager (which will be untested for use with the package to be built) -- which is Dima 3.
> 
> How does one know which version is good, and which is not? I presume a version used by Debian or Gentoo is likely to be OK, because it's actually used by many projects.

I don't know about Gentoo (but see Francois comment:59, comment:61)

And no, on Debian this package is *not* used for anything. It is not a build dependency of any package. comment:101


---

Comment by mkoeppe created at 2022-08-01 20:49:07

Replying to [comment:148 dimpase]:
> How does one know which version is good, and which is not?

You asked that before in comment:46, and I answered it in comment:47.


---

Comment by dimpase created at 2022-08-01 20:53:04

Replying to [comment:149 mkoeppe]:
> Replying to [comment:148 dimpase]:
> > > In the message that you refer to in comment:125, they argue against using a random arbitrary version from a package manager (which will be untested for use with the package to be built) -- which is Dima 3.
> > 
> > How does one know which version is good, and which is not? I presume a version used by Debian or Gentoo is likely to be OK, because it's actually used by many projects.
> 
> I don't know about Gentoo (but see Francois comment:59, comment:61)
> 
> And no, on Debian this package is *not* used for anything. It is not a build dependency of any package. comment:101

"It is packaged as a tool for Debian package maintainers." - you wrote it yourself. So it is used, I presume, just not in the way controlled by official dependencies. 

----

My theory is that gnulib maintainers just can't be bothered to do a sane redesign - no wonder autotools receive so much public hate...


---

Comment by mkoeppe created at 2022-08-01 20:55:16

Replying to [comment:151 dimpase]:
> > And no, on Debian this package is *not* used for anything. It is not a build dependency of any package. comment:101
> 
> "It is packaged as a tool for Debian package maintainers." - you wrote it yourself. So it is used, I presume, just not in the way controlled by official dependencies. 

Yes, for Debian package maintainers (persons) for their convenience in case they need to work on a package that has imported gnulib modules.


---

Comment by mkoeppe created at 2022-08-01 20:57:02

Replying to [comment:150 mkoeppe]:
> Replying to [comment:148 dimpase]:
> > How does one know which version is good, and which is not?
> 
> You asked that before in comment:46, and I answered it in comment:47.

Namely - we treat it like any other package upgrade.


---

Comment by dimpase created at 2022-08-01 20:59:35

Replying to [comment:150 mkoeppe]:
> Replying to [comment:148 dimpase]:
> > How does one know which version is good, and which is not?
> 
> You asked that before in comment:46, and I answered it in comment:47.

if true, this is an insanely wasteful approach - meaning that every, EVERY project using their beloved code must be doing its own testing?! Basically, they go to great heights to prevent organised QA of their code - "please everyone roll your own, and no, you must not organise to do share this burden" ?!


---

Comment by fbissey created at 2022-08-01 21:04:08

I am getting tired of seeing the two of you arguing back and forth without anyone wanting to concede. It is sterile.

We need some form of this ticket in 9.7 for cygwin as far as I understand. If we don't solve your argument soon. Exit cygwin support.

I want you to agree to each write a small brief about your side of the argument and then we will post them on sage-devel for a vote. Someone will not get what they think is right. And if we choose wrong it will be apparent soon enough. But this deadlock has to end.


---

Comment by dimpase created at 2022-08-01 21:07:41

Francois, in fact, today I have here a complete branch, ready for review. IMHO I convinced Matthias to at least look at it :-)


---

Comment by mkoeppe created at 2022-08-01 21:08:47

Dima, I also looked at your previous branch, which was easily seen to be not suitable


---

Comment by mkoeppe created at 2022-08-01 21:11:35

Changing priority from critical to major.


---

Comment by mkoeppe created at 2022-08-01 21:11:35

Replying to [comment:155 fbissey]:
> We need some form of this ticket in 9.7 for cygwin as far as I understand. If we don't solve your argument soon. Exit cygwin support.

No, it has nothing to do with Cygwin.

In fact, there isn't even a bug to be fixed. I thought there was when Marc reported this failure but there is actually no problem that needs to be solved. When gettext-devel is installed (as is documented as a bootstrap dependency), everything works OK.

Present ticket is an improvement that removes the remaining bits of dependency on gettext in our bootstrap process.


---

Comment by fbissey created at 2022-08-01 21:13:07

Changing priority from major to critical.


---

Comment by fbissey created at 2022-08-01 21:13:07

Whatever it is for, it seems even less worth the arguing.

You have been at it for at least 3 weeks. I don't see a breakthrough without a third party being involved. I think a vote is the most equitable thing to do. I am giving you 24 hours from this post to reach an agreement. After that I throw the whole thing on sage-devel for a vote.


---

Comment by mkoeppe created at 2022-08-01 21:13:33

Replying to [comment:154 dimpase]:
> if true, this is an insanely wasteful approach [... by upstream Gnulib]

It's not helpful for this ticket. As I said before, if you want to criticize their design decisions, this is the wrong forum. comment:73


---

Comment by mkoeppe created at 2022-08-01 21:15:54

Replying to [comment:159 fbissey]:
> You have been at it for at least 3 weeks. I don't see a breakthrough without a third party being involved. I think a vote is the most equitable thing to do.

+1, we actually made progress to determining something concrete that can be voted on in comment:130 to comment:133.


---

Comment by mkoeppe created at 2022-08-01 21:22:28

Replying to [comment:146 mkoeppe]:
> In the message that you refer to in comment:125, they argue against using a random arbitrary version from a package manager (which will be untested for use with the package to be built) -- which is Dima 3.
> 
> The Gnulib-provided bootstrap script - https://github.com/coreutils/gnulib/blob/master/top/bootstrap#L84 - does not take an arbitrary version of gnulib-tools from the system. Rather, developers can set the environment variable `GNULIB_SRCDIR` if they want to bring their own copy. 

Remains to be resolved whether Dima 3 is essential to Dima's plan or whether Gnulib's solution for this -- `GNULIB_SRCDIR` -- is acceptable.


---

Comment by dimpase created at 2022-08-01 21:29:29

I'm perfectly fine with only using `./upstream/gnulib/gnulib-tool`, if you don't like  `gnulib-tool` in the PATH.


---

Comment by mkoeppe created at 2022-08-02 01:18:20

OK, could you update your branch please?


---

Comment by git created at 2022-08-02 07:42:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-08-02 07:44:08

Replying to [comment:164 mkoeppe]:
> OK, could you update your branch please?
done


---

Comment by mkoeppe created at 2022-08-02 18:48:36

Thanks.

Looking at the `install_iconv` function in `bootstrap`: If we ever have to upgrade Gnulib (change the hardcoded commit), there is no mechanism that will bring this change to developer's `upstream` directories when `$SAGE_ROOT/upstream/gnulib/gnulib-tool` already exists. So this is not a complete solution yet


---

Comment by mkoeppe created at 2022-08-02 18:50:29

(Neither `make distclean` nor `make bootstrap-clean` clean anything in `upstream/`.)


---

Comment by mkoeppe created at 2022-08-02 18:53:40

Of course, Gnulib has a complete solution for all of this: Its implementation stretches over the following files:
- https://github.com/coreutils/gnulib/blob/master/top/bootstrap
- https://github.com/coreutils/gnulib/blob/master/top/autopull.sh
- https://github.com/coreutils/gnulib/blob/master/top/gitsub.sh
- https://github.com/coreutils/gnulib/blob/master/top/gen-bootstrap.sed


---

Comment by dimpase created at 2022-08-02 20:19:52

I can add removal of upstream/gnulib to bootstrap-clean target


---

Comment by fbissey created at 2022-08-02 21:42:39

Can I take the motions happening in the last 24 hours as a sign you are moving towards a resolution without needing arbitration?


---

Comment by klee created at 2022-08-02 21:56:57

Replying to [comment:171 fbissey]:
> Can I take the motions happening in the last 24 hours as a sign you are moving towards a resolution without needing arbitration?

Yes, they are :)


---

Comment by dimpase created at 2022-08-03 09:38:14

Replying to [comment:170 dimpase]:
> I can add removal of upstream/gnulib to bootstrap-clean target
this is actually not a good idea, as it will force git clone on every run on bootstrap.

On the other hand, `mainainer-clean` target removes `upstream/` all together.
For the purposes of avoiding a possible confusion when `upstream/` is a symbolic link,
I'll add an explicit removal of `upstream/gnulib` to `mainainer-clean`


---

Comment by git created at 2022-08-03 09:40:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-03 18:01:12

I don't think the last change is useful. `rm -rf` does not follow symlinks either way


---

Comment by dimpase created at 2022-08-03 20:06:05

it can be skipped, no problem. After all as soon as upstream/ is a symlink, all bets are off.


---

Comment by git created at 2022-08-04 08:09:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-08-04 09:11:03

Replying to [comment:175 mkoeppe]:
> I don't think the last change is useful. `rm -rf` does not follow symlinks either way
OK, I've dropped it. Anything else?

PS. Compared with the gnulib's `gitsub.sh`, the branch doesn't do a full checkout of their repo (which is 250Mb), it only checks out 83Mb (it probably can be trimmed even more, I didn't look into this). So that's a clear advantage, im my view (checking out a 250Mb repo takes a lot of time).


---

Comment by mkoeppe created at 2022-08-04 17:04:12

I think it is problematic to require developers to know that they need to do `make maintainer-clean` when they pick up a branch with a gnulib version change.

Previously in this thread, you seemed very concerned about the maintenance burden that gnulib updates bring (comment:25, comment:82). The lack of an incremental update mechanism in your current branch places such a burden on developers who aren't even touching gnulib - everyone who runs gnulib.

What do others think about this?


---

Comment by dimpase created at 2022-08-04 20:19:07

Replying to [comment:179 mkoeppe]:
> I think it is problematic to require developers to know that they need to do `make maintainer-clean` when they pick up a branch with a gnulib version change.
> 
> Previously in this thread, you seemed very concerned about the maintenance burden that gnulib updates bring (comment:25, comment:82). The lack of an incremental update mechanism in your current branch places such a burden on developers who aren't even touching gnulib - everyone who runs gnulib.

My main concern always was to avoid copying a lagre chunk of gnulib verbatim into Sage git tree. 

As to incremental updates - you argued that we don't want to follow the upstream closely, i.e. no incremental updates, but just want to pin a gnulib commit, and then, at a good moment, pin a newer one. That's what my branch does.

I can add a comment in ./bootstrap regarding the way to do this kind of update -  that certainly should be enough IMHO.


---

Comment by mkoeppe created at 2022-08-04 20:32:38

Replying to [comment:180 dimpase]:
> As to incremental updates - you argued that we don't want to follow the upstream closely, i.e. no incremental updates, but just want to pin a gnulib commit, and then, at a good moment, pin a newer one. That's what my branch does.

Yes, but developers (everyone who has ever run `./bootstrap` in the tree) will not get the new pin unless they manually run `make maintainer-clean`.


---

Comment by mkoeppe created at 2022-08-04 20:49:41

Replying to [comment:180 dimpase]:
> My main concern always was to avoid copying a lagre chunk of gnulib verbatim into Sage git tree. 

You still haven't quite explained what exactly the nature of this concern is and why it weighs so heavy that it would warrant the complexity of a script that checks out 83 MB from the Gnulib git repo?

To compare with the copied files:

```
$ du -sh config/config.rpath m4/lib-*.m4 m4/iconv.m4 m4/host-cpu-c-abi.m4
 20K	config/config.rpath
8.0K	m4/lib-ld.m4
 36K	m4/lib-link.m4
 12K	m4/lib-prefix.m4
 12K	m4/iconv.m4
 24K	m4/host-cpu-c-abi.m4
```



---

Comment by dimpase created at 2022-08-04 21:59:46

Replying to [comment:182 mkoeppe]:
> Replying to [comment:180 dimpase]:
> > My main concern always was to avoid copying a lagre chunk of gnulib verbatim into Sage git tree. 
> 
> You still haven't quite explained what exactly the nature of this concern is and why it weighs so heavy that it would warrant the complexity of a script that checks out 83 MB 
> from the Gnulib git repo?

The complexity of the 20-line script? Where is the compelexity there? 
There isn't even a loop. 1/3rd of it is about supporting `-q` option of ./bootstrap.

> 
> To compare with the copied files:
> {{{
> $ du -sh config/config.rpath m4/lib-*.m4 m4/iconv.m4 m4/host-cpu-c-abi.m4
>  20K	config/config.rpath
> 8.0K	m4/lib-ld.m4
>  36K	m4/lib-link.m4
>  12K	m4/lib-prefix.m4
>  12K	m4/iconv.m4
>  24K	m4/host-cpu-c-abi.m4
> }}}

This is not Sage's code, it has no place in Sage git tree - and there are means to get it in if needed. And your branch provides absolutely zero support for updating said code, while you keep arguing here that my code provides less than ideal support for it...

To update files in your branch, one would need to manually install gnulib, and run `gnulib-tool` with appropriate options, remove the unneeded files, and check the result in. You already made a mistake setting it up in the previous ticket. 

Updating in my branch is trivial compared to this.


---

Comment by mkoeppe created at 2022-08-04 22:02:04

Replying to [comment:183 dimpase]:
> Replying to [comment:182 mkoeppe]:
> > Replying to [comment:180 dimpase]:
> > > My main concern always was to avoid copying a lagre chunk of gnulib verbatim into Sage git tree. 
> > 
> > You still haven't quite explained what exactly the nature of this concern is and why it weighs so heavy that it would warrant the complexity of a script that checks out 83 MB 
> > from the Gnulib git repo?
> 
> The complexity of the 20-line script? Where is the compelexity there? 

Your script is not complete yet, see comment:179


---

Comment by mkoeppe created at 2022-08-04 22:12:28

Replying to [comment:183 dimpase]:
> Updating in my branch is trivial compared to this.

For the ticket author who works on the gnulib update, yes. For everyone else, as I said, it introduces a burden.


---

Comment by mkoeppe created at 2022-08-04 22:13:05

But maybe you can just find a simple solution for this problem? Just a few more lines of shell script


---

Comment by dimpase created at 2022-08-04 22:24:47

Replying to [comment:184 mkoeppe]:
> Replying to [comment:183 dimpase]:
> > Replying to [comment:182 mkoeppe]:
> > > Replying to [comment:180 dimpase]:
> > > > My main concern always was to avoid copying a lagre chunk of gnulib verbatim into Sage git tree. 
> > > 
> > > You still haven't quite explained what exactly the nature of this concern is and why it weighs so heavy that it would warrant the complexity of a script that checks out 83 MB 
> > > from the Gnulib git repo?
> > 
> > The complexity of the 20-line script? Where is the compelexity there? 
> 
> Your script is not complete yet, see comment:179
As I wrote, I think it suffices to put something like


```
# to update macros coming from gnulib:
# 1) change the commit hash below to the one desired
# 2) remove upstream/gnulib/, e.g. by running 
#    make maintainer-clean
# 3) re-run ./bootstrap
```

in ./bootstrap's `install_iconv()`


---

Comment by mkoeppe created at 2022-08-04 22:25:41

These would be instructions for who?


---

Comment by klee created at 2022-08-04 22:41:25

I am sorry to admit that there is still a chasm between you, and it seems that sage-devel voting is the only way to escape from this seemingly eternal debate...

The voting would be about: 

Dima's approach: install Gnulib by pulling 83 MB from Gnulib git repo (Dima, please rewrite in line of length < 80)

vs

Matthias' approach: install Gnulib by copying 112 KB into sagelib source tree (Matthias, please rewrite in line of length < 80)

Dima writes cons of Matthias' approach in 3 lines of each length < 80

Matthias writes cons of Dima's approach in 3 lines of each length < 80

Then please FranÃ§ois post the voting to sage-devel. Okay?


---

Comment by fbissey created at 2022-08-04 22:45:05

I am afraid it looks that way too. I will once we have the Matthias and Dima's position arguments.


---

Comment by dimpase created at 2022-08-04 22:57:30

Replying to [comment:188 mkoeppe]:
> These would be instructions for who?

for whoever will be updating the version of gnulib we use, isn't it obvious?


---

Comment by mkoeppe created at 2022-08-04 23:00:31

Replying to [comment:191 dimpase]:
> Replying to [comment:188 mkoeppe]:
> > These would be instructions for who?
> 
> for whoever will be updating the version of gnulib we use, isn't it obvious?

You've apparently missed my point in comment:179

Yes, step 1 of your instructions needs to be run by "whoever will be updating the version of gnulib we use", that is, the ticket author.

But step 2 has to be run by everyone who runs `./bootstrap` and switches to a branch that contains such an update ticket.


---

Comment by dimpase created at 2022-08-04 23:31:28

Replying to [comment:192 mkoeppe]:
> Replying to [comment:191 dimpase]:
> > Replying to [comment:188 mkoeppe]:
> > > These would be instructions for who?
> > 
> > for whoever will be updating the version of gnulib we use, isn't it obvious?
> 
> You've apparently missed my point in comment:179
> 
> Yes, step 1 of your instructions needs to be run by "whoever will be updating the version of gnulib we use", that is, the ticket author.
> 
> But step 2 has to be run by everyone who runs `./bootstrap` and switches to a branch that contains such an update ticket.

Ah, right, sorry. So we need to check that the output of `git rev-parse HEAD` in upstream/gnulib repo equals the commit hash hardwired in ./bootstrap, and if not, fetch the latter commit from the repo.


---

Comment by mkoeppe created at 2022-08-04 23:39:28

Replying to [comment:189 klee]:
> Matthias' approach: install Gnulib by copying 112 KB into sagelib source tree (Matthias, please rewrite in line of length < 80)

I've put a short description in the ticket box


---

Comment by git created at 2022-08-04 23:53:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-08-04 23:59:28

Replying to [comment:204 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[fd82fb9](https://git.sagemath.org/sage.git/commit/?id=fd82fb9ea530fab6f9b9b4d2e77a8d0e1c4f565e)||`check that installed gnulib is up to date`||

this is the change as explained in comment:194 - needs testing (I tend to get srting comparison in scripts wrong :-))


---

Comment by fbissey created at 2022-08-05 00:36:35

Ok is the material in the description what you want for going to a vote? Last call before I prepare the post.


---

Comment by mkoeppe created at 2022-08-05 00:37:37

I think Dima should have a chance to edit the description and finish his branch


---

Comment by fbissey created at 2022-08-05 00:49:24

Replying to [comment:209 mkoeppe]:
> I think Dima should have a chance to edit the description and finish his branch

Fair enough, a few hours will not make much difference at this point.


---

Comment by git created at 2022-08-05 09:49:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2022-08-05 09:51:39

OK, fixed the branch, and expanded ticket description.


---

Comment by klee created at 2022-08-05 10:08:52

Matthias's branch link doesn't work.


---

Comment by klee created at 2022-08-05 10:14:58

It seems that `__` at the end of the branch name disappears.


---

Comment by klee created at 2022-08-05 10:38:56

In Dima's branch: the sentence below seems broken. Omit `and`?

```bash
echo >&2 "gnulib-tool needs to be installed and in your PATH. We install a copy in upstream/ "
```



---

Comment by klee created at 2022-08-05 11:21:49

In Dima' branch:

I think it is better to place gnulib at its own directory `gnulib` instead of `upstream/gnulib`, since gnulib is not an ordinary package. It looks odd to me to find the gnulib directory in `upstream` among all those tar files.


---

Comment by mkoeppe created at 2022-08-05 17:22:46

I'm going to add a paragraph to the "Background" that explains in what situations `./bootstrap` must be run.


---

Comment by dimpase created at 2022-08-05 19:47:38

Replying to [comment:220 klee]:
> In Dima' branch:
> 
> I think it is better to place gnulib at its own directory `gnulib` instead of `upstream/gnulib`, since gnulib is not an ordinary package. It looks odd to me to find the gnulib directory in `upstream` among all those tar files.

gnulib is an upstream package which does not provide tarballs. So instead of a tarball one has a directory under git control.


---

Comment by mkoeppe created at 2022-08-05 20:58:40

Let's see if we can reach consensus on the question how often the files / the commit hash will have to be updated. Previously in this thread: 
- dimpase in comment:25 "likely to cause trouble if not updated on time... maintenance is problematic"
- klee in comment:126 "I guess that practically gnulib in sage would need to be updated very rarely."
Historical information on the relevant files of gnulib can be obtained by using `git log build-aux/config.rpath m4/lib-* m4/iconv.m4 m4/host-cpu-c-abi.m4` in a clone of Gnulib. I think the last change relevant for any of our supported platforms is from 2017.


---

Comment by dimpase created at 2022-08-05 21:27:31

By "problematic" I meant it's easy to make an error in your fully manual approach. And it's hard to test, as one needs to uninstall gettext, something that might be hard on some OSs, or create an artificial isolated environment/VM.


My proposal is essentially to add a semi-standard package to Sage (and use it in bootstrap). We have many rarely updated packages, and many packages with tarballs of size tens of Mb (matplotlib, Pillow, SciPy, GAP, giac, etc). I don't get why there is such a pushback against it.


---

Comment by klee created at 2022-08-05 21:49:16

Replying to [comment:231 dimpase]:
 > My proposal is essentially to add a semi-standard package to Sage (and use it in bootstrap). 

I meant that by "not ordinary package".

> By "problematic" I meant it's easy to make an error in your fully manual approach. And it's hard to test, as one needs to uninstall gettext, something that might be hard on some OSs, or create an artificial isolated environment/VM.

If Matthias' approach is adopted after voting, your script could be used as an automatic way to update gnulib in sage.


---

Comment by mkoeppe created at 2022-08-05 21:52:20

Replying to [comment:231 dimpase]:
> it's hard to test, as one needs to uninstall gettext, something that might be hard on some OSs, or create an artificial isolated environment/VM.

No, we already test it automatically on GH Actions in all `-minimal` builds.


---

Comment by dimpase created at 2022-08-05 22:08:44

Replying to [comment:233 mkoeppe]:
> Replying to [comment:231 dimpase]:
> > it's hard to test, as one needs to uninstall gettext, something that might be hard on some OSs, or create an artificial isolated environment/VM.
> 
> No, we already test it automatically on GH Actions in all `-minimal` builds.

yes, this is an artificial isolated environment, and a very fragile one (-minimal builds time out often). We don't have easy means to 
do this locally.


---

Comment by mkoeppe created at 2022-08-05 22:13:44

This can be run locally, and I know that you know this. It's `tox -e docker-ubuntu-jammy-minimal -- config.status` or `tox -e local-homebrew-macos-minimal -- config.status`.


---

Comment by mkoeppe created at 2022-08-05 22:30:41

Replying to [comment:231 dimpase]:
> My proposal is essentially to add a semi-standard package to Sage (and use it in bootstrap). We have many rarely updated packages, and many packages with tarballs of size tens of Mb (matplotlib, Pillow, SciPy, GAP, giac, etc).

That's not a very useful comparison. Our SciPy SPKG builds a 20 MB wheel from a 38 MB source tarball.

```
$ ls -l upstream/scipy-1.8.1.tar.gz
-rw-r--r--  1 mkoeppe  staff  38196215 May 20 09:47 upstream/scipy-1.8.1.tar.gz
$ ls -l venv/var/lib/sage/wheels/SciPy-1.8.1-cp310-cp310-macosx_12_0_x86_64.whl
-rw-r--r--  1 mkoeppe  staff  20700328 Aug  3 00:44 venv/var/lib/sage/wheels/SciPy-1.8.1-cp310-cp310-macosx_12_0_x86_64.whl
```



---

Comment by mkoeppe created at 2022-08-05 22:46:51

I've added "Updates are expected to be necessary only very rarely." to the ticket description. At least this does not seem to be disputed.


---

Comment by mkoeppe created at 2022-08-05 23:16:36

Replying to [comment:232 klee]:
> If Matthias' approach is adopted after voting, [dimpase's] script could be used as an automatic way to update gnulib in sage.

Indeed, as an `spkg-src` script of sorts.


---

Comment by mkoeppe created at 2022-08-05 23:24:12

Replying to [comment:234 dimpase]:
> > No, we already test it automatically on GH Actions in all `-minimal` builds.
> 
> yes, this is an artificial isolated environment, and a very fragile one (-minimal builds time out often). We don't have easy means to 
> do this locally.

Those who are interested in helping improve our testing infrastructure may want to take a look at #34228, #33062, #31505, #34270, #34255, which are waiting for review.


---

Comment by dimpase created at 2022-08-06 08:10:23

Replying to [comment:235 mkoeppe]:
> This can be run locally, and I know that you know this. It's `tox -e docker-ubuntu-jammy-minimal -- config.status` or `tox -e local-homebrew-macos-minimal -- config.status`.


I don't have Docker at work - our sysadmins don't allow it.


---

Comment by dimpase created at 2022-08-06 08:16:12

Replying to [comment:236 mkoeppe]:
> Replying to [comment:231 dimpase]:
> > My proposal is essentially to add a semi-standard package to Sage (and use it in bootstrap). We have many rarely updated packages, and many packages with tarballs of size tens of Mb (matplotlib, Pillow, SciPy, GAP, giac, etc).
> 
> That's not a very useful comparison. Our SciPy SPKG builds a 20 MB wheel from a 38 MB source tarball.

OK, compare with GAP - almost 0.5G tarball, basic install is is few Mb


---

Comment by mkoeppe created at 2022-08-06 13:37:36

Replying to [comment:173 dimpase]:
> Replying to [comment:170 dimpase]:
> > I can add removal of upstream/gnulib to bootstrap-clean target
> this is actually not a good idea, as it will force git clone on every run on bootstrap.
> 
> On the other hand, `maintainer-clean` target removes `upstream/` all together.

By the way, in your branch, `make bootstrap-clean` would need to remove the files that `gnulib-tool import` adds.


---

Comment by mkoeppe created at 2022-08-06 13:50:44

Replying to [comment:241 dimpase]:
> OK, compare with GAP - almost 0.5G tarball, basic install is is few Mb

```
$ du -sh local/share/gap
du: local/share/gap: No such file or directory
$ make gap
[...]
$ du -sh local/share/gap
720M	local/share/gap
```



---

Comment by klee created at 2022-08-06 14:48:22

Replying to [comment:219 klee]:
> In Dima's branch: the sentence below seems broken. Omit `and`?
> {{{#!bash
> echo >&2 "gnulib-tool needs to be installed and in your PATH. We install a copy in upstream/ "
> }}}

I read the sentence wrong. But still this part "`and in your PATH`" seems to cause a confusion on the user(developer) if she is not expected to use the `gnulib-tool` directly.


---

Comment by klee created at 2022-08-07 01:56:35

Developing a comment of mine before, I suggest another candidate for the voting,

hybrid: mkoeppe's and dimpase's branches may be combined. Dima's script is modified to a tool for updating the gnulib files, and kept in, perhaps,  `build/pkgs/gnulib/spkg-src`

Matthias seems to have agreed to this (comment:238). If Dima agrees too, then we don't need to go for the voting.

I am aware that Dima' main concern is to merge external source files into our source tree, but there already exists `m4/` directory filed with such files.

I leave it to FranÃ§ois to decide whether to take the hybrid candidate or not for the voting. I do not insist.


---

Comment by fbissey created at 2022-08-07 02:00:20

If an hybrid both side could live with exists then I do not think we need a vote. The vote would only be to decide between two things that are incompatible.


---

Comment by dimpase created at 2022-08-07 13:18:47

yet another option is to require external gnulib.

I don't recall how easy is to check the version by calling gnulib-tool (afk now).

Assuming the version rarely changes, why not?


---

Comment by mkoeppe created at 2022-08-09 19:10:13

Replying to [comment:248 dimpase]:
> yet another option is to require external gnulib.

In the nomenclature of comment:130, that's Dima 3 as a standalone. We have discussed it at length already.


---

Comment by mkoeppe created at 2022-08-12 22:20:17

Replying to [comment:247 fbissey]:
> If an hybrid both side could live with exists then I do not think we need a vote. The vote would only be to decide between two things that are incompatible.

It sounds like it's time for a vote


---

Comment by dimpase created at 2022-08-14 20:24:17

I'm without a fast internet and mostly in vacation mode in the coming week.


---

Comment by mkoeppe created at 2022-08-14 20:44:16

Replying to [comment:251 dimpase]:
> I'm without a fast internet

Sorry, hard to resist: This means you can't test your branch, right?


---

Comment by dimpase created at 2022-08-14 20:57:14

surely, installing Sage using a mobile phone connection is a multilevel challenge...


---

Comment by mkoeppe created at 2022-08-22 21:47:11

Replying to [comment:246 klee]:
> Developing a comment of mine before, I suggest another candidate for the voting,
> 
> hybrid: mkoeppe's and dimpase's branches may be combined. Dima's script is modified to a tool for updating the gnulib files, and kept in, perhaps,  `build/pkgs/gnulib/spkg-src`
> 
> Matthias seems to have agreed to this (comment:238). If Dima agrees too, then we don't need to go for the voting.

I've prepared the hybrid version as outlined above.
----
New commits:


---

Comment by @GMS103 created at 2022-08-23 00:05:10

Replying to [comment:159 fbissey]:

> You have been at it for at least 3 weeks. I don't see a breakthrough without a third party being involved. I think a vote is the most equitable thing to do. I am giving you 24 hours from this post to reach an agreement. After that I throw the whole thing on sage-devel for a vote.

Please FranÃ§ois, could you put up the vote?


---

Comment by mkoeppe created at 2022-08-23 00:10:43

I think people have been waiting for Dima to react to this:

Replying to [comment:246 klee]:
> Matthias seems to have agreed to this (comment:238). If Dima agrees too, then we don't need to go for the voting.


---

Comment by fbissey created at 2022-08-23 01:10:27

I have been quite busy since it is not a holidays period in the southern hemisphere. There is the point Matthias just made and my current lack of motivation because of stuff happening all over the place right now (I mean locally not globally, although that's also demoralizing).


---

Comment by klee created at 2022-08-23 07:58:30

Replying to [comment:260 fbissey]:
> I have been quite busy since it is not a holidays period in the southern hemisphere. There is the point Matthias just made and my current lack of motivation ...

I am giving you 24 hours from this post to put up the vote. After that, I will take the role and put up the vote.

Dima seems to just want the voting.


---

Comment by fbissey created at 2022-08-23 08:18:52

Replying to [comment:261 klee]:
> Replying to [comment:260 fbissey]:
> > I have been quite busy since it is not a holidays period in the southern hemisphere. There is the point Matthias just made and my current lack of motivation ...
> 
> I am giving you 24 hours from this post to put up the vote. After that, I will take the role and put up the vote.
> 
> Dima seems to just want the voting.
> 

Then don't wait :) I am quite happy for you to take the role of convenor. I just fixed my daughter bed frame and I had enough for the day.


---

Comment by dimpase created at 2022-08-23 09:20:16

the current branch still puts over 100K of gnulib's code into Sage git tree.
And this is the main point I don't approve of.


---

Comment by klee created at 2022-08-23 10:48:36

Replying to [comment:262 fbissey]:
> Then don't wait :) I am quite happy for you to take the role of convener. 

I need that time for me :) to prepare myself for the thing that people would vote about. You are still the better person for this job.


---

Comment by klee created at 2022-08-23 13:02:59

The branches linked in `hybrid` and `mkoeppe` are the same.


---

Comment by mkoeppe created at 2022-08-23 13:18:53

Sorry, I've fixed the link in the description now


---

Comment by nbruin created at 2022-08-24 03:09:04

OK, so if I understand the problem correctly:
 - we need 5 files in "m4" from "gnulib":

``` 
m4/host-cpu-c-abi.m4	
m4/iconv.m4
m4/lib-ld.m4
m4/lib-link.m4
m4/lib-prefix.m4
```

 - the only officially supported way to get these is by a git pull
 - there are objections to having git as a prereq for bootstrapping a sagemath build

The "hybrid" solution:
 - checks the relevant files into the sagemath repo
 - includes a tool to pull from git and update those checked-in files

That means the "hybrid" solution is very robust once the files are successfully checked in: no dependency on anything outside of sagemath!

Ugly bit: we now have files in the sagemath repo that should definitely not be edited! There's another process to update them. It seems to me the ideal solution would be if there is a tarball somewhere that we CAN use to get those files from. We could do that, right? we could host a tiny repo inside sagemath that manages the tool to make the tarball by pulling from the gnulib repo and then host that tarball in our "mirror" infrastructure. Would the "spkg" download-and-resolve infrastructure already be available pre-bootstrap? or is in reasonable to special-case the download?

It looks to me like the pain of maintaining a tarball that can be referenced should be weighed against the impurity of having files under our git control that don't really belong there. But that could be processed as an improvement over "hybrid" which eminently looks like a maintainable solution.


---

Comment by mkoeppe created at 2022-08-24 03:49:47

Replying to [comment:269 nbruin]:
> OK, so if I understand the problem correctly:
>  - we need 5 files in "m4" from "gnulib":
> {{{ 
> m4/host-cpu-c-abi.m4	
> m4/iconv.m4
> m4/lib-ld.m4
> m4/lib-link.m4
> m4/lib-prefix.m4
> }}}
>  - the only officially supported way to get these is by a git pull
>  - there are objections to having git as a prereq for bootstrapping a sagemath build

(... and triggering an 80MB pull to get 100kB of files...)

> The "hybrid" solution:
>  - checks the relevant files into the sagemath repo
>  - includes a tool to pull from git and update those checked-in files
> 
> That means the "hybrid" solution is very robust once the files are successfully checked in: no dependency on anything outside of sagemath!

That's right.

> Ugly bit: we now have files in the sagemath repo that should definitely not be edited! 

Yes. It shares this property with other files in our `m4/` directory, from autoconf-archive - see discussion in comment:103 and following. It's just a "fact of life" - bootstrapping has to start somewhere.


---

Comment by dimpase created at 2022-08-24 08:50:15

Since Nils proposed to create a tarball for `gnulib` and host it somewhere, as an alternative to using git to
clone `gnulib`, I've done it here:
https://github.com/dimpase/gnulib/releases/tag/1.1beta

As you see, an `xz -9`-comperessed tarball is under 4.5Mb, instead of 80Mb via `git clone` - note that git normally uses compression (zlib) on the fly, meaning that in fact the amount of data transferred by `git clone` is perhaps only 1/10th of 80 Mb.

This places gnulib tarball size among rather average Sage spkgs.


---

Comment by tmonteil created at 2022-08-24 09:05:16

According to the merged branch of #29549, we seem to only need `config/config.rpath` `m4/iconv.m4` from `gnulib`. Am i understanding correctly ?


---

Comment by tmonteil created at 2022-08-24 09:18:54

Or, are `m4/host-cpu-c-abi.m4`, `m4/lib-ld.m4`, `m4/lib-link.m4` and `m4/lib-prefix.m4` required as well ?


---

Comment by dimpase created at 2022-08-24 09:25:36

Replying to [comment:273 tmonteil]:
> Or, are `m4/host-cpu-c-abi.m4`, `m4/lib-ld.m4`, `m4/lib-link.m4` and `m4/lib-prefix.m4` required as well ?
yes, they are needed, too. Note that this ticket actually fixes a bug created in #29549 - the thing is that these files (perhaps, different versions) are also available as a part of gettext development on the system, so if you had the latter installed, you won't need this, more or less.

All together we need something like 112Kb from gnulib.


---

Comment by tmonteil created at 2022-08-24 09:46:32

Replying to [comment:274 dimpase]:
> Replying to [comment:273 tmonteil]:
> > Or, are `m4/host-cpu-c-abi.m4`, `m4/lib-ld.m4`, `m4/lib-link.m4` and `m4/lib-prefix.m4` required as well ?
> yes, they are needed, too. Note that this ticket actually fixes a big - the thing is that these files (perhaps, different versions) are also available as a part of gettext development on the system, so if you had the latter installed, you won't need this, more or less.
> 
> All together we need something like 112Kb from gnulib.

OK, thanks. What is wrong with shipping only those files within a `gnulib_cropped` (or `gnulib_iconv`) spkg as we do with boost or did with mathjax 2 ?


---

Comment by dimpase created at 2022-08-24 09:53:30

nothing much - except it cannot be an ordinary spkg, due to chicken vs egg issue.


---

Comment by mkoeppe created at 2022-08-24 16:31:51

Replying to [comment:271 dimpase]:
> Since Nils proposed to create a tarball for `gnulib` and host it somewhere, as an alternative to using git to
> clone `gnulib`, I've done it here:
> https://github.com/dimpase/gnulib/releases/tag/1.1beta
> 
> As you see, an `xz -9`-compressed tarball is under 4.5Mb, instead of 80Mb via `git clone` - note that git normally uses compression (zlib) on the fly, meaning that in fact the amount of data transferred by `git clone` is perhaps only 1/10th of 80 Mb.
> 
> This places gnulib tarball size among rather average Sage spkgs.

Since we're doing numbers again (after comment:231, comment:236, comment:241, comment:243), let me just point out that the ratio 80 MB : 112KB after said compression changes to 4.5Mb : 22kB

```
$ tar cfz gl.tgz  config/config.rpath m4/lib-*.m4 m4/iconv.m4 m4/host-cpu-c-abi.m4
$ ls -l gl.tgz
-rw-r--r--  1 mkoeppe  staff  22688 Aug 24 09:21 gl.tgz
```

... and is thus still in the "ludicrous" range.


---

Comment by nbruin created at 2022-08-24 18:40:26

It sounds like a `gnulib_cropped` package would strike a nice balance if hosting the files under sagemath git control is too impure. But it sounds like it's a bit of a one-off (because the normal spkg tools are not available yet when it's needed) and perhaps not worth the effort for what we get from it.

I'll have a go at a "conceptual" design, having the benefit of not having the technical knowledge to delve into details (a good design can be understood on a conceptual level, but I won't claim there exists a reasonable converse):

Perhaps there are other files/artifacts that we need but don't really want to "git" control ourselves, and are needed before our normal spkg infrastructure (which is normally responsible for this) is available?
I saw `autoconf-archive` mentioned before? So would this be more worthwhile if we'd have a `bootstrap-aux.spkg` that has all this crap in it?

The tools for *building* that `spkg` could just be the normal tools: in the building process, it would clone `gnulib` and extract the required files and similarly fetch `autoconf-archive` and extract (and patch?) what it needs, and then wrap that up in something that would look like a normal `spkg`.

However, this package would normally not be *installed* through the normal means -- instead, when bootstrap needs it, it would locate an appropriate `spkg` file (or download it) and then extract what's necessary from it by virtue of it being a tarball.

Or perhaps fulfilling the bootstrap-aux resources needs to happen in a pre-bootstrap step, that augments our git repo with some auxiliary external files?

This makes me think Matthias comment "bootstrapping has to start somewhere" might apply and make this not worthwhile, but perhaps someone else can see a way of making something like this work without too much trouble.


---

Comment by mkoeppe created at 2022-08-24 19:08:22

I think it is useful to think about why it is that the idea of having these files in `m4` elicits such strong emotions regarding "uncleanliness" in some of us, that some of us want to go to extremes (such as the bizarre solution in #27823, which introduced the gettext dependency; or accepting a bloat factor of 1000, comment:278) -- just to avoid the unclean feeling.

I have to admit that when I first used gnulib (in a more substantial way than here, namely to implement relocatability for LattE, around 2007) that I was also kind of offended by the idea of adding its imported files to my pristine CVS repository.

So here's some food for thought: The strong emotional response may be the result of decades of abuse that we endured by the early version control systems (RCS, CVS, SVN): If you committed something "unclean" to the central system, the system would come back and hurt you.

This is all outdated with git.


---

Comment by klee created at 2022-08-24 19:33:51

Regardless of the numbers, for me (and others perhaps), the thing is "another dependency on external resource that needs to be fetched through internet at build time" vs "the resource is already in".


---

Comment by mkoeppe created at 2022-08-24 19:38:55

Absolutely, I for sure don't want to have to do some manual workaround if I do a `git worktree create` while out in the wilderness without broadband access.


---

Comment by dimpase created at 2022-08-24 19:58:01

solution in #27823 has advantages: 1) `gettext` is a properly versioned package, not that pile of goo called `gnulib`; 2) it does not check in anything alien into Sage git tree.


---

Comment by nbruin created at 2022-08-24 20:05:23

Replying to [comment:281 klee]:
> ... the thing is "another dependency on external resource that needs to be fetched through internet at build time" vs "the resource is already in".

But when I build sage from a fresh `git clone` the system already goes and measure speeds to mirrors, and (I think) fetch some spkgs. I presume the tarballs (or at least some fat versions of them) still come with those spkgs included, so that no internet connection is necessary to build those?

I also recently learned that on all my previous builds, apparently `bootstrap -D` has executed, downloading a configuration from somewhere.

So it seems to me that if the bootstrap auxiliaries can be packaged in an spkg, we could provide the resources through an already-required pathway, so that shouldn't really make things more fragile.

That is provided that the `bootstrap-aux.spkg` locating/downloading can actually be done through normal means. If we have to special-case its discovery too much then *that* would probably make it more fragile and hence not worth it.

I think it is important that for sagemath we do remain in a state where, after installing a well-defined set of prereqs (which should be commonly provided bits on our supported platforms) and obtaining a well-defined tarball, one should be able to build sage without internet access.

I think that rule was previously already violated by `gettext-devel` being a soft prereq for which a silent workaround required internet access (in the form of `bootstrap -D`, which apparently does need internet access), so getting that solved is already progress. That can also be solved by declaring `gettext-devel` a hard prereq (provided it's a commonly provided component).


---

Comment by mkoeppe created at 2022-08-24 21:09:56

Replying to [comment:284 nbruin]:
> Replying to [comment:281 klee]:
> > ... the thing is "another dependency on external resource that needs to be fetched through internet at build time" vs "the resource is already in".
> 
> But when I build sage from a fresh `git clone` the system already goes and measure speeds to mirrors, and (I think) fetch some spkgs.

Yes, it does after the "configure" phase has been completed and it starts to build packages.

> I presume the tarballs [...] still come with those spkgs included, so that no internet connection is necessary to build those?

Yes, the tarballs include all standard packages and come pre-bootstrapped. No internet connection is needed.

> I also recently learned that on all my previous builds, apparently `bootstrap -D` has executed, downloading a configuration from somewhere.

Yes, this happens when you switch branches that touch any of the files listed here: https://github.com/sagemath/sage/blob/develop/Makefile#L43: It knows it should re-bootstrap. When the bootstrapping prerequisites are missing, it falls back to `bootstrap -D`, which retrieves the SPKG containing the bootstrapping results as of the release that the branch is based on. This is OK if that branch made no actual changes to these files compared to that release -- but it will silently give you something that's not suitable otherwise.


---

Comment by nbruin created at 2022-08-25 07:42:47

Replying to [comment:285 mkoeppe]:
> `bootstrap -D`, which retrieves the SPKG containing the bootstrapping results as of the release that the branch is based on.

OK, so if `bootstrap -D` can retrieve an SPKG then it could also locate/retrieve an SPKG with m4 artifacts compiled from gnulib and autoconf-archive derived files. It would seem that this approach would lead to a scenario that is no less fragile than what we have already? Declaring this to be a "standard" SPKG would mean it's part of tarballs and hence that those would acquire the capability of bootstrapping without an internet connection.

It would just require that someone invests the time to build the requisite spkg.

To me that doesn't sound worse than the "hybrid" solution and for some it would have a conceptual advantage of not checking in other project's files.


---

Comment by klee created at 2022-08-26 13:13:05

Nils seems to be proposing yet another solution for the present ticket, instead of arguing merits or demerits of the candidate solutions of the ongoing vote.

The vote is to finish endless debates about solutions for this ticket. Proposing another solution at this moment, regardless of its own merits, would just disrupt the vote.

By the result of the vote, this ticket will be closed with adopting one solution from the candidates.

Nils may open another ticket for his idea, but that should build upon the present ticket.


---

Comment by nbruin created at 2022-08-26 16:35:05

Replying to [comment:287 klee]:
> Nils seems to be proposing yet another solution for the present ticket, instead of arguing merits or demerits of the candidate solutions of the ongoing vote.

Yes, indeed. I explored whether an SPKG solution could be robust and organized in such a way that the tarball isn't overly large. The answer seems to be yes: everything needed for locating spkgs is already available at bootstrap time, since this is implemented in python script in build, which run on the prerequisite python.

Once the vote has completed, we should implement whatever solution resolves this mess ASAP because the current state results in breakage of sagemath building. If after that someone has appetite for a cleaner solution, it looks like it's possible to provide one. I do not have the expertise for it, so I won't be pursuing it.


---

Comment by dimpase created at 2022-08-26 19:17:58

Here what Bruno Haible (on of primary authors of gnulib/gettext) has to say about our problem:
https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00103.html
Note that he does not suggest to check bits of gnulib in our git tree.
(and elsewhere he says he seldom sees this done: https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00102.html)


```
Dima Pasechnik wrote:
> We are in fact having a fight now over whether to check in the
> iconv pieces produced by gnulib-tool into the source tree, or call 
> gnulib-tool at bootstrap.
> https://trac.sagemath.org/ticket/34152

OK, now let's talk about the actual problem at hand.

I won't jump into the discussion there, because
  - it's already a very long thread,
  - I don't know what an "SPKG" is,
  - I don't know about the preferred habits in the sagemath dev community.

But there I read:
> $ du -sh config/config.rpath m4/lib-*.m4 m4/iconv.m4 m4/host-cpu-c-abi.m4
>  20K  config/config.rpath
> 8.0K  m4/lib-ld.m4
>  36K  m4/lib-link.m4
>  12K  m4/lib-prefix.m4
>  12K  m4/iconv.m4
>  24K  m4/host-cpu-c-abi.m4

Yes, these is currently the list of files needed for AM_ICONV.

> It's some kind of a weird tradition of jumping through hoops to get
> config.rpath

If you need only a few files from Gnulib, the common approach is
to invoke either gnulib-tool (if present, indicated through an
environment variable GNULIB_SRCDIR that the user can set) or
fetch the files from the git repository one by one.

To fetch only config.rpath:

GNULIB_REPO_URL="https://git.savannah.gnu.org/gitweb/?p=gnulib.git;a=blob_plain;hb=HEAD;f=";
for file in build-aux/config.rpath; do
  if test -n "$GNULIB_SRCDIR" && test -d "$GNULIB_SRCDIR"; then
    "GNULIB_SRCDIR/gnulib-tool" --copy-file $file $file
  else
    wget -q --timeout=5 -O $file.tmp "${GNULIB_REPO_URL}$file" \
      && mv $file.tmp $file
  fi
done

To fetch all 6 files:

GNULIB_REPO_URL="https://git.savannah.gnu.org/gitweb/?p=gnulib.git;a=blob_plain;hb=HEAD;f=";
for file in build-aux/config.rpath m4/lib-ld.m4 m4/lib-link.m4 m4/lib-prefix.m4 
m4/iconv.m4 m4/host-cpu-c-abi.m4; do
  if test -n "$GNULIB_SRCDIR" && test -d "$GNULIB_SRCDIR"; then
    "GNULIB_SRCDIR/gnulib-tool" --copy-file $file $file
  else
    wget -q --timeout=5 -O $file.tmp "${GNULIB_REPO_URL}$file" \
      && mv $file.tmp $file
  fi
done

This is the quick solution, which minimizes network traffic. But it is not
future-proof: At any moment, some more files may become needed, due to
changes in the *.m4 files. The future-proof solution is to download
the gnulib git repository (shallow, if you want) and run
  $GNULIB_SRCDIR/gnulib-tool [OPTIONS] --import iconv

> I don't quite understand the relationship between automake, gettext, and
> gnutools here. Is AM_ICONV even meant to work without gnulib?
> Or is it a libtool bug?

AM_ICONV is documented in two places:
- https://www.gnu.org/software/gettext/manual/html_node/AM_005fICONV.html
- https://www.gnu.org/software/gnulib/MODULES.html#module=iconv

The consumption as a gnulib module is meant to be easier than through
gettext. A lot of work has been put into gnulib to make such a consumption
easy; gettext (autopoint) lags behind in this aspect.

> https://lists.gnu.org/archive/html/bug-gettext/2011-10/msg00012.html

Already in 2011, if you need only AM_ICONV, the gnulib module 'iconv'
was the better choice.

> config.rpath (in gnulib) appears to be an orphan.

No. It is maintained in gnulib, as you can see from the commit history.

> (Does gettext misappropriate prefixes AM_ and
> AC_ for its macros, making an impression that they are from autotools?)

Yes, the prefix AM_ here is a mistake. It should better be gl_. But
changing it now would cause more annoyance than benefit.
```



---

Comment by mkoeppe created at 2022-08-26 19:42:35

Dima, I suggested that you take your complaints about upstream gnulib to their mailing list in comment:73 and again in comment:87, 6 weeks ago, but you declined to do so in comment:88.

I see that now you did, after all, yesterday or so, in https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00089.html, and you are writing:

```
If a project does not use git's submodules, noone wants an extra
complexity of submodules to be added to the build system just due to
the need for gnulib.
In some projects I am or was involved, it's basically the case that the code 
injected by
the gnulib-tool got committed into the tree, and blissfully forgotten
about. 
```

Yes, having the gnulib-imported modules "blissfully forgotten" is exactly what my approach (and the hybrid approach) is achieving. You now seem to acknowledge that it's common practice, which sounds like a way to a peaceful resolution of what we discussed here in this ticket.


---

Comment by dimpase created at 2022-08-26 19:55:44

> You now seem to acknowledge that it's common practice, which sounds like a way to a peaceful resolution of what we discussed here in this ticket. 

No, you are twisting my words, please stop. I never conducted a study of this (and I trust Bruno did, one way or another, arriving to the conclusion opposite).

I also wrote there, and got a confirmation from a Gentoo developer, that "code 
injected by
the gnulib-tool got committed into the tree, and blissfully forgotten" is a bad approach.


---

Comment by mkoeppe created at 2022-08-26 19:58:20

Replying to [comment:289 dimpase]:
> Here what Bruno Haible (on of primary authors of gnulib/gettext) has to say about our problem:
> https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00103.html
> Note that he does not suggest to check bits of gnulib in our git tree. [...]

In the previous message, https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00102.html, Bruno writes this:

```
In [1] we document three approaches, dependending on the package's usual
handling of imported/generated files.

Dima Pasechnik wrote:
> [...]
> Why you at gnulib headquarters want large chunks of gnulib
> scattered accross many, many thousands of downstream git trees, I don't know.

This is not what we "want". The documentation [1] gives three options. You
choose the one that fits best for your package.

[1] https://www.gnu.org/software/gnulib/manual/html_node/VCS-Issues.html
```

He is confirming what the manual is saying, disputing your comment:72


---

Comment by jhpalmieri created at 2022-08-26 20:05:21

This is fun.

I suggest that we stop the discussion and just agree to abide by the vote on sage-devel, which is still ongoing.


---

Comment by mkoeppe created at 2022-08-26 20:07:22

+1, with the recommendation for everyone interested to read the whole thread in https://lists.gnu.org/archive/html/bug-gnulib/2022-08/msg00089.html


---

Comment by tmonteil created at 2022-08-27 23:14:09

Replying to [comment:287 klee]:
> Nils seems to be proposing yet another solution for the present ticket, instead of arguing merits or demerits of the candidate solutions of the ongoing vote.
> 
> The vote is to finish endless debates about solutions for this ticket. Proposing another solution at this moment, regardless of its own merits, would just disrupt the vote.
> 
> By the result of the vote, this ticket will be closed with adopting one solution from the candidates.
> 
> Nils may open another ticket for his idea, but that should build upon the present ticket.

This only shows that asking people to vote on a proposal that was constructed by few other people without letting them to debate and improve the proposal first is a bad habit. We already experienced similar "vote don't discuss" procedure by the past, including the "code of conduct" episode. If a better proposal emerges, i do not see in the name of what it could not be chosen over the previous ones.


---

Comment by klee created at 2022-08-28 00:24:28

Replying to [comment:295 tmonteil]:
> This only shows that asking people to vote on a proposal that was constructed by few other people without letting them to debate and improve the proposal first is a bad habit. 

We would be choked if we start a discussion on the procedure of voting that is likely to lead to a voting :) If you want the discussion anyway, please open it on sage-devel.


---

Comment by nbruin created at 2022-08-28 01:30:11

Replying to [comment:295 tmonteil]:
> This only shows that asking people to vote on a proposal that was constructed by few other people without letting them to debate and improve the proposal first is a bad habit. We already experienced similar "vote don't discuss" procedure by the past, including the "code of conduct" episode. If a better proposal emerges, i do not see in the name of what it could not be chosen over the previous ones.

This problem must urgently be resolved: presently, you can have a valid setup according to the documentation and yet be unable to build/configure the last couple of sagemath beta releases.

As far as I could see, a valid solution could have been "gettext-devel is a prereq for sagemath" (a really ugly one, though) but the solutions on the ticket at the moment would work too. I think the priority is to get *something* merged that resolves the acute problem.

Once we have a somewhat workable solution in place that at least allows people to build sage, we can look if the solution, like any piece of sage, can be improved. Who knows, perhaps a better solution even gets merged before a release is actually made! But we cannot really wait for that now.


---

Comment by fbissey created at 2022-08-28 01:43:59

Replying to [comment:295 tmonteil]:
> Replying to [comment:287 klee]:
> > Nils seems to be proposing yet another solution for the present ticket, instead of arguing merits or demerits of the candidate solutions of the ongoing vote.
> > 
> > The vote is to finish endless debates about solutions for this ticket. Proposing another solution at this moment, regardless of its own merits, would just disrupt the vote.
> > 
> > By the result of the vote, this ticket will be closed with adopting one solution from the candidates.
> > 
> > Nils may open another ticket for his idea, but that should build upon the present ticket.
> 
> This only shows that asking people to vote on a proposal that was constructed by few other people without letting them to debate and improve the proposal first is a bad habit. We already experienced similar "vote don't discuss" procedure by the past, including the "code of conduct" episode. If a better proposal emerges, i do not see in the name of what it could not be chosen over the previous ones.
> 

Your suggestion has some merits but there is no one size fits all for all cases. Problem: you have people arguing over two possible solution. You invite more sage developers in and now you have people arguing over 8 different solutions (Ok, I am exaggerating but I really see that kind of things as a real possibility). I'll take responsibility for calling the vote on this particular occasion. I was invited on the ticket but it became clear that I wouldn't sway one side over the other and I had nothing much more to offer to the ticket. May be calling someone else would have been better in this case.


---

Comment by fbissey created at 2022-08-29 00:08:37

Not a large participation but of those who voted, the hybrid approach was clearly prefered.

* hybrid: 8
* pseudo-package: 2
* copy: 0


---

Comment by mkoeppe created at 2022-08-29 01:12:51

I reviewed Dima's script while transforming it to the `spkg-src` script on the current branch.


---

Comment by klee created at 2022-08-29 02:32:20

It looks good to me, except those m4 files of external origin. But we decided to accept them.


---

Comment by nbruin created at 2022-08-29 03:11:58

Replying to [comment:302 klee]:
> It looks good to me, except those m4 files of external origin. But we decided to accept them.
If you put it like that, it's almost an argument _for_ checking them in: by keeping them out of the tree, they'd be invisible for review and yet the files are used to build sagemath. When we put them into the repo at least it's clear for all to see those particular pieces of code that we depend on. We have of course plenty of dependencies that we don't put through our usual review process ...

Anyway, thanks for getting the review process for this on track! I'm happy to see this problem is being resolved now. If people care enough to implement a nicer solution they can do so.


---

Comment by mkoeppe created at 2022-08-29 03:18:03

Replying to [comment:303 nbruin]:
> by keeping them out of the tree, they'd be invisible for review and yet the files are used to build sagemath. When we put them into the repo at least it's clear for all to see those particular pieces of code that we depend on. We have of course plenty of dependencies that we don't put through our usual review process ...

Yes, this is an important point, and it matches an earlier discussion that we had on sage-devel regarding monorepo vs. multirepo strategies (in the context of the Sage library, not the Sage distribution): https://groups.google.com/g/sage-devel/c/AaKxoNQAWMg/m/uY1rW5n0BQAJ

Related: https://groups.google.com/g/sage-devel/c/JBFbtUNhqNU/m/KuySNvTuBAAJ


---

Comment by mkoeppe created at 2022-08-30 19:09:27

Let's finally get this ticket in please.


---

Comment by klee created at 2022-08-30 23:38:37

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-08-31 01:40:27

Thanks!


---

Comment by mkoeppe created at 2022-08-31 01:50:34

Changing priority from critical to blocker.


---

Comment by vbraun created at 2022-09-07 23:10:40

Resolution: fixed
