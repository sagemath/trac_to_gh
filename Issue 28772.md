# Issue 28772: error using mpmath

Issue created by migration from https://trac.sagemath.org/ticket/29009

Original creator: @nouret

Original creation time: 2020-01-14 13:54:51

CC:  dimpase

Keywords: mpmath

I have a problem with sage on python3, example sage8.9 and 9.0

simple code:

```
import mpmath
mpmath.mp.prec = 1000
mpmath.findroot(lambda x: x^2 - 3, 2)

______________________

OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "sage/libs/mpmath/ext_main.pyx", line 1691, in sage.libs.mpmath.ext_main.mpf_base.__repr__ (build/cythonized/sage/libs/mpmath/ext_main.c:21256)
    return "mpf('%s')" % to_str(self._mpf_, n)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py", line 1242, in to_str
    sign, digits, exponent = to_digits_exp(s, dps+3)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py", line 1200, in to_digits_exp
    digits = numeral(sd, base=10, size=dps)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py", line 158, in numeral_python
    A, B = divmod(n, base**half)
SystemError: <built-in function divmod> returned a result with an error set
```





Problem is on File ".../SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py", line 161, in numeral_python

and using

```
A, B = n // (base**half), n % (base**half)
```

instead of

```
A, B = divmod(n, base**half)
```

solves this problem


---

Comment by egourgoulhon created at 2020-01-14 18:23:47

Changing keywords from "mpmath" to "mpmath, py3, python3".


---

Comment by egourgoulhon created at 2020-01-14 18:25:59

As pointed out in this [sage-support thread](https://groups.google.com/d/msg/sage-support/T1Ig6k95_Z0/onv4SW9TCAAJ), everything is fine with the Python 2 version of Sage 9.1.beta0.


---

Comment by paulmasson created at 2020-01-14 19:42:57

Upstream: https://github.com/fredrik-johansson/mpmath/issues/503


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by soehms created at 2021-04-16 06:26:53

Changing status from new to needs_review.


---

Comment by soehms created at 2021-04-16 06:26:53

The bug reported here is located in the Sage integer class, more precisely in the method `quo_rem` which is invoked from the code in `numeral_python`. Note that it disappears if you deactivate the mpmath sage backend, that means to call `os.environ['MPMATH_NOSAGE'] ='Y'` before you import `mpmath`.

The bug can be reproduced independently of mpmath in sage by the following example:


```python
sage: divmod(1, sys.maxsize+1r)
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-1-292a3012ef4a> in <module>
----> 1 divmod(Integer(1), sys.maxsize+1)

SystemError: <built-in function divmod> returned a result with an error set
```


The error occurs if the first argument is a sage integer and the second a python `int` of size larger than `sys.maxsize` in the statement `d = PyInt_AS_LONG(other)`. Therefore, I'm suggesting the following fix:


```diff
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index a2f913df7f..a268f29355 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -3468,12 +3468,21 @@ cdef class Integer(sage.structure.element.EuclideanDomainElement):
             sage: 5.quo_rem(2/3)
             (15/2, 0)

+        Check that :trac:`29009` is fixed:
+
+            sage: divmod(1, sys.maxsize+1r)
+            (0, 1)
+            sage: import mpmath
+            sage: mpmath.mp.prec = 1000
+            sage: root = mpmath.findroot(lambda x: x^2 - 3, 2)
+            sage: len(str(root))
+            301
         """
         cdef Integer q = PY_NEW(Integer)
         cdef Integer r = PY_NEW(Integer)
         cdef long d, res

-        if type(other) is int:
+        if is_small_python_int(other):
             d = PyInt_AS_LONG(other)
             if d > 0:
                 mpz_fdiv_qr_ui(q.value, r.value, self.value, d)

```


I suspect that there are some other places of code using `PyInt_AS_LONG` where a similar fix will be necessary to have them work with python3 for large python `int`. Shall I open a ticket for that?
----
New commits:


---

Comment by dimpase created at 2021-04-16 08:18:40

What is the purpose of `divmod()` call in the doctest?


---

Comment by soehms created at 2021-04-16 10:10:44

Replying to [comment:9 dimpase]:
> What is the purpose of `divmod()` call in the doctest?

I added this for ease of reading as it gets much closer to the problem. If you want to save tests, I can remove it (or better the other one?).


---

Comment by dimpase created at 2021-04-16 10:43:26

please add a comment describing `divmod()` meaning (imagine someone who didn't read details of this ticket seeing it - it looks like a typo).

something like `# sanity check - see #29009 for details` will do, if you cannot think of a better one.


---

Comment by git created at 2021-04-16 10:57:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-04-16 11:01:23

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-04-16 13:17:52

Thanks! There is another similar one: #31676


---

Comment by vbraun created at 2021-05-27 20:30:24

Resolution: fixed
