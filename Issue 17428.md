# Issue 17428: Change binary_matrix data type to use bitset

Issue created by migration from https://trac.sagemath.org/ticket/17665

Original creator: dcoudert

Original creation time: 2015-01-24 18:13:04

CC:  ncohen

This patch changes the data structure `binary_matrix_t` to use one bitset per row. This enables us to use directly operations on bitsets without casts.
Currently, this data structure is only used for operations on graphs.


---

Comment by vdelecroix created at 2015-01-24 18:40:52

Hello,

You could also consider moving it to `sage/data_structures/`... no?

Vincent


---

Comment by dcoudert created at 2015-01-24 18:44:33

I will try to ;)
David.


---

Comment by git created at 2015-01-24 20:56:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-01-24 21:00:28

I have compilation errors that I don't know how to fix.

It also remains to move the data structure to appropriate directory.

Enough for me for tonight.

David.


---

Comment by git created at 2015-01-24 23:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-01-24 23:38:48

I also tried to add a file `binary_matrix.pxd` (not in the commits since I don't remember how to include it), but still not working :(


---

Comment by jdemeyer created at 2015-01-25 09:06:39

Replying to [comment:7 dcoudert]:
> I don't remember how to include it
`git add FILENAME`


---

Comment by dcoudert created at 2015-01-25 10:47:02

I have added file `binary_matrix.pxd`, but now I'm unable to push my modifications.


```
confetti:sage dcoudert$ git trac push
Pushing to Trac #17665...
Guessed remote branch: public/17665
Traceback (most recent call last):
  File "/Users/dcoudert/sage/git-trac-command/bin/git-trac", line 18, in <module>
    cmdline.launch()
  File "/Users/dcoudert/sage/git-trac-command/git_trac/cmdline.py", line 210, in launch
    app.push(ticket_number, remote=args.remote, force=args.force)
  File "/Users/dcoudert/sage/git-trac-command/git_trac/app.py", line 194, in push
    self.repo.push(remote, force)
  File "/Users/dcoudert/sage/git-trac-command/git_trac/git_repository.py", line 181, in push
    self.git.echo.push('trac', refspec)
  File "/Users/dcoudert/sage/git-trac-command/git_trac/git_interface.py", line 341, in meth
    return self.execute(git_cmd, *args, **kwds)
  File "/Users/dcoudert/sage/git-trac-command/git_trac/git_interface.py", line 98, in execute
    popen_stderr=subprocess.PIPE)
  File "/Users/dcoudert/sage/git-trac-command/git_trac/git_interface.py", line 263, in _run
    raise GitError(result)
git_trac.git_error.GitError: git returned with non-zero exit code (1) when executing "git push trac HEAD:refs/heads/public/17665"
    STDERR: error: insufficient permission for adding an object to repository database ./objects
    STDERR: 
    STDERR: fatal: failed to write object
    STDERR: error: unpack failed: unpack-objects abnormal exit
    STDERR: To git@trac.sagemath.org:sage.git
    STDERR:  ! [remote rejected] HEAD -> public/17665 (n/a (unpacker error))
    STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```


Should I use a specific command?


---

Comment by git created at 2015-01-25 12:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-25 15:43:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-25 15:47:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-01-25 15:51:27

Changing status from new to needs_review.


---

Comment by dcoudert created at 2015-01-25 15:51:27

Patch ready to be reviewed.

Many thanks to Volker for solving technical issues.


---

Comment by jdemeyer created at 2015-01-26 10:52:25

Removed some cruft and a compiler warning.
----
New commits:


---

Comment by dcoudert created at 2015-01-26 12:28:50

Thank you, it is better now.


---

Comment by ncohen created at 2015-01-26 13:05:24

Hello !

I added a small commit at `public/17665` that only fixes some doc and a function call. It is not equivalent to do the following change:


```diff
-    binary_matrix_set0(m,row,col)
-    m.rows[row][col >> index_shift] |= (<unsigned long>1) << (value & offset_mask)
+    if value:
+        binary_matrix_set1(m,row,col)
+    else:
+        binary_matrix_set0(m,row,col)
```


The purpose of the first code (and of `bitset_set_to` is specifically to avoid that 'if').

Nothing else to mention, and only my commit now needs a review!

Nathann


---

Comment by dcoudert created at 2015-01-26 13:11:53

Have you pushed it on top of what Jeroen did? I don't see your commit.


---

Comment by ncohen created at 2015-01-26 13:12:37

Yep it is there `O_o`

Nathann


---

Comment by jdemeyer created at 2015-01-26 16:13:16

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-01-26 16:13:16

Why did you replace

```
for i in range(m.n_rows):
```

by

```
for i from 0 <= i < m.n_rows:
```

everywhere? The latter is considered legacy syntax.

Also: make sure your types match. `n_rows` and `n_cols` are declared as `long`, then loop indices should also be `long` (you use `int` in many places).


---

Comment by dcoudert created at 2015-01-26 16:30:31

Replying to [comment:20 jdemeyer]:
> Why did you replace
> {{{
> for i in range(m.n_rows):
> }}}
> by
> {{{
> for i from 0 <= i < m.n_rows:
> }}}
> everywhere? The latter is considered legacy syntax.

I thought it was better this way, but if it's not the correct cython syntax, we can go back to `range(n)`.


> Also: make sure your types match. `n_rows` and `n_cols` are declared as `long`, then loop indices should also be `long` (you use `int` in many places).

It was already `int`in many places. So we can try to unify the stuff.
Honestly I doubt that we really need `long` for `n_rows` and `n_cols`. `int` should be large enough, no?


Why have you changed the path to the branch? I cannot write to u/jdemeyer/ticket/17665  and I'm unable to see what Nathann's pushed.

Best,
David.


---

Comment by jdemeyer created at 2015-01-26 17:26:20

Replying to [comment:21 dcoudert]:
> Replying to [comment:20 jdemeyer]:
> > Why did you replace
> > {{{
> > for i in range(m.n_rows):
> > }}}
> > by
> > {{{
> > for i from 0 <= i < m.n_rows:
> > }}}
> > everywhere? The latter is considered legacy syntax.
> 
> I thought it was better this way, but if it's not the correct cython syntax, we can go back to `range(n)`.
It's technically correct but not recommended.

> > Also: make sure your types match. `n_rows` and `n_cols` are declared as `long`, then loop indices should also be `long` (you use `int` in many places).
> 
> It was already `int`in many places. So we can try to unify the stuff.
> Honestly I doubt that we really need `long` for `n_rows` and `n_cols`. `int` should be large enough, no?
I would personally use `long` (or even better: `Py_ssize_t`). There is no reason to artificially restrict to 2^32 rows and columns. Even if you don't see an obvious use-case for this, perhaps other people do.

Given that

```
sage: Matrix(GF(2), 2^32, 1)
4294967296 x 1 dense matrix over Finite Field of size 2 (use the '.str()' method to see the entries)
```

works fine, the same would work for this `binary_matrix` class.


---

Comment by dcoudert created at 2015-01-26 21:13:34

I have implemented requested changes:
- use `range(n)` instead of `for i from 0 <= i < n`
- use type `Py_ssize_t` instead of `int` or `long` in `binary_matrix`

Let me know if further changes are needed.
----
New commits:


---

Comment by dcoudert created at 2015-01-26 21:14:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-01-27 05:03:15

Given that bitsets are initialized with zeros, replace

```
binary_matrix_init(m, n, n)
binary_matrix_fill(m, 0)
```

by

```
binary_matrix_init(m, n, n)
```


In `bitset_are_disjoint`, replace

```
We assume ``a.limbs == b.limbs``.
```

by

```
We assume ``a.limbs <= b.limbs``.
```



---

Comment by git created at 2015-01-27 07:35:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-01-27 07:36:25

done.


---

Comment by ncohen created at 2015-01-28 10:21:12

Jeroen? Have your remarks been correctly addressed? If so, can you set this ticket to `positive_review`?

Thanks,

Nathann


---

Comment by jdemeyer created at 2015-01-28 19:51:26

I give positive_review to all changes which are _not_ in `sage/graphs`. If somebody else can review the graphs stuff, that would be perfect.


---

Comment by ncohen created at 2015-01-28 20:38:55

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-01-28 20:38:55

> I give positive_review to all changes which are _not_ in `sage/graphs`. If somebody else can review the graphs stuff, that would be perfect.

Then it can go. I already reviewed the graph changes.

Nathann


---

Comment by dcoudert created at 2015-01-28 22:15:33

Thank you for your help.
David.


---

Comment by vbraun created at 2015-01-29 13:26:01

Resolution: fixed
