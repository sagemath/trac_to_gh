# Issue 30768: Add traceback information to exceptions during docbuild

Issue created by migration from https://trac.sagemath.org/ticket/31005

Original creator: @tobiasdiez

Original creation time: 2020-12-04 12:32:58

CC:  dimpase jhpalmieri slabbe slelievre mjo

The docbuild was failing for me, and it was hard to track down where the original error occurred because there was no (proper) traceback information. In this ticket, such a traceback information is added for exceptions in the docbuild worker.


---

Comment by @tobiasdiez created at 2020-12-04 12:33:08

Changing status from new to needs_review.


---

Comment by slabbe created at 2020-12-09 11:23:19

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-12-09 11:23:19

The patchbot reports failures for the files that are changed by the branch:


```
----------------------------------------------------------------------
sage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/utils.py  # 1 doctest failed
sage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/__init__.py  # 1 doctest failed
----------------------------------------------------------------------
```


To help the review, may you add an example in the description field of the kind of new information printed in the dochtml.log when an error (warning) occurs?


---

Comment by git created at 2021-01-09 15:18:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-09 15:21:23

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-01-09 15:21:23

Thanks for the review. I've now extended the ticket description and fixed the doctests.


---

Comment by mkoeppe created at 2021-01-30 23:30:59

Let's see if this can help shed some light on previously reported docbuild failures such as #30640, #30796, #30825


---

Comment by jhpalmieri created at 2021-01-31 02:24:26

I've been having problems building the documentation on OS X Big Sur with the latest Xcode + homebrew. This ticket didn't have any apparent effect on the traceback.


---

Comment by @tobiasdiez created at 2021-02-13 09:38:26

`@`jhpalmieri: So you mean you got an exception in one of the workers, but the traceback still didn't included the proper origin of the exception? That's a bit strange, it's working for me.


---

Comment by jhpalmieri created at 2021-02-21 03:20:05

Yes, with the failure in #31344.


---

Comment by @tobiasdiez created at 2021-03-01 12:28:34

That makes sense. In #31344, no exception is thrown but the process ends with an error code, which then triggers 

```
        if exitcode != 0:
            raise WorkerDiedException(f"worker for {task[1]} died with non-zero exit code {w.exitcode}")
```

In this case, no stacktrac is added since this information is simply not available. The worker needs to throw an exception (including a stacktrace) so that the exception handler in

```
         try:
             result = target(task)
         except BaseException as exc:
             queue.put((None, exc))
             queue.put((None, RemoteExceptionWrapper(exc)))
```

is invoked. This needs changes to the particular worker, and should be done in a follow-up issue.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-11-28 20:05:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-12-01 01:59:37

Did the GH actions pass? My only suggestion would be to make `_rebuild_exc` a class method instead of a top-level function, but it's not important. This is a great improvement. Trying to track down all of the docbuild failures with `--underscore` and `--include-tests-blocks` is always a nightmare.


---

Comment by git created at 2021-12-04 18:58:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-04 18:59:59

Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.
Not sure if the tests passed but patch bot seems to be green.


---

Comment by mjo created at 2021-12-06 13:47:06

Replying to [comment:17 gh-tobiasdiez]:
> Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.
> Not sure if the tests passed but patch bot seems to be green.

Hm, this is even better. But now another refactoring is suggesting itself. Instead of,


```python
def __reduce__(self):
    def _rebuild_exc(exc: BaseException, tb: str):
        """
        Reconstructs the exception, putting the original exception as cause.
        """
        exc.__cause__ = RemoteException(tb)
        return exc

    return _rebuild_exc, (self.exc, self.tb)
```


couldn't we just do


```python
def __reduce__(self):
    self.exc.__cause__ =  RemoteException(self.tb)
    return self.exc
```


?

I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.


---

Comment by git created at 2021-12-06 20:35:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-06 20:39:51

Replying to [comment:18 mjo]:
> {{{#!python
> def __reduce__(self):
>     self.exc.__cause__ =  RemoteException(self.tb)
>     return self.exc
> }}}

I don't have much experience with pickling, but https://docs.python.org/3/library/pickle.html#object.__reduce__ says that either a string or tuple should be returned.

My solution also didn't worked as `__reduce__` cannot return locally defined methods. So I've converted it to a static instance method as you initially suggested.

> I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.

I've added a doctest for the reduce method. The other methods are still covered by the existing doctests.


---

Comment by mjo created at 2021-12-15 02:59:49

Replying to [comment:20 gh-tobiasdiez]:
> 
> > I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.
> 
> I've added a doctest for the reduce method. The other methods are still covered by the existing doctests.

I know, I was referring specifically to (before):


```
$ sage -coverage src/sage_docbuild/utils.py 
------------------------------------------------------------------------
SCORE src/sage_docbuild/utils.py: 50.0% (1 of 2)

Missing documentation:
     * line 10: def __init__(self, message, original_exception=None)
------------------------------------------------------------------------
```


and (after):


```
$ sage -coverage src/sage_docbuild/utils.py 
------------------------------------------------------------------------
SCORE src/sage_docbuild/utils.py: 28.6% (2 of 7)

Missing documentation:
     * line 16: def __init__(self, tb:str)
     * line 19: def __str__(self)
     * line 32: def __init__(self, exc:BaseException)
     * line 65: def __init__(self, message:Optional[str], original_exception:Optional[BaseException]=None)

Missing doctests:
     * line 42: def _rebuild_exc(exc:BaseException, tb:str)
------------------------------------------------------------------------
```


Normally the patchbots would have complained (see the "coverage" plugin), but in this case I think the special nature of the sage_docbuild package avoided it.

I've been on the other side of this argument more than once, so I feel for you, but the developer's guide still states that every function needs a docstring: https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings


---

Comment by git created at 2021-12-15 20:51:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-15 20:52:47

I've added the missing docstrings. But since none of the methods in this class have any tests, I don't have that much motivation to add tests for trivial constructor / properties ;-)


---

Comment by @tobiasdiez created at 2022-01-03 12:18:20

Test bot is green, anything else to do?


---

Comment by mjo created at 2022-01-04 01:06:29

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2022-01-04 01:06:29

I forgot what I was waiting for, so it must be OK.


---

Comment by @tobiasdiez created at 2022-01-04 12:00:28

Thanks!


---

Comment by vbraun created at 2022-02-16 23:56:48

Resolution: fixed
