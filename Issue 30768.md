# Issue 30768: Add traceback information to exceptions during docbuild

archive/issues_030768.json:
```json
{
    "body": "CC:  @dimpase @jhpalmieri @seblabbe @slel @orlitzky\n\nThe docbuild was failing for me, and it was hard to track down where the original error occurred because there was no (proper) traceback information. In this ticket, such a traceback information is added for exceptions in the docbuild worker.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31005\n\n",
    "created_at": "2020-12-04T12:32:58Z",
    "labels": [
        "documentation",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Add traceback information to exceptions during docbuild",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30768",
    "user": "@tobiasdiez"
}
```
CC:  @dimpase @jhpalmieri @seblabbe @slel @orlitzky

The docbuild was failing for me, and it was hard to track down where the original error occurred because there was no (proper) traceback information. In this ticket, such a traceback information is added for exceptions in the docbuild worker.

Issue created by migration from https://trac.sagemath.org/ticket/31005





---

archive/issue_comments_439809.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-04T12:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439809",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_439810.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-09T11:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439810",
    "user": "@seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_439811.json:
```json
{
    "body": "The patchbot reports failures for the files that are changed by the branch:\n\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/utils.py  # 1 doctest failed\nsage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/__init__.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\n\nTo help the review, may you add an example in the description field of the kind of new information printed in the dochtml.log when an error (warning) occurs?",
    "created_at": "2020-12-09T11:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439811",
    "user": "@seblabbe"
}
```

The patchbot reports failures for the files that are changed by the branch:


```
----------------------------------------------------------------------
sage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/utils.py  # 1 doctest failed
sage -t --long --warn-long 40.9 --random-seed=0 src/sage_setup/docbuild/__init__.py  # 1 doctest failed
----------------------------------------------------------------------
```


To help the review, may you add an example in the description field of the kind of new information printed in the dochtml.log when an error (warning) occurs?



---

archive/issue_comments_439812.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-09T15:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439812",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_439813.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-09T15:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439813",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_439814.json:
```json
{
    "body": "Thanks for the review. I've now extended the ticket description and fixed the doctests.",
    "created_at": "2021-01-09T15:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439814",
    "user": "@tobiasdiez"
}
```

Thanks for the review. I've now extended the ticket description and fixed the doctests.



---

archive/issue_comments_439815.json:
```json
{
    "body": "Let's see if this can help shed some light on previously reported docbuild failures such as #30640, #30796, #30825",
    "created_at": "2021-01-30T23:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439815",
    "user": "@mkoeppe"
}
```

Let's see if this can help shed some light on previously reported docbuild failures such as #30640, #30796, #30825



---

archive/issue_comments_439816.json:
```json
{
    "body": "I've been having problems building the documentation on OS X Big Sur with the latest Xcode + homebrew. This ticket didn't have any apparent effect on the traceback.",
    "created_at": "2021-01-31T02:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439816",
    "user": "@jhpalmieri"
}
```

I've been having problems building the documentation on OS X Big Sur with the latest Xcode + homebrew. This ticket didn't have any apparent effect on the traceback.



---

archive/issue_comments_439817.json:
```json
{
    "body": "`@`jhpalmieri: So you mean you got an exception in one of the workers, but the traceback still didn't included the proper origin of the exception? That's a bit strange, it's working for me.",
    "created_at": "2021-02-13T09:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439817",
    "user": "@tobiasdiez"
}
```

`@`jhpalmieri: So you mean you got an exception in one of the workers, but the traceback still didn't included the proper origin of the exception? That's a bit strange, it's working for me.



---

archive/issue_comments_439818.json:
```json
{
    "body": "Yes, with the failure in #31344.",
    "created_at": "2021-02-21T03:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439818",
    "user": "@jhpalmieri"
}
```

Yes, with the failure in #31344.



---

archive/issue_comments_439819.json:
```json
{
    "body": "That makes sense. In #31344, no exception is thrown but the process ends with an error code, which then triggers \n\n```\n        if exitcode != 0:\n            raise WorkerDiedException(f\"worker for {task[1]} died with non-zero exit code {w.exitcode}\")\n```\n\nIn this case, no stacktrac is added since this information is simply not available. The worker needs to throw an exception (including a stacktrace) so that the exception handler in\n\n```\n         try:\n             result = target(task)\n         except BaseException as exc:\n             queue.put((None, exc))\n             queue.put((None, RemoteExceptionWrapper(exc)))\n```\n\nis invoked. This needs changes to the particular worker, and should be done in a follow-up issue.",
    "created_at": "2021-03-01T12:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439819",
    "user": "@tobiasdiez"
}
```

That makes sense. In #31344, no exception is thrown but the process ends with an error code, which then triggers 

```
        if exitcode != 0:
            raise WorkerDiedException(f"worker for {task[1]} died with non-zero exit code {w.exitcode}")
```

In this case, no stacktrac is added since this information is simply not available. The worker needs to throw an exception (including a stacktrace) so that the exception handler in

```
         try:
             result = target(task)
         except BaseException as exc:
             queue.put((None, exc))
             queue.put((None, RemoteExceptionWrapper(exc)))
```

is invoked. This needs changes to the particular worker, and should be done in a follow-up issue.



---

archive/issue_comments_439820.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439820",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_439821.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439821",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_439822.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-28T20:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439822",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_439823.json:
```json
{
    "body": "Did the GH actions pass? My only suggestion would be to make `_rebuild_exc` a class method instead of a top-level function, but it's not important. This is a great improvement. Trying to track down all of the docbuild failures with `--underscore` and `--include-tests-blocks` is always a nightmare.",
    "created_at": "2021-12-01T01:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439823",
    "user": "@orlitzky"
}
```

Did the GH actions pass? My only suggestion would be to make `_rebuild_exc` a class method instead of a top-level function, but it's not important. This is a great improvement. Trying to track down all of the docbuild failures with `--underscore` and `--include-tests-blocks` is always a nightmare.



---

archive/issue_comments_439824.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-04T18:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439824",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_439825.json:
```json
{
    "body": "Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.\nNot sure if the tests passed but patch bot seems to be green.",
    "created_at": "2021-12-04T18:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439825",
    "user": "@tobiasdiez"
}
```

Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.
Not sure if the tests passed but patch bot seems to be green.



---

archive/issue_comments_439826.json:
```json
{
    "body": "Replying to [comment:17 gh-tobiasdiez]:\n> Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.\n> Not sure if the tests passed but patch bot seems to be green.\n\nHm, this is even better. But now another refactoring is suggesting itself. Instead of,\n\n\n```python\ndef __reduce__(self):\n    def _rebuild_exc(exc: BaseException, tb: str):\n        \"\"\"\n        Reconstructs the exception, putting the original exception as cause.\n        \"\"\"\n        exc.__cause__ = RemoteException(tb)\n        return exc\n\n    return _rebuild_exc, (self.exc, self.tb)\n```\n\n\ncouldn't we just do\n\n\n```python\ndef __reduce__(self):\n    self.exc.__cause__ =  RemoteException(self.tb)\n    return self.exc\n```\n\n\n?\n\nI also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.",
    "created_at": "2021-12-06T13:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439826",
    "user": "@orlitzky"
}
```

Replying to [comment:17 gh-tobiasdiez]:
> Thanks for the review. I've now moved _rebuild_exc to a local method in __reduce__.
> Not sure if the tests passed but patch bot seems to be green.

Hm, this is even better. But now another refactoring is suggesting itself. Instead of,


```python
def __reduce__(self):
    def _rebuild_exc(exc: BaseException, tb: str):
        """
        Reconstructs the exception, putting the original exception as cause.
        """
        exc.__cause__ = RemoteException(tb)
        return exc

    return _rebuild_exc, (self.exc, self.tb)
```


couldn't we just do


```python
def __reduce__(self):
    self.exc.__cause__ =  RemoteException(self.tb)
    return self.exc
```


?

I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.



---

archive/issue_comments_439827.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-06T20:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439827",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_439828.json:
```json
{
    "body": "Replying to [comment:18 mjo]:\n> {{{#!python\n> def __reduce__(self):\n>     self.exc.__cause__ =  RemoteException(self.tb)\n>     return self.exc\n> }}}\n\nI don't have much experience with pickling, but https://docs.python.org/3/library/pickle.html#object.__reduce__ says that either a string or tuple should be returned.\n\nMy solution also didn't worked as `__reduce__` cannot return locally defined methods. So I've converted it to a static instance method as you initially suggested.\n\n> I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.\n\nI've added a doctest for the reduce method. The other methods are still covered by the existing doctests.",
    "created_at": "2021-12-06T20:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439828",
    "user": "@tobiasdiez"
}
```

Replying to [comment:18 mjo]:
> {{{#!python
> def __reduce__(self):
>     self.exc.__cause__ =  RemoteException(self.tb)
>     return self.exc
> }}}

I don't have much experience with pickling, but https://docs.python.org/3/library/pickle.html#object.__reduce__ says that either a string or tuple should be returned.

My solution also didn't worked as `__reduce__` cannot return locally defined methods. So I've converted it to a static instance method as you initially suggested.

> I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.

I've added a doctest for the reduce method. The other methods are still covered by the existing doctests.



---

archive/issue_comments_439829.json:
```json
{
    "body": "Replying to [comment:20 gh-tobiasdiez]:\n> \n> > I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.\n> \n> I've added a doctest for the reduce method. The other methods are still covered by the existing doctests.\n\nI know, I was referring specifically to (before):\n\n\n```\n$ sage -coverage src/sage_docbuild/utils.py \n------------------------------------------------------------------------\nSCORE src/sage_docbuild/utils.py: 50.0% (1 of 2)\n\nMissing documentation:\n     * line 10: def __init__(self, message, original_exception=None)\n------------------------------------------------------------------------\n```\n\n\nand (after):\n\n\n```\n$ sage -coverage src/sage_docbuild/utils.py \n------------------------------------------------------------------------\nSCORE src/sage_docbuild/utils.py: 28.6% (2 of 7)\n\nMissing documentation:\n     * line 16: def __init__(self, tb:str)\n     * line 19: def __str__(self)\n     * line 32: def __init__(self, exc:BaseException)\n     * line 65: def __init__(self, message:Optional[str], original_exception:Optional[BaseException]=None)\n\nMissing doctests:\n     * line 42: def _rebuild_exc(exc:BaseException, tb:str)\n------------------------------------------------------------------------\n```\n\n\nNormally the patchbots would have complained (see the \"coverage\" plugin), but in this case I think the special nature of the sage_docbuild package avoided it.\n\nI've been on the other side of this argument more than once, so I feel for you, but the developer's guide still states that every function needs a docstring: https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings",
    "created_at": "2021-12-15T02:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439829",
    "user": "@orlitzky"
}
```

Replying to [comment:20 gh-tobiasdiez]:
> 
> > I also think we'll need doctests for the new classes/methods even if they're pretty trivial. Otherwise our coverage goes down.
> 
> I've added a doctest for the reduce method. The other methods are still covered by the existing doctests.

I know, I was referring specifically to (before):


```
$ sage -coverage src/sage_docbuild/utils.py 
------------------------------------------------------------------------
SCORE src/sage_docbuild/utils.py: 50.0% (1 of 2)

Missing documentation:
     * line 10: def __init__(self, message, original_exception=None)
------------------------------------------------------------------------
```


and (after):


```
$ sage -coverage src/sage_docbuild/utils.py 
------------------------------------------------------------------------
SCORE src/sage_docbuild/utils.py: 28.6% (2 of 7)

Missing documentation:
     * line 16: def __init__(self, tb:str)
     * line 19: def __str__(self)
     * line 32: def __init__(self, exc:BaseException)
     * line 65: def __init__(self, message:Optional[str], original_exception:Optional[BaseException]=None)

Missing doctests:
     * line 42: def _rebuild_exc(exc:BaseException, tb:str)
------------------------------------------------------------------------
```


Normally the patchbots would have complained (see the "coverage" plugin), but in this case I think the special nature of the sage_docbuild package avoided it.

I've been on the other side of this argument more than once, so I feel for you, but the developer's guide still states that every function needs a docstring: https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings



---

archive/issue_comments_439830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-15T20:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439830",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_439831.json:
```json
{
    "body": "I've added the missing docstrings. But since none of the methods in this class have any tests, I don't have that much motivation to add tests for trivial constructor / properties ;-)",
    "created_at": "2021-12-15T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439831",
    "user": "@tobiasdiez"
}
```

I've added the missing docstrings. But since none of the methods in this class have any tests, I don't have that much motivation to add tests for trivial constructor / properties ;-)



---

archive/issue_comments_439832.json:
```json
{
    "body": "Test bot is green, anything else to do?",
    "created_at": "2022-01-03T12:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439832",
    "user": "@tobiasdiez"
}
```

Test bot is green, anything else to do?



---

archive/issue_comments_439833.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-04T01:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439833",
    "user": "@orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_439834.json:
```json
{
    "body": "I forgot what I was waiting for, so it must be OK.",
    "created_at": "2022-01-04T01:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439834",
    "user": "@orlitzky"
}
```

I forgot what I was waiting for, so it must be OK.



---

archive/issue_comments_439835.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-01-04T12:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439835",
    "user": "@tobiasdiez"
}
```

Thanks!



---

archive/issue_comments_439836.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-16T23:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30768#issuecomment-439836",
    "user": "@vbraun"
}
```

Resolution: fixed
