# Issue 29816: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg

archive/issues_029816.json:
```json
{
    "body": "CC:  @antonio-rojas @mkoeppe @slel @orlitzky @kiwifb @embray @fchapoton\n\nIn #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\nHowever, not all systems have it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30053\n\n",
    "created_at": "2020-07-03T12:25:54Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29816",
    "user": "@dimpase"
}
```
CC:  @antonio-rojas @mkoeppe @slel @orlitzky @kiwifb @embray @fchapoton

In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
However, not all systems have it.

Issue created by migration from https://trac.sagemath.org/ticket/30053





---

archive/issue_comments_423465.json:
```json
{
    "body": "an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`. Perhaps print a warning.",
    "created_at": "2020-07-04T10:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423465",
    "user": "@dimpase"
}
```

an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`. Perhaps print a warning.



---

archive/issue_comments_423466.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2020-07-04T10:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423466",
    "user": "@dimpase"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_423467.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2020-07-04T10:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423467",
    "user": "@dimpase"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_423468.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`.\n+1",
    "created_at": "2020-07-04T15:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423468",
    "user": "@mkoeppe"
}
```

Replying to [comment:3 dimpase]:
> an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`.
+1



---

archive/issue_comments_423469.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-05T12:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423469",
    "user": "@dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423470.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-05T12:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423470",
    "user": "@dimpase"
}
```

New commits:



---

archive/issue_comments_423471.json:
```json
{
    "body": "Either this ticket is a duplicate of #30008 or it should make #30008 obsolete.",
    "created_at": "2020-07-05T13:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423471",
    "user": "@kliem"
}
```

Either this ticket is a duplicate of #30008 or it should make #30008 obsolete.



---

archive/issue_comments_423472.json:
```json
{
    "body": "I started test runs:\n\nhttps://github.com/kliem/sage/pull/20/checks",
    "created_at": "2020-07-05T13:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423472",
    "user": "@kliem"
}
```

I started test runs:

https://github.com/kliem/sage/pull/20/checks



---

archive/issue_comments_423473.json:
```json
{
    "body": "this ticket was a result of a bug report on Arch, not centos. Hopefully it works for #30008 too.",
    "created_at": "2020-07-05T15:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423473",
    "user": "@dimpase"
}
```

this ticket was a result of a bug report on Arch, not centos. Hopefully it works for #30008 too.



---

archive/issue_comments_423474.json:
```json
{
    "body": "Tests did not complete, because the 9.2.beta3 tests fail everywhere.\n\nhttps://github.com/sagemath/sage/actions/runs/157607524\n\nIs this a github issue or have we broken sage?\n\n\n```\n Step 13/18 : RUN ./bootstrap\n ---> Running in 89427ef5c1c4\nrm -rf config configure build/make/Makefile-auto.in\nrm -f src/doc/en/installation/*.txt\nrm -rf src/doc/en/reference/spkg/*.rst\nrm -f src/doc/en/reference/repl/*.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt\nsrc/doc/bootstrap:55: installing src/doc/en/reference/spkg/*.rst\nsrc/doc/bootstrap:83: installing src/doc/en/reference/repl/options.txt\nsrc/doc/bootstrap: line 84: src/doc/en/reference/repl/options.txt: No such file or directory\nThe command '/bin/sh -c ./bootstrap' returned a non-zero code: 1\n```\n",
    "created_at": "2020-07-05T15:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423474",
    "user": "@kliem"
}
```

Tests did not complete, because the 9.2.beta3 tests fail everywhere.

https://github.com/sagemath/sage/actions/runs/157607524

Is this a github issue or have we broken sage?


```
 Step 13/18 : RUN ./bootstrap
 ---> Running in 89427ef5c1c4
rm -rf config configure build/make/Makefile-auto.in
rm -f src/doc/en/installation/*.txt
rm -rf src/doc/en/reference/spkg/*.rst
rm -f src/doc/en/reference/repl/*.txt
src/doc/bootstrap:48: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt
src/doc/bootstrap:55: installing src/doc/en/reference/spkg/*.rst
src/doc/bootstrap:83: installing src/doc/en/reference/repl/options.txt
src/doc/bootstrap: line 84: src/doc/en/reference/repl/options.txt: No such file or directory
The command '/bin/sh -c ./bootstrap' returned a non-zero code: 1
```




---

archive/issue_comments_423475.json:
```json
{
    "body": "I just found #30064. Edit: I was cc on that, but I didn't realize how serious this is.\n\nOk. I'll run a new test then.",
    "created_at": "2020-07-05T15:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423475",
    "user": "@kliem"
}
```

I just found #30064. Edit: I was cc on that, but I didn't realize how serious this is.

Ok. I'll run a new test then.



---

archive/issue_comments_423476.json:
```json
{
    "body": "This breaks building sphinx on windows.\n\nhttps://github.com/kliem/sage/runs/838933940\n\nSame error as #30008.\n\nAs far as I understand the problem is that we need some sort of UTF to make the sphinx build work.\nIt appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.\nSo maybe `C` is not the best alternative for `C.UTF-8`.\n\nBtw, strangely centos 7 appears to work with the current beta. I don't know what happened. (And I don't know yet, if this behavior is stable).",
    "created_at": "2020-07-05T19:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423476",
    "user": "@kliem"
}
```

This breaks building sphinx on windows.

https://github.com/kliem/sage/runs/838933940

Same error as #30008.

As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.
It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.
So maybe `C` is not the best alternative for `C.UTF-8`.

Btw, strangely centos 7 appears to work with the current beta. I don't know what happened. (And I don't know yet, if this behavior is stable).



---

archive/issue_comments_423477.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-05T19:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423477",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_423478.json:
```json
{
    "body": "And it breaks centos 8.",
    "created_at": "2020-07-06T05:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423478",
    "user": "@kliem"
}
```

And it breaks centos 8.



---

archive/issue_comments_423479.json:
```json
{
    "body": "Replying to [comment:12 gh-kliem]:\n> This breaks building sphinx on windows.\n> \n> https://github.com/kliem/sage/runs/838933940\n> \n> Same error as #30008.\n> \n> As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.\n> It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.\n> So maybe `C` is not the best alternative for `C.UTF-8`.\n\nI'm not sure what you mean here.  `C.UTF-8` is supported on Cygwin and is in fact the default locale in absence of any other settings: https://www.cygwin.com/cygwin-ug-net/setup-locale.html\n\n> The default locale in the absence of the aforementioned locale environment variables is \"C.UTF-8\".",
    "created_at": "2020-07-06T11:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423479",
    "user": "@embray"
}
```

Replying to [comment:12 gh-kliem]:
> This breaks building sphinx on windows.
> 
> https://github.com/kliem/sage/runs/838933940
> 
> Same error as #30008.
> 
> As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.
> It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.
> So maybe `C` is not the best alternative for `C.UTF-8`.

I'm not sure what you mean here.  `C.UTF-8` is supported on Cygwin and is in fact the default locale in absence of any other settings: https://www.cygwin.com/cygwin-ug-net/setup-locale.html

> The default locale in the absence of the aforementioned locale environment variables is "C.UTF-8".



---

archive/issue_comments_423480.json:
```json
{
    "body": "the error `UnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)`:\n\n\n```\n2020-07-05T16:29:58.1676169Z [sphinx-3.0.4.p0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log\n2020-07-05T16:30:01.7883565Z   [sphinx-3.0.4.p0] error installing, exit status 1. End of log file:\n2020-07-05T16:30:01.8141086Z   [sphinx-3.0.4.p0]   Found local metadata for sphinx-3.0.4.p0\n2020-07-05T16:30:01.8155620Z   [sphinx-3.0.4.p0]   Attempting to download package Sphinx-3.0.4.tar.gz from mirrors\n2020-07-05T16:30:01.8169727Z   [sphinx-3.0.4.p0]   http://mirrors.mit.edu/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz\n2020-07-05T16:30:01.8174798Z   [sphinx-3.0.4.p0]   [......................................................................]\n2020-07-05T16:30:01.8191111Z   [sphinx-3.0.4.p0]   sphinx-3.0.4.p0\n2020-07-05T16:30:01.8193080Z   [sphinx-3.0.4.p0]   ====================================================\n2020-07-05T16:30:01.8197343Z   [sphinx-3.0.4.p0]   Setting up build directory for sphinx-3.0.4.p0\n2020-07-05T16:30:01.8217424Z   [sphinx-3.0.4.p0]   Traceback (most recent call last):\n2020-07-05T16:30:01.8221790Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n2020-07-05T16:30:01.8222267Z   [sphinx-3.0.4.p0]       run()\n2020-07-05T16:30:01.8222576Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n2020-07-05T16:30:01.8222857Z   [sphinx-3.0.4.p0]       unpack_archive(archive, dirname)\n2020-07-05T16:30:01.8223251Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n2020-07-05T16:30:01.8223583Z   [sphinx-3.0.4.p0]       archive.extractall(members=archive.names)\n2020-07-05T16:30:01.8223861Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 96, in extractall\n2020-07-05T16:30:01.8224117Z   [sphinx-3.0.4.p0]       **kwargs)\n2020-07-05T16:30:01.8224323Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2010, in extractall\n2020-07-05T16:30:01.8224793Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)\n2020-07-05T16:30:01.8225151Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2052, in extract\n2020-07-05T16:30:01.8225442Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)\n2020-07-05T16:30:01.8225898Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 122, in _extract_member\n2020-07-05T16:30:01.8226166Z   [sphinx-3.0.4.p0]       **kwargs)\n2020-07-05T16:30:01.8226601Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2122, in _extract_member\n2020-07-05T16:30:01.8226883Z   [sphinx-3.0.4.p0]       self.makefile(tarinfo, targetpath)\n2020-07-05T16:30:01.8227488Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2163, in makefile\n2020-07-05T16:30:01.8227940Z   [sphinx-3.0.4.p0]       with bltn_open(targetpath, \"wb\") as target:\n2020-07-05T16:30:01.8228249Z   [sphinx-3.0.4.p0]   UnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)\n2020-07-05T16:30:01.8228542Z   [sphinx-3.0.4.p0]   ************************************************************************\n2020-07-05T16:30:01.8228988Z   [sphinx-3.0.4.p0]   Error: failed to extract /cygdrive/d/a/sage/sage/upstream/Sphinx-3.0.4.tar.gz\n2020-07-05T16:30:01.8229264Z   [sphinx-3.0.4.p0]   ************************************************************************\n2020-07-05T16:30:01.8229537Z   [sphinx-3.0.4.p0] Full log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log\n```\n",
    "created_at": "2020-07-06T11:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423480",
    "user": "@dimpase"
}
```

the error `UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)`:


```
2020-07-05T16:29:58.1676169Z [sphinx-3.0.4.p0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log
2020-07-05T16:30:01.7883565Z   [sphinx-3.0.4.p0] error installing, exit status 1. End of log file:
2020-07-05T16:30:01.8141086Z   [sphinx-3.0.4.p0]   Found local metadata for sphinx-3.0.4.p0
2020-07-05T16:30:01.8155620Z   [sphinx-3.0.4.p0]   Attempting to download package Sphinx-3.0.4.tar.gz from mirrors
2020-07-05T16:30:01.8169727Z   [sphinx-3.0.4.p0]   http://mirrors.mit.edu/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz
2020-07-05T16:30:01.8174798Z   [sphinx-3.0.4.p0]   [......................................................................]
2020-07-05T16:30:01.8191111Z   [sphinx-3.0.4.p0]   sphinx-3.0.4.p0
2020-07-05T16:30:01.8193080Z   [sphinx-3.0.4.p0]   ====================================================
2020-07-05T16:30:01.8197343Z   [sphinx-3.0.4.p0]   Setting up build directory for sphinx-3.0.4.p0
2020-07-05T16:30:01.8217424Z   [sphinx-3.0.4.p0]   Traceback (most recent call last):
2020-07-05T16:30:01.8221790Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
2020-07-05T16:30:01.8222267Z   [sphinx-3.0.4.p0]       run()
2020-07-05T16:30:01.8222576Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
2020-07-05T16:30:01.8222857Z   [sphinx-3.0.4.p0]       unpack_archive(archive, dirname)
2020-07-05T16:30:01.8223251Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
2020-07-05T16:30:01.8223583Z   [sphinx-3.0.4.p0]       archive.extractall(members=archive.names)
2020-07-05T16:30:01.8223861Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 96, in extractall
2020-07-05T16:30:01.8224117Z   [sphinx-3.0.4.p0]       **kwargs)
2020-07-05T16:30:01.8224323Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2010, in extractall
2020-07-05T16:30:01.8224793Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)
2020-07-05T16:30:01.8225151Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2052, in extract
2020-07-05T16:30:01.8225442Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)
2020-07-05T16:30:01.8225898Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 122, in _extract_member
2020-07-05T16:30:01.8226166Z   [sphinx-3.0.4.p0]       **kwargs)
2020-07-05T16:30:01.8226601Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2122, in _extract_member
2020-07-05T16:30:01.8226883Z   [sphinx-3.0.4.p0]       self.makefile(tarinfo, targetpath)
2020-07-05T16:30:01.8227488Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2163, in makefile
2020-07-05T16:30:01.8227940Z   [sphinx-3.0.4.p0]       with bltn_open(targetpath, "wb") as target:
2020-07-05T16:30:01.8228249Z   [sphinx-3.0.4.p0]   UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)
2020-07-05T16:30:01.8228542Z   [sphinx-3.0.4.p0]   ************************************************************************
2020-07-05T16:30:01.8228988Z   [sphinx-3.0.4.p0]   Error: failed to extract /cygdrive/d/a/sage/sage/upstream/Sphinx-3.0.4.tar.gz
2020-07-05T16:30:01.8229264Z   [sphinx-3.0.4.p0]   ************************************************************************
2020-07-05T16:30:01.8229537Z   [sphinx-3.0.4.p0] Full log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log
```




---

archive/issue_comments_423481.json:
```json
{
    "body": "could it be that `locale` on Cygwin is not installed by default?\n\nHowever, https://www.cygwin.com/cygwin-ug-net/setup-locale.html says:\n\n```\nNote\nFor a list of locales supported by your Windows machine, use the new locale -a command, which is part of the Cygwin package. For a description see locale(1)\n```\n",
    "created_at": "2020-07-06T11:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423481",
    "user": "@dimpase"
}
```

could it be that `locale` on Cygwin is not installed by default?

However, https://www.cygwin.com/cygwin-ug-net/setup-locale.html says:

```
Note
For a list of locales supported by your Windows machine, use the new locale -a command, which is part of the Cygwin package. For a description see locale(1)
```




---

archive/issue_comments_423482.json:
```json
{
    "body": "Replying to [comment:8 gh-kliem]:\n> I started test runs:\n> \n> https://github.com/kliem/sage/pull/20/checks\n\nI just started rerunning those tests on top of the current beta. Maybe that stuff just goes away by itself.",
    "created_at": "2020-07-12T19:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423482",
    "user": "@kliem"
}
```

Replying to [comment:8 gh-kliem]:
> I started test runs:
> 
> https://github.com/kliem/sage/pull/20/checks

I just started rerunning those tests on top of the current beta. Maybe that stuff just goes away by itself.



---

archive/issue_comments_423483.json:
```json
{
    "body": "Still causes this error.",
    "created_at": "2020-07-12T22:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423483",
    "user": "@kliem"
}
```

Still causes this error.



---

archive/issue_comments_423484.json:
```json
{
    "body": "If the centos issue is caused by the sphinx upgrade (according to #30008), why is it blocking this? This is meant to fix another (very annoying) issue on Arch.",
    "created_at": "2020-07-23T19:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423484",
    "user": "@antonio-rojas"
}
```

If the centos issue is caused by the sphinx upgrade (according to #30008), why is it blocking this? This is meant to fix another (very annoying) issue on Arch.



---

archive/issue_comments_423485.json:
```json
{
    "body": "It appears that #30008 fixed itself. However, this here broke the cygwin sphinx build, last I checked.\n\nIt have no clue what is going on, but with this ticket we go from passing to failing.",
    "created_at": "2020-07-23T20:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423485",
    "user": "@kliem"
}
```

It appears that #30008 fixed itself. However, this here broke the cygwin sphinx build, last I checked.

It have no clue what is going on, but with this ticket we go from passing to failing.



---

archive/issue_comments_423486.json:
```json
{
    "body": "It seems a default setting on Cygwin is `LANG=en_US.UTF-8`. Perhaps we can try to only set `LC_ALL` if `LANG` is not already set or something like this.",
    "created_at": "2020-07-23T21:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423486",
    "user": "@mkoeppe"
}
```

It seems a default setting on Cygwin is `LANG=en_US.UTF-8`. Perhaps we can try to only set `LC_ALL` if `LANG` is not already set or something like this.



---

archive/issue_comments_423487.json:
```json
{
    "body": "Also it should be investigated whether it was really necessary to add this line in #29033 to achieve Python 3.6 support. In particular note that `sage-uncompress-spkg` uses `sage-system-python` (which can even be python2) -- which really has nothing to do with Python 3.6 support (which is about `PYTHON_FOR_VENV`).",
    "created_at": "2020-07-23T22:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423487",
    "user": "@mkoeppe"
}
```

Also it should be investigated whether it was really necessary to add this line in #29033 to achieve Python 3.6 support. In particular note that `sage-uncompress-spkg` uses `sage-system-python` (which can even be python2) -- which really has nothing to do with Python 3.6 support (which is about `PYTHON_FOR_VENV`).



---

archive/issue_comments_423488.json:
```json
{
    "body": "What problems arise if we drop the locale mangling entirely? Trac #15791 doesn't mention a problem.",
    "created_at": "2020-08-05T14:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423488",
    "user": "@orlitzky"
}
```

What problems arise if we drop the locale mangling entirely? Trac #15791 doesn't mention a problem.



---

archive/issue_comments_423489.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-08-11T01:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423489",
    "user": "@mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_423490.json:
```json
{
    "body": "I am not sure if this is related, but while compiling Cypari on macOS, every file gives a warning of this type:\n\n```\n     Colperl: warning: Setting locale failed.\n    perl: warning: Please check that your locale settings:\n        LC_ALL = \"C.UTF-8\",\n        LC_TERMINAL = \"iTerm2\",\n        LANG = \"de_DE.UTF-8\"\n        are supported and installed on your system.\n    perl: warning: Falling back to a fallback locale (\"de_DE.UTF-8\").\n```\n\nThe fallback that is used seems to work for me, though.",
    "created_at": "2020-08-26T16:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423490",
    "user": "@mwageringel"
}
```

I am not sure if this is related, but while compiling Cypari on macOS, every file gives a warning of this type:

```
     Colperl: warning: Setting locale failed.
    perl: warning: Please check that your locale settings:
        LC_ALL = "C.UTF-8",
        LC_TERMINAL = "iTerm2",
        LANG = "de_DE.UTF-8"
        are supported and installed on your system.
    perl: warning: Falling back to a fallback locale ("de_DE.UTF-8").
```

The fallback that is used seems to work for me, though.



---

archive/issue_comments_423491.json:
```json
{
    "body": "I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).\n\nMaybe we should just revert that line? Why rock the boat?\n\nErik is the only other person who might know why it was added.",
    "created_at": "2020-08-29T01:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423491",
    "user": "@orlitzky"
}
```

I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).

Maybe we should just revert that line? Why rock the boat?

Erik is the only other person who might know why it was added.



---

archive/issue_comments_423492.json:
```json
{
    "body": "This will need testing on `centos-8` with Python 3.6",
    "created_at": "2020-08-29T04:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423492",
    "user": "@mkoeppe"
}
```

This will need testing on `centos-8` with Python 3.6



---

archive/issue_comments_423493.json:
```json
{
    "body": "Replying to [comment:31 mjo]:\n> I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).\n> \n> Maybe we should just revert that line? Why rock the boat?\n\nNo. This was added for reasons.  Specifically to ensure compatibility between how Python 3.6 and Python 3.7 set the default encoding.  Without this, there were bugs on Python 3.6 with Python not using a unicode character encoding by default.  See https://www.python.org/dev/peps/pep-0538/\n\n> The simplest way to deal with this problem for currently released versions of CPython is to explicitly set a more sensible locale when launching the application. For example:\n>\n>     LC_CTYPE=C.UTF-8 python3 ...\n> The C.UTF-8 locale is a full locale definition that uses UTF-8 for the LC_CTYPE category, and the same settings as the C locale for all other categories (including LC_COLLATE). It is offered by a number of Linux distributions (including Debian, Ubuntu, Fedora, Alpine and Android) as an alternative to the ASCII-based C locale. Some other platforms (such as HP-UX) offer an equivalent locale definition under the name C.utf8.\n> \n> Mac OS X and other *BSD systems have taken a different approach: instead of offering a C.UTF-8 locale, they offer a partial UTF-8 locale that only defines the LC_CTYPE category. On such systems, the preferred environmental locale adjustment is to set LC_CTYPE=UTF-8 rather than to set LC_ALL or LANG. \n\nPerhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.",
    "created_at": "2020-08-31T13:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423493",
    "user": "@embray"
}
```

Replying to [comment:31 mjo]:
> I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).
> 
> Maybe we should just revert that line? Why rock the boat?

No. This was added for reasons.  Specifically to ensure compatibility between how Python 3.6 and Python 3.7 set the default encoding.  Without this, there were bugs on Python 3.6 with Python not using a unicode character encoding by default.  See https://www.python.org/dev/peps/pep-0538/

> The simplest way to deal with this problem for currently released versions of CPython is to explicitly set a more sensible locale when launching the application. For example:
>
>     LC_CTYPE=C.UTF-8 python3 ...
> The C.UTF-8 locale is a full locale definition that uses UTF-8 for the LC_CTYPE category, and the same settings as the C locale for all other categories (including LC_COLLATE). It is offered by a number of Linux distributions (including Debian, Ubuntu, Fedora, Alpine and Android) as an alternative to the ASCII-based C locale. Some other platforms (such as HP-UX) offer an equivalent locale definition under the name C.utf8.
> 
> Mac OS X and other *BSD systems have taken a different approach: instead of offering a C.UTF-8 locale, they offer a partial UTF-8 locale that only defines the LC_CTYPE category. On such systems, the preferred environmental locale adjustment is to set LC_CTYPE=UTF-8 rather than to set LC_ALL or LANG. 

Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.



---

archive/issue_comments_423494.json:
```json
{
    "body": "Replying to [comment:33 embray]:\n\n> \n> Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.\n\nHow about only doing this `export LC_...=` on Python3.x with x<7 ?\nThis should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,\neverything UTF-8 there is language-specific) happy, as their Python is new enough.",
    "created_at": "2020-08-31T13:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423494",
    "user": "@dimpase"
}
```

Replying to [comment:33 embray]:

> 
> Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.

How about only doing this `export LC_...=` on Python3.x with x<7 ?
This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,
everything UTF-8 there is language-specific) happy, as their Python is new enough.



---

archive/issue_comments_423495.json:
```json
{
    "body": "Ok, thanks for the information. I think the major take-away from PEP538 is,\n\n> With this change, any *nix platform that does not offer at least one of the C.UTF-8, C.utf8 or UTF-8 locales as part of its standard configuration would only be considered a fully supported platform for CPython 3.7+ deployments when a suitable locale other than the default C locale is configured explicitly (e.g. en_AU.UTF-8, zh_CN.gb18030).\n\nI'm pretty sure we have files that actually need the UTF-8 encoding by now, so that rules out the possibility of \"doing nothing\" (leaving `LC_ALL=C` or `LC_CTYPE=C`) on python-3.6. And if we want to make python-3.6 work the way that python-3.7 does, then we're in the same situation as upstream is with respect to C.UTF-8: we have to consider python-3.6 with no C.UTF-8 (or equivalent) unsupported.\n\nSo I see two real options left:\n\n1. Try to set the locale to `C.UTF-8` or `C.utf8` or `UTF-8` when python-3.6 is being used, and declare the system unsupported if we can't. If python-3.7+ is being used, we can set the locale to `C`, and it will coerce the locale to something utf8ish on its own. In either case, a lack of utf8 locale would be unsupported.\n2. Don't set a locale at all, and rely on the distribution/user to set a utf8 locale by default. This would result in some confusing grep/sort behavior (they're locale-dependent), but maybe we could be extra careful in our SPKGs to work around that, so that e.g. `en_US.UTF-8` would work too.\n\nLong-term, as one of the largest python projects in existence, I think we probably have to suck it up and go with (1), even though it pains me to require a locale that glibc doesn't even ship and isn't POSIX. Whatever decisions python makes, we're stuck with.",
    "created_at": "2020-08-31T14:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423495",
    "user": "@orlitzky"
}
```

Ok, thanks for the information. I think the major take-away from PEP538 is,

> With this change, any *nix platform that does not offer at least one of the C.UTF-8, C.utf8 or UTF-8 locales as part of its standard configuration would only be considered a fully supported platform for CPython 3.7+ deployments when a suitable locale other than the default C locale is configured explicitly (e.g. en_AU.UTF-8, zh_CN.gb18030).

I'm pretty sure we have files that actually need the UTF-8 encoding by now, so that rules out the possibility of "doing nothing" (leaving `LC_ALL=C` or `LC_CTYPE=C`) on python-3.6. And if we want to make python-3.6 work the way that python-3.7 does, then we're in the same situation as upstream is with respect to C.UTF-8: we have to consider python-3.6 with no C.UTF-8 (or equivalent) unsupported.

So I see two real options left:

1. Try to set the locale to `C.UTF-8` or `C.utf8` or `UTF-8` when python-3.6 is being used, and declare the system unsupported if we can't. If python-3.7+ is being used, we can set the locale to `C`, and it will coerce the locale to something utf8ish on its own. In either case, a lack of utf8 locale would be unsupported.
2. Don't set a locale at all, and rely on the distribution/user to set a utf8 locale by default. This would result in some confusing grep/sort behavior (they're locale-dependent), but maybe we could be extra careful in our SPKGs to work around that, so that e.g. `en_US.UTF-8` would work too.

Long-term, as one of the largest python projects in existence, I think we probably have to suck it up and go with (1), even though it pains me to require a locale that glibc doesn't even ship and isn't POSIX. Whatever decisions python makes, we're stuck with.



---

archive/issue_comments_423496.json:
```json
{
    "body": "Replying to [comment:34 dimpase]:\n> \n> How about only doing this `export LC_...=` on Python3.x with x<7 ?\n> This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,\n> everything UTF-8 there is language-specific) happy, as their Python is new enough.\n\nI think a combination of this and the current branch is the best we can do. On python-3.6, we should try to set `LC_ALL` to `C.UTF-8`, `C.utf8`, or `UTF-8`. If we can't, then we should leave it alone and pray that the user's locale is compatible with all of our SPKGs. That situation would be unsupported by sage.\n\nOn python-3.7+, we can set `LC_ALL=C`, and python itself will try to pick an appropriate UTF-8 version of the locale. What does python on arch do in this situation? It's possible that python itself will fail to find a suitable UTF-8 locale, but there's not a lot we can do if upstream python insists on a nonstandard locale. Arch will just have to reconsider their decision unless they want to be not-fully supported by upstream python-3.7+.",
    "created_at": "2020-08-31T14:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423496",
    "user": "@orlitzky"
}
```

Replying to [comment:34 dimpase]:
> 
> How about only doing this `export LC_...=` on Python3.x with x<7 ?
> This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,
> everything UTF-8 there is language-specific) happy, as their Python is new enough.

I think a combination of this and the current branch is the best we can do. On python-3.6, we should try to set `LC_ALL` to `C.UTF-8`, `C.utf8`, or `UTF-8`. If we can't, then we should leave it alone and pray that the user's locale is compatible with all of our SPKGs. That situation would be unsupported by sage.

On python-3.7+, we can set `LC_ALL=C`, and python itself will try to pick an appropriate UTF-8 version of the locale. What does python on arch do in this situation? It's possible that python itself will fail to find a suitable UTF-8 locale, but there's not a lot we can do if upstream python insists on a nonstandard locale. Arch will just have to reconsider their decision unless they want to be not-fully supported by upstream python-3.7+.



---

archive/issue_comments_423497.json:
```json
{
    "body": "Personally I don't care what glibc or POSIX say on this.  I think 1) is a fine option.",
    "created_at": "2020-08-31T14:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423497",
    "user": "@embray"
}
```

Personally I don't care what glibc or POSIX say on this.  I think 1) is a fine option.



---

archive/issue_comments_423498.json:
```json
{
    "body": "Apparently we carry the C.UTF-8 patch in Gentoo for systemd, who definitely don't care about portability:\n\nhttps://github.com/systemd/systemd/pull/10742",
    "created_at": "2020-08-31T14:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423498",
    "user": "@orlitzky"
}
```

Apparently we carry the C.UTF-8 patch in Gentoo for systemd, who definitely don't care about portability:

https://github.com/systemd/systemd/pull/10742



---

archive/issue_comments_423499.json:
```json
{
    "body": "Is anyone working on this?",
    "created_at": "2020-09-07T18:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423499",
    "user": "@mkoeppe"
}
```

Is anyone working on this?



---

archive/issue_comments_423500.json:
```json
{
    "body": "Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.",
    "created_at": "2020-09-08T07:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423500",
    "user": "@vbraun"
}
```

Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.



---

archive/issue_comments_423501.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2020-09-08T07:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423501",
    "user": "@vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_423502.json:
```json
{
    "body": "Replying to [comment:40 vbraun]:\n> Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.\n\nThese systems do support UTF-8, but not the (as of yet) non-standard `C.UTF-8` locale.\n\nThe current branch has the right idea, but since python-3.6 and python-3.7 act differently, it can be made a bit more precise. With python-3.7+, we can set `LC_ALL=C` and let python do the guessing. (Maybe it doesn't succeed, but officially Not Our Problem at that point.) With python-3.6, we can check for the `C.UTF-8` locale and set it when found, with a fallback to `LC_ALL=C`. The current branch does this unconditionally but, it should only do it for python-3.6 and we should check the other equivalent names `C.utf8` and `UTF-8` too.\n\nI think it's worthwhile to not output a million scary error messages in the sage-9.2 release on these systems that have done nothing wrong. At the very least, we owe it to the Arch maintainers who do a lot for sage and would have to field the resulting bug reports (or patch this themselves). I'm sure there are BSDs where this is problematic too.",
    "created_at": "2020-09-08T14:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423502",
    "user": "@orlitzky"
}
```

Replying to [comment:40 vbraun]:
> Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.

These systems do support UTF-8, but not the (as of yet) non-standard `C.UTF-8` locale.

The current branch has the right idea, but since python-3.6 and python-3.7 act differently, it can be made a bit more precise. With python-3.7+, we can set `LC_ALL=C` and let python do the guessing. (Maybe it doesn't succeed, but officially Not Our Problem at that point.) With python-3.6, we can check for the `C.UTF-8` locale and set it when found, with a fallback to `LC_ALL=C`. The current branch does this unconditionally but, it should only do it for python-3.6 and we should check the other equivalent names `C.utf8` and `UTF-8` too.

I think it's worthwhile to not output a million scary error messages in the sage-9.2 release on these systems that have done nothing wrong. At the very least, we owe it to the Arch maintainers who do a lot for sage and would have to field the resulting bug reports (or patch this themselves). I'm sure there are BSDs where this is problematic too.



---

archive/issue_comments_423503.json:
```json
{
    "body": "Arch locales maintainers just need to get C.UTF-8 locale, they are being silly  (their argument - \"it's an evil coming from Debian\" - and I'm told they don't reopen the corresponding issue, as it's \"decided\". Meanwhile everybody else has C.UTF-8 locale, it's just them who don't)",
    "created_at": "2020-09-10T15:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423503",
    "user": "@dimpase"
}
```

Arch locales maintainers just need to get C.UTF-8 locale, they are being silly  (their argument - "it's an evil coming from Debian" - and I'm told they don't reopen the corresponding issue, as it's "decided". Meanwhile everybody else has C.UTF-8 locale, it's just them who don't)



---

archive/issue_comments_423504.json:
```json
{
    "body": "It's a blocker because it is a regression regarding platform support.\n\nCan we please get a fix done?",
    "created_at": "2020-09-10T15:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423504",
    "user": "@mkoeppe"
}
```

It's a blocker because it is a regression regarding platform support.

Can we please get a fix done?



---

archive/issue_comments_423505.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-09-10T15:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423505",
    "user": "@mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_423506.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-09-10T16:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423506",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_423507.json:
```json
{
    "body": "rebased over the latest beta",
    "created_at": "2020-09-10T16:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423507",
    "user": "@dimpase"
}
```

rebased over the latest beta



---

archive/issue_comments_423508.json:
```json
{
    "body": "Using a freshly installed Ubuntu 18.04 (bionic) and with some french settings set somewhere so that `$ git pull` returns `D\u00e9j\u00e0 \u00e0 jour`, a french equivalent for `Already up to date`, running make on `9.2.beta12` yields the `[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)` error, see [this post](https://groups.google.com/g/sage-release/c/hobZzw74Rv0/m/bIvvvlXhAAAJ), right from the start of the build of the documentation.\n\nWith beta12 + current branch, I still get the same error after  `make doc-clean && make`.",
    "created_at": "2020-09-14T12:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423508",
    "user": "@seblabbe"
}
```

Using a freshly installed Ubuntu 18.04 (bionic) and with some french settings set somewhere so that `$ git pull` returns `Dj  jour`, a french equivalent for `Already up to date`, running make on `9.2.beta12` yields the `[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)` error, see [this post](https://groups.google.com/g/sage-release/c/hobZzw74Rv0/m/bIvvvlXhAAAJ), right from the start of the build of the documentation.

With beta12 + current branch, I still get the same error after  `make doc-clean && make`.



---

archive/issue_comments_423509.json:
```json
{
    "body": "That being said, I now see where it comes from:\n\n```\nsage: with open('src/doc/en/reference/references/index.rst', 'r') as f: s = f.read()                              \nsage: s[2600:2700]                                                                                   \n' characteristic,* The Open Book Series, vol. 2, no. 1, pp. 37\u201353, Jan. 2019.\\n\\n.. [ABZ2007] \\\\R. Aharo'\nsage: s[2661:2700]                                                                                   \n'\u201353, Jan. 2019.\\n\\n.. [ABZ2007] \\\\R. Aharo'\n```\n\n\nThe character `\u2013` has many occurrences in that file and is possibly not the only occurrence of a nonascii character (for example names of authors...). So, I am not sure replacing them by `--` is the correct fix. And I don't see how this is related at all with the `C.UTF-8` configuration.",
    "created_at": "2020-09-14T12:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423509",
    "user": "@seblabbe"
}
```

That being said, I now see where it comes from:

```
sage: with open('src/doc/en/reference/references/index.rst', 'r') as f: s = f.read()                              
sage: s[2600:2700]                                                                                   
' characteristic,* The Open Book Series, vol. 2, no. 1, pp. 3753, Jan. 2019.\n\n.. [ABZ2007] \\R. Aharo'
sage: s[2661:2700]                                                                                   
'53, Jan. 2019.\n\n.. [ABZ2007] \\R. Aharo'
```


The character `` has many occurrences in that file and is possibly not the only occurrence of a nonascii character (for example names of authors...). So, I am not sure replacing them by `--` is the correct fix. And I don't see how this is related at all with the `C.UTF-8` configuration.



---

archive/issue_comments_423510.json:
```json
{
    "body": "So your machine has no C.UTF-8 locale installed, right?",
    "created_at": "2020-09-14T13:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423510",
    "user": "@dimpase"
}
```

So your machine has no C.UTF-8 locale installed, right?



---

archive/issue_comments_423511.json:
```json
{
    "body": "How can I figure this out? If it can help, I have this:\n\n\n```\n$ locale\nLANG=fr_CA.UTF-8\nLANGUAGE=fr_CA:fr_FR:en_GB:en\nLC_CTYPE=\"fr_CA.UTF-8\"\nLC_NUMERIC=fr_FR.UTF-8\nLC_TIME=fr_FR.UTF-8\nLC_COLLATE=\"fr_CA.UTF-8\"\nLC_MONETARY=fr_FR.UTF-8\nLC_MESSAGES=\"fr_CA.UTF-8\"\nLC_PAPER=fr_FR.UTF-8\nLC_NAME=fr_FR.UTF-8\nLC_ADDRESS=fr_FR.UTF-8\nLC_TELEPHONE=fr_FR.UTF-8\nLC_MEASUREMENT=fr_FR.UTF-8\nLC_IDENTIFICATION=fr_FR.UTF-8\nLC_ALL=\nslabbe@miami ~ $ man locale\nslabbe@miami ~ $ locale -a\nC\nC.UTF-8\nen_AG\nen_AG.utf8\nen_AU.utf8\nen_BW.utf8\nen_CA.utf8\nen_DK.utf8\nen_GB.utf8\nen_HK.utf8\nen_IE.utf8\nen_IL\nen_IL.utf8\nen_IN\nen_IN.utf8\nen_NG\nen_NG.utf8\nen_NZ.utf8\nen_PH.utf8\nen_SG.utf8\nen_US.utf8\nen_ZA.utf8\nen_ZM\nen_ZM.utf8\nen_ZW.utf8\nfr_BE.utf8\nfr_CA.utf8\nfr_CH.utf8\nfrench\nfr_FR\nfr_FR.iso88591\nfr_FR.utf8\nfr_LU.utf8\nPOSIX\n```\n",
    "created_at": "2020-09-14T13:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423511",
    "user": "@seblabbe"
}
```

How can I figure this out? If it can help, I have this:


```
$ locale
LANG=fr_CA.UTF-8
LANGUAGE=fr_CA:fr_FR:en_GB:en
LC_CTYPE="fr_CA.UTF-8"
LC_NUMERIC=fr_FR.UTF-8
LC_TIME=fr_FR.UTF-8
LC_COLLATE="fr_CA.UTF-8"
LC_MONETARY=fr_FR.UTF-8
LC_MESSAGES="fr_CA.UTF-8"
LC_PAPER=fr_FR.UTF-8
LC_NAME=fr_FR.UTF-8
LC_ADDRESS=fr_FR.UTF-8
LC_TELEPHONE=fr_FR.UTF-8
LC_MEASUREMENT=fr_FR.UTF-8
LC_IDENTIFICATION=fr_FR.UTF-8
LC_ALL=
slabbe@miami ~ $ man locale
slabbe@miami ~ $ locale -a
C
C.UTF-8
en_AG
en_AG.utf8
en_AU.utf8
en_BW.utf8
en_CA.utf8
en_DK.utf8
en_GB.utf8
en_HK.utf8
en_IE.utf8
en_IL
en_IL.utf8
en_IN
en_IN.utf8
en_NG
en_NG.utf8
en_NZ.utf8
en_PH.utf8
en_SG.utf8
en_US.utf8
en_ZA.utf8
en_ZM
en_ZM.utf8
en_ZW.utf8
fr_BE.utf8
fr_CA.utf8
fr_CH.utf8
french
fr_FR
fr_FR.iso88591
fr_FR.utf8
fr_LU.utf8
POSIX
```




---

archive/issue_comments_423512.json:
```json
{
    "body": "in \n\n```\n+if test x`locale -a | grep C\\.UTF-8` != x; then\n+ export LC_ALL=C.UTF-8;\n+else\n+ export LC_ALL=C;\n+fi\n```\n\nbit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?",
    "created_at": "2020-09-14T13:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423512",
    "user": "@dimpase"
}
```

in 

```
+if test x`locale -a | grep C\.UTF-8` != x; then
+ export LC_ALL=C.UTF-8;
+else
+ export LC_ALL=C;
+fi
```

bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?



---

archive/issue_comments_423513.json:
```json
{
    "body": "Replying to [comment:51 dimpase]:\n> bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?\n\nSame error after make doc-clean and make.",
    "created_at": "2020-09-14T14:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423513",
    "user": "@seblabbe"
}
```

Replying to [comment:51 dimpase]:
> bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?

Same error after make doc-clean and make.



---

archive/issue_comments_423514.json:
```json
{
    "body": "To me, it seems like an error of the following kind. That is we are opening the `src/doc/en/reference/references/index.rst` file as a `bytes` type, and at some place (where?), we decode the bytes to ascii and then we get `UnicodeDecodeError` because it is not ascii at all. Here is a way to reproduce the same error message:\n\n\n```\nsage: with open('src/doc/en/reference/references/index.rst', 'rb') as f: b = f.read()                \nsage: b.decode('ascii')                                                                              \n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-13-498050d5a3fb> in <module>\n----> 1 b.decode('ascii')\n\nUnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\nsage: s = b.decode('utf-8') \n```\n\nI am adding Fr\u00e9d\u00e9ric in cc since he fixed a lot of those `UnicodeDecodeError` in recent times with the passage to Python 3.\n\nAlso, why this works in Python3.8 and not in Python3.6 ?",
    "created_at": "2020-09-14T14:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423514",
    "user": "@seblabbe"
}
```

To me, it seems like an error of the following kind. That is we are opening the `src/doc/en/reference/references/index.rst` file as a `bytes` type, and at some place (where?), we decode the bytes to ascii and then we get `UnicodeDecodeError` because it is not ascii at all. Here is a way to reproduce the same error message:


```
sage: with open('src/doc/en/reference/references/index.rst', 'rb') as f: b = f.read()                
sage: b.decode('ascii')                                                                              
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-13-498050d5a3fb> in <module>
----> 1 b.decode('ascii')

UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
sage: s = b.decode('utf-8') 
```

I am adding Frdric in cc since he fixed a lot of those `UnicodeDecodeError` in recent times with the passage to Python 3.

Also, why this works in Python3.8 and not in Python3.6 ?



---

archive/issue_comments_423515.json:
```json
{
    "body": "perhaps Python 3.6 needs an extra punch in form of \n\n```diff\n--- a/src/sage/docs/conf.py\n+++ b/src/sage/docs/conf.py\n@@ -36,6 +36,7 @@ plot_pre_code = \"\"\"\n # Set locale to prevent having commas in decimal numbers\n # in tachyon input (see https://trac.sagemath.org/ticket/28971)\n import locale\n+locale.setlocale(LC_ALL, '')\n locale.setlocale(locale.LC_NUMERIC, 'C')\n def sphinx_plot(graphics, **kwds):\n     import matplotlib.image as mpimg\n```\n\ncould you try this, without what's suggested in comment:51 ?\n\nThere is a comment \n\n```\nAccording to POSIX, a program which has not called setlocale(LC_ALL, '') runs using the \nportable 'C' locale. Calling setlocale(LC_ALL, '') lets it use the default locale as defined by the LANG variable. Since we do not want to interfere with the current locale setting we thus emulate the behavior in the way described above.\n```\n\nin https://docs.python.org/3.6/library/locale.html which makes me think it might be what's needed.",
    "created_at": "2020-09-14T15:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423515",
    "user": "@dimpase"
}
```

perhaps Python 3.6 needs an extra punch in form of 

```diff
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -36,6 +36,7 @@ plot_pre_code = """
 # Set locale to prevent having commas in decimal numbers
 # in tachyon input (see https://trac.sagemath.org/ticket/28971)
 import locale
+locale.setlocale(LC_ALL, '')
 locale.setlocale(locale.LC_NUMERIC, 'C')
 def sphinx_plot(graphics, **kwds):
     import matplotlib.image as mpimg
```

could you try this, without what's suggested in comment:51 ?

There is a comment 

```
According to POSIX, a program which has not called setlocale(LC_ALL, '') runs using the 
portable 'C' locale. Calling setlocale(LC_ALL, '') lets it use the default locale as defined by the LANG variable. Since we do not want to interfere with the current locale setting we thus emulate the behavior in the way described above.
```

in https://docs.python.org/3.6/library/locale.html which makes me think it might be what's needed.



---

archive/issue_comments_423516.json:
```json
{
    "body": "The name `C.UTF-8` isn't sufficient; you have to check for the others too. On Gentoo:\n\n\n```\n$ locale -a\nC\nC.utf8\nPOSIX\nen_US\nen_US.iso88591\nen_US.utf8\n```\n",
    "created_at": "2020-09-14T15:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423516",
    "user": "@orlitzky"
}
```

The name `C.UTF-8` isn't sufficient; you have to check for the others too. On Gentoo:


```
$ locale -a
C
C.utf8
POSIX
en_US
en_US.iso88591
en_US.utf8
```




---

archive/issue_comments_423517.json:
```json
{
    "body": "Replying to [comment:54 dimpase]:\n> could you try this, without what's suggested in comment:51 ?\n\nI get the same error after make doc-clean && make. In fact adding a line `print('AAAAAAAAAAAAA')` a this place does not print any `AAAAAAAAA...` on my screen, so I wonder if that code is really executed before the error occurs.",
    "created_at": "2020-09-14T15:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423517",
    "user": "@seblabbe"
}
```

Replying to [comment:54 dimpase]:
> could you try this, without what's suggested in comment:51 ?

I get the same error after make doc-clean && make. In fact adding a line `print('AAAAAAAAAAAAA')` a this place does not print any `AAAAAAAAA...` on my screen, so I wonder if that code is really executed before the error occurs.



---

archive/issue_comments_423518.json:
```json
{
    "body": "AAAAA, indeed (headbang on kbd)\nhere is the fix, I think\n\n```diff\n--- a/src/doc/en/reference/conf_sub.py\n+++ b/src/doc/en/reference/conf_sub.py\n@@ -20,7 +20,7 @@ ref_src = os.path.join(SAGE_DOC_SRC, 'en', 'reference')\n ref_out = os.path.join(SAGE_DOC, 'html', 'en', 'reference')\n \n # We use the main document's title, if we can find it.\n-rst_file = open('index.rst', 'r')\n+rst_file = open('index.rst', 'r', encoding='utf-8')\n rst_lines = rst_file.read().splitlines()\n rst_file.close()\n \n```\n\n\nindeed, that's one place in our homebaked docbuilder that opens UTF-8-encoded files without specifying them as UTF, and Python 3.6 does not like it.",
    "created_at": "2020-09-14T20:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423518",
    "user": "@dimpase"
}
```

AAAAA, indeed (headbang on kbd)
here is the fix, I think

```diff
--- a/src/doc/en/reference/conf_sub.py
+++ b/src/doc/en/reference/conf_sub.py
@@ -20,7 +20,7 @@ ref_src = os.path.join(SAGE_DOC_SRC, 'en', 'reference')
 ref_out = os.path.join(SAGE_DOC, 'html', 'en', 'reference')
 
 # We use the main document's title, if we can find it.
-rst_file = open('index.rst', 'r')
+rst_file = open('index.rst', 'r', encoding='utf-8')
 rst_lines = rst_file.read().splitlines()
 rst_file.close()
 
```


indeed, that's one place in our homebaked docbuilder that opens UTF-8-encoded files without specifying them as UTF, and Python 3.6 does not like it.



---

archive/issue_comments_423519.json:
```json
{
    "body": "there are also many more missing `encoding='utf-8'` in `open()` on source files in the docbuilder.\n\nand perhaps on other text files too. all these lead to these `UnicodeDecodeError: 'ascii' codec can't decode byte...`\n\nShould we just abandon the idea to support random system Python 3.6, they are just broken in this way...",
    "created_at": "2020-09-14T21:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423519",
    "user": "@dimpase"
}
```

there are also many more missing `encoding='utf-8'` in `open()` on source files in the docbuilder.

and perhaps on other text files too. all these lead to these `UnicodeDecodeError: 'ascii' codec can't decode byte...`

Should we just abandon the idea to support random system Python 3.6, they are just broken in this way...



---

archive/issue_comments_423520.json:
```json
{
    "body": "Worse, there are files with lots of utf-8 stuff, sitting in `r\"\"\"...\"\"\"` multiline comments, e.g.\n`src/sage/algebras/lie_algebras/lie_algebra_element.pyx`, and they cause problems too.",
    "created_at": "2020-09-14T21:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423520",
    "user": "@dimpase"
}
```

Worse, there are files with lots of utf-8 stuff, sitting in `r"""..."""` multiline comments, e.g.
`src/sage/algebras/lie_algebras/lie_algebra_element.pyx`, and they cause problems too.



---

archive/issue_comments_423521.json:
```json
{
    "body": "this is with Ubuntu 18.04 native Python 3.6:\n\n\n```\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.genus: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition_complete: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:8: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:9: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:23: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:24: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:7: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:6: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.hamming_weight: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.inverse_series_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_one: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_zero: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.number_of_terms: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.generic_power_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial._mul_trunc_: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] The inventory files are in local/share/doc/sage/inventory/en/reference/polynomial_rings.\n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/usr/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n[dochtml]     \"__main__\", mod_spec)\n[dochtml]   File \"/usr/lib/python3.6/runpy.py\", line 85, in _run_code\n[dochtml]     exec(code, run_globals)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 1730, in main\n[dochtml]     builder()\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 344, in _wrapper\n[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 570, in _wrapper\n[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 556, in _build_everything_except_bibliography\n[dochtml]     build_many(build_ref_doc, non_references)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 296, in build_many\n[dochtml]     _build_many(target, args, processes=NUM_THREADS)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/utils.py\", line 291, in build_many\n[dochtml]     raise worker_exc.original_exception\n[dochtml] OSError: WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n```\n\n\nif anyone wants to sort all this out, be my guest.",
    "created_at": "2020-09-14T21:20:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423521",
    "user": "@dimpase"
}
```

this is with Ubuntu 18.04 native Python 3.6:


```
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.genus: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition_complete: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:8: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:9: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:23: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:24: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:7: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:6: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.hamming_weight: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.inverse_series_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_one: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_zero: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.number_of_terms: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.generic_power_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial._mul_trunc_: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] The inventory files are in local/share/doc/sage/inventory/en/reference/polynomial_rings.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.6/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/usr/lib/python3.6/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 1730, in main
[dochtml]     builder()
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 344, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 570, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 556, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 296, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/utils.py", line 291, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```


if anyone wants to sort all this out, be my guest.



---

archive/issue_comments_423522.json:
```json
{
    "body": "please push your branch if you started to do some changes using utf-8 encodings. I will take a look tomorrow europe time.",
    "created_at": "2020-09-14T21:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423522",
    "user": "@seblabbe"
}
```

please push your branch if you started to do some changes using utf-8 encodings. I will take a look tomorrow europe time.



---

archive/issue_comments_423523.json:
```json
{
    "body": "Because `build_many` catches the error, it is difficult to debug. The following change allows to see the real error:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex 0841f429e7..c9e08214f3 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -292,6 +292,8 @@ def build_many(target, args):\n     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the\n     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.\n     \"\"\"\n+    for arg in args:\n+        target(arg)\n     try:\n         _build_many(target, args, processes=NUM_THREADS)\n     except BaseException as exc:\n```\n\n\nwhich is:\n\n\n```\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 296, in build_many\n[dochtml]     target(arg)\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 79, in build_ref_doc\n[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 763, in _wrapper\n[dochtml]     for module_name in self.get_all_included_modules():\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 927, in get_all_included_modules\n[dochtml]     for module in self.get_modules(filename):\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 1009, in get_modules\n[dochtml]     lines = f.readlines()\n[dochtml]   File \"/usr/lib/python3.6/encodings/ascii.py\", line 26, in decode\n[dochtml]     return codecs.ascii_decode(input, self.errors)[0]\n[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\n```\n\n\nBut indeed, I see that adding a `encoding='utf-8'` at this place is not sufficient.",
    "created_at": "2020-09-15T09:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423523",
    "user": "@seblabbe"
}
```

Because `build_many` catches the error, it is difficult to debug. The following change allows to see the real error:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index 0841f429e7..c9e08214f3 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -292,6 +292,8 @@ def build_many(target, args):
     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the
     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.
     """
+    for arg in args:
+        target(arg)
     try:
         _build_many(target, args, processes=NUM_THREADS)
     except BaseException as exc:
```


which is:


```
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 296, in build_many
[dochtml]     target(arg)
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 763, in _wrapper
[dochtml]     for module_name in self.get_all_included_modules():
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 927, in get_all_included_modules
[dochtml]     for module in self.get_modules(filename):
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 1009, in get_modules
[dochtml]     lines = f.readlines()
[dochtml]   File "/usr/lib/python3.6/encodings/ascii.py", line 26, in decode
[dochtml]     return codecs.ascii_decode(input, self.errors)[0]
[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
```


But indeed, I see that adding a `encoding='utf-8'` at this place is not sufficient.



---

archive/issue_comments_423524.json:
```json
{
    "body": "It is not sifficient, and I get the codec errors on a file where I cleaned all non-ascii away (sic!).\n\nI am giving up on this. I think the code is too new for Python 3.6, and I don't think we should invest time in a version that will be EOL by the end of 2021. \n\nPeople who only have Python 3.6 can build Python.",
    "created_at": "2020-09-15T09:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423524",
    "user": "@dimpase"
}
```

It is not sifficient, and I get the codec errors on a file where I cleaned all non-ascii away (sic!).

I am giving up on this. I think the code is too new for Python 3.6, and I don't think we should invest time in a version that will be EOL by the end of 2021. 

People who only have Python 3.6 can build Python.



---

archive/issue_comments_423525.json:
```json
{
    "body": "We already have some code in Sage that was taken from Python 3.7, in src/sage/misc/sageinspect.py, which is used in docbuilding, perhaps it is too new, e.g. \n\n```\ndef formatannotation(annotation, base_module=None):\n    \"\"\"\n    This is taken from Python 3.7's inspect.py; the only change is to\n    add documentation.\n...\n```\n\n\ncode from `sageinspect.py` is used in \"formatting arguments\", the error shown in comment:60.",
    "created_at": "2020-09-15T09:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423525",
    "user": "@dimpase"
}
```

We already have some code in Sage that was taken from Python 3.7, in src/sage/misc/sageinspect.py, which is used in docbuilding, perhaps it is too new, e.g. 

```
def formatannotation(annotation, base_module=None):
    """
    This is taken from Python 3.7's inspect.py; the only change is to
    add documentation.
...
```


code from `sageinspect.py` is used in "formatting arguments", the error shown in comment:60.



---

archive/issue_comments_423526.json:
```json
{
    "body": "I think I will surrender too. I posted the changes that needs to be done on the branch [u/slabbe/30053](https://git.sagemath.org/sage.git/commit/?h=u/slabbe/30053) to get Python3.6 to work. As you, I now get the error\n\n\n```\n[dochtml] OSError: WARNING: error while formatting arguments for \nsage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition:\n'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n```\n",
    "created_at": "2020-09-15T11:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423526",
    "user": "@seblabbe"
}
```

I think I will surrender too. I posted the changes that needs to be done on the branch [u/slabbe/30053](https://git.sagemath.org/sage.git/commit/?h=u/slabbe/30053) to get Python3.6 to work. As you, I now get the error


```
[dochtml] OSError: WARNING: error while formatting arguments for 
sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition:
'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```




---

archive/issue_comments_423527.json:
```json
{
    "body": "this ticket helps if one is on python 3.x for x>6. As to 3.6, well, it's apparently hard, as Sage code and perhaps sphinx are too new for it.",
    "created_at": "2020-09-15T12:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423527",
    "user": "@dimpase"
}
```

this ticket helps if one is on python 3.x for x>6. As to 3.6, well, it's apparently hard, as Sage code and perhaps sphinx are too new for it.



---

archive/issue_comments_423528.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-15T12:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423528",
    "user": "@dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423529.json:
```json
{
    "body": "On python >= 3.7, `LC_ALL=C` is sufficient, because python itself will attempt to find a UTF-8 version of that locale.\n\n(It may be only a semantic difference, but then the non-existence of `C.UTF-8` on some systems becomes Not Our Problem.)",
    "created_at": "2020-09-15T12:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423529",
    "user": "@orlitzky"
}
```

On python >= 3.7, `LC_ALL=C` is sufficient, because python itself will attempt to find a UTF-8 version of that locale.

(It may be only a semantic difference, but then the non-existence of `C.UTF-8` on some systems becomes Not Our Problem.)



---

archive/issue_comments_423530.json:
```json
{
    "body": "this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?",
    "created_at": "2020-09-15T14:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423530",
    "user": "@dimpase"
}
```

this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?



---

archive/issue_comments_423531.json:
```json
{
    "body": "Replying to [comment:68 dimpase]:\n> this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?\n\nYes, if we're going to throw python-3.6 under the bus in this release.\n\n`LC_ALL=C` is the standard choice, and python >= 3.7 already treat `LC_ALL=C` magically. That's what \"PEP 538 -- Coercing the legacy C locale to a UTF-8 based locale\" is about.",
    "created_at": "2020-09-15T14:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423531",
    "user": "@orlitzky"
}
```

Replying to [comment:68 dimpase]:
> this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?

Yes, if we're going to throw python-3.6 under the bus in this release.

`LC_ALL=C` is the standard choice, and python >= 3.7 already treat `LC_ALL=C` magically. That's what "PEP 538 -- Coercing the legacy C locale to a UTF-8 based locale" is about.



---

archive/issue_comments_423532.json:
```json
{
    "body": "Let's refocus this ticket (blocker for Sage 9.2) on solving the issues for Python 3.7+\n\nTo me Python 3.6 support is a \"wishlist\" item, but not a blocker. I have created a separate ticket for it: #30576",
    "created_at": "2020-09-15T15:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423532",
    "user": "@mkoeppe"
}
```

Let's refocus this ticket (blocker for Sage 9.2) on solving the issues for Python 3.7+

To me Python 3.6 support is a "wishlist" item, but not a blocker. I have created a separate ticket for it: #30576



---

archive/issue_comments_423533.json:
```json
{
    "body": "what are the 3.7+ problems left here?\nI presume all of them have plain C locale, so it all should work, no?",
    "created_at": "2020-09-15T16:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423533",
    "user": "@dimpase"
}
```

what are the 3.7+ problems left here?
I presume all of them have plain C locale, so it all should work, no?



---

archive/issue_comments_423534.json:
```json
{
    "body": "Replying to [comment:72 dimpase]:\n> what are the 3.7+ problems left here?\n> I presume all of them have plain C locale, so it all should work, no?\n\nNone, but AFAIK there were none before we started messing with the locale, either.\n\nIf no one is going to fix the python-3.6 problems, we should just drop it from the list of supported system pythons and revert this to `LC_ALL=C`. That's simpler and leaves us with one fewer locale problem to debug in the future.",
    "created_at": "2020-09-15T23:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423534",
    "user": "@orlitzky"
}
```

Replying to [comment:72 dimpase]:
> what are the 3.7+ problems left here?
> I presume all of them have plain C locale, so it all should work, no?

None, but AFAIK there were none before we started messing with the locale, either.

If no one is going to fix the python-3.6 problems, we should just drop it from the list of supported system pythons and revert this to `LC_ALL=C`. That's simpler and leaves us with one fewer locale problem to debug in the future.



---

archive/issue_comments_423535.json:
```json
{
    "body": "I wouldn't close the door on python 3.6 yet, so let's get this patch in please.",
    "created_at": "2020-09-16T00:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423535",
    "user": "@mkoeppe"
}
```

I wouldn't close the door on python 3.6 yet, so let's get this patch in please.



---

archive/issue_comments_423536.json:
```json
{
    "body": "Replying to [comment:74 mkoeppe]:\n> I wouldn't close the door on python 3.6 yet, so let's get this patch in please.\n\nIt still isn't sufficient for python-3.6, even if someone does fix the other problems. The name `C.UTF-8` isn't standard because... it's not standardized yet. On Gentoo, it's `C.utf8`, and elsewhere apparently (per the PEP) it's called simply `UTF-8`. All of them should be checked/tried, and we should really only be doing it if python-3.6 is in use. That way, when we drop python-3.6, we're left with just `LC_ALL=C` again.\n\nAlso keep in mind that if no one actually fixes the other problems with python-3.6, the door is closed regardless.",
    "created_at": "2020-09-16T00:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423536",
    "user": "@orlitzky"
}
```

Replying to [comment:74 mkoeppe]:
> I wouldn't close the door on python 3.6 yet, so let's get this patch in please.

It still isn't sufficient for python-3.6, even if someone does fix the other problems. The name `C.UTF-8` isn't standard because... it's not standardized yet. On Gentoo, it's `C.utf8`, and elsewhere apparently (per the PEP) it's called simply `UTF-8`. All of them should be checked/tried, and we should really only be doing it if python-3.6 is in use. That way, when we drop python-3.6, we're left with just `LC_ALL=C` again.

Also keep in mind that if no one actually fixes the other problems with python-3.6, the door is closed regardless.



---

archive/issue_comments_423537.json:
```json
{
    "body": "Replying to [comment:75 mjo]:\n> Replying to [comment:74 mkoeppe]:\n> > I wouldn't close the door on python 3.6 yet, so let's get this patch in please.\n> \n> It still isn't sufficient for python-3.6\n\nYes, I know, that's why I opened the separate ticket #30576 for that.",
    "created_at": "2020-09-16T01:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423537",
    "user": "@mkoeppe"
}
```

Replying to [comment:75 mjo]:
> Replying to [comment:74 mkoeppe]:
> > I wouldn't close the door on python 3.6 yet, so let's get this patch in please.
> 
> It still isn't sufficient for python-3.6

Yes, I know, that's why I opened the separate ticket #30576 for that.



---

archive/issue_comments_423538.json:
```json
{
    "body": "there is no harm in adding this, anyway, thus, over to bots.",
    "created_at": "2020-09-16T08:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423538",
    "user": "@dimpase"
}
```

there is no harm in adding this, anyway, thus, over to bots.



---

archive/issue_comments_423539.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-16T08:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423539",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423540.json:
```json
{
    "body": "I've also removed #30551 as a dependency - after all whether Python 3.6 is (somewhat) supported (IMHO docbuilding is the main problem there)\ncan be sorted out later.",
    "created_at": "2020-09-16T08:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423540",
    "user": "@dimpase"
}
```

I've also removed #30551 as a dependency - after all whether Python 3.6 is (somewhat) supported (IMHO docbuilding is the main problem there)
can be sorted out later.



---

archive/issue_comments_423541.json:
```json
{
    "body": "Replying to [comment:76 mkoeppe]:\n> \n> Yes, I know, that's why I opened the separate ticket #30576 for that.\n\nThe stuff on ticket #30576 isn't what I was referring to...\n\n\nReplying to [comment:77 dimpase]:\n> there is no harm in adding this, anyway, thus, over to bots.\n\nThe harm is that now we have additional locale problems to debug for a change that doesn't solve anything. With python-3.7, there are now three different configurations:\n\n* The `C.UTF-8` locale exists and is used.\n* No utf8 locale exists, so `C` is used.\n* A utf8 locale is available, but your grep doesn't find it, so we wind up with `C` on a machine that could have a utf8 locale.\n\nWhy, when `LC_ALL=C` unconditionally works fine and had been in there for ages?\n\n*If* someone wants to fix python-3.6, we should add these hacks only for python-3.6, and we should try the alternate names `C.utf8` and `UTF-8`, too.",
    "created_at": "2020-09-16T14:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423541",
    "user": "@orlitzky"
}
```

Replying to [comment:76 mkoeppe]:
> 
> Yes, I know, that's why I opened the separate ticket #30576 for that.

The stuff on ticket #30576 isn't what I was referring to...


Replying to [comment:77 dimpase]:
> there is no harm in adding this, anyway, thus, over to bots.

The harm is that now we have additional locale problems to debug for a change that doesn't solve anything. With python-3.7, there are now three different configurations:

* The `C.UTF-8` locale exists and is used.
* No utf8 locale exists, so `C` is used.
* A utf8 locale is available, but your grep doesn't find it, so we wind up with `C` on a machine that could have a utf8 locale.

Why, when `LC_ALL=C` unconditionally works fine and had been in there for ages?

*If* someone wants to fix python-3.6, we should add these hacks only for python-3.6, and we should try the alternate names `C.utf8` and `UTF-8`, too.



---

archive/issue_comments_423542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-09-16T15:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423542",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_423543.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-09-16T15:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423543",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_423544.json:
```json
{
    "body": "OK, so how about this?",
    "created_at": "2020-09-16T15:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423544",
    "user": "@dimpase"
}
```

OK, so how about this?



---

archive/issue_comments_423545.json:
```json
{
    "body": "I think that's the best solution, possibly combined with dropping 3.6 from the list of system pythons that we accept. Portability is nice and all, but we're wasting a lot of time trying to support an evolutionary dead-end with py3.6.",
    "created_at": "2020-09-16T15:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423545",
    "user": "@orlitzky"
}
```

I think that's the best solution, possibly combined with dropping 3.6 from the list of system pythons that we accept. Portability is nice and all, but we're wasting a lot of time trying to support an evolutionary dead-end with py3.6.



---

archive/issue_comments_423546.json:
```json
{
    "body": "Fine with me - then please also adjust python3's spkg-configure...",
    "created_at": "2020-09-16T16:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423546",
    "user": "@mkoeppe"
}
```

Fine with me - then please also adjust python3's spkg-configure...



---

archive/issue_comments_423547.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-16T16:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423547",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423548.json:
```json
{
    "body": "Replying to [comment:83 mkoeppe]:\n> Fine with me - then please also adjust python3's spkg-configure...\nfixed, as discussed - only test `python3`, to be either 3.7 or 3.8.\n\nPlease review",
    "created_at": "2020-09-16T16:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423548",
    "user": "@dimpase"
}
```

Replying to [comment:83 mkoeppe]:
> Fine with me - then please also adjust python3's spkg-configure...
fixed, as discussed - only test `python3`, to be either 3.7 or 3.8.

Please review



---

archive/issue_comments_423549.json:
```json
{
    "body": "I have made an adjustment. I don't like mixing the change discussed in #30546 into this ticket\n----\nNew commits:",
    "created_at": "2020-09-16T17:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423549",
    "user": "@mkoeppe"
}
```

I have made an adjustment. I don't like mixing the change discussed in #30546 into this ticket
----
New commits:



---

archive/issue_comments_423550.json:
```json
{
    "body": "Rationale: The changed search behavior would lead to confusing reports on sage-release.",
    "created_at": "2020-09-16T17:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423550",
    "user": "@mkoeppe"
}
```

Rationale: The changed search behavior would lead to confusing reports on sage-release.



---

archive/issue_comments_423551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-16T17:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423551",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-19T13:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29816",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29816#issuecomment-423552",
    "user": "@vbraun"
}
```

Resolution: fixed
