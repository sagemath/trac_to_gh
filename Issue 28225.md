# Issue 28225: Bug in computing the second fundamental form of a Riemannian submanifold

Issue created by migration from https://trac.sagemath.org/ticket/28462

Original creator: egourgoulhon

Original creation time: 2019-09-08 13:31:44

CC:  tscrim @florentinj

Keywords: submanifolds, pseudo-Riemannian, second_fundamental_form

As reported in this [ask.sagemath question](https://ask.sagemath.org/question/47786), we have currently (Sage 8.8 and 8.9.beta9):

```
sage: P = Manifold(3, 'P', structure='Riemannian')
sage: Q = Manifold(2, 'Q', ambient=P, structure='Riemannian')
sage: CP.<x,y,z> = P.chart()
sage: CQ.<u,v> = Q.chart()
sage: g = P.metric()
sage: c = 2/(1 + y^2 + z^2)
sage: g[0,0], g[1,1], g[2,2] = 1, c^2, c^2
sage: phi = Q.diff_map(P, (u+v, u, v))
sage: phi_inv = P.diff_map(Q, (y, z))
sage: Q.set_embedding(phi, inverse=phi_inv)
sage: Q.second_fundamental_form()
TypeError: unable to convert 1/2*sqrt(2)*(u^4 + v^4 + 2*(u^2 + 1)*v^2 + 2*u^2 + 1)*y/
(sqrt(u^4 + v^4 + 2*(u^2 + 1)*v^2 + 2*u^2 + 3)*(y^2 + z^2 + 1)) 
+ 1/2*sqrt(2)*(u^4 + v^4 + 2*(u^2 + 1)*v^2 + 2*u^2 + 1)*z/
(sqrt(u^4 + v^4 + 2*(u^2 + 1)*v^2 + 2*u^2 + 3)*(y^2 + z^2 + 1)) 
to an integer
```

This results from the missing mention of the ring `SR` in the declaration of a matrix involved in the computation. 

The issue is fixed by this ticket.


---

Comment by egourgoulhon created at 2019-09-08 13:35:27

New commits:


---

Comment by egourgoulhon created at 2019-09-08 13:37:09

Changing status from new to needs_review.


---

Comment by @FlorentinJ created at 2019-09-08 14:03:52

I completely agree with the changes, but why was there no errors in the doctests ? The example in `second_fundamental_form` features a symbolic computation, and the result was not an integer.


---

Comment by egourgoulhon created at 2019-09-08 14:24:51

Replying to [comment:4 gh-FlorentinJ]:
> I completely agree with the changes, but why was there no errors in the doctests ? The example in `second_fundamental_form` features a symbolic computation, and the result was not an integer.

Actually, the error does not show off when the coefficients of the ambient connection are zero, since then `gamma_n` in line 1079 is filled with zeros, which is compatible with a matrix declared on the integers (the default, when the ring is not specified in `matrix()`). This is the case of the doctests.


---

Comment by @FlorentinJ created at 2019-09-08 14:34:20

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-09-08 14:52:48

Changing status from positive_review to needs_work.


---

Comment by egourgoulhon created at 2019-09-08 14:52:48

Argh, there is another issue: I wanted to add the following doctest to check that the original issue is solved:

```
            sage: M = Manifold(2, 'M', structure='Riemannian')
            sage: N = Manifold(1, 'N', ambient=M, structure='Riemannian',
            ....:              start_index=1)
            sage: CM.<x,y> = M.chart()
            sage: CN.<u> = N.chart()
            sage: g = M.metric()
            sage: g[0, 0], g[1, 1] = 1, 1/(1 + y^2)^2
            sage: phi = N.diff_map(M, (u, u))
            sage: N.set_embedding(phi)
            sage: N.second_fundamental_form()
            Field of symmetric bilinear forms K on the 1-dimensional Riemannian
             submanifold N embedded in the 2-dimensional Riemannian manifold M
            sage: N.second_fundamental_form().display()
            K = 2*sqrt(u^4 + 2*u^2 + 2)*(2*u*y^2 - (u^2 + 1)*y + 2*u)
               /(u^6 + 3*u^4 + (u^6 + 3*u^4 + 4*u^2 + 2)*y^2 + 4*u^2 + 2) du*du
```

As you can see, the expression of the component K_{uu} involves `y`, while it should be a function of `u` only. I guess this is because the expression of the ambient connection coefficients returned by `expr()` in line 1098 involves `(x,y)`; `x` and `y` should be expressed in terms of `u` via the embedding formulas before continuing the computation.


---

Comment by @FlorentinJ created at 2019-09-08 15:23:15

Replying to [comment:7 egourgoulhon]:
>`x` and `y` should be expressed in terms of `u` via the embedding formulas before continuing the >computation.  

So I guess `phi_inv` was really needed...


---

Comment by git created at 2019-09-08 15:37:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-09-08 15:42:11

Replying to [comment:8 gh-FlorentinJ]:
> Replying to [comment:7 egourgoulhon]:
> >`x` and `y` should be expressed in terms of `u` via the embedding formulas before continuing the >computation.  
> 
> So I guess `phi_inv` was really needed...

No it was not. It was only a matter of using `phi` to substitute `(x,y)` by their expressions in terms of `u`. This is done in the above commit. I've also added a simplification of the result by a call to `chart.simplify()`. I think that everything is fixed now.


---

Comment by egourgoulhon created at 2019-09-08 15:42:26

Changing status from needs_work to needs_review.


---

Comment by @FlorentinJ created at 2019-09-08 21:29:07

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-09-08 21:32:10

Thanks for the review!


---

Comment by vbraun created at 2019-09-10 23:01:33

Resolution: fixed
