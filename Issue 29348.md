# Issue 29348: More race conditions with Python package installations because of DESTDIR

archive/issues_029348.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @embray @kliem\n\nFollow-up from #26018:\n\nDeclaring some Python packages as PYTHON_TOOLCHAIN helped somewhat, but there are more race conditions with the same failure mechanism: Some Python package byte-compiles modules from a half-installed package, and then finishing the installation of that fails.\n\nOf course, the high parallelization in my automatic runs on [GitHub](GitHub) provoke these kinds of errors. But this should be fixed nevertheless.\n\nSee https://github.com/mkoeppe/sage/runs/618645992\n\n\n```\n  [backports_shutil_get_terminal_size-1.0.0.p1]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.py': File exists\n  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************\n  [backports_shutil_get_terminal_size-1.0.0.p1]   Error copying files for backports_shutil_get_terminal_size-1.0.0.p1.\n  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0] error installing, exit status 1. End of log file:\n  [backports_shutil_get_terminal_size-1.0.0.p1] Full log file: /sage/logs/pkgs/backports_shutil_get_terminal_size-1.0.0.p1.log\n\n\n  [backports_ssl_match_hostname-3.5.0.1.p0]   Copying package files from temporary location /sage/local/var/tmp/sage/build/backports_ssl_match_hostname-3.5.0.1.p0/inst to /sage/local\n  [backports_ssl_match_hostname-3.5.0.1.p0]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.pyc': File exists\n  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0]   Error copying files for backports_ssl_match_hostname-3.5.0.1.p0.\n  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29585\n\n",
    "created_at": "2020-04-26T02:48:42Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "More race conditions with Python package installations because of DESTDIR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29348",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @dimpase @embray @kliem

Follow-up from #26018:

Declaring some Python packages as PYTHON_TOOLCHAIN helped somewhat, but there are more race conditions with the same failure mechanism: Some Python package byte-compiles modules from a half-installed package, and then finishing the installation of that fails.

Of course, the high parallelization in my automatic runs on [GitHub](GitHub) provoke these kinds of errors. But this should be fixed nevertheless.

See https://github.com/mkoeppe/sage/runs/618645992


```
  [backports_shutil_get_terminal_size-1.0.0.p1]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.py': File exists
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_shutil_get_terminal_size-1.0.0.p1]   Error copying files for backports_shutil_get_terminal_size-1.0.0.p1.
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] error installing, exit status 1. End of log file:
  [backports_shutil_get_terminal_size-1.0.0.p1] Full log file: /sage/logs/pkgs/backports_shutil_get_terminal_size-1.0.0.p1.log


  [backports_ssl_match_hostname-3.5.0.1.p0]   Copying package files from temporary location /sage/local/var/tmp/sage/build/backports_ssl_match_hostname-3.5.0.1.p0/inst to /sage/local
  [backports_ssl_match_hostname-3.5.0.1.p0]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.pyc': File exists
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0]   Error copying files for backports_ssl_match_hostname-3.5.0.1.p0.
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log
```


Issue created by migration from https://trac.sagemath.org/ticket/29585





---

archive/issue_comments_415765.json:
```json
{
    "body": "Various fixes are possible here:\n- More dependencies need to be added\n- Copying from the staging dir needs to make Python package directory creation atomic (by copying to a temp name in the destination directory, followed by an (atomic) mv of the directory)\n- It should be checked if current versions of pip are safe for concurrent use so we don't have to reinvent the wheel",
    "created_at": "2020-04-26T19:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415765",
    "user": "https://github.com/mkoeppe"
}
```

Various fixes are possible here:
- More dependencies need to be added
- Copying from the staging dir needs to make Python package directory creation atomic (by copying to a temp name in the destination directory, followed by an (atomic) mv of the directory)
- It should be checked if current versions of pip are safe for concurrent use so we don't have to reinvent the wheel



---

archive/issue_comments_415766.json:
```json
{
    "body": "In general, I think that package installation can't be atomic, since we need to move things to SAGE_LOCAL/lib and SAGE_LOCAL/include, and we can't just create a directory temp/lib and move it to SAGE_LOCAL without overwriting the existing one. But maybe this could work with Python packages. Rewrite `sdh_pip_install`?",
    "created_at": "2020-04-26T20:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415766",
    "user": "https://github.com/jhpalmieri"
}
```

In general, I think that package installation can't be atomic, since we need to move things to SAGE_LOCAL/lib and SAGE_LOCAL/include, and we can't just create a directory temp/lib and move it to SAGE_LOCAL without overwriting the existing one. But maybe this could work with Python packages. Rewrite `sdh_pip_install`?



---

archive/issue_comments_415767.json:
```json
{
    "body": "Yes, I mean specifically for Python packages.",
    "created_at": "2020-04-26T20:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415767",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I mean specifically for Python packages.



---

archive/issue_comments_415768.json:
```json
{
    "body": "Replying to [comment:2 jhpalmieri]:\n> Rewrite `sdh_pip_install`?\n\nI think the copy-from-staging-dir code could just deal with the Python directories specially. We are working around another problem (lib64) with that code already anyway.\n\nThis would solve it even for Python packages that are not installed using pip currently (#29500).",
    "created_at": "2020-04-26T20:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415768",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 jhpalmieri]:
> Rewrite `sdh_pip_install`?

I think the copy-from-staging-dir code could just deal with the Python directories specially. We are working around another problem (lib64) with that code already anyway.

This would solve it even for Python packages that are not installed using pip currently (#29500).



---

archive/issue_comments_415769.json:
```json
{
    "body": "In fact (when `SAGE_SUDO` is unset), the whole code should actually recursively move, instead of copy, directories. This will be much faster too (the staged directory is already on the same filesystem)",
    "created_at": "2020-04-26T21:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415769",
    "user": "https://github.com/mkoeppe"
}
```

In fact (when `SAGE_SUDO` is unset), the whole code should actually recursively move, instead of copy, directories. This will be much faster too (the staged directory is already on the same filesystem)



---

archive/issue_comments_415770.json:
```json
{
    "body": "`mv` vs `cp` was discussed at #26011.\n\nSomething like the following (rough draft, untested)?\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 5cdd55db3f..0f8acf9b97 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -946,6 +946,12 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     # Generate installed file manifest\n     FILE_LIST=\"$(cd \"$PREFIX\" && find . -type f -o -type l | sed 's|^\\./||' | sort)\"\n \n+    if [ -d \"$PREFIX\"/lib/python*/site-packages/ ]; then\n+        echo \"This is a Python package: moving site-package directories atomically.\"\n+        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')\n+        $SAGE_SUDO mv \"$PREFIX\"/lib/python*/site-packages/* \"$SITE_PACKAGES\"\n+    fi\n+\n     # Copy files into $SAGE_LOCAL\n     $SAGE_SUDO cp -Rp \"$PREFIX/.\" \"$SAGE_LOCAL\"\n     if [ $? -ne 0 ]; then\n```\n",
    "created_at": "2020-04-26T21:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415770",
    "user": "https://github.com/jhpalmieri"
}
```

`mv` vs `cp` was discussed at #26011.

Something like the following (rough draft, untested)?

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 5cdd55db3f..0f8acf9b97 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -946,6 +946,12 @@ if [ -d "$SAGE_DESTDIR" ]; then
     # Generate installed file manifest
     FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
 
+    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
+        echo "This is a Python package: moving site-package directories atomically."
+        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
+        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
+    fi
+
     # Copy files into $SAGE_LOCAL
     $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
     if [ $? -ne 0 ]; then
```




---

archive/issue_comments_415771.json:
```json
{
    "body": "Replying to [comment:6 jhpalmieri]:\n> `mv` vs `cp` was discussed at #26011.\n\nThanks for the pointer. The `mv --recursive` that Erik is asking about in that thread, is exactly what would need to be implemented - best in Python (as also discussed in that thread).\n\n> Something like the following (rough draft, untested)?\n> {{{\n> #!diff\n> diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\n> index 5cdd55db3f..0f8acf9b97 100755\n> --- a/build/bin/sage-spkg\n> +++ b/build/bin/sage-spkg\n> `@``@` -946,6 +946,12 `@``@` if [ -d \"$SAGE_DESTDIR\" ]; then\n>      # Generate installed file manifest\n>      FILE_LIST=\"$(cd \"$PREFIX\" && find . -type f -o -type l | sed 's|^\\./||' | sort)\"\n>  \n> +    if [ -d \"$PREFIX\"/lib/python*/site-packages/ ]; then\n> +        echo \"This is a Python package: moving site-package directories atomically.\"\n> +        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')\n> +        $SAGE_SUDO mv \"$PREFIX\"/lib/python*/site-packages/* \"$SITE_PACKAGES\"\n> +    fi\n> +\n>      # Copy files into $SAGE_LOCAL\n>      $SAGE_SUDO cp -Rp \"$PREFIX/.\" \"$SAGE_LOCAL\"\n>      if [ $? -ne 0 ]; then\n> }}}\n\nThat could work, but I think I would prefer the more general solution.",
    "created_at": "2020-04-26T21:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415771",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 jhpalmieri]:
> `mv` vs `cp` was discussed at #26011.

Thanks for the pointer. The `mv --recursive` that Erik is asking about in that thread, is exactly what would need to be implemented - best in Python (as also discussed in that thread).

> Something like the following (rough draft, untested)?
> {{{
> #!diff
> diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
> index 5cdd55db3f..0f8acf9b97 100755
> --- a/build/bin/sage-spkg
> +++ b/build/bin/sage-spkg
> `@``@` -946,6 +946,12 `@``@` if [ -d "$SAGE_DESTDIR" ]; then
>      # Generate installed file manifest
>      FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
>  
> +    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
> +        echo "This is a Python package: moving site-package directories atomically."
> +        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
> +        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
> +    fi
> +
>      # Copy files into $SAGE_LOCAL
>      $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
>      if [ $? -ne 0 ]; then
> }}}

That could work, but I think I would prefer the more general solution.



---

archive/issue_comments_415772.json:
```json
{
    "body": "This could be done in some 20 lines of code I guess that would take care of getting the intended concurrency semantics right. Basically try to move a source directory to the target, handling EEXIST and in that case recursing instead.",
    "created_at": "2020-04-26T21:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415772",
    "user": "https://github.com/mkoeppe"
}
```

This could be done in some 20 lines of code I guess that would take care of getting the intended concurrency semantics right. Basically try to move a source directory to the target, handling EEXIST and in that case recursing instead.



---

archive/issue_comments_415773.json:
```json
{
    "body": "The new script would also \n- make sure that the permissions are correct (avoiding the problems with readonly files that we encountered in #29082); \n- handle the intended semantics of copying symlinks to directory over symlinks (as needed for `lib64`) and \n- issue warnings when concurrent writes to the same file (not directory) / writes to existing files are detected.",
    "created_at": "2020-04-26T22:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415773",
    "user": "https://github.com/mkoeppe"
}
```

The new script would also 
- make sure that the permissions are correct (avoiding the problems with readonly files that we encountered in #29082); 
- handle the intended semantics of copying symlinks to directory over symlinks (as needed for `lib64`) and 
- issue warnings when concurrent writes to the same file (not directory) / writes to existing files are detected.



---

archive/issue_comments_415774.json:
```json
{
    "body": "Reference: https://rcrowley.org/2010/01/06/things-unix-can-do-atomically.html",
    "created_at": "2020-04-27T19:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415774",
    "user": "https://github.com/mkoeppe"
}
```

Reference: https://rcrowley.org/2010/01/06/things-unix-can-do-atomically.html



---

archive/issue_comments_415775.json:
```json
{
    "body": "Ha, yes, I stumbled on that website, too.",
    "created_at": "2020-04-27T21:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415775",
    "user": "https://github.com/jhpalmieri"
}
```

Ha, yes, I stumbled on that website, too.



---

archive/issue_comments_415776.json:
```json
{
    "body": "I think this sort of issue was solved a long time ago with `sage-pip-install`, and its use of `sage-flock` to prevent pip installing more than one package simultaneously.\n\nUnfortunately, with the switch to the DESTDIR system, while this is probably still helpful, it doesn't help during copying of files into SAGE_LOCAL.\n\nPerhaps the pip-lock should also be held when copying packages into $SAGE_LOCAL (don't even bother checking if it's an actual Python package; just prevent copying anything into $SAGE_LOCAL without holding the pip-lock).",
    "created_at": "2020-08-31T16:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415776",
    "user": "https://github.com/embray"
}
```

I think this sort of issue was solved a long time ago with `sage-pip-install`, and its use of `sage-flock` to prevent pip installing more than one package simultaneously.

Unfortunately, with the switch to the DESTDIR system, while this is probably still helpful, it doesn't help during copying of files into SAGE_LOCAL.

Perhaps the pip-lock should also be held when copying packages into $SAGE_LOCAL (don't even bother checking if it's an actual Python package; just prevent copying anything into $SAGE_LOCAL without holding the pip-lock).



---

archive/issue_comments_415777.json:
```json
{
    "body": "In 9.3 I hope to switch installation of all Python packages from DESTDIR to use pip wheel - see #29500.",
    "created_at": "2020-08-31T16:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415777",
    "user": "https://github.com/mkoeppe"
}
```

In 9.3 I hope to switch installation of all Python packages from DESTDIR to use pip wheel - see #29500.



---

archive/issue_comments_415778.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415778",
    "user": "https://github.com/mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_415779.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415779",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_415780.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415780",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_415781.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-23T00:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415781",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415782.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-23T00:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415782",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_415783.json:
```json
{
    "body": "- It would be good to document `sdh_pip_uninstall`, both at the top of the file and in the developer's guide.\n\n- Unindent the block in `sage-spkg` starting on line 449? The block right after the comment \"Extract the package\" \u2014\u00a0you deleted the enclosing `if` and `fi` but left the block indented.\n\n- Typo: \"pacakges\" on line 538 of `sage-spkg`.\n\n- Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?\n\nThe changes make sense, but it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.",
    "created_at": "2021-07-08T01:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415783",
    "user": "https://github.com/jhpalmieri"
}
```

- It would be good to document `sdh_pip_uninstall`, both at the top of the file and in the developer's guide.

- Unindent the block in `sage-spkg` starting on line 449? The block right after the comment "Extract the package" — you deleted the enclosing `if` and `fi` but left the block indented.

- Typo: "pacakges" on line 538 of `sage-spkg`.

- Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

The changes make sense, but it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.



---

archive/issue_comments_415784.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-08T01:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415784",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415785.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-08T01:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415785",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415786.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> - Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?\n\nYes, exactly",
    "created_at": "2021-07-08T01:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415786",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 jhpalmieri]:
> - Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

Yes, exactly



---

archive/issue_comments_415787.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.\n\nBased on the failing runs that I have seen on GH Actions, I would estimate 1 in 30 to 1 in 200 runs fail...\n\nIn any case, there's another reason why we should make this change: Whenever a user uses `sage -pip install` to install any package, this can update various other Python packages as a side effect. So the installation records that the DESTDIR staging uses easily get out of sync with what's actually installed, making uninstallation by this method basically a gamble.",
    "created_at": "2021-07-08T01:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415787",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 jhpalmieri]:
> it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.

Based on the failing runs that I have seen on GH Actions, I would estimate 1 in 30 to 1 in 200 runs fail...

In any case, there's another reason why we should make this change: Whenever a user uses `sage -pip install` to install any package, this can update various other Python packages as a side effect. So the installation records that the DESTDIR staging uses easily get out of sync with what's actually installed, making uninstallation by this method basically a gamble.



---

archive/issue_comments_415788.json:
```json
{
    "body": "Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):\n\n```\nUninstalling existing 'numpy'\nRunning pip-uninstall script for 'numpy'\nWARNING: Skipping numpy as it is not installed.\nRemoving stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'\n```\n\nFor this ticket: if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?\n\nI also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior? Maybe I don't understand your last post about how uninstallation is supposed to work.",
    "created_at": "2021-07-08T02:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415788",
    "user": "https://github.com/jhpalmieri"
}
```

Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):

```
Uninstalling existing 'numpy'
Running pip-uninstall script for 'numpy'
WARNING: Skipping numpy as it is not installed.
Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
```

For this ticket: if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior? Maybe I don't understand your last post about how uninstallation is supposed to work.



---

archive/issue_comments_415789.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior?\n\n`jupyterlab_widgets` and `nodejs` are script packages; we keep track of their installation by creating an empty stamp file in `...installed`.  The present ticket makes no changes to script packages.  There is no uninstallation procedure for script packages at all - only the stamp file is removed. (Only `sagelib-clean` and `sage_docbuild-clean` are defined directly in `build/make/Makefile.in`.)\n\n`jupyterlab` is a pip package; we do not keep installation records for them. The present ticket makes no changes to pip packages either.  Uninstallation is done using `sage --pip uninstall` (invoked by the makefile).",
    "created_at": "2021-07-08T03:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415789",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:32 jhpalmieri]:
> I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior?

`jupyterlab_widgets` and `nodejs` are script packages; we keep track of their installation by creating an empty stamp file in `...installed`.  The present ticket makes no changes to script packages.  There is no uninstallation procedure for script packages at all - only the stamp file is removed. (Only `sagelib-clean` and `sage_docbuild-clean` are defined directly in `build/make/Makefile.in`.)

`jupyterlab` is a pip package; we do not keep installation records for them. The present ticket makes no changes to pip packages either.  Uninstallation is done using `sage --pip uninstall` (invoked by the makefile).



---

archive/issue_comments_415790.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?\n\nNo, I don't think so. Neither our current build system (before the present ticket) nor `pip` do this. \n\n(Reinstallation of packages depending on `numpy` is instead triggered by a reinstallation of `numpy`.)",
    "created_at": "2021-07-08T04:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415790",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:32 jhpalmieri]:
> if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

No, I don't think so. Neither our current build system (before the present ticket) nor `pip` do this. 

(Reinstallation of packages depending on `numpy` is instead triggered by a reinstallation of `numpy`.)



---

archive/issue_comments_415791.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):\n> {{{\n> Uninstalling existing 'numpy'\n> Running pip-uninstall script for 'numpy'\n> WARNING: Skipping numpy as it is not installed.\n> Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'\n> }}}\nI think this warning will only show up if you switch between branches with and without this ticket.",
    "created_at": "2021-07-08T04:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415791",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:32 jhpalmieri]:
> Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):
> {{{
> Uninstalling existing 'numpy'
> Running pip-uninstall script for 'numpy'
> WARNING: Skipping numpy as it is not installed.
> Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
> }}}
I think this warning will only show up if you switch between branches with and without this ticket.



---

archive/issue_comments_415792.json:
```json
{
    "body": "Is `pip` better at atomic actions?",
    "created_at": "2021-07-13T03:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415792",
    "user": "https://github.com/jhpalmieri"
}
```

Is `pip` better at atomic actions?



---

archive/issue_comments_415793.json:
```json
{
    "body": "Replying to [comment:36 jhpalmieri]:\n> Is `pip` better at atomic actions?\nI don't know, but we do not depend on it to be because we are holding a lock while installing a wheel, in `build/bin/sage-pip-install`. This was added in #21672.",
    "created_at": "2021-07-13T03:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415793",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:36 jhpalmieri]:
> Is `pip` better at atomic actions?
I don't know, but we do not depend on it to be because we are holding a lock while installing a wheel, in `build/bin/sage-pip-install`. This was added in #21672.



---

archive/issue_comments_415794.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-13T04:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415794",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_415795.json:
```json
{
    "body": "Okay, let's merge it so it gets more testing.",
    "created_at": "2021-07-13T04:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415795",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, let's merge it so it gets more testing.



---

archive/issue_comments_415796.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-07-13T04:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415796",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_events_027116.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2021-07-23T20:11:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29348#event-27116"
}
```



---

archive/issue_comments_415797.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415797",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_415798.json:
```json
{
    "body": "A crucial commit was missing on this branch. Follow-up in #32361.",
    "created_at": "2021-08-10T18:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415798",
    "user": "https://github.com/mkoeppe"
}
```

A crucial commit was missing on this branch. Follow-up in #32361.



---

archive/issue_comments_415799.json:
```json
{
    "body": "I'm at peace with this solution :)",
    "created_at": "2021-08-18T16:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29348#issuecomment-415799",
    "user": "https://github.com/embray"
}
```

I'm at peace with this solution :)
