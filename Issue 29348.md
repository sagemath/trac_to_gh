# Issue 29348: More race conditions with Python package installations because of DESTDIR

Issue created by migration from https://trac.sagemath.org/ticket/29585

Original creator: mkoeppe

Original creation time: 2020-04-26 02:48:42

CC:  jhpalmieri dimpase embray @kliem

Follow-up from #26018:

Declaring some Python packages as PYTHON_TOOLCHAIN helped somewhat, but there are more race conditions with the same failure mechanism: Some Python package byte-compiles modules from a half-installed package, and then finishing the installation of that fails.

Of course, the high parallelization in my automatic runs on [GitHub](GitHub) provoke these kinds of errors. But this should be fixed nevertheless.

See https://github.com/mkoeppe/sage/runs/618645992


```
  [backports_shutil_get_terminal_size-1.0.0.p1]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.py': File exists
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_shutil_get_terminal_size-1.0.0.p1]   Error copying files for backports_shutil_get_terminal_size-1.0.0.p1.
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] error installing, exit status 1. End of log file:
  [backports_shutil_get_terminal_size-1.0.0.p1] Full log file: /sage/logs/pkgs/backports_shutil_get_terminal_size-1.0.0.p1.log


  [backports_ssl_match_hostname-3.5.0.1.p0]   Copying package files from temporary location /sage/local/var/tmp/sage/build/backports_ssl_match_hostname-3.5.0.1.p0/inst to /sage/local
  [backports_ssl_match_hostname-3.5.0.1.p0]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.pyc': File exists
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0]   Error copying files for backports_ssl_match_hostname-3.5.0.1.p0.
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log
```



---

Comment by mkoeppe created at 2020-04-26 19:01:05

Various fixes are possible here:
- More dependencies need to be added
- Copying from the staging dir needs to make Python package directory creation atomic (by copying to a temp name in the destination directory, followed by an (atomic) mv of the directory)
- It should be checked if current versions of pip are safe for concurrent use so we don't have to reinvent the wheel


---

Comment by jhpalmieri created at 2020-04-26 20:22:16

In general, I think that package installation can't be atomic, since we need to move things to SAGE_LOCAL/lib and SAGE_LOCAL/include, and we can't just create a directory temp/lib and move it to SAGE_LOCAL without overwriting the existing one. But maybe this could work with Python packages. Rewrite `sdh_pip_install`?


---

Comment by mkoeppe created at 2020-04-26 20:23:55

Yes, I mean specifically for Python packages.


---

Comment by mkoeppe created at 2020-04-26 20:39:43

Replying to [comment:2 jhpalmieri]:
> Rewrite `sdh_pip_install`?

I think the copy-from-staging-dir code could just deal with the Python directories specially. We are working around another problem (lib64) with that code already anyway.

This would solve it even for Python packages that are not installed using pip currently (#29500).


---

Comment by mkoeppe created at 2020-04-26 21:35:17

In fact (when `SAGE_SUDO` is unset), the whole code should actually recursively move, instead of copy, directories. This will be much faster too (the staged directory is already on the same filesystem)


---

Comment by jhpalmieri created at 2020-04-26 21:40:12

`mv` vs `cp` was discussed at #26011.

Something like the following (rough draft, untested)?

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 5cdd55db3f..0f8acf9b97 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -946,6 +946,12 @@ if [ -d "$SAGE_DESTDIR" ]; then
     # Generate installed file manifest
     FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
 
+    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
+        echo "This is a Python package: moving site-package directories atomically."
+        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
+        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
+    fi
+
     # Copy files into $SAGE_LOCAL
     $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
     if [ $? -ne 0 ]; then
```



---

Comment by mkoeppe created at 2020-04-26 21:50:37

Replying to [comment:6 jhpalmieri]:
> `mv` vs `cp` was discussed at #26011.

Thanks for the pointer. The `mv --recursive` that Erik is asking about in that thread, is exactly what would need to be implemented - best in Python (as also discussed in that thread).

> Something like the following (rough draft, untested)?
> {{{
> #!diff
> diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
> index 5cdd55db3f..0f8acf9b97 100755
> --- a/build/bin/sage-spkg
> +++ b/build/bin/sage-spkg
> `@``@` -946,6 +946,12 `@``@` if [ -d "$SAGE_DESTDIR" ]; then
>      # Generate installed file manifest
>      FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
>  
> +    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
> +        echo "This is a Python package: moving site-package directories atomically."
> +        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
> +        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
> +    fi
> +
>      # Copy files into $SAGE_LOCAL
>      $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
>      if [ $? -ne 0 ]; then
> }}}

That could work, but I think I would prefer the more general solution.


---

Comment by mkoeppe created at 2020-04-26 21:55:35

This could be done in some 20 lines of code I guess that would take care of getting the intended concurrency semantics right. Basically try to move a source directory to the target, handling EEXIST and in that case recursing instead.


---

Comment by mkoeppe created at 2020-04-26 22:22:19

The new script would also 
- make sure that the permissions are correct (avoiding the problems with readonly files that we encountered in #29082); 
- handle the intended semantics of copying symlinks to directory over symlinks (as needed for `lib64`) and 
- issue warnings when concurrent writes to the same file (not directory) / writes to existing files are detected.


---

Comment by mkoeppe created at 2020-04-27 19:53:26

Reference: https://rcrowley.org/2010/01/06/things-unix-can-do-atomically.html


---

Comment by jhpalmieri created at 2020-04-27 21:01:33

Ha, yes, I stumbled on that website, too.


---

Comment by embray created at 2020-08-31 16:23:32

I think this sort of issue was solved a long time ago with `sage-pip-install`, and its use of `sage-flock` to prevent pip installing more than one package simultaneously.

Unfortunately, with the switch to the DESTDIR system, while this is probably still helpful, it doesn't help during copying of files into SAGE_LOCAL.

Perhaps the pip-lock should also be held when copying packages into $SAGE_LOCAL (don't even bother checking if it's an actual Python package; just prevent copying anything into $SAGE_LOCAL without holding the pip-lock).


---

Comment by mkoeppe created at 2020-08-31 16:45:01

In 9.3 I hope to switch installation of all Python packages from DESTDIR to use pip wheel - see #29500.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-06-23 00:04:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-23 00:25:24

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-07-08 01:03:14

- It would be good to document `sdh_pip_uninstall`, both at the top of the file and in the developer's guide.

- Unindent the block in `sage-spkg` starting on line 449? The block right after the comment "Extract the package" — you deleted the enclosing `if` and `fi` but left the block indented.

- Typo: "pacakges" on line 538 of `sage-spkg`.

- Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

The changes make sense, but it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.


---

Comment by git created at 2021-07-08 01:15:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 01:17:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-08 01:18:00

Replying to [comment:27 jhpalmieri]:
> - Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

Yes, exactly


---

Comment by mkoeppe created at 2021-07-08 01:23:21

Replying to [comment:27 jhpalmieri]:
> it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.

Based on the failing runs that I have seen on GH Actions, I would estimate 1 in 30 to 1 in 200 runs fail...

In any case, there's another reason why we should make this change: Whenever a user uses `sage -pip install` to install any package, this can update various other Python packages as a side effect. So the installation records that the DESTDIR staging uses easily get out of sync with what's actually installed, making uninstallation by this method basically a gamble.


---

Comment by jhpalmieri created at 2021-07-08 02:54:08

Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):

```
Uninstalling existing 'numpy'
Running pip-uninstall script for 'numpy'
WARNING: Skipping numpy as it is not installed.
Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
```

For this ticket: if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior? Maybe I don't understand your last post about how uninstallation is supposed to work.


---

Comment by mkoeppe created at 2021-07-08 03:59:45

Replying to [comment:32 jhpalmieri]:
> I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior?

`jupyterlab_widgets` and `nodejs` are script packages; we keep track of their installation by creating an empty stamp file in `...installed`.  The present ticket makes no changes to script packages.  There is no uninstallation procedure for script packages at all - only the stamp file is removed. (Only `sagelib-clean` and `sage_docbuild-clean` are defined directly in `build/make/Makefile.in`.)

`jupyterlab` is a pip package; we do not keep installation records for them. The present ticket makes no changes to pip packages either.  Uninstallation is done using `sage --pip uninstall` (invoked by the makefile).


---

Comment by mkoeppe created at 2021-07-08 04:01:59

Replying to [comment:32 jhpalmieri]:
> if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

No, I don't think so. Neither our current build system (before the present ticket) nor `pip` do this. 

(Reinstallation of packages depending on `numpy` is instead triggered by a reinstallation of `numpy`.)


---

Comment by mkoeppe created at 2021-07-08 04:22:26

Replying to [comment:32 jhpalmieri]:
> Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):
> {{{
> Uninstalling existing 'numpy'
> Running pip-uninstall script for 'numpy'
> WARNING: Skipping numpy as it is not installed.
> Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
> }}}
I think this warning will only show up if you switch between branches with and without this ticket.


---

Comment by jhpalmieri created at 2021-07-13 03:04:03

Is `pip` better at atomic actions?


---

Comment by mkoeppe created at 2021-07-13 03:28:13

Replying to [comment:36 jhpalmieri]:
> Is `pip` better at atomic actions?
I don't know, but we do not depend on it to be because we are holding a lock while installing a wheel, in `build/bin/sage-pip-install`. This was added in #21672.


---

Comment by jhpalmieri created at 2021-07-13 04:09:53

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-07-13 04:09:53

Okay, let's merge it so it gets more testing.


---

Comment by mkoeppe created at 2021-07-13 04:11:19

Thanks!


---

Comment by vbraun created at 2021-07-23 20:11:56

Resolution: fixed


---

Comment by mkoeppe created at 2021-08-10 18:47:09

A crucial commit was missing on this branch. Follow-up in #32361.


---

Comment by embray created at 2021-08-18 16:56:56

I'm at peace with this solution :)
