# Issue 29719: Bug in KlyachkoBundle_class.random_deformation

Issue created by migration from https://trac.sagemath.org/ticket/29956

Original creator: @kliem

Original creation time: 2020-06-24 13:47:33

CC:  vbraun

Keywords: CPR-Fano toric variety

The doctest in `src/sage/schemes/toric/sheaf/klyachko.py` does produce an error on some random seeds:


```
sage: set_random_seed(151058820726654196682836430928254760259)
sage: P1 = toric_varieties.P1()
sage: H = P1.divisor(0)
sage: V = P1.sheaves.line_bundle(H) + P1.sheaves.line_bundle(-H)
sage: V.cohomology(dim=True, weight=(0,))
(1, 0)
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
sage: Vtilde = V.random_deformation()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-12-3095c5f6f78e> in <module>()
----> 1 Vtilde = V.random_deformation()

/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/schemes/toric/sheaf/klyachko.py in random_deformation(self, epsilon)
    953         """
    954         filt = self._filt.random_deformation(epsilon)
--> 955         return self.__class__(self.variety(), filt, check=True)

/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/schemes/toric/sheaf/klyachko.py in __init__(self, toric_variety, multi_filtration, check)
    176                              ' all rays of the fan.')
    177         if not multi_filtration.is_exhaustive():
--> 178             raise ValueError('multi-filtration must be exhaustive')
    179         if not multi_filtration.is_separating():
    180             raise ValueError('multi-filtration must be separating')

ValueError: multi-filtration must be exhaustive
```



---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by @sheerluck created at 2021-09-23 08:23:01


```diff
diff --git a/src/sage/schemes/toric/sheaf/klyachko.py b/src/sage/schemes/toric/sheaf/klyachko.py
index 1ed3ac290b..32821e6d06 100644
--- a/src/sage/schemes/toric/sheaf/klyachko.py
+++ b/src/sage/schemes/toric/sheaf/klyachko.py
@@ -952,4 +952,6 @@ class KlyachkoBundle_class(SageObject):
            (1, 0)
         """
         filt = self._filt.random_deformation(epsilon)
+        while not filt.is_exhaustive():
+            filt = self._filt.random_deformation(epsilon)
         return self.__class__(self.variety(), filt, check=True)
```



---

Comment by @kliem created at 2021-09-30 18:22:18

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-09-30 18:22:18

New commits:


---

Comment by @kliem created at 2021-10-01 06:29:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-09 11:10:21

Resolution: fixed
