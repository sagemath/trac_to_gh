# Issue 29619: sort out linking with libstd++

archive/issues_029619.json:
```json
{
    "body": "CC:  @antonio-rojas @mkoeppe @kiwifb @isuruf\n\nit appears it might be not needed any more.\n\n(currently mentioned in src/setup.py\nand in src/sage/misc/cython.py)\n\nIssue created by migration from https://trac.sagemath.org/ticket/29856\n\n",
    "created_at": "2020-06-14T09:29:02Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "sort out linking with libstd++",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29619",
    "user": "https://github.com/dimpase"
}
```
CC:  @antonio-rojas @mkoeppe @kiwifb @isuruf

it appears it might be not needed any more.

(currently mentioned in src/setup.py
and in src/sage/misc/cython.py)

Issue created by migration from https://trac.sagemath.org/ticket/29856





---

archive/issue_comments_420177.json:
```json
{
    "body": "trying to see what happens with the simple\n\n```diff\nindex af5f99d03e..0600603e62 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -41,7 +41,7 @@ cblas_library_dirs = list(cblas_pc['library_dirs'])\n cblas_include_dirs = list(cblas_pc['include_dirs'])\n \n standard_libs = [\n-    'mpfr', 'gmp', 'gmpxx', 'stdc++', 'pari', 'm',\n+    'mpfr', 'gmp', 'gmpxx', 'pari', 'm',\n     'ec', 'gsl',\n ] + cblas_libs + [\n     'ntl']\n--- a/src/setup.py\n+++ b/src/setup.py\n@@ -354,8 +354,6 @@ class sage_build_cython(Command):\n \n         - Add dependencies on header files for certain libraries\n \n-        - Ensure that C++ extensions link with -lstdc++\n-\n         - Sort the libraries according to the library order\n \n         - Add some default compile/link args and directories\n@@ -369,10 +367,7 @@ class sage_build_cython(Command):\n         lang = kwds.get('language', 'c')\n         cplusplus = (lang == \"c++\")\n \n-        # Libraries: add stdc++ if needed and sort them\n         libs = kwds.get('libraries', [])\n-        if cplusplus:\n-            libs = libs + ['stdc++']\n         kwds['libraries'] = sorted(set(libs),\n                 key=lambda lib: library_order.get(lib, 0))",
    "created_at": "2020-06-14T09:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420177",
    "user": "https://github.com/dimpase"
}
```

trying to see what happens with the simple

```diff
index af5f99d03e..0600603e62 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -41,7 +41,7 @@ cblas_library_dirs = list(cblas_pc['library_dirs'])
 cblas_include_dirs = list(cblas_pc['include_dirs'])
 
 standard_libs = [
-    'mpfr', 'gmp', 'gmpxx', 'stdc++', 'pari', 'm',
+    'mpfr', 'gmp', 'gmpxx', 'pari', 'm',
     'ec', 'gsl',
 ] + cblas_libs + [
     'ntl']
--- a/src/setup.py
+++ b/src/setup.py
@@ -354,8 +354,6 @@ class sage_build_cython(Command):
 
         - Add dependencies on header files for certain libraries
 
-        - Ensure that C++ extensions link with -lstdc++
-
         - Sort the libraries according to the library order
 
         - Add some default compile/link args and directories
@@ -369,10 +367,7 @@ class sage_build_cython(Command):
         lang = kwds.get('language', 'c')
         cplusplus = (lang == "c++")
 
-        # Libraries: add stdc++ if needed and sort them
         libs = kwds.get('libraries', [])
-        if cplusplus:
-            libs = libs + ['stdc++']
         kwds['libraries'] = sorted(set(libs),
                 key=lambda lib: library_order.get(lib, 0))



---

archive/issue_comments_420178.json:
```json
{
    "body": "This ticket description needs some work; what problem is this ticket addressing?\n\nAlso, `setup.py` does not use `sage.misc.cython` at all if I'm not mistaken.\n\nAnd please note #29702 moves the code from `src/setup.py` to `sage_setup` - best to do changes on top of that",
    "created_at": "2020-06-14T12:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420178",
    "user": "https://github.com/mkoeppe"
}
```

This ticket description needs some work; what problem is this ticket addressing?

Also, `setup.py` does not use `sage.misc.cython` at all if I'm not mistaken.

And please note #29702 moves the code from `src/setup.py` to `sage_setup` - best to do changes on top of that



---

archive/issue_comments_420179.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-15T15:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420179",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_420180.json:
```json
{
    "body": "seems to work.\n----\nLast 10 new commits:",
    "created_at": "2020-06-15T15:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420180",
    "user": "https://github.com/dimpase"
}
```

seems to work.
----
Last 10 new commits:



---

archive/issue_comments_420181.json:
```json
{
    "body": "tested on GH Actions?",
    "created_at": "2020-06-15T15:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420181",
    "user": "https://github.com/mkoeppe"
}
```

tested on GH Actions?



---

archive/issue_comments_420182.json:
```json
{
    "body": "Please rebase on unrebased-then-merged #29702",
    "created_at": "2020-06-15T16:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420182",
    "user": "https://github.com/mkoeppe"
}
```

Please rebase on unrebased-then-merged #29702



---

archive/issue_comments_420183.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-06-15T20:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420183",
    "user": "https://github.com/dimpase"
}
```

Last 10 new commits:



---

archive/issue_comments_420184.json:
```json
{
    "body": "testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)",
    "created_at": "2020-06-15T20:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420184",
    "user": "https://github.com/dimpase"
}
```

testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)



---

archive/issue_comments_420185.json:
```json
{
    "body": "Great",
    "created_at": "2020-06-15T22:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420185",
    "user": "https://github.com/mkoeppe"
}
```

Great



---

archive/issue_comments_420186.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)\n\nI see a lot of assembler errors (GNU 'as' version 2.24, ~6 years old)\nin building ecm, and elsewhere, on minimal ubuntu-trusty\n\n```\n2020-06-16T00:41:24.9539407Z   [ecm-7.0.4.p1]   /tmp/ccEhz4KE.s:342: Error: operand size mismatch for `vmovdqu64'\n```\n\n\nsee https://github.com/dimpase/sage/runs/774196885\n\nNot a surprise, as we build a newish gcc, not really compatible with an old `as`, running on hardware not 100% supported by this `as`. Should we just drop this target all together?",
    "created_at": "2020-06-16T13:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420186",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:10 dimpase]:
> testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)

I see a lot of assembler errors (GNU 'as' version 2.24, ~6 years old)
in building ecm, and elsewhere, on minimal ubuntu-trusty

```
2020-06-16T00:41:24.9539407Z   [ecm-7.0.4.p1]   /tmp/ccEhz4KE.s:342: Error: operand size mismatch for `vmovdqu64'
```


see https://github.com/dimpase/sage/runs/774196885

Not a surprise, as we build a newish gcc, not really compatible with an old `as`, running on hardware not 100% supported by this `as`. Should we just drop this target all together?



---

archive/issue_comments_420187.json:
```json
{
    "body": "On ubunty-bionic standard I see\n\n```\n2020-06-16T01:19:21.1467385Z   [dochtml]   ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.26' not found (required by /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_integer_sparse.cpython-37m-x86_64-linux-gnu.so)\n```\n\nwhich looks like a broken toolchain (`GLIBCXX_3.4.26' not found) - any idea why?\n\nsee https://github.com/dimpase/sage/runs/774196977\n\nThe rest looks OK to me.",
    "created_at": "2020-06-16T13:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420187",
    "user": "https://github.com/dimpase"
}
```

On ubunty-bionic standard I see

```
2020-06-16T01:19:21.1467385Z   [dochtml]   ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.26' not found (required by /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_integer_sparse.cpython-37m-x86_64-linux-gnu.so)
```

which looks like a broken toolchain (`GLIBCXX_3.4.26' not found) - any idea why?

see https://github.com/dimpase/sage/runs/774196977

The rest looks OK to me.



---

archive/issue_comments_420188.json:
```json
{
    "body": "The above two, are these from `-gcc_spkg` builds? Please add links to the runs",
    "created_at": "2020-06-16T14:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420188",
    "user": "https://github.com/mkoeppe"
}
```

The above two, are these from `-gcc_spkg` builds? Please add links to the runs



---

archive/issue_comments_420189.json:
```json
{
    "body": "(See #29675 for known failures of `-gcc_spkg` builds with \"GLIBCXX not found\" errors.)",
    "created_at": "2020-06-16T14:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420189",
    "user": "https://github.com/mkoeppe"
}
```

(See #29675 for known failures of `-gcc_spkg` builds with "GLIBCXX not found" errors.)



---

archive/issue_comments_420190.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> The above two, are these from `-gcc_spkg` builds? Please add links to the runs\n\ndone",
    "created_at": "2020-06-16T14:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420190",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:14 mkoeppe]:
> The above two, are these from `-gcc_spkg` builds? Please add links to the runs

done



---

archive/issue_comments_420191.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-17T06:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420191",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_420192.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-02T21:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29619",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29619#issuecomment-420192",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
