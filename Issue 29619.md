# Issue 29619: sort out linking with libstd++

Issue created by migration from https://trac.sagemath.org/ticket/29856

Original creator: dimpase

Original creation time: 2020-06-14 09:29:02

CC:  arojas mkoeppe fbissey isuruf

it appears it might be not needed any more.

(currently mentioned in src/setup.py
and in src/sage/misc/cython.py)


---

Comment by dimpase created at 2020-06-14 09:31:02

trying to see what happens with the simple

```diff
index af5f99d03e..0600603e62 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -41,7 +41,7 @@ cblas_library_dirs = list(cblas_pc['library_dirs'])
 cblas_include_dirs = list(cblas_pc['include_dirs'])
 
 standard_libs = [
-    'mpfr', 'gmp', 'gmpxx', 'stdc++', 'pari', 'm',
+    'mpfr', 'gmp', 'gmpxx', 'pari', 'm',
     'ec', 'gsl',
 ] + cblas_libs + [
     'ntl']
--- a/src/setup.py
+++ b/src/setup.py
@@ -354,8 +354,6 @@ class sage_build_cython(Command):
 
         - Add dependencies on header files for certain libraries
 
-        - Ensure that C++ extensions link with -lstdc++
-
         - Sort the libraries according to the library order
 
         - Add some default compile/link args and directories
@@ -369,10 +367,7 @@ class sage_build_cython(Command):
         lang = kwds.get('language', 'c')
         cplusplus = (lang == "c++")
 
-        # Libraries: add stdc++ if needed and sort them
         libs = kwds.get('libraries', [])
-        if cplusplus:
-            libs = libs + ['stdc++']
         kwds['libraries'] = sorted(set(libs),
                 key=lambda lib: library_order.get(lib, 0))


---

Comment by mkoeppe created at 2020-06-14 12:28:05

This ticket description needs some work; what problem is this ticket addressing?

Also, `setup.py` does not use `sage.misc.cython` at all if I'm not mistaken.

And please note #29702 moves the code from `src/setup.py` to `sage_setup` - best to do changes on top of that


---

Comment by dimpase created at 2020-06-15 15:56:39

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-06-15 15:56:39

seems to work.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-15 15:59:23

tested on GH Actions?


---

Comment by mkoeppe created at 2020-06-15 16:25:38

Please rebase on unrebased-then-merged #29702


---

Comment by dimpase created at 2020-06-15 20:38:50

Last 10 new commits:


---

Comment by dimpase created at 2020-06-15 20:44:40

testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)


---

Comment by mkoeppe created at 2020-06-15 22:35:01

Great


---

Comment by dimpase created at 2020-06-16 13:44:16

Replying to [comment:10 dimpase]:
> testing on https://github.com/dimpase/sage/pull/10 (also, this will test #29702)

I see a lot of assembler errors (GNU 'as' version 2.24, ~6 years old)
in building ecm, and elsewhere, on minimal ubuntu-trusty

```
2020-06-16T00:41:24.9539407Z   [ecm-7.0.4.p1]   /tmp/ccEhz4KE.s:342: Error: operand size mismatch for `vmovdqu64'
```


see https://github.com/dimpase/sage/runs/774196885

Not a surprise, as we build a newish gcc, not really compatible with an old `as`, running on hardware not 100% supported by this `as`. Should we just drop this target all together?


---

Comment by dimpase created at 2020-06-16 13:53:59

On ubunty-bionic standard I see

```
2020-06-16T01:19:21.1467385Z   [dochtml]   ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.26' not found (required by /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_integer_sparse.cpython-37m-x86_64-linux-gnu.so)
```

which looks like a broken toolchain (`GLIBCXX_3.4.26' not found) - any idea why?

see https://github.com/dimpase/sage/runs/774196977

The rest looks OK to me.


---

Comment by mkoeppe created at 2020-06-16 14:11:57

The above two, are these from `-gcc_spkg` builds? Please add links to the runs


---

Comment by mkoeppe created at 2020-06-16 14:13:15

(See #29675 for known failures of `-gcc_spkg` builds with "GLIBCXX not found" errors.)


---

Comment by dimpase created at 2020-06-16 14:41:24

Replying to [comment:14 mkoeppe]:
> The above two, are these from `-gcc_spkg` builds? Please add links to the runs

done


---

Comment by mkoeppe created at 2020-06-17 06:14:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-02 21:30:16

Resolution: fixed
