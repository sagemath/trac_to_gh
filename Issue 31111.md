# Issue 31111: build/pkgs/mpir/spkg-configure.m4: Check pkg-config first

Issue created by migration from https://trac.sagemath.org/ticket/31348

Original creator: mkoeppe

Original creation time: 2021-02-06 02:40:02

CC:  dimpase jhpalmieri @zlscherr mjo

Currently `gmp.pc`, which may be provided at least on some platforms, is not used at all -- neither by `configure` nor by `sage.env.cython_aliases`, `sage.misc.cython`.

For example, on homebrew, using it will provide the specific library search directory `-L/usr/local/Cellar/gmp/6.2.1/lib` instead of having to rely on `/usr/local/` (which is disabled when compiler/linker are invoked with `-isysroot`)

The failure reported in #31335#comment:47 only `sage.misc.cython` to pick up `gmp.pc` - but to avoid unpleasant surprises, we need to make sure that it is used consistently when present.

previous tickets: #27212


---

Comment by @zlscherr created at 2021-02-09 02:14:05

I started to play around with this a bit, and I can use python’s pkgconfig to locate gmp and mpfr.  After doing that though, I get complaints about not being able to locagte -lntl, which I don’t think I can find with pkgconfig since it doesn’t have an ntl.pc file.

This may be a bit too hacky, but would it be possible in the build process to copy the various includes and libraries to SAGE_LOCAL/{include, lib} that are picked up by configure? That seems like it would solve a whole host of problems at the expense of if the user updates one of those libraries then the new version would not be picked up.


---

Comment by mkoeppe created at 2021-02-09 02:51:21

Replying to [comment:4 gh-zlscherr]:
> I started to play around with this a bit, and I can use python’s pkgconfig to locate gmp and mpfr.  After doing that though, I get complaints about not being able to locagte -lntl, which I don’t think I can find with pkgconfig since it doesn’t have an ntl.pc file.

For NTL, the configure script already determines `SAGE_NTL_PREFIX`.
This variable just needs to be used more.


---

Comment by mkoeppe created at 2021-02-09 02:57:10

I've opened #31365 for NTL.


---

Comment by git created at 2021-04-07 21:00:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @zlscherr created at 2021-04-07 21:03:51

I pushed very simple code for trying to deal with this.  It's probably better to use regular expressions, but I just wanted a proof of concept.  This allows make ptest to work with homebrew without having to source .homebrew-build-env.


---

Comment by roed created at 2021-04-26 05:31:02

I've started getting [failures](https://math.mit.edu/~roed/31348.log) that are fixed by sourcing `.homebrew-build-env` even when I'm just changing Cython files and recompiling (not changing any spkgs).  Is this expected?


---

Comment by mkoeppe created at 2021-04-26 17:17:35

Yes, this is part of what this ticket intends to fix.


---

Comment by roed created at 2021-04-26 18:00:27

Great, thanks for the clarification!


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by dimpase created at 2021-09-23 15:57:22

some distros, like Fedora, have an unpleasant habit of not installing .pc files, while these are available.


---

Comment by mkoeppe created at 2021-09-23 15:59:22

Yes, the ticket is "Check pkg-config first", not "Check pkg-config only".


---

Comment by mjo created at 2021-09-23 17:00:16

IMO homebrew (and anyone else installing libgmp to a nonstandard directory) should be pestered to install it to the system's default location. I'm pretty sure that the gmp and mpir packages then conflict, but you don't need to install them both at the same time. In fact, mpir can probably be deprecated.

Using pkg-config just changes this potential problem (libraries in wrong locations) to another one (pc files in wrong locations) and adds an extra layer of indirection in the process. We may have to go ahead and fix it anyway, but we shouldn't lose track of the simple and easy way that this was all meant to work.


---

Comment by mkoeppe created at 2021-09-23 17:13:48

The problem on homebrew is really a very specific one, which I have explained in the ticket description: The GMP headers *are* installed in what you would call the "standard location" (`/usr/local/`), but when compiler/linker are invoked with `-isysroot`, then `/usr/local` is not a standard location. Yes, we fix it in the *build* environment using `.homebrew-build-env` but that does not affect the compiler use in the *runtime* environment.


---

Comment by dimpase created at 2021-09-23 18:27:40

Replying to [comment:21 mjo]:
> IMO homebrew (and anyone else installing libgmp to a nonstandard directory) should be pestered to install it to the system's default location. I'm pretty sure that the gmp and mpir packages then conflict, but you don't need to install them both at the same time. In fact, mpir can probably be deprecated.

No, brew does not install mpir in gmp-compatible mode, as far as
I can tell from reading https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/mpir.rb
 - so there is no interference with gmp.


---

Comment by dimpase created at 2021-09-23 18:28:44

Besides, we're getting rid of mpir spkg all together.


---

Comment by mkoeppe created at 2021-09-23 18:29:26

This ticket has really nothing to do with MPIR. It's just (pre #32549) that the spkg-configure duties for gmp are done by MPIR's spkg-configure.


---

Comment by mjo created at 2021-09-23 19:24:52

Replying to [comment:22 mkoeppe]:
> The problem on homebrew is really a very specific one, which I have explained in the ticket description: The GMP headers *are* installed in what you would call the "standard location" (`/usr/local/`), but when compiler/linker are invoked with `-isysroot`, then `/usr/local` is not a standard location. Yes, we fix it in the *build* environment using `.homebrew-build-env` but that does not affect the compiler use in the *runtime* environment.

Oh, the description makes it sounds like libgmp being in `/usr/local/Cellar/gmp/6.2.1/lib` is the problem. Is this another case of trying to use cython (which in turn uses the C toolchain) without sourcing `.homebrew-build-env` to make the C toolchain work?


---

Comment by mkoeppe created at 2021-09-25 01:44:59

It's really just the broken design of homebrew's `python3`. They use `-isysroot` in the build configuration of python, which goes into the compiler/flags of any extensions built via distutils/setuptools. Then they add back a few homebrew directories via `distutils.cfg`. It's hopelessly broken because these directories take priority over other user/package-provided include and linker directories. At build time, we work around it by disabling use of the system python's vendored distutils and use our own. 
At runtime, we would be best off by using paths explicitly that can be discovered via pkg-config -- because in the Sage library we already do that for all other packages.


---

Comment by dimpase created at 2021-09-25 07:30:11

is this reported to Homebrew as a bug?


---

Comment by mkoeppe created at 2021-09-25 17:02:55

Replying to [comment:28 dimpase]:
> is this reported to Homebrew as a bug?
I didn't report it when I came across it in #31335. I figured a bug report titled "distutils.cfg considered harmful" would drain a lot of energy...


---

Comment by dimpase created at 2021-09-26 08:12:22

Replying to [comment:29 mkoeppe]:
> Replying to [comment:28 dimpase]:
> > is this reported to Homebrew as a bug?
> I didn't report it when I came across it in #31335. I figured a bug report titled "distutils.cfg considered harmful" would drain a lot of energy... 

You don't need to fight a battle, merely report the problem, please.


---

Comment by mkoeppe created at 2021-09-27 19:18:22

They're pretty quick with closing as wontfix if one doesn't also provide a patch


---

Comment by dimpase created at 2021-09-27 19:50:50

Replying to [comment:32 mkoeppe]:
> They're pretty quick with closing as wontfix if one doesn't also provide a patch

Sprecht du kein Ruby, oder? :-)


---

Comment by mkoeppe created at 2021-12-12 00:15:28

Replying to [comment:31 dimpase]:
> Replying to [comment:29 mkoeppe]:
> > Replying to [comment:28 dimpase]:
> > > is this reported to Homebrew as a bug?
> > I didn't report it when I came across it in #31335. I figured a bug report titled "distutils.cfg considered harmful" would drain a lot of energy... 
> 
> You don't need to fight a battle, merely report the problem, please.

I sent a first PR to reduce homebrew's `distutils.cfg` - https://github.com/Homebrew/homebrew-core/pull/91043


---

Comment by slelievre created at 2022-01-01 21:46:46

Changing keywords from "" to "mpfr".


---

Comment by slelievre created at 2022-01-01 21:46:46

Removed mpir from ticket summary after its removal in #32549, #32727.


---

Comment by mkoeppe created at 2022-02-08 06:47:17

Replying to [comment:34 mkoeppe]:
> I sent a first PR to reduce homebrew's `distutils.cfg` - https://github.com/Homebrew/homebrew-core/pull/91043

They have merged a broader change now, eliminating all of `distutils.cfg` (https://github.com/Homebrew/homebrew-core/pull/91043#issuecomment-1032079055), at least for their Python 3.10 package. That's a good improvement, but it changes nothing for the present ticket.


---

Comment by dimpase created at 2022-05-20 13:19:09

so this needs changes to gmp's and mpfr's `spkg-configure.m4` ? Anything else?


---

Comment by mkoeppe created at 2022-05-20 16:39:18

`sage.env.cython_aliases` also needs to be extended


---

Comment by dimpase created at 2022-05-30 10:59:07

should we remove all the crud needed for gmp and mpfr without .pc files available?

I suppose almost every platform we support nowadays will have them installed.


---

Comment by mkoeppe created at 2022-05-30 18:42:30

Replying to [comment:43 dimpase]:
> I suppose almost every platform we support nowadays will have them installed.

That would be worth checking.
