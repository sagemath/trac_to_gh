# Issue 768: Open a method source in the editor of your choice

Issue created by migration from Trac.

Original creator: nbruin

Original creation time: 2007-10-01 00:18:49

Assignee: was

It is easy look up the location of the definition of a method or function in sage, but opening the relevant file in an editor requires cutting and pasting. The following code should do that for you:

```
import sage.misc.sageinspect
import sage.misc.sagedoc
import inspect

from string import Template

defaulttemplate = Template('nedit-nc -line ${line} ${file}')

def fileandline(obj):
   r"""
   Look up source file and line number of obj
   """
   d = inspect.getdoc(obj)
   ret = sage.misc.sageinspect._extract_embedded_position(d);
   if ret is not None:
     (_, filename, lineno) = ret
   else:
     filename = inspect.getsourcefile(obj)
     _,lineno = inspect.findsource(obj)
#      
#  for sage files, the registered source file is the result of the preparsing
#  these files end in ".py" and have "*autogenerated*" on the second line
#  for those files, we replace the extension by ".sage" and we subtract
#  3 from the line number to compensate for the 3 lines that were prefixed
#  in the preparsing process
#
     if filename[-3:] == '.py':
       infile=open(filename,'r')
       infile.readline()
       if infile.readline().find("*autogenerated*") >=0:
         filename=filename[:-3]+'.sage'
	 lineno = lineno-3
	 
   return filename, lineno
   
def edit(obj,template=defaulttemplate):
   """
   Open source of obj in editor of your choice
   """
   filename,lineno = fileandline(obj)
   os.system(edittemplate.substitute(line=lineno,file=filename))
```

Before this code gets included there are some issues to be addressed:
 * The default template should be settable in some way. What would be the appropriate way of doing that? Can there be a static variable in the module that gets set by a routine "seteditortemplate" or something like that?
 * I have been told that the file returned for library code will be in the running version, which will get overwritten upon the next sage -br. Can we change the file name in the appropriate way?
 * no error handling is in place
 * Where should it go?


---

Comment by nbruin created at 2007-10-01 00:26:02

source file


---

Attachment

attached source is not entirely identical to displayed code. I corrected some bugs, to the attached file is the right one to look at


---

Attachment


---

Comment by nbruin created at 2007-10-04 01:27:21

rather major rewrite (although still the same idea):
 * It is now a proper sage module
 * doctests included [BEWARE: due to the fact that this module uses "os" in a nontrivial way, not all doctests can actually be run. These are marked as required]
 * now looks at the EDITOR environment variable to try and set a sensible template

TODO:
 * figure out where this goes into the sage tree (if at all)
 * adjust doctests if module gets auto-imported in sage.
 * write an editor that works from the notebook


---

Comment by was created at 2007-10-04 04:02:21

Changing status from new to assigned.


---

Comment by was created at 2007-10-04 04:02:21

I'm working on integrating this into sage-2.8.6 (and a proper patch).


---

Attachment

This is a proper patch, with a bunch of improvements.


---

Comment by was created at 2007-10-04 04:46:53

Added a proper patch;  this will be in sage-2.8.6.


---

Comment by was created at 2007-10-04 04:46:53

Resolution: fixed


---

Comment by nbruin created at 2007-10-05 23:57:39

patch 6580 produces a file that does not pass doctest.
Also, as remarked in trac #828, always adding an '&' is not such a good idea. Whether an '&' is desirable depends on the editor and
hence should be placed in the default templates.
[or is it dependent on the editor AND some other environment variables? In that case we should probably encourage people to put the required configuration magic in their .sage/init One can't keep second-guessing people's private setup]

Other changes made:

 * set_edit_template
 * set_editor

are now separate routines. One sets the template directly and the other looks up the string in the default templates. Since the input between these two routines is really different, they should be different routines.

Patch file 6581.patch is relative to 6580.patch.

I also noted a problem with using the EDITOR variable:

The checkin system expects an editor in the EDITOR variable that
ONLY returns after the file has been edited. Many "client/server" editors don't do that: The "client" asks the "server" to open a window on a given file. The "client" then returns immediately.
Hence, many editors that are desirable for code editing are not suitable for the hg check-in system. Therefore, the dependency on the EDITOR variable is only of extremely limited use and people should perhaps not be too much encouraged to use it.

Putting a set_editor or set_edit_template instruction in you .sage/init gives a much more flexible setup.


---

Comment by nbruin created at 2007-10-05 23:57:39

Resolution changed from fixed to 


---

Comment by nbruin created at 2007-10-05 23:57:39

Changing status from closed to reopened.


---

Comment by mabshoff created at 2007-10-18 14:10:52

Is this mergable?

Cheers,

Michael


---

Comment by was created at 2007-10-21 03:17:08

I'm confused about what I'm supposed to do with this.  Some clarification would be nice.


---

Comment by nbruin created at 2007-10-21 06:44:02

Clarification for patch 6581: At the time 6580 was posted here but not included in a sage distribution, I tried the patch and I got an error when the EDITOR environment variable was not set, but a default editor template was set via other means. 6581 was meant to fix that.

Experimenting with setting EDITOR to an editor that I would want to use with the edit command ("nedit-nc") led to problems with checking in patches, because nedit-nc returns immediately, rather than after closing the edited file. That behaviour does not play well with hg at all.

I also realized that we ended up with two ways of specifying the editor to use:
 - setting a template to call the editor (this gives full control)
 - giving the system an editor name and let it figure out the appropriate calling template by itself. I figured that separating out the two in separate commands
would make a cleaner interface, hence the two commands "set_editor" and "set_edit_template"

So far for the rationale of the patch. I think the command in sage (is it there?) has since diverged from 6580 anyway, so I'm not sure if 6581 still applies cleanly, much less if it still represents an improvement. I suspect that if people actually use this command, then any obvious bugs would already have been solved, so I guess 6581 can just die. If people prefer the behaviour in 6581, they can always just install the file locally in their own .sageinit.


---

Attachment

Fixed patch


---

Comment by nbruin created at 2007-10-23 03:10:12

UPDATED patch 6581.patch. I realized that the functionality of the "edit" command was not fixed at all. I have remade a patch and attached it to 6581.patch. This should apply cleanly to 2.8.8.1. Main improvements:

 - things did not work at all without env\['EDITOR'\] set. They do now
 - Rationalized routine names and functionality
 - did away with "bg" parameter. set_edit_template can be used if the default templates get it wrong (they shouldn't, though)
 - "opts" parameter does not get used, so this isn't propagated currently.
 - using 'editor' optional argument to edit() sets the template string, so no need to import set_editor anymore. (This is a dirty side-effect, but the  command is exclusively for interactive use anyway)

Please DO consider the changes in this patch. Otherwise, edit_module should be scrapped entirely, because currently it is really broken.


---

Comment by malb created at 2007-10-23 22:20:24

applied to 2.8.9.alpha0


---

Comment by malb created at 2007-10-23 22:20:24

Resolution: fixed


---

Attachment

updated patch with bg option added back in


---

Comment by nbruin created at 2007-10-24 17:50:14

Resolution changed from fixed to 


---

Comment by nbruin created at 2007-10-24 17:50:14

Changing status from closed to reopened.


---

Comment by mabshoff created at 2007-10-24 18:01:33

Resolution: fixed


---

Comment by mabshoff created at 2007-10-24 18:01:33

Hello Nils,

this is going to be a problem, because your patch has already been applied to 2.8.9.alpa0 - available at

http://sage.math.washington.edu/home/malb/sage-2.8.9/sage-2.8.9.alpha0/dist/sage-2.8.9.alpha0.tar

Please open another ticket and attach a patch relative to 2.8.9.alpha0 or 2.8.8 with your previous patch applied there.

Cheers,

Michael
