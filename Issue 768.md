# Issue 768: Open a method source in the editor of your choice

archive/issues_000768.json:
```json
{
    "body": "Assignee: was\n\nIt is easy look up the location of the definition of a method or function in sage, but opening the relevant file in an editor requires cutting and pasting. The following code should do that for you:\n\n```\nimport sage.misc.sageinspect\nimport sage.misc.sagedoc\nimport inspect\n\nfrom string import Template\n\ndefaulttemplate = Template('nedit-nc -line ${line} ${file}')\n\ndef fileandline(obj):\n   r\"\"\"\n   Look up source file and line number of obj\n   \"\"\"\n   d = inspect.getdoc(obj)\n   ret = sage.misc.sageinspect._extract_embedded_position(d);\n   if ret is not None:\n     (_, filename, lineno) = ret\n   else:\n     filename = inspect.getsourcefile(obj)\n     _,lineno = inspect.findsource(obj)\n#      \n#  for sage files, the registered source file is the result of the preparsing\n#  these files end in \".py\" and have \"*autogenerated*\" on the second line\n#  for those files, we replace the extension by \".sage\" and we subtract\n#  3 from the line number to compensate for the 3 lines that were prefixed\n#  in the preparsing process\n#\n     if filename[-3:] == '.py':\n       infile=open(filename,'r')\n       infile.readline()\n       if infile.readline().find(\"*autogenerated*\") >=0:\n         filename=filename[:-3]+'.sage'\n\t lineno = lineno-3\n\t \n   return filename, lineno\n   \ndef edit(obj,template=defaulttemplate):\n   \"\"\"\n   Open source of obj in editor of your choice\n   \"\"\"\n   filename,lineno = fileandline(obj)\n   os.system(edittemplate.substitute(line=lineno,file=filename))\n```\n\nBefore this code gets included there are some issues to be addressed:\n* The default template should be settable in some way. What would be the appropriate way of doing that? Can there be a static variable in the module that gets set by a routine \"seteditortemplate\" or something like that?\n* I have been told that the file returned for library code will be in the running version, which will get overwritten upon the next sage -br. Can we change the file name in the appropriate way?\n* no error handling is in place\n* Where should it go?\n\nIssue created by migration from https://trac.sagemath.org/ticket/768\n\n",
    "created_at": "2007-10-01T00:18:49Z",
    "labels": [
        "user interface",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-2.8.9",
    "title": "Open a method source in the editor of your choice",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/768",
    "user": "nbruin"
}
```
Assignee: was

It is easy look up the location of the definition of a method or function in sage, but opening the relevant file in an editor requires cutting and pasting. The following code should do that for you:

```
import sage.misc.sageinspect
import sage.misc.sagedoc
import inspect

from string import Template

defaulttemplate = Template('nedit-nc -line ${line} ${file}')

def fileandline(obj):
   r"""
   Look up source file and line number of obj
   """
   d = inspect.getdoc(obj)
   ret = sage.misc.sageinspect._extract_embedded_position(d);
   if ret is not None:
     (_, filename, lineno) = ret
   else:
     filename = inspect.getsourcefile(obj)
     _,lineno = inspect.findsource(obj)
#      
#  for sage files, the registered source file is the result of the preparsing
#  these files end in ".py" and have "*autogenerated*" on the second line
#  for those files, we replace the extension by ".sage" and we subtract
#  3 from the line number to compensate for the 3 lines that were prefixed
#  in the preparsing process
#
     if filename[-3:] == '.py':
       infile=open(filename,'r')
       infile.readline()
       if infile.readline().find("*autogenerated*") >=0:
         filename=filename[:-3]+'.sage'
	 lineno = lineno-3
	 
   return filename, lineno
   
def edit(obj,template=defaulttemplate):
   """
   Open source of obj in editor of your choice
   """
   filename,lineno = fileandline(obj)
   os.system(edittemplate.substitute(line=lineno,file=filename))
```

Before this code gets included there are some issues to be addressed:
* The default template should be settable in some way. What would be the appropriate way of doing that? Can there be a static variable in the module that gets set by a routine "seteditortemplate" or something like that?
* I have been told that the file returned for library code will be in the running version, which will get overwritten upon the next sage -br. Can we change the file name in the appropriate way?
* no error handling is in place
* Where should it go?

Issue created by migration from https://trac.sagemath.org/ticket/768





---

archive/issue_comments_004544.json:
```json
{
    "body": "source file",
    "created_at": "2007-10-01T00:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4544",
    "user": "nbruin"
}
```

source file



---

archive/issue_comments_004545.json:
```json
{
    "body": "Attachment [editsage.sage](tarball://root/attachments/some-uuid/ticket768/editsage.sage) by nbruin created at 2007-10-01 00:27:54\n\nattached source is not entirely identical to displayed code. I corrected some bugs, to the attached file is the right one to look at",
    "created_at": "2007-10-01T00:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4545",
    "user": "nbruin"
}
```

Attachment [editsage.sage](tarball://root/attachments/some-uuid/ticket768/editsage.sage) by nbruin created at 2007-10-01 00:27:54

attached source is not entirely identical to displayed code. I corrected some bugs, to the attached file is the right one to look at



---

archive/issue_comments_004546.json:
```json
{
    "body": "Attachment [editmodule.py](tarball://root/attachments/some-uuid/ticket768/editmodule.py) by nbruin created at 2007-10-04 01:20:22",
    "created_at": "2007-10-04T01:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4546",
    "user": "nbruin"
}
```

Attachment [editmodule.py](tarball://root/attachments/some-uuid/ticket768/editmodule.py) by nbruin created at 2007-10-04 01:20:22



---

archive/issue_comments_004547.json:
```json
{
    "body": "rather major rewrite (although still the same idea):\n* It is now a proper sage module\n* doctests included [BEWARE: due to the fact that this module uses \"os\" in a nontrivial way, not all doctests can actually be run. These are marked as required]\n* now looks at the EDITOR environment variable to try and set a sensible template\n\nTODO:\n* figure out where this goes into the sage tree (if at all)\n* adjust doctests if module gets auto-imported in sage.\n* write an editor that works from the notebook",
    "created_at": "2007-10-04T01:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4547",
    "user": "nbruin"
}
```

rather major rewrite (although still the same idea):
* It is now a proper sage module
* doctests included [BEWARE: due to the fact that this module uses "os" in a nontrivial way, not all doctests can actually be run. These are marked as required]
* now looks at the EDITOR environment variable to try and set a sensible template

TODO:
* figure out where this goes into the sage tree (if at all)
* adjust doctests if module gets auto-imported in sage.
* write an editor that works from the notebook



---

archive/issue_comments_004548.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2007-10-04T04:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4548",
    "user": "was"
}
```

Changing status from new to assigned.



---

archive/issue_comments_004549.json:
```json
{
    "body": "I'm working on integrating this into sage-2.8.6 (and a proper patch).",
    "created_at": "2007-10-04T04:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4549",
    "user": "was"
}
```

I'm working on integrating this into sage-2.8.6 (and a proper patch).



---

archive/issue_comments_004550.json:
```json
{
    "body": "Attachment [6580.patch](tarball://root/attachments/some-uuid/ticket768/6580.patch) by was created at 2007-10-04 04:46:33\n\nThis is a proper patch, with a bunch of improvements.",
    "created_at": "2007-10-04T04:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4550",
    "user": "was"
}
```

Attachment [6580.patch](tarball://root/attachments/some-uuid/ticket768/6580.patch) by was created at 2007-10-04 04:46:33

This is a proper patch, with a bunch of improvements.



---

archive/issue_comments_004551.json:
```json
{
    "body": "Added a proper patch;  this will be in sage-2.8.6.",
    "created_at": "2007-10-04T04:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4551",
    "user": "was"
}
```

Added a proper patch;  this will be in sage-2.8.6.



---

archive/issue_comments_004552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2007-10-04T04:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4552",
    "user": "was"
}
```

Resolution: fixed



---

archive/issue_comments_004553.json:
```json
{
    "body": "patch 6580 produces a file that does not pass doctest.\nAlso, as remarked in trac #828, always adding an '&' is not such a good idea. Whether an '&' is desirable depends on the editor and\nhence should be placed in the default templates.\n[or is it dependent on the editor AND some other environment variables? In that case we should probably encourage people to put the required configuration magic in their .sage/init One can't keep second-guessing people's private setup]\n\nOther changes made:\n\n* set_edit_template\n* set_editor\n\nare now separate routines. One sets the template directly and the other looks up the string in the default templates. Since the input between these two routines is really different, they should be different routines.\n\nPatch file 6581.patch is relative to 6580.patch.\n\nI also noted a problem with using the EDITOR variable:\n\nThe checkin system expects an editor in the EDITOR variable that\nONLY returns after the file has been edited. Many \"client/server\" editors don't do that: The \"client\" asks the \"server\" to open a window on a given file. The \"client\" then returns immediately.\nHence, many editors that are desirable for code editing are not suitable for the hg check-in system. Therefore, the dependency on the EDITOR variable is only of extremely limited use and people should perhaps not be too much encouraged to use it.\n\nPutting a set_editor or set_edit_template instruction in you .sage/init gives a much more flexible setup.",
    "created_at": "2007-10-05T23:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4553",
    "user": "nbruin"
}
```

patch 6580 produces a file that does not pass doctest.
Also, as remarked in trac #828, always adding an '&' is not such a good idea. Whether an '&' is desirable depends on the editor and
hence should be placed in the default templates.
[or is it dependent on the editor AND some other environment variables? In that case we should probably encourage people to put the required configuration magic in their .sage/init One can't keep second-guessing people's private setup]

Other changes made:

* set_edit_template
* set_editor

are now separate routines. One sets the template directly and the other looks up the string in the default templates. Since the input between these two routines is really different, they should be different routines.

Patch file 6581.patch is relative to 6580.patch.

I also noted a problem with using the EDITOR variable:

The checkin system expects an editor in the EDITOR variable that
ONLY returns after the file has been edited. Many "client/server" editors don't do that: The "client" asks the "server" to open a window on a given file. The "client" then returns immediately.
Hence, many editors that are desirable for code editing are not suitable for the hg check-in system. Therefore, the dependency on the EDITOR variable is only of extremely limited use and people should perhaps not be too much encouraged to use it.

Putting a set_editor or set_edit_template instruction in you .sage/init gives a much more flexible setup.



---

archive/issue_comments_004554.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2007-10-05T23:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4554",
    "user": "nbruin"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_004555.json:
```json
{
    "body": "Changing status from closed to reopened.",
    "created_at": "2007-10-05T23:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4555",
    "user": "nbruin"
}
```

Changing status from closed to reopened.



---

archive/issue_comments_004556.json:
```json
{
    "body": "Is this mergable?\n\nCheers,\n\nMichael",
    "created_at": "2007-10-18T14:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4556",
    "user": "mabshoff"
}
```

Is this mergable?

Cheers,

Michael



---

archive/issue_comments_004557.json:
```json
{
    "body": "I'm confused about what I'm supposed to do with this.  Some clarification would be nice.",
    "created_at": "2007-10-21T03:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4557",
    "user": "was"
}
```

I'm confused about what I'm supposed to do with this.  Some clarification would be nice.



---

archive/issue_comments_004558.json:
```json
{
    "body": "Clarification for patch 6581: At the time 6580 was posted here but not included in a sage distribution, I tried the patch and I got an error when the EDITOR environment variable was not set, but a default editor template was set via other means. 6581 was meant to fix that.\n\nExperimenting with setting EDITOR to an editor that I would want to use with the edit command (\"nedit-nc\") led to problems with checking in patches, because nedit-nc returns immediately, rather than after closing the edited file. That behaviour does not play well with hg at all.\n\nI also realized that we ended up with two ways of specifying the editor to use:\n- setting a template to call the editor (this gives full control)\n- giving the system an editor name and let it figure out the appropriate calling template by itself. I figured that separating out the two in separate commands\nwould make a cleaner interface, hence the two commands \"set_editor\" and \"set_edit_template\"\n\nSo far for the rationale of the patch. I think the command in sage (is it there?) has since diverged from 6580 anyway, so I'm not sure if 6581 still applies cleanly, much less if it still represents an improvement. I suspect that if people actually use this command, then any obvious bugs would already have been solved, so I guess 6581 can just die. If people prefer the behaviour in 6581, they can always just install the file locally in their own .sageinit.",
    "created_at": "2007-10-21T06:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4558",
    "user": "nbruin"
}
```

Clarification for patch 6581: At the time 6580 was posted here but not included in a sage distribution, I tried the patch and I got an error when the EDITOR environment variable was not set, but a default editor template was set via other means. 6581 was meant to fix that.

Experimenting with setting EDITOR to an editor that I would want to use with the edit command ("nedit-nc") led to problems with checking in patches, because nedit-nc returns immediately, rather than after closing the edited file. That behaviour does not play well with hg at all.

I also realized that we ended up with two ways of specifying the editor to use:
- setting a template to call the editor (this gives full control)
- giving the system an editor name and let it figure out the appropriate calling template by itself. I figured that separating out the two in separate commands
would make a cleaner interface, hence the two commands "set_editor" and "set_edit_template"

So far for the rationale of the patch. I think the command in sage (is it there?) has since diverged from 6580 anyway, so I'm not sure if 6581 still applies cleanly, much less if it still represents an improvement. I suspect that if people actually use this command, then any obvious bugs would already have been solved, so I guess 6581 can just die. If people prefer the behaviour in 6581, they can always just install the file locally in their own .sageinit.



---

archive/issue_comments_004559.json:
```json
{
    "body": "Attachment [6581.patch](tarball://root/attachments/some-uuid/ticket768/6581.patch) by nbruin created at 2007-10-23 02:58:31\n\nFixed patch",
    "created_at": "2007-10-23T02:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4559",
    "user": "nbruin"
}
```

Attachment [6581.patch](tarball://root/attachments/some-uuid/ticket768/6581.patch) by nbruin created at 2007-10-23 02:58:31

Fixed patch



---

archive/issue_comments_004560.json:
```json
{
    "body": "UPDATED patch 6581.patch. I realized that the functionality of the \"edit\" command was not fixed at all. I have remade a patch and attached it to 6581.patch. This should apply cleanly to 2.8.8.1. Main improvements:\n\n- things did not work at all without env\\['EDITOR'\\] set. They do now\n- Rationalized routine names and functionality\n- did away with \"bg\" parameter. set_edit_template can be used if the default templates get it wrong (they shouldn't, though)\n- \"opts\" parameter does not get used, so this isn't propagated currently.\n- using 'editor' optional argument to edit() sets the template string, so no need to import set_editor anymore. (This is a dirty side-effect, but the  command is exclusively for interactive use anyway)\n\nPlease DO consider the changes in this patch. Otherwise, edit_module should be scrapped entirely, because currently it is really broken.",
    "created_at": "2007-10-23T03:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4560",
    "user": "nbruin"
}
```

UPDATED patch 6581.patch. I realized that the functionality of the "edit" command was not fixed at all. I have remade a patch and attached it to 6581.patch. This should apply cleanly to 2.8.8.1. Main improvements:

- things did not work at all without env\['EDITOR'\] set. They do now
- Rationalized routine names and functionality
- did away with "bg" parameter. set_edit_template can be used if the default templates get it wrong (they shouldn't, though)
- "opts" parameter does not get used, so this isn't propagated currently.
- using 'editor' optional argument to edit() sets the template string, so no need to import set_editor anymore. (This is a dirty side-effect, but the  command is exclusively for interactive use anyway)

Please DO consider the changes in this patch. Otherwise, edit_module should be scrapped entirely, because currently it is really broken.



---

archive/issue_comments_004561.json:
```json
{
    "body": "applied to 2.8.9.alpha0",
    "created_at": "2007-10-23T22:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4561",
    "user": "malb"
}
```

applied to 2.8.9.alpha0



---

archive/issue_comments_004562.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2007-10-23T22:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4562",
    "user": "malb"
}
```

Resolution: fixed



---

archive/issue_comments_004563.json:
```json
{
    "body": "Attachment [7087.patch](tarball://root/attachments/some-uuid/ticket768/7087.patch) by nbruin created at 2007-10-24 17:49:23\n\nupdated patch with bg option added back in",
    "created_at": "2007-10-24T17:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4563",
    "user": "nbruin"
}
```

Attachment [7087.patch](tarball://root/attachments/some-uuid/ticket768/7087.patch) by nbruin created at 2007-10-24 17:49:23

updated patch with bg option added back in



---

archive/issue_comments_004564.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2007-10-24T17:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4564",
    "user": "nbruin"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_004565.json:
```json
{
    "body": "Changing status from closed to reopened.",
    "created_at": "2007-10-24T17:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4565",
    "user": "nbruin"
}
```

Changing status from closed to reopened.



---

archive/issue_comments_004566.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2007-10-24T18:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4566",
    "user": "mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_004567.json:
```json
{
    "body": "Hello Nils,\n\nthis is going to be a problem, because your patch has already been applied to 2.8.9.alpa0 - available at\n\nhttp://sage.math.washington.edu/home/malb/sage-2.8.9/sage-2.8.9.alpha0/dist/sage-2.8.9.alpha0.tar\n\nPlease open another ticket and attach a patch relative to 2.8.9.alpha0 or 2.8.8 with your previous patch applied there.\n\nCheers,\n\nMichael",
    "created_at": "2007-10-24T18:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/768#issuecomment-4567",
    "user": "mabshoff"
}
```

Hello Nils,

this is going to be a problem, because your patch has already been applied to 2.8.9.alpa0 - available at

http://sage.math.washington.edu/home/malb/sage-2.8.9/sage-2.8.9.alpha0/dist/sage-2.8.9.alpha0.tar

Please open another ticket and attach a patch relative to 2.8.9.alpha0 or 2.8.8 with your previous patch applied there.

Cheers,

Michael
