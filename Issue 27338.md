# Issue 27338: Three.js: Fix CDN Fallback

Issue created by migration from https://trac.sagemath.org/ticket/27575

Original creator: paulmasson

Original creation time: 2019-03-30 19:42:56

CC:  egourgoulhon novoselt slelievre




---

Comment by paulmasson created at 2019-03-30 19:54:23

Changing component from PLEASE CHANGE to graphics.


---

Comment by paulmasson created at 2019-03-30 19:54:23

Changing type from PLEASE CHANGE to defect.


---

Comment by paulmasson created at 2019-03-30 19:54:23

New commits:


---

Comment by paulmasson created at 2019-03-30 19:54:23

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-03-31 15:25:00

The "mooted" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works?


---

Comment by saraedum created at 2019-03-31 15:35:49

Could you explain why this makes a difference? I.e., I don't understand why this change would make a difference to the browser.

Also, how does this compare to #26434?


---

Comment by saraedum created at 2019-03-31 15:39:41

I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?


---

Comment by git created at 2019-03-31 21:20:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2019-03-31 21:24:24

Replying to [comment:3 dimpase]:
> The "mooted" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works? 
It only silently works when the notebook is moved to a remote location. A locally served notebook should not have any problem finding the JS files and the the fallback will not be activated.


---

Comment by paulmasson created at 2019-03-31 21:27:42

Replying to [comment:5 saraedum]:
> I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?
A regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.

After reviewing the code in #22670 that added this fallback, I reverted to a normal JS string. That way older browsers and other environments should be supported.


---

Comment by paulmasson created at 2019-03-31 21:39:58

Replying to [comment:4 saraedum]:
> Also, how does this compare to #26434?
As a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant. This fallback is intended for files shared on the web, which implies internet access to a CDN.

Please describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.


---

Comment by saraedum created at 2019-03-31 22:07:25

Replying to [comment:9 paulmasson]:
> Replying to [comment:5 saraedum]:
> > I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?
> A regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.

Sure. That makes sense.


---

Comment by saraedum created at 2019-03-31 22:23:01

Replying to [comment:10 paulmasson]:
> Replying to [comment:4 saraedum]:
> > Also, how does this compare to #26434?
> As a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant.

I agree that it's not elegant. But you probably wouldn't dynamically emit script tags, would you?

> This fallback is intended for files shared on the web, which implies internet access to a CDN.

Personally, I really don't mind if this code contacts a CDN but one could argue that this could also run in a local webserver that is not meant to access the internet.

> Please describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.

There was no lack of internet access. I forget what the setup was unfortunately. Somehow this was served through an interface/web server that could not resolve the path to the local three.js assets. I assume that this fallback would have fixed the problem.

So, I'll set this to positive review as this definitely fixes an existing bug (currently, we are emitting JavaScript code with a Syntax Error.) Whether this is a privacy issue in the first place can be discussed in a new issue imho. Feel free to set that one to critical if you have strong feelings about it.


---

Comment by saraedum created at 2019-03-31 22:23:01

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2019-03-31 22:36:05

Ah, so the place where this does not work without the CDN is CoCalc btw. Let me build Sage there to check that it is actually fixed with this.


---

Comment by saraedum created at 2019-03-31 22:36:12

Changing status from positive_review to needs_info.


---

Comment by saraedum created at 2019-03-31 22:36:28

Changing status from needs_info to needs_review.


---

Comment by git created at 2019-04-01 02:06:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2019-04-01 02:13:51

This final commit does not change functionality, but produces cleaner HTML output. The inserted script tags will now appear on separate lines. Sorry for any inconvenience this change might cause.


---

Comment by saraedum created at 2019-04-01 02:16:38

I currently waiting for my upgrade on CoCalc. Somehow, I cannot build Sage there anymoreâ€¦


---

Comment by saraedum created at 2019-04-01 02:17:46

slelievre: Could you test this on CoCalc (or share one of your many upgrades with me so I can try myself?)


---

Comment by egourgoulhon created at 2019-04-01 16:18:12

Replying to [comment:13 saraedum]:
> Ah, so the place where this does not work without the CDN is CoCalc btw.

Another place where this does not work without the CDN is nbviewer.jupyter.org. With the code in this ticket branch, one can indeed get threejs rendering without having to add the option `online=True`, as [this example](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/test_dodecahedron_threejs.ipynb) demonstrates. Accordingly, I am +1 for a positive review!


---

Comment by saraedum created at 2019-04-01 16:39:21

Building on CoCalc failed somehow. Since it works on the nbviewer, I assume it also works on CoCalc; at least it certainly won't make the situation worse.


---

Comment by saraedum created at 2019-04-01 16:39:21

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-04-02 13:20:25

Changing keywords from "" to "threejs".


---

Comment by vbraun created at 2019-04-03 18:38:35

Resolution: fixed
