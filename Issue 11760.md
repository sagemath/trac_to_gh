# Issue 11760: Allow running Sage with a temporary DOT_SAGE directory

archive/issues_011760.json:
```json
{
    "body": "Assignee: leif\n\nCC:  jhpalmieri\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11932\n\n",
    "created_at": "2011-10-17T18:29:51Z",
    "labels": [
        "scripts",
        "major",
        "enhancement"
    ],
    "title": "Allow running Sage with a temporary DOT_SAGE directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11760",
    "user": "jdemeyer"
}
```
Assignee: leif

CC:  jhpalmieri



Issue created by migration from https://trac.sagemath.org/ticket/11932





---

archive/issue_comments_133959.json:
```json
{
    "body": "I copied some patches from #11926 (and make some small changes to John's patch).",
    "created_at": "2011-10-17T18:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133959",
    "user": "jdemeyer"
}
```

I copied some patches from #11926 (and make some small changes to John's patch).



---

archive/issue_comments_133960.json:
```json
{
    "body": "I'd rename the function (as it creates a temporary *directory*), and not use a global variable for the \"return value\".\n\nThe function could either take the variable name as its parameter (such that `sage_make_tmp_dir DIR` assigns the directory name to `DIR`), or just \"echo\" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.",
    "created_at": "2011-10-17T21:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133960",
    "user": "leif"
}
```

I'd rename the function (as it creates a temporary *directory*), and not use a global variable for the "return value".

The function could either take the variable name as its parameter (such that `sage_make_tmp_dir DIR` assigns the directory name to `DIR`), or just "echo" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.



---

archive/issue_comments_133961.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> or just \"echo\" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.\n\n`DIR=`sage_make_tmp_dir`` of course.",
    "created_at": "2011-10-18T06:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133961",
    "user": "leif"
}
```

Replying to [comment:3 leif]:
> or just "echo" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.

`DIR=`sage_make_tmp_dir`` of course.



---

archive/issue_comments_133962.json:
```json
{
    "body": "Here's a version in which the function echoes the path of the temp dir.\n\nThis works best with the patch from #11924: without applying the patch there, the parent directory of the temporary .sage directory gets polluted with pickle cache files.",
    "created_at": "2011-10-18T18:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133962",
    "user": "jhpalmieri"
}
```

Here's a version in which the function echoes the path of the temp dir.

This works best with the patch from #11924: without applying the patch there, the parent directory of the temporary .sage directory gets polluted with pickle cache files.



---

archive/issue_comments_133963.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-18T18:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133963",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133964.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133964",
    "user": "jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_133965.json:
```json
{
    "body": "Rebased to #11073.  Documentation added.",
    "created_at": "2012-02-28T22:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133965",
    "user": "jhpalmieri"
}
```

Rebased to #11073.  Documentation added.



---

archive/issue_comments_133966.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-29T09:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133966",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_133967.json:
```json
{
    "body": "The following seems to be portable:\n\n```\nmktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX\n```\n\nso I would use this instead of `sage_mktempdir`.\n\n`sage-sage` needs to be replaced by `sage`.\n\nFinally, why not simply run\n\n```\n./sage --norc </dev/null >/dev/null 2>/dev/null\n```\n\nin `spkg-install`?",
    "created_at": "2012-02-29T09:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133967",
    "user": "jdemeyer"
}
```

The following seems to be portable:

```
mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX
```

so I would use this instead of `sage_mktempdir`.

`sage-sage` needs to be replaced by `sage`.

Finally, why not simply run

```
./sage --norc </dev/null >/dev/null 2>/dev/null
```

in `spkg-install`?



---

archive/issue_comments_133968.json:
```json
{
    "body": "I meant \"in `spkg/install`\".",
    "created_at": "2012-02-29T09:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133968",
    "user": "jdemeyer"
}
```

I meant "in `spkg/install`".



---

archive/issue_comments_133969.json:
```json
{
    "body": "Fixed. The patch to spkg/install is no longer valid; instead, we need to patch the sage-starts script.",
    "created_at": "2012-02-29T18:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133969",
    "user": "jhpalmieri"
}
```

Fixed. The patch to spkg/install is no longer valid; instead, we need to patch the sage-starts script.



---

archive/issue_comments_133970.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-29T18:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133970",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_133971.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-29T22:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133971",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_133972.json:
```json
{
    "body": "This is not working, and I'm probably making some bash error in the `sage` script. When I run\n\n```\nsage -c 'print \"hello\"'\n```\n\nit works as it should: no banner, just \"hello\", then a new shell prompt.  When I run\n\n```\nsage --norc -c 'print \"hello\"'\n```\n\nit starts up Sage, prints a banner, prints \"hello\", and then gives the Sage prompt. As a consequence, the `sage-starts` script is not working right. What am I doing wrong?",
    "created_at": "2012-02-29T22:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133972",
    "user": "jhpalmieri"
}
```

This is not working, and I'm probably making some bash error in the `sage` script. When I run

```
sage -c 'print "hello"'
```

it works as it should: no banner, just "hello", then a new shell prompt.  When I run

```
sage --norc -c 'print "hello"'
```

it starts up Sage, prints a banner, prints "hello", and then gives the Sage prompt. As a consequence, the `sage-starts` script is not working right. What am I doing wrong?



---

archive/issue_comments_133973.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-29T22:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133973",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_133974.json:
```json
{
    "body": "Never mind, I've found various work-arounds. The best seems to be to replace `sage \"`@`$\"` with `source sage \"`@`$\"`.",
    "created_at": "2012-02-29T22:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133974",
    "user": "jhpalmieri"
}
```

Never mind, I've found various work-arounds. The best seems to be to replace `sage "`@`$"` with `source sage "`@`$"`.



---

archive/issue_comments_133975.json:
```json
{
    "body": "No, that doesn't work: it doesn't clean up the temporary directory afterward. Using `\"$SAGE_ROOT/sage\" \"$`@`\"` seems to work, but is that a good solution?",
    "created_at": "2012-02-29T23:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133975",
    "user": "jhpalmieri"
}
```

No, that doesn't work: it doesn't clean up the temporary directory afterward. Using `"$SAGE_ROOT/sage" "$`@`"` seems to work, but is that a good solution?



---

archive/issue_comments_133976.json:
```json
{
    "body": "Replying to [comment:13 jhpalmieri]:\n> Using `\"$SAGE_ROOT/sage\" \"$`@`\"` seems to work, but is that a good solution?\nI don't see how calling `sage` could be different from calling `$SAGE_ROOT/sage`, are you sure the former doesn't work (I haven't tried).",
    "created_at": "2012-03-14T20:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133976",
    "user": "jdemeyer"
}
```

Replying to [comment:13 jhpalmieri]:
> Using `"$SAGE_ROOT/sage" "$`@`"` seems to work, but is that a good solution?
I don't see how calling `sage` could be different from calling `$SAGE_ROOT/sage`, are you sure the former doesn't work (I haven't tried).



---

archive/issue_comments_133977.json:
```json
{
    "body": "Calling `sage` at this point in the script will call the script `spkg/bin/sage`, because that directory is now in the path, so it is conceivably different from calling `$SAGE_ROOT/sage`. In practice, it does behave differently, as I mentioned above: using `$SAGE_ROOT/sage` in the script, the command `sage --norc -c 'print \"hello\"'` works as expected, while using just `sage`, the command prints the Sage banner, prints \"hello\", and then you end up at a Sage prompt, running Sage interactively.",
    "created_at": "2012-03-14T20:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133977",
    "user": "jhpalmieri"
}
```

Calling `sage` at this point in the script will call the script `spkg/bin/sage`, because that directory is now in the path, so it is conceivably different from calling `$SAGE_ROOT/sage`. In practice, it does behave differently, as I mentioned above: using `$SAGE_ROOT/sage` in the script, the command `sage --norc -c 'print "hello"'` works as expected, while using just `sage`, the command prints the Sage banner, prints "hello", and then you end up at a Sage prompt, running Sage interactively.



---

archive/issue_comments_133978.json:
```json
{
    "body": "I confirm your observation but I still don't understand what's going on.  I'm investigating...",
    "created_at": "2012-03-14T20:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133978",
    "user": "jdemeyer"
}
```

I confirm your observation but I still don't understand what's going on.  I'm investigating...



---

archive/issue_comments_133979.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-03-14T20:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133979",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_133980.json:
```json
{
    "body": "Okay, found it.  \"sage\" refers to the shell function\n\n```\nsage() {\n    sage_setup\n    sage-ipython \"$@\" -i\n}\n```\n\nWe should probably rename this function to `run_sage` or so...\n\nIn the mean time, replace `$SAGE_ROOT/sage \"$`@`\"` by\n\n```\ncommand sage \"$@\"\n```\n\n\nHelp of command:\n\n```\ncommand: command [-pVv] command [arg ...]\n    Execute a simple command or display information about commands.\n\n    Runs COMMAND with ARGS suppressing  shell function lookup, or display\n    information about the specified COMMANDs.  Can be used to invoke commands\n    on disk when a function with the same name exists.\n\n    Options:\n      -p        use a default value for PATH that is guaranteed to find all of\n        the standard utilities\n      -v        print a description of COMMAND similar to the `type' builtin\n      -V        print a more verbose description of each COMMAND\n\n    Exit Status:\n    Returns exit status of COMMAND, or failure if COMMAND is not found.\n```\n",
    "created_at": "2012-03-14T21:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133980",
    "user": "jdemeyer"
}
```

Okay, found it.  "sage" refers to the shell function

```
sage() {
    sage_setup
    sage-ipython "$@" -i
}
```

We should probably rename this function to `run_sage` or so...

In the mean time, replace `$SAGE_ROOT/sage "$`@`"` by

```
command sage "$@"
```


Help of command:

```
command: command [-pVv] command [arg ...]
    Execute a simple command or display information about commands.

    Runs COMMAND with ARGS suppressing  shell function lookup, or display
    information about the specified COMMANDs.  Can be used to invoke commands
    on disk when a function with the same name exists.

    Options:
      -p        use a default value for PATH that is guaranteed to find all of
        the standard utilities
      -v        print a description of COMMAND similar to the `type' builtin
      -V        print a more verbose description of each COMMAND

    Exit Status:
    Returns exit status of COMMAND, or failure if COMMAND is not found.
```




---

archive/issue_comments_133981.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-14T21:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133981",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_133982.json:
```json
{
    "body": "Ah, good, thank you. I agree, having a function named \"sage\" is probably a bad idea, but changing it should be dealt with elsewhere. (It would require a number of changes in the `sage` script, and a correspondingly large number of tests to make sure everything works.)",
    "created_at": "2012-03-14T21:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133982",
    "user": "jhpalmieri"
}
```

Ah, good, thank you. I agree, having a function named "sage" is probably a bad idea, but changing it should be dealt with elsewhere. (It would require a number of changes in the `sage` script, and a correspondingly large number of tests to make sure everything works.)



---

archive/issue_comments_133983.json:
```json
{
    "body": "On an entirely different topic: I don't like the `--norc` option name.  In the light of #12647, I would expect that option to suppress the reading of the `sagerc` script (and/or the `init.sage` script).  I would only support `--nodotsage`.",
    "created_at": "2012-03-14T21:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133983",
    "user": "jdemeyer"
}
```

On an entirely different topic: I don't like the `--norc` option name.  In the light of #12647, I would expect that option to suppress the reading of the `sagerc` script (and/or the `init.sage` script).  I would only support `--nodotsage`.



---

archive/issue_comments_133984.json:
```json
{
    "body": "Here are new patches which just use `--nodotsage`.  (I also considered `--tmpdotsage`, but it doesn't matter too much, as long as it's documented.)",
    "created_at": "2012-03-19T17:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133984",
    "user": "jhpalmieri"
}
```

Here are new patches which just use `--nodotsage`.  (I also considered `--tmpdotsage`, but it doesn't matter too much, as long as it's documented.)



---

archive/issue_comments_133985.json:
```json
{
    "body": "Attachment\n\nscripts repo",
    "created_at": "2012-03-19T17:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133985",
    "user": "jhpalmieri"
}
```

Attachment

scripts repo



---

archive/issue_comments_133986.json:
```json
{
    "body": "documentation patch (Sage library)",
    "created_at": "2012-03-19T17:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133986",
    "user": "jhpalmieri"
}
```

documentation patch (Sage library)



---

archive/issue_comments_133987.json:
```json
{
    "body": "Attachment\n\nIt would be nice to also have `--nosagerc`, and let `--nodotsage` by default *not* bypass `[$DOT_SAGE/]sagerc` (if it exists; of course no directory should be created if it doesn't).",
    "created_at": "2012-03-19T18:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133987",
    "user": "leif"
}
```

Attachment

It would be nice to also have `--nosagerc`, and let `--nodotsage` by default *not* bypass `[$DOT_SAGE/]sagerc` (if it exists; of course no directory should be created if it doesn't).



---

archive/issue_comments_133988.json:
```json
{
    "body": "Perhaps on another ticket...",
    "created_at": "2012-03-19T18:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133988",
    "user": "jhpalmieri"
}
```

Perhaps on another ticket...



---

archive/issue_comments_133989.json:
```json
{
    "body": "Unfortunately, this doesn't quite work properly since `DOT_SAGE` is changed *after* reading `sage-env`.  The following variables still refer to `$HOME/.sage`:\n\n```\njdemeyer@arcanis:/usr/local/src/sage-5.0.beta13$ ./sage --nodotsage --sh -c env | fgrep \"$HOME/.sage\"\nMPLCONFIGDIR=/home/jdemeyer/.sage//matplotlib-1.1.0\nSAGE_STARTUP_FILE=/home/jdemeyer/.sage//init.sage\nSAGE_TESTDIR=/home/jdemeyer/.sage//tmp\n```\n\n\nI suggest moving the `--nodotsage` check before the sourcing of `sage-env`.",
    "created_at": "2012-04-09T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133989",
    "user": "jdemeyer"
}
```

Unfortunately, this doesn't quite work properly since `DOT_SAGE` is changed *after* reading `sage-env`.  The following variables still refer to `$HOME/.sage`:

```
jdemeyer@arcanis:/usr/local/src/sage-5.0.beta13$ ./sage --nodotsage --sh -c env | fgrep "$HOME/.sage"
MPLCONFIGDIR=/home/jdemeyer/.sage//matplotlib-1.1.0
SAGE_STARTUP_FILE=/home/jdemeyer/.sage//init.sage
SAGE_TESTDIR=/home/jdemeyer/.sage//tmp
```


I suggest moving the `--nodotsage` check before the sourcing of `sage-env`.



---

archive/issue_comments_133990.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-09T19:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133990",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_133991.json:
```json
{
    "body": "Okay, here's a new root patch.",
    "created_at": "2012-04-13T20:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133991",
    "user": "jhpalmieri"
}
```

Okay, here's a new root patch.



---

archive/issue_comments_133992.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-13T20:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133992",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_133993.json:
```json
{
    "body": "Just one more issue: now that you don't source `sage-env`, the `command sage` looks for `sage` in the **system** `PATH`.  I suggest to replace\n\n```\ncommand sage \"$@\"\n```\n\nby\n\n```\ncommand \"$0\" \"$@\"\n```\n\nIf you make this change, you can give this ticket positive review.\n\nFurthermore, I would like to point out that `$HOME/.sage/matplotlib-1.1.0` is still created by `sage-env` when building Sage.  But that shouldn't stop this ticket.",
    "created_at": "2012-04-26T08:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133993",
    "user": "jdemeyer"
}
```

Just one more issue: now that you don't source `sage-env`, the `command sage` looks for `sage` in the **system** `PATH`.  I suggest to replace

```
command sage "$@"
```

by

```
command "$0" "$@"
```

If you make this change, you can give this ticket positive review.

Furthermore, I would like to point out that `$HOME/.sage/matplotlib-1.1.0` is still created by `sage-env` when building Sage.  But that shouldn't stop this ticket.



---

archive/issue_comments_133994.json:
```json
{
    "body": "root repo",
    "created_at": "2012-04-30T17:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133994",
    "user": "jhpalmieri"
}
```

root repo



---

archive/issue_comments_133995.json:
```json
{
    "body": "Attachment",
    "created_at": "2012-04-30T17:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133995",
    "user": "jhpalmieri"
}
```

Attachment



---

archive/issue_comments_133996.json:
```json
{
    "body": "Attachment\n\nHere are two versions. If we want the easy root, the first version just makes the change\n\n```diff\ndiff --git a/spkg/bin/sage b/spkg/bin/sage\n--- a/spkg/bin/sage\n+++ b/spkg/bin/sage\n@@ -238,7 +238,7 @@ cd \"$SAGE_ROOT\"\n if [ \"$1\" = '--nodotsage' ]; then\n     export DOT_SAGE=`mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX`\n     shift\n-    command sage \"$@\"\n+    command \"$0\" \"$@\"\n     status=$?\n     rm -rf \"$DOT_SAGE\"\n     exit $status\n```\n\nThe second version deals (I think) with the matplotlib issue, creating the config directory in sage.misc.misc, where other subdirectories of `DOT_SAGE` are created. It's not a very significant difference: the file [attachment:trac_11932-sage.v2.patch] and these changes to the root patch:\n\n```diff\ndiff --git a/spkg/bin/sage-env b/spkg/bin/sage-env\n--- a/spkg/bin/sage-env\n+++ b/spkg/bin/sage-env\n@@ -281,8 +281,9 @@ fi\n \n if [ \"$DOT_SAGE\" = \"\" ]; then\n     # It is *not* an error if this directory does not exist, it will\n-    # be created in spkg/bin/sage.  This also works if $HOME/.sage is a\n-    # symbolic link to a non-existing directory.\n+    # be created in spkg/bin/sage or devel/sage/sage/misc/misc.py.\n+    # This also works if $HOME/.sage is a symbolic link to a\n+    # non-existing directory.\n     DOT_SAGE=`resolvelinks \"$HOME/.sage\"`\n \n     # In theory, DOT_SAGE is not required to have a trailing slash.\n@@ -340,8 +341,7 @@ if [ -f \"$MPLINITFILE\" ]; then\n         MPLCONFIGDIR=\"$DOT_SAGE/matplotlib\"\n     fi\n     export MPLCONFIGDIR\n-    # Create the directory, because matplotlib doesn't seem to be happy otherwi\n-    mkdir -p \"$MPLCONFIGDIR\"\n+    # The directory is created when Sage starts (see sage.misc.misc).\n fi\n \n # Add some directories to $LD_LIBRARY_PATH:\n```\n\nIf you have time to look at the second version, please consider it. If you would rather deal with just the first version here, we can move the other version to a new ticket.",
    "created_at": "2012-04-30T17:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133996",
    "user": "jhpalmieri"
}
```

Attachment

Here are two versions. If we want the easy root, the first version just makes the change

```diff
diff --git a/spkg/bin/sage b/spkg/bin/sage
--- a/spkg/bin/sage
+++ b/spkg/bin/sage
@@ -238,7 +238,7 @@ cd "$SAGE_ROOT"
 if [ "$1" = '--nodotsage' ]; then
     export DOT_SAGE=`mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX`
     shift
-    command sage "$@"
+    command "$0" "$@"
     status=$?
     rm -rf "$DOT_SAGE"
     exit $status
```

The second version deals (I think) with the matplotlib issue, creating the config directory in sage.misc.misc, where other subdirectories of `DOT_SAGE` are created. It's not a very significant difference: the file [attachment:trac_11932-sage.v2.patch] and these changes to the root patch:

```diff
diff --git a/spkg/bin/sage-env b/spkg/bin/sage-env
--- a/spkg/bin/sage-env
+++ b/spkg/bin/sage-env
@@ -281,8 +281,9 @@ fi
 
 if [ "$DOT_SAGE" = "" ]; then
     # It is *not* an error if this directory does not exist, it will
-    # be created in spkg/bin/sage.  This also works if $HOME/.sage is a
-    # symbolic link to a non-existing directory.
+    # be created in spkg/bin/sage or devel/sage/sage/misc/misc.py.
+    # This also works if $HOME/.sage is a symbolic link to a
+    # non-existing directory.
     DOT_SAGE=`resolvelinks "$HOME/.sage"`
 
     # In theory, DOT_SAGE is not required to have a trailing slash.
@@ -340,8 +341,7 @@ if [ -f "$MPLINITFILE" ]; then
         MPLCONFIGDIR="$DOT_SAGE/matplotlib"
     fi
     export MPLCONFIGDIR
-    # Create the directory, because matplotlib doesn't seem to be happy otherwi
-    mkdir -p "$MPLCONFIGDIR"
+    # The directory is created when Sage starts (see sage.misc.misc).
 fi
 
 # Add some directories to $LD_LIBRARY_PATH:
```

If you have time to look at the second version, please consider it. If you would rather deal with just the first version here, we can move the other version to a new ticket.



---

archive/issue_comments_133997.json:
```json
{
    "body": "For the Sage patch, what about:\n\n```\ntry:\n    # Create the matplotlib config directory\n    sage_makedirs(os.environ[\"MPLCONFIGDIR\"])\nexcept KeyError:\n    pass\n```\n\nI don't see a reason to create a directory when the environment variable doesn't exist.",
    "created_at": "2012-05-07T13:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133997",
    "user": "jdemeyer"
}
```

For the Sage patch, what about:

```
try:
    # Create the matplotlib config directory
    sage_makedirs(os.environ["MPLCONFIGDIR"])
except KeyError:
    pass
```

I don't see a reason to create a directory when the environment variable doesn't exist.



---

archive/issue_comments_133998.json:
```json
{
    "body": "Since we set `MPLCONFIGDIR` in sage-env, there is no reason for it not to be set (unless someone does something risky and unsupported like try to import the Sage library using the system's Python). But I made the change anyway.",
    "created_at": "2012-05-07T17:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133998",
    "user": "jhpalmieri"
}
```

Since we set `MPLCONFIGDIR` in sage-env, there is no reason for it not to be set (unless someone does something risky and unsupported like try to import the Sage library using the system's Python). But I made the change anyway.



---

archive/issue_comments_133999.json:
```json
{
    "body": "Attachment\n\nLooks good and works well.\n\nI'm currently running\n\n```\nsage --nodotsage -tp 2 devel/sage/sage\n```\n",
    "created_at": "2012-05-08T10:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-133999",
    "user": "jdemeyer"
}
```

Attachment

Looks good and works well.

I'm currently running

```
sage --nodotsage -tp 2 devel/sage/sage
```




---

archive/issue_comments_134000.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-08T11:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-134000",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_134001.json:
```json
{
    "body": "\n```\nAll tests passed!\n```\n",
    "created_at": "2012-05-08T11:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-134001",
    "user": "jdemeyer"
}
```


```
All tests passed!
```




---

archive/issue_comments_134002.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-13T21:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11760",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11760#issuecomment-134002",
    "user": "jdemeyer"
}
```

Resolution: fixed
