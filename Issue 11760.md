# Issue 11760: Allow running Sage with a temporary DOT_SAGE directory

Issue created by migration from https://trac.sagemath.org/ticket/11932

Original creator: jdemeyer

Original creation time: 2011-10-17 18:29:51

Assignee: leif

CC:  jhpalmieri




---

Comment by jdemeyer created at 2011-10-17 18:41:39

I copied some patches from #11926 (and make some small changes to John's patch).


---

Comment by leif created at 2011-10-17 21:55:47

I'd rename the function (as it creates a temporary _directory_), and not use a global variable for the "return value".

The function could either take the variable name as its parameter (such that `sage_make_tmp_dir DIR` assigns the directory name to `DIR`), or just "echo" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.


---

Comment by leif created at 2011-10-18 06:06:37

Replying to [comment:3 leif]:
> or just "echo" the result (as `mktemp` already does), such that one writes `DIR=sage_make_tmp_dir` or whatever.

`DIR=`sage_make_tmp_dir`` of course.


---

Comment by jhpalmieri created at 2011-10-18 18:49:56

Here's a version in which the function echoes the path of the temp dir.

This works best with the patch from #11924: without applying the patch there, the parent directory of the temporary .sage directory gets polluted with pickle cache files.


---

Comment by jhpalmieri created at 2011-10-18 18:49:56

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jhpalmieri created at 2012-02-28 22:16:29

Rebased to #11073.  Documentation added.


---

Comment by jdemeyer created at 2012-02-29 09:13:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-29 09:13:44

The following seems to be portable:

```
mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX
```

so I would use this instead of `sage_mktempdir`.

`sage-sage` needs to be replaced by `sage`.

Finally, why not simply run

```
./sage --norc </dev/null >/dev/null 2>/dev/null
```

in `spkg-install`?


---

Comment by jdemeyer created at 2012-02-29 09:19:57

I meant "in `spkg/install`".


---

Comment by jhpalmieri created at 2012-02-29 18:14:49

Fixed. The patch to spkg/install is no longer valid; instead, we need to patch the sage-starts script.


---

Comment by jhpalmieri created at 2012-02-29 18:14:49

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-29 22:14:56

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-02-29 22:14:56

This is not working, and I'm probably making some bash error in the `sage` script. When I run

```
sage -c 'print "hello"'
```

it works as it should: no banner, just "hello", then a new shell prompt.  When I run

```
sage --norc -c 'print "hello"'
```

it starts up Sage, prints a banner, prints "hello", and then gives the Sage prompt. As a consequence, the `sage-starts` script is not working right. What am I doing wrong?


---

Comment by jhpalmieri created at 2012-02-29 22:34:13

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-29 22:34:13

Never mind, I've found various work-arounds. The best seems to be to replace `sage "`@`$"` with `source sage "`@`$"`.


---

Comment by jhpalmieri created at 2012-02-29 23:37:41

No, that doesn't work: it doesn't clean up the temporary directory afterward. Using `"$SAGE_ROOT/sage" "$`@`"` seems to work, but is that a good solution?


---

Comment by jdemeyer created at 2012-03-14 20:00:03

Replying to [comment:13 jhpalmieri]:
> Using `"$SAGE_ROOT/sage" "$`@`"` seems to work, but is that a good solution?
I don't see how calling `sage` could be different from calling `$SAGE_ROOT/sage`, are you sure the former doesn't work (I haven't tried).


---

Comment by jhpalmieri created at 2012-03-14 20:41:21

Calling `sage` at this point in the script will call the script `spkg/bin/sage`, because that directory is now in the path, so it is conceivably different from calling `$SAGE_ROOT/sage`. In practice, it does behave differently, as I mentioned above: using `$SAGE_ROOT/sage` in the script, the command `sage --norc -c 'print "hello"'` works as expected, while using just `sage`, the command prints the Sage banner, prints "hello", and then you end up at a Sage prompt, running Sage interactively.


---

Comment by jdemeyer created at 2012-03-14 20:50:46

I confirm your observation but I still don't understand what's going on.  I'm investigating...


---

Comment by jdemeyer created at 2012-03-14 20:50:46

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-03-14 21:02:57

Okay, found it.  "sage" refers to the shell function

```
sage() {
    sage_setup
    sage-ipython "$@" -i
}
```

We should probably rename this function to `run_sage` or so...

In the mean time, replace `$SAGE_ROOT/sage "$`@`"` by

```
command sage "$@"
```


Help of command:

```
command: command [-pVv] command [arg ...]
    Execute a simple command or display information about commands.

    Runs COMMAND with ARGS suppressing  shell function lookup, or display
    information about the specified COMMANDs.  Can be used to invoke commands
    on disk when a function with the same name exists.

    Options:
      -p        use a default value for PATH that is guaranteed to find all of
        the standard utilities
      -v        print a description of COMMAND similar to the `type' builtin
      -V        print a more verbose description of each COMMAND

    Exit Status:
    Returns exit status of COMMAND, or failure if COMMAND is not found.
```



---

Comment by jhpalmieri created at 2012-03-14 21:13:52

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-03-14 21:13:52

Ah, good, thank you. I agree, having a function named "sage" is probably a bad idea, but changing it should be dealt with elsewhere. (It would require a number of changes in the `sage` script, and a correspondingly large number of tests to make sure everything works.)


---

Comment by jdemeyer created at 2012-03-14 21:41:24

On an entirely different topic: I don't like the `--norc` option name.  In the light of #12647, I would expect that option to suppress the reading of the `sagerc` script (and/or the `init.sage` script).  I would only support `--nodotsage`.


---

Comment by jhpalmieri created at 2012-03-19 17:46:16

Here are new patches which just use `--nodotsage`.  (I also considered `--tmpdotsage`, but it doesn't matter too much, as long as it's documented.)


---

Attachment

scripts repo


---

Comment by jhpalmieri created at 2012-03-19 17:49:22

documentation patch (Sage library)


---

Attachment

It would be nice to also have `--nosagerc`, and let `--nodotsage` by default _not_ bypass `[$DOT_SAGE/]sagerc` (if it exists; of course no directory should be created if it doesn't).


---

Comment by jhpalmieri created at 2012-03-19 18:35:15

Perhaps on another ticket...


---

Comment by jdemeyer created at 2012-04-09 19:39:09

Unfortunately, this doesn't quite work properly since `DOT_SAGE` is changed _after_ reading `sage-env`.  The following variables still refer to `$HOME/.sage`:

```
jdemeyer@arcanis:/usr/local/src/sage-5.0.beta13$ ./sage --nodotsage --sh -c env | fgrep "$HOME/.sage"
MPLCONFIGDIR=/home/jdemeyer/.sage//matplotlib-1.1.0
SAGE_STARTUP_FILE=/home/jdemeyer/.sage//init.sage
SAGE_TESTDIR=/home/jdemeyer/.sage//tmp
```


I suggest moving the `--nodotsage` check before the sourcing of `sage-env`.


---

Comment by jdemeyer created at 2012-04-09 19:39:52

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-04-13 20:21:46

Okay, here's a new root patch.


---

Comment by jhpalmieri created at 2012-04-13 20:21:46

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-04-26 08:09:46

Just one more issue: now that you don't source `sage-env`, the `command sage` looks for `sage` in the *system* `PATH`.  I suggest to replace

```
command sage "$@"
```

by

```
command "$0" "$@"
```

If you make this change, you can give this ticket positive review.

Furthermore, I would like to point out that `$HOME/.sage/matplotlib-1.1.0` is still created by `sage-env` when building Sage.  But that shouldn't stop this ticket.


---

Comment by jhpalmieri created at 2012-04-30 17:08:05

root repo


---

Attachment


---

Attachment

Here are two versions. If we want the easy root, the first version just makes the change

```diff
diff --git a/spkg/bin/sage b/spkg/bin/sage
--- a/spkg/bin/sage
+++ b/spkg/bin/sage
@@ -238,7 +238,7 @@ cd "$SAGE_ROOT"
 if [ "$1" = '--nodotsage' ]; then
     export DOT_SAGE=`mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX`
     shift
-    command sage "$@"
+    command "$0" "$@"
     status=$?
     rm -rf "$DOT_SAGE"
     exit $status
```

The second version deals (I think) with the matplotlib issue, creating the config directory in sage.misc.misc, where other subdirectories of `DOT_SAGE` are created. It's not a very significant difference: the file [attachment:trac_11932-sage.v2.patch] and these changes to the root patch:

```diff
diff --git a/spkg/bin/sage-env b/spkg/bin/sage-env
--- a/spkg/bin/sage-env
+++ b/spkg/bin/sage-env
@@ -281,8 +281,9 @@ fi
 
 if [ "$DOT_SAGE" = "" ]; then
     # It is *not* an error if this directory does not exist, it will
-    # be created in spkg/bin/sage.  This also works if $HOME/.sage is a
-    # symbolic link to a non-existing directory.
+    # be created in spkg/bin/sage or devel/sage/sage/misc/misc.py.
+    # This also works if $HOME/.sage is a symbolic link to a
+    # non-existing directory.
     DOT_SAGE=`resolvelinks "$HOME/.sage"`
 
     # In theory, DOT_SAGE is not required to have a trailing slash.
@@ -340,8 +341,7 @@ if [ -f "$MPLINITFILE" ]; then
         MPLCONFIGDIR="$DOT_SAGE/matplotlib"
     fi
     export MPLCONFIGDIR
-    # Create the directory, because matplotlib doesn't seem to be happy otherwi
-    mkdir -p "$MPLCONFIGDIR"
+    # The directory is created when Sage starts (see sage.misc.misc).
 fi
 
 # Add some directories to $LD_LIBRARY_PATH:
```

If you have time to look at the second version, please consider it. If you would rather deal with just the first version here, we can move the other version to a new ticket.


---

Comment by jdemeyer created at 2012-05-07 13:57:58

For the Sage patch, what about:

```
try:
    # Create the matplotlib config directory
    sage_makedirs(os.environ["MPLCONFIGDIR"])
except KeyError:
    pass
```

I don't see a reason to create a directory when the environment variable doesn't exist.


---

Comment by jhpalmieri created at 2012-05-07 17:11:32

Since we set `MPLCONFIGDIR` in sage-env, there is no reason for it not to be set (unless someone does something risky and unsupported like try to import the Sage library using the system's Python). But I made the change anyway.


---

Attachment

Looks good and works well.

I'm currently running

```
sage --nodotsage -tp 2 devel/sage/sage
```



---

Comment by jdemeyer created at 2012-05-08 11:28:53

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-05-08 11:28:53


```
All tests passed!
```



---

Comment by jdemeyer created at 2012-05-13 21:32:43

Resolution: fixed
