# Issue 22534: Numerical Precision for Heights in Number Fields

Issue created by migration from https://trac.sagemath.org/ticket/22771

Original creator: tjcombs

Original creation time: 2017-04-07 01:40:17

CC:  raghukul01 bhutz

Use real interval field for floating point computations to compute relative heights in number fields without precision errors.


---

Comment by raghukul01 created at 2018-05-28 03:18:58

New commits:


---

Comment by raghukul01 created at 2018-05-28 03:18:58

Changing status from new to needs_review.


---

Comment by raghukul01 created at 2018-05-28 03:18:58

Changing keywords from "" to "number fields, gsoc2018".


---

Comment by git created at 2018-05-28 18:03:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-05-29 21:24:18

Here are a few things I've noticed so far.

- Need to have in the longer description that this is using the 'relative multiplicative height'

- remove todo block  (QQ and r=0 are covered in other functions)

- step 13: spelling: thier


- why switching to iter instead of yield? What about the issues of this being possibly *many* points? Please respond.

- LLL reduction still in docs for elements_of_bounded_height.


- need spaces between inputs lines in elements_of_bounded_height

- spaces after , in parameters

- This fails:

```
R.<x>=QQ[]
K.<a> = NumberField(x^3 - x^2 + 1)
A.<x,y>=AffineSpace(K,2)
list(A.points_of_bounded_height(2))
```

then so does subschemes

```
A.<x,y>=AffineSpace(K,2)
C = A.subscheme([x-y])
C.rational_points(2)
```


- reference should be updated with published version

- add yourself and TJ Combs to author section at top of file


---

Comment by bhutz created at 2018-05-29 21:24:18

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-30 17:50:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-31 08:27:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-05-31 08:27:38

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-04 14:40:41

Sorry, I just realized I never commented on this. The fix does work, but I would change one thing.

d_tilde is used in a couple other places, so I would covert d_tilde to RR in the same place M is converted (after calculations with it are done)

d_tilde = RR(d_tilde)


---

Comment by bhutz created at 2018-06-04 14:40:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-04 14:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-04 15:01:36

Sir,
I have made the changes which you suggested, please review.
I guess trac doesn't notify about commits pushed on the ticket, though I have added you to cc now.


---

Comment by raghukul01 created at 2018-06-04 15:01:36

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-04 15:10:45

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-04 15:10:45

no, I did get notified and even pulled it down and tested, but apparently I never put in my comments.

In going back over my tests with the new branch, there is one addition thing that I had noticed that needs to be fixed. With affine schemes working it exposed the fact that the height is converted to an absolute height incorrectly. In affine_space.py it has

```
bound = bound**(1/self.base_ring().absolute_degree())
```

which should be

```
bound = bound**self.base_ring().absolute_degree()
```


You may need to adjust an example. If not, you should definitely add one that ensures this bound is converted correctly.


---

Comment by git created at 2018-06-04 20:50:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by raghukul01 created at 2018-06-04 21:06:46

I have changed the part which calculates relative height in affine_space.py, example 2 was taking a long time and the answer was also wrong. So I changed that (examples show previous calculation was wrong).


---

Comment by raghukul01 created at 2018-06-04 21:06:46

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-04 21:28:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-07 19:15:53

Doctests fail. Run "make ptestlong"


---

Comment by vbraun created at 2018-06-07 19:15:53

Changing status from positive_review to needs_work.


---

Comment by bhutz created at 2018-06-07 19:58:28

I ran the regular test, but  neglected to reun the longtests


```
File "src/sage/rings/number_field/number_field.py", line 9375, in sage.rings.number_field.number_field.NumberField_absolute.elements_of_bounded_height
Failed example:
    len(list(L)) # long time (2 s)
Expected:
    2163
Got:
    2171
```


you should check if this is another case of alg 3 missing points. If so we can just correct the result value.


---

Comment by git created at 2018-06-08 09:23:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-08 09:32:38

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-08 09:32:38

Yes it was a case of missing points, changing the height to 50.1 yeilds
 required output
 {{{
 sage: K.<a> = NumberField(x^4 - 5)
 sage: L = K.elements_of_bounded_height(50.1)
 sage: len(list(L)) # long time (2 s)
 2171
 }}}


---

Comment by bhutz created at 2018-06-08 10:01:49

Changing the height bound is not quite what I meant. It sounds like this is an instance of getting the points in L' which are supposed to be within tolerance of the height

abs(H_k(x) - B) < tolerance

If you need to move the bound to 50.1, then these points are outside of the specified tolerance when bound=50. Since we have to do some conversion between relative and absolute heights. Perhaps the issue is that tolerance must also undergo a similar 'conversion'?


---

Comment by raghukul01 created at 2018-06-08 10:45:22

Sorry, my comment was quite confusing,

What I meant was if we change the bound to 50.1 or even to 50.02 (current default of tolerance is 0.01), and use algorithm-3 we get correct output (2171). If we use bound 50 in algorithm-4 we get 2171 as the output.

So it was a case of missing points.

Which conversion are you suggesting? we are dealing with relative heights here, right?


---

Comment by bhutz created at 2018-06-08 13:57:40

The point I'm making is that we shouldn't be seeing if we can adjust the parameters to gt the 'right' answer, but rather see which is the right answer for the parameters in the doctest.

The difference are the eight points which all have height

50.0163488242872

so, if the tolerance is specified as 0.01 with a bound of 50, then these points should not be returned. In other words, that would be a failure in the tolerance.

Actually, it looks like the number_field.py function has default tolerance 0.2, which makes the new output correct, however, the other function (bdd_height) has default tolerance 0.01.  I would say maybe to make the default tolerance in all of these functions the same (perhaps the 0.01).


---

Comment by raghukul01 created at 2018-06-08 14:37:25

Yes sir, I got your point, but before changing there is one issue.

What should be the ideal value of tolerance, in earlier testing 0.01 was good enough, but as in this example height can be very close to tolerance (0.01634..). My suggestion is still to use 0.01, what are your views on that?


---

Comment by bhutz created at 2018-06-08 14:39:06

I'm fine with 0.01. More important than the default value is that tolerance does what is claims it does (find all points within tolerance of the specified bound).


---

Comment by git created at 2018-06-08 15:50:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-06-08 23:14:00

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-08 23:14:00

I get doctest failures in affine_homset and affine_rational_points.


Additionally, in my testing tolerance is not behaving as described. In other words you can get points that do not satisfy |H(P) - B| < tol.  However, these points are always points that are above the specified height bound, so I do not think is concerning. However, the documentation should be updated accordingly.


---

Comment by git created at 2018-06-09 12:36:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-09 12:38:46

Doc test were failing due to incorrect calculation of relative height, which was corrected in earlier commit. I have changes the bound accordingly, keeping existing bound would have taken very long time for the tests.


---

Comment by raghukul01 created at 2018-06-09 13:04:17

Sir,
For the documentation update I am planning to modify the current warning of algorithm 3 result (`In the current implementation, the output of the [Doyle-Krumm] algorithm cannot be guaranteed to be correct due to the necessity of floating point computations. In some cases, the default 53-bit precision is considerably lower than would be required for the algorithm to generate correct output.`) to what you are suggesting that there might me some points for which `H(p) > B + tolerance`, does this seem right?

BTW can you share those tests? 

thanks in advance!


---

Comment by bhutz created at 2018-06-09 13:16:58

I'm not sure it requires a warning block as it does return all of the points up to the bound and decreasing the tolerance does get you exactly the points up to that bound. The part that I am finding inaccurate is the precise relationship between tolerance and those extra points. Clarifying that there are floating point issues and you may get extra points which can be 'corrected' by lowering the tolerance in enough.


---

Comment by raghukul01 created at 2018-06-09 13:24:33

Okay so should this comment be made only in bdd_height? or every place where bdd_height is called indirectly?


---

Comment by git created at 2018-06-09 13:49:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-09 13:51:39

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-09 13:51:39

updated doctests and docstrings


---

Comment by bhutz created at 2018-06-10 18:10:48

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-10 18:10:48

I'm ok with the vague description of lowering tolerance, except that I would not just say extra, but rather points larger than the specified bound.

However, there are still a number of documentation issues surrounding tolerance that I had missed earlier.

- bdd_height still claims that all points satisfy |H(P) - B| < tol. Which is what I am finding to be not accurate.

- elements_of_bounded_height still lists the old warning

- there is no way to specify tolerance or precision in the places affine objects call enum_number_field

- there is no way specify tolerance in the places projective objects call enum_number_field

- The statements about what algorithm is used etc, should be also be in the indirect call places as well. (these are actually more likely to be used by the user).


---

Comment by bhutz created at 2018-06-10 20:18:06

btw, this is a situation where I'd be tempted to switch the affine.rational_points/.points and projective.rational_points/.points functions to *kwds since which keywords are needed dependents on which situation/algorithm is being used.


---

Comment by git created at 2018-06-11 17:17:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-11 17:31:02

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-11 18:22:18

Here is a suggestion for updating the docs. Please look over for typos.

Also there are still a couple functionality things:
kwds needed so tolerance, precision can be specified if needed

- affine homeset needs *kwds 

- product projective needs *kwds

- projective homset needs *kwds

need to remember to run doctests before pushing...

```
sage -t --warn-long 63.5 product_projective/homset.py  # 1 doctest failed
sage -t --warn-long 63.5 product_projective/space.py  # 2 doctests failed
```

----
New commits:


---

Comment by bhutz created at 2018-06-11 18:22:18

Changing status from needs_review to needs_work.


---

Comment by raghukul01 created at 2018-06-14 18:11:24

New commits:


---

Comment by raghukul01 created at 2018-06-14 18:11:24

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-19 14:15:41

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-19 14:15:41

algorithm 5 is spelled wrong evertywhere

in affine homset: dimension zero line in docs. this doesn't work for rings, so you probably mean: whether the field is infinite or not.


---

Comment by git created at 2018-06-19 23:32:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-19 23:34:10

added suggested changes


---

Comment by raghukul01 created at 2018-06-19 23:34:10

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-20 00:59:23

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-20 00:59:23

from ptestlong looks like the same set of failures from we got in #23627


```
sage -t --long --warn-long 66.7 src/sage/graphs/generators/smallgraphs.py  # 3 doctests failed
sage -t --long --warn-long 66.7 src/sage/coding/linear_code.py  # 109 doctests failed
sage -t --long --warn-long 66.7 src/sage/coding/codecan/autgroup_can_label.pyx  # 55 doctests failed
sage -t --long --warn-long 66.7 src/sage/coding/codecan/codecan.pyx  # 41 doctests failed
sage -t --long --warn-long 66.7 src/sage/coding/code_constructions.py  # 3 doctests failed
sage -t --long --warn-long 66.7 src/doc/en/constructions/linear_codes.rst  # 13 doctests failed
sage -t --long --warn-long 66.7 src/sage/coding/hamming_code.py  # 1 doctest failed
sage -t --long --warn-long 66.7 src/sage/tests/books/judson-abstract-algebra/algcodes-sage.py  # 9 doctests failed
```



---

Comment by git created at 2018-06-20 10:58:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-20 10:59:54

Corrected the line in hamming_code.py


---

Comment by raghukul01 created at 2018-06-20 10:59:54

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-20 16:18:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-21 17:26:25

Resolution: fixed
