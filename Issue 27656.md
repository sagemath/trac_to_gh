# Issue 27656: Coercion bug with mpz

Issue created by migration from https://trac.sagemath.org/ticket/27893

Original creator: mkoeppe

Original creation time: 2019-05-30 04:37:48

CC:  vdelecroix vklein

While porting some code from `sage.libs.ppl` to `pplpy`, I encountered the following.

```
sage: K.<f> = QQ[]
sage: 1.__mpz__() * f
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: There is a BUG in the coercion model:
                Action found for R <built-in function mul> S does not have the correct domains
                R = Set of Python objects of class 'mpz'
                S = Univariate Polynomial Ring in f over Rational Field
                (should be Integer Ring, Univariate Polynomial Ring in f over Rational Field)
                action = Left scalar multiplication by Integer Ring on Univariate Polynomial Ring in f over Rational Field (<type 'sage.categories.action.PrecomposedAction'>)
```



---

Comment by vklein created at 2019-06-03 14:10:12

It looks likes updating coerce.parent_is_integers fix the bug.

```
diff --git a/src/sage/structure/coerce.pyx b/src/sage/structure/coerce.pyx
index 456c526..ddbb8de 100644
--- a/src/sage/structure/coerce.pyx
+++ b/src/sage/structure/coerce.pyx
@@ -345,6 +345,8 @@ cpdef bint parent_is_integers(P) except -1:
         elif is_numpy_type(P):
             from numpy import integer
             return issubclass(P, integer)
+        elif issubclass(P, gmpy2.mpz):
+            return True
         else:
             return False
```

I will do some more tests before proposing a fix.


---

Comment by vklein created at 2019-06-03 14:58:09

New commits:


---

Comment by vklein created at 2019-06-03 14:58:09

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-06-03 15:17:10

Seems to have forgotten a linebreak here

```
+    Ensure (:trac:`27893`) is fixed::
+        sage: K.<f> = QQ[]
```



---

Comment by vdelecroix created at 2019-06-03 15:25:28

BTW, why the gmpy2 module is not cimported in `coerce.pyx`?

```diff
--- a/src/sage/structure/coerce.pyx
+++ b/src/sage/structure/coerce.pyx
@@ -80,7 +80,7 @@ from cpython.object cimport (PyObject, PyTypeObject,
         Py_EQ, Py_NE, Py_LT, Py_LE, Py_GT, Py_GE)
 from cpython.weakref cimport PyWeakref_GET_OBJECT, PyWeakref_NewRef
 from libc.string cimport strncmp
-import gmpy2
+cimport gmpy2
 
 cdef add, mul, truediv
 from operator import add, mul, truediv
```



---

Comment by git created at 2019-06-03 15:30:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-06-04 05:19:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-06-06 22:26:44

Resolution: fixed
