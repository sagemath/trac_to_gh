# Issue 17047: Fix command-line plotting keywords

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-11-04 07:31:06

CC:  vbraun kcrisman strogdon

This should open a Tachyon-rendered plot (and this worked until very recently):

```
sage: cube(viewer="tachyon")
```


The following still works:

```
sage: cube(viewer="tachyon").show()
```



---

Comment by kcrisman created at 2014-11-04 14:38:14

Yeah, I think that was more or less the previous code, huh?  But would it break showing graphics correctly in sagenb or ipynb?


---

Comment by strogdon created at 2014-11-04 16:49:50

This does work here from the command line. The notebook also seems OK. However, the ipynb seems to be malfunctioning. The default in ipynb is Tachyon, i.e. `cube()` returns a Tachyon rendered image. And `cube(viewer='jmol')` also returns a Tachyon image. `cube().show(viewer='jmol')` does return a jmol rendered image in the jmol viewer.


---

Comment by vbraun created at 2014-11-04 17:59:31

IPython notebook doesn't support 3d plots yet.


---

Comment by strogdon created at 2014-11-04 18:07:24

I may be mistaken but on a previous trying of the IPython notebook (when I can't remember) something like `cube()` would spawn the external jmol viewer, which is not the case now.


---

Comment by vbraun created at 2014-11-04 18:12:35

True, but neither is the desired outcome


---

Comment by vbraun created at 2014-11-04 20:23:07

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-11-04 20:23:07

New commits:


---

Comment by kcrisman created at 2014-11-04 20:38:51

I can't test it out immediately because I don't have time to compile up to rc1 right now, but this seems okay.  

Only one question - there are other viewers (e.g. canvas3d) available in the notebook, so I assume this code will only be reached in the command line?  Currently we get, in the command line,

```

sage: cube().show(viewer='canvas3d')
---------------------------------------------------------------------------
<snip>
UnboundLocalError: local variable 'viewer_app' referenced before assignment
```

which isn't all that helpful either, I have to admit.


---

Comment by vbraun created at 2014-11-04 21:10:31

This shouldn't change anything on SageNB.

Other viewers are not supported on the command line, nothing changed there:

```
sage: cube(viewer='canvas3d')
/home/vbraun/Sage/git-develop/local/lib/python2.7/site-packages/sage/repl/display/formatter.py:380: UserWarning: viewer=canvas3d is not supported
  gfx = obj._graphics_()
```

Really, the issue is the code quality in the 3d plots. Everything and their dog is lumped in a giant `show()` method with tons of if-branches, behaving slightly different depending on some global variables. I'll break all that up into separate methods in #17234.


---

Comment by jdemeyer created at 2014-11-04 21:39:25

Why do we reinvent the `show()` wheel inside `_graphics_()`?


---

Comment by jdemeyer created at 2014-11-04 21:44:42

In other words, what's wrong with:

```
def _graphics_(self, **kwds):
    self.show(**kwds)
```


Even if there is something wrong with the above, perhaps the right solution is to fix `show()` instead of inventing a new function `_graphics_` doing mostly the same.


---

Comment by jdemeyer created at 2014-11-04 22:04:09

Replying to [comment:9 kcrisman]:
> Currently we get, in the command line,
> {{{
> 
> sage: cube().show(viewer='canvas3d')
> ---------------------------------------------------------------------------
> <snip>
> UnboundLocalError: local variable 'viewer_app' referenced before assignment
> }}}

This is fixed in #16640 by raising a better error message.


---

Comment by vbraun created at 2014-11-04 22:18:45

`_graphics_` only handles finding the appropriate output. The actual generation of graphics files is dispatched elsewhere. And no global variables allowed. 

Everything is wrong with `show`, its a giant pile of shite. I'm slowly refactoring it into something maintainable if we have 3+ separate output channels.


---

Comment by jdemeyer created at 2014-11-04 22:42:12

Replying to [comment:14 vbraun]:
> `_graphics_` only handles finding the appropriate output. The actual generation of graphics files is dispatched elsewhere. And no global variables allowed. 
> 
> Everything is wrong with `show`, its a giant pile of shite. I'm slowly refactoring it into something maintainable if we have 3+ separate output channels.
If your solution is to _move_ stuff from `show` to somewhere else, I agree. Just don't "fix" `show` by re-inventing its functionality.

(I have seen the following too often: X is broken. Instead of fixing X, somebody invents Y which is similar to X but with other bugs)


---

Comment by vbraun created at 2014-11-04 23:27:06

The whole premise of using a handful of global variables to steer the output pipeline is IMHO utter crap. It didn't work well when we had a single Notebook, and it sure as hell is a nightmare if we want to deal with 3 different notebooks at the same time. There needs to be some infrastructure to arbitrate between backend capabilities and user preferences. But I sure as hell don't want to reinvent how `show()` works, I'm getting PTSD whenever I look in there.


---

Comment by strogdon created at 2014-11-04 23:55:52

Is this the intended behavior? From the notebook

```
sphere(viewer='java')
}}}       	

{{{
/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-package\
s/IPython/core/formatters.py:239: FormatterWarning: Exception in
text/plain formatter: Unknown 3d plot type: java
  FormatterWarning,
None
}}}

with no output, which is what I would expect. But from the Sage prompt

{{{
/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sage/repl/display/formatter.py:380: UserWarning: viewer=java is not supported
  gfx = obj._graphics_()
}}}

and the jmol viewer is spawned. And if `sphere(viewer='java')` is typed again there is no warning and the jmol viewer is spawned.


---

Comment by jdemeyer created at 2014-11-05 07:13:48

Replying to [comment:16 vbraun]:
> The whole premise of using a handful of global variables to steer the output pipeline is IMHO utter crap. It didn't work well when we had a single Notebook, and it sure as hell is a nightmare if we want to deal with 3 different notebooks at the same time.
I never said that `show()` was good, I'm just warning: don't make it worse! IMHO, the introduction of `_graphics_` _did_ make things worse but maybe that's just a local minimum.


---

Comment by vbraun created at 2014-11-05 10:14:17

Had I tacked on the IPython notebook with yet another global variable and extra if branches then it would have caused bugs, too...


---

Comment by vbraun created at 2014-11-05 10:16:49

Replying to [comment:17 strogdon]:
> Is this the intended behavior? From the notebook
> {{{
> sphere(viewer='java')
> /64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-package\
> s/IPython/core/formatters.py:239: FormatterWarning: Exception in
> text/plain formatter: Unknown 3d plot type: java
>   FormatterWarning,
> None
> }}}

As far as I'm concerned, this is the regrettable state of current affairs but not really on-topic for this ticket. Sphere should validate input when the graphics object is created, not fall flat on its face later on when it is about to be drawn.


---

Comment by kcrisman created at 2014-11-05 13:09:01

Two comments that hopefully will keep us on target:
> Is this the intended behavior? From the notebook `sphere(viewer='java')` ...
No, but I think this was already the case earlier, although the error messages probably will have changed.  We can't necessarily validate EVERY input, as I've been told when I've attempted to on many other tickets... incidentally, there is the `java3d` viewer or something like it, but again that only works (actually, doesn't, there is a ticket for that too) in the notebook.
> Why do we reinvent the show() wheel inside _graphics_()?  <and that discussion>
This is a noble goal and I totally agree that the 3d graphics show code is miserable due to accretion of layers over the years, but I think it probably isn't really worth the effort to fix that _right now_ because it will be pretty hard to test for all possible bugs easily.  On the other hand, putting something like that in an early beta someday when there aren't actual bugs to fix seems fine.

It's also worth pointing out that one reason that is so messy is because the actual creation of most plots is viewer-agnostic, which was deemed to be "a good thing" by TBDFL.


---

Comment by vbraun created at 2014-11-05 13:14:26

Creation of plots should of course be viewer-agnostic. The problem is that the modularity stops there and drops into a monolithic if-branch thicket (that is moreover hard to test). There are more modular problems here, like creating the rendering / viewer files, what to do with the output files, arbitrating capabilities versus user preferences.


---

Comment by gagern created at 2014-11-05 13:15:31

I guess you already know the following; I'm just posting for the sake of completeness. The commit which caused the originally reported problem, i.e. opening JMOL instead of a PNG viewer, was caused by commit [e7e7f9c](http://git.sagemath.org/sage.git/commit/?id=e7e7f9ce036343c4eb414434c93265461f3bced5) by Volker. Which is not surprising in hindsight: it changed the `_graphics_` implementation from `self.show()` to something which does `self.save(filename)` with a JMOL file unless some different `mime_types` gets passed. Which is exactly the location Volker's current branch here is tweaking.


---

Comment by kcrisman created at 2014-11-05 13:37:12

> I guess you already know the following; I'm just posting for the sake of completeness. 
Thanks for confirming this.

If you have already tried this and are satisfied with the code and behavior, feel free to put positive review - I haven't been able to upgrade Sage to the right place yet.


---

Comment by vbraun created at 2014-11-05 14:21:36

Replying to [comment:23 gagern]:
> The commit which caused the originally reported problem, i.e. opening JMOL instead of a PNG viewer, was caused by commit [e7e7f9c](http://git.sagemath.org/sage.git/commit/?id=e7e7f9ce036343c4eb414434c93265461f3bced5) by Volker.

Which is also precisely why the current `show()` is such a pile of shit: virtually no meaningful doctests, any time you touch something it is almost guaranteed to cause an error somewhere.


---

Comment by kcrisman created at 2014-11-05 14:31:26

> > The commit which caused the originally reported problem, i.e. opening JMOL instead of a PNG viewer, was caused by commit [e7e7f9c](http://git.sagemath.org/sage.git/commit/?id=e7e7f9ce036343c4eb414434c93265461f3bced5) by Volker.
> 
> Which is also precisely why the current `show()` is such a pile of ****: virtually no meaningful doctests, any time you touch something it is almost guaranteed to cause an error somewhere.

True, though that _still_ might not make dealing with it worth the while as compared to other things one could spend time on.  That's why I always visually tested output when I reviewed changes in things related to it, though probably one would want to do so in any case - esp. given that we can't do like mpl and have pre-existing files to test against, at least I don't think so.


---

Comment by jdemeyer created at 2014-11-05 14:44:36

Replying to [comment:26 kcrisman]:
> given that we can't do like mpl and have pre-existing files to test against, at least I don't think so.
We could in theory hash the resulting PNG file and check that in a doctest. However, I don't know how workable that would be in practice.


---

Comment by vbraun created at 2014-11-05 14:48:46

Apart from testing that the output pipeline ends in the place we thought it ends, we should also compare with the resulting rastered image (though was not what I was talking about previously). We can't do pixel comparisons because that might depend on rounding, installed fonts, and/or freetype version. The classical algorithm for that is to break up your picture in a grid (say, 10x10) and compare the color histogram in each sector with a small tolerance.


---

Comment by kcrisman created at 2014-11-05 17:00:51

> This shouldn't change anything on SageNB.
Yup, looks good there now that I had a chance, and this does indeed fix the previous problem.


---

Comment by kcrisman created at 2014-11-06 14:46:08

Since several people have commented here, I'm reluctant to be the final one to set to positive review.  But FWIW I don't hear any complaints about the code itself, just that Sage and show need help and that some undesirable behavior that isn't documented is or isn't still happening.  But the issue at hand seems to be fixed.


---

Comment by vbraun created at 2014-11-09 12:19:38

Can somebody grow a pair and set this to positive review already?


---

Comment by fbissey created at 2014-11-10 23:31:18

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2014-11-10 23:31:18

I think all the people commenting here didn't really have a problem with the code, since you don't want to push the button yourself Volker I'll do it on behalf of all those commentators.


---

Comment by vbraun created at 2014-11-11 17:00:07

Resolution: fixed
