# Issue 14486: Useless memory allocation in listing neighbors of a graph

Issue created by migration from https://trac.sagemath.org/ticket/14690

Original creator: vdelecroix

Original creation time: 2013-06-05 11:48:19

Assignee: jason, ncohen, rlm

CC:  ncohen

Keywords: sparse graph, allocation

This patch exist because I am an idiot. I reviewed #14659 and did not notice that the creation of the list of neighbors actually allocates an array! So #14659 only solve half of the problem.

The patch here remediate to the problem by adding an attribute `up` for the node of the binary tree (`SparseGraphBTNode`) that allows to do depth first search without storing anything.


---

Comment by vdelecroix created at 2013-06-05 11:52:10

The patch is not yet finished but at least, with it applied, I can build the `PetersonGraph` and `random_stress` does not complain ;-)

I would like some comments before going further.


---

Comment by vdelecroix created at 2013-06-05 11:52:10

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2013-06-05 17:15:21

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2013-06-05 17:15:21

Replying to [comment:1 vdelecroix]:
> The patch is not yet finished but at least, with it applied, I can build the `PetersonGraph` and `random_stress` does not complain ;-)
> 
> I would like some comments before going further.

The code to remove an edge does not work (`del_arc_unsafe`). I have to check it more carefully before asking somebody else to review the patch.


---

Comment by vdelecroix created at 2013-06-06 10:02:55

Changing status from needs_work to needs_review.


---

Attachment

All right! After one morning: at least no more memory corruption. I added many comments and documentation in order to be able to reread it later.

Many (~20) doctests now fail in `sage.graphs`. For some of them is just a matter of the output ordering but for some others it is quite a mystery...


---

Comment by ncohen created at 2013-06-06 10:19:57

Well, if doctests fails how can this patch be waiting for a review `O_o`

By the way, why do you use `sys.stdout.write/flush` instead of `print` ?

Nathan


---

Comment by vdelecroix created at 2013-06-06 10:34:27

Replying to [comment:4 ncohen]:
> Well, if doctests fails how can this patch be waiting for a review `O_o`

Because I am not used enough with the code of graphs to see if I break something or if something was broken. I am 90% sure of what I have done for `SparseGraph` and all test passes on `sage.graphs.base.sparse_graph`.

Needs review for me means that I want that somebody crazy enough spend some time on looking at it.

> By the way, why do you use `sys.stdout.write/flush` instead of `print` ?

All of them are in comments! The reason is because I want to use flush (print puts the text in the cache not on the screen). If your program crashes few lines after a print then you do not see anything.


---

Comment by vdelecroix created at 2013-06-06 12:58:53

All right, I found one concrete problem. With the patch applied

```
sage: edges = [(1,4),(7,16),(9,11),(11,8),(12,6),(14,5),(5,8),(15,4),(4,10),
....:          (10,6),(6,3),(3,8),(8,16),(16,13),(13,0),(0,2),(2,17)]
sage: G1 = Graph(); G2 = Graph()
sage: G1.add_vertices(range(18))
sage: for e in edges:
....:     G1.add_edge(e); G2.add_edge(e)
```

Now `G1` and `G2` should be the same graph but `G1` is completely bugged

```
sage: G1.has_edge(13,16)
True
sage: (13,16) in G1.edges(labels=False)
False
```

while it works for `G2`

```
sage: G2.has_edge(13,16)
True
sage: (13,16) in G2.edges(labels=False)
True
```



---

Comment by vdelecroix created at 2013-06-06 12:58:53

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2014-04-22 14:50:58

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-04-22 21:34:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-04-22 22:08:46

Resolution: invalid
