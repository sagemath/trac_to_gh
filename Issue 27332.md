# Issue 27332: Unicode issue with modular polynomials database

archive/issues_027332.json:
```json
{
    "body": "\n```\nsage: MP = AtkinModularPolynomialDatabase()\nsage: MP[3]\n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-29-920f2702531e> in <module>()\n----> 1 MP[Integer(3)]\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in __getitem__(self, level)\n    156                 raise TypeError(\"Argument level (= %s) must be prime.\"%N)\n    157         modpol = self._dbpath(level)\n--> 158         coeff_list = _dbz_to_integer_list(modpol)\n    159         if self.model == \"Cls\":\n    160             P = PolynomialRing(IntegerRing(),2,\"j\")\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_integer_list(name)\n     65     \"\"\"\n     66     from sage.rings.integer import Integer\n---> 67     data = _dbz_to_string(name)\n     68     return [[Integer(v) for v in row.strip().split(\" \")]\n     69             for row in data.split(\"\\n\")[:-1]]\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_string(name)\n     41         raise LookupError(\"filename {} does not exist\".format(filename))\n     42 \n---> 43     data = bz2.decompress(f.read())\n     44 \n     45     return data\n\n/home/kedlaya/sage/local/lib/python3.6/codecs.py in decode(self, input, final)\n    319         # decode input (taking the buffer into account)\n    320         data = self.buffer + input\n--> 321         (result, consumed) = self._buffer_decode(data, self.errors, final)\n    322         # keep undecoded input until the next call\n    323         self.buffer = data[consumed:]\n\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0x90 in position 13: invalid start byte\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27569\n\n",
    "created_at": "2019-03-30T01:28:55Z",
    "labels": [
        "component: modular forms"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Unicode issue with modular polynomials database",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27332",
    "user": "https://github.com/kedlaya"
}
```

```
sage: MP = AtkinModularPolynomialDatabase()
sage: MP[3]
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-29-920f2702531e> in <module>()
----> 1 MP[Integer(3)]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in __getitem__(self, level)
    156                 raise TypeError("Argument level (= %s) must be prime."%N)
    157         modpol = self._dbpath(level)
--> 158         coeff_list = _dbz_to_integer_list(modpol)
    159         if self.model == "Cls":
    160             P = PolynomialRing(IntegerRing(),2,"j")

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_integer_list(name)
     65     """
     66     from sage.rings.integer import Integer
---> 67     data = _dbz_to_string(name)
     68     return [[Integer(v) for v in row.strip().split(" ")]
     69             for row in data.split("\n")[:-1]]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_string(name)
     41         raise LookupError("filename {} does not exist".format(filename))
     42 
---> 43     data = bz2.decompress(f.read())
     44 
     45     return data

/home/kedlaya/sage/local/lib/python3.6/codecs.py in decode(self, input, final)
    319         # decode input (taking the buffer into account)
    320         data = self.buffer + input
--> 321         (result, consumed) = self._buffer_decode(data, self.errors, final)
    322         # keep undecoded input until the next call
    323         self.buffer = data[consumed:]

UnicodeDecodeError: 'utf-8' codec can't decode byte 0x90 in position 13: invalid start byte
```


Issue created by migration from https://trac.sagemath.org/ticket/27569





---

archive/issue_comments_384870.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-03-30T01:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384870",
    "user": "https://github.com/kedlaya"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_384871.json:
```json
{
    "body": "Guessing this is a Py3 issue?",
    "created_at": "2019-03-30T01:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384871",
    "user": "https://github.com/kedlaya"
}
```

Guessing this is a Py3 issue?



---

archive/issue_comments_384872.json:
```json
{
    "body": "here is a tentative of fix, plus some pep8 cleanup in the modified file\n----\nNew commits:",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384872",
    "user": "https://github.com/fchapoton"
}
```

here is a tentative of fix, plus some pep8 cleanup in the modified file
----
New commits:



---

archive/issue_comments_384873.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384873",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_384874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-30T12:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-30T15:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384876.json:
```json
{
    "body": "This does fix the issue on my end. But what is going on with the patchbot failures?",
    "created_at": "2019-03-31T14:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384876",
    "user": "https://github.com/kedlaya"
}
```

This does fix the issue on my end. But what is going on with the patchbot failures?



---

archive/issue_comments_384877.json:
```json
{
    "body": "patchbot looks green enough to me",
    "created_at": "2019-04-04T13:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384877",
    "user": "https://github.com/fchapoton"
}
```

patchbot looks green enough to me



---

archive/issue_comments_384878.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-04T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384878",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_384879.json:
```json
{
    "body": "OK then!",
    "created_at": "2019-04-04T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384879",
    "user": "https://github.com/kedlaya"
}
```

OK then!



---

archive/issue_comments_384880.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-05T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27332#issuecomment-384880",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_025367.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-04-05T20:51:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27332",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27332#event-25367"
}
```
