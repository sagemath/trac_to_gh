# Issue 27332: Unicode issue with modular polynomials database

Issue created by migration from https://trac.sagemath.org/ticket/27569

Original creator: kedlaya

Original creation time: 2019-03-30 01:28:55


```
sage: MP = AtkinModularPolynomialDatabase()
sage: MP[3]
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-29-920f2702531e> in <module>()
----> 1 MP[Integer(3)]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in __getitem__(self, level)
    156                 raise TypeError("Argument level (= %s) must be prime."%N)
    157         modpol = self._dbpath(level)
--> 158         coeff_list = _dbz_to_integer_list(modpol)
    159         if self.model == "Cls":
    160             P = PolynomialRing(IntegerRing(),2,"j")

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_integer_list(name)
     65     """
     66     from sage.rings.integer import Integer
---> 67     data = _dbz_to_string(name)
     68     return [[Integer(v) for v in row.strip().split(" ")]
     69             for row in data.split("\n")[:-1]]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_string(name)
     41         raise LookupError("filename {} does not exist".format(filename))
     42 
---> 43     data = bz2.decompress(f.read())
     44 
     45     return data

/home/kedlaya/sage/local/lib/python3.6/codecs.py in decode(self, input, final)
    319         # decode input (taking the buffer into account)
    320         data = self.buffer + input
--> 321         (result, consumed) = self._buffer_decode(data, self.errors, final)
    322         # keep undecoded input until the next call
    323         self.buffer = data[consumed:]

UnicodeDecodeError: 'utf-8' codec can't decode byte 0x90 in position 13: invalid start byte
```



---

Comment by kedlaya created at 2019-03-30 01:29:07

Changing type from PLEASE CHANGE to defect.


---

Comment by kedlaya created at 2019-03-30 01:30:02

Guessing this is a Py3 issue?


---

Comment by chapoton created at 2019-03-30 11:39:35

here is a tentative of fix, plus some pep8 cleanup in the modified file
----
New commits:


---

Comment by chapoton created at 2019-03-30 11:39:35

Changing status from new to needs_review.


---

Comment by git created at 2019-03-30 12:19:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-30 15:14:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-03-31 14:13:49

This does fix the issue on my end. But what is going on with the patchbot failures?


---

Comment by chapoton created at 2019-04-04 13:33:53

patchbot looks green enough to me


---

Comment by kedlaya created at 2019-04-04 13:35:37

Changing status from needs_review to positive_review.


---

Comment by kedlaya created at 2019-04-04 13:35:37

OK then!


---

Comment by vbraun created at 2019-04-05 20:51:39

Resolution: fixed
