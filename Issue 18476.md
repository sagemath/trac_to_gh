# Issue 18476: cannot feed cached function to Matrix

Issue created by migration from https://trac.sagemath.org/ticket/18713

Original creator: rws

Original creation time: 2015-06-16 14:28:25

From http://ask.sagemath.org/question/27111/why-can-matrix-not-use-cached-functions/

```
sage: @cached_function
....: def L(n,k):
....:         if n==k: return 1
....:         if k<0 or k>n: return 0
....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)
....: 
sage: matrix(ZZ, 8, L)
...
ValueError: Invalid matrix constructor.  Type matrix? for help
```



---

Comment by rws created at 2015-06-16 14:45:59

Changing status from new to needs_review.


---

Comment by rws created at 2015-06-16 14:45:59

New commits:


---

Comment by tscrim created at 2015-06-16 16:45:31

Trivial doctest failure (via the patchbot):

```
File "src/sage/misc/sageinspect.py", line 1959, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    sage_getsourcelines(matrix)[1]
Expected:
    732
Got:
    745
```

Once fixed, you can set a positive review on my behalf.


---

Comment by nbruin created at 2015-06-16 16:50:20

The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?

I don't think so, actually. The comment itself says "callable" and then the check is for particular types, rather than checking if the thing is callable.

I would say:
 - restructure, giving preference to checking the passed in argument being iterable. Possibly special-case some iterables like lists and tuples for efficiency if necessary (and if that makes a difference -- I doubt it.
 - check for a callable *later*. You can check using `callable(...)`.

I don't know what we should do with objects that are both iterable and callable. I suspect that giving preference to their iterable behaviour will be best.


---

Comment by jdemeyer created at 2015-06-16 20:21:15

Small detail: do not use

```
# :trac:`10158`
```

in code.

Also, instead of

```
    sage: @cached_function # :trac:`18713`
```

you could write

```
Check that the matrix constructor works with any callable input (see :trac:`18713`)::

    sage: @cached_function
```



---

Comment by jdemeyer created at 2015-06-16 20:21:15

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-10-20 08:19:57

Replying to [comment:4 nbruin]:
> The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?

It is in that all symbolic expressions are callable, i.e., they return itself when called with no arguments (which IMHO makes sense) and they try substitution when given arguments (which will hopefully soon raise an exception with #14270 but my hope is fading). So, instead of having special cases of callables your solution needs to exclude those symbolic expressions that are not `Function`s.


---

Comment by rws created at 2015-10-20 08:37:30

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-10-20 08:37:30

New commits:


---

Comment by git created at 2015-10-20 13:04:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-06-13 08:11:21

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-01-16 09:04:28

New commits:


---

Comment by rws created at 2017-01-16 09:04:28

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-03-01 14:36:18

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-01 14:36:18

Why are you adding an `import numpy`?


---

Comment by jdemeyer created at 2017-03-01 14:37:32

Why this?

```
not (isinstance(arg, Expression) and not isinstance(arg, Function))):
```



---

Comment by jdemeyer created at 2017-03-01 14:41:04

If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).


---

Comment by jdemeyer created at 2017-03-01 14:44:22

I don't understand `of_other_type`. Can you try a positive description (i.e. saying what it ''is
_ instead of what it _is not''). Like `is_iterable`. And then a minor optimization: in Cython, use `cdef bint` for booleans.

Or perhaps you can get rid of `if of_other_type` completely and replace it with something like `if entries is None`.


---

Comment by jdemeyer created at 2017-03-01 14:48:10

Some minor details:

1. Start exception messages with lower case: `raise ValueError("When passing...` -> `raise ValueError("when passing...`

2. The indentation looks strange here:

```diff
+            except TypeError:
+            # not iterable      <--------
+                from sage.symbolic.expression import Expression
+                from sage.symbolic.function import Function
+                if (callable(arg)
+                and not (isinstance(arg, Expression)          <--------
+                        and not isinstance(arg, Function))):  <--------
```

and here also:

```diff
+    The matrix constructor works with any callable input (see :trac:`18713`)::
+
+        sage: @cached_function
+        ....: def L(n,k):
+        ....:         if n==k: return 1                    <---------
+        ....:         if k<0 or k>n: return 0              <---------
+        ....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)   <---------
```



---

Comment by git created at 2017-04-14 06:39:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-04-14 06:41:34

Replying to [comment:15 jdemeyer]:
> If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).

Because it's really over my head atm.


---

Comment by rws created at 2017-04-14 06:41:34

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-04-22 02:41:46

Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:

```
sage: R = GF(9, 'a')
sage: m = matrix(3, 3, R)
sage: m
[      0       a   a + 1]
[2*a + 1       2     2*a]
[2*a + 2   a + 2       1]
```

I would like a doctest for this.


---

Comment by tscrim created at 2017-04-22 02:42:44

Jeroen or Ralf, what other iterables would not (necessarily) be handled by the current branch?


---

Comment by rws created at 2017-04-22 05:04:17

Replying to [comment:20 tscrim]:
> Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:
> {{{
> sage: R = GF(9, 'a')
> sage: m = matrix(3, 3, R)
> sage: m
> [      0       a   a + 1]
> [2*a + 1       2     2*a]
> [2*a + 2   a + 2       1]
> }}}

It does not (same error as with develop). Should it?


---

Comment by tscrim created at 2017-04-22 05:59:01

Well, technically, because it is a callable. Yet, it should be treated as an iterator in this case. So since it errors out in the same way, I think it is okay for now.


---

Comment by tscrim created at 2017-05-21 01:47:23

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-05-21 01:47:23

Doctest failures (see patchbot):

```
sage -t --long src/sage/matrix/matrix_symbolic_dense.pyx  # 4 doctests failed
```



---

Comment by rws created at 2017-08-24 05:46:33

Yes, any `Expression` is also a `callable` but we don't want to call it. This breaks the whole elaborate logic.
