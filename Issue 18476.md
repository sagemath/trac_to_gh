# Issue 18476: cannot feed cached function to Matrix

archive/issues_018476.json:
```json
{
    "body": "From http://ask.sagemath.org/question/27111/why-can-matrix-not-use-cached-functions/\n\n```\nsage: @cached_function\n....: def L(n,k):\n....:         if n==k: return 1\n....:         if k<0 or k>n: return 0\n....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)\n....: \nsage: matrix(ZZ, 8, L)\n...\nValueError: Invalid matrix constructor.  Type matrix? for help\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18713\n\n",
    "created_at": "2015-06-16T14:28:25Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "title": "cannot feed cached function to Matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18476",
    "user": "rws"
}
```
From http://ask.sagemath.org/question/27111/why-can-matrix-not-use-cached-functions/

```
sage: @cached_function
....: def L(n,k):
....:         if n==k: return 1
....:         if k<0 or k>n: return 0
....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)
....: 
sage: matrix(ZZ, 8, L)
...
ValueError: Invalid matrix constructor.  Type matrix? for help
```


Issue created by migration from https://trac.sagemath.org/ticket/18713





---

archive/issue_comments_251121.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-16T14:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251121",
    "user": "rws"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_251122.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-06-16T14:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251122",
    "user": "rws"
}
```

New commits:



---

archive/issue_comments_251123.json:
```json
{
    "body": "Trivial doctest failure (via the patchbot):\n\n```\nFile \"src/sage/misc/sageinspect.py\", line 1959, in sage.misc.sageinspect.sage_getsourcelines\nFailed example:\n    sage_getsourcelines(matrix)[1]\nExpected:\n    732\nGot:\n    745\n```\n\nOnce fixed, you can set a positive review on my behalf.",
    "created_at": "2015-06-16T16:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251123",
    "user": "tscrim"
}
```

Trivial doctest failure (via the patchbot):

```
File "src/sage/misc/sageinspect.py", line 1959, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    sage_getsourcelines(matrix)[1]
Expected:
    732
Got:
    745
```

Once fixed, you can set a positive review on my behalf.



---

archive/issue_comments_251124.json:
```json
{
    "body": "The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?\n\nI don't think so, actually. The comment itself says \"callable\" and then the check is for particular types, rather than checking if the thing is callable.\n\nI would say:\n- restructure, giving preference to checking the passed in argument being iterable. Possibly special-case some iterables like lists and tuples for efficiency if necessary (and if that makes a difference -- I doubt it.\n- check for a callable *later*. You can check using `callable(...)`.\n\nI don't know what we should do with objects that are both iterable and callable. I suspect that giving preference to their iterable behaviour will be best.",
    "created_at": "2015-06-16T16:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251124",
    "user": "nbruin"
}
```

The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?

I don't think so, actually. The comment itself says "callable" and then the check is for particular types, rather than checking if the thing is callable.

I would say:
- restructure, giving preference to checking the passed in argument being iterable. Possibly special-case some iterables like lists and tuples for efficiency if necessary (and if that makes a difference -- I doubt it.
- check for a callable *later*. You can check using `callable(...)`.

I don't know what we should do with objects that are both iterable and callable. I suspect that giving preference to their iterable behaviour will be best.



---

archive/issue_comments_251125.json:
```json
{
    "body": "Small detail: do not use\n\n```\n# :trac:`10158`\n```\n\nin code.\n\nAlso, instead of\n\n```\n    sage: @cached_function # :trac:`18713`\n```\n\nyou could write\n\n```\nCheck that the matrix constructor works with any callable input (see :trac:`18713`)::\n\n    sage: @cached_function\n```\n",
    "created_at": "2015-06-16T20:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251125",
    "user": "jdemeyer"
}
```

Small detail: do not use

```
# :trac:`10158`
```

in code.

Also, instead of

```
    sage: @cached_function # :trac:`18713`
```

you could write

```
Check that the matrix constructor works with any callable input (see :trac:`18713`)::

    sage: @cached_function
```




---

archive/issue_comments_251126.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-16T20:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251126",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_251127.json:
```json
{
    "body": "Replying to [comment:4 nbruin]:\n> The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?\n\nIt is in that all symbolic expressions are callable, i.e., they return itself when called with no arguments (which IMHO makes sense) and they try substitution when given arguments (which will hopefully soon raise an exception with #14270 but my hope is fading). So, instead of having special cases of callables your solution needs to exclude those symbolic expressions that are not `Function`s.",
    "created_at": "2015-10-20T08:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251127",
    "user": "rws"
}
```

Replying to [comment:4 nbruin]:
> The proposed fix mends the reported problem, and no more. However, shouldn't there be certain behaviour for the matrix constructor if it gets passed a *callable* object? or is that too broad?

It is in that all symbolic expressions are callable, i.e., they return itself when called with no arguments (which IMHO makes sense) and they try substitution when given arguments (which will hopefully soon raise an exception with #14270 but my hope is fading). So, instead of having special cases of callables your solution needs to exclude those symbolic expressions that are not `Function`s.



---

archive/issue_comments_251128.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-10-20T08:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251128",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_251129.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-10-20T08:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251129",
    "user": "rws"
}
```

New commits:



---

archive/issue_comments_251130.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-20T13:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251130",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_251131.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-13T08:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251131",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_251132.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-01-16T09:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251132",
    "user": "rws"
}
```

New commits:



---

archive/issue_comments_251133.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-16T09:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251133",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_251134.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-01T14:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251134",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_251135.json:
```json
{
    "body": "Why are you adding an `import numpy`?",
    "created_at": "2017-03-01T14:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251135",
    "user": "jdemeyer"
}
```

Why are you adding an `import numpy`?



---

archive/issue_comments_251136.json:
```json
{
    "body": "Why this?\n\n```\nnot (isinstance(arg, Expression) and not isinstance(arg, Function))):\n```\n",
    "created_at": "2017-03-01T14:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251136",
    "user": "jdemeyer"
}
```

Why this?

```
not (isinstance(arg, Expression) and not isinstance(arg, Function))):
```




---

archive/issue_comments_251137.json:
```json
{
    "body": "If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).",
    "created_at": "2017-03-01T14:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251137",
    "user": "jdemeyer"
}
```

If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).



---

archive/issue_comments_251138.json:
```json
{
    "body": "I don't understand `of_other_type`. Can you try a positive description (i.e. saying what it ''is\n* instead of what it *is not''). Like `is_iterable`. And then a minor optimization: in Cython, use `cdef bint` for booleans.\n\nOr perhaps you can get rid of `if of_other_type` completely and replace it with something like `if entries is None`.",
    "created_at": "2017-03-01T14:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251138",
    "user": "jdemeyer"
}
```

I don't understand `of_other_type`. Can you try a positive description (i.e. saying what it ''is
* instead of what it *is not''). Like `is_iterable`. And then a minor optimization: in Cython, use `cdef bint` for booleans.

Or perhaps you can get rid of `if of_other_type` completely and replace it with something like `if entries is None`.



---

archive/issue_comments_251139.json:
```json
{
    "body": "Some minor details:\n\n1. Start exception messages with lower case: `raise ValueError(\"When passing...` -> `raise ValueError(\"when passing...`\n\n2. The indentation looks strange here:\n\n```diff\n+            except TypeError:\n+            # not iterable      <--------\n+                from sage.symbolic.expression import Expression\n+                from sage.symbolic.function import Function\n+                if (callable(arg)\n+                and not (isinstance(arg, Expression)          <--------\n+                        and not isinstance(arg, Function))):  <--------\n```\n\nand here also:\n\n```diff\n+    The matrix constructor works with any callable input (see :trac:`18713`)::\n+\n+        sage: @cached_function\n+        ....: def L(n,k):\n+        ....:         if n==k: return 1                    <---------\n+        ....:         if k<0 or k>n: return 0              <---------\n+        ....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)   <---------\n```\n",
    "created_at": "2017-03-01T14:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251139",
    "user": "jdemeyer"
}
```

Some minor details:

1. Start exception messages with lower case: `raise ValueError("When passing...` -> `raise ValueError("when passing...`

2. The indentation looks strange here:

```diff
+            except TypeError:
+            # not iterable      <--------
+                from sage.symbolic.expression import Expression
+                from sage.symbolic.function import Function
+                if (callable(arg)
+                and not (isinstance(arg, Expression)          <--------
+                        and not isinstance(arg, Function))):  <--------
```

and here also:

```diff
+    The matrix constructor works with any callable input (see :trac:`18713`)::
+
+        sage: @cached_function
+        ....: def L(n,k):
+        ....:         if n==k: return 1                    <---------
+        ....:         if k<0 or k>n: return 0              <---------
+        ....:         return L(n-1,k-1)+(n+k-1)*L(n-1,k)   <---------
```




---

archive/issue_comments_251140.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-14T06:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251140",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_251141.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).\n\nBecause it's really over my head atm.",
    "created_at": "2017-04-14T06:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251141",
    "user": "rws"
}
```

Replying to [comment:15 jdemeyer]:
> If you are allowing any kind of callable, why not allowing any kind of iterable too (it's a valid question since you are making changes to the code for iterables).

Because it's really over my head atm.



---

archive/issue_comments_251142.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-14T06:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251142",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_251143.json:
```json
{
    "body": "Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:\n\n```\nsage: R = GF(9, 'a')\nsage: m = matrix(3, 3, R)\nsage: m\n[      0       a   a + 1]\n[2*a + 1       2     2*a]\n[2*a + 2   a + 2       1]\n```\n\nI would like a doctest for this.",
    "created_at": "2017-04-22T02:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251143",
    "user": "tscrim"
}
```

Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:

```
sage: R = GF(9, 'a')
sage: m = matrix(3, 3, R)
sage: m
[      0       a   a + 1]
[2*a + 1       2     2*a]
[2*a + 2   a + 2       1]
```

I would like a doctest for this.



---

archive/issue_comments_251144.json:
```json
{
    "body": "Jeroen or Ralf, what other iterables would not (necessarily) be handled by the current branch?",
    "created_at": "2017-04-22T02:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251144",
    "user": "tscrim"
}
```

Jeroen or Ralf, what other iterables would not (necessarily) be handled by the current branch?



---

archive/issue_comments_251145.json:
```json
{
    "body": "Replying to [comment:20 tscrim]:\n> Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:\n> {{{\n> sage: R = GF(9, 'a')\n> sage: m = matrix(3, 3, R)\n> sage: m\n> [      0       a   a + 1]\n> [2*a + 1       2     2*a]\n> [2*a + 2   a + 2       1]\n> }}}\n\nIt does not (same error as with develop). Should it?",
    "created_at": "2017-04-22T05:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251145",
    "user": "rws"
}
```

Replying to [comment:20 tscrim]:
> Did you test this against something that is callable and iterable, such as a parent that is a finite set? It seems like the iterable behavior takes precedent, but it is not clear from the code that this is correct. For example, does this now work:
> {{{
> sage: R = GF(9, 'a')
> sage: m = matrix(3, 3, R)
> sage: m
> [      0       a   a + 1]
> [2*a + 1       2     2*a]
> [2*a + 2   a + 2       1]
> }}}

It does not (same error as with develop). Should it?



---

archive/issue_comments_251146.json:
```json
{
    "body": "Well, technically, because it is a callable. Yet, it should be treated as an iterator in this case. So since it errors out in the same way, I think it is okay for now.",
    "created_at": "2017-04-22T05:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251146",
    "user": "tscrim"
}
```

Well, technically, because it is a callable. Yet, it should be treated as an iterator in this case. So since it errors out in the same way, I think it is okay for now.



---

archive/issue_comments_251147.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-21T01:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251147",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_251148.json:
```json
{
    "body": "Doctest failures (see patchbot):\n\n```\nsage -t --long src/sage/matrix/matrix_symbolic_dense.pyx  # 4 doctests failed\n```\n",
    "created_at": "2017-05-21T01:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251148",
    "user": "tscrim"
}
```

Doctest failures (see patchbot):

```
sage -t --long src/sage/matrix/matrix_symbolic_dense.pyx  # 4 doctests failed
```




---

archive/issue_comments_251149.json:
```json
{
    "body": "Yes, any `Expression` is also a `callable` but we don't want to call it. This breaks the whole elaborate logic.",
    "created_at": "2017-08-24T05:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18476#issuecomment-251149",
    "user": "rws"
}
```

Yes, any `Expression` is also a `callable` but we don't want to call it. This breaks the whole elaborate logic.
