# Issue 13183: Plot fails if a function implicitly needs complex intermediate values

Issue created by migration from Trac.

Original creator: tkluck

Original creation time: 2012-08-09 12:36:16

Assignee: burcin

CC:  kcrisman eviatarbach

Keywords: needs-review

Plotting currently fails when plotting a symbolic function that evaluates to complex values:


```
sage: def evalf_func(self,x,parent):
....:     return parent(I*x)
....: 
sage: f = function('f', evalf_func=evalf_func)
sage: plot(abs(f(x)),0,5)
verbose 0 (2392: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.
verbose 0 (2392: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
```


This is because `plot` uses `fast_float`, and `fast_float` cannot deal with the intermediate complex value.

The attached patch first changes these things:

 * it adds a method to `class Function` that allows one to see what output range is to be expected for a given input range. By default, it will return a complex field.
 * it overrides this method for builtin functions, which return floats for float input
 * this is then used by `fast_float` to throw an exception if complex values are to be expected

This exception will cause `plot` to fall back to `fast_callable` instead of `fast_float`. However, `fast_callable` needs patching too:

 * it now uses the `_evalf_` method when available instead of just `__call__`. Otherwise, `plot` will try to coerce the result to `float`, which also cannot deal with complex intermediate values.

An alternative to this step would be to fix `float` coercion, which I haven't looked into.


---

Attachment


---

Comment by tkluck created at 2012-08-09 12:37:08

Changing status from new to needs_review.


---

Comment by tkluck created at 2012-08-09 13:22:28

There's some issues with the patch as it is, please wait with reviewing.


---

Comment by tkluck created at 2012-08-09 13:22:28

Changing status from needs_review to needs_work.


---

Comment by tkluck created at 2012-08-09 14:12:59

Changing status from needs_work to needs_review.


---

Attachment

The _002.patch solves the issues I mentioned. Setting status back to "needs review".


---

Comment by tkluck created at 2012-08-09 14:58:11

Added an attachment containing the two patches together, with a proper filename containing the trac number.


---

Comment by chapoton created at 2013-05-24 09:38:17

for the bot:

apply trac_13355_plot_with_complex_intermediates.patch


---

Comment by chapoton created at 2013-05-24 17:21:11

one failing doctest, see bot report


---

Comment by chapoton created at 2013-05-24 17:21:11

Changing status from needs_review to needs_work.


---

Attachment

This should fix the doctest problem.

Apply trac_13355_plot_with_complex_intermediates.patch


---

Comment by tkluck created at 2013-07-02 11:29:30

Changing keywords from "needs-review" to "".


---

Comment by tkluck created at 2013-07-02 11:29:30

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2013-07-09 06:55:14

Hello,

I don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function? Could you be more explicit about the problem you intend to solve ? What kind of picture you would like to obtain with such input?

Note that for that purpose, there is yet `complex_plot`

```
{{{
sage: def evalf_func(self,x,parent=None):
....:     return parent(I*x) if parent!=None else I*x
....: 
sage: f = function('f', evalf_func=evalf_func)
sage: complex_plot(f, (-1,1), (-1,1)).show()
}}}


---

Comment by tkluck created at 2013-07-09 07:38:51

Thanks for looking at this!

Replying to [comment:9 vdelecroix]:
> I don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function?

My example was

```
sage: plot(abs(f(x)),0,5)
```

Note the `abs`.

Now the point is that

```
sage: abs(f(3))
abs(f(3))
sage: float(abs(f(3)))
3.0
```

both work, but plotting doesn't:

```
plot(abs(f(x)),x,0,10)
verbose 0 (2430: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.
verbose 0 (2430: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
```

The reason is that there is an optimization to use `fast_callable` for calculating plot points. The current implementation assumes that all intermediate values are floats, whereas we can still make a real plot when the argument to abs is complex. This patch should fix that.

Is this any clearer? It would be great if you could test/review the patch!


---

Comment by vdelecroix created at 2013-07-09 07:46:50

Replying to [comment:10 tkluck]:
> Is this any clearer?

I see. Sorry for my too fast lecture and thanks for the clarification!

> It would be great if you could test/review the patch!

It was my intention ;-)


---

Comment by eviatarbach created at 2013-08-16 00:58:37

#15030 fixes the same issue in a different (and I think simpler) way. I tried your example and it works with the #15030 patch as well.

I also think this is a significant issue; you can't even plot functions like `abs(log(x))` properly. tkluck, it would be great if you could look at my patch and if you think it's a better solution review it.


---

Comment by rws created at 2014-04-03 09:14:10

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-04-21 13:36:24

Note that #15030 was apparently merged.

Also, anyone know how this impacts 3d plots?


---

Comment by rws created at 2014-04-21 13:41:18

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-04-21 16:04:43

One thing that could be done here is if there are any significant/useful examples on this ticket that weren't added in #15030, they could be added here...


---

Comment by rws created at 2014-05-13 14:11:47

Changing keywords from "" to "evalf, fast_callable".


---

Comment by rws created at 2014-05-13 14:11:47

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-05-13 14:11:47

I have extracted the doctests from the patch and changed the description accordingly. However, some doctests fail.

```
sage -t --long src/sage/ext/fast_callable.pyx
**********************************************************************
File "src/sage/ext/fast_callable.pyx", line 397, in sage.ext.fast_callable.?
Failed example:
    fc(3,4)
Expected:
    12
Got:
    f(3, 4)
**********************************************************************
File "src/sage/ext/fast_callable.pyx", line 405, in sage.ext.fast_callable.?
Failed example:
    fc(3,4)
Expected:
    12*I
Got:
    g(3, 4)
**********************************************************************
1 item had failures:
   2 of  47 in sage.ext.fast_callable.?
    [586 tests, 2 failures, 3.54 s]
----------------------------------------------------------------------
sage -t --long src/sage/ext/fast_callable.pyx  # 2 doctests failed
----------------------------------------------------------------------
```

----
New commits:


---

Comment by kcrisman created at 2014-05-13 14:47:20

Hmm, these doctests look strange to me anyway.

```
parent!=None
```

should be 

```
parent is not None
```

I think.  The failures are actually probably features, not bugs, since `f` and `g` are symbolic functions, which are now not automatically evaluated, if that makes sense...


---

Comment by rws created at 2014-05-15 06:49:45

Yes. So change the doctests or abandon them?


---

Comment by kcrisman created at 2014-05-15 13:07:22

If you agree that this is proper behavior, then we might as well change them.  Also, the plot one is definitely useful.


---

Comment by git created at 2014-05-15 13:31:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-15 13:45:18

Changing status from needs_work to positive_review.


---

Comment by rws created at 2014-05-15 13:45:18

But then, somehow we want `12` or `12*I` as a result too, but for this the function needs a `simplify()` member like `hypergeometric` (#2516) has.


---

Comment by vbraun created at 2014-05-15 17:18:30

Resolution: fixed
