# Issue 13183: Plot fails if a function implicitly needs complex intermediate values

archive/issues_013183.json:
```json
{
    "body": "Assignee: burcin\n\nCC:  kcrisman eviatarbach\n\nKeywords: needs-review\n\nPlotting currently fails when plotting a symbolic function that evaluates to complex values:\n\n\n```\nsage: def evalf_func(self,x,parent):\n....:     return parent(I*x)\n....: \nsage: f = function('f', evalf_func=evalf_func)\nsage: plot(abs(f(x)),0,5)\nverbose 0 (2392: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.\nverbose 0 (2392: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'\n```\n\n\nThis is because `plot` uses `fast_float`, and `fast_float` cannot deal with the intermediate complex value.\n\nThe attached patch first changes these things:\n\n* it adds a method to `class Function` that allows one to see what output range is to be expected for a given input range. By default, it will return a complex field.\n* it overrides this method for builtin functions, which return floats for float input\n* this is then used by `fast_float` to throw an exception if complex values are to be expected\n\nThis exception will cause `plot` to fall back to `fast_callable` instead of `fast_float`. However, `fast_callable` needs patching too:\n\n* it now uses the `_evalf_` method when available instead of just `__call__`. Otherwise, `plot` will try to coerce the result to `float`, which also cannot deal with complex intermediate values.\n\nAn alternative to this step would be to fix `float` coercion, which I haven't looked into.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13355\n\n",
    "created_at": "2012-08-09T12:36:16Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "Plot fails if a function implicitly needs complex intermediate values",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13183",
    "user": "tkluck"
}
```
Assignee: burcin

CC:  kcrisman eviatarbach

Keywords: needs-review

Plotting currently fails when plotting a symbolic function that evaluates to complex values:


```
sage: def evalf_func(self,x,parent):
....:     return parent(I*x)
....: 
sage: f = function('f', evalf_func=evalf_func)
sage: plot(abs(f(x)),0,5)
verbose 0 (2392: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.
verbose 0 (2392: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
```


This is because `plot` uses `fast_float`, and `fast_float` cannot deal with the intermediate complex value.

The attached patch first changes these things:

* it adds a method to `class Function` that allows one to see what output range is to be expected for a given input range. By default, it will return a complex field.
* it overrides this method for builtin functions, which return floats for float input
* this is then used by `fast_float` to throw an exception if complex values are to be expected

This exception will cause `plot` to fall back to `fast_callable` instead of `fast_float`. However, `fast_callable` needs patching too:

* it now uses the `_evalf_` method when available instead of just `__call__`. Otherwise, `plot` will try to coerce the result to `float`, which also cannot deal with complex intermediate values.

An alternative to this step would be to fix `float` coercion, which I haven't looked into.

Issue created by migration from https://trac.sagemath.org/ticket/13355





---

archive/issue_comments_160936.json:
```json
{
    "body": "Attachment",
    "created_at": "2012-08-09T12:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160936",
    "user": "tkluck"
}
```

Attachment



---

archive/issue_comments_160937.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-09T12:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160937",
    "user": "tkluck"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160938.json:
```json
{
    "body": "There's some issues with the patch as it is, please wait with reviewing.",
    "created_at": "2012-08-09T13:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160938",
    "user": "tkluck"
}
```

There's some issues with the patch as it is, please wait with reviewing.



---

archive/issue_comments_160939.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-08-09T13:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160939",
    "user": "tkluck"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160940.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-08-09T14:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160940",
    "user": "tkluck"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160941.json:
```json
{
    "body": "Attachment\n\nThe _002.patch solves the issues I mentioned. Setting status back to \"needs review\".",
    "created_at": "2012-08-09T14:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160941",
    "user": "tkluck"
}
```

Attachment

The _002.patch solves the issues I mentioned. Setting status back to "needs review".



---

archive/issue_comments_160942.json:
```json
{
    "body": "Added an attachment containing the two patches together, with a proper filename containing the trac number.",
    "created_at": "2012-08-09T14:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160942",
    "user": "tkluck"
}
```

Added an attachment containing the two patches together, with a proper filename containing the trac number.



---

archive/issue_comments_160943.json:
```json
{
    "body": "for the bot:\n\napply trac_13355_plot_with_complex_intermediates.patch",
    "created_at": "2013-05-24T09:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160943",
    "user": "chapoton"
}
```

for the bot:

apply trac_13355_plot_with_complex_intermediates.patch



---

archive/issue_comments_160944.json:
```json
{
    "body": "one failing doctest, see bot report",
    "created_at": "2013-05-24T17:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160944",
    "user": "chapoton"
}
```

one failing doctest, see bot report



---

archive/issue_comments_160945.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-05-24T17:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160945",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160946.json:
```json
{
    "body": "Attachment\n\nThis should fix the doctest problem.\n\nApply trac_13355_plot_with_complex_intermediates.patch",
    "created_at": "2013-07-02T11:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160946",
    "user": "tkluck"
}
```

Attachment

This should fix the doctest problem.

Apply trac_13355_plot_with_complex_intermediates.patch



---

archive/issue_comments_160947.json:
```json
{
    "body": "Changing keywords from \"needs-review\" to \"\".",
    "created_at": "2013-07-02T11:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160947",
    "user": "tkluck"
}
```

Changing keywords from "needs-review" to "".



---

archive/issue_comments_160948.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-02T11:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160948",
    "user": "tkluck"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160949.json:
```json
{
    "body": "Hello,\n\nI don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function? Could you be more explicit about the problem you intend to solve ? What kind of picture you would like to obtain with such input?\n\nNote that for that purpose, there is yet `complex_plot`\n\n```\n{{{\nsage: def evalf_func(self,x,parent=None):\n....:     return parent(I*x) if parent!=None else I*x\n....: \nsage: f = function('f', evalf_func=evalf_func)\nsage: complex_plot(f, (-1,1), (-1,1)).show()\n}}}",
    "created_at": "2013-07-09T06:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160949",
    "user": "vdelecroix"
}
```

Hello,

I don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function? Could you be more explicit about the problem you intend to solve ? What kind of picture you would like to obtain with such input?

Note that for that purpose, there is yet `complex_plot`

```
{{{
sage: def evalf_func(self,x,parent=None):
....:     return parent(I*x) if parent!=None else I*x
....: 
sage: f = function('f', evalf_func=evalf_func)
sage: complex_plot(f, (-1,1), (-1,1)).show()
}}}



---

archive/issue_comments_160950.json:
```json
{
    "body": "Thanks for looking at this!\n\nReplying to [comment:9 vdelecroix]:\n> I don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function?\n\nMy example was\n\n```\nsage: plot(abs(f(x)),0,5)\n```\n\nNote the `abs`.\n\nNow the point is that\n\n```\nsage: abs(f(3))\nabs(f(3))\nsage: float(abs(f(3)))\n3.0\n```\n\nboth work, but plotting doesn't:\n\n```\nplot(abs(f(x)),x,0,10)\nverbose 0 (2430: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.\nverbose 0 (2430: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'\n```\n\nThe reason is that there is an optimization to use `fast_callable` for calculating plot points. The current implementation assumes that all intermediate values are floats, whereas we can still make a real plot when the argument to abs is complex. This patch should fix that.\n\nIs this any clearer? It would be great if you could test/review the patch!",
    "created_at": "2013-07-09T07:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160950",
    "user": "tkluck"
}
```

Thanks for looking at this!

Replying to [comment:9 vdelecroix]:
> I don't understand your example. You define `f` to take complex values, how do you want to plot it as a real function?

My example was

```
sage: plot(abs(f(x)),0,5)
```

Note the `abs`.

Now the point is that

```
sage: abs(f(3))
abs(f(3))
sage: float(abs(f(3)))
3.0
```

both work, but plotting doesn't:

```
plot(abs(f(x)),x,0,10)
verbose 0 (2430: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 199 points.
verbose 0 (2430: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
```

The reason is that there is an optimization to use `fast_callable` for calculating plot points. The current implementation assumes that all intermediate values are floats, whereas we can still make a real plot when the argument to abs is complex. This patch should fix that.

Is this any clearer? It would be great if you could test/review the patch!



---

archive/issue_comments_160951.json:
```json
{
    "body": "Replying to [comment:10 tkluck]:\n> Is this any clearer?\n\nI see. Sorry for my too fast lecture and thanks for the clarification!\n\n> It would be great if you could test/review the patch!\n\nIt was my intention ;-)",
    "created_at": "2013-07-09T07:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160951",
    "user": "vdelecroix"
}
```

Replying to [comment:10 tkluck]:
> Is this any clearer?

I see. Sorry for my too fast lecture and thanks for the clarification!

> It would be great if you could test/review the patch!

It was my intention ;-)



---

archive/issue_comments_160952.json:
```json
{
    "body": "#15030 fixes the same issue in a different (and I think simpler) way. I tried your example and it works with the #15030 patch as well.\n\nI also think this is a significant issue; you can't even plot functions like `abs(log(x))` properly. tkluck, it would be great if you could look at my patch and if you think it's a better solution review it.",
    "created_at": "2013-08-16T00:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160952",
    "user": "eviatarbach"
}
```

#15030 fixes the same issue in a different (and I think simpler) way. I tried your example and it works with the #15030 patch as well.

I also think this is a significant issue; you can't even plot functions like `abs(log(x))` properly. tkluck, it would be great if you could look at my patch and if you think it's a better solution review it.



---

archive/issue_comments_160953.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-04-03T09:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160953",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160954.json:
```json
{
    "body": "Note that #15030 was apparently merged.\n\nAlso, anyone know how this impacts 3d plots?",
    "created_at": "2014-04-21T13:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160954",
    "user": "kcrisman"
}
```

Note that #15030 was apparently merged.

Also, anyone know how this impacts 3d plots?



---

archive/issue_comments_160955.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-04-21T13:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160955",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160956.json:
```json
{
    "body": "One thing that could be done here is if there are any significant/useful examples on this ticket that weren't added in #15030, they could be added here...",
    "created_at": "2014-04-21T16:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160956",
    "user": "kcrisman"
}
```

One thing that could be done here is if there are any significant/useful examples on this ticket that weren't added in #15030, they could be added here...



---

archive/issue_comments_160957.json:
```json
{
    "body": "Changing keywords from \"\" to \"evalf, fast_callable\".",
    "created_at": "2014-05-13T14:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160957",
    "user": "rws"
}
```

Changing keywords from "" to "evalf, fast_callable".



---

archive/issue_comments_160958.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-13T14:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160958",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160959.json:
```json
{
    "body": "I have extracted the doctests from the patch and changed the description accordingly. However, some doctests fail.\n\n```\nsage -t --long src/sage/ext/fast_callable.pyx\n**********************************************************************\nFile \"src/sage/ext/fast_callable.pyx\", line 397, in sage.ext.fast_callable.?\nFailed example:\n    fc(3,4)\nExpected:\n    12\nGot:\n    f(3, 4)\n**********************************************************************\nFile \"src/sage/ext/fast_callable.pyx\", line 405, in sage.ext.fast_callable.?\nFailed example:\n    fc(3,4)\nExpected:\n    12*I\nGot:\n    g(3, 4)\n**********************************************************************\n1 item had failures:\n   2 of  47 in sage.ext.fast_callable.?\n    [586 tests, 2 failures, 3.54 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/ext/fast_callable.pyx  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\n----\nNew commits:",
    "created_at": "2014-05-13T14:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160959",
    "user": "rws"
}
```

I have extracted the doctests from the patch and changed the description accordingly. However, some doctests fail.

```
sage -t --long src/sage/ext/fast_callable.pyx
**********************************************************************
File "src/sage/ext/fast_callable.pyx", line 397, in sage.ext.fast_callable.?
Failed example:
    fc(3,4)
Expected:
    12
Got:
    f(3, 4)
**********************************************************************
File "src/sage/ext/fast_callable.pyx", line 405, in sage.ext.fast_callable.?
Failed example:
    fc(3,4)
Expected:
    12*I
Got:
    g(3, 4)
**********************************************************************
1 item had failures:
   2 of  47 in sage.ext.fast_callable.?
    [586 tests, 2 failures, 3.54 s]
----------------------------------------------------------------------
sage -t --long src/sage/ext/fast_callable.pyx  # 2 doctests failed
----------------------------------------------------------------------
```

----
New commits:



---

archive/issue_comments_160960.json:
```json
{
    "body": "Hmm, these doctests look strange to me anyway.\n\n```\nparent!=None\n```\n\nshould be \n\n```\nparent is not None\n```\n\nI think.  The failures are actually probably features, not bugs, since `f` and `g` are symbolic functions, which are now not automatically evaluated, if that makes sense...",
    "created_at": "2014-05-13T14:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160960",
    "user": "kcrisman"
}
```

Hmm, these doctests look strange to me anyway.

```
parent!=None
```

should be 

```
parent is not None
```

I think.  The failures are actually probably features, not bugs, since `f` and `g` are symbolic functions, which are now not automatically evaluated, if that makes sense...



---

archive/issue_comments_160961.json:
```json
{
    "body": "Yes. So change the doctests or abandon them?",
    "created_at": "2014-05-15T06:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160961",
    "user": "rws"
}
```

Yes. So change the doctests or abandon them?



---

archive/issue_comments_160962.json:
```json
{
    "body": "If you agree that this is proper behavior, then we might as well change them.  Also, the plot one is definitely useful.",
    "created_at": "2014-05-15T13:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160962",
    "user": "kcrisman"
}
```

If you agree that this is proper behavior, then we might as well change them.  Also, the plot one is definitely useful.



---

archive/issue_comments_160963.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-15T13:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160963",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_160964.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-05-15T13:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160964",
    "user": "rws"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_160965.json:
```json
{
    "body": "But then, somehow we want `12` or `12*I` as a result too, but for this the function needs a `simplify()` member like `hypergeometric` (#2516) has.",
    "created_at": "2014-05-15T13:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160965",
    "user": "rws"
}
```

But then, somehow we want `12` or `12*I` as a result too, but for this the function needs a `simplify()` member like `hypergeometric` (#2516) has.



---

archive/issue_comments_160966.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-15T17:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13183#issuecomment-160966",
    "user": "vbraun"
}
```

Resolution: fixed
