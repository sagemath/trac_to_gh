# Issue 31311: Create matrix class for FLINT's nmod_mat module

Issue created by migration from https://trac.sagemath.org/ticket/31548

Original creator: roed

Original creation time: 2021-03-24 15:54:33

CC:  edgarcosta




---

Comment by git created at 2021-03-24 16:08:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 18:28:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 19:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 19:45:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 19:47:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 19:49:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-25 16:41:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-26 17:17:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-27 02:13:38

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-03-29 21:17:39

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-30 17:51:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-07 07:05:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-08 21:05:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-13 17:56:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-16 19:04:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-16 22:25:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-20 07:40:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-04-20 07:41:27

Changing status from new to needs_review.


---

Comment by roed created at 2021-04-20 07:41:27

Marking for patchbot to test....


---

Comment by git created at 2021-04-22 19:47:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-04-23 01:40:23

If you aren't yet ready for comments, I apologize. However, I made a quick skim over things before I realized you set this as needs review for the patchbot.

For `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.

I know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. I would also add

```
cdef list X
cdef Py_ssize_t n
```

change

```diff
-            X = self.matrix_space(B.ncols(), self.ncols())(X)
-            return X.T
+            return self.matrix_space(B.ncols(), self.ncols())(X).T
```

(perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.

I am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.

Why is `poly_crt` in the matrix file?

`can't` -> `cannot` as we want to make the writing formal.

It would be good to implement a `get_is_zero_unsafe` method.


---

Comment by roed created at 2021-04-23 02:08:16

No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.

Do you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?

The `poly_crt` function is left over from an earlier implementation of `charpoly` or `minpoly` (I forget which).  I will take care of it.

Thanks!


---

Comment by tscrim created at 2021-04-23 02:16:31

Replying to [comment:23 roed]:
> No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.

Yea, I didn't quite realize that either. ^^;;

> Do you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?

The former for the name of the file, the latter for the name of the class considering the other matrix classes in Sage.

Let me know if there is anything I can do to help too.


---

Comment by git created at 2021-04-26 18:11:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-04-26 19:01:24

Replying to [comment:22 tscrim]:
> For `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.

Even for a 2 by 2 matrix where the calling overhead is most substantial, changing to `cpdef` makes a negligible difference:

```
sage: A = random_matrix(Zmod(120), 2)                                                                                                               
sage: A                                                                                                                                             
[ 32 108]
[  2 112]
sage: %time B = A._change_implementation("linbox") # using def                                                                                                
CPU times: user 339 µs, sys: 8 µs, total: 347 µs
Wall time: 350 µs
```


```
sage: A = random_matrix(Zmod(120), 2) # using cpdef                                                                                                                                                                                                                       
sage: %time B = A._change_implementation("linbox")                                                                                                                                                                                                            
CPU times: user 334 µs, sys: 5 µs, total: 339 µs
Wall time: 343 µs
```

I don't think it's worth the cost of recompiling everything depending on `matrix0.pxd`, and the risk of developers accidentally using `def` instead of `cpdef` on a matrix class in the future.

I agree about sparse matrices, but currently in `sage.matrix.matrix_space.get_matrix_class` we don't allow the `implementation` keyword for sparse matrices, so the issue is moot.  I'd be happy to have more sparse matrices in Sage eventually, but for now there's no way to even test a version of `_change_implementation` in `Matrix_sparse`.

I'm not sure what you mean by using `sage.matrix.matrix_space.MatrixSpace` unstable.  Do you mean switching to `from sage.matrix.matrix_space import MatrixSpace`?  I was just copying what's done a couple dozen lines above in `matrix2.pyx`, but I'm happy to make this change if desired.
> 
> I know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. 

Agreed.  I've added them.

> I would also add
> {{{
> cdef list X
> cdef Py_ssize_t n
> }}}
> change
> {{{#!diff
> -            X = self.matrix_space(B.ncols(), self.ncols())(X)
> -            return X.T
> +            return self.matrix_space(B.ncols(), self.ncols())(X).T
> }}}
> (perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.

I've added the `cdef Py_ssize_t n` since that can speed up the loop, and made the change you suggested in the diff.  I don't think it's necessary to mark `X` as a list or `B` as a matrix, since I'm not calling any functions that will benefit from knowing the types (and the runtime is surely dominated by the call to Pari's `matsolvemod`)

> I am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.

Agreed.  I've changed it to `matrix_modn_dense_flint`.

> Why is `poly_crt` in the matrix file?

I've created #31731 and removed it from this ticket.

> `can't` -> `cannot` as we want to make the writing formal.
> 
> It would be good to implement a `get_is_zero_unsafe` method.

Both done.


---

Comment by roed created at 2021-04-26 19:11:33

All tests pass in `matrix modules rings modular crypto`.  I'm happy to run tests on all of Sage if people are happy with the changes in principle.


---

Comment by git created at 2021-04-26 19:40:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2021-04-26 19:42:15

(I accidentally made a comment instead of editing the ticket description)
----
New commits:


---

Comment by roed created at 2021-04-26 19:43:01

This ticket is now actually ready for review, though the patchbot won't run currently (since it depends on #31069 which changes spkgs).


---

Comment by tscrim created at 2021-06-24 23:20:47

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2021-06-24 23:20:47

Needs rebase.


---

Comment by git created at 2021-06-25 15:37:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
