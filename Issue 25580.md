# Issue 25580: RuntimeError: Encountered operator mismatch in maxima-to-sr translation, integrate

Issue created by migration from Trac.

Original creator: @nasser1

Original creation time: 2018-07-10 15:26:12

CC:  tscrim vklein jhpalmieri

Keywords: integrate

I do not know if this is known or not. If it is, feel free to close.



```
>sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.3.rc0, Release Date: 2018-07-08                 │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: var('x')
x
sage: integrate(log(e^x*log(x)*sin(x))/x^2, x)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-ee0ac2fd3190> in <module>()
----> 1 integrate(log(e**x*log(x)*sin(x))/x**Integer(2), x)

/usr/lib/python2.7/site-packages/sage/misc/functional.py in integral(x, *args, **kwds)
    751     """
    752     if hasattr(x, 'integral'):
--> 753         return x.integral(*args, **kwds)
    754     else:
    755         from sage.symbolic.ring import SR

/usr/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:69761)()
  12364                     R = ring.SR
  12365             return R(integral(f, v, a, b, **kwds))
> 12366         return integral(self, *args, **kwds)
  12367 
  12368     integrate = integral

/usr/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)
    816         return integrator(expression, v, a, b)
    817     if a is None:
--> 818         return indefinite_integral(expression, v, hold=hold)
    819     else:
    820         return definite_integral(expression, v, a, b, hold=hold)

/usr/lib/python2.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:11921)()
    996             res = self._evalf_try_(*args)
    997             if res is None:
--> 998                 res = super(BuiltinFunction, self).__call__(
    999                         *args, coerce=coerce, hold=hold)
   1000 

/usr/lib/python2.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6948)()
    490                     (<Expression>args[0])._gobj, hold)
    491         elif self._nargs == 2:
--> 492             res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
    493                     (<Expression>args[1])._gobj, hold)
    494         elif self._nargs == 3:

/usr/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x)
     88         for integrator in self.integrators:
     89             try:
---> 90                 return integrator(f, x)
     91             except NotImplementedError:
     92                 pass

/usr/lib/python2.7/site-packages/sage/symbolic/integration/external.py in maxima_integrator(expression, v, a, b)
     30         expression = SR(expression)
     31     if a is None:
---> 32         result = maxima.sr_integral(expression,v)
     33     else:
     34         result = maxima.sr_integral(expression, v, a, b)

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in sr_integral(self, *args)
    803         """
    804         try:
--> 805             return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))
    806         except RuntimeError as error:
    807             s = str(error)

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1697             op=max_op_dict[op_max]
   1698         max_args=cdr(expr)
-> 1699         args=[max_to_sr(a) for a in max_args]
   1700         return op(*args)
   1701     elif expr.symbolp():

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1697             op=max_op_dict[op_max]
   1698         max_args=cdr(expr)
-> 1699         args=[max_to_sr(a) for a in max_args]
   1700         return op(*args)
   1701     elif expr.symbolp():

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1697             op=max_op_dict[op_max]
   1698         max_args=cdr(expr)
-> 1699         args=[max_to_sr(a) for a in max_args]
   1700         return op(*args)
   1701     elif expr.symbolp():

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1697             op=max_op_dict[op_max]
   1698         max_args=cdr(expr)
-> 1699         args=[max_to_sr(a) for a in max_args]
   1700         return op(*args)
   1701     elif expr.symbolp():

/usr/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1691                 op=sage_expr.operator()
   1692             if op in sage_op_dict:
-> 1693                 raise RuntimeError("Encountered operator mismatch in maxima-to-sr translation")
   1694             max_op_dict[op_max]=op
   1695             sage_op_dict[op]=op_max

RuntimeError: Encountered operator mismatch in maxima-to-sr translation

```


Running on Linux Manjaro 17.1




---

Comment by nbruin created at 2018-07-10 16:04:32

Thanks! good catch. That's been a long while since that one was triggered. The code has a warning (line 1689 in maxima_lib.py):

```
            else:
                # This could be unsafe if the conversion to SR
                # changes the structure of expr
```

The fix is straightforward: add the appropriate translation to the dictionary. A bit of debugging shows that this diff does the trick:

```
diff --git a/src/sage/interfaces/maxima_lib.py b/src/sage/interfaces/maxima_lib.py
index 874ea23..6d142c2 100644
--- a/src/sage/interfaces/maxima_lib.py
+++ b/src/sage/interfaces/maxima_lib.py
`@``@` -1236,6 +1236,7 `@``@` sage_op_dict = {
     sage.functions.other.factorial : "MFACTORIAL",
     sage.functions.error.erf : "%ERF",
     sage.functions.gamma.gamma_inc : "%GAMMA_INCOMPLETE",
+    sage.functions.other.conjugate : "$CONJUGATE",
 }
 #we compile the dictionary
 sage_op_dict = dict([(k,EclObject(sage_op_dict[k])) for k in sage_op_dict])
```

I don't have a sage build ready from which I can push this change, so for now I just document the fix this way.


---

Comment by nbruin created at 2018-07-10 17:34:24

Changing status from new to needs_review.


---

Comment by nbruin created at 2018-07-10 17:34:24

One line fix. If someone feels the need, please add a doctest. The error check in the code performed exactly as intended, and raised at a point where a little debug inspection immediately indicated what entry should be added.
----
New commits:


---

Comment by nbruin created at 2018-07-10 17:34:24

Changing type from PLEASE CHANGE to defect.


---

Comment by git created at 2018-07-10 17:48:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2018-07-11 21:06:34

With the fix from commit 2a5d00c:

```
sage: x = SR.var('x')
sage: integrate(log(e^x*log(x)*sin(x))/x^2, x)
1/2*(x*(Ei(-log(x)) + conjugate(Ei(-log(x))))
- 2*x*integrate(sin(x)/(x*cos(x)^2 + x*sin(x)^2
+ 2*x*cos(x) + x), x) + 2*x*integrate(sin(x)/(x*cos(x)^2
+ x*sin(x)^2 - 2*x*cos(x) + x), x) + 2*x*log(x) + 2*log(2)
- log(cos(x)^2 + sin(x)^2 + 2*cos(x) + 1) - log(cos(x)^2
+ sin(x)^2 - 2*cos(x) + 1) - 2*log(log(x)))/x
```

Where would be a good place to put this as a doctest?


---

Comment by chapoton created at 2019-08-25 06:34:11

Changing keywords from "integrate" to "integrate, maxima".


---

Comment by chapoton created at 2019-08-25 06:34:11

doctest added. I checked that the result is indeed a primitive. Please review
----
New commits:


---

Comment by chapoton created at 2019-08-29 11:43:48

green bot, please review (easy one)


---

Comment by tscrim created at 2019-08-29 12:04:38

LGTM.


---

Comment by tscrim created at 2019-08-29 12:04:38

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-08-29 12:09:55

Thanks Travis.

If you have time, please look at

https://ask.sagemath.org/question/47657/virasoro-verma-module-basis/


---

Comment by vbraun created at 2019-09-02 21:40:57

Resolution: fixed
