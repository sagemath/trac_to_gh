# Issue 16023: Python 2.7.6

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-04-28 14:39:57

CC:  fbissey jpflori simonking




---

Comment by vbraun created at 2014-04-28 14:56:02

The uuid patch does not apply any more. Removing it for now.


---

Comment by vbraun created at 2014-04-28 14:57:38

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2014-04-28 14:57:38

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2014-04-28 15:09:02

New commits:


---

Comment by vbraun created at 2014-04-28 15:09:02

Changing status from new to needs_review.


---

Comment by fbissey created at 2014-04-28 22:10:59

What was the uuid patch for?


---

Comment by vbraun created at 2014-04-28 22:52:31

Some cygwin thing, can't test to see if its still necessary.


---

Comment by fbissey created at 2014-04-28 22:54:27

Better ask Jean-Pierre about that patch then.


---

Comment by jpflori created at 2014-04-29 08:33:41

See #16119.
Without firther investigation, i would say it's still needed (unless the uuid module has been heavily modified in this new release).


---

Comment by vbraun created at 2014-04-29 08:44:17

It doesn't apply, so the module has been modified. In any case I have no way of testing it. The ball is on your court.


---

Comment by jpflori created at 2014-04-29 08:45:08

Ok, I'll give it a shot asap (which may be not before this week-end).


---

Comment by jpflori created at 2014-04-29 15:25:56

So, I already tested it and it seems that http://bugs.python.org/issue18784 which makes the previous patch (inspired from http://bugs.python.org/issue11063) fail to apply is not enough to prevent the segfaults I encountered in #16119.
I'll try to rebase the patch asap.


---

Attachment

Rebased patch


---

Comment by tscrim created at 2014-05-30 01:52:24

FYI - There was an inquiry about getting this in at https://groups.google.com/forum/#!topic/sage-devel/_zTj2wphoTQ.


---

Comment by fbissey created at 2014-05-30 01:54:46

Yes I noticed, my apologies for not coming back to this sooner. Once someone has pushed the patch into the branch I can give it a positive review.


---

Comment by tscrim created at 2014-05-30 02:10:44

Done.
----
New commits:


---

Comment by fbissey created at 2014-05-30 02:25:28

Hummm.... The heading for uuid patch mention python 2.7.5 not 2.7.6. Have checked that it applies cleanly?


---

Comment by tscrim created at 2014-05-30 02:54:04

No, I just merged in Jean-Pierre's patch posted here.


---

Comment by stephen created at 2014-05-30 02:55:07

Replying to [comment:16 fbissey]:
> Hummm.... The heading for uuid patch mention python 2.7.5 not 2.7.6. Have checked that it applies cleanly?

I just checked it.  It does apply cleanly to python-2.7.6.


---

Comment by fbissey created at 2014-05-30 02:57:50

OK I don't have a setup handy to import the branch and test it myself. It is just a bit curious but I will mark this as positive review.


---

Comment by fbissey created at 2014-05-30 02:57:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-30 15:19:55

Doesn't work on OSX because of case-insensitive file system and our retarded way of `mv python-2.7.6 src` (directory name is `Python-2.7.6`)


---

Comment by git created at 2014-05-30 17:00:57

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2014-05-30 17:00:57

Changing status from positive_review to needs_review.


---

Comment by leif created at 2014-05-31 13:25:50

Wonder whether that works as expected on Cygwin... (so I feel unable to give it positive review)

J-P?


---

Comment by leif created at 2014-05-31 15:59:23


```
/foo/Sage/sage-6.3.beta2-gcc-4.4.3/build/pipestatus "sage-spkg ${SAGE_SPKG_OPTS} python-2.7.6 2>&1" "tee -a /foo/Sage/sage-6.3.beta2-gcc-4.4.3/logs/pkgs/python-2.7.6.log"
cp /foo/Sage/sage-6.3.beta2-gcc-4.4.3/src/bin/sage-spkg /foo/Sage/sage-6.3.beta2-gcc-4.4.3/local/bin/sage-spkg
Found local metadata for python-2.7.6
Attempting to download package python-2.7.6
>>> Trying to download http://www.sagemath.org/packages/upstream/python/python-2.7.6.tar.bz2
[............................................................]
Checksum: ee6facccd17222966e5e846d8104f3431a4ecdc2 vs ee6facccd17222966e5e846d8104f3431a4ecdc2
python-2.7.6
====================================================
Setting up build directory for python-2.7.6
Finished set up
****************************************************
Host system:
Linux mediocrity 3.0.0-32-generic #51~lucid1-Ubuntu SMP Fri Mar 22 17:34:23 UTC 2013 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 4.4.3-4ubuntu5.1' --with-bugurl=file:///usr/share/doc/gcc-4.4/README.Bugs --enable-languages=c,c++,fortran,objc,obj-c++ --prefix=/usr --enable-shared --enable-multiarch --enable-linker-build-id --with-system-zlib --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --with-gxx-include-dir=/usr/include/c++/4.4 --program-suffix=-4.4 --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-plugin --enable-objc-gc --disable-werror --with-arch-32=i486 --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 4.4.3 (Ubuntu 4.4.3-4ubuntu5.1)
****************************************************
./spkg-install: line 23: cd: src: No such file or directory
./spkg-install: line 27: ../patches/*.patch: No such file or directory
Error: Patch "../patches/*.patch" failed to apply.

real    0m0.022s
user    0m0.000s
sys     0m0.000s
************************************************************************
Error installing package python-2.7.6
```


(Second try doesn't work either.)


```
$ git log src/bin/sage-spkg
commit e9aa3c608f1407fc5ff36236b442e7db42f8f871
Author: Volker Braun <vbraun.name`@`gmail.com>
Date:   Fri May 30 16:35:56 2014 +0100

    ignore case when renaming source directory

...
```


FWIW,

```
$ bash --version
GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>

This is free software; you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```



---

Comment by vbraun created at 2014-05-31 16:11:40

Does `export LC_ALL=C` fix it?


---

Comment by leif created at 2014-05-31 16:39:44

Replying to [comment:25 leif]:
> 
> FWIW,
> {{{
> $ bash --version
> GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)
> Copyright (C) 2009 Free Software Foundation, Inc.
> License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
> 
> This is free software; you are free to change and redistribute it.
> There is NO WARRANTY, to the extent permitted by law.
> }}}

Though "suboptimal",

```sh
    mv "${PKG_NAME_UPSTREAM%.tar*}"* src
```

works for me.


---

Comment by leif created at 2014-05-31 16:39:44

Changing status from needs_review to needs_info.


---

Comment by leif created at 2014-05-31 16:46:12

Replying to [comment:26 vbraun]:
> Does `export LC_ALL=C` fix it?

Sorry, missed your question.  But no, it doesn't.


---

Comment by vbraun created at 2014-05-31 17:05:21

Changing status from needs_info to needs_review.


---

Comment by vbraun created at 2014-05-31 17:05:21

I added the workaround to the dependency ticket.


---

Comment by jpflori created at 2014-06-03 13:20:58

Hi all, the rebased patch I posted was definitely needed, on my own Cygwin64 install at least, to let some Python dependencies of the notebook build.
Note though that Python is still very broken on Cygwin64.
A bunch of its testsuite fail, but I would not assume that the patch worsened anything.
Surely some other patches from the Cygwin folk are needed but I have no time to devote to investigating that now.
A first step would be if the Cygwin distributed Python also fails part of its testsuite or not.


---

Comment by leif created at 2014-06-03 13:31:51

Replying to [comment:30 jpflori]:
> Hi all, the rebased patch I posted was definitely needed, on my own Cygwin64 install at least, to let some Python dependencies of the notebook build.
> Note though that Python is still very broken on Cygwin64.
> A bunch of its testsuite fail, but I would not assume that the patch worsened anything.
> Surely some other patches from the Cygwin folk are needed but I have no time to devote to investigating that now.
> A first step would be if the Cygwin distributed Python also fails part of its testsuite or not.

Can you confirm that installation of the new spkg (with #16415) works on Cygwin?

If so, please set both tickets to "positive review" (unless there are other issues I don't know of).


---

Comment by jpflori created at 2014-06-03 13:39:03

I'll do that tomorrow.
I don't have any computer with internet access where I can plug the hdd containing the vm right now.


---

Comment by leif created at 2014-06-03 13:51:34

Changing status from needs_review to needs_work.


---

Comment by leif created at 2014-06-03 13:51:34

Replying to [comment:32 jpflori]:
> I'll do that tomorrow.
> I don't have any computer with internet access where I can plug the hdd containing the vm right now.

Virtual memory? ;-)

Ok, just noticed the branch has to be rebased on #16415 anyway (it still contains a patch to `sage-spkg` [which isn't based on #16415 nor the other way around]).


---

Comment by leif created at 2014-06-03 14:49:31

ROFL, William just posted

```
Python 2.7.7 was released already (I think yesterday).
```



---

Comment by git created at 2014-06-04 09:56:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-06-04 09:56:59

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-06-04 09:57:23

Maybe it can be reviewed before 2.7.8 is out...


---

Comment by vbraun created at 2014-06-04 10:00:22

Also, last time I checked Cygwin was not a supported platform. If you take the time to check progress on the Cygwin port then that is great, but don't hold up tickets for it.


---

Comment by jpflori created at 2014-06-04 10:05:37

Sure, this can get in without proper Cygwin support.
Just don't drop patches.


---

Comment by fbissey created at 2014-06-04 10:08:09

Looks like you rolled #16415 in that commit too.


---

Comment by vbraun created at 2014-06-04 10:23:12

#16415 is a dependency to build on OSX.


---

Comment by vbraun created at 2014-06-04 13:17:26

This fails with Python 2.7.7. Its testing an implementation detail, so I'll remove it:

```
sage -t --long src/sage/misc/weak_dict.pyx
**********************************************************************
File "src/sage/misc/weak_dict.pyx", line 84, in sage.misc.weak_dict
Failed example:
    for k in D.iterkeys():
        gc.enable()
        _ = gc.collect()
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: dictionary changed size during iteration
Got:
    <BLANKLINE>
**********************************************************************
```



---

Comment by git created at 2014-06-04 13:18:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-06-04 13:23:13

Replying to [comment:43 vbraun]:
> This fails with Python 2.7.7. Its testing an implementation detail, so I'll remove it:
> {{{
> sage -t --long src/sage/misc/weak_dict.pyx
> **********************************************************************
> File "src/sage/misc/weak_dict.pyx", line 84, in sage.misc.weak_dict
> Failed example:
>     for k in D.iterkeys():
>         gc.enable()
>         _ = gc.collect()
> Expected:
>     Traceback (most recent call last):
>     ...
>     RuntimeError: dictionary changed size during iteration
> Got:
>     <BLANKLINE>
> **********************************************************************
> }}}

Does Python now allow to change the dictionary size during iteration??? Strange.


---

Comment by SimonKing created at 2014-06-04 13:25:47

I just notice that this tests a bug of _Python's_ weak value dictionary. The point of this test was to show that Sage's weak value dictionary is safer. So, if Python has fixed the bug, the test has lost its purpose, and can be removed.


---

Comment by vbraun created at 2014-06-04 13:28:43

Its still illegal to change the dictionary during iteration. Might be Issue #20437: Fixed 43 potential bugs when deleting objects references.


---

Comment by SimonKing created at 2014-06-04 13:39:48

Replying to [comment:47 vbraun]:
> Its still illegal to change the dictionary during iteration.

Sure it is illegal. But the bug was that _garbage collection_ used to be able to change the size of a weak dictionary during iteration. Sage has fixed it, and so has Python.


---

Comment by leif created at 2014-06-04 14:23:55

Replying to [comment:42 vbraun]:
> #16415 is a dependency to build on OSX.

While that's not even true (it's a general fix for [almost all?] bashs but yours), merging parts of a ticket that this one is supposed to depend on doesn't make any sense to me.

So IMHO you should either remove patches to `sage-spkg` from the branch here, or close #16415 as a duplicate of this one, and remove the dependency.  The latter would be pretty illogical IMHO.


---

Comment by vbraun created at 2014-06-04 14:27:07

No. You merge dependencies into a branch. The Trac "Dependencies" field is for humans, and not parsed by git.


---

Comment by vbraun created at 2014-06-04 14:29:06

Updated the branch name to contain the right Python version


---

Comment by vbraun created at 2014-06-04 14:32:28

More explanation of the git workflow: Once the release manager merges #16415, all of the commits from that dependency ticket are no longer part of this ticket.


---

Comment by leif created at 2014-06-04 14:53:01

Replying to [comment:50 vbraun]:
> No. You merge dependencies into a branch. The Trac "Dependencies" field is for humans, and not parsed by git.

You didn't get it, but the new/updated branch looks clean[er] (apart from having a weird commit history).


---

Comment by leif created at 2014-06-04 16:03:36

Could we recompress the upstream tarball with bzip2 again?

(Affects the "checksums" of course.)


---

Comment by vbraun created at 2014-06-04 17:59:12

IMHO its better to keep the upstream tarball as unmodified as possible. Its bad enough that our retarded build system can't deal with the upstream `.tgz` ending. But at least now the checksum is still the same as on python.org (they don't offer bz2 downloads).


---

Comment by leif created at 2014-06-04 18:21:15

Replying to [comment:56 vbraun]:
> IMHO its better to keep the upstream tarball as unmodified as possible.

If we'd provide URLs to them...

Ideally we would have "checksums" for all kinds of tarballs (along with the URLs) whether offered by upstream / 3rd party ("almost" mirrors) or (just) us, and/or provide a checksum for the _uncompressed_ tarball.

> Its bad enough that our retarded build system can't deal with the upstream `.tgz` ending.

Yes, it's sad we still don't fully support MS-DOS.

> But at least now the checksum is still the same as on python.org (they don't offer bz2 downloads).

Which is an upstream bug we used to fix... ;-)




Ceterum censeo Sage should support (and use) `.xz` (as btw. a couple of included packages do since quite some time IIRC).


---

Comment by dimpase created at 2014-06-15 14:12:41

this upgrade appears to break pexpect (?) on OSX 10.9. Without it 

```
sage -t src/sage/modules/vector_integer_dense.pyx
```

passes, with it it always hands here:

```
sage: vs = singular(v); vs ## line 372 ##
```



---

Comment by jhpalmieri created at 2014-06-15 18:13:43

Hmm, I don't see this problem on my OS X 10.9 machine.


---

Comment by dimpase created at 2014-06-15 19:02:10

Replying to [comment:59 jhpalmieri]:
> Hmm, I don't see this problem on my OS X 10.9 machine.
do you have the patch from #16474#comment:3 applied?


---

Comment by jhpalmieri created at 2014-06-15 19:22:19

Replying to [comment:60 dimpase]:
> Replying to [comment:59 jhpalmieri]:
> > Hmm, I don't see this problem on my OS X 10.9 machine.
> do you have the patch from #16474#comment:3 applied?

I ran doctests once without it and once with it, and `sage/modules/vector_integer_dense.pyx` passed doctests both times.


---

Comment by dimpase created at 2014-06-15 20:00:27

Replying to [comment:61 jhpalmieri]:
> Replying to [comment:60 dimpase]:
> > Replying to [comment:59 jhpalmieri]:
> > > Hmm, I don't see this problem on my OS X 10.9 machine.
> > do you have the patch from #16474#comment:3 applied?
> 
> I ran doctests once without it and once with it, and `sage/modules/vector_integer_dense.pyx` passed doctests both times.
for me it only works with the #16474#comment:3 patch applied.
Note that however I have this ticket's (#16260) branch merged over #16440 rather than over the current beta (6.3.beta3).
Without the latter the docs won't build for me.


---

Comment by vbraun created at 2014-06-16 12:13:56

The pexpect issue is #16474.


---

Comment by jhpalmieri created at 2014-06-17 01:53:44

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2014-06-17 09:31:26

Replying to [comment:63 vbraun]:
> The pexpect issue is #16474.
OK, sure. By the way, I checked that this ticket works on ARM, too.


---

Comment by vbraun created at 2014-06-18 12:00:22

Resolution: fixed
