# Issue 14092: Force consistency of $LD and $AS with $CC

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-03-18 13:26:29

Assignee: GeorgSWeber

CC:  leif jpflori

Sometimes, a system-wide GCC can be configured to use a different linker than simply `ld` (using `configure --with-ld=/path/to/linker). The path to the linker used by GCC can be discovered by

```
buildbot`@`mark:~$ gcc -print-file-name=ld
/usr/local/binutils-2.22/sparc-SunOS-ultrasparc3-gcc-4.6.2-without-zlib/bin/ld
```


Unfortunately, there can be an inconsistency between `$LD` and the linker used by GCC, leading to build failures. We should do the following:
1. If `$LD` is unset, set it to `$CC -print-file-name=ld` by default instead of `ld`.
2. If `$LD` is set and the value differs from `$CC -print-file-name=ld`, force building of the GCC spkg (define these values to be equal if the output of `command -v VALUE` is equal).

Take care to support the case that `$CC` doesn't support the `-print-file-name` option.

------

Analogously, the same for the assembler `$AS`.


---

Comment by leif created at 2013-03-18 13:39:28

Replying to [ticket:14296 jdemeyer]:
> Unfortunately, there can be an inconsistency between `$LD` and the linker used by GCC, leading to build failures.

This affects only a few spkgs.  IMHO we should fix these, by changing their `spkg-install` scripts, or -- much better -- patching the upstream sources and reporting the fixes upstream.

> We should do the following:
> 1. If `$LD` is unset, set it to `$CC -print-file-name=ld` by default instead of `ld`.

Agreed.

> 2. If `$LD` is set and the value differs from `$CC -print-file-name=ld`, force building of the GCC spkg (define these values to be equal if the output of `command -v VALUE` is equal).

That's a bit overkill.  Ok for a buildbot, but otherwise we should just issue a warning (or, more complicated, error  out unless some override setting is active).


---

Comment by jdemeyer created at 2013-03-18 13:49:33

Replying to [comment:2 leif]:
> Replying to [ticket:14296 jdemeyer]:
> > Unfortunately, there can be an inconsistency between `$LD` and the linker used by GCC, leading to build failures.
> 
> This affects only a few spkgs.  IMHO we should fix these, by changing their `spkg-install` scripts
Is it really a bug? I'd say that configuring GCC to use a different linker from `$LD` is an user configuration error...


---

Comment by leif created at 2013-03-18 13:55:33

Replying to [comment:2 leif]:
> Replying to [ticket:14296 jdemeyer]:
> > We should do the following:
> > 1. If `$LD` is unset, set it to `$CC -print-file-name=ld` by default instead of `ld`.
> 
> Agreed.

Thinking more about that, it's probably too surprising (not respecting `PATH`), at least we shouldn't do that silently (if `which ld` differs from what GCC returns, unless GCC returns just `ld`, i.e., no absolute path).


---

Comment by jdemeyer created at 2013-03-18 13:56:46

Replying to [comment:2 leif]:
> > 2. If `$LD` is set and the value differs from `$CC -print-file-name=ld`, force building of the GCC spkg (define these values to be equal if the output of `command -v VALUE` is equal).
> 
> That's a bit overkill.  Ok for a buildbot, but otherwise we should just issue a warning (or, more complicated, error out unless some override setting is active).

Warnings will just be ignored. And why abort with an error if we can "fix" the issue (albeit in a complicated way) by building GCC?


---

Comment by leif created at 2013-03-18 14:02:37

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 leif]:
> > Replying to [ticket:14296 jdemeyer]:
> > > Unfortunately, there can be an inconsistency between `$LD` and the linker used by GCC, leading to build failures.
> > 
> > This affects only a few spkgs.  IMHO we should fix these, by changing their `spkg-install` scripts
> Is it really a bug? I'd say that configuring GCC to use a different linker from `$LD` is an user configuration error...

Nope.  AFAIK the affected packages just create (incompatible) linker scripts for the wrong linker, so their linker detection appears to be broken, or they at least feed the linker scripts to the wrong linker.


---

Comment by jdemeyer created at 2013-03-18 14:05:25

Replying to [comment:4 leif]:
> Thinking more about that, it's probably too surprising
Given that many (most?) packages actually link with `$CC` and therefore use the ld configured in `$CC`, I don't see the problem.


---

Comment by leif created at 2013-03-18 14:12:07

Replying to [comment:7 jdemeyer]:
> Replying to [comment:4 leif]:
> > Thinking more about that, it's probably too surprising
> Given that many (most?) packages actually link with `$CC` and therefore use the ld configured in `$CC`, I don't see the problem.

Well, if all spkgs used `$CC`, `$CXX` or `$FC` etc. for linking, there wouldn't be a problem (modulo generating linker scripts for the wrong, i.e., not "GCC's" linker), so setting `LD` would be pretty pointless.


---

Comment by leif created at 2013-03-18 14:22:40

Replying to [comment:5 jdemeyer]:
> Replying to [comment:2 leif]:
> > > 2. If `$LD` is set and the value differs from `$CC -print-file-name=ld`, force building of the GCC spkg (define these values to be equal if the output of `command -v VALUE` is equal).
> > 
> > That's a bit overkill.  Ok for a buildbot, but otherwise we should just issue a warning (or, more complicated, error out unless some override setting is active).
> 
> Warnings will just be ignored. And why abort with an error if we can "fix" the issue (albeit in a complicated way) by building GCC?

Well, letting the user unset `LD` or change / correct its setting is certainly "easier" (and less surprising) than Sage automagically building its own GCC.


---

Comment by jdemeyer created at 2013-03-18 15:41:17

leif, would you agree with keeping the changes to `sage-env` in [attachment:14296_ld_as.patch] but changing the detection in `spkg/install` to an error if the values of as or ld don't match (where there would never be an error if we're building GCC, since the newly-built GCC would use the setting of `$LD` as default linker).


---

Comment by leif created at 2013-03-18 17:43:59

In `sage-env`, `stdout` of `command -v ...` should also be redirected to `/dev/null`.

Replying to [comment:10 jdemeyer]:
> leif, would you agree with keeping the changes to `sage-env` in [attachment:14296_ld_as.patch]

This should be ok, although a user might still intentionally have a different `ld` or `as` first in his/her `PATH`.  (Then we'd have to document that setting `AS` and/or `LD` might be necessary to get the previous behaviour.)
  
> but changing the detection in `spkg/install` to an error if the values of as or ld don't match (where there would never be an error if we're building GCC, since the newly-built GCC would use the setting of `$LD` as default linker).

Hmmm.  It should be possible to override the error (probably by setting `SAGE_PORT`).

There are some subtle issues with the comparisons, not sure how artificial the following scenarios are:

* `AS` and/or `LD` are set to (e.g.) `as -foo` or `ld -foo`, respectively (likewise `/path/to/as -foo` etc.).
   Then e.g. `command -v "$AS"` gives an error (whilst `command -v $AS` probably doesn't.)
* `AS` and/or `LD` are set to something like `as-2.22`, while (e.g.) GCC was configured with something else.
* Opposite of the previous:  GCC was configured to (e.g.) use `as-2.22` (or `/path/to/as`, or `/path/to/as-2.22`), while e.g. `AS` is meanwhile just `as`, `as-2.23`, or `/other/path/to/as` etc. 
* Probably more weirdnesses.

Filename mismatches don't necessarily mean that the programs are different, or incompatible.

I don't think one couldn't work around the above situations by changing the setup, but this might be difficult for "ordinary" users, especially those without admin rights.

----

How does this fit your "If a user sets $VAR, assume he/she knows what he/she's doing, so don't override it; he/she doesn't need a nanny."? ;-)


---

Comment by jdemeyer created at 2013-03-18 20:57:53

Changing status from new to needs_review.


---

Comment by leif created at 2013-03-18 21:17:34

Now looks ok (and reasonable) to me.

In case users report trouble, we can always "fine-tune" the behaviour later.

Still, the documentation (on env vars, in the Installation Guide IIRC) should get updated accordingly.

Minor issue:  In the messages, I wouldn't use `\$PROG` but `PROG`, since the former refers to the value of a variable rather than to the variable itself.

Will (have to) test this later<sup>TM</sup>...


---

Comment by jpflori created at 2013-03-29 16:28:47

I endured a nightmare on Solaris because of LD/AS/CC troubles.
I'll try to gather exactly what was problematic with my install and report back here.


---

Comment by jdemeyer created at 2013-10-31 13:16:15

Updated with some small changes, anybody care for a review?


---

Comment by jpflori created at 2013-10-31 15:43:57

Looks good to me as well.


---

Comment by jpflori created at 2013-10-31 15:43:57

Changing status from needs_review to positive_review.


---

Attachment

Adding unsetting `AS` and `LD` in case of upgrading.


---

Comment by jdemeyer created at 2013-11-11 13:41:24

Changing status from positive_review to needs_review.


---

Comment by jpflori created at 2013-11-13 22:32:16

Can you give more details of why this last change is needed?


---

Comment by jdemeyer created at 2013-11-14 07:35:28

Replying to [comment:20 jpflori]:
> Can you give more details of why this last change is needed?
The changes to `spkg/install` require the changes to `sage-env`. If `gcc` doesn't use the default assembler `as`, then the new `spkg/install` requires `AS` to be set to the assembler used by `gcc`. When upgrading, the file `spkg/install` is upgraded before `sage-env`. Therefore, we disable this check when upgrading by unsetting `AS` and `LD` if they are set to the default value.


---

Comment by jpflori created at 2013-11-14 07:57:51

Ok, sure.
I didn't think of the fact that spkg/install and spkg-env were also upgraded...


---

Comment by jpflori created at 2013-11-14 07:57:51

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-14 08:06:20

Resolution: fixed
