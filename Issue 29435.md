# Issue 29435: spkg-configure.m4 for palp

Issue created by migration from https://trac.sagemath.org/ticket/29672

Original creator: dimpase

Original creation time: 2020-05-10 19:24:21

CC:  mjo mkoeppe enriqueartal isuruf vbraun

it should be easy - it's a stable package, with just binary executables and data.

In debian it is called `palp`


---

Comment by dimpase created at 2020-05-11 17:07:22

New commits:


---

Comment by dimpase created at 2020-05-11 17:07:22

Changing status from new to needs_review.


---

Comment by mjo created at 2020-05-12 15:22:22

The reason I haven't included this in Gentoo yet is because sage builds optimized versions of the `class.x`, `cws.x`, `nef.x`, and `poly.x` executables -- and then installs them with nonstandard names.

Editing `Global.h` to define `POLY_Dmax` is what upstream recommends, but the names of the resulting binaries are always e.g. `class.x` when you do that. Sage then renames them too e.g. `class-4d.x`. I don't want to include the nonstandard executables in a distro package just to make sage (which isn't even in the tree yet) happy.

Does anyone know if upstream is still interested in making source improvements? It might be easy to consolidate these into one executable by having each `foo.x` dispatch to one of several optimized functions rather than having the user (i.e. sage) dispatch to one of several different optimized executables. That depends it being easy to infer `POLY_Dmax` from the input, of course. Otherwise, we could at least ask that the build system standardize on these names and actually build the optimized executables.


---

Comment by mjo created at 2020-05-12 16:20:01

I think I forgot to write this: in `sage/geometry/polyhedron/palp_database.py`, we have


```
        return Popen(['class-4d.x', '-He',
```


so Sage does use at least use _that_ nonstandard name, and this script needs to check for it. I'm not sure if that will affect any of the other distros.


---

Comment by dimpase created at 2020-05-12 21:52:21

Debian has essentially the same naming scheme for palp's programs in its package.

Fedora as well.


---

Comment by mjo created at 2020-05-19 14:00:34

Replying to [comment:4 dimpase]:
> Debian has essentially the same naming scheme for palp's programs in its package.
> 
> Fedora as well.

If all of the major distros are using the same convoluted build process to achieve a consistent naming scheme, then to me that still suggests that we should upstream that build process. It's hard for me to justify building the same package four times and installing a bunch of executables with non-standard names just to make the test suite of another package that's not even in the tree pass.

In lieu of some agreement, I'll probably add a fallback to sagelib so that it uses `class.x` instead of `class-4d.x` when the latter isn't present (like we did with nauty). That will allow sage to keep working with the "out of the box" version of palp.


---

Comment by dimpase created at 2020-05-19 15:25:14

yes, assuming upstream is sensible. I spent a lot of time convincing upstreams to accept patches, it is often frustrating.


---

Comment by mjo created at 2020-05-19 18:42:44

I sent the maintainer a cleanup patch for the makefile, so I'll get some sort of impression soon enough.


---

Comment by mjo created at 2020-05-19 23:42:57

It turns out that the only place class-4d.x is even used is in an optional test for a huge, old-style SPKG that hasn't been ported yet (#26029). The nonstandard names are thus quite likely to be completely unused.


---

Comment by mjo created at 2020-05-19 23:53:11

Just kidding, the names of the executables are mangled on the fly. In `geometry/lattice_polytope.py`,


```
def set_palp_dimension(d):
    ...
    global _palp_dimension
    _palp_dimension = d

def _palp(command, polytopes, reduce_dimension=False):
    ...
    if _palp_dimension is not None:
        dot = command.find(".")
        command = command[:dot] + "-%dd" % _palp_dimension + command[dot:]
```


I give up.


---

Comment by mjo created at 2020-05-19 23:59:39

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2020-05-19 23:59:39

In light of that, you should check all 16 combinations of executable names `(poly, class, nef cws) x (4,5,6 11)` in the spkg-configure.m4. I started a branch at u/mjo/ticket/29672 that checks for `class-4d.x` and substitutes `class.x` in its place, but I'm not going to spend three days doing it for the other 15 names.


---

Comment by dimpase created at 2020-05-20 09:42:47

Volker, you're a `palp` user - could you comment on the naming schemes for `palp` executables?


---

Comment by dimpase created at 2020-05-21 09:04:29

Replying to [comment:10 mjo]:
> In light of that, you should check all 16 combinations of executable names `(poly, class, nef cws) x (4,5,6 11)` in the spkg-configure.m4. I started a branch at u/mjo/ticket/29672 that checks for `class-4d.x` and substitutes `class.x` in its place, but I'm not going to spend three days doing it for the other 15 names.

OK, I'll try my hand in nested m4 loops :-)


---

Comment by mjo created at 2020-05-21 13:14:05

Replying to [comment:7 mjo]:
> I sent the maintainer a cleanup patch for the makefile, so I'll get some sort of impression soon enough.

Harald Skarke just merged these patches. It probably wouldn't be hard to fix the naming issue if everyone can agree on a solution.

I think having one executable (e.g. `class.x`) dispatch to the proper routine is clearly preferable, _if_ the dimension can be determined quickly enough to do so. This avoids invalidating the examples in the paper (https://arxiv.org/abs/math/0204356) unnecessarily, and doesn't pollute `/usr/bin` with four copies of the same programs.


---

Comment by dimpase created at 2020-05-25 10:42:37

So, what's going to change once these merged upstream patches are in distros?


---

Comment by mjo created at 2020-05-25 13:27:51

Replying to [comment:15 dimpase]:
> So, what's going to change once these merged upstream patches are in distros?

Probably nothing, the series I sent only ensures that CC, LDFLAGS, CFLAGS, CPPFLAGS are supported out of the box.


---

Comment by @thierry-FreeBSD created at 2020-05-28 20:13:07

I just made a port of palm for FreeBSD, based upon build/pkgs/palp/spkg-install.in, but I do not see any data in it. The resulting MANIFEST (relative to $PREFIX) is:



```
bin/class-11d.x
bin/class-4d.x
bin/class-5d.x
bin/class-6d.x
bin/class.x
bin/cws-11d.x
bin/cws-4d.x
bin/cws-5d.x
bin/cws-6d.x
bin/cws.x
bin/mori-11d.x
bin/mori-4d.x
bin/mori-5d.x
bin/mori-6d.x
bin/mori.x
bin/nef-11d.x
bin/nef-4d.x
bin/nef-5d.x
bin/nef-6d.x
bin/nef.x
bin/poly-11d.x
bin/poly-4d.x
bin/poly-5d.x
bin/poly-6d.x
bin/poly.x

```



---

Comment by dimpase created at 2020-05-29 14:08:41

one way to test palp executables is to look up examples in
https://arxiv.org/abs/math/0204356


---

Comment by @thierry-FreeBSD created at 2020-05-29 14:20:18

Yes, it works!

But my question was about the description of this ticket "it's a stable package, with just binary executables and data", since I do not see any datafiles.


---

Comment by git created at 2020-06-04 09:51:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-04 10:26:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-04 10:28:11

OK, so as requested, checking that every executable is there. Needs review (you can just look in the `config.log` to see it does the right thing)


---

Comment by dimpase created at 2020-06-04 10:28:11

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2020-06-11 00:56:40

The logic is OK but the variable tests need quotes otherwise they crash if I do something stupid like put the executables in `/home/mjo/My Programs`.


---

Comment by git created at 2020-06-11 09:58:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-11 09:58:37

Replying to [comment:23 mjo]:
> The logic is OK but the variable tests need quotes otherwise they crash if I do something stupid like put the executables in `/home/mjo/My Programs`.

OK, sure, done.


---

Comment by mjo created at 2020-06-11 14:08:51

Ok, works now.


---

Comment by mjo created at 2020-06-11 14:08:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-06-21 22:37:01

Resolution: fixed
