# Issue 25506: Speed up iteration of ProjectiveSpace_finite_field

archive/issues_025506.json:
```json
{
    "body": "While implementing some algorithm involving projective spaces, I noticed that 90% of the time was simply spent enumerating the points of a projective space.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25743\n\n",
    "created_at": "2018-07-02T14:50:53Z",
    "labels": [
        "performance",
        "major",
        "enhancement"
    ],
    "title": "Speed up iteration of ProjectiveSpace_finite_field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25506",
    "user": "jdemeyer"
}
```
While implementing some algorithm involving projective spaces, I noticed that 90% of the time was simply spent enumerating the points of a projective space.

Issue created by migration from https://trac.sagemath.org/ticket/25743





---

archive/issue_comments_359763.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-30T11:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359763",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_359764.json:
```json
{
    "body": "here is a proposal. not yet benchmarked\n\nplus the file is cleaned up a little bit\n----\nNew commits:",
    "created_at": "2021-01-30T11:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359764",
    "user": "chapoton"
}
```

here is a proposal. not yet benchmarked

plus the file is cleaned up a little bit
----
New commits:



---

archive/issue_comments_359765.json:
```json
{
    "body": "apparently not faster at all",
    "created_at": "2021-01-30T12:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359765",
    "user": "chapoton"
}
```

apparently not faster at all



---

archive/issue_comments_359766.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-31T08:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359766",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359767.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-25T00:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359767",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_359768.json:
```json
{
    "body": "This branch speeds up the iteration ~5x on this example:\n\n```\nsage: PS = ProjectiveSpace(3, GF(71))\nsage: %time L = list(PS)\nCPU times: user 2.32 s, sys: 27.3 ms, total: 2.35 s\nWall time: 2.35 s\n```\n\nvs before\n\n```\nCPU times: user 10.6 s, sys: 18.2 ms, total: 10.6 s\nWall time: 10.6 s\n```\n\nBasically I avoid the checks, as well as more directly call the corresponding constructor since none of the points will by infinity. Feel free to merge this with your other cleanup stuff.\n----\nNew commits:",
    "created_at": "2021-02-25T00:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359768",
    "user": "tscrim"
}
```

This branch speeds up the iteration ~5x on this example:

```
sage: PS = ProjectiveSpace(3, GF(71))
sage: %time L = list(PS)
CPU times: user 2.32 s, sys: 27.3 ms, total: 2.35 s
Wall time: 2.35 s
```

vs before

```
CPU times: user 10.6 s, sys: 18.2 ms, total: 10.6 s
Wall time: 10.6 s
```

Basically I avoid the checks, as well as more directly call the corresponding constructor since none of the points will by infinity. Feel free to merge this with your other cleanup stuff.
----
New commits:



---

archive/issue_comments_359769.json:
```json
{
    "body": "The element constructors for affine and projetive space are very slow.  They go back to the very early days of Sage when this sort of thing was done in a very highbrow schemey way, at the expense of speed.  For example\n\n```\nsage: F = GF(73)                                                                                                                                      \nsage: %time L = list(cartesian_product_iterator([F for _ in range(3)]))                                                                               \nCPU times: user 189 ms, sys: 24.1 ms, total: 213 ms\nWall time: 212 ms\nsage: A = AffineSpace(F,3)                                                                                                                            \nsage: %time L = [A(v) for v in cartesian_product_iterator([F for _ in range(3)])]                                                                     \nCPU times: user 10.8 s, sys: 47.9 ms, total: 10.8 s\nWall time: 10.8 s\nsage: len(L)                                                                                                                                          \n389017\n```\n\nSo calling the constructor 389000 times results in a 10s run time.  Using `A.point(v)` is not much better, but with check=False we do gain:\n\n```\nsage: %time L = [A.point(v) for v in cartesian_product_iterator([F for _ in range(3)])]                                                               \nCPU times: user 9.07 s, sys: 47.8 ms, total: 9.12 s\nWall time: 9.12 s\nsage: %time L = [A.point(v, check=False) for v in cartesian_product_iterator([F for _ in range(3)])]                                                  \nCPU times: user 3 s, sys: 64 ms, total: 3.07 s\nWall time: 3.07 s\n```\n\n\nSo we could replace the current iterator for affine space over a finite field with this:\n\n```\ndef aff_iter(A):\n    F = A.base_ring()\n    d = A.dimension()\n    for v in cartesian_product_iterator([F for _ in range(d)]):\n        yield A.point(v, check=False)\n```\n\nand now\n\n```\nsage: %time L=list(aff_iter(A))                                                                                                                       \nCPU times: user 2.62 s, sys: 60.1 ms, total: 2.68 s\nWall time: 2.68 s\n```\n\n\nSimilarly for projective space, here is a new iterator, using the affine one:\n\n```\ndef proj_iter(P):\n    F = P.base_ring()\n    d = P.dimension()\n    one = (F.one(),)\n    zero = (F.zero(),)\n    for k in range(d+1): # position of last 1 before the 0's\n        for v in cartesian_product_iterator([F for _ in range(k)]):\n            yield P.point(v + one + zero*(d-k), check=False)\n```\n\nafter which\n\n```\nsage: P = ProjectiveSpace(GF(73), 3)                                                                                                                  \nsage: %time oldL=list(P)                                                                                                                              \nCPU times: user 11.6 s, sys: 63.8 ms, total: 11.6 s\nWall time: 11.6 s\nsage: %time L=list(proj_iter(P))                                                                                                                      \nCPU times: user 2.31 s, sys: 76.3 ms, total: 2.38 s\nWall time: 2.38 s\nsage: Set(L)==Set(oldL)                                                                                                                               \nTrue\n```\n\n\nI think my code is a lot easier to read than the old version, or the proposed adjustment to it -- shall we replace these two iterator methods with new version based on what I wrote?",
    "created_at": "2021-02-26T14:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359769",
    "user": "cremona"
}
```

The element constructors for affine and projetive space are very slow.  They go back to the very early days of Sage when this sort of thing was done in a very highbrow schemey way, at the expense of speed.  For example

```
sage: F = GF(73)                                                                                                                                      
sage: %time L = list(cartesian_product_iterator([F for _ in range(3)]))                                                                               
CPU times: user 189 ms, sys: 24.1 ms, total: 213 ms
Wall time: 212 ms
sage: A = AffineSpace(F,3)                                                                                                                            
sage: %time L = [A(v) for v in cartesian_product_iterator([F for _ in range(3)])]                                                                     
CPU times: user 10.8 s, sys: 47.9 ms, total: 10.8 s
Wall time: 10.8 s
sage: len(L)                                                                                                                                          
389017
```

So calling the constructor 389000 times results in a 10s run time.  Using `A.point(v)` is not much better, but with check=False we do gain:

```
sage: %time L = [A.point(v) for v in cartesian_product_iterator([F for _ in range(3)])]                                                               
CPU times: user 9.07 s, sys: 47.8 ms, total: 9.12 s
Wall time: 9.12 s
sage: %time L = [A.point(v, check=False) for v in cartesian_product_iterator([F for _ in range(3)])]                                                  
CPU times: user 3 s, sys: 64 ms, total: 3.07 s
Wall time: 3.07 s
```


So we could replace the current iterator for affine space over a finite field with this:

```
def aff_iter(A):
    F = A.base_ring()
    d = A.dimension()
    for v in cartesian_product_iterator([F for _ in range(d)]):
        yield A.point(v, check=False)
```

and now

```
sage: %time L=list(aff_iter(A))                                                                                                                       
CPU times: user 2.62 s, sys: 60.1 ms, total: 2.68 s
Wall time: 2.68 s
```


Similarly for projective space, here is a new iterator, using the affine one:

```
def proj_iter(P):
    F = P.base_ring()
    d = P.dimension()
    one = (F.one(),)
    zero = (F.zero(),)
    for k in range(d+1): # position of last 1 before the 0's
        for v in cartesian_product_iterator([F for _ in range(k)]):
            yield P.point(v + one + zero*(d-k), check=False)
```

after which

```
sage: P = ProjectiveSpace(GF(73), 3)                                                                                                                  
sage: %time oldL=list(P)                                                                                                                              
CPU times: user 11.6 s, sys: 63.8 ms, total: 11.6 s
Wall time: 11.6 s
sage: %time L=list(proj_iter(P))                                                                                                                      
CPU times: user 2.31 s, sys: 76.3 ms, total: 2.38 s
Wall time: 2.38 s
sage: Set(L)==Set(oldL)                                                                                                                               
True
```


I think my code is a lot easier to read than the old version, or the proposed adjustment to it -- shall we replace these two iterator methods with new version based on what I wrote?



---

archive/issue_comments_359770.json:
```json
{
    "body": "Please go ahead and make those changes.",
    "created_at": "2021-02-28T05:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359770",
    "user": "tscrim"
}
```

Please go ahead and make those changes.



---

archive/issue_comments_359771.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Please go ahead and make those changes.\nWill do. Since the new iterators will deliver the elements in a different order I'll be sure to check all doctests.",
    "created_at": "2021-02-28T08:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359771",
    "user": "cremona"
}
```

Replying to [comment:7 tscrim]:
> Please go ahead and make those changes.
Will do. Since the new iterators will deliver the elements in a different order I'll be sure to check all doctests.



---

archive/issue_comments_359772.json:
```json
{
    "body": "I made te changes I suggesed for both affine and projective space.  A small number of doctest outputs had to be changed since the order of iteration is now different, though I adjusted the code from what I had posted here to make the changes fewer.\n\nFor the original time tests, on the machine I was using we have the old version (9.2)\n\n```\nsage: PS = ProjectiveSpace(3, GF(71))                                                                                                                 \nsage: %time L = list(PS)                                                                                                                              \nCPU times: user 9.98 s, sys: 51.3 ms, total: 10 s\nWall time: 10 s\n```\n\nand the new\n\n```\nsage: PS = ProjectiveSpace(3, GF(71))                                                                                                                 \nsage: %time L = list(PS)                                                                                                                              \nCPU times: user 3.09 s, sys: 56.1 ms, total: 3.14 s\nWall time: 3.14 s\n```\n\nwhich I know is not so good a speedup as before.  If someone else wants to try to improve it further, they are welcome, but the time is all in the 363024 calls to the point constructor which is slow even with check-False.  (For this reason, the class for points on elliptic curves is not a specialization of the scheme point class -- it is rather ridiculous that it takes so long to construct a point when you do not even check that equations are satisfied.)\n\nBy the way, one thing I tried which definitely did not work is to construct one point outside the loop and then only assign its coordinates in the loop before yielding it.  The result is that all the points delivered are the same (pointers).  Adding in a copy() calls the constructor again...\n\nThe commit I made in u/cremona/25743 builds on the previous branch here, so it has Fr\u00e9d\u00e9ric's tidying up in the projective_space file, but I did not do similar in the affine_space file.\n----\nNew commits:",
    "created_at": "2021-03-01T09:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359772",
    "user": "cremona"
}
```

I made te changes I suggesed for both affine and projective space.  A small number of doctest outputs had to be changed since the order of iteration is now different, though I adjusted the code from what I had posted here to make the changes fewer.

For the original time tests, on the machine I was using we have the old version (9.2)

```
sage: PS = ProjectiveSpace(3, GF(71))                                                                                                                 
sage: %time L = list(PS)                                                                                                                              
CPU times: user 9.98 s, sys: 51.3 ms, total: 10 s
Wall time: 10 s
```

and the new

```
sage: PS = ProjectiveSpace(3, GF(71))                                                                                                                 
sage: %time L = list(PS)                                                                                                                              
CPU times: user 3.09 s, sys: 56.1 ms, total: 3.14 s
Wall time: 3.14 s
```

which I know is not so good a speedup as before.  If someone else wants to try to improve it further, they are welcome, but the time is all in the 363024 calls to the point constructor which is slow even with check-False.  (For this reason, the class for points on elliptic curves is not a specialization of the scheme point class -- it is rather ridiculous that it takes so long to construct a point when you do not even check that equations are satisfied.)

By the way, one thing I tried which definitely did not work is to construct one point outside the loop and then only assign its coordinates in the loop before yielding it.  The result is that all the points delivered are the same (pointers).  Adding in a copy() calls the constructor again...

The commit I made in u/cremona/25743 builds on the previous branch here, so it has Frédéric's tidying up in the projective_space file, but I did not do similar in the affine_space file.
----
New commits:



---

archive/issue_comments_359773.json:
```json
{
    "body": "So ~19% of the time is spent in the\n\n```\nsage.schemes.generic.homset.SchemeHomset_generic.__call__\n```\n\nmost likely because of the\n\n```python\nfrom sage.structure.parent import Set_generic\n```\n\nlocal import. So just moving that to the top of the file makes it go from 3.5s to 3s (via `%prun`).\n\nNext, I just avoided the intermediate step through the homset's `_element_constructor_` and just built the point directly.\n\nI also do some other changes to be more lazily about stuff. I strongly suspect the `(co)domain` attributes of `SchemeMorphism` can be standard morphisms with maybe an added `_domain`. So these are now both ~2x faster for me. Although it seems like it makes more sense to have `_point` be an attribute to the class, which will shave off even more time.\n----\nNew commits:",
    "created_at": "2021-03-04T00:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359773",
    "user": "tscrim"
}
```

So ~19% of the time is spent in the

```
sage.schemes.generic.homset.SchemeHomset_generic.__call__
```

most likely because of the

```python
from sage.structure.parent import Set_generic
```

local import. So just moving that to the top of the file makes it go from 3.5s to 3s (via `%prun`).

Next, I just avoided the intermediate step through the homset's `_element_constructor_` and just built the point directly.

I also do some other changes to be more lazily about stuff. I strongly suspect the `(co)domain` attributes of `SchemeMorphism` can be standard morphisms with maybe an added `_domain`. So these are now both ~2x faster for me. Although it seems like it makes more sense to have `_point` be an attribute to the class, which will shave off even more time.
----
New commits:



---

archive/issue_comments_359774.json:
```json
{
    "body": "Well done, I am happy to see the further improvement.  I do also think that the default point constructor for such a scheme should use the mechanism used here -- users should be able to write their own loops constructing points via A(coords_list) without having to go through the homset/codomain construction, which is rather obscure.\n\n(I think that just about the first ever Sage development I did in 2007 was adding proper support for urst-transforms on elliptic curves, when I noted that one way to recover the curve from a point P on it was to use P.codomain()!)",
    "created_at": "2021-03-04T08:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359774",
    "user": "cremona"
}
```

Well done, I am happy to see the further improvement.  I do also think that the default point constructor for such a scheme should use the mechanism used here -- users should be able to write their own loops constructing points via A(coords_list) without having to go through the homset/codomain construction, which is rather obscure.

(I think that just about the first ever Sage development I did in 2007 was adding proper support for urst-transforms on elliptic curves, when I noted that one way to recover the curve from a point P on it was to use P.codomain()!)



---

archive/issue_comments_359775.json:
```json
{
    "body": "Replying to [comment:11 cremona]:\n> Well done, I am happy to see the further improvement.  I do also think that the default point constructor for such a scheme should use the mechanism used here -- users should be able to write their own loops constructing points via A(coords_list) without having to go through the homset/codomain construction, which is rather obscure.\n\nI am not quite sure what you are suggesting here. Are you saying the current version is sufficient or is there something else to be done?\n\nAlso, green patchbot.",
    "created_at": "2021-03-05T01:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359775",
    "user": "tscrim"
}
```

Replying to [comment:11 cremona]:
> Well done, I am happy to see the further improvement.  I do also think that the default point constructor for such a scheme should use the mechanism used here -- users should be able to write their own loops constructing points via A(coords_list) without having to go through the homset/codomain construction, which is rather obscure.

I am not quite sure what you are suggesting here. Are you saying the current version is sufficient or is there something else to be done?

Also, green patchbot.



---

archive/issue_comments_359776.json:
```json
{
    "body": "I did not mean to delay this ticket, just perhaps suggesting that another ticket making it easy to construct points on schemes more efficiently might be worth while.  As you have been thinking about what would be needed, you might be the one to do that, but that is up to you of course.",
    "created_at": "2021-03-05T08:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359776",
    "user": "cremona"
}
```

I did not mean to delay this ticket, just perhaps suggesting that another ticket making it easy to construct points on schemes more efficiently might be worth while.  As you have been thinking about what would be needed, you might be the one to do that, but that is up to you of course.



---

archive/issue_comments_359777.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-05T08:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359777",
    "user": "cremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_359778.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-03-06T03:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359778",
    "user": "tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_359779.json:
```json
{
    "body": "Replying to [comment:13 cremona]:\n> I did not mean to delay this ticket, just perhaps suggesting that another ticket making it easy to construct points on schemes more efficiently might be worth while.  As you have been thinking about what would be needed, you might be the one to do that, but that is up to you of course.\n\nThat is no problem. I just wasn't sure of your intentions. I agree that would be a good thing to have.\n\nI did just notice that Fr\u00e9d\u00e9ric's cleanup did not get merged in. I will do this on Monday (unless someone else does it first). So I am just temporarily reverting the positive review until I do that.",
    "created_at": "2021-03-06T03:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359779",
    "user": "tscrim"
}
```

Replying to [comment:13 cremona]:
> I did not mean to delay this ticket, just perhaps suggesting that another ticket making it easy to construct points on schemes more efficiently might be worth while.  As you have been thinking about what would be needed, you might be the one to do that, but that is up to you of course.

That is no problem. I just wasn't sure of your intentions. I agree that would be a good thing to have.

I did just notice that Frédéric's cleanup did not get merged in. I will do this on Monday (unless someone else does it first). So I am just temporarily reverting the positive review until I do that.



---

archive/issue_comments_359780.json:
```json
{
    "body": "This was not necessary. You could set back to positive, in my opinion.",
    "created_at": "2021-03-06T07:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359780",
    "user": "chapoton"
}
```

This was not necessary. You could set back to positive, in my opinion.



---

archive/issue_comments_359781.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-08T01:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359781",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_359782.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-03-08T01:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359782",
    "user": "tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_359783.json:
```json
{
    "body": "I merged in Fr\u00e9d\u00e9ric's branch. Since I had already reviewed it, I am allowing myself to set this back to positive review. (I also double-checked by re-running the tests locally.)",
    "created_at": "2021-03-08T01:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359783",
    "user": "tscrim"
}
```

I merged in Frédéric's branch. Since I had already reviewed it, I am allowing myself to set this back to positive review. (I also double-checked by re-running the tests locally.)



---

archive/issue_comments_359784.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-09T00:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25506#issuecomment-359784",
    "user": "vbraun"
}
```

Resolution: fixed
