# Issue 26550: Use C++11 at least as default C++ standard

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2018-11-29 01:51:13

CC:  embray

We should raise the default standard of C++ used to compile sage to C++11 minimum across all standard (and in time) optional packages.


---

Comment by jdemeyer created at 2018-11-29 08:31:02

What do you mean? We already require a C++11 compiler.


---

Comment by fbissey created at 2018-11-29 08:32:50

Replying to [comment:1 jdemeyer]:
> What do you mean? We already require a C++11 compiler.

Yeah but we don't enforce compilation with at least that standard - at least not everywhere. See #25532.


---

Comment by jdemeyer created at 2018-11-29 09:17:18

Replying to [comment:2 fbissey]:
> we don't enforce compilation with at least that standard

Why should Sage enforce C++11 for every package? I would leave that decision to each package individually.


---

Comment by fbissey created at 2018-11-29 09:28:30

Individual packages can over-ride if needed, but as a base we should have a standard that allows ABI compatibility between dependencies. I am talking to have sensible default out of the box for packages, and gnu++98 is not that anymore.

We shouldn't have to play whack-a-mole on a packages dependency just because it uses and enforce c++11 and your compiler doesn't default to at least that. Alternatively you raise the bar on the compiler to get to that default. Hint: default C++ ABI for most recent distro release is c++14. All the problems in #25532 is because some older distro have a compiler that is recent enough to compile sage but doesn't default to at least c++11.


---

Comment by jdemeyer created at 2018-11-29 11:20:16

OK, I see your point now...


---

Comment by slelievre created at 2018-11-29 12:47:18

Changing keywords from "" to "C++11".


---

Comment by fbissey created at 2018-12-05 20:08:21

I have started by updating some macros and I have come to hate one particular commit
http://git.savannah.gnu.org/gitweb/?p=autoconf-archive.git;a=commitdiff;h=bbb60ca79952c20ee0b187208533d98206b156d1;hp=ad15d52fd1e552bc3d7fcfb3d7bc6a2681f364d8

In short, even if you compiler doesn't need a flag to compile c++11 code by default, it will be added nonetheless. Potentially lowering the standard applied (which may or may not be a bad thing).


---

Comment by fbissey created at 2018-12-05 20:38:47

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-12-05 20:38:47

This should be enough.
----
New commits:


---

Comment by git created at 2018-12-05 20:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-12-05 20:47:19

There is an associated clean up that should be done.


---

Comment by fbissey created at 2018-12-05 20:47:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-12-05 20:57:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-12-05 21:05:00

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-12-05 21:05:00

A number of spkg added `-std=c++11` or `-std=gnu++11` in spkg-*. I removed most of these since by default gnu++11 will be selected. The only exception being `fplll` which enforce c++11 in configure but needs gnu++11 on cygwin. The addition was already redundant in brial since I made the latest version default to at least gnu++11 upstream.

There is also a makefile patch in frobby which I decided not to touch. I'd rather someone interested in the optional frobby package to update the patch next time it needs touching.

It will need testing on cygwin in particular.


---

Comment by jdemeyer created at 2019-01-06 17:26:43

I'm a bit lost what this ticket does. I know that I already asked, but I still don't quite understand.


---

Comment by jdemeyer created at 2019-01-06 17:26:43

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2019-01-11 14:14:22

I think you knew, but forgot - it's needed to stop package-wise bikeshedding on C++ versions, to make sure not accidentally incompatible C++ ABIs are created.


---

Comment by jdemeyer created at 2019-01-11 14:42:30

So does the word "default" in the ticket title and description have any meaning? Maybe that's part what is confusing me.


---

Comment by dimpase created at 2019-01-11 14:47:51

Note that different versions of C++ compilers have differently set default values of the `std` parameter. And so it must be enforced in global `CXXFLAGS`. Does the changed title make more sense to you?


---

Comment by dimpase created at 2019-01-11 14:48:04

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2019-01-11 15:33:02

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2019-01-11 15:33:02

I still don't see how the ticket title and Dima's explanation corresponds to the actual branch. The branch is _removing_ C++11 stuff.


---

Comment by dimpase created at 2019-01-11 15:35:27

No, it's removing per-package C++ flags and replacing them with the globally set stuff.


---

Comment by fbissey created at 2019-01-12 22:31:25

I am sorry I am not more responsive across the board. I am on summer holydays after all :)

I'll rebase and check things over once 8.6 is released - no way we'll get that in now.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by git created at 2019-01-27 02:39:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2019-01-27 02:40:15

Rebased.


---

Comment by fbissey created at 2019-01-27 02:40:15

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2019-01-27 06:53:35

In the context of this ticket, I'd like to recall the difference between 
`BLAH=foo ./configure ...` and `./configure BLAH=foo ...`. Could you remind me please?


---

Comment by fbissey created at 2019-01-27 09:51:06

Replying to [comment:27 dimpase]:
> In the context of this ticket, I'd like to recall the difference between 
> `BLAH=foo ./configure ...` and `./configure BLAH=foo ...`. Could you remind me please?

I must say I cannot think of a functional difference on top of my head, but that doesn't mean there isn't any. I usually prefer `./configure BLAH=foo ...` because then `BLAH=foo ...` is recorded in `config.log`. While in the other form it isn't. That can make debugging unpleasant when all you are given is `config.log`.


---

Comment by fbissey created at 2019-01-27 10:07:54

Now I remember why you ask the question. You had a problem with a non autoconf configure script. Anyway there is one important difference.

* in `BLAH=foo ./configure ` you set an environment to run configure.
* in `./configure BLAH=foo ...` `BLAH=foo ...` becomes an argument to configure. Which is why is it is recorded.

In the case you had `BLAH=foo` was actually parsed as a configuration option by the script and because it was a configuration option, prepending it didn't work.


---

Comment by dimpase created at 2019-01-27 10:17:31

Replying to [comment:29 fbissey]:
> Now I remember why you ask the question. You had a problem with a non autoconf configure script.

Yes, that was exactly the thing. (The case in hand was probably flint or mpir, I don't quite recall now).


---

Comment by dimpase created at 2019-01-28 11:35:21

Replying to [comment:29 fbissey]:
> Now I remember why you ask the question. You had a problem with a non autoconf configure script. Anyway there is one important difference.
> 
> * in `BLAH=foo ./configure ` you set an environment to run configure.
> * in `./configure BLAH=foo ...` `BLAH=foo ...` becomes an argument to configure. Which is why is it is recorded.
> 
> In the case you had `BLAH=foo` was actually parsed as a configuration option by the script and because it was a configuration option, prepending it didn't work.

There is also a question what actually happens to `BLAH=foo`  after the `./configure` run.
For some of variables such as `BLAH` the values provided 
are getting stored somewhere, e.g. for `FC` and `CC`.
Is there a list of such stored variables anywhere? E.g. would `FFLAGS` value be stored somewhere?


---

Comment by fbissey created at 2019-01-28 19:05:58

Some of the values from configuration, like compilers are saved in `sage-env-config`. The rest are not preserved in any way. For the C++11 flags (and C99 when it applies) this is saved as part of the definition of the compiler. That is `CXX=g++ -std=gnu++11` for example. There is another ticket somewhere about preserving most of `SAGE_*` and other variable set at configure time in `sage-env-config` but this is not this ticket.


---

Comment by jdemeyer created at 2019-01-29 13:44:33

Replying to [comment:32 fbissey]:
> For the C++11 flags (and C99 when it applies) this is saved as part of the definition of the compiler. That is `CXX=g++ -std=gnu++11` for example.

I think that this is finally the explanation that I asked for.

But that raises the question: why should these flags become part of `CXX` and not `CXXFLAGS`?


---

Comment by dimpase created at 2019-01-29 13:55:15

Replying to [comment:33 jdemeyer]:
> Replying to [comment:32 fbissey]:
> > For the C++11 flags (and C99 when it applies) this is saved as part of the definition of the compiler. That is `CXX=g++ -std=gnu++11` for example.
> 
> I think that this is finally the explanation that I asked for.
> 
> But that raises the question: why should these flags become part of `CXX` and not `CXXFLAGS`?

I think that this branch puts stuff in CXXFLAGS, not in CXX.


---

Comment by fbissey created at 2019-01-29 18:47:36

Replying to [comment:34 dimpase]:
> Replying to [comment:33 jdemeyer]:
> > Replying to [comment:32 fbissey]:
> > > For the C++11 flags (and C99 when it applies) this is saved as part of the definition of the compiler. That is `CXX=g++ -std=gnu++11` for example.
> > 
> > I think that this is finally the explanation that I asked for.
> > 
> > But that raises the question: why should these flags become part of `CXX` and not `CXXFLAGS`?

By putting it in `CXX` you make your compiler c++11 compliant whether it is called with `CXXFLAGS` (as you should) or not.

> 
> I think that this branch puts stuff in CXXFLAGS, not in CXX.

Then the documentation at https://www.gnu.org/software/autoconf-archive/ax_cxx_compile_stdcxx.html would be wrong. And I don't believe that's the case.


---

Comment by dimpase created at 2019-01-30 16:51:15

You are right. Hopefully there are no packages in Sage that try to parse `$CXX` (IIRC, GAP used to parse `$CC`)...


---

Comment by fbissey created at 2019-01-30 18:48:05

Replying to [comment:36 dimpase]:
> You are right. Hopefully there are no packages in Sage that try to parse `$CXX` (IIRC, GAP used to parse `$CC`)...

Hum, I can't do it right now (location and timing). Can you try install `boost` (and not `boost_cropped`) with it?


---

Comment by fbissey created at 2019-02-04 00:31:17

Well building boost was no problem. I do some parsing in there. The patch bot seems relatively happy. Any more questions?


---

Comment by dimpase created at 2019-02-04 01:03:30

Do I get it right that one might not see an explicit `-std=` in the logs, it depends upon the compiler being old enough for these to show up?


---

Comment by fbissey created at 2019-02-04 01:06:37

It used to be the case, but I believe that with the macro I put in this ticket it should always be there. Which is annoying because my intent was ensuring a minimum standard but with the macro at hand it become the standard used not a minimum one. See http://git.savannah.gnu.org/gitweb/?p=autoconf-archive.git;a=commitdiff;h=bbb60ca79952c20ee0b187208533d98206b156d1;hp=ad15d52fd1e552bc3d7fcfb3d7bc6a2681f364d8


---

Comment by fbissey created at 2019-02-04 01:21:58

For info `sage-env-config` with gcc-8.2.0

```
# -*- shell-script -*-

###########################################################################
#
#  Set some environment variables for Sage.
#  This file is generated from sage-env-config.in by configure.
#
#  NOTES:
#  - You must *source* this script instead of executing.
#  - Use "return" instead of "exit" to signal a failure.  Since this
#    file is sourced, an "exit" here will actually exit src/bin/sage,
#    which is probably not intended.
#  - All environment variables set here should be *exported*, otherwise
#    they won't be available in child programs.
#
##########################################################################

# SAGE_LOCAL is the installation prefix and can be customized by using
# ./configure --prefix
export SAGE_LOCAL="/home/fbissey/sandbox/git-fork/sage/local"

#######################################
# Compilers set at configuration time
#######################################
export CONFIGURED_CC="gcc"
export CONFIGURED_CXX="g++ -std=gnu++11"
export CONFIGURED_FC="gfortran"
export CONFIGURED_OBJC="gcc"
export CONFIGURED_OBJCXX="g++"

#######################################
# Other configuration
#######################################
export SAGE_PYTHON_VERSION=2
if [ "$SAGE_PYTHON_VERSION" = 3 ]; then
    export SAGE_PYTHON3=yes
fi
```

As you can see even though my compiler default to gnu++14, `-std=gnu++11` is added.


---

Comment by dimpase created at 2019-02-04 02:50:31

looks good to me, also checked with clang 6.0.1 on FreeBSD.


---

Comment by dimpase created at 2019-02-04 02:50:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-05 16:57:53

Resolution: fixed


---

Comment by vbraun created at 2019-02-10 17:28:39

This broke giac on some platforms: #27252


---

Comment by embray created at 2019-02-12 17:04:24

I guess the question is, how would I _undo_ this for  single package?  How can I revert `-std=gnu++11` at least when building giac?


---

Comment by jdemeyer created at 2019-03-04 16:38:53

This broke building of gfan and lcalc on systems with gcc 4.9.3: #27422
