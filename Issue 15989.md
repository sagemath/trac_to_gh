# Issue 15989: Tachyon plot produces invalid file

archive/issues_015989.json:
```json
{
    "body": "CC:  kcrisman\n\nKeywords: tachyon, plot3d\n\n`Tachyon.plot` does not produce valid syntax for `tachyon_rt`.  The basic problem is that triangles are not printed correctly: they show as tuples instead.  This means that the [examples in the reference manual](http://www.sagemath.org/doc/reference/plot3d/sage/plot/plot3d/tachyon.html#sage.plot.plot3d.tachyon.Tachyon.plot) are broken.\n\nHere is a minimal example:\n\n\n```\nsage: m = lambda u,v: u^2 - v^3\nsage: Q = Tachyon(camera_center=(5,0,4))\nsage: Q.texture('t')\nsage: Q.light((-20,-20,40), 0.2, (1,1,1))\nsage: Q.plot(m,(0,1),(0,1),'t',max_depth=1,initial_depth=1)\n```\n\n\nThe string tachyon tries to render is this:\n\n```\nsage: print(Q.str())\n\n        begin_scene\n...\n        light center  -20.0 -20.0 40.0 \n              rad 0.2\n              color  1.0 1.0 1.0 \n        \n(1/2, 0, 1/4) (1/2, 1/2, 1/8) (1/4, 1/4, 3/64) t(1/2, 0, 1/4) (1/2, 1/2, 1/8) (3/4, 1/4, 35/64) t\n...\n        end_scene\n\n```\n\n\nInstead of 3-tuples, we should see something like this:\n\n```\n...\n        TRI V0  0.5 0.0 0.25   V1  0.5 0.5 0.125    V2  0.25 0.25 0.046875 \n            t\n        \n        TRI V0  0.5 0.0 0.25   V1  0.5 0.5 0.125    V2  0.75 0.25 0.546875 \n            t\n...\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16226\n\n",
    "created_at": "2014-04-24T13:38:44Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "title": "Tachyon plot produces invalid file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15989",
    "user": "niles"
}
```
CC:  kcrisman

Keywords: tachyon, plot3d

`Tachyon.plot` does not produce valid syntax for `tachyon_rt`.  The basic problem is that triangles are not printed correctly: they show as tuples instead.  This means that the [examples in the reference manual](http://www.sagemath.org/doc/reference/plot3d/sage/plot/plot3d/tachyon.html#sage.plot.plot3d.tachyon.Tachyon.plot) are broken.

Here is a minimal example:


```
sage: m = lambda u,v: u^2 - v^3
sage: Q = Tachyon(camera_center=(5,0,4))
sage: Q.texture('t')
sage: Q.light((-20,-20,40), 0.2, (1,1,1))
sage: Q.plot(m,(0,1),(0,1),'t',max_depth=1,initial_depth=1)
```


The string tachyon tries to render is this:

```
sage: print(Q.str())

        begin_scene
...
        light center  -20.0 -20.0 40.0 
              rad 0.2
              color  1.0 1.0 1.0 
        
(1/2, 0, 1/4) (1/2, 1/2, 1/8) (1/4, 1/4, 3/64) t(1/2, 0, 1/4) (1/2, 1/2, 1/8) (3/4, 1/4, 35/64) t
...
        end_scene

```


Instead of 3-tuples, we should see something like this:

```
...
        TRI V0  0.5 0.0 0.25   V1  0.5 0.5 0.125    V2  0.25 0.25 0.046875 
            t
        
        TRI V0  0.5 0.0 0.25   V1  0.5 0.5 0.125    V2  0.75 0.25 0.546875 
            t
...
```


Issue created by migration from https://trac.sagemath.org/ticket/16226





---

archive/issue_comments_207533.json:
```json
{
    "body": "Tachyon plots use `sage.plot.plot3d.tri_plot.TrianglePlot`, which prints objects with `str(o)` ([see tri_plot.py line 233](https://github.com/sagemath/sage/blob/master/src/sage/plot/plot3d/tri_plot.py#L233)).  \n\nOne quick fix is to add `__str__` or `__repr__` methods to `TachyonTriangle` and `TachyonSmoothTriangle` which print appropriately.  There may be a more robust fix though.",
    "created_at": "2014-04-24T13:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207533",
    "user": "niles"
}
```

Tachyon plots use `sage.plot.plot3d.tri_plot.TrianglePlot`, which prints objects with `str(o)` ([see tri_plot.py line 233](https://github.com/sagemath/sage/blob/master/src/sage/plot/plot3d/tri_plot.py#L233)).  

One quick fix is to add `__str__` or `__repr__` methods to `TachyonTriangle` and `TachyonSmoothTriangle` which print appropriately.  There may be a more robust fix though.



---

archive/issue_comments_207534.json:
```json
{
    "body": "A quick and dirty fix which solves the problem at hand but ignores the larger problems of duplicated code and low coordination between `Tachyon.plot` and other surface plots in Sage.\n----\nNew commits:",
    "created_at": "2014-04-25T15:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207534",
    "user": "niles"
}
```

A quick and dirty fix which solves the problem at hand but ignores the larger problems of duplicated code and low coordination between `Tachyon.plot` and other surface plots in Sage.
----
New commits:



---

archive/issue_comments_207535.json:
```json
{
    "body": "Don't worry about coordination on this ticket.  Is this ready for review?",
    "created_at": "2014-04-25T17:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207535",
    "user": "kcrisman"
}
```

Don't worry about coordination on this ticket.  Is this ready for review?



---

archive/issue_comments_207536.json:
```json
{
    "body": "Replying to [comment:3 kcrisman]:\n> Don't worry about coordination on this ticket.  Is this ready for review?\n\nUnfortunately I don't think so.  First, it needs some doctests to have 100% coverage.  Second, I think we need some better doctests for `Tachyon.plot` and other functions, so that regressions like this are less likely in the future.  Like maybe printing out a small portion of the tachyon string (what portion?), or its md5 hash (too fragile?), or checking the file size of the rendered image (too slow?).\n\nLastly, I'm not sure we really want to commit to `__str__` being the same as `.str()`.  Another easy fix which doesn't force this would be to change the `.str()` method of `TrianglePlot` from using\n\n```\n[str(o) for o in self._objects]\n```\n\nto\n\n```\n[o.str() for o in self._objects]\n```\n\nand add a `.str()` method for the default `Triangle` and `SmoothTriangle` classes.  Since `TrianglePlot` isn't used in the rest of Sage, this probably wouldn't cause too much trouble.\n\nMoreover, this would be more consistent with what's done for all the other Tachyon types, and would avoid mixing up what `.str()` means for Tachyon stuff---`.str()` is the exact code to be processed---with what `__str__` means for Python stuff---`__str__` returns a user-readable string describing the object, but need not be as exact as `__repr__`.  Or maybe this mixup is inevitable and we might as well embrace it, even though it's confusing.",
    "created_at": "2014-04-25T18:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207536",
    "user": "niles"
}
```

Replying to [comment:3 kcrisman]:
> Don't worry about coordination on this ticket.  Is this ready for review?

Unfortunately I don't think so.  First, it needs some doctests to have 100% coverage.  Second, I think we need some better doctests for `Tachyon.plot` and other functions, so that regressions like this are less likely in the future.  Like maybe printing out a small portion of the tachyon string (what portion?), or its md5 hash (too fragile?), or checking the file size of the rendered image (too slow?).

Lastly, I'm not sure we really want to commit to `__str__` being the same as `.str()`.  Another easy fix which doesn't force this would be to change the `.str()` method of `TrianglePlot` from using

```
[str(o) for o in self._objects]
```

to

```
[o.str() for o in self._objects]
```

and add a `.str()` method for the default `Triangle` and `SmoothTriangle` classes.  Since `TrianglePlot` isn't used in the rest of Sage, this probably wouldn't cause too much trouble.

Moreover, this would be more consistent with what's done for all the other Tachyon types, and would avoid mixing up what `.str()` means for Tachyon stuff---`.str()` is the exact code to be processed---with what `__str__` means for Python stuff---`__str__` returns a user-readable string describing the object, but need not be as exact as `__repr__`.  Or maybe this mixup is inevitable and we might as well embrace it, even though it's confusing.



---

archive/issue_comments_207537.json:
```json
{
    "body": "Here's a different branch which entirely throws out `__str__` and `__repr__` for Tachyon objects.  All methods are doctested, and all tests pass in sage/plot.  I'm running (long) tests on the whole sage library now.\n\nThe plotting examples in tachyon.py are working as expected.\n----\nNew commits:",
    "created_at": "2014-04-25T20:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207537",
    "user": "niles"
}
```

Here's a different branch which entirely throws out `__str__` and `__repr__` for Tachyon objects.  All methods are doctested, and all tests pass in sage/plot.  I'm running (long) tests on the whole sage library now.

The plotting examples in tachyon.py are working as expected.
----
New commits:



---

archive/issue_comments_207538.json:
```json
{
    "body": "Replying to [comment:5 niles]:\n>  I'm running (long) tests on the whole sage library now.\n\n... aaaaand all tests pass!\n\nUnless someone has a better idea, I can write something that prints the md5 digest of tachyon strings, and add some TEST docstrings that use it.",
    "created_at": "2014-04-25T20:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207538",
    "user": "niles"
}
```

Replying to [comment:5 niles]:
>  I'm running (long) tests on the whole sage library now.

... aaaaand all tests pass!

Unless someone has a better idea, I can write something that prints the md5 digest of tachyon strings, and add some TEST docstrings that use it.



---

archive/issue_comments_207539.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-28T16:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207539",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_207540.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-28T16:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207540",
    "user": "niles"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_207541.json:
```json
{
    "body": "Ok, this is ready for review.  I did try implementing a hash function, but this was even more fragile than I expected.  Triangulations of surfaces can vary depending on floating point rounding and maybe other things too.  So I just used `.show(verbose=1)` in a few places to verify that the plots are processed without error.\n\nIdeally, the raytracing function `tachyon_rt` would throw an error if the raytracing is not successful, but that is a problem for another ticket: #16262.",
    "created_at": "2014-04-28T16:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207541",
    "user": "niles"
}
```

Ok, this is ready for review.  I did try implementing a hash function, but this was even more fragile than I expected.  Triangulations of surfaces can vary depending on floating point rounding and maybe other things too.  So I just used `.show(verbose=1)` in a few places to verify that the plots are processed without error.

Ideally, the raytracing function `tachyon_rt` would throw an error if the raytracing is not successful, but that is a problem for another ticket: #16262.



---

archive/issue_comments_207542.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-07-26T11:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207542",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_207543.json:
```json
{
    "body": "There seems to be a problem in one of str methods:\n\nDoc claims to give \n\n\n`a b c da db dc color`\n\n\nbut the result is `[1, 2, 3] [2, 3, 4] [0, 0, 0] 0 [0, 0, 1] [0, 1, 0] [1, 0, 0]`\n\nwhich looks more like `a b c color da db dc`",
    "created_at": "2014-07-26T11:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207543",
    "user": "chapoton"
}
```

There seems to be a problem in one of str methods:

Doc claims to give 


`a b c da db dc color`


but the result is `[1, 2, 3] [2, 3, 4] [0, 0, 0] 0 [0, 0, 1] [0, 1, 0] [1, 0, 0]`

which looks more like `a b c color da db dc`



---

archive/issue_comments_207544.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-28T18:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207544",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_207545.json:
```json
{
    "body": "good catch -- fixed now",
    "created_at": "2014-07-28T18:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207545",
    "user": "niles"
}
```

good catch -- fixed now



---

archive/issue_comments_207546.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-07-28T18:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207546",
    "user": "niles"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_207547.json:
```json
{
    "body": "Looks good to me. Positive review.",
    "created_at": "2014-08-01T20:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207547",
    "user": "chapoton"
}
```

Looks good to me. Positive review.



---

archive/issue_comments_207548.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-08-01T20:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207548",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_207549.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-08-02T12:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15989#issuecomment-207549",
    "user": "vbraun"
}
```

Resolution: fixed
