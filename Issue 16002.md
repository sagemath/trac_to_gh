# Issue 16002: ZZ in the wrong category

Issue created by migration from https://trac.sagemath.org/ticket/16239

Original creator: tscrim

Original creation time: 2014-04-26 04:58:25

Assignee: sage-combinat

CC:  sage-combinat nthiery

Keywords: integer ring, category


```
sage: ZZ.categories()
[Category of euclidean domains,
 Category of principal ideal domains,
 Category of unique factorization domains,
 Category of gcd domains,
 Category of integral domains,
 Category of domains,
 Category of commutative rings,
 Category of rings,
 Category of rngs,
 Category of semirings,
 Category of monoids,
 Category of semigroups,
 Category of magmas,
 Category of commutative additive groups,
 Category of commutative additive monoids,
 Category of commutative additive semigroups,
 Category of additive magmas,
 Category of sets,
 Category of sets with partial maps,
 Category of objects]
```

Notice that it is not an infinite enumerated set.


---

Comment by tscrim created at 2014-05-26 02:01:24

Changing status from new to needs_review.


---

Comment by tscrim created at 2014-05-26 02:01:24

Surprisingly simple fix since `ZZ` is an old parent.
----
New commits:


---

Comment by git created at 2014-05-26 21:26:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-05-26 21:27:38

I am running all tests now. If they pass, and you agree with my changes, it's good to go!


---

Comment by tscrim created at 2014-05-26 21:40:24

I'm good with your changes. Go ahead and set to positive review once all tests pass.


---

Comment by nthiery created at 2014-05-26 22:05:20

I get a bunch of failing tests; most seem trivial, but I did not have time to check in detail:

```
sage -t --long src/sage/structure/parent.pyx  # Killed due to kill signal
sage -t --long src/sage/structure/element.pyx  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/root_space.py  # Bad exit: 1
sage -t --long src/sage/matrix/matrix_space.py  # Killed due to kill signal
sage -t --long src/sage/categories/primer.py  # 2 doctests failed
sage -t --long src/sage/dev/git_interface.py  # 22 doctests failed
sage -t --long src/sage/categories/category.py  # 3 doctests failed
sage -t --long src/sage/categories/map.pyx  # 1 doctest failed
sage -t --long src/sage/sets/set_from_iterator.py  # 1 doctest failed
sage -t --long src/sage/categories/homset.py  # 1 doctest failed
sage -t --long src/sage/rings/polynomial/polynomial_ring.py  # 1 doctest failed
sage -t --long src/sage/misc/dev_tools.py  # 1 doctest failed
sage -t --long src/doc/en/tutorial/tour_coercion.rst  # 1 doctest failed
sage -t --long src/sage/structure/category_object.pyx  # 1 doctest failed
sage -t --long src/doc/fr/tutorial/tour_coercion.rst  # 1 doctest failed
sage -t --long src/sage/categories/category_types.py  # 2 doctests failed
sage -t --long src/doc/en/thematic_tutorials/tutorial-objects-and-classes.rst  # 2 doctests failed
sage -t --long src/sage/misc/sage_unittest.py  # 2 doctests failed
sage -t --long src/sage/categories/bimodules.py  # 2 doctests failed
```



---

Comment by git created at 2014-05-27 17:03:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-05-27 17:12:59

I had to partially revert your change in order to get `(QQ^2).list()` (or any other infinite [enumerated] set that's not in the category) to raise an error. I'm not quite sure what happened with the doctest in `misc/dev_tools.py`, nor am I completely confident in the `tutorial-objects-and-classes.rst` doctest fixes (please double check those). I couldn't get anything to break in the `dev/git_interface.py`.

edit - removed a stupid idea due to the overwhelming changes it would entail.


---

Comment by tscrim created at 2014-06-11 04:00:57

Also I should make it clear, the error came from `QQ` not being in the correct category. So should we also change that here while we're at it?


---

Comment by vdelecroix created at 2014-06-15 16:12:52

Hello,

While we are at it, this is not an isolated case...

```
sage: std_sets = [ZZ, QQ, RDF, CDF, AA, QQbar, RR, CC]
sage: any(x in Sets().Infinite() for x in std_sets)
False
```

We can open another ticket for the remaining ones.

Vincent


---

Comment by tscrim created at 2014-06-15 16:36:50

I'm hoping to not open a can of worms, but technically `RDF`, `CDF`, `RR`, `CC` are not infinite sets as they have a _fixed_ finite precision. Although this would be somewhat surprising for beginners. Plus if we ignore this, we could make a category for char 0 fields, which IMO is a useful distinction and we make as a join `Fields() & Sets().Infinite()` (plus these "fields" already have worse abuses). But definitely another ticket.


---

Comment by vdelecroix created at 2014-06-15 17:10:49

Replying to [comment:11 tscrim]:
> I'm hoping to not open a can of worms, but technically `RDF`, `CDF`, `RR`, `CC` are not infinite sets as they have a _fixed_ finite precision. Although this would be somewhat surprising for beginners. Plus if we ignore this, we could make a category for char 0 fields, which IMO is a useful distinction and we make as a join `Fields() & Sets().Infinite()` (plus these "fields" already have worse abuses). But definitely another ticket.

You are right for `RDF` and `CDF` but for `RR` and `CC`, technically, these are infinite: the mantisse is finite but the exponent is arbitrary precision (because of mpfr). And again, technically speaking these are not fields ;-)


---

Comment by nbruin created at 2014-06-15 17:43:44

Replying to [comment:11 tscrim]:
> Plus if we ignore this, we could make a category for char 0 fields, which IMO is a useful distinction and we make as a join `Fields() & Sets().Infinite()`
??? Infinite fields are not necessarily of characteristic zero, see for instance `FieldOfFractions(GF(q)['t'])`.

It could be something like `Fields() & AssociativeAlgebras(QQ)`, although implementation dictates we should avoid referencing parametrized bases for categories whenever possible (this case wouldn't be so bad, since QQ just a single object. It's when characteristic p fields are made as `Fields() & AssociativeAlgebras(GF(p))` that we have a problem.)


---

Comment by tscrim created at 2014-06-16 05:50:01

Replying to [comment:13 nbruin]:
> Replying to [comment:11 tscrim]:
> > Plus if we ignore this, we could make a category for char 0 fields, which IMO is a useful distinction and we make as a join `Fields() & Sets().Infinite()`
> ??? Infinite fields are not necessarily of characteristic zero, see for instance `FieldOfFractions(GF(q)['t'])`.

However what I said is all fields of characteristic 0 are fields and infinite sets (as we can always add 1 more).

> It could be something like `Fields() & AssociativeAlgebras(QQ)`, although implementation dictates we should avoid referencing parametrized bases for categories whenever possible (this case wouldn't be so bad, since QQ just a single object. It's when characteristic p fields are made as `Fields() & AssociativeAlgebras(GF(p))` that we have a problem.)

Hmmm...that's an interesting idea. Nicolas, how feasible would that be?


---

Comment by git created at 2014-07-01 17:47:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-07-01 17:50:26

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2014-07-01 17:50:26

Back to the ticket at hand: I am happy with Travis changes and he looked over my final tweaks. Good to go!


---

Comment by vbraun created at 2014-07-03 02:03:49

Resolution: fixed


---

Comment by vbraun created at 2014-07-03 04:10:27

Changing status from closed to new.


---

Comment by vbraun created at 2014-07-03 04:10:27

Long doctests eat all my memory in `sage.matrix.matrix_space`. Looks like matrix space `MatrixSpace(QQ, 7)` trying to figure out whether it is finite or not.


---

Comment by vbraun created at 2014-07-03 04:10:27

Resolution changed from fixed to 


---

Comment by tscrim created at 2014-07-06 01:48:41

Changing status from new to needs_review.


---

Comment by tscrim created at 2014-07-06 01:48:41

Hey Nicolas,

I remember why I had things that way:

```
sage: QQ in Sets().Infinite()
False
sage: MS = MatrixSpace(ZZ, 7)
sage: MS in Sets().Infinite()
False
```

There will be a much larger fix needed for modules over infinite base rings recognizing that they are infinite (and `QQ` and friends will need to be in `Sets().Infinite()`). For now, I just reverted the change and added a comment. If that's okay for now, then can you set this back to positive review? Thanks.
----
New commits:


---

Comment by git created at 2014-07-11 11:55:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-07-11 11:57:30

Replying to [comment:19 tscrim]:
> I remember why I had things that way:
> {{{
> sage: QQ in Sets().Infinite()
> False
> sage: MS = MatrixSpace(ZZ, 7)
> sage: MS in Sets().Infinite()
> False
> }}}
> There will be a much larger fix needed for modules over infinite base rings recognizing that they are infinite (and `QQ` and friends will need to be in `Sets().Infinite()`

Gosh, that's ugly. Oh well, we will have to do with it I guess. Thanks! I improved a bit the wording, and now back to positive review.
----
New commits:


---

Comment by nthiery created at 2014-07-11 11:57:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-07-12 00:37:55

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-07-12 00:37:55


```
sage -t --long src/sage/sets/set_from_iterator.py
**********************************************************************
File "src/sage/sets/set_from_iterator.py", line 139, in sage.sets.set_from_iterator.EnumeratedSetFromIterator
Failed example:
    TestSuite(E).run()
Expected nothing
Got:
    doctest:291: UserWarning: Testing equality of infinite sets which will not end in case of equality
```



---

Comment by tscrim created at 2014-07-15 03:42:09

The warning is issued by `EnumeratedSetFromIterator` when `_test_an_element` calls `self(an_element)` where `self` is `E`. From there, the parent of `an_element` is `ZZ`, which the parent's default `__call__` tries to see if the parent is `self` by equality, leading to the `__eq__` call with `ZZ` being a different enumerated set.

So how do we fix this? I'm not quite sure what the best way to proceed is, put the warning in the test, remove the warning, rework `_test_an_element` to better support facade parents, ...?


---

Comment by vdelecroix created at 2014-07-15 07:14:08

Hey,

Funny that this has been catch in `set_from_iterator`. The warning is useful, so please, keep it.

It looks ok for me if you modify the doctest explaining what happened. For me it is a facade issue as a facade should be childless (i.e. there is no point in testing whether an element has a parent a given facade).

Vincent


---

Comment by tscrim created at 2014-07-15 17:54:40

Replying to [comment:24 vdelecroix]:
> It looks ok for me if you modify the doctest explaining what happened. For me it is a facade issue as a facade should be childless (i.e. there is no point in testing whether an element has a parent a given facade).

It's not checking that it is a child of a facade parent, but that the facade parents `__call__` (and the `_element_constructor_`?) doesn't change the element. I'm wondering if facade parents should work with the coercion framework differently...

Well, for now I will just add the warning to the doctest unless anyone objects.


---

Comment by git created at 2014-07-15 17:58:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-07-15 17:59:17

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2014-07-16 21:24:18

I am on vacations for the next couple weeks. So please someone take over the last bit of review!

Cheers,
                               Nicolas


---

Comment by git created at 2014-08-14 10:30:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-16 04:49:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-08-16 04:50:30

Replying to [comment:25 tscrim]:
> Replying to [comment:24 vdelecroix]:
> > It looks ok for me if you modify the doctest explaining what happened. For me it is a facade issue as a facade should be childless (i.e. there is no point in testing whether an element has a parent a given facade).
> 
> It's not checking that it is a child of a facade parent, but that the facade parents `__call__` (and the `_element_constructor_`?) doesn't change the element. I'm wondering if facade parents should work with the coercion framework differently...

Whenever possible, facade parents should indeed make sure that
F(F.an_element()) == F.an_element(), and bark on
F(something_outside). Now there are many occasions, like here
probably, where it might be hard, or costly, or just impossible to
achieve.

> Well, for now I will just add the warning to the doctest unless anyone objects.

Yeah, that's life. I am ok with the change.

I ran all long tests, and with the little new commit, all tests pass. Back to positive review!

Thanks!
                                                 Nicolas
----
New commits:


---

Comment by nthiery created at 2014-08-16 04:50:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-08-16 09:32:25

Resolution: fixed
