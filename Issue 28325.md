# Issue 28325: Tensor Fields: Better Zero Treatment

Issue created by migration from https://trac.sagemath.org/ticket/28562

Original creator: @DeRhamSource

Original creation time: 2019-10-06 09:59:02

CC:  tscrim egourgoulhon

Keywords: manifolds, tensor fields, scalar fields, mixed forms

The zero element is always a special element. Therefore it should be treated as such. It should shorten computations and certainly be immutable. This ticket is devoted to that topic. (Similarly for the one element in the scalar field and mixed form algebra).

This ticket is part of the metaticket #28519.


---

Comment by @DeRhamSource created at 2019-10-06 10:02:42

New commits:


---

Comment by git created at 2019-10-06 12:02:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-07 19:10:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-07 19:12:40

Changing component from PLEASE CHANGE to geometry.


---

Comment by @DeRhamSource created at 2019-10-07 19:12:40

Changing status from new to needs_review.


---

Comment by @DeRhamSource created at 2019-10-07 19:16:29

In `MixedForm`, the zero (and one element for scalar fields) is treated separately. The code in there is not very beautiful, but it works for now. However, I plan to reorganize the code of mixed forms anyway (see #28519).


---

Comment by @DeRhamSource created at 2019-10-07 19:18:46

Also, I removed the `_zero_element` attribute in the free modules and replaced it by a cached `zero()` method. This is a better solution, I guess.


---

Comment by git created at 2019-10-07 20:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-07 20:14:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-07 20:24:30

The code snippet (see commits 5d30100 and â€‹d949a13) was quite messy. Well, it still is. At least it is readable and works for now. It gets a little bit better after merging (see #28519).

I will think about a better solution. But I guess, this requires a complete reorganization of the mixed form code.


---

Comment by @DeRhamSource created at 2019-10-08 23:11:12

After a bit of thinking, I came to the conclusion that the code snippet should be obsolete. (As a mathematician, I feel the urge to solve or fix a problem/error as soon as it occurs. Here: Doctest errors.) The thing is, due to our little discussion in #28519, the doctest must be flawed since mixed forms defined via preconstructed forms get altered.

So, I 'm going to delete this snippet again and modify the affected doctests.

Do you agree with my conclusion and procedure?

A further doctest change is devoted to #28578.


---

Comment by @DeRhamSource created at 2019-10-08 23:11:12

Changing status from needs_review to needs_info.


---

Comment by egourgoulhon created at 2019-10-09 08:45:32

Replying to [comment:13 gh-DeRhamSource]:
> After a bit of thinking, I came to the conclusion that the code snippet should be obsolete. 

Which code snippet are you talking about? All the code in this ticket branch?


---

Comment by @DeRhamSource created at 2019-10-09 08:53:23

Replying to [comment:15 egourgoulhon]:
> Replying to [comment:13 gh-DeRhamSource]:
> > After a bit of thinking, I came to the conclusion that the code snippet should be obsolete. 
> 
> Which code snippet are you talking about? All the code in this ticket branch?
> 
No, only the last two/three commits. Namely the changes in `set_restriction` of `mixed_form.py`.


---

Comment by egourgoulhon created at 2019-10-09 13:13:22

Replying to [comment:13 gh-DeRhamSource]:
> After a bit of thinking, I came to the conclusion that the code snippet should be obsolete. (As a mathematician, I feel the urge to solve or fix a problem/error as soon as it occurs. Here: Doctest errors.) The thing is, due to our little discussion in #28519, the doctest must be flawed since mixed forms defined via preconstructed forms get altered.
> 
> So, I 'm going to delete this snippet again and modify the affected doctests.
> 
> Do you agree with my conclusion and procedure?

I am not sure to understand what you have in mind; I would say please go on and implement what you think is the best solution.


---

Comment by @DeRhamSource created at 2019-10-10 14:05:01


```
sage: M = Manifold(2, 'M') # the 2-dimensional sphere S^2
sage: U = M.open_subset('U') # complement of the North pole
sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
sage: V = M.open_subset('V') # complement of the South pole
sage: c_uv.<u,v> = V.chart() # stereographic coordinates from the South pole
sage: M.declare_union(U,V)   # S^2 is the union of U and V
sage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),
....:                intersection_name='W', restrictions1= x^2+y^2!=0,
....:                restrictions2= u^2+v^2!=0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: e_xy = c_xy.frame(); e_uv = c_uv.frame()
sage: f = M.scalar_field(x, name='f')
sage: omega = M.diff_form(1, name='omega')
sage: omega[e_xy,0] = x
sage: F = M.mixed_form(name='F', comp=[f, omega, 0])
sage: F.add_comp_by_continuation(e_xy, U.intersection(V), c_xy)
sage: F.add_comp_by_continuation(e_uv, U.intersection(V), c_uv)
```


This is an example of how I used `add_comp_by_continuation` in the doctest. Obviously, this is a _bad_ example. To ensure the "immutability" of mixed forms, the `comp` attribute should be used for already fully defined differential forms only. Whenever a incremental definition is explicitly wanted, `F[1][e_xy,0] = x` or `F[1] = M.one_form({e_xy: [x,0]}, name='omega')` should be used instead, and **then** `add_comp_by_continuation` is reasonable to use.

At least, that is my suggestion of how to use mixed forms.

Travis? Would you agree?


---

Comment by tscrim created at 2019-10-10 14:12:44

I am not sure I completely understand the question, or the subtleties in the use case. So I don't think I can make a reasonable comment here.


---

Comment by @DeRhamSource created at 2019-10-10 15:05:59

Mh. Sorry for that. I try again: The thing in the example above is that the zero element gets manipulated via `add_comp_by_continuation`, or `set_restriction` respectively. This indicates, the whole example (even if there is no zero element involved) is a bad use of this methods.

Better would be:



```
sage: M = Manifold(2, 'M') # the 2-dimensional sphere S^2
sage: U = M.open_subset('U') # complement of the North pole
sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
sage: V = M.open_subset('V') # complement of the South pole
sage: c_uv.<u,v> = V.chart() # stereographic coordinates from the South pole
sage: M.declare_union(U,V)   # S^2 is the union of U and V
sage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),
....:                intersection_name='W', restrictions1= x^2+y^2!=0,
....:                restrictions2= u^2+v^2!=0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: e_xy = c_xy.frame(); e_uv = c_uv.frame()
sage: f = M.scalar_field(x, name='f')
sage: f.add_expr_by_continuation(c_uv, U.intersection(V))
sage: omega = M.diff_form(1, name='omega')
sage: omega[e_xy,0] = x
sage: omega.add_comp_by_continuation(e_uv, U.intersection(V), c_uv)
sage: F = M.mixed_form(name='F', comp=[f, omega, 0])
```


Yet, I noticed that `add_comp_by_continuation` seems not being convenient at all. It runs into problems as soon as there is a homogeneous component defined which should not be altered or has no tensor component in the corresponding intersection domain. Therefore, if one single homogeneous component shall be zero, and all other components shall be continued, which is a reasonable use, this methods fails to fulfill its purpose.

Sorry, I'm not that much into that kind of thinking, especially the immutability of sage objects, and may confuse all around me including myself. :D


---

Comment by git created at 2019-10-10 21:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-10 21:23:53

Changing status from needs_info to needs_review.


---

Comment by @DeRhamSource created at 2019-10-10 21:23:53

What about this?


---

Comment by tscrim created at 2019-10-11 01:11:35

I guess it depends on how you define zero. Although if I think of this like a graded module, `0` exists in all graded parts simultaneously, so by analogy, the `add_comp_by_continuation` does work correctly. Although as a computer implementation that requires some more precision, this might not be feasible.


---

Comment by @DeRhamSource created at 2019-10-11 07:15:27

Changing status from needs_review to needs_work.


---

Comment by @DeRhamSource created at 2019-10-11 07:15:27

Yes, you're absolutely right. So, seeing things more from the mathematical point of view is always the way to go, right?

The problem here is that `add_comp_by_continuation` invokes the `add_comp` method for tensor fields which raises an error when it is used by the zero element. To make it usable in this case, a separate treatment of zero must be implemented.


---

Comment by @DeRhamSource created at 2019-10-12 12:36:53

I started the whole thing again from scratch since `add_comp_by_continuation` did not work properly in a mathematical manner.

Moreover, I (hopefully) improved the preexisting code.

In the commits, there are two alternatives presented: One using a flag `check_elements` and one using a separate method without security check. I'd prefer the second solution. It is completely hidden for the user and may become convenient when more checks are established in the future.


---

Comment by @DeRhamSource created at 2019-10-12 12:36:53

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-10-12 12:50:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-12 17:45:10

What I wanted to say with my previous message: I am not a professional programmer, however I had quite a few difficulties in modifying the code and perform a proper debugging. There are some code redundancies and hidden dependencies which could be susceptible for further modifications (like: a modification of `add_comp` in `tensorfield.py` caused severe troubles in `automorphismfield.py`). Perhaps, some code delegations and/or reusabilities are useful in the farther future?


---

Comment by git created at 2019-10-12 18:35:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-12 19:18:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-10-13 21:34:19

I just gave a quick look at the latest version. Looks good. I'll have a deeper look tomorrow.


---

Comment by git created at 2019-10-17 09:08:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-10-22 10:24:43

I've finally gone through the ticket. The impression stated in comment:30 is confirmed: this is a nice improvement of the code! Thank you. I have made minor modifications, which have been pushed in the above branch. In particular 
- the pyflake error reported by the patchbot is corrected
- `t(0)` has been changed to `t.zero()` and `gl(1)` to `gl.one()` (to skip one function call)
- some `add/set_comp(basis)` have been changed to `add/set_comp(basis=basis)`
- the treatment of zero has been added in `FreeModuleTensor._sub_()`

Do you agree with these changes?
----
New commits:


---

Comment by @DeRhamSource created at 2019-10-22 10:53:17

Yes, looks good! :)


---

Comment by tscrim created at 2019-10-22 14:21:23

I just have two trivial changes:

```diff
-The components w.r.t. basis e have been kept::
+The components with respect to basis ``e`` have been kept::
```

and in `automorphismfield.py`:

```
    def add_comp(self, basis=None):
        r"""

        Return the components of ``self`` w.r.t. a given module basis for
        assignment, keeping the components w.r.t. other bases.

        To delete the components w.r.t. other bases, use the method
        :meth:`set_comp` instead.
```

remove the blank line after `r"""` and same thing of spelling out `w.r.t.` (although I suspect this is done elsewhere, I think it is better to avoid abbreviations like this as this is a more "formal" document, but I don't care too much).


---

Comment by egourgoulhon created at 2019-10-22 14:31:14

On my side, one last remark: the names of the methods `_add_comp_unsafe()` and `_set_comp_unsafe()` give the impression that they are really dangerous methods that should be avoided, while they are key methods, doing most of the work of `add_comp()` and `set_comp()`. 
Since they are *private* methods, I don't think it is necessary to insist too much on their "unsafe" aspect, which is truly unsafe only when invoked on the special elements zero and one. Wouldn't something like `_add_comp_nocheck()` and `_set_comp_nocheck()` be better names? Travis, do you have an opinion on that?


---

Comment by tscrim created at 2019-10-22 14:33:16

This naming convention matches what is done for vectors (and maybe matrices?) in Sage. Although in that case, if you mess with things in the wrong way, you will crash Sage. However, given the nomenclature of other methods, I think `*_unsafe` is the way to go.


---

Comment by egourgoulhon created at 2019-10-22 14:39:50

Replying to [comment:36 tscrim]:
> This naming convention matches what is done for vectors (and maybe matrices?) in Sage. 

Ah yes! (`grep -r "_unsafe"` in `src/sage` returns 872 entries; I was not aware of that). So OK for `*_unsafe` then...


---

Comment by git created at 2019-10-22 15:11:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-22 15:11:55

Replying to [comment:34 tscrim]:
> I just have two trivial changes:
> {{{#!diff
> -The components w.r.t. basis e have been kept::
> +The components with respect to basis ``e`` have been kept::
> }}}

Since this issue is not just devoted to this ticket, I vote for a new ticket on that.

> and in `automorphismfield.py`:
> {{{
>     def add_comp(self, basis=None):
>         r"""
> 
>         Return the components of ``self`` w.r.t. a given module basis for
>         assignment, keeping the components w.r.t. other bases.
> 
>         To delete the components w.r.t. other bases, use the method
>         :meth:`set_comp` instead.
> }}}
> remove the blank line after `r"""` and same thing of spelling out `w.r.t.` (although I suspect this is done elsewhere, I think it is better to avoid abbreviations like this as this is a more "formal" document, but I don't care too much).

Done.


---

Comment by egourgoulhon created at 2019-10-22 18:52:49

Replying to [comment:39 gh-DeRhamSource]:
> Replying to [comment:34 tscrim]:
> > I just have two trivial changes:
> > {{{#!diff
> > -The components w.r.t. basis e have been kept::
> > +The components with respect to basis ``e`` have been kept::
> > }}}
> 
> Since this issue is not just devoted to this ticket, I vote for a new ticket on that.
> 

Indeed. I am afraid I am responsible for most of these `w.r.t.` ;-)


---

Comment by egourgoulhon created at 2019-10-22 18:54:06

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-10-22 18:54:06

Thanks for your work on this!


---

Comment by vbraun created at 2019-10-26 22:20:26

Resolution: fixed
