# Issue 28625: Localization of integral domains

Issue created by migration from https://trac.sagemath.org/ticket/28862

Original creator: soehms

Original creation time: 2019-12-09 22:03:49

CC:  tscrim vdelecroix

Keywords: rings integral domains localization fraction field

Localization is an important ring construction tool, which isn't available in Sage, so far. Whenever you have to extend a given integral domain such that it contains the inverses of a finite set of elements but should allow non injective homomorphic images this construction will be needed. Such situations occur for base rings of certain algebras, for example Hecke algebras as pointed out in comment 9 of ticket #27371.

This ticket implements a class for this construction following an example given in the reference pages on coercion (thanks to Vincent for this hint):
[coercion example](http://doc.sagemath.org/html/en/reference/coercion/index.html?highlight=localization#example>)




---

Comment by soehms created at 2019-12-09 22:11:06

Changing status from new to needs_review.


---

Comment by soehms created at 2019-12-09 22:11:06

The first example I've included in my initial attempt raises the following questions:

How should the behavior of matrix inversion over a localization be? By default it is a matrix over the field of fraction. In the doc-string of `sage.matrix.matrix0.__invert__` this is explained by analogy to the behavior over the integers: `parent(~1) == Rational Field`. I think for a matrix over a localization the user would expect to obtain a matrix over an appropriate localization again (being equal or extending the former one). Shouldn't we change this behavior, as well?

----
New commits:


---

Comment by git created at 2019-12-10 19:41:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-10 21:18:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-11 19:42:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-01 08:48:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-02-01 08:50:48

Just fixed merge conflict!


---

Comment by tscrim created at 2020-02-03 00:16:33

Overall this looks good and seems like a feature that should have been in Sage sometime ago. However, I do have some comments:


```diff
-Coercion from Localization::
+Coercion from a localization::
```


I am not sure I like this:

```
parent.__make_element_class__(FractionFieldEmbedding)
```

It doesn't feel right to be getting into the internal workings. Homsets are also somewhat special (and we don't have a good mechanism for parents with multiple element classes), so I use one of the following:

```
parent.element_class(foo)
FractionFieldEmbedding(foo)
```


I would get rid of this comment:

```
The implementation of this class is based on an example given in the reference pages on coercion:

`coercion example <http://doc.sagemath.org/html/en/reference/coercion/index.html?highlight=localization#example>`_
```

and instead just say localizations inherit from `IntegralDomain` and the consequences. I might also consider moving much of the module-level documentation to the class-level documentation as it is something specific to that implementation and is easier to see from the command line via `?`.

I don't think you need to say where the example comes from. So I would remove this:

```
taken from comment #9 of :trac:`27371`
```


The items of `INPUT:` do not end with a period/full-stop. The `OUTPUT:` should either start with a capital letter or not end with a period/full-stop.

The `list` is redundant here:

```diff
-return sorted(list(set(add_units_result)))
+return sorted(set(add_units_result))
```


For `__init__`, a good thing to put in there is a `TestSuite(foo).run()` call.

`Realizes` -> `Realize` (although I would say `Compute` probably).

`is_unit` and `inverse_of_unit` should have at least a one-line description.

In `_richcmp_`, this test is vacuous:

```
if self.parent() != other.parent():
    return super(Localization, self)._richcmp_(other, op)
```

since by the time it gets there, it must be in the same parent. Also


```diff
-INPUT (to the constructor):
+INPUT:
```


Error messages should start with a lowercase letter.


```diff
-        Return the i-th generator of self which is
-        the i-th generator of the base ring.
+        Return the ``i``-th generator of ``self``, which is
+        the ``i``-th generator of the base ring.
```



---

Comment by git created at 2020-02-07 20:09:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-02-07 20:12:57

I could follow all of your suggestions except the one about the definition of the coercion into the field of fraction.

Maybe I didn't get your suggestion, correctly. But, if I try it like this:


```diff
+   return FractionFieldEmbedding(S, self, category=parent.homset_category())
-   return parent.__make_element_class__(FractionFieldEmbedding)(S, self, category=parent.homset_category())
```



I'm getting the following:


```py
sage: R.<x> = QQ[]
sage: L = R.localization(x**2+1)
sage: f = L.fraction_field().coerce_map_from(L)
sage: TestSuite(f).run()
Failure in _test_category:
Traceback (most recent call last):
...
The following tests failed: _test_category
```


Can we ignore that? An according doctest has been in the code with respect to the coercion from the base ring into its field of fraction.


---

Comment by tscrim created at 2020-02-07 22:09:14

Ah, so this pattern has been used in many other places in the Sage code. Thus it is good to do this. I might need to make some appropriate changes to some of my code now that I know about this pattern. Thanks.


---

Comment by tscrim created at 2020-02-07 22:09:14

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-02-07 22:13:24

Ah, one more quick thing: the long (>80 chars) lines in the `EXAMPLES::` of the module-level doc of `localization.py`. I thought I had that in my comments. For the code part, it is less important, but you can also have outputs like:

```
Multivariate Polynomial Ring in u0, u1, u2, q over Integer Ring localized at
 (q, q + 1, u2, u1, u1 - u2, u0, u0 - u2, u0 - u1, u2*q - u1, u2*q - u0,
  u1*q - u2, u1*q - u0, u0*q - u2, u0*q - u1)
```

In particular, allowing the code parts to break the 80 char/line guideline is okay when it makes the break more natural IMO. Although it is still good to try and follow it.

Once changed, you can set it back to a positive review.


---

Comment by tscrim created at 2020-02-07 22:13:24

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-02-08 07:58:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-02-08 07:59:52

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2020-02-08 07:59:52

Now, PDF-docs look much nicer! Thanks a lot!


---

Comment by vbraun created at 2020-02-10 20:05:59

Resolution: fixed
