# Issue 21329: Task ticket: Make sage (the distribution) behave like a standard autotools package, to the extent possible

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-09-22 18:27:28

CC:  vbraun jdemeyer fbissey embray dimpase was mmezzarobba thansen @timokau jhpalmieri slabbe

The goal of this ticket is to be able to explain to experienced Unix users what sage-the-distribution is, as follows:

 If you download sage-the-distribution and do
 {{{
 ./configure --prefix=/SOMEWHERE && make 
 }}}
 then that's the same as doing a sequence of about 100 times: 
 {{{
wget SOMEPACKAGE.tar.gz && tar xf SOMEPACKAGE.tar.gz && (cd SOMEPACKAGE \
&& ./configure --prefix=/SOMEWHERE && make && make install)
 }}}
 (and about a 50 times `pip install SOMEPACKAGE`).
 sage-the-distribution has figured out the right order of installing these packages, tricky configure options so that everything works, and on top has fixes for various outdated/handwritten/missing build systems of various packages.

Thus it is beyond the scope of this ticket:
 - to separate `make` and `make install`. Our `make install` is a no-op. ANY discussion of this needs to go to ticket #21495, not here.

We will implement this goal without sacrificing any of the traditional convenience features that Sage-the-distribution has provided for the casual user (such as `sage -i` for installing packages).

We have a separate task ticket for the following:
 - #21507: Make sagelib (sage-the-Python-library) a normal Python package, installable by `setup.py`, `pip`, etc. and eventually even via PyPI.  We will NOT turn sagelib to an automake package (which was proposed in #14807). 
(There will be some interaction with some of the steps of that ticket.)

Included on this ticket are the following steps.

Implement standard features expected of an autotools build system.

 - Choosing the installation hierarchy (`configure --prefix=SAGE_LOCAL`). Right now it is the subdirectory `local` of `SAGE_ROOT`. 
  - #21501: Allow SAGE_LOCAL to be customized
  - #21534: Allow SAGE_LOCAL to be customized - follow-up
  - #21479: ./configure --prefix=SAGE_LOCAL
 - By allowing the user to choose the installation hierarchy, there are new requirements. What is installed there should run without requiring environment variables to be set. It should not refer to `SAGE_ROOT` (or `SAGE_SRC_ROOT`), except perhaps for "debugging" or "source inspection" facilities:
  - #21525: package `autotools`: Don't depend on `$SAGE_LOCAL`
  - #21509: Install cython_debug somewhere in SAGE_LOCAL
 - #21539: `make V=0` should silence the build
 - #21469: Enable VPATH builds (`SAGE_SRC_ROOT/configure --srcdir=SAGE_SRC_ROOT`)
 - #21538: `./configure --with-packages=...`
 - Various other `configure` options, to replace use of environment variables that influence the build.

Clean up parts of the build system to make it more standard. This is to make it straightforward for developers familiar with the autotools system to contribute to sage.
 - #21532: Create `SAGE_LOCAL` directory hierarchy during `make`, not `configure`
 - #21524: `configure.ac`: write `build/make/Makefile` within an `AC_CONFIG_COMMANDS`, not during main `configure`

Make the separation between sage-the-distribution and sagelib (sage-the-Python-library) clearer. This will be beneficial for distributions such as Debian etc.
 - #21559: Move sage-the-distribution scripts from `src/bin` to `build/bin`
 - #21565: Add src/README.txt and build/README.txt

Following are workarounds to enable root-owned installation hierarchies (`prefix`).
 - #21537: If `$SAGE_SUDO` is set, use it whenever we do `make install` of a package
 - #21536: documentation: Recommend GNU stow to people who want to install to `/usr/local`


---

Comment by mmezzarobba created at 2016-09-23 13:35:39

Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) For example, is the idea that `./configure` would finish by saying something like “the following dependencies are missing: ... please install them, or type `make` and I'll install my own copy”? (This wouldn't be _quite_ standard, but close enough, while staying mostly compatible with the installation procedure of sage-the-distribution.)

Or would sage-the-distribution still always have its private version of everything, so that users would have to choose between installing it and installing sagelib directly (e.g., via pip)?


---

Comment by embray created at 2016-09-23 13:36:49

(Sorry, the comment that was here previously was meant to go on #21507 -- I have too many tabs open)


---

Comment by mkoeppe created at 2016-09-23 15:14:22

Replying to [comment:3 mmezzarobba]:
> Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) 

That is beyond the scope of this task ticket. But I would be interested in a follow-up ticket to this effect.


---

Comment by embray created at 2016-10-05 09:15:56

Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?


---

Comment by mkoeppe created at 2016-10-05 17:42:27

Replying to [comment:9 embray]:
> Will this also fix how `make` actually runs `configure` for you, 

No, probably not. For this ticket, I want to keep `configure` an _optional_ step of the installation process. (I've updated the description.)

> and that `configure` gets invoked even if you run `make clean` targets?

Not sure about this one. To keep this ticket manageable, I want to change the top-level `Makefile` as little as possible. But please do open a ticket that describes `make clean` issues that ought to be addressed.


---

Comment by embray created at 2016-10-06 09:13:23

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 embray]:
> > Will this also fix how `make` actually runs `configure` for you, 
> 
> No, probably not. For this ticket, I want to keep `configure` an _optional_ step of the installation process. (I've updated the description.)

I guess it would be fine to make it an optional step.  But I don't think it should be a _mandatory_ step for all make targets, and currently it is, or at least seems to be.  For example if I run `make maintainer-clean` twice in a row, the second time will run `configure` only to delete its output.

This is especially annoying on Cygwin where `configure` is _extremely slow_.


---

Comment by jdemeyer created at 2016-10-06 12:30:00

Replying to [comment:9 embray]:
> Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?

In standard autotools packages, the `Makefile` gets _created_ by `configure`, so you wouldn't be able to run `make clean` either without `configure`.


---

Comment by embray created at 2016-10-07 08:15:26

True--in that case it should (hopefully) be a moot point.  This is currently a huge annoyance for me.


---

Comment by embray created at 2017-01-09 09:52:27

Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.

It's a little outside the scope of this ticket but not entirely.  There are quite a few system packages installed by sage that could be skipped if we added the appropriate scripts to check for them.


---

Comment by jdemeyer created at 2017-01-09 10:02:30

Replying to [comment:18 embray]:
> Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.

No, we don't. Feel free to open a ticket. I would prefer one ticket for every package, not a single ticket trying to do too much.


---

Comment by embray created at 2017-01-09 16:27:45

I agree--I probably won't even make a ticket for _every_ package right away but I will make a master ticket for coordinating the task, and then open individual tickets for packages that I think are most worth tackling.


---

Comment by mkoeppe created at 2017-07-07 17:33:04

Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?


---

Comment by embray created at 2017-07-10 09:21:10

Replying to [comment:22 mkoeppe]:
> Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?

Which build system changes specifically?  I have a few open tickets that are making some not insignificant changes, but they don't terribly change things for this ticket. If anything they will help make it easier to implement the goals of this ticket.  There is one small conflict I can see: The work I'm doing in #22509 and in #23160 will mostly supersede the work you already did in #21537.  This is because the `sdh_make_install` helper function I added will also handle `$SAGE_SUDO`.

Right now I'm working toward the goals I outlined [here](https://groups.google.com/d/msg/sage-devel/nTwhCV89FXE/_7GdzGy4BgAJ) for improving support for building Sage against dependencies from the system.  However, I haven't even made tickets for every aspect of that plan yet.  All the work I'm currently doing is toward #22509 and #22510 which I see as necessary for saner package management in Sage (they will also be very helpful for work I need to do of making it easier to install optional packages with the Windows installer, but that's otherwise an orthogonal issue).


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
