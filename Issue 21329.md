# Issue 21329: Task ticket: Make sage (the distribution) behave like a standard autotools package, to the extent possible

archive/issues_021329.json:
```json
{
    "body": "CC:  vbraun jdemeyer fbissey embray dimpase was mmezzarobba thansen @timokau jhpalmieri slabbe\n\nThe goal of this ticket is to be able to explain to experienced Unix users what sage-the-distribution is, as follows:\n\n If you download sage-the-distribution and do\n {{{\n ./configure --prefix=/SOMEWHERE && make \n }}}\n then that's the same as doing a sequence of about 100 times: \n {{{\nwget SOMEPACKAGE.tar.gz && tar xf SOMEPACKAGE.tar.gz && (cd SOMEPACKAGE \\\n&& ./configure --prefix=/SOMEWHERE && make && make install)\n }}}\n (and about a 50 times `pip install SOMEPACKAGE`).\n sage-the-distribution has figured out the right order of installing these packages, tricky configure options so that everything works, and on top has fixes for various outdated/handwritten/missing build systems of various packages.\n\nThus it is beyond the scope of this ticket:\n- to separate `make` and `make install`. Our `make install` is a no-op. ANY discussion of this needs to go to ticket #21495, not here.\n\nWe will implement this goal without sacrificing any of the traditional convenience features that Sage-the-distribution has provided for the casual user (such as `sage -i` for installing packages).\n\nWe have a separate task ticket for the following:\n- #21507: Make sagelib (sage-the-Python-library) a normal Python package, installable by `setup.py`, `pip`, etc. and eventually even via PyPI.  We will NOT turn sagelib to an automake package (which was proposed in #14807). \n(There will be some interaction with some of the steps of that ticket.)\n\nIncluded on this ticket are the following steps.\n\nImplement standard features expected of an autotools build system.\n\n- Choosing the installation hierarchy (`configure --prefix=SAGE_LOCAL`). Right now it is the subdirectory `local` of `SAGE_ROOT`. \n  - #21501: Allow SAGE_LOCAL to be customized\n  - #21534: Allow SAGE_LOCAL to be customized - follow-up\n  - #21479: ./configure --prefix=SAGE_LOCAL\n- By allowing the user to choose the installation hierarchy, there are new requirements. What is installed there should run without requiring environment variables to be set. It should not refer to `SAGE_ROOT` (or `SAGE_SRC_ROOT`), except perhaps for \"debugging\" or \"source inspection\" facilities:\n  - #21525: package `autotools`: Don't depend on `$SAGE_LOCAL`\n  - #21509: Install cython_debug somewhere in SAGE_LOCAL\n- #21539: `make V=0` should silence the build\n- #21469: Enable VPATH builds (`SAGE_SRC_ROOT/configure --srcdir=SAGE_SRC_ROOT`)\n- #21538: `./configure --with-packages=...`\n- Various other `configure` options, to replace use of environment variables that influence the build.\n\nClean up parts of the build system to make it more standard. This is to make it straightforward for developers familiar with the autotools system to contribute to sage.\n- #21532: Create `SAGE_LOCAL` directory hierarchy during `make`, not `configure`\n- #21524: `configure.ac`: write `build/make/Makefile` within an `AC_CONFIG_COMMANDS`, not during main `configure`\n\nMake the separation between sage-the-distribution and sagelib (sage-the-Python-library) clearer. This will be beneficial for distributions such as Debian etc.\n- #21559: Move sage-the-distribution scripts from `src/bin` to `build/bin`\n- #21565: Add src/README.txt and build/README.txt\n\nFollowing are workarounds to enable root-owned installation hierarchies (`prefix`).\n- #21537: If `$SAGE_SUDO` is set, use it whenever we do `make install` of a package\n- #21536: documentation: Recommend GNU stow to people who want to install to `/usr/local`\n\nIssue created by migration from https://trac.sagemath.org/ticket/21566\n\n",
    "created_at": "2016-09-22T18:27:28Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Task ticket: Make sage (the distribution) behave like a standard autotools package, to the extent possible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21329",
    "user": "mkoeppe"
}
```
CC:  vbraun jdemeyer fbissey embray dimpase was mmezzarobba thansen @timokau jhpalmieri slabbe

The goal of this ticket is to be able to explain to experienced Unix users what sage-the-distribution is, as follows:

 If you download sage-the-distribution and do
 {{{
 ./configure --prefix=/SOMEWHERE && make 
 }}}
 then that's the same as doing a sequence of about 100 times: 
 {{{
wget SOMEPACKAGE.tar.gz && tar xf SOMEPACKAGE.tar.gz && (cd SOMEPACKAGE \
&& ./configure --prefix=/SOMEWHERE && make && make install)
 }}}
 (and about a 50 times `pip install SOMEPACKAGE`).
 sage-the-distribution has figured out the right order of installing these packages, tricky configure options so that everything works, and on top has fixes for various outdated/handwritten/missing build systems of various packages.

Thus it is beyond the scope of this ticket:
- to separate `make` and `make install`. Our `make install` is a no-op. ANY discussion of this needs to go to ticket #21495, not here.

We will implement this goal without sacrificing any of the traditional convenience features that Sage-the-distribution has provided for the casual user (such as `sage -i` for installing packages).

We have a separate task ticket for the following:
- #21507: Make sagelib (sage-the-Python-library) a normal Python package, installable by `setup.py`, `pip`, etc. and eventually even via PyPI.  We will NOT turn sagelib to an automake package (which was proposed in #14807). 
(There will be some interaction with some of the steps of that ticket.)

Included on this ticket are the following steps.

Implement standard features expected of an autotools build system.

- Choosing the installation hierarchy (`configure --prefix=SAGE_LOCAL`). Right now it is the subdirectory `local` of `SAGE_ROOT`. 
  - #21501: Allow SAGE_LOCAL to be customized
  - #21534: Allow SAGE_LOCAL to be customized - follow-up
  - #21479: ./configure --prefix=SAGE_LOCAL
- By allowing the user to choose the installation hierarchy, there are new requirements. What is installed there should run without requiring environment variables to be set. It should not refer to `SAGE_ROOT` (or `SAGE_SRC_ROOT`), except perhaps for "debugging" or "source inspection" facilities:
  - #21525: package `autotools`: Don't depend on `$SAGE_LOCAL`
  - #21509: Install cython_debug somewhere in SAGE_LOCAL
- #21539: `make V=0` should silence the build
- #21469: Enable VPATH builds (`SAGE_SRC_ROOT/configure --srcdir=SAGE_SRC_ROOT`)
- #21538: `./configure --with-packages=...`
- Various other `configure` options, to replace use of environment variables that influence the build.

Clean up parts of the build system to make it more standard. This is to make it straightforward for developers familiar with the autotools system to contribute to sage.
- #21532: Create `SAGE_LOCAL` directory hierarchy during `make`, not `configure`
- #21524: `configure.ac`: write `build/make/Makefile` within an `AC_CONFIG_COMMANDS`, not during main `configure`

Make the separation between sage-the-distribution and sagelib (sage-the-Python-library) clearer. This will be beneficial for distributions such as Debian etc.
- #21559: Move sage-the-distribution scripts from `src/bin` to `build/bin`
- #21565: Add src/README.txt and build/README.txt

Following are workarounds to enable root-owned installation hierarchies (`prefix`).
- #21537: If `$SAGE_SUDO` is set, use it whenever we do `make install` of a package
- #21536: documentation: Recommend GNU stow to people who want to install to `/usr/local`

Issue created by migration from https://trac.sagemath.org/ticket/21566





---

archive/issue_comments_295942.json:
```json
{
    "body": "Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) For example, is the idea that `./configure` would finish by saying something like \u201cthe following dependencies are missing: ... please install them, or type `make` and I'll install my own copy\u201d? (This wouldn't be *quite* standard, but close enough, while staying mostly compatible with the installation procedure of sage-the-distribution.)\n\nOr would sage-the-distribution still always have its private version of everything, so that users would have to choose between installing it and installing sagelib directly (e.g., via pip)?",
    "created_at": "2016-09-23T13:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295942",
    "user": "mmezzarobba"
}
```

Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) For example, is the idea that `./configure` would finish by saying something like “the following dependencies are missing: ... please install them, or type `make` and I'll install my own copy”? (This wouldn't be *quite* standard, but close enough, while staying mostly compatible with the installation procedure of sage-the-distribution.)

Or would sage-the-distribution still always have its private version of everything, so that users would have to choose between installing it and installing sagelib directly (e.g., via pip)?



---

archive/issue_comments_295943.json:
```json
{
    "body": "(Sorry, the comment that was here previously was meant to go on #21507 -- I have too many tabs open)",
    "created_at": "2016-09-23T13:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295943",
    "user": "embray"
}
```

(Sorry, the comment that was here previously was meant to go on #21507 -- I have too many tabs open)



---

archive/issue_comments_295944.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) \n\nThat is beyond the scope of this task ticket. But I would be interested in a follow-up ticket to this effect.",
    "created_at": "2016-09-23T15:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295944",
    "user": "mkoeppe"
}
```

Replying to [comment:3 mmezzarobba]:
> Do you intend `./configure` to detect already installed dependencies so that `make` skips installing them? (Eventually? as part of this task?) 

That is beyond the scope of this task ticket. But I would be interested in a follow-up ticket to this effect.



---

archive/issue_comments_295945.json:
```json
{
    "body": "Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?",
    "created_at": "2016-10-05T09:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295945",
    "user": "embray"
}
```

Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?



---

archive/issue_comments_295946.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> Will this also fix how `make` actually runs `configure` for you, \n\nNo, probably not. For this ticket, I want to keep `configure` an *optional* step of the installation process. (I've updated the description.)\n\n> and that `configure` gets invoked even if you run `make clean` targets?\n\nNot sure about this one. To keep this ticket manageable, I want to change the top-level `Makefile` as little as possible. But please do open a ticket that describes `make clean` issues that ought to be addressed.",
    "created_at": "2016-10-05T17:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295946",
    "user": "mkoeppe"
}
```

Replying to [comment:9 embray]:
> Will this also fix how `make` actually runs `configure` for you, 

No, probably not. For this ticket, I want to keep `configure` an *optional* step of the installation process. (I've updated the description.)

> and that `configure` gets invoked even if you run `make clean` targets?

Not sure about this one. To keep this ticket manageable, I want to change the top-level `Makefile` as little as possible. But please do open a ticket that describes `make clean` issues that ought to be addressed.



---

archive/issue_comments_295947.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> Replying to [comment:9 embray]:\n> > Will this also fix how `make` actually runs `configure` for you, \n> \n> No, probably not. For this ticket, I want to keep `configure` an *optional* step of the installation process. (I've updated the description.)\n\nI guess it would be fine to make it an optional step.  But I don't think it should be a *mandatory* step for all make targets, and currently it is, or at least seems to be.  For example if I run `make maintainer-clean` twice in a row, the second time will run `configure` only to delete its output.\n\nThis is especially annoying on Cygwin where `configure` is *extremely slow*.",
    "created_at": "2016-10-06T09:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295947",
    "user": "embray"
}
```

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 embray]:
> > Will this also fix how `make` actually runs `configure` for you, 
> 
> No, probably not. For this ticket, I want to keep `configure` an *optional* step of the installation process. (I've updated the description.)

I guess it would be fine to make it an optional step.  But I don't think it should be a *mandatory* step for all make targets, and currently it is, or at least seems to be.  For example if I run `make maintainer-clean` twice in a row, the second time will run `configure` only to delete its output.

This is especially annoying on Cygwin where `configure` is *extremely slow*.



---

archive/issue_comments_295948.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?\n\nIn standard autotools packages, the `Makefile` gets *created* by `configure`, so you wouldn't be able to run `make clean` either without `configure`.",
    "created_at": "2016-10-06T12:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295948",
    "user": "jdemeyer"
}
```

Replying to [comment:9 embray]:
> Will this also fix how `make` actually runs `configure` for you, and that `configure` gets invoked even if you run `make clean` targets?

In standard autotools packages, the `Makefile` gets *created* by `configure`, so you wouldn't be able to run `make clean` either without `configure`.



---

archive/issue_comments_295949.json:
```json
{
    "body": "True--in that case it should (hopefully) be a moot point.  This is currently a huge annoyance for me.",
    "created_at": "2016-10-07T08:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295949",
    "user": "embray"
}
```

True--in that case it should (hopefully) be a moot point.  This is currently a huge annoyance for me.



---

archive/issue_comments_295950.json:
```json
{
    "body": "Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.\n\nIt's a little outside the scope of this ticket but not entirely.  There are quite a few system packages installed by sage that could be skipped if we added the appropriate scripts to check for them.",
    "created_at": "2017-01-09T09:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295950",
    "user": "embray"
}
```

Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.

It's a little outside the scope of this ticket but not entirely.  There are quite a few system packages installed by sage that could be skipped if we added the appropriate scripts to check for them.



---

archive/issue_comments_295951.json:
```json
{
    "body": "Replying to [comment:18 embray]:\n> Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.\n\nNo, we don't. Feel free to open a ticket. I would prefer one ticket for every package, not a single ticket trying to do too much.",
    "created_at": "2017-01-09T10:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295951",
    "user": "jdemeyer"
}
```

Replying to [comment:18 embray]:
> Do we have a ticket somewhere for adding more configure-time checks for system packages?   If there is I can't find it.

No, we don't. Feel free to open a ticket. I would prefer one ticket for every package, not a single ticket trying to do too much.



---

archive/issue_comments_295952.json:
```json
{
    "body": "I agree--I probably won't even make a ticket for *every* package right away but I will make a master ticket for coordinating the task, and then open individual tickets for packages that I think are most worth tackling.",
    "created_at": "2017-01-09T16:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295952",
    "user": "embray"
}
```

I agree--I probably won't even make a ticket for *every* package right away but I will make a master ticket for coordinating the task, and then open individual tickets for packages that I think are most worth tackling.



---

archive/issue_comments_295953.json:
```json
{
    "body": "Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?",
    "created_at": "2017-07-07T17:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295953",
    "user": "mkoeppe"
}
```

Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?



---

archive/issue_comments_295954.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?\n\nWhich build system changes specifically?  I have a few open tickets that are making some not insignificant changes, but they don't terribly change things for this ticket. If anything they will help make it easier to implement the goals of this ticket.  There is one small conflict I can see: The work I'm doing in #22509 and in #23160 will mostly supersede the work you already did in #21537.  This is because the `sdh_make_install` helper function I added will also handle `$SAGE_SUDO`.\n\nRight now I'm working toward the goals I outlined [here](https://groups.google.com/d/msg/sage-devel/nTwhCV89FXE/_7GdzGy4BgAJ) for improving support for building Sage against dependencies from the system.  However, I haven't even made tickets for every aspect of that plan yet.  All the work I'm currently doing is toward #22509 and #22510 which I see as necessary for saner package management in Sage (they will also be very helpful for work I need to do of making it easier to install optional packages with the Windows installer, but that's otherwise an orthogonal issue).",
    "created_at": "2017-07-10T09:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295954",
    "user": "embray"
}
```

Replying to [comment:22 mkoeppe]:
> Would someone who has followed recent build system changes be interested in updating the description of this meta-ticket?

Which build system changes specifically?  I have a few open tickets that are making some not insignificant changes, but they don't terribly change things for this ticket. If anything they will help make it easier to implement the goals of this ticket.  There is one small conflict I can see: The work I'm doing in #22509 and in #23160 will mostly supersede the work you already did in #21537.  This is because the `sdh_make_install` helper function I added will also handle `$SAGE_SUDO`.

Right now I'm working toward the goals I outlined [here](https://groups.google.com/d/msg/sage-devel/nTwhCV89FXE/_7GdzGy4BgAJ) for improving support for building Sage against dependencies from the system.  However, I haven't even made tickets for every aspect of that plan yet.  All the work I'm currently doing is toward #22509 and #22510 which I see as necessary for saner package management in Sage (they will also be very helpful for work I need to do of making it easier to install optional packages with the Windows installer, but that's otherwise an orthogonal issue).



---

archive/issue_comments_295955.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21329#issuecomment-295955",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
