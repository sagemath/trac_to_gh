# Issue 26693: add GAP io package (and other GAP kernel modules)

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2018-12-21 11:33:03

CC:  embray fbissey @timokau jhpalmieri andrew.mathas

On the libgap side, this requires tinkering with the loader, see
on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).

Here is a branch that implements this.


---

Comment by dimpase created at 2018-12-21 13:43:00

on OSX the dlopen call does not work. However, it does if given full path to the dll, i.e.

```diff
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
`@``@` -263,7 +263,8 `@``@` cdef initialize():
     # Note: we could use RTLD_NOLOAD and avoid the subsequent dlclose() but
     # this isn't portable
     cdef void* handle
-    handle = dlopen("libgap.so", RTLD_NOW | RTLD_GLOBAL)
+    # handle = dlopen("libgap.so", RTLD_NOW | RTLD_GLOBAL)
+    handle = dlopen("/Users/dima/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/libgap.so", RTLD_NOW | RTLD_GLOBAL)
     if handle == NULL:
         raise RuntimeError(
                 "Could not dlopen() libgap.so even though it should already "
```

name resolution procedures are different on OSX. Actually, I don't know what's happening  on Linux so that libgap.so is found.
Perhaps, it's already loaded on Linux, but not on OSX?


---

Comment by embray created at 2018-12-21 13:48:47

That's not really the intended "libgap.so".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  The re-dlopening the Python module might do it as well.

The other option, as I mentioned, would be to use Python's built-in `sys.setdlopenflags(...)`, but that has to be called before importing any modules (e.g. `sage.lib.gap.libgap`) that are linked with libgap.  It would probably be good afterwards to set it back to its default which is `RTLD_LAZY`.

But yes, it's probably more portable either way to give a full path to the relevant shared object.


---

Comment by dimpase created at 2018-12-21 14:10:20

Replying to [comment:2 embray]:
> That's not really the intended "libgap.so".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  
oh, right --- except it's `.dylib`, not `.so`. (I searched for `libgap.so`, absent-mindedly, found unique match, tried it :-))

And indeed simply replacing `libgap.so` with `libgap.dylib` in the dlopen call suffices,
no need for the full path.

So this is easy to fix - except that in C I would have gone for a macro with the right extension, how is one supposed to do this in Cython?


---

Comment by SimonKing created at 2018-12-26 16:21:53

Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?


---

Comment by dimpase created at 2018-12-26 16:28:57

Replying to [comment:4 SimonKing]:
> Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?

`database_gap` spkg is there no more, it's part of `gap` spkg; in fact, already 
on #22626.
On #26856 Erik prefers to keep `gap_packages` optional, at least for the upcoming (quick) release 8.6, to make Debian deadline of 12 Jan.

We have not included IO there, as it'd be an extra over the current `gap_packages`, and something that needs more testing. Then we can extend `gap_packages` (and merge everything into `gap`, as we are already using the same tarball for `gap` and `gap_packages` anyway).


---

Comment by SimonKing created at 2018-12-26 16:30:58

And now a question on the IO package: From its documentation, I see that it allows to pickle any GAP object into a file object. But that's cumbersome for serialisation in Sage.

In Sage, we want a `__reduce__` method (or a different serialisation protocol) to return a data tuple that is eventually dumped to a string by standard Python tools. But it seems wrong to me if we have a complicated object (say, a cohomology ring) with several attributes, one of them being defined in libgap, and to write only this attribute directly to a file.

So, how do you envision libgap serialisation?


---

Comment by dimpase created at 2018-12-26 16:36:23

Would you rather prefer IO dumping to a string? (i.e. into memory, right?)
I'm not sure, but perhaps this is doable via their streams; it sounds like a reasonable feature to add to IO, if it's not there yet.

As Python serialisation was never my concern, I have little idea about it.


---

Comment by SimonKing created at 2018-12-26 16:46:56

Replying to [comment:7 dimpase]:
> As Python serialisation was never my concern, I have little idea about it.

This is a SageMath ticket. So, Python serialisation has to come into play sooner or later.

Having IO installed and working is a nice first step. But eventually,

```
sage: G = libgap.DihedralGroup(8)
sage: loads(dumps(G))
```

should work. And also something like the following should work:

```python
class Foo(Ring):
    def __init__(self, G):
        assert G in Groups()
        self.G = G
        ...
    def __reduce__(self):
        return Foo, self.G
```

and then

```
sage: loads(dumps(Foo(libgap.DihedralGroup(8))))
```


But that would be for two follow-up tickets. One for pickling, the other for making libgap aware of Sage's categories (thus, translating `G in Groups()` into `bool(G.IsGroup())`).


---

Comment by git created at 2018-12-27 16:05:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2018-12-27 16:06:34

rebased over the branch on #26856, added OSX (and perhaps even Cygwin?) support.


---

Comment by git created at 2018-12-29 18:31:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2019-01-09 11:05:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-01-09 11:05:51

merged 8.6.rc0 in.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by dimpase created at 2019-01-22 13:48:37

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-01-22 13:51:32

Minor comment: if you are changing the `spkg-install` script of a package, you should also bump the patchlevel to force a rebuild.


---

Comment by jdemeyer created at 2019-01-22 13:54:33

Since `dlopen` takes a `const char*`, it's safer to use byte literals here:

```python
    for suffix in [b"so", b"dylib", b"dll"]:
        handle = dlopen(b"libgap." + suffix, RTLD_NOW | RTLD_GLOBAL)
```



---

Comment by jdemeyer created at 2019-01-22 13:58:18

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-01-22 13:58:18

Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:

```sh
cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
```



---

Comment by jdemeyer created at 2019-01-22 13:59:08

Finally a minor Cython style issue: I prefer `handle is NULL` as a more Pythonic spelling of `handle == NULL`.


---

Comment by jdemeyer created at 2019-01-22 14:02:21

By the way, the commit history is a mess. Maybe it would be better to squash and rebase on top of 8.6.


---

Comment by fbissey created at 2019-01-22 18:54:40

Replying to [comment:21 jdemeyer]:
> Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:
> {{{
> #!sh
> cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
> }}}

If I remember correctly this is where `io.c` expect some of its "include". I am planning to patch in sage-on-gentoo rather than doing something like that.

Now going through the ticket and this bit in particular:

```
+    cdef void* handle
+    for suffix in ["so", "dylib", "dll"]:
+        handle = dlopen("libgap."+suffix, RTLD_NOW | RTLD_GLOBAL)
+        if handle != NULL:
+            break
```


where the point has been made that we don't need the full path. Now that starts to get unrelated but we do the same thing for libsingular in `libs/singular.pyx` and we go to great length to get the full path even defining it in `env.py`. If I read this correctly it is now way more complicated than it should be.


---

Comment by dimpase created at 2019-01-23 00:05:12

Replying to [comment:24 fbissey]:
> Replying to [comment:21 jdemeyer]:
> > Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:
> > {{{
> > #!sh
> > cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
> > }}}
> 
> If I remember correctly this is where `io.c` expect some of its "include". I am planning to patch in sage-on-gentoo rather than doing something like that.

That's right. Perhaps the proper way would be to use `sdh_install` rather than `cp`, but on the other hand it's not clear to me whether `$GAP_ROOT/src/` is a location supported by this machinery.

Erik, could you look into this?

(Of course, GAP having its include files in the same directory as C sources is a problem, due to their lack of proper install mechanism...)


---

Comment by fbissey created at 2019-01-23 00:21:29

This is all I had to do compile `io` against an installed gap (with `config.h` installed in `include/gap` like in vanilla sage)

```diff
diff --git a/pkg/io-4.5.4/src/io.c b/pkg/io-4.5.4/src/io.c
index 5aa4a082..07e6e312 100644
--- a/pkg/io-4.5.4/src/io.c
+++ b/pkg/io-4.5.4/src/io.c
`@``@` -11,8 +11,8 `@``@`
 /* Try to use as much of the GNU C library as possible: */
 #define _GNU_SOURCE
 
-#include "src/compiled.h"          /* GAP headers                */
-#include "src/iostream.h"          /* Signal Handling            */
+#include "gap/compiled.h"          /* GAP headers                */
+#include "gap/iostream.h"          /* Signal Handling            */
 
 #undef PACKAGE
 #undef PACKAGE_BUGREPORT
```



---

Comment by dimpase created at 2019-01-23 00:59:28

rebased branch, using byte literals now, also internet-related tests fixed at one place
----
New commits:


---

Comment by dimpase created at 2019-01-23 00:59:28

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-01-23 06:28:47

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-01-23 06:28:47

[comment:17] and [comment:21] have not been addressed yet (neither has [comment:22] but that's just a style issue)


---

Comment by jdemeyer created at 2019-01-23 08:34:41

Thanks for doing the rebase, but `rebased the messy branch from #26930` is not really a good commit message. Better would be something like `Trac #26930: add GAP io package`.


---

Comment by embray created at 2019-01-23 10:38:57

I would like to handle the path for libgap.so (and its related variants) better, and had planned to do so soon before I saw all the recent work on this ticket.

I think the path to libgap should be set in `sage.env` and should be possible to override by environment variable, analogous to the handling of `SINGULAR_SO` (it could even repurpose the same code more-or-less).


---

Comment by embray created at 2019-01-23 10:44:23

This change


```diff

diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index 1a3e8c5..607d2c7 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
`@``@` -48,15 +48,15 `@``@` install_compiled_pkg()
     # Clean up any build artificts before installing the rest of the package
     # Also remove configure/Makefiles
     # Note: None, if any of the packages really have a proper install target
-    make clean  # Works for some packages but not all
-    rm -rf bin/
-    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/
 
     # Create the bin/ symlink
     ln -s "$SAGE_LOCAL/lib/gap/pkg/$pkg/bin" bin
 
     # Install the rest of the package files
     sdh_install * "$PKG_DIR/$pkg"
+    make clean  # Works for some packages but not all
+    rm -rf bin/
+    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/
 }
 
 # Build and install compiled packages:
```


is not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110


---

Comment by embray created at 2019-01-23 10:48:33


```diff
diff --git a/src/doc/en/constructions/groups.rst b/src/doc/en/constructions/groups.rst
index 30d8da4..0cc7b92 100644
--- a/src/doc/en/constructions/groups.rst
+++ b/src/doc/en/constructions/groups.rst
`@``@` -184,7 +184,7 `@``@` Here's another way, working more directly with GAP::
     [ Group( [ f1, f2 ] ), Group( [ f2 ] ), Group( <identity> of ... ) ]
     sage: print(gap.eval("G := SymmetricGroup( 4 )"))
     Sym( [ 1 .. 4 ] )
-    sage: print(gap.eval("normal := NormalSubgroups( G );"))
+    sage: print(gap.eval("normal := NormalSubgroups( G );")) # random
     [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),
       Group(()) ]
```


I'm confused why it's still giving you random results here.  #26874 should have fixed this.  I want to look into it.  It's not too important of course, but it still troubles me that there's some non-determinism in the tests when AFAIK there shouldn't be.


---

Comment by embray created at 2019-01-23 10:50:22

I don't know why you removed this:


```diff
diff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx
index 55a1428..90af15a 100644
--- a/src/sage/graphs/strongly_regular_db.pyx
+++ b/src/sage/graphs/strongly_regular_db.pyx
`@``@` -2450,10 +2450,8 `@``@` def SRG_416_100_36_20():
         (416, 100, 36, 20)
     """
     from sage.libs.gap.libgap import libgap
-    libgap.eval("SetInfoLevel(InfoWarning,0)") # silence #I warnings from GAP (without IO pkg)
     libgap.LoadPackage("AtlasRep")
     g=libgap.AtlasGroup("G2(4)",libgap.NrMovedPoints,416)
-    libgap.eval("SetInfoLevel(InfoWarning,1)") # restore #I warnings
     h = Graph()
     h.add_edges(g.Orbit([1,5],libgap.OnSets))
     h.relabel()
```


It's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.


---

Comment by dimpase created at 2019-01-23 11:22:19

Replying to [comment:33 embray]:
> I don't know why you removed this:
> 
> {{{
> #!diff
> diff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx
> index 55a1428..90af15a 100644
> --- a/src/sage/graphs/strongly_regular_db.pyx
> +++ b/src/sage/graphs/strongly_regular_db.pyx
> `@``@` -2450,10 +2450,8 `@``@` def SRG_416_100_36_20():
>          (416, 100, 36, 20)
>      """
>      from sage.libs.gap.libgap import libgap
> -    libgap.eval("SetInfoLevel(InfoWarning,0)") # silence #I warnings from GAP (without IO pkg)
>      libgap.LoadPackage("AtlasRep")
>      g=libgap.AtlasGroup("G2(4)",libgap.NrMovedPoints,416)
> -    libgap.eval("SetInfoLevel(InfoWarning,1)") # restore #I warnings
>      h = Graph()
>      h.add_edges(g.Orbit([1,5],libgap.OnSets))
>      h.relabel()
> }}}
> 
> It's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.

oh, I might have been confused by shaffling packages around. This chane makes sense if atlasrep is in gap-packages, but this is not the case any more.


---

Comment by dimpase created at 2019-01-23 22:28:45

Replying to [comment:31 embray]:
> This change
> is not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110

duh... I looked at that diff, wondering whether there is some whitespace-only difference there, for it looked totally the same :-(


---

Comment by git created at 2019-01-23 22:35:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-01-23 22:38:07

What should we do with comment 21? Just patch the GAP/io package source?


---

Comment by git created at 2019-01-23 22:57:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-01-23 22:58:02

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-01-28 11:08:25

piing...


---

Comment by zerline created at 2019-02-04 17:27:58

Hi!

I'm currently trying to compile a bunch of GAP packages in Sage environment, and apparently, I need to add this:

$ CFLAGS="-I../.. -I../../gen" ./configure --with-gaproot=../..

Is it the only way?


---

Comment by embray created at 2019-02-04 17:30:20

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-02-04 17:30:20

I just looked into this with Odile, who was trying to compile the IO package.  I don't think patching the sources is the way.  It's strange that the configure script, even given a path to the gaproot, doesn't add this.  I will look into what is _intended_ for this and see if there's a reason what we're doing with just passing `--with-gaproot` to configure doesn't work.

Either it's a bug on our end, or a bug in the package's configure.  Odile was able to work around it by adding `CFLAGS=-I../../ -I../../gen` and that seemed to work (where `../../` here was the relative path to the gaproot).  If we have to do that we can, but it still smells like a hack.

I also want to address #26930#comment:30


---

Comment by dimpase created at 2019-02-04 18:01:21

I don't see why we should not patch package's source.

It's written with GAP's sources and headers alike living in GAPROOT/src/, and
naturally you can either create some foo/src to use in `-I`, or else, indeed, replace `src/` with `gap/`.

I would like to see the log of the failure (without these extra CFLAGS)


---

Comment by zerline created at 2019-02-04 18:08:03

_after a bare ./configure --with-gaproot=../.._ :



```
(sage-sh) odile`@`ancolie:json-2.0.0$ make
  CXX      src/json.lo
src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
 #include "src/compiled.h"          /* GAP headers                */
          ^~~~~~~~~~~~~~~~
compilation terminated.
make: *** [Makefile:501: src/json.lo] Error 1

```



---

Comment by dimpase created at 2019-02-04 18:11:30

Don't do things like this at `sage -sh` prompt, it's not meant for this.

Just do the usual `./sage -f gap_packages` (with the branch pulled in, naturally).


---

Comment by dimpase created at 2019-02-04 18:13:18

and if you want more GAP packages installed, modify `gap_packages/spkg-install` accordingly.


---

Comment by zerline created at 2019-02-04 18:14:59

Could you point me to a documentation page for this?

(I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)

Note: I'm a complete newbie to GAP, not to mention GAP-in-Sage ..


---

Comment by zerline created at 2019-02-04 18:18:37

Thanks anyway, I'll try that.


---

Comment by zerline created at 2019-02-04 18:27:20

Here is my gap_packages-4.10.0.log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log](http://fluidinfo.fr/gap/gap_packages-4.10.0.log)

Note: I have a crypting-0.9 source directory, in my ./local/share/gap/pkg : for some reason it was not in the build directory as the other packages, I just copied it there and here is my second log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1](http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1)


---

Comment by dimpase created at 2019-02-04 18:45:53

Replying to [comment:48 zerline]:
> Could you point me to a documentation page for this?
> 
> (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> 
This link is totally obsolete - edited last time in 2013.
I've just edited that page to make this clear. Sorry...


---

Comment by fbissey created at 2019-02-04 18:53:46

Replying to [comment:45 zerline]:
> _after a bare ./configure --with-gaproot=../.._ :
> 
> 
> {{{
> (sage-sh) odile`@`ancolie:json-2.0.0$ make
>   CXX      src/json.lo
> src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
>  #include "src/compiled.h"          /* GAP headers                */
>           ^~~~~~~~~~~~~~~~
> compilation terminated.
> make: *** [Makefile:501: src/json.lo] Error 1
> 
> }}}

That's exactly one of the things I patch see #26930?replyto=45#comment:26


---

Comment by dimpase created at 2019-02-04 18:54:12

Let us separate a review for this ticket and adding yet more GAP packages.
I just opened #27218 for this purpose.


---

Comment by dimpase created at 2019-02-04 18:54:12

Changing status from needs_work to needs_review.


---

Comment by zerline created at 2019-02-04 21:18:10

Replying to [comment:51 dimpase]:
> Replying to [comment:48 zerline]:
> > Could you point me to a documentation page for this?
> > 
> > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> > 
> This link is totally obsolete - edited last time in 2013.
> I've just edited that page to make this clear. Sorry...

Yet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently _these_ packages (those compiled with the method above) are loaded.


---

Comment by zerline created at 2019-02-04 21:24:16

Replying to [comment:52 fbissey]:
> Replying to [comment:45 zerline]:
> > _after a bare ./configure --with-gaproot=../.._ :
> > 
> > 
> > {{{
> > (sage-sh) odile`@`ancolie:json-2.0.0$ make
> >   CXX      src/json.lo
> > src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
> >  #include "src/compiled.h"          /* GAP headers                */
> >           ^~~~~~~~~~~~~~~~
> > compilation terminated.
> > make: *** [Makefile:501: src/json.lo] Error 1
> > 
> > }}}
> 
> That's exactly one of the things I patch see #26930?replyto=45#comment:26 

thank you


---

Comment by dimpase created at 2019-02-04 21:43:52

Replying to [comment:54 zerline]:
> Replying to [comment:51 dimpase]:
> > Replying to [comment:48 zerline]:
> > > Could you point me to a documentation page for this?
> > > 
> > > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> > > 
> > This link is totally obsolete - edited last time in 2013.
> > I've just edited that page to make this clear. Sorry...
> 
> Yet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently _these_ packages (those compiled with the method above) are loaded.

there is no guarantee that one does not break GAP's installation in Sage this way - and it happened in the past often that people tried installing this way GAP packages with kernel modules (such as IO) and ended up with broken Sage installations.


---

Comment by dimpase created at 2019-02-05 13:40:18

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-02-05 13:45:29

Changing priority from major to critical.


---

Comment by embray created at 2019-02-05 15:34:06

Replying to [comment:44 dimpase]:
> I don't see why we should not patch package's source.

It isn't necessary normally when building the package, so why should it have to be patched?  ISTM the problem is just how GAP is being "installed" in Sage, which as we know is tricky since it doesn't have a proper installation system.  

I think the stuff Odile pointed out last night about `sysinfo.gap` clearly needs to be addressed (and in a separate ticket; this one is already trying to do too much).

For example, mine contains (this is just partial):


```
$ cat sysinfo.gap
# This files has been generated by the GAP build system,
# do not edit manually!
GAParch=x86_64-unknown-cygwin-default64
GAP_ABI=64
GAP_HPCGAP=no
GAP_ADDGUARDS2=

GAP_BIN_DIR="/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src"
GAP_LIB_DIR="/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src"

GAP_CC="gcc"
GAP_CFLAGS=" -O2 -g  "
GAP_CPPFLAGS=" -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/gen -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/src -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src -DHAVE_CONFIG_H -I/home/embray/src/sagemath/sage/local/include      "
GAP_LDFLAGS=" -L/home/embray/src/sagemath/sage/local/lib      -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib   -Wl,--stack,16777216"
GAP_LIBS=" -lgmp -lz -lreadline    "
```


In other words, it puts in a lot of paths, which seem to be important for building many packages, but that reference the SPKG build directory and not the actual final GAP_ROOT location (under `$SAGE_LOCAL/share/gap`).

So I think this probably needs to be fixed up when "installing" GAP, at a minimum.


---

Comment by dimpase created at 2019-02-05 15:37:43

On the other hand, the problem of using src/ prefix for includes in quite a few GAP packages seems to be a bit too big to patch.


---

Comment by embray created at 2019-02-05 16:39:44

This should be a dependent of #27218, not the other way around.   I think #27218 will help here.  I don't mind including crypting in this ticket as well since it is small and we know that it's been asked for.  Plus it helps to have an additional test case.


---

Comment by embray created at 2019-02-06 16:01:30

I added yet one more ticket for working on a way to get the libgap.so: #27230

The idea, as in comment:30, was to use the same code for both `SINGULAR_SO` and a new `LIBGAP_SO` variable which serves a similar purpose.

If that code ends up being contentious we can fall back on a simpler method, though I think either way it makes sense to reuse the code used for `SINGULAR_SO` as well, rather than just looping over some extension names.


---

Comment by dimpase created at 2019-02-06 16:05:22

New commits:


---

Comment by embray created at 2019-02-06 16:18:21

If you want, please also try merging #27230 into this and adding a `LIBGAP_SO` to `sage.env` like I suggested in that ticket, and then use that instead of the loop you have currently around `dlopen`.  That's a good observation that for Python 3 it will have to pass bytes to `dlopen()`, so you can use `str_to_bytes(LIBGAP_SO)` for that.


---

Comment by git created at 2019-02-06 20:07:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-02-06 20:08:23

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-02-06 20:08:23

once #27230 done it will be ready for review


---

Comment by git created at 2019-02-07 01:41:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-02-07 01:43:57

so this is now really ready for review.


---

Comment by @timokau created at 2019-02-07 11:55:54

Is this supposed to work on distro with an unchanged gap or is the io package now required?


---

Comment by dimpase created at 2019-02-07 12:04:37

Replying to [comment:70 gh-timokau]:
> Is this supposed to work on distro with an unchanged gap or is the io package now required?

no, io package is still optional. As you see, this ticket does two things:

* fixes Sage's libgap interface to allow kernel modules

* adds two packages (both needing the 1st thing) to its optional spkg gap_packages


---

Comment by git created at 2019-02-08 20:57:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-26 11:08:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-27 21:17:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-02-27 22:08:14

#27380 (extra `/` removed (sic!)) has apparently fixed the problem I had with this branch on OSX, upon running tests on my ancient MacBook it should be ready to go.


---

Comment by dimpase created at 2019-02-28 07:01:07

Tests pass on OSX and Linux. Please review.


---

Comment by dimpase created at 2019-02-28 07:49:58

OSX-specific reviews are needed for this ticket and #27380


---

Comment by embray created at 2019-02-28 10:24:24

Is there a reason this first "installs" crypting by copy in


```diff
diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index 1a3e8c5..07ce727 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
`@``@` -15,6 +15,7 `@``@` sdh_install \
     AutoDoc-* \
     corelg \
     crime-* \
+    crypting-* \
     cryst \
     crystcat \
     design \
```


but then installs it again (including compilation) further down in


```diff
`@``@` -63,7 +64,7 `@``@` install_compiled_pkg()
 #
 # These packages have an old ./configure that take the GAP_ROOT as a positional
 # argument
-for pkg in cohomolo-* grape-* guava-*
+for pkg in cohomolo-* crypting-* grape-* guava-*
 do
     echo "Building GAP package $pkg"
     cd "$PKG_SRC_DIR/$pkg"
```



---

Comment by dimpase created at 2019-02-28 10:26:18

looks like a harmless typo...


---

Comment by embray created at 2019-02-28 10:26:38

Any comment on comment:32 ?  This test really shouldn't be giving unpredictable results.


---

Comment by embray created at 2019-02-28 10:27:13

Replying to [comment:80 dimpase]:
> looks like a harmless typo...

I wouldn't necessarily call it "harmless" but if it's a typo that's okay; I just wondered if there was a real reason or not.


---

Comment by git created at 2019-02-28 16:29:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-28 17:37:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-02-28 17:38:34

Fixed both things.


---

Comment by jhpalmieri created at 2019-02-28 18:26:04

Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.

What else would you like me to check?


---

Comment by dimpase created at 2019-02-28 18:41:51

Replying to [comment:86 jhpalmieri]:
> Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.
> 
but some GAP packages were not fully functional, as their binaries (only few GAP packages have these) were installed in wrong directories...

> What else would you like me to check?

could you run tests, just to have another data point? (I tested on OSX 10.13, I don't have 10.14, my OSX box is too old for it).


---

Comment by jhpalmieri created at 2019-02-28 20:37:48

All tests pass for me. I didn't run full tests with `gap_packages` but without this branch, but I ran limited tests and saw one failure in `sage/groups`. So this looks good to me.


---

Comment by andrew.mathas created at 2019-03-01 13:18:53

I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough?


---

Comment by dimpase created at 2019-03-01 13:31:19

Replying to [comment:89 andrew.mathas]:
> I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough? 

You just need to pull the branch, the GAP tarball is the same. So can be done over GSM :-)

After merging the branch, you'll need to do 

```
./sage -f gap_packages && make ptestlong
```

And if there are errors in tests, please posts them (from `logs/ptestlong.log` file).
Thanks!


---

Comment by embray created at 2019-03-01 15:34:10

On Cygwin I'm getting a few cases of this failure in `src/sage/coding/linear_code.py`:


```
sage -t --long src/sage/coding/linear_code.py
**********************************************************************
File "src/sage/coding/linear_code.py", line 3134, in sage.coding.linear_code.AbstractLinearCode.weight_distribution
Failed example:
    C.weight_distribution(algorithm="leon")   # optional - gap_packages (Guava package)
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.coding.linear_code.AbstractLinearCode.weight_distribution[8]>", line 1, in <module>
        C.weight_distribution(algorithm="leon")   # optional - gap_packages (Guava package)
      File "sage/misc/cachefunc.pyx", line 1950, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10265)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1826, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9750)
        return self.f(self._instance, *args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/coding/linear_code.py", line 3184, in weight_distribution
        lines = subprocess.check_output([os.path.join(guava_bin_dir, 'wtdist'), input])
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/subprocess.py", line 223, in check_output
        raise CalledProcessError(retcode, cmd, output=output)
    CalledProcessError: Command '['/home/embray/src/sagemath/sage/local/share/gap/pkg/guava-3.14/bin/x86_64-unknown-cygwin-default64/wtdist', '/home/embray/.sage/temp/NAVI-Brick/6764/tmp_7ZlhoX::code']' returned non-zero exit status -11
```


The "exit status -11" indicates that the `wtdist` program, whatever that is, from the guava package is segfaulting.  Which is odd because I don't remember having any problem with that before, and it's not clear why it would start with this ticket (unless maybe it's doing something with the IO module that it didn't do when it was unavailable).

I'm going to try backing out the changes from this ticket and rebuilding `gap_packages` again just to rule out the possibility that the problem is somehow related to this ticket.


---

Comment by dimpase created at 2019-03-01 17:18:39

we didn't build this part of guava before, that's why...


---

Comment by embray created at 2019-03-01 17:36:45

I don't see anything explicitly in this ticket that would cause it to start being built though, so I'm a little confused.  Is it because we didn't have #27218?  Does it just, silently not build or something?


---

Comment by embray created at 2019-03-01 17:44:06

AFAICT the code that uses it doesn't check if the `wtdist` program exists or not or anything like that, so it should have just failed before with a command not found or something if it wasn't being built...


---

Comment by embray created at 2019-03-01 18:16:50

Well I was able to reproduce that issue with `gap_packages` prior to this ticket so I guess it's unrelated.  I'll make a new ticket for it. I'm not overly concerned about it in this case since gap_packages is not installed by default anyways.

As a side note, I realized in testing this that it this ticket should also bump the patch version on the SPKG version.

We should also clean up the commit history.  I can go ahead and do that...


---

Comment by dimpase created at 2019-03-01 18:20:03

oops, sorry, I meant it was not installed before GAP 4.10.
I gather it could be something trivial like whether or not there is `.exe` suffix...

Yes, please, bump up the version and rebase. The follow-up to this is #27295.


---

Comment by embray created at 2019-03-01 18:51:25

Okay, I'm fine with this now, especially since you tested on OSX.
----
New commits:


---

Comment by embray created at 2019-03-01 18:51:25

Changing status from needs_review to positive_review.


---

Comment by git created at 2019-03-01 18:57:27

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-03-01 18:57:27

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by embray created at 2019-03-01 18:57:55

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-03-01 18:57:55

Just reworded one of the commit messages.


---

Comment by vbraun created at 2019-03-03 22:38:24

Resolution: fixed
