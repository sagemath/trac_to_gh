# Issue 26152: Hisenbug with Matrix_gfpn_dense or meataxe

Issue created by migration from https://trac.sagemath.org/ticket/26389

Original creator: tscrim

Original creation time: 2018-10-03 10:34:22

CC:  simonking

There is likely an issue with `Matrix_gfpn_dense` or `meataxe`, which is likely caused by where things are in memory. This was first noticed by the following test in `rings/function_field/ideal.py`:

```
sage: K.<x> = FunctionField(GF(3^2)); R.<t> = K[]
sage: F.<y> = K.extension(t^3 + t^2 - x^4)
sage: Oinf = F.maximal_order_infinite()
sage: I = Oinf.ideal(1/y)
sage: I.factor()   # This will sometimes fail
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-b9ca13965ba4> in <module>()
----> 1 I.factor()

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.pyc in factor(self)
   2671             defined by y^2 + y + (x^2 + 1)/x)^2
   2672         """
-> 2673         return Factorization(self._factor(), cr=True)
   2674
   2675     def _factor(self):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.pyc in _factor(self)
   2693
   2694         factors = []
-> 2695         for iprime, exp in O._to_iF(self).factor():
   2696             prime = FunctionFieldIdealInfinite_global(O, iprime)
   2697             factors.append((prime, exp))

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.pyc in factor(self)
   1572             True
   1573         """
-> 1574         return Factorization(self._factor(), cr=True)
   1575
   1576     def _factor(self):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.pyc in _factor(self)
   1598         primes = set([o.ideal(p) for p,_ in d.factor()] + [p for p,_ in i.ideal_below().factor()])
   1599         for prime in primes:
-> 1600             qs = [q[0] for q in O.decomposition(prime)]
   1601             for q in qs:
   1602                 exp = q.valuation(self)

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10824)()
   1951                 return cache[k]
   1952         except KeyError:
-> 1953             w = self._instance_call(*args, **kwds)
   1954             cache[k] = w
   1955             return w

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10280)()
   1827             True
   1828         """
-> 1829         return self.f(self._instance, *args, **kwds)
   1830
   1831     cdef fix_args_kwds(self, tuple args, dict kwds):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/order.pyc in decomposition(self, ideal)
   1838
   1839             # J_1, J_2, ...
-> 1840             Jb =[Kb[0]] + [div(Kb[j],Kb[j-1]) for j in range(1,len(Kb))]
   1841
   1842             # H_1, H_2, ...

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/function_field/order.pyc in div(Ib, Jb)
   1805                 sJb = Jb.row_space()
   1806                 sIb = Ib.row_space()
-> 1807                 sJbsIb,proj_sJbsIb,lift_sJbsIb = sJb.quotient_abstract(sIb)
   1808                 supplement_basis = [lift_sJbsIb(v) for v in sJbsIb.basis()]
   1809

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/modules/free_module.pyc in quotient_abstract(self, sub, check)
   4546         # Calling is_subspace may be way too slow and repeat work done below.
   4547         # It will be very desirable to somehow do this step better.
-> 4548         if check and (not is_FreeModule(sub) or not sub.is_subspace(self)):
   4549             try:
   4550                 sub = self.subspace(sub)

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/modules/free_module.pyc in is_subspace(self, other)
   3790             True
   3791         """
-> 3792         return self.is_submodule(other)
   3793
   3794     def span(self, gens, base_ring=None, check=True, already_echelonized=False):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/modules/free_module.pyc in is_submodule(self, other)
   1458             from sage.misc.flatten import flatten
   1459             return all(x in S for x in flatten(M))
-> 1460         return all(x in S for x in M.list())
   1461
   1462     def __iter__(self):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.list (build/cythonized/sage/matrix/matrix0.c:4165)()
    154             [      y       x 2*x + y]
    155         """
--> 156         return list(self._list())
    157
    158     def _list(self):

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense._list (build/cythonized/sage/matrix/matrix_gfpn_dense.c:9038)()
    908             FfStepPtr(&(p))
    909             sig_check()
--> 910         x.extend([self._converter.int_to_field(FfToInt(FfExtract(p,j))) for j in range(self.Data.Noc)])
    911         self.cache('list', x)
    912         return x

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.FieldConverter_class.int_to_field (build/cythonized/sage/matrix/matrix_gfpn_dense.c:3717)()
    135
    136         """
--> 137         return self.field(x)
    138     cpdef int field_to_int(self, x):
    139         """

/home/uqtscrim/sage/local/lib/python2.7/site-packages/sage/rings/finite_rings/element_givaro.pyx in sage.rings.finite_rings.element_givaro.Cache_givaro.fetch_int (build/cythonized/sage/rings/finite_rings/element_givaro.cpp:8618)()
    591
    592         if n<0 or n>k.cardinality():
--> 593             raise TypeError("n must be between 0 and self.order()")
    594
    595         for i from 0 <= i < k.exponent():

TypeError: n must be between 0 and self.order()
sage: I.factor()
(Ideal (1/x,1/x^3*y^2) of Maximal infinite order of Function field in y defined by y^3 + y^2 + 2*x^4)^4
```

(This is not the only test that can fail in this file.) However, once this does finish, it never seems to fail (maybe due to some cache deep down in the call). The exact values that are returned with this error are `n = 255` and `self.order() = 9`. This does not seem to be a problem when using `GF(19^2)` or when `meataxe` is not installed.


---

Comment by jdemeyer created at 2018-10-03 15:42:08

Changing priority from critical to blocker.


---

Comment by klee created at 2018-10-04 00:22:43

> Do you know offhand (i.e., don't spend much time on this) of a simple way I can extract out the relevant matrix >computation? This is not a minimal example, and it would be useful to get it down smaller.

Right. But I didn't see the failure from the doctest yet, even after I installed meataxe to my installation (on mac). Do you have a specific procedure likely to encounter the failure?


---

Comment by tscrim created at 2018-10-04 00:30:23

Replying to [comment:2 klee]:
> > Do you know offhand (i.e., don't spend much time on this) of a simple way I can extract out the relevant matrix >computation? This is not a minimal example, and it would be useful to get it down smaller.
> 
> Right. But I didn't see the failure from the doctest yet, even after I installed meataxe to my installation (on mac). Do you have a specific procedure likely to encounter the failure?  

You may also have to run `sage -b`. However, it doesn't always happen, which is the annoying part. Usually I just run `sage -tp` on the file a bunch of times and it happens with some reasonable frequency.


---

Comment by klee created at 2018-10-04 04:32:06

Still no failure from 

```
 for i in {1..100}; do sage -tp src/sage/rings/function_field/ideal.py; done
```

on mac, after `sage -i meataxe; make`


---

Comment by SimonKing created at 2018-10-05 10:12:28

Replying to [ticket:26389 tscrim]:
> There is likely an issue with `Matrix_gfpn_dense` or `meataxe`, which is likely caused by where things are in memory. This was first noticed by the following test in `rings/function_field/ideal.py`:

Question: Are you using a special branch? Or do you mean the test in `sage/rings/function_field/function_field_ideal.py`, not `sage/rings/function_field/ideal.py` (which doesn't exist)?

When running the tests in `.../function_field_ideal.py` a hundred times, I get no problems whatsoever. And yes, I do have meataxe installed (using it intensively in computations with the p_group_cohomology package).

This raises the question what kind of machine you are using. Anything special concerning endianness, size of long, I think I recall there can also be issues regarding whether char is signed or not?


---

Comment by tscrim created at 2018-10-05 10:30:16

Replying to [comment:5 SimonKing]:
> Replying to [ticket:26389 tscrim]:
> > There is likely an issue with `Matrix_gfpn_dense` or `meataxe`, which is likely caused by where things are in memory. This was first noticed by the following test in `rings/function_field/ideal.py`:
> 
> Question: Are you using a special branch? Or do you mean the test in `sage/rings/function_field/function_field_ideal.py`, not `sage/rings/function_field/ideal.py` (which doesn't exist)?
> 
> When running the tests in `.../function_field_ideal.py` a hundred times, I get no problems whatsoever. And yes, I do have meataxe installed (using it intensively in computations with the p_group_cohomology package).

No, I am running vanilla 8.4.beta7. It seems like you are running 8.4.beta6 or below (specifically, this was added in #25435).

> This raises the question what kind of machine you are using. Anything special concerning endianness, size of long, I think I recall there can also be issues regarding whether char is signed or not?

I have seen this arise on multiple patchbots from multiple tickets ([sardonis on 25477](https://patchbot.sagemath.org/log/25477/Ubuntu/16.04/ppc64le/4.4.0-124-generic/sardonis/2018-10-03%2003:21:26?short), [sage4 on 12053](https://patchbot.sagemath.org/log/12053/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2018-10-05%2001:58:09?short), [sage4 on 26400](https://patchbot.sagemath.org/log/26400/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2018-10-04%2015:16:29?short)). I don't think I have anything special. I kinda recall there being a signed char issue, but I thought you had fixed that.


---

Comment by tscrim created at 2018-10-05 10:31:25

Replying to [comment:4 klee]:
> Still no failure from 
> {{{
>  for i in {1..100}; do sage -tp src/sage/rings/function_field/ideal.py; done
> }}}
> on mac, after `sage -i meataxe; make`

Maybe it is not something that shows up on macs (I am running Ubuntu 16.04 LTS).


---

Comment by SimonKing created at 2018-10-05 10:41:39

Replying to [comment:6 tscrim]:
> No, I am running vanilla 8.4.beta7. It seems like you are running 8.4.beta6 or below (specifically, this was added in #25435).

That would explain it: I got

```
sage: version()
'SageMath version 8.4.beta5, Release Date: 2018-09-15'
```


OK, I'll try to see what I can do.

EDIT: I'll use the current develop branch merged with the branch that introduces singular-4.1.1.p3.


---

Comment by SimonKing created at 2018-10-07 06:13:41

After upgrading, I indeed get frequent errors with that test, namely twice the same test in the same file:

```
File "src/sage/rings/function_field/ideal.py", line 2581, in sage.rings.function_field.ideal.FunctionFieldIdealInfinite_global.is_prime
Failed example:
    I.factor()
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.function_field.ideal.FunctionFieldIdealInfinite_global.is_prime[4]>", line 1, in <module>
        I.factor()
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.py", line 2673, in factor
        return Factorization(self._factor(), cr=True)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.py", line 2695, in _factor
        for iprime, exp in O._to_iF(self).factor():
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.py", line 1574, in factor
        return Factorization(self._factor(), cr=True)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/ideal.py", line 1600, in _factor
        qs = [q[0] for q in O.decomposition(prime)]
      File "sage/misc/cachefunc.pyx", line 1953, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10824)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1829, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10280)
        return self.f(self._instance, *args, **kwds)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/order.py", line 1840, in decomposition
        Jb =[Kb[0]] + [div(Kb[j],Kb[j-1]) for j in range(1,len(Kb))]
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/function_field/order.py", line 1807, in div
        sJbsIb,proj_sJbsIb,lift_sJbsIb = sJb.quotient_abstract(sIb)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/modules/free_module.py", line 4548, in quotient_abstract
        if check and (not is_FreeModule(sub) or not sub.is_subspace(self)):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/modules/free_module.py", line 3792, in is_subspace
        return self.is_submodule(other)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/modules/free_module.py", line 1460, in is_submodule
        return all(x in S for x in M.list())
      File "sage/matrix/matrix0.pyx", line 156, in sage.matrix.matrix0.Matrix.list (build/cythonized/sage/matrix/matrix0.c:4165)
        return list(self._list())
      File "sage/matrix/matrix_gfpn_dense.pyx", line 910, in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense._list (build/cythonized/sage/matrix/matrix_gfpn_dense.c:9038)
        x.extend([self._converter.int_to_field(FfToInt(FfExtract(p,j))) for j in range(self.Data.Noc)])
      File "sage/matrix/matrix_gfpn_dense.pyx", line 137, in sage.matrix.matrix_gfpn_dense.FieldConverter_class.int_to_field (build/cythonized/sage/matrix/matrix_gfpn_dense.c:3717)
        return self.field(x)
      File "sage/rings/finite_rings/element_givaro.pyx", line 593, in sage.rings.finite_rings.element_givaro.Cache_givaro.fetch_int (build/cythonized/sage/rings/finite_rings/element_givaro.cpp:8618)
        raise TypeError("n must be between 0 and self.order()")
    TypeError: n must be between 0 and self.order()
```

The error seems to indicate that the matrix contains items that do not belong to the underlying field. And that sounds pretty much like a memory corruption.

I cannot dive into it at the moment (need to prepare a written exam to be held tomorrow), but at least I can confirm the problem.


---

Comment by SimonKing created at 2018-10-07 06:18:44

The good thing is that it seems not to be caused by some obscure side-effect of other tests: I did

```
sage: K.<x> = FunctionField(GF(3^2)); _.<t> = PolynomialRing(K)
sage: F.<y> = K.extension(t^3 + t^2 - x^4)
sage: Oinf = F.maximal_order_infinite()
sage: I = Oinf.ideal(1/x)
sage: I.factor()
```

in three new Sage sessions. The first two times the test worked. The third time it failed.


---

Comment by SimonKing created at 2018-10-08 09:18:05

Please do not always change the ticket description. It makes me get a long mail (stating the old description but not the new one). Moreover it hides what you have actually changed (unless one clicks on the "diff" button).

So please, when you dig further, write a comment.


---

Comment by vbraun created at 2018-10-11 22:28:42

Since its optional I don't really see this as a blocker; Though if a simple bugfix materializes really soon I'd consider merging it...


---

Comment by klee created at 2018-10-12 00:32:43

Changing priority from blocker to major.


---

Comment by SimonKing created at 2018-10-15 11:19:34

Nice! So, the problem is just a corner case that was forgotten to be dealt with in my *wrapper* for SharedMeatAxe. That's a big relief. I thought it would be caused by a problem in SharedMeatAxe's memory management.


---

Comment by jdemeyer created at 2018-10-15 11:24:15

New commits:


---

Comment by jdemeyer created at 2018-10-15 11:24:15

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-10-15 11:36:09

The mystery is why this bug suddenly shows up now. As far as I can tell (by looking at git history), this has been broken all the time since #12103.


---

Comment by SimonKing created at 2018-10-15 15:24:10

Replying to [comment:23 jdemeyer]:
> The mystery is why this bug suddenly shows up now. As far as I can tell (by looking at git history), this has been broken all the time since #12103.

Well, it is not a big surprise if the old code accessed uninitialised memory.


---

Comment by jdemeyer created at 2018-10-15 15:48:49

Patchbot passed on sage4 which has `meataxe` installed.


---

Comment by tscrim created at 2018-10-18 17:10:53

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-10-18 17:10:53

LGTM. Thank you Jeroen.


---

Comment by vbraun created at 2018-10-20 11:58:32

Resolution: fixed


---

Comment by embray created at 2018-10-28 14:52:23

This should be re-targeted for 8.5.
