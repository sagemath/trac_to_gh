# Issue 17795: Broken copy, plot in sandpile

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-03-21 14:45:19

CC:  ncohen dimpase mhampton dperkinson

The inherited copy method does not work

```
sage: g = {0:[1,2], 1:[0,3], 2:[0,3], 3:[1,2]}
sage: G = Sandpile(g,3)
sage: G.copy()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-3cacdf1124d3> in <module>()
----> 1 G.copy()

/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in __copy__(self, weighted, implementation, data_structure, sparse, immutable)
   1025                            boundary=copy(self._boundary), weighted=weighted,
   1026                            implementation=implementation,
-> 1027                            data_structure=data_structure)
   1028 
   1029         attributes_to_copy = ('_assoc', '_embedding')

TypeError: __init__() got an unexpected keyword argument 'weighted'
```

This messes up other inherited methods, e.g. `plot`


---

Comment by ncohen created at 2015-03-21 15:58:07

If somebody actually knows this file, it would be nice to think of what should be done with `random_dag`, `random_digraph` and `random_tree`, which are all exported into the global namespace (and we have `graphs.<tab>` for these things already).


---

Comment by vbraun created at 2015-03-21 16:22:59

But please post your conclusion on the `random_*` methods on a separate ticket.


---

Comment by ncohen created at 2015-03-21 16:28:58

Of course of course, this belongs to a separate ticket. I do not believe in opening tickets which I do not address myself, so I hoped that the guy who will know that file and work on this ticket can do something about that too.

But in another ticket, of course.

Nathann


---

Comment by peterwicksstringfield created at 2015-03-29 19:34:37

The inherited __copy__ method was broken because Sandpile changed the signature of __init__.

I fixed this by moving the part of __copy__ that depends on __init__'s signature into its own function and overriding it in Sandpile.

This could also be fixed by copy+pasting the entire __copy__ method into Sandpile and tweaking it a bit. I think that's uglier than this though, though maybe not by much.

What does everyone else think?


---

Comment by git created at 2015-03-29 19:37:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-03-30 14:35:41

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-03-30 14:35:41

Hello,

There are several problems with your code:

- Why do you add this new `_make_copy` method in `GenericGraph`? I am not sure
  that I understand your goal, but I suspect that you may want to learn about
  the 'super' function of Python:

  http://stackoverflow.com/questions/576169/understanding-python-super-with-init-methods

  Perhaps you only want to call `super().__copy__()` somewhere?

- The way you added `*args` and `**kwds` to the `__init__` method of !Sandpile,
  the constructor now accepts anything as input,
  e.g. `Sandpile(heyheyhey="heyheyhey")` which has no meaning. When you use such
  a syntax, please ensure that one of the two following points is verified:

  a) The method checks that all the arguments that it is given are actually used,
    and raises an exception otherwise

  b) The method forwards all of `args` and `kwds` to another function

  This way we make sure that all arguments are read at least once, and that none
  of the input is ignored. This is especially useful to detect typos like
  `Sandpile(weithged=True)`, which would otherwise return no warning.

- All functions should have an INPUT and a TEST section:

  http://www.sagemath.org/doc/developer/coding_basics.html#the-docstring-of-a-function-content

Nathann


---

Comment by ncohen created at 2015-03-30 14:35:54

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-03-30 14:40:28

Changing keywords from "" to "sd66".


---

Comment by vbraun created at 2015-04-09 00:15:01

I added a override for copy. 

I don't like the `GenericGraph.__copy__` implementation, for starters its not making a copy. If you want to provide a way to change backends then call the ctor, or provide an appropriately-named method. A copy is not something with completely different innards that happens to compare equal. In any case, its best to not touch it from the Sandpile side.
----
New commits:


---

Comment by vbraun created at 2015-04-09 00:15:01

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-09 06:43:09

Helloooooo,

Looks good. About the graph's `copy` function, you will appreciate that `G.copy()` does precisely what you expect. Then, if you ask it to do more it will do... What you ask it to `:-P`

Nathann


---

Comment by ncohen created at 2015-04-09 06:54:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-09 07:58:59

Replying to [comment:12 ncohen]:
> Looks good. About the graph's `copy` function, you will appreciate that `G.copy()` does precisely what you expect. Then, if you ask it to do more it will do... What you ask it to `:-P`

No, `G.copy` does not do what I expect it to do. I've never before seen a copy method with a dozen arguments. I expect it to make a copy of ``self``, and I expect it to do nothing else.  

By the same argument, how about we rename `Matrix.change_ring` to `Matrix.copy` since a) the changed-ring matrix is still `==` comparable, and b) you could pass in the same ring to make a copy. But I hope you can agree that this would be ridiculous.


---

Comment by ncohen created at 2015-04-09 08:29:05

Hello,

> No, `G.copy` does not do what I expect it to do.

You misread. I was talking about `G.copy()` (no arguments). It does exactly what you expect it to.

Do you think that it is a problem for a `copy` function to take optional arguments? If so, can you explain why?

I do not believe that there is any risk of confusion possible, the meaning of `G.copy(immutable=True)` or `G.copy(data_structure="static_sparse_graph")` is rather obvious to anybody who reads it.

Nathann


---

Comment by vbraun created at 2015-04-09 08:47:42

Is `G.copy` implementing deep copy or shallow copy? The answer is clearly "neither" (or, more precisely, deep copy plus a grab bag of stuff that is not copy). So it should be labeled more accurately. Then people that subclass GenericGraph wouldn't be so confused by it, this ticket is plain evidence that it is confusing. I overrode `__copy__` which now means that the grab bag of non-copy stuff is gone from Sandpile. I say good riddance. But it does make it inconsistent with what is going on in the base class.


---

Comment by ncohen created at 2015-04-09 08:54:32

The problem that you met here is not related to copy. The problem is that `SandPile` inherits from `Graph`, but that its `__init__` function does not accept all arguments that `Graph.__init__` accepts.

Nathann


---

Comment by vbraun created at 2015-04-09 09:10:15

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-09 09:10:15

I know, but that is fair game in OOP. The standard lore is that you need to provide a copy ctor (`__copy__`) if you change the ctor (`__init__`) arguments. Then you can always make copies as needed. The ctor makes instances (and its arguments may change in subclasses), the copy ctor makes identical (as far as possible) copies (and takes the same = no arguments all the time).

Even with this ticket `Sandpile.copy == GenericGraph.__copy__` still doesn't work. That is fine with me since it doesn't make a copy anyways. But `plot()` also calls `copy(immutable=False)`, so plot is still broken. Why can't we plot immutable graphs to start with? Also, copies should be mutable, that usually the point of copying the immutable object. See e.g.:

```
sage: v = vector([1, 2, 3])
sage: v.is_immutable()
False
sage: v.set_immutable()
sage: v.is_immutable()
True
sage: copy(v).is_immutable()
False
```



---

Comment by ncohen created at 2015-04-09 09:21:43

Well, add a `**kwds` to the constructor, forward everything to `super().__init__` and you are done.

Nathann


---

Comment by vbraun created at 2015-04-09 09:24:22

Nuuh, `GenericGraph.copy` will still not pass positional arguments to `Sandpile.__init__`.


---

Comment by ncohen created at 2015-04-09 09:38:11

> Nuuh, `GenericGraph.copy` will still not pass positional arguments to `Sandpile.__init__`.

If your `copy` accept `**kwds` and you forward everything to the constructor then it should work, shouldn't it?

Nathann


---

Comment by vbraun created at 2015-04-09 09:49:52

In other words I also have to override `copy` in addition to `__copy__`. How very convenient. This is why Peter originally factored out the `self.__class__` call inside `__copy__`, to provide a hook to override this call. It is all a logical consequence of having `__copy__` do non-copy stuff...


---

Comment by ncohen created at 2015-04-09 09:55:10

> In other words I also have to override `copy` in addition to `__copy__`. How very convenient. This is why Peter originally factored out the `self.__class__` call inside `__copy__`, to provide a hook to override this call. It is all a logical consequence of having `__copy__` do non-copy stuff...

The same would have happened with any other function. If a class B inherits from A but B.f has fewer arguments than A.f, then of course something is going to break.

Now, if you look at `Sandpile.<tab>` and most methods do not make sense to you, then perhaps `Sandpile` should not inherit from `Graph` but merely have a `._graph` variable.

Nathann


---

Comment by vbraun created at 2015-04-09 09:56:41

Replying to [comment:23 ncohen]:
> The same would have happened with any other function. If a class B inherits from A but B.f has fewer arguments than A.f, then of course something is going to break.

Except that `__copy__` isn't supposed to have any arguments, and if Graphs would follow that simple rule then we wouldn't have the problem.


---

Comment by ncohen created at 2015-04-09 09:58:33

> Except that `__copy__` isn't supposed to have any arguments, and if Graphs would follow that simple rule then we wouldn't have the problem. 

Feel free to replace `GenericGraph.__copy__` by a new function with no arguments that calls `.copy()` (with no argument). I fail to see how that is an improvement, but if that makes it simpler for you I do not mind.

Nathann


---

Comment by vbraun created at 2015-04-09 10:12:03

Thats not an improvement since `plot()` still calls `G.copy()` (which shouldn't have been called copy) instead of `G.__copy__()`  to make a copy.


---

Comment by ncohen created at 2015-04-09 10:17:39

> Thats not an improvement since `plot()` still calls `G.copy()`

I agree. Which totally proves that the problem is not that `__copy__` takes arguments, but that you inherit a function which you overwrite while accepting fewer arguments.

I think that the easiest is to accept `**kwds` in your copy function and to forward it to the constructor. Same in the constructor, which will forward everything to `Graph.__init__`.

Nathann


---

Comment by vbraun created at 2015-04-09 10:20:28

Replying to [comment:27 ncohen]:
> I agree. Which totally proves that the problem is not that `__copy__` takes arguments, but that you inherit a function which you overwrite while accepting fewer arguments.

But `__copy__` is not supposed to take arguments precisely because you would then fall into this trap.


---

Comment by ncohen created at 2015-04-09 10:26:43

> But `__copy__` is not supposed to take arguments precisely because you would then fall into this trap.

I fail to see why this problem could happen with `__copy__` and not with other functions.

Nathann


---

Comment by git created at 2015-04-09 12:03:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-04-09 12:04:30

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-04-09 12:04:30

Maybe its clearer now, just fixing `GenericGraph.__copy__` also fixes the Sandpile plotting.


---

Comment by ncohen created at 2015-04-09 12:20:41

You are making the default behaviour of `copy` to *change* the backend?

Nathann


---

Comment by ncohen created at 2015-04-09 12:20:41

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2015-04-10 10:27:24

Only if necessary (i.e. only if the current backend doesn't support mutable graphs). The expected behavior of copy is that the copy is mutable.


---

Comment by ncohen created at 2015-04-10 10:29:34

> The expected behavior of copy is that the copy is mutable.

No.


```
sage: copy((1,2,3))
(1, 2, 3)
```


Nathann


---

Comment by vbraun created at 2015-04-10 10:31:07

Its a Sage convention, not a Python convention. Python doesn't have a concept of (imm)mutability for a single class, just completely different classes. Of course copy has to return an instance of the same class.


---

Comment by ncohen created at 2015-04-10 10:39:22

> Its a Sage convention, not a Python convention. Python doesn't have a concept of (imm)mutability for a single class, just completely different classes. Of course copy has to return an instance of the same class.

I disagree with the change that you propose. Now as you have a way to fix your bug with 4 lines of code please implement that.

Nathann


---

Comment by vbraun created at 2015-04-10 10:41:02

Its the same interface that vectors and matrices have. If you disagree with these too then fine. But my change is a big improvement to the graph code.


---

Comment by ncohen created at 2015-04-10 19:03:53

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-14 19:43:43

Resolution: fixed
