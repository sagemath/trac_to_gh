# Issue 12782: MPFR illegal instruction in OSX binaries

Issue created by migration from https://trac.sagemath.org/ticket/12954

Original creator: vbraun

Original creation time: 2012-05-17 04:07:00

Assignee: GeorgSWeber

CC:  jdemeyer leif jpflori mhansen kcrisman vbraun

The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors. Newer CPUs are fine, most likely too aggressive CFLAGS (are we correctly dialing them down if SAGE_FAT_BINARY is set?)

```
sage: int(2.75) 
Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand. 
0x0000000101723ed9 in case1 () 
(gdb) bt 
#0  0x0000000101723ed9 in case1 () 
#1  0x0000000103e8bba4 in parsed_string_to_mpfr () 
#2  0x0000000103e8c7fb in mpfr_strtofr () 
Previous frame inner to this frame (gdb could not unwind past this frame) 
```

Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion


---

Comment by jdemeyer created at 2012-05-17 13:42:19

Can you disassemble to see which instruction failed?

This MPFR binary was built with

```
-Wall -Wmissing-prototypes -Wpointer-arith -O2 -m64 -march=corei7 -mtune=corei7 
```


MPIR was built with

```
-O2 -m64 -march=corei7 -mtune=corei7
```


So, SAGE_FAT_BINARY indeed doesn't work as it should.


---

Comment by kcrisman created at 2012-05-17 13:54:36

> Can you disassemble to see which instruction failed?
> 

If you tell me how to do that (explicit commands) I have the offending binary on the right CPU and could at least get you a dump of the info that came out.


---

Comment by jdemeyer created at 2012-05-17 16:24:09

Changing component from build to packages.


---

Comment by jdemeyer created at 2012-05-17 16:24:09

Changing assignee from GeorgSWeber to tbd.


---

Comment by jdemeyer created at 2012-05-17 16:24:09

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2012-05-17 18:31:05

The problem is with MPIR (as MPFR simply uses MPIR's flags).  The current MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.


---

Comment by jdemeyer created at 2012-05-18 12:26:49

Changing status from new to needs_review.


---

Comment by vbraun created at 2012-05-18 14:15:00

`SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:

SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"

I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.


---

Comment by jdemeyer created at 2012-05-18 14:30:39

Replying to [comment:11 vbraun]:
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"
> 
> I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.

MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.


---

Comment by dimpase created at 2012-05-18 22:14:52

I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
 on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.


---

Comment by mhansen created at 2012-05-18 22:30:13

Replying to [comment:13 dimpase]:
> I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
>  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.

I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?


---

Comment by dimpase created at 2012-05-18 22:33:55

Replying to [comment:14 mhansen]:
> Replying to [comment:13 dimpase]:
> > I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
> >  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.
> 
> I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?

it's a good point. Well, I don't have newer hardware to test this.


---

Comment by vbraun created at 2012-05-18 22:49:13

Replying to [comment:12 jdemeyer]:
> MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.

Why do we have to set CFLAGS at all, then?

Also, is this really true? With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?


---

Comment by jdemeyer created at 2012-05-19 08:19:07

Replying to [comment:16 vbraun]:
> With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?
The surrounding library code is compiled with basic CFLAGS, without setting `-march` at all.  But the critical routines are compiled several times for various processors.


---

Comment by jdemeyer created at 2012-05-19 08:22:43

If you want


---

Comment by dimpase created at 2012-05-19 12:17:24

I tried the (non-app) binary from 5.0.1.rc0 on on Core 2 Duo (OSX 10.6.8), and got the usual crash:

```

sage: int(2.75)

------------------------------------------------------------------------
Unhandled SIGILL: An illegal instruction occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/Users/dima/Desktop/sage/spkg/bin/sage: line 312: 63629 Illegal instruction     sage-ipython "$@" -i

```


with ./sage -gdb, I get 

```
sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) bt
#0  0x00000001016e3ed9 in case1 ()
#1  0x0000000103e6dba4 in parsed_string_to_mpfr ()
#2  0x0000000103e6e7fb in mpfr_strtofr ()
Previous frame inner to this frame (gdb could not unwind past this frame)
(gdb) 
```



---

Comment by dimpase created at 2012-05-19 12:17:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-05-19 13:35:30

Can you send the output of

```
(gdb) disas
```

when getting a `SIGILL`?


---

Comment by dimpase created at 2012-05-19 13:57:04

Replying to [comment:20 jdemeyer]:
> Can you send the output of
> {{{
> (gdb) disas
> }}}
> when getting a `SIGILL`?

```

sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) disas
Dump of assembler code for function case1:
0x00000001016e3ed9 <case1+0>:	popcnt 0x20(%rdi),%r8
0x00000001016e3edf <case1+6>:	add    %r8,%rax
End of assembler dump.
(gdb) 
```



---

Comment by vbraun created at 2012-05-19 22:59:13

popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 

```
[~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
   45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
   45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
[...]
```

and I believe the equivalent command on OSX would be `otool -tV`. Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?


---

Comment by dimpase created at 2012-05-19 23:13:50

Replying to [comment:22 vbraun]:
> popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 
> {{{
> [~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
>    45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
>    45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
> [...]
> }}}
> and I believe the equivalent command on OSX would be `otool -tV`. 
yes, that's right (except it's not .so, but .dylb)

```
$ otool -tV local/lib/libmpir.dylib | grep popcnt
000000000003be60	popcnt	(%rdi,%rcx,8),%r8
000000000003be66	popcnt	0x08(%rdi,%rcx,8),%r9
```


> Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?

how would it help?
The problem seems to be in the inability of non-Apple gcc to build fat, a.k.a. universal, dynamic libs and executables. So I think we should either resort to making binary releases for OSX targeted to a particular architecture, or provide some post-install script that basically would do ./sage -f mpir (and anything else that needs similar fix) followed by ./sage -b. It's time-consuming to run, but it needs to be done only once...


---

Comment by vbraun created at 2012-05-19 23:22:42

Replying to [comment:23 dimpase]:
> how would it help?

It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.


---

Comment by dimpase created at 2012-05-19 23:27:14

Replying to [comment:24 vbraun]:
> Replying to [comment:23 dimpase]:
> > how would it help?
> 
> It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.

well, we certainly should ship such binaries, it's more about the proper labeling of them as such...


---

Comment by leif created at 2012-05-23 15:23:54

Replying to [comment:11 vbraun]:
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"

That description is certainly insufficient (or, to be more precise, one shouldn't read it from right to left).  One should in general not prepare "fat" binaries on relatively new (e.g. Core i7) CPUs -- unless one knows what one's doing... ;-)

IMHO the main purpose of `SAGE_FAT_BINARY` is to avoid the use of processor-specific ("hand-written") _assembly code_ (and prevent Sage from using things like `-march=native`); it's still up to the _distributor_ to make sure the compiler is targeted to the _desired_ CPU family (whichever that is).




Doing some "sanity check" upon `sage -bdist` isn't all bad, but of course heavily depends on what (limited) architecture a specific binary distribution is supposed to be run on.


----

I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.


---

Comment by jdemeyer created at 2012-05-27 06:08:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-05-27 06:11:44

Changing keywords from "" to "sd40.5".


---

Comment by jdemeyer created at 2012-05-27 06:20:02

Replying to [comment:25 dimpase]:
> Replying to [comment:24 vbraun]:
> > Replying to [comment:23 dimpase]:
> > > how would it help?
> > 
> > It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.
> 
> well, we certainly should ship such binaries
I don't think we should ship such binaries, otherwise you're just going to confuse people.


---

Comment by jdemeyer created at 2012-05-27 06:22:10

New spkg should be ready for review, changes have not yet been committed.


---

Attachment

Diff between the 2.4.0.p3 and 2.4.0.p4 spkgs. For reference / review only.


---

Comment by jdemeyer created at 2012-05-27 06:53:36

Replying to [comment:26 leif]:
> I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.
So let's change it to `{PKG}_CONFIGURE`.  Some of these packages (mpfr, ecm, pari) need to be changed anyway.


---

Comment by was created at 2012-05-27 16:59:36

Changing status from needs_review to positive_review.


---

Comment by was created at 2012-05-27 16:59:36

I read through your patch twice, tried building with SAGE_FAT_BINARY="yes", and this all looks great to me.  Of course, the real test is the buildbot and whether or not this really solves people's problems.   So for now I give this a positive review.


---

Comment by kcrisman created at 2012-05-28 22:47:47

I can confirm that this seems to work on an Intel Core 2 Duo which previously could not use the buildbot's binary.


---

Comment by jdemeyer created at 2012-05-28 22:59:04

Resolution: fixed


---

Comment by kcrisman created at 2012-05-31 21:10:42

Just for reference, this also appears to have solved a similar issue on older PPC Macs using binaries built on (still old, but not _as_ old) less old PPC Macs which was new with 5.0.  Good work.
