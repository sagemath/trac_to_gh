# Issue 23634: Assorted doctest failures due to optional packages

Issue created by migration from https://trac.sagemath.org/ticket/23871

Original creator: mderickx

Original creation time: 2017-09-15 18:53:28

The following tests fail on ubuntu 16.04 with all optional packages except `gmp igraph libtheora mpfrcx python_igraph`
installed. Note that on this system all test passed before installing the optional packages.



```
./sage -tp 2 --all 
...
...
...
sage -t --long --warn-long 46.3 src/sage/schemes/elliptic_curves/ell_number_field.py  # 18 doctests failed
sage -t --long --warn-long 46.3 src/sage/manifolds/differentiable/affine_connection.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/misc/sagedoc.py  # 7 doctests failed
sage -t --long --warn-long 46.3 src/sage/tests/cmdline.py  # 9 doctests failed
sage -t --long --warn-long 46.3 src/sage/manifolds/differentiable/vectorfield.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/rings/number_field/number_field.py  # 3 doctests failed
sage -t --long --warn-long 46.3 src/sage/graphs/generators/smallgraphs.py  # 9 doctests failed
sage -t --long --warn-long 46.3 src/sage/coding/linear_code.py  # 12 doctests failed
sage -t --long --warn-long 46.3 src/sage/graphs/strongly_regular_db.pyx  # 16 doctests failed
sage -t --long --warn-long 46.3 src/sage/graphs/generators/classical_geometries.py  # 6 doctests failed
sage -t --long --warn-long 46.3 src/sage/combinat/designs/database.py  # 3 doctests failed
sage -t --long --warn-long 46.3 src/sage/rings/integer.pyx  # 1 doctest failed
sage -t --long --warn-long 46.3 local/lib/python2.7/site-packages/sagenb/notebook/worksheet.py  # 1 doctest failed
sage -t --long --warn-long 46.3 local/lib/python2.7/site-packages/sagenb/notebook/cell.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/groups/perm_gps/permgroup.py  # 30 doctests failed
sage -t --long --warn-long 46.3 src/sage/tensor/modules/comp.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/parallel/decorate.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/groups/perm_gps/permgroup_named.py  # 50 doctests failed
sage -t --long --warn-long 46.3 src/sage/groups/generic.py  # 6 doctests failed
sage -t --long --warn-long 46.3 src/sage/combinat/integer_vectors_mod_permgroup.py  # 2 doctests failed
sage -t --long --warn-long 46.3 src/sage/repl/interpreter.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/rings/polynomial/polynomial_rational_flint.pyx  # 4 doctests failed
sage -t --long --warn-long 46.3 src/sage/rings/number_field/galois_group.py  # 2 doctests failed
sage -t --long --warn-long 46.3 local/lib/python2.7/site-packages/sagenb/notebook/notebook.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/combinat/designs/block_design.py  # 6 doctests failed
sage -t --long --warn-long 46.3 src/sage/coding/code_bounds.py  # 6 doctests failed
sage -t --long --warn-long 46.3 src/sage/combinat/designs/incidence_structures.py  # 7 doctests failed
sage -t --long --warn-long 46.3 src/sage/combinat/sloane_functions.py  # 2 doctests failed
sage -t --long --warn-long 46.3 src/sage/coding/databases.py  # 4 doctests failed
sage -t --long --warn-long 46.3 src/doc/ru/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/en/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/fr/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/ja/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/de/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/pt/tutorial/interfaces.rst  # 2 doctests failed
sage -t --long --warn-long 46.3 src/doc/en/constructions/groups.rst  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/repl/ipython_tests.py  # UserWarning in doctesting framework
sage -t --long --warn-long 46.3 src/sage/categories/finite_permutation_groups.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/parallel/multiprocessing_sage.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/tests/gap_packages.py  # 1 doctest failed
sage -t --long --warn-long 46.3 local/lib/python2.7/site-packages/sagenb/notebook/challenge.py  # 1 doctest failed
sage -t --long --warn-long 46.3 local/lib/python2.7/site-packages/sagenb/notebook/template.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/ext/memory.pyx  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/combinat/designs/design_catalog.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/doc/common/conf.py  # 1 doctest failed
sage -t --long --warn-long 46.3 src/sage/coding/guava.py  # 3 doctests failed
```


Any doctest for which a more specific reason of failure can be found shouldd get a separate ticket and be added to #23832. After this the doctests can be removed from this ticket.


---

Comment by mderickx created at 2017-09-15 18:55:00

Changing component from PLEASE CHANGE to misc.


---

Comment by jdemeyer created at 2017-09-15 19:24:11

Replying to [ticket:23871 mderickx]:
> The following tests fail on ubuntu 16.04 with all optional packages except `gmp igraph libtheora mpfrcx python_igraph`

Instead of listing the packages which are not installed, can you instead list the packages which are installed?


---

Comment by tscrim created at 2017-09-15 19:37:18

Do you also have which package you installed when you first saw a failure?


---

Comment by mderickx created at 2017-09-15 19:48:12

Ok I added a list of all the optional packages installed. I do not have a list of when I first saw a failure since this was obtained by first installing as many packages as possible and then running all the tests. An automated script for doctesting in between each install would be nice indeed. I'll try to see if I can set that up and run it only on the above files. I created this ticket as an overview so that we at least know what is wrong. I certainly plan on working on making it more refined.


---

Comment by fbissey created at 2017-09-15 20:50:19

Would you mind posting the details of at least one failure? Given the number of packages there may be multiple sources but you have to start somewhere.


---

Comment by fbissey created at 2017-09-15 20:55:43

There are multiple failures there that should be caused by gap_packages

```
sage -t --long --warn-long 46.3 src/sage/tests/gap_packages.py
sage -t --long --warn-long 46.3 src/sage/coding/guava.py
```

possibly a couple of others. I would have thought this particular package was well tested. I am wondering if there is a bad interaction with something else.

I would like to know the details of

```
sage -t --long --warn-long 46.3 src/sage/rings/integer.pyx
sage -t --long --warn-long 46.3 src/sage/ext/memory.pyx
```

that couple is suspicious in that it would imply gmp which you said you didn't install. I wonder if it was pulled by something else.


---

Comment by mderickx created at 2017-09-15 21:59:38

Hi Francios,

Thank you for pointing at gmp. I did have gmp installed in the same sage install, but then later did 

```
sage -i mpir
```

which removed gmp from the installed packages list returned by `installed_packages()`. Could this be the cause?


---

Comment by fbissey created at 2017-09-15 22:07:28

Could be something funny happening there. Typically gmp will lead to this

```
File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
Failed example:
    1 << (2^60)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:39280)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:39024)
        sig_on()
    RuntimeError: Aborted
```

and

```
File "/usr/lib64/python2.7/site-packages/sage/ext/memory.pyx", line 9, in sage.ext.memory
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory[0]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "sage/rings/integer.pyx", line 2067, in sage.rings.integer.Integer.__pow__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:14183)
        sig_on()
    RuntimeError: Aborted
```



---

Comment by mderickx created at 2017-09-15 22:42:06

I just did:


```
sage -f database_gap
sage -f gap_packages
```


and this fixed almost all of the failures. For some reason something went wrong with these two packages.


---

Comment by mderickx created at 2017-09-15 22:48:41

Replying to [comment:11 fbissey]:
> Could be something funny happening there. Typically gmp will lead to this
> {{{
> File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
> ...
>     RuntimeError: Aborted
> }}}
> 
> 
These two errors were exactly the two errors I got. So I guess that settles this. Is there a ticket for those?


---

Comment by fbissey created at 2017-09-15 22:51:36

Replying to [comment:14 mderickx]:
> Replying to [comment:11 fbissey]:
> > Could be something funny happening there. Typically gmp will lead to this
> > {{{
> > File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
> > ...
> >     RuntimeError: Aborted
> > }}}
> > 
> > 
> These two errors were exactly the two errors I got. So I guess that settles this. Is there a ticket for those?

Yes, possibly in a won't fix state though. These are differences in error messages between mpir and gmp. We are more or less living with them. They are well know of sage-on-distro people since we all use gmp for "reasons" (including sanity).


---

Comment by fbissey created at 2017-09-15 22:53:08

I am not shocked by the outcome of the gap stuff. Although I must say I wouldn't have known for a few of those. Now that you have a single test failing, can we have details?


---

Comment by mderickx created at 2017-09-15 23:03:45

Changing priority from blocker to major.


---

Comment by mderickx created at 2017-09-15 23:10:15

Replying to [comment:16 fbissey]:
> I am not shocked by the outcome of the gap stuff. Although I must say I wouldn't have known for a few of those. Now that you have a single test failing, can we have details?

Sorry the detail is gone by subsequent doctests. A lot of the messages were saying that I should install database_gap or gap_packages, which I already had installed. I want to try to make this entire build again from a clean sage install and see if I can reproduce the errors. This will take some time though.

In the meanwhile a lot of thanks for helping figuring all the errors out. This was a great help in reliably installing a lot of optional packages at the same time.


---

Comment by jdemeyer created at 2017-09-16 07:27:15

On my `sage4` patchbot, I also saw the whole bunch of failures that Maarten initially posted on this ticket. So there must be a real issue here. Since there are a lot of `MemoryError` in the failed tests, this is almost certainly due to #23748. So there must be some optional package which has high memory usage (possibly even if it's not actually used). This could very well be `gap_packages` but then I do not understand why reinstalling `gap_packages` would help.

My strategy is now to install those packages one by one and run a few selected doctests every time to see which package is responsible for which failures.


---

Comment by jdemeyer created at 2017-09-16 11:31:40

At least some of the failures are caused by `cbc`.


---

Comment by mderickx created at 2017-09-16 12:26:00

Is cbc failing as in #22006 or is it something else?


---

Comment by jdemeyer created at 2017-09-16 19:05:04

No, I don't mean #22006. I mean some of the failures that you originally posted in the ticket description (and which are not there anymore).


---

Comment by jdemeyer created at 2017-09-18 10:00:53

Replying to [ticket:23871 mderickx]:
> This leaves us with:
> {{{
> sage -t --long src/sage/ext/memory.pyx  # 1 doctest failed
> sage -t --long src/sage/rings/integer.pyx  # 1 doctest failed
> }}}
> which was caused by gmp being picked up.

Details please. What do you mean with "caused by gmp being picked up"? The Sage package `gmp` is not in your list of optional packages.


---

Comment by fbissey created at 2017-09-18 10:02:21

Replying to [comment:24 jdemeyer]:
> Replying to [ticket:23871 mderickx]:
> > This leaves us with:
> > {{{
> > sage -t --long src/sage/ext/memory.pyx  # 1 doctest failed
> > sage -t --long src/sage/rings/integer.pyx  # 1 doctest failed
> > }}}
> > which was caused by gmp being picked up.
> 
> Details please. What do you mean with "caused by gmp being picked up"? The Sage package `gmp` is not in your list of optional packages.

See #23871#comment:9


---

Comment by jdemeyer created at 2017-09-18 10:14:10

Replying to [comment:11 fbissey]:
> Could be something funny happening there. Typically gmp will lead to this
> {{{
> File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
> Failed example:
>     1 << (2^60)
> Expected:
>     Traceback (most recent call last):
>     ...
>     MemoryError: failed to allocate ... bytes   
> Got:
>     gmp: overflow in mpz type
>     Traceback (most recent call last):
>       File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
>         Integer(1) << (Integer(2)**Integer(60))
>       File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:39280)
>         return (<Integer>x)._shift_helper(y, 1)
>       File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:39024)
>         sig_on()
>     RuntimeError: Aborted
> }}}
> and
> {{{
> File "/usr/lib64/python2.7/site-packages/sage/ext/memory.pyx", line 9, in sage.ext.memory
> Failed example:
>     2<sup>(2</sup>63-2)
> Expected:
>     Traceback (most recent call last):
>     ...
>     MemoryError: failed to allocate 1152921504606847008 bytes  
> Got:
>     gmp: overflow in mpz type
>     Traceback (most recent call last):
>       File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.ext.memory[0]>", line 1, in <module>
>         Integer(2)**(Integer(2)**Integer(63)-Integer(2))
>       File "sage/rings/integer.pyx", line 2067, in sage.rings.integer.Integer.__pow__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:14183)
>         sig_on()
>     RuntimeError: Aborted
> }}}

I assume that this is with GMP 6 on Gentoo, right? Because Sage still ships GMP 5.1.3 (see #19706).


---

Comment by fbissey created at 2017-09-18 10:17:53

As far as I remember both `GMP` 5 and 6 will give you that message. While on the subject, the problem that stopped #19706 have now gone so we could finish it off.


---

Comment by jdemeyer created at 2017-10-05 10:36:44

#23713 should deal with `cbc` and `cryptominisat`


---

Comment by mderickx created at 2017-10-05 11:39:54

Thanks, I think this ticket can be closed as duplicate since the issues turned out to be flukes or are fixed by other tickets.


---

Comment by mderickx created at 2017-10-05 11:39:54

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-10-05 12:00:36

Changing status from needs_review to positive_review.


---

Comment by mderickx created at 2017-10-05 14:12:00

Resolution: duplicate


---

Comment by jdemeyer created at 2017-10-07 14:30:11

I believe that I have now created a blocker ticket for each of the issues that I could reproduce on a particular x86_64 Linux system.

I could not reproduce the issue with `gap_packages` and `database_gap`: I have no idea what went wrong there. Nor could I reproduce the issue with `pandoc`, but that's probably because `pandoc` is actually installed on the system where I tested it.


---

Comment by jdemeyer created at 2017-10-07 14:32:21

I should also add that I tested _all_ optional and pip packages except for `gmp`, `atlas` and `mpi4py`. So I included a few packages that you omitted.


---

Comment by mderickx created at 2017-10-07 18:16:21

Hi Jeroen thanks for putting so much energy in these optional packages,

I recreated the pandoc problem and created #23985 for this with a clear traceback and explanation of why it occurs. I think the `gap_packages` and `database_gap` errors can be regarded as a mistake in installing all these optional packages from my side, because I cannot reproduce it either on the machine where it went wrong.
