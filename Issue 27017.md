# Issue 27017: MP_LIBRARY, BLAS, PYTHON need inst_ in Makefile.in

archive/issues_027017.json:
```json
{
    "body": "CC:  @embray @jdemeyer\n\nIn particular to properly handle \"dummy\" targets like gmp/mpir,\nwe should do\n\n```diff\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)\n \n # Aliases for optional packages selected at configure time\n TOOLCHAIN = @SAGE_TOOLCHAIN@\n-PYTHON = python@SAGE_PYTHON_VERSION@\n-MP_LIBRARY = @SAGE_MP_LIBRARY@\n-BLAS = @SAGE_BLAS@\n+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)\n+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)\n+BLAS = $(inst_@SAGE_BLAS@)\n \n # Files to track installation of packages\n BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/27254\n\n",
    "created_at": "2019-02-11T09:01:00Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "MP_LIBRARY, BLAS, PYTHON need inst_ in Makefile.in",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27017",
    "user": "https://github.com/dimpase"
}
```
CC:  @embray @jdemeyer

In particular to properly handle "dummy" targets like gmp/mpir,
we should do

```diff
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)
 
 # Aliases for optional packages selected at configure time
 TOOLCHAIN = @SAGE_TOOLCHAIN@
-PYTHON = python@SAGE_PYTHON_VERSION@
-MP_LIBRARY = @SAGE_MP_LIBRARY@
-BLAS = @SAGE_BLAS@
+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)
+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)
+BLAS = $(inst_@SAGE_BLAS@)
 
 # Files to track installation of packages
 BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@
```

Issue created by migration from https://trac.sagemath.org/ticket/27254





---

archive/issue_comments_379893.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-11T09:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379893",
    "user": "https://github.com/dimpase"
}
```

New commits:



---

archive/issue_comments_379894.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-11T09:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379894",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379895.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-02-11T15:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379895",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_379896.json:
```json
{
    "body": "I'm actually not sure this is exactly right after all:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex eea7ceb..0bf0fcc 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)\n \n # Aliases for optional packages selected at configure time\n TOOLCHAIN = @SAGE_TOOLCHAIN@\n-PYTHON = python@SAGE_PYTHON_VERSION@\n-MP_LIBRARY = @SAGE_MP_LIBRARY@\n-BLAS = @SAGE_BLAS@\n+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)\n+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)\n+BLAS = $(inst_@SAGE_BLAS@)\n \n # Files to track installation of packages\n BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@\n```\n\nthe problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.  Similarly with these other variables.  I would actually leave these as is--not pointing to the `$(inst_<pkg>)` variables.  In fact, if you look at the generated Makefile in `build/make/Makefile`, you can see that where these variables are defined the `$(inst_<pkg>)` variables haven't even been defined yet.\n\nInstead, I would do like:\n\n```diff\ndiff --git a/build/make/deps b/build/make/deps\nindex e9008d2..f0a9c0b 100644\n--- a/build/make/deps\n+++ b/build/make/deps\n@@ -156,7 +156,7 @@ sagelib: \\\n                $(inst_mpc) \\\n                $(inst_mpfi) \\\n                $(inst_mpfr) \\\n-               $(MP_LIBRARY) \\\n+               $(inst_$(MP_LIBRARY)) \\\n                $(inst_ntl) \\\n                $(inst_numpy) \\\n                $(inst_pari) \\\n```\n\nThe problem is when this was just `$(MP_LIBRARY)` it expanded to something like:\n\n```\nsagelib: ... local/var/lib/sage/installed/mpfi-x.y.z ... mpir ... local/var/lib/sage/installed/ntl-x.y.z\n```\n\nand so on.  In other words, for `$(MP_LIBRARY)` you just get the package name which is just a phony target, and hence always built.  Whereas if you replace this with `$(inst_$(MP_LIBRARY))` it will expand to `$(inst_mpir)` and in turn to `local/var/lib/sage/installed/mpir-x.y.z` if installing the SPKG, or to just `.dummy` if not.",
    "created_at": "2019-02-11T15:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379896",
    "user": "https://github.com/embray"
}
```

I'm actually not sure this is exactly right after all:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index eea7ceb..0bf0fcc 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)
 
 # Aliases for optional packages selected at configure time
 TOOLCHAIN = @SAGE_TOOLCHAIN@
-PYTHON = python@SAGE_PYTHON_VERSION@
-MP_LIBRARY = @SAGE_MP_LIBRARY@
-BLAS = @SAGE_BLAS@
+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)
+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)
+BLAS = $(inst_@SAGE_BLAS@)
 
 # Files to track installation of packages
 BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@
```

the problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.  Similarly with these other variables.  I would actually leave these as is--not pointing to the `$(inst_<pkg>)` variables.  In fact, if you look at the generated Makefile in `build/make/Makefile`, you can see that where these variables are defined the `$(inst_<pkg>)` variables haven't even been defined yet.

Instead, I would do like:

```diff
diff --git a/build/make/deps b/build/make/deps
index e9008d2..f0a9c0b 100644
--- a/build/make/deps
+++ b/build/make/deps
@@ -156,7 +156,7 @@ sagelib: \
                $(inst_mpc) \
                $(inst_mpfi) \
                $(inst_mpfr) \
-               $(MP_LIBRARY) \
+               $(inst_$(MP_LIBRARY)) \
                $(inst_ntl) \
                $(inst_numpy) \
                $(inst_pari) \
```

The problem is when this was just `$(MP_LIBRARY)` it expanded to something like:

```
sagelib: ... local/var/lib/sage/installed/mpfi-x.y.z ... mpir ... local/var/lib/sage/installed/ntl-x.y.z
```

and so on.  In other words, for `$(MP_LIBRARY)` you just get the package name which is just a phony target, and hence always built.  Whereas if you replace this with `$(inst_$(MP_LIBRARY))` it will expand to `$(inst_mpir)` and in turn to `local/var/lib/sage/installed/mpir-x.y.z` if installing the SPKG, or to just `.dummy` if not.



---

archive/issue_comments_379897.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> the problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.\n\n\nMaybe that just means that we should have two of these variables: one for the Python executable and one for the dependency. Surely we'll need that anyway if we want to support system Python.",
    "created_at": "2019-02-11T16:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379897",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 embray]:
> the problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.


Maybe that just means that we should have two of these variables: one for the Python executable and one for the dependency. Surely we'll need that anyway if we want to support system Python.



---

archive/issue_comments_379898.json:
```json
{
    "body": "But I mean, even the package name is used as a variable alone.  For example, in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.  I suppose practically speaking that might still work, but it's still wildly inconsistent.",
    "created_at": "2019-02-11T16:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379898",
    "user": "https://github.com/embray"
}
```

But I mean, even the package name is used as a variable alone.  For example, in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.  I suppose practically speaking that might still work, but it's still wildly inconsistent.



---

archive/issue_comments_379899.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.\n\n\nBut that's just for convenience. We are actually textually replacing names like `pari` by `$(inst_pari)`. It should still work if you write the stamp file.",
    "created_at": "2019-02-11T17:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379899",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 embray]:
> in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.


But that's just for convenience. We are actually textually replacing names like `pari` by `$(inst_pari)`. It should still work if you write the stamp file.



---

archive/issue_comments_379900.json:
```json
{
    "body": "I agree, but I still think it's better to be consistent, and not change the current usage if it isn't necessary to.  If you look at my patch above you'll see that it's sufficient (when doing the same for BLAS, etc.) to solve the problem this ticket is trying to solve.",
    "created_at": "2019-02-11T17:07:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379900",
    "user": "https://github.com/embray"
}
```

I agree, but I still think it's better to be consistent, and not change the current usage if it isn't necessary to.  If you look at my patch above you'll see that it's sufficient (when doing the same for BLAS, etc.) to solve the problem this ticket is trying to solve.



---

archive/issue_comments_379901.json:
```json
{
    "body": "To put another way, traditionally these variables have been used to represent what package was selected at configure-time to satisfy some dependency that can be satisfied by multiple packages.  Having `BLAS=atlas` or `BLAS=openblas` is potentially useful information about what selection was made.  If you're using the system package in particular the stamp file will be `local/var/lib/sage/installed/.dummy`, so now you'll have `BLAS=local/var/lib/sage/installed/.dummy` which tells you nothing, and it is harder to reuse the information in that variable.",
    "created_at": "2019-02-11T17:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379901",
    "user": "https://github.com/embray"
}
```

To put another way, traditionally these variables have been used to represent what package was selected at configure-time to satisfy some dependency that can be satisfied by multiple packages.  Having `BLAS=atlas` or `BLAS=openblas` is potentially useful information about what selection was made.  If you're using the system package in particular the stamp file will be `local/var/lib/sage/installed/.dummy`, so now you'll have `BLAS=local/var/lib/sage/installed/.dummy` which tells you nothing, and it is harder to reuse the information in that variable.



---

archive/issue_comments_379902.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-11T18:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379902",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379903.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-02-11T18:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379903",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_379904.json:
```json
{
    "body": "Looks good.  I'm trying to build with this now--everything seems normal though.",
    "created_at": "2019-02-11T20:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379904",
    "user": "https://github.com/embray"
}
```

Looks good.  I'm trying to build with this now--everything seems normal though.



---

archive/issue_comments_379905.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-12T10:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379905",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379906.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-14T19:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27017#issuecomment-379906",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067643.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-14T19:45:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27017",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27017#event-67643"
}
```
