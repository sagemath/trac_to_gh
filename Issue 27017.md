# Issue 27017: MP_LIBRARY, BLAS, PYTHON need inst_ in Makefile.in

Issue created by migration from https://trac.sagemath.org/ticket/27254

Original creator: dimpase

Original creation time: 2019-02-11 09:01:00

CC:  embray jdemeyer

In particular to properly handle "dummy" targets like gmp/mpir,
we should do

```diff
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)
 
 # Aliases for optional packages selected at configure time
 TOOLCHAIN = @SAGE_TOOLCHAIN@
-PYTHON = python@SAGE_PYTHON_VERSION@
-MP_LIBRARY = @SAGE_MP_LIBRARY@
-BLAS = @SAGE_BLAS@
+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)
+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)
+BLAS = $(inst_@SAGE_BLAS@)
 
 # Files to track installation of packages
 BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@
```



---

Comment by dimpase created at 2019-02-11 09:49:59

New commits:


---

Comment by dimpase created at 2019-02-11 09:49:59

Changing status from new to needs_review.


---

Comment by embray created at 2019-02-11 15:59:05

Changing status from needs_review to needs_info.


---

Comment by embray created at 2019-02-11 15:59:05

I'm actually not sure this is exactly right after all:


```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index eea7ceb..0bf0fcc 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -31,9 +31,9 @@ INST = $(SAGE_SPKG_INST)
 
 # Aliases for optional packages selected at configure time
 TOOLCHAIN = @SAGE_TOOLCHAIN@
-PYTHON = python@SAGE_PYTHON_VERSION@
-MP_LIBRARY = @SAGE_MP_LIBRARY@
-BLAS = @SAGE_BLAS@
+PYTHON = $(inst_python@SAGE_PYTHON_VERSION@)
+MP_LIBRARY = $(inst_@SAGE_MP_LIBRARY@)
+BLAS = $(inst_@SAGE_BLAS@)
 
 # Files to track installation of packages
 BUILT_PACKAGES = @SAGE_BUILT_PACKAGES@
```


the problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.  Similarly with these other variables.  I would actually leave these as is--not pointing to the `$(inst_<pkg>)` variables.  In fact, if you look at the generated Makefile in `build/make/Makefile`, you can see that where these variables are defined the `$(inst_<pkg>)` variables haven't even been defined yet.

Instead, I would do like:


```diff
diff --git a/build/make/deps b/build/make/deps
index e9008d2..f0a9c0b 100644
--- a/build/make/deps
+++ b/build/make/deps
@@ -156,7 +156,7 @@ sagelib: \
                $(inst_mpc) \
                $(inst_mpfi) \
                $(inst_mpfr) \
-               $(MP_LIBRARY) \
+               $(inst_$(MP_LIBRARY)) \
                $(inst_ntl) \
                $(inst_numpy) \
                $(inst_pari) \
```


The problem is when this was just `$(MP_LIBRARY)` it expanded to something like:


```
sagelib: ... local/var/lib/sage/installed/mpfi-x.y.z ... mpir ... local/var/lib/sage/installed/ntl-x.y.z
```


and so on.  In other words, for `$(MP_LIBRARY)` you just get the package name which is just a phony target, and hence always built.  Whereas if you replace this with `$(inst_$(MP_LIBRARY))` it will expand to `$(inst_mpir)` and in turn to `local/var/lib/sage/installed/mpir-x.y.z` if installing the SPKG, or to just `.dummy` if not.


---

Comment by jdemeyer created at 2019-02-11 16:28:15

Replying to [comment:3 embray]:
> the problem is that there are some places, for example, that expect the `$(PYTHON)` variable to be either one of the simple strings `python2` or `python3`.

Maybe that just means that we should have two of these variables: one for the Python executable and one for the dependency. Surely we'll need that anyway if we want to support system Python.


---

Comment by embray created at 2019-02-11 16:58:14

But I mean, even the package name is used as a variable alone.  For example, in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.  I suppose practically speaking that might still work, but it's still wildly inconsistent.


---

Comment by jdemeyer created at 2019-02-11 17:02:38

Replying to [comment:5 embray]:
> in `dependencies` files I've formatted those so it's just the package name, not the path to the stamp file for that package.

But that's just for convenience. We are actually textually replacing names like `pari` by `$(inst_pari)`. It should still work if you write the stamp file.


---

Comment by embray created at 2019-02-11 17:07:43

I agree, but I still think it's better to be consistent, and not change the current usage if it isn't necessary to.  If you look at my patch above you'll see that it's sufficient (when doing the same for BLAS, etc.) to solve the problem this ticket is trying to solve.


---

Comment by embray created at 2019-02-11 17:23:29

To put another way, traditionally these variables have been used to represent what package was selected at configure-time to satisfy some dependency that can be satisfied by multiple packages.  Having `BLAS=atlas` or `BLAS=openblas` is potentially useful information about what selection was made.  If you're using the system package in particular the stamp file will be `local/var/lib/sage/installed/.dummy`, so now you'll have `BLAS=local/var/lib/sage/installed/.dummy` which tells you nothing, and it is harder to reuse the information in that variable.


---

Comment by git created at 2019-02-11 18:17:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-02-11 18:21:13

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-02-11 20:12:10

Looks good.  I'm trying to build with this now--everything seems normal though.


---

Comment by embray created at 2019-02-12 10:21:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-14 19:45:27

Resolution: fixed
