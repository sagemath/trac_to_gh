# Issue 27721: enhance the integration by using also giac and sympy

Issue created by migration from https://trac.sagemath.org/ticket/27958

Original creator: chapoton

Original creation time: 2019-06-09 07:22:08

CC:  @mwageringel jakobkroeker kcrisman pbruin rws slabbe slelievre tmonteil vdelecroix vklein zimmerma mforets mmezzarobba




---

Comment by chapoton created at 2019-06-09 07:22:40

New commits:


---

Comment by chapoton created at 2019-06-09 07:22:40

Changing status from new to needs_review.


---

Comment by git created at 2019-06-09 08:17:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-09 08:38:34

Changing keywords from "" to "integration".


---

Comment by chapoton created at 2019-06-09 08:43:19

sometimes sympy takes ages, so that's why it comes last:

```
sage: integrate(sqrt(1-m*sin(x)^2),x,algorithm='sympy')
... hangs ...
```



---

Comment by chapoton created at 2019-06-09 09:42:31

some failing doctests, work in progress


---

Comment by chapoton created at 2019-06-09 09:42:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-06-09 11:06:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-09 11:31:12

This seems to work well enough. Waiting for the patchbots' green lights.


---

Comment by tmonteil created at 2019-06-09 12:11:16

Having more integration algorithms tried by default is a very good move. However, doctests should get more analyzed:

This part of the patch looks weird:


```
-can do, but Sage currently can't do::
+can do, but Sage currently cannot do::
 
-    sage: integrate(log(x)*exp(-x^2), x)        # todo -- Mathematica can do this
-    integrate(e^(-x^2)*log(x), x)
+    sage: integrate(log(x)*exp(-x^2), x)
+    1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
```


Even if Sage is not able to perform the nice simplifications, this _looks_ pretty correct (though i am not analyst):


```
sage: f = 1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
sage: g =  f.derivative(x)
sage: h = g - log(x)*exp(-x^2)
sage: h.full_simplify()
1/18*(4*x^3*hypergeometric((3/2, 3/2), (5/2, 5/2), -x^2) - 18*x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2) + 9*sqrt(pi)*erf(x))/x
sage: h.plot(x,0,1)
```


That function looks like the zero function ?


---

Comment by tmonteil created at 2019-06-09 12:13:52

Actually, mathematica gives a very similar result : https://www.wolframalpha.com/input/?i=integrate+log(x)*exp(-x%5E2)


---

Comment by git created at 2019-06-09 12:16:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-09 12:16:57

thx, I have modified this part of the doc


---

Comment by tmonteil created at 2019-06-09 12:35:31

Also, in 


```
+Todo, Mathematica can do this and gets `\pi^2/15`::
 
     sage: integrate(log(1+sqrt(1+4*x)/2)/x, x, 0, 1)
     Traceback (most recent call last):
     ...
     ValueError: Integral is divergent.
```


Well, the integral //is// divergent, as the function behaves like `log(3/2)/x` around zero. And i bet mathematica never returned `pi^2/15`, maybe the original example was modified along the time without noticing.


---

Comment by tmonteil created at 2019-06-09 13:35:32

Some other remarks:

- when you write that Sage can "now" compute some integral, it might be good to refer to `:trac:`27958`` so that interested people could see how and where the issue was fixed.
- when you add some conversions dict that are not indirectly tested with the examples, it might be good to doctest them explicitely (i am thinking in particular to the `sign` conversion for fricas, but maybe there are other that you added without the need to let the new example work, but only you can track those without effort).
- why not also adding `fricas` to the tried integrators ? Though it is optional, it could be nice to have it implicitely used when the user has it installed. This may be part of another ticket though.


---

Comment by tmonteil created at 2019-06-09 13:44:48

Let me CC `@`zimmerma since some doctests in the Sage book are modified, so that perhaps the example of `exp(âˆ’x^2 )*ln(x)` might not be good anymore to illustrate numerical integration as a fallback.


---

Comment by git created at 2019-06-09 14:04:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-09 14:05:58

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-06-09 14:05:58

Thx, I have made the suggested changes.

Let us keep the possibility of also adding the fricas integrator for another ticket.


---

Comment by chapoton created at 2019-06-10 18:12:05

full green bot, please review


---

Comment by kcrisman created at 2019-06-10 18:17:17

Any timing information?  I'd be really concerned about stuff slowing down by trying these additional integrators if there was significant overhead somewhere we didn't know about.


---

Comment by mforets created at 2019-06-10 18:34:24

+1 for this PR.

> I'd be really concerned about stuff slowing down by trying these additional integrators

Since it still uses `maxima` as its first try, the time will get worse only in those cases were Sage was returning an error or an unevaluated integral (both results are useless, i would say, so one shouldn't care).


---

Comment by chapoton created at 2019-06-10 19:52:52

as I said in comment:5, sometimes sympy seems to hang forever. Here is one case :

```
sage: %time integrate(sqrt(1-3*sin(x)^2),x)
CPU times: user 252 ms, sys: 3.93 ms, total: 256 ms
Wall time: 274 ms
integrate(sqrt(-3*sin(x)^2 + 1), x)
sage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='giac')
CPU times: user 2.85 ms, sys: 3.85 ms, total: 6.7 ms
Wall time: 85.3 ms
integrate(sqrt(-3*sin(x)^2 + 1), x)
sage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='sympy')
NOTHING HAPPENS...
```

So this behaviour is now inherited by our integration.

One can hope that the users will CTRL-C. Or use a time-out ??

It seems to me that this is a reasonable prize to pay for having more success, in particular with integrals contaiing abs(), now that we have disabled maxima's `abs_integrate`.

**EDIT**:

in this case, sympy succeeds after not so long!!

```
sage: %time integrate(sqrt(1-3*sin(x)^2),x)
CPU times: user 1min 47s, sys: 346 ms, total: 1min 47s
Wall time: 1min 50s
elliptic_e(x, 3)
```



---

Comment by kcrisman created at 2019-06-10 20:18:58

I'd be careful, because not every user perhaps knows about Ctrl-C, especially in a notebook/worksheet situation.  But of course if we get a significantly higher proportion of integrals it is good.  I just wanted to raise this.


---

Comment by git created at 2019-06-11 13:21:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-11 13:22:07

squashed branch, with more doctests showing the new capacities


---

Comment by chapoton created at 2019-06-11 15:55:22

and the bot is still fully green.

Note that sometimes it is giac, rather than sympy, that hangs, for example in

```
integrate(sqrt(x + sqrt(x)), x)
```


**EDIT**
In giac itself, `integrate(sqrt(x + sqrt(x)),x);` returns an error quickly.

**EDIT**
Does not hang in Python2, only in Python3 !!!

**EDIT**: Apparently, in sage+py3, the giac interface cannot recover from a crash of Giac..

```
giac('int(sqrt(x+sqrt(x)),x)')
Giac crashed -- automatically restarting.
HANGS..
```



---

Comment by slelievre created at 2019-06-12 12:19:52

Replying to [comment:25 chapoton]:
> [sometimes giac hangs, for example in]
> {{{
> integrate(sqrt(x + sqrt(x)), x)
> }}}

Bernard Parisse made a workaround commit:

- https://dev.geogebra.org/trac/changeset/68668/

and Giac can now evaluate this integral to:

```
2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(abs(2*(sqrt(x+sqrt(x))-sqrt(x))-1)))
```



---

Comment by chapoton created at 2019-06-16 19:54:27

So, any comment or review, somebody ?


---

Comment by chapoton created at 2019-06-25 14:53:09

Anybody out there ? Does somebody care ?


---

Comment by vdelecroix created at 2019-06-25 19:16:35

What happend here

```
   sage: N(integrate(exp(-x^2)*log(x), x, 17, 42))  # rel tol 2e-12
-  2.5657285006962035e-127
+  -8.88178419700125e-16
```



---

Comment by vdelecroix created at 2019-06-25 19:18:32

More precisely: I don't understand the doctest. The answer is indeed close to `2.5657285006962035e-127` but then it makes no sense to have an error tolerance of `e-12`.


---

Comment by vdelecroix created at 2019-06-25 19:23:47

Actually, I believe more

```
sage: ComplexBallField(512).integral(lambda x,_: (-x*x).exp()*x.log(), 17, 42)
[2.565728500561051482917356396130478590014770955402032663e-127 +/- 8.94e-182]
```

(which is close to what provide `gsl` and the initial doctest) rather than

```
sage: f = integral(exp(-x^2)*log(x), (x,17,42), algorithm='sympy')
sage: RealBallField(512)(f)
[1.5577642856694726097777e-130 +/- 4.52e-153]
```

Is the formula provided by sympy even correct?


---

Comment by vdelecroix created at 2019-06-25 19:24:53

Or the symbolic ring does something completely stupid to evaluate hypergeometric functions with real ball input?


---

Comment by vdelecroix created at 2019-06-25 19:37:42

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2019-06-25 19:45:58

According to Mathematica it is correct... also confirmed by this smaller range computation

```
sage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')
sage: RBF(f.subs(x=2)) - RBF(f.subs(x=1))
[0.032612042358609 +/- 8.42e-16]
sage: CBF.integral(lambda x,_: (-x*x).exp()*x.log(), 1, 2)
[0.032612042358610 +/- 5.89e-16]
```


The conversion to ball fields appear to be wrong also for much smaller values

```
sage: prec = 256 
sage: R = RealBallField(prec)
sage: C = ComplexBallField(prec)
sage: a = 5; b = 6
sage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)
[2.218662695682179212714334629004026381551686783767107654124923915615978e-12 +/- 6.31e-82]
sage: R(f.subs(x=b)) - R(f.subs(x=a))
[2.218664132884571616593899629338237856352627658842503518158550169e-12 +/- 2.32e-76]
```

The two values start to differ from the 7th digit.


---

Comment by vdelecroix created at 2019-06-25 19:49:18

Conclusion: change the doctest to something more relevant such as

```
sage: integrate(exp(-x^2)*log(x), x)
1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
```

Though this takes 10 secs!!!

Also taking the numerical approximation of a symbolic integral is the last thing you want to do to evaluate numerically an integral. We should not tell users to do that.


---

Comment by chapoton created at 2019-06-26 07:23:34

Anyway, these doctests do no longer make any sense in the context of the book, because sage is now able to integrate symbolically this expression. In the book, this is given as an example where symbolic integration fails..

I would rather remove them from our testsuite..


---

Comment by kcrisman created at 2019-06-26 11:29:00

> I would rather remove them from our test suite..

But didn't they still want a failing doctest somehow, or is this okay by their point of view?  (There are so many authors, maybe you are one of them and can speak to that.)  It would be good to somewhere have a failing integral, because that tests whether that branch of the code (i.e. the one that says what to do if everything still doesn't work) is not inadvertently no longer working.  That said, I haven't been too aggressive on this ticket so I'll let all of you decide on this.


---

Comment by chapoton created at 2019-06-26 11:57:23

As a still failing integral, one could use then

```
integral(cos(ln(cos(x))),x,0,pi/2)
```

which cannot be done by maxima, giac, sympy or fricas.


---

Comment by mmezzarobba created at 2019-06-26 19:23:05

As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?


---

Comment by zimmerma created at 2019-06-27 15:12:51

Replying to [comment:39 mmezzarobba]:
> As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?

since it was decided in ticket #27958, comment [comment:58] (while the book was already in print by SIAM), not to accept doctests that do not pass in Python3 (while the book was publicly available since a long time, and nobody asked before for the doctests to be compatible with Python 3), the doctests in Sage do no longer correspond to those in the book, and I have decided not to spend any more time on this.

In summary: do whatever you want, those doctests are no more relevant for the french book.


---

Comment by vdelecroix created at 2019-06-28 05:27:43

Replying to [comment:40 zimmerma]:
> Replying to [comment:39 mmezzarobba]:
> > As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?
> 
> [...] in ticket #27958, comment [comment:58] [...]

There is no comment number 58 on ticket #27958!


---

Comment by zimmerma created at 2019-06-28 05:46:20

sorry that was ticket #23572


---

Comment by vdelecroix created at 2019-06-28 06:12:05

Replying to [comment:42 zimmerma]:
> sorry that was ticket #23572

I did not know about what happend with this ticket. It is indeed unfortunate... the switch to Python 3 is a long and painful route.

But the matter under discussion here is of different nature.  The single test under discussion is

```
N(integrate(exp(-x^2)*log(x), x, 17, 42))
```

There is a positive change of behavior since Sage will now symbolically integrate `exp(-x^2)*log(x)`. As the doctest was used to illustrate the fact that numerical integration was possible on unevaluated integrals it would not make sense anymore. It is rather the book that has to be adapted here (contrarily to #23572 where the doctest framework should have been adapted).

Isn't there a document that explains what has changed between the available version of the book and the current Sage version? I think this would be very useful.


---

Comment by git created at 2019-06-28 09:51:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-28 09:52:33

Here is a proposal that keeps the spirit of the modified books' doctests.


---

Comment by chapoton created at 2019-06-28 11:34:26

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by tmonteil created at 2019-07-09 13:34:52

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2019-07-09 13:34:52

Regarding builtins, instead of testing that a string is produced:


```
sage: log_integral(x)._fricas_init_()
'li(x)'
```


You could (optionally) test that fricas actually handles the function: 


```
sage: log_integral(x)._fricas_()      # optional - fricas
li(x)
```


as you did for giac.


---

Comment by chapoton created at 2019-07-09 13:43:56

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-07-09 13:43:56

Well, I prefer the first test, because Fricas is optional.

**edit**

I could change that if you insist, but this is really not the core of the matter.


---

Comment by tmonteil created at 2019-07-19 05:33:00

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2019-07-19 05:35:30

The thing is that this test does not test anything, you could change with any string not representing a `fricas` function, it will work as well.

Anyway, i see that there are other similar `fricas` functions that are not tested, so let us postpone that for a dedicated ticket.


---

Comment by vbraun created at 2019-07-20 09:10:52

Resolution: fixed


---

Comment by egourgoulhon created at 2020-01-07 10:56:45

See #28964 for a possible follow up.
