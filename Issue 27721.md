# Issue 27721: enhance the integration by using also giac and sympy

archive/issues_027721.json:
```json
{
    "body": "CC:  @mwageringel jakobkroeker kcrisman pbruin rws slabbe slelievre tmonteil vdelecroix vklein zimmerma mforets mmezzarobba\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27958\n\n",
    "created_at": "2019-06-09T07:22:08Z",
    "labels": [
        "symbolics",
        "major",
        "enhancement"
    ],
    "title": "enhance the integration by using also giac and sympy",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27721",
    "user": "chapoton"
}
```
CC:  @mwageringel jakobkroeker kcrisman pbruin rws slabbe slelievre tmonteil vdelecroix vklein zimmerma mforets mmezzarobba



Issue created by migration from https://trac.sagemath.org/ticket/27958





---

archive/issue_comments_391554.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-06-09T07:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391554",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_391555.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-09T07:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391555",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391556.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-09T08:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391556",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391557.json:
```json
{
    "body": "Changing keywords from \"\" to \"integration\".",
    "created_at": "2019-06-09T08:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391557",
    "user": "chapoton"
}
```

Changing keywords from "" to "integration".



---

archive/issue_comments_391558.json:
```json
{
    "body": "sometimes sympy takes ages, so that's why it comes last:\n\n```\nsage: integrate(sqrt(1-m*sin(x)^2),x,algorithm='sympy')\n... hangs ...\n```\n",
    "created_at": "2019-06-09T08:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391558",
    "user": "chapoton"
}
```

sometimes sympy takes ages, so that's why it comes last:

```
sage: integrate(sqrt(1-m*sin(x)^2),x,algorithm='sympy')
... hangs ...
```




---

archive/issue_comments_391559.json:
```json
{
    "body": "some failing doctests, work in progress",
    "created_at": "2019-06-09T09:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391559",
    "user": "chapoton"
}
```

some failing doctests, work in progress



---

archive/issue_comments_391560.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-09T09:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391560",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_391561.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-09T11:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391561",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391562.json:
```json
{
    "body": "This seems to work well enough. Waiting for the patchbots' green lights.",
    "created_at": "2019-06-09T11:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391562",
    "user": "chapoton"
}
```

This seems to work well enough. Waiting for the patchbots' green lights.



---

archive/issue_comments_391563.json:
```json
{
    "body": "Having more integration algorithms tried by default is a very good move. However, doctests should get more analyzed:\n\nThis part of the patch looks weird:\n\n\n```\n-can do, but Sage currently can't do::\n+can do, but Sage currently cannot do::\n \n-    sage: integrate(log(x)*exp(-x^2), x)        # todo -- Mathematica can do this\n-    integrate(e^(-x^2)*log(x), x)\n+    sage: integrate(log(x)*exp(-x^2), x)\n+    1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)\n```\n\n\nEven if Sage is not able to perform the nice simplifications, this *looks* pretty correct (though i am not analyst):\n\n\n```\nsage: f = 1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)\nsage: g =  f.derivative(x)\nsage: h = g - log(x)*exp(-x^2)\nsage: h.full_simplify()\n1/18*(4*x^3*hypergeometric((3/2, 3/2), (5/2, 5/2), -x^2) - 18*x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2) + 9*sqrt(pi)*erf(x))/x\nsage: h.plot(x,0,1)\n```\n\n\nThat function looks like the zero function ?",
    "created_at": "2019-06-09T12:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391563",
    "user": "tmonteil"
}
```

Having more integration algorithms tried by default is a very good move. However, doctests should get more analyzed:

This part of the patch looks weird:


```
-can do, but Sage currently can't do::
+can do, but Sage currently cannot do::
 
-    sage: integrate(log(x)*exp(-x^2), x)        # todo -- Mathematica can do this
-    integrate(e^(-x^2)*log(x), x)
+    sage: integrate(log(x)*exp(-x^2), x)
+    1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
```


Even if Sage is not able to perform the nice simplifications, this *looks* pretty correct (though i am not analyst):


```
sage: f = 1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
sage: g =  f.derivative(x)
sage: h = g - log(x)*exp(-x^2)
sage: h.full_simplify()
1/18*(4*x^3*hypergeometric((3/2, 3/2), (5/2, 5/2), -x^2) - 18*x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2) + 9*sqrt(pi)*erf(x))/x
sage: h.plot(x,0,1)
```


That function looks like the zero function ?



---

archive/issue_comments_391564.json:
```json
{
    "body": "Actually, mathematica gives a very similar result : https://www.wolframalpha.com/input/?i=integrate+log(x)*exp(-x%5E2)",
    "created_at": "2019-06-09T12:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391564",
    "user": "tmonteil"
}
```

Actually, mathematica gives a very similar result : https://www.wolframalpha.com/input/?i=integrate+log(x)*exp(-x%5E2)



---

archive/issue_comments_391565.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-09T12:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391565",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391566.json:
```json
{
    "body": "thx, I have modified this part of the doc",
    "created_at": "2019-06-09T12:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391566",
    "user": "chapoton"
}
```

thx, I have modified this part of the doc



---

archive/issue_comments_391567.json:
```json
{
    "body": "Also, in \n\n\n```\n+Todo, Mathematica can do this and gets `\\pi^2/15`::\n \n     sage: integrate(log(1+sqrt(1+4*x)/2)/x, x, 0, 1)\n     Traceback (most recent call last):\n     ...\n     ValueError: Integral is divergent.\n```\n\n\nWell, the integral //is// divergent, as the function behaves like `log(3/2)/x` around zero. And i bet mathematica never returned `pi^2/15`, maybe the original example was modified along the time without noticing.",
    "created_at": "2019-06-09T12:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391567",
    "user": "tmonteil"
}
```

Also, in 


```
+Todo, Mathematica can do this and gets `\pi^2/15`::
 
     sage: integrate(log(1+sqrt(1+4*x)/2)/x, x, 0, 1)
     Traceback (most recent call last):
     ...
     ValueError: Integral is divergent.
```


Well, the integral //is// divergent, as the function behaves like `log(3/2)/x` around zero. And i bet mathematica never returned `pi^2/15`, maybe the original example was modified along the time without noticing.



---

archive/issue_comments_391568.json:
```json
{
    "body": "Some other remarks:\n\n- when you write that Sage can \"now\" compute some integral, it might be good to refer to `:trac:`27958`` so that interested people could see how and where the issue was fixed.\n- when you add some conversions dict that are not indirectly tested with the examples, it might be good to doctest them explicitely (i am thinking in particular to the `sign` conversion for fricas, but maybe there are other that you added without the need to let the new example work, but only you can track those without effort).\n- why not also adding `fricas` to the tried integrators ? Though it is optional, it could be nice to have it implicitely used when the user has it installed. This may be part of another ticket though.",
    "created_at": "2019-06-09T13:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391568",
    "user": "tmonteil"
}
```

Some other remarks:

- when you write that Sage can "now" compute some integral, it might be good to refer to `:trac:`27958`` so that interested people could see how and where the issue was fixed.
- when you add some conversions dict that are not indirectly tested with the examples, it might be good to doctest them explicitely (i am thinking in particular to the `sign` conversion for fricas, but maybe there are other that you added without the need to let the new example work, but only you can track those without effort).
- why not also adding `fricas` to the tried integrators ? Though it is optional, it could be nice to have it implicitely used when the user has it installed. This may be part of another ticket though.



---

archive/issue_comments_391569.json:
```json
{
    "body": "Let me CC `@`zimmerma since some doctests in the Sage book are modified, so that perhaps the example of `exp(\u2212x^2 )*ln(x)` might not be good anymore to illustrate numerical integration as a fallback.",
    "created_at": "2019-06-09T13:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391569",
    "user": "tmonteil"
}
```

Let me CC `@`zimmerma since some doctests in the Sage book are modified, so that perhaps the example of `exp(−x^2 )*ln(x)` might not be good anymore to illustrate numerical integration as a fallback.



---

archive/issue_comments_391570.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-09T14:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391570",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391571.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-06-09T14:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391571",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_391572.json:
```json
{
    "body": "Thx, I have made the suggested changes.\n\nLet us keep the possibility of also adding the fricas integrator for another ticket.",
    "created_at": "2019-06-09T14:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391572",
    "user": "chapoton"
}
```

Thx, I have made the suggested changes.

Let us keep the possibility of also adding the fricas integrator for another ticket.



---

archive/issue_comments_391573.json:
```json
{
    "body": "full green bot, please review",
    "created_at": "2019-06-10T18:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391573",
    "user": "chapoton"
}
```

full green bot, please review



---

archive/issue_comments_391574.json:
```json
{
    "body": "Any timing information?  I'd be really concerned about stuff slowing down by trying these additional integrators if there was significant overhead somewhere we didn't know about.",
    "created_at": "2019-06-10T18:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391574",
    "user": "kcrisman"
}
```

Any timing information?  I'd be really concerned about stuff slowing down by trying these additional integrators if there was significant overhead somewhere we didn't know about.



---

archive/issue_comments_391575.json:
```json
{
    "body": "+1 for this PR.\n\n> I'd be really concerned about stuff slowing down by trying these additional integrators\n\nSince it still uses `maxima` as its first try, the time will get worse only in those cases were Sage was returning an error or an unevaluated integral (both results are useless, i would say, so one shouldn't care).",
    "created_at": "2019-06-10T18:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391575",
    "user": "mforets"
}
```

+1 for this PR.

> I'd be really concerned about stuff slowing down by trying these additional integrators

Since it still uses `maxima` as its first try, the time will get worse only in those cases were Sage was returning an error or an unevaluated integral (both results are useless, i would say, so one shouldn't care).



---

archive/issue_comments_391576.json:
```json
{
    "body": "as I said in comment:5, sometimes sympy seems to hang forever. Here is one case :\n\n```\nsage: %time integrate(sqrt(1-3*sin(x)^2),x)\nCPU times: user 252 ms, sys: 3.93 ms, total: 256 ms\nWall time: 274 ms\nintegrate(sqrt(-3*sin(x)^2 + 1), x)\nsage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='giac')\nCPU times: user 2.85 ms, sys: 3.85 ms, total: 6.7 ms\nWall time: 85.3 ms\nintegrate(sqrt(-3*sin(x)^2 + 1), x)\nsage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='sympy')\nNOTHING HAPPENS...\n```\n\nSo this behaviour is now inherited by our integration.\n\nOne can hope that the users will CTRL-C. Or use a time-out ??\n\nIt seems to me that this is a reasonable prize to pay for having more success, in particular with integrals contaiing abs(), now that we have disabled maxima's `abs_integrate`.\n\n**EDIT**:\n\nin this case, sympy succeeds after not so long!!\n\n```\nsage: %time integrate(sqrt(1-3*sin(x)^2),x)\nCPU times: user 1min 47s, sys: 346 ms, total: 1min 47s\nWall time: 1min 50s\nelliptic_e(x, 3)\n```\n",
    "created_at": "2019-06-10T19:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391576",
    "user": "chapoton"
}
```

as I said in comment:5, sometimes sympy seems to hang forever. Here is one case :

```
sage: %time integrate(sqrt(1-3*sin(x)^2),x)
CPU times: user 252 ms, sys: 3.93 ms, total: 256 ms
Wall time: 274 ms
integrate(sqrt(-3*sin(x)^2 + 1), x)
sage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='giac')
CPU times: user 2.85 ms, sys: 3.85 ms, total: 6.7 ms
Wall time: 85.3 ms
integrate(sqrt(-3*sin(x)^2 + 1), x)
sage: %time integrate(sqrt(1-3*sin(x)^2),x,algorithm='sympy')
NOTHING HAPPENS...
```

So this behaviour is now inherited by our integration.

One can hope that the users will CTRL-C. Or use a time-out ??

It seems to me that this is a reasonable prize to pay for having more success, in particular with integrals contaiing abs(), now that we have disabled maxima's `abs_integrate`.

**EDIT**:

in this case, sympy succeeds after not so long!!

```
sage: %time integrate(sqrt(1-3*sin(x)^2),x)
CPU times: user 1min 47s, sys: 346 ms, total: 1min 47s
Wall time: 1min 50s
elliptic_e(x, 3)
```




---

archive/issue_comments_391577.json:
```json
{
    "body": "I'd be careful, because not every user perhaps knows about Ctrl-C, especially in a notebook/worksheet situation.  But of course if we get a significantly higher proportion of integrals it is good.  I just wanted to raise this.",
    "created_at": "2019-06-10T20:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391577",
    "user": "kcrisman"
}
```

I'd be careful, because not every user perhaps knows about Ctrl-C, especially in a notebook/worksheet situation.  But of course if we get a significantly higher proportion of integrals it is good.  I just wanted to raise this.



---

archive/issue_comments_391578.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-11T13:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391578",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391579.json:
```json
{
    "body": "squashed branch, with more doctests showing the new capacities",
    "created_at": "2019-06-11T13:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391579",
    "user": "chapoton"
}
```

squashed branch, with more doctests showing the new capacities



---

archive/issue_comments_391580.json:
```json
{
    "body": "and the bot is still fully green.\n\nNote that sometimes it is giac, rather than sympy, that hangs, for example in\n\n```\nintegrate(sqrt(x + sqrt(x)), x)\n```\n\n\n**EDIT**\nIn giac itself, `integrate(sqrt(x + sqrt(x)),x);` returns an error quickly.\n\n**EDIT**\nDoes not hang in Python2, only in Python3 !!!\n\n**EDIT**: Apparently, in sage+py3, the giac interface cannot recover from a crash of Giac..\n\n```\ngiac('int(sqrt(x+sqrt(x)),x)')\nGiac crashed -- automatically restarting.\nHANGS..\n```\n",
    "created_at": "2019-06-11T15:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391580",
    "user": "chapoton"
}
```

and the bot is still fully green.

Note that sometimes it is giac, rather than sympy, that hangs, for example in

```
integrate(sqrt(x + sqrt(x)), x)
```


**EDIT**
In giac itself, `integrate(sqrt(x + sqrt(x)),x);` returns an error quickly.

**EDIT**
Does not hang in Python2, only in Python3 !!!

**EDIT**: Apparently, in sage+py3, the giac interface cannot recover from a crash of Giac..

```
giac('int(sqrt(x+sqrt(x)),x)')
Giac crashed -- automatically restarting.
HANGS..
```




---

archive/issue_comments_391581.json:
```json
{
    "body": "Replying to [comment:25 chapoton]:\n> [sometimes giac hangs, for example in]\n> {{{\n> integrate(sqrt(x + sqrt(x)), x)\n> }}}\n\nBernard Parisse made a workaround commit:\n\n- https://dev.geogebra.org/trac/changeset/68668/\n\nand Giac can now evaluate this integral to:\n\n```\n2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(abs(2*(sqrt(x+sqrt(x))-sqrt(x))-1)))\n```\n",
    "created_at": "2019-06-12T12:19:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391581",
    "user": "slelievre"
}
```

Replying to [comment:25 chapoton]:
> [sometimes giac hangs, for example in]
> {{{
> integrate(sqrt(x + sqrt(x)), x)
> }}}

Bernard Parisse made a workaround commit:

- https://dev.geogebra.org/trac/changeset/68668/

and Giac can now evaluate this integral to:

```
2*(2*((1/6*sqrt(x)+1/24)*sqrt(x)-1/16)*sqrt(x+sqrt(x))-1/16*ln(abs(2*(sqrt(x+sqrt(x))-sqrt(x))-1)))
```




---

archive/issue_comments_391582.json:
```json
{
    "body": "So, any comment or review, somebody ?",
    "created_at": "2019-06-16T19:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391582",
    "user": "chapoton"
}
```

So, any comment or review, somebody ?



---

archive/issue_comments_391583.json:
```json
{
    "body": "Anybody out there ? Does somebody care ?",
    "created_at": "2019-06-25T14:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391583",
    "user": "chapoton"
}
```

Anybody out there ? Does somebody care ?



---

archive/issue_comments_391584.json:
```json
{
    "body": "What happend here\n\n```\n   sage: N(integrate(exp(-x^2)*log(x), x, 17, 42))  # rel tol 2e-12\n-  2.5657285006962035e-127\n+  -8.88178419700125e-16\n```\n",
    "created_at": "2019-06-25T19:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391584",
    "user": "vdelecroix"
}
```

What happend here

```
   sage: N(integrate(exp(-x^2)*log(x), x, 17, 42))  # rel tol 2e-12
-  2.5657285006962035e-127
+  -8.88178419700125e-16
```




---

archive/issue_comments_391585.json:
```json
{
    "body": "More precisely: I don't understand the doctest. The answer is indeed close to `2.5657285006962035e-127` but then it makes no sense to have an error tolerance of `e-12`.",
    "created_at": "2019-06-25T19:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391585",
    "user": "vdelecroix"
}
```

More precisely: I don't understand the doctest. The answer is indeed close to `2.5657285006962035e-127` but then it makes no sense to have an error tolerance of `e-12`.



---

archive/issue_comments_391586.json:
```json
{
    "body": "Actually, I believe more\n\n```\nsage: ComplexBallField(512).integral(lambda x,_: (-x*x).exp()*x.log(), 17, 42)\n[2.565728500561051482917356396130478590014770955402032663e-127 +/- 8.94e-182]\n```\n\n(which is close to what provide `gsl` and the initial doctest) rather than\n\n```\nsage: f = integral(exp(-x^2)*log(x), (x,17,42), algorithm='sympy')\nsage: RealBallField(512)(f)\n[1.5577642856694726097777e-130 +/- 4.52e-153]\n```\n\nIs the formula provided by sympy even correct?",
    "created_at": "2019-06-25T19:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391586",
    "user": "vdelecroix"
}
```

Actually, I believe more

```
sage: ComplexBallField(512).integral(lambda x,_: (-x*x).exp()*x.log(), 17, 42)
[2.565728500561051482917356396130478590014770955402032663e-127 +/- 8.94e-182]
```

(which is close to what provide `gsl` and the initial doctest) rather than

```
sage: f = integral(exp(-x^2)*log(x), (x,17,42), algorithm='sympy')
sage: RealBallField(512)(f)
[1.5577642856694726097777e-130 +/- 4.52e-153]
```

Is the formula provided by sympy even correct?



---

archive/issue_comments_391587.json:
```json
{
    "body": "Or the symbolic ring does something completely stupid to evaluate hypergeometric functions with real ball input?",
    "created_at": "2019-06-25T19:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391587",
    "user": "vdelecroix"
}
```

Or the symbolic ring does something completely stupid to evaluate hypergeometric functions with real ball input?



---

archive/issue_comments_391588.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-06-25T19:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391588",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_391589.json:
```json
{
    "body": "According to Mathematica it is correct... also confirmed by this smaller range computation\n\n```\nsage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')\nsage: RBF(f.subs(x=2)) - RBF(f.subs(x=1))\n[0.032612042358609 +/- 8.42e-16]\nsage: CBF.integral(lambda x,_: (-x*x).exp()*x.log(), 1, 2)\n[0.032612042358610 +/- 5.89e-16]\n```\n\n\nThe conversion to ball fields appear to be wrong also for much smaller values\n\n```\nsage: prec = 256 \nsage: R = RealBallField(prec)\nsage: C = ComplexBallField(prec)\nsage: a = 5; b = 6\nsage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)\n[2.218662695682179212714334629004026381551686783767107654124923915615978e-12 +/- 6.31e-82]\nsage: R(f.subs(x=b)) - R(f.subs(x=a))\n[2.218664132884571616593899629338237856352627658842503518158550169e-12 +/- 2.32e-76]\n```\n\nThe two values start to differ from the 7th digit.",
    "created_at": "2019-06-25T19:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391589",
    "user": "vdelecroix"
}
```

According to Mathematica it is correct... also confirmed by this smaller range computation

```
sage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')
sage: RBF(f.subs(x=2)) - RBF(f.subs(x=1))
[0.032612042358609 +/- 8.42e-16]
sage: CBF.integral(lambda x,_: (-x*x).exp()*x.log(), 1, 2)
[0.032612042358610 +/- 5.89e-16]
```


The conversion to ball fields appear to be wrong also for much smaller values

```
sage: prec = 256 
sage: R = RealBallField(prec)
sage: C = ComplexBallField(prec)
sage: a = 5; b = 6
sage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)
[2.218662695682179212714334629004026381551686783767107654124923915615978e-12 +/- 6.31e-82]
sage: R(f.subs(x=b)) - R(f.subs(x=a))
[2.218664132884571616593899629338237856352627658842503518158550169e-12 +/- 2.32e-76]
```

The two values start to differ from the 7th digit.



---

archive/issue_comments_391590.json:
```json
{
    "body": "Conclusion: change the doctest to something more relevant such as\n\n```\nsage: integrate(exp(-x^2)*log(x), x)\n1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)\n```\n\nThough this takes 10 secs!!!\n\nAlso taking the numerical approximation of a symbolic integral is the last thing you want to do to evaluate numerically an integral. We should not tell users to do that.",
    "created_at": "2019-06-25T19:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391590",
    "user": "vdelecroix"
}
```

Conclusion: change the doctest to something more relevant such as

```
sage: integrate(exp(-x^2)*log(x), x)
1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
```

Though this takes 10 secs!!!

Also taking the numerical approximation of a symbolic integral is the last thing you want to do to evaluate numerically an integral. We should not tell users to do that.



---

archive/issue_comments_391591.json:
```json
{
    "body": "Anyway, these doctests do no longer make any sense in the context of the book, because sage is now able to integrate symbolically this expression. In the book, this is given as an example where symbolic integration fails..\n\nI would rather remove them from our testsuite..",
    "created_at": "2019-06-26T07:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391591",
    "user": "chapoton"
}
```

Anyway, these doctests do no longer make any sense in the context of the book, because sage is now able to integrate symbolically this expression. In the book, this is given as an example where symbolic integration fails..

I would rather remove them from our testsuite..



---

archive/issue_comments_391592.json:
```json
{
    "body": "> I would rather remove them from our test suite..\n\nBut didn't they still want a failing doctest somehow, or is this okay by their point of view?  (There are so many authors, maybe you are one of them and can speak to that.)  It would be good to somewhere have a failing integral, because that tests whether that branch of the code (i.e. the one that says what to do if everything still doesn't work) is not inadvertently no longer working.  That said, I haven't been too aggressive on this ticket so I'll let all of you decide on this.",
    "created_at": "2019-06-26T11:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391592",
    "user": "kcrisman"
}
```

> I would rather remove them from our test suite..

But didn't they still want a failing doctest somehow, or is this okay by their point of view?  (There are so many authors, maybe you are one of them and can speak to that.)  It would be good to somewhere have a failing integral, because that tests whether that branch of the code (i.e. the one that says what to do if everything still doesn't work) is not inadvertently no longer working.  That said, I haven't been too aggressive on this ticket so I'll let all of you decide on this.



---

archive/issue_comments_391593.json:
```json
{
    "body": "As a still failing integral, one could use then\n\n```\nintegral(cos(ln(cos(x))),x,0,pi/2)\n```\n\nwhich cannot be done by maxima, giac, sympy or fricas.",
    "created_at": "2019-06-26T11:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391593",
    "user": "chapoton"
}
```

As a still failing integral, one could use then

```
integral(cos(ln(cos(x))),x,0,pi/2)
```

which cannot be done by maxima, giac, sympy or fricas.



---

archive/issue_comments_391594.json:
```json
{
    "body": "As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?",
    "created_at": "2019-06-26T19:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391594",
    "user": "mmezzarobba"
}
```

As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?



---

archive/issue_comments_391595.json:
```json
{
    "body": "Replying to [comment:39 mmezzarobba]:\n> As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?\n\nsince it was decided in ticket #27958, comment [comment:58] (while the book was already in print by SIAM), not to accept doctests that do not pass in Python3 (while the book was publicly available since a long time, and nobody asked before for the doctests to be compatible with Python 3), the doctests in Sage do no longer correspond to those in the book, and I have decided not to spend any more time on this.\n\nIn summary: do whatever you want, those doctests are no more relevant for the french book.",
    "created_at": "2019-06-27T15:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391595",
    "user": "zimmerma"
}
```

Replying to [comment:39 mmezzarobba]:
> As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?

since it was decided in ticket #27958, comment [comment:58] (while the book was already in print by SIAM), not to accept doctests that do not pass in Python3 (while the book was publicly available since a long time, and nobody asked before for the doctests to be compatible with Python 3), the doctests in Sage do no longer correspond to those in the book, and I have decided not to spend any more time on this.

In summary: do whatever you want, those doctests are no more relevant for the french book.



---

archive/issue_comments_391596.json:
```json
{
    "body": "Replying to [comment:40 zimmerma]:\n> Replying to [comment:39 mmezzarobba]:\n> > As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?\n> \n> [...] in ticket #27958, comment [comment:58] [...]\n\nThere is no comment number 58 on ticket #27958!",
    "created_at": "2019-06-28T05:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391596",
    "user": "vdelecroix"
}
```

Replying to [comment:40 zimmerma]:
> Replying to [comment:39 mmezzarobba]:
> > As one of the authors, that's fine with me, but I'm not the main author of the chapter, and I think the author with the clearest idea of what to do and not to do with these doctests is Paul (already Cc:ed). Paul, if you are reading this, is it okay with you to remove the test?
> 
> [...] in ticket #27958, comment [comment:58] [...]

There is no comment number 58 on ticket #27958!



---

archive/issue_comments_391597.json:
```json
{
    "body": "sorry that was ticket #23572",
    "created_at": "2019-06-28T05:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391597",
    "user": "zimmerma"
}
```

sorry that was ticket #23572



---

archive/issue_comments_391598.json:
```json
{
    "body": "Replying to [comment:42 zimmerma]:\n> sorry that was ticket #23572\n\nI did not know about what happend with this ticket. It is indeed unfortunate... the switch to Python 3 is a long and painful route.\n\nBut the matter under discussion here is of different nature.  The single test under discussion is\n\n```\nN(integrate(exp(-x^2)*log(x), x, 17, 42))\n```\n\nThere is a positive change of behavior since Sage will now symbolically integrate `exp(-x^2)*log(x)`. As the doctest was used to illustrate the fact that numerical integration was possible on unevaluated integrals it would not make sense anymore. It is rather the book that has to be adapted here (contrarily to #23572 where the doctest framework should have been adapted).\n\nIsn't there a document that explains what has changed between the available version of the book and the current Sage version? I think this would be very useful.",
    "created_at": "2019-06-28T06:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391598",
    "user": "vdelecroix"
}
```

Replying to [comment:42 zimmerma]:
> sorry that was ticket #23572

I did not know about what happend with this ticket. It is indeed unfortunate... the switch to Python 3 is a long and painful route.

But the matter under discussion here is of different nature.  The single test under discussion is

```
N(integrate(exp(-x^2)*log(x), x, 17, 42))
```

There is a positive change of behavior since Sage will now symbolically integrate `exp(-x^2)*log(x)`. As the doctest was used to illustrate the fact that numerical integration was possible on unevaluated integrals it would not make sense anymore. It is rather the book that has to be adapted here (contrarily to #23572 where the doctest framework should have been adapted).

Isn't there a document that explains what has changed between the available version of the book and the current Sage version? I think this would be very useful.



---

archive/issue_comments_391599.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-28T09:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391599",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391600.json:
```json
{
    "body": "Here is a proposal that keeps the spirit of the modified books' doctests.",
    "created_at": "2019-06-28T09:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391600",
    "user": "chapoton"
}
```

Here is a proposal that keeps the spirit of the modified books' doctests.



---

archive/issue_comments_391601.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-06-28T11:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391601",
    "user": "chapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_391602.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391602",
    "user": "embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_391603.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-07-09T13:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391603",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_391604.json:
```json
{
    "body": "Regarding builtins, instead of testing that a string is produced:\n\n\n```\nsage: log_integral(x)._fricas_init_()\n'li(x)'\n```\n\n\nYou could (optionally) test that fricas actually handles the function: \n\n\n```\nsage: log_integral(x)._fricas_()      # optional - fricas\nli(x)\n```\n\n\nas you did for giac.",
    "created_at": "2019-07-09T13:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391604",
    "user": "tmonteil"
}
```

Regarding builtins, instead of testing that a string is produced:


```
sage: log_integral(x)._fricas_init_()
'li(x)'
```


You could (optionally) test that fricas actually handles the function: 


```
sage: log_integral(x)._fricas_()      # optional - fricas
li(x)
```


as you did for giac.



---

archive/issue_comments_391605.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-09T13:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391605",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_391606.json:
```json
{
    "body": "Well, I prefer the first test, because Fricas is optional.\n\n**edit**\n\nI could change that if you insist, but this is really not the core of the matter.",
    "created_at": "2019-07-09T13:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391606",
    "user": "chapoton"
}
```

Well, I prefer the first test, because Fricas is optional.

**edit**

I could change that if you insist, but this is really not the core of the matter.



---

archive/issue_comments_391607.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-19T05:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391607",
    "user": "tmonteil"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_391608.json:
```json
{
    "body": "The thing is that this test does not test anything, you could change with any string not representing a `fricas` function, it will work as well.\n\nAnyway, i see that there are other similar `fricas` functions that are not tested, so let us postpone that for a dedicated ticket.",
    "created_at": "2019-07-19T05:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391608",
    "user": "tmonteil"
}
```

The thing is that this test does not test anything, you could change with any string not representing a `fricas` function, it will work as well.

Anyway, i see that there are other similar `fricas` functions that are not tested, so let us postpone that for a dedicated ticket.



---

archive/issue_comments_391609.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-20T09:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391609",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_391610.json:
```json
{
    "body": "See #28964 for a possible follow up.",
    "created_at": "2020-01-07T10:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27721#issuecomment-391610",
    "user": "egourgoulhon"
}
```

See #28964 for a possible follow up.
