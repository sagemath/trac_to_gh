# Issue 31624: Persistent Homology

Issue created by migration from https://trac.sagemath.org/ticket/31861

Original creator: @Quenouillaume

Original creation time: 2021-05-26 19:48:01

CC:  jhpalmieri slelievre tscrim




---

Comment by @Quenouillaume created at 2021-05-26 20:02:21

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @Quenouillaume created at 2021-05-26 20:02:21

Changing component from PLEASE CHANGE to algebraic topology.


---

Comment by @Quenouillaume created at 2021-05-26 20:02:21

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-05-26 20:15:24

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-05-26 20:15:24

There's no code on this branch


---

Comment by git created at 2021-05-26 20:33:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-26 21:38:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Quenouillaume created at 2021-05-26 21:46:25

Apologies for the first ticket that had no code on its branch, this is my first time using trac !


---

Comment by @Quenouillaume created at 2021-05-26 21:46:25

Changing status from needs_work to needs_review.


---

Comment by @Quenouillaume created at 2021-05-26 21:47:03

Changing keywords from "" to "homology, persistent-homology".


---

Comment by mkoeppe created at 2021-05-26 22:36:25

I would suggest not to create a new top-level package `sage.persistent_homology` but rather to nest it


---

Comment by tmonteil created at 2021-05-26 23:30:22

I am not sure, but since this code seems already packaged at https://github.com/Quenouillaume/persil, why not let it be part of the task #31164 ? Also, some 10 years ago i saw some optimized code for persistent homology (by Edelsbrunner iirc), so i wonder whether there is room for interfacing such code within Sage ?


---

Comment by tmonteil created at 2021-05-26 23:31:01

See https://en.wikipedia.org/wiki/Persistent_homology#Computation


---

Comment by @Quenouillaume created at 2021-05-27 07:15:59

The code at https://github.com/Quenouillaume/persil was a first draft, in particular I used my own homemade versions of the `Simplex` and `FreeModule` classes ! The code on this ticket's branch replaces those with built-in Sage functionalities.


Replying to [comment:9 tmonteil]:
> I am not sure, but since this code seems already packaged at https://github.com/Quenouillaume/persil, why not let it be part of the task #31164 ? Also, some 10 years ago i saw some optimized code for persistent homology (by Edelsbrunner iirc), so i wonder whether there is room for interfacing such code within Sage ?


---

Comment by tscrim created at 2021-05-27 07:55:02

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2021-05-27 07:55:02

Thank you for adding this code. However, there are a few things that will need to be addressed before this can be included.

- All methods and functions need to be doctested.
- There isn't a need to define a sublevel of the documentation for this one additional file. Just adding it to the usual homology documentation is fine. In a related note, I would put your files under the `sage/homology` folder.
- I wouldn't use `__foo` methods. There is no need to name-mangle. Just `_foo` is fine. (This will also make it easier to doctest; note that this does not apply to special methods like `__getitem__`.)
- Avoid useless checks here with short-circuiting:
  {{{#!diff
-if j%1000 == 0 and self._verbose:
+if self._verbose and j%1000 == 0:
  }}}
- Please follow PEP8 when reasonable. In particular, use Python's naming convention for variables. For example, change `_numSimplices` -> `_num_simplices`.


---

Comment by git created at 2021-05-27 10:59:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-27 11:33:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Quenouillaume created at 2021-05-27 11:42:03

Changing status from needs_work to needs_review.


---

Comment by @Quenouillaume created at 2021-05-27 11:42:03

Added doctests for all methods, and adapted to PEP8.
A few lines are still more than 80 characters long,
most of them being in the doctests.

Also moved files and documentation to the homology folders.


---

Comment by git created at 2021-05-27 15:28:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-05-29 23:28:27

Some comments:

- It might be a good idea to have ways of converting to and from simplicial complexes: for instance, if X is a filtered complex, then a method that takes a value n and returns the complex made up of all simplices with filtration at most n. Also a `_simplicial_` method so that `SimplicialComplex(X)` works. In addition, take a simplicial complex and make it a filtered complex with everything in filtration 0.

- Related to that, I was wondering if it made sense for `FilteredComplex` to inherit from `SimplicialComplex`. I don't think so, but I thought I'd ask.

- Also related to that, would it make sense to have a way of modifying the filtration value for a given simplex? I would suggest renaming `get_value` to `filtration`. Maybe it could take two arguments: a required argument `s`, a simplex, and if that is the only argument, then return its filtration. If an optional argument `v` is present, then instead set its filtration to `v`.

- Throughout, I would change "filtered complex" to "filtered simplicial complex", and I would change the name of the file and the name of the class accordingly. When I see "filtered complex," I tend to think of a filtered chain complex, and then I think that there should be spectral sequences lurking somewhere. (That would be a great task for someone to take on.) To make things unambiguous, we should have `FilteredChainComplex` (I hope eventually) and `FilteredSimplicialComplex` (from this ticket).

- Regarding

```
    This implementation requires filtration values to be positive. Most
    features will not work with negative values.
```

 Should we have a warning or error if the user uses negative filtration values? I would also add this comment to the docstring for the `__init__` method, so that users will see if when they do `FilteredComplex?`.

- In the `__init__` method, I like the comments about `_vertices`, `_simplices`, and `_degrees_dict`. Can you add a similar comment about `_warnings`? (Or document the `warnings` argument.) Is `degree` the same as filtration value? I might change that language, at least in the docstring and names of the user-viewable variables (for example `simplex_degree_list` could perhaps just be renamed to `simplices`).


---

Comment by tscrim created at 2021-06-01 01:06:19

+1 on making this a subclass of `SimplicialComplex` and changing the name to `FilteredSimplicialComplex`.


---

Comment by jhpalmieri created at 2021-06-01 05:31:31

Replying to [comment:19 tscrim]:
> +1 on making this a subclass of `SimplicialComplex` and changing the name to `FilteredSimplicialComplex`.

This might require a lot of work: various methods for `SimplicialComplex` would have to be modified to work with `FilteredSimplicialComplex`, like product, wedge, join, ..., unless we just forget the filtration. At least `FilteredSimplicialComplex` could inherit from `GenericCellComplex`, and maybe there could be a new intermediate class that both it and `SimplicialComplex` could inherit from.


---

Comment by tscrim created at 2021-06-01 06:36:33

Hmm...yea, I guess so. Well, I am okay with including this class as-is for now since it will be essentially all implementation details changed by such a refactoring. The only thing I would want would be to change `compute_homology()` to `persistent_homology()` so it is unambiguous about what type of homology is being computed. (The Betti numbers are fine because of the extra parameters.)


---

Comment by @Quenouillaume created at 2021-06-01 12:29:12

I'm working on implementing all those suggestions, thank you for the very insightful feedback !

I also think that having `FilteredSimplicialComplex` inherit from `SimplicialComplex` is a bit odd, for all the reasons mentionned above, but I'm not sure it should inherit from `GenericCellComplex` either, since they don't really have the same homology type...

Maybe a simple first solution would be, as jhpalmieri suggests, to have a `_simplicial_()` method for `FilteredSimplicialComplex`, which returns the maximal simplicial complex associated to the filtered complex, as well as a `prune(max_value)` method which returns a copy of the filtered complex, where simplices of value more than `max_value` have been removed.


---

Comment by jhpalmieri created at 2021-06-01 15:47:50

Replying to [comment:21 tscrim]:
> The only thing I would want would be to change `compute_homology()` to `persistent_homology()` so it is unambiguous about what type of homology is being computed. (The Betti numbers are fine because of the extra parameters.)

+1


---

Comment by git created at 2021-06-02 12:20:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-02 12:23:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-02 12:47:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-06-05 08:15:28

I don't really like the fact that `compute_persistent_homology()` in some sense fixes the field you are computing the homology over and that it needs to be called before getting the intervals without a meaningful error message. Plus the result is only partially cached as when you run this again, you obtain new data that overwrites the old computed data. So my proposal is to change it as follows:

- Make `compute_persistent_homology()` hidden by `_compute_persistent_homology()` and then have it return the resulting intervals.
- Have a cached method `intervals()` (perhaps call that `persistence_intervals`) that has `field` and `strict` as part of its key. So it will be decorated by ``@`cached_method(key=lambda self,f,s,v: (f,s))`.
- Remove the now unused attributes such as `intervals`.

Also, why can't you just pass `_filtration_dict` as a list of simplicies to `SimplicialComplex` in `_simplicial_`? Related, I also don't see the need for the `_simplicies` list as you can get it as the keys of `_filtration_dict`. The sorting is only needed during the computation of the persistent homology, which you could construct in there.


---

Comment by git created at 2021-06-07 08:27:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Quenouillaume created at 2021-06-07 08:27:39

Replying to [comment:27 tscrim]:
> I don't really like the fact that `compute_persistent_homology()`...

I agree, I didn't know about the cached_method decorator and it can probably be very useful here. However there is a problem: since `FilteredSimplicialComplex` objects can have their simplices inserted or changed, the cache key needs to take into account whether the complex has changed since last time persistent homology was computed or not.
I was thinking of just counting the number of times that the complex has been modified and have that also be part of the cache key, but maybe there is a simpler / less hacky solution...
In any case, I think that the `_compute_persistent_homology` method should be cached rather than the `persistence_intervals` method, since it can be called when computing intervals or betti numbers.

> Also, why can't you just pass `_filtration_dict` as a list of simplicies to `SimplicialComplex` in `_simplicial_`? Related, ...

Yes this is much simpler, thank you ! 
----
New commits:


---

Comment by tscrim created at 2021-06-07 22:39:30

I would just call `foo.cached_func.clear_cache()` to clear the cache when the complex is mutated.

Addendum: The way you have it implemented now is effectively a memory leak since you are always adding more stuff to the cache every time you run it.


---

Comment by git created at 2021-06-08 10:12:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-08 10:39:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by tscrim created at 2021-08-27 01:09:52

Sorry for loosing track of this; I didn't get any notifications from trac that you pushed changes.

I think all of my and John's current comments have been taken into account, correct?

Can you provide a rebase onto the latest beta? I will continue my review at that point.


---

Comment by git created at 2021-08-27 16:13:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @Quenouillaume created at 2021-08-27 16:20:51

I believe I've taken all your comments into account ! And I've just finished rebasing if you wish to keep reviewing.


---

Comment by chapoton created at 2021-08-28 12:05:14

le patchbot a l'air de dire que la branche ne compile pas..


---

Comment by git created at 2021-08-28 18:27:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Quenouillaume created at 2021-08-28 18:33:15

I fixed the rebase error, it should work now. This was in part due to me not realizing that 
`sage.homology.simplicial_complex` was deprecated and moved to `sage.topology` ! 
Should the files of this ticket also be moved from `sage.homology` to `sage.topology` ?


---

Comment by jhpalmieri created at 2021-08-28 19:40:43

Replying to [comment:39 gh-Quenouillaume]:
> Should the files of this ticket also be moved from `sage.homology` to `sage.topology` ?

I would say yes.


---

Comment by chapoton created at 2021-08-29 06:38:23

le patchbot dit maintenant que la doc ne compile pas:

```
[dochtml] [reference] /home/chapoton/sage/src/doc/en/reference/references/index.rst:5977: WARNING: Duplicate explicit target name: "zc2005".
[dochtml] [reference] /home/chapoton/sage/src/doc/en/reference/references/index.rst:5977: WARNING: duplicate citation ZC2005, other instance in /home/chapoton/sage/src/doc/en/reference/references/index.rst
```



---

Comment by tscrim created at 2021-09-01 02:31:24

Indeed, you can see in the diff that [ZC2005] has accidentally been added twice. I have removed the duplicate reference.

I made a few other reviewer changes. Most of them are doc formatting. However, there are two big ones:

- I added an equality check.
- I changed `warnings` to `verbose` as it wasn't being used to warn the user but simply expressing that it changed its state.

I found two things that might be lacking: we cannot remove simplices nor raise the filtration value. The first is a feature that can be added later. The second, I am guessing it is for reasons of keeping things consistent? These aren't anything that would prevent me from giving a positive review, but it would be nice for some clarification for the latter (of course, the behaviour is documented, but why do we want this?).

John, do you have any other comments?
----
New commits:


---

Comment by jhpalmieri created at 2021-09-01 16:56:02

My only comment is that the file should be moved from `homology` to `topology`. After that,  I would be happy to see it merged.


---

Comment by git created at 2021-09-08 01:00:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-08 01:02:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-08 01:03:23

Replying to [comment:43 jhpalmieri]:
> My only comment is that the file should be moved from `homology` to `topology`. After that,  I would be happy to see it merged.

I have moved it over and fixed a pyflakes warning. Please check.


---

Comment by git created at 2021-09-08 22:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-08 22:10:41

That should fix the docbuild issue.


---

Comment by tscrim created at 2021-09-13 01:21:34

Green patchbot.


---

Comment by jhpalmieri created at 2021-09-13 04:50:38

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-09-13 04:50:38

Great, let's merge it!


---

Comment by vbraun created at 2021-09-14 22:51:05

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-09-14 22:51:05

Merge conflict


---

Comment by git created at 2021-09-14 23:46:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-14 23:46:47

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2021-09-14 23:46:47

Trivial rebase.


---

Comment by vbraun created at 2021-09-19 09:59:08

Resolution: fixed
