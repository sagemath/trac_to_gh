# Issue 31384: ubuntu-groovy-standard: numerics-related sage testsuite errors

archive/issues_031384.json:
```json
{
    "body": "CC:  dimpase jhpalmieri vdelecroix @kliem\n\nFrom https://groups.google.com/g/sage-release/c/6WjKQt_e_B8/m/dpx1qILOCwAJ (for 9.3.rc2):\n\n9.3.beta8> {debian-bullseye,ubuntu-groovy}-standard: cvxopt testsuite errors, numerics-related sage testsuite errors\n9.3.beta8> (is system BLAS feeling OK??)\n\nThe numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. \nThe numerics failures on ubuntu-groovy are still present.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31621\n\n",
    "created_at": "2021-04-08T17:18:51Z",
    "labels": [
        "porting",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "ubuntu-groovy-standard: numerics-related sage testsuite errors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31384",
    "user": "mkoeppe"
}
```
CC:  dimpase jhpalmieri vdelecroix @kliem

From https://groups.google.com/g/sage-release/c/6WjKQt_e_B8/m/dpx1qILOCwAJ (for 9.3.rc2):

9.3.beta8> {debian-bullseye,ubuntu-groovy}-standard: cvxopt testsuite errors, numerics-related sage testsuite errors
9.3.beta8> (is system BLAS feeling OK??)

The numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. 
The numerics failures on ubuntu-groovy are still present.

Issue created by migration from https://trac.sagemath.org/ticket/31621





---

archive/issue_comments_448923.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448923",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_448924.json:
```json
{
    "body": "I saw what I think are the same failures on one OS X 11.5.2 machine (but not another one \u2014\u00a0I think it's CPU dependent). The failing machine says\n\n```\n% sysctl -n machdep.cpu.brand_string\nIntel(R) Xeon(R) W-2140B CPU @ 3.20GHz\n```\n\nI can provide other CPU info if you let me know what commands to run.",
    "created_at": "2021-09-22T21:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448924",
    "user": "jhpalmieri"
}
```

I saw what I think are the same failures on one OS X 11.5.2 machine (but not another one — I think it's CPU dependent). The failing machine says

```
% sysctl -n machdep.cpu.brand_string
Intel(R) Xeon(R) W-2140B CPU @ 3.20GHz
```

I can provide other CPU info if you let me know what commands to run.



---

archive/issue_comments_448925.json:
```json
{
    "body": "The tests passed when I did `tox -e local-homebrew-macos-minimal -- ptestlong`. Any guesses for what homebrew package is causing the problem? What should I plug into `./configure --with-system-PKG=no`?",
    "created_at": "2021-09-23T20:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448925",
    "user": "jhpalmieri"
}
```

The tests passed when I did `tox -e local-homebrew-macos-minimal -- ptestlong`. Any guesses for what homebrew package is causing the problem? What should I plug into `./configure --with-system-PKG=no`?



---

archive/issue_comments_448926.json:
```json
{
    "body": "These tests passed when I did `./configure --with-system-gsl=no --with-system-openblas=no`. \n\nJust using `./configure --with-system-gsl=no` failed to build: gsl's configure script failed with\n\n```\nconfigure: error: in `/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta1/local/var/tmp/sage/build/gsl-2.6/src':\nconfigure: error: C compiler cannot create executables\n```\n\nand gsl's config.log file said\n\n```\nld: library not found for -lopenblas\n```\n\n\nI'm trying now with `./configure --with-system-openblas=no`, which means that Sage will also build its own `gsl`, `r`, and `suitesparse`.\n\n(This computer is in my work office, and so I will not check its progress again until Monday.)",
    "created_at": "2021-09-24T21:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448926",
    "user": "jhpalmieri"
}
```

These tests passed when I did `./configure --with-system-gsl=no --with-system-openblas=no`. 

Just using `./configure --with-system-gsl=no` failed to build: gsl's configure script failed with

```
configure: error: in `/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta1/local/var/tmp/sage/build/gsl-2.6/src':
configure: error: C compiler cannot create executables
```

and gsl's config.log file said

```
ld: library not found for -lopenblas
```


I'm trying now with `./configure --with-system-openblas=no`, which means that Sage will also build its own `gsl`, `r`, and `suitesparse`.

(This computer is in my work office, and so I will not check its progress again until Monday.)



---

archive/issue_comments_448927.json:
```json
{
    "body": "By the way, I expect this to pass these tests \u2014 it should be equivalent to what I already did with `./configure --with-system-gsl=no --with-system-openblas=no` \u2014\u00a0but I want to see the output of `make ptestlong`.",
    "created_at": "2021-09-24T22:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448927",
    "user": "jhpalmieri"
}
```

By the way, I expect this to pass these tests — it should be equivalent to what I already did with `./configure --with-system-gsl=no --with-system-openblas=no` — but I want to see the output of `make ptestlong`.



---

archive/issue_comments_448928.json:
```json
{
    "body": "All tests passed when using that flag (`--with-system-openblas=no`).",
    "created_at": "2021-09-27T18:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448928",
    "user": "jhpalmieri"
}
```

All tests passed when using that flag (`--with-system-openblas=no`).



---

archive/issue_comments_448929.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-10-16T17:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448929",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_448930.json:
```json
{
    "body": "John, do you see on macOS the error reported by Vincent?\n\n```\nFile \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\nsage.matrix.matrix_double_dense.Matrix_double_dense.?\nFailed example:\n     A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\nExpected:\n     [(-8.0, 22), (2.0, 77), (22.0, 1)]\nGot:\n     [(-13.81753974166025, 1),\n...\n```\n\n\n- it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)",
    "created_at": "2021-10-16T22:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448930",
    "user": "dimpase"
}
```

John, do you see on macOS the error reported by Vincent?

```
File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
sage.matrix.matrix_double_dense.Matrix_double_dense.?
Failed example:
     A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
Expected:
     [(-8.0, 22), (2.0, 77), (22.0, 1)]
Got:
     [(-13.81753974166025, 1),
...
```


- it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)



---

archive/issue_comments_448931.json:
```json
{
    "body": "also, what openblas version did you try on homebrew?\nthe bumped to 0.3.18 two weeks ago: https://github.com/Homebrew/homebrew-core/commit/63de340b1e397b67e7137519f45b02491b6e1f15",
    "created_at": "2021-10-16T22:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448931",
    "user": "dimpase"
}
```

also, what openblas version did you try on homebrew?
the bumped to 0.3.18 two weeks ago: https://github.com/Homebrew/homebrew-core/commit/63de340b1e397b67e7137519f45b02491b6e1f15



---

archive/issue_comments_448932.json:
```json
{
    "body": "I will check on Monday.",
    "created_at": "2021-10-17T00:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448932",
    "user": "jhpalmieri"
}
```

I will check on Monday.



---

archive/issue_comments_448933.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> John, do you see on macOS the error reported by Vincent?\n> {{{\n> File \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\n> sage.matrix.matrix_double_dense.Matrix_double_dense.?\n> Failed example:\n>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\n> Expected:\n>      [(-8.0, 22), (2.0, 77), (22.0, 1)]\n> Got:\n>      [(-13.81753974166025, 1),\n> ...\n> }}}\n> \n> - it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)\n> \n>  \n\nDima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.",
    "created_at": "2021-10-17T10:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448933",
    "user": "vdelecroix"
}
```

Replying to [comment:11 dimpase]:
> John, do you see on macOS the error reported by Vincent?
> {{{
> File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
> sage.matrix.matrix_double_dense.Matrix_double_dense.?
> Failed example:
>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
> Expected:
>      [(-8.0, 22), (2.0, 77), (22.0, 1)]
> Got:
>      [(-13.81753974166025, 1),
> ...
> }}}
> 
> - it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)
> 
>  

Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.



---

archive/issue_comments_448934.json:
```json
{
    "body": "Attachment [dev_test.f90](tarball://root/attachments/some-uuid/ticket31621/dev_test.f90) by dimpase created at 2021-10-17 21:17:45\n\ntest Fortran program",
    "created_at": "2021-10-17T21:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448934",
    "user": "dimpase"
}
```

Attachment [dev_test.f90](tarball://root/attachments/some-uuid/ticket31621/dev_test.f90) by dimpase created at 2021-10-17 21:17:45

test Fortran program



---

archive/issue_comments_448935.json:
```json
{
    "body": "the failing example (spectrum of the adj. matrix of 100-vertex Higman-Sims graph)",
    "created_at": "2021-10-17T21:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448935",
    "user": "dimpase"
}
```

the failing example (spectrum of the adj. matrix of 100-vertex Higman-Sims graph)



---

archive/issue_comments_448936.json:
```json
{
    "body": "Attachment [HigmanSims.tst](tarball://root/attachments/some-uuid/ticket31621/HigmanSims.tst) by dimpase created at 2021-10-17 21:19:50\n\nsmaller example (from Petersen graph)",
    "created_at": "2021-10-17T21:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448936",
    "user": "dimpase"
}
```

Attachment [HigmanSims.tst](tarball://root/attachments/some-uuid/ticket31621/HigmanSims.tst) by dimpase created at 2021-10-17 21:19:50

smaller example (from Petersen graph)



---

archive/issue_comments_448937.json:
```json
{
    "body": "Attachment [petersen.tst](tarball://root/attachments/some-uuid/ticket31621/petersen.tst) by dimpase created at 2021-10-17 21:20:21\n\nscript to compute test data",
    "created_at": "2021-10-17T21:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448937",
    "user": "dimpase"
}
```

Attachment [petersen.tst](tarball://root/attachments/some-uuid/ticket31621/petersen.tst) by dimpase created at 2021-10-17 21:20:21

script to compute test data



---

archive/issue_comments_448938.json:
```json
{
    "body": "Attachment [graphdata.sage](tarball://root/attachments/some-uuid/ticket31621/graphdata.sage) by dimpase created at 2021-10-17 21:28:36\n\nI've uploaded an attempted test of OpenBLAS. Download the attachments and\n\n```\ngfortran dev_test.f90 -lopenblas\n./a.out <HigmanSims.tst\n```\n\n\nThe last line of the output should say `max. deviation of eigenvals: <small number>`, where `<small number>` is smaller than 10<sup>-13</sup> or so if all is good.\n \n(there is another, smaller, example, too, petersen.tst)\n\n\nPlease note I'm not sure I used exactly the same LAPACK function as in Sage failing test - there is one more function to try, `DSYEVR` if this one, `DSYEV`, would just work.",
    "created_at": "2021-10-17T21:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448938",
    "user": "dimpase"
}
```

Attachment [graphdata.sage](tarball://root/attachments/some-uuid/ticket31621/graphdata.sage) by dimpase created at 2021-10-17 21:28:36

I've uploaded an attempted test of OpenBLAS. Download the attachments and

```
gfortran dev_test.f90 -lopenblas
./a.out <HigmanSims.tst
```


The last line of the output should say `max. deviation of eigenvals: <small number>`, where `<small number>` is smaller than 10<sup>-13</sup> or so if all is good.
 
(there is another, smaller, example, too, petersen.tst)


Please note I'm not sure I used exactly the same LAPACK function as in Sage failing test - there is one more function to try, `DSYEVR` if this one, `DSYEV`, would just work.



---

archive/issue_comments_448939.json:
```json
{
    "body": "Attachment [dev_test_dsyevr.f90](tarball://root/attachments/some-uuid/ticket31621/dev_test_dsyevr.f90) by dimpase created at 2021-10-18 10:54:19\n\ntest using LAPACK's dsyevr call",
    "created_at": "2021-10-18T10:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448939",
    "user": "dimpase"
}
```

Attachment [dev_test_dsyevr.f90](tarball://root/attachments/some-uuid/ticket31621/dev_test_dsyevr.f90) by dimpase created at 2021-10-18 10:54:19

test using LAPACK's dsyevr call



---

archive/issue_comments_448940.json:
```json
{
    "body": "please also try the latter attachment (same instructions, different file name,  `dev_test_dsyevr.f90`",
    "created_at": "2021-10-18T10:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448940",
    "user": "dimpase"
}
```

please also try the latter attachment (same instructions, different file name,  `dev_test_dsyevr.f90`



---

archive/issue_comments_448941.json:
```json
{
    "body": "Replying to [comment:14 vdelecroix]:\n\n> Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.\n\nhere is a direct scipy test via Sage:\n\n```\nsage: import numpy as np\nsage: import scipy\nsage: import scipy.linalg\nsage: g=graphs.HigmanSimsGraph()\nsage: a=np.matrix(g.adjacency_matrix())\nsage: eig=scipy.linalg.lapack.dsyevr(a); eig[0]\narray([-8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8.,\n       -8., -8., -8., -8., -8., -8., -8., -8., -8.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2., 22.])\n```\n",
    "created_at": "2021-10-18T14:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448941",
    "user": "dimpase"
}
```

Replying to [comment:14 vdelecroix]:

> Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.

here is a direct scipy test via Sage:

```
sage: import numpy as np
sage: import scipy
sage: import scipy.linalg
sage: g=graphs.HigmanSimsGraph()
sage: a=np.matrix(g.adjacency_matrix())
sage: eig=scipy.linalg.lapack.dsyevr(a); eig[0]
array([-8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8.,
       -8., -8., -8., -8., -8., -8., -8., -8., -8.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2., 22.])
```




---

archive/issue_comments_448942.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> John, do you see on macOS the error reported by Vincent?\n> {{{\n> File \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\n> sage.matrix.matrix_double_dense.Matrix_double_dense.?\n> Failed example:\n>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\n> Expected:\n>      [(-8.0, 22), (2.0, 77), (22.0, 1)]\n> Got:\n>      [(-13.81753974166025, 1),\n> ...\n> }}}\n\nYes, I see this failure. This is with an un-updated version of OpenBLAS: 0.3.17 from 2021-09-23 according to `brew info openblas`. I will try upgrading.",
    "created_at": "2021-10-18T17:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448942",
    "user": "jhpalmieri"
}
```

Replying to [comment:11 dimpase]:
> John, do you see on macOS the error reported by Vincent?
> {{{
> File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
> sage.matrix.matrix_double_dense.Matrix_double_dense.?
> Failed example:
>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
> Expected:
>      [(-8.0, 22), (2.0, 77), (22.0, 1)]
> Got:
>      [(-13.81753974166025, 1),
> ...
> }}}

Yes, I see this failure. This is with an un-updated version of OpenBLAS: 0.3.17 from 2021-09-23 according to `brew info openblas`. I will try upgrading.



---

archive/issue_comments_448943.json:
```json
{
    "body": "I can't use the standalone test because I get `ld: library not found for -lopenblas`.",
    "created_at": "2021-10-18T17:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448943",
    "user": "jhpalmieri"
}
```

I can't use the standalone test because I get `ld: library not found for -lopenblas`.



---

archive/issue_comments_448944.json:
```json
{
    "body": "Replying to [comment:19 jhpalmieri]:\n> I can't use the standalone test because I get `ld: library not found for -lopenblas`.\nYou'd need `-L` flag:\n\n```\ngfortran <...>.f90 -L/usr/local/opt/openblas/lib -lopenblas\n```\n",
    "created_at": "2021-10-18T18:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448944",
    "user": "dimpase"
}
```

Replying to [comment:19 jhpalmieri]:
> I can't use the standalone test because I get `ld: library not found for -lopenblas`.
You'd need `-L` flag:

```
gfortran <...>.f90 -L/usr/local/opt/openblas/lib -lopenblas
```




---

archive/issue_comments_448945.json:
```json
{
    "body": "Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.",
    "created_at": "2021-10-18T18:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448945",
    "user": "jhpalmieri"
}
```

Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.



---

archive/issue_comments_448946.json:
```json
{
    "body": "With `petersen.tst` I get `max. deviation of eigenvals:    8.8817841970012523E-016`.",
    "created_at": "2021-10-18T18:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448946",
    "user": "jhpalmieri"
}
```

With `petersen.tst` I get `max. deviation of eigenvals:    8.8817841970012523E-016`.



---

archive/issue_comments_448947.json:
```json
{
    "body": "On the other hand, when I run the example in Sage in comment:17, I get\n\n```\narray([-9.51662688, -9.01957761, -8.82571413, -8.53509523, -8.45449832,\n       -8.19421094, -8.06706488, -8.        , -8.        , -8.        ,\n       -8.        , -8.        , -8.        , -8.        , -8.        ,\n       -8.        , -8.        , -7.92742484, -7.63275394, -7.25448498,\n       -7.06795155, -6.90611622, -6.64469129, -6.54715317, -5.4872644 ,\n       -5.29660049, -4.69884647, -4.33752666, -4.30959029, -3.75213367,\n       -3.57502391, -2.92795773, -2.58101222, -2.57098415, -2.53138416,\n       -2.27048023, -2.16406448, -1.80261557, -1.75557973, -1.59188765,\n       -1.41796672, -1.35756654, -1.13476674, -0.92256797, -0.65109354,\n       -0.49437488, -0.27070739, -0.07512487,  0.17239949,  0.4835247 ,\n        0.54260365,  0.67677662,  1.03820124,  1.12679921,  1.41540993,\n        1.65236118,  1.75100574,  1.86305818,  1.99997232,  2.        ,\n        2.        ,  2.        ,  2.        ,  2.        ,  2.        ,\n        2.        ,  2.        ,  2.        ,  2.        ,  2.01296242,\n        2.23534418,  2.37464655,  2.50556135,  2.69055392,  2.73682618,\n        3.00360424,  3.18959084,  3.33877411,  3.4352485 ,  3.60531369,\n        3.74100246,  3.88461972,  3.98561053,  4.12222078,  4.2778004 ,\n        4.42940272,  4.49540354,  4.52975646,  4.83264503,  4.90738351,\n        5.1034719 ,  5.17889141,  5.6570698 ,  5.75157547,  6.26235796,\n        6.26836517,  7.08899349,  7.30672858,  8.74786038, 22.        ])\n```\n",
    "created_at": "2021-10-18T18:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448947",
    "user": "jhpalmieri"
}
```

On the other hand, when I run the example in Sage in comment:17, I get

```
array([-9.51662688, -9.01957761, -8.82571413, -8.53509523, -8.45449832,
       -8.19421094, -8.06706488, -8.        , -8.        , -8.        ,
       -8.        , -8.        , -8.        , -8.        , -8.        ,
       -8.        , -8.        , -7.92742484, -7.63275394, -7.25448498,
       -7.06795155, -6.90611622, -6.64469129, -6.54715317, -5.4872644 ,
       -5.29660049, -4.69884647, -4.33752666, -4.30959029, -3.75213367,
       -3.57502391, -2.92795773, -2.58101222, -2.57098415, -2.53138416,
       -2.27048023, -2.16406448, -1.80261557, -1.75557973, -1.59188765,
       -1.41796672, -1.35756654, -1.13476674, -0.92256797, -0.65109354,
       -0.49437488, -0.27070739, -0.07512487,  0.17239949,  0.4835247 ,
        0.54260365,  0.67677662,  1.03820124,  1.12679921,  1.41540993,
        1.65236118,  1.75100574,  1.86305818,  1.99997232,  2.        ,
        2.        ,  2.        ,  2.        ,  2.        ,  2.        ,
        2.        ,  2.        ,  2.        ,  2.        ,  2.01296242,
        2.23534418,  2.37464655,  2.50556135,  2.69055392,  2.73682618,
        3.00360424,  3.18959084,  3.33877411,  3.4352485 ,  3.60531369,
        3.74100246,  3.88461972,  3.98561053,  4.12222078,  4.2778004 ,
        4.42940272,  4.49540354,  4.52975646,  4.83264503,  4.90738351,
        5.1034719 ,  5.17889141,  5.6570698 ,  5.75157547,  6.26235796,
        6.26836517,  7.08899349,  7.30672858,  8.74786038, 22.        ])
```




---

archive/issue_comments_448948.json:
```json
{
    "body": "Replying to [comment:21 jhpalmieri]:\n> Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.\n\nWhich Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.",
    "created_at": "2021-10-18T19:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448948",
    "user": "dimpase"
}
```

Replying to [comment:21 jhpalmieri]:
> Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.

Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.



---

archive/issue_comments_448949.json:
```json
{
    "body": "Replying to [comment:24 dimpase]:\n> Replying to [comment:21 jhpalmieri]:\n> > Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.\n> \n> Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.\n\nI tried both (that's what I meant by \"either test program\").",
    "created_at": "2021-10-18T19:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448949",
    "user": "jhpalmieri"
}
```

Replying to [comment:24 dimpase]:
> Replying to [comment:21 jhpalmieri]:
> > Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.
> 
> Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.

I tried both (that's what I meant by "either test program").



---

archive/issue_comments_448950.json:
```json
{
    "body": "ok, so the next step would be to try the \"normal\" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in comment:17.",
    "created_at": "2021-10-18T19:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448950",
    "user": "dimpase"
}
```

ok, so the next step would be to try the "normal" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in comment:17.



---

archive/issue_comments_448951.json:
```json
{
    "body": "and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.",
    "created_at": "2021-10-18T19:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448951",
    "user": "dimpase"
}
```

and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.



---

archive/issue_comments_448952.json:
```json
{
    "body": "Replying to [comment:26 dimpase]:\n> ok, so the next step would be to try the \"normal\" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in comment:17.\n> \none quick way to do this is the following:\n\n```\nsage: import numpy as np\nsage: g=graphs.HigmanSimsGraph()\nsage: a=np.matrix(g.adjacency_matrix())\nsage: np.save('/tmp/x',a)\n```\n\nnow we have `a` in `/tmp/x.npy`. So start \n\n```\n./sage --python\n```\n \nand at its `>>>` prompt do\n\n```\nimport numpy as np\na=np.load('/tmp/x.npy')\nimport scipy\nimport scipy.linalg\neig=scipy.linalg.lapack.dsyevr(a); eig[0]\n```\n",
    "created_at": "2021-10-18T20:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448952",
    "user": "dimpase"
}
```

Replying to [comment:26 dimpase]:
> ok, so the next step would be to try the "normal" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in comment:17.
> 
one quick way to do this is the following:

```
sage: import numpy as np
sage: g=graphs.HigmanSimsGraph()
sage: a=np.matrix(g.adjacency_matrix())
sage: np.save('/tmp/x',a)
```

now we have `a` in `/tmp/x.npy`. So start 

```
./sage --python
```
 
and at its `>>>` prompt do

```
import numpy as np
a=np.load('/tmp/x.npy')
import scipy
import scipy.linalg
eig=scipy.linalg.lapack.dsyevr(a); eig[0]
```




---

archive/issue_comments_448953.json:
```json
{
    "body": "Needless to say, it's a good idea to check that `/tmp/x.npy` is correct, so copying it on a machine where Sage is not broken and testing it as above might be good idea.",
    "created_at": "2021-10-18T20:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448953",
    "user": "dimpase"
}
```

Needless to say, it's a good idea to check that `/tmp/x.npy` is correct, so copying it on a machine where Sage is not broken and testing it as above might be good idea.



---

archive/issue_comments_448954.json:
```json
{
    "body": "> Replying to [comment:27 dimpase]:\n> and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.\n\nThis gives correct results (although I wrote the matrix `g.adjacency_matrix()` to a file and then read it back in and fed it into `np.matrix(...)`).",
    "created_at": "2021-10-18T20:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448954",
    "user": "jhpalmieri"
}
```

> Replying to [comment:27 dimpase]:
> and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.

This gives correct results (although I wrote the matrix `g.adjacency_matrix()` to a file and then read it back in and fed it into `np.matrix(...)`).



---

archive/issue_comments_448955.json:
```json
{
    "body": "So it's not OpenBLAS or SciPy themselves, right?\nSomething else in Sage upsets OpenBLAS (and only OpenBLAS from numpy, right?) on this particular CPU.",
    "created_at": "2021-10-18T20:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448955",
    "user": "dimpase"
}
```

So it's not OpenBLAS or SciPy themselves, right?
Something else in Sage upsets OpenBLAS (and only OpenBLAS from numpy, right?) on this particular CPU.



---

archive/issue_comments_448956.json:
```json
{
    "body": "For what it's worth, I dumped `a` to a file using `np.save(FILE, a)`. Then I loaded it and ran the above list of commands.\n\n- works just fine with `./sage --python`\n- produces the wrong answer with `./sage`",
    "created_at": "2021-10-18T21:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448956",
    "user": "jhpalmieri"
}
```

For what it's worth, I dumped `a` to a file using `np.save(FILE, a)`. Then I loaded it and ran the above list of commands.

- works just fine with `./sage --python`
- produces the wrong answer with `./sage`



---

archive/issue_comments_448957.json:
```json
{
    "body": "And naturally it works fine if I use a version of Sage built with `./configure --with-system-openblas=no`.",
    "created_at": "2021-10-18T21:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448957",
    "user": "jhpalmieri"
}
```

And naturally it works fine if I use a version of Sage built with `./configure --with-system-openblas=no`.



---

archive/issue_comments_448958.json:
```json
{
    "body": "Could `gsl` be involved somehow, rather than `openblas`?",
    "created_at": "2021-10-18T21:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448958",
    "user": "jhpalmieri"
}
```

Could `gsl` be involved somehow, rather than `openblas`?



---

archive/issue_comments_448959.json:
```json
{
    "body": "It need not be something even dependent on openblas that creates this weird CPU state. It could be something using AVX-512, or OpenMP.\n\nUnfortunately Sage isn't modularised enough so that one could just load parts one by one, and check if the bug appears.",
    "created_at": "2021-10-18T21:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448959",
    "user": "dimpase"
}
```

It need not be something even dependent on openblas that creates this weird CPU state. It could be something using AVX-512, or OpenMP.

Unfortunately Sage isn't modularised enough so that one could just load parts one by one, and check if the bug appears.



---

archive/issue_comments_448960.json:
```json
{
    "body": "I built Sage with\n\n```\nexport CFLAGS=\"-L/usr/local/opt/openblas/lib\"\n./configure --with-system-gsl=no\n```\n\nand I am not seeing the errors. This is using homebrew's `openblas`.",
    "created_at": "2021-10-18T22:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448960",
    "user": "jhpalmieri"
}
```

I built Sage with

```
export CFLAGS="-L/usr/local/opt/openblas/lib"
./configure --with-system-gsl=no
```

and I am not seeing the errors. This is using homebrew's `openblas`.



---

archive/issue_comments_448961.json:
```json
{
    "body": "Interesting. First, it's a bug either in spkg-install of GSL, as it demands that `cblas` is known to `pkg-config`, which is not the case here - it can get the same from `openblas`, or somewhere in our hacky procedure of creating .pc files from the one for `openblas`.\n\nSecond, Sage is still on GSL 2.6, but Homebrew is on GSL 2.7.\nThere is #32607 - which supposed to be fixing something GSL 2.7-related (but I am happily running GSL 2.7 on Linux with Sage...)\n\nMatthias has tickets to make GSL optional.",
    "created_at": "2021-10-18T22:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448961",
    "user": "dimpase"
}
```

Interesting. First, it's a bug either in spkg-install of GSL, as it demands that `cblas` is known to `pkg-config`, which is not the case here - it can get the same from `openblas`, or somewhere in our hacky procedure of creating .pc files from the one for `openblas`.

Second, Sage is still on GSL 2.6, but Homebrew is on GSL 2.7.
There is #32607 - which supposed to be fixing something GSL 2.7-related (but I am happily running GSL 2.7 on Linux with Sage...)

Matthias has tickets to make GSL optional.



---

archive/issue_comments_448962.json:
```json
{
    "body": "Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n`pkg-config --libs cblas`, what's the output?\n\nI suspect that \n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n```\n\nin GSL's spkg-install.in should be\n\n```\nsdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n```\n\n\n(`--libs-only-l` doesn't print `-L` flags.)\n\nCan you try the latter line without `CFLAGS` ?",
    "created_at": "2021-10-18T22:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448962",
    "user": "dimpase"
}
```

Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
`pkg-config --libs cblas`, what's the output?

I suspect that 

```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
```

in GSL's spkg-install.in should be

```
sdh_configure LIBS="`pkg-config --libs cblas` -lm"
```


(`--libs-only-l` doesn't print `-L` flags.)

Can you try the latter line without `CFLAGS` ?



---

archive/issue_comments_448963.json:
```json
{
    "body": "Should `pkgconf` be a dependency for `gsl`?",
    "created_at": "2021-10-18T22:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448963",
    "user": "jhpalmieri"
}
```

Should `pkgconf` be a dependency for `gsl`?



---

archive/issue_comments_448964.json:
```json
{
    "body": "Replying to [comment:38 dimpase]:\n> Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n> `pkg-config --libs cblas`, what's the output?\n\n```\n-L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas\n```\n\n> \n> I suspect that \n> {{{\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> }}}\n> in GSL's spkg-install.in should be\n> {{{\n> sdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n> }}}\n> \n> (`--libs-only-l` doesn't print `-L` flags.)\n> \n> Can you try the latter line without `CFLAGS` ?\n\nWill do.",
    "created_at": "2021-10-18T22:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448964",
    "user": "jhpalmieri"
}
```

Replying to [comment:38 dimpase]:
> Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
> `pkg-config --libs cblas`, what's the output?

```
-L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas
```

> 
> I suspect that 
> {{{
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
> }}}
> in GSL's spkg-install.in should be
> {{{
> sdh_configure LIBS="`pkg-config --libs cblas` -lm"
> }}}
> 
> (`--libs-only-l` doesn't print `-L` flags.)
> 
> Can you try the latter line without `CFLAGS` ?

Will do.



---

archive/issue_comments_448965.json:
```json
{
    "body": "As noted in #32587, GSL 2.7 may be built with an option to use old API. This does not happen on Homebrew, see https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gsl.rb\n\nHowever, on Debian Bullseye GSL is still version 2.6, so perhaps\nit's not the version alone that's reponsible.\nhttps://packages.debian.org/source/stable/gsl\n\n----\n\nVincent, could you check the GSL version you're using, and build Sage with system OpenBLAS, but\nwithout GSL, just as John did here?",
    "created_at": "2021-10-19T07:35:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448965",
    "user": "dimpase"
}
```

As noted in #32587, GSL 2.7 may be built with an option to use old API. This does not happen on Homebrew, see https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gsl.rb

However, on Debian Bullseye GSL is still version 2.6, so perhaps
it's not the version alone that's reponsible.
https://packages.debian.org/source/stable/gsl

----

Vincent, could you check the GSL version you're using, and build Sage with system OpenBLAS, but
without GSL, just as John did here?



---

archive/issue_comments_448966.json:
```json
{
    "body": "Replying to [comment:40 jhpalmieri]:\n> Replying to [comment:38 dimpase]:\n> > Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n> > `pkg-config --libs cblas`, what's the output?\n> {{{\n> -L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas\n> }}}\n> > \n> > I suspect that \n> > {{{\n> > sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> > }}}\n> > in GSL's spkg-install.in should be\n> > {{{\n> > sdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n> > }}}\n> > \n> > (`--libs-only-l` doesn't print `-L` flags.)\n> > \n> > Can you try the latter line without `CFLAGS` ?\n> \n> Will do.\n\nPerhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:\n\n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n```\n",
    "created_at": "2021-10-19T15:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448966",
    "user": "dimpase"
}
```

Replying to [comment:40 jhpalmieri]:
> Replying to [comment:38 dimpase]:
> > Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
> > `pkg-config --libs cblas`, what's the output?
> {{{
> -L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas
> }}}
> > 
> > I suspect that 
> > {{{
> > sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
> > }}}
> > in GSL's spkg-install.in should be
> > {{{
> > sdh_configure LIBS="`pkg-config --libs cblas` -lm"
> > }}}
> > 
> > (`--libs-only-l` doesn't print `-L` flags.)
> > 
> > Can you try the latter line without `CFLAGS` ?
> 
> Will do.

Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:


```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
```




---

archive/issue_comments_448967.json:
```json
{
    "body": "Replying to [comment:42 dimpase]:\n> Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:\n> \n> {{{\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n> }}} \n\n`gsl` builds but the `sagelib` package fails to build this way: `ld: library not found for -lopenblas`.",
    "created_at": "2021-10-19T16:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448967",
    "user": "jhpalmieri"
}
```

Replying to [comment:42 dimpase]:
> Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:
> 
> {{{
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
> }}} 

`gsl` builds but the `sagelib` package fails to build this way: `ld: library not found for -lopenblas`.



---

archive/issue_comments_448968.json:
```json
{
    "body": "how about \n\n```diff\n--- a/.homebrew-build-env\n+++ b/.homebrew-build-env\n@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH\n LIBRARY_PATH=\"$HOMEBREW/lib$LIBRARY_PATH\"\n [ -z \"$CPATH\" ] || CPATH=\":${CPATH}\"\n CPATH=\"$HOMEBREW/include$CPATH\"\n-for l in readline bzip2 ntl; do\n+for l in readline bzip2 ntl openblas; do\n     if [ -d \"$HOMEBREW/opt/$l/lib\" ]; then\n         LIBRARY_PATH=\"$HOMEBREW/opt/$l/lib:$LIBRARY_PATH\"\n     fi\n```\n\ni.e. change `.homebrew-build-env` as above, source it, and then run `make build` again.",
    "created_at": "2021-10-19T16:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448968",
    "user": "dimpase"
}
```

how about 

```diff
--- a/.homebrew-build-env
+++ b/.homebrew-build-env
@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH
 LIBRARY_PATH="$HOMEBREW/lib$LIBRARY_PATH"
 [ -z "$CPATH" ] || CPATH=":${CPATH}"
 CPATH="$HOMEBREW/include$CPATH"
-for l in readline bzip2 ntl; do
+for l in readline bzip2 ntl openblas; do
     if [ -d "$HOMEBREW/opt/$l/lib" ]; then
         LIBRARY_PATH="$HOMEBREW/opt/$l/lib:$LIBRARY_PATH"
     fi
```

i.e. change `.homebrew-build-env` as above, source it, and then run `make build` again.



---

archive/issue_comments_448969.json:
```json
{
    "body": "I'm really confused now.\n\n- With the changes you suggested in comment:42 and comment:44 (set LDFLAGS and modify `.homebrew-build-env`), Sage builds, but the example in comment:17 fails and I see the numerical failures in doctesting.\n- If instead I build Sage as in comment:36 (exporting `CFLAGS`), then Sage builds (although with warnings \"clang: warning: argument unused during compilation: '-L/usr/local/opt/openblas/lib' [-Wunused-command-line-argument]\") and the example in comment:17 works. `./sage -tp --long src/sage/matrix` succeeds: no numerical failures.",
    "created_at": "2021-10-19T18:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448969",
    "user": "jhpalmieri"
}
```

I'm really confused now.

- With the changes you suggested in comment:42 and comment:44 (set LDFLAGS and modify `.homebrew-build-env`), Sage builds, but the example in comment:17 fails and I see the numerical failures in doctesting.
- If instead I build Sage as in comment:36 (exporting `CFLAGS`), then Sage builds (although with warnings "clang: warning: argument unused during compilation: '-L/usr/local/opt/openblas/lib' [-Wunused-command-line-argument]") and the example in comment:17 works. `./sage -tp --long src/sage/matrix` succeeds: no numerical failures.



---

archive/issue_comments_448970.json:
```json
{
    "body": "probably \"success\" with gsl comes from it not using openblas at all. You can check by running `otool -L `",
    "created_at": "2021-10-19T20:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448970",
    "user": "dimpase"
}
```

probably "success" with gsl comes from it not using openblas at all. You can check by running `otool -L `



---

archive/issue_comments_448971.json:
```json
{
    "body": "`% otool -L local/lib/libgsl.25.dylib` returns the same thing in each of the two cases (edited to replace the actual path with `$SAGE_ROOT`):\n\n```\n% otool -L local/lib/libgsl.25.dylib \nlocal/lib/libgsl.25.dylib:\n\t$SAGE_ROOT/local/lib/libgsl.25.dylib (compatibility version 26.0.0, current version 26.0.0)\n\t/usr/local/opt/openblas/lib/libopenblas.0.dylib (compatibility version 0.0.0, current version 0.0.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)\n```\n",
    "created_at": "2021-10-19T21:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448971",
    "user": "jhpalmieri"
}
```

`% otool -L local/lib/libgsl.25.dylib` returns the same thing in each of the two cases (edited to replace the actual path with `$SAGE_ROOT`):

```
% otool -L local/lib/libgsl.25.dylib 
local/lib/libgsl.25.dylib:
	$SAGE_ROOT/local/lib/libgsl.25.dylib (compatibility version 26.0.0, current version 26.0.0)
	/usr/local/opt/openblas/lib/libopenblas.0.dylib (compatibility version 0.0.0, current version 0.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)
```




---

archive/issue_comments_448972.json:
```json
{
    "body": "Same with `otool -L local/lib/libgslcblas.0.dylib`.",
    "created_at": "2021-10-19T21:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448972",
    "user": "jhpalmieri"
}
```

Same with `otool -L local/lib/libgslcblas.0.dylib`.



---

archive/issue_comments_448973.json:
```json
{
    "body": "I can only say that exporting `-L` flag in CFLAGS makes little sense to me.\nI'd like to see GSLs config.log when it's set, and when it's not (as in comment:6 are you sure your CFLAGS didn't contain something wrong then?).",
    "created_at": "2021-10-19T21:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448973",
    "user": "dimpase"
}
```

I can only say that exporting `-L` flag in CFLAGS makes little sense to me.
I'd like to see GSLs config.log when it's set, and when it's not (as in comment:6 are you sure your CFLAGS didn't contain something wrong then?).



---

archive/issue_comments_448974.json:
```json
{
    "body": "\n```\n% echo $CFLAGS\n-L/usr/local/opt/openblas/lib\n```\n\nBut this causes other changes in the Sage build: when I set `CFLAGS` manually, then Sage does not add `-O2 -g -march=native`. Maybe one of those flags makes a difference. I'll try to test it out.",
    "created_at": "2021-10-19T22:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448974",
    "user": "jhpalmieri"
}
```


```
% echo $CFLAGS
-L/usr/local/opt/openblas/lib
```

But this causes other changes in the Sage build: when I set `CFLAGS` manually, then Sage does not add `-O2 -g -march=native`. Maybe one of those flags makes a difference. I'll try to test it out.



---

archive/issue_comments_448975.json:
```json
{
    "body": "Attachment [gsl-2.6.log.CFLAGS](tarball://root/attachments/some-uuid/ticket31621/gsl-2.6.log.CFLAGS) by jhpalmieri created at 2021-10-19 22:36:27",
    "created_at": "2021-10-19T22:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448975",
    "user": "jhpalmieri"
}
```

Attachment [gsl-2.6.log.CFLAGS](tarball://root/attachments/some-uuid/ticket31621/gsl-2.6.log.CFLAGS) by jhpalmieri created at 2021-10-19 22:36:27



---

archive/issue_comments_448976.json:
```json
{
    "body": "Attachment [gsl-2.6.log.do-not-set-CFLAGS](tarball://root/attachments/some-uuid/ticket31621/gsl-2.6.log.do-not-set-CFLAGS) by dimpase created at 2021-10-20 09:41:23\n\nI guess it's `-march=native` to blame for this. Overwriting `CFLAGS` to exclude it for `gsl` makes a difference (see  #27122), and we saw this a number of times lately in regard of `openblas`. Not all Xeon CPUs are created equal. :/",
    "created_at": "2021-10-20T09:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448976",
    "user": "dimpase"
}
```

Attachment [gsl-2.6.log.do-not-set-CFLAGS](tarball://root/attachments/some-uuid/ticket31621/gsl-2.6.log.do-not-set-CFLAGS) by dimpase created at 2021-10-20 09:41:23

I guess it's `-march=native` to blame for this. Overwriting `CFLAGS` to exclude it for `gsl` makes a difference (see  #27122), and we saw this a number of times lately in regard of `openblas`. Not all Xeon CPUs are created equal. :/



---

archive/issue_comments_448977.json:
```json
{
    "body": "After a `make openblas` sage fails to start with\n\n```\n~/sage/local/lib/python3.9/site-packages/sage/matrix/matrix_space.py in <module>\n     42 \n---> 43 from . import matrix_modn_sparse\n        global matrix_modn_sparse = undefined\n     44\n\nImportError: /lib/x86_64-linux-gnu/libblas.so.3: undefined symbol: gotoblas\n```\n\nI thought that this would have solved my problem but instead created another one.",
    "created_at": "2021-10-20T17:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448977",
    "user": "vdelecroix"
}
```

After a `make openblas` sage fails to start with

```
~/sage/local/lib/python3.9/site-packages/sage/matrix/matrix_space.py in <module>
     42 
---> 43 from . import matrix_modn_sparse
        global matrix_modn_sparse = undefined
     44

ImportError: /lib/x86_64-linux-gnu/libblas.so.3: undefined symbol: gotoblas
```

I thought that this would have solved my problem but instead created another one.



---

archive/issue_comments_448978.json:
```json
{
    "body": "have you rebuilt sagelib?\n\n```\nmake sagelib-clean && make build\n```\n",
    "created_at": "2021-10-20T19:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448978",
    "user": "dimpase"
}
```

have you rebuilt sagelib?

```
make sagelib-clean && make build
```




---

archive/issue_comments_448979.json:
```json
{
    "body": "Separately from the other issues, should we change gsl's `spkg-install.in` to use\n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n```\n\nas suggested in comment:42? And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?",
    "created_at": "2021-10-21T19:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448979",
    "user": "jhpalmieri"
}
```

Separately from the other issues, should we change gsl's `spkg-install.in` to use

```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
```

as suggested in comment:42? And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?



---

archive/issue_comments_448980.json:
```json
{
    "body": "Replying to [comment:54 jhpalmieri]:\n> Separately from the other issues, should we change gsl's `spkg-install.in` to use\n> {{{\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n> }}}\n> as suggested in comment:42?\nyes\n\n> And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?\nyes (an order-only dependency, just like for `r`).",
    "created_at": "2021-10-22T09:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448980",
    "user": "dimpase"
}
```

Replying to [comment:54 jhpalmieri]:
> Separately from the other issues, should we change gsl's `spkg-install.in` to use
> {{{
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
> }}}
> as suggested in comment:42?
yes

> And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?
yes (an order-only dependency, just like for `r`).



---

archive/issue_comments_448981.json:
```json
{
    "body": "By the way, if I build all of Sage with `export CFLAGS='-O2 -g'`, just with a plain `./configure` so using all of homebrew's packages, tests pass. So allowing  `-march=native` to remain (by not explicitly setting `CFLAGS`) on this machine causes problems in building parts of Sage.",
    "created_at": "2021-10-22T21:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448981",
    "user": "jhpalmieri"
}
```

By the way, if I build all of Sage with `export CFLAGS='-O2 -g'`, just with a plain `./configure` so using all of homebrew's packages, tests pass. So allowing  `-march=native` to remain (by not explicitly setting `CFLAGS`) on this machine causes problems in building parts of Sage.



---

archive/issue_comments_448982.json:
```json
{
    "body": "Shouldn't `CPPFLAGS` also be set using pkgconfig?",
    "created_at": "2021-10-23T22:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448982",
    "user": "mkoeppe"
}
```

Shouldn't `CPPFLAGS` also be set using pkgconfig?



---

archive/issue_comments_448983.json:
```json
{
    "body": "(in the branch of #32587)",
    "created_at": "2021-10-24T20:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448983",
    "user": "mkoeppe"
}
```

(in the branch of #32587)



---

archive/issue_comments_448984.json:
```json
{
    "body": "Replying to [comment:57 mkoeppe]:\n> Shouldn't `CPPFLAGS` also be set using pkgconfig?\n\nIt builds without that, but please modify that branch if you think it's a good idea.",
    "created_at": "2021-10-27T04:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448984",
    "user": "jhpalmieri"
}
```

Replying to [comment:57 mkoeppe]:
> Shouldn't `CPPFLAGS` also be set using pkgconfig?

It builds without that, but please modify that branch if you think it's a good idea.



---

archive/issue_comments_448985.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-11-13T17:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448985",
    "user": "mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_448986.json:
```json
{
    "body": "Still the same in 9.5.beta6",
    "created_at": "2021-11-13T17:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448986",
    "user": "mkoeppe"
}
```

Still the same in 9.5.beta6



---

archive/issue_comments_448987.json:
```json
{
    "body": "What's the status here?",
    "created_at": "2021-12-21T17:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448987",
    "user": "mkoeppe"
}
```

What's the status here?



---

archive/issue_comments_448988.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2022-01-10T23:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448988",
    "user": "mkoeppe"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_448989.json:
```json
{
    "body": "We can no longer test `ubuntu-groovy`, and the failures do not show up in any other Debian and Ubuntu variants tested in https://github.com/sagemath/sage/actions/runs/1673712139 (for 9.5.rc0). \n\nSo perhaps we can close it?",
    "created_at": "2022-01-10T23:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448989",
    "user": "mkoeppe"
}
```

We can no longer test `ubuntu-groovy`, and the failures do not show up in any other Debian and Ubuntu variants tested in https://github.com/sagemath/sage/actions/runs/1673712139 (for 9.5.rc0). 

So perhaps we can close it?



---

archive/issue_comments_448990.json:
```json
{
    "body": "Seen again in 9.7.rc0 on `debian-bullseye-standard`\nhttps://github.com/sagemath/sage/runs/8104739123?check_suite_focus=true",
    "created_at": "2022-09-02T04:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448990",
    "user": "mkoeppe"
}
```

Seen again in 9.7.rc0 on `debian-bullseye-standard`
https://github.com/sagemath/sage/runs/8104739123?check_suite_focus=true



---

archive/issue_comments_448991.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-09-02T04:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31384",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31384#issuecomment-448991",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.
