# Issue 15100: Speed up ulp() method of real_mpfr.pyx

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-10-28 12:32:44

CC:  zimmerma




---

Comment by jdemeyer created at 2013-10-28 13:35:49

Changing status from new to needs_review.


---

Comment by zimmerma created at 2013-10-30 09:58:09

now in vacation, I will look at it next week, unless someone beats me.

Paul


---

Comment by zimmerma created at 2013-11-05 07:23:59

I tested the patch against Sage 5.12, and got the following failures

```
sage -t --long __init__.pyc  # AttributeError in doctesting framework
sage -t --long env.pyc  # AttributeError in doctesting framework
sage -t --long version.pyc  # AttributeError in doctesting framework
sage -t --long tests/interrupt.pyx  # Time out
sage -t --long tests/cmdline.py  # 11 doctests failed
sage -t --long calculus/desolvers.py  # 8 doctests failed
sage -t --long misc/interpreter.py  # 1 doctest failed
sage -t --long misc/trace.py  # 2 doctests failed
```

This is under Ubuntu 12.04. I can give more detail if needed.

Paul


---

Comment by jdemeyer created at 2013-11-05 07:37:15

I don't know how you ran the doctests, but it must have been in an invalid way because the errors clearly have nothing to do with the patch and you're testing `.pyc` files which are normally not tested (I bet you would get the same results without my patch).

So please run, from `SAGE_ROOT` something like

```
$ make ptestlong
```

or

```
$ ./sage -t --long --all
```

or

```
$ ./sage -t --long devel/sage/sage  # Skipping notebook and doc
```



---

Comment by jdemeyer created at 2013-11-05 07:37:52

Replying to [comment:4 zimmerma]:
> I can give more detail if needed.
I'd like to know which command you used to get those results.


---

Comment by zimmerma created at 2013-11-05 07:45:20

> I'd like to know which command you used to get those results.

in `devel/sage-15337/sage` I ran `../../../sage -tp 4 --long *`, which seems equivalent to the 3rd form above.

Paul


---

Comment by zimmerma created at 2013-11-05 09:51:44

All doctests pass with `./sage -tp 4 --long devel/sage-15337/sage`.
I will now start my review.

Paul


---

Comment by zimmerma created at 2013-11-05 09:58:41

I confirm the speedup for normal numbers. Before:

```
sage: a=RealField(10**6).one(); timeit('a.ulp()')
625 loops, best of 3: 118 µs per loop
```

After:

```
sage: a=RealField(10**6).one(); timeit('a.ulp()')
625 loops, best of 3: 7.74 µs per loop
```


However for `+Inf` I notice a slowdown. Before:

```
sage: a=RealField(10**6)("Inf"); timeit('a.ulp()')
625 loops, best of 3: 101 ns per loop
```

After:

```
sage: a=RealField(10**6)("Inf"); timeit('a.ulp()')
625 loops, best of 3: 330 ns per loop
```

For `-Inf` it is faster now, and I see no difference for `NaN`.
Paul


---

Comment by jdemeyer created at 2013-11-05 10:42:30

The slowdown for `+Inf` was because we used to simply return `self` in that case. My code instead always creates a new number, so the slowdown you see is the overhead of creating a new number. However, I personally prefer the current code, which is simpler but not optimal for `+Inf` (which should be a rare case anyway). I don't think it is justified to make the code more complicated to deal with the case of `+Inf` in a special way.


---

Comment by zimmerma created at 2013-11-05 14:30:24

Changing status from needs_review to needs_work.


---

Comment by zimmerma created at 2013-11-05 14:30:24

"Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.

I don't see the logic of returning `self` for NaN but not for infinities.

Since the patch also adds tests for `fp_rank` (which I discovered) I tested it too:

```
sage: a=RR(0).ulp()
sage: a.exact_rational()
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-22-2b55db8a739a> in <module>()
----> 1 a.exact_rational()

/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/real_mpfr.so in sage.rings.real_mpfr.RealNumber.exact_rational (sage/rings/real_mpfr.c:18776)()

/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14022)()

RuntimeError: Segmentation fault
```


Finally this looks strange:

```
sage: a=RR(0).ulp()
sage: a.str(16)
'1.0000000000000`@`-1152921504606846976'
sage: b=a.nextabove()
sage: b.str(16)
'1.0000000000001`@`-1152921504606846976'
```

If `a` is the smallest positive non-zero number, then the next number should be `2*a`. In other words, the difference between two floating-point numbers is always a multiple of `a` (and thus always a floating-point number), which is not the case here:

```
sage: b-a
0.000000000000000
```


Paul


---

Comment by jdemeyer created at 2013-11-06 17:09:29

Replying to [comment:11 zimmerma]:
> "Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.
Fair enough, this documentation should be fixed.

> I don't see the logic of returning `self` for NaN but not for infinities.
So what do you prefer: never returning `self`? returning `self` for `NaN` and `+Inf` but not for `-Inf`?

> Since the patch also adds tests for `fp_rank` (which I discovered)
That's an indepedent bug deserving a new ticket: #15363.

> If `a` is the smallest positive non-zero number, then the next number should be `2*a`.
In MPFR, this isn't true since MPFR doesn't have denormal numbers.


---

Comment by jdemeyer created at 2013-11-07 08:46:02

Changing status from needs_work to needs_review.


---

Comment by zimmerma created at 2013-11-08 13:46:54

I will look at that one once I complete my review of #15363.

Paul


---

Comment by zimmerma created at 2013-11-12 15:35:17

> So what do you prefer: never returning self? returning self for NaN and +Inf but not for -Inf?

I would prefer consistency: either always returning self, or never returning self (unless there is a good reason for not being coherent).

While playing with ulp I noticed something strange:

```
sage: a=RDF(0)
sage: a, a.ulp()
(0.0, 4.94065645841e-324)
sage: b, b.ulp()
(4.94065645841e-324, 0.0)
```


The same holds with RR:

```
sage: a=RR(0)
sage: a, a.ulp()
(0.000000000000000, 8.50969131174084e-1388255822130839284)
sage: b=a.ulp()
sage: b, b.ulp()
(8.50969131174084e-1388255822130839284, 0.000000000000000)
```


Finally:

> In MPFR, this isn't true since MPFR doesn't have denormal numbers.

agreed.

Paul


---

Comment by zimmerma created at 2013-11-13 09:44:02

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2013-11-13 09:44:02

I retract part of my comment [comment:17] since it works correctly with the patch:

```
sage: a=RDF(0)
sage: a, a.ulp()
(0.0, 4.94065645841e-324)
sage: b=a.ulp()
sage: b, b.ulp()
(4.94065645841e-324, 4.94065645841e-324)
```

and with RR:

```
sage: a=RR(0)
sage: a, a.ulp()
(0.000000000000000, 8.50969131174084e-1388255822130839284)
sage: b=a.ulp()
sage: b, b.ulp()
(8.50969131174084e-1388255822130839284, 8.50969131174084e-1388255822130839284)
```


Thus the only remaining issue is whether we return self or a new object.
Since this is a minor issue, I give a positive review.

Paul


---

Attachment


---

Comment by jdemeyer created at 2013-11-13 16:32:26

I made the additional change

```diff
diff --git a/sage/rings/real_double.pyx b/sage/rings/real_double.pyx
--- a/sage/rings/real_double.pyx
+++ b/sage/rings/real_double.pyx
`@``@` -692,7 +692,7 `@``@`
             +infinity
             sage: (-a).ulp()
             +infinity
-            sage: a = RR('nan')
+            sage: a = RDF('nan')
             sage: a.ulp() is a
             True
 
```

in the doctest for the method `ulp()` of `RDF`.


---

Comment by zimmerma created at 2013-11-13 16:45:34

> I made the additional change [...]

correct, sorry for not having seen this.

Paul


---

Comment by jdemeyer created at 2013-11-14 07:53:14

Resolution: fixed
