# Issue 15100: Speed up ulp() method of real_mpfr.pyx

archive/issues_015100.json:
```json
{
    "body": "CC:  @zimmermann6\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15337\n\n",
    "created_at": "2013-10-28T12:32:44Z",
    "labels": [
        "basic arithmetic",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Speed up ulp() method of real_mpfr.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15100",
    "user": "@jdemeyer"
}
```
CC:  @zimmermann6



Issue created by migration from https://trac.sagemath.org/ticket/15337





---

archive/issue_comments_193557.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-28T13:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193557",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_193558.json:
```json
{
    "body": "now in vacation, I will look at it next week, unless someone beats me.\n\nPaul",
    "created_at": "2013-10-30T09:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193558",
    "user": "@zimmermann6"
}
```

now in vacation, I will look at it next week, unless someone beats me.

Paul



---

archive/issue_comments_193559.json:
```json
{
    "body": "I tested the patch against Sage 5.12, and got the following failures\n\n```\nsage -t --long __init__.pyc  # AttributeError in doctesting framework\nsage -t --long env.pyc  # AttributeError in doctesting framework\nsage -t --long version.pyc  # AttributeError in doctesting framework\nsage -t --long tests/interrupt.pyx  # Time out\nsage -t --long tests/cmdline.py  # 11 doctests failed\nsage -t --long calculus/desolvers.py  # 8 doctests failed\nsage -t --long misc/interpreter.py  # 1 doctest failed\nsage -t --long misc/trace.py  # 2 doctests failed\n```\n\nThis is under Ubuntu 12.04. I can give more detail if needed.\n\nPaul",
    "created_at": "2013-11-05T07:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193559",
    "user": "@zimmermann6"
}
```

I tested the patch against Sage 5.12, and got the following failures

```
sage -t --long __init__.pyc  # AttributeError in doctesting framework
sage -t --long env.pyc  # AttributeError in doctesting framework
sage -t --long version.pyc  # AttributeError in doctesting framework
sage -t --long tests/interrupt.pyx  # Time out
sage -t --long tests/cmdline.py  # 11 doctests failed
sage -t --long calculus/desolvers.py  # 8 doctests failed
sage -t --long misc/interpreter.py  # 1 doctest failed
sage -t --long misc/trace.py  # 2 doctests failed
```

This is under Ubuntu 12.04. I can give more detail if needed.

Paul



---

archive/issue_comments_193560.json:
```json
{
    "body": "I don't know how you ran the doctests, but it must have been in an invalid way because the errors clearly have nothing to do with the patch and you're testing `.pyc` files which are normally not tested (I bet you would get the same results without my patch).\n\nSo please run, from `SAGE_ROOT` something like\n\n```\n$ make ptestlong\n```\n\nor\n\n```\n$ ./sage -t --long --all\n```\n\nor\n\n```\n$ ./sage -t --long devel/sage/sage  # Skipping notebook and doc\n```\n",
    "created_at": "2013-11-05T07:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193560",
    "user": "@jdemeyer"
}
```

I don't know how you ran the doctests, but it must have been in an invalid way because the errors clearly have nothing to do with the patch and you're testing `.pyc` files which are normally not tested (I bet you would get the same results without my patch).

So please run, from `SAGE_ROOT` something like

```
$ make ptestlong
```

or

```
$ ./sage -t --long --all
```

or

```
$ ./sage -t --long devel/sage/sage  # Skipping notebook and doc
```




---

archive/issue_comments_193561.json:
```json
{
    "body": "Replying to [comment:4 zimmerma]:\n> I can give more detail if needed.\nI'd like to know which command you used to get those results.",
    "created_at": "2013-11-05T07:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193561",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 zimmerma]:
> I can give more detail if needed.
I'd like to know which command you used to get those results.



---

archive/issue_comments_193562.json:
```json
{
    "body": "> I'd like to know which command you used to get those results.\n\nin `devel/sage-15337/sage` I ran `../../../sage -tp 4 --long *`, which seems equivalent to the 3rd form above.\n\nPaul",
    "created_at": "2013-11-05T07:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193562",
    "user": "@zimmermann6"
}
```

> I'd like to know which command you used to get those results.

in `devel/sage-15337/sage` I ran `../../../sage -tp 4 --long *`, which seems equivalent to the 3rd form above.

Paul



---

archive/issue_comments_193563.json:
```json
{
    "body": "All doctests pass with `./sage -tp 4 --long devel/sage-15337/sage`.\nI will now start my review.\n\nPaul",
    "created_at": "2013-11-05T09:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193563",
    "user": "@zimmermann6"
}
```

All doctests pass with `./sage -tp 4 --long devel/sage-15337/sage`.
I will now start my review.

Paul



---

archive/issue_comments_193564.json:
```json
{
    "body": "I confirm the speedup for normal numbers. Before:\n\n```\nsage: a=RealField(10**6).one(); timeit('a.ulp()')\n625 loops, best of 3: 118 \u00b5s per loop\n```\n\nAfter:\n\n```\nsage: a=RealField(10**6).one(); timeit('a.ulp()')\n625 loops, best of 3: 7.74 \u00b5s per loop\n```\n\n\nHowever for `+Inf` I notice a slowdown. Before:\n\n```\nsage: a=RealField(10**6)(\"Inf\"); timeit('a.ulp()')\n625 loops, best of 3: 101 ns per loop\n```\n\nAfter:\n\n```\nsage: a=RealField(10**6)(\"Inf\"); timeit('a.ulp()')\n625 loops, best of 3: 330 ns per loop\n```\n\nFor `-Inf` it is faster now, and I see no difference for `NaN`.\nPaul",
    "created_at": "2013-11-05T09:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193564",
    "user": "@zimmermann6"
}
```

I confirm the speedup for normal numbers. Before:

```
sage: a=RealField(10**6).one(); timeit('a.ulp()')
625 loops, best of 3: 118 µs per loop
```

After:

```
sage: a=RealField(10**6).one(); timeit('a.ulp()')
625 loops, best of 3: 7.74 µs per loop
```


However for `+Inf` I notice a slowdown. Before:

```
sage: a=RealField(10**6)("Inf"); timeit('a.ulp()')
625 loops, best of 3: 101 ns per loop
```

After:

```
sage: a=RealField(10**6)("Inf"); timeit('a.ulp()')
625 loops, best of 3: 330 ns per loop
```

For `-Inf` it is faster now, and I see no difference for `NaN`.
Paul



---

archive/issue_comments_193565.json:
```json
{
    "body": "The slowdown for `+Inf` was because we used to simply return `self` in that case. My code instead always creates a new number, so the slowdown you see is the overhead of creating a new number. However, I personally prefer the current code, which is simpler but not optimal for `+Inf` (which should be a rare case anyway). I don't think it is justified to make the code more complicated to deal with the case of `+Inf` in a special way.",
    "created_at": "2013-11-05T10:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193565",
    "user": "@jdemeyer"
}
```

The slowdown for `+Inf` was because we used to simply return `self` in that case. My code instead always creates a new number, so the slowdown you see is the overhead of creating a new number. However, I personally prefer the current code, which is simpler but not optimal for `+Inf` (which should be a rare case anyway). I don't think it is justified to make the code more complicated to deal with the case of `+Inf` in a special way.



---

archive/issue_comments_193566.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-11-05T14:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193566",
    "user": "@zimmermann6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_193567.json:
```json
{
    "body": "\"Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)\": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.\n\nI don't see the logic of returning `self` for NaN but not for infinities.\n\nSince the patch also adds tests for `fp_rank` (which I discovered) I tested it too:\n\n```\nsage: a=RR(0).ulp()\nsage: a.exact_rational()\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-22-2b55db8a739a> in <module>()\n----> 1 a.exact_rational()\n\n/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/real_mpfr.so in sage.rings.real_mpfr.RealNumber.exact_rational (sage/rings/real_mpfr.c:18776)()\n\n/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14022)()\n\nRuntimeError: Segmentation fault\n```\n\n\nFinally this looks strange:\n\n```\nsage: a=RR(0).ulp()\nsage: a.str(16)\n'1.0000000000000@-1152921504606846976'\nsage: b=a.nextabove()\nsage: b.str(16)\n'1.0000000000001@-1152921504606846976'\n```\n\nIf `a` is the smallest positive non-zero number, then the next number should be `2*a`. In other words, the difference between two floating-point numbers is always a multiple of `a` (and thus always a floating-point number), which is not the case here:\n\n```\nsage: b-a\n0.000000000000000\n```\n\n\nPaul",
    "created_at": "2013-11-05T14:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193567",
    "user": "@zimmermann6"
}
```

"Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.

I don't see the logic of returning `self` for NaN but not for infinities.

Since the patch also adds tests for `fp_rank` (which I discovered) I tested it too:

```
sage: a=RR(0).ulp()
sage: a.exact_rational()
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-22-2b55db8a739a> in <module>()
----> 1 a.exact_rational()

/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/real_mpfr.so in sage.rings.real_mpfr.RealNumber.exact_rational (sage/rings/real_mpfr.c:18776)()

/localdisk/tmp/sage-5.12/local/lib/python2.7/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14022)()

RuntimeError: Segmentation fault
```


Finally this looks strange:

```
sage: a=RR(0).ulp()
sage: a.str(16)
'1.0000000000000@-1152921504606846976'
sage: b=a.nextabove()
sage: b.str(16)
'1.0000000000001@-1152921504606846976'
```

If `a` is the smallest positive non-zero number, then the next number should be `2*a`. In other words, the difference between two floating-point numbers is always a multiple of `a` (and thus always a floating-point number), which is not the case here:

```
sage: b-a
0.000000000000000
```


Paul



---

archive/issue_comments_193568.json:
```json
{
    "body": "Replying to [comment:11 zimmerma]:\n> \"Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)\": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.\nFair enough, this documentation should be fixed.\n\n> I don't see the logic of returning `self` for NaN but not for infinities.\nSo what do you prefer: never returning `self`? returning `self` for `NaN` and `+Inf` but not for `-Inf`?\n\n> Since the patch also adds tests for `fp_rank` (which I discovered)\nThat's an indepedent bug deserving a new ticket: #15363.\n\n> If `a` is the smallest positive non-zero number, then the next number should be `2*a`.\nIn MPFR, this isn't true since MPFR doesn't have denormal numbers.",
    "created_at": "2013-11-06T17:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193568",
    "user": "@jdemeyer"
}
```

Replying to [comment:11 zimmerma]:
> "Adding or subtracting something less than half an ulp always gives the same number (unless the number is exactly a power of 2...)": the case of the opposite of a power of 2 is missing here, also this assumes the rounding mode is to nearest.
Fair enough, this documentation should be fixed.

> I don't see the logic of returning `self` for NaN but not for infinities.
So what do you prefer: never returning `self`? returning `self` for `NaN` and `+Inf` but not for `-Inf`?

> Since the patch also adds tests for `fp_rank` (which I discovered)
That's an indepedent bug deserving a new ticket: #15363.

> If `a` is the smallest positive non-zero number, then the next number should be `2*a`.
In MPFR, this isn't true since MPFR doesn't have denormal numbers.



---

archive/issue_comments_193569.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-07T08:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193569",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_193570.json:
```json
{
    "body": "I will look at that one once I complete my review of #15363.\n\nPaul",
    "created_at": "2013-11-08T13:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193570",
    "user": "@zimmermann6"
}
```

I will look at that one once I complete my review of #15363.

Paul



---

archive/issue_comments_193571.json:
```json
{
    "body": "> So what do you prefer: never returning self? returning self for NaN and +Inf but not for -Inf?\n\nI would prefer consistency: either always returning self, or never returning self (unless there is a good reason for not being coherent).\n\nWhile playing with ulp I noticed something strange:\n\n```\nsage: a=RDF(0)\nsage: a, a.ulp()\n(0.0, 4.94065645841e-324)\nsage: b, b.ulp()\n(4.94065645841e-324, 0.0)\n```\n\n\nThe same holds with RR:\n\n```\nsage: a=RR(0)\nsage: a, a.ulp()\n(0.000000000000000, 8.50969131174084e-1388255822130839284)\nsage: b=a.ulp()\nsage: b, b.ulp()\n(8.50969131174084e-1388255822130839284, 0.000000000000000)\n```\n\n\nFinally:\n\n> In MPFR, this isn't true since MPFR doesn't have denormal numbers.\n\nagreed.\n\nPaul",
    "created_at": "2013-11-12T15:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193571",
    "user": "@zimmermann6"
}
```

> So what do you prefer: never returning self? returning self for NaN and +Inf but not for -Inf?

I would prefer consistency: either always returning self, or never returning self (unless there is a good reason for not being coherent).

While playing with ulp I noticed something strange:

```
sage: a=RDF(0)
sage: a, a.ulp()
(0.0, 4.94065645841e-324)
sage: b, b.ulp()
(4.94065645841e-324, 0.0)
```


The same holds with RR:

```
sage: a=RR(0)
sage: a, a.ulp()
(0.000000000000000, 8.50969131174084e-1388255822130839284)
sage: b=a.ulp()
sage: b, b.ulp()
(8.50969131174084e-1388255822130839284, 0.000000000000000)
```


Finally:

> In MPFR, this isn't true since MPFR doesn't have denormal numbers.

agreed.

Paul



---

archive/issue_comments_193572.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-13T09:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193572",
    "user": "@zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_193573.json:
```json
{
    "body": "I retract part of my comment [comment:17] since it works correctly with the patch:\n\n```\nsage: a=RDF(0)\nsage: a, a.ulp()\n(0.0, 4.94065645841e-324)\nsage: b=a.ulp()\nsage: b, b.ulp()\n(4.94065645841e-324, 4.94065645841e-324)\n```\n\nand with RR:\n\n```\nsage: a=RR(0)\nsage: a, a.ulp()\n(0.000000000000000, 8.50969131174084e-1388255822130839284)\nsage: b=a.ulp()\nsage: b, b.ulp()\n(8.50969131174084e-1388255822130839284, 8.50969131174084e-1388255822130839284)\n```\n\n\nThus the only remaining issue is whether we return self or a new object.\nSince this is a minor issue, I give a positive review.\n\nPaul",
    "created_at": "2013-11-13T09:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193573",
    "user": "@zimmermann6"
}
```

I retract part of my comment [comment:17] since it works correctly with the patch:

```
sage: a=RDF(0)
sage: a, a.ulp()
(0.0, 4.94065645841e-324)
sage: b=a.ulp()
sage: b, b.ulp()
(4.94065645841e-324, 4.94065645841e-324)
```

and with RR:

```
sage: a=RR(0)
sage: a, a.ulp()
(0.000000000000000, 8.50969131174084e-1388255822130839284)
sage: b=a.ulp()
sage: b, b.ulp()
(8.50969131174084e-1388255822130839284, 8.50969131174084e-1388255822130839284)
```


Thus the only remaining issue is whether we return self or a new object.
Since this is a minor issue, I give a positive review.

Paul



---

archive/issue_comments_193574.json:
```json
{
    "body": "Attachment [15337_ulp.patch](tarball://root/attachments/some-uuid/ticket15337/15337_ulp.patch) by @jdemeyer created at 2013-11-13 16:30:51",
    "created_at": "2013-11-13T16:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193574",
    "user": "@jdemeyer"
}
```

Attachment [15337_ulp.patch](tarball://root/attachments/some-uuid/ticket15337/15337_ulp.patch) by @jdemeyer created at 2013-11-13 16:30:51



---

archive/issue_comments_193575.json:
```json
{
    "body": "I made the additional change\n\n```diff\ndiff --git a/sage/rings/real_double.pyx b/sage/rings/real_double.pyx\n--- a/sage/rings/real_double.pyx\n+++ b/sage/rings/real_double.pyx\n@@ -692,7 +692,7 @@\n             +infinity\n             sage: (-a).ulp()\n             +infinity\n-            sage: a = RR('nan')\n+            sage: a = RDF('nan')\n             sage: a.ulp() is a\n             True\n \n```\n\nin the doctest for the method `ulp()` of `RDF`.",
    "created_at": "2013-11-13T16:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193575",
    "user": "@jdemeyer"
}
```

I made the additional change

```diff
diff --git a/sage/rings/real_double.pyx b/sage/rings/real_double.pyx
--- a/sage/rings/real_double.pyx
+++ b/sage/rings/real_double.pyx
@@ -692,7 +692,7 @@
             +infinity
             sage: (-a).ulp()
             +infinity
-            sage: a = RR('nan')
+            sage: a = RDF('nan')
             sage: a.ulp() is a
             True
 
```

in the doctest for the method `ulp()` of `RDF`.



---

archive/issue_comments_193576.json:
```json
{
    "body": "> I made the additional change [...]\n\ncorrect, sorry for not having seen this.\n\nPaul",
    "created_at": "2013-11-13T16:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193576",
    "user": "@zimmermann6"
}
```

> I made the additional change [...]

correct, sorry for not having seen this.

Paul



---

archive/issue_comments_193577.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-11-14T07:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15100#issuecomment-193577",
    "user": "@jdemeyer"
}
```

Resolution: fixed
