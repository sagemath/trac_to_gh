# Issue 16805: Improvement to subsets_with_hereditary_property

Issue created by migration from https://trac.sagemath.org/ticket/17042

Original creator: ncohen

Original creation time: 2014-09-25 16:27:48

CC:  vinceknight kcrisman dimpase jdemeyer nthiery vdelecroix jhpalmieri

I just noticed something useful I could use for my current problem, and it may also be useful to others. I hope it's not too "custom".

It can also be applied to Dima's example in the doc, as in his case the obstructions have size 3.

Nathann


---

Comment by ncohen created at 2014-09-25 16:28:13

Changing status from new to needs_review.


---

Comment by git created at 2014-09-25 16:28:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2014-09-25 18:21:09

In the same vein, don't you want to have `min_obstruction_size`, too? I.e. if you know that your function returns true on any set of size at most that, you shouldn't even call it.


---

Comment by ncohen created at 2014-09-26 08:13:54

Yo !

> In the same vein, don't you want to have `min_obstruction_size`, too? I.e. if you know that your function returns true on any set of size at most that, you shouldn't even call it.

Well, it is true but in this case you can change the function itself to always return True on <min_size input. While if you do the same with the max_size, your function is not monotone anymore.

Well, it cannot hurt. Add a commit if you like.

Nathann


---

Comment by dimpase created at 2014-09-26 08:40:53

You haven't added `max_obstruction_size` parameter to the `SimplicialComplex` constructor.

(and as soon as it is there, you can speed up the long doctest I added)


---

Comment by dimpase created at 2014-09-26 08:40:53

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-09-26 08:42:04

> You haven't added `max_obstruction_size` parameter to the `SimplicialComplex` constructor.
> 
> (and as soon as it is there, you can speed up the long doctest I added)

I did not intend to. You can also see I did not expose the 'ncpus' argument. Just thought I would keep the constructor simple... What do you think ?

Nathann


---

Comment by ncohen created at 2014-09-26 08:44:07

That's also why I put a link from the constructor to this function, so that interested users can find it.

Nathann


---

Comment by ncohen created at 2014-09-26 08:48:05

By the way

```
sage: %time  l1=list(subsets_with_hereditary_property(lambda S:not any(Set(S).intersection(x).cardinality()>2 for x in l), range(21)))
CPU times: user 7.98 s, sys: 36 ms, total: 8.02 s
Wall time: 7.96 s
sage: %time  l2=list(subsets_with_hereditary_property(lambda S:not any(len(set(S).intersection(x))>2 for x in l), range(21)))         
CPU times: user 436 ms, sys: 60 ms, total: 496 ms
Wall time: 426 ms
sage: l1==l2
True
```


`Set->set`. never use combinat code if you can avoid it.

Nathann


---

Comment by ncohen created at 2014-09-26 08:49:59

This being said the combinat code is better to observe the speedups `:-D`


```
sage: %time  l1=list(subsets_with_hereditary_property(lambda S:not any(Set(S).intersection(x).cardinality()>2 for x in l), range(21)))                       
CPU times: user 7.97 s, sys: 72 ms, total: 8.04 s
Wall time: 7.96 s
sage: %time  l2=list(subsets_with_hereditary_property(lambda S:not any(Set(S).intersection(x).cardinality()>2 for x in l), range(21),max_obstruction_size=3))
CPU times: user 2.46 s, sys: 44 ms, total: 2.51 s
Wall time: 2.43 s
sage: l1==l2
True
```



---

Comment by dimpase created at 2014-09-26 09:22:58

Replying to [comment:6 ncohen]:
> > You haven't added `max_obstruction_size` parameter to the `SimplicialComplex` constructor.
> > 
> > (and as soon as it is there, you can speed up the long doctest I added)
> 
> I did not intend to. You can also see I did not expose the 'ncpus' argument. Just thought I would keep the constructor simple... What do you think ?

OK, then keep it as it is. But could you do the changes Set->set in that doctest?


---

Comment by ncohen created at 2014-09-26 09:24:42

> OK, then keep it as it is. But could you do the changes Set->set in that doctest?

Of course !

Nathann


---

Comment by ncohen created at 2014-09-26 09:33:26

It still takes a LONG time afterwards, because SimplicialComplex removes non-maximal faces `-_-`


```
sage: %time SimplicialComplex(from_characteristic_function=(f, range(21)))
CPU times: user 6.2 s, sys: 184 ms, total: 6.38 s
Wall time: 6.34 s
Simplicial complex with 21 vertices and 168 facets
```


Nathann


---

Comment by ncohen created at 2014-09-26 09:57:24

Fixed


```
sage: l=map(Set, designs.ProjectiveGeometryDesign(2,1,GF(4,name='a'))) 
sage: f = lambda S: not any(len(set(S).intersection(x))>2 for x in l)
sage: %time SimplicialComplex(from_characteristic_function=(f, range(21)))
CPU times: user 584 ms, sys: 4 ms, total: 588 ms
Wall time: 587 ms
Simplicial complex with 21 vertices and 168 facets
```


It is like everybody has gave up thinking of algorithms.

Maybe I should change my job. I would be more useful to the world going over other people's loops.

Anyway, the constructor is now faster. It could be made faster, but at the cost of trying to understand why there is a `sort_faces` flag in this constructor, and I am convinced that it would make me angry.

Just to illustrate the speedup:

Before

```
sage: S=list(Subsets(range(13)))
sage: %time SimplicialComplex(S)
CPU times: user 6.72 s, sys: 64 ms, total: 6.79 s
Wall time: 6.72 s
Simplicial complex with 13 vertices and facets {(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)}
```


After

```
sage: %time SimplicialComplex(S)
CPU times: user 172 ms, sys: 12 ms, total: 184 ms
Wall time: 172 ms
Simplicial complex with 13 vertices and facets {(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)}
```


Nathann


---

Comment by git created at 2014-09-26 09:57:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-09-26 09:58:05

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2014-09-26 10:04:50

just one more Set to go, in 

```
sage: l=map(Set, designs.ProjectiveGeometryDesign(2,1,GF(4,name='a')))
```



---

Comment by ncohen created at 2014-09-26 10:07:23

What's the point ?.. It costs nothing.

Nathann


---

Comment by git created at 2014-09-26 10:07:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2014-09-26 10:30:24

Replying to [comment:13 ncohen]:
> Maybe I should change my job. I would be more useful to the world going over other people's loops.

you'd ran into the problem of what to do with about 10-fold increase in income :-)


---

Comment by dimpase created at 2014-09-26 10:30:24

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-09-26 10:37:59

> you'd ran into the problem of what to do with about 10-fold increase in income :-)

Honestly, do you know who I could do such a job for ? I am getting tired of working alone in my office, day after day.

Nathann


---

Comment by dimpase created at 2014-09-26 10:46:41

Replying to [comment:20 ncohen]:
> > you'd ran into the problem of what to do with about 10-fold increase in income :-)
> 
> Honestly, do you know who I could do such a job for ? I am getting tired of working alone in my office, day after day.

name your favourite Evil Empire... Oh, wait, you can also teach practical CS to undergrads - you'll see so much bad code it will make your head spin :-)

At least you should go to Sage Days more often, I presume...


---

Comment by ncohen created at 2014-09-26 11:44:37

> At least you should go to Sage Days more often, I presume...

I am paid to do research, not to take holidays.

I should take holidays, though. But the plane tickets are expensive too.

Nathann


---

Comment by dimpase created at 2014-09-26 11:54:18

Replying to [comment:22 ncohen]:
> > At least you should go to Sage Days more often, I presume...
> 
> I am paid to do research, not to take holidays.

I guess you only went to "wrong" in this respect Sage Days...
One in Seattle I went to was like working 12+ hours a day on Sage code...


---

Comment by ncohen created at 2014-09-26 13:11:02

Hmmm... Perhaps I should go next time..

Nathann


---

Comment by tscrim created at 2014-09-26 13:32:43

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2014-09-26 13:32:43

You shouldn't use `assert` to validate user input:

```python
assert (maximal_faces is None) or (from_characteristic_function is None)
```

as any assertion being raised is supposed to indicate a bug (plus they can be turned off). Instead raise an error

```python
if maximal_faces is None and from_characteristic_function is None:
    raise ValueError("maximal_faces and from_characteristic_function cannot both be specified")
```

(with perhaps a better error message).

However I do like the speedup of `SimplicialComplex`.

PS - This made me chuckle `:p`:

> I am convinced that it would make me angry.


---

Comment by git created at 2014-09-26 14:07:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-09-26 14:09:39

> You shouldn't use `assert` to validate user input:

Whyyyyyyyyyyyyyyyyyyyy had it been declared bad ?.... How can it hurt anybody ?...

We should have rules about rules.

> However I do like the speedup of `SimplicialComplex`.

Yep, that's cool !

Branch updated.

Nathann


---

Comment by tscrim created at 2014-09-26 19:16:48

Replying to [comment:27 ncohen]:
> > You shouldn't use `assert` to validate user input:
> 
> Whyyyyyyyyyyyyyyyyyyyy had it been declared bad ?.... How can it hurt anybody ?...
> 
> We should have rules about rules.

Assert statements are to check statements within the code that are (suppose to be) always true, and hence, should not depend on (the always potentially bad) user input. Thus if an assertion error is raised, there's a bug in the code. It's more of a general programming thing. (It was also something Jeroen enforced when he was release manager; IDK if Volker continues this.) Also they can be turned off (IDR offhand if it's at compile or run time) to encourage programmers to use them (or leave them in code) more.

Anyways, thanks for changing it.


---

Comment by tscrim created at 2014-09-26 19:16:48

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-09-29 11:17:42

Resolution: fixed
