# Issue 26759: Copying package files: cannot overwrite non-directory

Issue created by migration from https://trac.sagemath.org/ticket/26996

Original creator: vbraun

Original creation time: 2019-01-02 11:18:28

CC:  embray mafra vdelecroix dimpase

As reported at https://groups.google.com/d/msg/sage-devel/HHC-CmQ6X60/KCLUP0_aDQAJ

```
66509-real      31m50.729s 
66510-user      28m47.266s
66511-sys       2m43.839s
66512-Copying package files from temporary location /home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst to /home/sverre/sage/local
66513-cp: cannot overwrite non-directory '/home/sverre/sage/local/./lib64' with directory '/home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst/home/sverre/sage/local/./lib64'
66514-************************************************************************
66515:Error copying files for gfortran-7.2.0.
66516-************************************************************************
66517-Please email sage-devel (http://groups.google.com/group/sage-devel)
66518-explaining the problem and including the log file
66519-  /home/sverre/sage/logs/pkgs/gfortran-7.2.0.log
66520-Describe your computer, operating system, etc.
66521-************************************************************************
```

Presumably `/home/sverre/sage/local/lib64` is a symlink, and overwriting it with an actual directory fails.


---

Comment by embray created at 2019-01-02 11:48:04

So? That's intentional.  Package installations shouldn't overwrite existing non-directories with directories.  There's no reason they should have a symlink named `$SAGE_LOCAL/lib64`.  The real question is why that's there.


---

Comment by vbraun created at 2019-01-02 12:21:18

Afair its there because there is no easy way to convince gcc/gfortran to use /lib instead of /lib64


---

Comment by embray created at 2019-01-02 13:44:24

I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.


---

Comment by embray created at 2019-01-02 14:14:15

Replying to [comment:3 embray]:
> I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.

I've spent more time understanding the gcc build system and the "multilib" settings, and now I understand Debian's patches better as well, which include patching many of the target config files under `gcc/config` to not use lib64.  I can see this on my own GCC on Debian by running


```
$ gcc -print-multi-os-directory
../lib
```


This path is appended to `${libdir}/` by the build system to specify the installation path for the target native libraries installed by gcc, so for example libstdc++.so would get installed to `${libdir}/../lib}`, or in other words just `lib/`.

However, with the target fragments in the gcc source, the bootstrap gcc that is built during stage 1 one of the build process ends up with `../lib64` for this, and hence builds all its libraries to also go in lib64.

However, I think I've figured out a bit of a hack to change the multilib settings without patching, in such a way that should work on any platform we care about.  I'll probably also propose an upstream patch to make this easier, because really it's pretty straightforward and otherwise supported by the build system.  It's just trickier than it should be to get the right flags specified in the right place.


---

Comment by embray created at 2019-01-04 11:26:11

Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux, the specific case reported in this ticket is fixed by #27016, since those packages will no longer create files in lib64.

I opted for now to keep the symlink to lib64 just in case _something_ needs it (though I can't find any specific case), and because having it will alert us in the future to packages trying to install files to lib64.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by jdemeyer created at 2019-02-04 11:53:27

Replying to [comment:5 embray]:
> Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux

On a different system, I'm also getting

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst to /Users/jdemeyer/sage/local
cp: cannot overwrite directory /Users/jdemeyer/sage/local/./lib/ecl with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst/Users/jdemeyer/sage/local/./lib/ecl
************************************************************************
Error copying files for ecl-16.1.2.p5.
************************************************************************
```



---

Comment by embray created at 2019-02-04 12:45:45

It appears `lib/ecl` is a symlink to `lib/ecl-<version>`.  Is it possible the symlink was not removed for some reason?


---

Comment by embray created at 2019-02-04 12:51:50

In the `spkg-install` for ecl there's a line


```
rm -rf "$SAGE_LOCAL/lib/ecl-"*
```


but no


```
rm -f "$SAGE_LOCAL/lib/ecl"
```


This should also go in a `spkg-legacy-uninstall` script, but regardless, if you were updating from some older version, and it didn't delete the symlink, you would get this.


---

Comment by jdemeyer created at 2019-02-04 15:41:57

Also with `brial` (when upgrading from an older version of Sage):

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/brial-1.2.4/inst to /Users/jdemeyer/sage/local
cp: symlink: libbrial_groebner.3.dylib: File exists
cp: symlink: libbrial.3.dylib: File exists
************************************************************************
Error copying files for brial-1.2.4.
************************************************************************
```



---

Comment by embray created at 2019-02-04 15:51:29

That's a little more strange.  Actually, now that I think about it, I did see some behavior like this a couple weeks ago, and I think I saw some evidence for a bug that could actually cause the `spkg-legacy-uninstall` scripts not to run, which in the case of brial it definitely should have.

Let me confirm that and make a ticket if so...


---

Comment by jdemeyer created at 2019-02-04 15:58:51

And also

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/jdemeyer/sage/local
cp: cannot overwrite directory /Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst/Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
cp: /Users/jdemeyer/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
************************************************************************
Error copying files for gap-4.10.0.
************************************************************************
```



---

Comment by embray created at 2019-02-04 16:08:17

That one is a known issue from #22626 [comment:423](https://trac.sagemath.org/ticket/22626#comment:432).  The upstream tarball actually contains a file that randomly has read-only permissions for no good reason.

It seems that still has not been fixed.  Not clear what the appropriate solution is.  Just chmod everything to `u+rw` when extracting a tarball?


---

Comment by jdemeyer created at 2019-02-04 16:29:27


```
[gsl-2.5] Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gsl-2.5/inst to /Users/jdemeyer/sage/local
[gsl-2.5] cp: symlink: libgsl.23.dylib: File exists
```



---

Comment by jdemeyer created at 2019-02-04 16:29:51

Replying to [comment:13 embray]:
> Just chmod everything to `u+rw` when extracting a tarball?

I thought that we already fixed permissions when extracting?


---

Comment by jhpalmieri created at 2019-02-04 17:14:41

Any way this could be related to #27124?


---

Comment by jdemeyer created at 2019-02-05 15:07:20

The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.


---

Comment by jdemeyer created at 2019-02-05 15:10:50

So I'll give up on writing `spkg-legacy-uninstall` scripts, it's not a scalable solution.


---

Comment by embray created at 2019-02-05 15:12:46

Replying to [comment:15 jdemeyer]:
> Replying to [comment:13 embray]:
> > Just chmod everything to `u+rw` when extracting a tarball?
> 
> I thought that we already fixed permissions when extracting?

We apply a umask but that's different.  And I think it has `0` in the user bits, so that means if a file happens to be read-only for some reason that will be preserved.


---

Comment by embray created at 2019-02-05 15:13:45

Replying to [comment:17 jdemeyer]:
> The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.

To be clear: Only if you're trying to upgrade some relatively old build.  It would be nice if this can always work, and I'm not saying this isn't a problem.  But sometimes it's okay to just require a `make distclean`.


---

Comment by jhpalmieri created at 2019-02-25 18:54:29

I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 

gap:

```
Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
cp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
cp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
************************************************************************
Error copying files for gap-4.10.0.p0.
```


ecl:

```
Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
cp: symlink: ecl-16.1.3: File exists
************************************************************************
Error copying files for ecl-16.1.3.p0.
```


I've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.


---

Comment by embray created at 2019-02-26 13:46:25

Replying to [comment:23 jhpalmieri]:
> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 

The former is a problem with the GAP tarball.  I think we should just make a special case fix for that in the GAP spkg for now; see comment:13.

I think the latter might be because of #27124 or possibly #27223.  In other words, it's likely that some previous bug meant the package could not be correctly uninstalled first.


---

Comment by jhpalmieri created at 2019-02-26 18:53:41

For GAP, and indeed in general, I would be tempted to do this:

```diff
diff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py
index 57621527ac..cf707e78a3 100644
--- a/build/sage_bootstrap/uncompress/tar_file.py
+++ b/build/sage_bootstrap/uncompress/tar_file.py
@@ -68,6 +68,7 @@ class SageBaseTarFile(tarfile.TarFile):
         """Apply ``self.umask`` instead of the permissions in the TarInfo."""
         tarinfo = copy.copy(tarinfo)
         tarinfo.mode &= ~self.umask
+        tarinfo.mode |= stat.S_IWUSR
         tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)
         return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)

```

I can't tell whether that's a good idea.

It looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.


---

Comment by embray created at 2019-02-28 15:17:01

Replying to [comment:25 jhpalmieri]:
> For GAP, and indeed in general, I would be tempted to do this:
> {{{
> #!diff
> diff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py
> index 57621527ac..cf707e78a3 100644
> --- a/build/sage_bootstrap/uncompress/tar_file.py
> +++ b/build/sage_bootstrap/uncompress/tar_file.py
> `@``@` -68,6 +68,7 `@``@` class SageBaseTarFile(tarfile.TarFile):
>          """Apply ``self.umask`` instead of the permissions in the TarInfo."""
>          tarinfo = copy.copy(tarinfo)
>          tarinfo.mode &= ~self.umask
> +        tarinfo.mode |= stat.S_IWUSR
>          tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)
>          return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)
> 
> }}}
> I can't tell whether that's a good idea.
> 
> It looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.

Yeah, I wouldn't be opposed to that.  I don't think there's any good reason for a package to be _installing_ read-only files.


---

Comment by jhpalmieri created at 2019-02-28 18:31:17

See #27388 for this permissions change.


---

Comment by dimpase created at 2019-03-13 22:59:09

Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this


---

Comment by embray created at 2019-03-18 11:10:33

Replying to [comment:28 dimpase]:
> Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this

See #27485


---

Comment by embray created at 2019-03-18 11:21:08

Tried to add some more explanation to this ticket.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-03-25 12:49:51

Replying to [comment:23 jhpalmieri]:
> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 
> 
> gap:
> {{{
> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
> cp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
> cp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
> ************************************************************************
> Error copying files for gap-4.10.0.p0.
> }}}
> 
> ecl:
> {{{
> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
> cp: symlink: ecl-16.1.3: File exists
> ************************************************************************
> Error copying files for ecl-16.1.3.p0.
> }}}
> 
> I've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.

This is now #27544.


---

Comment by embray created at 2019-05-09 16:04:28

ISTM all _known_ cases of this have been fixed.  In particular, fixing #27223 should fix many cases where this could crop up, since some files were not being properly uninstalled.

If it comes up again I would suggest opening a new ticket for that specific case.


---

Comment by embray created at 2019-05-09 16:04:28

Resolution: worksforme


---

Comment by mkoeppe created at 2020-01-31 21:15:16

I'm hitting the "cannot overwrite non-directory" from the original ticket description with gfortran (now 9.2.0) on `fedora-31-minimal` and `fedora-32-minimal` - see https://github.com/mkoeppe/sage/actions/runs/33491442


---

Comment by mkoeppe created at 2020-01-31 21:15:16

Resolution changed from worksforme to 


---

Comment by mkoeppe created at 2020-01-31 21:15:16

Changing status from closed to new.


---

Comment by mkoeppe created at 2020-01-31 21:18:50

The symbolic link `lib64->lib` is set in the `AC_CONFIG_COMMANDS mkdirs`.

The `gfortran` staging install creates the following:

```
ls -l /sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib*
/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib:
total 48296
drwxr-xr-x 3 root root     4096 Jan 31 20:56 gcc
-rw-r--r-- 1 root root   464650 Jan 31 20:56 libatomic.a
lrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so -> libatomic.so.1.2.0
lrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so.1 -> libatomic.so.1.2.0
-rwxr-xr-x 1 root root   170064 Jan 31 20:56 libatomic.so.1.2.0
-rw-r--r-- 1 root root      132 Jan 31 20:56 libgcc_s.so
-rw-r--r-- 1 root root   872480 Jan 31 20:56 libgcc_s.so.1
-rw-r--r-- 1 root root 28051754 Jan 31 20:56 libgfortran.a
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so -> libgfortran.so.5.0.0
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so.5 -> libgfortran.so.5.0.0
-rwxr-xr-x 1 root root 11718472 Jan 31 20:56 libgfortran.so.5.0.0
-rw-r--r-- 1 root root      269 Jan 31 20:56 libgfortran.spec
-rw-r--r-- 1 root root  3239510 Jan 31 20:56 libgomp.a
lrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so -> libgomp.so.1.0.0
lrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so.1 -> libgomp.so.1.0.0
-rwxr-xr-x 1 root root  1468416 Jan 31 20:56 libgomp.so.1.0.0
-rw-r--r-- 1 root root      169 Jan 31 20:56 libgomp.spec
-rw-r--r-- 1 root root  2055148 Jan 31 20:56 libquadmath.a
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so -> libquadmath.so.0.0.0
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so.0 -> libquadmath.so.0.0.0
-rwxr-xr-x 1 root root  1224592 Jan 31 20:56 libquadmath.so.0.0.0
-rw-r--r-- 1 root root   101410 Jan 31 20:56 libssp.a
lrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so -> libssp.so.0.0.0
lrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so.0 -> libssp.so.0.0.0
-rwxr-xr-x 1 root root    51328 Jan 31 20:56 libssp.so.0.0.0
-rw-r--r-- 1 root root     3222 Jan 31 20:56 libssp_nonshared.a

/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib64:
total 1196
-rwxr-xr-x 1 root root     932 Jan 31 20:56 libcc1.la
lrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so -> libcc1.so.0.0.0
lrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so.0 -> libcc1.so.0.0.0
-rwxr-xr-x 1 root root 1217840 Jan 31 20:56 libcc1.so.0.0.0

/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/libexec:
total 4
drwxr-xr-x 3 root root 4096 Jan 31 20:56 gcc
```



---

Comment by mkoeppe created at 2020-01-31 21:23:00

I'm fixing this for `gfortran` in #29089
but the faulty copying from staging to $SAGE_LOCAL should be cleaned up in #22509.


---

Comment by mkoeppe created at 2020-03-31 11:27:02

Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ


---

Comment by mkoeppe created at 2020-03-31 11:27:02

Changing priority from major to critical.


---

Comment by dimpase created at 2020-03-31 12:15:16

Replying to [comment:37 mkoeppe]:
> Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ

an unpleasant part of it is that the installation attempt happens from within distutils or setuptools, called from within pillow's `setup.py`.

would it be better to make `lib64/` a proper directory, install stuff there, and then do a kind of postinstall that would move/link/copy stuff over to `lib/` ?


---

Comment by mkoeppe created at 2020-03-31 13:00:02

I will just move the fix that I have in the gfortran install script into sage-spkg.


---

Comment by mkoeppe created at 2020-03-31 14:25:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-31 14:25:23

New commits:


---

Comment by dimpase created at 2020-03-31 15:55:39

A diffrent error now (`File exists`):

```
writing manifest file 'src/Pillow.egg-info/SOURCES.txt'
running install_lib
creating /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64
error: could not create '/home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64': File exists
***************************************************************************************************************************************
Error building/installing Pillow

```



---

Comment by git created at 2020-03-31 16:02:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-31 16:03:56

Try with this version


---

Comment by dimpase created at 2020-03-31 16:52:47

pillow installs now. Moar testing underway


---

Comment by dimpase created at 2020-04-01 02:48:38

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-04-01 02:48:38

lgtm


---

Comment by mkoeppe created at 2020-04-01 02:54:25

Thanks!


---

Comment by vbraun created at 2020-04-09 22:45:14

Resolution: fixed
