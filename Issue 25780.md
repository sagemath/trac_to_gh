# Issue 25780: Improve regression test on search_doc

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-08-07 09:33:44

This test started failing for me, due to there being more than 2000 matches for "tree" in my docs (even when considering whole word matches).  The rewritten test demonstrates, I believe, that the failure is not in the code itself, but rather that my docs directory just started having a larger number of matches than the hard-coded threshold.  I'm not sure why that is, and it's possible I need to do a `make doc-clean`.

But nevertheless this test can still be rewritten to not depend on some arbitrary thresholds.

(Incidentally, I also noticed that this full text search over all the docs is very, very slow.  Doesn't Sphinx generate some indices we could be taking advantage of...?)


---

Comment by embray created at 2018-08-07 09:33:50

Changing status from new to needs_review.


---

Comment by git created at 2018-08-07 09:34:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-08-07 16:55:53

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-08-08 14:59:29

FWIW running a `make doc-clean` and rebuilding the docs in the source tree where I was getting this failure also fixed the failure of the original test, as I suspected it might.  Nevertheless I think this rewrite makes more sense.


---

Comment by vbraun created at 2018-08-08 19:12:06

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-08-08 19:12:06

Merge conflict


---

Comment by embray created at 2018-08-09 12:12:40

Dare I ask what with??


---

Comment by embray created at 2018-08-09 12:15:10

If you're going to write "merge conflict" you could at least produce the diff as a mere hint of what it might conflict with.


---

Comment by embray created at 2018-08-09 12:16:00

Changing status from needs_work to needs_info.


---

Comment by saraedum created at 2018-08-09 15:25:41

I guess that's just Volker's workflow. He merges things into his private "alpha" branch and reports merge conflicts that you won't see until the next beta. I think this kind of workflow is fine but the communication could be a bit more clear about this (as I have already been on quite a few tickets where this caused a bit of confusion.) Something like

'''
The Release Manager could not merge the changes on this ticket because there were merge conflicts.
These conflicts might not be visible to you until the next beta of Sage has been released. Please merge the develop branch into this ticket's branch once the next beta version of Sage has been released.
'''

vbraun: What do you think?


---

Comment by embray created at 2018-08-10 09:27:21

I've already brought this up before and suggested that the "private" branch be more visible.  The response to this has usually been along the lines of "it's not hidden--you can see it right here".  But that's extremely non-obvious.  I might know that (now) but it's a pretty confusing and unwelcoming response to new users.  I have suggested that it be an easily locatable, well-known branch name on git.sagemath.org (I would prefer an integration branch for the next release or something like that) along with links to that branch so that I can see what's going on there.

The response to that has generally been along the lines of "we can't do that because it would be confusing if people base stuff off that branch".  But I don't buy that.  Even if someone did, so what?  Just say that it doesn't merge and _why_, and that they should rebase on "develop" or something.  I think in practice that would be pretty rare.  Much less rare than telling that their ticket has a merge conflict--when by appearances it doesn't--and then not explaining what the conflict is.  And then worse, setting the ticket back to "needs work", where it's possible it will be forgotten and decay further.


---

Comment by chapoton created at 2018-08-10 16:13:55

I tried to propose something (in May) :

https://github.com/sagemath/git-trac-command/pull/30


---

Comment by jhpalmieri created at 2018-08-22 22:01:51

See #26102 for a slight speed-up to `search_doc`.


---

Comment by git created at 2018-08-23 09:29:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-08-23 09:30:00

Rebased, I guess.  Thanks for the info.


---

Comment by embray created at 2018-08-23 09:30:00

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2018-08-26 08:58:15

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-08-26 08:58:15


```
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1179, in sage.misc.sagedoc.?
Failed example:
    len(L) < N  # long time
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sagedoc.?[1]>", line 1, in <module>
        len(L) < N  # long time
    NameError: name 'L' is not defined
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1183, in sage.misc.sagedoc.?
Failed example:
    all(tree_re.search(l) for l in L)  # long time
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sagedoc.?[4]>", line 1, in <module>
        all(tree_re.search(l) for l in L)  # long time
    NameError: name 'L' is not defined
**********************************************************************
```



---

Comment by jhpalmieri created at 2018-08-27 17:37:47

Fixed the `optional` tags on the doctests.
----
New commits:


---

Comment by jhpalmieri created at 2018-08-27 17:37:47

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-08-30 22:24:41

Resolution: fixed


---

Comment by jdemeyer created at 2018-09-03 08:07:20

Breakage: #26184
