# Issue 11478: Make 'convert' the standard way to produce animated gifs (again)

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-08-04 17:03:03

Assignee: jason, was

Keywords: animate convert ffmpeg

In ticket #11170, code was added so that if ffmpeg is present, it gets used by default to produce animated gifs.  These can be much larger than the ones produced by 'convert', plus there may be other problems with ffmpeg.  The attached patch makes 'convert' the default again.



---

Comment by jhpalmieri created at 2011-08-04 17:04:02

Changing status from new to needs_review.


---

Comment by kini created at 2011-08-05 06:21:43

Just by the by, what do you think about bundling GraphicsMagick (a fork of ImageMagick by a group of its original developers) with Sage? Apparently it is faster than ImageMagick (I'm told, by a user, that it is faster by a factor of three for these animation type things). It's also X11-licensed, so if I understand correctly it is possible to bundle it, unlike ImageMagick. The source occupies ~38 MB.


---

Comment by jhpalmieri created at 2011-08-10 19:22:08

I've never used GraphicsMagick, but I'll take a look some time.  It would be nice to include it, if it's that small.  Does it need libjpeg or anything else like that?


---

Comment by ddrake created at 2011-08-31 03:16:02

This looks good. Two notes:

* You can't pass `use_ffmpeg=True` when using `.save()`. If it's easy to do, can `.save()` pass that onto `.gif()`? Or at least change the docstring in `.save()` to tell users to go directly to `.gif()` if they want to use ffmpeg.

* Somehow, the `delay` parameter is now a string:

```
sage: a.gif('bar2.gif', use_ffmpeg=True)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/drake/s/sage-4.7.2.alpha2/<ipython console> in <module>()

/home/drake/s/sage-4.7.2.alpha2/local/lib/python2.6/site-packages/sage/plot/animate.pyc in gif(self, delay, savefile, iterations, show_path, use_ffmpeg)
    361                 self.ffmpeg(savefile=savefile, show_path=show_path,
    362                             output_format='gif', delay=delay,
--> 363                             iterations=iterations)
    364             else:
    365                 if not have_convert:

/home/drake/s/sage-4.7.2.alpha2/local/lib/python2.6/site-packages/sage/plot/animate.pyc in ffmpeg(self, savefile, show_path, output_format, ffmpeg_options, delay, iterations, verbose)
    566                 ffmpeg_options += ' -pix_fmt rgb24 -loop_output %s ' % iterations
    567             if delay is not None and output_format != 'mpeg' and output_format != 'mpg':
--> 568                 early_options += ' -r %s -g 3 ' % int(100/delay)
    569             savefile = os.path.abspath(savefile)
    570             pngdir = self.png()

TypeError: unsupported operand type(s) for /: 'int' and 'str'
```

Calling `.ffmpeg()` without the patch here works fine.


---

Comment by ddrake created at 2011-08-31 03:16:02

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-09-08 20:25:18

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-09-08 20:25:18

Here's a new patch; the only changes are the following:

```diff
diff --git a/sage/plot/animate.py b/sage/plot/animate.py
--- a/sage/plot/animate.py
+++ b/sage/plot/animate.py
`@``@` -587,7 +587,7 `@``@` please install it and try again."""
                 print "Error running ffmpeg."
                 raise
 
-    def save(self, filename=None, show_path=False):
+    def save(self, filename=None, show_path=False, use_ffmpeg=False):
         """
         Save this animation.
 
`@``@` -598,6 +598,10 `@``@` please install it and try again."""
         -  ``show_path`` - boolean (default: False); if True,
            print the path to the saved file
 
+        - ``use_ffmpeg`` - boolean (default: False); if True, use
+          'ffmpeg' by default instead of 'convert' when creating GIF
+          files.
+
         If filename is None, then in notebook mode, display the
         animation; otherwise, save the animation to a GIF file.  If
         filename ends in '.sobj', save to an sobj file.  Otherwise,
`@``@` -632,7 +636,8 `@``@` please install it and try again."""
                 suffix = '.gif'
 
         if filename is None or suffix == '.gif':
-            self.gif(savefile=filename, show_path=show_path)
+            self.gif(savefile=filename, show_path=show_path,
+                     use_ffmpeg=use_ffmpeg)
             return
         elif suffix == '.sobj':
             SageObject.save(self, filename)
```

This allows you to do `a.save('foobar.gif', use_ffmpeg=True)`.

I'm not seeing the issue with `delay` being a string.  Can you please try again?


---

Attachment


---

Comment by ddrake created at 2011-11-18 04:38:40

Changing status from needs_review to positive_review.


---

Comment by ddrake created at 2011-11-18 04:38:40

Now this looks good. Passes all doctests and works properly. I don't know what happened with the `delay` option; it now works.


---

Comment by jdemeyer created at 2011-11-23 13:25:13

Resolution: fixed
