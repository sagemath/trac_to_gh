# Issue 27236: Matrix inversion fails over a Laurent series ring

Issue created by migration from https://trac.sagemath.org/ticket/27473

Original creator: kedlaya

Original creation time: 2019-03-12 17:28:52

CC:  roed

As of 8.7beta6, this works fine (note change from `adjoint` to `adjugate` as per #10501):

```
sage: R.<t> = LaurentSeriesRing(QQ)
sage: M = t*identity_matrix(2)
sage: M.adjugate() * ~M.det()
[t^-1    0]
[   0 t^-1]
```

but this fails:

```
sage: ~M ## Shorthand for M.inverse(), which behaves the same way
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-53-6c551a35e6a8> in <module>()
----> 1 ~M

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__invert__ (build/cythonized/sage/matrix/matrix0.c:36096)()
   5380 
   5381         A = self.augment(self.parent().identity_matrix())
-> 5382         A.echelonize()
   5383 
   5384         # Now we want to make sure that B is of the form [I|X], in

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.echelonize (build/cythonized/sage/matrix/matrix2.c:48296)()
   6725             if self.base_ring().is_field():
   6726                 if algorithm in ['classical', 'partial_pivoting', 'scaled_partial_pivoting']:
-> 6727                     self._echelon_in_place(algorithm)
   6728                 elif algorithm == 'strassen':
   6729                     self._echelon_strassen(cutoff)

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix._echelon_in_place (build/cythonized/sage/matrix/matrix2.c:50128)()
   7004                     scale_factor = 0
   7005                     for c in range(nc):
-> 7006                         abs_val = A.get_unsafe(r, c).abs()
   7007                         if abs_val > scale_factor:
   7008                             scale_factor = abs_val

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/structure/element.pyx in sage.structure.element.RingElement.abs (build/cythonized/sage/structure/element.c:18824)()
   2718             ArithmeticError: absolute valued not defined on integers modulo n.
   2719         """
-> 2720         return abs(self)
   2721 
   2722     def is_prime(self):

TypeError: bad operand type for abs(): 'sage.rings.laurent_series_ring_element.LaurentSeries'
```

This worked back in 8.2, so it must be a recent change that broke it.



---

Comment by chapoton created at 2019-03-12 19:14:44

The error comes from:

```
M.echelonize('scaled_partial_pivoting')
```

It seems to be assumed that rings in `DiscreteValuationFields` have an `abs` method.


---

Comment by nbruin created at 2019-03-13 06:00:21

... which of course they can have, but it's probably better to program the partial pivoting using the valuation directly. The definition of `abs` would be `lambda self: (self.is_zero()) select 0 else 2**(-self.valuation())` or something similar, and is a very inefficient way of representing the valuation. So we probably need a  `scaled_partial_pivoting_absvalue` and a `scaled_partial_pivoting_valuation`.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by kedlaya created at 2019-08-16 02:02:34

Changing status from new to needs_review.


---

Comment by kedlaya created at 2019-08-16 02:02:34

I followed nbruin's suggestion and added an algorithm `scaled_partial_pivoting_valuation`. This shouldn't cause any side effects, but one should be careful when messing with core linear algebra.
----
New commits:


---

Comment by kedlaya created at 2019-08-16 02:56:03

I see some failing doctests, so let me pull this until I have a chance to check these out.


---

Comment by kedlaya created at 2019-08-16 02:56:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-08-16 03:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-08-16 03:15:24

The first commit broke a bunch of doctests involving matrices over p-adic fields. In principle it should be possible to fix this, but it is far easier to simply short-circuit the echelon code so that it uses `abs` even for discretely valued field unless the field does not support it, in which case we switch to valuation. The latest commit implements this, but I want to rerun all doctests before changing status again.


---

Comment by kedlaya created at 2019-08-16 06:23:44

Changing keywords from "" to "matrix inversion, Laurent series".


---

Comment by kedlaya created at 2019-08-16 06:23:44

I completed a run of doctests, so let's put this back up for review.


---

Comment by kedlaya created at 2019-08-16 06:23:44

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-08-20 18:07:36

I would try "ring.one().abs" instead of "abs(ring.one())" and then catch `AttributeError`.

Wrong doc here:

```
+          - ``'scaled_partial_pivoting_valuation'``: Gauss elimination, using scaled
+            partial pivoting (if base ring has absolute value)
```


Otherwise, looks good.


---

Comment by git created at 2019-08-20 23:26:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-08-20 23:28:08

Latest commit makes the change regarding `abs`. Regarding the doc, I fixed the line overrun; but was there also another issue?


---

Comment by chapoton created at 2019-08-21 06:42:40

You did not fix the correct doc lines. The one I talk about is a little bit below, and contains the word "absolute value", instead of the correct "valuation".


---

Comment by git created at 2019-08-21 14:33:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-08-24 11:31:46

There is a failure in src/sage/matrix/matrix2.pyx : you need to catch `TypeError` in the check for abs.


---

Comment by git created at 2019-08-24 18:25:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-08-25 05:55:38

ok, let it be. Thanks


---

Comment by chapoton created at 2019-08-25 05:55:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-08-26 22:15:07

Resolution: fixed


---

Comment by vbraun created at 2019-08-28 20:09:23

Still getting

```
File "src/sage/matrix/matrix2.pyx", line 8922, in sage.matrix.matrix2.Matrix.diagonal.inverse
Failed example:
    ~M
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix2.Matrix.diagonal.inverse[11]>", line 1, in <module>
        ~M
      File "sage/matrix/matrix0.pyx", line 5382, in sage.matrix.matrix0.Matrix.__invert__ (build/cythonized/sage/matrix/matrix0.c:36130)
        A.echelonize()
      File "sage/matrix/matrix2.pyx", line 6756, in sage.matrix.matrix2.Matrix.echelonize (build/cythonized/sage/matrix/matrix2.c:48757)
        self._echelon_in_place(algorithm)
      File "sage/matrix/matrix2.pyx", line 7076, in sage.matrix.matrix2.Matrix._echelon_in_place (build/cythonized/sage/matrix/matrix2.c:51166)
        if abs_val > max_abs_val:
    TypeError: '>' not supported between instances of 'int' and 'NoneType'
```

with e4ab5738ca


---

Comment by vbraun created at 2019-08-28 20:09:28

Changing status from closed to new.


---

Comment by vbraun created at 2019-08-28 20:09:28

Resolution changed from fixed to 


---

Comment by kedlaya created at 2019-08-28 22:11:02

Changing status from new to needs_review.


---

Comment by kedlaya created at 2019-08-28 22:11:02

That looks like a Py3 issue. Let's see if patchbot likes this better.


---

Comment by chapoton created at 2019-08-29 07:48:05

You did something strange with your branch. I pushed a clean (and squashed) one instead, with the same fix for py3.
----
New commits:


---

Comment by chapoton created at 2019-08-29 09:58:01

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-08-29 09:58:01

the py2 bot is green, and all tests pass on py3. I am setting this back to positive


---

Comment by vbraun created at 2019-09-02 21:41:21

Resolution: fixed
