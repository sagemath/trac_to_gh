# Issue 13744: Let MPIR build with Clang

archive/issues_013744.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  leif jhpalmieri\n\nKeywords: spkg mpir clang\n\nSee #13137.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13948\n\n",
    "created_at": "2013-01-11T22:59:12Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "Let MPIR build with Clang",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13744",
    "user": "jpflori"
}
```
Assignee: tbd

CC:  leif jhpalmieri

Keywords: spkg mpir clang

See #13137.

Issue created by migration from https://trac.sagemath.org/ticket/13948





---

archive/issue_comments_170517.json:
```json
{
    "body": "Changing assignee from tbd to leif.",
    "created_at": "2013-01-12T08:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170517",
    "user": "leif"
}
```

Changing assignee from tbd to leif.



---

archive/issue_comments_170518.json:
```json
{
    "body": "Pinging myself... ;-)\n\n(I do have a trivial patch to `acinclude.m4` to make MPIR configure [and of course build and pass its test suite] with `clang`.  Haven't yet submitted it upstream either IIRC.)",
    "created_at": "2013-03-01T00:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170518",
    "user": "leif"
}
```

Pinging myself... ;-)

(I do have a trivial patch to `acinclude.m4` to make MPIR configure [and of course build and pass its test suite] with `clang`.  Haven't yet submitted it upstream either IIRC.)



---

archive/issue_comments_170519.json:
```json
{
    "body": "Replying to [comment:2 leif]:\n> (I do have a trivial patch to `acinclude.m4` to make MPIR configure [and of course build and pass its test suite] with `clang`.  Haven't yet submitted it upstream either IIRC.)\n\n*I think<sup>TM</sup>* this is the *resulting* patch to `configure` (resulting from patching `acinclude.m4` in two places):\n\n```patch\n--- mpir-2.6.0/configure\t2012-11-08 23:13:27.000000000 +0100\n+++ mpir-2.6.0/configure\t2013-01-06 14:06:55.873290298 +0100\n@@ -5132,7 +5132,7 @@\n   rm -f conftest* a.out b.out a.exe a_out.exe\n   cat >conftest.c <<EOF\n /* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */\n-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)\n+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)\n int __attribute__((noinline))\n foo(int i)\n {\n@@ -5588,7 +5588,7 @@\n    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and\n    1666 to segfault with e.g., -O2 -mpowerpc64.  */\n \n-#ifdef __GNUC__\n+#if\tdefined(__GNUC__) && !defined(__clang__)\n typedef unsigned long long t1;typedef t1*t2;\n __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)\n {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}\n@@ -6393,7 +6393,7 @@\n   rm -f conftest* a.out b.out a.exe a_out.exe\n   cat >conftest.c <<EOF\n /* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */\n-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)\n+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)\n int __attribute__((noinline))\n foo(int i)\n {\n@@ -6849,7 +6849,7 @@\n    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and\n    1666 to segfault with e.g., -O2 -mpowerpc64.  */\n \n-#ifdef __GNUC__\n+#if\tdefined(__GNUC__) && !defined(__clang__)\n typedef unsigned long long t1;typedef t1*t2;\n __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)\n {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}\n```\n",
    "created_at": "2013-05-15T15:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170519",
    "user": "leif"
}
```

Replying to [comment:2 leif]:
> (I do have a trivial patch to `acinclude.m4` to make MPIR configure [and of course build and pass its test suite] with `clang`.  Haven't yet submitted it upstream either IIRC.)

*I think<sup>TM</sup>* this is the *resulting* patch to `configure` (resulting from patching `acinclude.m4` in two places):

```patch
--- mpir-2.6.0/configure	2012-11-08 23:13:27.000000000 +0100
+++ mpir-2.6.0/configure	2013-01-06 14:06:55.873290298 +0100
@@ -5132,7 +5132,7 @@
   rm -f conftest* a.out b.out a.exe a_out.exe
   cat >conftest.c <<EOF
 /* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */
-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)
+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)
 int __attribute__((noinline))
 foo(int i)
 {
@@ -5588,7 +5588,7 @@
    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and
    1666 to segfault with e.g., -O2 -mpowerpc64.  */
 
-#ifdef __GNUC__
+#if	defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
@@ -6393,7 +6393,7 @@
   rm -f conftest* a.out b.out a.exe a_out.exe
   cat >conftest.c <<EOF
 /* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */
-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)
+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)
 int __attribute__((noinline))
 foo(int i)
 {
@@ -6849,7 +6849,7 @@
    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and
    1666 to segfault with e.g., -O2 -mpowerpc64.  */
 
-#ifdef __GNUC__
+#if	defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
```




---

archive/issue_comments_170520.json:
```json
{
    "body": "And that's the corresponding one against *upstream's* `acinclude.m4`:\n\n```patch\n--- mpir-2.6.0/acinclude.m4\t2012-10-23 16:56:46.000000000 +0200\n+++ mpir-2.6.0/acinclude.m4\t2013-01-08 22:14:36.895834719 +0100\n@@ -480,9 +480,9 @@\n # first see a simple \"main()\" works, then go on to other checks\n GMP_PROG_CC_WORKS_PART([$1], [])\n \n-GMP_PROG_CC_WORKS_PART_MAIN([$1], [gcc-4.3.2 on 64bit is bad , try -O1 or -fno-strict-aliasing for the flags],\n-[/* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */\n-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)\n+GMP_PROG_CC_WORKS_PART_MAIN([$1], [gcc-4.3.2 on 64-bit is bad, try -O1 or -fno-strict-aliasing for the flags],\n+[/* The following aborts with gcc-4.3.2 on a 64-bit system which is an unusable compiler */\n+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)\n int __attribute__((noinline))\n foo(int i)\n {\n@@ -566,9 +566,9 @@\n GMP_PROG_CC_WORKS_PART([$1], [long long reliability test 1],\n [/* The following provokes a segfault in the compiler on powerpc-apple-darwin.\n    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and\n-   1666 to segfault with e.g., -O2 -mpowerpc64.  */\n+   1666 to segfault with, e.g., -O2 -mpowerpc64. */\n \n-#ifdef __GNUC__\n+#if\tdefined(__GNUC__) && !defined(__clang__)\n typedef unsigned long long t1;typedef t1*t2;\n __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)\n {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}\n```\n",
    "created_at": "2013-05-15T15:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170520",
    "user": "leif"
}
```

And that's the corresponding one against *upstream's* `acinclude.m4`:

```patch
--- mpir-2.6.0/acinclude.m4	2012-10-23 16:56:46.000000000 +0200
+++ mpir-2.6.0/acinclude.m4	2013-01-08 22:14:36.895834719 +0100
@@ -480,9 +480,9 @@
 # first see a simple "main()" works, then go on to other checks
 GMP_PROG_CC_WORKS_PART([$1], [])
 
-GMP_PROG_CC_WORKS_PART_MAIN([$1], [gcc-4.3.2 on 64bit is bad , try -O1 or -fno-strict-aliasing for the flags],
-[/* The following aborts with gcc-4.3.2 on a 64bit system which is an unusable compiler */
-#if defined(__GNUC__) && !defined(__INTEL_COMPILER)
+GMP_PROG_CC_WORKS_PART_MAIN([$1], [gcc-4.3.2 on 64-bit is bad, try -O1 or -fno-strict-aliasing for the flags],
+[/* The following aborts with gcc-4.3.2 on a 64-bit system which is an unusable compiler */
+#if defined(__GNUC__) && !defined(__INTEL_COMPILER) && !defined(__clang__)
 int __attribute__((noinline))
 foo(int i)
 {
@@ -566,9 +566,9 @@
 GMP_PROG_CC_WORKS_PART([$1], [long long reliability test 1],
 [/* The following provokes a segfault in the compiler on powerpc-apple-darwin.
    Extracted from tests/mpn/t-iord_u.c.  Causes Apple's gcc 3.3 build 1640 and
-   1666 to segfault with e.g., -O2 -mpowerpc64.  */
+   1666 to segfault with, e.g., -O2 -mpowerpc64. */
 
-#ifdef __GNUC__
+#if	defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
```




---

archive/issue_comments_170521.json:
```json
{
    "body": "Leif: do you plan to make a proper spkg? Have you reported it upstream? (If both answers are \"NO\", that's fine, I can do it).",
    "created_at": "2013-06-03T10:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170521",
    "user": "jdemeyer"
}
```

Leif: do you plan to make a proper spkg? Have you reported it upstream? (If both answers are "NO", that's fine, I can do it).



---

archive/issue_comments_170522.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Leif: do you plan to make a proper spkg?\n\nPlan to:  Yes.\n\nRight now:  No.  (So feel free to do so.)\n\n\n\n\n> Have you reported it upstream?\n\nYes, quite a while ago (on mpir-devel).\n\nI also reported *how* to fix it, but haven't (yet) submitted the \"final\" `acinclude.m4` patch above IIRC.\n\n(I was actually going to ask Bill about the MPIR release schedule, also because of this.)",
    "created_at": "2013-06-03T10:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170522",
    "user": "leif"
}
```

Replying to [comment:7 jdemeyer]:
> Leif: do you plan to make a proper spkg?

Plan to:  Yes.

Right now:  No.  (So feel free to do so.)




> Have you reported it upstream?

Yes, quite a while ago (on mpir-devel).

I also reported *how* to fix it, but haven't (yet) submitted the "final" `acinclude.m4` patch above IIRC.

(I was actually going to ask Bill about the MPIR release schedule, also because of this.)



---

archive/issue_comments_170523.json:
```json
{
    "body": "Replying to [comment:9 leif]:\n> Replying to [comment:7 jdemeyer]:\n> > Have you reported it upstream?\n> \n> Yes, quite a while ago (on mpir-devel).\n\nhttp://groups.google.com/group/mpir-devel/browse_thread/thread/7888d9a026432871#\n\n(See also [http://groups.google.com/group/mpir-devel/browse_thread/thread/c9d70a195f846258#](http://groups.google.com/group/mpir-devel/browse_thread/thread/c9d70a195f846258#).)\n\n\n\n\n> I also reported *how* to fix it, but haven't (yet) submitted the \"final\" `acinclude.m4` patch above IIRC.\n\nYep.",
    "created_at": "2013-06-03T10:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170523",
    "user": "leif"
}
```

Replying to [comment:9 leif]:
> Replying to [comment:7 jdemeyer]:
> > Have you reported it upstream?
> 
> Yes, quite a while ago (on mpir-devel).

http://groups.google.com/group/mpir-devel/browse_thread/thread/7888d9a026432871#

(See also [http://groups.google.com/group/mpir-devel/browse_thread/thread/c9d70a195f846258#](http://groups.google.com/group/mpir-devel/browse_thread/thread/c9d70a195f846258#).)




> I also reported *how* to fix it, but haven't (yet) submitted the "final" `acinclude.m4` patch above IIRC.

Yep.



---

archive/issue_comments_170524.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> I also reported *how* to fix it, but haven't (yet) submitted the \"final\" `acinclude.m4` patch above IIRC.\n\nPatch now submitted upstream.",
    "created_at": "2013-06-03T11:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170524",
    "user": "leif"
}
```

Replying to [comment:10 leif]:
> I also reported *how* to fix it, but haven't (yet) submitted the "final" `acinclude.m4` patch above IIRC.

Patch now submitted upstream.



---

archive/issue_comments_170525.json:
```json
{
    "body": "Any chance to get an spkg to review?\nOr should I begin working on Cygwin64 support without fearing a future rebase?",
    "created_at": "2013-06-20T11:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170525",
    "user": "jpflori"
}
```

Any chance to get an spkg to review?
Or should I begin working on Cygwin64 support without fearing a future rebase?



---

archive/issue_comments_170526.json:
```json
{
    "body": "I am going to move forward on this and simply make a spkg which completely removes the offending test.",
    "created_at": "2013-10-01T15:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170526",
    "user": "jdemeyer"
}
```

I am going to move forward on this and simply make a spkg which completely removes the offending test.



---

archive/issue_comments_170527.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-01T16:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170527",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170528.json:
```json
{
    "body": "I'm using OS X 10.8.5 with Xcode 5.0, which means that `gcc --version` returns\n\n```\n$ gcc --version\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/usr/include/c++/4.2.1\nApple LLVM version 5.0 (clang-500.2.76) (based on LLVM 3.3svn)\nTarget: x86_64-apple-darwin12.5.0\nThread model: posix\n```\n\nThe old mpir spkg fails to build for known reasons. The new mpir spkg fails also, though. [Log file.](http://sage.math.washington.edu/home/palmieri/misc/mpir-2.6.0.p3.log)\n\n(I also tried unsetting `MAKE` and it didn't help.)",
    "created_at": "2013-10-01T17:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170528",
    "user": "jhpalmieri"
}
```

I'm using OS X 10.8.5 with Xcode 5.0, which means that `gcc --version` returns

```
$ gcc --version
Configured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/usr/include/c++/4.2.1
Apple LLVM version 5.0 (clang-500.2.76) (based on LLVM 3.3svn)
Target: x86_64-apple-darwin12.5.0
Thread model: posix
```

The old mpir spkg fails to build for known reasons. The new mpir spkg fails also, though. [Log file.](http://sage.math.washington.edu/home/palmieri/misc/mpir-2.6.0.p3.log)

(I also tried unsetting `MAKE` and it didn't help.)



---

archive/issue_comments_170529.json:
```json
{
    "body": "Please try the following: extract the spkg and try to \"manually\" configure it by doing:\n\n```\n$ cd mpir-2.6.0.p3/src\n$ ./configure\n```\n\n\nI'm interested to see the output of that, as well as the resulting `config.log` file.",
    "created_at": "2013-10-01T17:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170529",
    "user": "jdemeyer"
}
```

Please try the following: extract the spkg and try to "manually" configure it by doing:

```
$ cd mpir-2.6.0.p3/src
$ ./configure
```


I'm interested to see the output of that, as well as the resulting `config.log` file.



---

archive/issue_comments_170530.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> Please try the following: extract the spkg and try to \"manually\" configure it by doing:\n> {{{\n> $ cd mpir-2.6.0.p3/src\n> $ ./configure\n> }}}\n> \n> I'm interested to see the output of that, as well as the resulting `config.log` file.\n\nThis fails almost immediately because it thinks that clang is a broken compiler: [config.log.](http://sage.math.washington.edu/home/palmieri/misc/config.log)",
    "created_at": "2013-10-01T18:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170530",
    "user": "jhpalmieri"
}
```

Replying to [comment:19 jdemeyer]:
> Please try the following: extract the spkg and try to "manually" configure it by doing:
> {{{
> $ cd mpir-2.6.0.p3/src
> $ ./configure
> }}}
> 
> I'm interested to see the output of that, as well as the resulting `config.log` file.

This fails almost immediately because it thinks that clang is a broken compiler: [config.log.](http://sage.math.washington.edu/home/palmieri/misc/config.log)



---

archive/issue_comments_170531.json:
```json
{
    "body": "Aah sorry, I meant extract the spkg, **apply the patches** and then do what you did.",
    "created_at": "2013-10-01T18:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170531",
    "user": "jdemeyer"
}
```

Aah sorry, I meant extract the spkg, **apply the patches** and then do what you did.



---

archive/issue_comments_170532.json:
```json
{
    "body": "Okay, here is [config.log](http://sage.math.washington.edu/home/palmieri/misc/config.log) and [the output from running `./configure`](http://sage.math.washington.edu/home/palmieri/misc/configure-output.txt).",
    "created_at": "2013-10-01T18:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170532",
    "user": "jhpalmieri"
}
```

Okay, here is [config.log](http://sage.math.washington.edu/home/palmieri/misc/config.log) and [the output from running `./configure`](http://sage.math.washington.edu/home/palmieri/misc/configure-output.txt).



---

archive/issue_comments_170533.json:
```json
{
    "body": "Hmm, at first sight looks like a genuine compiler bug, but that's hard to say from here...",
    "created_at": "2013-10-01T19:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170533",
    "user": "jdemeyer"
}
```

Hmm, at first sight looks like a genuine compiler bug, but that's hard to say from here...



---

archive/issue_comments_170534.json:
```json
{
    "body": "Could you try the same (i.e. manual `./configure`) with `export CC=clang`?",
    "created_at": "2013-10-01T19:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170534",
    "user": "jdemeyer"
}
```

Could you try the same (i.e. manual `./configure`) with `export CC=clang`?



---

archive/issue_comments_170535.json:
```json
{
    "body": "With `export CC=clang`: [config.log](http://sage.math.washington.edu/home/palmieri/misc/clang-config.log) and [configure output](http://sage.math.washington.edu/home/palmieri/misc/config-with-clang-output).\n\nBy the way, running `make` seems to succeed after all of these manual runs of `./configure`. Once I set `CFLAGS` as Sage does -- that is,\n\n```\nexport CFLAGS=\"-m32 -O2 -fomit-frame-pointer -mtune=corei7-avx -march=corei7-avx  -g\"\n```\n\nthen do `./configure` and `make`, it fails. Remove the `-m32` flag and it works again. Can we just remove `-m32` in the spkg?",
    "created_at": "2013-10-01T19:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170535",
    "user": "jhpalmieri"
}
```

With `export CC=clang`: [config.log](http://sage.math.washington.edu/home/palmieri/misc/clang-config.log) and [configure output](http://sage.math.washington.edu/home/palmieri/misc/config-with-clang-output).

By the way, running `make` seems to succeed after all of these manual runs of `./configure`. Once I set `CFLAGS` as Sage does -- that is,

```
export CFLAGS="-m32 -O2 -fomit-frame-pointer -mtune=corei7-avx -march=corei7-avx  -g"
```

then do `./configure` and `make`, it fails. Remove the `-m32` flag and it works again. Can we just remove `-m32` in the spkg?



---

archive/issue_comments_170536.json:
```json
{
    "body": "It seems that `gcc` is identical to `clang`, so that didn't make a difference.\n\n> Can we just remove `-m32` in the spkg?\nThere is no `-m32` in the spkg. The problem is that `-m64` simply doesn't work, so MPIR's `configure` falls back to `-m32`.",
    "created_at": "2013-10-01T19:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170536",
    "user": "jdemeyer"
}
```

It seems that `gcc` is identical to `clang`, so that didn't make a difference.

> Can we just remove `-m32` in the spkg?
There is no `-m32` in the spkg. The problem is that `-m64` simply doesn't work, so MPIR's `configure` falls back to `-m32`.



---

archive/issue_comments_170537.json:
```json
{
    "body": "Replying to [comment:25 jhpalmieri]:\n> Remove the `-m32` flag and it works again.\nExactly what does \"it\" refer to here? Did you manage to `./configure` MPIR as 64-bit?",
    "created_at": "2013-10-01T19:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170537",
    "user": "jdemeyer"
}
```

Replying to [comment:25 jhpalmieri]:
> Remove the `-m32` flag and it works again.
Exactly what does "it" refer to here? Did you manage to `./configure` MPIR as 64-bit?



---

archive/issue_comments_170538.json:
```json
{
    "body": "I mean that if I do\n\n```\nexport CFLAGS=\"-O2 -fomit-frame-pointer -mtune=corei7-avx -march=corei7-avx  -g\"\n./configure\nmake\n```\n\nit finishes without error. (I haven't tried a full Sage build on top of this, of course.) If `CFLAGS` also includes `-m32`, then `make` fails.\n\nIn the spkg, we could have some code like\n\n```diff\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -275,6 +275,12 @@\n echo \"  ABI:     $user_abi\"\n echo \"  (CPP, CPPFLAGS, CXX and CXXFLAGS are listed below; these don't get modified.)\"\n \n+# Fix bug with Xcode 5.0 on Darwin: mpir doesn't build using the -m32\n+# flag with the gcc from this version of Xcode.\n+if [ blah ]; then        # using Xcode 5.0 on Darwin\n+    mpir_cflags=...      # remove -m32 from $mpir_cflags\n+fi\n+\n # Finally: use MPIR's flags, plus those required by Sage for the\n # package to build properly, plus those specified by the user.\n CFLAGS=\"$mpir_cflags $required_cflags $user_cflags\"\n```\n\nI have no idea if this is actually a good idea, though.",
    "created_at": "2013-10-01T20:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170538",
    "user": "jhpalmieri"
}
```

I mean that if I do

```
export CFLAGS="-O2 -fomit-frame-pointer -mtune=corei7-avx -march=corei7-avx  -g"
./configure
make
```

it finishes without error. (I haven't tried a full Sage build on top of this, of course.) If `CFLAGS` also includes `-m32`, then `make` fails.

In the spkg, we could have some code like

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -275,6 +275,12 @@
 echo "  ABI:     $user_abi"
 echo "  (CPP, CPPFLAGS, CXX and CXXFLAGS are listed below; these don't get modified.)"
 
+# Fix bug with Xcode 5.0 on Darwin: mpir doesn't build using the -m32
+# flag with the gcc from this version of Xcode.
+if [ blah ]; then        # using Xcode 5.0 on Darwin
+    mpir_cflags=...      # remove -m32 from $mpir_cflags
+fi
+
 # Finally: use MPIR's flags, plus those required by Sage for the
 # package to build properly, plus those specified by the user.
 CFLAGS="$mpir_cflags $required_cflags $user_cflags"
```

I have no idea if this is actually a good idea, though.



---

archive/issue_comments_170539.json:
```json
{
    "body": "Now I *have* tried a full Sage build on top of this, and the build finishes. I guess that isn't too surprising, because mpir gets rebuilt with Sage's GCC anyway.\n\nI'll try again with a more carefully constructed spkg, and I'll also run the full test suite. Here's my actual proposed patch to spkg-install:\n\n```diff\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -275,6 +275,21 @@\n echo \"  ABI:     $user_abi\"\n echo \"  (CPP, CPPFLAGS, CXX and CXXFLAGS are listed below; these don't get modified.)\"\n \n+# Fix bug with Xcode 5.0 or later on Darwin: mpir doesn't build using\n+# the -m32 flag with the gcc from this version of Xcode, so remove\n+# -m32 from CFLAGS.\n+if [ \"$UNAME\" = \"Darwin\" ]; then\n+    # Xcode version detection, etc., taken from spkg/base/prereq\n+    XCODE_VERS=`xcodebuild -version 2> /dev/null | grep Xcode | sed -e 's/[A-Za-z ]//g'`\n+    if [ -z $XCODE_VERS ]; then\n+        XCODE_VERS=\"2\"\n+    fi\n+    XCODE_VERS_MAJOR=`echo $XCODE_VERS | cut '-d.' -f1`\n+    if [ $XCODE_VERS_MAJOR -gt 4 ]; then\n+        mpir_cflags=`echo $mpir_cflags | sed 's/-m32//'` # remove -m32\n+    fi\n+fi\n+\n # Finally: use MPIR's flags, plus those required by Sage for the\n # package to build properly, plus those specified by the user.\n CFLAGS=\"$mpir_cflags $required_cflags $user_cflags\"\n```\n",
    "created_at": "2013-10-01T22:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170539",
    "user": "jhpalmieri"
}
```

Now I *have* tried a full Sage build on top of this, and the build finishes. I guess that isn't too surprising, because mpir gets rebuilt with Sage's GCC anyway.

I'll try again with a more carefully constructed spkg, and I'll also run the full test suite. Here's my actual proposed patch to spkg-install:

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -275,6 +275,21 @@
 echo "  ABI:     $user_abi"
 echo "  (CPP, CPPFLAGS, CXX and CXXFLAGS are listed below; these don't get modified.)"
 
+# Fix bug with Xcode 5.0 or later on Darwin: mpir doesn't build using
+# the -m32 flag with the gcc from this version of Xcode, so remove
+# -m32 from CFLAGS.
+if [ "$UNAME" = "Darwin" ]; then
+    # Xcode version detection, etc., taken from spkg/base/prereq
+    XCODE_VERS=`xcodebuild -version 2> /dev/null | grep Xcode | sed -e 's/[A-Za-z ]//g'`
+    if [ -z $XCODE_VERS ]; then
+        XCODE_VERS="2"
+    fi
+    XCODE_VERS_MAJOR=`echo $XCODE_VERS | cut '-d.' -f1`
+    if [ $XCODE_VERS_MAJOR -gt 4 ]; then
+        mpir_cflags=`echo $mpir_cflags | sed 's/-m32//'` # remove -m32
+    fi
+fi
+
 # Finally: use MPIR's flags, plus those required by Sage for the
 # package to build properly, plus those specified by the user.
 CFLAGS="$mpir_cflags $required_cflags $user_cflags"
```




---

archive/issue_comments_170540.json:
```json
{
    "body": "I used an spkg with this patch, took an otherwise clean tarball for 5.12.rc0, did `export SAGE_CHECK=yes`. Then `make ptestlong` was completely successful.",
    "created_at": "2013-10-02T01:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170540",
    "user": "jhpalmieri"
}
```

I used an spkg with this patch, took an otherwise clean tarball for 5.12.rc0, did `export SAGE_CHECK=yes`. Then `make ptestlong` was completely successful.



---

archive/issue_comments_170541.json:
```json
{
    "body": "What does\n\n```\n$ gcc -E -dM -x c /dev/null |grep -i clang\n```\n\nsay on that machine?\n\nInstead of fiddling with `CFLAGS`, I propose to try to \"fix\" the test causing the 64-bit build to fail.",
    "created_at": "2013-10-02T07:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170541",
    "user": "jdemeyer"
}
```

What does

```
$ gcc -E -dM -x c /dev/null |grep -i clang
```

say on that machine?

Instead of fiddling with `CFLAGS`, I propose to try to "fix" the test causing the 64-bit build to fail.



---

archive/issue_comments_170542.json:
```json
{
    "body": "I prepared a new version of the spkg with a simple fix, can you test it? Simply try to install the spkg normally through Sage. If that fails, send me the file `configure-empty.log`",
    "created_at": "2013-10-02T07:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170542",
    "user": "jdemeyer"
}
```

I prepared a new version of the spkg with a simple fix, can you test it? Simply try to install the spkg normally through Sage. If that fails, send me the file `configure-empty.log`



---

archive/issue_comments_170543.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-10-02T07:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170543",
    "user": "jdemeyer"
}
```

Attachment



---

archive/issue_comments_170544.json:
```json
{
    "body": "Replying to [comment:31 jdemeyer]:\n> What does\n> {{{\n> $ gcc -E -dM -x c /dev/null |grep -i clang\n> }}}\n> say on that machine?\n\n\n```\ngcc -E -dM -x c /dev/null |grep -i clang\n#define __VERSION__ \"4.2.1 Compatible Apple LLVM 5.0 (clang-500.2.76)\"\n#define __clang__ 1\n#define __clang_major__ 5\n#define __clang_minor__ 0\n#define __clang_patchlevel__ 0\n#define __clang_version__ \"5.0 (clang-500.2.76)\"\n```\n\n\nThe new spkg seems to work. I'm trying a full Sage build to make sure.",
    "created_at": "2013-10-02T15:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170544",
    "user": "jhpalmieri"
}
```

Replying to [comment:31 jdemeyer]:
> What does
> {{{
> $ gcc -E -dM -x c /dev/null |grep -i clang
> }}}
> say on that machine?


```
gcc -E -dM -x c /dev/null |grep -i clang
#define __VERSION__ "4.2.1 Compatible Apple LLVM 5.0 (clang-500.2.76)"
#define __clang__ 1
#define __clang_major__ 5
#define __clang_minor__ 0
#define __clang_patchlevel__ 0
#define __clang_version__ "5.0 (clang-500.2.76)"
```


The new spkg seems to work. I'm trying a full Sage build to make sure.



---

archive/issue_comments_170545.json:
```json
{
    "body": "Replying to [comment:35 jhpalmieri]:\n> {{{\n> gcc -E -dM -x c /dev/null |grep -i clang\n> #define __VERSION__ \"4.2.1 Compatible Apple LLVM 5.0 (clang-500.2.76)\"\n> #define __clang__ 1\n> #define __clang_major__ 5\n> #define __clang_minor__ 0\n> #define __clang_patchlevel__ 0\n> #define __clang_version__ \"5.0 (clang-500.2.76)\"\n> }}}\n\nThis confirms my suspicion that `gcc` really is Clang.",
    "created_at": "2013-10-02T16:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170545",
    "user": "jdemeyer"
}
```

Replying to [comment:35 jhpalmieri]:
> {{{
> gcc -E -dM -x c /dev/null |grep -i clang
> #define __VERSION__ "4.2.1 Compatible Apple LLVM 5.0 (clang-500.2.76)"
> #define __clang__ 1
> #define __clang_major__ 5
> #define __clang_minor__ 0
> #define __clang_patchlevel__ 0
> #define __clang_version__ "5.0 (clang-500.2.76)"
> }}}

This confirms my suspicion that `gcc` really is Clang.



---

archive/issue_comments_170546.json:
```json
{
    "body": "The doc patch is certainly fine. As far as the spkg goes, first, is it worth it to rebase the patch files so we don't get the \"offset -128 lines\" messages? Second, it seems to work, and I understand in principle what the changes are, but I'm not an expert in `acinclude.m4` files. I think I'll give it a positive review anyway: this ticket is very important (I think a blocker) since anyone with OS X and the most recent Xcode won't be able to build Sage without it.",
    "created_at": "2013-10-02T17:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170546",
    "user": "jhpalmieri"
}
```

The doc patch is certainly fine. As far as the spkg goes, first, is it worth it to rebase the patch files so we don't get the "offset -128 lines" messages? Second, it seems to work, and I understand in principle what the changes are, but I'm not an expert in `acinclude.m4` files. I think I'll give it a positive review anyway: this ticket is very important (I think a blocker) since anyone with OS X and the most recent Xcode won't be able to build Sage without it.



---

archive/issue_comments_170547.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2013-10-02T17:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170547",
    "user": "jhpalmieri"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_170548.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-10-02T17:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170548",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170549.json:
```json
{
    "body": "Replying to [comment:38 jhpalmieri]:\n> As far as the spkg goes, first, is it worth it to rebase the patch files so we don't get the \"offset -128 lines\" messages?\nIn my opinion, no. Offsets are harmless.\n\n> this ticket is very important (I think a blocker)\nI agree. In fact, it justifies an extra rc for sage-5.12.",
    "created_at": "2013-10-02T19:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170549",
    "user": "jdemeyer"
}
```

Replying to [comment:38 jhpalmieri]:
> As far as the spkg goes, first, is it worth it to rebase the patch files so we don't get the "offset -128 lines" messages?
In my opinion, no. Offsets are harmless.

> this ticket is very important (I think a blocker)
I agree. In fact, it justifies an extra rc for sage-5.12.



---

archive/issue_comments_170550.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-10-02T19:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170550",
    "user": "jdemeyer"
}
```

Attachment



---

archive/issue_comments_170551.json:
```json
{
    "body": "By the way, thank you for taking care of this so quickly after my message to sage-devel. It wasn't so urgent until Apple released Xcode 5.0.",
    "created_at": "2013-10-02T23:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170551",
    "user": "jhpalmieri"
}
```

By the way, thank you for taking care of this so quickly after my message to sage-devel. It wasn't so urgent until Apple released Xcode 5.0.



---

archive/issue_comments_170552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-10-04T07:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170552",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_170553.json:
```json
{
    "body": "Replying to [ticket:13948 jpflori]:\n> There are two problems with the MPIR `configure` script for Clang:\n> \n> 1) It uses `__builtin_malloc()` which Clang doesn't have, which is an MPIR upstream bug (up to and including MPIR 2.6.0). The spkg simply removes this test.\n> \n> 2) The \"long long reliability\" test fails with a linker error. This looks like a Clang bug.\n\nThe latter one apparently now hits GCC (5.0.1 RC1) as well... B)\n\n(From `config.log` it also seems that the `__builtin_alloca()` availability test fails for a different reason, but that's harmless.)",
    "created_at": "2015-04-18T18:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170553",
    "user": "leif"
}
```

Replying to [ticket:13948 jpflori]:
> There are two problems with the MPIR `configure` script for Clang:
> 
> 1) It uses `__builtin_malloc()` which Clang doesn't have, which is an MPIR upstream bug (up to and including MPIR 2.6.0). The spkg simply removes this test.
> 
> 2) The "long long reliability" test fails with a linker error. This looks like a Clang bug.

The latter one apparently now hits GCC (5.0.1 RC1) as well... B)

(From `config.log` it also seems that the `__builtin_alloca()` availability test fails for a different reason, but that's harmless.)



---

archive/issue_comments_170554.json:
```json
{
    "body": "Replying to [comment:42 leif]:\n> > 2) The \"long long reliability\" test fails with a linker error. This looks like a Clang bug.\n> \n> The latter one apparently now hits GCC (5.0.1 RC1) as well... B)\n\nThe difference appears to be\n\n```C\n#define __GNUC_STDC_INLINE__ 1\n```\n\nin GCC 5.x vs.\n\n```C\n#define __GNUC_GNU_INLINE__ 1\n```\n\nin older versions.  (In each case the other macro isn't defined, corresponding to `0`.)",
    "created_at": "2015-04-18T19:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170554",
    "user": "leif"
}
```

Replying to [comment:42 leif]:
> > 2) The "long long reliability" test fails with a linker error. This looks like a Clang bug.
> 
> The latter one apparently now hits GCC (5.0.1 RC1) as well... B)

The difference appears to be

```C
#define __GNUC_STDC_INLINE__ 1
```

in GCC 5.x vs.

```C
#define __GNUC_GNU_INLINE__ 1
```

in older versions.  (In each case the other macro isn't defined, corresponding to `0`.)



---

archive/issue_comments_170555.json:
```json
{
    "body": "Replying to [comment:43 leif]:\n> Replying to [comment:42 leif]:\n> > > 2) The \"long long reliability\" test fails with a linker error. This looks like a Clang bug.\n> > \n> > The latter one apparently now hits GCC (5.0.1 RC1) as well... B)\n> \n> The difference appears to be\n> {{{\n> #!C\n> #define __GNUC_STDC_INLINE__ 1\n> }}}\n> in GCC 5.x vs.\n> {{{\n> #!C\n> #define __GNUC_GNU_INLINE__ 1\n> }}}\n> in older versions.  (In each case the other macro isn't defined, corresponding to `0`.)\n\nFollow-up: #18247",
    "created_at": "2015-04-18T19:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13744#issuecomment-170555",
    "user": "leif"
}
```

Replying to [comment:43 leif]:
> Replying to [comment:42 leif]:
> > > 2) The "long long reliability" test fails with a linker error. This looks like a Clang bug.
> > 
> > The latter one apparently now hits GCC (5.0.1 RC1) as well... B)
> 
> The difference appears to be
> {{{
> #!C
> #define __GNUC_STDC_INLINE__ 1
> }}}
> in GCC 5.x vs.
> {{{
> #!C
> #define __GNUC_GNU_INLINE__ 1
> }}}
> in older versions.  (In each case the other macro isn't defined, corresponding to `0`.)

Follow-up: #18247
