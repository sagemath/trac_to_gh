# Issue 15808: Polytope volume function engines produce different results

Issue created by migration from https://trac.sagemath.org/ticket/16045

Original creator: wishcow

Original creation time: 2014-04-02 07:50:31

CC:  jakobkroeker mkoeppe vdelecroix jipilab mforets moritz slabbe

Keywords: polytope, volume, lrs_volume

The lrs engine for polytope volume calculates volume respective to the dimension of the polytope,
while the auto engine calculates volume respective to the dimension of the ambient space.

Example:



```
m3 = matrix(ZZ, [[0,0,0],[0,0,1]])
p = Polyhedron(m3)
p.volume(engine="lrs")
p.volume()

1.0
0
```


(Note: The lrs behavior actually has some benefits, since it allows calculation of volumes of facets without reducing the dimension of the ambient space.)


---

Comment by jakobkroeker created at 2017-03-04 00:22:56

what is a rational polytope? defined over rationals?

At least I could not get from documentation that using engine="lrs"
implies  calculates volume respective to the dimension of the polytope
and using 'auto' implies calculating volume respective to the dimension of the ambient space,
so for me it is a wrong answer issue.


---

Comment by jipilab created at 2017-03-09 18:30:58

This is actually very useful to have this. (I was actually looking for such a function just now).

It should perhaps be better documented with an optional parameter to switch this on and off and let `lrs` compute the volume of faces.


---

Comment by mkoeppe created at 2017-03-09 18:35:51

I agree, a keyword parameter that controls the measure used for lower-dim faces would be useful.
There are currently 3 options:

- 0
- answer according to standard lower-dim measure
- LattE always returns a rational answer, by normalizing with respect to the intersection lattice.


---

Comment by moritz created at 2017-03-12 23:04:04

A few questions:

 - What should be the name for the parameter (which is essentially boolean) that controls what measure to be used? 
I can think of `inherent`, `induced`, `relative`, `ambient`... (I think `instrinsic` would not be a good idea.)

 - Should the default for the parameter (if none is given) depend on the `engine` chosen? 
 - What should happen if the `engine` is not able to compute the inherent volume?


---

Comment by vdelecroix created at 2017-03-14 12:23:24

Replying to [comment:4 moritz]:
> A few questions:
> 
>  - What should be the name for the parameter (which is essentially boolean) that controls what measure to be used?  I can think of `inherent`, `induced`, `relative`, `ambient`... (I think `instrinsic` would not be a good idea.)

It is a troolean (at least for rational polytopes) as mentioned in [comment:3 comment:3] of Marcelo.

>  - Should the default for the parameter (if none is given) depend on the `engine` chosen? 

No.

>  - What should happen if the `engine` is not able to compute the inherent volume?

A `ValueError` or a `RuntimeError`.


---

Comment by moritz created at 2017-03-16 17:41:21

So how about the following solve the problem:

We introduce a parameter "measure" with the following options:

  - "ambient" (the default?!)
  - "induced" 
  - "latte_renormalized" (or something that Matthias likes)

I suppose it would be wisest to catch measure="ambient" if the polytope is not full-dimensional and return "0" for all the engines (Even if the engines only can compute the induced volume of the polytope)

Should it could work like:

```
sage: m3 = matrix(ZZ, [[0,0,0],[0,0,1]])
sage: p = Polyhedron(m3)
sage: p.volume()
0
sage: p.volume(engine="lrs", measure="induced")
1.0
sage: p.volume(engine="lrs", measure="ambient")
0
sage: p.volume(measure="induced")
ValueError or a RuntimeError: "Please choose a different engine."
```


Maybe it would be ok to choose a differnt engine for the last command automatically.

What do you think?


---

Comment by vdelecroix created at 2017-03-16 17:58:20

Replying to [comment:8 moritz]:
> So how about the following solve the problem:
> 
> We introduce a parameter "measure" with the following options:
> 
>   - "ambient" (the default?!)
>   - "induced" 
>   - "latte_renormalized" (or something that Matthias likes)

Note that "latte_renormalized" only make sense for polyhedron defined over Q. I guess it would be better `"induced_rational"` rather than any reference to latte. This renormalization is very natural.

> I suppose it would be wisest to catch measure="ambient" if the polytope is not full-dimensional and return "0" for all the engines (Even if the engines only can compute the induced volume of the polytope)
> 
> Should it could work like:
> {{{
> sage: m3 = matrix(ZZ, [[0,0,0],[0,0,1]])
> sage: p = Polyhedron(m3)
> sage: p.volume()
> 0
> sage: p.volume(engine="lrs", measure="induced")
> 1.0
> sage: p.volume(engine="lrs", measure="ambient")
> 0
> sage: p.volume(measure="induced")
> ValueError or a RuntimeError: "Please choose a different engine."
> }}}
>
> Maybe it would be ok to choose a differnt engine for the last command automatically.

+1. I also do not like the behavior of the last command. The default choice of the engine should take into account the `measure` argument (which should be firt BTW).


```
def volume(measure="ambient", engine=None):
    r"""
    Return the volume (or relative volume) of the polytope
    """
```



---

Comment by mforets created at 2017-03-16 18:19:42

minor remark: ticket #20887 also touches the polyhedron volume function


---

Comment by mkoeppe created at 2017-03-16 18:36:09

+1 on `"induced_rational"`


---

Comment by moritz created at 2017-03-31 16:03:01

I am building on #20887 and introduced a `measure` option.

Here is a test (make sure ou have latte_int, topcom and lrs installed)


```
sage: C = polytopes.cube()
sage: P = polytopes.permutahedron(4)
sage: P
A 3-dimensional polyhedron in ZZ^4 defined as the convex hull of 24 vertices
sage: measures = ["ambient", "induced", "induced_rational"]
sage: engines = ["auto", "internal", "TOPCOM", "lrs", "latte"]
sage: for m in measures:
....:     for e in engines:
....:         try:
....:             pvol = P.volume(measure=m, engine=e)
....:         except TypeError as err:
....:             pvol = err
....:         try:
....:             cvol = C.volume(measure=m, engine=e)
....:         except Exception as err:
....:             cvol = err
....:         print 'measure =',m, 'engine =',e 
....:         print 'not-fulldimensional example: ', pvol
....:         print 'full-dimensional example: ', cvol
....:         print '--------------'
....:         
measure = ambient engine = auto
not-fulldimensional example:  0
full-dimensional example:  8
--------------
measure = ambient engine = internal
not-fulldimensional example:  0
full-dimensional example:  8
--------------
measure = ambient engine = TOPCOM
not-fulldimensional example:  0
full-dimensional example:  8
--------------
measure = ambient engine = lrs
not-fulldimensional example:  0
full-dimensional example:  8.0
--------------
measure = ambient engine = latte
not-fulldimensional example:  0
full-dimensional example:  8
--------------
measure = induced engine = auto
not-fulldimensional example:  16.0
full-dimensional example:  8.0
--------------
measure = induced engine = internal
not-fulldimensional example:  The induced measure can only be computed with the engine set to `auto` or `lrs`
full-dimensional example:  8.0
--------------
measure = induced engine = TOPCOM
not-fulldimensional example:  The induced measure can only be computed with the engine set to `auto` or `lrs`
full-dimensional example:  8.0
--------------
measure = induced engine = lrs
not-fulldimensional example:  16.0
full-dimensional example:  8.0
--------------
measure = induced engine = latte
not-fulldimensional example:  The induced measure can only be computed with the engine set to `auto` or `lrs`
full-dimensional example:  8.0
--------------
measure = induced_rational engine = auto
not-fulldimensional example:  16
full-dimensional example:  8
--------------
measure = induced_rational engine = internal
not-fulldimensional example:  The induced rational measure can only be computed with the engine set to `auto` or `latte`
full-dimensional example:  8
--------------
measure = induced_rational engine = TOPCOM
not-fulldimensional example:  The induced rational measure can only be computed with the engine set to `auto` or `latte`
full-dimensional example:  8
--------------
measure = induced_rational engine = lrs
not-fulldimensional example:  The induced rational measure can only be computed with the engine set to `auto` or `latte`
full-dimensional example:  8
--------------
measure = induced_rational engine = latte
not-fulldimensional example:  16
full-dimensional example:  8
--------------
```



The options are explained as 


```
        - ``measure`` -- string. The measure to use. Allowed values are:

          * ``ambient``: Lebesgue measure of ambient space (volume)
          * ``induced``: Lebesgue measure of affine hull (relative volume)
          * ``induced_rational``: TODO: explanation (only makes sense for integer polytopes?!)

        - ``engine`` -- string. The backend to use. Allowed values are:

          * ``'auto'`` (default): choose engine according to measure
          * ``'internal'``: see :meth:`triangulate`.
          * ``'TOPCOM'``: see :meth:`triangulate`.
          * ``'lrs'``: use David Avis's lrs program (optional).
          * ``'latte'``: use LattE integrale program (optional).
```


What could I write for `induced_rational`?

I have not yet added doctests.

Comments welcome!
----
New commits:


---

Comment by moritz created at 2017-03-31 16:03:01

Changing status from new to needs_info.


---

Comment by vdelecroix created at 2017-03-31 16:07:25

> What could I write for induced_rational? 

(I think this is describe in the latte manual) Given the polytope P in Z<sup>d</sup> it spans an affine space E. The ambient measure is the only scaling of the Lebesgue measure so that the lattice `E \cap Z^d` has covolume 1 in E.


---

Comment by vdelecroix created at 2017-03-31 16:11:38

If you merge commits from #20887 here you should set it as a dependency.


---

Comment by mkoeppe created at 2017-03-31 16:14:09

Note that it's also defined for rational polytopes; and more generally for any (possibly irrational) translation of those.


---

Comment by mkoeppe created at 2017-04-02 18:15:58

Changing status from needs_info to needs_work.


---

Comment by moritz created at 2017-04-03 09:01:53

I noticed that "lrs" is in fact **not** computing the Lebesgue measure of the affine hull. Form the lrs web-page: 


  If the option is applied to a V-representation of  a polytope that is not full dimensional, the volume of a projected polytope is computed. The projection used is to the lexicographically smallest coordinate subspace, see Avis, Fukuda, Picozzi (2002).  


In fact, this shows already in one of the old doctests:

```
sage: I = Polyhedron([(0,0), (1,1)])
sage: I.volume(engine='lrs') #optional - lrslib
1.0
```

The result with the induced measure should be `sqrt(2)` (or `1.414213562373095` I guess)

So this should not be used to compute the volume of facets, as mentioned in comment:2 !

In any case I still think it would be useful to have the option for this measure, except that at the moment, none of the engines is able to actually compute appropriate induced volumes. 

Perhaps it would be useful to open a ticket to ask for a function, that does compute the induced measure?! A naive implementation could choose an affine basis of vertices and then some isometry.


---

Comment by jipilab created at 2017-04-04 07:41:45

It would be nice to have an explanation of these subtleties in the doc of the function (as shown by Moritz). Consequently, the issue described in the ticket would be resolved so as to address the reason why it returns different results.

IMHO, I guess it is okay to have one method returning different results depending on the value of the parameters. So +1 to have an optional parameter which specifies the measure (and hence the engine in some cases) as Vincent mentionned.

Finally, add a TODO that would ask for the lebesgue measure which would be addressed in a separate ticket and explain what `lrs` is doing with a possible link to the webpage.

What do you think?


---

Comment by moritz created at 2017-04-12 09:12:42

One thing that would be useful to have, would be a function, that takes a non full-dimensional poytope and returns a full-dimensional one that is affinely equivalent to the original one. Note that the usual `.affine_hull` method does not achive that goal:

```
sage: p = Polyhedron([[0,0],[1,1]])
sage: p.affine_hull()
A 1-dimensional polyhedron in ZZ^1 defined as the convex hull of 2 vertices
sage: p.affine_hull().vertices()
(A vertex at (0), A vertex at (1))
```

The length of the affine hull is not `sqrt(2)` as one might expect. Another example would be 

``` 
sage: s = polytopes.simplex()
sage: s
A 3-dimensional polyhedron in ZZ^4 defined as the convex hull of 4 vertices
sage: s.affine_hull()
A 3-dimensional polyhedron in ZZ^3 defined as the convex hull of 4 vertices
sage: _.show()
Launched jmol viewer for Graphics3d Object
```

Here the simplex is not regular after using `.affine_hull`. 

Consider this new `affine_hull` function:


```
def affine_hull(P, preserve_volume=True):
    if P.ambient_dim() == P.dim():
        return P
    Q = P.translation(-vector(P.vertices()[0]))
    v = Q.vertices()[0]
    assert list(v) == P.ambient_dim()*[0]
    import itertools
    M = Matrix([list(w) for w in itertools.islice(v.neighbors(), P.dim())])
    if P.base_ring() in [ZZ,QQ]:
        M = Matrix(AA,M)
    A = M.gram_schmidt(orthonormal = True)[0]
    return Polyhedron([A*vector(v) for v in Q.vertices()])
```



Using this gets the desired results:

```
sage: p = Polyhedron([[0,0],[1,1]])
sage: affine_hull(p)
A 1-dimensional polyhedron in AA^1 defined as the convex hull of 2 vertices
sage: affine_hull(p).vertices()
(A vertex at (0), A vertex at (1.414213562373095?))
```

It is actually useful to plot the permutahedron nicely:

```
sage: P = polytopes.permutahedron(4)
sage: P
A 3-dimensional polyhedron in ZZ^4 defined as the convex hull of 24 vertices
sage: affine_hull(P)
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 24 vertices
sage: _.plot()
Launched jmol viewer for Graphics3d Object
```




 (There is an inherent problem, that considering a rational polytope as full-dimensional polytope in its affine hull might lead to non-rational polyopes: basically you want to work in a field with square roots.)

In any case I propose to introduce an improved version of the `.affine_hull` method, perhaps with an parameter `preserve_volume=True` (or `isometry=True`) an then use this method to handle the cases of the volume of non full-dimenional polytopes here. 


What do you think?


---

Comment by vdelecroix created at 2017-04-12 09:36:27

Replying to [comment:21 moritz]:
> One thing that would be useful to have, would be a function, that takes a non full-dimensional poytope and returns a full-dimensional one that is affinely equivalent to the original one.
>
> [...]
> 
> What do you think?

I agree that it would be useful and essentially straightforward (ignoring details about base ring). You can open a *new* ticket and move the discussion there.


---

Comment by moritz created at 2017-04-13 11:58:35

Replying to [comment:22 vdelecroix]:
> I agree that it would be useful and essentially straightforward (ignoring details about base ring). You can open a *new* ticket and move the discussion there.

I opened #22804 and already added some code. This could eventually become a depency here (#16045) and we can end up with a '.volume' method that is more useful...


---

Comment by git created at 2017-06-29 18:59:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-06-29 19:03:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-06-29 19:13:32

I now used the new affine hull function to provide induced volumes; comments welcome!

I would like to include a good example / doctest for the induced rational volume, any hints? (Also to improve the description ind the section "Input"?)


---

Comment by moritz created at 2017-06-29 19:13:32

Changing status from needs_work to needs_info.


---

Comment by vdelecroix created at 2017-06-29 22:29:18

Replying to [comment:27 moritz]:
> I now used the new affine hull function to provide induced volumes; comments welcome!
> 
> I would like to include a good example / doctest for the induced rational volume, any hints? (Also to improve the description ind the section "Input"?)

Volume of the line segment between `(a,0)` and `(0,b)` are already good examples. Then you can do that for the triangle `(a,0,0)`, `(0,b,0)` and `(0,0,c)`. And you can consider polytopes obtained by permuting the entries of a vector like

```
sage: Polyhedron(vertices=[(0,0,1,1),(0,1,1,0),(1,1,0,0)])
A 2-dimensional polyhedron in ZZ^4 defined as the convex hull of 3 vertices
```



---

Comment by git created at 2017-06-30 08:14:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-07-03 09:36:56

Changing status from needs_info to needs_review.


---

Comment by jipilab created at 2017-07-12 09:48:28

Hi Moritz,

Small comments:

 - In the doc: `measure.Different engines`   (add space)
 - Further, right after this sentence, could there be a short sentence, maybe as a note, to say what "for lattice polytope" means exactly?.
 - For the example, `P = Polyhedron([[0, 0], [1, 1]])` I would also add the output with the parameter `induced_rational`. This will make it contrast right away, rather than waiting for polyhedron `I`. (It is minor but very instructive).
 -  Perhaps name the second polyhedron `P` differently.
 - `if polyhedron is actually full-dimensional, return volume with ambient measuren` (remove the `n` at the end).

You have some failed tests:


```
    **********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 4373, in sage.geometry.polyhedron.base.Polyhedron_base.volume
Failed example:
    w = Dinexact.faces(2)[0].as_polyhedron().volume(measure='induced', engine='internal'); w
Expected:
    1.534062710738235
Got:
    1.5340627107382352
```



```
Failed example:
    I.volume(measure='induced_rational')
Exception raised:
    NotImplementedError: You must install the optional latte_int package for this function to work.
```


(add `# optional -- latte_int`)


---

Comment by jipilab created at 2017-07-12 09:48:28

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-13 19:31:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by moritz created at 2017-07-13 19:36:52

Thanks for the comments, JP!

I fixed everything, except perhaps the following; where I was not quite sure what is going on. (Perhaps somehow different machines have different ideas what a real double is..)


```
    w = Dinexact.faces(2)[0].as_polyhedron().volume(measure='induced', engine='internal'); w
Expected:
    1.534062710738235
Got:
    1.5340627107382352
```


I hope I managed to add `# optional -- latte_int` in all relevant places: I didn't test it without `latte_int` installed.


---

Comment by moritz created at 2017-07-13 19:36:52

Changing status from needs_work to needs_info.


---

Comment by slabbe created at 2017-07-17 08:46:59

Use [# abs tol](https://github.com/sagemath/sage/blob/develop/src/sage/symbolic/integration/integral.py#L726) marker in the comment. See [Special Markup to Influence Doctests](http://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests) in the documentation.


---

Comment by git created at 2017-07-17 11:17:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by moritz created at 2017-07-17 11:24:45

Changing status from needs_info to needs_review.


---

Comment by moritz created at 2017-07-17 11:24:45

Thanks, SÃ©bastian! 
I added the marker..


---

Comment by jipilab created at 2017-08-21 16:18:04

Changing keywords from "polytope, volume, lrs_volume" to "polytope, volume, lrs_volume, days88".


---

Comment by jipilab created at 2017-08-21 21:48:01

There is a hidden failed test (probably got caught by chance by the bot):


```
sage -t --long src/sage/geometry/polyhedron/backend_normaliz.py
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 412, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.integral_hull
Failed example:
    set(PI.Vrepresentation())                                # optional - pynormaliz
Expected:
    {A vertex at (-1, 0), A vertex at (0, 1), A ray in the direction (1, 0)}
Got:
    {A ray in the direction (1, 0), A vertex at (-1, 0), A vertex at (0, 1)}
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 420, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.integral_hull
Failed example:
    set(PI.Vrepresentation())                                # optional - pynormaliz
Expected:
    {A vertex at (1, 0),
     A ray in the direction (1, 0),
     A line in the direction (1, -1)}
Got:
    {A line in the direction (1, -1),
     A ray in the direction (1, 0),
     A vertex at (1, 0)}
**********************************************************************
1 item had failures:
   2 of  10 in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.integral_hull
    [100 tests, 2 failures, 4.39 s]
```


Question: I have "normaliz" in my optional installed packages but not "pynormaliz", is the above naming correct then?

I am aware that this is not the topic of this ticket but since the tests failed here, it is probably best to treat this here.


---

Comment by jipilab created at 2017-08-21 22:09:16

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2017-08-22 04:53:21

Replying to [comment:38 jipilab]:
> {{{
>     set(PI.Vrepresentation())                                # optional - pynormaliz
> }}}
> 
> Question: I have "normaliz" in my optional installed packages but not "pynormaliz", is the above naming correct then?

The only way that sage accesses normaliz is via pynormaliz, so this is correct.


---

Comment by moritz created at 2017-08-22 07:14:36

> I am aware that this is not the topic of this ticket but since the tests failed here, it is probably best to treat this here.

I disagree. This should not be treated here, but a new ticket should be opened. If we proceed as you propose (and everybody else does the same), this random pynormaliz bug will be treated in every ticket that is around. 

In fact it already seems to be fixed here:

https://trac.sagemath.org/ticket/23586

see also:

https://trac.sagemath.org/ticket/23637

and 

https://git.sagemath.org/sage.git/diff?id2=effcedba414f8832b07e6e77cf0b4a6aed6aff9b&id=cb2fcfd6760f74db9dc16def7edfef00c96cf657


---

Comment by moritz created at 2017-08-22 07:14:36

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2017-08-22 13:46:21

> The only way that sage accesses normaliz is via pynormaliz, so this is correct.

My bad, I confused both and only installed normaliz. Oh well...


---

Comment by jipilab created at 2017-08-22 14:33:40

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2017-08-22 14:33:40

> I disagree. This should not be treated here, but a new ticket should be opened. If we proceed as you propose (and everybody else does the same), this random pynormaliz bug will be treated in every ticket that is around. 
> 
> In fact it already seems to be fixed here:
> 
> #23586
> 
> see also:
> 
> #23637
> 
> and 
> 
> https://git.sagemath.org/sage.git/diff?id2=effcedba414f8832b07e6e77cf0b4a6aed6aff9b&id=cb2fcfd6760f74db9dc16def7edfef00c96cf657

All right, good to know, thanks for looking it up!

Should we add a dependancy in such cases, or perhaps just wait...?

I corrected two indentations. This looks good to me now, tests pass on my machine with pynormaliz (!).

I extended the description of the ticket a bit, if you believe it should contain some more information you can add it, otherwise, I'd it is ready to go.
----
New commits:


---

Comment by moritz created at 2017-08-22 14:46:04

Thanks for the review, JP! I don't think we should put a dependency for the pynormaliz-set-thing.


---

Comment by vbraun created at 2017-09-10 11:56:41

Resolution: fixed
