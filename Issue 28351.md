# Issue 28351: Submultiset is broken

archive/issues_028351.json:
```json
{
    "body": "CC:  @fchapoton\n\nThe documentation says:\n\n    Finally the option ``submultiset`` allows one to deal with sets with\n    repeated elements, usually called multisets. The method then\n    returns the class of all multisets in which every element is\n    contained at most as often as it is contained in ``s``. These\n    multisets are encoded as lists.\n\nHowever:\n\n```\nsage: Subsets([3,2,2], submultiset=True).list()\n[[], [3], [2], [3, 3], [3, 2], [3, 3, 2]]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28588\n\n",
    "created_at": "2019-10-10T16:48:36Z",
    "labels": [
        "component: combinatorics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Submultiset is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28351",
    "user": "https://github.com/mantepse"
}
```
CC:  @fchapoton

The documentation says:

    Finally the option ``submultiset`` allows one to deal with sets with
    repeated elements, usually called multisets. The method then
    returns the class of all multisets in which every element is
    contained at most as often as it is contained in ``s``. These
    multisets are encoded as lists.

However:

```
sage: Subsets([3,2,2], submultiset=True).list()
[[], [3], [2], [3, 3], [3, 2], [3, 3, 2]]
```


Issue created by migration from https://trac.sagemath.org/ticket/28588





---

archive/issue_comments_399929.json:
```json
{
    "body": "I think the problem is here (in `class SubMultiset_sk(SubMultiset_s)`):\n\n```\n    def __iter__(self):\n        from sage.combinat.integer_vector import IntegerVectors\n        elts = self._keys\n        for iv in IntegerVectors(self._k, len(self._d),\n                                 outer=list(self._d.values())):\n            yield sum([[elts[i]] * iv[i] for i in range(len(iv))], [])\n```\n\nThe list `self._keys` is produced by `list_to_dict` in the same file:\n\n```\ndef list_to_dict(l):\n    d = {}\n    keys = []\n    for elt in l:\n        if elt not in d:\n            d[elt] = 0\n            keys.append(elt)\n        d[elt] += 1\n    return d, keys\n\n```\n\nIn `__iter__` it is assumed that `keys()` of the dict returned here is the same as `keys`, which is not the case.\n\nShould I simply change\n\n```\n        elts = self._keys\n```\n\nto\n\n```\n        elts = self._d.keys()\n```\n\n?",
    "created_at": "2019-10-10T17:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399929",
    "user": "https://github.com/mantepse"
}
```

I think the problem is here (in `class SubMultiset_sk(SubMultiset_s)`):

```
    def __iter__(self):
        from sage.combinat.integer_vector import IntegerVectors
        elts = self._keys
        for iv in IntegerVectors(self._k, len(self._d),
                                 outer=list(self._d.values())):
            yield sum([[elts[i]] * iv[i] for i in range(len(iv))], [])
```

The list `self._keys` is produced by `list_to_dict` in the same file:

```
def list_to_dict(l):
    d = {}
    keys = []
    for elt in l:
        if elt not in d:
            d[elt] = 0
            keys.append(elt)
        d[elt] += 1
    return d, keys

```

In `__iter__` it is assumed that `keys()` of the dict returned here is the same as `keys`, which is not the case.

Should I simply change

```
        elts = self._keys
```

to

```
        elts = self._d.keys()
```

?



---

archive/issue_comments_399930.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-10T20:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399930",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399931.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-10-10T20:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399931",
    "user": "https://github.com/mantepse"
}
```

New commits:



---

archive/issue_comments_399932.json:
```json
{
    "body": "LGTM.",
    "created_at": "2019-10-11T01:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399932",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_comments_399933.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-11T01:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399933",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399934.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-13T09:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28351#issuecomment-399934",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_071843.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-13T09:31:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28351",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28351#event-71843"
}
```
