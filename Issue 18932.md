# Issue 18932: Create has_cm() function for modular forms

Issue created by migration from https://trac.sagemath.org/ticket/19169

Original creator: jlang

Original creation time: 2015-09-08 22:01:12

Keywords: modular form, cm, sd69

A modular form $f$ has complex multiplication (cm) if there is a quadratic character $\epsilon$ such that
\[
a_p(f) = \epsilon a_p(f)
\]
for all but finitely many primes $p$ (those dividing the level of $f$).  (Here, $a_p(f$) are the Fourier coefficients of $f$.)  This patch creates a method for the modular forms class in Sage to test whether a given modular form has cm.


---

Comment by jlang created at 2015-09-08 22:24:44

Changing keywords from "modular form, cm, sd69" to "modular form, cm, complex multiplication, sd69".


---

Comment by roed created at 2017-02-06 17:44:58

Any progress on this code?


---

Comment by jlang created at 2017-02-06 19:20:27

Replying to [comment:2 roed]:
> Any progress on this code?

The code was ready to go as of September 2015, but I had trouble getting a working version of Sage downloaded onto my computer.  (I have very minimal experience with all things computer-related.)  I still have the file with the code in it, and I am happy to send it to anyone who wants to try getting it into Sage.  I don't have the time or expertise to try again.


---

Comment by roed created at 2017-02-06 19:54:54

One option to make sure that the code doesn't get lost is to to attach it to this ticket.  Someone else can then make it into a git branch.


---

Comment by jlang created at 2017-02-06 20:00:38

As of September 2015, this was supposed to be the code to add the function has_CM to Sage.  It may be out of date now.


---

Attachment

Replying to [comment:4 roed]:
> One option to make sure that the code doesn't get lost is to to attach it to this ticket.  Someone else can then make it into a git branch.

Thanks for the suggestion; I didn't realize that was an option!  I have attached the code that I have to this ticket.


---

Comment by cremona created at 2017-07-18 12:53:16

jlang, it would be great to have this in Sage -- any chance you could provide your code according to the usual development process, which is to give a link to a new git branch (see the developers' manual)?  Someone can help you do that.  I can see that your attached file is an edited version of src/sage/modular/modform/element.py which has had some other changes sine you wrote your new functions, so it will not be possible to simply replace it.  What you (or someone) should do is: check out the latest development branch; create a new branch called (say) cm_forms; in the branch add your new functions (methods) ( _q_expansion_bound(), _candidate_characters(), has_cm(); test, commit and push to the trac server.


---

Comment by chapoton created at 2017-07-18 14:03:38

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-07-18 14:03:38

Done.
----
New commits:


---

Comment by christelle created at 2017-07-18 18:11:25

Changing keywords from "modular form, cm, complex multiplication, sd69" to "modular form, cm, complex multiplication, sd69, sd87".


---

Comment by aly.deines created at 2017-07-18 20:11:12

Looks good.


---

Comment by aly.deines created at 2017-07-18 20:11:12

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2017-07-20 13:05:56

I have two suggestions to make, though I did not get fast enough and see that there is now a positive review.
(1) You test all quadratic characters.  It would be enough to test those whose conductor's square divides the level.  And only odd characters (since it is *complex* multiplication).
(2) Before testing any characters I would do some local tests.  (I just implemented a similar thing for CM testing for elliptic curves, see #23454 -- in fact I found this ticket when doing a search before creating that one).   The idea is to compute `a_p<sup>2-4*p</sup>(k-1)` for a lot of good primes p for which a_p is nonzero.  If the form is CM these will all have the same square-free part, so non-CM forms will be eliminated very quickly, and for forms which pass this test, you would only have *one* character to test.

I am going to take the liberty of setting this back to needs_work but if someone wants to over-rule that and put it back to positive review, with a new ticket for what I have suggested, that is OK with me.


---

Comment by cremona created at 2017-07-20 13:05:56

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-08-26 14:14:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-08-26 14:14:32

Is my last commit correct ?
----
New commits:


---

Comment by chapoton created at 2017-08-26 14:14:32

Changing status from needs_work to needs_info.


---

Comment by cremona created at 2017-08-30 13:55:16

The new code is correct for weight k>=2, probably not for weight 1 but I think that we don't have any weight one forms anyway.


---

Comment by git created at 2017-09-23 19:41:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-11-12 15:03:12

Hold it, the new code is *not* correct, because the assertion "if f has CM by chi, then the square of the conductor of chi divides the level" is not true; it only works for forms of trivial character (and even for those I'm a little wary about powers of 2). 

The simplest counterexample I could find was this one:

```
sage: G = DirichletGroup(21)          # note squarefree level
sage: eps = G.0 * G.1
sage: f = Newforms(eps,2)[0]; f
q + (-zeta6 - 1)*q^3 + (2*zeta6 - 2)*q^4 + O(q^6)
sage: [f[p] for p in prime_range(200) if kronecker_character(-3)(p) == -1]
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
```



---

Comment by cremona created at 2017-11-12 16:02:34

OK I submit.  I must have been thinking of trivial character.  So this would be correct if we fixed it so that for trivial character (nebentypus)  it only checks quadratic characters whose conductor square divides the level, otherwise the larger set of characters?  Is there a similar restriction we can impose for the general case?


---

Comment by davidloeffler created at 2017-11-12 19:20:13

I suspect this won't make much difference in practice; the running time will be overwhelmingly dominated by the computation of Fourier coefficients anyway. 

However, I think the code can be much speeded up by not computing all the coefficients up to `bound` at once but rather doing this in a loop computing coefficients one at a time and checking them against the candidate characters; if doesn't have CM, then we will almost certainly spot this long before we get up to `bound`. One can also rule out some trivial cases early on (e.g. if there is any prime q which exactly divides the level and which doesn't divide the nebentype conductor, then f can't be CM). 

(Also, in the code for `q_expansion_bound`, did someone really seriously think that the best way to loop over the divisors of M was to loop over `prime_range(M+1)` and ignore all primes which don't divide M?)


---

Comment by aly.deines created at 2017-11-13 21:21:09

Hi David, while you are correct (that is not a good way to iterate over the divisors of M), the authors are new contributors.  If we want to foster new developers it is perhaps better to phrase things so that they can learn better coding practices as opposed to making fun of them in a public forum.  Also, this is partially my fault as the original reviewer.  I should have caught this and mentioned a better way to iterate.


Replying to [comment:18 davidloeffler]:
> I suspect this won't make much difference in practice; the running time will be overwhelmingly dominated by the computation of Fourier coefficients anyway. 
> 
> However, I think the code can be much speeded up by not computing all the coefficients up to `bound` at once but rather doing this in a loop computing coefficients one at a time and checking them against the candidate characters; if doesn't have CM, then we will almost certainly spot this long before we get up to `bound`. One can also rule out some trivial cases early on (e.g. if there is any prime q which exactly divides the level and which doesn't divide the nebentype conductor, then f can't be CM). 
> 
> (Also, in the code for `q_expansion_bound`, did someone really seriously think that the best way to loop over the divisors of M was to loop over `prime_range(M+1)` and ignore all primes which don't divide M?)


---

Comment by davidloeffler created at 2017-11-14 09:46:37

Hi Aly: that's a fair point. I didn't realise the original authors were first-time contributors, and I apologise for any offence caused. 

Just in case any of the original authors are still reading this: a faster and simpler way of iterating over the prime factors of M would be  is something like

```
for p in M.prime_divisors():
    ...
```



---

Comment by davidloeffler created at 2017-11-14 17:11:24

I've just uploaded a new git branch which is based on the original code by Lang et al, but with some of the efficiency improvements we discussed added. (I also moved the code from `ModularFormElement` to `ModularForm_abstract`, since `Newform` objects don't inherit from `ModularFormElement`.) 

Aly, John: can you check and see if it looks kosher? It would be good to get this function into Sage at last, since it is nearly 2 years since the original code was submitted.
----
New commits:


---

Comment by davidloeffler created at 2017-11-14 17:11:24

Changing status from needs_info to needs_review.


---

Comment by davidloeffler created at 2017-11-14 20:50:13

The Sage patch-bot (which automatically tests code from "needs review" tickets) seems to be ignoring this ticket. I suspect this is because it (stupidly) ignores code by new Sage users.

Hence I am **temporarily removing** most of the authors from the ticket "Authors" field. I am leaving Amy Feaver because the patchbot apparently knows who she is already.  The missing authors (Jaclyn Lang, Lubjana Beshaj, Michelle Kovesi) should be restored before this ticket is marked closed. 

Jaclyn, Lubjana, Michelle: please don't take this personally -- the patchbot is a strange and clunky piece of software!


---

Comment by chapoton created at 2017-11-14 21:14:50

You can easily bypass that by running your own patchbot client..


---

Comment by chapoton created at 2017-11-14 21:16:46

This:

```
`self`
```

is wrong, and should be instead

```
``self``
```

If you feel you do not master the rst syntax, then you should build the doc and look at  it.


---

Comment by git created at 2017-11-15 07:05:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-11-15 07:15:53

> If you feel you do not master the rst syntax, then you should build the doc and look at it.

This is actually rather difficult to do if you don't have direct access to a machine powerful enough to run Sage; I do all my Sage hacking via SSH to a remote server, and reading the doc output is difficult under those circumstances. (There are tricks with HTTP over SSH tunnels etc, but it's fiddly to set up.)

It used to be possible at least to run the docbuild script and look at the output logs, but this has been made much more difficult by the switch to parallel building of the documentation: this has meant that the output of the docbuild script is now almost completely incomprehensible, with any ReST formatting error messages swamped in huge amounts of routine junk output. 

Anyway, I have uploaded a patch with precisely 3 bytes of changes, fixing the issues identified by the patchbot.


---

Comment by davidloeffler created at 2017-11-15 09:03:46

(The ticket now has a green light from patchbot, so I am restoring the missing authors.)


---

Comment by cremona created at 2017-11-19 15:41:58

I wrote some minor comments yesterday, but today they are not here, and I am not going to repeat them.  As soon as the light goes green again I am happy for this to be merged.


---

Comment by davidloeffler created at 2017-11-19 17:58:42

> As soon as the light goes green again I am happy for this to be merged.
It won't, because of the two patchbot runs with the current version of the code, one succeeded and the other failed due to a totally unrelated error:

```
sage -t --long src/sage/graphs/matchpoly.pyx  # Timed out
```

Since this obviously has nothing to do with the present ticket I am interpreting your comment as a positive review.


---

Comment by davidloeffler created at 2017-11-19 17:58:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-14 12:40:11

Resolution: fixed
