# Issue 23723: Copy SymPy's test_sage.py into Sage's tests/

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2017-10-03 14:13:22

The SymPy-->Sage interface is theoretically tested in SymPy's `sympy/external/tests/test_sage.py` but practically it does not happen in the SymPy repo even if the file is changed, because of Travis limitations (a Sage installation is needed). The file header states:


```
# Execute this test inside Sage, e.g. with:
# sage -python bin/test sympy/external/tests/test_sage.py
#
# This file can be tested by Sage itself by:
# sage -t sympy/external/tests/test_sage.py
# and if all tests pass, it should be copied (verbatim) to Sage, so that it is
# automatically doctested by Sage.  Note that this second method imports the
# version of SymPy in Sage, whereas the -python method imports the local version
# of SymPy (both use the local version of the tests, however).
```


In the present version the file fails two doctests so these should be fixed in SymPy. This ticket should then add the patch to the Sage SymPy install and change the SymPy install script to automatically copy the file into Sage's `tests/` directory.


---

Comment by rws created at 2017-10-03 14:23:09

After adding: `sage: from sympy.external.tests.test_sage import *` the fails are:

```
**********************************************************************
File "test_sage.py", line 260, in test_sage.test_abstract_function
Failed example:
    test_undefined_function()
Expected:
    sage  test_abstract_function()
Got:
    <BLANKLINE>
**********************************************************************
File "test_sage.py", line 265, in test_sage.test_abstract_function
Failed example:
    check_expression("lucas(x)", "x")
Expected:
    Traceback (most recent call last):
    ...
    AttributeError: 'module' object has no attribute 'lucas'
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest test_sage.test_abstract_function[17]>", line 1, in <module>
        check_expression("lucas(x)", "x")
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sympy/external/tests/test_sage.py", line 71, in check_expression
        e_sage = _sage_method(sympy.S(e_sympy))
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sympy/core/function.py", line 720, in _sage_
        raise AttributeError
    AttributeError
```



---

Comment by rws created at 2017-10-03 15:06:20

Changing status from new to needs_review.


---

Comment by rws created at 2017-10-03 15:06:20

New commits:


---

Comment by jdemeyer created at 2017-10-04 12:51:30

I don't think that copying files into the Sage source tree is acceptable.

Instead, we could run the testsuite in the `spkg-check` file of `sympy`.


---

Comment by jdemeyer created at 2017-10-04 12:51:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-04 13:27:33

Wait a minute, this testsuite is actually installed anyway in `site-packages/sympy`?

So instead of copying that file, why not run the standard doctester on it?

```
sage: from sympy.external.tests import test_sage
sage: import doctest
sage: doctest.testmod(test_sage)
```


This is using the standard Python doctest framework, so the tests should be written with `>>>` instead of `sage:` and the tests should be put in real docstrings. A string somewhere in the middle of a `.py` file isn't a docstring.


---

Comment by rws created at 2017-10-04 13:42:20

Replying to [comment:5 jdemeyer]:
> Instead, we could run the testsuite in the `spkg-check` file of `sympy`.

Isn't that run after package installation? You need full Sage for it.


---

Comment by jdemeyer created at 2017-10-04 13:50:04

Replying to [comment:7 rws]:
> Isn't that run after package installation?

Yes, it is.

> You need full Sage for it.

Probably not "full Sage", or do you? It is possible to add `$(SAGERUNTIME)` to `build/pkgs/sympy/dependencies` if you require Sage. But that is not "full Sage", just a minimal Sage.

In any case, the solution from [comment:6] is simpler.


---

Comment by rws created at 2017-10-04 15:06:34

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-10-04 15:06:34

I copied this solution from the giacpy package so I assume it will work on a new Sage install as well (which I didn't test, I only tested with `sage -p` and 'SAGE_CHECK=yes' on a compiled Sage).
----
New commits:


---

Comment by jdemeyer created at 2017-10-04 15:25:12

I can test it. I don't understand this comment though: `# --force-lib because we dont want sage -t to compile test-sage.py`

Also, indent with 4 spaces.


---

Comment by rws created at 2017-10-05 05:44:26

Replying to [comment:11 jdemeyer]:
> I can test it. I don't understand this comment though: `# --force-lib because we dont want sage -t to compile test-sage.py`

I'll remove it. Is `--force-lib` necessary at all?

> Also, indent with 4 spaces.


---

Comment by jdemeyer created at 2017-10-05 08:16:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-05 08:16:06


```
File "src/sympy/external/tests/test_sage.py", line 258, in sympy.external.tests.test_sage.test_abstract_function
Failed example:
    test_issue_4023()
Exception raised:
    Traceback (most recent call last):
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sympy.external.tests.test_sage.test_abstract_function[14]>", line 1, in <module>
        test_issue_4023()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/sympy/external/tests/test_sage.py", line 198, in test_issue_4023
        assert s == (a*log(1 + a) - a*log(a) + log(1 + a) - 1)/a
      File "sage/symbolic/expression.pyx", line 2764, in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19169)
        return test_relation_maxima(self)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/sage/symbolic/relation.py", line 467, in test_relation_maxima
        m = relation._maxima_()
      File "sage/symbolic/expression.pyx", line 798, in sage.symbolic.expression.Expression._maxima_ (build/cythonized/sage/symbolic/expression.cpp:7820)
        return super(Expression, self)._interface_(maxima)
      File "sage/structure/sage_object.pyx", line 734, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:6513)
        nm = I.name()
      File "sage/misc/lazy_import.pyx", line 322, in sage.misc.lazy_import.LazyImport.__getattr__ (build/cythonized/sage/misc/lazy_import.c:3546)
        return getattr(self.get_object(), attr)
      File "sage/misc/lazy_import.pyx", line 189, in sage.misc.lazy_import.LazyImport.get_object (build/cythonized/sage/misc/lazy_import.c:2198)
        return self._get_object()
      File "sage/misc/lazy_import.pyx", line 221, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2468)
        self._object = getattr(__import__(self._module, {}, {}, [self._name]), self._name)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py", line 104, in <module>
        ecl_eval("(require 'maxima)")
      File "sage/libs/ecl.pyx", line 1322, in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10817)
        cpdef EclObject ecl_eval(bytes s):
      File "sage/libs/ecl.pyx", line 1337, in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10756)
        o=ecl_safe_eval(o)
      File "sage/libs/ecl.pyx", line 349, in sage.libs.ecl.ecl_safe_eval (build/cythonized/sage/libs/ecl.c:5807)
        raise RuntimeError("ECL says: "+ecl_base_string_pointer_safe(s))
    RuntimeError: ECL says: Module error: Don't know how to REQUIRE MAXIMA.
```



---

Comment by rws created at 2017-10-05 08:41:53

Ah the proof machinery, easy fix.


---

Comment by jdemeyer created at 2017-10-05 09:48:09

The Sage doctest framework needs to determine whether to load the file to be doctested or not. If the file to be tested is part of a package (as opposed to a stand-alone script), then it is never loaded. If `--force-lib` is given, it is also not loaded.

In this case, `--force-lib` is not needed because the file `test_sage.py` is part of a package.


---

Comment by git created at 2017-10-05 13:21:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-05 13:24:12

See for both SymPy patches:

 - https://github.com/sympy/sympy/pull/13392
 - https://github.com/sympy/sympy/pull/13402

Again, unfortunately I can't test this myself.


---

Comment by rws created at 2017-10-05 13:24:12

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-10-05 13:25:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-05 13:28:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-05 13:28:46

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-10-05 13:46:57

According to the git Trac plugin, you added an empty file as patch.


---

Comment by git created at 2017-10-05 14:24:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-05 14:26:26

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-10-05 14:26:26

Apparently I tested an empty file, thanks.


---

Comment by git created at 2017-10-05 15:44:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-05 15:45:46

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-10-10 14:29:16

This ticket actually seems the ONLY way to test the SymPy/Sage interface because the same attempt on SymPy Travis never worked, see https://github.com/sympy/sympy/issues/13395


---

Comment by rws created at 2017-10-10 15:43:11

See also #24006.


---

Comment by rws created at 2017-10-15 15:28:23

This is obsoleted by #24006.


---

Comment by rws created at 2017-10-15 15:28:40

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
