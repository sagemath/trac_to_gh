# Issue 8730: cddlib makefile looks for gmp in /usr/local, should be $SAGE_LOCAL

Issue created by migration from https://trac.sagemath.org/ticket/8730

Original creator: vbraun

Original creation time: 2010-04-20 17:30:50

Assignee: AlexGhitza

CC:  dimpase drkirkby

The current problem with this spkg is that gmp must be in SAGE_LOCAL, and not in /usr/local This stops the thing building on Solaris, see http://groups.google.com/group/sage-release/msg/35b0c600a5ef250f and other messages in this thread. And gmpdir=/usr/local is hardwired in Makefile.am.




---

Comment by vbraun created at 2010-04-20 17:33:58

Updated spkg is at 

http://www.stp.dias.ie/~vbraun/Sage/spkg/cddlib-094f.p6.spkg

I changed gmplib in Makefile.am, re-ran autotools, and added the updated files to patches/. It should work now, but I have no Solaris machine to test on. Please let us know if this fixes the build problem.


---

Comment by jhpalmieri created at 2010-04-20 21:43:46

It builds on t2.math.washington.edu now.


---

Comment by jhpalmieri created at 2010-04-21 17:31:21

The hg repository in the spkg has unchecked-in changes.  Other than this, is this ready for review?


---

Comment by dimpase created at 2010-04-21 17:38:51

Replying to [comment:3 jhpalmieri]:
> The hg repository in the spkg has unchecked-in changes.  Other than this, is this ready for review?
 
IMHO there should be a short explanation (in SPKG.txt?) on how to make modifications to patches. The whole autoconf/automake machinery is not so trivial...

Thanks,
Dima


---

Comment by kedlaya created at 2010-04-21 18:41:31

This fixes my build problem under 64-bit Fedora 10, where /usr/local/lib was providing 32-bit libraries and causing linking errors.


---

Comment by vbraun created at 2010-04-21 20:03:01

Changing status from new to needs_review.


---

Comment by vbraun created at 2010-04-21 20:03:01

Dima: "autoreconf -f" regenerates all auto-generated files. If you want to make changes to the autotools sources you need to read the autoconf manual or ask the friendly package maintainer. Once you understand what autoconf does the organization of the patches/ directory should be self-explanatory (but then, I'm biased :-)

I checked in the changes and the package is ready for review.


---

Comment by dimpase created at 2010-04-22 04:29:56

Replying to [comment:6 vbraun]:
> Dima: "autoreconf -f" regenerates all auto-generated files. If you want to make changes to the autotools sources you need to read the autoconf manual or ask the friendly package maintainer. Once you understand what autoconf does the organization of the patches/ directory should be self-explanatory (but then, I'm biased :-)

IMHO it is unusual to have sources and configuration files reside in a directory tree like this one.
E.g. it's unclear in which directory autoreconf must be run...
Although I must admit last time I messed around with autotools config files 11 years ago. :-)


> 
> I checked in the changes and the package is ready for review.


---

Comment by vbraun created at 2010-04-22 09:49:15

For the record, autoreconf needs to be run in the build directory. The auto(re)generated files then need to be copied into patches/autogenerated/

If anybody with a good grasp of autotools has a better idea of how to organize things, I'd be happy to hear your opinion. Ideally we'd fix the automake sources upstream, and take upstream's autogenerated files. I'll try to communicate our patches upstream once we make sure our changes build on all Sage-supported platforms.


---

Comment by drkirkby created at 2010-04-22 09:53:22

Changing status from needs_review to needs_work.


---

Comment by drkirkby created at 2010-04-22 09:53:22

I agree with Dima in that the fact patches/autogenerated has files autogenerated by running autoreconf should be stated in SPKG.txt - not just the tickets. It is not obvious to someone that does not know autoconf/automake well.

Also, I believe the directory autom4te.cache should be copied too. When 'autoreconf' is run, it creates that directory. The only file in there which says it can be safely removed is autom4te.cache/requests. There is nothing to indicate to me that is is safe to remove the other files from autom4te.cache. One might get away with it, but I think it is wrong to not include them. Note this directory is created by autoreconf - not when one runs the configure script.

Whoever wrote the cddlib package in the first place clearly did not understand autoconf/automake. The whole point of using autoconf/automake is to create a configure script where things like the locations of the libraries can be specified as options - they should not be hard-coded in Makefile.am like they are. The file Makefile.am starts with "Site customizations:" which should not be necessary.

Also, there is a file "ChangeLog?" and another "ChangeLog? (Autosaved)" in the src directory. Couple that with facts there is no LICENSE file, History/News/ChangeLog are all the same, and you get the feeling the developers did not understand autoconf/automake.

What I find strange is that libgmp has been in /usr/local/lib for almost 10 months on 't2'

kirkby`@`t2:[/usr/local/lib] $ ls -l /usr/local/lib/libgmp*
-rw-r--r--   1 nobody   nobody    659804 Jun 27  2009 /usr/local/lib/libgmp.a
-rwxr-xr-x   1 nobody   nobody       785 Jun 27  2009 /usr/local/lib/libgmp.la
lrwxrwxrwx   1 nobody   nobody        15 Jun 27  2009 /usr/local/lib/libgmp.so -> libgmp.so.3.5.0
lrwxrwxrwx   1 nobody   nobody        15 Jun 27  2009 /usr/local/lib/libgmp.so.3 -> libgmp.so.3.5.0
-rwxr-xr-x   1 nobody   nobody    355108 Jun 27  2009 /usr/local/lib/libgmp.so.3.5.0
kirkby`@`t2:[/usr/local/lib] $

Why this should suddenly be a problem is a bit puzzling to me, given cddlib-094f.p5.spkg was merged into sage 4.3.4 and 4.3.4 built on 't2' OK.

Does anyone know why this suddenly stops working?

But in principle, I think changing Kakefile.am and regenerating the files with autoreconf is the way to go. I'm just a bit concerned that the autom4te.cache directory is not included. 

I think it is important to point out to the upstream developers that having a site customisation file Makefile.am goes totally against the principle of using autoconf/automake. 


Dave


---

Comment by jhpalmieri created at 2010-04-22 15:27:56

Have any of these issues with cddlib been reported upstream?  The configure script should allow "--with-gmp=..." -- we shouldn't have to hack it in ourselves.  Can someone please contact the cddlib people about this, and then change the "Report Upstream" field accordingly?

> Why this should suddenly be a problem is a bit puzzling to me, given cddlib-094f.p5.spkg was merged into sage 4.3.4 and 4.3.4 built on 't2' OK.

Well, maybe it's something in my setup on t2 in particular; I haven't heard that Minh (for example) has had this trouble building on t2.  (It also seems to fix Kiran's problem on his linux box.)


---

Comment by dimpase created at 2010-04-22 16:05:50

Replying to [comment:10 jhpalmieri]:
> Have any of these issues with cddlib been reported upstream?  The configure script should allow "--with-gmp=..." -- we shouldn't have to hack it in ourselves.  Can someone please contact the cddlib people about this, and then change the "Report Upstream" field accordingly?

I happen to know Komei Fukuda, the cdd(lib) author, (even had a joint paper with him quite a while ago).
I'll write to him, once the spkg is ready.

Dima


> 
> > Why this should suddenly be a problem is a bit puzzling to me, given cddlib-094f.p5.spkg was merged into sage 4.3.4 and 4.3.4 built on 't2' OK.
> 
> Well, maybe it's something in my setup on t2 in particular; I haven't heard that Minh (for example) has had this trouble building on t2.  (It also seems to fix Kiran's problem on his linux box.)


---

Comment by kedlaya created at 2010-04-22 16:15:28

Replying to [comment:10 jhpalmieri]:
> Have any of these issues with cddlib been reported upstream?  The configure script should allow "--with-gmp=..." -- we shouldn't have to hack it in ourselves.  Can someone please contact the cddlib people about this, and then change the "Report Upstream" field accordingly?
> 
> > Why this should suddenly be a problem is a bit puzzling to me, given cddlib-094f.p5.spkg was merged into sage 4.3.4 and 4.3.4 built on 't2' OK.
> 
> Well, maybe it's something in my setup on t2 in particular; I haven't heard that Minh (for example) has had this trouble building on t2.  (It also seems to fix Kiran's problem on his linux box.)

For the record, I started having those problems on my Fedora box already at 4.3.4 (probably when the cddlib spkg was merged).


---

Comment by drkirkby created at 2010-04-22 21:42:49

Replying to [comment:11 dimpase]:
> I happen to know Komei Fukuda, the cdd(lib) author, (even had a joint paper with him quite a while ago).
> I'll write to him, once the spkg is ready.
> 
> Dima

I think he needs to add an AC_ARG_WITH into configure.ac. There must be many packages in Sage which allow the location of gmp to be specified, so there must be plenty of examples of how to do it. I suspect mpfr is probably the best place to look, as the mpfr developers seem to know what they are doing with autoconf/automake. 

But I agree with Dima, that there should be an explanation of what files are in the patches/autogenerated directory. 

There also needs to be a Mercurial patch added on the ticket once the wording is sorted out. 

Dave


---

Comment by jhpalmieri created at 2010-04-22 23:15:18

Changing component from algebra to packages.


---

Comment by jhpalmieri created at 2010-04-22 23:15:18

By the way, this is my main blocker ticket for Sage 4.4: without it, Sage doesn't build (for me) on Solaris, nor on certain Fedora setups.  With it, it does.  So if the issues (whether the "autom4te.cache" directory is included, and the contents of SPKG.txt) can be settled quickly, that would be great.  Otherwise, we can merge it more or less as is and then deal with follow-up issues on another ticket.


---

Comment by jhpalmieri created at 2010-04-22 23:15:18

Changing priority from major to blocker.


---

Comment by was created at 2010-04-23 23:38:54

After talking with John about this, let's move followup to a new ticket.    This is just what we have to do because of limited time by the release manager, etc.    Please somebody make a new ticket and summarize what needs to be done next to make this stuff perfect.

And David K. -- many thanks for your careful comments above.


---

Comment by was created at 2010-04-23 23:38:54

Changing status from needs_work to needs_review.


---

Comment by was created at 2010-04-23 23:39:01

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2010-04-24 00:05:13

Resolution: fixed


---

Comment by vbraun created at 2010-06-07 11:49:36

Followup for the remaining issues raised in this ticket is at #9177


---

Comment by chapoton created at 2017-07-19 09:04:39

full author name
