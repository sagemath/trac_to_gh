# Issue 31823: configure: Change defaults to --with-system-gcc=force, --with-system-python3=force

Issue created by migration from https://trac.sagemath.org/ticket/32060

Original creator: mkoeppe

Original creation time: 2021-06-25 16:34:29

CC:  dimpase slabbe slelievre @kliem mjo vbraun

This will make it an error if no suitable system gcc / python3 is found.

It can be overridden by the user by `--without-system-gcc`, `--without-system-python3`

(from https://groups.google.com/g/sage-devel/c/cSsAsPuVnxg/m/fDBOSaYZBgAJ)


---

Comment by mkoeppe created at 2021-06-25 18:33:36

#30863 has a related proposal.


---

Comment by mkoeppe created at 2021-06-26 02:08:03

Here's a beginning. `./bootstrap && ./configure --with-system-libsemigroups=force --with-system-pari_galpol=force` on homebrew (which does not have these packages) now leads to:

```
configure:

    notice: the following SPKGs did not find equivalent system packages:

          _recommended coxeter3 gp2c igraph libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata perl_cpan_polymake_prereq perl_mongodb
        
[...irrelevant system package advice...]

configure: error: 

    Given --with-system-libsemigroups=force, but no system package could be used.
    That's an error.  Please install the indicated package to continue.
    (To override this error, use ./configure --without-system-libsemigroups)
    Given --with-system-pari_galpol=force, but no system package could be used.
    That's an error.  Please install the indicated package to continue.
    (To override this error, use ./configure --without-system-pari_galpol)
```


Feel free to make refinements to the wording by pushing to this ticket...
----
New commits:


---

Comment by git created at 2021-06-26 02:13:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-26 02:28:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-26 02:28:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-28 16:46:01

The discussion that led to the ticket has ended, but the ticket with the solution still needs review.


---

Comment by mkoeppe created at 2021-06-29 06:38:42

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-29 06:38:42

Need to override these changed defaults in tox.ini, or all `-minimal` builds will fail


---

Comment by git created at 2021-06-29 07:13:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-29 07:14:19

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-26 17:48:33

Still needs review


---

Comment by mkoeppe created at 2021-09-15 00:53:07

Let's get this in please.


---

Comment by jhpalmieri created at 2021-09-15 16:11:43

Why `--with-system-python3=force`? I can understand gcc, since building gcc can take a long time and maybe can be a little finicky, but why Python?


---

Comment by mkoeppe created at 2021-09-15 16:20:10

I don't have a strong preference on the default for `python3`. I can undo this change


---

Comment by jhpalmieri created at 2021-09-15 16:48:30

I don't think I have a strong preference either, I was asking for the reason behind the proposed change.


---

Comment by git created at 2021-09-15 17:36:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-09-15 17:36:51

Let's do the more limited change.


---

Comment by dimpase created at 2021-09-16 08:59:04

Replying to [comment:18 jhpalmieri]:
> I don't think I have a strong preference either, I was asking for the reason behind the proposed change.

the proposal was to minimize unnecessary tricky package building on a typical system.
Typically Python3.7 or newer is available.


---

Comment by jhpalmieri created at 2021-09-16 15:58:53

Is the tricky part (for building Python) making sure that ssl is available?


---

Comment by dimpase created at 2021-09-16 16:32:17

Replying to [comment:24 jhpalmieri]:
> Is the tricky part (for building Python) making sure that ssl is available?
that's one of tricky parts for sure, in particular on macOS.


---

Comment by mkoeppe created at 2021-09-16 16:32:39

No, the ssl problems are all gone since we made the openssl package (3.0) standard.

I don't think there are build problems with python3 on any of our platforms -- with the exception of builds on top of conda on Linux (which is currently broken in multiple ways)

I think the point was just that some (new) users are surprised that we build our own python. But in contrast to the gcc build, which rarely works at all, building python3 is very robust. So I don't think this warrants the change of defaults.


---

Comment by dimpase created at 2021-09-16 17:11:02

Replying to [comment:26 mkoeppe]:
> No, the ssl problems are all gone since we made the openssl package (3.0) standard.
> 
> I don't think there are build problems with python3 on any of our platforms -- with the exception of builds on top of conda on Linux (which is currently broken in multiple ways)
> 
> I think the point was just that some (new) users are surprised that we build our own python. But in contrast to the gcc build, which rarely works at all, building python3 is very robust. So I don't think this warrants the change of defaults.
> 

What's the point of building Python, and other packages which are just a click away, such as GMP? To accelerate global warming?


---

Comment by mjo created at 2021-09-16 17:30:53

Replying to [comment:27 dimpase]:
> 
> What's the point of building Python, and other packages which are just a click away, such as GMP? To accelerate global warming?

It also ensures that downloading the source release wastes a few hundred megabytes of bandwidth and then disk space.

We should eliminate the gcc and python SPKGs entirely. They serve no purpose at all, and require constant maintenance, support, and physical resources. In the rare case where gcc or python3 are not available from a package manager or binary download, using conda or nix is preferable to using the sage spkg.


---

Comment by mkoeppe created at 2021-09-16 17:43:21

Let's kindly not use this technical ticket to rehash this fruitless discussion.


---

Comment by mkoeppe created at 2021-09-16 17:43:33

Needs review.


---

Comment by mjo created at 2021-09-16 18:26:57

Well, someone asked "what's the point?" The benefits of deleting the SPKGs are clear. The benefits of changing them to "force" by default are less clear, since we will still be responsible for shipping and maintaining SPKGs that will never get used. (Using `--without-system-gcc` is always a mistake, and likewise for python3.)

Nevertheless, setting them to "force" can be seen as step towards removal, so I'm not against it. I just don't think it solves the issue that prompted the mailing list thread -- that we are involved in this mess in the first place. All of the core packages that are available everywhere and are well-supported (for multiple versions) in sage should be relegated to _prereq or _bootstrap.


---

Comment by dimpase created at 2021-09-16 19:41:02

Replying to [comment:29 mkoeppe]:
> Let's kindly not use this technical ticket to rehash this fruitless discussion. 

technically there is no need to keep gcc and python3 packages in Sage.


---

Comment by mkoeppe created at 2021-09-16 19:42:28

that's just, like, your opinion, man


---

Comment by jhpalmieri created at 2021-09-16 21:18:22

First, the help string in `./configure` still says that "yes" is the default for `--with-system-gcc`. Second, if I don't have `gcc` at all, then `./configure` stops before it prints the message, saying

```
configure: error: no acceptable C compiler found in $PATH
See `config.log' for more details
```

Third, should this also test for `gfortran`, or should we continue to build that without complaining? It would be nice on a platform like OS X to just quit with an error if `gfortran` is missing *and* the user is using homebrew, because there is no excuse, but maybe install it if there is no obvious package management system in place. That may be beyond the scope of this ticket.

The Sage philosophy used to be: treat developers and users as the same, and basically assume everyone was building from scratch. Have we moved enough away from this now that we can treat developers (by which I just mean people who compile Sage themselves) differently?


---

Comment by mkoeppe created at 2021-09-16 21:24:36

Replying to [comment:34 jhpalmieri]:
> if I don't have `gcc` at all, then `./configure` stops before it prints the message, saying
> {{{
> configure: error: no acceptable C compiler found in $PATH
> See `config.log' for more details
> }}}

It's hard to avoid error exits from standard autoconf macros. Ticket #29531 sketches a solution, but it's tricky, and I consider it out of scope.


---

Comment by mkoeppe created at 2021-09-16 21:26:18


```
> should this also test for `gfortran`
```

No, I don't think so because building `gfortran` is robust when a suitable `gcc` is present. We know this because we test it on GH Actions: All the `-minimal` configuration do not have system `gfortran`.


---

Comment by jhpalmieri created at 2021-09-16 21:30:02

That makes it hard (at least for me) to test. The changes make sense, but I'm not that familiar with `m4` syntax. To see it in action, I guess I need a system with a `gcc` but one that's broken (too old for example).

If someone else can review, that would be great. If you think it's right to do the same with Python3, please open another ticket.


---

Comment by dimpase created at 2021-09-16 22:37:19

Replying to [comment:33 mkoeppe]:
> that's just, like, your opinion, man

that's, like, the reviewer's job, no?


---

Comment by mkoeppe created at 2021-09-16 22:40:10

It's out of scope for this ticket, so, no.


---

Comment by dimpase created at 2021-09-16 23:04:15

Replying to [comment:34 jhpalmieri]:
> First, the help string in `./configure` still says that "yes" is the default for `--with-system-gcc`. Second, if I don't have `gcc` at all, then `./configure` stops before it prints the message, saying
> {{{
> configure: error: no acceptable C compiler found in $PATH
> See `config.log' for more details
> }}}
> Third, should this also test for `gfortran`, or should we continue to build that without complaining? It would be nice on a platform like OS X to just quit with an error if `gfortran` is missing *and* the user is using homebrew, because there is no excuse, but maybe install it if there is no obvious package management system in place. That may be beyond the scope of this ticket.


there are standalone distributions of gfortran for macOS by the gfortran maintainer of the Homebrew package.
To me this offers a way to entirety remove gcc and gfortran spkgs from Sage.

https://github.com/fxcoudert/gfortran-for-macOS


> 
> The Sage philosophy used to be: treat developers and users as the same, and basically assume everyone was building from scratch. Have we moved enough away from this now that we can treat developers (by which I just mean people who compile Sage themselves) differently?

it is hard to tell, but I guess the majority of users is using prebuilt Sage.


---

Comment by dimpase created at 2021-09-17 10:25:47

I've put a broken `gcc` ahead of everything in my PATH, and tried `./configure`

Is this how the error regarding missing gcc should look like?

```
checking for gcc... gcc
checking whether the C compiler works... no
configure: error: in `/mnt/opt/Sage/sage-dev':
configure: error: C compiler cannot create executables
See `config.log' for more details
```


and there is nothing beyond that in `config.log`, no `more details`, really, except `configure: exit 77` as the last line.


---

Comment by dimpase created at 2021-09-17 10:37:11

the trick in the previous comment does not work for python3, as `./configure` still manages to divine
`/usr/bin/python3` somehow.


---

Comment by dimpase created at 2021-09-17 10:46:53

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-09-17 10:46:53

anyhow, this looks good enough.


---

Comment by mkoeppe created at 2021-09-17 16:38:47

Replying to [comment:43 dimpase]:
> I've put a broken `gcc` ahead of everything in my PATH, and tried `./configure`
> 
> Is this how the error regarding missing gcc should look like?
> {{{
> checking for gcc... gcc
> checking whether the C compiler works... no
> configure: error: in `/mnt/opt/Sage/sage-dev':
> configure: error: C compiler cannot create executables
> See `config.log' for more details
> }}}
> 
> and there is nothing beyond that in `config.log`, no `more details`, really, except `configure: exit 77` as the last line.

No, see comment:35. This ticket is not about early exits caused by standard autoconf macros. It is about our spkg-configure which uses more specific tests regarding the compiler.

If you want to test this properly, use a working but out-of-version-range compiler such as gcc 4.4 or 12.dev.


---

Comment by mkoeppe created at 2021-09-17 16:39:56

Replying to [comment:45 dimpase]:
> looks good enough.

Thanks. If nothing else, the deferred error exits are valuable.


---

Comment by dimpase created at 2021-09-18 14:13:42

I have opened #32532 to remove gcc and gfortran spkgs.


---

Comment by mkoeppe created at 2021-09-18 16:15:44

Thanks. Good to have a central place for this recurring topic.


---

Comment by mkoeppe created at 2021-09-18 18:05:32

Replying to [comment:34 jhpalmieri]:
> the help string in `./configure` still says that "yes" is the default for `--with-system-gcc`. 

Let's fix this in #32533 - one of several possible improvements for `./configure --help`


---

Comment by vbraun created at 2021-09-25 23:18:13

Resolution: fixed
