# Issue 12388: Artin Hasse Exponential

Issue created by migration from Trac.

Original creator: magfrump

Original creation time: 2012-02-22 08:49:51

Assignee: roed

CC:  caruso spancratz

add Artin Hasse Exponential to Zp and Qp


---

Attachment


---

Comment by magfrump created at 2012-02-22 09:07:01

Changing status from new to needs_review.


---

Comment by dsm created at 2012-02-22 16:40:52

Two points, one trivial and one not:

(1) Shouldn't it be "Artin-Hasse exponential" and not "Artin Hasse Exponential"?

(2) There really aren't any tests which demonstrate that what the function returns is actually the A-H exp, as opposed to some other similar-looking element in the ring.  Probably there should be something in TESTS: which verifies some known properties.


---

Comment by magfrump created at 2012-02-22 21:35:42

(1) agreed

(2) also agreed, I'm planning to add some doctests to that effect today.


---

Comment by dsm created at 2012-02-25 22:13:05

Changing status from needs_review to needs_work.


---

Comment by kedlaya created at 2016-08-19 22:02:38

Ping. This looks like low-hanging fruit; it just needs some more convincing doctests.


---

Comment by chapoton created at 2016-08-20 07:56:07

I made a branch, and refreshed it, but did not manage to make it compile..
----
New commits:


---

Comment by git created at 2016-08-26 14:03:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-26 15:09:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-28 10:09:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-29 14:08:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-29 14:09:31

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-08-29 14:09:31

ok, ready. Needs review.


---

Comment by git created at 2016-08-29 15:31:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-29 18:48:11

reference for the random test: theorem 2.5 of

http://www.math.uconn.edu/~kconrad/blurbs/gradnumthy/AHrootofunity.pdf


---

Comment by roed created at 2016-09-02 03:21:50

Changing status from needs_review to needs_work.


---

Comment by roed created at 2016-09-02 03:21:50

Mostly good; here are some issues to fix.

* When `prec=0`, the precision should be taken from the precision of the element rather than the precision cap of the parent (the process of finding the right precision may be more involved than just copying the precision of the element; I haven't thought about what the right precision should be in terms of the derivative of the artin-hasse exponential).
* When `prec=1`, the resulting p-adic element should have absolute precision 1, not the precision equal to the precision cap of the parent (probably `self.parent(c)` should be `self.parent()(c,1)`).
* It would be good to have the reference to Thm 2.5 of Conrad's notes in the docstring.
* It would be nice to have a test along the lines of

```
sage: x = 3*Zp(3,30).random_element()
sage: x.artin_hass_exp() == (sum(x^(p^i)/p^i for i in range(5)).exp()
True
```


Thanks for reviving the ticket though!


---

Comment by git created at 2016-09-02 07:07:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-09-04 15:13:17

There remains to handle your remarks about precision.

And also I am not very happy with all the imports that I have added, there may be a smarter way to avoid that.
----
New commits:


---

Comment by caruso created at 2017-05-22 14:09:42

I think that precision is fine.

Small other remarks:
- Shouldn't we cpdef the function `artin_hasse_exp`?
- Why do we need an external function `floorlogp`? Shouldn't we integrate it directy in `artin_hasse_exp` (and actually not call it at each iteration of the main loop)? 
- I would use `None` instead of `0` for the default of `prec`
- It is enough to evaluate the Artin-Hasse series up to `prec/self.valuation()`
- Shouldn't we cache the coefficients of the Artin-Hasse series and/or only compute them modulo `pi^prec`?

By the way, I think I can imagine faster algorithms for computing the Artin-Hasse exponential but it will be for another ticket.


---

Comment by caruso created at 2017-05-27 19:44:05

Also notice that the class `pAdicGenericElement` is a generic class whose instances and not only elements of Zp or Qp but also elements in finite extensions. However your code is definitely specific to Zp / Qp as its relies on integer lifts.


---

Comment by tscrim created at 2017-06-04 23:21:23

Comments only on the Cython aspects:

Don't include `stdsage.pxi` (#22896) or `cysignals/signals.pxi` (see, e.g., #23121).

You should use (#17668):

```diff
-        cdef Rational c = PY_NEW(Rational)
+        cdef Rational c = Rational.__new__(Rational)
```


With how Cython works, it is no worse to compactify:

```
cdef long floorlogp(long x, long b):
    """
    A fast way to find the floor of the log base ``b`` of ``x``.
    """
    cdef long t = b
    cdef long n = 0
    while t <= x:
        t *= b
        n += 1
    return n
```

However, isn't this just `x // b` since `x` and `b` are both non-negative?


```diff
-        cdef sage.rings.integer.Integer p_as_Integer
+        cdef Integer p_as_Integer
```



```diff
-        if self.valuation() < 1:
+        if self.valuation_c() < 1:
```


It would be great to use `self.lift_c()` instead of `self.lift()`, as `self.lift()` in all cases just redirects to `self.lift_c()`. However, the code is not properly set up to do this. :(

Since this is a `cdef` class, you can just use `self._parent` (which is a much faster call and cleaner Cython code).

Actually, as far as I can see, you don't need anything past

```
p_as_Integer = self.parent().prime()
```

when `prec == 1` (other than maybe `mpq_set_si(a[0], 1, 1)`). So I would move that code block/special case before that. Actually, if I am reading the code correctly, you could do it as a special case before

```
a = <mpq_t *> sig_malloc(prec * sizeof(mpq_t))
```



---

Comment by roed created at 2017-07-17 17:38:25

Changing keywords from "" to "sd87".


---

Comment by git created at 2017-07-23 08:53:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-07-22 20:09:56

Changing keywords from "sd87" to "sd87, padicIMA".


---

Comment by git created at 2018-08-12 17:51:57

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by caruso created at 2018-08-12 18:04:12

I've just written another implementation that solves the equation (with unknown `y`)

```
log(y) = x + x^p/p + x^(p^2)/p^2 + x^(p^3)/p^3 + ...
```

using a Newton scheme.

It works over any p-adic ring/field (that's why I make this ticket dependent from #23218). 
Moreover, it is expected to be fast as soon as there exists a fast implementation of the logarithm for this ring/field. For example:

```
sage: R = Zp(3,1000)
sage: x = 3 * R.random_element()
sage: %time y1 = x.artin_hasse_exp()
CPU times: user 9.14 s, sys: 0 ns, total: 9.14 s
Wall time: 9.16 s
sage: %time y2 = x.artin_hasse_exp_Newton()
CPU times: user 8 ms, sys: 4 ms, total: 12 ms
Wall time: 9.81 ms
sage: y1 == y2
True
```

However, with precision 20, `artin_hasse_exp` is faster because it is written in Cython.


---

Comment by git created at 2018-08-13 02:20:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-08-13 02:31:04

I've added a "direct" implementation that just evaluates

```
exp(x + x^p/p + x^(p^2)/p^2 + ...)
```

An heuristic is used for choosing the fastest algorithm (hopefully), depending on the input and the methods available for this input.

I've also improved the computation of the Artin-Hasse series: the computation is now done modulo some power of `p` (and not in `QQ` as before) and the result is cached.

On my laptop, timings are now:


```
sage: R = Zp(3,1000)
sage: elt = 3 * R.random_element()
sage: %timeit elt.artin_hasse_exp()  # use the "direct" algorithm
100 loops, best of 3: 2.22 ms per loop
sage: %timeit elt.artin_hasse_exp(algorithm='direct')
100 loops, best of 3: 2.14 ms per loop
sage: %timeit elt.artin_hasse_exp(algorithm='newton')
100 loops, best of 3: 4.84 ms per loop
sage: %timeit elt.artin_hasse_exp(algorithm='series')
100 loops, best of 3: 17.4 ms per loop
```


And for an extension:


```
sage: S.<pi> = R.extension(x^2 + 3)
sage: elt = pi * S.random_element()
sage: %timeit elt.artin_hasse_exp()  # use the "series" algorithm
10 loops, best of 3: 121 ms per loop
sage: %timeit elt.artin_hasse_exp(algorithm='direct')
Traceback (most recent call last):
...
NotImplementedError: One factor of the Artin-Hasse exponential does not converge
sage: %timeit elt.artin_hasse_exp(algorithm='newton')
1 loop, best of 3: 333 ms per loop
sage: %timeit elt.artin_hasse_exp(algorithm='series')
10 loops, best of 3: 121 ms per loop
```



---

Comment by roed created at 2018-08-13 15:09:29

Great!  Let me know when this is ready for review.  I may wait until #23218 is merged into a beta so that I can see the changes.


---

Comment by chapoton created at 2018-08-14 08:16:42

* patchbot reports 2 failing doctests

* you need to document every single function, even with underscore names


---

Comment by git created at 2018-08-16 15:15:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-08-16 15:17:07

I've added the missing doctests. The ticket is now ready for review.


---

Comment by caruso created at 2018-08-16 15:17:07

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-08-16 16:35:05

You need to use

```
+        r"""
```

instead of 

```
+        """
```

in every doc that contains latex commands somewhere (`\log` for example)


---

Comment by chapoton created at 2018-08-16 16:39:34

and the branch does not apply on the latest beta..


---

Comment by git created at 2018-08-16 16:42:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-16 17:03:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-08-16 17:04:14

Thanks. Should be fixed.


---

Comment by git created at 2018-08-16 17:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-16 19:24:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-16 19:41:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-18 06:31:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-08-18 07:52:57

typo:

```
is not is the domain of convergence of the
```



---

Comment by git created at 2018-08-18 08:11:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-13 21:02:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-13 21:11:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-14 06:18:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-20 06:11:26

this seems to make some patchbots turn crazy, for some reason...


---

Comment by caruso created at 2018-09-20 06:28:13

I don't see anything in the ticket that is executed at startup, except this line:

```
_AHE_coefficients_cache = { }
```

but I don't except this to cause slowness.


---

Comment by chapoton created at 2018-09-20 06:37:00

This is very probably not the fault of anything in this ticket. Probably a new bug of the patchbot, maybe on the server side..


---

Comment by roed created at 2018-09-20 19:14:44

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-09-20 19:14:44

I ran tests locally and they all passed.  Looks good to me.


---

Comment by vbraun created at 2018-09-22 10:22:45

Resolution: fixed


---

Comment by jdemeyer created at 2018-10-24 11:55:25

Is "Sebastian Pancrantz" a typo for "Sebastian Pancratz"?


---

Comment by jdemeyer created at 2018-10-24 11:57:36

I'm assuming that it is, correct me if I'm wrong.


---

Comment by embray created at 2018-10-28 14:52:23

This should be re-targeted for 8.5.
