# Issue 29698: implicitly fuzz RNG-dependent doctests

Issue created by migration from https://trac.sagemath.org/ticket/29935

Original creator: dimpase

Original creation time: 2020-06-22 13:02:46

CC:  @kliem mjo @davewittemorris slelievre mantepse

currently doctests are run completely deterministically, as they always start from the same random seed.

We propose to start from a "random" random seed, this would make
these tests more robust.

See  this thread: https://groups.google.com/d/msg/sage-devel/c4UbKSdt3Aw/UQAo1iYoAAAJ
for more details.


---

Comment by @kliem created at 2020-06-22 13:19:50

Just so that we don't forget that we will have to update

https://doc.sagemath.org/html/en/developer/coding_basics.html


---

Comment by @kliem created at 2020-06-22 13:53:07

`geometry/hyperbolic_space/hyperbolic_geodesic.py` makes some claims on how good approximations work, which doesn't seem to work. I had this thing run 7 times now and not one time did all tests pass. E.g. there is one test that gives me absolute errors of `0.7` when running this in the shell, but the test claims it is below `10**-9`.

There is also #29904. Other than that the `geometry` module appears to ready.

Edit: And there is some place where you need to add `set_random_seed(0)` now or similar.


---

Comment by dimpase created at 2020-06-22 14:09:39

Replying to [comment:5 gh-kliem]:
> `geometry/hyperbolic_space/hyperbolic_geodesic.py` makes some claims on how good approximations work, which doesn't seem to work. I had this thing run 7 times now and not one time did all tests pass. E.g. there is one test that gives me absolute errors of `0.7` when running this in the shell, but the test claims it is below `10**-9`.

this is a great example of fuzzing catching an apparent error, it seems.

> 
> There is also #29904. Other than that the `geometry` module appears to ready.
> 
> Edit: And there is some place where you need to add `set_random_seed(0)` now or similar.


---

Comment by @kliem created at 2020-06-22 14:49:58

New commits:


---

Comment by @kliem created at 2020-06-22 14:54:23

Even in the developer guide there is an example, where it is confusing:


```
sage: M = matrix.identity(3) + random_matrix(RR,3,3)/10^3
sage: M^2 # abs tol 1e-2
[1 0 0]
[0 1 0]
[0 0 1]
```


There is no mentioning there that only one particular matrix is tested.


---

Comment by git created at 2020-06-22 14:57:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-22 15:14:16

Replying to [comment:8 gh-kliem]:
> Even in the developer guide there is an example, where it is confusing:
> 
> {{{
> sage: M = matrix.identity(3) + random_matrix(RR,3,3)/10^3
> sage: M^2 # abs tol 1e-2
> [1 0 0]
> [0 1 0]
> [0 0 1]
> }}}
> 
> There is no mentioning there that only one particular matrix is tested.

indeed it assumes (?) that the entries of the random matrix are small in abs value


---

Comment by @kliem created at 2020-06-22 15:16:22

Nothing to assume there. `random_matrix(RR,3,3)` has entries between `-1` and `1`. After dividing we are good.


---

Comment by mkoeppe created at 2020-06-22 16:14:14

How about making the random seed an option to `sage-runtests`. Then people can fuzz the doctests if they want.


---

Comment by @kliem created at 2020-06-22 16:27:43

Will people do that? Especially enough to find incorrect claims. If you look into #29936 we have been claiming a preciseness that is far from true. Even if you consider the relative error instead of the absolute error. fuzzed doctests would have easily detected that. Even worse. Maybe the situation was better at some point and we never caught on about the regression.


---

Comment by dimpase created at 2020-06-22 16:39:26

it is not a "real" (time-consuming) fuzzing, it is making the main random seed nondeterministic in tests. making it optional is akin to making tests optional.

we already found a couple of examples which show usefulness of this change in detecting bugs in Sage.


---

Comment by mkoeppe created at 2020-06-22 16:40:57

The option that I propose to add needs to be added in any case, so that when a failure is revealed by a random random seeds, we can reproduce the failure with that seed.


---

Comment by dimpase created at 2020-06-22 16:43:35

it is a good point - and the non-det. seed needs to  be logged - if this is not yet in the branch it should get there.


---

Comment by mkoeppe created at 2020-06-22 16:46:28

So I would suggest to use this ticket to introduce the option, not change the default.


---

Comment by dimpase created at 2020-06-22 16:51:26

no, I don't agree, it makes no sense to test less if one can test more, and also not having it default would not force people to make their tests robust.


---

Comment by mkoeppe created at 2020-06-22 16:51:45

By the way I don't think most doctests have the ambition to demonstrate correctness of mathematical claims. In my opinion, if a doctest intends to do that, it should run an explicit loop of several tests. Still deterministically.


---

Comment by mkoeppe created at 2020-06-22 16:53:21

Why would creating the option and changing the default have to be done on the same ticket? I think it's best practices to separate the two steps on two tickets.


---

Comment by @kliem created at 2020-06-22 16:54:21

Feel free to do with the branch whatever you think is reasonable.


---

Comment by @kliem created at 2020-06-22 17:00:23

What I think would be great if running we could run each file at some "random" seed, e.g.


```
sage -t src/sage/all.py 
Running doctests with ID 2020-06-22-18-56-54-668a26f3.
Git branch: public/29935
Using --optional=4ti2,bliss,build,dochtml,e_antic,flask,flask_autoindex,flask_babel,flask_oldsessions,flask_openid,flask_silk,latte_int,lidia,lrslib,memlimit,normaliz,pynormaliz,python_openid,sage,speaklater,twisted
Doctesting 1 file.
sage -t --warn-long 91.5 --seed 123456 src/sage/all.py
    [16 tests, 0.76 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.8 seconds
    cumulative wall time: 0.8 seconds
```


You can reproduce this test with

```
sage -t --warn-long 91.5 --seed 123456 src/sage/all.py
```


Is a bit annoying, as seeds can be long though. Then whenever a bot or someone discovers a failure, you can reproduce it. At least if it really was caused by the random seed.


---

Comment by mjo created at 2020-06-22 17:39:48

Just to weigh in:

1. The default should be to use a randomly-chosen seed.
2. Failures should be reproducible:
 a. It should be possible to pass a seed to the test runner with e.g. `--seed`.
 b. Any test failures should log/echo the current seed so that the failing test can be reproduced easily using the option in (2.a.).

The sooner we can push this through the better. Tests that don't work due to bugs can even be deleted and replaced with trac tickets saying "this never worked" IMO.


---

Comment by @kliem created at 2020-06-22 18:18:16

With #29904 (already pulled into this branch), #29936 (not yet pulled) and 	`b2954ceea638b4510e99d90cea3f99fa9a49338` (commit from above) geometry should be ready for this.

Edit: The updated branch of #29904 (not yet pulled) doesn't have `set_random_seed` anymore. But there is plenty of `set_random_seed` for cones doctests? Should I remove those as well or do we do this somewhere else?


---

Comment by git created at 2020-06-22 19:05:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-22 19:20:59

Replying to [comment:26 gh-kliem]:
> there is plenty of `set_random_seed` for cones doctests? Should I remove those as well or do we do this somewhere else?

Not on the same ticket.


---

Comment by git created at 2020-06-22 19:23:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-22 19:40:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-22 19:41:21

Please tell me, if I should open seperate tickets for those or something else. I just felt like starting with those. I'm done for today.


---

Comment by @mwageringel created at 2020-06-23 19:02:38

Replying to [comment:25 mjo]:
> 1. The default should be to use a randomly-chosen seed.
> 2. Failures should be reproducible:
>  a. It should be possible to pass a seed to the test runner with e.g. `--seed`.
>  b. Any test failures should log/echo the current seed so that the failing test can be reproduced easily using the option in (2.a.).

+1.

Also note that Sage still uses a verbatim copy of the Python-2 version of the `Random` module during doctesting, which was necessary in order to obtain consistent results between Python 2 and 3. This is why the bug in #29550 went unnoticed, for example. Now that support for Python 2 has been removed, we should switch to the Python 3 version of `Random`. This will require updating lots of doctests, but I assume this ticket here will simplify this if it makes doctests less dependent on the seed/RNG.


---

Comment by @kliem created at 2020-06-23 19:31:57

Apparently `LinearCodeSyndromeDecoder.decode_to_code` is broken.

See #29945.


---

Comment by git created at 2020-06-23 19:34:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-23 21:26:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-23 21:33:08

I specified `random_seed` to distinguish from `--randorder=SEED`. If after `--randorder=SEED` the next option is `--seed=SEED` that sounds a bit weird to me. Although `random_seed` is not much better.


---

Comment by @kliem created at 2020-06-24 08:56:24

Standard  bracked lyndon words are set up incorrectly. I don't know if that should be consider a bug:


```
sage: SBLW33 = StandardBracketedLyndonWords(3,3)
sage: TestSuite(SBLW33).run()
Failure in _test_an_element:
Traceback (most recent call last):
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
    test_method(tester=tester)
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/categories/sets_cat.py", line 1093, in _test_an_element
    tester.assertTrue(an_element in self, "self.an_element() is not in self")
  File "/home/jonathan/Applications/sage/local/lib/python3.7/unittest/case.py", line 692, in assertTrue
    raise self.failureException(msg)
AssertionError: self.an_element() is not in self
------------------------------------------------------------
Failure in _test_enumerated_set_contains:
Traceback (most recent call last):
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
    test_method(tester=tester)
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/categories/enumerated_sets.py", line 945, in _test_enumerated_set_contains
    tester.assertIn(w, self)
  File "/home/jonathan/Applications/sage/local/lib/python3.7/unittest/case.py", line 1106, in assertIn
    self.fail(self._formatMessage(msg, standardMsg))
  File "/home/jonathan/Applications/sage/local/lib/python3.7/unittest/case.py", line 680, in fail
    raise self.failureException(msg)
AssertionError: [1, [1, 2]] not found in Standard bracketed Lyndon words from an alphabet of size 3 of length 3
------------------------------------------------------------
Failure in _test_some_elements:
Traceback (most recent call last):
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
    test_method(tester=tester)
  File "/home/jonathan/Applications/sage/local/lib/python3.7/site-packages/sage/categories/sets_cat.py", line 1385, in _test_some_elements
    "the object %s in self.some_elements() is not in self")%(x,))
  File "/home/jonathan/Applications/sage/local/lib/python3.7/unittest/case.py", line 692, in assertTrue
    raise self.failureException(msg)
AssertionError: the object [1, [1, 2]] in self.some_elements() is not in self
------------------------------------------------------------
The following tests failed: _test_an_element, _test_enumerated_set_contains, _test_some_elements
```



---

Comment by git created at 2020-06-24 09:12:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-24 09:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-24 12:13:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-24 13:23:59

In `src/sage/plot/multigraphics.py` is a doctest that fails with the precicion:


```
1294             sage: g1 = plot(sin(x), (x, -pi, pi))
1295             sage: g2 = circle((0,1), 1.)
1296             sage: G = graphics_array([g1, g2])
1297             sage: G.position(0)  # tol 1.0e-13
1298             (0.023437500000000003,
1299              0.03415488992713045,
1300              0.4627803348994754,
1301              0.9345951100728696)
1302             sage: G.position(1)  # tol 1.0e-13
1303             (0.5136230468749999,
1304              0.19293222169724827,
1305              0.46278033489947534,
1306              0.617040446532634)
```

when running on `set_random_seed(151058820726654196682836430928254760259)`. The precision is somewhere around `1e-3` then. Is this a bug?


---

Comment by git created at 2020-06-24 15:46:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-24 16:31:14

It may be too late for this, but I would suggest a staged approach:

- ticket 1: implement optional random seed but don't make it the default
- tickets 2-n: fix doctests when using random seeds in various parts of the Sage library
- ticket n+1: make random seed standard, if that is what people think should be done

Doing everything all at once is likely to lead to a patch bomb, which will lead to merge conflicts and in general be hard to deal with.


---

Comment by @kliem created at 2020-06-24 18:08:08

There is a reason that I have the fixes grouped by parts of sage. So that isn't spoiled yet.

That completely makes sense. We still need the last ticket to have the bots test everything.


---

Comment by git created at 2020-06-24 19:02:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-24 19:20:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-24 19:58:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-06-24 20:01:41

New commits:


---

Comment by @kliem created at 2020-06-29 08:38:55

We had a little discussion on #29971, how we treat doctests as

```
sage: C = FiniteEnumeratedSets().example()
sage: C.random_element()
1
```


If we tag this as `# random` and maybe test instead containment in `C`, the doctest we will essentially remove the doctest and add another. Is this what we want?

Matthias Koeppe suggested inventing a new tag maybe `# random-seed=0`. If we implicitly fuzz all doctests this would only be tested if we run the test block twice?!

I think we should agree on a something here. Depending on the agreement it needs to be taken care of with #29962 already.

IMO tests as `C.random_element()` should run at least once with fuzzing (with checking that the object is consistent). We can run it twice to obtain our old test, but I would appreciate some help with that.


---

Comment by mjo created at 2020-06-29 11:46:19

This will do the job, and doesn't depend on the literal output of the random function:


```
sage: C = FiniteEnumeratedSets().example()
sage: C.random_element() in C
True
```



---

Comment by @kliem created at 2020-06-29 12:38:21

In principal I agree.

I prefer

```
sage: C = FiniteEnumeratedSets().example()
sage: n = C.random_element(); n  # random
1
sage: n in C
True
```

as this makes it a bit easier for the user to see, what will/might happen. But that is only minor.

However, I just noticed, that there are problems with that approach. The representation of those random things will never be checked. In principal (almost) all random events should be reproducible with some random seed (doesn't work for e.g. hashing). By tagging something as `# random`, we might document nonsense or outdated information and no one will catch on.

E.g. in #29981 I fixed a documentation mistake along the way: Solve a linear equation system with `A\v` with `A` a random matrix. `A` should be non-singular of course, which was never thought of because the doctest is only tested for one matrix, which happens to be non-singular. In #29981, `A` is defined as `A = random_matrix(QQ, 3, algorithm='unimodular')`. However, I forgot to update the representation of `A` to some unimodular matrix and the doctests never caught on.

Now if you tag something as `# random-seed=0` and we find some way to test this (both seed 0 and different), it would mean that the printed representations stay up to date and consistent and it is also tested, if those thing work for "random" input.

I found many examples where functions where tested assuming random seed 0. One could make use of the double testing framework:

```
def foo(y):
   r"""
   EXAMPLES::

      sage: M = random(); M  # random-seed=0
      <some random input>
      sage: N = foo(M); N  # random-seed=0
      <some random output>
      sage: check_for_consistency(M, N)
   """
   return _foo(y)
```

It is still checked, that `foo` works exactly for some example that hopefully was verified by someone. But it is also checked, that the method in principal works on "random" input and that the output appears to be correct.


---

Comment by mjo created at 2020-06-29 17:41:48

If we want to check the printed/string representation of something, can't we just... check it? In other words, instead of


```
sage: C = FiniteEnumeratedSets().example()
sage: C.random_element()
1
```


we could do


```
sage: C = FiniteEnumeratedSets().example()
sage: C.random_element() in C
True
sage: C[0]
1
```


This has the (big, in my opinion) added benefit of actually being a runnable example. If a user runs


```
sage: C = FiniteEnumeratedSets().example()
sage: n = C.random_element(); n  # random
```


then he's not going to see what the documentation says he should see, because `# random` does nothing on the command-line.


---

Comment by @mwageringel created at 2020-06-29 17:46:47

IMO, it is not necessary to test the printing of random elements, as the repr of those elements is already tested elsewhere. We do not make any promises about the precise elements that are returned with a seed of 0, so we should not bake that into the doctests. As we cannot test the randomness, we can only test that `random_element` returns an element of the parent. The following check could be used for that:

```
sage: C.random_element().parent() is C
```

Unlike `__contains__`, this does not implicitly coerce the element into `C`.


---

Comment by mjo created at 2020-06-29 18:23:04

Replying to [comment:62 gh-mwageringel]:
> IMO, it is not necessary to test the printing of random elements, as the repr of those elements is already tested elsewhere. We do not make any promises about the precise elements that are returned with a seed of 0, so we should not bake that into the doctests. As we cannot test the randomness, we can only test that `random_element` returns an element of the parent. The following check could be used for that:
> {{{
> sage: C.random_element().parent() is C
> }}}
> Unlike `__contains__`, this does not implicitly coerce the element into `C`.

Sounds good to me.


---

Comment by @kliem created at 2020-06-29 19:06:25

Replying to [comment:60 gh-kliem]:
> {{{
Sounds good to me. As for the documentation of `random_element`, I don't think a user cares about the precise value of `set_random_seed(0); C.random_element()`.

Two more cases that I would like to discuss.

- Basically from comment:60. How do we deal with something like this:

```
def foo(y):
   r"""
   EXAMPLES::

      sage: M = random(); M
      <some random input>
      sage: foo(M)
      <some random output>
   """
```

  It appears to me that there are many examples, where someone did not write down a concrete element to doctest. I would propose having two doctests, if possible:
  - Explicitly obtain the old test.
  - Have a "random" test with a consistency check. (Even without a consistency check, it's probably worth checking that the function terminates without an error usually.)
- The other one is a concrete example from #29981 (linear algrebra tutorial). The original test is

```
    sage: A=random_matrix(QQ,3)
    sage: v=vector([2,3,1])
    sage: A,v
    (
    [ 0 -1  1]
    [-1 -1 -1]
    [ 0  2  2], (2, 3, 1)
    )
    sage: x=A\v; x
    (-7/2, -3/4, 5/4)
    sage: A*x
    (2, 3, 1)
```

  As mentioned already, this does not work. I see basically two ways of fixing this. One is to explicitly write down `A`. The other one is similar to what I did. Use a correct random approach (e.g. random unimodular) and check that indeed `A*x == v`. Optionally one can print `x` and `A` and tag this as random. To be honest, I don't see how a user would profit from the printing. What a 3 by 3 matrix looks like should be clear by then.


---

Comment by mjo created at 2020-06-29 19:17:11

Replying to [comment:64 gh-kliem]:
> 
> - Basically from comment:60. How do we deal with something like this:
> {{{
> def foo(y):
>    r"""
>    EXAMPLES::
> 
>       sage: M = random(); M
>       <some random input>
>       sage: foo(M)
>       <some random output>
>    """
> }}}

If the point isn't to demonstrate the `random()` function, then the "random" element can just be replaced with whatever it winds up with now (i.e. the fixed element you get with a seed of zero).
The `TESTS` block can contain some truly random test of a property that the output from `foo()` should satisfy, like


```
sage: foo(random()) in RR
True
```



> - The other one is a concrete example from #29981 (linear algrebra tutorial). The original test is
> {{{
>     sage: A=random_matrix(QQ,3)
>     sage: v=vector([2,3,1])
>     sage: A,v
>     (
>     [ 0 -1  1]
>     [-1 -1 -1]
>     [ 0  2  2], (2, 3, 1)
>     )
>     sage: x=A\v; x
>     (-7/2, -3/4, 5/4)
>     sage: A*x
>     (2, 3, 1)
> }}}

How about...


```
sage: A = random_matrix(QQ,3)
sage: while not A.is_invertible():
....:     A = random_matrix(QQ,3)
....:     
sage: v=vector([2,3,1])
sage: x=A\v
sage: A*x - v == 0
True
```



---

Comment by @kliem created at 2020-07-02 11:18:14

Replying to [comment:65 mjo]:
> Replying to [comment:64 gh-kliem]:
> > 
> > - Basically from comment:60. How do we deal with something like this:
> > {{{
> > def foo(y):
> >    r"""
> >    EXAMPLES::
> > 
> >       sage: M = random(); M
> >       <some random input>
> >       sage: foo(M)
> >       <some random output>
> >    """
> > }}}
> 
> If the point isn't to demonstrate the `random()` function, then the "random" element can just be replaced with whatever it winds up with now (i.e. the fixed element you get with a seed of zero).
> The `TESTS` block can contain some truly random test of a property that the output from `foo()` should satisfy, like
> 
> {{{
> sage: foo(random()) in RR
> True
> }}}
> 
> 
> > - The other one is a concrete example from #29981 (linear algrebra tutorial). The original test is
> > {{{
> >     sage: A=random_matrix(QQ,3)
> >     sage: v=vector([2,3,1])
> >     sage: A,v
> >     (
> >     [ 0 -1  1]
> >     [-1 -1 -1]
> >     [ 0  2  2], (2, 3, 1)
> >     )
> >     sage: x=A\v; x
> >     (-7/2, -3/4, 5/4)
> >     sage: A*x
> >     (2, 3, 1)
> > }}}
> 
> How about...
> 
> {{{
> sage: A = random_matrix(QQ,3)
> sage: while not A.is_invertible():
> ....:     A = random_matrix(QQ,3)
> ....:     
> sage: v=vector([2,3,1])
> sage: x=A\v
> sage: A*x - v == 0
> True
> }}}

Sounds reasonable to me. I will adhere to those suggestions.


---

Comment by @kliem created at 2020-07-11 07:01:18

New commits:


---

Comment by @kliem created at 2020-07-11 07:29:53

Maybe it makes sense to restrict the size of the random seed, so that one can still read the output of doctesting.


---

Comment by dimpase created at 2020-07-11 07:32:16

Replying to [comment:69 gh-kliem]:
> Maybe it makes sense to restrict the size of the random seed, so that one can still read the output of doctesting.

it's not clear to me what you mean here.


---

Comment by @kliem created at 2020-07-11 07:36:30


```
sage -t src/sage/all.py 
Running doctests with ID 2020-06-23-23-19-03-8003eea5.
...
sage -t --warn-long 89.5 --random-seed=273987373473433732996760115183658447263 src/sage/all.py
    [16 tests, 0.73 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```


Currently this output is the plan. This might be very annoying for patchbots and so on. If we instead restrict to fewer digits, we will still test a reasonable amount of different inputs and you can still read this line (even if working on a non-huge screen).


---

Comment by dimpase created at 2020-07-11 07:41:09

I think it is ok - compare this with very long lists of optional packages which are there sometimes.


---

Comment by @kliem created at 2020-08-24 06:30:35

See #29962#comment:19


---

Comment by mkoeppe created at 2021-03-27 02:13:38

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by slelievre created at 2021-04-29 22:00:45

Marking this as a meta-ticket.


---

Comment by slelievre created at 2021-04-29 22:00:45

Changing keywords from "" to "fuzz, random, seed".


---

Comment by slelievre created at 2021-06-08 10:30:26

Expanding the ticket description, adding a code snippet giving
a way to set a random randomness seed, which I find useful
for working on the (few remaining) dependencies of this ticket.


---

Comment by @kliem created at 2021-07-01 12:41:10

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-07-01 16:06:11

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-07-01 16:06:11

A couple of new tests fail yet.


---

Comment by @kliem created at 2021-07-03 09:20:18

Last 10 new commits:


---

Comment by git created at 2021-07-03 09:38:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 21:25:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 08:54:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 08:57:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-05 08:59:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-05 09:06:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 09:25:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 17:25:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-06 07:18:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-06 15:58:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-07-06 16:01:32

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-07-06 16:01:32

This is getting more and more stable.

I can now run it on 8 random seeds without failure (or without failure that doesn't appear on random seed 0). There are probably still failing examples, but its getting to a point, where it won't prevent patchbots from working and it's not too much of a burden to report failures because of this.


---

Comment by @mwageringel created at 2021-07-06 19:26:34

We should also remember to try the optional tests at some point, but I assume the majority of them does not use randomness.


---

Comment by @kliem created at 2021-07-06 19:29:51

Right, I forgot about the optional packages.

I hope this helps a bit:

https://github.com/kliem/sage/pull/48/checks


---

Comment by git created at 2021-07-09 19:22:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-12 06:49:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-12 15:34:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-12 15:40:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-07-12 15:56:50

I outsourced many of the small fixes to #32188, to make review here easier.


---

Comment by nbruin created at 2021-07-16 16:53:02

Note that doctesting with a fixed seed is publicly documented behaviour in sage. Quoting from [Developer guide](https://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests):

    ''However, most functions generating pseudorandom output do not need this tag since the doctesting framework guarantees the state of the pseudorandom number generators (PRNGs) used in Sage for a given doctest.
''

I would think that tests explicitly relying on this behaviour are rather weak and I wouldn't mind changing this "policy", but we shouldn't forget to update the developer guide as well.


---

Comment by @kliem created at 2021-07-16 20:00:03

Replying to [comment:139 nbruin]:
> Note that doctesting with a fixed seed is publicly documented behaviour in sage. Quoting from [Developer guide](https://doc.sagemath.org/html/en/developer/coding_basics.html#special-markup-to-influence-doctests):
> 
>     ''However, most functions generating pseudorandom output do not need this tag since the doctesting framework guarantees the state of the pseudorandom number generators (PRNGs) used in Sage for a given doctest.
> ''
> 
> I would think that tests explicitly relying on this behaviour are rather weak and I wouldn't mind changing this "policy", but we shouldn't forget to update the developer guide as well.

Thanks for the pointer. This is now #32216.


---

Comment by @kliem created at 2021-09-16 08:55:07

I'll leave #32169 for later and would just like to get this in.
----
New commits:


---

Comment by mjo created at 2021-09-16 13:21:44

I think this,


```patch
         ....:     n = ZZ.random_element().abs() + 5
+        ....:     if n > 5000:  # avoid timeouts
+        ....:         continue
```


can be simplified by passing `(5,5001)` as the bound to `ZZ.random_element()`, without abs.

And the fix for this has already been merged:


```patch
+        sage: test_symbolic_expression_order(10000)  # long time,  # not tested, known bug (see :trac:`32185`)
```



---

Comment by git created at 2021-09-16 14:53:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-16 15:21:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-17 09:00:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-09-19 10:56:07

Looks OK now, but there's really no way to be 100% certain. We will probably discover a few instances where e.g. a ptestlong happens to generate four relatively hard problems at once, leading to intermittent timeouts. But regardless, I think the sooner we can get this in, the better. I started some GH actions for added test cycles.


---

Comment by @DaveWitteMorris created at 2021-09-20 01:24:17

Replying to [comment:148 mjo]:
> ... I think the sooner we can get this in, the better. ...

+1


---

Comment by git created at 2021-09-20 07:11:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-20 07:18:46

I also think this is ready. It is rather stable now.

We should open a new (meta?) ticket, to collect all those failures, I think.


---

Comment by mjo created at 2021-09-21 00:26:05

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2021-09-21 00:26:05

Let's just do it before beta2 happens.

Thanks for all your work on this, I never had the courage to try it myself.


---

Comment by @kliem created at 2021-09-21 04:31:54

Thank you.


---

Comment by @kliem created at 2021-09-21 06:36:58

I created #32544 for the errors appearing now that this is positively reviewed.
There already is a ticket on it (#32543).


---

Comment by vbraun created at 2021-10-02 14:33:03


```
sage -t --long --warn-long 45.3 --random-seed=58740356065403116296055203326248101103 src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 23499, in sage.graphs.generic_graph.GenericGraph.edge_polytope
Failed example:
    P.is_combinatorially_isomorphic(product(components))
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  24 in sage.graphs.generic_graph.GenericGraph.edge_polytope
    [3598 tests, 1 failure, 22.29 s]
----------------------------------------------------------------------
sage -t --long --warn-long 45.3 --random-seed=58740356065403116296055203326248101103 src/sage/graphs/generic_graph.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2021-10-02 14:33:03

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2021-10-02 19:02:45

So this ticket got rejected because it detected my own mistake in #32498. That's fair I guess.

What I claimed is complete nonsense, but it did work for seed 0 I guess. The (symmetric) edge polytope of a graph is of course the **join** of the (symmetric) edge polytopes of the connecting compoments.


---

Comment by @kliem created at 2021-10-02 19:28:48

No, that is not the join, it is the subdirect sum. It is really worth reading the definitions once in a while...


---

Comment by git created at 2021-10-02 19:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-10-02 19:33:07

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-10-02 19:33:07

`@`Martin Rubey: Can you please check the fix of #32498, everything else should still be fine.


---

Comment by mantepse created at 2021-10-04 08:01:14

I'm afraid there is a `MemoryError` reported by the bot.  I'll check whether it is reproducible.


---

Comment by mantepse created at 2021-10-04 08:06:58


```
sage -t --random-seed=306431873350217748498615142104107167501 src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 23601, in sage.graphs.generic_graph.GenericGraph.symmetric_edge_polytope
Failed example:
    P.is_combinatorially_isomorphic(P1.subdirect_sum(P2))
Exception raised:
    Traceback (most recent call last):
      File "/home/martin/sage-develop/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/martin/sage-develop/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.symmetric_edge_polytope[20]>", line 1, in <module>
        P.is_combinatorially_isomorphic(P1.subdirect_sum(P2))
      File "/home/martin/sage-develop/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base.py", line 10715, in is_combinatorially_isomorphic
        return G_self.is_isomorphic(G_other)
      File "/home/martin/sage-develop/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py", line 22672, in is_isomorphic
        isom = isomorphic(GC, GC2, partition, partition2, (self._directed or self.has_loops()), 1)
      File "sage/groups/perm_gps/partn_ref/refinement_graphs.pyx", line 163, in sage.groups.perm_gps.partn_ref.refinement_graphs.isomorphic (build/cythonized/sage/groups/perm_gps/partn_ref/refinement_graphs.c:6775)
        cdef bint isomorphic = double_coset(<void *>GS1, <void *>GS2, part, ordering, n, &all_children_are_equivalent, &refine_by_degree, &compare_graphs, NULL, NULL, output)
      File "sage/groups/perm_gps/partn_ref/double_coset.pyx", line 364, in sage.groups.perm_gps.partn_ref.double_coset.double_coset (build/cythonized/sage/groups/perm_gps/partn_ref/double_coset.c:5618)
        raise MemoryError
    MemoryError
**********************************************************************
1 item had failures:
   1 of  53 in sage.graphs.generic_graph.GenericGraph.symmetric_edge_polytope
    [3558 tests, 1 failure, 42.09 s]
----------------------------------------------------------------------
sage -t --random-seed=306431873350217748498615142104107167501 src/sage/graphs/generic_graph.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 43.1 seconds
    cpu time: 40.1 seconds
    cumulative wall time: 42.1 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

Comment by @kliem created at 2021-10-04 08:08:21

Looks like I need to reduce the number of vertices.


---

Comment by git created at 2021-10-04 08:16:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-10-04 08:19:57

Previously I decomposed random graphs of up to 12 vertices. Now I take the disjoint union of random graphs and need to go down with the number of vertices.


---

Comment by mantepse created at 2021-10-04 09:45:19

timeout


---

Attachment

It seems that there is still a problem.  With some seeds, testing `generic_graph.py` takes about 16 seconds on my computer.  However,

```
sage -t --random-seed=236024484355828254371843550334759500607 src/sage/graphs/generic_graph.py
```

times out.  I attached the log.  The last line executed is

```
sage: trees = g.edge_disjoint_spanning_trees(k) ## line 6282 ##
```


Of course, this should not have anything to do with the SEP.


---

Comment by @kliem created at 2021-10-04 09:57:01

Yes, that is #32169. I was wondering why it did not happen in this case.


---

Comment by git created at 2021-10-04 09:59:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-08 07:49:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-08 14:22:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-10-08 14:23:24

New commits:


---

Comment by git created at 2021-10-11 05:06:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @kliem created at 2021-10-11 05:07:56

Rebased on #32498, which fixes the error with (symmetric) edge polytopes.


---

Comment by @kliem created at 2021-10-11 07:04:33

Correct ticket.


---

Comment by mjo created at 2021-10-13 12:08:27

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-10-13 12:20:37

Thank you.


---

Comment by mjo created at 2021-10-13 12:22:35

No problem, you'll have to rebase this onto the typo-fix too I think.


---

Comment by git created at 2021-10-13 12:25:48

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-10-13 12:25:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:


---

Comment by @kliem created at 2021-10-13 12:26:17

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-10-13 12:26:41

Replying to [comment:176 mjo]:
> No problem, you'll have to rebase this onto the typo-fix too I think.

I don't know, if this is necessary, but it sure doesn't hurt.


---

Comment by vbraun created at 2021-10-13 19:27:44

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-10-13 19:27:44

Merge conflict


---

Comment by @kliem created at 2021-10-13 19:39:04

This is the merge conflict, which permits a trivial solution (at least trivial for a human being):


```diff
diff --cc src/bin/sage-runtests
index d1fe6567e7,4fc2062b15..0000000000
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@@ -64,59 -55,60 +55,97 @@@ if __name__ == "__main__"
               'if "external" is listed, will also run tests for available external software; '
               'if "build" is listed, will also run tests specific to Sage\'s build/packaging system; '
               'if set to "all", then all tests will be run')
++<<<<<<< HEAD
 +    parser.add_option("--randorder", type=int, metavar="SEED", help="randomize order of tests")
 +    parser.add_option("--random-seed", dest="random_seed", type=int, metavar="SEED", help="random seed (integer) for fuzzing doctests")
 +    parser.add_option("--global-iterations", "--global_iterations", type=int, default=0, help="repeat the whole testing process this many times")
 +    parser.add_option("--file-iterations", "--file_iterations", type=int, default=0, help="repeat each file this many times, stopping on the first failure")
 +    parser.add_option("--environment", type=str, default="sage.repl.ipython_kernel.all_jupyter", help="name of a module that provides the global environment for tests")
 +
 +    parser.add_option("-i", "--initial", action="store_true", default=False, help="only show the first failure in each file")
 +    parser.add_option("--exitfirst", action="store_true", default=False, help="end the test run immediately after the first failure or unexpected exception")
 +    parser.add_option("--force_lib", "--force-lib", action="store_true", default=False, help="do not import anything from the tested file(s)")
 +    parser.add_option("--abspath", action="store_true", default=False, help="print absolute paths rather than relative paths")
 +    parser.add_option("--verbose", action="store_true", default=False, help="print debugging output during the test")
 +    parser.add_option("-d", "--debug", action="store_true", default=False, help="drop into a python debugger when an unexpected error is raised")
 +    parser.add_option("--only-errors", action="store_true", default=False, help="only output failures, not test successes")
 +
 +    parser.add_option("--gdb", action="store_true", default=False, help="run doctests under the control of gdb")
 +    parser.add_option("--valgrind", "--memcheck", action="store_true", default=False,
 +                      help="run doctests using Valgrind's memcheck tool.  The log "
 +                         "files are named sage-memcheck.PID and can be found in " +
 +                         os.path.join(DOT_SAGE, "valgrind"))
 +    parser.add_option("--massif", action="store_true", default=False,
 +                      help="run doctests using Valgrind's massif tool.  The log "
 +                         "files are named sage-massif.PID and can be found in " +
 +                         os.path.join(DOT_SAGE, "valgrind"))
 +    parser.add_option("--cachegrind", action="store_true", default=False,
 +                      help="run doctests using Valgrind's cachegrind tool.  The log "
 +                         "files are named sage-cachegrind.PID and can be found in " +
 +                         os.path.join(DOT_SAGE, "valgrind"))
 +    parser.add_option("--omega", action="store_true", default=False,
 +                      help="run doctests using Valgrind's omega tool.  The log "
 +                         "files are named sage-omega.PID and can be found in " +
 +                         os.path.join(DOT_SAGE, "valgrind"))
 +
 +    parser.add_option("-f", "--failed", action="store_true", default=False,
++=======
+     parser.add_argument("--randorder", type=int, metavar="SEED", help="randomize order of tests")
+     parser.add_argument("--random-seed", dest="random_seed", type=int, metavar="SEED", help="random seed for fuzzing doctests")
+     parser.add_argument("--global-iterations", "--global_iterations", type=int, default=0, help="repeat the whole testing process this many times")
+     parser.add_argument("--file-iterations", "--file_iterations", type=int, default=0, help="repeat each file this many times, stopping on the first failure")
+     parser.add_argument("--environment", type=str, default="sage.repl.ipython_kernel.all_jupyter", help="name of a module that provides the global environment for tests")
+ 
+     parser.add_argument("-i", "--initial", action="store_true", default=False, help="only show the first failure in each file")
+     parser.add_argument("--exitfirst", action="store_true", default=False, help="end the test run immediately after the first failure or unexpected exception")
+     parser.add_argument("--force_lib", "--force-lib", action="store_true", default=False, help="do not import anything from the test
...
```



---

Comment by git created at 2021-10-13 19:40:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-10-13 19:41:57

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-10-19 20:35:13

Resolution: fixed
