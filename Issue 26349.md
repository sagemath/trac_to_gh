# Issue 26349: Failing doctest in poset_examples

archive/issues_026349.json:
```json
{
    "body": "With `--gc=never`, this doctest fails consistently:\n\n```\n./sage -t --gc=never src/sage/combinat/posets/poset_examples.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2018-10-28-23-55-00-fb2259d6.\nGit branch: t/24593/upgrade_from_thebe_to_thebelab_for_live_documentation_support\nUsing --optional=dochtml,meataxe,memlimit,mpir,python2,sage\nDoctesting 1 file.\nsage -t src/sage/combinat/posets/poset_examples.py\n**********************************************************************\nFile \"src/sage/combinat/posets/poset_examples.py\", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset\nFailed example:\n    P.cover_relations()\nExpected:\n    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),\n    (1, 1)]]\nGot:\n    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset\n    [159 tests, 1 failure, 11.36 s]\n----------------------------------------------------------------------\nsage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26586\n\n",
    "created_at": "2018-10-28T22:57:08Z",
    "labels": [
        "combinatorics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Failing doctest in poset_examples",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26349",
    "user": "@jdemeyer"
}
```
With `--gc=never`, this doctest fails consistently:

```
./sage -t --gc=never src/sage/combinat/posets/poset_examples.py
too many failed tests, not using stored timings
Running doctests with ID 2018-10-28-23-55-00-fb2259d6.
Git branch: t/24593/upgrade_from_thebe_to_thebelab_for_live_documentation_support
Using --optional=dochtml,meataxe,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/combinat/posets/poset_examples.py
**********************************************************************
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
Failed example:
    P.cover_relations()
Expected:
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),
    (1, 1)]]
Got:
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
**********************************************************************
1 item had failures:
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
    [159 tests, 1 failure, 11.36 s]
----------------------------------------------------------------------
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
----------------------------------------------------------------------
```


Issue created by migration from https://trac.sagemath.org/ticket/26586





---

archive/issue_comments_371010.json:
```json
{
    "body": "It seems that adding sorted() to the doctest does not sort, hence does not fix the issue\n\n```\nchapoton@pc-chapoton:~/sage$ ./sage -t --gc=never src/sage/combinat/posets/poset_examples.py\ntoo few successful tests, not using stored timings\nRunning doctests with ID 2018-10-29-10-25-27-f966edb9.\nGit branch: poset\nUsing --optional=4ti2,ccache,dochtml,dot2tex,fricas,gfortran,latte_int,lidia,lrslib,memlimit,mpir,python2,sage\nDoctesting 1 file.\nsage -t src/sage/combinat/posets/poset_examples.py\n**********************************************************************\nFile \"src/sage/combinat/posets/poset_examples.py\", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset\nFailed example:\n    sorted(P.cover_relations())\nExpected:\n    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),\n    (1, 1)]]\nGot:\n    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset\n    [159 tests, 1 failure, 1.79 s]\n----------------------------------------------------------------------\nsage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed\n```\n",
    "created_at": "2018-10-29T09:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371010",
    "user": "@fchapoton"
}
```

It seems that adding sorted() to the doctest does not sort, hence does not fix the issue

```
chapoton@pc-chapoton:~/sage$ ./sage -t --gc=never src/sage/combinat/posets/poset_examples.py
too few successful tests, not using stored timings
Running doctests with ID 2018-10-29-10-25-27-f966edb9.
Git branch: poset
Using --optional=4ti2,ccache,dochtml,dot2tex,fricas,gfortran,latte_int,lidia,lrslib,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/combinat/posets/poset_examples.py
**********************************************************************
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
Failed example:
    sorted(P.cover_relations())
Expected:
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),
    (1, 1)]]
Got:
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
**********************************************************************
1 item had failures:
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
    [159 tests, 1 failure, 1.79 s]
----------------------------------------------------------------------
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
```




---

archive/issue_comments_371011.json:
```json
{
    "body": "A difference also happens with respect to `--long` on the same file (on linux-ubuntu):\n\n```\nmartin@convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          \ntoo many failed tests, not using stored timings                                                                                                       \nRunning doctests with ID 2018-11-21-07-24-59-6ea730c0.                                                                                                \nGit branch: develop                                                                                                                                   \nUsing --optional=memlimit,sage                                                                                                                        \nDoctesting 1 file.                                                                                                                                    \nsage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             \n    [160 tests, 2.88 s]                                                                                                                               \n----------------------------------------------------------------------                                                                                \nAll tests passed!                                                                                                                                     \n----------------------------------------------------------------------                                                                                \nTotal time for all tests: 3.0 seconds                                                                                                                 \n    cpu time: 2.8 seconds                                                                                                                             \n    cumulative wall time: 2.9 seconds\n                                                                                                                 \nmartin@convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py \ntoo many failed tests, not using stored timings                                                                                                       \nRunning doctests with ID 2018-11-21-07-25-08-142907c8.                                                                                                \nGit branch: develop                                                                                                                                   \nUsing --optional=memlimit,sage                                                                                                                        \nDoctesting 1 file.                                                                                                                                    \nsage -t src/sage/combinat/posets/poset_examples.py                                                                                                    \n**********************************************************************                                                                                \nFile \"src/sage/combinat/posets/poset_examples.py\", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                         \nFailed example:                                                                                                                                       \n    P.cover_relations()                                                                                                                               \nExpected:                                                                                                                                             \n    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),                                                                                   \n    (1, 1)]]                                                                                                                                          \nGot:                                                                                                                                                  \n    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]                                                                          \n**********************************************************************                                                                                \n1 item had failures:                                                                                                                                  \n   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                                                                           \n    [159 tests, 1 failure, 2.09 s]                                                                                                                    \n----------------------------------------------------------------------                                                                                \nsage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed \n----------------------------------------------------------------------                                                                                \nTotal time for all tests: 2.2 seconds                                                                                                                 \n    cpu time: 2.0 seconds                                                                                                                             \n    cumulative wall time: 2.1 seconds  \n```\n\n\nMoreover, removing the only `# long` marker from this file (in line 963), the problem is not visible anymore!\n\n```\nmartin@convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          \ntoo many failed tests, not using stored timings                                                                                                       \nRunning doctests with ID 2018-11-21-07-25-28-653967b1.                                                                                                \nGit branch: develop                                                                                                                                   \nUsing --optional=memlimit,sage                                                                                                                        \nDoctesting 1 file.                                                                                                                                    \nsage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             \n    [160 tests, 2.88 s]                                                                                                                               \n----------------------------------------------------------------------                                                                                \nAll tests passed!                                                                                                                                     \n----------------------------------------------------------------------                                                                                \nTotal time for all tests: 2.9 seconds                                                                                                                 \n    cpu time: 2.8 seconds                                                                                                                             \n    cumulative wall time: 2.9 seconds                                                                                                                 \n\nmartin@convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py                                          \ntoo many failed tests, not using stored timings                                                                                                       \nRunning doctests with ID 2018-11-21-07-25-36-4df51548.                                                                                                \nGit branch: develop                                                                                                                                   \nUsing --optional=memlimit,sage                                                                                                                        \nDoctesting 1 file.                                                                                                                                    \nsage -t src/sage/combinat/posets/poset_examples.py                                                                                                    \n    [160 tests, 2.88 s]                                                                                                                               \n----------------------------------------------------------------------                                                                                \nAll tests passed!                                                                                                                                     \n----------------------------------------------------------------------                                                                                \nTotal time for all tests: 2.9 seconds                                                                                                                 \n    cpu time: 2.8 seconds                                                                                                                             \n    cumulative wall time: 2.9 seconds   \n```\n",
    "created_at": "2018-11-21T06:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371011",
    "user": "@mantepse"
}
```

A difference also happens with respect to `--long` on the same file (on linux-ubuntu):

```
martin@convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-24-59-6ea730c0.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 3.0 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds
                                                                                                                 
martin@convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py 
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-08-142907c8.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t src/sage/combinat/posets/poset_examples.py                                                                                                    
**********************************************************************                                                                                
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                         
Failed example:                                                                                                                                       
    P.cover_relations()                                                                                                                               
Expected:                                                                                                                                             
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),                                                                                   
    (1, 1)]]                                                                                                                                          
Got:                                                                                                                                                  
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]                                                                          
**********************************************************************                                                                                
1 item had failures:                                                                                                                                  
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                                                                           
    [159 tests, 1 failure, 2.09 s]                                                                                                                    
----------------------------------------------------------------------                                                                                
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed 
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.2 seconds                                                                                                                 
    cpu time: 2.0 seconds                                                                                                                             
    cumulative wall time: 2.1 seconds  
```


Moreover, removing the only `# long` marker from this file (in line 963), the problem is not visible anymore!

```
martin@convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-28-653967b1.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.9 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds                                                                                                                 

martin@convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-36-4df51548.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t src/sage/combinat/posets/poset_examples.py                                                                                                    
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.9 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds   
```




---

archive/issue_comments_371012.json:
```json
{
    "body": "Finally, when running the offending test on its own in a session, there is no mismatch:\n\n```\nmartin@convex63:~/sage-develop$ ./sage                                                                                                                \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                                                                \n\u2502 SageMath version 8.5.beta4, Release Date: 2018-11-18               \u2502                                                                                \n\u2502 Using Python 2.7.15. Type \"help()\" for help.                       \u2502                                                                                \n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                                                                \n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513                                                                                \n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503                                                                                \n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b                                                                                \nsage: P = posets.YoungDiagramPoset(Partition([2,2])); P                                                                                               \nFinite meet-semilattice containing 4 elements                                                                                                         \nsage: P.cover_relations()                                                                                                                             \n[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]\n```\n\nAdding\n\n```\n            sage: import gc                                                                                                                           \n            sage: gc.collect() # random                                                                                                               \n \n```\n\njust before the test in line 1400 \"fixes\" it.",
    "created_at": "2018-11-21T06:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371012",
    "user": "@mantepse"
}
```

Finally, when running the offending test on its own in a session, there is no mismatch:

```
martin@convex63:~/sage-develop$ ./sage                                                                                                                
┌────────────────────────────────────────────────────────────────────┐                                                                                
│ SageMath version 8.5.beta4, Release Date: 2018-11-18               │                                                                                
│ Using Python 2.7.15. Type "help()" for help.                       │                                                                                
└────────────────────────────────────────────────────────────────────┘                                                                                
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                                                                                
┃ Warning: this is a prerelease version, and it may be unstable.     ┃                                                                                
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛                                                                                
sage: P = posets.YoungDiagramPoset(Partition([2,2])); P                                                                                               
Finite meet-semilattice containing 4 elements                                                                                                         
sage: P.cover_relations()                                                                                                                             
[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
```

Adding

```
            sage: import gc                                                                                                                           
            sage: gc.collect() # random                                                                                                               
 
```

just before the test in line 1400 "fixes" it.



---

archive/issue_comments_371013.json:
```json
{
    "body": "Here is a minimal example for my computer.  Could you please check whether this yields a failure when run without `--long` and no failure when run with `--long`?\n\n\n```\ndef A():\n    \"\"\"\n    sage: posets.ProductOfChains([2, 2]).linear_extension()\n    [(0, 0), (1, 0), (0, 1), (1, 1)]\n    \n    sage: posets.SSTPoset([3,2]).bottom()  # long time\n    [[1, 1, 1], [2, 2]]\n    \"\"\"\n\ndef B():\n    \"\"\"\n    sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()\n    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]\n    \"\"\"\n```\n",
    "created_at": "2018-11-21T13:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371013",
    "user": "@mantepse"
}
```

Here is a minimal example for my computer.  Could you please check whether this yields a failure when run without `--long` and no failure when run with `--long`?


```
def A():
    """
    sage: posets.ProductOfChains([2, 2]).linear_extension()
    [(0, 0), (1, 0), (0, 1), (1, 1)]
    
    sage: posets.SSTPoset([3,2]).bottom()  # long time
    [[1, 1, 1], [2, 2]]
    """

def B():
    """
    sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
    """
```




---

archive/issue_comments_371014.json:
```json
{
    "body": "Apparently it has nothing to do with the doctest framework, i.e., your example can be easily reproduced in an interactive session:\n\n```\nsage: posets.ProductOfChains([2, 2]).linear_extension()\n[(0, 0), (1, 0), (0, 1), (1, 1)]\nsage: posets.SSTPoset([3,2]).bottom()\n[[1, 1, 1], [2, 2]]\nsage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()\n[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]\n```\n\nthen restart Sage, then\n\n```\nsage: posets.ProductOfChains([2, 2]).linear_extension()\n[(0, 0), (1, 0), (0, 1), (1, 1)]\nsage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()\n[[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]\n```\n\nVery likely some kind of caching is causing the inconsistency, but I am not familiar with the code and therefore have no clue where that cache can be found.\n\nWhat I find odd: Even when sorting the output, the two results are different. Is sorting not properly implemented for `sage.sets.cartesian_product.CartesianProduct_with_category.element_class`?",
    "created_at": "2018-11-21T19:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371014",
    "user": "@simon-king-jena"
}
```

Apparently it has nothing to do with the doctest framework, i.e., your example can be easily reproduced in an interactive session:

```
sage: posets.ProductOfChains([2, 2]).linear_extension()
[(0, 0), (1, 0), (0, 1), (1, 1)]
sage: posets.SSTPoset([3,2]).bottom()
[[1, 1, 1], [2, 2]]
sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
```

then restart Sage, then

```
sage: posets.ProductOfChains([2, 2]).linear_extension()
[(0, 0), (1, 0), (0, 1), (1, 1)]
sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
[[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
```

Very likely some kind of caching is causing the inconsistency, but I am not familiar with the code and therefore have no clue where that cache can be found.

What I find odd: Even when sorting the output, the two results are different. Is sorting not properly implemented for `sage.sets.cartesian_product.CartesianProduct_with_category.element_class`?



---

archive/issue_comments_371015.json:
```json
{
    "body": "But shouldn't doctests in each function start with a fresh environment?",
    "created_at": "2018-11-21T20:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371015",
    "user": "@mantepse"
}
```

But shouldn't doctests in each function start with a fresh environment?



---

archive/issue_comments_371016.json:
```json
{
    "body": "Replying to [comment:6 mantepse]:\n> But shouldn't doctests in each function start with a fresh environment?\n> \n\nNo.\n\nI could be mistaken, but when I write doctests, I always assume:\n- The tests of individual functions within a single file are ALL executed in the same environment.\n- The tests of the individual functions within a single file are executed in random order.",
    "created_at": "2018-11-21T20:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371016",
    "user": "@simon-king-jena"
}
```

Replying to [comment:6 mantepse]:
> But shouldn't doctests in each function start with a fresh environment?
> 

No.

I could be mistaken, but when I write doctests, I always assume:
- The tests of individual functions within a single file are ALL executed in the same environment.
- The tests of the individual functions within a single file are executed in random order.



---

archive/issue_comments_371017.json:
```json
{
    "body": "Its in the nature of posets that there is usually no canonical total order, so trying to make the output canonical is probably not going to happen in all cases. \n\nWithout looking at the code I'm guessing that you are somewhere iterating over an associative container, which ends up being random because the elements can't be ordered. \n\nYou probably want to rewrite the test as X == Y instead of looking at the output",
    "created_at": "2018-11-21T20:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371017",
    "user": "@vbraun"
}
```

Its in the nature of posets that there is usually no canonical total order, so trying to make the output canonical is probably not going to happen in all cases. 

Without looking at the code I'm guessing that you are somewhere iterating over an associative container, which ends up being random because the elements can't be ordered. 

You probably want to rewrite the test as X == Y instead of looking at the output



---

archive/issue_comments_371018.json:
```json
{
    "body": "The output is a python list of python lists of elements. So, testing equality won't work. But perhaps one can turn the lists into sets and compare them?",
    "created_at": "2018-11-21T20:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371018",
    "user": "@simon-king-jena"
}
```

The output is a python list of python lists of elements. So, testing equality won't work. But perhaps one can turn the lists into sets and compare them?



---

archive/issue_comments_371019.json:
```json
{
    "body": "We could do\n\n```\nsage: sorted(map(tuple, P.cover_relations()), key=lambda c: map(tuple, c))\n[((0, 0), (0, 1)), ((0, 0), (1, 0)), ((0, 1), (1, 1)), ((1, 0), (1, 1))]\n```\n\nif we do not want to have sorting for cartesian products.",
    "created_at": "2018-11-22T05:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371019",
    "user": "@mantepse"
}
```

We could do

```
sage: sorted(map(tuple, P.cover_relations()), key=lambda c: map(tuple, c))
[((0, 0), (0, 1)), ((0, 0), (1, 0)), ((0, 1), (1, 1)), ((1, 0), (1, 1))]
```

if we do not want to have sorting for cartesian products.



---

archive/issue_comments_371020.json:
```json
{
    "body": "Is it easier to just say `sorted(sorted(x) for x in posets.YoungDiagramPoset(Partition([2,2])).cover_relations())`? I think I have seen that structure in some other parts of Sage.",
    "created_at": "2018-11-22T07:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371020",
    "user": "@jm58660"
}
```

Is it easier to just say `sorted(sorted(x) for x in posets.YoungDiagramPoset(Partition([2,2])).cover_relations())`? I think I have seen that structure in some other parts of Sage.



---

archive/issue_comments_371021.json:
```json
{
    "body": "Wouldn't it be better to have cartesian product export sorting?  (lexicographic)",
    "created_at": "2018-11-22T13:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371021",
    "user": "@mantepse"
}
```

Wouldn't it be better to have cartesian product export sorting?  (lexicographic)



---

archive/issue_comments_371022.json:
```json
{
    "body": "Besides, shouldn't upper and lower covers be tuples, not lists?",
    "created_at": "2018-11-22T13:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371022",
    "user": "@mantepse"
}
```

Besides, shouldn't upper and lower covers be tuples, not lists?



---

archive/issue_comments_371023.json:
```json
{
    "body": "Unless something happens real soon this will not be fixed in Sage 8.5",
    "created_at": "2018-12-13T14:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371023",
    "user": "@vbraun"
}
```

Unless something happens real soon this will not be fixed in Sage 8.5



---

archive/issue_comments_371024.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-13T15:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371024",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_371025.json:
```json
{
    "body": "ok, here it is\n----\nNew commits:",
    "created_at": "2018-12-13T15:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371025",
    "user": "@fchapoton"
}
```

ok, here it is
----
New commits:



---

archive/issue_comments_371026.json:
```json
{
    "body": "Why not use a plain `sorted()`?",
    "created_at": "2018-12-13T16:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371026",
    "user": "@jdemeyer"
}
```

Why not use a plain `sorted()`?



---

archive/issue_comments_371027.json:
```json
{
    "body": "Because this does not work. See comment:1",
    "created_at": "2018-12-13T16:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371027",
    "user": "@fchapoton"
}
```

Because this does not work. See comment:1



---

archive/issue_comments_371028.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-13T17:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371028",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_371029.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-12-13T18:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371029",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_371030.json:
```json
{
    "body": "I understand that you want to get rid of this blocker, but this is not a right fix.",
    "created_at": "2018-12-13T18:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371030",
    "user": "@jdemeyer"
}
```

I understand that you want to get rid of this blocker, but this is not a right fix.



---

archive/issue_comments_371031.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-13T18:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371031",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_371032.json:
```json
{
    "body": "Don't hide bugs, at least mark it as `# known bug`\n----\nNew commits:",
    "created_at": "2018-12-13T18:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371032",
    "user": "@jdemeyer"
}
```

Don't hide bugs, at least mark it as `# known bug`
----
New commits:



---

archive/issue_comments_371033.json:
```json
{
    "body": "Replying to [comment:12 mantepse]:\n> Wouldn't it be better to have cartesian product export sorting?  (lexicographic)\n\nYes obviously. I opened #26890 for that.",
    "created_at": "2018-12-13T18:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371033",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 mantepse]:
> Wouldn't it be better to have cartesian product export sorting?  (lexicographic)

Yes obviously. I opened #26890 for that.



---

archive/issue_comments_371034.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-13T18:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371034",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_371035.json:
```json
{
    "body": "right. ok for me",
    "created_at": "2018-12-13T18:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371035",
    "user": "@fchapoton"
}
```

right. ok for me



---

archive/issue_comments_371036.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-15T19:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26349#issuecomment-371036",
    "user": "@vbraun"
}
```

Resolution: fixed
