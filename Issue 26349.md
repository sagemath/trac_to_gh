# Issue 26349: Failing doctest in poset_examples

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-10-28 22:57:08

With `--gc=never`, this doctest fails consistently:

```
./sage -t --gc=never src/sage/combinat/posets/poset_examples.py
too many failed tests, not using stored timings
Running doctests with ID 2018-10-28-23-55-00-fb2259d6.
Git branch: t/24593/upgrade_from_thebe_to_thebelab_for_live_documentation_support
Using --optional=dochtml,meataxe,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/combinat/posets/poset_examples.py
**********************************************************************
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
Failed example:
    P.cover_relations()
Expected:
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),
    (1, 1)]]
Got:
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
**********************************************************************
1 item had failures:
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
    [159 tests, 1 failure, 11.36 s]
----------------------------------------------------------------------
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by chapoton created at 2018-10-29 09:26:28

It seems that adding sorted() to the doctest does not sort, hence does not fix the issue

```
chapoton`@`pc-chapoton:~/sage$ ./sage -t --gc=never src/sage/combinat/posets/poset_examples.py
too few successful tests, not using stored timings
Running doctests with ID 2018-10-29-10-25-27-f966edb9.
Git branch: poset
Using --optional=4ti2,ccache,dochtml,dot2tex,fricas,gfortran,latte_int,lidia,lrslib,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/combinat/posets/poset_examples.py
**********************************************************************
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
Failed example:
    sorted(P.cover_relations())
Expected:
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),
    (1, 1)]]
Got:
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
**********************************************************************
1 item had failures:
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
    [159 tests, 1 failure, 1.79 s]
----------------------------------------------------------------------
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
```



---

Comment by mantepse created at 2018-11-21 06:29:23

A difference also happens with respect to `--long` on the same file (on linux-ubuntu):

```
martin`@`convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-24-59-6ea730c0.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 3.0 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds
                                                                                                                 
martin`@`convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py 
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-08-142907c8.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t src/sage/combinat/posets/poset_examples.py                                                                                                    
**********************************************************************                                                                                
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                         
Failed example:                                                                                                                                       
    P.cover_relations()                                                                                                                               
Expected:                                                                                                                                             
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0),                                                                                   
    (1, 1)]]                                                                                                                                          
Got:                                                                                                                                                  
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]                                                                          
**********************************************************************                                                                                
1 item had failures:                                                                                                                                  
   1 of   3 in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset                                                                           
    [159 tests, 1 failure, 2.09 s]                                                                                                                    
----------------------------------------------------------------------                                                                                
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed 
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.2 seconds                                                                                                                 
    cpu time: 2.0 seconds                                                                                                                             
    cumulative wall time: 2.1 seconds  
```


Moreover, removing the only `# long` marker from this file (in line 963), the problem is not visible anymore!

```
martin`@`convex63:~/sage-develop$ ./sage -t --long --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-28-653967b1.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t --long src/sage/combinat/posets/poset_examples.py                                                                                             
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.9 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds                                                                                                                 

martin`@`convex63:~/sage-develop$ ./sage -t --optional=sage src/sage/combinat/posets/poset_examples.py                                          
too many failed tests, not using stored timings                                                                                                       
Running doctests with ID 2018-11-21-07-25-36-4df51548.                                                                                                
Git branch: develop                                                                                                                                   
Using --optional=memlimit,sage                                                                                                                        
Doctesting 1 file.                                                                                                                                    
sage -t src/sage/combinat/posets/poset_examples.py                                                                                                    
    [160 tests, 2.88 s]                                                                                                                               
----------------------------------------------------------------------                                                                                
All tests passed!                                                                                                                                     
----------------------------------------------------------------------                                                                                
Total time for all tests: 2.9 seconds                                                                                                                 
    cpu time: 2.8 seconds                                                                                                                             
    cumulative wall time: 2.9 seconds   
```



---

Comment by mantepse created at 2018-11-21 06:43:12

Finally, when running the offending test on its own in a session, there is no mismatch:

```
martin`@`convex63:~/sage-develop$ ./sage                                                                                                                
┌────────────────────────────────────────────────────────────────────┐                                                                                
│ SageMath version 8.5.beta4, Release Date: 2018-11-18               │                                                                                
│ Using Python 2.7.15. Type "help()" for help.                       │                                                                                
└────────────────────────────────────────────────────────────────────┘                                                                                
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                                                                                
┃ Warning: this is a prerelease version, and it may be unstable.     ┃                                                                                
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛                                                                                
sage: P = posets.YoungDiagramPoset(Partition([2,2])); P                                                                                               
Finite meet-semilattice containing 4 elements                                                                                                         
sage: P.cover_relations()                                                                                                                             
[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
```

Adding

```
            sage: import gc                                                                                                                           
            sage: gc.collect() # random                                                                                                               
 
```

just before the test in line 1400 "fixes" it.


---

Comment by mantepse created at 2018-11-21 13:42:55

Here is a minimal example for my computer.  Could you please check whether this yields a failure when run without `--long` and no failure when run with `--long`?


```
def A():
    """
    sage: posets.ProductOfChains([2, 2]).linear_extension()
    [(0, 0), (1, 0), (0, 1), (1, 1)]
    
    sage: posets.SSTPoset([3,2]).bottom()  # long time
    [[1, 1, 1], [2, 2]]
    """

def B():
    """
    sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
    """
```



---

Comment by SimonKing created at 2018-11-21 19:52:08

Apparently it has nothing to do with the doctest framework, i.e., your example can be easily reproduced in an interactive session:

```
sage: posets.ProductOfChains([2, 2]).linear_extension()
[(0, 0), (1, 0), (0, 1), (1, 1)]
sage: posets.SSTPoset([3,2]).bottom()
[[1, 1, 1], [2, 2]]
sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
[[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
```

then restart Sage, then

```
sage: posets.ProductOfChains([2, 2]).linear_extension()
[(0, 0), (1, 0), (0, 1), (1, 1)]
sage: posets.YoungDiagramPoset(Partition([2,2])).cover_relations()
[[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)], [(0, 1), (1, 1)]]
```

Very likely some kind of caching is causing the inconsistency, but I am not familiar with the code and therefore have no clue where that cache can be found.

What I find odd: Even when sorting the output, the two results are different. Is sorting not properly implemented for `sage.sets.cartesian_product.CartesianProduct_with_category.element_class`?


---

Comment by mantepse created at 2018-11-21 20:22:50

But shouldn't doctests in each function start with a fresh environment?


---

Comment by SimonKing created at 2018-11-21 20:28:31

Replying to [comment:6 mantepse]:
> But shouldn't doctests in each function start with a fresh environment?
> 

No.

I could be mistaken, but when I write doctests, I always assume:
- The tests of individual functions within a single file are ALL executed in the same environment.
- The tests of the individual functions within a single file are executed in random order.


---

Comment by vbraun created at 2018-11-21 20:32:33

Its in the nature of posets that there is usually no canonical total order, so trying to make the output canonical is probably not going to happen in all cases. 

Without looking at the code I'm guessing that you are somewhere iterating over an associative container, which ends up being random because the elements can't be ordered. 

You probably want to rewrite the test as X == Y instead of looking at the output


---

Comment by SimonKing created at 2018-11-21 20:36:53

The output is a python list of python lists of elements. So, testing equality won't work. But perhaps one can turn the lists into sets and compare them?


---

Comment by mantepse created at 2018-11-22 05:55:42

We could do

```
sage: sorted(map(tuple, P.cover_relations()), key=lambda c: map(tuple, c))
[((0, 0), (0, 1)), ((0, 0), (1, 0)), ((0, 1), (1, 1)), ((1, 0), (1, 1))]
```

if we do not want to have sorting for cartesian products.


---

Comment by jmantysalo created at 2018-11-22 07:23:08

Is it easier to just say `sorted(sorted(x) for x in posets.YoungDiagramPoset(Partition([2,2])).cover_relations())`? I think I have seen that structure in some other parts of Sage.


---

Comment by mantepse created at 2018-11-22 13:02:37

Wouldn't it be better to have cartesian product export sorting?  (lexicographic)


---

Comment by mantepse created at 2018-11-22 13:03:10

Besides, shouldn't upper and lower covers be tuples, not lists?


---

Comment by vbraun created at 2018-12-13 14:47:30

Unless something happens real soon this will not be fixed in Sage 8.5


---

Comment by chapoton created at 2018-12-13 15:53:38

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-12-13 15:53:38

ok, here it is
----
New commits:


---

Comment by jdemeyer created at 2018-12-13 16:22:17

Why not use a plain `sorted()`?


---

Comment by chapoton created at 2018-12-13 16:23:31

Because this does not work. See comment:1


---

Comment by vbraun created at 2018-12-13 17:22:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-12-13 18:21:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2018-12-13 18:21:35

I understand that you want to get rid of this blocker, but this is not a right fix.


---

Comment by jdemeyer created at 2018-12-13 18:24:21

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-12-13 18:24:21

Don't hide bugs, at least mark it as `# known bug`
----
New commits:


---

Comment by jdemeyer created at 2018-12-13 18:24:44

Replying to [comment:12 mantepse]:
> Wouldn't it be better to have cartesian product export sorting?  (lexicographic)

Yes obviously. I opened #26890 for that.


---

Comment by chapoton created at 2018-12-13 18:51:57

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-12-13 18:51:57

right. ok for me


---

Comment by vbraun created at 2018-12-15 19:25:38

Resolution: fixed
