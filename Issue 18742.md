# Issue 18742: avoid Maxima on creation of symbolic matrices

archive/issues_018742.json:
```json
{
    "body": "People have no idea what they ask for when they write `if ex != 0:` with `ex` possibly(!) a symbolic expression. E.g. this happens to trigger in `matrix/*` the full blown procedure of starting Maxima with its limited deductive armament trying to prove that `ex` is nonzero. This when all was wanted was that it not be a \"numeric\" zero.\n\nThis ticket replaces the two instances in `matrix/` where such behaviour was triggered in doctests. Speedups are expected.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18979\n\n",
    "created_at": "2015-08-01T07:54:57Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "title": "avoid Maxima on creation of symbolic matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18742",
    "user": "rws"
}
```
People have no idea what they ask for when they write `if ex != 0:` with `ex` possibly(!) a symbolic expression. E.g. this happens to trigger in `matrix/*` the full blown procedure of starting Maxima with its limited deductive armament trying to prove that `ex` is nonzero. This when all was wanted was that it not be a "numeric" zero.

This ticket replaces the two instances in `matrix/` where such behaviour was triggered in doctests. Speedups are expected.

Issue created by migration from https://trac.sagemath.org/ticket/18979





---

archive/issue_comments_255907.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-08-01T07:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255907",
    "user": "rws"
}
```

New commits:



---

archive/issue_comments_255908.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-08-01T07:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255908",
    "user": "rws"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_255909.json:
```json
{
    "body": "This is also a commit of #18980 because without #18979 the improved decision logic in Pynac would lead to doctest fails. So if #18980 is merged first this ticket will be duplicate.",
    "created_at": "2015-08-02T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255909",
    "user": "rws"
}
```

This is also a commit of #18980 because without #18979 the improved decision logic in Pynac would lead to doctest fails. So if #18980 is merged first this ticket will be duplicate.



---

archive/issue_comments_255910.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-15T16:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255910",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_255911.json:
```json
{
    "body": "Hi,\n\nI really do not like your solution. You are invading a generic class with some specialized code. Moreover, the issue you found might be present in a lot of other places. You should find a better way to do this test without having to care whether the input is symbolic. If each ring needs a specialized treatment it will become a complete nightmare.\n\nSecondly, the operations `import XYZ` and `isinstance(x, my_type)` are not at all negligeable. Though, in this case it is not very noticeable since the cost is elsewhere. But with your strategy, you are potentially slowing down everthing for a corner case speed up.\n\nIn this very particular case of matrices, there is a simpler way to fix the issue. You can just avoid testing anything. In case `x` is zero a useless filling will be done but of no harm (it is very quick compared to the rest of the initialization). If you like better my solution, write at least a comment that we should not test wheter the input is zero.\n\nVincent",
    "created_at": "2015-08-15T16:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255911",
    "user": "vdelecroix"
}
```

Hi,

I really do not like your solution. You are invading a generic class with some specialized code. Moreover, the issue you found might be present in a lot of other places. You should find a better way to do this test without having to care whether the input is symbolic. If each ring needs a specialized treatment it will become a complete nightmare.

Secondly, the operations `import XYZ` and `isinstance(x, my_type)` are not at all negligeable. Though, in this case it is not very noticeable since the cost is elsewhere. But with your strategy, you are potentially slowing down everthing for a corner case speed up.

In this very particular case of matrices, there is a simpler way to fix the issue. You can just avoid testing anything. In case `x` is zero a useless filling will be done but of no harm (it is very quick compared to the rest of the initialization). If you like better my solution, write at least a comment that we should not test wheter the input is zero.

Vincent



---

archive/issue_comments_255912.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> You should find a better way to do this test without having to care whether the input is symbolic. If each ring needs a specialized treatment it will become a complete nightmare.\nAgreed. The easiest way would be `bool(x1!=x2)` to mean `not (x1-x2).is_trivial_zero()` for symbolic `x` and to provide a different interface for cases requiring simplification/proof. This would have some rerpercussions in symbolic and will take long to review so...\n> In this very particular case of matrices, there is a simpler way to fix the issue. You can just avoid testing anything.\nWill do that.\n\nEDIT: not zero",
    "created_at": "2015-08-16T05:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255912",
    "user": "rws"
}
```

Replying to [comment:5 vdelecroix]:
> You should find a better way to do this test without having to care whether the input is symbolic. If each ring needs a specialized treatment it will become a complete nightmare.
Agreed. The easiest way would be `bool(x1!=x2)` to mean `not (x1-x2).is_trivial_zero()` for symbolic `x` and to provide a different interface for cases requiring simplification/proof. This would have some rerpercussions in symbolic and will take long to review so...
> In this very particular case of matrices, there is a simpler way to fix the issue. You can just avoid testing anything.
Will do that.

EDIT: not zero



---

archive/issue_comments_255913.json:
```json
{
    "body": "Omitting the checks however makes hundreds of doctests fail with eg...\n\n```\nFailed example:\n    matrix(RR, 0, 2, []).columns()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.matrix.matrix1.Matrix.columns[2]>\", line 1, in <module>\n        matrix(RR, Integer(0), Integer(2), []).columns()\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/constructor.py\", line 729, in _matrix_constructor\n        return matrix_space.MatrixSpace(ring, nrows, ncols, sparse=sparse)(entries)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 482, in __call__\n        return self.matrix(entries, coerce, copy)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 1334, in matrix\n        return self.zero_matrix().__copy__()\n      File \"sage/misc/cachefunc.pyx\", line 2215, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13792)\n        self.cache = f(self._instance)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 1185, in zero_matrix\n        res = self.__matrix_class(self, 0, coerce=False, copy=False)\n      File \"sage/matrix/matrix_generic_dense.pyx\", line 118, in sage.matrix.matrix_generic_dense.Matrix_generic_dense.__init__ (build/cythonized/sage/matrix/matrix_generic_dense.c:3057)\n        raise TypeError, \"nonzero scalar matrix must be square\"\n    TypeError: nonzero scalar matrix must be square\n```\n",
    "created_at": "2015-08-16T05:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255913",
    "user": "rws"
}
```

Omitting the checks however makes hundreds of doctests fail with eg...

```
Failed example:
    matrix(RR, 0, 2, []).columns()
Exception raised:
    Traceback (most recent call last):
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix1.Matrix.columns[2]>", line 1, in <module>
        matrix(RR, Integer(0), Integer(2), []).columns()
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/constructor.py", line 729, in _matrix_constructor
        return matrix_space.MatrixSpace(ring, nrows, ncols, sparse=sparse)(entries)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 482, in __call__
        return self.matrix(entries, coerce, copy)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 1334, in matrix
        return self.zero_matrix().__copy__()
      File "sage/misc/cachefunc.pyx", line 2215, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13792)
        self.cache = f(self._instance)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 1185, in zero_matrix
        res = self.__matrix_class(self, 0, coerce=False, copy=False)
      File "sage/matrix/matrix_generic_dense.pyx", line 118, in sage.matrix.matrix_generic_dense.Matrix_generic_dense.__init__ (build/cythonized/sage/matrix/matrix_generic_dense.c:3057)
        raise TypeError, "nonzero scalar matrix must be square"
    TypeError: nonzero scalar matrix must be square
```




---

archive/issue_comments_255914.json:
```json
{
    "body": "For the symbolic solution see #19040. The question is if that makes this ticket a duplicate, or if your idea of simply removing checks can be implemented.",
    "created_at": "2015-08-16T06:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255914",
    "user": "rws"
}
```

For the symbolic solution see #19040. The question is if that makes this ticket a duplicate, or if your idea of simply removing checks can be implemented.



---

archive/issue_comments_255915.json:
```json
{
    "body": "Replying to [comment:8 rws]:\n> For the symbolic solution see #19040. The question is if that makes this ticket a duplicate, or if your idea of simply removing checks can be implemented.\n\nI was wrong. Removing the check would work only for square matrices. You want to allow initialization from zero for any matrix (because the matrix space form a vector space). But for other scalars the matrices need to be square in order to form a ring.",
    "created_at": "2015-08-16T09:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255915",
    "user": "vdelecroix"
}
```

Replying to [comment:8 rws]:
> For the symbolic solution see #19040. The question is if that makes this ticket a duplicate, or if your idea of simply removing checks can be implemented.

I was wrong. Removing the check would work only for square matrices. You want to allow initialization from zero for any matrix (because the matrix space form a vector space). But for other scalars the matrices need to be square in order to form a ring.



---

archive/issue_comments_255916.json:
```json
{
    "body": "> Secondly, the operations `import XYZ` and `isinstance(x, my_type)` are not at all negligeable. Though, in this case it is not very noticeable since the cost is elsewhere. But with your strategy, you are potentially slowing down everthing for a corner case speed up.\nThis is nonsense. Look at how many instance checks you have in `Matrix_generic_dense.__init__`. Lots of special cases. I have no idea why you would try to avoid this one here.",
    "created_at": "2015-09-07T06:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255916",
    "user": "rws"
}
```

> Secondly, the operations `import XYZ` and `isinstance(x, my_type)` are not at all negligeable. Though, in this case it is not very noticeable since the cost is elsewhere. But with your strategy, you are potentially slowing down everthing for a corner case speed up.
This is nonsense. Look at how many instance checks you have in `Matrix_generic_dense.__init__`. Lots of special cases. I have no idea why you would try to avoid this one here.



---

archive/issue_comments_255917.json:
```json
{
    "body": "This patch has the following footprint:\n\n```\n           SR   Laurent poly\ndevelop   2 ms     45 us\npatched  78 us     52 us\n```\n\nI don't believe you would stall this again because of, say, ten microseconds?\n----\nNew commits:",
    "created_at": "2015-09-07T14:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255917",
    "user": "rws"
}
```

This patch has the following footprint:

```
           SR   Laurent poly
develop   2 ms     45 us
patched  78 us     52 us
```

I don't believe you would stall this again because of, say, ten microseconds?
----
New commits:



---

archive/issue_comments_255918.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-07T14:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255918",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_255919.json:
```json
{
    "body": "I think invading a fundamental piece of infrastructure with specific tests for a specific ring should not be taken lightly. I think you can avoid most of your trouble by delaying the is_zero test to the last possible moment:\n\n```\n        elif self._nrows == self._ncols:\n            self._entries = [entries if i==j else zero for i in range(self.nrows) for j in range(self.nrows)]\n        elif entries == zero:\n            self._entries = [zero]*(self._nrows*self._ncols)\n        else:\n            raise TypeError(\"nonzero scalar matrix must be square\")\n```\n\nThe first list comprehension can be optimized further, if required (I suspect that testing whether \"entries\" is zero to more quickly create a square zero matrix is a false optimization: if you need that thing quickly often, you should reuse an immutable zero matrix. That will be much quicker (and constant in size of the matrix!), so I don't think it's necessary).\n\nIf the zero check is expensive, it will almost certainly lead to an error.\n\nWith this code there is no big need to single out SR anymore, and you fix a more fundamental issue: in order to create a matrix (even a diagonal square one) it shouldn't be necessary that your ring has a decidable (or efficient) zero test. For a non-square zero matrix, we can't avoid a zero check, but at least we can delay that until we really need to know (because otherwise we raise an error).",
    "created_at": "2015-09-07T18:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255919",
    "user": "nbruin"
}
```

I think invading a fundamental piece of infrastructure with specific tests for a specific ring should not be taken lightly. I think you can avoid most of your trouble by delaying the is_zero test to the last possible moment:

```
        elif self._nrows == self._ncols:
            self._entries = [entries if i==j else zero for i in range(self.nrows) for j in range(self.nrows)]
        elif entries == zero:
            self._entries = [zero]*(self._nrows*self._ncols)
        else:
            raise TypeError("nonzero scalar matrix must be square")
```

The first list comprehension can be optimized further, if required (I suspect that testing whether "entries" is zero to more quickly create a square zero matrix is a false optimization: if you need that thing quickly often, you should reuse an immutable zero matrix. That will be much quicker (and constant in size of the matrix!), so I don't think it's necessary).

If the zero check is expensive, it will almost certainly lead to an error.

With this code there is no big need to single out SR anymore, and you fix a more fundamental issue: in order to create a matrix (even a diagonal square one) it shouldn't be necessary that your ring has a decidable (or efficient) zero test. For a non-square zero matrix, we can't avoid a zero check, but at least we can delay that until we really need to know (because otherwise we raise an error).



---

archive/issue_comments_255920.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-07T18:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255920",
    "user": "nbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_255921.json:
```json
{
    "body": "OK, I'll put my code where my mouth is. \n\nPrevious branch [u/rws/18979](http://git.sagemath.org/sage.git/diff/?h=u/rws/18979) should still be present if it's preferred to resolve this ticket on the solution proposed there.\n----\nNew commits:",
    "created_at": "2015-09-07T20:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255921",
    "user": "nbruin"
}
```

OK, I'll put my code where my mouth is. 

Previous branch [u/rws/18979](http://git.sagemath.org/sage.git/diff/?h=u/rws/18979) should still be present if it's preferred to resolve this ticket on the solution proposed there.
----
New commits:



---

archive/issue_comments_255922.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-07T20:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255922",
    "user": "nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_255923.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-07T21:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255923",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_255924.json:
```json
{
    "body": "As I said in [comment:5 comment:5], the solution should be non intrusive and your solution is what I suggested at the very end of this comment.\n\nThough, using a list extension is twice slower. With\n\n```\ndef m1():\n    cdef Py_ssize_t i\n    cdef list l = [0] * 100\n    for i in range(10): l[10*i + i] = 12\n    return l\ndef m2():\n    cdef Py_ssize_t i,j\n    return [12 if i == j else 0 for i in range(10) for j in range(10)]\n```\n\nI got\n\n```\nsage: %runfile test.pyx\nsage: %timeit l = m1()\n1000000 loops, best of 3: 456 ns per loop\nsage: %timeit l = m2()\n1000000 loops, best of 3: 1.09 \u00b5s per loop\n```\n",
    "created_at": "2015-09-07T21:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255924",
    "user": "vdelecroix"
}
```

As I said in [comment:5 comment:5], the solution should be non intrusive and your solution is what I suggested at the very end of this comment.

Though, using a list extension is twice slower. With

```
def m1():
    cdef Py_ssize_t i
    cdef list l = [0] * 100
    for i in range(10): l[10*i + i] = 12
    return l
def m2():
    cdef Py_ssize_t i,j
    return [12 if i == j else 0 for i in range(10) for j in range(10)]
```

I got

```
sage: %runfile test.pyx
sage: %timeit l = m1()
1000000 loops, best of 3: 456 ns per loop
sage: %timeit l = m2()
1000000 loops, best of 3: 1.09 µs per loop
```




---

archive/issue_comments_255925.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> As I said in [comment:5 comment:5], the solution should be non intrusive and your solution is what I suggested at the very end of this comment.\n> \n> Though, using a list extension is twice slower. With\n> {{{\n> def m1():\n>     cdef Py_ssize_t i\n>     cdef list l = [0] * 100\n>     for i in range(10): l[10*i + i] = 12\n>     return l\n> def m2():\n>     cdef Py_ssize_t i,j\n>     return [12 if i == j else 0 for i in range(10) for j in range(10)]\n> }}}\n> I got\n> {{{\n> sage: %runfile test.pyx\n> sage: %timeit l = m1()\n> 1000000 loops, best of 3: 456 ns per loop\n> sage: %timeit l = m2()\n> 1000000 loops, best of 3: 1.09 \u00b5s per loop\n> }}}\nOK, go ahead and replace the loop by whatever works better. I hoped cython would be able to optimize this loop, but apparently it cannot. As your example shows, we're likely better off writing the diagonal twice. If this absolutely needs to be fast, we can kick down to a `PyList_New` and `PyList_SET_ITEM` inside a c-style loop. Do we need that? Probably if you need a diagonal matrix *fast* you should some something sparse.\n\nThe only thing that testing for zero got us in the square case is that for a zero matrix, we can avoid reinitializing the diagonal. I think we can do without that optimization, so then at least the problem for SR and other rings without (easily) testable equality are mostly fine except for situations that will most likely be an error anyway.",
    "created_at": "2015-09-07T21:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255925",
    "user": "nbruin"
}
```

Replying to [comment:17 vdelecroix]:
> As I said in [comment:5 comment:5], the solution should be non intrusive and your solution is what I suggested at the very end of this comment.
> 
> Though, using a list extension is twice slower. With
> {{{
> def m1():
>     cdef Py_ssize_t i
>     cdef list l = [0] * 100
>     for i in range(10): l[10*i + i] = 12
>     return l
> def m2():
>     cdef Py_ssize_t i,j
>     return [12 if i == j else 0 for i in range(10) for j in range(10)]
> }}}
> I got
> {{{
> sage: %runfile test.pyx
> sage: %timeit l = m1()
> 1000000 loops, best of 3: 456 ns per loop
> sage: %timeit l = m2()
> 1000000 loops, best of 3: 1.09 µs per loop
> }}}
OK, go ahead and replace the loop by whatever works better. I hoped cython would be able to optimize this loop, but apparently it cannot. As your example shows, we're likely better off writing the diagonal twice. If this absolutely needs to be fast, we can kick down to a `PyList_New` and `PyList_SET_ITEM` inside a c-style loop. Do we need that? Probably if you need a diagonal matrix *fast* you should some something sparse.

The only thing that testing for zero got us in the square case is that for a zero matrix, we can avoid reinitializing the diagonal. I think we can do without that optimization, so then at least the problem for SR and other rings without (easily) testable equality are mostly fine except for situations that will most likely be an error anyway.



---

archive/issue_comments_255926.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-07T21:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255926",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_255927.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-07T21:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255927",
    "user": "nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_255928.json:
```json
{
    "body": "Thanks for the changes. Note that your solution does not change anything to the problem mentioned in the description of this ticket!\n\nVincent",
    "created_at": "2015-09-07T22:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255928",
    "user": "vdelecroix"
}
```

Thanks for the changes. Note that your solution does not change anything to the problem mentioned in the description of this ticket!

Vincent



---

archive/issue_comments_255929.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> Note that your solution does not change anything to the problem mentioned in the description of this ticket!\n\nWell, it solves the problem for the example mentioned: for square matrices and a single ring element as initialization it doesn't compare it to 0 anymore, so for square matrices, maxima is now avoided.\n\nI think comparison in SR is smart enough that an explicit 0 compares equal to 0 without punting to maxima. So maxima should only be hit if we have a non-square matrix and the argument is not obviously 0. In that case it probably isn't zero, and in any case the user deserves what they have coming to them then.\n\nIn general, I think indeed that the generic matrix code shouldn't assume equality- or zero-testing is particularly cheap, and hence avoid it unless it's really necessary. The change here is a step in the right direction and basically has the same effect of what rws was trying to do on his branch.",
    "created_at": "2015-09-07T22:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255929",
    "user": "nbruin"
}
```

Replying to [comment:21 vdelecroix]:
> Note that your solution does not change anything to the problem mentioned in the description of this ticket!

Well, it solves the problem for the example mentioned: for square matrices and a single ring element as initialization it doesn't compare it to 0 anymore, so for square matrices, maxima is now avoided.

I think comparison in SR is smart enough that an explicit 0 compares equal to 0 without punting to maxima. So maxima should only be hit if we have a non-square matrix and the argument is not obviously 0. In that case it probably isn't zero, and in any case the user deserves what they have coming to them then.

In general, I think indeed that the generic matrix code shouldn't assume equality- or zero-testing is particularly cheap, and hence avoid it unless it's really necessary. The change here is a step in the right direction and basically has the same effect of what rws was trying to do on his branch.



---

archive/issue_comments_255930.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-07T23:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255930",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_255931.json:
```json
{
    "body": "Replying to [comment:22 nbruin]:\n> Replying to [comment:21 vdelecroix]:\n> > Note that your solution does not change anything to the problem mentioned in the description of this ticket!\n> \n> Well, it solves the problem for the example mentioned: for square matrices and a single ring element as initialization it doesn't compare it to 0 anymore, so for square matrices, maxima is now avoided.\n\nRight. Sorry, I misunderstood the branching of the code!",
    "created_at": "2015-09-07T23:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255931",
    "user": "vdelecroix"
}
```

Replying to [comment:22 nbruin]:
> Replying to [comment:21 vdelecroix]:
> > Note that your solution does not change anything to the problem mentioned in the description of this ticket!
> 
> Well, it solves the problem for the example mentioned: for square matrices and a single ring element as initialization it doesn't compare it to 0 anymore, so for square matrices, maxima is now avoided.

Right. Sorry, I misunderstood the branching of the code!



---

archive/issue_comments_255932.json:
```json
{
    "body": "Replying to [comment:22 nbruin]:\n> In general, I think indeed that the generic matrix code shouldn't assume equality- or zero-testing is particularly cheap, and hence avoid it unless it's really necessary. The change here is a step in the right direction and basically has the same effect of what rws was trying to do on his branch.\n\nRight, but for sparse matrices it is explicitely assumed that only nonzero entries are stored... what should we do in that case?",
    "created_at": "2015-09-07T23:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255932",
    "user": "vdelecroix"
}
```

Replying to [comment:22 nbruin]:
> In general, I think indeed that the generic matrix code shouldn't assume equality- or zero-testing is particularly cheap, and hence avoid it unless it's really necessary. The change here is a step in the right direction and basically has the same effect of what rws was trying to do on his branch.

Right, but for sparse matrices it is explicitely assumed that only nonzero entries are stored... what should we do in that case?



---

archive/issue_comments_255933.json:
```json
{
    "body": "Replying to [comment:24 vdelecroix]:\n> Right, but for sparse matrices it is explicitely assumed that only nonzero entries are stored... what should we do in that case?\n\nDifferent problem, different ticket. Of course, one should only avoid comparisons if one can.\n\nSince matrices rarely \"accidentally\" remain sparse, you probably get decent performance by just assuming any entry that is actually given, is nonzero (so no explicit checks necessary). Of course that doesn't work when converting a dense matrix to a sparse one.\n\nIf this is an issue, perhaps we should have a special \"comparison avoiding\" sparse matrix class.",
    "created_at": "2015-09-07T23:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255933",
    "user": "nbruin"
}
```

Replying to [comment:24 vdelecroix]:
> Right, but for sparse matrices it is explicitely assumed that only nonzero entries are stored... what should we do in that case?

Different problem, different ticket. Of course, one should only avoid comparisons if one can.

Since matrices rarely "accidentally" remain sparse, you probably get decent performance by just assuming any entry that is actually given, is nonzero (so no explicit checks necessary). Of course that doesn't work when converting a dense matrix to a sparse one.

If this is an issue, perhaps we should have a special "comparison avoiding" sparse matrix class.



---

archive/issue_comments_255934.json:
```json
{
    "body": "In any case #19040 will make this all obsolete.",
    "created_at": "2015-09-08T07:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255934",
    "user": "rws"
}
```

In any case #19040 will make this all obsolete.



---

archive/issue_comments_255935.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-08T14:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18742#issuecomment-255935",
    "user": "vbraun"
}
```

Resolution: fixed
