# Issue 28617: Comparison of Frobenius endomorphism is broken

archive/issues_028380.json:
```json
{
    "assignees": [],
    "body": "Over NTL finite fields, comparisons between Frobenius endomorphisms raise an error:\n\n```\nsage: FF = GF(2^20)\nsage: f = FF.frobenius_endomorphism()\nsage: f == FF.frobenius_endomorphism()\nTraceback (most recent call last):\n...\nTypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented\n```\n\nCC:  @xcaruso @johanrosenkilde @mbombar @williamstein @tscrim @pjbruin\n\nBranch/Commit: **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**\n\nReviewer: **Xavier Caruso, Travis Scrimshaw**\n\nAuthor: **Kwankyu Lee**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28617_\n\n",
    "closed_at": "2021-05-27T20:29:21Z",
    "created_at": "2019-10-16T13:02:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Comparison of Frobenius endomorphism is broken",
    "type": "issue",
    "updated_at": "2021-05-27T20:29:21Z",
    "url": "https://github.com/sagemath/sage/issues/28617",
    "user": "https://github.com/jlavauzelle"
}
```
Over NTL finite fields, comparisons between Frobenius endomorphisms raise an error:

```
sage: FF = GF(2^20)
sage: f = FF.frobenius_endomorphism()
sage: f == FF.frobenius_endomorphism()
Traceback (most recent call last):
...
TypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented
```

CC:  @xcaruso @johanrosenkilde @mbombar @williamstein @tscrim @pjbruin

Branch/Commit: **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**

Reviewer: **Xavier Caruso, Travis Scrimshaw**

Author: **Kwankyu Lee**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/28617_





---

archive/issue_events_394941.json:
```json
{
    "actor": "https://github.com/jlavauzelle",
    "created_at": "2019-10-16T13:02:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394941"
}
```



---

archive/issue_events_394942.json:
```json
{
    "actor": "https://github.com/jlavauzelle",
    "created_at": "2019-10-16T13:02:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394942"
}
```



---

archive/issue_events_394943.json:
```json
{
    "actor": "https://github.com/jlavauzelle",
    "created_at": "2019-10-16T13:02:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394943"
}
```



---

archive/issue_events_394944.json:
```json
{
    "actor": "https://github.com/jlavauzelle",
    "created_at": "2019-10-16T13:02:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394944"
}
```



---

archive/issue_comments_446113.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe problem comes from comparison between Frobenius endomorphisms:\n\n```\nsage: FF = GF(2^20)\nsage: f = FF.frobenius_endomorphism()\nsage: f == FF.frobenius_endomorphism()\nTraceback (most recent call last):\n...\nTypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented\n```",
    "created_at": "2019-10-16T13:58:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446113",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:1" align="right">comment:1</div>

The problem comes from comparison between Frobenius endomorphisms:

```
sage: FF = GF(2^20)
sage: f = FF.frobenius_endomorphism()
sage: f == FF.frobenius_endomorphism()
Traceback (most recent call last):
...
TypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented
```



---

archive/issue_comments_446114.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nHello Xavier,\n\nThanks for your quick answer. So I guess the problem lies in the fact that no specific `FrobeniusEndomorphism` class/method has been implemented for the `ntl_gf2e` finite field case.\n\nI had a look on what has been done for \"givaro\" finite fields, and this seems to be a quite long work... I'm not sure I have time to write everything properly for the moment.\n\nThanks again,\n\nJulien",
    "created_at": "2019-10-17T08:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446114",
    "user": "https://github.com/jlavauzelle"
}
```

<div id="comment:2" align="right">comment:2</div>

Hello Xavier,

Thanks for your quick answer. So I guess the problem lies in the fact that no specific `FrobeniusEndomorphism` class/method has been implemented for the `ntl_gf2e` finite field case.

I had a look on what has been done for "givaro" finite fields, and this seems to be a quite long work... I'm not sure I have time to write everything properly for the moment.

Thanks again,

Julien



---

archive/issue_comments_446115.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nTicket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446115",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

Ticket retargeted after milestone closed



---

archive/issue_events_394945.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394945"
}
```



---

archive/issue_events_394946.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394946"
}
```



---

archive/issue_comments_446116.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nMoving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446116",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_394947.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394947"
}
```



---

archive/issue_events_394948.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394948"
}
```



---

archive/issue_comments_446117.json:
```json
{
    "body": "Branch: **[u/caruso/richcmp_morphism](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/richcmp_morphism)**",
    "created_at": "2020-07-03T19:03:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446117",
    "user": "https://github.com/xcaruso"
}
```

Branch: **[u/caruso/richcmp_morphism](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/richcmp_morphism)**



---

archive/issue_events_394949.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2020-07-03T19:04:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394949"
}
```



---

archive/issue_comments_446118.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe problem comes from the combination of two facts:\n- the method `_lmul_` is not implemented for NTL finite fields, so it inherits from the abstract class `Element` and just returns `None`\n- in the generic implementation of comparison of morphisms, `_lmul_` is called without further precaution\n\nActually, I do not see why calling `_lmul_` is needed, so I removed this call... which fixes the problem.\n\nPS: Maybe, we should also implement `_lmul_` for NTL finite fields; I don't know if it's required.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0\"><code>0c310df</code></a></td><td><code>simplify generic comparison of morphisms</code></td></tr></table>\n",
    "created_at": "2020-07-03T19:04:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446118",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:7" align="right">comment:7</div>

The problem comes from the combination of two facts:
- the method `_lmul_` is not implemented for NTL finite fields, so it inherits from the abstract class `Element` and just returns `None`
- in the generic implementation of comparison of morphisms, `_lmul_` is called without further precaution

Actually, I do not see why calling `_lmul_` is needed, so I removed this call... which fixes the problem.

PS: Maybe, we should also implement `_lmul_` for NTL finite fields; I don't know if it's required.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0"><code>0c310df</code></a></td><td><code>simplify generic comparison of morphisms</code></td></tr></table>




---

archive/issue_comments_446119.json:
```json
{
    "body": "Commit: **[`0c310df`](https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0)**",
    "created_at": "2020-07-03T19:04:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446119",
    "user": "https://github.com/xcaruso"
}
```

Commit: **[`0c310df`](https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0)**



---

archive/issue_comments_446120.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd\"><code>0362e48</code></a></td><td><code>add doctest</code></td></tr></table>\n",
    "created_at": "2020-07-03T19:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446120",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd"><code>0362e48</code></a></td><td><code>add doctest</code></td></tr></table>




---

archive/issue_comments_446121.json:
```json
{
    "body": "Changed commit from **[`0c310df`](https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0)** to **[`0362e48`](https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd)**",
    "created_at": "2020-07-03T19:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446121",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0c310df`](https://github.com/sagemath/sagetrac-mirror/commit/0c310df6513e4845b074ebd0e650c685247cecd0)** to **[`0362e48`](https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd)**



---

archive/issue_comments_446122.json:
```json
{
    "body": "Author: **Xavier Caruso**",
    "created_at": "2020-07-04T12:26:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446122",
    "user": "https://github.com/xcaruso"
}
```

Author: **Xavier Caruso**



---

archive/issue_events_394950.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2020-07-04T12:26:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "title_is": "Comparison of Frobenius endomorphism is broken",
    "title_was": "Instantiating SkewPolynomialRing twice fails",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394950"
}
```



---

archive/issue_comments_446123.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,27 +1,10 @@\n-I would like to report a problem concerning skew polynomial rings.\n-\n-Consider the following function:\n+Over NTL finite fields, comparisons between Frobenius endomorphisms raise an error:\n \n ```\n-def foo(n):\n-    FF = GF(2**n)\n-    f = FF.frobenius_endomorphism()\n-    return SkewPolynomialRing(FF, f, \"X\")\n+sage: FF = GF(2^20)\n+sage: f = FF.frobenius_endomorphism()\n+sage: f == FF.frobenius_endomorphism()\n+Traceback (most recent call last):\n+...\n+TypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented\n ```\n-\n-Then, calling `foo` **twice**, with the same large input (ie., extension degree `n` > 15), raises an error, probably due to some cache problem:\n-\n-```\n-sage: foo(96)\n-Skew Polynomial Ring in X over Finite Field in z96 of size 2^96 twisted by z96 |--> z96^2\n-sage: foo(96)\n-(...)\n-TypeError: None fails to convert into the map's domain Finite Field in z96 of size 2^96, but a `pushforward` method is not properly implemented\n-```\n-\n-Quite surprisingly, the error does not appear when:\n-* the extension degree is less than 15, or\n-* the instantiation of the `SkewPolynomialRing` is not embedded in a function, or\n-* we use classical `PolynomialRing` instead of `SkewPolynomialRing`.\n-\n-Any idea?\n``````\n",
    "created_at": "2020-07-04T12:26:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446123",
    "user": "https://github.com/xcaruso"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,27 +1,10 @@
-I would like to report a problem concerning skew polynomial rings.
-
-Consider the following function:
+Over NTL finite fields, comparisons between Frobenius endomorphisms raise an error:
 
 ```
-def foo(n):
-    FF = GF(2**n)
-    f = FF.frobenius_endomorphism()
-    return SkewPolynomialRing(FF, f, "X")
+sage: FF = GF(2^20)
+sage: f = FF.frobenius_endomorphism()
+sage: f == FF.frobenius_endomorphism()
+Traceback (most recent call last):
+...
+TypeError: None fails to convert into the map's domain Finite Field in z20 of size 2^20, but a `pushforward` method is not properly implemented
 ```
-
-Then, calling `foo` **twice**, with the same large input (ie., extension degree `n` > 15), raises an error, probably due to some cache problem:
-
-```
-sage: foo(96)
-Skew Polynomial Ring in X over Finite Field in z96 of size 2^96 twisted by z96 |--> z96^2
-sage: foo(96)
-(...)
-TypeError: None fails to convert into the map's domain Finite Field in z96 of size 2^96, but a `pushforward` method is not properly implemented
-```
-
-Quite surprisingly, the error does not appear when:
-* the extension degree is less than 15, or
-* the instantiation of the `SkewPolynomialRing` is not embedded in a function, or
-* we use classical `PolynomialRing` instead of `SkewPolynomialRing`.
-
-Any idea?
``````




---

archive/issue_comments_446124.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@xcaruso](#comment:7):\n> The problem comes from the combination of two facts:\n> - the method `_lmul_` is not implemented for NTL finite fields, so it inherits from the abstract class `Element` and just returns `None`\n> - in the generic implementation of comparison of morphisms, `_lmul_` is called without further precaution\n> \n> Actually, I do not see why calling `_lmul_` is needed, so I removed this call... which fixes the problem.\n> \n> PS: Maybe, we should also implement `_lmul_` for NTL finite fields; I don't know if it's required.\n\nI think we need to hear from the initial implementer.",
    "created_at": "2020-07-05T01:24:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446124",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@xcaruso](#comment:7):
> The problem comes from the combination of two facts:
> - the method `_lmul_` is not implemented for NTL finite fields, so it inherits from the abstract class `Element` and just returns `None`
> - in the generic implementation of comparison of morphisms, `_lmul_` is called without further precaution
> 
> Actually, I do not see why calling `_lmul_` is needed, so I removed this call... which fixes the problem.
> 
> PS: Maybe, we should also implement `_lmul_` for NTL finite fields; I don't know if it's required.

I think we need to hear from the initial implementer.



---

archive/issue_comments_446125.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWith the patchbot report, I think I see now why using `_lmul_` is appropriate: it's because this code is supposed to work not only for ring homomorphisms but also for module homomorphisms.\n\nSo, I've switched back to the original version but added one test in order to avoid the call to `_lmul_` when a coercion map is defined. I believe it would make things faster.",
    "created_at": "2020-07-05T10:05:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446125",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:11" align="right">comment:11</div>

With the patchbot report, I think I see now why using `_lmul_` is appropriate: it's because this code is supposed to work not only for ring homomorphisms but also for module homomorphisms.

So, I've switched back to the original version but added one test in order to avoid the call to `_lmul_` when a coercion map is defined. I believe it would make things faster.



---

archive/issue_comments_446126.json:
```json
{
    "body": "Changed commit from **[`0362e48`](https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd)** to **[`9b4d57e`](https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15)**",
    "created_at": "2020-07-05T10:06:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446126",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0362e48`](https://github.com/sagemath/sagetrac-mirror/commit/0362e48e5e99267be0715fdabf440235fe8be4dd)** to **[`9b4d57e`](https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15)**



---

archive/issue_comments_446127.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15\"><code>9b4d57e</code></a></td><td><code>use coercion maps when available</code></td></tr></table>\n",
    "created_at": "2020-07-05T10:06:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446127",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15"><code>9b4d57e</code></a></td><td><code>use coercion maps when available</code></td></tr></table>




---

archive/issue_comments_446128.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@xcaruso](#comment:11):\n> With the patchbot report, I think I see now why using `_lmul_` is appropriate: it's because this code is supposed to work not only for ring homomorphisms but also for module homomorphisms.\n\nI guessed so, but I still do not see it clearly. Would you give an example where `_lmul_` and `_base` things are in work?",
    "created_at": "2020-07-06T10:09:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446128",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@xcaruso](#comment:11):
> With the patchbot report, I think I see now why using `_lmul_` is appropriate: it's because this code is supposed to work not only for ring homomorphisms but also for module homomorphisms.

I guessed so, but I still do not see it clearly. Would you give an example where `_lmul_` and `_base` things are in work?



---

archive/issue_comments_446129.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nLet us first look at the case of ring homomorphisms. Consider the following:\n\n```\nsage: k.<a> = GF(9)\nsage: Frob = k.frobenius_endomorphism()\nsage: R.<x> = k[] \nsage: phi = R.hom([x^2])\nsage: psi = R.hom([x^2], base_map=Frob)\n```\n\nThen `phi` is definitely different from `psi` because they act differently of `k`:\n\n```\nsage: phi(a)\na\nsage: psi(a)\n2*a + 1\n```\n\nHowever, `R.gens()` consists only of `x` and `phi(x) = psi(x) = x^3`. Therefore, in order to guarantee that two morphisms coincide, we need to check that they take the same values on the generators of the domain, but also recursively on the generators of the base of the domain, the generators of the base of the base of the domain, etc.\n\nNow, the same occurs with modules. If `A` and `B` and two `K`-modules, it's certainly possible to imagine a mapping `A -> B` which is not `K`-linear (for instance, it could be semi-linear)... though I'm not sure it would be easy/possible to define in Sage. Hence, in order to check that two such mappings coincide, we need to check that they agree on the generators but also on the product of generators by (iterated) generators of the ring of scalars. Actually, it is not exactly what the current code does (both before and after my patch): the current code only checks products with the *last* generator of the module. It looks like a bug but I'm not sure about this (because I don't know precisely what `ModuleMorphism` means in Sage).",
    "created_at": "2020-07-06T12:47:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446129",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:14" align="right">comment:14</div>

Let us first look at the case of ring homomorphisms. Consider the following:

```
sage: k.<a> = GF(9)
sage: Frob = k.frobenius_endomorphism()
sage: R.<x> = k[] 
sage: phi = R.hom([x^2])
sage: psi = R.hom([x^2], base_map=Frob)
```

Then `phi` is definitely different from `psi` because they act differently of `k`:

```
sage: phi(a)
a
sage: psi(a)
2*a + 1
```

However, `R.gens()` consists only of `x` and `phi(x) = psi(x) = x^3`. Therefore, in order to guarantee that two morphisms coincide, we need to check that they take the same values on the generators of the domain, but also recursively on the generators of the base of the domain, the generators of the base of the base of the domain, etc.

Now, the same occurs with modules. If `A` and `B` and two `K`-modules, it's certainly possible to imagine a mapping `A -> B` which is not `K`-linear (for instance, it could be semi-linear)... though I'm not sure it would be easy/possible to define in Sage. Hence, in order to check that two such mappings coincide, we need to check that they agree on the generators but also on the product of generators by (iterated) generators of the ring of scalars. Actually, it is not exactly what the current code does (both before and after my patch): the current code only checks products with the *last* generator of the module. It looks like a bug but I'm not sure about this (because I don't know precisely what `ModuleMorphism` means in Sage).



---

archive/issue_comments_446130.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@xcaruso](#comment:14):\n> Let us first look at the case of ring homomorphisms. Consider the following:\n> \n> ```\n> sage: k.<a> = GF(9)\n> sage: Frob = k.frobenius_endomorphism()\n> sage: R.<x> = k[] \n> sage: phi = R.hom([x^2])\n> sage: psi = R.hom([x^2], base_map=Frob)\n> ```\n> \n> Then `phi` is definitely different from `psi` because they act differently of `k`:\n> \n> ```\n> sage: phi(a)\n> a\n> sage: psi(a)\n> 2*a + 1\n> ```\n> \n> However, `R.gens()` consists only of `x` and `phi(x) = psi(x) = x^3`. Therefore, in order to guarantee that two morphisms coincide, we need to check that they take the same values on the generators of the domain, but also recursively on the generators of the base of the domain, the generators of the base of the base of the domain, etc.\n\nRight.. But this is not a relevant example to the current issue. `_lmul_` and `_base` are not involved here.\n\nPutting the math behind `_richcmp_` aside, the direct cause of the failure is that `g._lmul_(h)` does not work (returns `None`) for g in the finite field k and h in the prime base field of k. \n\n```diff\ndiff --git a/src/sage/categories/morphism.pyx b/src/sage/categories/morphism.pyx\nindex dec8b00b74..b41f5e7e2a 100644\n--- a/src/sage/categories/morphism.pyx\n+++ b/src/sage/categories/morphism.pyx\n@@ -362,7 +362,7 @@ cdef class Morphism(Map):\n             # gens by picking an element of the initial domain (e) and\n             # multiplying it with the gens of the scalar ring.\n             if e is not None and isinstance(e, ModuleElement):\n-                gens = [(<ModuleElement>e)._lmul_(x) for x in gens]\n+                gens = [e._lmul_(x) for x in gens]\n             for e in gens:\n                 x = self(e)\n                 y = other(e)\ndiff --git a/src/sage/rings/finite_rings/element_base.pyx b/src/sage/rings/finite_rings/element_base.pyx\nindex 97d4260a18..e81155b316 100755\n--- a/src/sage/rings/finite_rings/element_base.pyx\n+++ b/src/sage/rings/finite_rings/element_base.pyx\n@@ -30,6 +30,10 @@ def is_FiniteFieldElement(x):\n \n \n cdef class FiniteRingElement(CommutativeRingElement):\n+    def _lmul_(self, other):\n+        return self * other\n+\n```\n\nThis fixes the problem.",
    "created_at": "2020-07-07T03:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446130",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@xcaruso](#comment:14):
> Let us first look at the case of ring homomorphisms. Consider the following:
> 
> ```
> sage: k.<a> = GF(9)
> sage: Frob = k.frobenius_endomorphism()
> sage: R.<x> = k[] 
> sage: phi = R.hom([x^2])
> sage: psi = R.hom([x^2], base_map=Frob)
> ```
> 
> Then `phi` is definitely different from `psi` because they act differently of `k`:
> 
> ```
> sage: phi(a)
> a
> sage: psi(a)
> 2*a + 1
> ```
> 
> However, `R.gens()` consists only of `x` and `phi(x) = psi(x) = x^3`. Therefore, in order to guarantee that two morphisms coincide, we need to check that they take the same values on the generators of the domain, but also recursively on the generators of the base of the domain, the generators of the base of the base of the domain, etc.

Right.. But this is not a relevant example to the current issue. `_lmul_` and `_base` are not involved here.

Putting the math behind `_richcmp_` aside, the direct cause of the failure is that `g._lmul_(h)` does not work (returns `None`) for g in the finite field k and h in the prime base field of k. 

```diff
diff --git a/src/sage/categories/morphism.pyx b/src/sage/categories/morphism.pyx
index dec8b00b74..b41f5e7e2a 100644
--- a/src/sage/categories/morphism.pyx
+++ b/src/sage/categories/morphism.pyx
@@ -362,7 +362,7 @@ cdef class Morphism(Map):
             # gens by picking an element of the initial domain (e) and
             # multiplying it with the gens of the scalar ring.
             if e is not None and isinstance(e, ModuleElement):
-                gens = [(<ModuleElement>e)._lmul_(x) for x in gens]
+                gens = [e._lmul_(x) for x in gens]
             for e in gens:
                 x = self(e)
                 y = other(e)
diff --git a/src/sage/rings/finite_rings/element_base.pyx b/src/sage/rings/finite_rings/element_base.pyx
index 97d4260a18..e81155b316 100755
--- a/src/sage/rings/finite_rings/element_base.pyx
+++ b/src/sage/rings/finite_rings/element_base.pyx
@@ -30,6 +30,10 @@ def is_FiniteFieldElement(x):
 
 
 cdef class FiniteRingElement(CommutativeRingElement):
+    def _lmul_(self, other):
+        return self * other
+
```

This fixes the problem.



---

archive/issue_comments_446131.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nHi,\nI'm quite new to Sage, but why exactly `e` would be different from `<ModuleElement>e` when `e` is the generator of the finite field ?\n\nIf we get into that, \n\n```\n    if e is not None and isinstance(e, ModuleElement):\n       gens = [(<ModuleElement>e)._lmul_(x) for x in gens]\n```\n\n`e` should be an instance of `ModuleElement`, isn't it ? Therefore, I don't get why there is this coercion in the first place, which is removed in [klee](#comment:15)'s proposal.\n\nObviously, they are different : If we keep this coercion, we still have the failure, even when `_lmul_` is defined for `FiniteRingElement`. However, `e == <ModuleElement>e` evaluates to `True`. Can someone explain to me the difference please ?\n\n\nMy question here brings another one: By removing the coercion, aren't we breaking anything else ?\n\n\n\nAnyway, this issue led me to trac ticket #24281. The example mentioned in the description is interesting, because `f` and `g` are both defined on `None` and evaluate to `0`, hence the result. Otherwise I guess there would have been the same exception. Is this a side effect of anything else ? Or is it normal to define a morphism on `None` ? And if so, wouldn't it solve the problem to define the Frobenius map on `None` either ? In fact, the Frobenius map is well defined on `None` for other fields :\n\n\n```\nsage: k = GF(9)\nsage: frob = k.frobenius_endomorphism()\nsage: frob(None)\n0\nsage: frob == k.frobenius_endomorphism()\nTrue\nsage: k = GF(2^15)  # Givaro                                                                          \nsage: frob = k.frobenius_endomorphism()\nsage: frob(None)\n0\nsage: frob == k.frobenius_endomorphism()\nTrue\nsage: k = GF(2^16)\nsage: frob = k.frobenius_endomorphism()                                                                        \nsage: frob(None) \n...\nTypeError: None fails to convert into the map's domain Finite Field in z16 of size 2^16, but a `pushforward` method is not properly implemented\n```",
    "created_at": "2020-08-29T20:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446131",
    "user": "https://github.com/mbombar"
}
```

<div id="comment:16" align="right">comment:16</div>

Hi,
I'm quite new to Sage, but why exactly `e` would be different from `<ModuleElement>e` when `e` is the generator of the finite field ?

If we get into that, 

```
    if e is not None and isinstance(e, ModuleElement):
       gens = [(<ModuleElement>e)._lmul_(x) for x in gens]
```

`e` should be an instance of `ModuleElement`, isn't it ? Therefore, I don't get why there is this coercion in the first place, which is removed in [klee](#comment:15)'s proposal.

Obviously, they are different : If we keep this coercion, we still have the failure, even when `_lmul_` is defined for `FiniteRingElement`. However, `e == <ModuleElement>e` evaluates to `True`. Can someone explain to me the difference please ?


My question here brings another one: By removing the coercion, aren't we breaking anything else ?



Anyway, this issue led me to trac ticket #24281. The example mentioned in the description is interesting, because `f` and `g` are both defined on `None` and evaluate to `0`, hence the result. Otherwise I guess there would have been the same exception. Is this a side effect of anything else ? Or is it normal to define a morphism on `None` ? And if so, wouldn't it solve the problem to define the Frobenius map on `None` either ? In fact, the Frobenius map is well defined on `None` for other fields :


```
sage: k = GF(9)
sage: frob = k.frobenius_endomorphism()
sage: frob(None)
0
sage: frob == k.frobenius_endomorphism()
True
sage: k = GF(2^15)  # Givaro                                                                          
sage: frob = k.frobenius_endomorphism()
sage: frob(None)
0
sage: frob == k.frobenius_endomorphism()
True
sage: k = GF(2^16)
sage: frob = k.frobenius_endomorphism()                                                                        
sage: frob(None) 
...
TypeError: None fails to convert into the map's domain Finite Field in z16 of size 2^16, but a `pushforward` method is not properly implemented
```



---

archive/issue_comments_446132.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mbombar](#comment:16):\n> Hi,\n> I'm quite new to Sage, but why exactly `e` would be different from `<ModuleElement>e` when `e` is the generator of the finite field ?\n> \n> If we get into that, \n> \n> ```\n>     if e is not None and isinstance(e, ModuleElement):\n>        gens = [(<ModuleElement>e)._lmul_(x) for x in gens]\n> ```\n> \n> `e` should be an instance of `ModuleElement`, isn't it ? Therefore, I don't get why there is this coercion in the first place, which is removed in [klee](#comment:15)'s proposal.\n\nI had the same question. My guess is what follows. With the coercion, `_lmul_` defined on `ModuleElement` class is invoked, and somehow leads to the failure. Without the coercion, `_lmul_` defined on `FiniteRingElement` is invoked, and I provided an implementation of that method.\n\n> \n> However, `e == <ModuleElement>e` evaluates to `True`. \n\nEquality test is on a different level, and complicated. This being `True` is not relevant with the behavior of the above code in issue. \n\n> My question here brings another one: By removing the coercion, aren't we breaking anything else ?\n\nI guess not. I hope not.\n\n> Anyway, this issue led me to trac ticket #24281. The example mentioned in the description is interesting, because `f` and `g` are both defined on `None` and evaluate to `0`, hence the result. Otherwise I guess there would have been the same exception. Is this a side effect of anything else ? Or is it normal to define a morphism on `None` ? And if so, wouldn't it solve the problem to define the Frobenius map on `None` either ? In fact, the Frobenius map is well defined on `None` for other fields :\n> \n> \n> ```\n> sage: k = GF(9)\n> sage: frob = k.frobenius_endomorphism()\n> sage: frob(None)\n> 0\n> sage: frob == k.frobenius_endomorphism()\n> True\n> sage: k = GF(2^15)  # Givaro                                                                          \n> sage: frob = k.frobenius_endomorphism()\n> sage: frob(None)\n> 0\n> sage: frob == k.frobenius_endomorphism()\n> True\n> sage: k = GF(2^16)\n> sage: frob = k.frobenius_endomorphism()                                                                        \n> sage: frob(None) \n> ...\n> TypeError: None fails to convert into the map's domain Finite Field in z16 of size 2^16, but a `pushforward` method is not properly implemented\n> ```\n\nFrobenius maps are not defined on `None`, mathematically. The above are just consequences of Sage coercion (different concept from the Cython coercion above) of `None` to `0` element.",
    "created_at": "2020-08-30T02:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446132",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mbombar](#comment:16):
> Hi,
> I'm quite new to Sage, but why exactly `e` would be different from `<ModuleElement>e` when `e` is the generator of the finite field ?
> 
> If we get into that, 
> 
> ```
>     if e is not None and isinstance(e, ModuleElement):
>        gens = [(<ModuleElement>e)._lmul_(x) for x in gens]
> ```
> 
> `e` should be an instance of `ModuleElement`, isn't it ? Therefore, I don't get why there is this coercion in the first place, which is removed in [klee](#comment:15)'s proposal.

I had the same question. My guess is what follows. With the coercion, `_lmul_` defined on `ModuleElement` class is invoked, and somehow leads to the failure. Without the coercion, `_lmul_` defined on `FiniteRingElement` is invoked, and I provided an implementation of that method.

> 
> However, `e == <ModuleElement>e` evaluates to `True`. 

Equality test is on a different level, and complicated. This being `True` is not relevant with the behavior of the above code in issue. 

> My question here brings another one: By removing the coercion, aren't we breaking anything else ?

I guess not. I hope not.

> Anyway, this issue led me to trac ticket #24281. The example mentioned in the description is interesting, because `f` and `g` are both defined on `None` and evaluate to `0`, hence the result. Otherwise I guess there would have been the same exception. Is this a side effect of anything else ? Or is it normal to define a morphism on `None` ? And if so, wouldn't it solve the problem to define the Frobenius map on `None` either ? In fact, the Frobenius map is well defined on `None` for other fields :
> 
> 
> ```
> sage: k = GF(9)
> sage: frob = k.frobenius_endomorphism()
> sage: frob(None)
> 0
> sage: frob == k.frobenius_endomorphism()
> True
> sage: k = GF(2^15)  # Givaro                                                                          
> sage: frob = k.frobenius_endomorphism()
> sage: frob(None)
> 0
> sage: frob == k.frobenius_endomorphism()
> True
> sage: k = GF(2^16)
> sage: frob = k.frobenius_endomorphism()                                                                        
> sage: frob(None) 
> ...
> TypeError: None fails to convert into the map's domain Finite Field in z16 of size 2^16, but a `pushforward` method is not properly implemented
> ```

Frobenius maps are not defined on `None`, mathematically. The above are just consequences of Sage coercion (different concept from the Cython coercion above) of `None` to `0` element.



---

archive/issue_comments_446133.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI am willing to upload a patch implementing the simple fix in [comment:15](#comment:15), if no one objects.",
    "created_at": "2020-09-08T05:13:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446133",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:18" align="right">comment:18</div>

I am willing to upload a patch implementing the simple fix in [comment:15](#comment:15), if no one objects.



---

archive/issue_comments_446134.json:
```json
{
    "body": "Changed commit from **[`9b4d57e`](https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15)** to none",
    "created_at": "2020-09-09T06:18:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446134",
    "user": "https://github.com/kwankyu"
}
```

Changed commit from **[`9b4d57e`](https://github.com/sagemath/sagetrac-mirror/commit/9b4d57ea0733469796b67c4ca3af158f521e4f15)** to none



---

archive/issue_comments_446135.json:
```json
{
    "body": "Changed branch from **[u/caruso/richcmp_morphism](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/richcmp_morphism)** to **[u/klee/28617](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/28617)**",
    "created_at": "2020-09-09T06:18:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446135",
    "user": "https://github.com/kwankyu"
}
```

Changed branch from **[u/caruso/richcmp_morphism](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/richcmp_morphism)** to **[u/klee/28617](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/28617)**



---

archive/issue_comments_446136.json:
```json
{
    "body": "Commit: **[`ac32ca9`](https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24)**",
    "created_at": "2020-09-09T06:20:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446136",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`ac32ca9`](https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24)**



---

archive/issue_comments_446137.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24\"><code>ac32ca9</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>\n",
    "created_at": "2020-09-09T06:20:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446137",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24"><code>ac32ca9</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>




---

archive/issue_comments_446138.json:
```json
{
    "body": "Changed author from **Xavier Caruso** to **Xavier Caruso, Kwankyu Lee**",
    "created_at": "2020-09-09T06:21:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446138",
    "user": "https://github.com/kwankyu"
}
```

Changed author from **Xavier Caruso** to **Xavier Caruso, Kwankyu Lee**



---

archive/issue_events_394951.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394951"
}
```



---

archive/issue_events_394952.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394952"
}
```



---

archive/issue_comments_446139.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1\"><code>8300a98</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>\n",
    "created_at": "2020-12-16T08:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446139",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1"><code>8300a98</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>




---

archive/issue_comments_446140.json:
```json
{
    "body": "Changed commit from **[`ac32ca9`](https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24)** to **[`8300a98`](https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1)**",
    "created_at": "2020-12-16T08:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446140",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ac32ca9`](https://github.com/sagemath/sagetrac-mirror/commit/ac32ca9b8e2b0efed040f9abeddd30b1b5f2fc24)** to **[`8300a98`](https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1)**



---

archive/issue_events_394953.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394953"
}
```



---

archive/issue_events_394954.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394954"
}
```



---

archive/issue_comments_446141.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nSage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446141",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_394955.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2021-04-28T05:33:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394955"
}
```



---

archive/issue_events_394956.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2021-04-28T05:33:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394956"
}
```



---

archive/issue_comments_446142.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThis branch no longer merges, and there's quite a bit of discussion after Xavier marked it as needs review.",
    "created_at": "2021-04-28T05:33:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446142",
    "user": "https://github.com/roed314"
}
```

<div id="comment:25" align="right">comment:25</div>

This branch no longer merges, and there's quite a bit of discussion after Xavier marked it as needs review.



---

archive/issue_comments_446143.json:
```json
{
    "body": "Changed commit from **[`8300a98`](https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1)** to **[`ad1a0b0`](https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678)**",
    "created_at": "2021-04-28T07:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446143",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8300a98`](https://github.com/sagemath/sagetrac-mirror/commit/8300a98e92053a7202ad0d7125022209edc157c1)** to **[`ad1a0b0`](https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678)**



---

archive/issue_comments_446144.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678\"><code>ad1a0b0</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>\n",
    "created_at": "2021-04-28T07:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446144",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678"><code>ad1a0b0</code></a></td><td><code>Provide `_lmul_` for finite ring elements</code></td></tr></table>




---

archive/issue_events_394957.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-04-28T08:02:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394957"
}
```



---

archive/issue_events_394958.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-04-28T08:02:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394958"
}
```



---

archive/issue_comments_446145.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThe patch fixes the problem. But I do not understand the logic of the code in `_richcmp_` well. In particular, the business of the base gens stuff... Hence someone who does should look at it.",
    "created_at": "2021-04-28T09:38:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446145",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:28" align="right">comment:28</div>

The patch fixes the problem. But I do not understand the logic of the code in `_richcmp_` well. In particular, the business of the base gens stuff... Hence someone who does should look at it.



---

archive/issue_comments_446146.json:
```json
{
    "body": "Reviewer: **Xavier Caruso**",
    "created_at": "2021-04-28T13:59:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446146",
    "user": "https://github.com/xcaruso"
}
```

Reviewer: **Xavier Caruso**



---

archive/issue_comments_446147.json:
```json
{
    "body": "Changed author from **Xavier Caruso, Kwankyu Lee** to **Kwankyu Lee**",
    "created_at": "2021-04-28T13:59:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446147",
    "user": "https://github.com/xcaruso"
}
```

Changed author from **Xavier Caruso, Kwankyu Lee** to **Kwankyu Lee**



---

archive/issue_events_394959.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2021-04-28T13:59:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394959"
}
```



---

archive/issue_events_394960.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2021-04-28T13:59:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394960"
}
```



---

archive/issue_comments_446148.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI don't know if it's correct but I tried to explain what I've understood on [comment:14](#comment:14).\n\nOK for fixing the issue as you propose for this ticket (so I'm giving a positive review). However, I think that thinking again at the best way to check equalities between general morphims would be a good idea for another ticket.",
    "created_at": "2021-04-28T13:59:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446148",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:29" align="right">comment:29</div>

I don't know if it's correct but I tried to explain what I've understood on [comment:14](#comment:14).

OK for fixing the issue as you propose for this ticket (so I'm giving a positive review). However, I think that thinking again at the best way to check equalities between general morphims would be a good idea for another ticket.



---

archive/issue_comments_446149.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@xcaruso](#comment:29):\n> OK for fixing the issue as you propose for this ticket (so I'm giving a positive review). \n\nThank you.\n\n>However, I think that thinking again at the best way to check equalities between general morphims would be a good idea for another ticket.\n\nand the code needs more documentation and examples.",
    "created_at": "2021-04-29T00:34:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446149",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@xcaruso](#comment:29):
> OK for fixing the issue as you propose for this ticket (so I'm giving a positive review). 

Thank you.

>However, I think that thinking again at the best way to check equalities between general morphims would be a good idea for another ticket.

and the code needs more documentation and examples.



---

archive/issue_comments_446150.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nFor [comment:28](#comment:28): Yes, what is in [comment:15](#comment:15) is correct. Here is another way of explaining it. The base check just means it goes down recursively, which is necessary to check that we get the same map. For example, consider two cyclic R-modules M = <x>, N = <y> and morphisms f<sub>1</sub>, f<sub>2</sub>: M -> N such that f<sub>1</sub>(r*x) = r*y and f<sub>2</sub>(r*x) = g(r)*y, where g: R -> R is some non-trivial automorphism. On basis vectors (i.e., the generators), both f<sub>1</sub> and f<sub>2</sub> map x -> y. However, they are not the same morphism when you map the generators of R.\n\nI am not completely sure about this fix. It seems like it could lead to an infinite loop because `*` could call the `_lmul_`, which then calls `*`. It feels like there should be a bit better of a solution, but I don't know offhand what that is.",
    "created_at": "2021-04-29T11:25:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446150",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:31" align="right">comment:31</div>

For [comment:28](#comment:28): Yes, what is in [comment:15](#comment:15) is correct. Here is another way of explaining it. The base check just means it goes down recursively, which is necessary to check that we get the same map. For example, consider two cyclic R-modules M = <x>, N = <y> and morphisms f<sub>1</sub>, f<sub>2</sub>: M -> N such that f<sub>1</sub>(r*x) = r*y and f<sub>2</sub>(r*x) = g(r)*y, where g: R -> R is some non-trivial automorphism. On basis vectors (i.e., the generators), both f<sub>1</sub> and f<sub>2</sub> map x -> y. However, they are not the same morphism when you map the generators of R.

I am not completely sure about this fix. It seems like it could lead to an infinite loop because `*` could call the `_lmul_`, which then calls `*`. It feels like there should be a bit better of a solution, but I don't know offhand what that is.



---

archive/issue_comments_446151.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@tscrim](#comment:31):\n\nIs this part also correct?\n\n... the current code only checks products with the *last* generator of the module. It \n    looks like a bug ...\n\nIs it a bug?",
    "created_at": "2021-04-29T12:40:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446151",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@tscrim](#comment:31):

Is this part also correct?

... the current code only checks products with the *last* generator of the module. It 
    looks like a bug ...

Is it a bug?



---

archive/issue_comments_446152.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI don't think so. It is enough to recurse down on the last generator because everything before and including that must have compared equal. All you are doing is comparing stuff in the base ring at that point.",
    "created_at": "2021-04-29T13:58:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446152",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:33" align="right">comment:33</div>

I don't think so. It is enough to recurse down on the last generator because everything before and including that must have compared equal. All you are doing is comparing stuff in the base ring at that point.



---

archive/issue_comments_446153.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb\"><code>62785e0</code></a></td><td><code>Make cpdef _lmul_</code></td></tr></table>\n",
    "created_at": "2021-04-30T03:52:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446153",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb"><code>62785e0</code></a></td><td><code>Make cpdef _lmul_</code></td></tr></table>




---

archive/issue_comments_446154.json:
```json
{
    "body": "Changed commit from **[`ad1a0b0`](https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678)** to **[`62785e0`](https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb)**",
    "created_at": "2021-04-30T03:52:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446154",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ad1a0b0`](https://github.com/sagemath/sagetrac-mirror/commit/ad1a0b0d4adf2f92d006a2f953461845cfecb678)** to **[`62785e0`](https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb)**



---

archive/issue_events_394961.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-04-30T03:52:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394961"
}
```



---

archive/issue_events_394962.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-04-30T03:52:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394962"
}
```



---

archive/issue_comments_446155.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@tscrim](#comment:33):\n> I don't think so. It is enough to recurse down on the last generator because everything before and including that must have compared equal. All you are doing is comparing stuff in the base ring at that point.\n\nOkay. I now understand the code better. The last generator is just picked up to compare the images of scalar multiplications with the base ring generators. Thanks.",
    "created_at": "2021-04-30T03:55:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446155",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@tscrim](#comment:33):
> I don't think so. It is enough to recurse down on the last generator because everything before and including that must have compared equal. All you are doing is comparing stuff in the base ring at that point.

Okay. I now understand the code better. The last generator is just picked up to compare the images of scalar multiplications with the base ring generators. Thanks.



---

archive/issue_comments_446156.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@tscrim](#comment:31):\n\n> I am not completely sure about this fix. It seems like it could lead to an infinite loop because `*` could call the `_lmul_`, which then calls `*`. It feels like there should be a bit better of a solution, but I don't know offhand what that is.\n\nIn the last commit, I made `_lmul_` `cpdef`ed and use `_mul_` instead of `*`. This is simpler and seems safer.",
    "created_at": "2021-04-30T03:58:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446156",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@tscrim](#comment:31):

> I am not completely sure about this fix. It seems like it could lead to an infinite loop because `*` could call the `_lmul_`, which then calls `*`. It feels like there should be a bit better of a solution, but I don't know offhand what that is.

In the last commit, I made `_lmul_` `cpdef`ed and use `_mul_` instead of `*`. This is simpler and seems safer.



---

archive/issue_comments_446157.json:
```json
{
    "body": "Changed commit from **[`62785e0`](https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb)** to **[`0d2dd5d`](https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd)**",
    "created_at": "2021-04-30T04:01:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446157",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`62785e0`](https://github.com/sagemath/sagetrac-mirror/commit/62785e0709d0d8c6ad873f3fc083b928a2228dbb)** to **[`0d2dd5d`](https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd)**



---

archive/issue_comments_446158.json:
```json
{
    "body": "<div id=\"comment:37\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd\"><code>0d2dd5d</code></a></td><td><code>Fix a typo</code></td></tr></table>\n",
    "created_at": "2021-04-30T04:01:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446158",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:37"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd"><code>0d2dd5d</code></a></td><td><code>Fix a typo</code></td></tr></table>




---

archive/issue_comments_446159.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI think you should wrap the `_mul_` with a `try-except` block and return `None` if an error is raised from trying to do the coercion. Now it will likely fail later on in the same way, but by returning `None`, the remaining coercion framework for `*` gets invoked. This then tries to find a larger common parent (which might succeed) rather than just simply trying to force it into the same parent as `self`. This also allows us to say that there is no (left) action of `other` on `self`. I doubt I could think of a doctest for this specific case (although perhaps over two suitably chosen base rings) though...",
    "created_at": "2021-04-30T06:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446159",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:38" align="right">comment:38</div>

I think you should wrap the `_mul_` with a `try-except` block and return `None` if an error is raised from trying to do the coercion. Now it will likely fail later on in the same way, but by returning `None`, the remaining coercion framework for `*` gets invoked. This then tries to find a larger common parent (which might succeed) rather than just simply trying to force it into the same parent as `self`. This also allows us to say that there is no (left) action of `other` on `self`. I doubt I could think of a doctest for this specific case (although perhaps over two suitably chosen base rings) though...



---

archive/issue_comments_446160.json:
```json
{
    "body": "Changed commit from **[`0d2dd5d`](https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd)** to **[`967f848`](https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff)**",
    "created_at": "2021-04-30T08:43:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446160",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0d2dd5d`](https://github.com/sagemath/sagetrac-mirror/commit/0d2dd5dce40364f27ab47ccef761d1610a4f4edd)** to **[`967f848`](https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff)**



---

archive/issue_comments_446161.json:
```json
{
    "body": "<div id=\"comment:39\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff\"><code>967f848</code></a></td><td><code>Try coercion first</code></td></tr></table>\n",
    "created_at": "2021-04-30T08:43:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446161",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:39"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff"><code>967f848</code></a></td><td><code>Try coercion first</code></td></tr></table>




---

archive/issue_comments_446162.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nNow I wonder whether `FiniteRingElement` class is the right place to put `_lmul_` method. The scalar multiplication is naturally defined for all rings. So `RingElement` class might be a better place. I experimented on this idea, but I got lots of doctest failures. So I would not attempt this on this ticket.",
    "created_at": "2021-04-30T08:49:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446162",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:40" align="right">comment:40</div>

Now I wonder whether `FiniteRingElement` class is the right place to put `_lmul_` method. The scalar multiplication is naturally defined for all rings. So `RingElement` class might be a better place. I experimented on this idea, but I got lots of doctest failures. So I would not attempt this on this ticket.



---

archive/issue_comments_446163.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nActually \n\n```\n----------------------------------------------------------------------\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/complex_arb.pyx  # 1 doctest failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/qqbar.py  # 1 doctest failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/number_field/number_field_element.pyx  # 1 doctest failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/infinite_polynomial_element.py  # 6 doctests failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/skew_polynomial_ring.py  # 2 doctests failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/polynomial_element.pyx  # 1 doctest failed\nsage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/ore_function_element.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\nSo not so many...",
    "created_at": "2021-04-30T08:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446163",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:41" align="right">comment:41</div>

Actually 

```
----------------------------------------------------------------------
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/complex_arb.pyx  # 1 doctest failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/qqbar.py  # 1 doctest failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/number_field/number_field_element.pyx  # 1 doctest failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/infinite_polynomial_element.py  # 6 doctests failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/skew_polynomial_ring.py  # 2 doctests failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/polynomial_element.pyx  # 1 doctest failed
sage -t --warn-long 65.6 --random-seed=0 src/sage/rings/polynomial/ore_function_element.py  # 1 doctest failed
----------------------------------------------------------------------
```
So not so many...



---

archive/issue_comments_446164.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@kwankyu](#comment:32):\n> ... the current code only checks products with the *last* generator of the module. It \n>     looks like a bug ...\n> \n> Is it a bug?\n\nI think that at least the code needs to make sure that the last generator is non-zero. For example, this fails in this case:\n\n```\nsage: K.<a> = QuadraticField(-1)\nsage: R.<x,y> = K['x,y'].quotient('y')\nsage: id = R.Hom(R).identity()\nsage: f = R.hom(R.gens(), R, base_map=K.hom([-a], K))\nsage: f == id  # should be False\nTrue\n```\n(Currently, this fails because `_lmul_` returns `None`, though.)\n\nThis example is from ticket [[#30938 comment:3](https://github.com/sagemath/sage/issues/30938#comment:3)], where we were also confused about this `_richcmp_` implementation.",
    "created_at": "2021-05-03T18:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446164",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@kwankyu](#comment:32):
> ... the current code only checks products with the *last* generator of the module. It 
>     looks like a bug ...
> 
> Is it a bug?

I think that at least the code needs to make sure that the last generator is non-zero. For example, this fails in this case:

```
sage: K.<a> = QuadraticField(-1)
sage: R.<x,y> = K['x,y'].quotient('y')
sage: id = R.Hom(R).identity()
sage: f = R.hom(R.gens(), R, base_map=K.hom([-a], K))
sage: f == id  # should be False
True
```
(Currently, this fails because `_lmul_` returns `None`, though.)

This example is from ticket [[#30938 comment:3](https://github.com/sagemath/sage/issues/30938#comment:3)], where we were also confused about this `_richcmp_` implementation.



---

archive/issue_comments_446165.json:
```json
{
    "body": "<div id=\"comment:43\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7c3582094e430f3c21e569f2a289b9eb013c3c78\"><code>7c35820</code></a></td><td><code>Merge branch 'develop' into frobenius-trac28617</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f\"><code>e7b7845</code></a></td><td><code>Use nonzero gen for base elements comparison</code></td></tr></table>\n",
    "created_at": "2021-05-04T02:03:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446165",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:43"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7c3582094e430f3c21e569f2a289b9eb013c3c78"><code>7c35820</code></a></td><td><code>Merge branch 'develop' into frobenius-trac28617</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f"><code>e7b7845</code></a></td><td><code>Use nonzero gen for base elements comparison</code></td></tr></table>




---

archive/issue_comments_446166.json:
```json
{
    "body": "Changed commit from **[`967f848`](https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff)** to **[`e7b7845`](https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f)**",
    "created_at": "2021-05-04T02:03:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446166",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`967f848`](https://github.com/sagemath/sagetrac-mirror/commit/967f8483e3fbb30f99ab861f9970d6b6bea199ff)** to **[`e7b7845`](https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f)**



---

archive/issue_comments_446167.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@mwageringel](#comment:42):\n> I think that at least the code needs to make sure that the last generator is non-zero. For example, this fails in this case:\n> \n> ```\n> sage: K.<a> = QuadraticField(-1)\n> sage: R.<x,y> = K['x,y'].quotient('y')\n> sage: id = R.Hom(R).identity()\n> sage: f = R.hom(R.gens(), R, base_map=K.hom([-a], K))\n> sage: f == id  # should be False\n> True\n> ```\n> Currently, this fails because `_lmul_` returns `None`, though.\n\nDone. But the example still fails as you said.",
    "created_at": "2021-05-04T02:23:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446167",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@mwageringel](#comment:42):
> I think that at least the code needs to make sure that the last generator is non-zero. For example, this fails in this case:
> 
> ```
> sage: K.<a> = QuadraticField(-1)
> sage: R.<x,y> = K['x,y'].quotient('y')
> sage: id = R.Hom(R).identity()
> sage: f = R.hom(R.gens(), R, base_map=K.hom([-a], K))
> sage: f == id  # should be False
> True
> ```
> Currently, this fails because `_lmul_` returns `None`, though.

Done. But the example still fails as you said.



---

archive/issue_comments_446168.json:
```json
{
    "body": "<div id=\"comment:45\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f\"><code>a895363</code></a></td><td><code>Use coercion model to get scalar multiplication</code></td></tr></table>\n",
    "created_at": "2021-05-04T04:40:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446168",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:45"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f"><code>a895363</code></a></td><td><code>Use coercion model to get scalar multiplication</code></td></tr></table>




---

archive/issue_comments_446169.json:
```json
{
    "body": "Changed commit from **[`e7b7845`](https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f)** to **[`a895363`](https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f)**",
    "created_at": "2021-05-04T04:40:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446169",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`e7b7845`](https://github.com/sagemath/sagetrac-mirror/commit/e7b7845b3958301a419166382b789e80b969477f)** to **[`a895363`](https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f)**



---

archive/issue_comments_446170.json:
```json
{
    "body": "<div id=\"comment:46\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe\"><code>bb1835d</code></a></td><td><code>Remove `_lmul_` not unnecessary</code></td></tr></table>\n",
    "created_at": "2021-05-04T04:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446170",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:46"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe"><code>bb1835d</code></a></td><td><code>Remove `_lmul_` not unnecessary</code></td></tr></table>




---

archive/issue_comments_446171.json:
```json
{
    "body": "Changed commit from **[`a895363`](https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f)** to **[`bb1835d`](https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe)**",
    "created_at": "2021-05-04T04:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446171",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a895363`](https://github.com/sagemath/sagetrac-mirror/commit/a895363d55dfdf8a610251e80ca963afcba9bb8f)** to **[`bb1835d`](https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe)**



---

archive/issue_comments_446172.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nLooking at #30938, requiring each ring to implement `_lmul_` to avoid this morphism comparison problem seems not a good solution. It seems to me that the `_richcmp_` method of a generic morphism should try to get the necessary scalar multiplication in a general way, that is, via the coercion model. It will be a little bit slower but will work well generally.",
    "created_at": "2021-05-04T04:54:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446172",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:47" align="right">comment:47</div>

Looking at #30938, requiring each ring to implement `_lmul_` to avoid this morphism comparison problem seems not a good solution. It seems to me that the `_richcmp_` method of a generic morphism should try to get the necessary scalar multiplication in a general way, that is, via the coercion model. It will be a little bit slower but will work well generally.



---

archive/issue_comments_446173.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nYeah, I agree that avoiding a direct call to `_lmul_` is best, since multiplication by the base ring is allowed to be implemented using other methods.",
    "created_at": "2021-05-04T13:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446173",
    "user": "https://github.com/roed314"
}
```

<div id="comment:48" align="right">comment:48</div>

Yeah, I agree that avoiding a direct call to `_lmul_` is best, since multiplication by the base ring is allowed to be implemented using other methods.



---

archive/issue_comments_446174.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nIf I am not mistaken, there is still a problem with the theory behind this. For example:\n\n```\nsage: S.<a,b> = QQ['a,b'].quotient(['a*b'])\nsage: R.<x> = S['x']\nsage: f = R.hom([b], R, base_map=S.hom([-a, b], S))\nsage: g = R.hom([b], R)\nsage: f == g  # False is correct\nFalse\n```\nThe above only gives the correct answer because `f` and `g` have the same type, so a different comparison function is used. With the generic implementation, this gives the wrong answer:\n\n```\nsage: from sage.structure.richcmp import op_EQ\nsage: from sage.rings.morphism import RingMap\nsage: RingMap._richcmp_(f, g, op_EQ)  # should be False\nTrue\n```\nHere, `f(x)==g(x)` and `f(a*x)==g(a*x)` does not imply `f(a)==g(a)`, so the implementation relies on a cancellation property that does not hold in general.\n\nAs a module, `x` does not generate `R`, but `R` is generated by all monomials in `x`. In this case, the monomial `x^0` is the only generator for which the images of `a*x^0`, `b*x^0` allow to distinguish `f` and `g`.\n\nIt may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that `f` and `g` agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure \u2013 maybe we need to restrict to the case of module *homomorphisms* and raise a `NotImplementedError` otherwise.",
    "created_at": "2021-05-04T22:08:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446174",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:49" align="right">comment:49</div>

If I am not mistaken, there is still a problem with the theory behind this. For example:

```
sage: S.<a,b> = QQ['a,b'].quotient(['a*b'])
sage: R.<x> = S['x']
sage: f = R.hom([b], R, base_map=S.hom([-a, b], S))
sage: g = R.hom([b], R)
sage: f == g  # False is correct
False
```
The above only gives the correct answer because `f` and `g` have the same type, so a different comparison function is used. With the generic implementation, this gives the wrong answer:

```
sage: from sage.structure.richcmp import op_EQ
sage: from sage.rings.morphism import RingMap
sage: RingMap._richcmp_(f, g, op_EQ)  # should be False
True
```
Here, `f(x)==g(x)` and `f(a*x)==g(a*x)` does not imply `f(a)==g(a)`, so the implementation relies on a cancellation property that does not hold in general.

As a module, `x` does not generate `R`, but `R` is generated by all monomials in `x`. In this case, the monomial `x^0` is the only generator for which the images of `a*x^0`, `b*x^0` allow to distinguish `f` and `g`.

It may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that `f` and `g` agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure – maybe we need to restrict to the case of module *homomorphisms* and raise a `NotImplementedError` otherwise.



---

archive/issue_comments_446175.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@mwageringel](#comment:49):\n> so the implementation relies on a cancellation property that does not hold in general.\n\nGood point. \n\n> It may be necessary to separate the implementations for rings and modules. \n\nAssuming cancellation property is reasonable for most ring and modules in Sage. So I think the implementation is okay for generic morphisms. You just showed that it is not adequate for general rings. Fortunately Sage seems to provide a different implementation for the exceptional rings as you explained. \n\nI would document that the implementation for generic morphisms is assuming cancellation property so that future developers be warned for the trap.",
    "created_at": "2021-05-04T23:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446175",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@mwageringel](#comment:49):
> so the implementation relies on a cancellation property that does not hold in general.

Good point. 

> It may be necessary to separate the implementations for rings and modules. 

Assuming cancellation property is reasonable for most ring and modules in Sage. So I think the implementation is okay for generic morphisms. You just showed that it is not adequate for general rings. Fortunately Sage seems to provide a different implementation for the exceptional rings as you explained. 

I would document that the implementation for generic morphisms is assuming cancellation property so that future developers be warned for the trap.



---

archive/issue_comments_446176.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nWhy not just do\n\n```diff\n-coercion_model.bin_op(e, B.coerce(x), operator.mul)\n+e * B.coerce(x)\n```\nI find it easier to understand and it could use some optimizations that are present in `__mul__` (such as with integers and rationals).",
    "created_at": "2021-05-05T02:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446176",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:51" align="right">comment:51</div>

Why not just do

```diff
-coercion_model.bin_op(e, B.coerce(x), operator.mul)
+e * B.coerce(x)
```
I find it easier to understand and it could use some optimizations that are present in `__mul__` (such as with integers and rationals).



---

archive/issue_comments_446177.json:
```json
{
    "body": "<div id=\"comment:52\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc\"><code>c750280</code></a></td><td><code>Use * instead of bin_op</code></td></tr></table>\n",
    "created_at": "2021-05-05T05:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446177",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:52"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc"><code>c750280</code></a></td><td><code>Use * instead of bin_op</code></td></tr></table>




---

archive/issue_comments_446178.json:
```json
{
    "body": "Changed commit from **[`bb1835d`](https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe)** to **[`c750280`](https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc)**",
    "created_at": "2021-05-05T05:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446178",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bb1835d`](https://github.com/sagemath/sagetrac-mirror/commit/bb1835d32398f5772072244302b622cde3ebbbbe)** to **[`c750280`](https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc)**



---

archive/issue_comments_446179.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@kwankyu](#comment:50):\n> Assuming cancellation property is reasonable for most ring and modules in Sage. So I think the implementation is okay for generic morphisms. You just showed that it is not adequate for general rings. Fortunately Sage seems to provide a different implementation for the exceptional rings as you explained. \n\nThere are ways to construct the same maps but with different Python types, which seems to be the original motivation for #24281. Here are two examples, where the generic implementation is used:\n\n```\nsage: S.<a,b> = QQ['a,b'].quotient('a*b')\nsage: R.<x> = S[]\nsage: f = R.hom([b], R)\nsage: g = R.hom([b], R) * R.hom(S.hom([-a, b], S), R)\nsage: f == g  # should be False\nTrue\n```\n\n```\nsage: from sage.rings.polynomial.flatten import SpecializationMorphism\nsage: f2 = SpecializationMorphism(R, {x:b})\nsage: g2 = R.hom([b], S, base_map=S.hom([-a, b], S))\nsage: f2 == g2  # should be False\nTrue\n```\nSo making assumptions in the generic implementation which do not hold in general opens the door to mathematically wrong answers.",
    "created_at": "2021-05-05T07:54:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446179",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@kwankyu](#comment:50):
> Assuming cancellation property is reasonable for most ring and modules in Sage. So I think the implementation is okay for generic morphisms. You just showed that it is not adequate for general rings. Fortunately Sage seems to provide a different implementation for the exceptional rings as you explained. 

There are ways to construct the same maps but with different Python types, which seems to be the original motivation for #24281. Here are two examples, where the generic implementation is used:

```
sage: S.<a,b> = QQ['a,b'].quotient('a*b')
sage: R.<x> = S[]
sage: f = R.hom([b], R)
sage: g = R.hom([b], R) * R.hom(S.hom([-a, b], S), R)
sage: f == g  # should be False
True
```

```
sage: from sage.rings.polynomial.flatten import SpecializationMorphism
sage: f2 = SpecializationMorphism(R, {x:b})
sage: g2 = R.hom([b], S, base_map=S.hom([-a, b], S))
sage: f2 == g2  # should be False
True
```
So making assumptions in the generic implementation which do not hold in general opens the door to mathematically wrong answers.



---

archive/issue_comments_446180.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@mwageringel](#comment:53):\n> So making assumptions in the generic implementation which do not hold in general opens the door to mathematically wrong answers.\n\nI agree that the generic implementation is not perfect, and it needs to be replaced if someone comes up with a better one. On the other hand, the current patch solves the problem of this ticket by improving the implementation. \n\nIf a perfect solution is not around now, I suggest to open another ticket for it later.",
    "created_at": "2021-05-05T13:02:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446180",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@mwageringel](#comment:53):
> So making assumptions in the generic implementation which do not hold in general opens the door to mathematically wrong answers.

I agree that the generic implementation is not perfect, and it needs to be replaced if someone comes up with a better one. On the other hand, the current patch solves the problem of this ticket by improving the implementation. 

If a perfect solution is not around now, I suggest to open another ticket for it later.



---

archive/issue_comments_446181.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@kwankyu](#comment:54):\n> On the other hand, the current patch solves the problem of this ticket by improving the implementation. \n\nYes, I agree the current branch is better than what we had. I am ok with these changes.\n\nJust one small comment:\n\n```diff\n+from sage.structure.coerce cimport coercion_model\n```\nThis import does not seem to be needed anymore.",
    "created_at": "2021-05-05T19:19:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446181",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@kwankyu](#comment:54):
> On the other hand, the current patch solves the problem of this ticket by improving the implementation. 

Yes, I agree the current branch is better than what we had. I am ok with these changes.

Just one small comment:

```diff
+from sage.structure.coerce cimport coercion_model
```
This import does not seem to be needed anymore.



---

archive/issue_comments_446182.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nI'm fine with closing this ticket as it is.\n\nHowever, I need to mention that while working on #21413 about two years ago, I already noticed that comparison of ring morphisms was not really reliable and I implemented my own equality checking in `sage.rings.ring_extension_morphism` (function `are_equal_morphisms`). Probably, this code should be merged in the class `RingHomomorphism` at some point.",
    "created_at": "2021-05-05T19:42:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446182",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:56" align="right">comment:56</div>

I'm fine with closing this ticket as it is.

However, I need to mention that while working on #21413 about two years ago, I already noticed that comparison of ring morphisms was not really reliable and I implemented my own equality checking in `sage.rings.ring_extension_morphism` (function `are_equal_morphisms`). Probably, this code should be merged in the class `RingHomomorphism` at some point.



---

archive/issue_comments_446183.json:
```json
{
    "body": "Changed commit from **[`c750280`](https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc)** to **[`5415bd7`](https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae)**",
    "created_at": "2021-05-06T00:01:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446183",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c750280`](https://github.com/sagemath/sagetrac-mirror/commit/c750280d3e6ed7f831397477e1f2a55fb341a4fc)** to **[`5415bd7`](https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae)**



---

archive/issue_comments_446184.json:
```json
{
    "body": "<div id=\"comment:57\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae\"><code>5415bd7</code></a></td><td><code>Remove unnecessary import</code></td></tr></table>\n",
    "created_at": "2021-05-06T00:01:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446184",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:57"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae"><code>5415bd7</code></a></td><td><code>Remove unnecessary import</code></td></tr></table>




---

archive/issue_comments_446185.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nReplying to [@mwageringel](#comment:55):\n> \n> ```diff\n> +from sage.structure.coerce cimport coercion_model\n> ```\n> This import does not seem to be needed anymore.\n\nFixed. Thanks.",
    "created_at": "2021-05-06T00:14:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446185",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:58" align="right">comment:58</div>

Replying to [@mwageringel](#comment:55):
> 
> ```diff
> +from sage.structure.coerce cimport coercion_model
> ```
> This import does not seem to be needed anymore.

Fixed. Thanks.



---

archive/issue_comments_446186.json:
```json
{
    "body": "Changed commit from **[`5415bd7`](https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae)** to **[`fc019e2`](https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610)**",
    "created_at": "2021-05-06T00:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5415bd7`](https://github.com/sagemath/sagetrac-mirror/commit/5415bd761a2f5f6f31cdff5b0bb5a2182f9fc2ae)** to **[`fc019e2`](https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610)**



---

archive/issue_comments_446187.json:
```json
{
    "body": "<div id=\"comment:59\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610\"><code>fc019e2</code></a></td><td><code>Add reference to #31783</code></td></tr></table>\n",
    "created_at": "2021-05-06T00:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446187",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:59"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610"><code>fc019e2</code></a></td><td><code>Add reference to #31783</code></td></tr></table>




---

archive/issue_comments_446188.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@xcaruso](#comment:56):\n> I need to mention that while working on #21413 about two years ago, I already noticed that comparison of ring morphisms was not really reliable and I implemented my own equality checking in `sage.rings.ring_extension_morphism` (function `are_equal_morphisms`). Probably, this code should be merged in the class `RingHomomorphism` at some point.\n\nGood. You may provide the code to #31783.",
    "created_at": "2021-05-06T00:18:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446188",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@xcaruso](#comment:56):
> I need to mention that while working on #21413 about two years ago, I already noticed that comparison of ring morphisms was not really reliable and I implemented my own equality checking in `sage.rings.ring_extension_morphism` (function `are_equal_morphisms`). Probably, this code should be merged in the class `RingHomomorphism` at some point.

Good. You may provide the code to #31783.



---

archive/issue_comments_446189.json:
```json
{
    "body": "Changed commit from **[`fc019e2`](https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610)** to **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**",
    "created_at": "2021-05-06T09:05:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446189",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fc019e2`](https://github.com/sagemath/sagetrac-mirror/commit/fc019e23ab54eadcc258d9da14a72d45630b0610)** to **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**



---

archive/issue_comments_446190.json:
```json
{
    "body": "<div id=\"comment:61\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589\"><code>37c186e</code></a></td><td><code>Rewrite the added comment</code></td></tr></table>\n",
    "created_at": "2021-05-06T09:05:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446190",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:61"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589"><code>37c186e</code></a></td><td><code>Rewrite the added comment</code></td></tr></table>




---

archive/issue_comments_446191.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nAfter some thought, I became not sure of the added comment that the problem of the comparison method is only the assumption of the cancellation property. So I rewrote it only about a fact.\n\nThere is no change in the code. As it was a green light, we may still assume green light.\n\nFurther discussion on the problem should continue in #31783.",
    "created_at": "2021-05-06T09:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446191",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:62" align="right">comment:62</div>

After some thought, I became not sure of the added comment that the problem of the comparison method is only the assumption of the cancellation property. So I rewrote it only about a fact.

There is no change in the code. As it was a green light, we may still assume green light.

Further discussion on the problem should continue in #31783.



---

archive/issue_comments_446192.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nShouldn't we reset:\n\n```diff\n             if e is not None and isinstance(e, ModuleElement):\n                 B = (<ModuleElement>e)._parent._base\n                 gens = [e * B.coerce(x) for x in gens]\n+                e = None\n```\nOtherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.",
    "created_at": "2021-05-07T05:55:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446192",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:63" align="right">comment:63</div>

Shouldn't we reset:

```diff
             if e is not None and isinstance(e, ModuleElement):
                 B = (<ModuleElement>e)._parent._base
                 gens = [e * B.coerce(x) for x in gens]
+                e = None
```
Otherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.



---

archive/issue_comments_446193.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@tscrim](#comment:63):\n> Shouldn't we reset:\n> \n> ```diff\n>              if e is not None and isinstance(e, ModuleElement):\n>                  B = (<ModuleElement>e)._parent._base\n>                  gens = [e * B.coerce(x) for x in gens]\n> +                e = None\n> ```\n> Otherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.\n\ne should remain as an element of the module. All base elements are coerced to the scalar ring of the module.",
    "created_at": "2021-05-07T06:02:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446193",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@tscrim](#comment:63):
> Shouldn't we reset:
> 
> ```diff
>              if e is not None and isinstance(e, ModuleElement):
>                  B = (<ModuleElement>e)._parent._base
>                  gens = [e * B.coerce(x) for x in gens]
> +                e = None
> ```
> Otherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.

e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.



---

archive/issue_comments_446194.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@kwankyu](#comment:64):\n> Replying to [@tscrim](#comment:63):\n> > Shouldn't we reset:\n> > [snip]\n> > Otherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.\n\n> \n> e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.\n\nI thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?",
    "created_at": "2021-05-07T06:10:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446194",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@kwankyu](#comment:64):
> Replying to [@tscrim](#comment:63):
> > Shouldn't we reset:
> > [snip]
> > Otherwise we wouldn't set `e` to be an element of `gens` on subsequent calls. This would only show up if we have to go more than twice down, which we may not have a doctest for.

> 
> e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.

I thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?



---

archive/issue_comments_446195.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nReplying to [@tscrim](#comment:65):\n> Replying to [@kwankyu](#comment:64):\n> > e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.\n\n> \n> I thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?\n\nI think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.\n\nAnyway, the patch fixes the problem of the ticket but do not alter the logic or algorithm of the implementation. The flaw of the algorithm should now be dealt with in #31783. I hope that someone with a proved algorithm propose a patch to completely fix the morphism comparison problem in Sage.",
    "created_at": "2021-05-09T10:00:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446195",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:66" align="right">comment:66</div>

Replying to [@tscrim](#comment:65):
> Replying to [@kwankyu](#comment:64):
> > e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.

> 
> I thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?

I think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.

Anyway, the patch fixes the problem of the ticket but do not alter the logic or algorithm of the implementation. The flaw of the algorithm should now be dealt with in #31783. I hope that someone with a proved algorithm propose a patch to completely fix the morphism comparison problem in Sage.



---

archive/issue_comments_446196.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nReplying to [@kwankyu](#comment:66):\n> Replying to [@tscrim](#comment:65):\n> > Replying to [@kwankyu](#comment:64):\n> > > e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.\n\n> > \n> > I thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?\n\n> \n> I think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.\n\nI think it needs to go down as deep as possible. This is what the code currently does.\n\n> Anyway, the patch fixes the problem of the ticket but do not alter the logic or algorithm of the implementation. The flaw of the algorithm should now be dealt with in #31783. I hope that someone with a proved algorithm propose a patch to completely fix the morphism comparison problem in Sage. \n\nI am not fully convinced the logic has not changed. However, I am convinced enough that it works to let it in. I still would like a doctest doing the comparison with functions that are at least 2 deep in the recursion instead of just once to make sure it works. For example\n\n```\nZ[x] -> Z[x][y] -> Z[x][y][z]\n```\nwhere at each step we twist the generator `a -> -a`. I can write the doctest explicitly tomorrow.",
    "created_at": "2021-05-11T07:04:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446196",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:67" align="right">comment:67</div>

Replying to [@kwankyu](#comment:66):
> Replying to [@tscrim](#comment:65):
> > Replying to [@kwankyu](#comment:64):
> > > e should remain as an element of the module. All base elements are coerced to the scalar ring of the module.

> > 
> > I thought we wanted a recursion going a level deeper each time. Perhaps we can add a doctest for this behavior?

> 
> I think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.

I think it needs to go down as deep as possible. This is what the code currently does.

> Anyway, the patch fixes the problem of the ticket but do not alter the logic or algorithm of the implementation. The flaw of the algorithm should now be dealt with in #31783. I hope that someone with a proved algorithm propose a patch to completely fix the morphism comparison problem in Sage. 

I am not fully convinced the logic has not changed. However, I am convinced enough that it works to let it in. I still would like a doctest doing the comparison with functions that are at least 2 deep in the recursion instead of just once to make sure it works. For example

```
Z[x] -> Z[x][y] -> Z[x][y][z]
```
where at each step we twist the generator `a -> -a`. I can write the doctest explicitly tomorrow.



---

archive/issue_comments_446197.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nReplying to [@tscrim](#comment:67):\n> I think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.\n> \n> I think it needs to go down as deep as possible. This is what the code currently does.\n\nI tried to mean the recursion happens only within the base ring (not the module). My sentence was not clear. Sorry.\n\n> I still would like a doctest doing the comparison with functions that are at least 2 deep in the recursion instead of just once to make sure it works. For example\n> \n> ```\n> Z[x] -> Z[x][y] -> Z[x][y][z]\n> ```\n> where at each step we twist the generator `a -> -a`. I can write the doctest explicitly tomorrow.\n\nComparison of ring homomorphisms will be dealt with the code in #31783. It would be better that your doctest for the present ticket is about module homomorphisms.",
    "created_at": "2021-05-11T08:07:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446197",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:68" align="right">comment:68</div>

Replying to [@tscrim](#comment:67):
> I think the recursion should limit to the base ring of the base ring for module morphisms. For ring morphisms, the implementation seems inherently flawed as Markus showed.
> 
> I think it needs to go down as deep as possible. This is what the code currently does.

I tried to mean the recursion happens only within the base ring (not the module). My sentence was not clear. Sorry.

> I still would like a doctest doing the comparison with functions that are at least 2 deep in the recursion instead of just once to make sure it works. For example
> 
> ```
> Z[x] -> Z[x][y] -> Z[x][y][z]
> ```
> where at each step we twist the generator `a -> -a`. I can write the doctest explicitly tomorrow.

Comparison of ring homomorphisms will be dealt with the code in #31783. It would be better that your doctest for the present ticket is about module homomorphisms.



---

archive/issue_comments_446198.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nAs suggested by Kwankyu, I think that we should close this ticket now (in order to fix the issue as soon as possible) and continue the discussion (which could take some time) in #31783.\n\nThat's why I'm giving again a positive review to this ticket. Feel free to revert this decision if you strongly disagree.",
    "created_at": "2021-05-11T13:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446198",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:69" align="right">comment:69</div>

As suggested by Kwankyu, I think that we should close this ticket now (in order to fix the issue as soon as possible) and continue the discussion (which could take some time) in #31783.

That's why I'm giving again a positive review to this ticket. Feel free to revert this decision if you strongly disagree.



---

archive/issue_comments_446199.json:
```json
{
    "body": "Changed author from **Kwankyu Lee** to **Kwankyu Lee, Travis Scrimshaw**",
    "created_at": "2021-05-11T13:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446199",
    "user": "https://github.com/xcaruso"
}
```

Changed author from **Kwankyu Lee** to **Kwankyu Lee, Travis Scrimshaw**



---

archive/issue_events_394963.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2021-05-11T13:22:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394963"
}
```



---

archive/issue_events_394964.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2021-05-11T13:22:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394964"
}
```



---

archive/issue_comments_446200.json:
```json
{
    "body": "Changed reviewer from **Xavier Caruso** to **Xavier Caruso, , Travis Scrimshaw**",
    "created_at": "2021-05-11T13:23:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446200",
    "user": "https://github.com/xcaruso"
}
```

Changed reviewer from **Xavier Caruso** to **Xavier Caruso, , Travis Scrimshaw**



---

archive/issue_comments_446201.json:
```json
{
    "body": "Changed author from **Kwankyu Lee, Travis Scrimshaw** to **Kwankyu Lee**",
    "created_at": "2021-05-11T13:23:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446201",
    "user": "https://github.com/xcaruso"
}
```

Changed author from **Kwankyu Lee, Travis Scrimshaw** to **Kwankyu Lee**



---

archive/issue_comments_446202.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\n(Hope it's correct this time. Sorry for the inconvenience.)",
    "created_at": "2021-05-11T13:25:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446202",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:71" align="right">comment:71</div>

(Hope it's correct this time. Sorry for the inconvenience.)



---

archive/issue_comments_446203.json:
```json
{
    "body": "Changed reviewer from **Xavier Caruso, , Travis Scrimshaw** to **Xavier Caruso, Travis Scrimshaw**",
    "created_at": "2021-05-11T13:25:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446203",
    "user": "https://github.com/xcaruso"
}
```

Changed reviewer from **Xavier Caruso, , Travis Scrimshaw** to **Xavier Caruso, Travis Scrimshaw**



---

archive/issue_comments_446204.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nI don't know of a good test for this, so okay, let it be.",
    "created_at": "2021-05-12T06:58:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446204",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:72" align="right">comment:72</div>

I don't know of a good test for this, so okay, let it be.



---

archive/issue_events_394965.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:29:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394965"
}
```



---

archive/issue_events_394966.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "75c60e17c5428ce86af0d9fcfb701a88f048aead",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-05-27T20:29:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28617#event-394966"
}
```



---

archive/issue_comments_446205.json:
```json
{
    "body": "Changed branch from **[u/klee/28617](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/28617)** to **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**",
    "created_at": "2021-05-27T20:29:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28617",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28617#issuecomment-446205",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/klee/28617](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/28617)** to **[`37c186e`](https://github.com/sagemath/sagetrac-mirror/commit/37c186e3eac777e52eaa429b136439ade5b8e589)**
