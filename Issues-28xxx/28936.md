# Issue 28936: Meta-ticket: Adopt mainstream Python testing/linting infrastructure: tox, pytest, ..., describe in Developer's Guide

archive/issues_028699.json:
```json
{
    "body": "This metaticket proposes to use mainstream Python testing and linting infrastructure for Sage -- by adding configuration files and documentation.\n\n**tox**:\n- #28987 Add `src/tox.ini`: As an alternative interface to running the sage doctester.\n- #30467 `src/tox.ini`: Check patchbot plugin patterns\n- #30410 (Command \"sage -tox\")\n- #30416 (Make tox a standard package)\n- #30453 Document \"sage -tox\"\n- #30411 (src/tox.ini: Add environment pyright)\n- #30448 (src/tox.ini: Add validation of rst files and docstrings via a quick docbuild)\n\n\n**pytest**:\n- #31003 Add minimal pytest configuration\n- #31103 `sage.numerical.backends`: Replace use of `TestSuite` by `pytest`\n- #30362 Add symplectic structures\n- #32975 Improve doctest interaction with pytest\n- #33549 Rename `test_...` functions to avoid the naming scheme reserved by pytest\n- #31924 `sage -t`: Do not run pytest on individual Python files unless they match the pytest file pattern\n- #33572 `sage -pytest`\n- #33560 pytest: ignore cython files\n- #33561 Rename `test_...` classes to avoid the naming scheme reserved by pytest\n- #33550 Preparse sage files before passing them to pytest\n- #31123 Document pytest\n- #33521 doctesting with pytest fails on system install of sage\n- #33531 pytest in sage is broken, please make it really optional\n- #31110 Make `pytest` a standard package\n- #33546 Replace custom Sage doctest discovery by pytest (using pytest_collect_file)\n- #30738 Replace custom Sage unit test discovery by pytest\n- #31104 `sage.geometry.polyhedron`: Replace use of `TestSuite` by `pytest`\n\nOther tickets:\n\n- #30452 (\"sage -startuptime\" should accept file names too)\n\n- #30361 (Add pyright config and linting documentation; dup: #17992)\n\n- #33232 (`sage -t`: Write report in JUnitXML format)\n\n- #30415 (Remove pyflakes?)\n\n\nDocumentation tickets:\n\n- #29784 Update section \"Sage Development Process\" in Developer's Guide\n\n\n- #29520: Mention .lgtm.yml in the Developer's Guide\n\nInfrastructure tickets:\n\n- #30363 Replace patchbot by github actions (part of https://trac.sagemath.org/ticket/)\n\n- Use pre-commit https://pre-commit.com/\n\n- Use pipenv in place of venv https://pipenv.pypa.io/en/latest/#\n\n\nSee also:\n\n- Meta-ticket #29060: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages\n\n- Generalize `sage.numerical.backends.logging_backend.LoggingBackend` to help generate `_test` methods\n\n- #28998: Add script-type check_dependencies package that installs tox, mock, pytest etc.\n\n- Extensive description of different linters: https://github.com/vintasoftware/python-linters-and-code-analysis\n\n\n\nCC:  @jdemeyer @dimpase @embray @videlec @fchapoton @tscrim @jm58660 @tobiasdiez @kliem @nthiery @tornaria\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/28936\n\n",
    "created_at": "2020-01-01T18:58:02Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: Adopt mainstream Python testing/linting infrastructure: tox, pytest, ..., describe in Developer's Guide",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28936",
    "user": "https://github.com/mkoeppe"
}
```
This metaticket proposes to use mainstream Python testing and linting infrastructure for Sage -- by adding configuration files and documentation.

**tox**:
- #28987 Add `src/tox.ini`: As an alternative interface to running the sage doctester.
- #30467 `src/tox.ini`: Check patchbot plugin patterns
- #30410 (Command "sage -tox")
- #30416 (Make tox a standard package)
- #30453 Document "sage -tox"
- #30411 (src/tox.ini: Add environment pyright)
- #30448 (src/tox.ini: Add validation of rst files and docstrings via a quick docbuild)


**pytest**:
- #31003 Add minimal pytest configuration
- #31103 `sage.numerical.backends`: Replace use of `TestSuite` by `pytest`
- #30362 Add symplectic structures
- #32975 Improve doctest interaction with pytest
- #33549 Rename `test_...` functions to avoid the naming scheme reserved by pytest
- #31924 `sage -t`: Do not run pytest on individual Python files unless they match the pytest file pattern
- #33572 `sage -pytest`
- #33560 pytest: ignore cython files
- #33561 Rename `test_...` classes to avoid the naming scheme reserved by pytest
- #33550 Preparse sage files before passing them to pytest
- #31123 Document pytest
- #33521 doctesting with pytest fails on system install of sage
- #33531 pytest in sage is broken, please make it really optional
- #31110 Make `pytest` a standard package
- #33546 Replace custom Sage doctest discovery by pytest (using pytest_collect_file)
- #30738 Replace custom Sage unit test discovery by pytest
- #31104 `sage.geometry.polyhedron`: Replace use of `TestSuite` by `pytest`

Other tickets:

- #30452 ("sage -startuptime" should accept file names too)

- #30361 (Add pyright config and linting documentation; dup: #17992)

- #33232 (`sage -t`: Write report in JUnitXML format)

- #30415 (Remove pyflakes?)


Documentation tickets:

- #29784 Update section "Sage Development Process" in Developer's Guide


- #29520: Mention .lgtm.yml in the Developer's Guide

Infrastructure tickets:

- #30363 Replace patchbot by github actions (part of https://trac.sagemath.org/ticket/)

- Use pre-commit https://pre-commit.com/

- Use pipenv in place of venv https://pipenv.pypa.io/en/latest/#


See also:

- Meta-ticket #29060: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages

- Generalize `sage.numerical.backends.logging_backend.LoggingBackend` to help generate `_test` methods

- #28998: Add script-type check_dependencies package that installs tox, mock, pytest etc.

- Extensive description of different linters: https://github.com/vintasoftware/python-linters-and-code-analysis



CC:  @jdemeyer @dimpase @embray @videlec @fchapoton @tscrim @jm58660 @tobiasdiez @kliem @nthiery @tornaria

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/28936





---

archive/issue_events_073259.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-04T04:39:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73259"
}
```



---

archive/issue_comments_404919.json:
```json
{
    "body": "Replying to [ticket:28936 mkoeppe]:\n> `tox` seems to be the preferred interface for running tests - see for example https://github.com/pypa/setuptools/issues/931 (deprecation of `setup.py test`).\n\n\nI don't know what you mean by \"preferred interface\" here.  There isn't really any such thing as a preferred interface.  It's just being proposed here as a recommendation over `setup.py test`.  Sage doesn't use `setup.py test` anyways so there's nothing that needs to be \"replaced\" with a different interface if/when `setup.py` goes away.\n\nThe main advantage to tox is the ability to run a package's tests across multiple runtime environments (esp. different Python versions).  This isn't really possible currently with Sage; it would actually be very difficult to use tox in any sensible manner with Sage.\n\nIf someone wants to do this anyways I don't see the harm really, but I'm not sure what problem it would be solving.",
    "created_at": "2020-01-06T14:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404919",
    "user": "https://github.com/embray"
}
```

Replying to [ticket:28936 mkoeppe]:
> `tox` seems to be the preferred interface for running tests - see for example https://github.com/pypa/setuptools/issues/931 (deprecation of `setup.py test`).


I don't know what you mean by "preferred interface" here.  There isn't really any such thing as a preferred interface.  It's just being proposed here as a recommendation over `setup.py test`.  Sage doesn't use `setup.py test` anyways so there's nothing that needs to be "replaced" with a different interface if/when `setup.py` goes away.

The main advantage to tox is the ability to run a package's tests across multiple runtime environments (esp. different Python versions).  This isn't really possible currently with Sage; it would actually be very difficult to use tox in any sensible manner with Sage.

If someone wants to do this anyways I don't see the harm really, but I'm not sure what problem it would be solving.



---

archive/issue_comments_404920.json:
```json
{
    "body": "Changing type from enhancement to task.",
    "created_at": "2020-01-11T05:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404920",
    "user": "https://github.com/mkoeppe"
}
```

Changing type from enhancement to task.



---

archive/issue_comments_404921.json:
```json
{
    "body": "<a id='comment:4'></a>A first step:  #28987",
    "created_at": "2020-01-11T05:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404921",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>A first step:  #28987



---

archive/issue_comments_404922.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 embray]:\n> Replying to [ticket:28936 mkoeppe]:\n> The main advantage to tox is the ability to run a package's tests across multiple runtime environments (esp. different Python versions).  This isn't really possible currently with Sage; it would actually be very difficult to use tox in any sensible manner with Sage.\n\n\nFWIW, I managed to use `tox` on top of the sage installation, see https://github.com/mkoeppe/sage-numerical-backends-gurobi/blob/master/tox.ini: The trick is to run `tox` with `sitepackages = true` and an `install_command` that installs into the user scheme. With this trick, after all, no new plugin for `tox` is needed to handle the sage environment.",
    "created_at": "2020-01-13T01:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404922",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Replying to [comment:3 embray]:
> Replying to [ticket:28936 mkoeppe]:
> The main advantage to tox is the ability to run a package's tests across multiple runtime environments (esp. different Python versions).  This isn't really possible currently with Sage; it would actually be very difficult to use tox in any sensible manner with Sage.


FWIW, I managed to use `tox` on top of the sage installation, see https://github.com/mkoeppe/sage-numerical-backends-gurobi/blob/master/tox.ini: The trick is to run `tox` with `sitepackages = true` and an `install_command` that installs into the user scheme. With this trick, after all, no new plugin for `tox` is needed to handle the sage environment.



---

archive/issue_comments_404923.json:
```json
{
    "body": "<a id='comment:6'></a>I have broadened the ticket description.",
    "created_at": "2020-01-13T02:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404923",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>I have broadened the ticket description.



---

archive/issue_comments_404924.json:
```json
{
    "body": "<a id='comment:8'></a>pushing these forward to 9.2",
    "created_at": "2020-04-14T06:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404924",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>pushing these forward to 9.2



---

archive/issue_events_073260.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:38:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73260"
}
```



---

archive/issue_events_073261.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:38:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73261"
}
```



---

archive/issue_events_073262.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73262"
}
```



---

archive/issue_events_073263.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73263"
}
```



---

archive/issue_comments_404925.json:
```json
{
    "body": "<a id='comment:29'></a>Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404925",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_073264.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73264"
}
```



---

archive/issue_events_073265.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73265"
}
```



---

archive/issue_comments_404926.json:
```json
{
    "body": "<a id='comment:31'></a>What do you think about using [pytest-cov](https://pypi.org/project/pytest-cov/) for generating the test coverage report? The results can then be uploded to [codecov](https://about.codecov.io/) as part of the build process (github action). This gives a nice overview of the actual test coverage (i.e. code covered by tests) and could replace the sage-coverage scripts in the future.",
    "created_at": "2021-05-27T21:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404926",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:31'></a>What do you think about using [pytest-cov](https://pypi.org/project/pytest-cov/) for generating the test coverage report? The results can then be uploded to [codecov](https://about.codecov.io/) as part of the build process (github action). This gives a nice overview of the actual test coverage (i.e. code covered by tests) and could replace the sage-coverage scripts in the future.



---

archive/issue_comments_404927.json:
```json
{
    "body": "<a id='comment:32'></a>+1 on investigating this. Myself I have no experience with the available tools (including the `sage-coverage` scripts even though I have fixed them up at least once). As usual, it's best to build a prototype and then demonstrate to the sage-devel community that it is useful.",
    "created_at": "2021-05-28T00:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28936#issuecomment-404927",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>+1 on investigating this. Myself I have no experience with the available tools (including the `sage-coverage` scripts even though I have fixed them up at least once). As usual, it's best to build a prototype and then demonstrate to the sage-devel community that it is useful.



---

archive/issue_events_073266.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73266"
}
```



---

archive/issue_events_073267.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73267"
}
```



---

archive/issue_events_073268.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73268"
}
```



---

archive/issue_events_073269.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73269"
}
```



---

archive/issue_events_073270.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73270"
}
```



---

archive/issue_events_073271.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73271"
}
```



---

archive/issue_events_073272.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T16:33:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73272"
}
```



---

archive/issue_events_073273.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T16:33:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28936",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28936#event-73273"
}
```
