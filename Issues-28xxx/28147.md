# Issue 28147: Remove _derivative from Polynomial_template

archive/issues_027910.json:
```json
{
    "body": "Right now, the class `Polynomial_template` contains a method `_derivative`, called from the generic `derivative` (from `Polynomial`) through the function `multi_derivative` of `misc/derivative.pyx`. This method is quite badly written, with at least the following consequences:\n\n- It is **really** slow:\n\n```python\nsage: R.<x> = GF(65537)[]\nsage: p = R.random_element(10^4)\nsage: %time _ = p.derivative()\nCPU times: user 6.91 s, sys: 3.7 ms, total: 6.91 s\nWall time: 6.91 s\n```\n\n- It breaks the differentiation of rational functions, cf #26844:\n\n```python\nsage: A = PolynomialRing(GF(3), name='t')\nsage: K = A.fraction_field()\nsage: t = K.gen()\nsage: t.derivative(t)\nTraceback (most recent call last):\n...\nValueError: cannot differentiate with respect to t\n```\n\n\nAfter removal:\n\n```python\nsage: R.<x> = GF(65537)[]\nsage: p = R.random_element(10^4)\nsage: %time _ = p.derivative()\nCPU times: user 48.5 ms, sys: 145 \u00b5s, total: 48.7 ms\nWall time: 48.3 ms\n```\n\n\n```python\nsage: A = PolynomialRing(GF(3), name='t')\nsage: K = A.fraction_field()\nsage: t = K.gen()\nsage: t.derivative(t)\n1\n```\n\nKeywords: polynomial\n\nBranch/Commit: 9543c20b0992d55ae6ba99a8ace921025cf39ec7\n\nReviewer: Marc Mezzarobba\n\nAuthor: Bruno Grenet\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28147\n\n",
    "closed_at": "2019-08-29T20:02:12Z",
    "created_at": "2019-07-09T18:07:48Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Remove _derivative from Polynomial_template",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28147",
    "user": "https://github.com/bgrenet"
}
```
Right now, the class `Polynomial_template` contains a method `_derivative`, called from the generic `derivative` (from `Polynomial`) through the function `multi_derivative` of `misc/derivative.pyx`. This method is quite badly written, with at least the following consequences:

- It is **really** slow:

```python
sage: R.<x> = GF(65537)[]
sage: p = R.random_element(10^4)
sage: %time _ = p.derivative()
CPU times: user 6.91 s, sys: 3.7 ms, total: 6.91 s
Wall time: 6.91 s
```

- It breaks the differentiation of rational functions, cf #26844:

```python
sage: A = PolynomialRing(GF(3), name='t')
sage: K = A.fraction_field()
sage: t = K.gen()
sage: t.derivative(t)
Traceback (most recent call last):
...
ValueError: cannot differentiate with respect to t
```


After removal:

```python
sage: R.<x> = GF(65537)[]
sage: p = R.random_element(10^4)
sage: %time _ = p.derivative()
CPU times: user 48.5 ms, sys: 145 µs, total: 48.7 ms
Wall time: 48.3 ms
```


```python
sage: A = PolynomialRing(GF(3), name='t')
sage: K = A.fraction_field()
sage: t = K.gen()
sage: t.derivative(t)
1
```

Keywords: polynomial

Branch/Commit: 9543c20b0992d55ae6ba99a8ace921025cf39ec7

Reviewer: Marc Mezzarobba

Author: Bruno Grenet

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28147





---

archive/issue_comments_545317.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,10 +10,20 @@\n Wall time: 6.91 s\n ```\n \n-- It breaks the differentiation of power series, cf #26844. \n+- It breaks the differentiation of power series, cf #26844:\n+\n+```python\n+sage: A = PolynomialRing(GF(3), name='t')\n+sage: K = A.fraction_field()\n+sage: t = K.gen()\n+sage: t.derivative(t)\n+Traceback (most recent call last):\n+...\n+ValueError: cannot differentiate with respect to t\n+```\n \n \n-After removing it, I see no problem, #26844 is not a problem anymore, and we have a more reasonable computation time for the above example:\n+After removal:\n \n ```python\n sage: R.<x> = GF(65537)[]\n@@ -22,3 +32,12 @@\n CPU times: user 48.5 ms, sys: 145 \u00b5s, total: 48.7 ms\n Wall time: 48.3 ms\n ```\n+\n+\n+```python\n+sage: A = PolynomialRing(GF(3), name='t')\n+sage: K = A.fraction_field()\n+sage: t = K.gen()\n+sage: t.derivative(t)\n+1\n+```\n``````\n",
    "created_at": "2019-07-10T07:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545317",
    "user": "https://github.com/bgrenet"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,10 +10,20 @@
 Wall time: 6.91 s
 ```
 
-- It breaks the differentiation of power series, cf #26844. 
+- It breaks the differentiation of power series, cf #26844:
+
+```python
+sage: A = PolynomialRing(GF(3), name='t')
+sage: K = A.fraction_field()
+sage: t = K.gen()
+sage: t.derivative(t)
+Traceback (most recent call last):
+...
+ValueError: cannot differentiate with respect to t
+```
 
 
-After removing it, I see no problem, #26844 is not a problem anymore, and we have a more reasonable computation time for the above example:
+After removal:
 
 ```python
 sage: R.<x> = GF(65537)[]
@@ -22,3 +32,12 @@
 CPU times: user 48.5 ms, sys: 145 µs, total: 48.7 ms
 Wall time: 48.3 ms
 ```
+
+
+```python
+sage: A = PolynomialRing(GF(3), name='t')
+sage: K = A.fraction_field()
+sage: t = K.gen()
+sage: t.derivative(t)
+1
+```
``````




---

archive/issue_comments_545318.json:
```json
{
    "body": "Changing branch from \"\" to \"u/bruno/remove_derivative\"",
    "created_at": "2019-07-10T07:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545318",
    "user": "https://github.com/bgrenet"
}
```

Changing branch from "" to "u/bruno/remove_derivative"



---

archive/issue_comments_545319.json:
```json
{
    "body": "Changing commit from \"\" to \"dcba4094c2910c1956413b1e310ca8465d2c7790\"",
    "created_at": "2019-07-10T07:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545319",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "dcba4094c2910c1956413b1e310ca8465d2c7790"



---

archive/issue_comments_545320.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[6384e2e](https://git.sagemath.org/sage.git/commit/?id=6384e2ee1e9bfd719d86fda731ee68f090220a20)|`28147: Remove _derivative`|\n|[dcba409](https://git.sagemath.org/sage.git/commit/?id=dcba4094c2910c1956413b1e310ca8465d2c7790)|`28147: Doctests`|",
    "created_at": "2019-07-10T07:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[6384e2e](https://git.sagemath.org/sage.git/commit/?id=6384e2ee1e9bfd719d86fda731ee68f090220a20)|`28147: Remove _derivative`|
|[dcba409](https://git.sagemath.org/sage.git/commit/?id=dcba4094c2910c1956413b1e310ca8465d2c7790)|`28147: Doctests`|



---

archive/issue_comments_545321.json:
```json
{
    "body": "<a id='comment:3'></a>\nI tried to detect potential problems with the removal of this method, but I didn't find any. Feel free to suggest where to look at!",
    "created_at": "2019-07-10T07:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545321",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:3'></a>
I tried to detect potential problems with the removal of this method, but I didn't find any. Feel free to suggest where to look at!



---

archive/issue_comments_545322.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-10T07:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545322",
    "user": "https://github.com/bgrenet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_545323.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,7 +10,7 @@\n Wall time: 6.91 s\n ```\n \n-- It breaks the differentiation of power series, cf #26844:\n+- It breaks the differentiation of rational functions, cf #26844:\n \n ```python\n sage: A = PolynomialRing(GF(3), name='t')\n``````\n",
    "created_at": "2019-07-10T07:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545323",
    "user": "https://github.com/bgrenet"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,7 +10,7 @@
 Wall time: 6.91 s
 ```
 
-- It breaks the differentiation of power series, cf #26844:
+- It breaks the differentiation of rational functions, cf #26844:
 
 ```python
 sage: A = PolynomialRing(GF(3), name='t')
``````




---

archive/issue_comments_545324.json:
```json
{
    "body": "<a id='comment:5'></a>\nHi Bruno,\n\nI think you may want to adapt some of the doctests you are removing. Otherwise lgtm...",
    "created_at": "2019-07-23T17:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545324",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:5'></a>
Hi Bruno,

I think you may want to adapt some of the doctests you are removing. Otherwise lgtm...



---

archive/issue_comments_545325.json:
```json
{
    "body": "Changing commit from \"dcba4094c2910c1956413b1e310ca8465d2c7790\" to \"9543c20b0992d55ae6ba99a8ace921025cf39ec7\"",
    "created_at": "2019-08-19T16:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "dcba4094c2910c1956413b1e310ca8465d2c7790" to "9543c20b0992d55ae6ba99a8ace921025cf39ec7"



---

archive/issue_comments_545326.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|\n|[9543c20](https://git.sagemath.org/sage.git/commit/?id=9543c20b0992d55ae6ba99a8ace921025cf39ec7)|`28147: Better error messages`|",
    "created_at": "2019-08-19T16:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545326",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|
|[9543c20](https://git.sagemath.org/sage.git/commit/?id=9543c20b0992d55ae6ba99a8ace921025cf39ec7)|`28147: Better error messages`|



---

archive/issue_comments_545327.json:
```json
{
    "body": "<a id='comment:7'></a>\nHi Marc, \n\nI imported the removed doctests, and had errors... I had to change the error message when one tries to differentiate with respect to something \"weird\". In my view, this improves the current situation. In particular I do not find the following doctest (that I changed) very satisfying:\n\n```\nIn the following example, it doesn't recognise 2\\*x as the\ngenerator, so it tries to differentiate each of the coefficients\nwith respect to 2\\*x, which doesn't work because the integer\ncoefficients don't have a _derivative() method::\n\n    sage: f._derivative(2*x)\n    Traceback (most recent call last):\n    ...\n    AttributeError: 'sage.rings.integer.Integer' object has no attribute '_derivative'\n```\n\nThe new doctest seems more reasonable to me:\n\n```\nIt is not possible to differentiate with respect to 2\\*x for instance::\n\n    sage: f._derivative(2*x)\n    Traceback (most recent call last):\n    ...\n    ValueError: cannot differentiate with respect to 2*x\n```",
    "created_at": "2019-08-19T17:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545327",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:7'></a>
Hi Marc, 

I imported the removed doctests, and had errors... I had to change the error message when one tries to differentiate with respect to something "weird". In my view, this improves the current situation. In particular I do not find the following doctest (that I changed) very satisfying:

```
In the following example, it doesn't recognise 2\*x as the
generator, so it tries to differentiate each of the coefficients
with respect to 2\*x, which doesn't work because the integer
coefficients don't have a _derivative() method::

    sage: f._derivative(2*x)
    Traceback (most recent call last):
    ...
    AttributeError: 'sage.rings.integer.Integer' object has no attribute '_derivative'
```

The new doctest seems more reasonable to me:

```
It is not possible to differentiate with respect to 2\*x for instance::

    sage: f._derivative(2*x)
    Traceback (most recent call last):
    ...
    ValueError: cannot differentiate with respect to 2*x
```



---

archive/issue_comments_545328.json:
```json
{
    "body": "<a id='comment:8'></a>\nThank you!",
    "created_at": "2019-08-21T07:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545328",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:8'></a>
Thank you!



---

archive/issue_comments_545329.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T07:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545329",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_545330.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2019-08-21T07:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545330",
    "user": "https://github.com/mezzarobba"
}
```

Changing reviewer from "" to "Marc Mezzarobba"



---

archive/issue_comments_545331.json:
```json
{
    "body": "<a id='comment:9'></a>\nThank you for the review. Could you have a quick look to #26844 to confirm that the bug is indeed fixed by the current ticket?",
    "created_at": "2019-08-21T09:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545331",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:9'></a>
Thank you for the review. Could you have a quick look to #26844 to confirm that the bug is indeed fixed by the current ticket?



---

archive/issue_comments_545332.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-29T20:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545332",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069894.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-29T20:02:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28147#event-69894"
}
```



---

archive/issue_comments_545333.json:
```json
{
    "body": "Changing branch from \"u/bruno/remove_derivative\" to \"9543c20b0992d55ae6ba99a8ace921025cf39ec7\"",
    "created_at": "2019-08-29T20:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28147#issuecomment-545333",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/bruno/remove_derivative" to "9543c20b0992d55ae6ba99a8ace921025cf39ec7"
