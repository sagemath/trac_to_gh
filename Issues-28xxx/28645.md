# Issue 28645: Error in precision of Tate elliptic curves over Qp

archive/issues_028408.json:
```json
{
    "body": "The optional precision arguments for Tate's elliptic curves are incorrectly implemented. For many functions, increasing the precision does not increase the precision of the output.\n\nKeywords: Tate curve\n\nBranch/Commit: 9c537fbbeb0f6106cc637d5aa6e1cfff9437dd4f\n\nReviewer: Edgar Costa\n\nAuthor: Chris Wuthrich\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28645\n\n",
    "closed_at": "2019-11-07T23:30:04Z",
    "created_at": "2019-10-22T17:50:56Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Error in precision of Tate elliptic curves over Qp",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28645",
    "user": "https://github.com/categorie"
}
```
The optional precision arguments for Tate's elliptic curves are incorrectly implemented. For many functions, increasing the precision does not increase the precision of the output.

Keywords: Tate curve

Branch/Commit: 9c537fbbeb0f6106cc637d5aa6e1cfff9437dd4f

Reviewer: Edgar Costa

Author: Chris Wuthrich

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28645





---

archive/issue_comments_427106.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-10-22T17:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427106",
    "user": "https://github.com/categorie"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_427107.json:
```json
{
    "body": "<a id='comment:2'></a>Here an example of what was wrong\n\n```\nsage: E = EllipticCurve(\"126a5\")\nsage: Eq = E.tate_curve(2)\nsage: R = Qp(2,30)\nsage: u = R(2019)\nsage: Eq.parametrisation_onto_original_curve(u, prec=30)\n(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + O(2^18) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + O(2^16) : 1 + O(2^30))\n```\n\nThe precision drops to 20. Now fixed returns:\n\n```\n(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + 2^18 + 2^19 + 2^20 + 2^21 + 2^26 + O(2^28) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + 2^19 + 2^20 + 2^23 + 2^24 + 2^25 + O(2^26) : 1 + O(2^30))\n```",
    "created_at": "2019-10-22T18:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427107",
    "user": "https://github.com/categorie"
}
```

<a id='comment:2'></a>Here an example of what was wrong

```
sage: E = EllipticCurve("126a5")
sage: Eq = E.tate_curve(2)
sage: R = Qp(2,30)
sage: u = R(2019)
sage: Eq.parametrisation_onto_original_curve(u, prec=30)
(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + O(2^18) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + O(2^16) : 1 + O(2^30))
```

The precision drops to 20. Now fixed returns:

```
(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + 2^18 + 2^19 + 2^20 + 2^21 + 2^26 + O(2^28) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + 2^19 + 2^20 + 2^23 + 2^24 + 2^25 + O(2^26) : 1 + O(2^30))
```



---

archive/issue_comments_427108.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-22T18:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427108",
    "user": "https://github.com/categorie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_427109.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-10-24T21:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427109",
    "user": "https://github.com/edgarcosta"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_427110.json:
```json
{
    "body": "<a id='comment:3'></a>FYI, \n`src/sage/schemes/elliptic_curves/ell_tate_curve.py:233: local variable 'n' is assigned to but never used`",
    "created_at": "2019-10-24T21:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427110",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:3'></a>FYI, 
`src/sage/schemes/elliptic_curves/ell_tate_curve.py:233: local variable 'n' is assigned to but never used`



---

archive/issue_comments_427111.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-25T07:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427111",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_427112.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-10-25T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427112",
    "user": "https://github.com/categorie"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_427113.json:
```json
{
    "body": "<a id='comment:5'></a>Deleted that line.",
    "created_at": "2019-10-25T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427113",
    "user": "https://github.com/categorie"
}
```

<a id='comment:5'></a>Deleted that line.



---

archive/issue_comments_427114.json:
```json
{
    "body": "<a id='comment:6'></a>I'm sorry, but can't fully test this at the moment, so I can't give you examples, but \nI spotted a couple of issues (not introduced by you), but propagate through the rest:\n\n1- One is always hitting an `AttributeError` in the `try` block in `def parameter`, as it should be calling `precision_absolute`. Also, the `try` block is a bit sad, as it should be just triggered by `__init__`. Perhaps a `getattr(self, '_q', None)` would make more sense.\n\n2- Shouldn't we be checking for `precision_relative`? Given that we are always working with relative precision.\n\n3- Shouldn't parameter return a value with the right precision?\nIf not, we might need to work more and get results with more precision than expected. \n\n4- Similar to the previous item, we should consider replacing `R = qE.parent()` by `R = Qp(self._p, prec=prec)` in `def curve`.",
    "created_at": "2019-10-25T11:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427114",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:6'></a>I'm sorry, but can't fully test this at the moment, so I can't give you examples, but 
I spotted a couple of issues (not introduced by you), but propagate through the rest:

1- One is always hitting an `AttributeError` in the `try` block in `def parameter`, as it should be calling `precision_absolute`. Also, the `try` block is a bit sad, as it should be just triggered by `__init__`. Perhaps a `getattr(self, '_q', None)` would make more sense.

2- Shouldn't we be checking for `precision_relative`? Given that we are always working with relative precision.

3- Shouldn't parameter return a value with the right precision?
If not, we might need to work more and get results with more precision than expected. 

4- Similar to the previous item, we should consider replacing `R = qE.parent()` by `R = Qp(self._p, prec=prec)` in `def curve`.



---

archive/issue_comments_427115.json:
```json
{
    "body": "<a id='comment:7'></a>You may be right that there are more things that should be improved in that file. The purpose of this ticket is to correct a bug: I can increase the precision of the output by increasing the parameter prec. That was broken.\n\nMy proposal is that this is done on this ticket. Then we can open a further ticket to improve things.\n\nIn particular, I can get rid of try blocks (this is early sage when there were try blocks everywhere). \nWe could also think about getting provable correct precisions out. Honestly, I have little interest in doing so, but I would be willing to go through the file and make the necessary changes. But I doubt that anyone uses the output in that way. We should at least, give a warning that it is not provable relative/absolute precision.\n\nIf we want to do everything on this ticket, it is likely to drag for months and may get abandoned when this simple quick fix would have improved sage.",
    "created_at": "2019-10-25T14:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427115",
    "user": "https://github.com/categorie"
}
```

<a id='comment:7'></a>You may be right that there are more things that should be improved in that file. The purpose of this ticket is to correct a bug: I can increase the precision of the output by increasing the parameter prec. That was broken.

My proposal is that this is done on this ticket. Then we can open a further ticket to improve things.

In particular, I can get rid of try blocks (this is early sage when there were try blocks everywhere). 
We could also think about getting provable correct precisions out. Honestly, I have little interest in doing so, but I would be willing to go through the file and make the necessary changes. But I doubt that anyone uses the output in that way. We should at least, give a warning that it is not provable relative/absolute precision.

If we want to do everything on this ticket, it is likely to drag for months and may get abandoned when this simple quick fix would have improved sage.



---

archive/issue_comments_427116.json:
```json
{
    "body": "<a id='comment:8'></a>I agree with you, you should not fix this now.\n\nRegarding the original bug, is this an expected output, or should one raise an exception?\n\n```\nsage: E = EllipticCurve(\"126a5\")\nsage: Eq = E.tate_curve(2)\nsage: R = Qp(2,30)\nsage: u = R(2019)\nsage: Eq.parametrisation_onto_original_curve(u, prec=60)\n(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + 2^18 + 2^19 + 2^20 + 2^21 + 2^26 + O(2^28) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + 2^19 + 2^20 + 2^23 + 2^24 + 2^25 + O(2^26) : 1 + O(2^60))\n```",
    "created_at": "2019-10-31T00:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427116",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:8'></a>I agree with you, you should not fix this now.

Regarding the original bug, is this an expected output, or should one raise an exception?

```
sage: E = EllipticCurve("126a5")
sage: Eq = E.tate_curve(2)
sage: R = Qp(2,30)
sage: u = R(2019)
sage: Eq.parametrisation_onto_original_curve(u, prec=60)
(2^-2 + 2^-1 + 1 + 2 + 2^3 + 2^7 + 2^8 + 2^15 + 2^18 + 2^19 + 2^20 + 2^21 + 2^26 + O(2^28) : 2^-3 + 2^-2 + 2^-1 + 2 + 2^2 + 2^5 + 2^6 + 2^7 + 2^9 + 2^11 + 2^14 + 2^15 + 2^19 + 2^20 + 2^23 + 2^24 + 2^25 + O(2^26) : 1 + O(2^60))
```



---

archive/issue_comments_427117.json:
```json
{
    "body": "<a id='comment:9'></a>Ignore my comment, I will just move that to a new ticket",
    "created_at": "2019-10-31T19:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427117",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:9'></a>Ignore my comment, I will just move that to a new ticket



---

archive/issue_comments_427118.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-31T19:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427118",
    "user": "https://github.com/edgarcosta"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_427119.json:
```json
{
    "body": "<a id='comment:10'></a>Reviewer name is missing...",
    "created_at": "2019-10-31T23:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427119",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Reviewer name is missing...



---

archive/issue_comments_427120.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-10-31T23:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427120",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_427121.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-11-01T01:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427121",
    "user": "https://github.com/edgarcosta"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_427122.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-07T23:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28645#issuecomment-427122",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_072132.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:30:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28645",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28645#event-72132"
}
```
