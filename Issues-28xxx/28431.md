# Issue 28431: integrate(1/(a-c*b),a) incorrect

archive/issues_028194.json:
```json
{
    "assignees": [],
    "body": "This appears to be a maxima related error.\n\n```\nintegrate(1/(a-b),a)\n```\n => log(a-b), which is correct\n\n```\nintegrate(1/(a-c*b),a)\n```\n => log(c*b-a), which is *incorrect*.\n\n```\nSympy.integrate(1/(a-c*b),a)\n=> log(a-c*b), which is correct.\n``` \n\nAs SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backend translation used by the integrate function.\n\nI assume this should also be reported upstream, but I do not know how to verify that it really is an upstream error.\n\nKeywords: **integration, 1/x, maxima**\n\nStopgaps: **use `algorithm='sympy'` in the integrate call**\n\nAuthor: **gutow**\n\nComponent: **calculus**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28431_\n\n",
    "created_at": "2019-08-30T15:03:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20calculus",
        "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/wishlist%20item"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "integrate(1/(a-c*b),a) incorrect",
    "type": "issue",
    "updated_at": "2021-03-25T16:16:22Z",
    "url": "https://github.com/sagemath/sage/issues/28431",
    "user": "https://github.com/gutow"
}
```
This appears to be a maxima related error.

```
integrate(1/(a-b),a)
```
 => log(a-b), which is correct

```
integrate(1/(a-c*b),a)
```
 => log(c*b-a), which is *incorrect*.

```
Sympy.integrate(1/(a-c*b),a)
=> log(a-c*b), which is correct.
``` 

As SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backend translation used by the integrate function.

I assume this should also be reported upstream, but I do not know how to verify that it really is an upstream error.

Keywords: **integration, 1/x, maxima**

Stopgaps: **use `algorithm='sympy'` in the integrate call**

Author: **gutow**

Component: **calculus**

_Issue created by migration from https://trac.sagemath.org/ticket/28431_





---

archive/issue_events_392115.json:
```json
{
    "actor": "https://github.com/gutow",
    "created_at": "2019-08-30T15:03:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392115"
}
```



---

archive/issue_events_392116.json:
```json
{
    "actor": "https://github.com/gutow",
    "created_at": "2019-08-30T15:03:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20calculus",
    "label_color": "0000ff",
    "label_name": "c: calculus",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392116"
}
```



---

archive/issue_events_392117.json:
```json
{
    "actor": "https://github.com/gutow",
    "created_at": "2019-08-30T15:03:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392117"
}
```



---

archive/issue_events_392118.json:
```json
{
    "actor": "https://github.com/gutow",
    "created_at": "2019-08-30T15:03:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392118"
}
```



---

archive/issue_comments_442841.json:
```json
{
    "body": "Stopgaps: **use `algorithm='sympy'` in the integrate call**",
    "created_at": "2019-08-30T17:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442841",
    "user": "https://github.com/gutow"
}
```

Stopgaps: **use `algorithm='sympy'` in the integrate call**



---

archive/issue_comments_442842.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This appears to be a Macsyma related error.\n+This appears to be a maxima related error.\n \n ```\n integrate(1/(a-b),a)\n``````\n",
    "created_at": "2019-08-30T17:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442842",
    "user": "https://github.com/gutow"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This appears to be a Macsyma related error.
+This appears to be a maxima related error.
 
 ```
 integrate(1/(a-b),a)
``````




---

archive/issue_comments_442843.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI believe I have isolated this to maxima or how Sage is using it.\n\nIncorrect:\n\n```\n>integrate(1/(a-b*n),a, algorithm='maxima')\nlog(b*n - a)\n```\n\nCorrect:\n\n```\n>integrate(1/(a-b*n),a, algorithm='sympy')\nlog(-b*n + a)\n```",
    "created_at": "2019-08-30T17:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442843",
    "user": "https://github.com/gutow"
}
```

<div id="comment:1" align="right">comment:1</div>

I believe I have isolated this to maxima or how Sage is using it.

Incorrect:

```
>integrate(1/(a-b*n),a, algorithm='maxima')
log(b*n - a)
```

Correct:

```
>integrate(1/(a-b*n),a, algorithm='sympy')
log(-b*n + a)
```



---

archive/issue_comments_442844.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,6 +15,6 @@\n => log(a-c*b), which is correct.\n ``` \n \n-As SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backed translation used by the integrate function.\n+As SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backend translation used by the integrate function.\n \n I assume this should also be reported upstream, but I do not know how to verify that it really is an upstream error.\n``````\n",
    "created_at": "2019-08-30T17:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442844",
    "user": "https://github.com/gutow"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,6 +15,6 @@
 => log(a-c*b), which is correct.
 ``` 
 
-As SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backed translation used by the integrate function.
+As SymPy does this correctly can we get a quick fix by rerouting 1/x type integrals through SymPy? I am not familiar with the details of the backend translation used by the integrate function.
 
 I assume this should also be reported upstream, but I do not know how to verify that it really is an upstream error.
``````




---

archive/issue_events_392119.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-11-20T18:37:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392119"
}
```



---

archive/issue_events_392120.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-11-20T18:37:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392120"
}
```



---

archive/issue_comments_442845.json:
```json
{
    "body": "Changed keywords from **integration, 1/x** to **integration, 1/x, maxima**",
    "created_at": "2019-11-20T18:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442845",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changed keywords from **integration, 1/x** to **integration, 1/x, maxima**



---

archive/issue_comments_442846.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe problem may be with our translation from `maxima`, which, by itself, behaves correctly:\n\n```\ncharpent@p-202-021:~$ sage -maxima\n;;; Loading #P\"/usr/local/sage-python3/local/lib/ecl/sb-bsd-sockets.fas\"\n;;; Loading #P\"/usr/local/sage-python3/local/lib/ecl/sockets.fas\"\n;;; Loading #P\"/usr/local/sage-python3/local/lib/ecl/defsystem.fas\"\n;;; Loading #P\"/usr/local/sage-python3/local/lib/ecl/cmp.fas\"\nMaxima 5.42.2 http://maxima.sourceforge.net\nusing Lisp ECL 16.1.2\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) integrate(1/(a-b*c),a);\n(%o1)                            log(a - b c)\n```\nwhich is **correct**. And, BTW:\n\n```\n(%i5) diff(integrate(1/(a-b*c),a),a);\n\n(%o5) 1/(a-b*c)\n```\nalso correct.\n\n**EDIT :** This is **not** yet another effect of `domain:complex`:\n\n```\n(%i7) domain:complex;              \n\n(%o7) complex\n(%i8) integrate(1/(a-b*c),a);\n\n(%o8) log(a-b*c)\n```\nwhich is again correct...\n\nFurthermore:\n\n```\nsage: var(\"a, b, c\")\n(a, b, c)\nsage: integrate(1/(a-c*b),a)\nlog(b*c - a)                           /* Wrong */\nsage: integrate(1/(a-c*b),a).diff(a)\n-1/(b*c - a)                           /* CORRECT ??? */\n```\n\nTwo wrongs make one right ??? \n\nThis is, IMHO, a seemingly innocuous sign of a serious problem in a basic ability. I raise the priority to `critical`.",
    "created_at": "2019-11-20T18:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442846",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:3" align="right">comment:3</div>

The problem may be with our translation from `maxima`, which, by itself, behaves correctly:

```
charpent@p-202-021:~$ sage -maxima
;;; Loading #P"/usr/local/sage-python3/local/lib/ecl/sb-bsd-sockets.fas"
;;; Loading #P"/usr/local/sage-python3/local/lib/ecl/sockets.fas"
;;; Loading #P"/usr/local/sage-python3/local/lib/ecl/defsystem.fas"
;;; Loading #P"/usr/local/sage-python3/local/lib/ecl/cmp.fas"
Maxima 5.42.2 http://maxima.sourceforge.net
using Lisp ECL 16.1.2
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) integrate(1/(a-b*c),a);
(%o1)                            log(a - b c)
```
which is **correct**. And, BTW:

```
(%i5) diff(integrate(1/(a-b*c),a),a);

(%o5) 1/(a-b*c)
```
also correct.

**EDIT :** This is **not** yet another effect of `domain:complex`:

```
(%i7) domain:complex;              

(%o7) complex
(%i8) integrate(1/(a-b*c),a);

(%o8) log(a-b*c)
```
which is again correct...

Furthermore:

```
sage: var("a, b, c")
(a, b, c)
sage: integrate(1/(a-c*b),a)
log(b*c - a)                           /* Wrong */
sage: integrate(1/(a-c*b),a).diff(a)
-1/(b*c - a)                           /* CORRECT ??? */
```

Two wrongs make one right ??? 

This is, IMHO, a seemingly innocuous sign of a serious problem in a basic ability. I raise the priority to `critical`.



---

archive/issue_comments_442847.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI think that `integrate(1/(x-a), x)` should actually be `log(abs(x-a))`, because for `x < a` the expression `log(x-a)` doesn't make much sense, does it?",
    "created_at": "2019-11-20T19:26:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442847",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:4" align="right">comment:4</div>

I think that `integrate(1/(x-a), x)` should actually be `log(abs(x-a))`, because for `x < a` the expression `log(x-a)` doesn't make much sense, does it?



---

archive/issue_comments_442848.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI think the simplification\n\n```\nsage: 1/(a-b*c)\n-1/(b*c - a)\n```\nexplains this. In maxima:\n\n```\n(%i1) integrate( -1/(b*c-a), a);\n(%o1)                            log(b c - a)\n```\nWe're not doing anything wrong. It's really down to branch choice. (having `log(abs(x-a))` as antiderivative doesn't play nice with complex analytic computations)\nFurthermore,\n\n```\nsage: log(b*c-a).diff(a)\n-1/(b*c - a)\n```\nis just correct.\n\nThis is just us using a monomial ordering and a normalization of rational functions that leads maxima to choosing a branch for an antiderivative that doesn't match what you might expect to be chosen naively.",
    "created_at": "2019-11-20T20:44:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442848",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:5" align="right">comment:5</div>

I think the simplification

```
sage: 1/(a-b*c)
-1/(b*c - a)
```
explains this. In maxima:

```
(%i1) integrate( -1/(b*c-a), a);
(%o1)                            log(b c - a)
```
We're not doing anything wrong. It's really down to branch choice. (having `log(abs(x-a))` as antiderivative doesn't play nice with complex analytic computations)
Furthermore,

```
sage: log(b*c-a).diff(a)
-1/(b*c - a)
```
is just correct.

This is just us using a monomial ordering and a normalization of rational functions that leads maxima to choosing a branch for an antiderivative that doesn't match what you might expect to be chosen naively.



---

archive/issue_comments_442849.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@mantepse](#comment:4):\n> I think that `integrate(1/(x-a), x)` should actually be `log(abs(x-a))`, \n\nNope. Whereas\n\n```\nsage: with assuming (x, \"real\", a, \"real\"): (log(abs(x-a))).diff(x)\n-1/(a - x)\n```\n\nIn general, \n\n```\nsage: (log(abs(x-a))).diff(x)\n-1/2*(a - x + conjugate(a) - conjugate(x))/abs(-a + x)^2\n```\n\n> because for `x < a` the expression `log(x-a)` doesn't make much sense, does it?\n\nIt [does](https://en.wikipedia.org/wiki/Logarithm#Complex_logarithm). In the complex plane, and at the cost of choosing one among an infinity of solutions (branch choice).\n\nSeen another way, the *definite* integral `integrate(x-a),x,b, c`} does make sense, and can be  trivially computed (use the change of variable t=x-a), **except** if a+b<0 *and* a+c>0 : the function can't be integrated in x==a, and the integration constant has absolutely no reason to be the same on the two sides of this discontinuity. If you suppose that the two integration constants are the same, you obtain a [Cauchy principal value](https://en.wikipedia.org/wiki/Cauchy_principal_value), which is **not** a value of the integral.",
    "created_at": "2019-11-20T20:45:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442849",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@mantepse](#comment:4):
> I think that `integrate(1/(x-a), x)` should actually be `log(abs(x-a))`, 

Nope. Whereas

```
sage: with assuming (x, "real", a, "real"): (log(abs(x-a))).diff(x)
-1/(a - x)
```

In general, 

```
sage: (log(abs(x-a))).diff(x)
-1/2*(a - x + conjugate(a) - conjugate(x))/abs(-a + x)^2
```

> because for `x < a` the expression `log(x-a)` doesn't make much sense, does it?

It [does](https://en.wikipedia.org/wiki/Logarithm#Complex_logarithm). In the complex plane, and at the cost of choosing one among an infinity of solutions (branch choice).

Seen another way, the *definite* integral `integrate(x-a),x,b, c`} does make sense, and can be  trivially computed (use the change of variable t=x-a), **except** if a+b<0 *and* a+c>0 : the function can't be integrated in x==a, and the integration constant has absolutely no reason to be the same on the two sides of this discontinuity. If you suppose that the two integration constants are the same, you obtain a [Cauchy principal value](https://en.wikipedia.org/wiki/Cauchy_principal_value), which is **not** a value of the integral.



---

archive/issue_comments_442850.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@nbruin](#comment:5):\n> I think the simplification\n> \n> ```\n> sage: 1/(a-b*c)\n> -1/(b*c - a)\n> ```\n> explains this. In maxima:\n> \n> ```\n> (%i1) integrate( -1/(b*c-a), a);\n> (%o1)                            log(b c - a)\n> ```\n\nThis is *another* (Maxima's) error.\n\n> We're not doing anything wrong.\n\nSo, why are we obtaining the *opposite* of the expected result (which is *correctly* given by Maxima) *in the original case* ?\n\nBecause *we* are passing a \"simplified\" operand, which sends us in Maxima's trap.\n\nNot our fault ?\n\n> It's really down to branch choice. (having `log(abs(x-a))` as antiderivative doesn't play nice with complex analytic computations)\n\nNope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...",
    "created_at": "2019-11-20T20:51:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442850",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@nbruin](#comment:5):
> I think the simplification
> 
> ```
> sage: 1/(a-b*c)
> -1/(b*c - a)
> ```
> explains this. In maxima:
> 
> ```
> (%i1) integrate( -1/(b*c-a), a);
> (%o1)                            log(b c - a)
> ```

This is *another* (Maxima's) error.

> We're not doing anything wrong.

So, why are we obtaining the *opposite* of the expected result (which is *correctly* given by Maxima) *in the original case* ?

Because *we* are passing a "simplified" operand, which sends us in Maxima's trap.

Not our fault ?

> It's really down to branch choice. (having `log(abs(x-a))` as antiderivative doesn't play nice with complex analytic computations)

Nope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...



---

archive/issue_comments_442851.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@EmmanuelCharpentier](#comment:6):\n\nTo illustrate, compare:\n\n```\nsage: integrate(1/x, x, -3, -1)\n-log(3)\nsage: integrate(1/x, x, -3, 1)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n\n[ Snip... ]\n\nValueError: Integral is divergent.\n```",
    "created_at": "2019-11-20T20:57:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442851",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@EmmanuelCharpentier](#comment:6):

To illustrate, compare:

```
sage: integrate(1/x, x, -3, -1)
-log(3)
sage: integrate(1/x, x, -3, 1)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)

[ Snip... ]

ValueError: Integral is divergent.
```



---

archive/issue_comments_442852.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@EmmanuelCharpentier](#comment:8):\n\nAnother illustration (to show that Maxima tries to give us a principal value, on whoch Sage chokes):\n\n```\nsage: %maxima integrate(1/x, x, -3, 1)\n---------------------------------------------------------------------------\n\n[ Snip ... ]\n\nTypeError: error evaluating \"integrate(1/x,x,-3,1)\":\nError executing code in Maxima\nCODE:\n\tintegrate(1/x,x,-3,1);\nMaxima ERROR:\n\tPrincipal Value\n(%o67) -log(3)\n```",
    "created_at": "2019-11-20T21:05:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442852",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@EmmanuelCharpentier](#comment:8):

Another illustration (to show that Maxima tries to give us a principal value, on whoch Sage chokes):

```
sage: %maxima integrate(1/x, x, -3, 1)
---------------------------------------------------------------------------

[ Snip ... ]

TypeError: error evaluating "integrate(1/x,x,-3,1)":
Error executing code in Maxima
CODE:
	integrate(1/x,x,-3,1);
Maxima ERROR:
	Principal Value
(%o67) -log(3)
```



---

archive/issue_comments_442853.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSorry about my mistake, I thought that we were playing in the reals.",
    "created_at": "2019-11-20T21:32:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442853",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:10" align="right">comment:10</div>

Sorry about my mistake, I thought that we were playing in the reals.



---

archive/issue_comments_442854.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@EmmanuelCharpentier](#comment:7):\n> Nope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...\n\n\n```\nlog( b*c -a ) = log ( (-1) *(a-b*c))= log(-1) + log(a-b*c)\n```\nso, with certain branch choices they do differ by a constant and therefore have the same derivative; and the derivative has no complicated branch choices. Hence, `log(a-b*c)` and `log(b*c-a)` are both valid antiderivatives.",
    "created_at": "2019-11-20T22:12:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442854",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@EmmanuelCharpentier](#comment:7):
> Nope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...


```
log( b*c -a ) = log ( (-1) *(a-b*c))= log(-1) + log(a-b*c)
```
so, with certain branch choices they do differ by a constant and therefore have the same derivative; and the derivative has no complicated branch choices. Hence, `log(a-b*c)` and `log(b*c-a)` are both valid antiderivatives.



---

archive/issue_comments_442855.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@mantepse](#comment:10):\n> Sorry about my mistake, I thought that we were playing in the reals.\n\nMost of Sage's (and Maxima's) symbolic functions aim to play with complexes. Roughly speaking, they assume that SR element are complexes. Hence the difference in x.log().abs().diff() with and without assumptions about x...\n\nFor example:\n\n```\nsage: PolynomialRing(QQ,\"x\")(x^2+1).is_irreducible()\nTrue\nsage: PolynomialRing(QQbar,\"x\")(x^2+1).is_irreducible()\nFalse\nsage: PolynomialRing(SR,\"x\")(x^2+1).is_irreducible()\nFalse\n```\n\nBut note that:\n\n```\nsage: (x^2+1).is_irreducible()\n\n[ Snip ... ]\n\nAttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'is_irreducible'\n```\n\nSo these rules are not cast in stone...",
    "created_at": "2019-11-20T22:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442855",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@mantepse](#comment:10):
> Sorry about my mistake, I thought that we were playing in the reals.

Most of Sage's (and Maxima's) symbolic functions aim to play with complexes. Roughly speaking, they assume that SR element are complexes. Hence the difference in x.log().abs().diff() with and without assumptions about x...

For example:

```
sage: PolynomialRing(QQ,"x")(x^2+1).is_irreducible()
True
sage: PolynomialRing(QQbar,"x")(x^2+1).is_irreducible()
False
sage: PolynomialRing(SR,"x")(x^2+1).is_irreducible()
False
```

But note that:

```
sage: (x^2+1).is_irreducible()

[ Snip ... ]

AttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'is_irreducible'
```

So these rules are not cast in stone...



---

archive/issue_comments_442856.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@nbruin](#comment:11):\n> Replying to [@EmmanuelCharpentier](#comment:7):\n> > Nope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...\n\n> \n> ```\n> log( b*c -a ) = log ( (-1) *(a-b*c))= log(-1) + log(a-b*c)\n> ```\n> so, with certain branch choices they do differ by a constant and therefore have the same derivative; and the derivative has no complicated branch choices. Hence, `log(a-b*c)` and `log(b*c-a)` are both valid antiderivatives.\n\nDamn... You're right !\n\nI stand corrected.\n\nBut still:\n\n```\nsage: with assuming(a, \"real\", b, \"real\", c, \"real\"): (1/(a - b*c)).integrate(a)\nlog(b*c - a)\n```\nis hard to swallow... Choosing `I*pi` as an integration constant in a problem involving real quantities is a stretch of imagination...\n\nBut that's a nice excuse for any undergrad committing an error of sign in an integration problem. Which, BTW, won't hold in the case of *definite* integration.",
    "created_at": "2019-11-20T22:26:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442856",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@nbruin](#comment:11):
> Replying to [@EmmanuelCharpentier](#comment:7):
> > Nope : unless I'm sorely mistaken (which is always possible), a branch choice problem would leave us with a constant (pure imaginary in this case, I believe)  added to the correct value, *not* its opposite...

> 
> ```
> log( b*c -a ) = log ( (-1) *(a-b*c))= log(-1) + log(a-b*c)
> ```
> so, with certain branch choices they do differ by a constant and therefore have the same derivative; and the derivative has no complicated branch choices. Hence, `log(a-b*c)` and `log(b*c-a)` are both valid antiderivatives.

Damn... You're right !

I stand corrected.

But still:

```
sage: with assuming(a, "real", b, "real", c, "real"): (1/(a - b*c)).integrate(a)
log(b*c - a)
```
is hard to swallow... Choosing `I*pi` as an integration constant in a problem involving real quantities is a stretch of imagination...

But that's a nice excuse for any undergrad committing an error of sign in an integration problem. Which, BTW, won't hold in the case of *definite* integration.



---

archive/issue_comments_442857.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nSo Sage needs to be clear about what conditions the solution holds for. It should also work correctly if forced to use real numbers and get the sign correct without a hidden constant of integration. If Maxima can handle this Sage should too.",
    "created_at": "2019-11-21T00:44:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442857",
    "user": "https://github.com/gutow"
}
```

<div id="comment:14" align="right">comment:14</div>

So Sage needs to be clear about what conditions the solution holds for. It should also work correctly if forced to use real numbers and get the sign correct without a hidden constant of integration. If Maxima can handle this Sage should too.



---

archive/issue_comments_442858.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:\n\n```\n>(1/(a-b)).integrate(a)\n   [log(a-b),log(b-a)]\n```\nas when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.\n\nI am not sure about how this generalizes.",
    "created_at": "2019-12-03T02:48:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442858",
    "user": "https://github.com/gutow"
}
```

<div id="comment:15" align="right">comment:15</div>

Thinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:

```
>(1/(a-b)).integrate(a)
   [log(a-b),log(b-a)]
```
as when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.

I am not sure about how this generalizes.



---

archive/issue_comments_442859.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@gutow](#comment:15):\n> Thinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:\n> \n> ```\n> >(1/(a-b)).integrate(a)\n>    [log(a-b),log(b-a)]\n> ```\n> as when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.\n> \n> I am not sure about how this generalizes.\n\nIt doesn't. This is exactly what integration constants express. You'd have to give an uncountable set of antiderivatives.",
    "created_at": "2019-12-03T03:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442859",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@gutow](#comment:15):
> Thinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:
> 
> ```
> >(1/(a-b)).integrate(a)
>    [log(a-b),log(b-a)]
> ```
> as when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.
> 
> I am not sure about how this generalizes.

It doesn't. This is exactly what integration constants express. You'd have to give an uncountable set of antiderivatives.



---

archive/issue_comments_442860.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@nbruin](#comment:16):\n> Replying to [@gutow](#comment:15):\n> > Thinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:\n> > \n> > ```\n> > >(1/(a-b)).integrate(a)\n> >    [log(a-b),log(b-a)]\n> > ```\n> > as when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.\n> > \n> > I am not sure about how this generalizes.\n\n> \n> It doesn't. This is exactly what integration constants express. You'd have to give an uncountable set of antiderivatives.\n\nDuh! Of course, it doesn't generalize. I get my dunce hat for this one!\n\nI am beginning to lean towards some kind of \"domain\" control as discussed on sage-devel. I can see `algorithm='maxima_real' or 'sympy_real'` as easy to use. The default should remain the complex domain. To facilitate usability by people like me (physical scientists and their students) the default domain needs to be stated up-front in the documentation for integrate.\n\nAs was discussed in the sage-devel thread, I am not clear this solves all the issues. However, it ought to help with the issue of log in the real domain requiring a positive real number input. I would expect it to trigger an error requiring an assumption about whether a > b or not.",
    "created_at": "2019-12-03T04:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442860",
    "user": "https://github.com/gutow"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@nbruin](#comment:16):
> Replying to [@gutow](#comment:15):
> > Thinking on this a little more, another option that does not hide a mysterious choice of integration constants, such as log(-1), would be to provide multiple valid integrations. I'm thinking of behavior something like this:
> > 
> > ```
> > >(1/(a-b)).integrate(a)
> >    [log(a-b),log(b-a)]
> > ```
> > as when reporting other results with multiple valid solutions. This would leave the user to pick the correct one for their situation. If they are limited to real numbers then they would pick the version that provides positive input to the log function.
> > 
> > I am not sure about how this generalizes.

> 
> It doesn't. This is exactly what integration constants express. You'd have to give an uncountable set of antiderivatives.

Duh! Of course, it doesn't generalize. I get my dunce hat for this one!

I am beginning to lean towards some kind of "domain" control as discussed on sage-devel. I can see `algorithm='maxima_real' or 'sympy_real'` as easy to use. The default should remain the complex domain. To facilitate usability by people like me (physical scientists and their students) the default domain needs to be stated up-front in the documentation for integrate.

As was discussed in the sage-devel thread, I am not clear this solves all the issues. However, it ought to help with the issue of log in the real domain requiring a positive real number input. I would expect it to trigger an error requiring an assumption about whether a > b or not.



---

archive/issue_events_392121.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392121"
}
```



---

archive/issue_events_392122.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392122"
}
```



---

archive/issue_comments_442861.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442861",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

Ticket retargeted after milestone closed



---

archive/issue_events_392123.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-07T02:29:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392123"
}
```



---

archive/issue_events_392124.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-07T02:29:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392124"
}
```



---

archive/issue_events_392125.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392125"
}
```



---

archive/issue_events_392126.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392126"
}
```



---

archive/issue_comments_442862.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI'm not even sure this is an error, but at any rate this is not critical, given that (up to integration constants and branch choice) this is correct.\n\nAs to documentation, there are a few places where we do mention this (IIRC).  We haven't apologized for it, and I don't think we have to, but it's certainly true that it's confusing, and adding to the documentation in some *visible* places would be salutary.",
    "created_at": "2021-03-25T12:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442862",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:21" align="right">comment:21</div>

I'm not even sure this is an error, but at any rate this is not critical, given that (up to integration constants and branch choice) this is correct.

As to documentation, there are a few places where we do mention this (IIRC).  We haven't apologized for it, and I don't think we have to, but it's certainly true that it's confusing, and adding to the documentation in some *visible* places would be salutary.



---

archive/issue_events_392127.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2021-03-25T12:34:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392127"
}
```



---

archive/issue_events_392128.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2021-03-25T12:34:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392128"
}
```



---

archive/issue_comments_442863.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nAlso, to Jonathan's suggestion, it seems like making the context in [comment:6](#comment:6) more advertised would be useful.  But since neither Sympy nor Maxima add the absolute value, I'm not sure if that aspect is really 'fixable'.",
    "created_at": "2021-03-25T12:40:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442863",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:22" align="right">comment:22</div>

Also, to Jonathan's suggestion, it seems like making the context in [comment:6](#comment:6) more advertised would be useful.  But since neither Sympy nor Maxima add the absolute value, I'm not sure if that aspect is really 'fixable'.



---

archive/issue_comments_442864.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@kcrisman](#comment:22):\n> Also, to Jonathan's suggestion, it seems like making the context in [comment:6](#comment:6) more advertised would be useful.  But since neither Sympy nor Maxima add the absolute value, I'm not sure if that aspect is really 'fixable'.\n\nFrom a practical usability perspective, I still think there should be a way to request the domain of the result, in addition to being much clearer about how the branch was chosen.",
    "created_at": "2021-03-25T15:07:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442864",
    "user": "https://github.com/gutow"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@kcrisman](#comment:22):
> Also, to Jonathan's suggestion, it seems like making the context in [comment:6](#comment:6) more advertised would be useful.  But since neither Sympy nor Maxima add the absolute value, I'm not sure if that aspect is really 'fixable'.

From a practical usability perspective, I still think there should be a way to request the domain of the result, in addition to being much clearer about how the branch was chosen.



---

archive/issue_comments_442865.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThat may be true, but if Maxima and Sympy don't, I'm not sure how we can :(",
    "created_at": "2021-03-25T15:27:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442865",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:24" align="right">comment:24</div>

That may be true, but if Maxima and Sympy don't, I'm not sure how we can :(



---

archive/issue_events_392129.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-25T16:16:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392129"
}
```



---

archive/issue_events_392130.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-25T16:16:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28431#event-392130"
}
```



---

archive/issue_comments_442866.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nCould open an issue with https://github.com/sympy/sympy expressing this feature request.",
    "created_at": "2021-03-25T16:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28431#issuecomment-442866",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

Could open an issue with https://github.com/sympy/sympy expressing this feature request.
