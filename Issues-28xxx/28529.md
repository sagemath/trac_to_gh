# Issue 28529: Some micro-optimizations related to univariate polynomials

archive/issues_028292.json:
```json
{
    "body": "\n\n**CC:**  @roed314 @orlitzky\n\n**Branch/Commit:** [d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Marc Mezzarobba\n\nIssue created by migration from https://trac.sagemath.org/ticket/28529\n\n",
    "closed_at": "2020-08-30T08:38:38Z",
    "created_at": "2019-09-23T08:14:47Z",
    "labels": [
        "component: performance",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Some micro-optimizations related to univariate polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28529",
    "user": "https://github.com/mezzarobba"
}
```


**CC:**  @roed314 @orlitzky

**Branch/Commit:** [d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)

**Reviewer:** Travis Scrimshaw

**Author:** Marc Mezzarobba

Issue created by migration from https://trac.sagemath.org/ticket/28529





---

archive/issue_comments_529168.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-09-23T08:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529168",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_529169.json:
```json
{
    "body": "<a id='comment:2'></a>\n\n```\nFile \"src/sage/rings/polynomial/polynomial_element.pyx\", line 1164, in sage.rings.polynomial.polynomial_element.Polynomial._cache_key\nFailed example:\n    foo(x)\nExpected:\n    (1 + O(2^20))*x\nGot:\n    x\n```\n\nHmmm, so if I understand right, a p-adic polynomial `f` that prints as `(1 + O(2^20))*x` satisfies `f.is_gen()`. Is that intentional?",
    "created_at": "2019-09-23T13:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529169",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:2'></a>

```
File "src/sage/rings/polynomial/polynomial_element.pyx", line 1164, in sage.rings.polynomial.polynomial_element.Polynomial._cache_key
Failed example:
    foo(x)
Expected:
    (1 + O(2^20))*x
Got:
    x
```

Hmmm, so if I understand right, a p-adic polynomial `f` that prints as `(1 + O(2^20))*x` satisfies `f.is_gen()`. Is that intentional?



---

archive/issue_comments_529170.json:
```json
{
    "body": "<a id='comment:3'></a>\nYep, that's intentional.  For capped-relative and capped-absolute p-adic rings, we don't have an exact 1.  So `(1 + O(2^20))*x` is as close to it as possible, and we mark it as the generator.  I don't know what would be broken by changing this, so perhaps the easiest fix is to check for the base ring being exact when you return the name.",
    "created_at": "2019-09-23T14:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529170",
    "user": "https://github.com/roed314"
}
```

<a id='comment:3'></a>
Yep, that's intentional.  For capped-relative and capped-absolute p-adic rings, we don't have an exact 1.  So `(1 + O(2^20))*x` is as close to it as possible, and we mark it as the generator.  I don't know what would be broken by changing this, so perhaps the easiest fix is to check for the base ring being exact when you return the name.



---

archive/issue_comments_529171.json:
```json
{
    "body": "<a id='comment:4'></a>\nWhy did you change the evaluation code?",
    "created_at": "2019-10-25T04:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529171",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
Why did you change the evaluation code?



---

archive/issue_comments_529172.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [vdelecroix](#comment%3A4):\n> Why did you change the evaluation code?\n\n\nTo make it a little bit faster. I'm not sure I understand the question, sorry. And I don't remember the details, but I think it had to do with the cost of going through an fmpz vs an mpz.",
    "created_at": "2019-10-25T12:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529172",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:5'></a>
Replying to [vdelecroix](#comment%3A4):
> Why did you change the evaluation code?


To make it a little bit faster. I'm not sure I understand the question, sorry. And I don't remember the details, but I think it had to do with the cost of going through an fmpz vs an mpz.



---

archive/issue_events_080621.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28529#event-80621"
}
```



---

archive/issue_comments_529173.json:
```json
{
    "body": "<a id='comment:6'></a>\nTicket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529173",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Ticket retargeted after milestone closed



---

archive/issue_comments_529174.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?",
    "created_at": "2020-02-26T15:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529174",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:7'></a>
The p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?



---

archive/issue_events_080622.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28529#event-80622"
}
```



---

archive/issue_events_080623.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28529#event-80623"
}
```



---

archive/issue_comments_529175.json:
```json
{
    "body": "<a id='comment:8'></a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529175",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_529176.json:
```json
{
    "body": "<a id='comment:9'></a>\npatchbot indicates doctest errors",
    "created_at": "2020-08-18T21:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529176",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
patchbot indicates doctest errors



---

archive/issue_comments_529177.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2020-08-18T21:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529177",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_529178.json:
```json
{
    "body": "**Changing commit** from \"[396d67282480df0efe826093affcfcaf0d6ee77a](https://github.com/sagemath/sagetrac-mirror/commit/396d67282480df0efe826093affcfcaf0d6ee77a)\" to \"[176f6e1185026d67b94699157e70dbc5f6dcd87d](https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d)\".",
    "created_at": "2020-08-19T07:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529178",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[396d67282480df0efe826093affcfcaf0d6ee77a](https://github.com/sagemath/sagetrac-mirror/commit/396d67282480df0efe826093affcfcaf0d6ee77a)" to "[176f6e1185026d67b94699157e70dbc5f6dcd87d](https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d)".



---

archive/issue_comments_529179.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/532aa78f084481a52e3d1127e569b356c64e66f1\">532aa78</a></td><td><code>slightly faster eval of pol \u2208 \u211a[x] at Python int</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d\">176f6e1</a></td><td><code>fast path for the generator in generic polynomial _repr_()</code></td></tr></table>\n",
    "created_at": "2020-08-19T07:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529179",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/532aa78f084481a52e3d1127e569b356c64e66f1">532aa78</a></td><td><code>slightly faster eval of pol ∈ ℚ[x] at Python int</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d">176f6e1</a></td><td><code>fast path for the generator in generic polynomial _repr_()</code></td></tr></table>




---

archive/issue_comments_529180.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [mjo](#comment%3A7):\n> The p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?\n\n\nI guess it was a mistake. I fixed it and added an exception for polynomials over p-adic parents.",
    "created_at": "2020-08-19T07:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529180",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:11'></a>
Replying to [mjo](#comment%3A7):
> The p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?


I guess it was a mistake. I fixed it and added an exception for polynomials over p-adic parents.



---

archive/issue_comments_529181.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2020-08-19T07:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529181",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_529182.json:
```json
{
    "body": "<a id='comment:12'></a>\nCan you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?",
    "created_at": "2020-08-20T23:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529182",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
Can you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?



---

archive/issue_comments_529183.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tscrim](#comment%3A12):\n> Can you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?\n\n\nI assume you are talking about the code for evaluation at integers. There are timings in the commit message. I don't remember why I thought my version would be faster (it was a year ago...), but I suppose part of the explanation must be that `fmpq_poly_evaluate_mpz` does more or less the same conversions that my version is doing and requires temporary objects as well.",
    "created_at": "2020-08-21T06:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529183",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:13'></a>
Replying to [tscrim](#comment%3A12):
> Can you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?


I assume you are talking about the code for evaluation at integers. There are timings in the commit message. I don't remember why I thought my version would be faster (it was a year ago...), but I suppose part of the explanation must be that `fmpq_poly_evaluate_mpz` does more or less the same conversions that my version is doing and requires temporary objects as well.



---

archive/issue_comments_529184.json:
```json
{
    "body": "<a id='comment:14'></a>\nOkay, well, let it be so.",
    "created_at": "2020-08-21T08:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529184",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Okay, well, let it be so.



---

archive/issue_comments_529185.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2020-08-21T08:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529185",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_529186.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2020-08-21T08:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529186",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_529187.json:
```json
{
    "body": "<a id='comment:15'></a>\nCan you also please add a comment about the p-adic line,\n\n```\nif self._is_gen and not isinstance(self._parent._base, pAdicGeneric)\n```\n\nOtherwise that's going to look very mysterious out of context.",
    "created_at": "2020-08-21T11:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529187",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>
Can you also please add a comment about the p-adic line,

```
if self._is_gen and not isinstance(self._parent._base, pAdicGeneric)
```

Otherwise that's going to look very mysterious out of context.



---

archive/issue_comments_529188.json:
```json
{
    "body": "**Changing commit** from \"[176f6e1185026d67b94699157e70dbc5f6dcd87d](https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d)\" to \"[d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)\".",
    "created_at": "2020-08-26T09:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529188",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[176f6e1185026d67b94699157e70dbc5f6dcd87d](https://github.com/sagemath/sagetrac-mirror/commit/176f6e1185026d67b94699157e70dbc5f6dcd87d)" to "[d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)".



---

archive/issue_comments_529189.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** This was a forced push. **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254\">d29e166</a></td><td><code>fast path for the generator in generic polynomial _repr_()</code></td></tr></table>\n",
    "created_at": "2020-08-26T09:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** This was a forced push. **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254">d29e166</a></td><td><code>fast path for the generator in generic polynomial _repr_()</code></td></tr></table>




---

archive/issue_comments_529190.json:
```json
{
    "body": "**Changing status** from positive_review to needs_review.",
    "created_at": "2020-08-26T09:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing status** from positive_review to needs_review.



---

archive/issue_comments_529191.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [mjo](#comment%3A15):\n> Can you also please add a comment about the p-adic line,\n> \n> ```\n> if self._is_gen and not isinstance(self._parent._base, pAdicGeneric)\n> ```\n\n\nDone; thanks for the remark!",
    "created_at": "2020-08-26T09:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529191",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:17'></a>
Replying to [mjo](#comment%3A15):
> Can you also please add a comment about the p-adic line,
> 
> ```
> if self._is_gen and not isinstance(self._parent._base, pAdicGeneric)
> ```


Done; thanks for the remark!



---

archive/issue_comments_529192.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2020-08-26T09:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529192",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_529193.json:
```json
{
    "body": "<a id='comment:18'></a>\nI am taking the liberty of leaving the ticket marked as positive_review since all my last push does was to add the requested comment without changing the code.",
    "created_at": "2020-08-26T09:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529193",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:18'></a>
I am taking the liberty of leaving the ticket marked as positive_review since all my last push does was to add the requested comment without changing the code.



---

archive/issue_events_080624.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-30T08:38:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28529#event-80624"
}
```



---

archive/issue_comments_529194.json:
```json
{
    "body": "**Changing branch** from \"[u/mmezzarobba/poly_micro-opt](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/poly_micro-opt)\" to \"[d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)\".",
    "created_at": "2020-08-30T08:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28529",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28529#issuecomment-529194",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mmezzarobba/poly_micro-opt](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/poly_micro-opt)" to "[d29e166edb692179b386468c22d3aab07ffa8254](https://github.com/sagemath/sagetrac-mirror/commit/d29e166edb692179b386468c22d3aab07ffa8254)".
