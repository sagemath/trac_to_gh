# Issue 28287: alarm test failure in CombinatorialPolyhedron.f_vector

archive/issues_028050.json:
```json
{
    "body": "Ever since the merging of #26887 I get this one test failure:\n\n```\nsage -t --long --warn-long 157.3 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx\", line 1132, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector\nFailed example:\n    try:\n        alarm(0.5)\n        C.f_vector()\n    except:\n        print(\"alarm!\")\nExpected:\n    alarm!\nGot:\n    (1,\n     25,\n     300,\n     2300,\n     12650,\n     53130,\n     177100,\n     480700,\n     1081575,\n     2042975,\n     3268760,\n     4457400,\n     5200300,\n     5200300,\n     4457400,\n     3268760,\n     2042975,\n     1081575,\n     480700,\n     177100,\n     53130,\n     12650,\n     2300,\n     300,\n     25,\n     1)\n**********************************************************************\n1 item had failures:\n   1 of  12 in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector\n    [324 tests, 1 failure, 6.49 s]\n```\n\nIt's a minor issue, but I mark the ticket priority as \"critical\" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).  I did check, to be certain, that lowering the alarm time in this test does cause it to pass for me. But that's no guarantee it won't still fail on an even faster machine.\n\nAlthough, if as [this comment](https://trac.sagemath.org/ticket/26887#comment:184) states, there is no explicit reason for these tests, I would just remove them.\n\nCC:  @kliem\n\nKeywords: f_vector, polytopes\n\nBranch/Commit: e62f499bbd3e4b08e1e70efe2d729dc89215eef2\n\nReviewer: Erik Bray\n\nAuthor: Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28287\n\n",
    "closed_at": "2019-08-04T07:25:33Z",
    "created_at": "2019-07-30T09:27:32Z",
    "labels": [
        "component: geometry",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "alarm test failure in CombinatorialPolyhedron.f_vector",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28287",
    "user": "https://github.com/embray"
}
```
Ever since the merging of #26887 I get this one test failure:

```
sage -t --long --warn-long 157.3 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx
**********************************************************************
File "src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx", line 1132, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector
Failed example:
    try:
        alarm(0.5)
        C.f_vector()
    except:
        print("alarm!")
Expected:
    alarm!
Got:
    (1,
     25,
     300,
     2300,
     12650,
     53130,
     177100,
     480700,
     1081575,
     2042975,
     3268760,
     4457400,
     5200300,
     5200300,
     4457400,
     3268760,
     2042975,
     1081575,
     480700,
     177100,
     53130,
     12650,
     2300,
     300,
     25,
     1)
**********************************************************************
1 item had failures:
   1 of  12 in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector
    [324 tests, 1 failure, 6.49 s]
```

It's a minor issue, but I mark the ticket priority as "critical" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).  I did check, to be certain, that lowering the alarm time in this test does cause it to pass for me. But that's no guarantee it won't still fail on an even faster machine.

Although, if as [this comment](https://trac.sagemath.org/ticket/26887#comment:184) states, there is no explicit reason for these tests, I would just remove them.

CC:  @kliem

Keywords: f_vector, polytopes

Branch/Commit: e62f499bbd3e4b08e1e70efe2d729dc89215eef2

Reviewer: Erik Bray

Author: Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28287





---

archive/issue_comments_550161.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -45,6 +45,6 @@\n     [324 tests, 1 failure, 6.49 s]\n ```\n \n-It's a minor issue, but I mark the ticket priority as \"critical\" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).\n+It's a minor issue, but I mark the ticket priority as \"critical\" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).  I did check, to be certain, that lowering the alarm time in this test does cause it to pass for me. But that's no guarantee it won't still fail on an even faster machine.\n \n Although, if as [this comment](https://trac.sagemath.org/ticket/26887#comment:184) states, there is no explicit reason for these tests, I would just remove them.\n``````\n",
    "created_at": "2019-07-30T09:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550161",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -45,6 +45,6 @@
     [324 tests, 1 failure, 6.49 s]
 ```
 
-It's a minor issue, but I mark the ticket priority as "critical" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).
+It's a minor issue, but I mark the ticket priority as "critical" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).  I did check, to be certain, that lowering the alarm time in this test does cause it to pass for me. But that's no guarantee it won't still fail on an even faster machine.
 
 Although, if as [this comment](https://trac.sagemath.org/ticket/26887#comment:184) states, there is no explicit reason for these tests, I would just remove them.
``````




---

archive/issue_comments_550162.json:
```json
{
    "body": "<a id='comment:2'></a>\nAlso I'll note that, in the process of trying to test this manually, I got bitten by [this issue](https://groups.google.com/d/msg/sage-devel/xjADjJJChtU/jzicLwjAFQAJ) again, which I see now that we never made a ticket for.  I'll go do that now.",
    "created_at": "2019-07-30T09:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550162",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Also I'll note that, in the process of trying to test this manually, I got bitten by [this issue](https://groups.google.com/d/msg/sage-devel/xjADjJJChtU/jzicLwjAFQAJ) again, which I see now that we never made a ticket for.  I'll go do that now.



---

archive/issue_comments_550163.json:
```json
{
    "body": "<a id='comment:3'></a>\nIn fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.",
    "created_at": "2019-07-30T09:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550163",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
In fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.



---

archive/issue_comments_550164.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [embray](#comment%3A3):\n> In fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.\n\n\nThere is nothing being cashed at that point. Also if there was something being cashed or `C.f_vector` would be faster than `alarm`, `alarm` would escape the `try ... except` environment and would cause sage to crash. This didn't seem to be the issue. (Also the specific calculation takes 1.92 s at my machine. As `f_vector` is not parallelized (yet), I doubt that your machine can do it under a second.)\n\nWhat I think is happening, is that the `alarm` is triggered, but has no effect. For some reason the alarm just vanishes and the procedure keeps on going. This would also explain many patchbot reports, where there is a timeout with this module.\n\nI don't seem to be the only one with this problem: https://patchbot.sagemath.org/log/27973/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-07-25%2015:09:25?short\n\nAs a resolution one could either figure out,\n- why `alarm` doesn't trigger anything in some cases (I don't think I will be successful with this) or\n- we can just delete all the tests including alarm interrupts in `CombinatorialPolyhedron` (as stated in the description of this ticket).\n\nI would prefer the second option, as the first depends on somebody with time and knowledge. We won't have a certificate anymore that the methods in `CombinatorialPolyhedron` can be interrupted, so we have to trust anyone making changes to not break the ability to interrupt.",
    "created_at": "2019-07-30T11:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550164",
    "user": "https://github.com/kliem"
}
```

<a id='comment:4'></a>
Replying to [embray](#comment%3A3):
> In fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.


There is nothing being cashed at that point. Also if there was something being cashed or `C.f_vector` would be faster than `alarm`, `alarm` would escape the `try ... except` environment and would cause sage to crash. This didn't seem to be the issue. (Also the specific calculation takes 1.92 s at my machine. As `f_vector` is not parallelized (yet), I doubt that your machine can do it under a second.)

What I think is happening, is that the `alarm` is triggered, but has no effect. For some reason the alarm just vanishes and the procedure keeps on going. This would also explain many patchbot reports, where there is a timeout with this module.

I don't seem to be the only one with this problem: https://patchbot.sagemath.org/log/27973/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-07-25%2015:09:25?short

As a resolution one could either figure out,
- why `alarm` doesn't trigger anything in some cases (I don't think I will be successful with this) or
- we can just delete all the tests including alarm interrupts in `CombinatorialPolyhedron` (as stated in the description of this ticket).

I would prefer the second option, as the first depends on somebody with time and knowledge. We won't have a certificate anymore that the methods in `CombinatorialPolyhedron` can be interrupted, so we have to trust anyone making changes to not break the ability to interrupt.



---

archive/issue_comments_550165.json:
```json
{
    "body": "<a id='comment:5'></a>\nOne more example for `alarm` being messed up with `sage -t`:\n\nhttps://groups.google.com/d/msg/sage-devel/wqnilUCLsT4/4riK4FnhDQAJ\n\nIn sage/rings/integer.pyx the alarm interrupts takes much longer than they should take, when using `sage -t`.",
    "created_at": "2019-07-30T11:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550165",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>
One more example for `alarm` being messed up with `sage -t`:

https://groups.google.com/d/msg/sage-devel/wqnilUCLsT4/4riK4FnhDQAJ

In sage/rings/integer.pyx the alarm interrupts takes much longer than they should take, when using `sage -t`.



---

archive/issue_comments_550166.json:
```json
{
    "body": "Changing commit from \"\" to \"e62f499bbd3e4b08e1e70efe2d729dc89215eef2\"",
    "created_at": "2019-07-30T13:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550166",
    "user": "https://github.com/kliem"
}
```

Changing commit from "" to "e62f499bbd3e4b08e1e70efe2d729dc89215eef2"



---

archive/issue_comments_550167.json:
```json
{
    "body": "Changing author from \"\" to \"Jonathan Kliem\"",
    "created_at": "2019-07-30T13:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550167",
    "user": "https://github.com/kliem"
}
```

Changing author from "" to "Jonathan Kliem"



---

archive/issue_comments_550168.json:
```json
{
    "body": "<a id='comment:6'></a>\nNew commits:\n|                                                                                                                                          |                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|\n|[e62f499](https://github.com/sagemath/sagetrac-mirror/commit/e62f499bbd3e4b08e1e70efe2d729dc89215eef2)|`removed tests involving alarm interrupts`|",
    "created_at": "2019-07-30T13:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550168",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>
New commits:
|                                                                                                                                          |                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|
|[e62f499](https://github.com/sagemath/sagetrac-mirror/commit/e62f499bbd3e4b08e1e70efe2d729dc89215eef2)|`removed tests involving alarm interrupts`|



---

archive/issue_comments_550169.json:
```json
{
    "body": "Changing branch from \"\" to \"public/28287\"",
    "created_at": "2019-07-30T13:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550169",
    "user": "https://github.com/kliem"
}
```

Changing branch from "" to "public/28287"



---

archive/issue_comments_550170.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-30T13:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550170",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_550171.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-02T09:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550171",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_550172.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Erik Bray\"",
    "created_at": "2019-08-02T09:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550172",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Erik Bray"



---

archive/issue_comments_550173.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks, I think maybe that's the best for now.  Writing a test like this to work reliably is hard, and unless there's a specific *regression* to test related to interruptability I don't know that such tests add much value.\n\nIf you do want to have one, it has to be a case where it for sure won't return unless interrupted.",
    "created_at": "2019-08-02T09:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550173",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Thanks, I think maybe that's the best for now.  Writing a test like this to work reliably is hard, and unless there's a specific *regression* to test related to interruptability I don't know that such tests add much value.

If you do want to have one, it has to be a case where it for sure won't return unless interrupted.



---

archive/issue_events_079918.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-04T07:25:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28287#event-79918"
}
```



---

archive/issue_comments_550174.json:
```json
{
    "body": "Changing branch from \"public/28287\" to \"e62f499bbd3e4b08e1e70efe2d729dc89215eef2\"",
    "created_at": "2019-08-04T07:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550174",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/28287" to "e62f499bbd3e4b08e1e70efe2d729dc89215eef2"



---

archive/issue_comments_550175.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-04T07:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28287#issuecomment-550175",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
