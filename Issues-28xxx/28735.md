# Issue 28735: Lattice Polytopes: Obtain facets directly from facet_normals

archive/issues_028498.json:
```json
{
    "assignees": [],
    "body": "Currently, the facets of lattice polytopes are obtained from the face lattice. This is somewhat slow, but most importantly this is a problem for `CombinatorialPolyhedron`, which uses the method `facets` to obtain the combinatorial structure. So `CombinatorialPolyhedron` cannot be be used for computing the face lattice of lattice polytopes.\n\nSolution: We won't fix this. Instead #28960 initializes `CombinatorialPolyhedron` from (a new method) `incidence_matrix`. This implicitely uses `facet_normals` instead of facets. This why `CombinatorialPolyhedron` is independent of the face lattice computation.\n\nCC:  @jplab @LaisRast\n\nComponent: **geometry**\n\nKeywords: **lattice polytopes, facets**\n\nAuthor: **Jonathan Kliem**\n\nReviewer: **Andrey Novoseltsev**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28735_\n\n",
    "closed_at": "2020-04-22T07:38:46Z",
    "created_at": "2019-11-14T13:05:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20geometry",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/wontfix"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Lattice Polytopes: Obtain facets directly from facet_normals",
    "type": "issue",
    "updated_at": "2020-04-22T07:38:46Z",
    "url": "https://github.com/sagemath/sage/issues/28735",
    "user": "https://github.com/kliem"
}
```
Currently, the facets of lattice polytopes are obtained from the face lattice. This is somewhat slow, but most importantly this is a problem for `CombinatorialPolyhedron`, which uses the method `facets` to obtain the combinatorial structure. So `CombinatorialPolyhedron` cannot be be used for computing the face lattice of lattice polytopes.

Solution: We won't fix this. Instead #28960 initializes `CombinatorialPolyhedron` from (a new method) `incidence_matrix`. This implicitely uses `facet_normals` instead of facets. This why `CombinatorialPolyhedron` is independent of the face lattice computation.

CC:  @jplab @LaisRast

Component: **geometry**

Keywords: **lattice polytopes, facets**

Author: **Jonathan Kliem**

Reviewer: **Andrey Novoseltsev**

_Issue created by migration from https://trac.sagemath.org/ticket/28735_





---

archive/issue_events_391683.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T13:05:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391683"
}
```



---

archive/issue_events_391684.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T13:05:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "c: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391684"
}
```



---

archive/issue_events_391685.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T13:05:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391685"
}
```



---

archive/issue_events_391686.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T13:05:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391686"
}
```



---

archive/issue_comments_448128.json:
```json
{
    "body": "Commit: **[`5d9eff3`](https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902)**",
    "created_at": "2019-11-14T13:06:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448128",
    "user": "https://github.com/kliem"
}
```

Commit: **[`5d9eff3`](https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902)**



---

archive/issue_comments_448129.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902\"><code>5d9eff3</code></a></td><td><code>directly obtain facets of lattice polytope</code></td></tr></table>\n",
    "created_at": "2019-11-14T13:06:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448129",
    "user": "https://github.com/kliem"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902"><code>5d9eff3</code></a></td><td><code>directly obtain facets of lattice polytope</code></td></tr></table>




---

archive/issue_events_391687.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T13:06:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391687"
}
```



---

archive/issue_comments_448130.json:
```json
{
    "body": "Branch: **[public/28735](https://github.com/sagemath/sagetrac-mirror/tree/public/28735)**",
    "created_at": "2019-11-14T13:06:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448130",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/28735](https://github.com/sagemath/sagetrac-mirror/tree/public/28735)**



---

archive/issue_events_391688.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2019-11-14T17:17:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391688"
}
```



---

archive/issue_events_391689.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2019-11-14T17:17:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391689"
}
```



---

archive/issue_comments_448131.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nWhile it certainly makes sense, some things should be addressed:\n1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.\n2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.\n3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?\n\nAs a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.",
    "created_at": "2019-11-14T17:17:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448131",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:2" align="right">comment:2</div>

While it certainly makes sense, some things should be addressed:
1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.
2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.
3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?

As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.



---

archive/issue_comments_448132.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a06009f02d2a63627fa2a215c3bc929b181adcda\"><code>a06009f</code></a></td><td><code>cache facets, facets are identical in face lattice</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7\"><code>76e9daf</code></a></td><td><code>return facets by ambient faces, if self is an ambient face of another polyhedron</code></td></tr></table>\n",
    "created_at": "2019-11-14T20:18:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448132",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a06009f02d2a63627fa2a215c3bc929b181adcda"><code>a06009f</code></a></td><td><code>cache facets, facets are identical in face lattice</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7"><code>76e9daf</code></a></td><td><code>return facets by ambient faces, if self is an ambient face of another polyhedron</code></td></tr></table>




---

archive/issue_comments_448133.json:
```json
{
    "body": "Changed commit from **[`5d9eff3`](https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902)** to **[`76e9daf`](https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7)**",
    "created_at": "2019-11-14T20:18:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448133",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5d9eff3`](https://github.com/sagemath/sagetrac-mirror/commit/5d9eff3c4c0687e2d9b238963ce8b7023ca1f902)** to **[`76e9daf`](https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7)**



---

archive/issue_comments_448134.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThanks for the comments.\n\nReplying to [@novoselt](#comment%3A2):\n> While it certainly makes sense, some things should be addressed:\n> 1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.\n\nSure.\n> 2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.\n\nIt seems to still work:\n\n```\nsage: o = lattice_polytope.cross_polytope(5)\nsage: f = o.facets()[0]\nsage: f.facet_of()\n(5-d reflexive polytope in 5-d lattice M,)\nsage: L = o.face_lattice()\nsage: D = L.hasse_diagram()\nsage: D.neighbors(f)\n[3-d face of 5-d reflexive polytope in 5-d lattice M,\n 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M]\nsage: f.facet_of()\n(5-d reflexive polytope in 5-d lattice M,)\nsage: \n```\nNevertheless, I adopted `face_lattice` to return exactly the facets in codimension 1.\n\nI also changed my could to only be applied, when `self is self.ambient()`.\n> 3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?\n\nMy facets should be in exactly the same order, as they used to be, as I just took the code from `face_lattice`. They are also in the same order as the normals. So anything else would be very strange. Wouldn't it?\n> \n> As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.\n\nEventually, it makes sense to cache the hasse diagram instead of the `FiniteLatticePoset`. See [https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ](https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ).\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a06009f02d2a63627fa2a215c3bc929b181adcda\"><code>a06009f</code></a></td><td><code>cache facets, facets are identical in face lattice</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7\"><code>76e9daf</code></a></td><td><code>return facets by ambient faces, if self is an ambient face of another polyhedron</code></td></tr></table>\n",
    "created_at": "2019-11-14T20:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448134",
    "user": "https://github.com/kliem"
}
```

<div id="comment:4" align="right">comment:4</div>

Thanks for the comments.

Replying to [@novoselt](#comment%3A2):
> While it certainly makes sense, some things should be addressed:
> 1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.

Sure.
> 2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.

It seems to still work:

```
sage: o = lattice_polytope.cross_polytope(5)
sage: f = o.facets()[0]
sage: f.facet_of()
(5-d reflexive polytope in 5-d lattice M,)
sage: L = o.face_lattice()
sage: D = L.hasse_diagram()
sage: D.neighbors(f)
[3-d face of 5-d reflexive polytope in 5-d lattice M,
 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M]
sage: f.facet_of()
(5-d reflexive polytope in 5-d lattice M,)
sage: 
```
Nevertheless, I adopted `face_lattice` to return exactly the facets in codimension 1.

I also changed my could to only be applied, when `self is self.ambient()`.
> 3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?

My facets should be in exactly the same order, as they used to be, as I just took the code from `face_lattice`. They are also in the same order as the normals. So anything else would be very strange. Wouldn't it?
> 
> As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.

Eventually, it makes sense to cache the hasse diagram instead of the `FiniteLatticePoset`. See [https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ](https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ).

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a06009f02d2a63627fa2a215c3bc929b181adcda"><code>a06009f</code></a></td><td><code>cache facets, facets are identical in face lattice</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7"><code>76e9daf</code></a></td><td><code>return facets by ambient faces, if self is an ambient face of another polyhedron</code></td></tr></table>




---

archive/issue_events_391690.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T20:24:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391690"
}
```



---

archive/issue_events_391691.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-14T20:24:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391691"
}
```



---

archive/issue_comments_448135.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4\"><code>d1e022b</code></a></td><td><code>simplified construction</code></td></tr></table>\n",
    "created_at": "2019-11-15T05:50:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448135",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4"><code>d1e022b</code></a></td><td><code>simplified construction</code></td></tr></table>




---

archive/issue_comments_448136.json:
```json
{
    "body": "Changed commit from **[`76e9daf`](https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7)** to **[`d1e022b`](https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4)**",
    "created_at": "2019-11-15T05:50:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448136",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`76e9daf`](https://github.com/sagemath/sagetrac-mirror/commit/76e9daf7779f6e9f75aa27c40500899b64ffc8b7)** to **[`d1e022b`](https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4)**



---

archive/issue_events_391692.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-15T06:37:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391692"
}
```



---

archive/issue_events_391693.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-11-15T06:37:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391693"
}
```



---

archive/issue_comments_448137.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nActually, I think I'm going to change the design a bit.\n\n- Make `LPFace` a method of the lattice polytope (cached), which\n  - if `self.ambient() is self` works as it is\n  - otherwise transform the indices to ambient indices (using cached dictionaries) and then call `LPFace` of ambient\n\nThis way one can obtain facets directly from any lattice polytope. This will also allow to obtain faces directly from an interator instead of from the face lattice.",
    "created_at": "2019-11-15T06:37:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448137",
    "user": "https://github.com/kliem"
}
```

<div id="comment:7" align="right">comment:7</div>

Actually, I think I'm going to change the design a bit.

- Make `LPFace` a method of the lattice polytope (cached), which
  - if `self.ambient() is self` works as it is
  - otherwise transform the indices to ambient indices (using cached dictionaries) and then call `LPFace` of ambient

This way one can obtain facets directly from any lattice polytope. This will also allow to obtain faces directly from an interator instead of from the face lattice.



---

archive/issue_comments_448138.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nBy face lattice methods I actually meant methods of facets which are related to the lattice:\n\n```\nsage: sage: o = lattice_polytope.cross_polytope(5)\n....: sage: f = o.facets()[0]\n....: sage: f.facet_of()\n....: \n(5-d reflexive polytope in 5-d lattice M,)\nsage: f.adjacent()\n(4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M)\n```\nWill this adjacent method work with your design? What would be nice (and perhaps your last comment was about it as well) is to have an ability to construct standalone faces, but whenever they are requested again for whatever reason (e.g. because the full face lattice is computed) - exactly the same objects are returned.",
    "created_at": "2019-11-15T16:21:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448138",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:8" align="right">comment:8</div>

By face lattice methods I actually meant methods of facets which are related to the lattice:

```
sage: sage: o = lattice_polytope.cross_polytope(5)
....: sage: f = o.facets()[0]
....: sage: f.facet_of()
....: 
(5-d reflexive polytope in 5-d lattice M,)
sage: f.adjacent()
(4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M)
```
Will this adjacent method work with your design? What would be nice (and perhaps your last comment was about it as well) is to have an ability to construct standalone faces, but whenever they are requested again for whatever reason (e.g. because the full face lattice is computed) - exactly the same objects are returned.



---

archive/issue_comments_448139.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAlso a general remark on these improvements and optimizations - they are very welcome, especially since I have no time anymore to work on them myself! But please keep in mind the use case these classes were introduced - working with a lot of quite small polytopes (reflexive, their faces and subpolytopes) where faces and numbers of lattice points are requested repeatedly. So whatever optimizations are added to initial constructions should not affect caching of stuff for later reuse. Thank you!",
    "created_at": "2019-11-15T16:24:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448139",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:9" align="right">comment:9</div>

Also a general remark on these improvements and optimizations - they are very welcome, especially since I have no time anymore to work on them myself! But please keep in mind the use case these classes were introduced - working with a lot of quite small polytopes (reflexive, their faces and subpolytopes) where faces and numbers of lattice points are requested repeatedly. So whatever optimizations are added to initial constructions should not affect caching of stuff for later reuse. Thank you!



---

archive/issue_comments_448140.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOk, I keep that in mind.\n\nA few sentences about my motivation:\n\nI mainly just wanted to compute the face lattice by `CombinatorialPolyhedron`. However, it doesn't make any sense to initialize it from the facets, which are in turn taken from the face lattice.\n\nOne intermediate step, is to create the incidence matrix (#28743). This is implicitly done for the face lattice anyway. (Actually one can obtain the combinatorial polyhedron instead from the incidence matrix.)\n\nMaybe I just replace face lattice (in the `self is self.ambient()` case) and leave everything else the way it is.\n\nTo avoid memory leak, it makes also sense to cache the hasse diagram/digraph instead of `FiniteLatticePoset` (I was told that this is cached anyway). As it looks, many methods can then just call the hasse diagram directly.",
    "created_at": "2019-11-15T20:33:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448140",
    "user": "https://github.com/kliem"
}
```

<div id="comment:10" align="right">comment:10</div>

Ok, I keep that in mind.

A few sentences about my motivation:

I mainly just wanted to compute the face lattice by `CombinatorialPolyhedron`. However, it doesn't make any sense to initialize it from the facets, which are in turn taken from the face lattice.

One intermediate step, is to create the incidence matrix (#28743). This is implicitly done for the face lattice anyway. (Actually one can obtain the combinatorial polyhedron instead from the incidence matrix.)

Maybe I just replace face lattice (in the `self is self.ambient()` case) and leave everything else the way it is.

To avoid memory leak, it makes also sense to cache the hasse diagram/digraph instead of `FiniteLatticePoset` (I was told that this is cached anyway). As it looks, many methods can then just call the hasse diagram directly.



---

archive/issue_comments_448141.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nTicket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448141",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Ticket retargeted after milestone closed



---

archive/issue_events_391694.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391694"
}
```



---

archive/issue_events_391695.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391695"
}
```



---

archive/issue_events_391696.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-01-06T20:20:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391696"
}
```



---

archive/issue_events_391697.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-01-06T20:20:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391697"
}
```



---

archive/issue_events_391698.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-01-06T20:20:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391698"
}
```



---

archive/issue_comments_448142.json:
```json
{
    "body": "Changed commit from **[`d1e022b`](https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4)** to none",
    "created_at": "2020-01-06T20:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448142",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`d1e022b`](https://github.com/sagemath/sagetrac-mirror/commit/d1e022b4807e2b18c5fb769968a50a9e33c021b4)** to none



---

archive/issue_comments_448143.json:
```json
{
    "body": "Changed branch from **[public/28735](https://github.com/sagemath/sagetrac-mirror/tree/public/28735)** to none",
    "created_at": "2020-01-06T20:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448143",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/28735](https://github.com/sagemath/sagetrac-mirror/tree/public/28735)** to none



---

archive/issue_comments_448144.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,39 +1,3 @@\n-We improve the method `facets` of lattice polytopes to be obtained directly from the facet normals.\n+With #28960, this ticket will not be needed anymore. `CombinatorialPolyhedron` does not use the method `facets` anymore but instead the incidence matrix and `facet_normals`.\n \n-Before, this method implicitly computed the face lattice and then obtained the codimension 1 faces of the face lattice.\n-\n-Timings before:\n-\n-```\n-sage: o = lattice_polytope.cross_polytope(5)\n-sage: %time _ = o.facets()\n-CPU times: user 24.8 ms, sys: 4.13 ms, total: 28.9 ms\n-Wall time: 26.8 ms\n-sage: o = lattice_polytope.cross_polytope(7)\n-sage: %time _ = o.facets()\n-CPU times: user 302 ms, sys: 4.04 ms, total: 306 ms\n-Wall time: 288 ms\n-sage: o = lattice_polytope.cross_polytope(10)\n-sage: %time _ = o.facets()\n-CPU times: user 16.2 s, sys: 70.6 ms, total: 16.3 s\n-Wall time: 16.3 s\n-```\n-\n-Timings with this ticket:\n-\n-```\n-sage: o = lattice_polytope.cross_polytope(5)\n-sage: %time _ = o.facets()\n-CPU times: user 2.29 ms, sys: 0 ns, total: 2.29 ms\n-Wall time: 1.97 ms\n-sage: o = lattice_polytope.cross_polytope(7)\n-sage: %time _ = o.facets()\n-CPU times: user 5.76 ms, sys: 0 ns, total: 5.76 ms\n-Wall time: 5.22 ms\n-sage: o = lattice_polytope.cross_polytope(10)\n-sage: %time _ = o.facets()\n-CPU times: user 45.1 ms, sys: 4.7 ms, total: 49.8 ms\n-Wall time: 46.2 ms\n-```\n-\n-Remark: This makes `CombinatorialPolyhedron` useful for lattice polytopes, as it is obtained from the method `facets`. Currently the entire face lattice is implicitly computed to obtain the combinatorial polyhedron.\n+Thus `facets` can use `faces`, which will eventually use `CombinatorialPolyhedron`.\n``````\n",
    "created_at": "2020-01-06T20:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448144",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,39 +1,3 @@
-We improve the method `facets` of lattice polytopes to be obtained directly from the facet normals.
+With #28960, this ticket will not be needed anymore. `CombinatorialPolyhedron` does not use the method `facets` anymore but instead the incidence matrix and `facet_normals`.
 
-Before, this method implicitly computed the face lattice and then obtained the codimension 1 faces of the face lattice.
-
-Timings before:
-
-```
-sage: o = lattice_polytope.cross_polytope(5)
-sage: %time _ = o.facets()
-CPU times: user 24.8 ms, sys: 4.13 ms, total: 28.9 ms
-Wall time: 26.8 ms
-sage: o = lattice_polytope.cross_polytope(7)
-sage: %time _ = o.facets()
-CPU times: user 302 ms, sys: 4.04 ms, total: 306 ms
-Wall time: 288 ms
-sage: o = lattice_polytope.cross_polytope(10)
-sage: %time _ = o.facets()
-CPU times: user 16.2 s, sys: 70.6 ms, total: 16.3 s
-Wall time: 16.3 s
-```
-
-Timings with this ticket:
-
-```
-sage: o = lattice_polytope.cross_polytope(5)
-sage: %time _ = o.facets()
-CPU times: user 2.29 ms, sys: 0 ns, total: 2.29 ms
-Wall time: 1.97 ms
-sage: o = lattice_polytope.cross_polytope(7)
-sage: %time _ = o.facets()
-CPU times: user 5.76 ms, sys: 0 ns, total: 5.76 ms
-Wall time: 5.22 ms
-sage: o = lattice_polytope.cross_polytope(10)
-sage: %time _ = o.facets()
-CPU times: user 45.1 ms, sys: 4.7 ms, total: 49.8 ms
-Wall time: 46.2 ms
-```
-
-Remark: This makes `CombinatorialPolyhedron` useful for lattice polytopes, as it is obtained from the method `facets`. Currently the entire face lattice is implicitly computed to obtain the combinatorial polyhedron.
+Thus `facets` can use `faces`, which will eventually use `CombinatorialPolyhedron`.
``````




---

archive/issue_comments_448145.json:
```json
{
    "body": "Reviewer: **Andrey Novoseltsev**",
    "created_at": "2020-01-07T18:08:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448145",
    "user": "https://github.com/novoselt"
}
```

Reviewer: **Andrey Novoseltsev**



---

archive/issue_events_391699.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2020-01-07T18:08:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391699"
}
```



---

archive/issue_events_391700.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2020-01-07T18:08:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391700"
}
```



---

archive/issue_comments_448146.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nWhile this ticket is not closed, I updated the description to help people understand what was going on and why we this ticket is a \"won't fix\".",
    "created_at": "2020-02-11T10:52:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448146",
    "user": "https://github.com/kliem"
}
```

<div id="comment:14" align="right">comment:14</div>

While this ticket is not closed, I updated the description to help people understand what was going on and why we this ticket is a "won't fix".



---

archive/issue_comments_448147.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-With #28960, this ticket will not be needed anymore. `CombinatorialPolyhedron` does not use the method `facets` anymore but instead the incidence matrix and `facet_normals`.\n+Currently, the facets of lattice polytopes are obtained from the face lattice. This is somewhat slow, but most importantly this is a problem for `CombinatorialPolyhedron`, which uses the method `facets` to obtain the combinatorial structure. So `CombinatorialPolyhedron` cannot be be used for computing the face lattice of lattice polytopes.\n \n-Thus `facets` can use `faces`, which will eventually use `CombinatorialPolyhedron`.\n+Solution: We won't fix this. Instead #28960 initializes `CombinatorialPolyhedron` from (a new method) `incidence_matrix`. This implicitely uses `facet_normals` instead of facets. This why `CombinatorialPolyhedron` is independent of the face lattice computation.\n``````\n",
    "created_at": "2020-02-11T10:52:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28735#issuecomment-448147",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-With #28960, this ticket will not be needed anymore. `CombinatorialPolyhedron` does not use the method `facets` anymore but instead the incidence matrix and `facet_normals`.
+Currently, the facets of lattice polytopes are obtained from the face lattice. This is somewhat slow, but most importantly this is a problem for `CombinatorialPolyhedron`, which uses the method `facets` to obtain the combinatorial structure. So `CombinatorialPolyhedron` cannot be be used for computing the face lattice of lattice polytopes.
 
-Thus `facets` can use `faces`, which will eventually use `CombinatorialPolyhedron`.
+Solution: We won't fix this. Instead #28960 initializes `CombinatorialPolyhedron` from (a new method) `incidence_matrix`. This implicitely uses `facet_normals` instead of facets. This why `CombinatorialPolyhedron` is independent of the face lattice computation.
``````




---

archive/issue_events_391701.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-04-22T07:38:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391701"
}
```



---

archive/issue_events_391702.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-04-22T07:38:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/wontfix",
    "label_color": "c6c6c6",
    "label_name": "wontfix",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391702"
}
```



---

archive/issue_events_391703.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-04-22T07:38:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391703"
}
```



---

archive/issue_events_391704.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-04-22T07:38:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28735",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28735#event-391704"
}
```
