# Issue 28989: Bug in proper cycles of indefinite binary quadratic forms

archive/issues_028752.json:
```json
{
    "body": "The proper cycle of the indefinite quadratic form x<sup>2</sup>+xy-y<sup>2</sup> consists of x<sup>2</sup>+xy-y<sup>2</sup> and -x<sup>2</sup>+xy+y<sup>2</sup>. Sage gives only one element.\n\n```\nsage: Q=BinaryQF(1,1,-1)\nsage: Q.cycle(proper=True) \n[x^2 + x*y - y^2]\n```\n\nAs a consequence, consider two quadratic forms of discriminant 5. Two such forms are always properly equivalent. However, we get\n\n```\nsage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) \nsage: Q1.is_equivalent(Q2, proper=True) \nFalse\n```\n\nTo check proper equivalence, note that\n\n```\nsage: M=Matrix(ZZ,2,2, [1,1,-1,0])\nsage: det(M)\n1\nsage: Q2 == Q1.matrix_action_right(M)\nTrue\n```\n\n\n\n\nKeywords: binary quadratic forms\n\nReviewer: Travis Scrimshaw\n\nAuthor: Steffen L\u00f6brich, Dave Morris\n\nBranch: b3c79005b3a51d9649408bf265a00584d8c76479\n\nCommit: b3c79005b3a51d9649408bf265a00584d8c76479\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28989\n\n",
    "closed_at": "2020-01-25T17:27:44Z",
    "created_at": "2020-01-11T10:21:07Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Bug in proper cycles of indefinite binary quadratic forms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28989",
    "user": "https://github.com/sloebrich"
}
```
The proper cycle of the indefinite quadratic form x<sup>2</sup>+xy-y<sup>2</sup> consists of x<sup>2</sup>+xy-y<sup>2</sup> and -x<sup>2</sup>+xy+y<sup>2</sup>. Sage gives only one element.

```
sage: Q=BinaryQF(1,1,-1)
sage: Q.cycle(proper=True) 
[x^2 + x*y - y^2]
```

As a consequence, consider two quadratic forms of discriminant 5. Two such forms are always properly equivalent. However, we get

```
sage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) 
sage: Q1.is_equivalent(Q2, proper=True) 
False
```

To check proper equivalence, note that

```
sage: M=Matrix(ZZ,2,2, [1,1,-1,0])
sage: det(M)
1
sage: Q2 == Q1.matrix_action_right(M)
True
```




Keywords: binary quadratic forms

Reviewer: Travis Scrimshaw

Author: Steffen LÃ¶brich, Dave Morris

Branch: b3c79005b3a51d9649408bf265a00584d8c76479

Commit: b3c79005b3a51d9649408bf265a00584d8c76479

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28989





---

archive/issue_comments_405602.json:
```json
{
    "body": "<a id='comment:2'></a>Thanks for reporting the bug. My patch fixes an error in the definition of the `cycle` function.\n\n```\nsage: Q=BinaryQF(1,1,-1)\nsage: Q.cycle(proper=True)\n[x^2 + x*y - y^2, -x^2 + x*y + y^2]\nsage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) \nsage: Q1.is_equivalent(Q2, proper=True)\nTrue\n```\n\nI am not setting this to \"needs review\" yet, for two reasons: the doctests need work, and I am not sure this gives correct answers for quadratic forms whose first coefficient is negative. (The reference [BV2007] seems to require the first coefficient to be positive.) I think I should be able to get this figured out, but it's great if someone who knows about quadratic forms wants to chime in.\n\n---\nNew commits:",
    "created_at": "2020-01-11T20:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405602",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:2'></a>Thanks for reporting the bug. My patch fixes an error in the definition of the `cycle` function.

```
sage: Q=BinaryQF(1,1,-1)
sage: Q.cycle(proper=True)
[x^2 + x*y - y^2, -x^2 + x*y + y^2]
sage: Q1, Q2 = BinaryQF(1,1,-1), BinaryQF(-1,1,1) 
sage: Q1.is_equivalent(Q2, proper=True)
True
```

I am not setting this to "needs review" yet, for two reasons: the doctests need work, and I am not sure this gives correct answers for quadratic forms whose first coefficient is negative. (The reference [BV2007] seems to require the first coefficient to be positive.) I think I should be able to get this figured out, but it's great if someone who knows about quadratic forms wants to chime in.

---
New commits:



---

archive/issue_comments_405603.json:
```json
{
    "body": "<a id='comment:3'></a>The second item in the output of `Q.cycle(proper=True)` seems to have a sign error in the `y^2` term. I'll have to look into this.",
    "created_at": "2020-01-11T23:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405603",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:3'></a>The second item in the output of `Q.cycle(proper=True)` seems to have a sign error in the `y^2` term. I'll have to look into this.



---

archive/issue_comments_405604.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-12T03:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405604",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405605.json:
```json
{
    "body": "<a id='comment:5'></a>I fixed an additional mistake in the definition of `cycle`. (The statement of Proposition 6.10.5 of [BV2007] is ambiguous, and the original algorithm interpreted it incorrectly.) I validated the new algorithm on a couple of examples from [BV2007], and will add these as doctests. \n\nHowever, I also still need to look at quadratic forms whose coefficient of `x^2` is negative.\n\nPS [BV2007] = Johannes Buchmann and Ulrich Vollmer, *Binary Quadratic Forms*, Springer, 2007.\n\n---\nNew commits:",
    "created_at": "2020-01-12T03:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405605",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>I fixed an additional mistake in the definition of `cycle`. (The statement of Proposition 6.10.5 of [BV2007] is ambiguous, and the original algorithm interpreted it incorrectly.) I validated the new algorithm on a couple of examples from [BV2007], and will add these as doctests. 

However, I also still need to look at quadratic forms whose coefficient of `x^2` is negative.

PS [BV2007] = Johannes Buchmann and Ulrich Vollmer, *Binary Quadratic Forms*, Springer, 2007.

---
New commits:



---

archive/issue_comments_405606.json:
```json
{
    "body": "<a id='comment:6'></a>OK, I think the mathematics is correct, but I will modify the docstrings to clarify that the  definition of \"cycle\" used here is not quite the same as in [BV2007].",
    "created_at": "2020-01-12T06:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405606",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:6'></a>OK, I think the mathematics is correct, but I will modify the docstrings to clarify that the  definition of "cycle" used here is not quite the same as in [BV2007].



---

archive/issue_comments_405607.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T23:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405607",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405608.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-15T23:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405608",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405609.json:
```json
{
    "body": "<a id='comment:8'></a>I added several doctests and corrected (or replaced) some of the ones that were already there, rewrote the docstring of `cycle`, and fixed two more bugs (including one that was my fault).\n\nThe main purpose of this ticket is to rewrite the few lines of code that compute proper cycles of indefinite forms. I believe that function is now correct. The ticket also fixes a bug in `is_equivalent`. (The quadratic form `self` might not be reduced, so it needed to be replaced with `selfred` at one point.) \n\nI verified a few examples by hand, and also validated against some examples that I found on the internet. I did not look at the code for definite forms at all, but that is older and presumably better tested.",
    "created_at": "2020-01-15T23:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405609",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:8'></a>I added several doctests and corrected (or replaced) some of the ones that were already there, rewrote the docstring of `cycle`, and fixed two more bugs (including one that was my fault).

The main purpose of this ticket is to rewrite the few lines of code that compute proper cycles of indefinite forms. I believe that function is now correct. The ticket also fixes a bug in `is_equivalent`. (The quadratic form `self` might not be reduced, so it needed to be replaced with `selfred` at one point.) 

I verified a few examples by hand, and also validated against some examples that I found on the internet. I did not look at the code for definite forms at all, but that is older and presumably better tested.



---

archive/issue_comments_405610.json:
```json
{
    "body": "<a id='comment:9'></a>please do not use comments (starting with #) in the documentation, but make sentences.",
    "created_at": "2020-01-17T12:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405610",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>please do not use comments (starting with #) in the documentation, but make sentences.



---

archive/issue_comments_405611.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T18:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405612.json:
```json
{
    "body": "<a id='comment:11'></a>A few minor things:\n\n```diff\n-        TESTS::\n+        TESTS:\n \n         Check an example in :trac:`28989`::\n+\n-            sage: Q=BinaryQF(1,1,-1)\n+            sage: Q = BinaryQF(1,1,-1)\n             sage: Q.cycle(proper=True)\n             [x^2 + x*y - y^2, -x^2 + x*y + y^2]\n \n         This is Example 6.10.6 of [BUVO2007]_::\n+\n-            sage: Q=BinaryQF(1,7,-6)\n+            sage: Q = BinaryQF(1,7,-6)\n```\nand any other similar changes.\n\n```diff\n-        Try an example where a is negative::\n-            sage: Q=BinaryQF(-1, 8, 3)\n+        Try an example where `a` is negative::\n+\n+            sage: Q = BinaryQF(-1, 8, 3)\n```\nThe for-loop part is over-indented here:\n\n```\n            for i in range(len(C)//2):\n                    C[2*i+1] = C[2*i+1]._Tau()\n```\n\n```diff\n-                C = C + C\n+                C += C\n```\nI also don't understand the point of this test:\n\n```\n            sage: hasattr(Q, '_cycle_list')\n            False\n```",
    "created_at": "2020-01-20T04:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405612",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>A few minor things:

```diff
-        TESTS::
+        TESTS:
 
         Check an example in :trac:`28989`::
+
-            sage: Q=BinaryQF(1,1,-1)
+            sage: Q = BinaryQF(1,1,-1)
             sage: Q.cycle(proper=True)
             [x^2 + x*y - y^2, -x^2 + x*y + y^2]
 
         This is Example 6.10.6 of [BUVO2007]_::
+
-            sage: Q=BinaryQF(1,7,-6)
+            sage: Q = BinaryQF(1,7,-6)
```
and any other similar changes.

```diff
-        Try an example where a is negative::
-            sage: Q=BinaryQF(-1, 8, 3)
+        Try an example where `a` is negative::
+
+            sage: Q = BinaryQF(-1, 8, 3)
```
The for-loop part is over-indented here:

```
            for i in range(len(C)//2):
                    C[2*i+1] = C[2*i+1]._Tau()
```

```diff
-                C = C + C
+                C += C
```
I also don't understand the point of this test:

```
            sage: hasattr(Q, '_cycle_list')
            False
```



---

archive/issue_comments_405613.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-22T03:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405614.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks for looking at the ticket, and for your corrections. I made all of the changes that you suggested, and searched to correct similar mistakes. I also noticed that the spacing in lists was inconsistent, so I standardized by always putting a space after commas.\n\nYou were right to question the `hasattr` test, because it does not really make sense as a doctest. So I deleted it, and also the similar test a few lines later.",
    "created_at": "2020-01-22T03:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405614",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:13'></a>Thanks for looking at the ticket, and for your corrections. I made all of the changes that you suggested, and searched to correct similar mistakes. I also noticed that the spacing in lists was inconsistent, so I standardized by always putting a space after commas.

You were right to question the `hasattr` test, because it does not really make sense as a doctest. So I deleted it, and also the similar test a few lines later.



---

archive/issue_comments_405615.json:
```json
{
    "body": "<a id='comment:14'></a>Thank you. However, all of these changes except for the one I pointed out are wrong:\n\n```diff\n-TESTS::\n+TESTS:\n```\nWhen there are two colons `::`, what should follow is indented and doctests. If there is only one colon `:`, then it should be normal text.",
    "created_at": "2020-01-22T03:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405615",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Thank you. However, all of these changes except for the one I pointed out are wrong:

```diff
-TESTS::
+TESTS:
```
When there are two colons `::`, what should follow is indented and doctests. If there is only one colon `:`, then it should be normal text.



---

archive/issue_comments_405616.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-22T03:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405616",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405617.json:
```json
{
    "body": "<a id='comment:16'></a>Sorry, I didn't know that (obviously). I think it is correct now.",
    "created_at": "2020-01-22T03:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405617",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:16'></a>Sorry, I didn't know that (obviously). I think it is correct now.



---

archive/issue_comments_405618.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-22T03:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405618",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405619.json:
```json
{
    "body": "<a id='comment:17'></a>Thank you.",
    "created_at": "2020-01-22T03:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405619",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Thank you.



---

archive/issue_comments_405620.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-25T17:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28989#issuecomment-405620",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073412.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-25T17:27:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28989",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28989#event-73412"
}
```
