# Issue 28540: Let lookup_global accept unicode as input

archive/issues_028303.json:
```json
{
    "body": "CC:  @jhpalmieri @mwageringel\n\nKeywords: python3\n\nIn #28444, bytes_to_str was made more tolerant: It now accepts as input not only bytes but also str. A str input is returned unaltered.\n\nbytes_to_str is also used in sage.structure.factory.lookup_global. It turns out that a pickle created in py3 may not be unpicklable in py2 because the stored name of the global is a unicode, but a bytes or str is expected.\n\nObvious fix: Try to convert unicode to str in lookup_global.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28540\n\n",
    "closed_at": "2020-10-11T16:51:42Z",
    "created_at": "2019-09-26T21:59:21Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Let lookup_global accept unicode as input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28540",
    "user": "https://github.com/simon-king-jena"
}
```
CC:  @jhpalmieri @mwageringel

Keywords: python3

In #28444, bytes_to_str was made more tolerant: It now accepts as input not only bytes but also str. A str input is returned unaltered.

bytes_to_str is also used in sage.structure.factory.lookup_global. It turns out that a pickle created in py3 may not be unpicklable in py2 because the stored name of the global is a unicode, but a bytes or str is expected.

Obvious fix: Try to convert unicode to str in lookup_global.

Issue created by migration from https://trac.sagemath.org/ticket/28540





---

archive/issue_comments_399297.json:
```json
{
    "body": "That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's \"str\".\n\nThere is of course a way to convert a unicode object to py2: `s.encode(\"utf8\")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.",
    "created_at": "2019-09-26T22:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399297",
    "user": "https://github.com/nbruin"
}
```

That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's "str".

There is of course a way to convert a unicode object to py2: `s.encode("utf8")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.



---

archive/issue_comments_399298.json:
```json
{
    "body": "Replying to [comment:1 nbruin]:\n> That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's \"str\".\n> \n> There is of course a way to convert a unicode object to py2: `s.encode(\"utf8\")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.\n\n\nOK, that somehow makes sense to me. So, I will not touch it.\n\nQuestion: Is the change that I have introduced in #28444 OK, then? At least it made it possible to read a py2 pickle in py3.",
    "created_at": "2019-09-26T22:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399298",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:1 nbruin]:
> That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's "str".
> 
> There is of course a way to convert a unicode object to py2: `s.encode("utf8")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.


OK, that somehow makes sense to me. So, I will not touch it.

Question: Is the change that I have introduced in #28444 OK, then? At least it made it possible to read a py2 pickle in py3.



---

archive/issue_comments_399299.json:
```json
{
    "body": "Rather than stretching byte_to_str beyond its specifications, it may be better to fix the function that actually needs a conversion from unicode to str, namely lookup_glocal. See the new ticket description.",
    "created_at": "2019-09-26T23:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399299",
    "user": "https://github.com/simon-king-jena"
}
```

Rather than stretching byte_to_str beyond its specifications, it may be better to fix the function that actually needs a conversion from unicode to str, namely lookup_glocal. See the new ticket description.



---

archive/issue_comments_399300.json:
```json
{
    "body": "See #28414 for a situation where the fix from this ticket actually solves a problem.\n\n---\nNew commits:",
    "created_at": "2019-09-26T23:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399300",
    "user": "https://github.com/simon-king-jena"
}
```

See #28414 for a situation where the fix from this ticket actually solves a problem.

---
New commits:



---

archive/issue_comments_399301.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-26T23:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399301",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399302.json:
```json
{
    "body": "red branch",
    "created_at": "2019-11-24T19:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399302",
    "user": "https://github.com/fchapoton"
}
```

red branch



---

archive/issue_comments_399303.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-24T19:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399303",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399304.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399304",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_events_071597.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71597"
}
```



---

archive/issue_events_071598.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71598"
}
```



---

archive/issue_events_071599.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71599"
}
```



---

archive/issue_comments_399305.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399305",
    "user": "https://github.com/mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_399306.json:
```json
{
    "body": "As we do not support Python 2 anymore, should we close this as outdated? I imagine there is rarely a need to load a py3 pickle in a Python-2-based Sage now.",
    "created_at": "2020-07-11T13:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399306",
    "user": "https://github.com/mwageringel"
}
```

As we do not support Python 2 anymore, should we close this as outdated? I imagine there is rarely a need to load a py3 pickle in a Python-2-based Sage now.



---

archive/issue_comments_399307.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-11T15:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399307",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_071600.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-11T15:54:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71600"
}
```



---

archive/issue_events_071601.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-11T15:54:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71601"
}
```



---

archive/issue_comments_399308.json:
```json
{
    "body": "That was my thought too.",
    "created_at": "2020-07-11T15:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399308",
    "user": "https://github.com/mkoeppe"
}
```

That was my thought too.



---

archive/issue_comments_399309.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-11T15:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399309",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399310.json:
```json
{
    "body": "Ok.",
    "created_at": "2020-07-11T15:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399310",
    "user": "https://github.com/mwageringel"
}
```

Ok.



---

archive/issue_comments_399311.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-10-11T16:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399311",
    "user": "https://github.com/slel"
}
```

Resolution: invalid



---

archive/issue_comments_399312.json:
```json
{
    "body": "If this needs to be reopened, use the milestone sage-9.1.1",
    "created_at": "2020-10-11T16:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28540#issuecomment-399312",
    "user": "https://github.com/slel"
}
```

If this needs to be reopened, use the milestone sage-9.1.1



---

archive/issue_events_071602.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T16:51:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28540",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28540#event-71602"
}
```
