# Issue 28082: upgrade to giacpy_sage-0.6.8

archive/issues_027845.json:
```json
{
    "body": "CC:  @kiwifb @frederichan-IMJPRG\n\nIn Sage 8.8, giacpy_sage fails to build \u2013 apparently, because it is not using the flag `-std=c++11`. So it fails if the compiler doesn't default to C++11.\n\nThe logs are attached (OS X 10.13.6). This was originally reported on [sage-devel](https://groups.google.com/d/msg/sage-devel/OCweUCoikXc/Nuazv8TRAgAJ).\n\nsource tarball to upgrade giacpy_sage:\nhttp://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz\n\nIssue created by migration from https://trac.sagemath.org/ticket/28082\n\n",
    "closed_at": "2019-10-10T21:42:36Z",
    "created_at": "2019-06-29T08:24:02Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "upgrade to giacpy_sage-0.6.8",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28082",
    "user": "https://github.com/mwageringel"
}
```
CC:  @kiwifb @frederichan-IMJPRG

In Sage 8.8, giacpy_sage fails to build â€“ apparently, because it is not using the flag `-std=c++11`. So it fails if the compiler doesn't default to C++11.

The logs are attached (OS X 10.13.6). This was originally reported on [sage-devel](https://groups.google.com/d/msg/sage-devel/OCweUCoikXc/Nuazv8TRAgAJ).

source tarball to upgrade giacpy_sage:
http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz

Issue created by migration from https://trac.sagemath.org/ticket/28082





---

archive/issue_comments_392819.json:
```json
{
    "body": "Attachment [giacpy_sage-0.6.7.log](tarball://root/attachments/some-uuid/ticket28082/giacpy_sage-0.6.7.log) by @mwageringel created at 2019-06-29 08:25:06",
    "created_at": "2019-06-29T08:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392819",
    "user": "https://github.com/mwageringel"
}
```

Attachment [giacpy_sage-0.6.7.log](tarball://root/attachments/some-uuid/ticket28082/giacpy_sage-0.6.7.log) by @mwageringel created at 2019-06-29 08:25:06



---

archive/issue_comments_392820.json:
```json
{
    "body": "Note that it happens also on linux\n\n```\n[giacpy_sage-0.6.7]     creating build/temp.linux-x86_64-2.7\n[giacpy_sage-0.6.7]     gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/cysignals -I/home/fbissey/sandbox/git-fork/sage/local/include -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o\n```\nThis is probably an issue where python doesn't identify the code as C++ properly. Note that the sage-on-gentoo package properly use g++ for the same code.\n\n```\ncreating /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7\nx86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7 -I/usr/lib64/python2.7/site-packages/sage/cpython -I/usr/lib64/python2.7/site-packages/sage/libs/ntl -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/include/python2.7 -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7/giacpy_sage.o\n```\nthere may be another bug on track about C++ support in distutils.",
    "created_at": "2019-06-29T08:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392820",
    "user": "https://github.com/kiwifb"
}
```

Note that it happens also on linux

```
[giacpy_sage-0.6.7]     creating build/temp.linux-x86_64-2.7
[giacpy_sage-0.6.7]     gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/cysignals -I/home/fbissey/sandbox/git-fork/sage/local/include -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o
```
This is probably an issue where python doesn't identify the code as C++ properly. Note that the sage-on-gentoo package properly use g++ for the same code.

```
creating /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7
x86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7 -I/usr/lib64/python2.7/site-packages/sage/cpython -I/usr/lib64/python2.7/site-packages/sage/libs/ntl -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/include/python2.7 -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7/giacpy_sage.o
```
there may be another bug on track about C++ support in distutils.



---

archive/issue_comments_392821.json:
```json
{
    "body": "Replying to [comment:1 fbissey]:\n> Note that it happens also on linux\n\n\nOn what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.",
    "created_at": "2019-07-01T12:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392821",
    "user": "https://github.com/embray"
}
```

Replying to [comment:1 fbissey]:
> Note that it happens also on linux


On what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.



---

archive/issue_comments_392822.json:
```json
{
    "body": "Replying to [comment:2 embray]:\n> On what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.\n\n\nFor me, this happens on CentOS Linux release 7.6.1810 (Core). Do the bots also build optional packages?",
    "created_at": "2019-07-01T17:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392822",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:2 embray]:
> On what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.


For me, this happens on CentOS Linux release 7.6.1810 (Core). Do the bots also build optional packages?



---

archive/issue_comments_392823.json:
```json
{
    "body": "Replying to [comment:1 fbissey]:\n> there may be another bug on track about C++ support in distutils.\n\n\nIndeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.\n\nThere are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.",
    "created_at": "2019-07-01T17:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392823",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:1 fbissey]:
> there may be another bug on track about C++ support in distutils.


Indeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.

There are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.



---

archive/issue_comments_392824.json:
```json
{
    "body": "Replying to [comment:4 gh-mwageringel]:\n> Replying to [comment:1 fbissey]:\n> > there may be another bug on track about C++ support in distutils.\n\n> \n> Indeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.\n> \n\n\nAnd that's why the sage-on-gentoo package works properly but vanilla sage on the same OS doesn't.\n\n> There are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.\n\n\nIf I am being honest we had this discussion for a while and I thought we had included the distutils patch in sage because it threaten to break the sage library in a few places. May be we have a work around that I forgot about.",
    "created_at": "2019-07-01T20:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392824",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:4 gh-mwageringel]:
> Replying to [comment:1 fbissey]:
> > there may be another bug on track about C++ support in distutils.

> 
> Indeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.
> 


And that's why the sage-on-gentoo package works properly but vanilla sage on the same OS doesn't.

> There are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.


If I am being honest we had this discussion for a while and I thought we had included the distutils patch in sage because it threaten to break the sage library in a few places. May be we have a work around that I forgot about.



---

archive/issue_comments_392825.json:
```json
{
    "body": "The problem is not that `gcc` is used instead of `g++`. The problem is that `-std=c++11` is missing from the compiler flags. That looks like an upstream bug.",
    "created_at": "2019-07-02T21:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392825",
    "user": "https://github.com/jdemeyer"
}
```

The problem is not that `gcc` is used instead of `g++`. The problem is that `-std=c++11` is missing from the compiler flags. That looks like an upstream bug.



---

archive/issue_comments_392826.json:
```json
{
    "body": "But if `giacpy_sage` was using CXX instead of CC it would automatically get that flag. That being said, yes that flag should be added upstream. But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.",
    "created_at": "2019-07-02T21:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392826",
    "user": "https://github.com/kiwifb"
}
```

But if `giacpy_sage` was using CXX instead of CC it would automatically get that flag. That being said, yes that flag should be added upstream. But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.



---

archive/issue_comments_392827.json:
```json
{
    "body": "Replying to [comment:8 fbissey]:\n> But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.\n\n\nThe language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.",
    "created_at": "2019-07-02T21:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392827",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 fbissey]:
> But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.


The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.



---

archive/issue_comments_392828.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 fbissey]:\n> > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.\n\n> \n> The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.\n\n\nI am skeptical but I am willing to see if that works.",
    "created_at": "2019-07-02T21:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392828",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 fbissey]:
> > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.

> 
> The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.


I am skeptical but I am willing to see if that works.



---

archive/issue_comments_392829.json:
```json
{
    "body": "I try to understand what happens. Don't you have similar problems with pplpy?\n\nIn giacpy_sage there is a\n`language=\"c++\"`\nin setup.py but should I also add \n`# distutils: language = c++`\nin giacpy_sage.pyx?\n\nAbout the c++ standard used, we mainly want to use the same as the giac library so why isn't the default behaviour the same? or is there some environment variable missed by giacpy_sage?",
    "created_at": "2019-07-03T08:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392829",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

I try to understand what happens. Don't you have similar problems with pplpy?

In giacpy_sage there is a
`language="c++"`
in setup.py but should I also add 
`# distutils: language = c++`
in giacpy_sage.pyx?

About the c++ standard used, we mainly want to use the same as the giac library so why isn't the default behaviour the same? or is there some environment variable missed by giacpy_sage?



---

archive/issue_comments_392830.json:
```json
{
    "body": "I just had a look and `pplpy` exhibit the same behavior. g++ is only used when linking. gcc is used for compilation. `pplpy` doesn't seem to be hit by trouble coming from the c++11 standard and is successfully compiled.",
    "created_at": "2019-07-03T08:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392830",
    "user": "https://github.com/kiwifb"
}
```

I just had a look and `pplpy` exhibit the same behavior. g++ is only used when linking. gcc is used for compilation. `pplpy` doesn't seem to be hit by trouble coming from the c++11 standard and is successfully compiled.



---

archive/issue_comments_392831.json:
```json
{
    "body": "Replying to [comment:10 fbissey]:\n> Replying to [comment:9 jdemeyer]:\n> > Replying to [comment:8 fbissey]:\n> > > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.\n\n> > \n> > The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.\n\n> \n> I am skeptical but I am willing to see if that works.\n\n\n`gcc` and `g++` are just front-ends to multiple different programs, including different compilers (for c and c++ among others), linkers, and others.  There are differences between whether you invoke `gcc` or `g++` though.  Namely, in the case of `g++`, it *always* assumes you are working on a C++ project (whether you're compiling `.c` sources or `.cpp` sources), so even for apparently \"plain C\" files it will link in the C++ stdlib since it's assumed to be part of a C++ project.",
    "created_at": "2019-07-03T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392831",
    "user": "https://github.com/embray"
}
```

Replying to [comment:10 fbissey]:
> Replying to [comment:9 jdemeyer]:
> > Replying to [comment:8 fbissey]:
> > > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.

> > 
> > The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.

> 
> I am skeptical but I am willing to see if that works.


`gcc` and `g++` are just front-ends to multiple different programs, including different compilers (for c and c++ among others), linkers, and others.  There are differences between whether you invoke `gcc` or `g++` though.  Namely, in the case of `g++`, it *always* assumes you are working on a C++ project (whether you're compiling `.c` sources or `.cpp` sources), so even for apparently "plain C" files it will link in the C++ stdlib since it's assumed to be part of a C++ project.



---

archive/issue_comments_392832.json:
```json
{
    "body": "So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:\n\n```\nextra_compile_args\": [\n            \"-fno-strict-aliasing\", \n            \"-DCYTHON_CLINE_IN_TRACEBACK=1\", \n            \"-std=c++11\"\n        ]\n```\n\nbut files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?",
    "created_at": "2019-07-03T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392832",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:

```
extra_compile_args": [
            "-fno-strict-aliasing", 
            "-DCYTHON_CLINE_IN_TRACEBACK=1", 
            "-std=c++11"
        ]
```

but files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?



---

archive/issue_comments_392833.json:
```json
{
    "body": "Replying to [comment:14 frederichan]:\n> So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:\n> \n> \n> ```\n> extra_compile_args\": [\n>             \"-fno-strict-aliasing\", \n>             \"-DCYTHON_CLINE_IN_TRACEBACK=1\", \n>             \"-std=c++11\"\n>         ]\n> ```\n> \n> but files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?\n\n\nLet's try to go back to this. `extra_compile_args` is a standard distutils option and is already used in `giacpy_sage`'s setup.py\n\n```\n                   extra_compile_args=conf[\"CXXFLAGS\"],\n```\nYou would be excused to think that this is enough to make sure the compilation follow C++11 standard. However the way the autoconf macro we are using works is to ensure that we have C++11 compliant compiler. I repeat: compiler. Which means that `-std=c++11` is added to `CXX` not `CXXFLAGS`.\n\nNow if what Jeroen says gcc's front end being able to recognise c++ code, adding a line `EXPORT CXXFLAGS=\"${CXXFLAGS} -std=c++11\"` before `sdh_pip_install` in `spkg-install` for `giacpy_sage` should be enough to fix the issue.",
    "created_at": "2019-07-19T00:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392833",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:14 frederichan]:
> So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:
> 
> 
> ```
> extra_compile_args": [
>             "-fno-strict-aliasing", 
>             "-DCYTHON_CLINE_IN_TRACEBACK=1", 
>             "-std=c++11"
>         ]
> ```
> 
> but files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?


Let's try to go back to this. `extra_compile_args` is a standard distutils option and is already used in `giacpy_sage`'s setup.py

```
                   extra_compile_args=conf["CXXFLAGS"],
```
You would be excused to think that this is enough to make sure the compilation follow C++11 standard. However the way the autoconf macro we are using works is to ensure that we have C++11 compliant compiler. I repeat: compiler. Which means that `-std=c++11` is added to `CXX` not `CXXFLAGS`.

Now if what Jeroen says gcc's front end being able to recognise c++ code, adding a line `EXPORT CXXFLAGS="${CXXFLAGS} -std=c++11"` before `sdh_pip_install` in `spkg-install` for `giacpy_sage` should be enough to fix the issue.



---

archive/issue_comments_392834.json:
```json
{
    "body": "Actually, `conf[\"CXXFLAGS\"]` is defined within `setup.py` of giacpy_sage, so it does not seem like environment variables have an effect on this. In fact, I suppose it would be preferable to set this within `setup.py`, since then giacpy_sage can be installed like any package, i.e. independently from `spkg-install`. This works for me:\n\n```diff\n--- a/setup.py\n+++ b/setup.py\n@@ -9,7 +9,7 @@ from distutils.extension import Extension\n from Cython.Build import cythonize\n\n\n-conf = {'CXXFLAGS' : [], 'LDFLAGS' : []}\n+conf = {'CXXFLAGS' : ['-std=c++11'], 'LDFLAGS' : []}\n\n libraries=['giac']\n library_dirs=[SAGE_LOCAL+'/lib']\n```",
    "created_at": "2019-07-19T22:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392834",
    "user": "https://github.com/mwageringel"
}
```

Actually, `conf["CXXFLAGS"]` is defined within `setup.py` of giacpy_sage, so it does not seem like environment variables have an effect on this. In fact, I suppose it would be preferable to set this within `setup.py`, since then giacpy_sage can be installed like any package, i.e. independently from `spkg-install`. This works for me:

```diff
--- a/setup.py
+++ b/setup.py
@@ -9,7 +9,7 @@ from distutils.extension import Extension
 from Cython.Build import cythonize


-conf = {'CXXFLAGS' : [], 'LDFLAGS' : []}
+conf = {'CXXFLAGS' : ['-std=c++11'], 'LDFLAGS' : []}

 libraries=['giac']
 library_dirs=[SAGE_LOCAL+'/lib']
```



---

archive/issue_comments_392835.json:
```json
{
    "body": "looks like an upstream bug, one should not ignore CXXFLAGS.",
    "created_at": "2019-08-02T09:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392835",
    "user": "https://github.com/dimpase"
}
```

looks like an upstream bug, one should not ignore CXXFLAGS.



---

archive/issue_comments_392836.json:
```json
{
    "body": "I am not completely sure about this. Does `conf` override anything mentioned in it or is it just default if they are not defined?",
    "created_at": "2019-08-02T10:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392836",
    "user": "https://github.com/kiwifb"
}
```

I am not completely sure about this. Does `conf` override anything mentioned in it or is it just default if they are not defined?



---

archive/issue_comments_392837.json:
```json
{
    "body": "Looks to me as if it is getting my FLAGS from the compilation lines I am seeing.",
    "created_at": "2019-08-02T10:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392837",
    "user": "https://github.com/kiwifb"
}
```

Looks to me as if it is getting my FLAGS from the compilation lines I am seeing.



---

archive/issue_comments_392838.json:
```json
{
    "body": "So I have add the -std=c++11 in the extra_compil_args in setup.py.\ncf: https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/setup.py\n(and fixed a doctest)\n\nOn fedora 29 it gives with sage 8.9beta4:\n\n```\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/cysignals -I/home/fred-dev/sage/develop/sage/local/include -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o -std=c++11\n    In file included from /home/fred-dev/sage/develop/sage/local/include/giac/poly.h:25,\n                     from /home/fred-dev/sage/develop/sage/local/include/giac/giac.h:5,\n                     from giacpy_sage.cpp:665:\n    /home/fred-dev/sage/develop/sage/local/include/giac/index.h:32: warning: ignoring #pragma anon_unions  [-Wunknown-pragmas]\n     #pragma anon_unions\n\n    creating build/lib.linux-x86_64-2.7\n    g++ -pthread -shared -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib build/temp.linux-x86_64-2.7/giacpy_sage.o -L/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -lgmp -lgiac -lpython2.7 -o build/lib.linux-x86_64-2.7/giacpy_sage.so -lpari\n    running install_lib\n```\nso the -std=c++11 is given to gcc. The built/runtime are OK but they were also OK without -std=c++11 on this system.\n\nBasically we just want to follow the behaviour of what is done to extra_compil_args in  *sage/src/setup.py* It seems to also use -std=c++11 but I also saw some gnu++11.",
    "created_at": "2019-08-02T15:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392838",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

So I have add the -std=c++11 in the extra_compil_args in setup.py.
cf: https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/setup.py
(and fixed a doctest)

On fedora 29 it gives with sage 8.9beta4:

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/cysignals -I/home/fred-dev/sage/develop/sage/local/include -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o -std=c++11
    In file included from /home/fred-dev/sage/develop/sage/local/include/giac/poly.h:25,
                     from /home/fred-dev/sage/develop/sage/local/include/giac/giac.h:5,
                     from giacpy_sage.cpp:665:
    /home/fred-dev/sage/develop/sage/local/include/giac/index.h:32: warning: ignoring #pragma anon_unions  [-Wunknown-pragmas]
     #pragma anon_unions

    creating build/lib.linux-x86_64-2.7
    g++ -pthread -shared -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib build/temp.linux-x86_64-2.7/giacpy_sage.o -L/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -lgmp -lgiac -lpython2.7 -o build/lib.linux-x86_64-2.7/giacpy_sage.so -lpari
    running install_lib
```
so the -std=c++11 is given to gcc. The built/runtime are OK but they were also OK without -std=c++11 on this system.

Basically we just want to follow the behaviour of what is done to extra_compil_args in  *sage/src/setup.py* It seems to also use -std=c++11 but I also saw some gnu++11.



---

archive/issue_comments_392839.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-02T15:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392839",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392840.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-02T15:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392840",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

New commits:



---

archive/issue_comments_392841.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-02T15:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392841",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_392842.json:
```json
{
    "body": "a proper fix should not hardcode the value of -std= parameter. Rather it should infer it from what it is for giac, or you might create an ABI mismatch.",
    "created_at": "2019-08-02T16:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392842",
    "user": "https://github.com/dimpase"
}
```

a proper fix should not hardcode the value of -std= parameter. Rather it should infer it from what it is for giac, or you might create an ABI mismatch.



---

archive/issue_comments_392843.json:
```json
{
    "body": "Yes but not only giac. The first error appearing in the original attachment was around NTL includes because giacpy_sage uses\n\n```\nfrom sage.rings.integer cimport Integer\n```\nSo giacpy_sage must also follow what does the sage/src/setup.py do for other cython modules. And for c++ ones sage/src/setup.py adds the -std=c++11  to extra_compil_args.\n\nI have tried to add giacpy_sage to sage/src/module_list.py  without any flags and let sage/src/setup.py built giacpy_sage, and the -std=c++11 was indeed added.\n\nI have put on a public branch because I don't know a better solution.",
    "created_at": "2019-08-03T13:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392843",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

Yes but not only giac. The first error appearing in the original attachment was around NTL includes because giacpy_sage uses

```
from sage.rings.integer cimport Integer
```
So giacpy_sage must also follow what does the sage/src/setup.py do for other cython modules. And for c++ ones sage/src/setup.py adds the -std=c++11  to extra_compil_args.

I have tried to add giacpy_sage to sage/src/module_list.py  without any flags and let sage/src/setup.py built giacpy_sage, and the -std=c++11 was indeed added.

I have put on a public branch because I don't know a better solution.



---

archive/issue_events_069615.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-10-06T14:20:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28082#event-69615"
}
```



---

archive/issue_comments_392844.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-07T03:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392844",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392845.json:
```json
{
    "body": "Dima and I have had another look at this. The underlying problem seems to be that Sage sets `CXX` to something like `g++ -std=gnu++11`, but distutils invokes a C compiler which is just `gcc`, so the `-std=gnu++11` flag is not passed in the compile command.\n\nSolving this by setting `extra_compile_args` to `-std=c++11` is correct in the sense that this is also what is done elsewhere in Sage to overcome this problem, for example in `sage/libs/polybori/decl.pxd` and `sage/libs/pynac/pynac.pxd`. With the new giacpy_sage version, everything seems to work, so I am setting this to positive.",
    "created_at": "2019-10-07T03:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392845",
    "user": "https://github.com/mwageringel"
}
```

Dima and I have had another look at this. The underlying problem seems to be that Sage sets `CXX` to something like `g++ -std=gnu++11`, but distutils invokes a C compiler which is just `gcc`, so the `-std=gnu++11` flag is not passed in the compile command.

Solving this by setting `extra_compile_args` to `-std=c++11` is correct in the sense that this is also what is done elsewhere in Sage to overcome this problem, for example in `sage/libs/polybori/decl.pxd` and `sage/libs/pynac/pynac.pxd`. With the new giacpy_sage version, everything seems to work, so I am setting this to positive.



---

archive/issue_comments_392846.json:
```json
{
    "body": "```\nConnecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.\n```",
    "created_at": "2019-10-07T22:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392846",
    "user": "https://github.com/vbraun"
}
```

```
Connecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.
```



---

archive/issue_comments_392847.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> {{{\n> Connecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.\n> }}}\n\nworks for me (from USA):\n\n```\n$ wget http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz\n--2019-10-07 23:20:43--  http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz\nResolving webusers.imj-prg.fr... 134.157.100.46\nConnecting to webusers.imj-prg.fr|134.157.100.46|:80... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 45807 (45K) [application/x-gzip]\nSaving to: \u2018giacpy_sage-0.6.8.tar.gz\u2019\n\ngiacpy_sage-0.6.8.tar.gz          100%[==========================================================>]  44.73K   201KB/s    in 0.2s    \n\n2019-10-07 23:20:44 (201 KB/s) - \u2018giacpy_sage-0.6.8.tar.gz\u2019 saved [45807/45807]\n\n```",
    "created_at": "2019-10-07T22:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392847",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:28 vbraun]:
> {{{
> Connecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.
> }}}

works for me (from USA):

```
$ wget http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz
--2019-10-07 23:20:43--  http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz
Resolving webusers.imj-prg.fr... 134.157.100.46
Connecting to webusers.imj-prg.fr|134.157.100.46|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 45807 (45K) [application/x-gzip]
Saving to: â€˜giacpy_sage-0.6.8.tar.gzâ€™

giacpy_sage-0.6.8.tar.gz          100%[==========================================================>]  44.73K   201KB/s    in 0.2s    

2019-10-07 23:20:44 (201 KB/s) - â€˜giacpy_sage-0.6.8.tar.gzâ€™ saved [45807/45807]

```



---

archive/issue_comments_392848.json:
```json
{
    "body": "Attachment [giacpy_sage-0.6.8.tar.gz](tarball://root/attachments/some-uuid/ticket28082/giacpy_sage-0.6.8.tar.gz) by @dimpase created at 2019-10-07 22:24:48",
    "created_at": "2019-10-07T22:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392848",
    "user": "https://github.com/dimpase"
}
```

Attachment [giacpy_sage-0.6.8.tar.gz](tarball://root/attachments/some-uuid/ticket28082/giacpy_sage-0.6.8.tar.gz) by @dimpase created at 2019-10-07 22:24:48



---

archive/issue_events_069616.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-10T21:42:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28082#event-69616"
}
```



---

archive/issue_comments_392849.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-10T21:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28082#issuecomment-392849",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
