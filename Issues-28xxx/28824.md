# Issue 28824: make doc-pdf race condition

archive/issues_028587.json:
```json
{
    "body": "I'm hitting pretty reliably a race in the doc-pdf target:\n\n```\n$ make doc-clean && make -j10 doc-pdf\n[...]\n[docpdf] [59 [40\n[docpdf] Runaway definition?\n[docpdf] ->\\bibcite {index \n[docpdf] ! File ended within \\read.\n[...]\n```\nRe-running `make doc-pdf` eventually succeeds. Clearly a partially-written bibliography file is somewhere read by another process.\n\nCC:  @jhpalmieri @kiwifb @strogdon\n\nReviewer: Steven Trogdon\n\nAuthor: Volker Braun\n\nBranch: 6e263c8a21507c489e0579b81c75849893d94703\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28824\n\n",
    "closed_at": "2019-12-01T22:50:31Z",
    "created_at": "2019-11-30T11:05:22Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "make doc-pdf race condition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28824",
    "user": "https://github.com/vbraun"
}
```
I'm hitting pretty reliably a race in the doc-pdf target:

```
$ make doc-clean && make -j10 doc-pdf
[...]
[docpdf] [59 [40
[docpdf] Runaway definition?
[docpdf] ->\bibcite {index 
[docpdf] ! File ended within \read.
[...]
```
Re-running `make doc-pdf` eventually succeeds. Clearly a partially-written bibliography file is somewhere read by another process.

CC:  @jhpalmieri @kiwifb @strogdon

Reviewer: Steven Trogdon

Author: Volker Braun

Branch: 6e263c8a21507c489e0579b81c75849893d94703

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28824





---

archive/issue_comments_560663.json:
```json
{
    "body": "<a id='comment:1'></a>\nIn `local/share/doc/sage/latex/en/reference/rings_standard/rings_standard.log`:\n\n```\nPackage: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)\n)\nPackage xr Info: IMPORTING LABELS FROM ../references/references.aux on input li\nne 35.\n\nRunaway definition?\n->\\bibcite {index \n! File ended within \\read.\n<read 0> \n         \nl.35 \\externalcitedocument\n                          [../references/]{../references/references}\n? \n! Emergency stop.\n<read 0> \n         \nl.35 \\externalcitedocument\n                          [../references/]{../references/references}\nEnd of file on the terminal!\n```\nand `local/share/doc/sage/latex/en/reference/references/references.aux` looks just fine after make finishes.",
    "created_at": "2019-11-30T11:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560663",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
In `local/share/doc/sage/latex/en/reference/rings_standard/rings_standard.log`:

```
Package: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)
)
Package xr Info: IMPORTING LABELS FROM ../references/references.aux on input li
ne 35.

Runaway definition?
->\bibcite {index 
! File ended within \read.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
? 
! Emergency stop.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
End of file on the terminal!
```
and `local/share/doc/sage/latex/en/reference/references/references.aux` looks just fine after make finishes.



---

archive/issue_comments_560664.json:
```json
{
    "body": "<a id='comment:3'></a>\nPossibly due to #28059",
    "created_at": "2019-11-30T11:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560664",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
Possibly due to #28059



---

archive/issue_comments_560665.json:
```json
{
    "body": "<a id='comment:4'></a>\nhyperref and xr-hyper definitely is not operating atomically on the file system, so the only options are to run LaTeX in serial or use separate aux files.\n\nFor cross references to work in general (and parallel) we'd also have run LaTeX twice on each tex file, first to generate all references and then to build the actual pdf with the cross-references. That is:\n\n* For each tex file `foo.tex`: run `pdflatex foo.tex` to generate `foo.aux`\n* Combine the aux files into a `crossreferences.aux` file\n* For each tex file: run pdflatex again, but this time `\\input{crossreferences.aux}`\n\nIf we only want to include bibitems from the bibliography section then we don't have to do the whole thing, we can just create references.aux and include it in all the other files. This seems to be what is implemented, we should just not use xr-hyper (which will also write to references.aux) and instead manually include the references.aux (read only)",
    "created_at": "2019-11-30T11:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560665",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>
hyperref and xr-hyper definitely is not operating atomically on the file system, so the only options are to run LaTeX in serial or use separate aux files.

For cross references to work in general (and parallel) we'd also have run LaTeX twice on each tex file, first to generate all references and then to build the actual pdf with the cross-references. That is:

* For each tex file `foo.tex`: run `pdflatex foo.tex` to generate `foo.aux`
* Combine the aux files into a `crossreferences.aux` file
* For each tex file: run pdflatex again, but this time `\input{crossreferences.aux}`

If we only want to include bibitems from the bibliography section then we don't have to do the whole thing, we can just create references.aux and include it in all the other files. This seems to be what is implemented, we should just not use xr-hyper (which will also write to references.aux) and instead manually include the references.aux (read only)



---

archive/issue_comments_560666.json:
```json
{
    "body": "<a id='comment:5'></a>\nActually xr-hyper doesn't write to `references.aux`. The problem is that the sage docbuilder is building first the references before all other ref manual parts (good), but then once more in parallel with all the rest (bad). The second build races, and we just shouldn't do that.",
    "created_at": "2019-11-30T13:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560666",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
Actually xr-hyper doesn't write to `references.aux`. The problem is that the sage docbuilder is building first the references before all other ref manual parts (good), but then once more in parallel with all the rest (bad). The second build races, and we just shouldn't do that.



---

archive/issue_comments_560667.json:
```json
{
    "body": "Changing branch from \"\" to \"u/vbraun/make_doc_pdf_race_condition\"",
    "created_at": "2019-11-30T13:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560667",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "" to "u/vbraun/make_doc_pdf_race_condition"



---

archive/issue_comments_560668.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560668",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_560669.json:
```json
{
    "body": "Changing author from \"\" to \"Volker Braun\"",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560669",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Volker Braun"



---

archive/issue_comments_560670.json:
```json
{
    "body": "Changing commit from \"\" to \"6e263c8a21507c489e0579b81c75849893d94703\"",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560670",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "" to "6e263c8a21507c489e0579b81c75849893d94703"



---

archive/issue_comments_560671.json:
```json
{
    "body": "<a id='comment:7'></a>\nNew commits:\n|                                                                                                                                          |                                                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|\n|[6e263c8](https://github.com/sagemath/sagetrac-mirror/commit/6e263c8a21507c489e0579b81c75849893d94703)|`Properly separate building the reference manual into bibliography and rest`|",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560671",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>
New commits:
|                                                                                                                                          |                                                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
|[6e263c8](https://github.com/sagemath/sagetrac-mirror/commit/6e263c8a21507c489e0579b81c75849893d94703)|`Properly separate building the reference manual into bibliography and rest`|



---

archive/issue_comments_560672.json:
```json
{
    "body": "<a id='comment:8'></a>\nSteve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558\n\nCan you try this out Steve?",
    "created_at": "2019-11-30T19:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560672",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>
Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558

Can you try this out Steve?



---

archive/issue_comments_560673.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [fbissey](#comment%3A8):\n> Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558\n> \n> Can you try this out Steve?\n\n\nI'm glad there is the expertise to fix these things. I thought the issue was somewhere under the `docbuild` folder but had no idea where. This allows building of the `pdf-docs` without issue. I'll build once more to save the `build.log` to see if anything odd is there.",
    "created_at": "2019-11-30T21:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560673",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:9'></a>
Replying to [fbissey](#comment%3A8):
> Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558
> 
> Can you try this out Steve?


I'm glad there is the expertise to fix these things. I thought the issue was somewhere under the `docbuild` folder but had no idea where. This allows building of the `pdf-docs` without issue. I'll build once more to save the `build.log` to see if anything odd is there.



---

archive/issue_comments_560674.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-30T22:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560674",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_560675.json:
```json
{
    "body": "<a id='comment:10'></a>\nBuilt the `pdf-docs` twice with `-j13` without incident. Without this branch the build would fail. Nothing odd in the `.log` file. The present approach looks fine to me.",
    "created_at": "2019-11-30T22:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560675",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:10'></a>
Built the `pdf-docs` twice with `-j13` without incident. Without this branch the build would fail. Nothing odd in the `.log` file. The present approach looks fine to me.



---

archive/issue_comments_560676.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Steven Trogdon\"",
    "created_at": "2019-11-30T22:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560676",
    "user": "https://github.com/strogdon"
}
```

Changing reviewer from "" to "Steven Trogdon"



---

archive/issue_events_082288.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-01T22:50:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28824#event-82288"
}
```



---

archive/issue_comments_560677.json:
```json
{
    "body": "Changing branch from \"u/vbraun/make_doc_pdf_race_condition\" to \"6e263c8a21507c489e0579b81c75849893d94703\"",
    "created_at": "2019-12-01T22:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560677",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/vbraun/make_doc_pdf_race_condition" to "6e263c8a21507c489e0579b81c75849893d94703"



---

archive/issue_comments_560678.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-01T22:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560678",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_560679.json:
```json
{
    "body": "<a id='comment:12'></a>\nJust to confirm: without this branch, I hit this race condition five times in ten tries. With this branch, ten successful runs in a row.",
    "created_at": "2019-12-01T23:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560679",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>
Just to confirm: without this branch, I hit this race condition five times in ten tries. With this branch, ten successful runs in a row.



---

archive/issue_comments_560680.json:
```json
{
    "body": "Changing commit from \"6e263c8a21507c489e0579b81c75849893d94703\" to \"\"",
    "created_at": "2019-12-01T23:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28824#issuecomment-560680",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "6e263c8a21507c489e0579b81c75849893d94703" to ""
