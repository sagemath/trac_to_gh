# Issue 28707: More control on the numerical ODE solver for integrated curves and geodesics

archive/issues_028470.json:
```json
{
    "body": "This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters (see comment:1 for details).\n\nBesides, this ticket makes the `odeint` solver (introduced in #25936) the default one, instead of `rk4_maxima`, since the former is much faster than\nthe latter, as already noticed in #25936. The method name `'ode_int'` has been changed to `'odeint'`, in order to match with `desolve_odeint()` and the [SciPy name](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) (for backward compatibility, `method='ode_int'` is still accepted though).\n\nMoreover, this ticket performs some improvement of the documentation of integrated curves. \n\nCC:  @florentinj karimvanaelst\n\nKeywords: manifolds, integrated_curve, geodesic\n\nBranch/Commit: aca08a898e22586d2d9fcb4f29e830cc788f165f\n\nReviewer: Florentin Jaffredo\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28707\n\n",
    "closed_at": "2019-11-16T20:15:40Z",
    "created_at": "2019-11-08T13:45:28Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "More control on the numerical ODE solver for integrated curves and geodesics",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28707",
    "user": "https://github.com/egourgoulhon"
}
```
This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters (see comment:1 for details).

Besides, this ticket makes the `odeint` solver (introduced in #25936) the default one, instead of `rk4_maxima`, since the former is much faster than
the latter, as already noticed in #25936. The method name `'ode_int'` has been changed to `'odeint'`, in order to match with `desolve_odeint()` and the [SciPy name](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) (for backward compatibility, `method='ode_int'` is still accepted though).

Moreover, this ticket performs some improvement of the documentation of integrated curves. 

CC:  @florentinj karimvanaelst

Keywords: manifolds, integrated_curve, geodesic

Branch/Commit: aca08a898e22586d2d9fcb4f29e830cc788f165f

Reviewer: Florentin Jaffredo

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28707





---

archive/issue_comments_427905.json:
```json
{
    "body": "Attachment [test_geod_bad.png](tarball://root/attachments/some-uuid/ticket28707/test_geod_bad.png) by @egourgoulhon created at 2019-11-08 13:46:16",
    "created_at": "2019-11-08T13:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427905",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [test_geod_bad.png](tarball://root/attachments/some-uuid/ticket28707/test_geod_bad.png) by @egourgoulhon created at 2019-11-08 13:46:16



---

archive/issue_comments_427906.json:
```json
{
    "body": "<a id='comment:1'></a>Attachment [test_geod.png](tarball://root/attachments/some-uuid/ticket28707/test_geod.png) by @egourgoulhon created at 2019-11-08 14:25:34\n\nIn Sage 8.9, when integrating a null geodesic in Schwarzschild spacetime with an impact parameter close to critical (all details are in [this notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb)), the solution obtained with `solve(method='ode_int')` (green in the figure below) differs significantly from those obtained by means of other solvers, for instance the `rkf45` solver (red in the figure below):\n\n![](test_geod_bad.png)\n\nThe geodesic arises from the upper right (*(x,y)* approx. (10, 5)), circles twice around the black hole (the grey area) and then departs away to the lower left (`rkf45` \"exact\" solution) or to the lower right (`ode_int` bad solution). \nThis issue is due to the default values of 1.49012e-8 for the parameters `rtol` and `atol` of\n[scipy.integrate.odeint](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) being not sufficient in the present case. Now, with the Sage 8.9 implementation of `IntegratedCurve.solve()`, there is no way to change the values of  `rtol` and `atol`. Thanks to the new argument `**control_param` introduced here this becomes possible. Morevoer, the default values of \n`rtol` and `atol` are changed to 1.e-10. Accordingly, the curves obtained from the `odeint` and  `rkf45` become almost undistinguishable:\n\n![](test_geod.png)\n\nSee the [notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb) for a detailed study of the agreement between `odeint` and the other solvers when using the code of this ticket branch.",
    "created_at": "2019-11-08T14:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427906",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>Attachment [test_geod.png](tarball://root/attachments/some-uuid/ticket28707/test_geod.png) by @egourgoulhon created at 2019-11-08 14:25:34

In Sage 8.9, when integrating a null geodesic in Schwarzschild spacetime with an impact parameter close to critical (all details are in [this notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb)), the solution obtained with `solve(method='ode_int')` (green in the figure below) differs significantly from those obtained by means of other solvers, for instance the `rkf45` solver (red in the figure below):

![](test_geod_bad.png)

The geodesic arises from the upper right (*(x,y)* approx. (10, 5)), circles twice around the black hole (the grey area) and then departs away to the lower left (`rkf45` "exact" solution) or to the lower right (`ode_int` bad solution). 
This issue is due to the default values of 1.49012e-8 for the parameters `rtol` and `atol` of
[scipy.integrate.odeint](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) being not sufficient in the present case. Now, with the Sage 8.9 implementation of `IntegratedCurve.solve()`, there is no way to change the values of  `rtol` and `atol`. Thanks to the new argument `**control_param` introduced here this becomes possible. Morevoer, the default values of 
`rtol` and `atol` are changed to 1.e-10. Accordingly, the curves obtained from the `odeint` and  `rkf45` become almost undistinguishable:

![](test_geod.png)

See the [notebook](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_geodesics.ipynb) for a detailed study of the agreement between `odeint` and the other solvers when using the code of this ticket branch.



---

archive/issue_comments_427907.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-11-08T14:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427907",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_427908.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,9 +1,9 @@\n-This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters. \n+This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters (see comment:1 for details).\n \n Besides, this ticket makes the `odeint` solver (introduced in #25936) the default one, instead of `rk4_maxima`, since the former is much faster than\n the latter, as already noticed in #25936. The method name `'ode_int'` has been changed to `'odeint'`, in order to match with `desolve_odeint()` and the [SciPy name](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) (for backward compatibility, `method='ode_int'` is still accepted though).\n \n-Moreover, this ticket performs some improvement of the documentation of integrated curves.\n+Moreover, this ticket performs some improvement of the documentation of integrated curves. \n \n Author: Eric Gourgoulhon\n \n```\n",
    "created_at": "2019-11-08T14:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427908",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,9 +1,9 @@
-This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters. 
+This ticket allows to pass extra parameters to the method `IntegratedCurve.solve()` in order to control the numerical ODE solver. In particular, this allows to fix an issue with the `odeint` solver by increasing its precision via some tolerance parameters (see comment:1 for details).
 
 Besides, this ticket makes the `odeint` solver (introduced in #25936) the default one, instead of `rk4_maxima`, since the former is much faster than
 the latter, as already noticed in #25936. The method name `'ode_int'` has been changed to `'odeint'`, in order to match with `desolve_odeint()` and the [SciPy name](https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html) (for backward compatibility, `method='ode_int'` is still accepted though).
 
-Moreover, this ticket performs some improvement of the documentation of integrated curves.
+Moreover, this ticket performs some improvement of the documentation of integrated curves. 
 
 Author: Eric Gourgoulhon
 
```




---

archive/issue_comments_427909.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-08T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427909",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_427910.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-08T19:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427910",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_427911.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-11T08:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427911",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_427912.json:
```json
{
    "body": "<a id='comment:6'></a>The above commit fixes a merge conflict with Sage 9.0.beta5, due to #28669.",
    "created_at": "2019-11-11T08:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427912",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>The above commit fixes a merge conflict with Sage 9.0.beta5, due to #28669.



---

archive/issue_comments_427913.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-12T21:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427913",
    "user": "https://github.com/FlorentinJ"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_427914.json:
```json
{
    "body": "<a id='comment:7'></a>Seems perfect to me. Many thanks \u00c9ric.\n\n(The failed plugins are only there because of the merge with #28669, no issue here)",
    "created_at": "2019-11-12T21:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427914",
    "user": "https://github.com/FlorentinJ"
}
```

<a id='comment:7'></a>Seems perfect to me. Many thanks Éric.

(The failed plugins are only there because of the merge with #28669, no issue here)



---

archive/issue_comments_427915.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 gh-FlorentinJ]:\n> Seems perfect to me. Many thanks \u00c9ric.\n> \n\n\nThank you for the review!\n\n> (The failed plugins are only there because of the merge with #28669, no issue here)\n\n\nI think it's rather an issue with this patchbot: there are many errors and all reports say that they happen \"on 0 non-empty lines\". The \"0\" is highly suspicious here...",
    "created_at": "2019-11-12T22:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427915",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:9'></a>Replying to [comment:7 gh-FlorentinJ]:
> Seems perfect to me. Many thanks Éric.
> 


Thank you for the review!

> (The failed plugins are only there because of the merge with #28669, no issue here)


I think it's rather an issue with this patchbot: there are many errors and all reports say that they happen "on 0 non-empty lines". The "0" is highly suspicious here...



---

archive/issue_comments_427916.json:
```json
{
    "body": "<a id='comment:10'></a>The diff for the failed plugin only contain 2 lines:\n\n\n```\n--- 9.0.beta5\n+++ 9.0.beta5 + #28707\n```\n\n\nIsn't that the reason it failed ?",
    "created_at": "2019-11-12T22:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427916",
    "user": "https://github.com/FlorentinJ"
}
```

<a id='comment:10'></a>The diff for the failed plugin only contain 2 lines:


```
--- 9.0.beta5
+++ 9.0.beta5 + #28707
```


Isn't that the reason it failed ?



---

archive/issue_comments_427917.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-16T20:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28707#issuecomment-427917",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_072370.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-16T20:15:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28707",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28707#event-72370"
}
```
