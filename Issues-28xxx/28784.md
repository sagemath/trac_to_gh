# Issue 28784: Adding multiple symmetries and multiple contractions to tensors

archive/issues_028547.json:
```json
{
    "body": "As of sage-9.0.beta6, applying multiple contractions or multiple symmetries to tensors in indices notation raises a NotImplementedError. \n\nThis tickets aims at removing this error by implementing the adequate behavior as well as adding a convention check on the index notation.\n\nThe index notation should allow : \n\\\\*  Multiple contraction \n\\\\*  Multiple symmetries\n\\\\*  indices denoted by a non-accentuated latin caracter  {a,...,z,A,...,Z} and wild card \".\"\n\\\\*  covariant indices first notation as well as contravariant indices first\n\\\\*  Latex notations '{' and '}'\n\\\\*  if indices do not begin by `^` nor `_` then contravariant indices first is assumed \n\\\\The index notation should not allow :\n\\\\*  Repeated indices of the same type\n\\\\*  indices denoted by any other caracter\n\\\\*  nested symmetries\n\\\\*  unbalanced parentheses/brackets\n\n\nNB : Usual index notations allows greek indices but their implementation seems more difficult and is not the goal of the ticket.\n\n\n\nAssignee: @LBrunswic\n\nCC:  @egourgoulhon\n\nKeywords: tensor, contraction, symmetries, manifolds\n\nReviewer: Eric Gourgoulhon\n\nAuthor: L\u00e9o Brunswic\n\nBranch: 3013354903be7147e51c9dd7957428a281c801df\n\nCommit: 3013354903be7147e51c9dd7957428a281c801df\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28784\n\n",
    "closed_at": "2019-11-30T13:36:10Z",
    "created_at": "2019-11-21T21:01:06Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Adding multiple symmetries and multiple contractions to tensors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28784",
    "user": "https://github.com/LBrunswic"
}
```
As of sage-9.0.beta6, applying multiple contractions or multiple symmetries to tensors in indices notation raises a NotImplementedError. 

This tickets aims at removing this error by implementing the adequate behavior as well as adding a convention check on the index notation.

The index notation should allow : 
\\*  Multiple contraction 
\\*  Multiple symmetries
\\*  indices denoted by a non-accentuated latin caracter  {a,...,z,A,...,Z} and wild card "."
\\*  covariant indices first notation as well as contravariant indices first
\\*  Latex notations '{' and '}'
\\*  if indices do not begin by `^` nor `_` then contravariant indices first is assumed 
\\The index notation should not allow :
\\*  Repeated indices of the same type
\\*  indices denoted by any other caracter
\\*  nested symmetries
\\*  unbalanced parentheses/brackets


NB : Usual index notations allows greek indices but their implementation seems more difficult and is not the goal of the ticket.



Assignee: @LBrunswic

CC:  @egourgoulhon

Keywords: tensor, contraction, symmetries, manifolds

Reviewer: Eric Gourgoulhon

Author: LÃ©o Brunswic

Branch: 3013354903be7147e51c9dd7957428a281c801df

Commit: 3013354903be7147e51c9dd7957428a281c801df

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28784





---

archive/issue_comments_402607.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-11-21T21:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402607",
    "user": "https://github.com/LBrunswic"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_402608.json:
```json
{
    "body": "Changing keywords from \"\" to \"tensor, contraction, symmetries, manifolds\".",
    "created_at": "2019-11-21T21:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402608",
    "user": "https://github.com/LBrunswic"
}
```

Changing keywords from "" to "tensor, contraction, symmetries, manifolds".



---

archive/issue_comments_402609.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to linear algebra.",
    "created_at": "2019-11-21T21:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402609",
    "user": "https://github.com/LBrunswic"
}
```

Changing component from PLEASE CHANGE to linear algebra.



---

archive/issue_comments_402610.json:
```json
{
    "body": "Set assignee to @LBrunswic.",
    "created_at": "2019-11-21T21:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402610",
    "user": "https://github.com/LBrunswic"
}
```

Set assignee to @LBrunswic.



---

archive/issue_comments_402611.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-21T21:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402612.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-21T21:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402612",
    "user": "https://github.com/LBrunswic"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402613.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-22T09:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402613",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_402614.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks for this useful enhancement!\n\nThe patchbot reports some failures:\n\n```\nsage -t --long src/sage/manifolds/differentiable/tensorfield.py  # 2 doctests failed\nsage -t --long src/sage/tensor/modules/free_module_tensor.py  # 19 doctests failed\nsage -t --long src/sage/tensor/modules/tensor_with_indices.py  # 39 doctests failed\n```\nBesides, could you add a few doctests to illustrate the new functionalities?",
    "created_at": "2019-11-22T09:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402614",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>Thanks for this useful enhancement!

The patchbot reports some failures:

```
sage -t --long src/sage/manifolds/differentiable/tensorfield.py  # 2 doctests failed
sage -t --long src/sage/tensor/modules/free_module_tensor.py  # 19 doctests failed
sage -t --long src/sage/tensor/modules/tensor_with_indices.py  # 39 doctests failed
```
Besides, could you add a few doctests to illustrate the new functionalities?



---

archive/issue_comments_402615.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-22T11:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402615",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402616.json:
```json
{
    "body": "<a id='comment:9'></a>`@`egourgoulhon \n I needed it :)\n \n I'm sorry I forgot to do a doctest :$...I corrected the features that are tested and added new doctest.",
    "created_at": "2019-11-22T11:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402616",
    "user": "https://github.com/LBrunswic"
}
```

<a id='comment:9'></a>`@`egourgoulhon 
 I needed it :)
 
 I'm sorry I forgot to do a doctest :$...I corrected the features that are tested and added new doctest.



---

archive/issue_comments_402617.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-22T11:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402617",
    "user": "https://github.com/LBrunswic"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402618.json:
```json
{
    "body": "<a id='comment:12'></a>New commits:",
    "created_at": "2019-11-23T21:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402618",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>New commits:



---

archive/issue_comments_402619.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks for making all doctest passed.\nI gave a more in-depth look at the code and it looks very good.\nI've just performed some reviewer tweaks, which I pushed in the new branch. You can see the (minor) changes [here](https://git.sagemath.org/sage.git/commit?id=0823e29c5fa02815c71a23f770f8ee226eec7c76).\nIn particular\n- a doctest block has been corrected by adding a missing `::`\n- some PEP 8 enforcement has been performed\n- doctests raising an exception have been rewritten via `Traceback...` instead of a `try` block\n- the header  `# -*- coding: utf-8 -*-` has been added to the file `tensor_with_indices.py`, in order to get rid of the non-ascii error revealed by the patchbot.\n\nDo you agree with the above changes?",
    "created_at": "2019-11-23T21:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402619",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:13'></a>Thanks for making all doctest passed.
I gave a more in-depth look at the code and it looks very good.
I've just performed some reviewer tweaks, which I pushed in the new branch. You can see the (minor) changes [here](https://git.sagemath.org/sage.git/commit?id=0823e29c5fa02815c71a23f770f8ee226eec7c76).
In particular
- a doctest block has been corrected by adding a missing `::`
- some PEP 8 enforcement has been performed
- doctests raising an exception have been rewritten via `Traceback...` instead of a `try` block
- the header  `# -*- coding: utf-8 -*-` has been added to the file `tensor_with_indices.py`, in order to get rid of the non-ascii error revealed by the patchbot.

Do you agree with the above changes?



---

archive/issue_comments_402620.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-24T00:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402620",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402621.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks for the PEP8 enforcement and the correction of the doctest. \n\nOf course, I agree with the changes and merged. \nI quickly reviewed them and checked the doctest. \n\nAlso, I corrected a typo and clarified two lines.",
    "created_at": "2019-11-24T00:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402621",
    "user": "https://github.com/LBrunswic"
}
```

<a id='comment:15'></a>Thanks for the PEP8 enforcement and the correction of the doctest. 

Of course, I agree with the changes and merged. 
I quickly reviewed them and checked the doctest. 

Also, I corrected a typo and clarified two lines.



---

archive/issue_comments_402622.json:
```json
{
    "body": "<a id='comment:16'></a>I would give a positive review but since I modified the code (even marginally) I think I shouldn't do it.",
    "created_at": "2019-11-24T19:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402622",
    "user": "https://github.com/LBrunswic"
}
```

<a id='comment:16'></a>I would give a positive review but since I modified the code (even marginally) I think I shouldn't do it.



---

archive/issue_comments_402623.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-24T19:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402623",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_402624.json:
```json
{
    "body": "<a id='comment:17'></a>I've just checked your latest changes. Everything is OK. \nThanks for this work.",
    "created_at": "2019-11-24T19:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402624",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>I've just checked your latest changes. Everything is OK. 
Thanks for this work.



---

archive/issue_comments_402625.json:
```json
{
    "body": "<a id='comment:18'></a>It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.",
    "created_at": "2019-11-27T18:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402625",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:18'></a>It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.



---

archive/issue_comments_402626.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 gh-mwageringel]:\n> It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.\n\n\nHi! \n\n I completely agree! We should open another ticket or a discussion of devel to discuss this (I would at the very least ask Eric Gourgoulhon for validation). \n\n To begin the discussion, I see other issues with the current implementation and methods.\nFor instance, it's not possible to define the symmetries of the riemann tensor. This is related to the fact that (anti)symmetrize ony takes a set of indices as argument and then consider the action of the natural action of the symmetric group this set.\nIt would be appreciable to define the symmetrization via an action of some group on the set indices. Antisymmetrization would need also a 'signature' morphism G-->{1,-1}. More generally, one could consider linear group action symmetries.",
    "created_at": "2019-11-27T19:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402626",
    "user": "https://github.com/LBrunswic"
}
```

<a id='comment:19'></a>Replying to [comment:18 gh-mwageringel]:
> It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.


Hi! 

 I completely agree! We should open another ticket or a discussion of devel to discuss this (I would at the very least ask Eric Gourgoulhon for validation). 

 To begin the discussion, I see other issues with the current implementation and methods.
For instance, it's not possible to define the symmetries of the riemann tensor. This is related to the fact that (anti)symmetrize ony takes a set of indices as argument and then consider the action of the natural action of the symmetric group this set.
It would be appreciable to define the symmetrization via an action of some group on the set indices. Antisymmetrization would need also a 'signature' morphism G-->{1,-1}. More generally, one could consider linear group action symmetries.



---

archive/issue_comments_402627.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 gh-LBrunswic]:\n> Replying to [comment:18 gh-mwageringel]:\n> > It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.\n\n> \n> Hi! \n> \n>  I completely agree! We should open another ticket or a discussion of devel to discuss this (I would at the very least ask Eric Gourgoulhon for validation). \n> \n\n\nYes please open a ticket for this! (and continue the discussion there).\n \n>  To begin the discussion, I see other issues with the current implementation and methods.\n\n> For instance, it's not possible to define the symmetries of the riemann tensor. This is related to the fact that (anti)symmetrize ony takes a set of indices as argument and then consider the action of the natural action of the symmetric group this set.\n> It would be appreciable to define the symmetrization via an action of some group on the set indices. Antisymmetrization would need also a 'signature' morphism G-->{1,-1}. More generally, one could consider linear group action symmetries.  \n\n\nIndeed, this would be nice.",
    "created_at": "2019-11-28T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402627",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>Replying to [comment:19 gh-LBrunswic]:
> Replying to [comment:18 gh-mwageringel]:
> > It would be nice to add this functionality for multiple symmetrizations to the method `symmetrize()` as well because symmetrization is not necessarily done over neighboring indices which cannot be handled by the string syntax. I assume it is more efficient to do all symmetrizations and antisymmetrizations in a single function call, rather than computing several intermediate results.

> 
> Hi! 
> 
>  I completely agree! We should open another ticket or a discussion of devel to discuss this (I would at the very least ask Eric Gourgoulhon for validation). 
> 


Yes please open a ticket for this! (and continue the discussion there).
 
>  To begin the discussion, I see other issues with the current implementation and methods.

> For instance, it's not possible to define the symmetries of the riemann tensor. This is related to the fact that (anti)symmetrize ony takes a set of indices as argument and then consider the action of the natural action of the symmetric group this set.
> It would be appreciable to define the symmetrization via an action of some group on the set indices. Antisymmetrization would need also a 'signature' morphism G-->{1,-1}. More generally, one could consider linear group action symmetries.  


Indeed, this would be nice.



---

archive/issue_comments_402628.json:
```json
{
    "body": "<a id='comment:21'></a>The new ticket is #28813.",
    "created_at": "2019-11-28T20:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402628",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:21'></a>The new ticket is #28813.



---

archive/issue_comments_402629.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-30T13:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28784#issuecomment-402629",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_072702.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-30T13:36:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28784",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28784#event-72702"
}
```
