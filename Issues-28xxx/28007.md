# Issue 28007: Keep upstream three.js directory structure

archive/issues_027770.json:
```json
{
    "body": "Currently sage flattens the threejs directory structure. It still needs to take the actual structure into account when using threejs from a CDN though.\n\nI don't see a reason to flatten the structure. It should be easier for distributions (certainly is for nixos) to keep the structure.\n\nI have only tested this with the nix package, since it is a pain to get the sage build system working on nixos. Would appreciate it if someone else could test the `build/` changes (simple `make ptestlong`).\n\nCC:  @antonio-rojas @kiwifb @saraedum @timokau @paulmasson\n\nKeywords: threejs\n\nBranch/Commit: 4a69f3bacfbc7c0864ab4097080773bfe6590422\n\nReviewer: Paul Masson\n\nAuthor: Timo Kaufmann\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28007\n\n",
    "closed_at": "2019-06-28T04:29:56Z",
    "created_at": "2019-06-17T20:00:53Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Keep upstream three.js directory structure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28007",
    "user": "https://github.com/timokau"
}
```
Currently sage flattens the threejs directory structure. It still needs to take the actual structure into account when using threejs from a CDN though.

I don't see a reason to flatten the structure. It should be easier for distributions (certainly is for nixos) to keep the structure.

I have only tested this with the nix package, since it is a pain to get the sage build system working on nixos. Would appreciate it if someone else could test the `build/` changes (simple `make ptestlong`).

CC:  @antonio-rojas @kiwifb @saraedum @timokau @paulmasson

Keywords: threejs

Branch/Commit: 4a69f3bacfbc7c0864ab4097080773bfe6590422

Reviewer: Paul Masson

Author: Timo Kaufmann

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28007





---

archive/issue_comments_417628.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-17T20:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417628",
    "user": "https://github.com/timokau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_417629.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-17T21:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417629",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417630.json:
```json
{
    "body": "<a id='comment:3'></a>If you do that, the package will need a rev-bump to be re-installed.",
    "created_at": "2019-06-17T21:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417630",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:3'></a>If you do that, the package will need a rev-bump to be re-installed.



---

archive/issue_comments_417631.json:
```json
{
    "body": "Changing keywords from \"\" to \"threejs\".",
    "created_at": "2019-06-17T22:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417631",
    "user": "https://github.com/paulmasson"
}
```

Changing keywords from "" to "threejs".



---

archive/issue_comments_417632.json:
```json
{
    "body": "<a id='comment:5'></a>Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?",
    "created_at": "2019-06-17T22:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417632",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:5'></a>Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?



---

archive/issue_comments_417633.json:
```json
{
    "body": "<a id='comment:6'></a>What are you installing in nix to find it a burden to change the structure? Because it didn't appear that we are using an upstream tarball I just used sage's one in sage-on-gentoo. Admittedly, I call the package `threejs-sage-extension` and it is installed in a sage related location rather then something more generic.\n\nI am curious of your install procedure and if it make sense for me to follow suite.",
    "created_at": "2019-06-18T01:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417633",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>What are you installing in nix to find it a burden to change the structure? Because it didn't appear that we are using an upstream tarball I just used sage's one in sage-on-gentoo. Admittedly, I call the package `threejs-sage-extension` and it is installed in a sage related location rather then something more generic.

I am curious of your install procedure and if it make sense for me to follow suite.



---

archive/issue_comments_417634.json:
```json
{
    "body": "<a id='comment:7'></a>Regardless of anything else `THREEJSDIR` should be used like you do in this branch even if we don't end up flattening the structure. That would be worth a ticket by itself.",
    "created_at": "2019-06-18T01:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417634",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>Regardless of anything else `THREEJSDIR` should be used like you do in this branch even if we don't end up flattening the structure. That would be worth a ticket by itself.



---

archive/issue_comments_417635.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-18T10:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417635",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417636.json:
```json
{
    "body": "<a id='comment:9'></a>I bumped the patch version and made a separate commit for the `THREEJS_DIR` usage.\n\n---\nNew commits:",
    "created_at": "2019-06-18T10:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417636",
    "user": "https://github.com/timokau"
}
```

<a id='comment:9'></a>I bumped the patch version and made a separate commit for the `THREEJS_DIR` usage.

---
New commits:



---

archive/issue_comments_417637.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:5 paulmasson]:\n> Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?\n\n\nWell sage doesn't actually build anything, it just cherry-picks \"binaries\" (or as close as javascript can come to binaries) from a CDN. If you actually \"build\" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate \"interface\" package that only symlinks the two files to the places sage expects them.\n\n`@`fbissey we have some (suboptimal) npm [infrastructure](https://nixos.org/nixpkgs/manual/#node.js-packages) to package javascript packages, that is what I'm using. As far as I understand it (I haven't really looked into it) it scrapes npm for the dependencies, generates the build recipes, fetches each package from the npm registry and then builds them. So basically a wrapper around npm that takes over all network activity while still using npm for the actual building.",
    "created_at": "2019-06-18T10:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417637",
    "user": "https://github.com/timokau"
}
```

<a id='comment:10'></a>Replying to [comment:5 paulmasson]:
> Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?


Well sage doesn't actually build anything, it just cherry-picks "binaries" (or as close as javascript can come to binaries) from a CDN. If you actually "build" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate "interface" package that only symlinks the two files to the places sage expects them.

`@`fbissey we have some (suboptimal) npm [infrastructure](https://nixos.org/nixpkgs/manual/#node.js-packages) to package javascript packages, that is what I'm using. As far as I understand it (I haven't really looked into it) it scrapes npm for the dependencies, generates the build recipes, fetches each package from the npm registry and then builds them. So basically a wrapper around npm that takes over all network activity while still using npm for the actual building.



---

archive/issue_comments_417638.json:
```json
{
    "body": "<a id='comment:11'></a>Right, npm stuff is a pain. I don't see an updated `package-version.txt` and `checksums.ini`. But technically the real problem is you want to change the tarball without changing the version. That is a bit of a challenge. The nice way to do that is to do an upgrade at the same time so the problem with the tarball change is avoided.",
    "created_at": "2019-06-18T10:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417638",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>Right, npm stuff is a pain. I don't see an updated `package-version.txt` and `checksums.ini`. But technically the real problem is you want to change the tarball without changing the version. That is a bit of a challenge. The nice way to do that is to do an upgrade at the same time so the problem with the tarball change is avoided.



---

archive/issue_comments_417639.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-18T17:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417639",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417640.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-18T17:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417641.json:
```json
{
    "body": "<a id='comment:14'></a>Right, somehow failed to push that.\n\nWhy is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.",
    "created_at": "2019-06-18T17:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417641",
    "user": "https://github.com/timokau"
}
```

<a id='comment:14'></a>Right, somehow failed to push that.

Why is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.



---

archive/issue_comments_417642.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:11 fbissey]:\n> Right, npm stuff is a pain.\n\n\nLife was good when there was only make and autotools. At least for packagers that is.",
    "created_at": "2019-06-18T17:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417642",
    "user": "https://github.com/timokau"
}
```

<a id='comment:15'></a>Replying to [comment:11 fbissey]:
> Right, npm stuff is a pain.


Life was good when there was only make and autotools. At least for packagers that is.



---

archive/issue_comments_417643.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:10 gh-timokau]:\n> Replying to [comment:5 paulmasson]:\n> > Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?\n\n> \n> Well sage doesn't actually build anything, it just cherry-picks \"binaries\" (or as close as javascript can come to binaries) from a CDN. If you actually \"build\" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate \"interface\" package that only symlinks the two files to the places sage expects them.\n\nAs the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice. Given that, keeping the original directory structure really is an extra complication without much practical gain.",
    "created_at": "2019-06-18T19:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417643",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:16'></a>Replying to [comment:10 gh-timokau]:
> Replying to [comment:5 paulmasson]:
> > Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?

> 
> Well sage doesn't actually build anything, it just cherry-picks "binaries" (or as close as javascript can come to binaries) from a CDN. If you actually "build" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate "interface" package that only symlinks the two files to the places sage expects them.

As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice. Given that, keeping the original directory structure really is an extra complication without much practical gain.



---

archive/issue_comments_417644.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:13 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                        |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n> |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|\n\nIn the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.",
    "created_at": "2019-06-18T19:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417644",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:17'></a>Replying to [comment:13 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                        |
> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
> |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|

In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.



---

archive/issue_comments_417645.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-18T19:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417645",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417646.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 paulmasson]:\n> As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice\n\n\nYes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.\n\nI don't really see much of a complication here. Since it makes the `offline` code closer to the one that fetches from the CDN, it may even simplify in the future. But in any case, I don't see any complication for sage.",
    "created_at": "2019-06-18T19:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417646",
    "user": "https://github.com/timokau"
}
```

<a id='comment:18'></a>Replying to [comment:16 paulmasson]:
> As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice


Yes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.

I don't really see much of a complication here. Since it makes the `offline` code closer to the one that fetches from the CDN, it may even simplify in the future. But in any case, I don't see any complication for sage.



---

archive/issue_comments_417647.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-18T19:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417647",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417648.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:17 paulmasson]:\n> Replying to [comment:13 git]:\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n> > |                                                                                                                                           |                        |\n> > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n> > |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|\n\n> In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.\n\nOkay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?",
    "created_at": "2019-06-18T19:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417648",
    "user": "https://github.com/timokau"
}
```

<a id='comment:20'></a>Replying to [comment:17 paulmasson]:
> Replying to [comment:13 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > |                                                                                                                                           |                        |
> > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
> > |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|

> In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.

Okay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?



---

archive/issue_comments_417649.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 gh-timokau]:\n> Replying to [comment:17 paulmasson]:\n> > Replying to [comment:13 git]:\n> > > Branch pushed to git repo; I updated commit sha1. New commits:\n> > > |                                                                                                                                           |                        |\n> > > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n> > > |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|\n\n> > In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.\n> \n> Okay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?\n\nJust attach it to this ticket. Volker does the rest.",
    "created_at": "2019-06-18T19:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417649",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:21'></a>Replying to [comment:20 gh-timokau]:
> Replying to [comment:17 paulmasson]:
> > Replying to [comment:13 git]:
> > > Branch pushed to git repo; I updated commit sha1. New commits:
> > > |                                                                                                                                           |                        |
> > > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
> > > |[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)|`Update threejs to r105`|

> > In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.
> 
> Okay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?

Just attach it to this ticket. Volker does the rest.



---

archive/issue_comments_417650.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 gh-timokau]:\n> Replying to [comment:16 paulmasson]:\n> > As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice\n\n> \n> Yes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.\n\nThen I guess I don\u2019t have an objection, but would like other packagers to chime in.",
    "created_at": "2019-06-18T19:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417650",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:22'></a>Replying to [comment:18 gh-timokau]:
> Replying to [comment:16 paulmasson]:
> > As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice

> 
> Yes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.

Then I guess I don’t have an objection, but would like other packagers to chime in.



---

archive/issue_comments_417651.json:
```json
{
    "body": "Soruce tarball",
    "created_at": "2019-06-18T19:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417651",
    "user": "https://github.com/timokau"
}
```

Soruce tarball



---

archive/issue_comments_417652.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-06-18T19:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417652",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_417653.json:
```json
{
    "body": "<a id='comment:23'></a>Attachment [threejs-r100.tar.gz](tarball://root/attachments/some-uuid/ticket28007/threejs-r100.tar.gz) by @timokau created at 2019-06-18 19:55:02",
    "created_at": "2019-06-18T19:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417653",
    "user": "https://github.com/timokau"
}
```

<a id='comment:23'></a>Attachment [threejs-r100.tar.gz](tarball://root/attachments/some-uuid/ticket28007/threejs-r100.tar.gz) by @timokau created at 2019-06-18 19:55:02



---

archive/issue_comments_417654.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:14 gh-timokau]:\n> Right, somehow failed to push that.\n> \n> Why is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.\n\n\nBecause pkg-$version and pkg-$version.p$number are supposed to have the same tarball in sage's package management system. Which is a problem when the online package repo has to hold tarballs for several versions of sage, see http://mirror.aarnet.edu.au/pub/sage/spkg/upstream/threejs/index.html for a relevant example. This is where patchbot gets their packages by the way.",
    "created_at": "2019-06-18T20:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417654",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:24'></a>Replying to [comment:14 gh-timokau]:
> Right, somehow failed to push that.
> 
> Why is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.


Because pkg-$version and pkg-$version.p$number are supposed to have the same tarball in sage's package management system. Which is a problem when the online package repo has to hold tarballs for several versions of sage, see http://mirror.aarnet.edu.au/pub/sage/spkg/upstream/threejs/index.html for a relevant example. This is where patchbot gets their packages by the way.



---

archive/issue_comments_417655.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-18T20:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417655",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417656.json:
```json
{
    "body": "<a id='comment:26'></a>Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?\n\nThat'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).",
    "created_at": "2019-06-18T20:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417656",
    "user": "https://github.com/timokau"
}
```

<a id='comment:26'></a>Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?

That'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).



---

archive/issue_comments_417657.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 gh-timokau]:\n> Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?\n> \n> That'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).\n\nJust did some local testing with r105 and didn't see any major problems with this version. If you want to add the upgrade back in then I'll review the ticket. Sorry for creating the extra work for you, but I always try to remind people of possible issues with upgrading Three.js.",
    "created_at": "2019-06-18T21:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417657",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:27'></a>Replying to [comment:26 gh-timokau]:
> Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?
> 
> That'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).

Just did some local testing with r105 and didn't see any major problems with this version. If you want to add the upgrade back in then I'll review the ticket. Sorry for creating the extra work for you, but I always try to remind people of possible issues with upgrading Three.js.



---

archive/issue_comments_417658.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-18T21:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417658",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417659.json:
```json
{
    "body": "Up-to-date source tarball",
    "created_at": "2019-06-18T21:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417659",
    "user": "https://github.com/timokau"
}
```

Up-to-date source tarball



---

archive/issue_comments_417660.json:
```json
{
    "body": "<a id='comment:29'></a>Attachment [threejs-r105.tar.gz](tarball://root/attachments/some-uuid/ticket28007/threejs-r105.tar.gz) by @timokau created at 2019-06-18 21:50:33\n\nNot a problem, dealing with backwards incompatibility is always annoying. Update re-added.\n\n---\nNew commits:",
    "created_at": "2019-06-18T21:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417660",
    "user": "https://github.com/timokau"
}
```

<a id='comment:29'></a>Attachment [threejs-r105.tar.gz](tarball://root/attachments/some-uuid/ticket28007/threejs-r105.tar.gz) by @timokau created at 2019-06-18 21:50:33

Not a problem, dealing with backwards incompatibility is always annoying. Update re-added.

---
New commits:



---

archive/issue_comments_417661.json:
```json
{
    "body": "<a id='comment:30'></a>gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)",
    "created_at": "2019-06-18T22:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417661",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:30'></a>gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)



---

archive/issue_comments_417662.json:
```json
{
    "body": "<a id='comment:31'></a>I think it may indeed. It certainly addresses some points raised here. I quite like #26434 (beside the obvious reason of removing `installed_packages`).",
    "created_at": "2019-06-18T22:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417662",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:31'></a>I think it may indeed. It certainly addresses some points raised here. I quite like #26434 (beside the obvious reason of removing `installed_packages`).



---

archive/issue_comments_417663.json:
```json
{
    "body": "<a id='comment:32'></a>To be clear, there should be coordination between the tickets. #26434 does a lot of the dealing internally with script locations. But this ticket is talking about changing the way threejs is packaged and installed. And because the cleanest way to achieve this is an upgrade, it does that too. \n\nAdopting #26434 means this ticket can do its packaging changes without touching \"sage\"'s code.",
    "created_at": "2019-06-18T22:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417663",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:32'></a>To be clear, there should be coordination between the tickets. #26434 does a lot of the dealing internally with script locations. But this ticket is talking about changing the way threejs is packaged and installed. And because the cleanest way to achieve this is an upgrade, it does that too. 

Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.



---

archive/issue_comments_417664.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:30 saraedum]:\n> gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)\n\nThat ticket appears to remove the online, i.e. CDN scripts, completely and only uses local scripts. How will that allow people to create and share notebooks? The CDN fallback was fixed in #27575 and would likely have addressed the issues you encountered at the conference.",
    "created_at": "2019-06-18T22:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417664",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:33'></a>Replying to [comment:30 saraedum]:
> gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)

That ticket appears to remove the online, i.e. CDN scripts, completely and only uses local scripts. How will that allow people to create and share notebooks? The CDN fallback was fixed in #27575 and would likely have addressed the issues you encountered at the conference.



---

archive/issue_comments_417665.json:
```json
{
    "body": "<a id='comment:34'></a>`@`paulmasson the issue that #26434 originally seeks to address is that sage is calling its internal package management to figure out the version of threejs to look for. For us on distro it is not feasible or desirable.",
    "created_at": "2019-06-18T22:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417665",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:34'></a>`@`paulmasson the issue that #26434 originally seeks to address is that sage is calling its internal package management to figure out the version of threejs to look for. For us on distro it is not feasible or desirable.



---

archive/issue_comments_417666.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:32 fbissey]:\n> Adopting #26434 means this ticket can do its packaging changes without touching \"sage\"'s code.\n\n\nHow is that? #26434 still contains this line:\n\n```\nscripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]\n```",
    "created_at": "2019-06-19T08:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417666",
    "user": "https://github.com/timokau"
}
```

<a id='comment:35'></a>Replying to [comment:32 fbissey]:
> Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.


How is that? #26434 still contains this line:

```
scripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]
```



---

archive/issue_comments_417667.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 gh-timokau]:\n> Replying to [comment:32 fbissey]:\n> > Adopting #26434 means this ticket can do its packaging changes without touching \"sage\"'s code.\n\n> \n> How is that? #26434 still contains this line:\n> \n> \n> ```\n> scripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]\n> ```\n\n\nYou are right. I misread something this morning, I thought it was walking in any subdirectories for some reason.",
    "created_at": "2019-06-19T09:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417667",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:36'></a>Replying to [comment:35 gh-timokau]:
> Replying to [comment:32 fbissey]:
> > Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.

> 
> How is that? #26434 still contains this line:
> 
> 
> ```
> scripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]
> ```


You are right. I misread something this morning, I thought it was walking in any subdirectories for some reason.



---

archive/issue_comments_417668.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-06-19T23:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417668",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_417669.json:
```json
{
    "body": "<a id='comment:37'></a>LGTM",
    "created_at": "2019-06-19T23:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417669",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:37'></a>LGTM



---

archive/issue_events_069409.json:
```json
{
    "actor": "https://github.com/paulmasson",
    "created_at": "2019-06-19T23:56:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28007#event-69409"
}
```



---

archive/issue_comments_417670.json:
```json
{
    "body": "<a id='comment:38'></a>Thank you for the review!",
    "created_at": "2019-06-20T11:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417670",
    "user": "https://github.com/timokau"
}
```

<a id='comment:38'></a>Thank you for the review!



---

archive/issue_events_069410.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-28T04:29:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28007#event-69410"
}
```



---

archive/issue_comments_417671.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-28T04:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28007#issuecomment-417671",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
