# Issue 28539: Optimization for small permutation groups

archive/issues_028302.json:
```json
{
    "body": "This ticket proposes micro optimizations for small permutation\ngroups. The rationale is to handle the situation where we have\nbillions of combinatorial objects and need to run through their\nautomorphism groups most of which are trivial or let's say have\nsize at most 100. An even more concrete application is given by\n[admcycles MR 14](https://gitlab.com/jo314schmitt/admcycles/merge_requests/14)\nwhere there is an attempt to use graph automorphisms from Sage\ninstead of a handmade implementation. This turns out to result\nin a major slowdown! For example\n\n```\nsage: from admcycles.admcycles import Hyperell\nsage: %time H = Hyperell(3)\n```\ntakes 13.5 s on master but with MR 14 takes 17.4 s.\n\nThe profiling points to\n\n- the constructor `__init__` of `PermutationGroupElement`:\n  see #28652\n- the `subgroup` method of `PermutationGroupElement`\n- the product `p1 * p2` when `p1` is a symmetric group element\n  and `p2` is a permutation group on the same domain:\n  see #28652 (and also the bug #28544)\n- `__iter__` for `PermutationGroupElement` (that currently\n  involves computing a strong generating scheme):\n  see #28652 and #28653\n\nThe optimizations proposed in this ticket noticeably speed up\nthe `Hyperell(3)` computation mentioned above: from 17.4 s with\nthe previous Sage implementation or 13.5 s with admcycle's\nprevious handmade implementation, the timing goes down to 9 s.\n\nCC:  @tscrim @fchapoton @simonbrandhorst\n\nAuthor: Vincent Delecroix\n\nBranch: u/vdelecroix/28539\n\nStatus: needs_work\n\nDependencies: #28544, #28652, #28653\n\nCommit: 44bd8638bebbed543ff6f3c13846893ebca17f8b\n\nIssue created by migration from https://trac.sagemath.org/ticket/28539\n\n",
    "created_at": "2019-09-26T11:16:12Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Optimization for small permutation groups",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28539",
    "user": "https://github.com/videlec"
}
```
This ticket proposes micro optimizations for small permutation
groups. The rationale is to handle the situation where we have
billions of combinatorial objects and need to run through their
automorphism groups most of which are trivial or let's say have
size at most 100. An even more concrete application is given by
[admcycles MR 14](https://gitlab.com/jo314schmitt/admcycles/merge_requests/14)
where there is an attempt to use graph automorphisms from Sage
instead of a handmade implementation. This turns out to result
in a major slowdown! For example

```
sage: from admcycles.admcycles import Hyperell
sage: %time H = Hyperell(3)
```
takes 13.5 s on master but with MR 14 takes 17.4 s.

The profiling points to

- the constructor `__init__` of `PermutationGroupElement`:
  see #28652
- the `subgroup` method of `PermutationGroupElement`
- the product `p1 * p2` when `p1` is a symmetric group element
  and `p2` is a permutation group on the same domain:
  see #28652 (and also the bug #28544)
- `__iter__` for `PermutationGroupElement` (that currently
  involves computing a strong generating scheme):
  see #28652 and #28653

The optimizations proposed in this ticket noticeably speed up
the `Hyperell(3)` computation mentioned above: from 17.4 s with
the previous Sage implementation or 13.5 s with admcycle's
previous handmade implementation, the timing goes down to 9 s.

CC:  @tscrim @fchapoton @simonbrandhorst

Author: Vincent Delecroix

Branch: u/vdelecroix/28539

Status: needs_work

Dependencies: #28544, #28652, #28653

Commit: 44bd8638bebbed543ff6f3c13846893ebca17f8b

Issue created by migration from https://trac.sagemath.org/ticket/28539





---

archive/issue_comments_399276.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-09-26T11:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399276",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_399277.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-30T08:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399278.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-30T08:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399278",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399279.json:
```json
{
    "body": "<a id='comment:5'></a>hmm some py2/py3 issue I guess.",
    "created_at": "2019-09-30T12:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399279",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>hmm some py2/py3 issue I guess.



---

archive/issue_comments_399280.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-30T12:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399280",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399281.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-30T14:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399282.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-30T15:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399283.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-30T15:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399283",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399284.json:
```json
{
    "body": "<a id='comment:9'></a>Still failing. And proliferation of #py2 and # py3 does not seem to be a good solution.",
    "created_at": "2019-10-01T06:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399284",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>Still failing. And proliferation of #py2 and # py3 does not seem to be a good solution.



---

archive/issue_comments_399285.json:
```json
{
    "body": "<a id='comment:10'></a>I agree with Fr\u00e9d\u00e9ric that adding a whole bunch of `# py2` and `# py3` tags is not a good solution. I am assuming this comes from this change:\n\n```diff\n-        return self.iteration(algorithm=\"SGS\")\n+        if len(self._gens) == 1:\n+            return self._iteration_monogen()\n+        elif self.cardinality() <= 100:\n+            return self.iteration(algorithm=\"BFS\")\n+        else:\n+            return self.iteration(algorithm=\"SGS\")\n```\nand the `BFS` option calls `RecursivelyEnumeratedSet`, which has consistency problems on Python3 IIRC. So we have to solve that bigger problem first.\n\nI have some other comments:\n\nI don't see the point of going to cycles just to convert back here:\n\n```\nreturn grp.element_class(self.to_cycles(singletons=False), grp, check=False)\n```\nI know this was already done, but it seems useless as the `PermutationGroupElement` stores things internally as a list in essentially the same way.\n\nI would probably Cythonize `from_cycles`.\n\nIs there a reason why `_set_identity` and `_set_list_images` are `cpdef` and not just `cdef` (which is faster when being called by C code)? By being `cpdef`, they also need doctests.",
    "created_at": "2019-10-02T01:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399285",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>I agree with Frédéric that adding a whole bunch of `# py2` and `# py3` tags is not a good solution. I am assuming this comes from this change:

```diff
-        return self.iteration(algorithm="SGS")
+        if len(self._gens) == 1:
+            return self._iteration_monogen()
+        elif self.cardinality() <= 100:
+            return self.iteration(algorithm="BFS")
+        else:
+            return self.iteration(algorithm="SGS")
```
and the `BFS` option calls `RecursivelyEnumeratedSet`, which has consistency problems on Python3 IIRC. So we have to solve that bigger problem first.

I have some other comments:

I don't see the point of going to cycles just to convert back here:

```
return grp.element_class(self.to_cycles(singletons=False), grp, check=False)
```
I know this was already done, but it seems useless as the `PermutationGroupElement` stores things internally as a list in essentially the same way.

I would probably Cythonize `from_cycles`.

Is there a reason why `_set_identity` and `_set_list_images` are `cpdef` and not just `cdef` (which is faster when being called by C code)? By being `cpdef`, they also need doctests.



---

archive/issue_comments_399286.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-10-02T01:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399286",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_399287.json:
```json
{
    "body": "<a id='comment:11'></a>Thanks for the feedback. I will cut the ticket and start by optimizing the constructor. Optimizing the iterator will be postponed to another one.",
    "created_at": "2019-10-02T03:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399287",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Thanks for the feedback. I will cut the ticket and start by optimizing the constructor. Optimizing the iterator will be postponed to another one.



---

archive/issue_comments_399288.json:
```json
{
    "body": "Changing type from enhancement to task.",
    "created_at": "2019-10-25T01:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399288",
    "user": "https://github.com/videlec"
}
```

Changing type from enhancement to task.



---

archive/issue_comments_399289.json:
```json
{
    "body": "<a id='comment:14'></a>See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.",
    "created_at": "2019-10-29T23:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399289",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:14'></a>See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.



---

archive/issue_comments_399290.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 gh-mwageringel]:\n> See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.\n\n\nI don't think that the enumeration order is relevant here. This is convenient for doctests and only shows the weakness of them.",
    "created_at": "2019-10-31T15:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399290",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 gh-mwageringel]:
> See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.


I don't think that the enumeration order is relevant here. This is convenient for doctests and only shows the weakness of them.



---

archive/issue_events_071582.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71582"
}
```



---

archive/issue_comments_399291.json:
```json
{
    "body": "<a id='comment:16'></a>Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399291",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Ticket retargeted after milestone closed



---

archive/issue_comments_399292.json:
```json
{
    "body": "<a id='comment:17'></a>Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399292",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_071583.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71583"
}
```



---

archive/issue_events_071584.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71584"
}
```



---

archive/issue_comments_399293.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-08-31T20:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399293",
    "user": "https://github.com/slel"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_399294.json:
```json
{
    "body": "<a id='comment:18'></a>Supporting Python 2 is no longer needed now.",
    "created_at": "2020-08-31T20:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399294",
    "user": "https://github.com/slel"
}
```

<a id='comment:18'></a>Supporting Python 2 is no longer needed now.



---

archive/issue_events_071585.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71585"
}
```



---

archive/issue_events_071586.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71586"
}
```



---

archive/issue_comments_399295.json:
```json
{
    "body": "<a id='comment:20'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399295",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_071587.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71587"
}
```



---

archive/issue_events_071588.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71588"
}
```



---

archive/issue_comments_399296.json:
```json
{
    "body": "<a id='comment:21'></a>Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28539#issuecomment-399296",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_071589.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71589"
}
```



---

archive/issue_events_071590.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71590"
}
```



---

archive/issue_events_071591.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71591"
}
```



---

archive/issue_events_071592.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71592"
}
```



---

archive/issue_events_071593.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71593"
}
```



---

archive/issue_events_071594.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71594"
}
```



---

archive/issue_events_071595.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71595"
}
```



---

archive/issue_events_071596.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28539",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28539#event-71596"
}
```
