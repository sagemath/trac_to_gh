# Issue 28681: py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules

archive/issues_028444.json:
```json
{
    "body": "The following happened with [SageMath](SageMath) 9.0.beta3 / Python 3\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: cartesian_product([FF,FF])\nKeyError                                  Traceback (most recent call last)\n...\nTypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()\n```\n\n**Branch/Commit:** [3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)\n\n**Reviewer:** Markus Wageringel\n\n**Author:** Christian Nassau\n\nIssue created by migration from https://trac.sagemath.org/ticket/28681\n\n",
    "closed_at": "2019-11-07T23:29:57Z",
    "created_at": "2019-10-31T06:48:58Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28681",
    "user": "https://github.com/cnassau"
}
```
The following happened with [SageMath](SageMath) 9.0.beta3 / Python 3

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: cartesian_product([FF,FF])
KeyError                                  Traceback (most recent call last)
...
TypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()
```

**Branch/Commit:** [3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)

**Reviewer:** Markus Wageringel

**Author:** Christian Nassau

Issue created by migration from https://trac.sagemath.org/ticket/28681





---

archive/issue_events_258767.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-10-31T10:48:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "rename": {
        "from": "Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
        "to": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258767"
}
```



---

archive/issue_comments_451736.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis works with Python 2.\n\n```\nsage: cartesian_product([FF,FF])\nFree module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring\n```",
    "created_at": "2019-10-31T10:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451736",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:1'></a>
This works with Python 2.

```
sage: cartesian_product([FF,FF])
Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring
```



---

archive/issue_comments_451737.json:
```json
{
    "body": "<a id='comment:2'></a>\nSee also #26731 which fails with a similar error, even in Python 2.",
    "created_at": "2019-10-31T11:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451737",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>
See also #26731 which fails with a similar error, even in Python 2.



---

archive/issue_comments_451738.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe following reveals a relevant difference. This is with Python 2:\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: I=FF.basis().keys()\nsage: type(I)\n<class 'sage.combinat.combinat.MapCombinatorialClass'>\nsage: I.__hash__\n<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>\n```\nWith Python 3 the `I.__hash__` is None.\n\nThis appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass",
    "created_at": "2019-11-01T16:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451738",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:3'></a>
The following reveals a relevant difference. This is with Python 2:

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: I=FF.basis().keys()
sage: type(I)
<class 'sage.combinat.combinat.MapCombinatorialClass'>
sage: I.__hash__
<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>
```
With Python 3 the `I.__hash__` is None.

This appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass



---

archive/issue_comments_451739.json:
```json
{
    "body": "**Commit:** [5f95445a42f16fe241ee8e4cdd0b464f043513e7](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)",
    "created_at": "2019-11-01T22:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451739",
    "user": "https://github.com/cnassau"
}
```

**Commit:** [5f95445a42f16fe241ee8e4cdd0b464f043513e7](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)



---

archive/issue_comments_451740.json:
```json
{
    "body": "**Branch:** [u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)",
    "created_at": "2019-11-01T22:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451740",
    "user": "https://github.com/cnassau"
}
```

**Branch:** [u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)



---

archive/issue_comments_451741.json:
```json
{
    "body": "<a id='comment:5'></a>\nAs explained in \"the docs\" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).\n\nMy patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.",
    "created_at": "2019-11-01T23:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451741",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:5'></a>
As explained in "the docs" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).

My patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.



---

archive/issue_events_258768.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-11-01T23:01:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258768"
}
```



---

archive/issue_comments_451742.json:
```json
{
    "body": "**Author:** Christian Nassau",
    "created_at": "2019-11-01T23:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451742",
    "user": "https://github.com/cnassau"
}
```

**Author:** Christian Nassau



---

archive/issue_comments_451743.json:
```json
{
    "body": "**Changing commit** from \"[5f95445a42f16fe241ee8e4cdd0b464f043513e7](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)\" to \"[d120c9454ed927704085e3662a277f3689899270](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)\".",
    "created_at": "2019-11-01T23:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451743",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[5f95445a42f16fe241ee8e4cdd0b464f043513e7](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)" to "[d120c9454ed927704085e3662a277f3689899270](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)".



---

archive/issue_comments_451744.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)\" to \"[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)\".",
    "created_at": "2019-11-01T23:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451744",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)" to "[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)".



---

archive/issue_comments_451745.json:
```json
{
    "body": "<a id='comment:8'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270\">d120c94</a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>\n",
    "created_at": "2019-11-01T23:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451745",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:8'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270">d120c94</a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>




---

archive/issue_comments_451746.json:
```json
{
    "body": "<a id='comment:9'></a>\nOk, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.",
    "created_at": "2019-11-03T20:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451746",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>
Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.



---

archive/issue_comments_451747.json:
```json
{
    "body": "<a id='comment:10'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a\">3a67869</a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>\n",
    "created_at": "2019-11-03T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451747",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:10'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a">3a67869</a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>




---

archive/issue_comments_451748.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)\" to \"[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)\".",
    "created_at": "2019-11-03T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451748",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)" to "[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)".



---

archive/issue_comments_451749.json:
```json
{
    "body": "**Changing commit** from \"[d120c9454ed927704085e3662a277f3689899270](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)\" to \"[3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)\".",
    "created_at": "2019-11-03T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451749",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[d120c9454ed927704085e3662a277f3689899270](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)" to "[3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)".



---

archive/issue_comments_451750.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [gh-mwageringel](#comment%3A9):\n> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.\n\n\nThanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.",
    "created_at": "2019-11-03T21:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451750",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:11'></a>
Replying to [gh-mwageringel](#comment%3A9):
> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.


Thanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.



---

archive/issue_events_258769.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258769"
}
```



---

archive/issue_events_258770.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258770"
}
```



---

archive/issue_comments_451751.json:
```json
{
    "body": "**Reviewer:** Markus Wageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451751",
    "user": "https://github.com/mwageringel"
}
```

**Reviewer:** Markus Wageringel



---

archive/issue_comments_451752.json:
```json
{
    "body": "<a id='comment:12'></a>\nThank you. This looks good to me now.",
    "created_at": "2019-11-04T08:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451752",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:12'></a>
Thank you. This looks good to me now.



---

archive/issue_events_258771.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258771"
}
```



---

archive/issue_events_258772.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28681#event-258772"
}
```



---

archive/issue_comments_451753.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)\" to \"[3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)\".",
    "created_at": "2019-11-07T23:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-451753",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)" to "[3a67869fec793f40da2c80cb6d97649d69d7db5a](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)".
