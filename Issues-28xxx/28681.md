# Issue 28681: py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules

archive/issues_028444.json:
```json
{
    "assignees": [],
    "body": "The following happened with [SageMath](../wiki/SageMath) 9.0.beta3 / Python 3\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: cartesian_product([FF,FF])\nKeyError                                  Traceback (most recent call last)\n...\nTypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()\n```\n\nBranch/Commit: **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**\n\nReviewer: **Markus Wageringel**\n\nAuthor: **Christian Nassau**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28681_\n\n",
    "closed_at": "2019-11-07T23:29:57Z",
    "created_at": "2019-10-31T06:48:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "type": "issue",
    "updated_at": "2019-11-07T23:29:57Z",
    "url": "https://github.com/sagemath/sage/issues/28681",
    "user": "https://github.com/cnassau"
}
```
The following happened with [SageMath](../wiki/SageMath) 9.0.beta3 / Python 3

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: cartesian_product([FF,FF])
KeyError                                  Traceback (most recent call last)
...
TypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()
```

Branch/Commit: **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**

Reviewer: **Markus Wageringel**

Author: **Christian Nassau**

_Issue created by migration from https://trac.sagemath.org/ticket/28681_





---

archive/issue_events_375694.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375694"
}
```



---

archive/issue_events_375695.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "component: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375695"
}
```



---

archive/issue_events_375696.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375696"
}
```



---

archive/issue_events_375697.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375697"
}
```



---

archive/issue_events_375698.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-10-31T10:48:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "title_is": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "title_was": "Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375698"
}
```



---

archive/issue_comments_450333.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nThis works with Python 2.\n\n```\nsage: cartesian_product([FF,FF])\nFree module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring\n```",
    "created_at": "2019-10-31T10:48:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450333",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:1" align="right">Comment 1</div>

This works with Python 2.

```
sage: cartesian_product([FF,FF])
Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring
```



---

archive/issue_comments_450334.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nSee also #26731 which fails with a similar error, even in Python 2.",
    "created_at": "2019-10-31T11:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450334",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:2" align="right">Comment 2</div>

See also #26731 which fails with a similar error, even in Python 2.



---

archive/issue_comments_450335.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nThe following reveals a relevant difference. This is with Python 2:\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: I=FF.basis().keys()\nsage: type(I)\n<class 'sage.combinat.combinat.MapCombinatorialClass'>\nsage: I.__hash__\n<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>\n```\nWith Python 3 the `I.__hash__` is None.\n\nThis appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass",
    "created_at": "2019-11-01T16:02:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450335",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:3" align="right">Comment 3</div>

The following reveals a relevant difference. This is with Python 2:

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: I=FF.basis().keys()
sage: type(I)
<class 'sage.combinat.combinat.MapCombinatorialClass'>
sage: I.__hash__
<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>
```
With Python 3 the `I.__hash__` is None.

This appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass



---

archive/issue_comments_450336.json:
```json
{
    "body": "Commit: **[5f95445](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)**",
    "created_at": "2019-11-01T22:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450336",
    "user": "https://github.com/cnassau"
}
```

Commit: **[5f95445](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)**



---

archive/issue_comments_450337.json:
```json
{
    "body": "Branch: **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)**",
    "created_at": "2019-11-01T22:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450337",
    "user": "https://github.com/cnassau"
}
```

Branch: **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)**



---

archive/issue_comments_450338.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nAs explained in \"the docs\" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).\n\nMy patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.",
    "created_at": "2019-11-01T23:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450338",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:5" align="right">Comment 5</div>

As explained in "the docs" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).

My patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.



---

archive/issue_events_375699.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-11-01T23:01:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375699"
}
```



---

archive/issue_comments_450339.json:
```json
{
    "body": "Author: **Christian Nassau**",
    "created_at": "2019-11-01T23:01:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450339",
    "user": "https://github.com/cnassau"
}
```

Author: **Christian Nassau**



---

archive/issue_comments_450340.json:
```json
{
    "body": "Changed commit from **[5f95445](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)** to **[d120c94](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)**",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450340",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[5f95445](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)** to **[d120c94](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)**



---

archive/issue_comments_450341.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)** to **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)**",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450341",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)** to **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)**



---

archive/issue_comments_450342.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270\">d120c94</a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>\n",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450342",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:8" align="right">Comment 8</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270">d120c94</a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>




---

archive/issue_comments_450343.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nOk, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.",
    "created_at": "2019-11-03T20:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450343",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:9" align="right">Comment 9</div>

Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.



---

archive/issue_comments_450344.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a\">3a67869</a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>\n",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450344",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:10" align="right">Comment 10</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a">3a67869</a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>




---

archive/issue_comments_450345.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)** to **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)**",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450345",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)** to **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)**



---

archive/issue_comments_450346.json:
```json
{
    "body": "Changed commit from **[d120c94](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)** to **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450346",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[d120c94](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)** to **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**



---

archive/issue_comments_450347.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nReplying to [@mwageringel](#comment%3A9):\n> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.\n\nThanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.",
    "created_at": "2019-11-03T21:21:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450347",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:11" align="right">Comment 11</div>

Replying to [@mwageringel](#comment%3A9):
> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.

Thanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.



---

archive/issue_events_375700.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375700"
}
```



---

archive/issue_events_375701.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375701"
}
```



---

archive/issue_comments_450348.json:
```json
{
    "body": "Reviewer: **Markus Wageringel**",
    "created_at": "2019-11-04T08:00:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450348",
    "user": "https://github.com/mwageringel"
}
```

Reviewer: **Markus Wageringel**



---

archive/issue_comments_450349.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nThank you. This looks good to me now.",
    "created_at": "2019-11-04T08:00:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450349",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:12" align="right">Comment 12</div>

Thank you. This looks good to me now.



---

archive/issue_events_375702.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375702"
}
```



---

archive/issue_events_375703.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "c26dd23b463daab0310b0217444b78f833a07147",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-375703"
}
```



---

archive/issue_comments_450350.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)** to **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**",
    "created_at": "2019-11-07T23:29:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-450350",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)** to **[3a67869](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**
