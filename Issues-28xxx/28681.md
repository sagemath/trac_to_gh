# Issue 28681: py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules

archive/issues_028444.json:
```json
{
    "assignees": [],
    "body": "The following happened with [SageMath](../wiki/SageMath) 9.0.beta3 / Python 3\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: cartesian_product([FF,FF])\nKeyError                                  Traceback (most recent call last)\n...\nTypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()\n```\n\nBranch/Commit: **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**\n\nReviewer: **Markus Wageringel**\n\nAuthor: **Christian Nassau**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28681_\n\n",
    "closed_at": "2019-11-07T23:29:57Z",
    "created_at": "2019-10-31T06:48:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "type": "issue",
    "updated_at": "2019-11-07T23:29:57Z",
    "url": "https://github.com/sagemath/sage/issues/28681",
    "user": "https://github.com/cnassau"
}
```
The following happened with [SageMath](../wiki/SageMath) 9.0.beta3 / Python 3

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: cartesian_product([FF,FF])
KeyError                                  Traceback (most recent call last)
...
TypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()
```

Branch/Commit: **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**

Reviewer: **Markus Wageringel**

Author: **Christian Nassau**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/28681_





---

archive/issue_events_393921.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393921"
}
```



---

archive/issue_events_393922.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393922"
}
```



---

archive/issue_events_393923.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393923"
}
```



---

archive/issue_events_393924.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-10-31T06:48:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393924"
}
```



---

archive/issue_events_393925.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-10-31T10:48:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "title_is": "py3: Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "title_was": "Construction of (A#A)+(A#A) fails for CombinatorialFreeModules",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393925"
}
```



---

archive/issue_comments_447465.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThis works with Python 2.\n\n```\nsage: cartesian_product([FF,FF])\nFree module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring\n```",
    "created_at": "2019-10-31T10:48:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447465",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:1" align="right">comment:1</div>

This works with Python 2.

```
sage: cartesian_product([FF,FF])
Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring # Free module generated by Integer Ring over Integer Ring
```



---

archive/issue_comments_447466.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nSee also #26731 which fails with a similar error, even in Python 2.",
    "created_at": "2019-10-31T11:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447466",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:2" align="right">comment:2</div>

See also #26731 which fails with a similar error, even in Python 2.



---

archive/issue_comments_447467.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe following reveals a relevant difference. This is with Python 2:\n\n```\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: FF=tensor((F,F))\nsage: I=FF.basis().keys()\nsage: type(I)\n<class 'sage.combinat.combinat.MapCombinatorialClass'>\nsage: I.__hash__\n<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>\n```\nWith Python 3 the `I.__hash__` is None.\n\nThis appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass",
    "created_at": "2019-11-01T16:02:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447467",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:3" align="right">comment:3</div>

The following reveals a relevant difference. This is with Python 2:

```
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: FF=tensor((F,F))
sage: I=FF.basis().keys()
sage: type(I)
<class 'sage.combinat.combinat.MapCombinatorialClass'>
sage: I.__hash__
<method-wrapper '__hash__' of MapCombinatorialClass object at 0x7f58b5a22338>
```
With Python 3 the `I.__hash__` is None.

This appears to be explained here: https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass



---

archive/issue_comments_447468.json:
```json
{
    "body": "Commit: **[`5f95445`](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)**",
    "created_at": "2019-11-01T22:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447468",
    "user": "https://github.com/cnassau"
}
```

Commit: **[`5f95445`](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)**



---

archive/issue_comments_447469.json:
```json
{
    "body": "Branch: **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)**",
    "created_at": "2019-11-01T22:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447469",
    "user": "https://github.com/cnassau"
}
```

Branch: **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)**



---

archive/issue_comments_447470.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAs explained in \"the docs\" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).\n\nMy patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.",
    "created_at": "2019-11-01T23:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447470",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:5" align="right">comment:5</div>

As explained in "the docs" (and found here https://stackoverflow.com/questions/53518981/inheritance-hash-sets-to-none-in-a-subclass ), a class that defines `__eq__` or other comparison functions does no longer inherit the `__hash__` from its base classes. In python2 the (long deprecated) CombinatorialClass inherited its hash from CategoryObject (where it is computed from the string representation).

My patch adds an explicit `__hash__` for CombinatorialClass objects, also based on the string representation. This seems to fix the issue.



---

archive/issue_events_393926.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2019-11-01T23:01:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393926"
}
```



---

archive/issue_comments_447471.json:
```json
{
    "body": "Author: **Christian Nassau**",
    "created_at": "2019-11-01T23:01:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447471",
    "user": "https://github.com/cnassau"
}
```

Author: **Christian Nassau**



---

archive/issue_comments_447472.json:
```json
{
    "body": "Changed commit from **[`5f95445`](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)** to **[`d120c94`](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)**",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447472",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[`5f95445`](https://github.com/sagemath/sagetrac-mirror/commit/5f95445a42f16fe241ee8e4cdd0b464f043513e7)** to **[`d120c94`](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)**



---

archive/issue_comments_447473.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)** to **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)**",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447473",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[u/cnassau/combinathash](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash)** to **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)**



---

archive/issue_comments_447474.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270\"><code>d120c94</code></a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>\n",
    "created_at": "2019-11-01T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447474",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:8"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270"><code>d120c94</code></a></td><td><code>#28681: make CombinatorialClass hashable with Python 3</code></td></tr></table>




---

archive/issue_comments_447475.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nOk, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.",
    "created_at": "2019-11-03T20:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447475",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:9" align="right">comment:9</div>

Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.



---

archive/issue_comments_447476.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a\"><code>3a67869</code></a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>\n",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447476",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:10"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a"><code>3a67869</code></a></td><td><code>Ticket 28681: restore `__hash__` for CombinatorialClass objects</code></td></tr></table>




---

archive/issue_comments_447477.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)** to **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)**",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447477",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[u/cnassau/combinathash2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash2)** to **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)**



---

archive/issue_comments_447478.json:
```json
{
    "body": "Changed commit from **[`d120c94`](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)** to **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**",
    "created_at": "2019-11-03T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447478",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[`d120c94`](https://github.com/sagemath/sagetrac-mirror/commit/d120c9454ed927704085e3662a277f3689899270)** to **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**



---

archive/issue_comments_447479.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@mwageringel](#comment:9):\n> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.\n\nThanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.",
    "created_at": "2019-11-03T21:21:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447479",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@mwageringel](#comment:9):
> Ok, this seems to work and with Python 2 the hashes seem to be the same as before. The implementation of `__eq__` calls `repr()` instead of `str()` though, so ideally the same should be done in the hash function. Moreover, I think it would be good to mention the number of this ticket and add a doctest about the initial problem with cartesian products.

Thanks for looking into this!  I have now added a test for the original failure in `free_modules.py` and also changed the definition of `__hash__` to use `repr` rather than `str`.



---

archive/issue_events_393927.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393927"
}
```



---

archive/issue_events_393928.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-04T08:00:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393928"
}
```



---

archive/issue_comments_447480.json:
```json
{
    "body": "Reviewer: **Markus Wageringel**",
    "created_at": "2019-11-04T08:00:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447480",
    "user": "https://github.com/mwageringel"
}
```

Reviewer: **Markus Wageringel**



---

archive/issue_comments_447481.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThank you. This looks good to me now.",
    "created_at": "2019-11-04T08:00:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447481",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:12" align="right">comment:12</div>

Thank you. This looks good to me now.



---

archive/issue_events_393929.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393929"
}
```



---

archive/issue_events_393930.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "c26dd23b463daab0310b0217444b78f833a07147",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-11-07T23:29:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28681#event-393930"
}
```



---

archive/issue_comments_447482.json:
```json
{
    "body": "Changed branch from **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)** to **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**",
    "created_at": "2019-11-07T23:29:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28681#issuecomment-447482",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/cnassau/combinathash3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/combinathash3)** to **[`3a67869`](https://github.com/sagemath/sagetrac-mirror/commit/3a67869fec793f40da2c80cb6d97649d69d7db5a)**
