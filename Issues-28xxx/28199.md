# Issue 28199: gcd can be very slow in AA[x]

archive/issues_027962.json:
```json
{
    "body": "Here is a x50 slower example\n\n```\nsage: x,y = polygens(QQ,\"x,y\")\nsage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422\nsage: p2 = p1(x=(x-1)^2)\nsage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()\nsage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]\nsage: %time _ = p4.squarefree_decomposition()\nCPU times: user 807 \u00b5s, sys: 0 ns, total: 807 \u00b5s\nWall time: 883 \u00b5s\nsage: %time _ = p4.change_ring(AA).squarefree_decomposition()\nCPU times: user 40.1 s, sys: 3.21 ms, total: 40.1 s\nWall time: 40.1 s\n```\nThis problem originally appeared in #17895 (where a better workaround has been found).\n\nCC:  @bgrenet @mezzarobba\n\nBranch: u/bruno/gcd_via_UFD\n\nStatus: new\n\nCommit: 62db08ca0b85c535f3d6ef5bacac19ecefa8908b\n\nIssue created by migration from https://trac.sagemath.org/ticket/28199\n\n",
    "created_at": "2019-07-14T22:14:25Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "gcd can be very slow in AA[x]",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28199",
    "user": "https://github.com/videlec"
}
```
Here is a x50 slower example

```
sage: x,y = polygens(QQ,"x,y")
sage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422
sage: p2 = p1(x=(x-1)^2)
sage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()
sage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]
sage: %time _ = p4.squarefree_decomposition()
CPU times: user 807 µs, sys: 0 ns, total: 807 µs
Wall time: 883 µs
sage: %time _ = p4.change_ring(AA).squarefree_decomposition()
CPU times: user 40.1 s, sys: 3.21 ms, total: 40.1 s
Wall time: 40.1 s
```
This problem originally appeared in #17895 (where a better workaround has been found).

CC:  @bgrenet @mezzarobba

Branch: u/bruno/gcd_via_UFD

Status: new

Commit: 62db08ca0b85c535f3d6ef5bacac19ecefa8908b

Issue created by migration from https://trac.sagemath.org/ticket/28199





---

archive/issue_comments_539993.json:
```json
{
    "body": "Changing branch from \"\" to \"u/bruno/gcd_via_UFD\"",
    "created_at": "2019-07-15T08:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539993",
    "user": "https://github.com/bgrenet"
}
```

Changing branch from "" to "u/bruno/gcd_via_UFD"



---

archive/issue_comments_539994.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[62db08c](https://github.com/sagemath/sagetrac-mirror/commit/62db08ca0b85c535f3d6ef5bacac19ecefa8908b)|`28199: Try to use subresultants algorithm`|",
    "created_at": "2019-07-15T08:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539994",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[62db08c](https://github.com/sagemath/sagetrac-mirror/commit/62db08ca0b85c535f3d6ef5bacac19ecefa8908b)|`28199: Try to use subresultants algorithm`|



---

archive/issue_comments_539995.json:
```json
{
    "body": "Changing commit from \"\" to \"62db08ca0b85c535f3d6ef5bacac19ecefa8908b\"",
    "created_at": "2019-07-15T08:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "62db08ca0b85c535f3d6ef5bacac19ecefa8908b"



---

archive/issue_comments_539996.json:
```json
{
    "body": "<a id='comment:3'></a>\nI've made a very quick try: Instead of using the plain old Euclidean algorithm, one can use the so-called subresultant algorithm. This algorithm is already provided for UFDs so I tried to branch this algorithms for fields also. The resulting timings are still bad, but slightly less so:\n\n```python\nsage: x,y = polygens(QQ,\"x,y\")\nsage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422\nsage: p2 = p1(x=(x-1)^2)\nsage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()\nsage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]\nsage: %time _ = p4.squarefree_decomposition()\nCPU times: user 1.89 ms, sys: 0 ns, total: 1.89 ms\nWall time: 1.91 ms\nsage: %time _ = p4.change_ring(AA).squarefree_decomposition()\nCPU times: user 3.14 s, sys: 15.3 ms, total: 3.16 s\nWall time: 3.16 s\n```",
    "created_at": "2019-07-15T08:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539996",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:3'></a>
I've made a very quick try: Instead of using the plain old Euclidean algorithm, one can use the so-called subresultant algorithm. This algorithm is already provided for UFDs so I tried to branch this algorithms for fields also. The resulting timings are still bad, but slightly less so:

```python
sage: x,y = polygens(QQ,"x,y")
sage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422
sage: p2 = p1(x=(x-1)^2)
sage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()
sage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]
sage: %time _ = p4.squarefree_decomposition()
CPU times: user 1.89 ms, sys: 0 ns, total: 1.89 ms
Wall time: 1.91 ms
sage: %time _ = p4.change_ring(AA).squarefree_decomposition()
CPU times: user 3.14 s, sys: 15.3 ms, total: 3.16 s
Wall time: 3.16 s
```



---

archive/issue_comments_539997.json:
```json
{
    "body": "<a id='comment:4'></a>\nYou were quick :-) This is great: 10x improvement! There is no hope to beat the C-implementation from flint anyway.\n\nDo you know why the subresultant is not the default method over fields? Could it be always better?  \n\nThis reminds me the problem for computing determinant of matrices with rational coefficients. Going via Gauss elimination (which is a sort of \"default\" for fields) will create a terrible coefficient blowup.",
    "created_at": "2019-07-15T09:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539997",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
You were quick :-) This is great: 10x improvement! There is no hope to beat the C-implementation from flint anyway.

Do you know why the subresultant is not the default method over fields? Could it be always better?  

This reminds me the problem for computing determinant of matrices with rational coefficients. Going via Gauss elimination (which is a sort of "default" for fields) will create a terrible coefficient blowup.



---

archive/issue_comments_539998.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [vdelecroix](#comment%3A4):\n> You were quick :-) This is great: 10x improvement! There is no hope to beat the C-implementation from flint anyway.\n\n\nOf course, but I would hope for less than a second...\n\n> \n> Do you know why the subresultant is not the default method over fields? Could it be always better?  \n\n\nThat's why my first try. The problem is that it requires a `_floordiv_` and not all fields have it. For instance:\n\n```python\nsage: R.<x> = RR[]\nsage: p = (x^2-1)^2\nsage: p.is_squarefree()\nTraceback (most recent call last):\n...\nTypeError: unsupported operand parent(s) for //: 'Real Field with 53 bits of precision' and 'Real Field with 53 bits of precision'\n```\n\nor \n\n```python\nsage: S.<y> = GF(5)[]\nsage: Q = S.quotient_ring(y^2+y+1)\nsage: T.<z> = Q[]\nsage: gcd(y*z+1, z + y)\nTraceback (most recent call last):\n...\nTypeError: unsupported operand parent(s) for //: 'Univariate Quotient Polynomial Ring in ybar over Finite Field of size 5 with modulus y^2 + y + 1' and 'Univariate Quotient Polynomial Ring in ybar over Finite Field of size 5 with modulus y^2 + y + 1'\n```\n\nOne possibility to check is whether adding a `_floordiv_` method that simply calls `self._div_(other)` in the `Fields` category is sufficient and yields better timings.",
    "created_at": "2019-07-15T10:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539998",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:5'></a>
Replying to [vdelecroix](#comment%3A4):
> You were quick :-) This is great: 10x improvement! There is no hope to beat the C-implementation from flint anyway.


Of course, but I would hope for less than a second...

> 
> Do you know why the subresultant is not the default method over fields? Could it be always better?  


That's why my first try. The problem is that it requires a `_floordiv_` and not all fields have it. For instance:

```python
sage: R.<x> = RR[]
sage: p = (x^2-1)^2
sage: p.is_squarefree()
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for //: 'Real Field with 53 bits of precision' and 'Real Field with 53 bits of precision'
```

or 

```python
sage: S.<y> = GF(5)[]
sage: Q = S.quotient_ring(y^2+y+1)
sage: T.<z> = Q[]
sage: gcd(y*z+1, z + y)
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for //: 'Univariate Quotient Polynomial Ring in ybar over Finite Field of size 5 with modulus y^2 + y + 1' and 'Univariate Quotient Polynomial Ring in ybar over Finite Field of size 5 with modulus y^2 + y + 1'
```

One possibility to check is whether adding a `_floordiv_` method that simply calls `self._div_(other)` in the `Fields` category is sufficient and yields better timings.



---

archive/issue_comments_539999.json:
```json
{
    "body": "<a id='comment:6'></a>\nActually I checked: It is not faster in general (you can for instance test in the ring `T` of my example of the previous comment). This is reasonable: The only cases where it is faster is when there is coefficient growth. So there is a difficulty to decide when to use each algorithm. Maybe I should add a test as: `if not self.base_ring().is_finite()`. Note that in that case, `RR` would use subresultants while it is slightly slower. (But not that computing (non-approximate) gcds for polynomials over `RR` is mainly nonsense because of approximation issues.)",
    "created_at": "2019-07-15T10:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-539999",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:6'></a>
Actually I checked: It is not faster in general (you can for instance test in the ring `T` of my example of the previous comment). This is reasonable: The only cases where it is faster is when there is coefficient growth. So there is a difficulty to decide when to use each algorithm. Maybe I should add a test as: `if not self.base_ring().is_finite()`. Note that in that case, `RR` would use subresultants while it is slightly slower. (But not that computing (non-approximate) gcds for polynomials over `RR` is mainly nonsense because of approximation issues.)



---

archive/issue_comments_540000.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think that exact algorithm should raise an error with non-approximate base ring.",
    "created_at": "2019-07-15T12:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-540000",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>
I think that exact algorithm should raise an error with non-approximate base ring.



---

archive/issue_comments_540001.json:
```json
{
    "body": "<a id='comment:8'></a>\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-540001",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Ticket retargeted after milestone closed



---

archive/issue_events_087264.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87264"
}
```



---

archive/issue_comments_540002.json:
```json
{
    "body": "<a id='comment:9'></a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-540002",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_087265.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87265"
}
```



---

archive/issue_events_087266.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87266"
}
```



---

archive/issue_events_087267.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87267"
}
```



---

archive/issue_events_087268.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87268"
}
```



---

archive/issue_events_087269.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87269"
}
```



---

archive/issue_events_087270.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87270"
}
```



---

archive/issue_comments_540003.json:
```json
{
    "body": "<a id='comment:11'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28199#issuecomment-540003",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_087271.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87271"
}
```



---

archive/issue_events_087272.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87272"
}
```



---

archive/issue_events_087273.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87273"
}
```



---

archive/issue_events_087274.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87274"
}
```



---

archive/issue_events_087275.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87275"
}
```



---

archive/issue_events_087276.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87276"
}
```



---

archive/issue_events_087277.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T16:33:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87277"
}
```



---

archive/issue_events_087278.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T16:33:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28199",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28199#event-87278"
}
```
