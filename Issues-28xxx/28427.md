# Issue 28427: Various improvements to Lie algebras

archive/issues_028190.json:
```json
{
    "body": "CC:  @darijgr\n\nKeywords: lie algebra\n\nWe fix a bug in constructing the `0` element of a Lie algebra by putting that path higher in the `_element_constructor_`.\n\nWe make all of the Lie algebras and modules in `virasoro.py` know that they are graded.\n\nImplement a fallback to the PBW basis for when the construction of the universal enveloping algebra fails for finite-dimensional Lie algebras with a basis.\n\nAllow coercions and actions between Lie algebras to lift to the PBW bases.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28427\n\n",
    "closed_at": "2019-09-05T21:33:02Z",
    "created_at": "2019-08-30T04:20:26Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Various improvements to Lie algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28427",
    "user": "https://github.com/tscrim"
}
```
CC:  @darijgr

Keywords: lie algebra

We fix a bug in constructing the `0` element of a Lie algebra by putting that path higher in the `_element_constructor_`.

We make all of the Lie algebras and modules in `virasoro.py` know that they are graded.

Implement a fallback to the PBW basis for when the construction of the universal enveloping algebra fails for finite-dimensional Lie algebras with a basis.

Allow coercions and actions between Lie algebras to lift to the PBW bases.

Issue created by migration from https://trac.sagemath.org/ticket/28427





---

archive/issue_comments_397644.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-30T04:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397644",
    "user": "https://github.com/tscrim"
}
```

New commits:



---

archive/issue_comments_397645.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-30T04:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397645",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_397646.json:
```json
{
    "body": "Please fix the doc of the Virasoro degree_on_basis function: it should mention c, too.\n\n```\n+        We skip the grading test as we need to be able to echelonize a\n+        matrix over the base ring as part of the test::\n+\n             sage: L = lie_algebras.pwitt(Zmod(6), 6)\n-            sage: TestSuite(L).run()  # not tested -- universal envelope doesn't work\n-            sage: L._test_jacobi_identity()\n+            sage: TestSuite(L).run(skip=\"_test_grading\"\n```\nWhat needs to be echelonized?\n\nThe runtime error check is a bit of a hack -- but it may well be fine. Are you sure Singular will always throw a runtime error if it doesn't recognize the base ring as a field, as opposed to silently responding with a wrong result?",
    "created_at": "2019-08-30T07:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397646",
    "user": "https://github.com/darijgr"
}
```

Please fix the doc of the Virasoro degree_on_basis function: it should mention c, too.

```
+        We skip the grading test as we need to be able to echelonize a
+        matrix over the base ring as part of the test::
+
             sage: L = lie_algebras.pwitt(Zmod(6), 6)
-            sage: TestSuite(L).run()  # not tested -- universal envelope doesn't work
-            sage: L._test_jacobi_identity()
+            sage: TestSuite(L).run(skip="_test_grading"
```
What needs to be echelonized?

The runtime error check is a bit of a hack -- but it may well be fine. Are you sure Singular will always throw a runtime error if it doesn't recognize the base ring as a field, as opposed to silently responding with a wrong result?



---

archive/issue_comments_397647.json:
```json
{
    "body": "Replying to [comment:2 gh-darijgr]:\n> {{{\n> +        We skip the grading test as we need to be able to echelonize a\n> +        matrix over the base ring as part of the test::\n> +\n>              sage: L = lie_algebras.pwitt(Zmod(6), 6)\n> -            sage: TestSuite(L).run()  # not tested -- universal envelope doesn't work\n> -            sage: L._test_jacobi_identity()\n> +            sage: TestSuite(L).run(skip=\"_test_grading\"\n> }}}\n> What needs to be echelonized?\n\n\nIt is done in computing the homogeneous degree component as part of the test.\n\n> The runtime error check is a bit of a hack -- but it may well be fine. Are you sure Singular will always throw a runtime error if it doesn't recognize the base ring as a field, as opposed to silently responding with a wrong result?\n\n\nThe reason Singular throws the error is because it only can work over certain base rings. If it silently returns a wrong result, then there is nothing anyone can do except submit an upstream bug report.",
    "created_at": "2019-08-30T07:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397647",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:2 gh-darijgr]:
> {{{
> +        We skip the grading test as we need to be able to echelonize a
> +        matrix over the base ring as part of the test::
> +
>              sage: L = lie_algebras.pwitt(Zmod(6), 6)
> -            sage: TestSuite(L).run()  # not tested -- universal envelope doesn't work
> -            sage: L._test_jacobi_identity()
> +            sage: TestSuite(L).run(skip="_test_grading"
> }}}
> What needs to be echelonized?


It is done in computing the homogeneous degree component as part of the test.

> The runtime error check is a bit of a hack -- but it may well be fine. Are you sure Singular will always throw a runtime error if it doesn't recognize the base ring as a field, as opposed to silently responding with a wrong result?


The reason Singular throws the error is because it only can work over certain base rings. If it silently returns a wrong result, then there is nothing anyone can do except submit an upstream bug report.



---

archive/issue_comments_397648.json:
```json
{
    "body": "Does Singular say that it's not going to work over a non-field, or does it try and panic when some division fails? In the former case, what you're doing is fine; in the latter I'd be more careful.\n\nStill not sure why the echelon form may be needed in the test suite, but you know better. I'm fine with or without the tests; the grading on the Witt algebra is so obvious there can't be any trouble from that front :)\n\nCare to mention c in the doc of Virasoro's degree function? Everything apart of this (and the possible Singular issue, if it is one) LGTM. (Sorry for the absence of more significant code review from me lately...)",
    "created_at": "2019-08-30T09:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397648",
    "user": "https://github.com/darijgr"
}
```

Does Singular say that it's not going to work over a non-field, or does it try and panic when some division fails? In the former case, what you're doing is fine; in the latter I'd be more careful.

Still not sure why the echelon form may be needed in the test suite, but you know better. I'm fine with or without the tests; the grading on the Witt algebra is so obvious there can't be any trouble from that front :)

Care to mention c in the doc of Virasoro's degree function? Everything apart of this (and the possible Singular issue, if it is one) LGTM. (Sorry for the absence of more significant code review from me lately...)



---

archive/issue_comments_397649.json:
```json
{
    "body": "You are way overthinking this Singular thing. Just run the test and you will see for the echelonization.\n\nI am planning on mentioning the c, but I am not at my computer right now.",
    "created_at": "2019-08-30T09:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397649",
    "user": "https://github.com/tscrim"
}
```

You are way overthinking this Singular thing. Just run the test and you will see for the echelonization.

I am planning on mentioning the c, but I am not at my computer right now.



---

archive/issue_comments_397650.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-31T01:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397650",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_397651.json:
```json
{
    "body": "I have updated the documentation. I also was more precise about that singular is failing for the **Z**/6**Z** example (although its documentation does (implicitly) say the algebra needs to be defined over a field; at least, I am fairly certain it needs an integral domain). I also did another improvement that I think would be useful, to allow coercions and actions to lift to the PBW basis.\n\nHere also is the traceback of what happens in the grading test:\n\n```\nsage: L = lie_algebras.pwitt(Zmod(6), 6)\nsage: L._test_grading()\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n<ipython-input-2-fb4e02d44a27> in <module>()\n----> 1 L._test_grading()\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/finite_dimensional_graded_lie_algebras_with_basis.pyc in _test_grading(self, **options)\n     82                         (X, Y, Zdeg, i + j))\n     83                 tester.assertTrue(\n---> 84                     Z.to_vector() in self.homogeneous_component_as_submodule(i + j),\n     85                     msg=\"Lie bracket [%s, %s] is not in the \"\n     86                         \"homogeneous component of degree %s\" % (X, Y, i + j))\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)()\n   1947                 return cache[k]\n   1948         except KeyError:\n-> 1949             w = self._instance_call(*args, **kwds)\n   1950             cache[k] = w\n   1951             return w\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)()\n   1823             True\n   1824         \"\"\"\n-> 1825         return self.f(self._instance, *args, **kwds)\n   1826 \n   1827     cdef fix_args_kwds(self, tuple args, dict kwds):\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/finite_dimensional_graded_lie_algebras_with_basis.pyc in homogeneous_component_as_submodule(self, d)\n    104             \"\"\"\n    105             B = self.homogeneous_component_basis(d)\n--> 106             return self.module().submodule([X.to_vector() for X in B])\n    107 \n    108     class Stratified(CategoryWithAxiom_over_base_ring):\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in submodule(self, gens, check, already_echelonized, unitriangular, category)\n    813             \"\"\"\n    814             if not already_echelonized:\n--> 815                 gens = self.echelon_form(gens, unitriangular)\n    816             from sage.modules.with_basis.subquotient import SubmoduleWithBasis\n    817             return SubmoduleWithBasis(gens, ambient=self,\n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in echelon_form(self, elements, row_reduced)\n    657                     raise ValueError(\"unable to compute the row reduced echelon form\")\n    658             else:\n--> 659                 mat.echelonize()\n    660             return [self.from_vector(vec) for vec in mat if vec]\n    661 \n\n/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/matrix/matrix_modn_dense_template.pxi in sage.matrix.matrix_modn_dense_float.Matrix_modn_dense_template.echelonize (build/cythonized/sage/matrix/matrix_modn_dense_float.cpp:12657)()\n   1851 \n   1852         if not self.base_ring().is_field():\n-> 1853             raise NotImplementedError(\"Echelon form not implemented over '%s'.\"%self.base_ring())\n   1854 \n   1855         if algorithm == 'linbox':\n\nNotImplementedError: Echelon form not implemented over 'Ring of integers modulo 6'.\n```\nYou can see where it needs to be able to echelonize a matrix. If we wanted to fix this, we would have to change the test itself by weakening it when it is not over a field (which should be a separate ticket as that has farther reaching implications).\n\nAlso, no problem with not doing more reviewing. I know you are starting a new tenure-track job. `;)`",
    "created_at": "2019-08-31T01:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397651",
    "user": "https://github.com/tscrim"
}
```

I have updated the documentation. I also was more precise about that singular is failing for the **Z**/6**Z** example (although its documentation does (implicitly) say the algebra needs to be defined over a field; at least, I am fairly certain it needs an integral domain). I also did another improvement that I think would be useful, to allow coercions and actions to lift to the PBW basis.

Here also is the traceback of what happens in the grading test:

```
sage: L = lie_algebras.pwitt(Zmod(6), 6)
sage: L._test_grading()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-2-fb4e02d44a27> in <module>()
----> 1 L._test_grading()

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/finite_dimensional_graded_lie_algebras_with_basis.pyc in _test_grading(self, **options)
     82                         (X, Y, Zdeg, i + j))
     83                 tester.assertTrue(
---> 84                     Z.to_vector() in self.homogeneous_component_as_submodule(i + j),
     85                     msg="Lie bracket [%s, %s] is not in the "
     86                         "homogeneous component of degree %s" % (X, Y, i + j))

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)()
   1947                 return cache[k]
   1948         except KeyError:
-> 1949             w = self._instance_call(*args, **kwds)
   1950             cache[k] = w
   1951             return w

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)()
   1823             True
   1824         """
-> 1825         return self.f(self._instance, *args, **kwds)
   1826 
   1827     cdef fix_args_kwds(self, tuple args, dict kwds):

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/finite_dimensional_graded_lie_algebras_with_basis.pyc in homogeneous_component_as_submodule(self, d)
    104             """
    105             B = self.homogeneous_component_basis(d)
--> 106             return self.module().submodule([X.to_vector() for X in B])
    107 
    108     class Stratified(CategoryWithAxiom_over_base_ring):

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in submodule(self, gens, check, already_echelonized, unitriangular, category)
    813             """
    814             if not already_echelonized:
--> 815                 gens = self.echelon_form(gens, unitriangular)
    816             from sage.modules.with_basis.subquotient import SubmoduleWithBasis
    817             return SubmoduleWithBasis(gens, ambient=self,

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in echelon_form(self, elements, row_reduced)
    657                     raise ValueError("unable to compute the row reduced echelon form")
    658             else:
--> 659                 mat.echelonize()
    660             return [self.from_vector(vec) for vec in mat if vec]
    661 

/home/uqtscrim/sage-build/local/lib/python2.7/site-packages/sage/matrix/matrix_modn_dense_template.pxi in sage.matrix.matrix_modn_dense_float.Matrix_modn_dense_template.echelonize (build/cythonized/sage/matrix/matrix_modn_dense_float.cpp:12657)()
   1851 
   1852         if not self.base_ring().is_field():
-> 1853             raise NotImplementedError("Echelon form not implemented over '%s'."%self.base_ring())
   1854 
   1855         if algorithm == 'linbox':

NotImplementedError: Echelon form not implemented over 'Ring of integers modulo 6'.
```
You can see where it needs to be able to echelonize a matrix. If we wanted to fix this, we would have to change the test itself by weakening it when it is not over a field (which should be a separate ticket as that has farther reaching implications).

Also, no problem with not doing more reviewing. I know you are starting a new tenure-track job. `;)`



---

archive/issue_comments_397652.json:
```json
{
    "body": "Hmm...something broke with that latest push for the Verma modules. I need to investigate.",
    "created_at": "2019-08-31T01:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397652",
    "user": "https://github.com/tscrim"
}
```

Hmm...something broke with that latest push for the Verma modules. I need to investigate.



---

archive/issue_comments_397653.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-31T01:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397653",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_397654.json:
```json
{
    "body": "So the problem comes from extending the action of the Lie algebra to the PBW basis (i.e., not the additional coercions allowed).",
    "created_at": "2019-08-31T01:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397654",
    "user": "https://github.com/tscrim"
}
```

So the problem comes from extending the action of the Lie algebra to the PBW basis (i.e., not the additional coercions allowed).



---

archive/issue_comments_397655.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-31T01:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397655",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_397656.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-31T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397656",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_397657.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-31T01:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397657",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_397658.json:
```json
{
    "body": "Okay, I fixed the problem. I forgot to also add the coefficient to the product `>_<`. I also added a shortcut for the action when there is a specialized PBW action implemented on a module (e.g., Verma modules).",
    "created_at": "2019-08-31T01:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397658",
    "user": "https://github.com/tscrim"
}
```

Okay, I fixed the problem. I forgot to also add the coefficient to the product `>_<`. I also added a shortcut for the action when there is a specialized PBW action implemented on a module (e.g., Verma modules).



---

archive/issue_comments_397659.json:
```json
{
    "body": "some warnings, see patchbot plugins",
    "created_at": "2019-08-31T07:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397659",
    "user": "https://github.com/fchapoton"
}
```

some warnings, see patchbot plugins



---

archive/issue_comments_397660.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-31T08:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_397661.json:
```json
{
    "body": "Replying to [comment:13 chapoton]:\n> some warnings, see patchbot plugins\n\n\nFixed.",
    "created_at": "2019-08-31T08:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397661",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:13 chapoton]:
> some warnings, see patchbot plugins


Fixed.



---

archive/issue_comments_397662.json:
```json
{
    "body": "ok, good to go",
    "created_at": "2019-09-01T06:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397662",
    "user": "https://github.com/fchapoton"
}
```

ok, good to go



---

archive/issue_comments_397663.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-01T06:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397663",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_397664.json:
```json
{
    "body": "Thank you. I am also adding Darij as a reviewer for his comments.",
    "created_at": "2019-09-01T08:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397664",
    "user": "https://github.com/tscrim"
}
```

Thank you. I am also adding Darij as a reviewer for his comments.



---

archive/issue_events_071111.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-09-05T21:33:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28427#event-71111"
}
```



---

archive/issue_comments_397665.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-09-05T21:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-397665",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
