# Issue 28742: sage-python incremental build breakage

archive/issues_028505.json:
```json
{
    "body": "CC:  @jhpalmieri\n\nThe `sage` target in src/Makefile can be called if the previous build was incomplete, in particular if six has not been installed. But our setup.py implicitly depends on six:\n\n```\n[sagelib-9.0.beta5] cd . && export                                    \\\n[sagelib-9.0.beta5]     SAGE_ROOT=/doesnotexist                               \\\n[sagelib-9.0.beta5]     SAGE_SRC=/doesnotexist                                \\\n[sagelib-9.0.beta5]     SAGE_SRC_ROOT=/doesnotexist                           \\\n[sagelib-9.0.beta5]     SAGE_DOC_SRC=/doesnotexist                            \\\n[sagelib-9.0.beta5]     SAGE_BUILD_DIR=/doesnotexist                          \\\n[sagelib-9.0.beta5]     SAGE_PKGS=/var/lib/buildbot/slave/sage_git/build/build/pkgs                \\\n[sagelib-9.0.beta5] && sage-python -u setup.py --no-user-cfg build install\n[sagelib-9.0.beta5] /var/lib/buildbot/slave/sage_git/build/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory\n[sagelib-9.0.beta5] Warning: overwriting SAGE_ROOT environment variable:\n[sagelib-9.0.beta5] Old SAGE_ROOT=/doesnotexist\n[sagelib-9.0.beta5] New SAGE_ROOT=\n[sagelib-9.0.beta5] Traceback (most recent call last):\n[sagelib-9.0.beta5]   File \"setup.py\", line 22, in <module>\n[sagelib-9.0.beta5]     import fpickle_setup\n[sagelib-9.0.beta5]   File \"/var/lib/buildbot/slave/sage_git/build/src/fpickle_setup.py\", line 8, in <module>\n[sagelib-9.0.beta5]     from six.moves import copyreg\n[sagelib-9.0.beta5] ModuleNotFoundError: No module named 'six'\n[sagelib-9.0.beta5] Makefile:33: recipe for target 'sage' failed\n[sagelib-9.0.beta5] make[4]: *** [sage] Error 1\n[sagelib-9.0.beta5] make[4]: Leaving directory '/var/lib/buildbot/slave/sage_git/build/src'\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/28742\n\n",
    "closed_at": "2020-09-16T15:12:02Z",
    "created_at": "2019-11-15T09:33:28Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage-python incremental build breakage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28742",
    "user": "https://github.com/vbraun"
}
```
CC:  @jhpalmieri

The `sage` target in src/Makefile can be called if the previous build was incomplete, in particular if six has not been installed. But our setup.py implicitly depends on six:

```
[sagelib-9.0.beta5] cd . && export                                    \
[sagelib-9.0.beta5]     SAGE_ROOT=/doesnotexist                               \
[sagelib-9.0.beta5]     SAGE_SRC=/doesnotexist                                \
[sagelib-9.0.beta5]     SAGE_SRC_ROOT=/doesnotexist                           \
[sagelib-9.0.beta5]     SAGE_DOC_SRC=/doesnotexist                            \
[sagelib-9.0.beta5]     SAGE_BUILD_DIR=/doesnotexist                          \
[sagelib-9.0.beta5]     SAGE_PKGS=/var/lib/buildbot/slave/sage_git/build/build/pkgs                \
[sagelib-9.0.beta5] && sage-python -u setup.py --no-user-cfg build install
[sagelib-9.0.beta5] /var/lib/buildbot/slave/sage_git/build/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory
[sagelib-9.0.beta5] Warning: overwriting SAGE_ROOT environment variable:
[sagelib-9.0.beta5] Old SAGE_ROOT=/doesnotexist
[sagelib-9.0.beta5] New SAGE_ROOT=
[sagelib-9.0.beta5] Traceback (most recent call last):
[sagelib-9.0.beta5]   File "setup.py", line 22, in <module>
[sagelib-9.0.beta5]     import fpickle_setup
[sagelib-9.0.beta5]   File "/var/lib/buildbot/slave/sage_git/build/src/fpickle_setup.py", line 8, in <module>
[sagelib-9.0.beta5]     from six.moves import copyreg
[sagelib-9.0.beta5] ModuleNotFoundError: No module named 'six'
[sagelib-9.0.beta5] Makefile:33: recipe for target 'sage' failed
[sagelib-9.0.beta5] make[4]: *** [sage] Error 1
[sagelib-9.0.beta5] make[4]: Leaving directory '/var/lib/buildbot/slave/sage_git/build/src'
```

Issue created by migration from https://trac.sagemath.org/ticket/28742





---

archive/issue_comments_402091.json:
```json
{
    "body": "`six` is a dependency for `sagelib`, so how does this happen?",
    "created_at": "2019-11-15T18:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402091",
    "user": "https://github.com/jhpalmieri"
}
```

`six` is a dependency for `sagelib`, so how does this happen?



---

archive/issue_comments_402092.json:
```json
{
    "body": "I see this now, incremental build from 9.0.beta5 -> 9.0.beta6.\n\n```\n[sagelib-9.0.beta6] Traceback (most recent call last):\n[sagelib-9.0.beta6]   File \"setup.py\", line 22, in <module>\n[sagelib-9.0.beta6]     import fpickle_setup\n[sagelib-9.0.beta6]   File \"/64bitdev/storage/sage-git_develop/sage/src/fpickle_setup.py\", line 8, in <module>\n[sagelib-9.0.beta6]     from six.moves import copyreg\n[sagelib-9.0.beta6] ModuleNotFoundError: No module named 'six'\n[sagelib-9.0.beta6] make[4]: *** [Makefile:33: sage] Error 1\n[sagelib-9.0.beta6] make[4]: Leaving directory '/64bitdev/storage/sage-git_develop/sage/src'\n```\nI looks like `six` is only installed for `python2.7`",
    "created_at": "2019-11-18T01:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402092",
    "user": "https://github.com/strogdon"
}
```

I see this now, incremental build from 9.0.beta5 -> 9.0.beta6.

```
[sagelib-9.0.beta6] Traceback (most recent call last):
[sagelib-9.0.beta6]   File "setup.py", line 22, in <module>
[sagelib-9.0.beta6]     import fpickle_setup
[sagelib-9.0.beta6]   File "/64bitdev/storage/sage-git_develop/sage/src/fpickle_setup.py", line 8, in <module>
[sagelib-9.0.beta6]     from six.moves import copyreg
[sagelib-9.0.beta6] ModuleNotFoundError: No module named 'six'
[sagelib-9.0.beta6] make[4]: *** [Makefile:33: sage] Error 1
[sagelib-9.0.beta6] make[4]: Leaving directory '/64bitdev/storage/sage-git_develop/sage/src'
```
I looks like `six` is only installed for `python2.7`



---

archive/issue_comments_402093.json:
```json
{
    "body": "Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?",
    "created_at": "2019-11-18T01:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402093",
    "user": "https://github.com/jhpalmieri"
}
```

Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?



---

archive/issue_comments_402094.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?\n\nThe original build was with Python 2. The failure resulted from\n\n```\ngit pull\nmake\n```\nSo I presume it's still Python 2.",
    "created_at": "2019-11-18T01:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402094",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:3 jhpalmieri]:
> Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?

The original build was with Python 2. The failure resulted from

```
git pull
make
```
So I presume it's still Python 2.



---

archive/issue_comments_402095.json:
```json
{
    "body": "But maybe with `9.0.beta6` Python 3 is the default.",
    "created_at": "2019-11-18T01:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402095",
    "user": "https://github.com/strogdon"
}
```

But maybe with `9.0.beta6` Python 3 is the default.



---

archive/issue_comments_402096.json:
```json
{
    "body": "Yes, the post has now appeared on `sage-release`. Python 3 is the default.",
    "created_at": "2019-11-18T01:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402096",
    "user": "https://github.com/strogdon"
}
```

Yes, the post has now appeared on `sage-release`. Python 3 is the default.



---

archive/issue_comments_402097.json:
```json
{
    "body": "If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?",
    "created_at": "2019-11-18T02:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402097",
    "user": "https://github.com/jhpalmieri"
}
```

If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?



---

archive/issue_comments_402098.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?\n\nFrom sage folder\n\n```\nmake distclean\nmake\n```\nseemed to fix things here. I'm not anxious to continue with Python 2 and with the above Python 3 is being used. It seems a bit severe but perhaps what's needed.",
    "created_at": "2019-11-18T03:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402098",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:7 jhpalmieri]:
> If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?

From sage folder

```
make distclean
make
```
seemed to fix things here. I'm not anxious to continue with Python 2 and with the above Python 3 is being used. It seems a bit severe but perhaps what's needed.



---

archive/issue_comments_402099.json:
```json
{
    "body": "I just did a test with similar results: started a Python 2 build with 9.0.beta5, then did `git trac pull develop` and started `make`. Then `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` reported `3`, which is only going to lead to problems. This is due to #28660, I guess.",
    "created_at": "2019-11-18T03:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402099",
    "user": "https://github.com/jhpalmieri"
}
```

I just did a test with similar results: started a Python 2 build with 9.0.beta5, then did `git trac pull develop` and started `make`. Then `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` reported `3`, which is only going to lead to problems. This is due to #28660, I guess.



---

archive/issue_comments_402100.json:
```json
{
    "body": "I just posted this on #28660: in the case of building with Python 2, then merging this ticket and trying to an incremental upgrade, \"we should detect the version mismatch and either keep using Python 2 or abort the make process, telling the user what the issue is.\"",
    "created_at": "2019-11-18T03:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402100",
    "user": "https://github.com/jhpalmieri"
}
```

I just posted this on #28660: in the case of building with Python 2, then merging this ticket and trying to an incremental upgrade, "we should detect the version mismatch and either keep using Python 2 or abort the make process, telling the user what the issue is."



---

archive/issue_events_072497.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72497"
}
```



---

archive/issue_comments_402101.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402101",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_events_072498.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72498"
}
```



---

archive/issue_events_072499.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72499"
}
```



---

archive/issue_comments_402102.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402102",
    "user": "https://github.com/mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_072500.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-30T19:19:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72500"
}
```



---

archive/issue_events_072501.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-30T19:19:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72501"
}
```



---

archive/issue_comments_402103.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-30T19:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402103",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402104.json:
```json
{
    "body": "This is likely outdated after the removal of python 2 support",
    "created_at": "2020-08-30T19:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402104",
    "user": "https://github.com/mkoeppe"
}
```

This is likely outdated after the removal of python 2 support



---

archive/issue_comments_402105.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-31T02:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402105",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_072502.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-09-16T15:12:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28742#event-72502"
}
```



---

archive/issue_comments_402106.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-09-16T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28742#issuecomment-402106",
    "user": "https://github.com/fchapoton"
}
```

Resolution: invalid
