# Issue 28227: py3 fixes for weyl_characters.py

archive/issues_027990.json:
```json
{
    "body": "Fix the Python 3 doctest failures in `combinat/root_systems/weyl_characters.py`. The failures all come down to sorting. The more complicated problem is the method `fusion_labels` which relies on sorted output when it shouldn't.\n\nBranch/Commit: 7d31fbb58883541c4e35d22b8327e1fae8a8ea70\n\nReviewer: Markus Wageringel, Vincent Klein\n\nAuthor: John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28227\n\n",
    "closed_at": "2019-07-29T21:54:47Z",
    "created_at": "2019-07-22T05:33:38Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "py3 fixes for weyl_characters.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28227",
    "user": "https://github.com/jhpalmieri"
}
```
Fix the Python 3 doctest failures in `combinat/root_systems/weyl_characters.py`. The failures all come down to sorting. The more complicated problem is the method `fusion_labels` which relies on sorted output when it shouldn't.

Branch/Commit: 7d31fbb58883541c4e35d22b8327e1fae8a8ea70

Reviewer: Markus Wageringel, Vincent Klein

Author: John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28227





---

archive/issue_comments_395064.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-07-22T05:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395064",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_395065.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-22T05:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395065",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_395066.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-22T05:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_395067.json:
```json
{
    "body": "<a id='comment:4'></a>It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.\n\n```\n        sage: sorted(B22.basis(), key=str)\n        [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]\n        sage: sorted([x.highest_weight() for x in B22.basis()], key=str)\n        [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]\n        sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])\n```\n\nAlso, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.\n\n```\nsage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S\nA recursively enumerated set (breadth first search)\nsage: str(list(S))  # py3\n'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'\nsage: str(list(S))  # py2\n'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'\n```\nIf the successor function gives consistent results, the breadth-first search should be unique, should it not?",
    "created_at": "2019-07-22T08:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395067",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:4'></a>It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.

```
        sage: sorted(B22.basis(), key=str)
        [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]
        sage: sorted([x.highest_weight() for x in B22.basis()], key=str)
        [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]
        sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])
```

Also, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.

```
sage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S
A recursively enumerated set (breadth first search)
sage: str(list(S))  # py3
'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
sage: str(list(S))  # py2
'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
```
If the successor function gives consistent results, the breadth-first search should be unique, should it not?



---

archive/issue_comments_395068.json:
```json
{
    "body": "<a id='comment:5'></a>There is #27967 already, but it only deals with the graded variant of `RecursivelyEnumeratedSet`.",
    "created_at": "2019-07-22T08:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395068",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>There is #27967 already, but it only deals with the graded variant of `RecursivelyEnumeratedSet`.



---

archive/issue_comments_395069.json:
```json
{
    "body": "<a id='comment:6'></a>\n```\n+        if key:\n+            fb = sorted(self.basis(), key=key)\n+        else:\n+            fb = list(self.basis())\n```\n\nAs `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.",
    "created_at": "2019-07-22T09:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395069",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:6'></a>
```
+        if key:
+            fb = sorted(self.basis(), key=key)
+        else:
+            fb = list(self.basis())
```

As `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.



---

archive/issue_comments_395070.json:
```json
{
    "body": "<a id='comment:7'></a>With this branch and py2 i get the following error :\n\n```\nsage -t --long src/sage/combinat/root_system/weyl_characters.py\n**********************************************************************\nFile \"src/sage/combinat/root_system/weyl_characters.py\", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing\nFailed example:\n    Z*Z\nExpected:\n    1\nGot:\n    1 + Y1 + Y2\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing\n    [308 tests, 1 failure, 1.88 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2019-07-22T12:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395070",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:7'></a>With this branch and py2 i get the following error :

```
sage -t --long src/sage/combinat/root_system/weyl_characters.py
**********************************************************************
File "src/sage/combinat/root_system/weyl_characters.py", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing
Failed example:
    Z*Z
Expected:
    1
Got:
    1 + Y1 + Y2
**********************************************************************
1 item had failures:
   1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing
    [308 tests, 1 failure, 1.88 s]
----------------------------------------------------------------------
sage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_395071.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 vklein]:\n> With this branch and py2 i get the following error :\n> \n> ```\n> sage -t --long src/sage/combinat/root_system/weyl_characters.py\n> **********************************************************************\n> File \"src/sage/combinat/root_system/weyl_characters.py\", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing\n> Failed example:\n>     Z*Z\n> Expected:\n>     1\n> Got:\n>     1 + Y1 + Y2\n> **********************************************************************\n> 1 item had failures:\n>    1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing\n>     [308 tests, 1 failure, 1.88 s]\n> ----------------------------------------------------------------------\n> sage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed\n> ----------------------------------------------------------------------\n> ```\n\n\nI can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?",
    "created_at": "2019-07-22T16:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395071",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Replying to [comment:7 vklein]:
> With this branch and py2 i get the following error :
> 
> ```
> sage -t --long src/sage/combinat/root_system/weyl_characters.py
> **********************************************************************
> File "src/sage/combinat/root_system/weyl_characters.py", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing
> Failed example:
>     Z*Z
> Expected:
>     1
> Got:
>     1 + Y1 + Y2
> **********************************************************************
> 1 item had failures:
>    1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing
>     [308 tests, 1 failure, 1.88 s]
> ----------------------------------------------------------------------
> sage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed
> ----------------------------------------------------------------------
> ```


I can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?



---

archive/issue_comments_395072.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-23T03:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395073.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:4 gh-mwageringel]:\n> It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.\n> \n> ```\n>         sage: sorted(B22.basis(), key=str)\n>         [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]\n>         sage: sorted([x.highest_weight() for x in B22.basis()], key=str)\n>         [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]\n>         sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])\n> ```\n\n\nIs this better? \n\n> Also, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.\n> \n> ```\n> sage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S\n> A recursively enumerated set (breadth first search)\n> sage: str(list(S))  # py3\n> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'\n> sage: str(list(S))  # py2\n> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'\n> ```\n> If the successor function gives consistent results, the breadth-first search should be unique, should it not?\n\n\nShould we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?\n\nReplying to [comment:6 vklein]:\n> \n> \n> ```\n> +        if key:\n> +            fb = sorted(self.basis(), key=key)\n> +        else:\n> +            fb = list(self.basis())\n> ```\n> \n> As `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.\n\n\nI added something.",
    "created_at": "2019-07-23T03:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395073",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Replying to [comment:4 gh-mwageringel]:
> It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.
> 
> ```
>         sage: sorted(B22.basis(), key=str)
>         [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]
>         sage: sorted([x.highest_weight() for x in B22.basis()], key=str)
>         [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]
>         sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])
> ```


Is this better? 

> Also, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.
> 
> ```
> sage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S
> A recursively enumerated set (breadth first search)
> sage: str(list(S))  # py3
> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
> sage: str(list(S))  # py2
> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
> ```
> If the successor function gives consistent results, the breadth-first search should be unique, should it not?


Should we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?

Replying to [comment:6 vklein]:
> 
> 
> ```
> +        if key:
> +            fb = sorted(self.basis(), key=key)
> +        else:
> +            fb = list(self.basis())
> ```
> 
> As `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.


I added something.



---

archive/issue_comments_395074.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 jhpalmieri]:\n> Replying to [comment:7 vklein]:\n> ...\n> I can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?\n\n\nI had a mess in my py2 local branch. It works now.\n\nI'm ok with this ticket as it is. `@`gh-mwageringel : I let you set the ticket to positive review if you agree.",
    "created_at": "2019-07-23T07:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395074",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:11'></a>Replying to [comment:8 jhpalmieri]:
> Replying to [comment:7 vklein]:
> ...
> I can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?


I had a mess in my py2 local branch. It works now.

I'm ok with this ticket as it is. `@`gh-mwageringel : I let you set the ticket to positive review if you agree.



---

archive/issue_comments_395075.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 jhpalmieri]:\n> Is this better? \n\n\nYes, thanks.\n\n> Should we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?\n\n\nIMO, it would be better to delay this as it is a change of the API, not just the doctests. I am not sure where #27967 is headed though, so I will not insist. Feel free to set this to positive if you prefer these changes be merged now.",
    "created_at": "2019-07-23T08:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395075",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:12'></a>Replying to [comment:10 jhpalmieri]:
> Is this better? 


Yes, thanks.

> Should we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?


IMO, it would be better to delay this as it is a change of the API, not just the doctests. I am not sure where #27967 is headed though, so I will not insist. Feel free to set this to positive if you prefer these changes be merged now.



---

archive/issue_comments_395076.json:
```json
{
    "body": "<a id='comment:13'></a>If you think that #27967 will take a while to get resolved, then maybe we should merge these changes now to fix these doctests, but the two of you (vklein, gh-mwageringel) have a better idea of the fate of #27967 than I do, so I will let you decide what to do here.",
    "created_at": "2019-07-23T17:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395076",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>If you think that #27967 will take a while to get resolved, then maybe we should merge these changes now to fix these doctests, but the two of you (vklein, gh-mwageringel) have a better idea of the fate of #27967 than I do, so I will let you decide what to do here.



---

archive/issue_comments_395077.json:
```json
{
    "body": "<a id='comment:14'></a>I think we should merge this ticket now.\n\nFrom #27967#comment:10\n>Also, why should the enumeration order be certified? This is not claimed in the documentation.\n\n\nI think this is a valid point and therefore modifying RecursivelyEnumeratedSet rather than the classes using it is debatable. So yes i think #27967 will take a while.",
    "created_at": "2019-07-24T07:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395077",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:14'></a>I think we should merge this ticket now.

From #27967#comment:10
>Also, why should the enumeration order be certified? This is not claimed in the documentation.


I think this is a valid point and therefore modifying RecursivelyEnumeratedSet rather than the classes using it is debatable. So yes i think #27967 will take a while.



---

archive/issue_comments_395078.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-24T08:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395078",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_395079.json:
```json
{
    "body": "<a id='comment:15'></a>Ok, let us move on here. Setting to positive.",
    "created_at": "2019-07-24T08:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395079",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:15'></a>Ok, let us move on here. Setting to positive.



---

archive/issue_events_070191.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-29T21:54:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28227#event-70191"
}
```



---

archive/issue_comments_395080.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-29T21:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28227#issuecomment-395080",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
