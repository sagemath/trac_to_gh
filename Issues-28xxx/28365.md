# Issue 28365: Use something instead of time() to ensure Manifold uniqueness in tests

archive/issues_028128.json:
```json
{
    "body": "CC:  @egourgoulhon @slel\n\nKeywords: manifolds\n\nAs discussed in #28331, specifically ticket:28331#comment:9, the `Manifold` constructor uses `unique_tag=getrandbits(128)*time()` to ensure all returned manifolds are unique instances.\n\nI'm not exactly sure why `time()` is used, except for the fact that in the doctests, the random seed is reset to 0 (so the `getrandbits` is not useful from test case to case case).  However, on some systems `time()` is not high-enough resolution to change from case to case as well.\n\nPerhaps it would be better to either use a different random number that is not re-seeded.  Or use a monotonic clock or even just a monotonically increasing integer for each manifold...?\n\nIssue created by migration from https://trac.sagemath.org/ticket/28365\n\n",
    "closed_at": "2019-08-29T20:02:07Z",
    "created_at": "2019-08-19T10:31:15Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Use something instead of time() to ensure Manifold uniqueness in tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28365",
    "user": "https://github.com/embray"
}
```
CC:  @egourgoulhon @slel

Keywords: manifolds

As discussed in #28331, specifically ticket:28331#comment:9, the `Manifold` constructor uses `unique_tag=getrandbits(128)*time()` to ensure all returned manifolds are unique instances.

I'm not exactly sure why `time()` is used, except for the fact that in the doctests, the random seed is reset to 0 (so the `getrandbits` is not useful from test case to case case).  However, on some systems `time()` is not high-enough resolution to change from case to case as well.

Perhaps it would be better to either use a different random number that is not re-seeded.  Or use a monotonic clock or even just a monotonically increasing integer for each manifold...?

Issue created by migration from https://trac.sagemath.org/ticket/28365





---

archive/issue_comments_396880.json:
```json
{
    "body": "Note: On Python 3 (specifically 3.4+) there is new monotonic clock support.  For Python 2.7 there is a backport: https://pypi.org/project/monotonic/",
    "created_at": "2019-08-19T10:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396880",
    "user": "https://github.com/embray"
}
```

Note: On Python 3 (specifically 3.4+) there is new monotonic clock support.  For Python 2.7 there is a backport: https://pypi.org/project/monotonic/



---

archive/issue_comments_396881.json:
```json
{
    "body": "Replying to [ticket:28365 embray]:\n> a monotonically increasing integer for each manifold\n\n\nSounds like the best solution, unless this needs to be cryptographically secure :-)",
    "created_at": "2019-08-19T10:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396881",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:28365 embray]:
> a monotonically increasing integer for each manifold


Sounds like the best solution, unless this needs to be cryptographically secure :-)



---

archive/issue_comments_396882.json:
```json
{
    "body": "Replying to [comment:1 embray]:\n> Note: On Python 3 (specifically 3.4+) there is new monotonic clock support.  For Python 2.7 there is a backport: https://pypi.org/project/monotonic/\n\n\nThough it seems on Windows/Cygwin this is still not good-enough resolution.",
    "created_at": "2019-08-19T10:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396882",
    "user": "https://github.com/embray"
}
```

Replying to [comment:1 embray]:
> Note: On Python 3 (specifically 3.4+) there is new monotonic clock support.  For Python 2.7 there is a backport: https://pypi.org/project/monotonic/


Though it seems on Windows/Cygwin this is still not good-enough resolution.



---

archive/issue_comments_396883.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Replying to [ticket:28365 embray]:\n> > a monotonically increasing integer for each manifold\n\n> \n> Sounds like the best solution, unless this needs to be cryptographically secure :-)\n\n\nYup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)",
    "created_at": "2019-08-19T11:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396883",
    "user": "https://github.com/embray"
}
```

Replying to [comment:2 jdemeyer]:
> Replying to [ticket:28365 embray]:
> > a monotonically increasing integer for each manifold

> 
> Sounds like the best solution, unless this needs to be cryptographically secure :-)


Yup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)



---

archive/issue_comments_396884.json:
```json
{
    "body": "Here's a version of the workaround I mentioned.  I'm not even really sure the getrandbits is necessary either, but I'm not sure so I left it for now.  Could even keep `time()` but again, it's not clear it's really needed.\n\n---\nNew commits:",
    "created_at": "2019-08-19T17:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396884",
    "user": "https://github.com/embray"
}
```

Here's a version of the workaround I mentioned.  I'm not even really sure the getrandbits is necessary either, but I'm not sure so I left it for now.  Could even keep `time()` but again, it's not clear it's really needed.

---
New commits:



---

archive/issue_comments_396885.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-19T17:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396885",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396886.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> Replying to [comment:2 jdemeyer]:\n> > Replying to [ticket:28365 embray]:\n> > > a monotonically increasing integer for each manifold\n\n> > \n> > Sounds like the best solution, unless this needs to be cryptographically secure :-)\n\n> \n> Yup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)\n\n\nYes the use of `time()` was only a (bad!) attempt to guarantee uniqueness. Combining it with `getrandbits(128)` was naively thought as a security in case two successive calls of `time()` occur with a time separation too small to be resolved.\nThe use of the monotonically increasing integer as in you implemented in the above commit seems a much more robust solution. \n\nIn the long term, I think we should get rid of the `UniqueRepresentation` for manifolds, except for those that do have a mathematically meaningful unique representation, like `EuclideanSpace`. Having manifolds inherit from `UniqueRepresentation` was a hack to make pickling work easily, which is required for parallelized computations via `multiprocessing`.",
    "created_at": "2019-08-19T20:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396886",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:4 embray]:
> Replying to [comment:2 jdemeyer]:
> > Replying to [ticket:28365 embray]:
> > > a monotonically increasing integer for each manifold

> > 
> > Sounds like the best solution, unless this needs to be cryptographically secure :-)

> 
> Yup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)


Yes the use of `time()` was only a (bad!) attempt to guarantee uniqueness. Combining it with `getrandbits(128)` was naively thought as a security in case two successive calls of `time()` occur with a time separation too small to be resolved.
The use of the monotonically increasing integer as in you implemented in the above commit seems a much more robust solution. 

In the long term, I think we should get rid of the `UniqueRepresentation` for manifolds, except for those that do have a mathematically meaningful unique representation, like `EuclideanSpace`. Having manifolds inherit from `UniqueRepresentation` was a hack to make pickling work easily, which is required for parallelized computations via `multiprocessing`.



---

archive/issue_comments_396887.json:
```json
{
    "body": "Replying to [comment:6 egourgoulhon]:\n> Replying to [comment:4 embray]:\n> > Replying to [comment:2 jdemeyer]:\n> > > Replying to [ticket:28365 embray]:\n> > > > a monotonically increasing integer for each manifold\n\n> > > \n> > > Sounds like the best solution, unless this needs to be cryptographically secure :-)\n\n> > \n> > Yup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)\n\n\n> In the long term, I think we should get rid of the `UniqueRepresentation` for manifolds, except for those that do have a mathematically meaningful unique representation, like `EuclideanSpace`. Having manifolds inherit from `UniqueRepresentation` was a hack to make pickling work easily, which is required for parallelized computations via `multiprocessing`.\n\n\nYes, that doesn't seem like a good enough justification, given that pickling can be done elsewise.  Though as you say, having an easy way to construct *specific* manifolds that should be globally unique would be good too.",
    "created_at": "2019-08-21T10:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396887",
    "user": "https://github.com/embray"
}
```

Replying to [comment:6 egourgoulhon]:
> Replying to [comment:4 embray]:
> > Replying to [comment:2 jdemeyer]:
> > > Replying to [ticket:28365 embray]:
> > > > a monotonically increasing integer for each manifold

> > > 
> > > Sounds like the best solution, unless this needs to be cryptographically secure :-)

> > 
> > Yup. Was just discussing this with Samuel and it seems obvious now that we think about it.  Just want to confirm that Eric that the use of `time()` is merely to guarantee uniqueness (in which case, it is not a good guarantee of uniqueness :)


> In the long term, I think we should get rid of the `UniqueRepresentation` for manifolds, except for those that do have a mathematically meaningful unique representation, like `EuclideanSpace`. Having manifolds inherit from `UniqueRepresentation` was a hack to make pickling work easily, which is required for parallelized computations via `multiprocessing`.


Yes, that doesn't seem like a good enough justification, given that pickling can be done elsewise.  Though as you say, having an easy way to construct *specific* manifolds that should be globally unique would be good too.



---

archive/issue_comments_396888.json:
```json
{
    "body": "Specifically, what problems did you encounter with pickling of manifolds that `UniqueRepresentation` was able to solve?",
    "created_at": "2019-08-21T10:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396888",
    "user": "https://github.com/embray"
}
```

Specifically, what problems did you encounter with pickling of manifolds that `UniqueRepresentation` was able to solve?



---

archive/issue_comments_396889.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396889",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396890.json:
```json
{
    "body": "LGTM. Thanks!\n\nDoes this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they?",
    "created_at": "2019-08-21T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396890",
    "user": "https://github.com/egourgoulhon"
}
```

LGTM. Thanks!

Does this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they?



---

archive/issue_comments_396891.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Specifically, what problems did you encounter with pickling of manifolds that `UniqueRepresentation` was able to solve?\n\n\nWell, this was some time ago and I have to figure out again what the problems were...\nBasically, manifolds are objects that are constructed on the fly, with the user adding open subsets, charts and vector frames at any time.",
    "created_at": "2019-08-21T14:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396891",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:8 embray]:
> Specifically, what problems did you encounter with pickling of manifolds that `UniqueRepresentation` was able to solve?


Well, this was some time ago and I have to figure out again what the problems were...
Basically, manifolds are objects that are constructed on the fly, with the user adding open subsets, charts and vector frames at any time.



---

archive/issue_comments_396892.json:
```json
{
    "body": "Replying to [comment:9 egourgoulhon]:\n> Does this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they? \n\n\nWhen running tests, the doctesting framework resets the random seed\nto 0 at each new doctest, in order to ensure reproducibility of doctests!",
    "created_at": "2019-08-21T14:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396892",
    "user": "https://github.com/slel"
}
```

Replying to [comment:9 egourgoulhon]:
> Does this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they? 


When running tests, the doctesting framework resets the random seed
to 0 at each new doctest, in order to ensure reproducibility of doctests!



---

archive/issue_comments_396893.json:
```json
{
    "body": "Replying to [comment:12 slelievre]:\n> Replying to [comment:9 egourgoulhon]:\n> > Does this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they? \n\n> \n> When running tests, the doctesting framework resets the random seed\n> to 0 at each new doctest, in order to ensure reproducibility of doctests!\n\n\nAh I see... I was not aware of this point. Thanks for explaining it!",
    "created_at": "2019-08-21T15:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396893",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:12 slelievre]:
> Replying to [comment:9 egourgoulhon]:
> > Does this solve the issue with !Cygwin/Windows 7 reported in ticket:28331#comment:5 ? If yes, it seems to me that `getrandbits` is somehow broken on this computer, because it should have solved the degeneracy in `time()`: in the same session, two successive calls to `getrandbits(128)` are very unlikely to return the same value, aren't they? 

> 
> When running tests, the doctesting framework resets the random seed
> to 0 at each new doctest, in order to ensure reproducibility of doctests!


Ah I see... I was not aware of this point. Thanks for explaining it!



---

archive/issue_comments_396894.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-29T20:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28365#issuecomment-396894",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070857.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-29T20:02:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28365",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28365#event-70857"
}
```
