# Issue 28297: Small optimizations to arithmetic in number fields of degree > 2

archive/issues_028060.json:
```json
{
    "body": "Micro-benchmark (maybe of limited relevance):\n\n```   \nsage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))\nsage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10\nsage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10\n```    \nBefore:\n\n```    \nsage: %timeit b+c\nThe slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 4.76 \u00b5s per loop\n```    \nAfter:\n\n```    \nsage: %timeit b+c\nThe slowest run took 8.70 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.34 \u00b5s per loop\n```\n\nThere seem to be a lot more opportunities to further improve basic arithmetic operations by removing gcds at the right moment. Please feel free to hijack the ticket if you find the time and energy to have a look!\n\nBranch/Commit: c71c660a3e5c89ea081ac8161a4ee8cb05bc6e79\n\nReviewer: Michael Orlitzky, Marc Mezzarobba\n\nAuthor: Marc Mezzarobba, Michael Orlitzky\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28297\n\n",
    "closed_at": "2019-08-29T20:02:03Z",
    "created_at": "2019-07-31T07:31:54Z",
    "labels": [
        "component: performance",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Small optimizations to arithmetic in number fields of degree > 2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28297",
    "user": "https://github.com/mezzarobba"
}
```
Micro-benchmark (maybe of limited relevance):

```   
sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))
sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10
sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10
```    
Before:

```    
sage: %timeit b+c
The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.76 µs per loop
```    
After:

```    
sage: %timeit b+c
The slowest run took 8.70 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.34 µs per loop
```

There seem to be a lot more opportunities to further improve basic arithmetic operations by removing gcds at the right moment. Please feel free to hijack the ticket if you find the time and energy to have a look!

Branch/Commit: c71c660a3e5c89ea081ac8161a4ee8cb05bc6e79

Reviewer: Michael Orlitzky, Marc Mezzarobba

Author: Marc Mezzarobba, Michael Orlitzky

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28297





---

archive/issue_comments_422138.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-07-31T07:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422138",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_422139.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -5,14 +5,14 @@\n     sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10\n     sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10\n \\`\\`\\`    \n-    Before:\n+Before:\n \n \\`\\`\\`    \n     sage: %timeit b+c\n     The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n     100000 loops, best of 3: 4.76 \u00b5s per loop\n \\`\\`\\`    \n-    After:\n+After:\n \n \\`\\`\\`    \n     sage: %timeit b+c\n@@ -20,7 +20,7 @@\n     100000 loops, best of 3: 3.58 \u00b5s per loop\n \\`\\`\\`\n \n-(There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!)\n+There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!\n \n Author: Marc Mezzarobba\n \n```\n",
    "created_at": "2019-07-31T07:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422139",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
```diff
--- 
+++ 
@@ -5,14 +5,14 @@
     sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10
     sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10
 \`\`\`    
-    Before:
+Before:
 
 \`\`\`    
     sage: %timeit b+c
     The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.
     100000 loops, best of 3: 4.76 µs per loop
 \`\`\`    
-    After:
+After:
 
 \`\`\`    
     sage: %timeit b+c
@@ -20,7 +20,7 @@
     100000 loops, best of 3: 3.58 µs per loop
 \`\`\`
 
-(There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!)
+There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!
 
 Author: Marc Mezzarobba
 
```




---

archive/issue_comments_422140.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-31T07:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422140",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422141.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-31T16:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422141",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422142.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,26 @@\n+Micro-benchmark (maybe of limited relevance):\n \n+\\`\\`\\`   \n+sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))\n+sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10\n+sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10\n+\\`\\`\\`    \n+Before:\n+\n+\\`\\`\\`    \n+sage: %timeit b+c\n+The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n+100000 loops, best of 3: 4.76 \u00b5s per loop\n+\\`\\`\\`    \n+After:\n+\n+\\`\\`\\`    \n+sage: %timeit b+c\n+The slowest run took 8.70 times longer than the fastest. This could mean that an intermediate result is being cached.\n+100000 loops, best of 3: 3.34 \u00b5s per loop\n+\\`\\`\\`\n+\n+There seem to be a lot more opportunities to further improve basic arithmetic operations by removing gcds at the right moment. Please feel free to hijack the ticket if you find the time and energy to have a look!\n \n Author: Marc Mezzarobba\n \n```\n",
    "created_at": "2019-07-31T16:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422142",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,26 @@
+Micro-benchmark (maybe of limited relevance):
 
+\`\`\`   
+sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))
+sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10
+sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10
+\`\`\`    
+Before:
+
+\`\`\`    
+sage: %timeit b+c
+The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.
+100000 loops, best of 3: 4.76 µs per loop
+\`\`\`    
+After:
+
+\`\`\`    
+sage: %timeit b+c
+The slowest run took 8.70 times longer than the fastest. This could mean that an intermediate result is being cached.
+100000 loops, best of 3: 3.34 µs per loop
+\`\`\`
+
+There seem to be a lot more opportunities to further improve basic arithmetic operations by removing gcds at the right moment. Please feel free to hijack the ticket if you find the time and energy to have a look!
 
 Author: Marc Mezzarobba
 
```




---

archive/issue_comments_422143.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-18T11:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422143",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422144.json:
```json
{
    "body": "<a id='comment:5'></a>Rebased.",
    "created_at": "2019-08-18T11:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422144",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:5'></a>Rebased.



---

archive/issue_comments_422145.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T12:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422145",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422146.json:
```json
{
    "body": "<a id='comment:6'></a>Seems straightforward:\n\nThe addition to `_reduce_c_()` bails out early if the denominator is one because in that case there's nothing to do. The check is cheap and avoids several other function calls that do nothing when the denominator is one, so I believe it's an improvement on average.\n\nThe changes to  `_add_()` and `_sub_()` are identical. We now pull out the GCD of the two denominators (which are smallish numbers) early, and it eventually cancels out. This would happen anyway when we call `_reduce_c_()` before `return`ing, but at that point we would be cancelling the same GCD out of the relatively-largish product of the denominators. I have faith that doing it early at least makes things no worse, and your numbers show an improvement, so it's fine by me. (This also makes it more likely that we hit the new \"fast return\" in `_reduce_c_()`.)\n\nCould you please describe the changes in a bit more detail in the commit message? That's my only nitpick.",
    "created_at": "2019-08-21T12:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422146",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>Seems straightforward:

The addition to `_reduce_c_()` bails out early if the denominator is one because in that case there's nothing to do. The check is cheap and avoids several other function calls that do nothing when the denominator is one, so I believe it's an improvement on average.

The changes to  `_add_()` and `_sub_()` are identical. We now pull out the GCD of the two denominators (which are smallish numbers) early, and it eventually cancels out. This would happen anyway when we call `_reduce_c_()` before `return`ing, but at that point we would be cancelling the same GCD out of the relatively-largish product of the denominators. I have faith that doing it early at least makes things no worse, and your numbers show an improvement, so it's fine by me. (This also makes it more likely that we hit the new "fast return" in `_reduce_c_()`.)

Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.



---

archive/issue_comments_422147.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2019-08-21T13:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422147",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_422148.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-08-21T13:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422148",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_422149.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T13:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422149",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422150.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 mjo]:\n> Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.\n\n\nI've copied your detailed description (minus a few sentences) there. I hope that's okay.\n\nThank you for the review!",
    "created_at": "2019-08-21T13:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422150",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:8'></a>Replying to [comment:6 mjo]:
> Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.


I've copied your detailed description (minus a few sentences) there. I hope that's okay.

Thank you for the review!



---

archive/issue_comments_422151.json:
```json
{
    "body": "<a id='comment:9'></a>Yes that's fine with me. You don't have to give me author credit for just describing what you did, but you're the boss =)",
    "created_at": "2019-08-21T21:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422151",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'></a>Yes that's fine with me. You don't have to give me author credit for just describing what you did, but you're the boss =)



---

archive/issue_comments_422152.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-29T20:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28297#issuecomment-422152",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070636.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-29T20:02:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28297",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28297#event-70636"
}
```
