# Issue 28207: Derivative of piecewise function returns junk

archive/issues_027970.json:
```json
{
    "body": "Reported in [Ask SageMath question #47169](https://ask.sagemath.org/question/47169/plotting-derivative-of-bump-function/), we can't differentiate the bump function:\n\n```\nsage: f(x) = piecewise([((-oo, -1), 0), ((-1, 1), exp(-1/(1 - x^2))), ((1, oo), 0)])\nsage: f.diff()\nx |--> (0, 0, 0)*D[0]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x) + D[1]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x)\nsage: f.diff()(0)\n(0, 0, 0)*e^(-1) + e^(-1)\nsage: f.diff()(0) in RR\nFalse\n```\n\nThat's not right...\n\n**CC:**  @tscrim @slel @kliem\n\n**Keywords:** piecewise, derivative, diff\n\n**Branch/Commit:** [2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\nIssue created by migration from https://trac.sagemath.org/ticket/28207\n\n",
    "closed_at": "2021-10-24T18:39:17Z",
    "created_at": "2019-07-16T19:08:47Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "title": "Derivative of piecewise function returns junk",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/28207",
    "user": "https://github.com/rburing"
}
```
Reported in [Ask SageMath question #47169](https://ask.sagemath.org/question/47169/plotting-derivative-of-bump-function/), we can't differentiate the bump function:

```
sage: f(x) = piecewise([((-oo, -1), 0), ((-1, 1), exp(-1/(1 - x^2))), ((1, oo), 0)])
sage: f.diff()
x |--> (0, 0, 0)*D[0]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x) + D[1]piecewise(x|-->0 on (-oo, -1), x|-->e^(1/(x^2 - 1)) on (-1, 1), x|-->0 on (1, +oo); x)
sage: f.diff()(0)
(0, 0, 0)*e^(-1) + e^(-1)
sage: f.diff()(0) in RR
False
```

That's not right...

**CC:**  @tscrim @slel @kliem

**Keywords:** piecewise, derivative, diff

**Branch/Commit:** [2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)

**Reviewer:** Travis Scrimshaw

**Author:** Frédéric Chapoton

Issue created by migration from https://trac.sagemath.org/ticket/28207





---

archive/issue_comments_441999.json:
```json
{
    "body": "<a id='comment:1'></a>\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-441999",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Ticket retargeted after milestone closed



---

archive/issue_events_249179.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249179"
}
```



---

archive/issue_events_249180.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249180"
}
```



---

archive/issue_comments_442000.json:
```json
{
    "body": "<a id='comment:2'></a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442000",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_249181.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249181"
}
```



---

archive/issue_events_249182.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249182"
}
```



---

archive/issue_events_249183.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249183"
}
```



---

archive/issue_events_249184.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249184"
}
```



---

archive/issue_events_249185.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249185"
}
```



---

archive/issue_events_249186.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249186"
}
```



---

archive/issue_comments_442001.json:
```json
{
    "body": "<a id='comment:4'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442001",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_249187.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249187"
}
```



---

archive/issue_events_249188.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249188"
}
```



---

archive/issue_comments_442002.json:
```json
{
    "body": "**Branch:** [u/chapoton/28207](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28207)",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442002",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [u/chapoton/28207](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28207)



---

archive/issue_comments_442003.json:
```json
{
    "body": "**Commit:** [e1b526c6be9cfc1bcb879fadbe63fb2d56b66010](https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010)",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442003",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [e1b526c6be9cfc1bcb879fadbe63fb2d56b66010](https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010)



---

archive/issue_comments_442004.json:
```json
{
    "body": "**Author:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442004",
    "user": "https://github.com/fchapoton"
}
```

**Author:** Frédéric Chapoton



---

archive/issue_events_249189.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-19T16:25:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249189"
}
```



---

archive/issue_comments_442005.json:
```json
{
    "body": "<a id='comment:6'></a>\nhere is a tentative ; certainly better than before, but not perfect\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010\">e1b526c</a></td><td><code>trying to make derivative od piecewise work</code></td></tr></table>\n",
    "created_at": "2021-10-19T16:25:33Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442005",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
here is a tentative ; certainly better than before, but not perfect

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010">e1b526c</a></td><td><code>trying to make derivative od piecewise work</code></td></tr></table>




---

archive/issue_comments_442006.json:
```json
{
    "body": "<a id='comment:7'></a>\nWhat would you say is missing from making it perfect?",
    "created_at": "2021-10-20T04:04:15Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442006",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
What would you say is missing from making it perfect?



---

archive/issue_comments_442007.json:
```json
{
    "body": "<a id='comment:8'></a>\nderivative wrt y is not working, giving the same result as wrt x...",
    "created_at": "2021-10-20T06:54:33Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442007",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
derivative wrt y is not working, giving the same result as wrt x...



---

archive/issue_comments_442008.json:
```json
{
    "body": "<a id='comment:9'></a>\nCould we add a short explanation and doctest showing this behavior (and perhaps with the desired output)?",
    "created_at": "2021-10-20T07:02:35Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442008",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
Could we add a short explanation and doctest showing this behavior (and perhaps with the desired output)?



---

archive/issue_comments_442009.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/028cc8a4ca09b3842abd412ac54c58df6aecad06\">028cc8a</a></td><td><code>Merge branch 'u/chapoton/28207' in 9.5.b4</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097\">2f0c828</a></td><td><code>describe known bugs in derivative of piecewise</code></td></tr></table>\n",
    "created_at": "2021-10-20T11:40:18Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442009",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/028cc8a4ca09b3842abd412ac54c58df6aecad06">028cc8a</a></td><td><code>Merge branch 'u/chapoton/28207' in 9.5.b4</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097">2f0c828</a></td><td><code>describe known bugs in derivative of piecewise</code></td></tr></table>




---

archive/issue_comments_442010.json:
```json
{
    "body": "**Changing commit** from \"[e1b526c6be9cfc1bcb879fadbe63fb2d56b66010](https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010)\" to \"[2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)\".",
    "created_at": "2021-10-20T11:40:18Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442010",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[e1b526c6be9cfc1bcb879fadbe63fb2d56b66010](https://github.com/sagemath/sagetrac-mirror/commit/e1b526c6be9cfc1bcb879fadbe63fb2d56b66010)" to "[2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)".



---

archive/issue_comments_442011.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis is still very ugly. One should try to fix that, but experts are lacking..",
    "created_at": "2021-10-20T11:41:10Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442011",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>
This is still very ugly. One should try to fix that, but experts are lacking..



---

archive/issue_comments_442012.json:
```json
{
    "body": "<a id='comment:12'></a>\nI am not sure these should actually count as bugs as the behavior is consistent with what other symbolic functions do:\n\n```\nsage: y = SR.var('y')\nsage: f(x) = x*y + x + y\nsage: type(f)\n<class 'sage.symbolic.expression.Expression'>\nsage: f\nx |--> x*y + x + y\n\nsage: f.derivative(x)\nx |--> y + 1\nsage: f.derivative(y)\nx |--> x + 1\n```\nWhat would you expect the output to be?",
    "created_at": "2021-10-20T23:51:35Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442012",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
I am not sure these should actually count as bugs as the behavior is consistent with what other symbolic functions do:

```
sage: y = SR.var('y')
sage: f(x) = x*y + x + y
sage: type(f)
<class 'sage.symbolic.expression.Expression'>
sage: f
x |--> x*y + x + y

sage: f.derivative(x)
x |--> y + 1
sage: f.derivative(y)
x |--> x + 1
```
What would you expect the output to be?



---

archive/issue_comments_442013.json:
```json
{
    "body": "<a id='comment:13'></a>\nI have written the expected output in the doctests. The actual behaviour, with the branch, is to raise an Error.",
    "created_at": "2021-10-21T07:04:34Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442013",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>
I have written the expected output in the doctests. The actual behaviour, with the branch, is to raise an Error.



---

archive/issue_comments_442014.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2021-10-21T07:27:34Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442014",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_events_249190.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-10-21T07:27:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249190"
}
```



---

archive/issue_events_249191.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-10-21T07:27:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249191"
}
```



---

archive/issue_comments_442015.json:
```json
{
    "body": "<a id='comment:14'></a>\nAh, sorry, I misunderstood. Thank you. LGTM.",
    "created_at": "2021-10-21T07:27:34Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442015",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Ah, sorry, I misunderstood. Thank you. LGTM.



---

archive/issue_comments_442016.json:
```json
{
    "body": "<a id='comment:15'></a>\nI would have hoped that someone step in to fix that..\n\nHere is the traceback:\n\n```\nsage: y = SR.var('y')\nsage: h = piecewise([((-1,1),x**2*y)])\nsage: h.derivative(x)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-6-efc8c30bd882> in <module>\n----> 1 h.derivative(x)\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()\n   4574             ValueError: No differentiation variable specified.\n   4575         \"\"\"\n-> 4576         return multi_derivative(self, args)\n   4577 \n   4578     diff = differentiate = derivative\n\n~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3218)()\n    220 \n    221     for arg in derivative_parse(args):\n--> 222         F = F._derivative(arg)\n    223     return F\n    224 \n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55084)()\n   4646         sig_on()\n   4647         try:\n-> 4648             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)\n   4649         finally:\n   4650             sig_off()\n\n~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in _tderivative_(self, parameters, variable, *args, **kwds)\n    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)\n    313         \"\"\"\n--> 314         return piecewise([(domain, func.derivative(*args))\n    315                           for domain, func in parameters],\n    316                          var=variable)\n\n~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in <listcomp>(.0)\n    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)\n    313         \"\"\"\n--> 314         return piecewise([(domain, func.derivative(*args))\n    315                           for domain, func in parameters],\n    316                          var=variable)\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()\n   4574             ValueError: No differentiation variable specified.\n   4575         \"\"\"\n-> 4576         return multi_derivative(self, args)\n   4577 \n   4578     diff = differentiate = derivative\n\n~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3114)()\n    217     if not args:\n    218         # fast version where no arguments supplied\n--> 219         return F._derivative()\n    220 \n    221     for arg in derivative_parse(args):\n\n~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:54909)()\n   4636                 return self.gradient()\n   4637             else:\n-> 4638                 raise ValueError(\"No differentiation variable specified.\")\n   4639         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \\\n   4640                 or deg < 1:\n\nValueError: No differentiation variable specified.\n```",
    "created_at": "2021-10-21T07:47:08Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442016",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>
I would have hoped that someone step in to fix that..

Here is the traceback:

```
sage: y = SR.var('y')
sage: h = piecewise([((-1,1),x**2*y)])
sage: h.derivative(x)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-6-efc8c30bd882> in <module>
----> 1 h.derivative(x)

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()
   4574             ValueError: No differentiation variable specified.
   4575         """
-> 4576         return multi_derivative(self, args)
   4577 
   4578     diff = differentiate = derivative

~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3218)()
    220 
    221     for arg in derivative_parse(args):
--> 222         F = F._derivative(arg)
    223     return F
    224 

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55084)()
   4646         sig_on()
   4647         try:
-> 4648             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)
   4649         finally:
   4650             sig_off()

~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in _tderivative_(self, parameters, variable, *args, **kwds)
    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)
    313         """
--> 314         return piecewise([(domain, func.derivative(*args))
    315                           for domain, func in parameters],
    316                          var=variable)

~/sage/local/lib/python3.8/site-packages/sage/functions/piecewise.py in <listcomp>(.0)
    312             piecewise(x|-->0 on (-oo, -1), x|-->-2*x*e^(1/(x^2 - 1))/(x^2 - 1)^2 on (-1, 1), x|-->0 on (1, +oo); x)
    313         """
--> 314         return piecewise([(domain, func.derivative(*args))
    315                           for domain, func in parameters],
    316                          var=variable)

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54561)()
   4574             ValueError: No differentiation variable specified.
   4575         """
-> 4576         return multi_derivative(self, args)
   4577 
   4578     diff = differentiate = derivative

~/sage/local/lib/python3.8/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3114)()
    217     if not args:
    218         # fast version where no arguments supplied
--> 219         return F._derivative()
    220 
    221     for arg in derivative_parse(args):

~/sage/local/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:54909)()
   4636                 return self.gradient()
   4637             else:
-> 4638                 raise ValueError("No differentiation variable specified.")
   4639         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \
   4640                 or deg < 1:

ValueError: No differentiation variable specified.
```



---

archive/issue_comments_442017.json:
```json
{
    "body": "<a id='comment:16'></a>\nI will try to dig a little deeper soon.",
    "created_at": "2021-10-21T11:16:35Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442017",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>
I will try to dig a little deeper soon.



---

archive/issue_events_249192.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-24T18:39:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249192"
}
```



---

archive/issue_events_249193.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-24T18:39:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28207#event-249193"
}
```



---

archive/issue_comments_442018.json:
```json
{
    "body": "**Changing branch** from \"[u/chapoton/28207](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28207)\" to \"[2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)\".",
    "created_at": "2021-10-24T18:39:17Z",
    "issue": "https://github.com/sagemath/sage/issues/28207",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28207#issuecomment-442018",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/chapoton/28207](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28207)" to "[2f0c8282bee61453e962f57cdc2a16be746ba097](https://github.com/sagemath/sagetrac-mirror/commit/2f0c8282bee61453e962f57cdc2a16be746ba097)".
