# Issue 28387: Implement function that returns the balanced digit representation of an integer

archive/issues_028150.json:
```json
{
    "body": "This ticket adds the balanced_digits function, returning the digit representation of an integer where the digits are centered at 0. For example, this enables:\n\n```\nsage: 8.balanced_digits(3)\n[-1, 0, 1]\n```\n\n```\nsage: 33.balanced_digits(6)\n[3, -1, 1]\n```\n\n\nBranch/Commit: a69b95259043fa5b5b0faa1cb12c4bf6506fea3d\n\nReviewer: Bruno Grenet\n\nAuthor: Alex Shearer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28387\n\n",
    "closed_at": "2019-09-02T21:40:41Z",
    "created_at": "2019-08-22T22:01:20Z",
    "labels": [
        "component: number theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Implement function that returns the balanced digit representation of an integer",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28387",
    "user": "https://github.com/sheareralexj"
}
```
This ticket adds the balanced_digits function, returning the digit representation of an integer where the digits are centered at 0. For example, this enables:

```
sage: 8.balanced_digits(3)
[-1, 0, 1]
```

```
sage: 33.balanced_digits(6)
[3, -1, 1]
```


Branch/Commit: a69b95259043fa5b5b0faa1cb12c4bf6506fea3d

Reviewer: Bruno Grenet

Author: Alex Shearer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28387





---

archive/issue_comments_397078.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-22T22:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397078",
    "user": "https://github.com/sheareralexj"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_397079.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-08-22T22:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397079",
    "user": "https://github.com/sheareralexj"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_397080.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-23T10:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397080",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_397081.json:
```json
{
    "body": "<a id='comment:3'></a>That's a good idea to add this. I've a few comments on your implementation though. \n\n## Incorrect algorithm?\n\nFirst, it is not clear to me (so the docstring should be adapted) what is the exact specification. I would say that the balanced base `b` uses `b` digits centered around zero. Thus if `b` is odd, there is only one possibility, namely digits between `-b//2` and `b//2` (both included). For instance in base 9, one uses digits from -4 to 4. If `b` is even, one has to choose between digits from `-b//2` to `b//2-1` or `-b//2+1` to `b//2` (base 10 for instance: either -5 to 4 or -4 to 5), and this is defined by the value of `positive_shift`. Is that we you have in mind? Note that in this case, your implementation has a problem:\n\n```python\nsage: n = -46\nsage: n.balanced_digits(10) # correct\n[4, -5]\nsage: n.balanced_digits(10, positive_shift=True) # should be [4, 5, -1]\n[4, -5]\n```\n\nI think that a correct algorithm (if my specification in the one you have in mind) would be easier to write using a \"balanced `quo_rem`\" that on input `a` and `b` returns `(q, r)` such that `a = b*q + r` with `-b//2 <= r <= b//2` (with the same subtleties for even bases). This could go as follows:\n\n```python\ndef balanced_quo_rem(self, right, positive_shift=True):\n    q, r = self.quo_rem(right)\n    if r > right//2:\n        return (q+1, r-right)\n    if right % 2 == 0 and not positive_shift and r == right//2:\n        return (q+1, r-right)\n    return (q, r)\n```\n\nThen the algorithm could be implemented as (I just put the main idea):\n\n```python\ndef balanced_digits(self, base, positive_shift=True):\n    digits = []\n    n = self\n    while n > 0:\n        q, r = n.balanced_quo_rem(base, positive_shift)\n        digits.append(r)\n        n = q\n    return digits\n```\n\n\n## Other remarks\n\nBelow, I indicate a few general comments on your current implementation (and the docstring, tests, etc.), though it should be changed anyway.\n\n#### In the docstring\n\n1. There should not be a blank line as first line;\n2. It should be \"Return\" rather than \"Returns\" (as mentioned in [the doc](http://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content));\n3. Following the doc also, I would put a blank line between the first sentence (\"Return ... given base\") and the rest of the specification;\n4. I would write \"Return **the** list of balanced digits\" rather than \"Return a list of balanced digit\" (since there is uniqueness);\n5. You should replace `b/2` by `b//2` in the docstring to indicate a floor division (if the base is odd);\n6. Your `::` alone on a line should be replaced by `TESTS::`;\n7. You should write a more precise specification more generally.\n\n#### In the code itself\n\n1. I think that having `base = 10` as default would be a good idea, to be consistent with `n.digits()` for instance (should be then mentioned in the doc obviously);\n2. You may raise an `Exception` if the base is not an integer (and add an `EXAMPLE` for this). Something like:\n   {{{#!python\nif isinstance(base, Integer): \n    _base = base\nelse:\n    try:\n        _base = Integer(base)\n    except TypeError:\n        raise ValueError('base should be an integer')\n   }}}\n1. You should not use `floor(b/2)`, but rather `b//2`;\n2. You may compute `self_abs` and `neg` as follows: `self_abs, neg = self.abs(), self.sign()`",
    "created_at": "2019-08-23T10:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397081",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:3'></a>That's a good idea to add this. I've a few comments on your implementation though. 

## Incorrect algorithm?

First, it is not clear to me (so the docstring should be adapted) what is the exact specification. I would say that the balanced base `b` uses `b` digits centered around zero. Thus if `b` is odd, there is only one possibility, namely digits between `-b//2` and `b//2` (both included). For instance in base 9, one uses digits from -4 to 4. If `b` is even, one has to choose between digits from `-b//2` to `b//2-1` or `-b//2+1` to `b//2` (base 10 for instance: either -5 to 4 or -4 to 5), and this is defined by the value of `positive_shift`. Is that we you have in mind? Note that in this case, your implementation has a problem:

```python
sage: n = -46
sage: n.balanced_digits(10) # correct
[4, -5]
sage: n.balanced_digits(10, positive_shift=True) # should be [4, 5, -1]
[4, -5]
```

I think that a correct algorithm (if my specification in the one you have in mind) would be easier to write using a "balanced `quo_rem`" that on input `a` and `b` returns `(q, r)` such that `a = b*q + r` with `-b//2 <= r <= b//2` (with the same subtleties for even bases). This could go as follows:

```python
def balanced_quo_rem(self, right, positive_shift=True):
    q, r = self.quo_rem(right)
    if r > right//2:
        return (q+1, r-right)
    if right % 2 == 0 and not positive_shift and r == right//2:
        return (q+1, r-right)
    return (q, r)
```

Then the algorithm could be implemented as (I just put the main idea):

```python
def balanced_digits(self, base, positive_shift=True):
    digits = []
    n = self
    while n > 0:
        q, r = n.balanced_quo_rem(base, positive_shift)
        digits.append(r)
        n = q
    return digits
```


## Other remarks

Below, I indicate a few general comments on your current implementation (and the docstring, tests, etc.), though it should be changed anyway.

#### In the docstring

1. There should not be a blank line as first line;
2. It should be "Return" rather than "Returns" (as mentioned in [the doc](http://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content));
3. Following the doc also, I would put a blank line between the first sentence ("Return ... given base") and the rest of the specification;
4. I would write "Return **the** list of balanced digits" rather than "Return a list of balanced digit" (since there is uniqueness);
5. You should replace `b/2` by `b//2` in the docstring to indicate a floor division (if the base is odd);
6. Your `::` alone on a line should be replaced by `TESTS::`;
7. You should write a more precise specification more generally.

#### In the code itself

1. I think that having `base = 10` as default would be a good idea, to be consistent with `n.digits()` for instance (should be then mentioned in the doc obviously);
2. You may raise an `Exception` if the base is not an integer (and add an `EXAMPLE` for this). Something like:
   {{{#!python
if isinstance(base, Integer): 
    _base = base
else:
    try:
        _base = Integer(base)
    except TypeError:
        raise ValueError('base should be an integer')
   }}}
1. You should not use `floor(b/2)`, but rather `b//2`;
2. You may compute `self_abs` and `neg` as follows: `self_abs, neg = self.abs(), self.sign()`



---

archive/issue_comments_397082.json:
```json
{
    "body": "<a id='comment:4'></a>Actually, there is another (simpler?) algorithm:\n\n1. First compute the classical base `b` representation of the input integer `n`;\n2. Scan the digits from low to high order, and if a digit `d` is larger than `b//2`, replace `d` by `d-b` and remove one to the next digit. \n\nYou still have to manage the subtlety for even bases but that's not a big deal. Also, the two-step algorithm I mention works for nonnegative integers. For negative integers, do the same with `abs(n)` and take the opposite of all digits. For even bases, you have to do it with `not positive shift`.",
    "created_at": "2019-08-23T11:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397082",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:4'></a>Actually, there is another (simpler?) algorithm:

1. First compute the classical base `b` representation of the input integer `n`;
2. Scan the digits from low to high order, and if a digit `d` is larger than `b//2`, replace `d` by `d-b` and remove one to the next digit. 

You still have to manage the subtlety for even bases but that's not a big deal. Also, the two-step algorithm I mention works for nonnegative integers. For negative integers, do the same with `abs(n)` and take the opposite of all digits. For even bases, you have to do it with `not positive shift`.



---

archive/issue_comments_397083.json:
```json
{
    "body": "<a id='comment:5'></a>Thanks for reviewing, and thanks for finding the error! Yeah, it seems the issue is that the code is handling negatives incorrectly. Today  I'll work at fixing this as well as implementing your other suggestions and algorithms.\n\nThanks!",
    "created_at": "2019-08-23T17:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397083",
    "user": "https://github.com/sheareralexj"
}
```

<a id='comment:5'></a>Thanks for reviewing, and thanks for finding the error! Yeah, it seems the issue is that the code is handling negatives incorrectly. Today  I'll work at fixing this as well as implementing your other suggestions and algorithms.

Thanks!



---

archive/issue_comments_397084.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-24T02:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397084",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_397085.json:
```json
{
    "body": "<a id='comment:7'></a>I updated the code and used the documentation you suggested. I tested the runtime on all three algorithms and went with the last one (using the standard n.digits(b) function) as it worked fastest for large bases.",
    "created_at": "2019-08-24T02:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397085",
    "user": "https://github.com/sheareralexj"
}
```

<a id='comment:7'></a>I updated the code and used the documentation you suggested. I tested the runtime on all three algorithms and went with the last one (using the standard n.digits(b) function) as it worked fastest for large bases.



---

archive/issue_comments_397086.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-24T02:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397086",
    "user": "https://github.com/sheareralexj"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_397087.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-26T09:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397087",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_397088.json:
```json
{
    "body": "<a id='comment:9'></a>The new version is much better indeed! I still have a two remarks:\n\n- The case `base = 2` is problematic. Depending on `positive_shift` it can only represent nonnegative or nonpositive integers. The simplest way to deal with it is probably to impose that `base > 2`.\n\n- I would add some details in the docstring for the parameter `positive_shift`. In the block `INPUT`, you may write something like \"For even bases, the representation uses digits from `-b//2 + 1` to `b//2` if set to True, and from `-b//2` to `b//2-1` otherwise. This has no effect for odd bases.\"",
    "created_at": "2019-08-26T09:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397088",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:9'></a>The new version is much better indeed! I still have a two remarks:

- The case `base = 2` is problematic. Depending on `positive_shift` it can only represent nonnegative or nonpositive integers. The simplest way to deal with it is probably to impose that `base > 2`.

- I would add some details in the docstring for the parameter `positive_shift`. In the block `INPUT`, you may write something like "For even bases, the representation uses digits from `-b//2 + 1` to `b//2` if set to True, and from `-b//2` to `b//2-1` otherwise. This has no effect for odd bases."



---

archive/issue_comments_397089.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-26T19:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397089",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_397090.json:
```json
{
    "body": "<a id='comment:11'></a>Awesome, made those two edits. Thank you much.",
    "created_at": "2019-08-26T19:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397090",
    "user": "https://github.com/sheareralexj"
}
```

<a id='comment:11'></a>Awesome, made those two edits. Thank you much.



---

archive/issue_comments_397091.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-26T19:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397091",
    "user": "https://github.com/sheareralexj"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_397092.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-27T08:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397092",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_397093.json:
```json
{
    "body": "<a id='comment:12'></a>That's fine for me!\n\nA side note: It is usually not needed (nor advised) to merge new versions in a branch. As long as the merge automatically works\u00b9, it is fine. The history is simpler to read if there aren't several merges.\n\n\u00b9 This is showed by the color of the link to the branch in the description: Green is OK, red is NOT OK, orange means NOT TESTED and you just need to click the link for trac to try the merge (and change the color accordingly).",
    "created_at": "2019-08-27T08:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397093",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:12'></a>That's fine for me!

A side note: It is usually not needed (nor advised) to merge new versions in a branch. As long as the merge automatically works¹, it is fine. The history is simpler to read if there aren't several merges.

¹ This is showed by the color of the link to the branch in the description: Green is OK, red is NOT OK, orange means NOT TESTED and you just need to click the link for trac to try the merge (and change the color accordingly).



---

archive/issue_comments_397094.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-09-02T21:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28387#issuecomment-397094",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070973.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-09-02T21:40:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28387",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28387#event-70973"
}
```
