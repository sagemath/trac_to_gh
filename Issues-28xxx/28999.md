# Issue 28999: qepcad interface is broken with python3

archive/issues_028762.json:
```json
{
    "body": "qepcad interface is based on passing text strings. Since the switch to python3, some of these strings are in fact bytes objects, which break the interface:\n\n```\nsage: qepcad(x^2-x<0)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-1-5bf4e2d1f270> in <module>()\n----> 1 qepcad(x**Integer(2)-x<Integer(0))\n\n/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in qepcad(formula, assume, interact, solution, vars, **kwargs)\n   1639         qe.go()\n   1640         if solution is None:\n-> 1641             qe.finish()\n   1642             return qe.answer()\n   1643         elif solution == 'geometric':\n\n/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in __call__(self, *args)\n   1416                              \"interactive commands not handled\")\n   1417 \n-> 1418         return self._parent._function_call(self._name, args)\n   1419 \n   1420 \n\n/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _function_call(self, name, args)\n   1324         if pre_phase != post_phase:\n   1325             if post_phase == 'EXITED' and name != 'quit':\n-> 1326                 return self.answer()\n   1327             return AsciiArtString(\"QEPCAD object has moved to phase '%s'\"%post_phase)\n   1328 \n\n/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in answer(self)\n   1123             {'x + 1 = 0', 'x + 1 >= 0', 'x - 1 <= 0', 'x - 1 = 0', 'x = 0'}\n   1124         \"\"\"\n-> 1125         return AsciiArtString(self._parse_answer_stats()[0])\n   1126 \n   1127     def final_stats(self):\n\n/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _parse_answer_stats(self)\n   1091             raise ValueError(\"QEPCAD is not finished yet\")\n   1092         final = self._qex.expect().before\n-> 1093         match = re.search('\\nAn equivalent quantifier-free formula:(.*)\\n=+  The End  =+\\r\\n\\r\\n(.*)$', final, re.DOTALL)\n   1094 \n   1095         if match:\n\n/home/mmarco/sage/local/lib/python3.7/re.py in search(pattern, string, flags)\n    181     \"\"\"Scan through string looking for a match to the pattern, returning\n    182     a Match object, or None if no match was found.\"\"\"\n--> 183     return _compile(pattern, flags).search(string)\n    184 \n    185 def sub(pattern, repl, string, count=0, flags=0):\n\nTypeError: cannot use a string pattern on a bytes-like object\n```\n\n\nCC:  @jdemeyer @tscrim @fchapoton @embray\n\nKeywords: interfaces py3\n\nReviewer: Travis Scrimshaw, Erik Bray\n\nAuthor: Miguel Marco, Erik Bray\n\nBranch: 9847fad597ce2244c970c97efb4d7a336f618930\n\nCommit: 9847fad597ce2244c970c97efb4d7a336f618930\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28999\n\n",
    "closed_at": "2020-01-22T20:43:56Z",
    "created_at": "2020-01-13T10:17:15Z",
    "labels": [
        "component: packages: experimental",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "qepcad interface is broken with python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28999",
    "user": "https://github.com/miguelmarco"
}
```
qepcad interface is based on passing text strings. Since the switch to python3, some of these strings are in fact bytes objects, which break the interface:

```
sage: qepcad(x^2-x<0)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-5bf4e2d1f270> in <module>()
----> 1 qepcad(x**Integer(2)-x<Integer(0))

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in qepcad(formula, assume, interact, solution, vars, **kwargs)
   1639         qe.go()
   1640         if solution is None:
-> 1641             qe.finish()
   1642             return qe.answer()
   1643         elif solution == 'geometric':

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in __call__(self, *args)
   1416                              "interactive commands not handled")
   1417 
-> 1418         return self._parent._function_call(self._name, args)
   1419 
   1420 

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _function_call(self, name, args)
   1324         if pre_phase != post_phase:
   1325             if post_phase == 'EXITED' and name != 'quit':
-> 1326                 return self.answer()
   1327             return AsciiArtString("QEPCAD object has moved to phase '%s'"%post_phase)
   1328 

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in answer(self)
   1123             {'x + 1 = 0', 'x + 1 >= 0', 'x - 1 <= 0', 'x - 1 = 0', 'x = 0'}
   1124         """
-> 1125         return AsciiArtString(self._parse_answer_stats()[0])
   1126 
   1127     def final_stats(self):

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _parse_answer_stats(self)
   1091             raise ValueError("QEPCAD is not finished yet")
   1092         final = self._qex.expect().before
-> 1093         match = re.search('\nAn equivalent quantifier-free formula:(.*)\n=+  The End  =+\r\n\r\n(.*)$', final, re.DOTALL)
   1094 
   1095         if match:

/home/mmarco/sage/local/lib/python3.7/re.py in search(pattern, string, flags)
    181     """Scan through string looking for a match to the pattern, returning
    182     a Match object, or None if no match was found."""
--> 183     return _compile(pattern, flags).search(string)
    184 
    185 def sub(pattern, repl, string, count=0, flags=0):

TypeError: cannot use a string pattern on a bytes-like object
```


CC:  @jdemeyer @tscrim @fchapoton @embray

Keywords: interfaces py3

Reviewer: Travis Scrimshaw, Erik Bray

Author: Miguel Marco, Erik Bray

Branch: 9847fad597ce2244c970c97efb4d7a336f618930

Commit: 9847fad597ce2244c970c97efb4d7a336f618930

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28999





---

archive/issue_comments_405709.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-13T12:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405709",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405710.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2020-01-13T12:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405710",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_405711.json:
```json
{
    "body": "Changing keywords from \"\" to \"interfaces\".",
    "created_at": "2020-01-13T12:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405711",
    "user": "https://github.com/miguelmarco"
}
```

Changing keywords from "" to "interfaces".



---

archive/issue_comments_405712.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2020-01-13T16:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405712",
    "user": "https://github.com/tscrim"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_405713.json:
```json
{
    "body": "<a id='comment:5'></a>Did you also check this on Python2? If so, then you can set a positive review.",
    "created_at": "2020-01-13T16:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405713",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Did you also check this on Python2? If so, then you can set a positive review.



---

archive/issue_comments_405714.json:
```json
{
    "body": "<a id='comment:6'></a>If it doesn't work, you can try the `bytes_to_str` helper function. cc-ing Erik since he also knows a lot about making these work.",
    "created_at": "2020-01-13T16:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405714",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>If it doesn't work, you can try the `bytes_to_str` helper function. cc-ing Erik since he also knows a lot about making these work.



---

archive/issue_comments_405715.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 tscrim]:\n> Did you also check this on Python2? If so, then you can set a positive review.\n\n\nNo. I didn't. \n\nDo we need to ensure compaitibility with python2 now that we have made the switch to python3?",
    "created_at": "2020-01-13T18:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405715",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:7'></a>Replying to [comment:5 tscrim]:
> Did you also check this on Python2? If so, then you can set a positive review.


No. I didn't. 

Do we need to ensure compaitibility with python2 now that we have made the switch to python3?



---

archive/issue_comments_405716.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 mmarco]:\n> Replying to [comment:5 tscrim]:\n> > Did you also check this on Python2? If so, then you can set a positive review.\n\n> \n> No. I didn't. \n> \n> Do we need to ensure compaitibility with python2 now that we have made the switch to python3?\n\n\nWe are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...",
    "created_at": "2020-01-13T18:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405716",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>Replying to [comment:7 mmarco]:
> Replying to [comment:5 tscrim]:
> > Did you also check this on Python2? If so, then you can set a positive review.

> 
> No. I didn't. 
> 
> Do we need to ensure compaitibility with python2 now that we have made the switch to python3?


We are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...



---

archive/issue_comments_405717.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 tscrim]:\n> Replying to [comment:7 mmarco]:\n> > Replying to [comment:5 tscrim]:\n> > > Did you also check this on Python2? If so, then you can set a positive review.\n\n> > \n> > No. I didn't. \n> > \n> > Do we need to ensure compaitibility with python2 now that we have made the switch to python3?\n\n> \n> We are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...\n\n\nIIUC that question is still unresolved, but it would be best to try to preserve Python 2 compatibility for now, yes.",
    "created_at": "2020-01-14T11:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405717",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Replying to [comment:8 tscrim]:
> Replying to [comment:7 mmarco]:
> > Replying to [comment:5 tscrim]:
> > > Did you also check this on Python2? If so, then you can set a positive review.

> > 
> > No. I didn't. 
> > 
> > Do we need to ensure compaitibility with python2 now that we have made the switch to python3?

> 
> We are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...


IIUC that question is still unresolved, but it would be best to try to preserve Python 2 compatibility for now, yes.



---

archive/issue_comments_405718.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-14T11:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405718",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405719.json:
```json
{
    "body": "<a id='comment:11'></a>Anyways, as Travis says, it's better to go through the interface carefully and ensure that any place that reads bytes directly from pexpect runs `bytes_to_str` over them before passing them to code that is intended to operate on strings.\n\nI'm going to install qepcad and see if I can run the tests for it and what comes up...",
    "created_at": "2020-01-14T11:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405719",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Anyways, as Travis says, it's better to go through the interface carefully and ensure that any place that reads bytes directly from pexpect runs `bytes_to_str` over them before passing them to code that is intended to operate on strings.

I'm going to install qepcad and see if I can run the tests for it and what comes up...



---

archive/issue_comments_405720.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-14T13:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405720",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405721.json:
```json
{
    "body": "<a id='comment:13'></a>I think it would be clearer are more consistent with some of the other code to write this like:\n\n```\nfinal = bytes_to_str(self._qex.expect().before)\n```",
    "created_at": "2020-01-16T11:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405721",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I think it would be clearer are more consistent with some of the other code to write this like:

```
final = bytes_to_str(self._qex.expect().before)
```



---

archive/issue_comments_405722.json:
```json
{
    "body": "Changing keywords from \"interfaces\" to \"interfaces py3\".",
    "created_at": "2020-01-16T16:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405722",
    "user": "https://github.com/embray"
}
```

Changing keywords from "interfaces" to "interfaces py3".



---

archive/issue_comments_405723.json:
```json
{
    "body": "<a id='comment:14'></a>Here, try this--this fixes all the doctests for `sage.interfaces.qepcad` on Python 3.\n\n---\nNew commits:",
    "created_at": "2020-01-16T16:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405723",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Here, try this--this fixes all the doctests for `sage.interfaces.qepcad` on Python 3.

---
New commits:



---

archive/issue_comments_405724.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-16T16:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405724",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405725.json:
```json
{
    "body": "<a id='comment:15'></a>The last commit by embray works fine for me.\n\nAre you ok with a positive review?",
    "created_at": "2020-01-20T12:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405725",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:15'></a>The last commit by embray works fine for me.

Are you ok with a positive review?



---

archive/issue_comments_405726.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-20T13:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405726",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405727.json:
```json
{
    "body": "<a id='comment:16'></a>Yep, positive review.",
    "created_at": "2020-01-20T13:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405727",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Yep, positive review.



---

archive/issue_events_073444.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-22T20:43:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28999#event-73444"
}
```



---

archive/issue_comments_405728.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-22T20:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28999#issuecomment-405728",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
