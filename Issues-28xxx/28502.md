# Issue 28502: MR36: Use Sphinx hash function

archive/issues_028265.json:
```json
{
    "body": "https://gitlab.com/sagemath/sage/merge_requests/36:\n\n`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n\nThis is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n\nThere are several underlying problems it seems:\n\n* the hash function that Sphinx uses has changed, our code uses the wrong hash function\n* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?\n\nCC:  @slel @nthiery @embray @roed314 @videlec\n\nKeywords: docker, ci\n\nBranch/Commit: b37257c69a4924271047dd8e54c50e3ab1d4f8b7\n\nReviewer: John Palmieri\n\nAuthor: Julian R\u00fcth\n\nDependencies: #28041\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28502\n\n",
    "closed_at": "2019-11-07T23:30:12Z",
    "created_at": "2019-09-15T16:16:35Z",
    "labels": [
        "component: documentation",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "MR36: Use Sphinx hash function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28502",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```
https://gitlab.com/sagemath/sage/merge_requests/36:

`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.

This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.

There are several underlying problems it seems:

* the hash function that Sphinx uses has changed, our code uses the wrong hash function
* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?

CC:  @slel @nthiery @embray @roed314 @videlec

Keywords: docker, ci

Branch/Commit: b37257c69a4924271047dd8e54c50e3ab1d4f8b7

Reviewer: John Palmieri

Author: Julian Rüth

Dependencies: #28041

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28502





---

archive/issue_comments_424971.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to documentation.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424971",
    "user": "https://github.com/saraedum"
}
```

Changing component from PLEASE CHANGE to documentation.



---

archive/issue_comments_424972.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424972",
    "user": "https://github.com/saraedum"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_424973.json:
```json
{
    "body": "Description changed:\n```diff\n\n```\n",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424973",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff

```




---

archive/issue_comments_424974.json:
```json
{
    "body": "<a id='comment:1'></a>CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424974",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:1'></a>CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.



---

archive/issue_comments_424975.json:
```json
{
    "body": "<a id='comment:2'></a>Note that Sphinx's current hash function is\n\n```\ndef get_stable_hash(obj):\n    # type: (Any) -> unicode\n    \"\"\"\n    Return a stable hash for a Python data structure.  We can't just use\n    the md5 of str(obj) since for example dictionary items are enumerated\n    in unpredictable order due to hash randomization in newer Pythons.\n    \"\"\"\n    if isinstance(obj, dict):\n        return get_stable_hash(list(obj.items()))\n    elif isinstance(obj, (list, tuple)):\n        obj = sorted(get_stable_hash(o) for o in obj)\n    return md5(text_type(obj).encode('utf8')).hexdigest()\n```\n\nI assume it used to be just the last line at some point.",
    "created_at": "2019-09-15T16:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424975",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'></a>Note that Sphinx's current hash function is

```
def get_stable_hash(obj):
    # type: (Any) -> unicode
    """
    Return a stable hash for a Python data structure.  We can't just use
    the md5 of str(obj) since for example dictionary items are enumerated
    in unpredictable order due to hash randomization in newer Pythons.
    """
    if isinstance(obj, dict):
        return get_stable_hash(list(obj.items()))
    elif isinstance(obj, (list, tuple)):
        obj = sorted(get_stable_hash(o) for o in obj)
    return md5(text_type(obj).encode('utf8')).hexdigest()
```

I assume it used to be just the last line at some point.



---

archive/issue_comments_424976.json:
```json
{
    "body": "<a id='comment:3'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-15T16:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424976",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:3'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_424977.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+https://gitlab.com/sagemath/sage/merge_requests/36:\n \n+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n+\n+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n \n Author: Julian R\u00fcth\n \n```\n",
    "created_at": "2019-09-15T16:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424977",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
+https://gitlab.com/sagemath/sage/merge_requests/36:
 
+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.
+
+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.
 
 Author: Julian Rüth
 
```




---

archive/issue_comments_424978.json:
```json
{
    "body": "<a id='comment:5'></a>Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.",
    "created_at": "2019-09-15T17:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424978",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.



---

archive/issue_comments_424979.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-15T17:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424979",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_424980.json:
```json
{
    "body": "<a id='comment:6'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-15T17:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424980",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:6'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_424981.json:
```json
{
    "body": "<a id='comment:7'></a>New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:",
    "created_at": "2019-09-15T18:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424981",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:7'></a>New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:



---

archive/issue_comments_424982.json:
```json
{
    "body": "Changing keywords from \"\" to \"docker, ci\".",
    "created_at": "2019-09-15T19:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424982",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "" to "docker, ci".



---

archive/issue_comments_424983.json:
```json
{
    "body": "<a id='comment:9'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T00:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424983",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:9'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_424984.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+https://gitlab.com/sagemath/sage/merge_requests/36:\n \n+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n+\n+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n+\n+There are several underlying problems it seems:\n+\n+* the hash function that Sphinx uses has changed, our code uses the wrong hash function\n+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.\n \n Author: Julian R\u00fcth\n \n```\n",
    "created_at": "2019-09-16T00:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424984",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+https://gitlab.com/sagemath/sage/merge_requests/36:
 
+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.
+
+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.
+
+There are several underlying problems it seems:
+
+* the hash function that Sphinx uses has changed, our code uses the wrong hash function
+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.
 
 Author: Julian Rüth
 
```




---

archive/issue_comments_424985.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+https://gitlab.com/sagemath/sage/merge_requests/36:\n \n+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n+\n+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n+\n+There are several underlying problems it seems:\n+\n+* the hash function that Sphinx uses has changed, our code uses the wrong hash function\n+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?\n \n Author: Julian R\u00fcth\n \n```\n",
    "created_at": "2019-09-16T00:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424985",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+https://gitlab.com/sagemath/sage/merge_requests/36:
 
+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.
+
+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.
+
+There are several underlying problems it seems:
+
+* the hash function that Sphinx uses has changed, our code uses the wrong hash function
+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?
 
 Author: Julian Rüth
 
```




---

archive/issue_comments_424986.json:
```json
{
    "body": "<a id='comment:12'></a>New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:",
    "created_at": "2019-09-16T06:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424986",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:12'></a>New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:



---

archive/issue_comments_424987.json:
```json
{
    "body": "<a id='comment:13'></a>The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.",
    "created_at": "2019-09-16T06:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424987",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:13'></a>The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.



---

archive/issue_comments_424988.json:
```json
{
    "body": "<a id='comment:14'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T09:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424988",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:14'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_424989.json:
```json
{
    "body": "<a id='comment:15'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T10:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424989",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```

<a id='comment:15'></a>New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_424990.json:
```json
{
    "body": "<a id='comment:16'></a>Seems to work fine. There are no unnecessary rebuilds of documentation anymore.\n\nThe python 3 test-dev failed but that's an unrelated issue: #28507.",
    "created_at": "2019-09-16T12:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424990",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:16'></a>Seems to work fine. There are no unnecessary rebuilds of documentation anymore.

The python 3 test-dev failed but that's an unrelated issue: #28507.



---

archive/issue_comments_424991.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-16T12:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424991",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_424992.json:
```json
{
    "body": "<a id='comment:17'></a>Now that the dependency is in, this needs review :)\n\nAnd with this we should finally get working docker images automatically again.\n\nNote that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.",
    "created_at": "2019-10-05T16:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424992",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:17'></a>Now that the dependency is in, this needs review :)

And with this we should finally get working docker images automatically again.

Note that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.



---

archive/issue_comments_424993.json:
```json
{
    "body": "<a id='comment:18'></a>This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).",
    "created_at": "2019-10-29T18:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424993",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).



---

archive/issue_comments_424994.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-04T21:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424994",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_071482.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-05T22:09:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28502#event-71482"
}
```



---

archive/issue_comments_424995.json:
```json
{
    "body": "<a id='comment:21'></a>I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.",
    "created_at": "2019-11-06T12:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424995",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.



---

archive/issue_comments_424996.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-07T23:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28502#issuecomment-424996",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_071483.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:30:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28502",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28502#event-71483"
}
```
