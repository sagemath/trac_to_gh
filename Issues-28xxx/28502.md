# Issue 28502: MR36: Use Sphinx hash function

archive/issues_028265.json:
```json
{
    "assignees": [],
    "body": "https://gitlab.com/sagemath/sage/merge_requests/36:\n\n`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n\nThis is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n\nThere are several underlying problems it seems:\n\n* the hash function that Sphinx uses has changed, our code uses the wrong hash function\n* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?\n\nDepends on #28041\n\nCC:  @slel @nthiery @embray @roed314 @videlec\n\nComponent: **documentation**\n\nKeywords: **ci**\n\nAuthor: **Julian R\u00fcth**\n\nBranch/Commit: **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**\n\nReviewer: **John Palmieri**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28502_\n\n",
    "closed_at": "2019-11-07T23:30:12Z",
    "created_at": "2019-09-15T16:16:35Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20docker"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "MR36: Use Sphinx hash function",
    "type": "issue",
    "updated_at": "2019-11-07T23:30:12Z",
    "url": "https://github.com/sagemath/sage/issues/28502",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```
https://gitlab.com/sagemath/sage/merge_requests/36:

`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.

This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.

There are several underlying problems it seems:

* the hash function that Sphinx uses has changed, our code uses the wrong hash function
* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?

Depends on #28041

CC:  @slel @nthiery @embray @roed314 @videlec

Component: **documentation**

Keywords: **ci**

Author: **Julian Rüth**

Branch/Commit: **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**

Reviewer: **John Palmieri**

_Issue created by migration from https://trac.sagemath.org/ticket/28502_





---

archive/issue_events_388263.json:
```json
{
    "actor": "https://github.com/sagetrac-gitlab-bot",
    "created_at": "2019-09-15T16:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388263"
}
```



---

archive/issue_events_388264.json:
```json
{
    "actor": "https://github.com/sagetrac-gitlab-bot",
    "created_at": "2019-09-15T16:16:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388264"
}
```



---

archive/issue_events_388265.json:
```json
{
    "actor": "https://github.com/sagetrac-gitlab-bot",
    "created_at": "2019-09-15T16:16:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388265"
}
```



---

archive/issue_events_388266.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T16:19:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388266"
}
```



---

archive/issue_events_388267.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T16:19:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388267"
}
```



---

archive/issue_comments_444228.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2019-09-15T16:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444228",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_444229.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nCCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.",
    "created_at": "2019-09-15T16:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444229",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:1" align="right">comment:1</div>

CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.



---

archive/issue_comments_444230.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNote that Sphinx's current hash function is\n\n```\ndef get_stable_hash(obj):\n    # type: (Any) -> unicode\n    \"\"\"\n    Return a stable hash for a Python data structure.  We can't just use\n    the md5 of str(obj) since for example dictionary items are enumerated\n    in unpredictable order due to hash randomization in newer Pythons.\n    \"\"\"\n    if isinstance(obj, dict):\n        return get_stable_hash(list(obj.items()))\n    elif isinstance(obj, (list, tuple)):\n        obj = sorted(get_stable_hash(o) for o in obj)\n    return md5(text_type(obj).encode('utf8')).hexdigest()\n```\n\nI assume it used to be just the last line at some point.",
    "created_at": "2019-09-15T16:20:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444230",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:2" align="right">comment:2</div>

Note that Sphinx's current hash function is

```
def get_stable_hash(obj):
    # type: (Any) -> unicode
    """
    Return a stable hash for a Python data structure.  We can't just use
    the md5 of str(obj) since for example dictionary items are enumerated
    in unpredictable order due to hash randomization in newer Pythons.
    """
    if isinstance(obj, dict):
        return get_stable_hash(list(obj.items()))
    elif isinstance(obj, (list, tuple)):
        obj = sorted(get_stable_hash(o) for o in obj)
    return md5(text_type(obj).encode('utf8')).hexdigest()
```

I assume it used to be just the last line at some point.



---

archive/issue_comments_444231.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450\"><code>d3a8d31</code></a></td><td><code>Do not sort explicitly</code></td></tr></table>\n",
    "created_at": "2019-09-15T16:22:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444231",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:3" align="right">comment:3</div>

New commits added to merge request.  I updated the commit SHA-1.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450"><code>d3a8d31</code></a></td><td><code>Do not sort explicitly</code></td></tr></table>




---

archive/issue_comments_444232.json:
```json
{
    "body": "Changed commit from **[`6be239c`](https://github.com/sagemath/sagetrac-mirror/commit/6be239c8950800ab79b0d06514b602c14f69ccfb)** to **[`d3a8d31`](https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450)**",
    "created_at": "2019-09-15T16:22:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444232",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`6be239c`](https://github.com/sagemath/sagetrac-mirror/commit/6be239c8950800ab79b0d06514b602c14f69ccfb)** to **[`d3a8d31`](https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450)**



---

archive/issue_comments_444233.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,13 +1,5 @@\n-Julian R\u00fcth ([@saraedum](https://gitlab.com/saraedum)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/36:\n+https://gitlab.com/sagemath/sage/merge_requests/36:\n \n----\n+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n \n-```markdown\n-otherwise lots of doc rebuilds (this is a huge problem with building\n-docker images.)\n-```\n-\n-\n-\n-\n-\n+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n``````\n",
    "created_at": "2019-09-15T16:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444233",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,13 +1,5 @@
-Julian Rüth ([@saraedum](https://gitlab.com/saraedum)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/36:
+https://gitlab.com/sagemath/sage/merge_requests/36:
 
----
+`make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.
 
-```markdown
-otherwise lots of doc rebuilds (this is a huge problem with building
-docker images.)
-```
-
-
-
-
-
+This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.
``````




---

archive/issue_comments_444234.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nUnfortunately, this is not the only problem. Docs are still rebuilding during docker builds.",
    "created_at": "2019-09-15T17:11:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444234",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:5" align="right">comment:5</div>

Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.



---

archive/issue_events_388268.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T17:11:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388268"
}
```



---

archive/issue_events_388269.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T17:11:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388269"
}
```



---

archive/issue_comments_444235.json:
```json
{
    "body": "Changed commit from **[`d3a8d31`](https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450)** to **[`3aff80e`](https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374)**",
    "created_at": "2019-09-15T17:20:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444235",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`d3a8d31`](https://github.com/sagemath/sagetrac-mirror/commit/d3a8d31f5c79c4d720ea97bf085351cb41a40450)** to **[`3aff80e`](https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374)**



---

archive/issue_comments_444236.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374\"><code>3aff80e</code></a></td><td><code>add debug info</code></td></tr></table>\n",
    "created_at": "2019-09-15T17:20:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444236",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:6" align="right">comment:6</div>

New commits added to merge request.  I updated the commit SHA-1.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374"><code>3aff80e</code></a></td><td><code>add debug info</code></td></tr></table>




---

archive/issue_comments_444237.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9\"><code>8acd277</code></a></td><td><code>Use upstream BuildInfo instead of rolling our own</code></td></tr></table>\n",
    "created_at": "2019-09-15T18:58:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444237",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:7" align="right">comment:7</div>

New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9"><code>8acd277</code></a></td><td><code>Use upstream BuildInfo instead of rolling our own</code></td></tr></table>




---

archive/issue_comments_444238.json:
```json
{
    "body": "Changed commit from **[`3aff80e`](https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374)** to **[`8acd277`](https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9)**",
    "created_at": "2019-09-15T18:58:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444238",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`3aff80e`](https://github.com/sagemath/sagetrac-mirror/commit/3aff80ee4e13fabbab944761ae99ea9b22f35374)** to **[`8acd277`](https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9)**



---

archive/issue_comments_444239.json:
```json
{
    "body": "Changed keywords from none to **ci**",
    "created_at": "2019-09-15T19:40:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444239",
    "user": "https://github.com/saraedum"
}
```

Changed keywords from none to **ci**



---

archive/issue_events_388270.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T19:40:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20docker",
    "label_color": "0000b0",
    "label_name": "c: docker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388270"
}
```



---

archive/issue_comments_444240.json:
```json
{
    "body": "Changed commit from **[`8acd277`](https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9)** to **[`15a267a`](https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad)**",
    "created_at": "2019-09-16T00:49:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444240",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`8acd277`](https://github.com/sagemath/sagetrac-mirror/commit/8acd2774d842f2c20777f248df68b842f8ba15b9)** to **[`15a267a`](https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad)**



---

archive/issue_comments_444241.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad\"><code>15a267a</code></a></td><td><code>Do not depend on .pyc files</code></td></tr></table>\n",
    "created_at": "2019-09-16T00:49:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444241",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:9" align="right">comment:9</div>

New commits added to merge request.  I updated the commit SHA-1.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad"><code>15a267a</code></a></td><td><code>Do not depend on .pyc files</code></td></tr></table>




---

archive/issue_comments_444242.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,3 +3,9 @@\n `make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.\n \n This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.\n+\n+There are several underlying problems it seems:\n+\n+* the hash function that Sphinx uses has changed, our code uses the wrong hash function\n+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.\n``````\n",
    "created_at": "2019-09-16T00:51:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444242",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,3 +3,9 @@
 `make doc` rebuilds lots of things every time. Just run `make doc` twice to see how this is broken currently.
 
 This is a major problem with our docker builds. Their test-dev stage times out all the time because of this.
+
+There are several underlying problems it seems:
+
+* the hash function that Sphinx uses has changed, our code uses the wrong hash function
+* rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.
``````




---

archive/issue_comments_444243.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,4 +8,4 @@\n \n * the hash function that Sphinx uses has changed, our code uses the wrong hash function\n * rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)\n-* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.\n+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?\n``````\n",
    "created_at": "2019-09-16T00:53:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444243",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,4 +8,4 @@
 
 * the hash function that Sphinx uses has changed, our code uses the wrong hash function
 * rebuilds depend on the mtime of .pyc files not on the actual .py files. (this is a problem with the docker builds.)
-* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. I have no clue what's going on here.
+* often config changes are detected because the `ipython_rgxout` has changed in the configuration. This is a `_sre.SRE_Pattern`. Maybe the pickle is somehow platform dependent which makes this breaks when the docker image is pulled on a different platform?
``````




---

archive/issue_comments_444244.json:
```json
{
    "body": "Changed commit from **[`15a267a`](https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad)** to **[`3847a64`](https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec)**",
    "created_at": "2019-09-16T06:19:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444244",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`15a267a`](https://github.com/sagemath/sagetrac-mirror/commit/15a267ae12b69fad05550bcb9e3e49f3037001ad)** to **[`3847a64`](https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec)**



---

archive/issue_comments_444245.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a229ffcedaf9d27fb7389d6612a65e58ead938e3\"><code>a229ffc</code></a></td><td><code>Undo docker changes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/22da0878d4de129b13b4847c4090808601d9b27a\"><code>22da087</code></a></td><td><code>do not remove config.status from dev image</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c3d9c146ae520ed9198835bc3c100428f9a9b26a\"><code>c3d9c14</code></a></td><td><code>Keep misc-clean around longer in Makefile</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54319874059f41512b6e812f020aed93eb7d0c0e\"><code>5431987</code></a></td><td><code>Merge remote-tracking branch 'trac/develop' into 28041</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/45268e7aef055f0c180d45235f636b1683091532\"><code>45268e7</code></a></td><td><code>fix grammar</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a9dd58910e1b04f1e21ae23673022592513b3b8\"><code>9a9dd58</code></a></td><td><code>Merge remote-tracking branch 'trac/develop' into 28041</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89c78f8b903f225a5f2b18cc41adc245c9326964\"><code>89c78f8</code></a></td><td><code>Cleanup py-3 script</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d02785aa8dca73ba9d19f9fc486d5bed8c6200a\"><code>1d02785</code></a></td><td><code>Add a test-hook for build-from-clean</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ca243324e4d9706a0c189193beebec09eed33a2b\"><code>ca24332</code></a></td><td><code>Do not run build-from-latest for explicit builds</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec\"><code>3847a64</code></a></td><td><code>Merge remote-tracking branch 'trac/u/saraedum/28041' into stable-hash</code></td></tr></table>\n",
    "created_at": "2019-09-16T06:19:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444245",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:12" align="right">comment:12</div>

New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a229ffcedaf9d27fb7389d6612a65e58ead938e3"><code>a229ffc</code></a></td><td><code>Undo docker changes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/22da0878d4de129b13b4847c4090808601d9b27a"><code>22da087</code></a></td><td><code>do not remove config.status from dev image</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c3d9c146ae520ed9198835bc3c100428f9a9b26a"><code>c3d9c14</code></a></td><td><code>Keep misc-clean around longer in Makefile</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54319874059f41512b6e812f020aed93eb7d0c0e"><code>5431987</code></a></td><td><code>Merge remote-tracking branch 'trac/develop' into 28041</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/45268e7aef055f0c180d45235f636b1683091532"><code>45268e7</code></a></td><td><code>fix grammar</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a9dd58910e1b04f1e21ae23673022592513b3b8"><code>9a9dd58</code></a></td><td><code>Merge remote-tracking branch 'trac/develop' into 28041</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89c78f8b903f225a5f2b18cc41adc245c9326964"><code>89c78f8</code></a></td><td><code>Cleanup py-3 script</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d02785aa8dca73ba9d19f9fc486d5bed8c6200a"><code>1d02785</code></a></td><td><code>Add a test-hook for build-from-clean</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ca243324e4d9706a0c189193beebec09eed33a2b"><code>ca24332</code></a></td><td><code>Do not run build-from-latest for explicit builds</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec"><code>3847a64</code></a></td><td><code>Merge remote-tracking branch 'trac/u/saraedum/28041' into stable-hash</code></td></tr></table>




---

archive/issue_comments_444246.json:
```json
{
    "body": "Dependencies: **#28041**",
    "created_at": "2019-09-16T06:23:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444246",
    "user": "https://github.com/saraedum"
}
```

Dependencies: **#28041**



---

archive/issue_comments_444247.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.",
    "created_at": "2019-09-16T06:23:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444247",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:13" align="right">comment:13</div>

The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.



---

archive/issue_comments_444248.json:
```json
{
    "body": "Changed commit from **[`3847a64`](https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec)** to **[`ce1cb69`](https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5)**",
    "created_at": "2019-09-16T09:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444248",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`3847a64`](https://github.com/sagemath/sagetrac-mirror/commit/3847a6453d111838a1f0e5be51ca41014a6f3bec)** to **[`ce1cb69`](https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5)**



---

archive/issue_comments_444249.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34749893e2c6591b034cd9f7869e0aee8062f7a2\"><code>3474989</code></a></td><td><code>Protect workaround so we do not drop it easily in future upgrades</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5\"><code>ce1cb69</code></a></td><td><code>Debugging why the docbuild is not more parallel</code></td></tr></table>\n",
    "created_at": "2019-09-16T09:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444249",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:14" align="right">comment:14</div>

New commits added to merge request.  I updated the commit SHA-1.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34749893e2c6591b034cd9f7869e0aee8062f7a2"><code>3474989</code></a></td><td><code>Protect workaround so we do not drop it easily in future upgrades</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5"><code>ce1cb69</code></a></td><td><code>Debugging why the docbuild is not more parallel</code></td></tr></table>




---

archive/issue_comments_444250.json:
```json
{
    "body": "Changed commit from **[`ce1cb69`](https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5)** to **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**",
    "created_at": "2019-09-16T10:31:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444250",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

Changed commit from **[`ce1cb69`](https://github.com/sagemath/sagetrac-mirror/commit/ce1cb69a8e1cd73372be7cfb991d19d980b257a5)** to **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**



---

archive/issue_comments_444251.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nNew commits added to merge request.  I updated the commit SHA-1.  New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3edf62003ecff0bd2b74872e47b8b33a316cbe26\"><code>3edf620</code></a></td><td><code>Restore pass on exception</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f545047a320fe4c94bdc738f47e4451a871513fb\"><code>f545047</code></a></td><td><code>Revert \"Debugging why the docbuild is not more parallel\"</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7\"><code>b37257c</code></a></td><td><code>Parts of the docbuild are not parallel</code></td></tr></table>\n",
    "created_at": "2019-09-16T10:31:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444251",
    "user": "https://github.com/sagetrac-gitlab-bot"
}
```

<div id="comment:15" align="right">comment:15</div>

New commits added to merge request.  I updated the commit SHA-1.  New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3edf62003ecff0bd2b74872e47b8b33a316cbe26"><code>3edf620</code></a></td><td><code>Restore pass on exception</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f545047a320fe4c94bdc738f47e4451a871513fb"><code>f545047</code></a></td><td><code>Revert "Debugging why the docbuild is not more parallel"</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7"><code>b37257c</code></a></td><td><code>Parts of the docbuild are not parallel</code></td></tr></table>




---

archive/issue_comments_444252.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nSeems to work fine. There are no unnecessary rebuilds of documentation anymore.\n\nThe python 3 test-dev failed but that's an unrelated issue: #28507.",
    "created_at": "2019-09-16T12:32:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444252",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:16" align="right">comment:16</div>

Seems to work fine. There are no unnecessary rebuilds of documentation anymore.

The python 3 test-dev failed but that's an unrelated issue: #28507.



---

archive/issue_events_388271.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-16T12:32:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388271"
}
```



---

archive/issue_events_388272.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-16T12:32:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388272"
}
```



---

archive/issue_comments_444253.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nNow that the dependency is in, this needs review :)\n\nAnd with this we should finally get working docker images automatically again.\n\nNote that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.",
    "created_at": "2019-10-05T16:06:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444253",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:17" align="right">comment:17</div>

Now that the dependency is in, this needs review :)

And with this we should finally get working docker images automatically again.

Note that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.



---

archive/issue_comments_444254.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThis seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).",
    "created_at": "2019-10-29T18:17:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444254",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).



---

archive/issue_comments_444255.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2019-11-04T21:15:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444255",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_388273.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-11-04T21:15:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388273"
}
```



---

archive/issue_events_388274.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-11-04T21:15:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388274"
}
```



---

archive/issue_events_388275.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-05T22:09:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388275"
}
```



---

archive/issue_events_388276.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-11-05T22:09:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388276"
}
```



---

archive/issue_comments_444256.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.",
    "created_at": "2019-11-06T12:44:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444256",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.



---

archive/issue_comments_444257.json:
```json
{
    "body": "Changed branch from **[u/galois/mrs/36/stable-hash](https://github.com/sagemath/sagetrac-mirror/tree/u/galois/mrs/36/stable-hash)** to **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**",
    "created_at": "2019-11-07T23:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28502#issuecomment-444257",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/galois/mrs/36/stable-hash](https://github.com/sagemath/sagetrac-mirror/tree/u/galois/mrs/36/stable-hash)** to **[`b37257c`](https://github.com/sagemath/sagetrac-mirror/commit/b37257c69a4924271047dd8e54c50e3ab1d4f8b7)**



---

archive/issue_events_388277.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-07T23:30:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388277"
}
```



---

archive/issue_events_388278.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0976a5cf93f3abb071b61eec62a23a2e91b1f888",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-11-07T23:30:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28502",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28502#event-388278"
}
```
