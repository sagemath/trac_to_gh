# Issue 28909: Allow overriding "when building, check that user isn't root" for use in Docker containers with configure --enable-build-as-root

archive/issues_028672.json:
```json
{
    "body": "#17420 added `AX_CHECK_ROOT`, which refuses to configure a sage build as root, as a safety measure protecting users from getting themselves into trouble with `sudo make`.\n\nOn containers, however, building as root is quite natural. We provide an option ``--enable-build-as-root``. (Then we fix all related build system bugs that stop this from working)\nThis would allow us to simplify `docker/Dockerfile`, which currently works around it: \n\n```\n# Sage refuses to build as root, so we add a \"sage\" user that can sudo without a password.\n# We also want this user at runtime as some commands in sage know about the user that was used during build.\nARG HOME=/home/sage\nRUN adduser --quiet --shell /bin/bash --gecos \"Sage user,101,,\" --disabled-password --home \"$HOME\" sage \\\n    && echo \"sage ALL=(ALL) NOPASSWD:ALL\" >> /etc/sudoers.d/01-sage \\\n    && chmod 0440 /etc/sudoers.d/01-sage\n# Run everything from now on as the sage user in sage's home\nUSER sage\nENV HOME $HOME\n```\nFor example, GitHub Actions do not like Docker containers that make use of the `USER` command:  https://help.github.com/en/actions/automating-your-workflow-with-github-actions/virtual-environments-for-github-hosted-runners#docker-container-filesystem\n\n\nReported build failures as root user:\n- https://groups.google.com/forum/#!searchin/sage-devel/17420%7Csort:date/sage-devel/kBMh22r1E90/LdZkK2JMoMIJ\n\n\nCC:  @kiwifb @jhpalmieri @dimpase @vbraun @jdemeyer @saraedum\n\nBranch/Commit: 6b5f27ad21b7e68ce440a80f36bc1abb3e5f7ae3\n\nReviewer: Volker Braun\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28909\n\n",
    "closed_at": "2020-01-09T23:44:25Z",
    "created_at": "2019-12-25T20:49:51Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Allow overriding \"when building, check that user isn't root\" for use in Docker containers with configure --enable-build-as-root",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28909",
    "user": "https://github.com/mkoeppe"
}
```
#17420 added `AX_CHECK_ROOT`, which refuses to configure a sage build as root, as a safety measure protecting users from getting themselves into trouble with `sudo make`.

On containers, however, building as root is quite natural. We provide an option ``--enable-build-as-root``. (Then we fix all related build system bugs that stop this from working)
This would allow us to simplify `docker/Dockerfile`, which currently works around it: 

```
# Sage refuses to build as root, so we add a "sage" user that can sudo without a password.
# We also want this user at runtime as some commands in sage know about the user that was used during build.
ARG HOME=/home/sage
RUN adduser --quiet --shell /bin/bash --gecos "Sage user,101,," --disabled-password --home "$HOME" sage \
    && echo "sage ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/01-sage \
    && chmod 0440 /etc/sudoers.d/01-sage
# Run everything from now on as the sage user in sage's home
USER sage
ENV HOME $HOME
```
For example, GitHub Actions do not like Docker containers that make use of the `USER` command:  https://help.github.com/en/actions/automating-your-workflow-with-github-actions/virtual-environments-for-github-hosted-runners#docker-container-filesystem


Reported build failures as root user:
- https://groups.google.com/forum/#!searchin/sage-devel/17420%7Csort:date/sage-devel/kBMh22r1E90/LdZkK2JMoMIJ


CC:  @kiwifb @jhpalmieri @dimpase @vbraun @jdemeyer @saraedum

Branch/Commit: 6b5f27ad21b7e68ce440a80f36bc1abb3e5f7ae3

Reviewer: Volker Braun

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28909





---

archive/issue_comments_431100.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n #17420 added \\`AX_CHECK_ROOT\\`, which refuses to configure a sage build as root, as a safety measure protecting users from getting themselves into trouble with \\`sudo make\\`.\n \n-On containers, however, building as root is quite natural, and we should provide an option \\`\\`--enable-user-0\\`\\` (and fix all related build system bugs...)\n+On containers, however, building as root is quite natural. We provide an option \\`\\`--enable-build-as-root\\`\\`. (Then we fix all related build system bugs that stop this from working)\n This would allow us to simplify \\`docker/Dockerfile\\`, which currently works around it: \n \n \\`\\`\\`\n@@ -20,6 +20,7 @@\n Reported build failures as root user:\n - https://groups.google.com/forum/#!searchin/sage-devel/17420%7Csort:date/sage-devel/kBMh22r1E90/LdZkK2JMoMIJ\n \n+\n Comment: 1\n \n Summary: Allow overriding \"when building, check that user isn't root\" for use in Docker containers\n```\n",
    "created_at": "2019-12-26T17:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431100",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,6 @@
 #17420 added \`AX_CHECK_ROOT\`, which refuses to configure a sage build as root, as a safety measure protecting users from getting themselves into trouble with \`sudo make\`.
 
-On containers, however, building as root is quite natural, and we should provide an option \`\`--enable-user-0\`\` (and fix all related build system bugs...)
+On containers, however, building as root is quite natural. We provide an option \`\`--enable-build-as-root\`\`. (Then we fix all related build system bugs that stop this from working)
 This would allow us to simplify \`docker/Dockerfile\`, which currently works around it: 
 
 \`\`\`
@@ -20,6 +20,7 @@
 Reported build failures as root user:
 - https://groups.google.com/forum/#!searchin/sage-devel/17420%7Csort:date/sage-devel/kBMh22r1E90/LdZkK2JMoMIJ
 
+
 Comment: 1
 
 Summary: Allow overriding "when building, check that user isn't root" for use in Docker containers
```




---

archive/issue_comments_431101.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-26T17:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431101",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_431102.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-12-26T17:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431102",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_431103.json:
```json
{
    "body": "<a id='comment:4'></a>Is there some other way we can work around the [GitHub](GitHub) Actions problem? Afaik it's considered bad (though common) practice to run processes inside containers as root.",
    "created_at": "2019-12-26T17:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431103",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>Is there some other way we can work around the [GitHub](GitHub) Actions problem? Afaik it's considered bad (though common) practice to run processes inside containers as root.



---

archive/issue_comments_431104.json:
```json
{
    "body": "<a id='comment:5'></a>Bad but common practice nicely sums up the current state of affairs...",
    "created_at": "2019-12-26T21:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431104",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Bad but common practice nicely sums up the current state of affairs...



---

archive/issue_events_073151.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-12-27T04:29:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28909#event-73151"
}
```



---

archive/issue_comments_431105.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-27T09:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431105",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_431106.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.\n\n~~What's the situation with [GitHub](GitHub) Actions exactly? They ignore `USER` or they do not allow it at all? If they just ignore it, can we `su` to `sage` in our entrypoint if we happen to be root?~~\n\nSo, problem seems to be that `GITHUB_WORKSPACE` is owned by `root`. If you are not root you do not get access to that. I don't know enough about [GitHub](GitHub) Actions but it seems that their interface is very limited, so you don't get to change the `USER`. (And you also don't get to run an initialization container that could `chmod` the workspace.)",
    "created_at": "2019-12-28T15:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431106",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:8'></a>Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.

~~What's the situation with [GitHub](GitHub) Actions exactly? They ignore `USER` or they do not allow it at all? If they just ignore it, can we `su` to `sage` in our entrypoint if we happen to be root?~~

So, problem seems to be that `GITHUB_WORKSPACE` is owned by `root`. If you are not root you do not get access to that. I don't know enough about [GitHub](GitHub) Actions but it seems that their interface is very limited, so you don't get to change the `USER`. (And you also don't get to run an initialization container that could `chmod` the workspace.)



---

archive/issue_comments_431107.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 saraedum]:\n> Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.\n\n\nI think in this discussion, one should distinguish building sage from running sage:\n- I think building sage as root in the container is unproblematic.\n- A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... \n- There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)",
    "created_at": "2019-12-28T16:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431107",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:8 saraedum]:
> Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.


I think in this discussion, one should distinguish building sage from running sage:
- I think building sage as root in the container is unproblematic.
- A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... 
- There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)



---

archive/issue_comments_431108.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 mkoeppe]:\n> Replying to [comment:8 saraedum]:\n> I think in this discussion, one should distinguish building sage from running sage:\n\nTrue.\n\n> - I think building sage as root in the container is unproblematic.\n\n\nYes, but it probably does not win you much.\n\n> - A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... \n\n\nSome people want to be able to pip install things for example. For this it makes sense to own the Sage installation. (without being root.)\n\n> - There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)\n\n\nI agree but having a separate image comes at a significant maintenance cost.",
    "created_at": "2019-12-28T17:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431108",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:10'></a>Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 saraedum]:
> I think in this discussion, one should distinguish building sage from running sage:

True.

> - I think building sage as root in the container is unproblematic.


Yes, but it probably does not win you much.

> - A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... 


Some people want to be able to pip install things for example. For this it makes sense to own the Sage installation. (without being root.)

> - There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)


I agree but having a separate image comes at a significant maintenance cost.



---

archive/issue_comments_431109.json:
```json
{
    "body": "<a id='comment:11'></a>What is the intended meaning of positive review for a sage-wishlist ticket ?",
    "created_at": "2020-01-01T21:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431109",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>What is the intended meaning of positive review for a sage-wishlist ticket ?



---

archive/issue_comments_431110.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 chapoton]:\n> What is the intended meaning of positive review for a sage-wishlist ticket ?\n\nI think it means \"wish granted\".",
    "created_at": "2020-01-02T14:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431110",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Replying to [comment:11 chapoton]:
> What is the intended meaning of positive review for a sage-wishlist ticket ?

I think it means "wish granted".



---

archive/issue_events_073152.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-02T14:56:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28909#event-73152"
}
```



---

archive/issue_events_073153.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-02T14:56:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28909#event-73153"
}
```



---

archive/issue_comments_431111.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-09T23:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28909#issuecomment-431111",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073154.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-09T23:44:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28909",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28909#event-73154"
}
```
