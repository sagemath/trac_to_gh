# Issue 28225: Allow sage to run in the absence of sage-env

archive/issues_027988.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nThe sage-env script has never been particularly useful in distributions, and has actually been more of a nuisance: it needs to be heavily patched or even replaced with a custom one. \n\nAfter #25786 (which removes SAGE_DOC_SRC usage at runtime) the only use for it that I can think of is setting DOT_SAGE. This patch allows to completely do away with this script, by setting a fallback for DOT_SAGE in the sage executable.\n\nDepends on #25786\n\nCC:  @saraedum @isuruf @kiwifb @timokau\n\nComponent: **distribution**\n\nAuthor: **Antonio Rojas**\n\nBranch/Commit: **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env) @ [`83a6cec`](https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac)**\n\nReviewer: **Fran\u00e7ois Bissey**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28225_\n\n",
    "closed_at": "2019-08-03T23:51:18Z",
    "created_at": "2019-07-21T10:20:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20distribution",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Allow sage to run in the absence of sage-env",
    "type": "issue",
    "updated_at": "2020-01-17T20:28:46Z",
    "url": "https://github.com/sagemath/sage/issues/28225",
    "user": "https://github.com/antonio-rojas"
}
```
<div id="comment:0"></div>

The sage-env script has never been particularly useful in distributions, and has actually been more of a nuisance: it needs to be heavily patched or even replaced with a custom one. 

After #25786 (which removes SAGE_DOC_SRC usage at runtime) the only use for it that I can think of is setting DOT_SAGE. This patch allows to completely do away with this script, by setting a fallback for DOT_SAGE in the sage executable.

Depends on #25786

CC:  @saraedum @isuruf @kiwifb @timokau

Component: **distribution**

Author: **Antonio Rojas**

Branch/Commit: **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env) @ [`83a6cec`](https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac)**

Reviewer: **Fran√ßois Bissey**

_Issue created by migration from https://trac.sagemath.org/ticket/28225_





---

archive/issue_events_384206.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-21T10:20:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384206"
}
```



---

archive/issue_events_384207.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-21T10:20:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384207"
}
```



---

archive/issue_comments_439583.json:
```json
{
    "body": "Branch: **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)**",
    "created_at": "2019-07-21T10:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439583",
    "user": "https://github.com/antonio-rojas"
}
```

Branch: **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)**



---

archive/issue_comments_439584.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394\"><code>dda6986</code></a></td><td><code>Allow sage to run if sage-env is not present</code></td></tr></table>\n",
    "created_at": "2019-07-21T10:23:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439584",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394"><code>dda6986</code></a></td><td><code>Allow sage to run if sage-env is not present</code></td></tr></table>




---

archive/issue_comments_439585.json:
```json
{
    "body": "Commit: **[`dda6986`](https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394)**",
    "created_at": "2019-07-21T10:23:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439585",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`dda6986`](https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394)**



---

archive/issue_events_384208.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-21T10:30:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20distribution",
    "label_color": "0000b0",
    "label_name": "c: distribution",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384208"
}
```



---

archive/issue_comments_439586.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n+The sage-env script has never been particularly useful in distributions, and has actually been more of a nuisance: it needs to be heavily patched or even replaced with a custom one. \n \n+After #25786 (which removes SAGE_DOC_SRC usage at runtime) the only use for it that I can think of is setting DOT_SAGE. This patch allows to completely do away with this script, by setting a fallback for DOT_SAGE in the sage executable.\n``````\n",
    "created_at": "2019-07-21T10:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439586",
    "user": "https://github.com/antonio-rojas"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
+The sage-env script has never been particularly useful in distributions, and has actually been more of a nuisance: it needs to be heavily patched or even replaced with a custom one. 
 
+After #25786 (which removes SAGE_DOC_SRC usage at runtime) the only use for it that I can think of is setting DOT_SAGE. This patch allows to completely do away with this script, by setting a fallback for DOT_SAGE in the sage executable.
``````




---

archive/issue_comments_439587.json:
```json
{
    "body": "Dependencies: **#25786**",
    "created_at": "2019-07-21T10:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439587",
    "user": "https://github.com/antonio-rojas"
}
```

Dependencies: **#25786**



---

archive/issue_comments_439588.json:
```json
{
    "body": "Author: **Antonio Rojas**",
    "created_at": "2019-07-21T10:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439588",
    "user": "https://github.com/antonio-rojas"
}
```

Author: **Antonio Rojas**



---

archive/issue_events_384209.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-21T10:33:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384209"
}
```



---

archive/issue_comments_439589.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI have been `sage-env` free for a few releases now in sage-on-gentoo. I ship my own sage script now, but the change I see in the commit are good. I think you should also fix `sage-cython` https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-8.1-sage-cython.patch which won't work with stuff from the environment. I also have this patch for various scripts https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-bin-8.7.patch\n\nI also have \n\n```\n# Replace SAGE_EXTCODE with the installation location\n\tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n\t\tbin/sage-ipynb2rst \\\n\t\tbin/sage-valgrind\n```\nwhich may be harder to replace more generally.\n\nI haven't made any fix to runtests, but `DOT_SAGE` should definitely be set - for some exotic usage with valgrind and other tools.",
    "created_at": "2019-07-21T11:07:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439589",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:5" align="right">comment:5</div>

I have been `sage-env` free for a few releases now in sage-on-gentoo. I ship my own sage script now, but the change I see in the commit are good. I think you should also fix `sage-cython` https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-8.1-sage-cython.patch which won't work with stuff from the environment. I also have this patch for various scripts https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-bin-8.7.patch

I also have 

```
# Replace SAGE_EXTCODE with the installation location
	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
		bin/sage-ipynb2rst \
		bin/sage-valgrind
```
which may be harder to replace more generally.

I haven't made any fix to runtests, but `DOT_SAGE` should definitely be set - for some exotic usage with valgrind and other tools.



---

archive/issue_comments_439590.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThanks. Most of these work fine here just because /bin symlinked to /usr/bin, but that certainly shouldn't be assumed",
    "created_at": "2019-07-21T11:16:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439590",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:6" align="right">comment:6</div>

Thanks. Most of these work fine here just because /bin symlinked to /usr/bin, but that certainly shouldn't be assumed



---

archive/issue_comments_439591.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nYes, I hadn't thought of that scenario at all, where the variable being undefined is actually helpful. But it will break on other system. But that doesn't help with `sage-cython`.",
    "created_at": "2019-07-21T11:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439591",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

Yes, I hadn't thought of that scenario at all, where the variable being undefined is actually helpful. But it will break on other system. But that doesn't help with `sage-cython`.



---

archive/issue_comments_439592.json:
```json
{
    "body": "Changed commit from **[`dda6986`](https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394)** to **[`6d049b1`](https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e)**",
    "created_at": "2019-07-21T11:43:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439592",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`dda6986`](https://github.com/sagemath/sagetrac-mirror/commit/dda6986e1a3b4c3d06150475d75a207c1e133394)** to **[`6d049b1`](https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e)**



---

archive/issue_comments_439593.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e59156b09f7b7c1c44e6726fe3d24ffad224a187\"><code>e59156b</code></a></td><td><code>Fix sage-cython when sage-env is not available</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a52972e293045854ac9996eb261f23470675cf21\"><code>a52972e</code></a></td><td><code>export DOT_SAGE so it can be used in spawned scripts</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e\"><code>6d049b1</code></a></td><td><code>Fix several scripts to work without sage-env</code></td></tr></table>\n",
    "created_at": "2019-07-21T11:43:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439593",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e59156b09f7b7c1c44e6726fe3d24ffad224a187"><code>e59156b</code></a></td><td><code>Fix sage-cython when sage-env is not available</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a52972e293045854ac9996eb261f23470675cf21"><code>a52972e</code></a></td><td><code>export DOT_SAGE so it can be used in spawned scripts</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e"><code>6d049b1</code></a></td><td><code>Fix several scripts to work without sage-env</code></td></tr></table>




---

archive/issue_comments_439594.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9\"><code>2dacae2</code></a></td><td><code>Fix sage-ipynb2rst and sage-valgrind scripts when sage-env is not available</code></td></tr></table>\n",
    "created_at": "2019-07-21T12:03:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439594",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9"><code>2dacae2</code></a></td><td><code>Fix sage-ipynb2rst and sage-valgrind scripts when sage-env is not available</code></td></tr></table>




---

archive/issue_comments_439595.json:
```json
{
    "body": "Changed commit from **[`6d049b1`](https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e)** to **[`2dacae2`](https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9)**",
    "created_at": "2019-07-21T12:03:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439595",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6d049b1`](https://github.com/sagemath/sagetrac-mirror/commit/6d049b14a3a1b77033fa09687a3942fe66f1384e)** to **[`2dacae2`](https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9)**



---

archive/issue_comments_439596.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@kiwifb](#comment%3A5):\n> I also have \n> \n> ```\n> # Replace SAGE_EXTCODE with the installation location\n> \tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n> \t\tbin/sage-ipynb2rst \\\n> \t\tbin/sage-valgrind\n> ```\n> which may be harder to replace more generally.\n\nFixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)",
    "created_at": "2019-07-21T12:05:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439596",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@kiwifb](#comment%3A5):
> I also have 
> 
> ```
> # Replace SAGE_EXTCODE with the installation location
> 	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
> 		bin/sage-ipynb2rst \
> 		bin/sage-valgrind
> ```
> which may be harder to replace more generally.

Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)



---

archive/issue_comments_439597.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@antonio-rojas](#comment%3A10):\n> Replying to [@kiwifb](#comment%3A5):\n> > I also have \n> > \n> > ```\n> > # Replace SAGE_EXTCODE with the installation location\n> > \tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n> > \t\tbin/sage-ipynb2rst \\\n> > \t\tbin/sage-valgrind\n> > ```\n> > which may be harder to replace more generally.\n> \n> \n> Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)\n\nCertainly does look hackish. I would have never thought of using `print` that way. Does this really work?",
    "created_at": "2019-07-21T20:57:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439597",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@antonio-rojas](#comment%3A10):
> Replying to [@kiwifb](#comment%3A5):
> > I also have 
> > 
> > ```
> > # Replace SAGE_EXTCODE with the installation location
> > 	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
> > 		bin/sage-ipynb2rst \
> > 		bin/sage-valgrind
> > ```
> > which may be harder to replace more generally.
> 
> 
> Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)

Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?



---

archive/issue_comments_439598.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\n> Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?\n\nSure it does - we use this kind of thing frequently in Arch build scripts to get the python lib dir independently of the version.",
    "created_at": "2019-07-21T21:03:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439598",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:12" align="right">comment:12</div>

> Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?

Sure it does - we use this kind of thing frequently in Arch build scripts to get the python lib dir independently of the version.



---

archive/issue_comments_439599.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nOK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.",
    "created_at": "2019-07-21T21:17:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439599",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:13" align="right">comment:13</div>

OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.



---

archive/issue_comments_439600.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nHow do you deal with `SAGE_LOCAL` in the `sage` script? Because of arch having `/usr/bin` and `/bin` symlinked you may not catch problems in line 7 and 8. There are a number of calls to `SAGE_LOCAL` in that file you are probably missing altogether.",
    "created_at": "2019-07-21T21:24:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439600",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:14" align="right">comment:14</div>

How do you deal with `SAGE_LOCAL` in the `sage` script? Because of arch having `/usr/bin` and `/bin` symlinked you may not catch problems in line 7 and 8. There are a number of calls to `SAGE_LOCAL` in that file you are probably missing altogether.



---

archive/issue_comments_439601.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@kiwifb](#comment%3A13):\n> OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.\n\nAfter line 1078 we also have `$SAGE_EXTCODE` in lines 1099 to 1101.",
    "created_at": "2019-07-21T22:06:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439601",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@kiwifb](#comment%3A13):
> OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.

After line 1078 we also have `$SAGE_EXTCODE` in lines 1099 to 1101.



---

archive/issue_comments_439602.json:
```json
{
    "body": "Changed branch from **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)** to **[u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env)**",
    "created_at": "2019-07-21T22:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439602",
    "user": "https://github.com/kiwifb"
}
```

Changed branch from **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)** to **[u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env)**



---

archive/issue_comments_439603.json:
```json
{
    "body": "Changed commit from **[`2dacae2`](https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9)** to **[`bbaf22f`](https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff)**",
    "created_at": "2019-07-21T22:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439603",
    "user": "https://github.com/kiwifb"
}
```

Changed commit from **[`2dacae2`](https://github.com/sagemath/sagetrac-mirror/commit/2dacae22b2e2da5bbfd89a3ecaec08c2f17f31f9)** to **[`bbaf22f`](https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff)**



---

archive/issue_comments_439604.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAdding my ideas for `sage/doctests/control.py`. Feel free to regain control of the branch.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff\"><code>bbaf22f</code></a></td><td><code>Fix control.py so it doesn't depend on values from sage-env.</code></td></tr></table>\n",
    "created_at": "2019-07-21T22:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439604",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

Adding my ideas for `sage/doctests/control.py`. Feel free to regain control of the branch.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff"><code>bbaf22f</code></a></td><td><code>Fix control.py so it doesn't depend on values from sage-env.</code></td></tr></table>




---

archive/issue_comments_439605.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIt may be impossible to completely fix the `sage` script at this stage. Best efforts at improvement would be acceptable to me.",
    "created_at": "2019-07-21T22:26:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439605",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:17" align="right">comment:17</div>

It may be impossible to completely fix the `sage` script at this stage. Best efforts at improvement would be acceptable to me.



---

archive/issue_comments_439606.json:
```json
{
    "body": "Changed branch from **[u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env)** to **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)**",
    "created_at": "2019-07-21T22:57:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439606",
    "user": "https://github.com/antonio-rojas"
}
```

Changed branch from **[u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/allow_sage_to_run_in_the_absence_of_sage_env)** to **[u/arojas/allow_sage_to_run_in_the_absence_of_sage_env](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/allow_sage_to_run_in_the_absence_of_sage_env)**



---

archive/issue_comments_439607.json:
```json
{
    "body": "Changed commit from **[`bbaf22f`](https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff)** to **[`25c686b`](https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d)**",
    "created_at": "2019-07-21T22:59:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439607",
    "user": "https://github.com/antonio-rojas"
}
```

Changed commit from **[`bbaf22f`](https://github.com/sagemath/sagetrac-mirror/commit/bbaf22f491ab6d334885ba4762256278d18a1bff)** to **[`25c686b`](https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d)**



---

archive/issue_comments_439608.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI think all SAGE_LOCAL usage in the sage executable part that is relevant for !sage-the-distro is gone now\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c31b262effd66f591286ec6629dda65ea2d6991\"><code>2c31b26</code></a></td><td><code>Replace SAGE_LOCAL usage in sage executable</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d\"><code>25c686b</code></a></td><td><code>Skip uncompiled tarball check if sage-env is not present</code></td></tr></table>\n",
    "created_at": "2019-07-21T22:59:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439608",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:19" align="right">comment:19</div>

I think all SAGE_LOCAL usage in the sage executable part that is relevant for !sage-the-distro is gone now

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c31b262effd66f591286ec6629dda65ea2d6991"><code>2c31b26</code></a></td><td><code>Replace SAGE_LOCAL usage in sage executable</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d"><code>25c686b</code></a></td><td><code>Skip uncompiled tarball check if sage-env is not present</code></td></tr></table>




---

archive/issue_comments_439609.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI don't think there is anything to add. Time for review?",
    "created_at": "2019-07-21T23:01:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439609",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:20" align="right">comment:20</div>

I don't think there is anything to add. Time for review?



---

archive/issue_events_384210.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-07-22T02:07:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384210"
}
```



---

archive/issue_comments_439610.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI am putting in \"needs review\" to start the patchbots (I hope).",
    "created_at": "2019-07-22T02:07:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439610",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:21" align="right">comment:21</div>

I am putting in "needs review" to start the patchbots (I hope).



---

archive/issue_comments_439611.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSome tests are failing locally without sage-env\n\n```\nsage -t --long /usr/lib/python2.7/site-packages/sage/misc/sagedoc.py  # 1 doctest failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/misc/sphinxify.py  # 4 doctests failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/libs/singular/function.pyx  # 1 doctest failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/interfaces/singular.py  # 5 doctests failed\n```",
    "created_at": "2019-07-22T06:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439611",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:22" align="right">comment:22</div>

Some tests are failing locally without sage-env

```
sage -t --long /usr/lib/python2.7/site-packages/sage/misc/sagedoc.py  # 1 doctest failed
sage -t --long /usr/lib/python2.7/site-packages/sage/misc/sphinxify.py  # 4 doctests failed
sage -t --long /usr/lib/python2.7/site-packages/sage/libs/singular/function.pyx  # 1 doctest failed
sage -t --long /usr/lib/python2.7/site-packages/sage/interfaces/singular.py  # 5 doctests failed
```



---

archive/issue_events_384211.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-22T06:56:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384211"
}
```



---

archive/issue_events_384212.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-22T06:56:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384212"
}
```



---

archive/issue_comments_439612.json:
```json
{
    "body": "Changed commit from **[`25c686b`](https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d)** to **[`045e01c`](https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d)**",
    "created_at": "2019-07-22T07:23:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439612",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`25c686b`](https://github.com/sagemath/sagetrac-mirror/commit/25c686bc4c5696eb63a5ba1fd44f2529749cae8d)** to **[`045e01c`](https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d)**



---

archive/issue_comments_439613.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c86bd9d765fc39e3b8b7fea3a434c7bcf71102bb\"><code>c86bd9d</code></a></td><td><code>Search for custom html themes also in SAGE_DOC, so they are found at runtime if SAGE_DOC_SRC is not set</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d\"><code>045e01c</code></a></td><td><code>Define SINGULARPATH in env.py so it is available at runtime when sage-env is not imported</code></td></tr></table>\n",
    "created_at": "2019-07-22T07:23:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439613",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c86bd9d765fc39e3b8b7fea3a434c7bcf71102bb"><code>c86bd9d</code></a></td><td><code>Search for custom html themes also in SAGE_DOC, so they are found at runtime if SAGE_DOC_SRC is not set</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d"><code>045e01c</code></a></td><td><code>Define SINGULARPATH in env.py so it is available at runtime when sage-env is not imported</code></td></tr></table>




---

archive/issue_comments_439614.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAll tests pass now. This branch conflicts with #25786 so it will need rebasing once that one goes in.",
    "created_at": "2019-07-22T07:24:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439614",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:24" align="right">comment:24</div>

All tests pass now. This branch conflicts with #25786 so it will need rebasing once that one goes in.



---

archive/issue_comments_439615.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI missed the singularpath one because I deal with it in the same patch as I do adjustments to `env.py`. I neglected that. I don't have a problem with `SAGE_DOC_SRC` because I have it default to `SAGE_DOC`  not `SAGE_SRC/doc` in sage-on-gentoo. I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n\nI know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.",
    "created_at": "2019-07-22T07:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439615",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:25" align="right">comment:25</div>

I missed the singularpath one because I deal with it in the same patch as I do adjustments to `env.py`. I neglected that. I don't have a problem with `SAGE_DOC_SRC` because I have it default to `SAGE_DOC`  not `SAGE_SRC/doc` in sage-on-gentoo. I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.

I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.



---

archive/issue_comments_439616.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@kiwifb](#comment%3A25):\n> I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n\nThe only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.\n\n> I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.\n\nNo. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.",
    "created_at": "2019-07-22T08:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439616",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@kiwifb](#comment%3A25):
> I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.

The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.

> I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.

No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.



---

archive/issue_comments_439617.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@antonio-rojas](#comment%3A26):\n> Replying to [@kiwifb](#comment%3A25):\n> > I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n> \n> \n> The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.\n\nCool, that's a clean up that's almost done then.\n\n> \n> > I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.\n> \n> \n> No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.\n\nAgreed. What to do with that file may be dependent on distro policies as well. It belongs to the location I set `SAGE_DOC` to, by policy in sage-on-gentoo.\n\nThis ticket is dealing with a good number of loose ends, it is quite nice.",
    "created_at": "2019-07-22T08:31:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439617",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@antonio-rojas](#comment%3A26):
> Replying to [@kiwifb](#comment%3A25):
> > I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.
> 
> 
> The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.

Cool, that's a clean up that's almost done then.

> 
> > I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.
> 
> 
> No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.

Agreed. What to do with that file may be dependent on distro policies as well. It belongs to the location I set `SAGE_DOC` to, by policy in sage-on-gentoo.

This ticket is dealing with a good number of loose ends, it is quite nice.



---

archive/issue_comments_439618.json:
```json
{
    "body": "<div id=\"comment:28\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3\"><code>c960520</code></a></td><td><code>Merge branch 'develop' of git://trac.sagemath.org/sage into t/28225/allow_sage_to_run_in_the_absence_of_sage_env</code></td></tr></table>\n",
    "created_at": "2019-07-29T17:34:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439618",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:28"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3"><code>c960520</code></a></td><td><code>Merge branch 'develop' of git://trac.sagemath.org/sage into t/28225/allow_sage_to_run_in_the_absence_of_sage_env</code></td></tr></table>




---

archive/issue_comments_439619.json:
```json
{
    "body": "Changed commit from **[`045e01c`](https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d)** to **[`c960520`](https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3)**",
    "created_at": "2019-07-29T17:34:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439619",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`045e01c`](https://github.com/sagemath/sagetrac-mirror/commit/045e01c75afdc50562bf3335c9c9977defec0d0d)** to **[`c960520`](https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3)**



---

archive/issue_comments_439620.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nRebased on top of beta 4",
    "created_at": "2019-07-29T17:36:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439620",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:29" align="right">comment:29</div>

Rebased on top of beta 4



---

archive/issue_events_384213.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-29T17:36:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384213"
}
```



---

archive/issue_events_384214.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2019-07-29T17:36:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384214"
}
```



---

archive/issue_events_384215.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-07-29T20:44:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384215"
}
```



---

archive/issue_events_384216.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-07-29T20:44:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384216"
}
```



---

archive/issue_comments_439621.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2019-07-29T20:44:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439621",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **Fran√ßois Bissey**



---

archive/issue_comments_439622.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nWell, it all looks good to me. Anyone knows why the patchbot doesn't seem to want to pick it? Is it too early after 8.9.beta4?",
    "created_at": "2019-07-29T20:44:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439622",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:30" align="right">comment:30</div>

Well, it all looks good to me. Anyone knows why the patchbot doesn't seem to want to pick it? Is it too early after 8.9.beta4?



---

archive/issue_comments_439623.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nThis is being merge-tested right now. Not runtime but build time, I wish I had spotted some instances of `os.environ` in `sage_setup/docbuild/__init__.py`. \n\nI am hoping the ticket will be merged in the current state and then we can address those little left overs in a follow up ticket.",
    "created_at": "2019-08-02T01:36:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439623",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:31" align="right">comment:31</div>

This is being merge-tested right now. Not runtime but build time, I wish I had spotted some instances of `os.environ` in `sage_setup/docbuild/__init__.py`. 

I am hoping the ticket will be merged in the current state and then we can address those little left overs in a follow up ticket.



---

archive/issue_comments_439624.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nAnother kink I missed before because of my setting of `SAGE_DOC_SRC`. sage doctest the documentation source not the installed one. I guess it also test the source code by looking at SAGE_SRC which default to SAGE_LIB when SAGE_ROOT is undefined. May be we should have gone for a similar model for SAGE_DOC_SRC - instead of the fix currently in `sage/docs/conf.py`?",
    "created_at": "2019-08-02T09:43:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439624",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:32" align="right">comment:32</div>

Another kink I missed before because of my setting of `SAGE_DOC_SRC`. sage doctest the documentation source not the installed one. I guess it also test the source code by looking at SAGE_SRC which default to SAGE_LIB when SAGE_ROOT is undefined. May be we should have gone for a similar model for SAGE_DOC_SRC - instead of the fix currently in `sage/docs/conf.py`?



---

archive/issue_comments_439625.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac\"><code>83a6cec</code></a></td><td><code>Set SAGE_DOC as fallback for SAGE_DOC_SRC in env.py, and make sure that the fallback is used if SAGE_ROOT is unset</code></td></tr></table>\n",
    "created_at": "2019-08-02T20:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439625",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac"><code>83a6cec</code></a></td><td><code>Set SAGE_DOC as fallback for SAGE_DOC_SRC in env.py, and make sure that the fallback is used if SAGE_ROOT is unset</code></td></tr></table>




---

archive/issue_events_384217.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2019-08-02T20:39:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384217"
}
```



---

archive/issue_events_384218.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2019-08-02T20:39:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384218"
}
```



---

archive/issue_comments_439626.json:
```json
{
    "body": "Changed commit from **[`c960520`](https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3)** to **[`83a6cec`](https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac)**",
    "created_at": "2019-08-02T20:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439626",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c960520`](https://github.com/sagemath/sagetrac-mirror/commit/c9605200e2b5a1cadefb868fd28ef13ef2bef8c3)** to **[`83a6cec`](https://github.com/sagemath/sagetrac-mirror/commit/83a6cec200e7179a632daee8658ac95b561d92ac)**



---

archive/issue_comments_439627.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI should have said to wait for a follow up ticket. Nevermind, let's see how it plays out.",
    "created_at": "2019-08-02T20:42:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439627",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:34" align="right">comment:34</div>

I should have said to wait for a follow up ticket. Nevermind, let's see how it plays out.



---

archive/issue_comments_439628.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nSome version of this ticket was merged into 8.9.beta5, and I'm guessing the last commit didn't make it. In any case, the changes that were merged cause an error with Python 3:\n\n```\nsage -t --warn-long 78.7 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 503, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Cython (http://cython.org) is a compiler for code written in the\n    Cython language.  Cython is based on Pyrex by Greg Ewing.\n    ...\nGot:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.9.beta5/src/bin/sage-cython\", line 12, in <module>\n        from sage.env import SAGE_SRC\n    ImportError: No module named sage.env\n    <BLANKLINE>\n```\nThe reason is that the `sage-cython` script begins\n\n```\n#!/usr/bin/env python\n```\nThat means that it uses Python 2 by default. With a Python 3 build, Python 2 doesn't know about the `sage` module.\n\nI'm not sure what you should do instead. Maybe\n\n```\ntry:\n    from sage.env import SAGE_SRC\nexcept ImportError:\n    SAGE_SRC = (something involving SAGE_ROOT or SAGE_LIB?)\n```\nWhat variables are guaranteed to be set when `sage-cython` is run?",
    "created_at": "2019-08-03T22:44:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439628",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:35" align="right">comment:35</div>

Some version of this ticket was merged into 8.9.beta5, and I'm guessing the last commit didn't make it. In any case, the changes that were merged cause an error with Python 3:

```
sage -t --warn-long 78.7 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 503, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Cython (http://cython.org) is a compiler for code written in the
    Cython language.  Cython is based on Pyrex by Greg Ewing.
    ...
Got:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.9.beta5/src/bin/sage-cython", line 12, in <module>
        from sage.env import SAGE_SRC
    ImportError: No module named sage.env
    <BLANKLINE>
```
The reason is that the `sage-cython` script begins

```
#!/usr/bin/env python
```
That means that it uses Python 2 by default. With a Python 3 build, Python 2 doesn't know about the `sage` module.

I'm not sure what you should do instead. Maybe

```
try:
    from sage.env import SAGE_SRC
except ImportError:
    SAGE_SRC = (something involving SAGE_ROOT or SAGE_LIB?)
```
What variables are guaranteed to be set when `sage-cython` is run?



---

archive/issue_comments_439629.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nI think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.\n\nWe need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.",
    "created_at": "2019-08-03T23:24:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439629",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:36" align="right">comment:36</div>

I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.

We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.



---

archive/issue_events_384219.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-03T23:51:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384219"
}
```



---

archive/issue_events_384220.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-03T23:51:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28225#event-384220"
}
```



---

archive/issue_comments_439630.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nc9605200e2b5a1cadefb868fd28ef13ef2bef8c3 was merged and is in 8.9.beta5, go and make a new ticket...",
    "created_at": "2019-08-03T23:51:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439630",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:37" align="right">comment:37</div>

c9605200e2b5a1cadefb868fd28ef13ef2bef8c3 was merged and is in 8.9.beta5, go and make a new ticket...



---

archive/issue_comments_439631.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@kiwifb](#comment%3A36):\n> I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.\n\nThe only thing that script does is to check arguments and run `cython`, so it should run fine with the system Python. For distro use, do you even care about how SAGE_SRC is used here? Maybe you could have\n\n```\ntry:\n    SAGE_SRC = os.environ[\"SAGE_SRC\"]\nexcept ImportError:\n    SAGE_SRC = \"/does/not/exist\"\n```\nplus some explanatory comments. The whole script is deprecated, so maybe it doesn't matter much what happens to it, but you might cc jdemeyer on the followup ticket.\n \n> We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.\n\nEither one or two: one for your followup issues, maybe a separate one to fix the doctest?",
    "created_at": "2019-08-04T00:22:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439631",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@kiwifb](#comment%3A36):
> I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.

The only thing that script does is to check arguments and run `cython`, so it should run fine with the system Python. For distro use, do you even care about how SAGE_SRC is used here? Maybe you could have

```
try:
    SAGE_SRC = os.environ["SAGE_SRC"]
except ImportError:
    SAGE_SRC = "/does/not/exist"
```
plus some explanatory comments. The whole script is deprecated, so maybe it doesn't matter much what happens to it, but you might cc jdemeyer on the followup ticket.
 
> We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.

Either one or two: one for your followup issues, maybe a separate one to fix the doctest?



---

archive/issue_comments_439632.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nFiled #28320",
    "created_at": "2019-08-04T09:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439632",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:39" align="right">comment:39</div>

Filed #28320



---

archive/issue_comments_439633.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nFollow up: #29022",
    "created_at": "2020-01-17T19:49:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439633",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:40" align="right">comment:40</div>

Follow up: #29022



---

archive/issue_comments_439634.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nand #25486",
    "created_at": "2020-01-17T20:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28225",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28225#issuecomment-439634",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:41" align="right">comment:41</div>

and #25486
