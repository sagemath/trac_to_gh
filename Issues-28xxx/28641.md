# Issue 28641: improve polynomial conversion from Fricas

archive/issues_028404.json:
```json
{
    "assignees": [],
    "body": "see https://ask.sagemath.org/question/48431/why-this-integral-fail-using-fricas-algorithm/\n\nfor the original bug report:\n\n```\nintegrate(sqrt(2)*x^2 + 2*x,x, algorithm=\"fricas\")\n```\n\nCC:  @mantepse @EmmanuelCharpentier\n\nKeywords: **FriCAS**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28641_\n\n",
    "closed_at": "2021-08-30T10:52:33Z",
    "created_at": "2019-10-20T13:35:56Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces%3A%20optional",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "improve polynomial conversion from Fricas",
    "type": "issue",
    "updated_at": "2021-08-30T10:52:33Z",
    "url": "https://github.com/sagemath/sage/issues/28641",
    "user": "https://github.com/fchapoton"
}
```
see https://ask.sagemath.org/question/48431/why-this-integral-fail-using-fricas-algorithm/

for the original bug report:

```
integrate(sqrt(2)*x^2 + 2*x,x, algorithm="fricas")
```

CC:  @mantepse @EmmanuelCharpentier

Keywords: **FriCAS**

Author: **Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/28641_





---

archive/issue_events_362024.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-20T13:35:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces%3A%20optional",
    "label_color": "0000ff",
    "label_name": "component: interfaces: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362024"
}
```



---

archive/issue_events_362025.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-20T13:35:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362025"
}
```



---

archive/issue_events_362026.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-20T13:35:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362026"
}
```



---

archive/issue_events_362027.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-20T13:37:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362027"
}
```



---

archive/issue_comments_449620.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937\">dc1761e</a></td><td><code>some improvements in Fricas interface</code></td></tr></table>\n",
    "created_at": "2019-10-20T13:37:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449620",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937">dc1761e</a></td><td><code>some improvements in Fricas interface</code></td></tr></table>




---

archive/issue_comments_449621.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n+see https://ask.sagemath.org/question/48431/why-this-integral-fail-using-fricas-algorithm/\n \n+for the original bug report:\n+\n+```\n+integrate(sqrt(2)*x^2 + 2*x,x, algorithm=\"fricas\")\n+```\n``````\n",
    "created_at": "2019-10-20T13:37:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449621",
    "user": "https://github.com/fchapoton"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,7 @@
+see https://ask.sagemath.org/question/48431/why-this-integral-fail-using-fricas-algorithm/
 
+for the original bug report:
+
+```
+integrate(sqrt(2)*x^2 + 2*x,x, algorithm="fricas")
+```
``````




---

archive/issue_comments_449622.json:
```json
{
    "body": "Branch: **[u/chapoton/28641](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28641)**",
    "created_at": "2019-10-20T13:37:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449622",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/28641](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28641)**



---

archive/issue_comments_449623.json:
```json
{
    "body": "Commit: **[dc1761e](https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937)**",
    "created_at": "2019-10-20T13:37:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449623",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[dc1761e](https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937)**



---

archive/issue_comments_449624.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nHmmm...\n\n```\nsage: ft=fricas(t); ft\n +-+\n\\|2\nsage: ft.parent()\nFriCAS\nsage: ft.sage()\n1.414213562373095?\nsage: ft.sage().parent()\nAlgebraic Field\nsage: ft.sage()^2\n2.000000000000000?\nsage: t^2\n2\nsage: (ft.sage()^2).parent()\nAlgebraic Field\nsage: (t^2).parent()\nSymbolic Ring\n```\n\nWe may loose the aymbolic representation of some quantities. And so, inconsistently:\n\n```\nsage: u=log(2); u\nlog(2)\nsage: fu=fricas(u); fu\nlog(2)\nsage: fu.sage()\nlog(2)\nsage: fu.sage().parent()\nSymbolic Ring\n```\n\n\nDitto for exponentials. Potentially worse for trig:\n\n```\nsage: t\nsqrt(2)\nsage: arcsin(t/2)\n1/4*pi\nsage: arcsin(ft.sage()/2)\narcsin(0.7071067811865475?)\n```\n\nAnyway, `ptestalllong` underway for the current version (https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937) of this patch.",
    "created_at": "2019-10-20T16:03:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449624",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:2'>Comment 2:</a>
Hmmm...

```
sage: ft=fricas(t); ft
 +-+
\|2
sage: ft.parent()
FriCAS
sage: ft.sage()
1.414213562373095?
sage: ft.sage().parent()
Algebraic Field
sage: ft.sage()^2
2.000000000000000?
sage: t^2
2
sage: (ft.sage()^2).parent()
Algebraic Field
sage: (t^2).parent()
Symbolic Ring
```

We may loose the aymbolic representation of some quantities. And so, inconsistently:

```
sage: u=log(2); u
log(2)
sage: fu=fricas(u); fu
log(2)
sage: fu.sage()
log(2)
sage: fu.sage().parent()
Symbolic Ring
```


Ditto for exponentials. Potentially worse for trig:

```
sage: t
sqrt(2)
sage: arcsin(t/2)
1/4*pi
sage: arcsin(ft.sage()/2)
arcsin(0.7071067811865475?)
```

Anyway, `ptestalllong` underway for the current version (https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937) of this patch.



---

archive/issue_comments_449625.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A2):\n\n[ Snip... ]\n\nEven more inconsistent:\n\n```\nsage: fricas(sqrt(pi))\n +---+\n\\|%pi\nsage: fricas(sqrt(pi)).sage()\nsqrt(pi)\n```\n\nCouldn't we have `fricas(sqrt(2)).sage()==sqrt(2)` ?",
    "created_at": "2019-10-20T16:58:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449625",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [@EmmanuelCharpentier](#comment%3A2):

[ Snip... ]

Even more inconsistent:

```
sage: fricas(sqrt(pi))
 +---+
\|%pi
sage: fricas(sqrt(pi)).sage()
sqrt(pi)
```

Couldn't we have `fricas(sqrt(2)).sage()==sqrt(2)` ?



---

archive/issue_events_362028.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-10-20T17:19:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362028"
}
```



---

archive/issue_events_362029.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-10-20T17:19:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362029"
}
```



---

archive/issue_comments_449626.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nNever mind :\n\n```\ncharpent@zen-book-flip:/usr/local/sage-P3-2$ sage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py \nRunning doctests with ID 2019-10-20-19-15-43-ce51a938.\nGit branch: t/28641/28641\nUsing --optional=build,dochtml,dot2tex,fricas,gap_packages,giacpy_sage,libsemigroups,memlimit,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py\n**********************************************************************\nFile \"src/sage/interfaces/fricas.py\", line 1693, in sage.interfaces.fricas.FriCASElement._sage_\nFailed example:\n    fricas(\"x^2/2\").sage()                                        # optional - fricas\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.fricas.FriCASElement._sage_[19]>\", line 1, in <module>\n        fricas(\"x^2/2\").sage()                                        # optional - fricas\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 1081, in sage\n        return self._sage_(*args, **kwds)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1928, in _sage_\n        for idx, cf in zip(monoms, coeffs)})\n      File \"sage/structure/parent.pyx\", line 900, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 162, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 157, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)\n        return C._element_constructor(x)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_ring.py\", line 476, in _element_constructor_\n        return C(self, x, check, is_gen, construct=construct, **kwds)\n      File \"sage/rings/polynomial/polynomial_rational_flint.pyx\", line 262, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:5378)\n        for deg, e in x.iteritems():\n    TypeError: an integer is required\n**********************************************************************\nFile \"src/sage/interfaces/fricas.py\", line 1753, in sage.interfaces.fricas.FriCASElement._sage_\nFailed example:\n    fricas(\"matrix [[x^n/2^m for n in 0..5] for m in 0..3]\").sage()         # optional - fricas, long time\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.fricas.FriCASElement._sage_[37]>\", line 1, in <module>\n        fricas(\"matrix [[x^n/2^m for n in 0..5] for m in 0..3]\").sage()         # optional - fricas, long time\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 1081, in sage\n        return self._sage_(*args, **kwds)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1846, in _sage_\n        rows = self.listOfLists().sage()\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 1081, in sage\n        return self._sage_(*args, **kwds)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1838, in _sage_\n        return [self.elt(k).sage() for k in range(1, n + 1)]\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1838, in <listcomp>\n        return [self.elt(k).sage() for k in range(1, n + 1)]\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 1081, in sage\n        return self._sage_(*args, **kwds)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1838, in _sage_\n        return [self.elt(k).sage() for k in range(1, n + 1)]\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1838, in <listcomp>\n        return [self.elt(k).sage() for k in range(1, n + 1)]\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 1081, in sage\n        return self._sage_(*args, **kwds)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py\", line 1928, in _sage_\n        for idx, cf in zip(monoms, coeffs)})\n      File \"sage/structure/parent.pyx\", line 900, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 162, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 157, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)\n        return C._element_constructor(x)\n      File \"/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_ring.py\", line 476, in _element_constructor_\n        return C(self, x, check, is_gen, construct=construct, **kwds)\n      File \"sage/rings/polynomial/polynomial_rational_flint.pyx\", line 262, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:5378)\n        for deg, e in x.iteritems():\n    TypeError: an integer is required\n**********************************************************************\n1 item had failures:\n   2 of  45 in sage.interfaces.fricas.FriCASElement._sage_\n    [253 tests, 2 failures, 35.90 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 41.0 seconds\n    cpu time: 4.0 seconds\n    cumulative wall time: 35.9 seconds\n```\n\n==> `needs_work`\n\nI'll peruse the other `ptestalllong` failures (usually transient) in order to find other (new) (permanent) problems.",
    "created_at": "2019-10-20T17:19:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449626",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:4'>Comment 4:</a>
Never mind :

```
charpent@zen-book-flip:/usr/local/sage-P3-2$ sage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py 
Running doctests with ID 2019-10-20-19-15-43-ce51a938.
Git branch: t/28641/28641
Using --optional=build,dochtml,dot2tex,fricas,gap_packages,giacpy_sage,libsemigroups,memlimit,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 1693, in sage.interfaces.fricas.FriCASElement._sage_
Failed example:
    fricas("x^2/2").sage()                                        # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement._sage_[19]>", line 1, in <module>
        fricas("x^2/2").sage()                                        # optional - fricas
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 1081, in sage
        return self._sage_(*args, **kwds)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1928, in _sage_
        for idx, cf in zip(monoms, coeffs)})
      File "sage/structure/parent.pyx", line 900, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 162, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)
        raise
      File "sage/structure/coerce_maps.pyx", line 157, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)
        return C._element_constructor(x)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_ring.py", line 476, in _element_constructor_
        return C(self, x, check, is_gen, construct=construct, **kwds)
      File "sage/rings/polynomial/polynomial_rational_flint.pyx", line 262, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:5378)
        for deg, e in x.iteritems():
    TypeError: an integer is required
**********************************************************************
File "src/sage/interfaces/fricas.py", line 1753, in sage.interfaces.fricas.FriCASElement._sage_
Failed example:
    fricas("matrix [[x^n/2^m for n in 0..5] for m in 0..3]").sage()         # optional - fricas, long time
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement._sage_[37]>", line 1, in <module>
        fricas("matrix [[x^n/2^m for n in 0..5] for m in 0..3]").sage()         # optional - fricas, long time
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 1081, in sage
        return self._sage_(*args, **kwds)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1846, in _sage_
        rows = self.listOfLists().sage()
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 1081, in sage
        return self._sage_(*args, **kwds)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1838, in _sage_
        return [self.elt(k).sage() for k in range(1, n + 1)]
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1838, in <listcomp>
        return [self.elt(k).sage() for k in range(1, n + 1)]
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 1081, in sage
        return self._sage_(*args, **kwds)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1838, in _sage_
        return [self.elt(k).sage() for k in range(1, n + 1)]
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1838, in <listcomp>
        return [self.elt(k).sage() for k in range(1, n + 1)]
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 1081, in sage
        return self._sage_(*args, **kwds)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 1928, in _sage_
        for idx, cf in zip(monoms, coeffs)})
      File "sage/structure/parent.pyx", line 900, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 162, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)
        raise
      File "sage/structure/coerce_maps.pyx", line 157, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)
        return C._element_constructor(x)
      File "/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_ring.py", line 476, in _element_constructor_
        return C(self, x, check, is_gen, construct=construct, **kwds)
      File "sage/rings/polynomial/polynomial_rational_flint.pyx", line 262, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:5378)
        for deg, e in x.iteritems():
    TypeError: an integer is required
**********************************************************************
1 item had failures:
   2 of  45 in sage.interfaces.fricas.FriCASElement._sage_
    [253 tests, 2 failures, 35.90 s]
----------------------------------------------------------------------
sage -t --long --warn-long 192.4 src/sage/interfaces/fricas.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 41.0 seconds
    cpu time: 4.0 seconds
    cumulative wall time: 35.9 seconds
```

==> `needs_work`

I'll peruse the other `ptestalllong` failures (usually transient) in order to find other (new) (permanent) problems.



---

archive/issue_comments_449627.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A4):\n\n[ Snip... ]\n \n> I'll peruse the other `ptestalllong` failures (usually transient) in order to find other (new) (permanent) problems.\n\nFWIW, no new permanent failure beyond the one related to FriCAS, the transient failures are those already reported in sage-release.",
    "created_at": "2019-10-20T17:28:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449627",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@EmmanuelCharpentier](#comment%3A4):

[ Snip... ]
 
> I'll peruse the other `ptestalllong` failures (usually transient) in order to find other (new) (permanent) problems.

FWIW, no new permanent failure beyond the one related to FriCAS, the transient failures are those already reported in sage-release.



---

archive/issue_comments_449628.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nAdding myself to the Cc list.",
    "created_at": "2019-10-20T17:30:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449628",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:6'>Comment 6:</a>
Adding myself to the Cc list.



---

archive/issue_comments_449629.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A4):\n\n[ Snip... ]\n\nFrom your patch:\n\n```\n+                gens = R.variable_names()\n+                coeffs = (base_ring(cf.sage()) for cf in self.coefficients())\n```\n\nThe problem is here, IMSHO: I think that the base ring should be the base ring of the expression as a whole. This would avoid the intrusion of QQ or QQbar in symbolic expression having interger or fractional exponents, whose double translation (sage --> FriCAS --> sage) ends up in QQ.\n\n```\n+                monoms = (m.degree() for m in self.monomials())\n+\n+                def vers_exposant(idx):\n+                    return tuple(idx[v] if v in idx else 0 for v in gens)\n+\n+                return R({vers_exposant(idx.sage()): cf\n+                          for idx, cf in zip(monoms, coeffs)})\n```\n\nHTH,",
    "created_at": "2019-10-20T17:39:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449629",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:7'>Comment 7:</a>
Replying to [@EmmanuelCharpentier](#comment%3A4):

[ Snip... ]

From your patch:

```
+                gens = R.variable_names()
+                coeffs = (base_ring(cf.sage()) for cf in self.coefficients())
```

The problem is here, IMSHO: I think that the base ring should be the base ring of the expression as a whole. This would avoid the intrusion of QQ or QQbar in symbolic expression having interger or fractional exponents, whose double translation (sage --> FriCAS --> sage) ends up in QQ.

```
+                monoms = (m.degree() for m in self.monomials())
+
+                def vers_exposant(idx):
+                    return tuple(idx[v] if v in idx else 0 for v in gens)
+
+                return R({vers_exposant(idx.sage()): cf
+                          for idx, cf in zip(monoms, coeffs)})
```

HTH,



---

archive/issue_comments_449630.json:
```json
{
    "body": "Changed commit from **[dc1761e](https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937)** to **[0bf9540](https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5)**",
    "created_at": "2019-10-20T19:07:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449630",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[dc1761e](https://github.com/sagemath/sagetrac-mirror/commit/dc1761eb48e0a28b93f4409020bb4d6d1435f937)** to **[0bf9540](https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5)**



---

archive/issue_comments_449631.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5\">0bf9540</a></td><td><code>trac 28641 fix for fricas polynomials</code></td></tr></table>\n",
    "created_at": "2019-10-20T19:07:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449631",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'>Comment 8:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5">0bf9540</a></td><td><code>trac 28641 fix for fricas polynomials</code></td></tr></table>




---

archive/issue_comments_449632.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nIn my opinion, getting results in something else than the horrible SR ring is a welcome improvement.\n\nSomething else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.",
    "created_at": "2019-10-20T19:27:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449632",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'>Comment 9:</a>
In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.

Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.



---

archive/issue_comments_449633.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nReplying to [@fchapoton](#comment%3A9):\n> In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.\n\nI agree.  I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will \"guess\" a convenient domain for you, which most of the time works very well.\n\nHowever, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:\n\n```\nsage: fricas(sqrt(2)).domainOf()\nAlgebraicNumber()\n```\nwould be better\n\n```\nsage: fricas(\"sqrt(2)::EXPR INT\").domainOf()\nExpression(Integer())\n```\n\nApparently, conversion from `QQbar` is not yet implemented, but this should not be hard.\n\n> Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.\n\nIndeed, this is a big problem.  The correct fix would be to write a proper interface, bypassing pexpect.  This thread contains a sketch (!) of a proof of concept: https://groups.google.com/d/msg/fricas-devel/qYzrY-92Q2A/EnJ_82FZAQAJ",
    "created_at": "2019-10-20T19:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449633",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:10'>Comment 10:</a>
Replying to [@fchapoton](#comment%3A9):
> In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.

I agree.  I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will "guess" a convenient domain for you, which most of the time works very well.

However, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:

```
sage: fricas(sqrt(2)).domainOf()
AlgebraicNumber()
```
would be better

```
sage: fricas("sqrt(2)::EXPR INT").domainOf()
Expression(Integer())
```

Apparently, conversion from `QQbar` is not yet implemented, but this should not be hard.

> Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.

Indeed, this is a big problem.  The correct fix would be to write a proper interface, bypassing pexpect.  This thread contains a sketch (!) of a proof of concept: https://groups.google.com/d/msg/fricas-devel/qYzrY-92Q2A/EnJ_82FZAQAJ



---

archive/issue_comments_449634.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nReplying to [@fchapoton](#comment%3A9):\n> In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.\n\nIn this specific case, I disagree *absolutely* : SR allows to use  a lot of knowlegde not accessible when these values are expressed as algrebraics (as already remarked, arcsin(sqrt(2)/2)) is recognized as pi/4, but not arcsin(0.707?), even if in this specific case, the expressed value can be recovered by `.radical_expression()`). Similarly, this change of representation may cause Sage to miss some simplifications or factorizations.\n\nMore generally, one should **not** unexpectedly change a representation to another with different possibilities.\n\n> Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.\n\nThis is anor=ther problem, that should be treated in another ticker.",
    "created_at": "2019-10-20T21:30:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449634",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:11'>Comment 11:</a>
Replying to [@fchapoton](#comment%3A9):
> In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.

In this specific case, I disagree *absolutely* : SR allows to use  a lot of knowlegde not accessible when these values are expressed as algrebraics (as already remarked, arcsin(sqrt(2)/2)) is recognized as pi/4, but not arcsin(0.707?), even if in this specific case, the expressed value can be recovered by `.radical_expression()`). Similarly, this change of representation may cause Sage to miss some simplifications or factorizations.

More generally, one should **not** unexpectedly change a representation to another with different possibilities.

> Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.

This is anor=ther problem, that should be treated in another ticker.



---

archive/issue_comments_449635.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@mantepse](#comment%3A10):\n> Replying to [@fchapoton](#comment%3A9):\n> > In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.\n\n> \n> I agree.  \n\nI don't (see my reply to chapoton).\n\n>I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will \"guess\" a convenient domain for you, which most of the time works very well.\n> \n> However, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:\n> \n>\n> ```\n> sage: fricas(sqrt(2)).domainOf()\n> AlgebraicNumber()\n> ```\n> would be better\n>\n> ```\n> sage: fricas(\"sqrt(2)::EXPR INT\").domainOf()\n> Expression(Integer())\n> ```\n\nNo. Non. Nope. Nyet. (Or, as in the British Commons, no, no, no, no, no, no, no, no. And no).\n\nYou don't know if your \"2\" is the second non-null integer, `(sin(2*x)/x).limit(x=0)` or something else. The only \"polyvalent\" representation is SR(2).Which, I agree, is horribly inefficient, *because* it is polysemic.\n\n \n> Apparently, conversion from `QQbar` is not yet implemented, but this should not be hard.\n\nI wouldn't wager my (supposedly) eternal soul on this one:\n\n```\nsage: QQbar(arcsin(1/2))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-9-b60e7a0af1e6> in <module>()\n----> 1 QQbar(arcsin(Integer(1)/Integer(2)))\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)()\n    898         if mor is not None:\n    899             if no_extra_args:\n--> 900                 return mor._call_(x)\n    901             else:\n    902                 return mor._call_with_args(x, args, kwds)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)()\n    160                 print(type(C), C)\n    161                 print(type(C._element_constructor), C._element_constructor)\n--> 162             raise\n    163 \n    164     cpdef Element _call_with_args(self, x, args=(), kwds={}):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)()\n    155         cdef Parent C = self._codomain\n    156         try:\n--> 157             return C._element_constructor(x)\n    158         except Exception:\n    159             if print_warnings:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/qqbar.py in _element_constructor_(self, x)\n   1176             return AlgebraicNumber(x._descr)\n   1177         elif hasattr(x, '_algebraic_'):\n-> 1178             return x._algebraic_(QQbar)\n   1179         return AlgebraicNumber(x)\n   1180 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:11585)()\n   1503         \"\"\"\n   1504         from sage.symbolic.expression_conversions import algebraic\n-> 1505         return algebraic(self, field)\n   1506 \n   1507     def __hash__(self):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in algebraic(ex, field)\n   1178         0\n   1179     \"\"\"\n-> 1180     return AlgebraicConverter(field)(ex)\n   1181 \n   1182 ##############\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)\n   1028                 return exp(expt)._algebraic_(self.field)\n   1029 \n-> 1030         raise TypeError(\"unable to convert %r to %s\"%(ex, self.field))\n   1031 \n   1032     def composition(self, ex, operator):\n\nTypeError: unable to convert 1/6*pi to Algebraic Field\n```\n \n> > Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.\n\n> \n> Indeed, this is a big problem.  The correct fix would be to write a proper interface, bypassing pexpect.  This thread contains a sketch (!) of a proof of concept: https://groups.google.com/d/msg/fricas-devel/qYzrY-92Q2A/EnJ_82FZAQAJ\n\nI'd be very wary on this one. This has been done recently with R, and the result isn't (yet) beyond all criticism...",
    "created_at": "2019-10-20T21:51:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449635",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@mantepse](#comment%3A10):
> Replying to [@fchapoton](#comment%3A9):
> > In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.

> 
> I agree.  

I don't (see my reply to chapoton).

>I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will "guess" a convenient domain for you, which most of the time works very well.
> 
> However, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:
> 
>
> ```
> sage: fricas(sqrt(2)).domainOf()
> AlgebraicNumber()
> ```
> would be better
>
> ```
> sage: fricas("sqrt(2)::EXPR INT").domainOf()
> Expression(Integer())
> ```

No. Non. Nope. Nyet. (Or, as in the British Commons, no, no, no, no, no, no, no, no. And no).

You don't know if your "2" is the second non-null integer, `(sin(2*x)/x).limit(x=0)` or something else. The only "polyvalent" representation is SR(2).Which, I agree, is horribly inefficient, *because* it is polysemic.

 
> Apparently, conversion from `QQbar` is not yet implemented, but this should not be hard.

I wouldn't wager my (supposedly) eternal soul on this one:

```
sage: QQbar(arcsin(1/2))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-9-b60e7a0af1e6> in <module>()
----> 1 QQbar(arcsin(Integer(1)/Integer(2)))

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9198)()
    898         if mor is not None:
    899             if no_extra_args:
--> 900                 return mor._call_(x)
    901             else:
    902                 return mor._call_with_args(x, args, kwds)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4556)()
    160                 print(type(C), C)
    161                 print(type(C._element_constructor), C._element_constructor)
--> 162             raise
    163 
    164     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4448)()
    155         cdef Parent C = self._codomain
    156         try:
--> 157             return C._element_constructor(x)
    158         except Exception:
    159             if print_warnings:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/rings/qqbar.py in _element_constructor_(self, x)
   1176             return AlgebraicNumber(x._descr)
   1177         elif hasattr(x, '_algebraic_'):
-> 1178             return x._algebraic_(QQbar)
   1179         return AlgebraicNumber(x)
   1180 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._algebraic_ (build/cythonized/sage/symbolic/expression.cpp:11585)()
   1503         """
   1504         from sage.symbolic.expression_conversions import algebraic
-> 1505         return algebraic(self, field)
   1506 
   1507     def __hash__(self):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in algebraic(ex, field)
   1178         0
   1179     """
-> 1180     return AlgebraicConverter(field)(ex)
   1181 
   1182 ##############

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)
   1028                 return exp(expt)._algebraic_(self.field)
   1029 
-> 1030         raise TypeError("unable to convert %r to %s"%(ex, self.field))
   1031 
   1032     def composition(self, ex, operator):

TypeError: unable to convert 1/6*pi to Algebraic Field
```
 
> > Something else: the back conversion of lists and matrices is extremely slow, and I have no idea how to fix that.

> 
> Indeed, this is a big problem.  The correct fix would be to write a proper interface, bypassing pexpect.  This thread contains a sketch (!) of a proof of concept: https://groups.google.com/d/msg/fricas-devel/qYzrY-92Q2A/EnJ_82FZAQAJ

I'd be very wary on this one. This has been done recently with R, and the result isn't (yet) beyond all criticism...



---

archive/issue_comments_449636.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A12):\n> Replying to [@mantepse](#comment%3A10):\n> > Replying to [@fchapoton](#comment%3A9):\n> > > In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.\n\n> > \n> > I agree.  \n\n> \n> I don't (see my reply to chapoton).\n> \n> >I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will \"guess\" a convenient domain for you, which most of the time works very well.\n> > \n> > However, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:\n> > \n> >\n> > ```\n> > sage: fricas(sqrt(2)).domainOf()\n> > AlgebraicNumber()\n> > ```\n> > would be better\n> >\n> > ```\n> > sage: fricas(\"sqrt(2)::EXPR INT\").domainOf()\n> > Expression(Integer())\n> > ```\n\n> \n> No. Non. Nope. Nyet. (Or, as in the British Commons, no, no, no, no, no, no, no, no. And no).\n\nYou seem to have a very strong opinion on that.  In any case, this is how the interface currently (mostly) works, but if you want to do it differently, please go ahead.\n\n> You don't know if your \"2\" is the second non-null integer, `(sin(2*x)/x).limit(x=0)` or something else. The only \"polyvalent\" representation is SR(2).Which, I agree, is horribly inefficient, *because* it is polysemic.\n\nI thought that, essentially, sagemath follows the idea that every object has a type.  So, sage actually knows the type of \"2\" within an expression.\n\nI would suggest to use this - and I think that the current interface does use this information quite a lot.\n\nIn FriCAS, every object *must* have a proper type.  There is no way you can invert a square array of integers.  (FriCAS is not very strict about itself, so you may find lots of counterexamples.)\n\n> > Apparently, conversion from `QQbar` is not yet implemented, but this should not be hard.\n\n> \n> I wouldn't wager my (supposedly) eternal soul on this one:\n> \n> ```\n> sage: QQbar(arcsin(1/2))\n> ```\n\nI don't understand - this is not an algebraic number.  What do you want to show?",
    "created_at": "2019-10-21T06:04:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449636",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@EmmanuelCharpentier](#comment%3A12):
> Replying to [@mantepse](#comment%3A10):
> > Replying to [@fchapoton](#comment%3A9):
> > > In my opinion, getting results in something else than the horrible SR ring is a welcome improvement.

> > 
> > I agree.  

> 
> I don't (see my reply to chapoton).
> 
> >I didn't look at the details, so please just take it as a hint: you can (and should) tell FriCAS in which domain you want to compute.  If you don't, FriCAS will "guess" a convenient domain for you, which most of the time works very well.
> > 
> > However, maybe it makes sense if, within sage, the conversion from sage to fricas preserves the domain.  For example:
> > 
> >
> > ```
> > sage: fricas(sqrt(2)).domainOf()
> > AlgebraicNumber()
> > ```
> > would be better
> >
> > ```
> > sage: fricas("sqrt(2)::EXPR INT").domainOf()
> > Expression(Integer())
> > ```

> 
> No. Non. Nope. Nyet. (Or, as in the British Commons, no, no, no, no, no, no, no, no. And no).

You seem to have a very strong opinion on that.  In any case, this is how the interface currently (mostly) works, but if you want to do it differently, please go ahead.

> You don't know if your "2" is the second non-null integer, `(sin(2*x)/x).limit(x=0)` or something else. The only "polyvalent" representation is SR(2).Which, I agree, is horribly inefficient, *because* it is polysemic.

I thought that, essentially, sagemath follows the idea that every object has a type.  So, sage actually knows the type of "2" within an expression.

I would suggest to use this - and I think that the current interface does use this information quite a lot.

In FriCAS, every object *must* have a proper type.  There is no way you can invert a square array of integers.  (FriCAS is not very strict about itself, so you may find lots of counterexamples.)

> > Apparently, conversion from `QQbar` is not yet implemented, but this should not be hard.

> 
> I wouldn't wager my (supposedly) eternal soul on this one:
> 
> ```
> sage: QQbar(arcsin(1/2))
> ```

I don't understand - this is not an algebraic number.  What do you want to show?



---

archive/issue_events_362030.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-21T18:20:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362030"
}
```



---

archive/issue_events_362031.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-21T18:20:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362031"
}
```



---

archive/issue_comments_449637.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nI think that this is ready for review.\n\nFurther fixes and enhacements could be done in later tickets. This ticket is fixing a precise problem, the integral in the description.",
    "created_at": "2019-10-21T18:20:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449637",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'>Comment 14:</a>
I think that this is ready for review.

Further fixes and enhacements could be done in later tickets. This ticket is fixing a precise problem, the integral in the description.



---

archive/issue_events_362032.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-10-22T10:43:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362032"
}
```



---

archive/issue_events_362033.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2019-10-22T10:43:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362033"
}
```



---

archive/issue_comments_449638.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@fchapoton](#comment%3A14):\n> I think that this is ready for review.\n> \n> Further fixes and enhacements could be done in later tickets. This ticket is fixing a precise problem, the integral in the description.\n\nNope:\n\n```\nsage: f=x*sqrt(2)\nsage: bool(f.integrate(x, algorithm=\"fricas\").diff(x)==f.integrate(x).diff(x))\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)\n    707             try:\n--> 708                 self._name = parent._create(value, name=name)\n    709             except (TypeError, RuntimeError, ValueError) as x:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _create(self, value, name)\n    605             else:\n--> 606                 self.set(name, value)\n    607         except RuntimeError as error:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in set(self, var, value)\n    514         cmd = '%s : %s$'%(var, value.rstrip(';'))\n--> 515         self.eval(cmd)\n    516 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _eval_line(self, line, locals, reformat, **kwds)\n    460                 if statement:\n--> 461                     maxima_eval(\"#$%s$\" % statement)\n    462         if not reformat:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:7779)()\n    804         \"\"\"\n--> 805         lispargs = EclObject(list(args))\n    806         return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__init__ (build/cythonized/sage/libs/ecl.c:7313)()\n    669         if len(args) != 0:\n--> 670             self.set_obj(python_to_ecl(args[0]))\n    671 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6357)()\n    484         else:\n--> 485             L=cl_cons(python_to_ecl(pyobj[0]),Cnil)\n    486             ptr=L\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6051)()\n    465         s=str_to_bytes(pyobj)\n--> 466         return ecl_safe_read_string(s)\n    467     elif isinstance(pyobj,bytes):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_read_string (build/cythonized/sage/libs/ecl.c:5530)()\n    385     o = ecl_cstring_to_base_string_or_nil(s)\n--> 386     o = ecl_safe_funcall(read_from_string_clobj,o)\n    387     return o\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5297)()\n    364         s = si_coerce_to_base_string(ecl_values(1))\n--> 365         raise RuntimeError(\"ECL says: {}\".format(\n    366             char_to_str(ecl_base_string_pointer_safe(s))))\n\nRuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n\nDuring handling of the above exception, another exception occurred:\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-25-463b9051345c> in <module>()\n----> 1 bool(f.integrate(x, algorithm=\"fricas\").diff(x)==f.integrate(x).diff(x))\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19521)()\n   2918             # lot of basic Sage objects can't be put into maxima.\n   2919             from sage.symbolic.relation import test_relation_maxima\n-> 2920             return test_relation_maxima(self)\n   2921 \n   2922         self_is_zero = self._gobj.is_zero()\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/relation.py in test_relation_maxima(relation)\n    490         [k is noninteger]\n    491     \"\"\"\n--> 492     m = relation._maxima_()\n    493 \n    494     #Handle some basic cases first\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._maxima_ (build/cythonized/sage/symbolic/expression.cpp:7806)()\n    813             # Maybe not such a great idea because the \"default\" interface is another one\n    814             from sage.calculus.calculus import maxima\n--> 815             return super(Expression, self)._interface_(maxima)\n    816         else:\n    817             return super(Expression, self)._interface_(session)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5532)()\n    674             except Exception:\n    675                 raise NotImplementedError(\"coercion of object %s to %s not implemented:\\n%s\\n%s\" % (repr(self), I))\n--> 676         X = I(s)\n    677         if c:\n    678             try:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)\n    286 \n    287         if isinstance(x, string_types):\n--> 288             return cls(self, x, name=name)\n    289         try:\n    290             # Special methods do not and should not have an option to\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)\n    708                 self._name = parent._create(value, name=name)\n    709             except (TypeError, RuntimeError, ValueError) as x:\n--> 710                 raise TypeError(x)\n    711 \n    712     def _latex_(self):\n\nTypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n```\n\nMissing this elementary test is no small beer...\n\n===>`needs_work`",
    "created_at": "2019-10-22T10:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449638",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@fchapoton](#comment%3A14):
> I think that this is ready for review.
> 
> Further fixes and enhacements could be done in later tickets. This ticket is fixing a precise problem, the integral in the description.

Nope:

```
sage: f=x*sqrt(2)
sage: bool(f.integrate(x, algorithm="fricas").diff(x)==f.integrate(x).diff(x))
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    707             try:
--> 708                 self._name = parent._create(value, name=name)
    709             except (TypeError, RuntimeError, ValueError) as x:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _create(self, value, name)
    605             else:
--> 606                 self.set(name, value)
    607         except RuntimeError as error:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in set(self, var, value)
    514         cmd = '%s : %s$'%(var, value.rstrip(';'))
--> 515         self.eval(cmd)
    516 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _eval_line(self, line, locals, reformat, **kwds)
    460                 if statement:
--> 461                     maxima_eval("#$%s$" % statement)
    462         if not reformat:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:7779)()
    804         """
--> 805         lispargs = EclObject(list(args))
    806         return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__init__ (build/cythonized/sage/libs/ecl.c:7313)()
    669         if len(args) != 0:
--> 670             self.set_obj(python_to_ecl(args[0]))
    671 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6357)()
    484         else:
--> 485             L=cl_cons(python_to_ecl(pyobj[0]),Cnil)
    486             ptr=L

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6051)()
    465         s=str_to_bytes(pyobj)
--> 466         return ecl_safe_read_string(s)
    467     elif isinstance(pyobj,bytes):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_read_string (build/cythonized/sage/libs/ecl.c:5530)()
    385     o = ecl_cstring_to_base_string_or_nil(s)
--> 386     o = ecl_safe_funcall(read_from_string_clobj,o)
    387     return o

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5297)()
    364         s = si_coerce_to_base_string(ecl_values(1))
--> 365         raise RuntimeError("ECL says: {}".format(
    366             char_to_str(ecl_base_string_pointer_safe(s))))

RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-25-463b9051345c> in <module>()
----> 1 bool(f.integrate(x, algorithm="fricas").diff(x)==f.integrate(x).diff(x))

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19521)()
   2918             # lot of basic Sage objects can't be put into maxima.
   2919             from sage.symbolic.relation import test_relation_maxima
-> 2920             return test_relation_maxima(self)
   2921 
   2922         self_is_zero = self._gobj.is_zero()

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/relation.py in test_relation_maxima(relation)
    490         [k is noninteger]
    491     """
--> 492     m = relation._maxima_()
    493 
    494     #Handle some basic cases first

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._maxima_ (build/cythonized/sage/symbolic/expression.cpp:7806)()
    813             # Maybe not such a great idea because the "default" interface is another one
    814             from sage.calculus.calculus import maxima
--> 815             return super(Expression, self)._interface_(maxima)
    816         else:
    817             return super(Expression, self)._interface_(session)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5532)()
    674             except Exception:
    675                 raise NotImplementedError("coercion of object %s to %s not implemented:\n%s\n%s" % (repr(self), I))
--> 676         X = I(s)
    677         if c:
    678             try:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    286 
    287         if isinstance(x, string_types):
--> 288             return cls(self, x, name=name)
    289         try:
    290             # Special methods do not and should not have an option to

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    708                 self._name = parent._create(value, name=name)
    709             except (TypeError, RuntimeError, ValueError) as x:
--> 710                 raise TypeError(x)
    711 
    712     def _latex_(self):

TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
```

Missing this elementary test is no small beer...

===>`needs_work`



---

archive/issue_comments_449639.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nReplying to [@mantepse](#comment%3A13):\n\n[ Snip... ]\n\n> I thought that, essentially, sagemath follows the idea that every object has a type.  So, sage actually knows the type of \"2\" within an expression.\n\nIndeed. But by converting SR(2) to QQbar(2), you lose information. Worse: \n\n```\nsage: ((pi/sqrt(2))*QQbar(sqrt(2))-pi).iz_zero()\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-29-f8bf3b60b3d2> in <module>()\n----> 1 ((pi/sqrt(Integer(2)))*QQbar(sqrt(Integer(2)))-pi).iz_zero()\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4608)()\n    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    488         \"\"\"\n--> 489         return self.getattr_from_category(name)\n    490 \n    491     cdef getattr_from_category(self, name):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4717)()\n    500         else:\n    501             cls = P._abstract_element_class\n--> 502         return getattr_from_other_class(self, cls, name)\n    503 \n    504     def __dir__(self):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)()\n    392         dummy_error_message.cls = type(self)\n    393         dummy_error_message.name = name\n--> 394         raise AttributeError(dummy_error_message)\n    395     attribute = <object>attr\n    396     # Check for a descriptor (__get__ in Python)\n\nAttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'iz_zero'\nsage: (pi/sqrt(2))*QQbar(sqrt(2))==pi\n0.7071067811865475?*sqrt(2)*pi == pi\nsage: bool((pi/sqrt(2))*QQbar(sqrt(2))==pi)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)\n    707             try:\n--> 708                 self._name = parent._create(value, name=name)\n    709             except (TypeError, RuntimeError, ValueError) as x:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _create(self, value, name)\n    605             else:\n--> 606                 self.set(name, value)\n    607         except RuntimeError as error:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in set(self, var, value)\n    514         cmd = '%s : %s$'%(var, value.rstrip(';'))\n--> 515         self.eval(cmd)\n    516 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _eval_line(self, line, locals, reformat, **kwds)\n    460                 if statement:\n--> 461                     maxima_eval(\"#$%s$\" % statement)\n    462         if not reformat:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:7779)()\n    804         \"\"\"\n--> 805         lispargs = EclObject(list(args))\n    806         return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__init__ (build/cythonized/sage/libs/ecl.c:7313)()\n    669         if len(args) != 0:\n--> 670             self.set_obj(python_to_ecl(args[0]))\n    671 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6357)()\n    484         else:\n--> 485             L=cl_cons(python_to_ecl(pyobj[0]),Cnil)\n    486             ptr=L\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6051)()\n    465         s=str_to_bytes(pyobj)\n--> 466         return ecl_safe_read_string(s)\n    467     elif isinstance(pyobj,bytes):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_read_string (build/cythonized/sage/libs/ecl.c:5530)()\n    385     o = ecl_cstring_to_base_string_or_nil(s)\n--> 386     o = ecl_safe_funcall(read_from_string_clobj,o)\n    387     return o\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5297)()\n    364         s = si_coerce_to_base_string(ecl_values(1))\n--> 365         raise RuntimeError(\"ECL says: {}\".format(\n    366             char_to_str(ecl_base_string_pointer_safe(s))))\n\nRuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n\nDuring handling of the above exception, another exception occurred:\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-31-93eb451d56f1> in <module>()\n----> 1 bool((pi/sqrt(Integer(2)))*QQbar(sqrt(Integer(2)))==pi)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19521)()\n   2918             # lot of basic Sage objects can't be put into maxima.\n   2919             from sage.symbolic.relation import test_relation_maxima\n-> 2920             return test_relation_maxima(self)\n   2921 \n   2922         self_is_zero = self._gobj.is_zero()\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/relation.py in test_relation_maxima(relation)\n    490         [k is noninteger]\n    491     \"\"\"\n--> 492     m = relation._maxima_()\n    493 \n    494     #Handle some basic cases first\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._maxima_ (build/cythonized/sage/symbolic/expression.cpp:7806)()\n    813             # Maybe not such a great idea because the \"default\" interface is another one\n    814             from sage.calculus.calculus import maxima\n--> 815             return super(Expression, self)._interface_(maxima)\n    816         else:\n    817             return super(Expression, self)._interface_(session)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5532)()\n    674             except Exception:\n    675                 raise NotImplementedError(\"coercion of object %s to %s not implemented:\\n%s\\n%s\" % (repr(self), I))\n--> 676         X = I(s)\n    677         if c:\n    678             try:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)\n    286 \n    287         if isinstance(x, string_types):\n--> 288             return cls(self, x, name=name)\n    289         try:\n    290             # Special methods do not and should not have an option to\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)\n    708                 self._name = parent._create(value, name=name)\n    709             except (TypeError, RuntimeError, ValueError) as x:\n--> 710                 raise TypeError(x)\n    711 \n    712     def _latex_(self):\n\nTypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n```\n\n> I would suggest to use this - and I think that the current interface does use this information quite a lot.\n\nBut not always wisely, as demonstrated above...\n\n> In FriCAS, every object *must* have a proper type.  There is no way you can invert a square array of integers.  (FriCAS is not very strict about itself, so you may find lots of counterexamples.)\n\nAgreed.",
    "created_at": "2019-10-22T10:55:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449639",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:16'>Comment 16:</a>
Replying to [@mantepse](#comment%3A13):

[ Snip... ]

> I thought that, essentially, sagemath follows the idea that every object has a type.  So, sage actually knows the type of "2" within an expression.

Indeed. But by converting SR(2) to QQbar(2), you lose information. Worse: 

```
sage: ((pi/sqrt(2))*QQbar(sqrt(2))-pi).iz_zero()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-29-f8bf3b60b3d2> in <module>()
----> 1 ((pi/sqrt(Integer(2)))*QQbar(sqrt(Integer(2)))-pi).iz_zero()

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4608)()
    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    488         """
--> 489         return self.getattr_from_category(name)
    490 
    491     cdef getattr_from_category(self, name):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4717)()
    500         else:
    501             cls = P._abstract_element_class
--> 502         return getattr_from_other_class(self, cls, name)
    503 
    504     def __dir__(self):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)()
    392         dummy_error_message.cls = type(self)
    393         dummy_error_message.name = name
--> 394         raise AttributeError(dummy_error_message)
    395     attribute = <object>attr
    396     # Check for a descriptor (__get__ in Python)

AttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'iz_zero'
sage: (pi/sqrt(2))*QQbar(sqrt(2))==pi
0.7071067811865475?*sqrt(2)*pi == pi
sage: bool((pi/sqrt(2))*QQbar(sqrt(2))==pi)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    707             try:
--> 708                 self._name = parent._create(value, name=name)
    709             except (TypeError, RuntimeError, ValueError) as x:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _create(self, value, name)
    605             else:
--> 606                 self.set(name, value)
    607         except RuntimeError as error:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in set(self, var, value)
    514         cmd = '%s : %s$'%(var, value.rstrip(';'))
--> 515         self.eval(cmd)
    516 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/maxima_lib.py in _eval_line(self, line, locals, reformat, **kwds)
    460                 if statement:
--> 461                     maxima_eval("#$%s$" % statement)
    462         if not reformat:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:7779)()
    804         """
--> 805         lispargs = EclObject(list(args))
    806         return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__init__ (build/cythonized/sage/libs/ecl.c:7313)()
    669         if len(args) != 0:
--> 670             self.set_obj(python_to_ecl(args[0]))
    671 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6357)()
    484         else:
--> 485             L=cl_cons(python_to_ecl(pyobj[0]),Cnil)
    486             ptr=L

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.python_to_ecl (build/cythonized/sage/libs/ecl.c:6051)()
    465         s=str_to_bytes(pyobj)
--> 466         return ecl_safe_read_string(s)
    467     elif isinstance(pyobj,bytes):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_read_string (build/cythonized/sage/libs/ecl.c:5530)()
    385     o = ecl_cstring_to_base_string_or_nil(s)
--> 386     o = ecl_safe_funcall(read_from_string_clobj,o)
    387     return o

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5297)()
    364         s = si_coerce_to_base_string(ecl_values(1))
--> 365         raise RuntimeError("ECL says: {}".format(
    366             char_to_str(ecl_base_string_pointer_safe(s))))

RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-31-93eb451d56f1> in <module>()
----> 1 bool((pi/sqrt(Integer(2)))*QQbar(sqrt(Integer(2)))==pi)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__nonzero__ (build/cythonized/sage/symbolic/expression.cpp:19521)()
   2918             # lot of basic Sage objects can't be put into maxima.
   2919             from sage.symbolic.relation import test_relation_maxima
-> 2920             return test_relation_maxima(self)
   2921 
   2922         self_is_zero = self._gobj.is_zero()

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/relation.py in test_relation_maxima(relation)
    490         [k is noninteger]
    491     """
--> 492     m = relation._maxima_()
    493 
    494     #Handle some basic cases first

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._maxima_ (build/cythonized/sage/symbolic/expression.cpp:7806)()
    813             # Maybe not such a great idea because the "default" interface is another one
    814             from sage.calculus.calculus import maxima
--> 815             return super(Expression, self)._interface_(maxima)
    816         else:
    817             return super(Expression, self)._interface_(session)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5532)()
    674             except Exception:
    675                 raise NotImplementedError("coercion of object %s to %s not implemented:\n%s\n%s" % (repr(self), I))
--> 676         X = I(s)
    677         if c:
    678             try:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    286 
    287         if isinstance(x, string_types):
--> 288             return cls(self, x, name=name)
    289         try:
    290             # Special methods do not and should not have an option to

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    708                 self._name = parent._create(value, name=name)
    709             except (TypeError, RuntimeError, ValueError) as x:
--> 710                 raise TypeError(x)
    711 
    712     def _latex_(self):

TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
```

> I would suggest to use this - and I think that the current interface does use this information quite a lot.

But not always wisely, as demonstrated above...

> In FriCAS, every object *must* have a proper type.  There is no way you can invert a square array of integers.  (FriCAS is not very strict about itself, so you may find lots of counterexamples.)

Agreed.



---

archive/issue_comments_449640.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nCould you please expand on\n\n> But by converting SR(2) to QQbar(2), you lose information.\n\nWhat information do you lose?  (Possibly, you would loose information when converting to FriCAS AlgebraicNumber, because the latter only remembers the minimal polynomial, I think.)\n\nAlso, whot is `iz_zero`?",
    "created_at": "2019-10-22T11:10:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449640",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:17'>Comment 17:</a>
Could you please expand on

> But by converting SR(2) to QQbar(2), you lose information.

What information do you lose?  (Possibly, you would loose information when converting to FriCAS AlgebraicNumber, because the latter only remembers the minimal polynomial, I think.)

Also, whot is `iz_zero`?



---

archive/issue_comments_449641.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A16):\n\nIsn't the problem with the above failures that the `SR` and `QQbar` do not interact nicely?  `((pi/sqrt(2))*QQbar(sqrt(2))-pi).is_zero()` has nothing to do with the FriCAS interface, as far as I can see.",
    "created_at": "2019-10-22T18:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449641",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@EmmanuelCharpentier](#comment%3A16):

Isn't the problem with the above failures that the `SR` and `QQbar` do not interact nicely?  `((pi/sqrt(2))*QQbar(sqrt(2))-pi).is_zero()` has nothing to do with the FriCAS interface, as far as I can see.



---

archive/issue_comments_449642.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@mantepse](#comment%3A18):\n> Replying to [@EmmanuelCharpentier](#comment%3A16):\n> \n> Isn't the problem with the above failures that the `SR` and `QQbar` do not interact nicely?\n\nYes, indeed. And that's the very reason why returning something \"that won't play nice with `SR` from a call to `integrate` (which expects *symbolic* arguments and is expected to return a *symbolic* expression) is a *really **dumb*** idea, notwithstanding the respective virtues of `SR` and `QQbar`.\n\nGot it, now ?\n \n> `((pi/sqrt(2))*QQbar(sqrt(2))-pi).is_zero()` has nothing to do with the FriCAS interface, as far as I can see.\n\nI was typing (stupidly) from (muscle) memory. My apologies. Try `bool((pi/sqrt(2))*QQbar(sqrt(2)) ==pi)` instead... or one of the previous counterexamples.\n\nThe root of the problem is that a lot of pur symbolics derive from maxima, which has nothing like `QQbar`. In fact, `maxima(QQbar(sqrt(2)))` never returns (but you can interrupt it and return to Sage's prompt).\n\nTo drive my point home once more:\n\n```\nsage: f=x*sqrt(2)\nsage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)\n....: .operands())]\n[True, True]\nsage: f=x*QQbar(sqrt(2))\nsage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)\n....: .operands())]\n[True, False]\n```\nWhatever may be the virtues of `QQbar`, this is not acceptable.",
    "created_at": "2019-10-22T18:52:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449642",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@mantepse](#comment%3A18):
> Replying to [@EmmanuelCharpentier](#comment%3A16):
> 
> Isn't the problem with the above failures that the `SR` and `QQbar` do not interact nicely?

Yes, indeed. And that's the very reason why returning something "that won't play nice with `SR` from a call to `integrate` (which expects *symbolic* arguments and is expected to return a *symbolic* expression) is a *really **dumb*** idea, notwithstanding the respective virtues of `SR` and `QQbar`.

Got it, now ?
 
> `((pi/sqrt(2))*QQbar(sqrt(2))-pi).is_zero()` has nothing to do with the FriCAS interface, as far as I can see.

I was typing (stupidly) from (muscle) memory. My apologies. Try `bool((pi/sqrt(2))*QQbar(sqrt(2)) ==pi)` instead... or one of the previous counterexamples.

The root of the problem is that a lot of pur symbolics derive from maxima, which has nothing like `QQbar`. In fact, `maxima(QQbar(sqrt(2)))` never returns (but you can interrupt it and return to Sage's prompt).

To drive my point home once more:

```
sage: f=x*sqrt(2)
sage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)
....: .operands())]
[True, True]
sage: f=x*QQbar(sqrt(2))
sage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)
....: .operands())]
[True, False]
```
Whatever may be the virtues of `QQbar`, this is not acceptable.



---

archive/issue_comments_449643.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A19):\n\n[ Snip... ]\n\nAnd, in the current state of the patch :\n\n```\nsage: f=x*sqrt(2)\nsage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)\n....: .operands())]\n[True, True]\nsage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x, algorit\n....: hm=\"fricas\").diff(x).operands())]\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-61-120730aa9cd9> in <module>()\n----> 1 [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x, algorithm=\"fricas\").diff(x).operands())]\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4608)()\n    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    488         \"\"\"\n--> 489         return self.getattr_from_category(name)\n    490 \n    491     cdef getattr_from_category(self, name):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4717)()\n    500         else:\n    501             cls = P._abstract_element_class\n--> 502         return getattr_from_other_class(self, cls, name)\n    503 \n    504     def __dir__(self):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2547)()\n    387         dummy_error_message.cls = type(self)\n    388         dummy_error_message.name = name\n--> 389         raise AttributeError(dummy_error_message)\n    390     cdef PyObject* attr = instance_getattr(cls, name)\n    391     if attr is NULL:\n\nAttributeError: 'PolynomialRing_field_with_category.element_class' object has no attribute 'operands'\n```\n\nEven less acceptable..",
    "created_at": "2019-10-22T18:58:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449643",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [@EmmanuelCharpentier](#comment%3A19):

[ Snip... ]

And, in the current state of the patch :

```
sage: f=x*sqrt(2)
sage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x).diff(x)
....: .operands())]
[True, True]
sage: [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x, algorit
....: hm="fricas").diff(x).operands())]
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-61-120730aa9cd9> in <module>()
----> 1 [w for w in map(lambda u,v:bool(u==v), f.operands(), f.integrate(x, algorithm="fricas").diff(x).operands())]

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4608)()
    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    488         """
--> 489         return self.getattr_from_category(name)
    490 
    491     cdef getattr_from_category(self, name):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4717)()
    500         else:
    501             cls = P._abstract_element_class
--> 502         return getattr_from_other_class(self, cls, name)
    503 
    504     def __dir__(self):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2547)()
    387         dummy_error_message.cls = type(self)
    388         dummy_error_message.name = name
--> 389         raise AttributeError(dummy_error_message)
    390     cdef PyObject* attr = instance_getattr(cls, name)
    391     if attr is NULL:

AttributeError: 'PolynomialRing_field_with_category.element_class' object has no attribute 'operands'
```

Even less acceptable..



---

archive/issue_comments_449644.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@EmmanuelCharpentier](#comment%3A20):\n\nIf the previeous points weren't enough, please explain this inconsistency:\n\n```\nsage: f=sqrt(2)*x\nsage: f.integrate(x, algorithm=\"fricas\").diff(x)\n1.414213562373095?*x\nsage: f=sqrt(2)*x+sin(x)\nsage: f.integrate(x, algorithm=\"fricas\").diff(x)\nsqrt(2)*x + sin(x)\n```\n\nAm I clear, now ?",
    "created_at": "2019-10-22T19:21:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449644",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@EmmanuelCharpentier](#comment%3A20):

If the previeous points weren't enough, please explain this inconsistency:

```
sage: f=sqrt(2)*x
sage: f.integrate(x, algorithm="fricas").diff(x)
1.414213562373095?*x
sage: f=sqrt(2)*x+sin(x)
sage: f.integrate(x, algorithm="fricas").diff(x)
sqrt(2)*x + sin(x)
```

Am I clear, now ?



---

archive/issue_comments_449645.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nEnglish is not my native language, but I think \"dumb idea\" is pretty clear.  Could you please tone down?\n\nApart from that: the general FriCAS interface (and thus conversion of FriCAS polynomials to sage polynomials) and the special integration interface to FriCAS are quite separate.  I agree that, when asking FriCAS to integrate something, we should send a symbolic expression - and convert it to `Expression Integer`.\n\nThat's actually what I suggested with\n\n```\nsage: fricas(\"sqrt(2)::EXPR INT\").domainOf()\nExpression(Integer())\n```",
    "created_at": "2019-10-22T22:57:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449645",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:22'>Comment 22:</a>
English is not my native language, but I think "dumb idea" is pretty clear.  Could you please tone down?

Apart from that: the general FriCAS interface (and thus conversion of FriCAS polynomials to sage polynomials) and the special integration interface to FriCAS are quite separate.  I agree that, when asking FriCAS to integrate something, we should send a symbolic expression - and convert it to `Expression Integer`.

That's actually what I suggested with

```
sage: fricas("sqrt(2)::EXPR INT").domainOf()
Expression(Integer())
```



---

archive/issue_comments_449646.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nBelow is a complementary patch, which (hopefully) makes sure that the FriCAS domain of `Symbolic Ring` objects is `Expression Integer`.\n\nThis patch does neither solve the polynomial conversion problem, nor conversion from `QQbar` to FriCAS' `AlgebraicNumber`.\n\n```diff\nindex ad2e20a..c491b44 100644\n--- a/src/sage/symbolic/expression_conversions.py\n+++ b/src/sage/symbolic/expression_conversions.py\n@@ -898,6 +898,33 @@ class FriCASConverter(InterfaceInit):\n         import sage.interfaces.fricas\n         super(FriCASConverter, self).__init__(sage.interfaces.fricas.fricas)\n \n+    def pyobject(self, ex, obj):\n+        \"\"\"\n+        EXAMPLES::\n+\n+            sage: 2._fricas_().domainOf()                                       # optional - fricas\n+            PositiveInteger()\n+\n+            sage: (-1/2)._fricas_().domainOf()                                  # optional - fricas\n+            Fraction(Integer())\n+\n+            sage: SR(2)._fricas_().domainOf()                                   # optional - fricas\n+            Expression(Integer())\n+\n+            sage: (sqrt(2))._fricas_().domainOf()                               # optional - fricas\n+            Expression(Integer())\n+        \"\"\"\n+        return \"((%s)::EXPR INT)\" % ex\n+\n+    def symbol(self, ex):\n+        \"\"\"\n+        EXAMPLES::\n+\n+            sage: x._fricas_().domainOf()                                       # optional - fricas\n+            Expression(Integer())\n+        \"\"\"\n+        return \"(%s::EXPR INT)\" % repr(ex)\n+\n     def derivative(self, ex, operator):\n         \"\"\"\n         Convert the derivative of ``self`` in FriCAS.\ndiff --git a/src/sage/symbolic/integration/external.py b/src/sage/symbolic/integration/external.py\nindex 057b113..c116536 100644\n--- a/src/sage/symbolic/integration/external.py\n+++ b/src/sage/symbolic/integration/external.py\n@@ -371,16 +371,29 @@ def fricas_integrator(expression, v, a=None, b=None, noPole=True):\n \n     Check that in case of failure one gets unevaluated integral::\n \n-        sage: integral(cos(ln(cos(x))), x, 0, pi/8, algorithm='fricas')   # optional - fricas\n+        sage: integral(cos(ln(cos(x))), x, 0, pi/8, algorithm='fricas')         # optional - fricas\n         integrate(cos(log(cos(x))), x, 0, 1/8*pi)\n-        sage: integral(cos(ln(cos(x))), x, algorithm='fricas')   # optional - fricas\n+\n+        sage: integral(cos(ln(cos(x))), x, algorithm='fricas')                  # optional - fricas\n         integral(cos(log(cos(x))), x)\n+\n+    Check that :trac:`28641` is fixed::\n+\n+        sage: integrate(sqrt(2)*x^2 + 2*x, x, algorithm=\"fricas\")               # optional - fricas\n+        1/3*sqrt(2)*x^3 + x^2\n+\n+        sage: integrate(sqrt(2), x, algorithm=\"fricas\")                         # optional - fricas\n+        sqrt(2)*x\n+\n+        sage: integrate(1, x, algorithm=\"fricas\")                               # optional - fricas\n+        x\n     \"\"\"\n     if not isinstance(expression, Expression):\n         expression = SR(expression)\n \n     from sage.interfaces.fricas import fricas\n     ex = fricas(expression)\n+    v = fricas(\"%s::Symbol\" % v)\n \n     if a is None:\n         result = ex.integrate(v)\n```",
    "created_at": "2019-10-23T13:11:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449646",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:23'>Comment 23:</a>
Below is a complementary patch, which (hopefully) makes sure that the FriCAS domain of `Symbolic Ring` objects is `Expression Integer`.

This patch does neither solve the polynomial conversion problem, nor conversion from `QQbar` to FriCAS' `AlgebraicNumber`.

```diff
index ad2e20a..c491b44 100644
--- a/src/sage/symbolic/expression_conversions.py
+++ b/src/sage/symbolic/expression_conversions.py
@@ -898,6 +898,33 @@ class FriCASConverter(InterfaceInit):
         import sage.interfaces.fricas
         super(FriCASConverter, self).__init__(sage.interfaces.fricas.fricas)
 
+    def pyobject(self, ex, obj):
+        """
+        EXAMPLES::
+
+            sage: 2._fricas_().domainOf()                                       # optional - fricas
+            PositiveInteger()
+
+            sage: (-1/2)._fricas_().domainOf()                                  # optional - fricas
+            Fraction(Integer())
+
+            sage: SR(2)._fricas_().domainOf()                                   # optional - fricas
+            Expression(Integer())
+
+            sage: (sqrt(2))._fricas_().domainOf()                               # optional - fricas
+            Expression(Integer())
+        """
+        return "((%s)::EXPR INT)" % ex
+
+    def symbol(self, ex):
+        """
+        EXAMPLES::
+
+            sage: x._fricas_().domainOf()                                       # optional - fricas
+            Expression(Integer())
+        """
+        return "(%s::EXPR INT)" % repr(ex)
+
     def derivative(self, ex, operator):
         """
         Convert the derivative of ``self`` in FriCAS.
diff --git a/src/sage/symbolic/integration/external.py b/src/sage/symbolic/integration/external.py
index 057b113..c116536 100644
--- a/src/sage/symbolic/integration/external.py
+++ b/src/sage/symbolic/integration/external.py
@@ -371,16 +371,29 @@ def fricas_integrator(expression, v, a=None, b=None, noPole=True):
 
     Check that in case of failure one gets unevaluated integral::
 
-        sage: integral(cos(ln(cos(x))), x, 0, pi/8, algorithm='fricas')   # optional - fricas
+        sage: integral(cos(ln(cos(x))), x, 0, pi/8, algorithm='fricas')         # optional - fricas
         integrate(cos(log(cos(x))), x, 0, 1/8*pi)
-        sage: integral(cos(ln(cos(x))), x, algorithm='fricas')   # optional - fricas
+
+        sage: integral(cos(ln(cos(x))), x, algorithm='fricas')                  # optional - fricas
         integral(cos(log(cos(x))), x)
+
+    Check that :trac:`28641` is fixed::
+
+        sage: integrate(sqrt(2)*x^2 + 2*x, x, algorithm="fricas")               # optional - fricas
+        1/3*sqrt(2)*x^3 + x^2
+
+        sage: integrate(sqrt(2), x, algorithm="fricas")                         # optional - fricas
+        sqrt(2)*x
+
+        sage: integrate(1, x, algorithm="fricas")                               # optional - fricas
+        x
     """
     if not isinstance(expression, Expression):
         expression = SR(expression)
 
     from sage.interfaces.fricas import fricas
     ex = fricas(expression)
+    v = fricas("%s::Symbol" % v)
 
     if a is None:
         result = ex.integrate(v)
```



---

archive/issue_comments_449647.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nping?",
    "created_at": "2019-10-24T10:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449647",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:24'>Comment 24:</a>
ping?



---

archive/issue_comments_449648.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nplease make a branch, not a patch",
    "created_at": "2019-10-24T10:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449648",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'>Comment 25:</a>
please make a branch, not a patch



---

archive/issue_comments_449649.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nOK - I'll open a separate ticket, because the branch in this ticket is (despite the problem it fixes) about polynomial conversion.",
    "created_at": "2019-10-24T10:40:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449649",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:26'>Comment 26:</a>
OK - I'll open a separate ticket, because the branch in this ticket is (despite the problem it fixes) about polynomial conversion.



---

archive/issue_comments_449650.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nPossible collision with #28647 which refers to the same ask.sagemath.org question.",
    "created_at": "2019-10-24T12:18:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449650",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<a id='comment:27'>Comment 27:</a>
Possible collision with #28647 which refers to the same ask.sagemath.org question.



---

archive/issue_comments_449651.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nTicket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449651",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'>Comment 28:</a>
Ticket retargeted after milestone closed



---

archive/issue_events_362034.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362034"
}
```



---

archive/issue_events_362035.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362035"
}
```



---

archive/issue_comments_449652.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449652",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'>Comment 29:</a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_362036.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362036"
}
```



---

archive/issue_events_362037.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362037"
}
```



---

archive/issue_events_362038.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362038"
}
```



---

archive/issue_events_362039.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362039"
}
```



---

archive/issue_comments_449653.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449653",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>Comment 31:</a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_362040.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362040"
}
```



---

archive/issue_events_362041.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362041"
}
```



---

archive/issue_events_362042.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-07-12T07:40:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362042"
}
```



---

archive/issue_events_362043.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-07-12T07:40:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362043"
}
```



---

archive/issue_events_362044.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-07-12T07:40:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362044"
}
```



---

archive/issue_comments_449654.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nmaybe we can close as duplicate ?",
    "created_at": "2021-07-12T07:40:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449654",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:32'>Comment 32:</a>
maybe we can close as duplicate ?



---

archive/issue_comments_449655.json:
```json
{
    "body": "Changed branch from **[u/chapoton/28641](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28641)** to none",
    "created_at": "2021-08-30T10:06:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449655",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/chapoton/28641](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/28641)** to none



---

archive/issue_comments_449656.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nping ? Martin, can we close ?",
    "created_at": "2021-08-30T10:06:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449656",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:33'>Comment 33:</a>
ping ? Martin, can we close ?



---

archive/issue_comments_449657.json:
```json
{
    "body": "Changed commit from **[0bf9540](https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5)** to none",
    "created_at": "2021-08-30T10:06:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449657",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[0bf9540](https://github.com/sagemath/sagetrac-mirror/commit/0bf95407d96a15022e458aea53cd861d830c3fb5)** to none



---

archive/issue_events_362045.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2021-08-30T10:46:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362045"
}
```



---

archive/issue_events_362046.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2021-08-30T10:46:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362046"
}
```



---

archive/issue_comments_449658.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nOK.",
    "created_at": "2021-08-30T10:46:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28641#issuecomment-449658",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:34'>Comment 34:</a>
OK.



---

archive/issue_events_362047.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-08-30T10:52:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362047"
}
```



---

archive/issue_events_362048.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-08-30T10:52:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28641",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28641#event-362048"
}
```
