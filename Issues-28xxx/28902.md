# Issue 28902: Cythonize hypergeometric trace formula

archive/issues_028665.json:
```json
{
    "body": "The goal of this ticket is to improve upon this comparison between Magma:\n\n```\n> H := HypergeometricData([3],[4]);\n> time EulerFactor(H, 1/2, 1000003);                                           \n1000003*$.1^2 - 788*$.1 + 1\nTime: 2.840\n> H := HypergeometricData([10],[5]);  \n> time EulerFactor(H, 1/2, 1009);\n1018081*$.1^4 + 8072*$.1^3 + 590*$.1^2 + 8*$.1 + 1\nTime: 4.890\n> H := HypergeometricData([[10,6],[5,4]]);\n> time EulerFactor(H, 1/2, 61);\n11694146092834141*$.1^6 - 14271143697997*$.1^5 - 13901224364*$.1^4 + \n    104106138*$.1^3 - 61244*$.1^2 - 277*$.1 + 1\nTime: 4.670\n```\nand Sage:\n\n```\nsage: from sage.modular.hypergeometric_motive import HypergeometricData as HG\nsage: H = HG(cyclotomic=[[3],[4]])\nsage: time H.euler_factor(2, 1000003)\nWall time: 1min 5s\n1000003*T^2 - 788*T + 1\nsage: H = HG(cyclotomic=[[10],[5]])\nsage: time H.euler_factor(2, 1009)\nWall time: 49 s\n1018081*T^4 + 8072*T^3 + 590*T^2 + 8*T + 1\nsage: H = HG(cyclotomic=[[10,6],[5,4]])\nsage: time H.euler_factor(2, 61)\nWall time: 14.8 s\n11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1\n```\nby moving two bottleneck steps into Cython.\n\n- Computing Gauss sums via the Gross-Koblitz formula, in the `gauss_table` function in `rings/padics/padic_generic_element.pyx`.\n  - We refactor Sage's implementation of the p-adic Gamma function to expose some internals as C functions.\n  - When possible, we do the p-adic computations using C longs.\n  - We short-circuit the computation when the working precision equals 1. This benefits the case of a degree-2 L-function.\n  - We enable global caching of the Gauss sums, as in Magma's `HypergeometricMotiveSaveLimit` function.\n- Computing products of Gauss sums needed for the hypergeometric trace formula, in the `hgm_coeffs` function in `modular/hypergeometric_misc.pyx`.\n  - We again use C longs when possible.\n\n\nCC:  @roed314\n\nKeywords: hypergeometric motives\n\nBranch/Commit: a7bfd25cbbbc799536da393188fe7094fe6d5d89\n\nReviewer: David Roe, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Kiran Kedlaya\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28902\n\n",
    "closed_at": "2020-01-11T17:45:04Z",
    "created_at": "2019-12-20T17:30:27Z",
    "labels": [
        "component: modular forms",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Cythonize hypergeometric trace formula",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28902",
    "user": "https://github.com/kedlaya"
}
```
The goal of this ticket is to improve upon this comparison between Magma:

```
> H := HypergeometricData([3],[4]);
> time EulerFactor(H, 1/2, 1000003);                                           
1000003*$.1^2 - 788*$.1 + 1
Time: 2.840
> H := HypergeometricData([10],[5]);  
> time EulerFactor(H, 1/2, 1009);
1018081*$.1^4 + 8072*$.1^3 + 590*$.1^2 + 8*$.1 + 1
Time: 4.890
> H := HypergeometricData([[10,6],[5,4]]);
> time EulerFactor(H, 1/2, 61);
11694146092834141*$.1^6 - 14271143697997*$.1^5 - 13901224364*$.1^4 + 
    104106138*$.1^3 - 61244*$.1^2 - 277*$.1 + 1
Time: 4.670
```
and Sage:

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as HG
sage: H = HG(cyclotomic=[[3],[4]])
sage: time H.euler_factor(2, 1000003)
Wall time: 1min 5s
1000003*T^2 - 788*T + 1
sage: H = HG(cyclotomic=[[10],[5]])
sage: time H.euler_factor(2, 1009)
Wall time: 49 s
1018081*T^4 + 8072*T^3 + 590*T^2 + 8*T + 1
sage: H = HG(cyclotomic=[[10,6],[5,4]])
sage: time H.euler_factor(2, 61)
Wall time: 14.8 s
11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1
```
by moving two bottleneck steps into Cython.

- Computing Gauss sums via the Gross-Koblitz formula, in the `gauss_table` function in `rings/padics/padic_generic_element.pyx`.
  - We refactor Sage's implementation of the p-adic Gamma function to expose some internals as C functions.
  - When possible, we do the p-adic computations using C longs.
  - We short-circuit the computation when the working precision equals 1. This benefits the case of a degree-2 L-function.
  - We enable global caching of the Gauss sums, as in Magma's `HypergeometricMotiveSaveLimit` function.
- Computing products of Gauss sums needed for the hypergeometric trace formula, in the `hgm_coeffs` function in `modular/hypergeometric_misc.pyx`.
  - We again use C longs when possible.


CC:  @roed314

Keywords: hypergeometric motives

Branch/Commit: a7bfd25cbbbc799536da393188fe7094fe6d5d89

Reviewer: David Roe, Frédéric Chapoton

Author: Kiran Kedlaya

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28902





---

archive/issue_comments_430932.json:
```json
{
    "body": "<a id='comment:2'></a>One additional change: I refined the precision bound a bit. Particularly in degree 2, it makes a substantial difference to work with one p-adic digit rather than two (the computation of p-adic Gamma scales noticeably linearly in the number of digits).\n\nTimings I recorded on this branch (same machine as before):\n\n```\nsage: from sage.modular.hypergeometric_motive import HypergeometricData as HG\nsage: H = HG(cyclotomic=[[3],[4]])\nsage: time H.euler_factor(2, 1000003)\nWall time: 13 s\n1000003*T^2 - 788*T + 1\nsage: H = HG(cyclotomic=[[10],[5]])\nsage: time H.euler_factor(2, 1009)\nWall time: 14.6 s\n1018081*T^4 + 8072*T^3 + 590*T^2 + 8*T + 1\nsage: H = HG(cyclotomic=[[10,6],[5,4]])\nsage: time H.euler_factor(2, 61)\nWall time: 4.87 s\n11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1\n```\n\n---\nNew commits:",
    "created_at": "2019-12-20T17:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430932",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>One additional change: I refined the precision bound a bit. Particularly in degree 2, it makes a substantial difference to work with one p-adic digit rather than two (the computation of p-adic Gamma scales noticeably linearly in the number of digits).

Timings I recorded on this branch (same machine as before):

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as HG
sage: H = HG(cyclotomic=[[3],[4]])
sage: time H.euler_factor(2, 1000003)
Wall time: 13 s
1000003*T^2 - 788*T + 1
sage: H = HG(cyclotomic=[[10],[5]])
sage: time H.euler_factor(2, 1009)
Wall time: 14.6 s
1018081*T^4 + 8072*T^3 + 590*T^2 + 8*T + 1
sage: H = HG(cyclotomic=[[10,6],[5,4]])
sage: time H.euler_factor(2, 61)
Wall time: 4.87 s
11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1
```

---
New commits:



---

archive/issue_comments_430933.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-21T18:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430934.json:
```json
{
    "body": "<a id='comment:4'></a>In this commit, I moved the evaluation of the Mahler series for `p`-adic Gamma into a helper cdef function; this eliminates some Python call overhead. As a bonus, I can undo the change in call syntax to `dwork_expansion` and thereby restore backward compatibility.\n\nI also made some additional optimizations in the case where the working precision is 1, as in the first of my examples.\n\nFinally, I moved the precomputation of the Mahler series into `padics/misc.py`. This seems like a step backward since that is not a Cython file, but conceptually it seemed to make sense, and it doesn't have much effect on the timings.\n\nWith this commit, the timings are down to 9.15s, 11s, 3.81s. Some cleanup and doctests still needed.",
    "created_at": "2019-12-21T18:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430934",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:4'></a>In this commit, I moved the evaluation of the Mahler series for `p`-adic Gamma into a helper cdef function; this eliminates some Python call overhead. As a bonus, I can undo the change in call syntax to `dwork_expansion` and thereby restore backward compatibility.

I also made some additional optimizations in the case where the working precision is 1, as in the first of my examples.

Finally, I moved the precomputation of the Mahler series into `padics/misc.py`. This seems like a step backward since that is not a Cython file, but conceptually it seemed to make sense, and it doesn't have much effect on the timings.

With this commit, the timings are down to 9.15s, 11s, 3.81s. Some cleanup and doctests still needed.



---

archive/issue_comments_430935.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-21T21:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430935",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430936.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-21T22:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430936",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430937.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-21T23:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430937",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430938.json:
```json
{
    "body": "<a id='comment:8'></a>This batch of commits implements a speedup to `hgm_coeffs`: it turns out that some of the coefficients are forced to be zero for combinatorial reasons, and it is helpful to order the computation so that this vanishing can be detected for an early abort. The relevance of this will vary with the hypergeometric data.\n\nFor the examples I am testing, the latest timings are 5.48s, 7.81s, 2.77s.\n\nI also added doctests to restore 100% coverage in the affected files.\n\n---\nNew commits:",
    "created_at": "2019-12-21T23:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430938",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:8'></a>This batch of commits implements a speedup to `hgm_coeffs`: it turns out that some of the coefficients are forced to be zero for combinatorial reasons, and it is helpful to order the computation so that this vanishing can be detected for an early abort. The relevance of this will vary with the hypergeometric data.

For the examples I am testing, the latest timings are 5.48s, 7.81s, 2.77s.

I also added doctests to restore 100% coverage in the affected files.

---
New commits:



---

archive/issue_comments_430939.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-22T06:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430939",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430940.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-22T23:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430940",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430941.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-23T23:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430942.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-24T02:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430942",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430943.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-25T16:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430943",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430944.json:
```json
{
    "body": "<a id='comment:15'></a>To clean things up, I squashed the preceding commits and the next one into a single commit on a new branch. Timings in the three examples are now quite comparable with Magma: 3.57s, 4.75s, 2.73s.\n\nTo test things more deeply (particularly the cacheing functionality), I reran a computation from the LMFDB: this iterates over all hypergeometric data of degree 2 through 10 and computes various Euler factors. All answers agree with Magma.\n\nAt this point I think I'm ready to put this to review.",
    "created_at": "2019-12-25T16:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430944",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:15'></a>To clean things up, I squashed the preceding commits and the next one into a single commit on a new branch. Timings in the three examples are now quite comparable with Magma: 3.57s, 4.75s, 2.73s.

To test things more deeply (particularly the cacheing functionality), I reran a computation from the LMFDB: this iterates over all hypergeometric data of degree 2 through 10 and computes various Euler factors. All answers agree with Magma.

At this point I think I'm ready to put this to review.



---

archive/issue_comments_430945.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-25T16:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430945",
    "user": "https://github.com/kedlaya"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_430946.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -32,11 +32,16 @@\n Wall time: 14.8 s\n 11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1\n \\`\\`\\`\n-by moving some bottleneck steps into Cython.\n+by moving two bottleneck steps into Cython.\n \n-- \\`dwork_expansion\\`, used to compute the p-adic Gamma function.\n-- Computing Gauss sums via the Gross-Koblitz formula. These should be cached if one is going to compute the trace formula multiple times for the same prime (Magma already provides this option).\n-- Computing the coefficients of the hypergeometric trace formula. These should be cached if one is going to fix the hypergeometric data and the prime, and loop over parameter values.\n+- Computing Gauss sums via the Gross-Koblitz formula, in the \\`gauss_table\\` function in \\`rings/padics/padic_generic_element.pyx\\`.\n+  - We refactor Sage's implementation of the p-adic Gamma function to expose some internals as C functions.\n+  - When possible, we do the p-adic computations using C longs.\n+  - We short-circuit the computation when the working precision equals 1. This benefits the case of a degree-2 L-function.\n+  - We enable global caching of the Gauss sums, as in Magma's \\`HypergeometricMotiveSaveLimit\\` function.\n+- Computing products of Gauss sums needed for the hypergeometric trace formula, in the \\`hgm_coeffs\\` function in \\`modular/hypergeometric_misc.pyx\\`.\n+  - We again use C longs when possible.\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2019-12-25T16:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430946",
    "user": "https://github.com/kedlaya"
}
```

Description changed:
```diff
--- 
+++ 
@@ -32,11 +32,16 @@
 Wall time: 14.8 s
 11694146092834141*T^6 - 14271143697997*T^5 - 13901224364*T^4 + 104106138*T^3 - 61244*T^2 - 277*T + 1
 \`\`\`
-by moving some bottleneck steps into Cython.
+by moving two bottleneck steps into Cython.
 
-- \`dwork_expansion\`, used to compute the p-adic Gamma function.
-- Computing Gauss sums via the Gross-Koblitz formula. These should be cached if one is going to compute the trace formula multiple times for the same prime (Magma already provides this option).
-- Computing the coefficients of the hypergeometric trace formula. These should be cached if one is going to fix the hypergeometric data and the prime, and loop over parameter values.
+- Computing Gauss sums via the Gross-Koblitz formula, in the \`gauss_table\` function in \`rings/padics/padic_generic_element.pyx\`.
+  - We refactor Sage's implementation of the p-adic Gamma function to expose some internals as C functions.
+  - When possible, we do the p-adic computations using C longs.
+  - We short-circuit the computation when the working precision equals 1. This benefits the case of a degree-2 L-function.
+  - We enable global caching of the Gauss sums, as in Magma's \`HypergeometricMotiveSaveLimit\` function.
+- Computing products of Gauss sums needed for the hypergeometric trace formula, in the \`hgm_coeffs\` function in \`modular/hypergeometric_misc.pyx\`.
+  - We again use C longs when possible.
+
 
 Comment: 1
 
```




---

archive/issue_comments_430947.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-27T02:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430947",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430948.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-30T17:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430948",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430949.json:
```json
{
    "body": "<a id='comment:18'></a>Some of the patchbots found a non-ASCII issue. This should fix that.",
    "created_at": "2019-12-30T17:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430949",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:18'></a>Some of the patchbots found a non-ASCII issue. This should fix that.



---

archive/issue_comments_430950.json:
```json
{
    "body": "<a id='comment:20'></a>I made a few minor changes and one somewhat substantial one (switching from a Python list to a C array of long longs, which gave a 33% speedup in the second example when I tested).  If you're happy with the changes and tests pass, I'm happy to give this ticket a positive review.\n\n---\nNew commits:",
    "created_at": "2019-12-31T08:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430950",
    "user": "https://github.com/roed314"
}
```

<a id='comment:20'></a>I made a few minor changes and one somewhat substantial one (switching from a Python list to a C array of long longs, which gave a 33% speedup in the second example when I tested).  If you're happy with the changes and tests pass, I'm happy to give this ticket a positive review.

---
New commits:



---

archive/issue_comments_430951.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-31T09:24:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430951",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430952.json:
```json
{
    "body": "<a id='comment:22'></a>looks good to me\n\nside note (no action needed) : pep8 does not require `**` to be framed with spaces, but does require that for `/` and `*`",
    "created_at": "2020-01-01T07:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430952",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:22'></a>looks good to me

side note (no action needed) : pep8 does not require `**` to be framed with spaces, but does require that for `/` and `*`



---

archive/issue_comments_430953.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-01T07:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430953",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_430954.json:
```json
{
    "body": "<a id='comment:25'></a>If we're going to use an array of long longs, I think it makes more sense to use a Python array (which is almost as efficient) so that we can send it directly from one subroutine to the other without conversion to a Python list. \n\nBesides making that change, I also found an overflow bug that I had introduced in this branch and added a doctest for it.\n\nTimings for my three examples are now 2.0s, 3.4s, 2.9s. In particular we are now beating Magma in all of these cases (though they are far from exhaustive).\n\nI also enabled the use of the long-based code when cacheing, which wasn't happening before. Not that this makes any appreciable difference when cacheing, but I wanted my LMFDB test run to stress-test this modification.\n\nPatchbots seem satisfied with the earlier versions, but maybe it's worth waiting to see some runs from this latest commit.\n\n---\nNew commits:",
    "created_at": "2020-01-01T15:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430954",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:25'></a>If we're going to use an array of long longs, I think it makes more sense to use a Python array (which is almost as efficient) so that we can send it directly from one subroutine to the other without conversion to a Python list. 

Besides making that change, I also found an overflow bug that I had introduced in this branch and added a doctest for it.

Timings for my three examples are now 2.0s, 3.4s, 2.9s. In particular we are now beating Magma in all of these cases (though they are far from exhaustive).

I also enabled the use of the long-based code when cacheing, which wasn't happening before. Not that this makes any appreciable difference when cacheing, but I wanted my LMFDB test run to stress-test this modification.

Patchbots seem satisfied with the earlier versions, but maybe it's worth waiting to see some runs from this latest commit.

---
New commits:



---

archive/issue_comments_430955.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-01-01T17:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430955",
    "user": "https://github.com/fchapoton"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_430956.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-01T18:54:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430956",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430957.json:
```json
{
    "body": "<a id='comment:28'></a>Fixed a doctest failure caught by patchbot.",
    "created_at": "2020-01-01T18:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430957",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:28'></a>Fixed a doctest failure caught by patchbot.



---

archive/issue_comments_430958.json:
```json
{
    "body": "<a id='comment:29'></a>green bot, I am setting back to positive",
    "created_at": "2020-01-01T21:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430958",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>green bot, I am setting back to positive



---

archive/issue_comments_430959.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-01T21:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430959",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_430960.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-01-04T11:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430960",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_430961.json:
```json
{
    "body": "<a id='comment:30'></a>I'm getting this on the python2 buildbot\n\n```\n**********************************************************************\nFile \"src/sage/modular/hypergeometric_misc.pyx\", line 19, in sage.modular.hypergeometric_misc.?\nFailed example:\n    H.euler_factor(2, 7, cache_p=True)\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.modular.hypergeometric_misc.?[4]>\", line 1, in <module>\n        H.euler_factor(Integer(2), Integer(7), cache_p=True)\n      File \"sage/misc/cachefunc.pyx\", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)\n        w = self._instance_call(*args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)\n        return self.f(self._instance, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modular/hypergeometric_motive.py\", line 1498, in euler_factor\n        for i in range(bound)]\n      File \"sage/misc/cachefunc.pyx\", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)\n        w = self._instance_call(*args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)\n        return self.f(self._instance, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modular/hypergeometric_motive.py\", line 1234, in padic_H_value\n        trcoeffs = hgm_coeffs(p, f, prec, gamma, m, D, gtab, use_longs)\n      File \"sage/modular/hypergeometric_misc.pyx\", line 6, in sage.modular.hypergeometric_misc.hgm_coeffs (build/cythonized/sage/modular/hypergeometric_misc.c:2809)\n        cpdef hgm_coeffs(long long p, int f, int prec, gamma, array.array m, int D,\n      File \"sage/modular/hypergeometric_misc.pyx\", line 37, in sage.modular.hypergeometric_misc.hgm_coeffs (build/cythonized/sage/modular/hypergeometric_misc.c:1674)\n        cdef array.array digit_count = array.array('Q', [0]) * q1\n    ValueError: bad typecode (must be c, b, B, u, h, H, i, I, l, L, f or d)\n```",
    "created_at": "2020-01-04T11:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430961",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>I'm getting this on the python2 buildbot

```
**********************************************************************
File "src/sage/modular/hypergeometric_misc.pyx", line 19, in sage.modular.hypergeometric_misc.?
Failed example:
    H.euler_factor(2, 7, cache_p=True)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.hypergeometric_misc.?[4]>", line 1, in <module>
        H.euler_factor(Integer(2), Integer(7), cache_p=True)
      File "sage/misc/cachefunc.pyx", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)
        return self.f(self._instance, *args, **kwds)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modular/hypergeometric_motive.py", line 1498, in euler_factor
        for i in range(bound)]
      File "sage/misc/cachefunc.pyx", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10273)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9758)
        return self.f(self._instance, *args, **kwds)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/modular/hypergeometric_motive.py", line 1234, in padic_H_value
        trcoeffs = hgm_coeffs(p, f, prec, gamma, m, D, gtab, use_longs)
      File "sage/modular/hypergeometric_misc.pyx", line 6, in sage.modular.hypergeometric_misc.hgm_coeffs (build/cythonized/sage/modular/hypergeometric_misc.c:2809)
        cpdef hgm_coeffs(long long p, int f, int prec, gamma, array.array m, int D,
      File "sage/modular/hypergeometric_misc.pyx", line 37, in sage.modular.hypergeometric_misc.hgm_coeffs (build/cythonized/sage/modular/hypergeometric_misc.c:1674)
        cdef array.array digit_count = array.array('Q', [0]) * q1
    ValueError: bad typecode (must be c, b, B, u, h, H, i, I, l, L, f or d)
```



---

archive/issue_comments_430962.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-04T17:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_430963.json:
```json
{
    "body": "<a id='comment:32'></a>Oh hmm, an array of long longs is only a Py3 thing. But I really need to be sure that I have 64-bit integers to avoid overflows in the Cython code.\n\nThe easiest thing to do is first, limit input so that `p**f < 2**32` (which is close to the practical computational limit of what we can do anyway), change the arrays to longs (which might only be 32-bit), but make sure that their entries are cast to long longs before doing arithmetic with them. Implemented in this commit; let's wait and see what the patchbots say.\n\n---\nNew commits:",
    "created_at": "2020-01-04T17:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430963",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:32'></a>Oh hmm, an array of long longs is only a Py3 thing. But I really need to be sure that I have 64-bit integers to avoid overflows in the Cython code.

The easiest thing to do is first, limit input so that `p**f < 2**32` (which is close to the practical computational limit of what we can do anyway), change the arrays to longs (which might only be 32-bit), but make sure that their entries are cast to long longs before doing arithmetic with them. Implemented in this commit; let's wait and see what the patchbots say.

---
New commits:



---

archive/issue_comments_430964.json:
```json
{
    "body": "<a id='comment:33'></a>Patchbot seem satisfied. Now let's see whether the Py2 buildbot is too.",
    "created_at": "2020-01-05T20:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430964",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:33'></a>Patchbot seem satisfied. Now let's see whether the Py2 buildbot is too.



---

archive/issue_comments_430965.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-01-06T07:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430965",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_430966.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-11T17:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-430966",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073136.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-11T17:45:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28902#event-73136"
}
```
