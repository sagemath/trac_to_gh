# Issue 28021: Fork errors in sage.misc.cython doctests

archive/issues_028021.json:
```json
{
    "body": "Assignee: @embray\n\nI've seen fork-related problems in the tests of this module before, although this is the first time it's come up again in a while.\n\nThey seem to occur because the temporarily generated DLL modules output by `cython()` can end up in an address space that overlaps with some other modules, and then any subsequent `fork()` will fail.\n\nThe problem tends to manifest itself, in the test failures, in the form of an error like:\n\n```\nEnvironmentError: pkg-config is probably not installed. Could not run pkg-config: OSError(11, 'Resource temporarily unavailable')\n```\n\nThis is because Python is trying to `fork()` to run the `pkg-config` program, and that fails.  The problem isn't really anything to do with `pkg-config` itself.\n\nTwo strange observations:\n\n* It works *most of the time* if I run \n  {{{\n  ./sage -t --serial --long src/sage/misc/cython.py\n  }}}\n  Which means the tests are not running from a forked process to begin with.  It's still strange though, because running `pkg-config` in the tests still means `fork()` is being called during the serial test run, and not failing.\n\n* It works *some of the time*, or sometimes with at least fewer failures, if I run:\n  {{{\n  ./sage -t --verbose --long src/sage/misc/cython.py\n  }}}\n  This implies to me that there might be some kind of race condition involved, since merely running with the verbose output seems to decrease the chances of failure.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28258\n\n",
    "closed_at": "2019-12-04T22:43:42Z",
    "created_at": "2019-07-25T10:52:01Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Fork errors in sage.misc.cython doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28021",
    "user": "https://github.com/embray"
}
```
Assignee: @embray

I've seen fork-related problems in the tests of this module before, although this is the first time it's come up again in a while.

They seem to occur because the temporarily generated DLL modules output by `cython()` can end up in an address space that overlaps with some other modules, and then any subsequent `fork()` will fail.

The problem tends to manifest itself, in the test failures, in the form of an error like:

```
EnvironmentError: pkg-config is probably not installed. Could not run pkg-config: OSError(11, 'Resource temporarily unavailable')
```

This is because Python is trying to `fork()` to run the `pkg-config` program, and that fails.  The problem isn't really anything to do with `pkg-config` itself.

Two strange observations:

* It works *most of the time* if I run 
  {{{
  ./sage -t --serial --long src/sage/misc/cython.py
  }}}
  Which means the tests are not running from a forked process to begin with.  It's still strange though, because running `pkg-config` in the tests still means `fork()` is being called during the serial test run, and not failing.

* It works *some of the time*, or sometimes with at least fewer failures, if I run:
  {{{
  ./sage -t --verbose --long src/sage/misc/cython.py
  }}}
  This implies to me that there might be some kind of race condition involved, since merely running with the verbose output seems to decrease the chances of failure.

Issue created by migration from https://trac.sagemath.org/ticket/28258





---

archive/issue_comments_395646.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-07-25T10:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395646",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_395647.json:
```json
{
    "body": "Tangent: why is `--serial` not listed in the options when I run `sage -t -h`? Are there other undocumented Sage doctesting options?",
    "created_at": "2019-07-25T18:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395647",
    "user": "https://github.com/jhpalmieri"
}
```

Tangent: why is `--serial` not listed in the options when I run `sage -t -h`? Are there other undocumented Sage doctesting options?



---

archive/issue_events_070377.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-11-13T17:08:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28021#event-70377"
}
```



---

archive/issue_comments_395648.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2019-11-13T17:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395648",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_395649.json:
```json
{
    "body": "I've been seeing this more and more lately--perhaps something about changes to `rebase` (of which I know there have been some lately), or some other DLLs in the Cygwin distribution--but it's now quite frequent that the DLLs generated at runtime by `cython()` are based, by default, in such a way that they overlap.  So when `fork()` is  called (especially probable in many of the tests where `cython()` is used), it crashes.",
    "created_at": "2019-11-13T17:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395649",
    "user": "https://github.com/embray"
}
```

I've been seeing this more and more lately--perhaps something about changes to `rebase` (of which I know there have been some lately), or some other DLLs in the Cygwin distribution--but it's now quite frequent that the DLLs generated at runtime by `cython()` are based, by default, in such a way that they overlap.  So when `fork()` is  called (especially probable in many of the tests where `cython()` is used), it crashes.



---

archive/issue_comments_395650.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-13T17:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395650",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_395651.json:
```json
{
    "body": "The attached branch fixes the problem to my satisfaction.  It can never be fully \"fixed\" as what we're dealing with here is a fundamental limitation of !Windows/Cygwin.  But we can *mitigate* the problem and this does so well.  See the commit message for more details.\n\n---\nNew commits:",
    "created_at": "2019-11-13T17:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395651",
    "user": "https://github.com/embray"
}
```

The attached branch fixes the problem to my satisfaction.  It can never be fully "fixed" as what we're dealing with here is a fundamental limitation of !Windows/Cygwin.  But we can *mitigate* the problem and this does so well.  See the commit message for more details.

---
New commits:



---

archive/issue_comments_395652.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-02T18:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395652",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_395653.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-04T22:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28021#issuecomment-395653",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070378.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-04T22:43:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28021#event-70378"
}
```
