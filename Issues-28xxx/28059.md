# Issue 28059: Some citations are missing from pdf docs

archive/issues_027822.json:
```json
{
    "assignees": [],
    "body": "As reported in https://github.com/cschwan/sage-on-gentoo/issues/543\nin 8.8.rc3 some citations are in missing in the generated pdf documentation. A clear example is en/reference/tensor_free_modules/tensor_free_modules.pdf\nwhere there are citations missing on the first page of chapter one.\n\nCC:  @strogdon\n\nBranch/Commit: **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nAuthor: **John Palmieri**\n\nComponent: **documentation**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28059_\n\n",
    "closed_at": "2019-09-17T22:26:00Z",
    "created_at": "2019-06-26T03:15:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Some citations are missing from pdf docs",
    "type": "issue",
    "updated_at": "2019-09-17T22:26:00Z",
    "url": "https://github.com/sagemath/sage/issues/28059",
    "user": "https://github.com/kiwifb"
}
```
As reported in https://github.com/cschwan/sage-on-gentoo/issues/543
in 8.8.rc3 some citations are in missing in the generated pdf documentation. A clear example is en/reference/tensor_free_modules/tensor_free_modules.pdf
where there are citations missing on the first page of chapter one.

CC:  @strogdon

Branch/Commit: **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**

Reviewer: **Fran√ßois Bissey**

Author: **John Palmieri**

Component: **documentation**

_Issue created by migration from https://trac.sagemath.org/ticket/28059_





---

archive/issue_events_384750.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-06-26T03:15:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384750"
}
```



---

archive/issue_events_384751.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-06-26T03:15:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384751"
}
```



---

archive/issue_events_384752.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-06-26T03:15:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384752"
}
```



---

archive/issue_events_384753.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-06-26T03:15:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384753"
}
```



---

archive/issue_comments_436604.json:
```json
{
    "body": "Attachment: **[citations.png](https://github.com/sagemath/sage/files/ticket28059/citations.png)**",
    "created_at": "2019-06-26T03:55:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436604",
    "user": "https://github.com/kiwifb"
}
```

Attachment: **[citations.png](https://github.com/sagemath/sage/files/ticket28059/citations.png)**



---

archive/issue_comments_436605.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nExample \n\n![](https://github.com/sagemath/sage/files/ticket28059/citations.png)",
    "created_at": "2019-06-26T04:05:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436605",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:1" align="right">comment:1</div>

Example 

![](https://github.com/sagemath/sage/files/ticket28059/citations.png)



---

archive/issue_comments_436606.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.",
    "created_at": "2019-06-26T06:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436606",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.



---

archive/issue_comments_436607.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\njust to be sure, the same in python2 and python3 ?",
    "created_at": "2019-06-26T06:58:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436607",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:3" align="right">comment:3</div>

just to be sure, the same in python2 and python3 ?



---

archive/issue_comments_436608.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nYes, I suspect the sphinx upgrade had something to do with it. That's the most likely. \n\nPython2 vs python3: I haven't tried yet with python3. I am a bit busy and my first port of call was eliminating texlive2017 vs texlive2019.",
    "created_at": "2019-06-26T08:19:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436608",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:4" align="right">comment:4</div>

Yes, I suspect the sphinx upgrade had something to do with it. That's the most likely. 

Python2 vs python3: I haven't tried yet with python3. I am a bit busy and my first port of call was eliminating texlive2017 vs texlive2019.



---

archive/issue_comments_436609.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI have also noticed that \"proper\" in-file `REFERENCES:` sections such as\n\n```\nREFERENCES:\n\n.. [BvL84] \\A. Brouwer, J. van Lint,\n   Strongly regular graphs and partial geometries,\n   Enumeration and design,\n   (Waterloo, Ont., 1982) (1984): 85-122.\n   http://oai.cwi.nl/oai/asset/1817/1817A.pdf\n```\nin `graphs/strongly_regular_db.pyx` come out as just `REFERENCES:`, without any content.\nOn the other hand, \"improper\" (to be fixed, I suppose) in-file references such as\n\n```\n        REFERENCES:\n\n        - [1] http://mathworld.wolfram.com/MatrixTreeTheorem.html\n\n        - [2] Lih-Hsing Hsu, Cheng-Kuan Lin, \"Graph Theory and\n          Interconnection Networks\"\n```\nin graphs/generic_graph.py\ndo come out with the proper content.",
    "created_at": "2019-06-26T09:24:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436609",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

I have also noticed that "proper" in-file `REFERENCES:` sections such as

```
REFERENCES:

.. [BvL84] \A. Brouwer, J. van Lint,
   Strongly regular graphs and partial geometries,
   Enumeration and design,
   (Waterloo, Ont., 1982) (1984): 85-122.
   http://oai.cwi.nl/oai/asset/1817/1817A.pdf
```
in `graphs/strongly_regular_db.pyx` come out as just `REFERENCES:`, without any content.
On the other hand, "improper" (to be fixed, I suppose) in-file references such as

```
        REFERENCES:

        - [1] http://mathworld.wolfram.com/MatrixTreeTheorem.html

        - [2] Lih-Hsing Hsu, Cheng-Kuan Lin, "Graph Theory and
          Interconnection Networks"
```
in graphs/generic_graph.py
do come out with the proper content.



---

archive/issue_comments_436610.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jhpalmieri](#comment:2):\n> I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.\n\nI confirm: with Sage 8.7, running \n\n```\n./sage -docbuild reference/tensor_free_modules pdf\n```\nyields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.",
    "created_at": "2019-06-26T14:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436610",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jhpalmieri](#comment:2):
> I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.

I confirm: with Sage 8.7, running 

```
./sage -docbuild reference/tensor_free_modules pdf
```
yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.



---

archive/issue_comments_436611.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@egourgoulhon](#comment:6):\n> Replying to [@jhpalmieri](#comment:2):\n> > I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.\n\n> \n> I confirm: with Sage 8.7, running \n> \n> ```\n> ./sage -docbuild reference/tensor_free_modules pdf\n> ```\n> yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.\n\nThe Sphinx upgrade was added in 8.8.beta1",
    "created_at": "2019-06-26T14:24:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436611",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@egourgoulhon](#comment:6):
> Replying to [@jhpalmieri](#comment:2):
> > I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.

> 
> I confirm: with Sage 8.7, running 
> 
> ```
> ./sage -docbuild reference/tensor_free_modules pdf
> ```
> yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.

The Sphinx upgrade was added in 8.8.beta1



---

archive/issue_comments_436612.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI'm adding the branch of #26451 to 8.7 and will try to compare LaTeX files generated by 8.7 with the one from the update.",
    "created_at": "2019-06-26T15:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436612",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

I'm adding the branch of #26451 to 8.7 and will try to compare LaTeX files generated by 8.7 with the one from the update.



---

archive/issue_comments_436613.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\noops, the problem is that 8.7 doesn't keep generated LaTeX files :-(\n\nSo the question is how to make them persist in 8.7.",
    "created_at": "2019-06-26T15:18:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436613",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">comment:9</div>

oops, the problem is that 8.7 doesn't keep generated LaTeX files :-(

So the question is how to make them persist in 8.7.



---

archive/issue_comments_436614.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI see lots of files in `local/share/doc/sage/latex/...`, for example `latex/en/reference/algebras/algebras.tex`. If you don't, maybe try `sage --docbuild reference latex`?",
    "created_at": "2019-06-26T15:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436614",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

I see lots of files in `local/share/doc/sage/latex/...`, for example `latex/en/reference/algebras/algebras.tex`. If you don't, maybe try `sage --docbuild reference latex`?



---

archive/issue_comments_436615.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAre there actually active references in the Sage 8.7 pdf files? I don't see the question marks, but instead I just see plain text, not a link to a reference file or to references elsewhere in the same file. So maybe the new Sphinx is actually trying to resolve the links when the old one wasn't, and we have to figure out how to tell it where to find them.",
    "created_at": "2019-06-26T15:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436615",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

Are there actually active references in the Sage 8.7 pdf files? I don't see the question marks, but instead I just see plain text, not a link to a reference file or to references elsewhere in the same file. So maybe the new Sphinx is actually trying to resolve the links when the old one wasn't, and we have to figure out how to tell it where to find them.



---

archive/issue_comments_436616.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nafter the sphinx update, one sees lots of\n\n```\nLaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in\nput line 605.\n```\n\n(one would rather have it getting `../references/references:lee2011')\n\nProbably `index` comes from it being generated from `index.rst`.",
    "created_at": "2019-06-26T16:19:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436616",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:12" align="right">comment:12</div>

after the sphinx update, one sees lots of

```
LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in
put line 605.
```

(one would rather have it getting `../references/references:lee2011')

Probably `index` comes from it being generated from `index.rst`.



---

archive/issue_comments_436617.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@dimpase](#comment:12):\n> after the sphinx update, one sees lots of\n> \n> ```\n> LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in\n> put line 605.\n> ```\n> \n> (one would rather have it getting `../references/references:lee2011')\n> \n> Probably `index` comes from it being generated from `index.rst`.\n\n>\n\nBut the sphinx generated file `latex/en/reference/references/references.tex` has the bibitem\n\n```\n\\bibitem[Lee2011]{index:lee2011}\nJ. M. Lee, \\sphinxstyleemphasis{Introduction to Topological Manifolds}, 2nd ed.,\nSpringer (New York) (2011); \\sphinxhref{https://doi.org/10.1007/978-1-4419-7940-7}{doi:10.1007/978-1-4419-7940-7}\n```\nWould things work if index were change to references?",
    "created_at": "2019-06-26T16:50:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436617",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@dimpase](#comment:12):
> after the sphinx update, one sees lots of
> 
> ```
> LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in
> put line 605.
> ```
> 
> (one would rather have it getting `../references/references:lee2011')
> 
> Probably `index` comes from it being generated from `index.rst`.

>

But the sphinx generated file `latex/en/reference/references/references.tex` has the bibitem

```
\bibitem[Lee2011]{index:lee2011}
J. M. Lee, \sphinxstyleemphasis{Introduction to Topological Manifolds}, 2nd ed.,
Springer (New York) (2011); \sphinxhref{https://doi.org/10.1007/978-1-4419-7940-7}{doi:10.1007/978-1-4419-7940-7}
```
Would things work if index were change to references?



---

archive/issue_comments_436618.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nthey are hooked up via `\\sphinxcite`, which is an alias to `\\cite`. Which is meant to hook up citations from a bibfile, not from a (La)TeX file.\n\nMoreover, `\\sphinxcite` is supposed to be only introduced in sphinx 1.8.3, whereas we already used it in sphinx 1.7.3, for some reason...",
    "created_at": "2019-06-26T17:48:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436618",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:14" align="right">comment:14</div>

they are hooked up via `\sphinxcite`, which is an alias to `\cite`. Which is meant to hook up citations from a bibfile, not from a (La)TeX file.

Moreover, `\sphinxcite` is supposed to be only introduced in sphinx 1.8.3, whereas we already used it in sphinx 1.7.3, for some reason...



---

archive/issue_comments_436619.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nIt appears that `\\sphinxcite` is just an alias to `\\cite`, and thus its argument is treated in a normal way, i.e. one would need \n`\\bibitem[Lee2011]{index:lee2011}` to become \n\n`\\bibitem[Lee2011]{../references/index:lee2011}` \n\nin addition to the knowledge about the location of this `bibitem` to be properly passed.\n(something what in \"normal\" latex would be in a parameter to `\\bibliography{}`.\n\nhttps://tex.stackexchange.com/questions/497566/meaning-of-cite-foo-barbaz-in-sphinx-generated-latex",
    "created_at": "2019-06-26T18:59:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436619",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

It appears that `\sphinxcite` is just an alias to `\cite`, and thus its argument is treated in a normal way, i.e. one would need 
`\bibitem[Lee2011]{index:lee2011}` to become 

`\bibitem[Lee2011]{../references/index:lee2011}` 

in addition to the knowledge about the location of this `bibitem` to be properly passed.
(something what in "normal" latex would be in a parameter to `\bibliography{}`.

https://tex.stackexchange.com/questions/497566/meaning-of-cite-foo-barbaz-in-sphinx-generated-latex



---

archive/issue_comments_436620.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n\n```\n\\usepackage{xcite}\n\\usepackage{xr-hyper}\n\\externaldocument{../references/references}\n\\externalcitedocument{../references/references}\n\\usepackage{sphinx}\n```\nDelete all of the `../references/` from the `\\sphinxcite{}` entries. After the deletions there should only be items like\n\n```\n\\sphinxcite{index:god1968}\n\\sphinxcite{index:lan2002}\n ...\n```\nNow rebuild `tensor_free_modules.pdf`. Here all the labels appear after the citations in `tensor_free_modules.pdf`. I believe for this to work the stuff under `../references/` must be built. One caveat is that I see \n\n```\nLaTeX Warning: There were multiply-defined labels.\n```\nin the .log file but the citations in the pdf are in place.",
    "created_at": "2019-06-26T19:14:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436620",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:16" align="right">comment:16</div>

I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.

```
\usepackage{xcite}
\usepackage{xr-hyper}
\externaldocument{../references/references}
\externalcitedocument{../references/references}
\usepackage{sphinx}
```
Delete all of the `../references/` from the `\sphinxcite{}` entries. After the deletions there should only be items like

```
\sphinxcite{index:god1968}
\sphinxcite{index:lan2002}
 ...
```
Now rebuild `tensor_free_modules.pdf`. Here all the labels appear after the citations in `tensor_free_modules.pdf`. I believe for this to work the stuff under `../references/` must be built. One caveat is that I see 

```
LaTeX Warning: There were multiply-defined labels.
```
in the .log file but the citations in the pdf are in place.



---

archive/issue_comments_436621.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThis would be a stopgap, but if we just want to reproduce the output from Sage 8.7, we need `\\sphinxcite{../references/index:mil1958}` to return the plain text `[Mil1958]`.\n\n(This should only be done for the reference manual. As far as I can tell, references/citations work well in old and new Sage in the other parts of the documentation.)",
    "created_at": "2019-06-26T21:46:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436621",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

This would be a stopgap, but if we just want to reproduce the output from Sage 8.7, we need `\sphinxcite{../references/index:mil1958}` to return the plain text `[Mil1958]`.

(This should only be done for the reference manual. As far as I can tell, references/citations work well in old and new Sage in the other parts of the documentation.)



---

archive/issue_comments_436622.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@strogdon](#comment:16):\n> I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n> \n> ```\n> \\usepackage{xcite}\n> \\usepackage{xr-hyper}\n> \\externaldocument{../references/references}\n> \\externalcitedocument{../references/references}\n> \\usepackage{sphinx}\n> ```\n\nI think you can modify this and not do any changes in the `sphinxcite{...}` commands:\n\n```\n\\usepackage{xcite}\n\\usepackage{xr-hyper}\n\\externaldocument[../references/]{../references/references}\n\\externalcitedocument[../references/]{../references/references}\n% These lines must appear before \\usepackage{hyperref}.\n```\nThese commands take an optional argument which specifies the prefix used in their citations. Then `\\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?\n\nMaybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?",
    "created_at": "2019-06-26T22:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436622",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@strogdon](#comment:16):
> I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.
> 
> ```
> \usepackage{xcite}
> \usepackage{xr-hyper}
> \externaldocument{../references/references}
> \externalcitedocument{../references/references}
> \usepackage{sphinx}
> ```

I think you can modify this and not do any changes in the `sphinxcite{...}` commands:

```
\usepackage{xcite}
\usepackage{xr-hyper}
\externaldocument[../references/]{../references/references}
\externalcitedocument[../references/]{../references/references}
% These lines must appear before \usepackage{hyperref}.
```
These commands take an optional argument which specifies the prefix used in their citations. Then `\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?

Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?



---

archive/issue_comments_436623.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI think this accomplishes @strogdon's suggestion:\n\n```diff\ndiff --git a/src/doc/en/reference/conf_sub.py b/src/doc/en/reference/conf_sub.py\nindex 76f6e12909..9344260f61 100644\n--- a/src/doc/en/reference/conf_sub.py\n+++ b/src/doc/en/reference/conf_sub.py\n@@ -63,6 +63,18 @@ latex_documents = [\n ('index', name + '.tex', project, u'The Sage Development Team', 'manual')\n ]\n \n+latex_elements['hyperref'] = r\"\"\"\n+\\usepackage{xcite}\n+\\usepackage{xr-hyper}\n+\\externaldocument[../references/]{../references/references}\n+\\externalcitedocument[../references/]{../references/references}\n+% Include hyperref last.\n+\\usepackage{hyperref}\n+% Fix anchor placement for figures with captions.\n+\\usepackage{hypcap}% it must be loaded after hyperref.\n+% Set up styles of URL: it should be placed after hyperref.\n+\\urlstyle{same}\"\"\"\n+\n #Ignore all .rst in the _sage subdirectory\n exclude_patterns = exclude_patterns + ['_sage']\n \n```\nby putting the commands in the preamble of each component of the reference manual, along with the appropriate prefix for each citation. (The extra lines come from Sphinx's default setting for the `hyperref` entry for `latex_elements`. We can't just put the proposed lines in `latex_elements['preamble']`, because that gets inserted after `\\usepackage{hyperref}`, whereas these lines must come before `\\usepackage{hyperref}`.)\n\nThis does not provide live links, though.",
    "created_at": "2019-06-26T22:55:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436623",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

I think this accomplishes @strogdon's suggestion:

```diff
diff --git a/src/doc/en/reference/conf_sub.py b/src/doc/en/reference/conf_sub.py
index 76f6e12909..9344260f61 100644
--- a/src/doc/en/reference/conf_sub.py
+++ b/src/doc/en/reference/conf_sub.py
@@ -63,6 +63,18 @@ latex_documents = [
 ('index', name + '.tex', project, u'The Sage Development Team', 'manual')
 ]
 
+latex_elements['hyperref'] = r"""
+\usepackage{xcite}
+\usepackage{xr-hyper}
+\externaldocument[../references/]{../references/references}
+\externalcitedocument[../references/]{../references/references}
+% Include hyperref last.
+\usepackage{hyperref}
+% Fix anchor placement for figures with captions.
+\usepackage{hypcap}% it must be loaded after hyperref.
+% Set up styles of URL: it should be placed after hyperref.
+\urlstyle{same}"""
+
 #Ignore all .rst in the _sage subdirectory
 exclude_patterns = exclude_patterns + ['_sage']
 
```
by putting the commands in the preamble of each component of the reference manual, along with the appropriate prefix for each citation. (The extra lines come from Sphinx's default setting for the `hyperref` entry for `latex_elements`. We can't just put the proposed lines in `latex_elements['preamble']`, because that gets inserted after `\usepackage{hyperref}`, whereas these lines must come before `\usepackage{hyperref}`.)

This does not provide live links, though.



---

archive/issue_comments_436624.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jhpalmieri](#comment:18):\n> Replying to [@strogdon](#comment:16):\n> > I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n> > \n> > ```\n> > \\usepackage{xcite}\n> > \\usepackage{xr-hyper}\n> > \\externaldocument{../references/references}\n> > \\externalcitedocument{../references/references}\n> > \\usepackage{sphinx}\n> > ```\n\n> \n> I think you can modify this and not do any changes in the `sphinxcite{...}` commands:\n> \n> ```\n> \\usepackage{xcite}\n> \\usepackage{xr-hyper}\n> \\externaldocument[../references/]{../references/references}\n> \\externalcitedocument[../references/]{../references/references}\n> % These lines must appear before \\usepackage{hyperref}.\n> ```\n> These commands take an optional argument which specifies the prefix used in their citations. Then `\\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?\n> \n> Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?\n\nExcellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info. I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?",
    "created_at": "2019-06-26T22:56:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436624",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jhpalmieri](#comment:18):
> Replying to [@strogdon](#comment:16):
> > I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.
> > 
> > ```
> > \usepackage{xcite}
> > \usepackage{xr-hyper}
> > \externaldocument{../references/references}
> > \externalcitedocument{../references/references}
> > \usepackage{sphinx}
> > ```

> 
> I think you can modify this and not do any changes in the `sphinxcite{...}` commands:
> 
> ```
> \usepackage{xcite}
> \usepackage{xr-hyper}
> \externaldocument[../references/]{../references/references}
> \externalcitedocument[../references/]{../references/references}
> % These lines must appear before \usepackage{hyperref}.
> ```
> These commands take an optional argument which specifies the prefix used in their citations. Then `\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?
> 
> Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?

Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info. I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?



---

archive/issue_comments_436625.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@strogdon](#comment:20):\n> Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info.\n\nThat file will contain the list of citations, but not actual authors, titles, etc.\n\n> I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?\n\nThe diff in [comment:19](#comment:19) should insert those lines into each LaTeX file.",
    "created_at": "2019-06-27T02:12:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436625",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@strogdon](#comment:20):
> Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info.

That file will contain the list of citations, but not actual authors, titles, etc.

> I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?

The diff in [comment:19](#comment:19) should insert those lines into each LaTeX file.



---

archive/issue_comments_436626.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@jhpalmieri](#comment:21):\n> The diff in [comment:19](#comment:19) should insert those lines into each LaTeX file.\n\nI've tried this and it does work.",
    "created_at": "2019-06-27T02:45:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436626",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@jhpalmieri](#comment:21):
> The diff in [comment:19](#comment:19) should insert those lines into each LaTeX file.

I've tried this and it does work.



---

archive/issue_comments_436627.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nwhat I don\u2019t understand is why we don\u2019t get proper hyperlinks in pdf this way.\n\nnormally pdflatex would create them from \\cite macros  used with \\hyperref package.",
    "created_at": "2019-06-27T06:07:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436627",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">comment:23</div>

what I don‚Äôt understand is why we don‚Äôt get proper hyperlinks in pdf this way.

normally pdflatex would create them from \cite macros  used with \hyperref package.



---

archive/issue_comments_436628.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@dimpase](#comment:23):\n> what I don\u2019t understand is why we don\u2019t get proper hyperlinks in pdf this way.\n> \n> normally pdflatex would create them from \\cite macros  used with \\hyperref package.\n\nI think this is because the citation is in one pdf and the actual bibliographic entry is in another pdf. I don't know if \\hyperref can be made to work across pdf files.",
    "created_at": "2019-06-27T14:37:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436628",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@dimpase](#comment:23):
> what I don‚Äôt understand is why we don‚Äôt get proper hyperlinks in pdf this way.
> 
> normally pdflatex would create them from \cite macros  used with \hyperref package.

I think this is because the citation is in one pdf and the actual bibliographic entry is in another pdf. I don't know if \hyperref can be made to work across pdf files.



---

archive/issue_comments_436629.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nhyperref can work across files, with `\\ref` etc, but not with `\\cite`, for some reason.",
    "created_at": "2019-06-27T16:05:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436629",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:25" align="right">comment:25</div>

hyperref can work across files, with `\ref` etc, but not with `\cite`, for some reason.



---

archive/issue_comments_436630.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nBy the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. \n\n```\nLatexmk: Log file says output to 'combinat.pdf'\nLatexmk: List of undefined refs and citations:\n  Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570\n  Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570\n  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550\n  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839\n  Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131\n  Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455\nLatexmk: Summary of warnings from last run of (pdf)latex:\n  Latex failed to resolve 1 reference(s)\n  Latex failed to resolve 5 citation(s)\n=== TeX engine is 'pdfTeX'\n```\nI think this is to be expected, given the proposed solution. The long term fix is #27497.",
    "created_at": "2019-06-27T17:01:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436630",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. 

```
Latexmk: Log file says output to 'combinat.pdf'
Latexmk: List of undefined refs and citations:
  Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570
  Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570
  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550
  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839
  Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131
  Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455
Latexmk: Summary of warnings from last run of (pdf)latex:
  Latex failed to resolve 1 reference(s)
  Latex failed to resolve 5 citation(s)
=== TeX engine is 'pdfTeX'
```
I think this is to be expected, given the proposed solution. The long term fix is #27497.



---

archive/issue_comments_436631.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nA untested shorter term fix is to add more `\\externalcitedocument[...]{...}` commands.",
    "created_at": "2019-06-27T17:02:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436631",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

A untested shorter term fix is to add more `\externalcitedocument[...]{...}` commands.



---

archive/issue_comments_436632.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nIt's probably best to go with #27497 - it's the easiest.\nI also think we should indeed convert the thing to bibtex \n\n(who was the genius who thought that free from meta-information format for citations is OK :-))",
    "created_at": "2019-06-27T17:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436632",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

It's probably best to go with #27497 - it's the easiest.
I also think we should indeed convert the thing to bibtex 

(who was the genius who thought that free from meta-information format for citations is OK :-))



---

archive/issue_comments_436633.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@jhpalmieri](#comment:27):\n> A untested shorter term fix is to add more `\\externalcitedocument[...]{...}` commands.\n\nI think a problem with this is that combinat.tex will want to access graphs.aux, which won't be ready until graphs.tex is compiled, while graphs.tex will want to access combinat.aux. So there is no good order to process these.\n\nRegarding #27497: it's going to be a lot tedious work to do this (speaking from experience, since I have moved most of Sage's other references to the master bibliography file). I don't want to do it. Fortunately, for the purposes of this ticket, we only need to move a few references: the ones in combinat that are used elsewhere and the ones in graphs that are used elsewhere.\n\nConverting to bibtex will also be a lot of work. A program like [bibweb](https://github.com/jhpalmieri/bibweb) might help a bit, but who wants to convert all of the current references to bibtex format? I'm certainly not going to stand in anyone's way, but the task is almost too tedious to even consider.\n\nOh, there is also [sphinxcontrib-bibtex](https://pypi.org/project/sphinxcontrib-bibtex/), but note [this issue](https://sphinxcontrib-bibtex.readthedocs.io/en/latest/usage.html#unresolved-citations-across-documents).",
    "created_at": "2019-06-27T17:29:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436633",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@jhpalmieri](#comment:27):
> A untested shorter term fix is to add more `\externalcitedocument[...]{...}` commands.

I think a problem with this is that combinat.tex will want to access graphs.aux, which won't be ready until graphs.tex is compiled, while graphs.tex will want to access combinat.aux. So there is no good order to process these.

Regarding #27497: it's going to be a lot tedious work to do this (speaking from experience, since I have moved most of Sage's other references to the master bibliography file). I don't want to do it. Fortunately, for the purposes of this ticket, we only need to move a few references: the ones in combinat that are used elsewhere and the ones in graphs that are used elsewhere.

Converting to bibtex will also be a lot of work. A program like [bibweb](https://github.com/jhpalmieri/bibweb) might help a bit, but who wants to convert all of the current references to bibtex format? I'm certainly not going to stand in anyone's way, but the task is almost too tedious to even consider.

Oh, there is also [sphinxcontrib-bibtex](https://pypi.org/project/sphinxcontrib-bibtex/), but note [this issue](https://sphinxcontrib-bibtex.readthedocs.io/en/latest/usage.html#unresolved-citations-across-documents).



---

archive/issue_comments_436634.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jhpalmieri](#comment:26):\n> By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. \n> \n> ```\n> Latexmk: Log file says output to 'combinat.pdf'\n> Latexmk: List of undefined refs and citations:\n>   Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570\n>   Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570\n>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550\n>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839\n>   Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131\n>   Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455\n> Latexmk: Summary of warnings from last run of (pdf)latex:\n>   Latex failed to resolve 1 reference(s)\n>   Latex failed to resolve 5 citation(s)\n> === TeX engine is 'pdfTeX'\n> ```\n> I think this is to be expected, given the proposed solution. The long term fix is #27497.\n\nOn a sage-on-gentoo build I see things like\n\n```\n(/usr/share/texmf-dist/tex/latex/xcite/xcite.sty\nPackage: xcite 2011/09/02 v1.0 eXternal Citations (EG)\n)\n(/usr/share/texmf-dist/tex/latex/hyperref/xr-hyper.sty\nPackage: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)\n)\n\nPackage xr Warning:\nNo file ../references/references.aux\nLABELS NOT IMPORTED.\n on input line 35.\n\nPackage xc Warning:\nNo file ../references/references.aux\nLABELS NOT IMPORTED.\n on input line 35.\n``` \nI don't see any reason why this couldn't happen with vanilla sage. For the proposed fix to work it is necessary that the stuff under `../references/*` be built and I don't see any way to insure that, especially if things are built in parallel.",
    "created_at": "2019-06-30T01:57:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436634",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jhpalmieri](#comment:26):
> By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. 
> 
> ```
> Latexmk: Log file says output to 'combinat.pdf'
> Latexmk: List of undefined refs and citations:
>   Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570
>   Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570
>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550
>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839
>   Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131
>   Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455
> Latexmk: Summary of warnings from last run of (pdf)latex:
>   Latex failed to resolve 1 reference(s)
>   Latex failed to resolve 5 citation(s)
> === TeX engine is 'pdfTeX'
> ```
> I think this is to be expected, given the proposed solution. The long term fix is #27497.

On a sage-on-gentoo build I see things like

```
(/usr/share/texmf-dist/tex/latex/xcite/xcite.sty
Package: xcite 2011/09/02 v1.0 eXternal Citations (EG)
)
(/usr/share/texmf-dist/tex/latex/hyperref/xr-hyper.sty
Package: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)
)

Package xr Warning:
No file ../references/references.aux
LABELS NOT IMPORTED.
 on input line 35.

Package xc Warning:
No file ../references/references.aux
LABELS NOT IMPORTED.
 on input line 35.
``` 
I don't see any reason why this couldn't happen with vanilla sage. For the proposed fix to work it is necessary that the stuff under `../references/*` be built and I don't see any way to insure that, especially if things are built in parallel.



---

archive/issue_comments_436635.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI think it should be possible to make `en/reference/references` a special case when building the reference manual, to build it first.",
    "created_at": "2019-06-30T04:22:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436635",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:31" align="right">comment:31</div>

I think it should be possible to make `en/reference/references` a special case when building the reference manual, to build it first.



---

archive/issue_events_384754.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:39:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384754"
}
```



---

archive/issue_events_384755.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:39:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384755"
}
```



---

archive/issue_comments_436636.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nMoving open critical and blocker issues to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:39:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436636",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Moving open critical and blocker issues to the next release milestone (optimistically).



---

archive/issue_comments_436637.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nBuild the bibliography first to make sure that the `aux` file is present:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex 2fa23276ba..f4cca072e2 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -547,6 +547,9 @@ class ReferenceBuilder(AllBuilder):\n                 continue\n             output_dir = self._output_dir(format, lang)\n             L = [(doc, lang, format, kwds) + args for doc in self.get_all_documents(refdir)]\n+            if format == 'pdf' and lang == 'en':\n+                logger.warning('Building bibliography')\n+                getattr(ReferenceSubBuilder('reference/references', 'en'), 'pdf')(*args, **kwds)\n             build_many(build_ref_doc, L)\n             # The html refman must be build at the end to ensure correct\n             # merging of indexes and inventories.\n```",
    "created_at": "2019-07-19T23:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436637",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

Build the bibliography first to make sure that the `aux` file is present:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index 2fa23276ba..f4cca072e2 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -547,6 +547,9 @@ class ReferenceBuilder(AllBuilder):
                 continue
             output_dir = self._output_dir(format, lang)
             L = [(doc, lang, format, kwds) + args for doc in self.get_all_documents(refdir)]
+            if format == 'pdf' and lang == 'en':
+                logger.warning('Building bibliography')
+                getattr(ReferenceSubBuilder('reference/references', 'en'), 'pdf')(*args, **kwds)
             build_many(build_ref_doc, L)
             # The html refman must be build at the end to ensure correct
             # merging of indexes and inventories.
```



---

archive/issue_comments_436638.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/doc-pdf-citations](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/doc-pdf-citations)**",
    "created_at": "2019-07-19T23:39:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436638",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/doc-pdf-citations](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/doc-pdf-citations)**



---

archive/issue_comments_436639.json:
```json
{
    "body": "Commit: **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**",
    "created_at": "2019-07-19T23:43:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436639",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**



---

archive/issue_comments_436640.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2019-07-19T23:43:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436640",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **John Palmieri**



---

archive/issue_comments_436641.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nIn principle this is ready for review, but it has some dependencies: some references need to be moved to the master bibliography file. #28084 would do it, but I don't think that all of the references in `sage/graphs` need to be modified, just those which are referenced elsewhere. I'm not going to mark it as \"needs review\" until I know which ticket to list as a dependency.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd\">67bfb85</a></td><td><code>trac 28059: fix citations in PDF version of reference manual.</code></td></tr></table>\n",
    "created_at": "2019-07-19T23:43:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436641",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:35" align="right">comment:35</div>

In principle this is ready for review, but it has some dependencies: some references need to be moved to the master bibliography file. #28084 would do it, but I don't think that all of the references in `sage/graphs` need to be modified, just those which are referenced elsewhere. I'm not going to mark it as "needs review" until I know which ticket to list as a dependency.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd">67bfb85</a></td><td><code>trac 28059: fix citations in PDF version of reference manual.</code></td></tr></table>




---

archive/issue_comments_436642.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nAny progress here? Maybe this ticket can already be merged even if other references still need to me moved?",
    "created_at": "2019-09-15T12:11:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436642",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:36" align="right">comment:36</div>

Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?



---

archive/issue_comments_436643.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@vbraun](#comment:36):\n> Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?\n\nI will do a test run to check it doesn't break any other doc. If it doesn't, lets merge it.",
    "created_at": "2019-09-15T20:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436643",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@vbraun](#comment:36):
> Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?

I will do a test run to check it doesn't break any other doc. If it doesn't, lets merge it.



---

archive/issue_comments_436644.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nNothing is obviously broken. There may be references missing in some other places.",
    "created_at": "2019-09-15T22:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436644",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:38" align="right">comment:38</div>

Nothing is obviously broken. There may be references missing in some other places.



---

archive/issue_events_384756.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-09-15T22:05:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384756"
}
```



---

archive/issue_events_384757.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-09-15T22:05:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384757"
}
```



---

archive/issue_events_384758.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-09-15T22:05:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384758"
}
```



---

archive/issue_comments_436645.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2019-09-15T22:05:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436645",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **Fran√ßois Bissey**



---

archive/issue_comments_436646.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/doc-pdf-citations](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/doc-pdf-citations)** to **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**",
    "created_at": "2019-09-17T22:26:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28059#issuecomment-436646",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/doc-pdf-citations](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/doc-pdf-citations)** to **[67bfb85](https://github.com/sagemath/sagetrac-mirror/commit/67bfb85a907c3fadc6a69236282c48a3b29063dd)**



---

archive/issue_events_384759.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-09-17T22:26:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384759"
}
```



---

archive/issue_events_384760.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2eff516090a8c057e6601887fd9dae00f34ec73f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-09-17T22:26:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/28059",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28059#event-384760"
}
```
