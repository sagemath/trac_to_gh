# Issue 28059: Some citations are missing from pdf docs

archive/issues_027822.json:
```json
{
    "body": "As reported in https://github.com/cschwan/sage-on-gentoo/issues/543\nin 8.8.rc3 some citations are in missing in the generated pdf documentation. A clear example is en/reference/tensor_free_modules/tensor_free_modules.pdf\nwhere there are citations missing on the first page of chapter one.\n\nCC:  @strogdon\n\nBranch/Commit: 67bfb85a907c3fadc6a69236282c48a3b29063dd\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28059\n\n",
    "closed_at": "2019-09-17T22:26:00Z",
    "created_at": "2019-06-26T03:15:26Z",
    "labels": [
        "component: documentation",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Some citations are missing from pdf docs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28059",
    "user": "https://github.com/kiwifb"
}
```
As reported in https://github.com/cschwan/sage-on-gentoo/issues/543
in 8.8.rc3 some citations are in missing in the generated pdf documentation. A clear example is en/reference/tensor_free_modules/tensor_free_modules.pdf
where there are citations missing on the first page of chapter one.

CC:  @strogdon

Branch/Commit: 67bfb85a907c3fadc6a69236282c48a3b29063dd

Reviewer: François Bissey

Author: John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28059





---

archive/issue_comments_543528.json:
```json
{
    "body": "Attachment [citations.png](tarball://root/attachments/some-uuid/ticket28059/citations.png) by @kiwifb created at 2019-06-26 03:55:46",
    "created_at": "2019-06-26T03:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543528",
    "user": "https://github.com/kiwifb"
}
```

Attachment [citations.png](tarball://root/attachments/some-uuid/ticket28059/citations.png) by @kiwifb created at 2019-06-26 03:55:46



---

archive/issue_comments_543529.json:
```json
{
    "body": "<a id='comment:1'></a>Example \n\n![](citations.png)",
    "created_at": "2019-06-26T04:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543529",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>Example 

![](citations.png)



---

archive/issue_comments_543530.json:
```json
{
    "body": "<a id='comment:2'></a>I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.",
    "created_at": "2019-06-26T06:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543530",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.



---

archive/issue_comments_543531.json:
```json
{
    "body": "<a id='comment:3'></a>just to be sure, the same in python2 and python3 ?",
    "created_at": "2019-06-26T06:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543531",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>just to be sure, the same in python2 and python3 ?



---

archive/issue_comments_543532.json:
```json
{
    "body": "<a id='comment:4'></a>Yes, I suspect the sphinx upgrade had something to do with it. That's the most likely. \n\nPython2 vs python3: I haven't tried yet with python3. I am a bit busy and my first port of call was eliminating texlive2017 vs texlive2019.",
    "created_at": "2019-06-26T08:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543532",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>Yes, I suspect the sphinx upgrade had something to do with it. That's the most likely. 

Python2 vs python3: I haven't tried yet with python3. I am a bit busy and my first port of call was eliminating texlive2017 vs texlive2019.



---

archive/issue_comments_543533.json:
```json
{
    "body": "<a id='comment:5'></a>I have also noticed that \"proper\" in-file `REFERENCES:` sections such as\n\n```\nREFERENCES:\n\n.. [BvL84] \\A. Brouwer, J. van Lint,\n   Strongly regular graphs and partial geometries,\n   Enumeration and design,\n   (Waterloo, Ont., 1982) (1984): 85-122.\n   http://oai.cwi.nl/oai/asset/1817/1817A.pdf\n```\nin `graphs/strongly_regular_db.pyx` come out as just `REFERENCES:`, without any content.\nOn the other hand, \"improper\" (to be fixed, I suppose) in-file references such as\n\n```\n        REFERENCES:\n\n        - [1] http://mathworld.wolfram.com/MatrixTreeTheorem.html\n\n        - [2] Lih-Hsing Hsu, Cheng-Kuan Lin, \"Graph Theory and\n          Interconnection Networks\"\n```\nin graphs/generic_graph.py\ndo come out with the proper content.",
    "created_at": "2019-06-26T09:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543533",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>I have also noticed that "proper" in-file `REFERENCES:` sections such as

```
REFERENCES:

.. [BvL84] \A. Brouwer, J. van Lint,
   Strongly regular graphs and partial geometries,
   Enumeration and design,
   (Waterloo, Ont., 1982) (1984): 85-122.
   http://oai.cwi.nl/oai/asset/1817/1817A.pdf
```
in `graphs/strongly_regular_db.pyx` come out as just `REFERENCES:`, without any content.
On the other hand, "improper" (to be fixed, I suppose) in-file references such as

```
        REFERENCES:

        - [1] http://mathworld.wolfram.com/MatrixTreeTheorem.html

        - [2] Lih-Hsing Hsu, Cheng-Kuan Lin, "Graph Theory and
          Interconnection Networks"
```
in graphs/generic_graph.py
do come out with the proper content.



---

archive/issue_comments_543534.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A2):\n> I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.\n\n\nI confirm: with Sage 8.7, running \n\n```\n./sage -docbuild reference/tensor_free_modules pdf\n```\nyields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.",
    "created_at": "2019-06-26T14:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543534",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A2):
> I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.


I confirm: with Sage 8.7, running 

```
./sage -docbuild reference/tensor_free_modules pdf
```
yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.



---

archive/issue_comments_543535.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [egourgoulhon](#comment%3A6):\n> Replying to [jhpalmieri](#comment%3A2):\n> > I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.\n\n> \n> I confirm: with Sage 8.7, running \n> \n> ```\n> ./sage -docbuild reference/tensor_free_modules pdf\n> ```\n> yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.\n\n\nThe Sphinx upgrade was added in 8.8.beta1",
    "created_at": "2019-06-26T14:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543535",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:7'></a>Replying to [egourgoulhon](#comment%3A6):
> Replying to [jhpalmieri](#comment%3A2):
> > I suppose it must be related to the Sphinx upgrade #26451. I don't think this problem was present in Sage 8.7.

> 
> I confirm: with Sage 8.7, running 
> 
> ```
> ./sage -docbuild reference/tensor_free_modules pdf
> ```
> yields a pdf file with the references properly set. It fails with Sage 8.8.beta7 and later versions.


The Sphinx upgrade was added in 8.8.beta1



---

archive/issue_comments_543536.json:
```json
{
    "body": "<a id='comment:8'></a>I'm adding the branch of #26451 to 8.7 and will try to compare LaTeX files generated by 8.7 with the one from the update.",
    "created_at": "2019-06-26T15:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543536",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>I'm adding the branch of #26451 to 8.7 and will try to compare LaTeX files generated by 8.7 with the one from the update.



---

archive/issue_comments_543537.json:
```json
{
    "body": "<a id='comment:9'></a>oops, the problem is that 8.7 doesn't keep generated LaTeX files :-(\n\nSo the question is how to make them persist in 8.7.",
    "created_at": "2019-06-26T15:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543537",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>oops, the problem is that 8.7 doesn't keep generated LaTeX files :-(

So the question is how to make them persist in 8.7.



---

archive/issue_comments_543538.json:
```json
{
    "body": "<a id='comment:10'></a>I see lots of files in `local/share/doc/sage/latex/...`, for example `latex/en/reference/algebras/algebras.tex`. If you don't, maybe try `sage --docbuild reference latex`?",
    "created_at": "2019-06-26T15:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543538",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>I see lots of files in `local/share/doc/sage/latex/...`, for example `latex/en/reference/algebras/algebras.tex`. If you don't, maybe try `sage --docbuild reference latex`?



---

archive/issue_comments_543539.json:
```json
{
    "body": "<a id='comment:11'></a>Are there actually active references in the Sage 8.7 pdf files? I don't see the question marks, but instead I just see plain text, not a link to a reference file or to references elsewhere in the same file. So maybe the new Sphinx is actually trying to resolve the links when the old one wasn't, and we have to figure out how to tell it where to find them.",
    "created_at": "2019-06-26T15:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543539",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>Are there actually active references in the Sage 8.7 pdf files? I don't see the question marks, but instead I just see plain text, not a link to a reference file or to references elsewhere in the same file. So maybe the new Sphinx is actually trying to resolve the links when the old one wasn't, and we have to figure out how to tell it where to find them.



---

archive/issue_comments_543540.json:
```json
{
    "body": "<a id='comment:12'></a>after the sphinx update, one sees lots of\n\n```\nLaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in\nput line 605.\n```\n\n(one would rather have it getting `../references/references:lee2011')\n\nProbably `index` comes from it being generated from `index.rst`.",
    "created_at": "2019-06-26T16:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543540",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>after the sphinx update, one sees lots of

```
LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in
put line 605.
```

(one would rather have it getting `../references/references:lee2011')

Probably `index` comes from it being generated from `index.rst`.



---

archive/issue_comments_543541.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [dimpase](#comment%3A12):\n> after the sphinx update, one sees lots of\n> \n> ```\n> LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in\n> put line 605.\n> ```\n> \n> (one would rather have it getting `../references/references:lee2011')\n> \n> Probably `index` comes from it being generated from `index.rst`.\n\n>\nBut the sphinx generated file `latex/en/reference/references/references.tex` has the bibitem\n\n```\n\\bibitem[Lee2011]{index:lee2011}\nJ. M. Lee, \\sphinxstyleemphasis{Introduction to Topological Manifolds}, 2nd ed.,\nSpringer (New York) (2011); \\sphinxhref{https://doi.org/10.1007/978-1-4419-7940-7}{doi:10.1007/978-1-4419-7940-7}\n```\nWould things work if index were change to references?",
    "created_at": "2019-06-26T16:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543541",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:13'></a>Replying to [dimpase](#comment%3A12):
> after the sphinx update, one sees lots of
> 
> ```
> LaTeX Warning: Citation `../references/index:lee2011' on page 8 undefined on in
> put line 605.
> ```
> 
> (one would rather have it getting `../references/references:lee2011')
> 
> Probably `index` comes from it being generated from `index.rst`.

>
But the sphinx generated file `latex/en/reference/references/references.tex` has the bibitem

```
\bibitem[Lee2011]{index:lee2011}
J. M. Lee, \sphinxstyleemphasis{Introduction to Topological Manifolds}, 2nd ed.,
Springer (New York) (2011); \sphinxhref{https://doi.org/10.1007/978-1-4419-7940-7}{doi:10.1007/978-1-4419-7940-7}
```
Would things work if index were change to references?



---

archive/issue_comments_543542.json:
```json
{
    "body": "<a id='comment:14'></a>they are hooked up via `\\sphinxcite`, which is an alias to `\\cite`. Which is meant to hook up citations from a bibfile, not from a (La)TeX file.\n\nMoreover, `\\sphinxcite` is supposed to be only introduced in sphinx 1.8.3, whereas we already used it in sphinx 1.7.3, for some reason...",
    "created_at": "2019-06-26T17:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543542",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>they are hooked up via `\sphinxcite`, which is an alias to `\cite`. Which is meant to hook up citations from a bibfile, not from a (La)TeX file.

Moreover, `\sphinxcite` is supposed to be only introduced in sphinx 1.8.3, whereas we already used it in sphinx 1.7.3, for some reason...



---

archive/issue_comments_543543.json:
```json
{
    "body": "<a id='comment:15'></a>It appears that `\\sphinxcite` is just an alias to `\\cite`, and thus its argument is treated in a normal way, i.e. one would need \n`\\bibitem[Lee2011]{index:lee2011}` to become \n\n`\\bibitem[Lee2011]{../references/index:lee2011}` \n\nin addition to the knowledge about the location of this `bibitem` to be properly passed.\n(something what in \"normal\" latex would be in a parameter to `\\bibliography{}`.\n\nhttps://tex.stackexchange.com/questions/497566/meaning-of-cite-foo-barbaz-in-sphinx-generated-latex",
    "created_at": "2019-06-26T18:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543543",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>It appears that `\sphinxcite` is just an alias to `\cite`, and thus its argument is treated in a normal way, i.e. one would need 
`\bibitem[Lee2011]{index:lee2011}` to become 

`\bibitem[Lee2011]{../references/index:lee2011}` 

in addition to the knowledge about the location of this `bibitem` to be properly passed.
(something what in "normal" latex would be in a parameter to `\bibliography{}`.

https://tex.stackexchange.com/questions/497566/meaning-of-cite-foo-barbaz-in-sphinx-generated-latex



---

archive/issue_comments_543544.json:
```json
{
    "body": "<a id='comment:16'></a>I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n\n```\n\\usepackage{xcite}\n\\usepackage{xr-hyper}\n\\externaldocument{../references/references}\n\\externalcitedocument{../references/references}\n\\usepackage{sphinx}\n```\nDelete all of the `../references/` from the `\\sphinxcite{}` entries. After the deletions there should only be items like\n\n```\n\\sphinxcite{index:god1968}\n\\sphinxcite{index:lan2002}\n ...\n```\nNow rebuild `tensor_free_modules.pdf`. Here all the labels appear after the citations in `tensor_free_modules.pdf`. I believe for this to work the stuff under `../references/` must be built. One caveat is that I see \n\n```\nLaTeX Warning: There were multiply-defined labels.\n```\nin the .log file but the citations in the pdf are in place.",
    "created_at": "2019-06-26T19:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543544",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:16'></a>I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.

```
\usepackage{xcite}
\usepackage{xr-hyper}
\externaldocument{../references/references}
\externalcitedocument{../references/references}
\usepackage{sphinx}
```
Delete all of the `../references/` from the `\sphinxcite{}` entries. After the deletions there should only be items like

```
\sphinxcite{index:god1968}
\sphinxcite{index:lan2002}
 ...
```
Now rebuild `tensor_free_modules.pdf`. Here all the labels appear after the citations in `tensor_free_modules.pdf`. I believe for this to work the stuff under `../references/` must be built. One caveat is that I see 

```
LaTeX Warning: There were multiply-defined labels.
```
in the .log file but the citations in the pdf are in place.



---

archive/issue_comments_543545.json:
```json
{
    "body": "<a id='comment:17'></a>This would be a stopgap, but if we just want to reproduce the output from Sage 8.7, we need `\\sphinxcite{../references/index:mil1958}` to return the plain text `[Mil1958]`.\n\n(This should only be done for the reference manual. As far as I can tell, references/citations work well in old and new Sage in the other parts of the documentation.)",
    "created_at": "2019-06-26T21:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543545",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>This would be a stopgap, but if we just want to reproduce the output from Sage 8.7, we need `\sphinxcite{../references/index:mil1958}` to return the plain text `[Mil1958]`.

(This should only be done for the reference manual. As far as I can tell, references/citations work well in old and new Sage in the other parts of the documentation.)



---

archive/issue_comments_543546.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [strogdon](#comment%3A16):\n> I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n> \n> ```\n> \\usepackage{xcite}\n> \\usepackage{xr-hyper}\n> \\externaldocument{../references/references}\n> \\externalcitedocument{../references/references}\n> \\usepackage{sphinx}\n> ```\n\n\nI think you can modify this and not do any changes in the `sphinxcite{...}` commands:\n\n```\n\\usepackage{xcite}\n\\usepackage{xr-hyper}\n\\externaldocument[../references/]{../references/references}\n\\externalcitedocument[../references/]{../references/references}\n% These lines must appear before \\usepackage{hyperref}.\n```\nThese commands take an optional argument which specifies the prefix used in their citations. Then `\\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?\n\nMaybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?",
    "created_at": "2019-06-26T22:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543546",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>Replying to [strogdon](#comment%3A16):
> I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.
> 
> ```
> \usepackage{xcite}
> \usepackage{xr-hyper}
> \externaldocument{../references/references}
> \externalcitedocument{../references/references}
> \usepackage{sphinx}
> ```


I think you can modify this and not do any changes in the `sphinxcite{...}` commands:

```
\usepackage{xcite}
\usepackage{xr-hyper}
\externaldocument[../references/]{../references/references}
\externalcitedocument[../references/]{../references/references}
% These lines must appear before \usepackage{hyperref}.
```
These commands take an optional argument which specifies the prefix used in their citations. Then `\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?

Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?



---

archive/issue_comments_543547.json:
```json
{
    "body": "<a id='comment:19'></a>I think this accomplishes `@`strogdon's suggestion:\n\n```diff\ndiff --git a/src/doc/en/reference/conf_sub.py b/src/doc/en/reference/conf_sub.py\nindex 76f6e12909..9344260f61 100644\n--- a/src/doc/en/reference/conf_sub.py\n+++ b/src/doc/en/reference/conf_sub.py\n@@ -63,6 +63,18 @@ latex_documents = [\n ('index', name + '.tex', project, u'The Sage Development Team', 'manual')\n ]\n \n+latex_elements['hyperref'] = r\"\"\"\n+\\usepackage{xcite}\n+\\usepackage{xr-hyper}\n+\\externaldocument[../references/]{../references/references}\n+\\externalcitedocument[../references/]{../references/references}\n+% Include hyperref last.\n+\\usepackage{hyperref}\n+% Fix anchor placement for figures with captions.\n+\\usepackage{hypcap}% it must be loaded after hyperref.\n+% Set up styles of URL: it should be placed after hyperref.\n+\\urlstyle{same}\"\"\"\n+\n #Ignore all .rst in the _sage subdirectory\n exclude_patterns = exclude_patterns + ['_sage']\n \n```\nby putting the commands in the preamble of each component of the reference manual, along with the appropriate prefix for each citation. (The extra lines come from Sphinx's default setting for the `hyperref` entry for `latex_elements`. We can't just put the proposed lines in `latex_elements['preamble']`, because that gets inserted after `\\usepackage{hyperref}`, whereas these lines must come before `\\usepackage{hyperref}`.)\n\nThis does not provide live links, though.",
    "created_at": "2019-06-26T22:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543547",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>I think this accomplishes `@`strogdon's suggestion:

```diff
diff --git a/src/doc/en/reference/conf_sub.py b/src/doc/en/reference/conf_sub.py
index 76f6e12909..9344260f61 100644
--- a/src/doc/en/reference/conf_sub.py
+++ b/src/doc/en/reference/conf_sub.py
@@ -63,6 +63,18 @@ latex_documents = [
 ('index', name + '.tex', project, u'The Sage Development Team', 'manual')
 ]
 
+latex_elements['hyperref'] = r"""
+\usepackage{xcite}
+\usepackage{xr-hyper}
+\externaldocument[../references/]{../references/references}
+\externalcitedocument[../references/]{../references/references}
+% Include hyperref last.
+\usepackage{hyperref}
+% Fix anchor placement for figures with captions.
+\usepackage{hypcap}% it must be loaded after hyperref.
+% Set up styles of URL: it should be placed after hyperref.
+\urlstyle{same}"""
+
 #Ignore all .rst in the _sage subdirectory
 exclude_patterns = exclude_patterns + ['_sage']
 
```
by putting the commands in the preamble of each component of the reference manual, along with the appropriate prefix for each citation. (The extra lines come from Sphinx's default setting for the `hyperref` entry for `latex_elements`. We can't just put the proposed lines in `latex_elements['preamble']`, because that gets inserted after `\usepackage{hyperref}`, whereas these lines must come before `\usepackage{hyperref}`.)

This does not provide live links, though.



---

archive/issue_comments_543548.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [jhpalmieri](#comment%3A18):\n> Replying to [strogdon](#comment%3A16):\n> > I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\\usepackage{sphinx}`.\n> > \n> > ```\n> > \\usepackage{xcite}\n> > \\usepackage{xr-hyper}\n> > \\externaldocument{../references/references}\n> > \\externalcitedocument{../references/references}\n> > \\usepackage{sphinx}\n> > ```\n\n> \n> I think you can modify this and not do any changes in the `sphinxcite{...}` commands:\n> \n> ```\n> \\usepackage{xcite}\n> \\usepackage{xr-hyper}\n> \\externaldocument[../references/]{../references/references}\n> \\externalcitedocument[../references/]{../references/references}\n> % These lines must appear before \\usepackage{hyperref}.\n> ```\n> These commands take an optional argument which specifies the prefix used in their citations. Then `\\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?\n> \n> Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?\n\n\nExcellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info. I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?",
    "created_at": "2019-06-26T22:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543548",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:20'></a>Replying to [jhpalmieri](#comment%3A18):
> Replying to [strogdon](#comment%3A16):
> > I know now to fix things from the Latex side, but how to make Sphinx work is unknown. I will focus on `latex/en/reference/tensor_free_modules/tensor_free_modules.tex`. Make sure the preamble has the following inserted above the `\usepackage{sphinx}`.
> > 
> > ```
> > \usepackage{xcite}
> > \usepackage{xr-hyper}
> > \externaldocument{../references/references}
> > \externalcitedocument{../references/references}
> > \usepackage{sphinx}
> > ```

> 
> I think you can modify this and not do any changes in the `sphinxcite{...}` commands:
> 
> ```
> \usepackage{xcite}
> \usepackage{xr-hyper}
> \externaldocument[../references/]{../references/references}
> \externalcitedocument[../references/]{../references/references}
> % These lines must appear before \usepackage{hyperref}.
> ```
> These commands take an optional argument which specifies the prefix used in their citations. Then `\sphinxcite{../references/index:mil1958}` will be converted to `index:mil1958`, which should then be looked up in the master bibliography file. This renders as plain text `[Mil1958]`, but maybe that's the best you can hope for: PDF files shouldn't have live links to other PDF files, should they? Is that what we would want?
> 
> Maybe the best solution would be if Sphinx magically extracted the relevant citations and included only those in each PDF file, but I don't know how to do that. Maybe we can convert our master bibliography file into a BibTeX `.bib` file and use that?


Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info. I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?



---

archive/issue_comments_543549.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [strogdon](#comment%3A20):\n> Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info.\n\n\nThat file will contain the list of citations, but not actual authors, titles, etc.\n\n> I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?\n\n\nThe diff in[comment:19](#comment%3A19) should insert those lines into each LaTeX file.",
    "created_at": "2019-06-27T02:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543549",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>Replying to [strogdon](#comment%3A20):
> Excellent! I may be incorrect, but I think LaTeX parses `../references/references.aux` to get bibliographical info.


That file will contain the list of citations, but not actual authors, titles, etc.

> I had thought about the BibTeX approach but that will require some significant work. If this is to work then four lines will have to be inserted into each .tex file by Sphinx. Sphinx auto-generates the files. But where?


The diff in[comment:19](#comment%3A19) should insert those lines into each LaTeX file.



---

archive/issue_comments_543550.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [jhpalmieri](#comment%3A21):\n> The diff in[comment:19](#comment%3A19) should insert those lines into each LaTeX file.\n\nI've tried this and it does work.",
    "created_at": "2019-06-27T02:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543550",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:22'></a>Replying to [jhpalmieri](#comment%3A21):
> The diff in[comment:19](#comment%3A19) should insert those lines into each LaTeX file.

I've tried this and it does work.



---

archive/issue_comments_543551.json:
```json
{
    "body": "<a id='comment:23'></a>what I don\u2019t understand is why we don\u2019t get proper hyperlinks in pdf this way.\n\nnormally pdflatex would create them from \\cite macros  used with \\hyperref package.",
    "created_at": "2019-06-27T06:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543551",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>what I don’t understand is why we don’t get proper hyperlinks in pdf this way.

normally pdflatex would create them from \cite macros  used with \hyperref package.



---

archive/issue_comments_543552.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [dimpase](#comment%3A23):\n> what I don\u2019t understand is why we don\u2019t get proper hyperlinks in pdf this way.\n> \n> normally pdflatex would create them from \\cite macros  used with \\hyperref package.\n\nI think this is because the citation is in one pdf and the actual bibliographic entry is in another pdf. I don't know if \\hyperref can be made to work across pdf files.",
    "created_at": "2019-06-27T14:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543552",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:24'></a>Replying to [dimpase](#comment%3A23):
> what I don’t understand is why we don’t get proper hyperlinks in pdf this way.
> 
> normally pdflatex would create them from \cite macros  used with \hyperref package.

I think this is because the citation is in one pdf and the actual bibliographic entry is in another pdf. I don't know if \hyperref can be made to work across pdf files.



---

archive/issue_comments_543553.json:
```json
{
    "body": "<a id='comment:25'></a>hyperref can work across files, with `\\ref` etc, but not with `\\cite`, for some reason.",
    "created_at": "2019-06-27T16:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543553",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>hyperref can work across files, with `\ref` etc, but not with `\cite`, for some reason.



---

archive/issue_comments_543554.json:
```json
{
    "body": "<a id='comment:26'></a>By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. \n\n```\nLatexmk: Log file says output to 'combinat.pdf'\nLatexmk: List of undefined refs and citations:\n  Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570\n  Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570\n  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550\n  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839\n  Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131\n  Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455\nLatexmk: Summary of warnings from last run of (pdf)latex:\n  Latex failed to resolve 1 reference(s)\n  Latex failed to resolve 5 citation(s)\n### TeX engine is 'pdfTeX'\n```\nI think this is to be expected, given the proposed solution. The long term fix is #27497.",
    "created_at": "2019-06-27T17:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543554",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:26'></a>By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. 

```
Latexmk: Log file says output to 'combinat.pdf'
Latexmk: List of undefined refs and citations:
  Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570
  Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570
  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550
  Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839
  Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131
  Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455
Latexmk: Summary of warnings from last run of (pdf)latex:
  Latex failed to resolve 1 reference(s)
  Latex failed to resolve 5 citation(s)
### TeX engine is 'pdfTeX'
```
I think this is to be expected, given the proposed solution. The long term fix is #27497.



---

archive/issue_comments_543555.json:
```json
{
    "body": "<a id='comment:27'></a>A untested shorter term fix is to add more `\\externalcitedocument[...]{...}` commands.",
    "created_at": "2019-06-27T17:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543555",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>A untested shorter term fix is to add more `\externalcitedocument[...]{...}` commands.



---

archive/issue_comments_543556.json:
```json
{
    "body": "<a id='comment:28'></a>It's probably best to go with #27497 - it's the easiest.\nI also think we should indeed convert the thing to bibtex \n\n(who was the genius who thought that free from meta-information format for citations is OK :-))",
    "created_at": "2019-06-27T17:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543556",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>It's probably best to go with #27497 - it's the easiest.
I also think we should indeed convert the thing to bibtex 

(who was the genius who thought that free from meta-information format for citations is OK :-))



---

archive/issue_comments_543557.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [jhpalmieri](#comment%3A27):\n> A untested shorter term fix is to add more `\\externalcitedocument[...]{...}` commands.\n\n\nI think a problem with this is that combinat.tex will want to access graphs.aux, which won't be ready until graphs.tex is compiled, while graphs.tex will want to access combinat.aux. So there is no good order to process these.\n\nRegarding #27497: it's going to be a lot tedious work to do this (speaking from experience, since I have moved most of Sage's other references to the master bibliography file). I don't want to do it. Fortunately, for the purposes of this ticket, we only need to move a few references: the ones in combinat that are used elsewhere and the ones in graphs that are used elsewhere.\n\nConverting to bibtex will also be a lot of work. A program like [bibweb](https://github.com/jhpalmieri/bibweb) might help a bit, but who wants to convert all of the current references to bibtex format? I'm certainly not going to stand in anyone's way, but the task is almost too tedious to even consider.\n\nOh, there is also [sphinxcontrib-bibtex](https://pypi.org/project/sphinxcontrib-bibtex/), but note [this issue](https://sphinxcontrib-bibtex.readthedocs.io/en/latest/usage.html#unresolved-citations-across-documents).",
    "created_at": "2019-06-27T17:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543557",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:29'></a>Replying to [jhpalmieri](#comment%3A27):
> A untested shorter term fix is to add more `\externalcitedocument[...]{...}` commands.


I think a problem with this is that combinat.tex will want to access graphs.aux, which won't be ready until graphs.tex is compiled, while graphs.tex will want to access combinat.aux. So there is no good order to process these.

Regarding #27497: it's going to be a lot tedious work to do this (speaking from experience, since I have moved most of Sage's other references to the master bibliography file). I don't want to do it. Fortunately, for the purposes of this ticket, we only need to move a few references: the ones in combinat that are used elsewhere and the ones in graphs that are used elsewhere.

Converting to bibtex will also be a lot of work. A program like [bibweb](https://github.com/jhpalmieri/bibweb) might help a bit, but who wants to convert all of the current references to bibtex format? I'm certainly not going to stand in anyone's way, but the task is almost too tedious to even consider.

Oh, there is also [sphinxcontrib-bibtex](https://pypi.org/project/sphinxcontrib-bibtex/), but note [this issue](https://sphinxcontrib-bibtex.readthedocs.io/en/latest/usage.html#unresolved-citations-across-documents).



---

archive/issue_comments_543558.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [jhpalmieri](#comment%3A26):\n> By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. \n> \n> ```\n> Latexmk: Log file says output to 'combinat.pdf'\n> Latexmk: List of undefined refs and citations:\n>   Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570\n>   Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570\n>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550\n>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839\n>   Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131\n>   Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455\n> Latexmk: Summary of warnings from last run of (pdf)latex:\n>   Latex failed to resolve 1 reference(s)\n>   Latex failed to resolve 5 citation(s)\n> === TeX engine is 'pdfTeX'\n> ```\n> I think this is to be expected, given the proposed solution. The long term fix is #27497.\n\n\nOn a sage-on-gentoo build I see things like\n\n```\n(/usr/share/texmf-dist/tex/latex/xcite/xcite.sty\nPackage: xcite 2011/09/02 v1.0 eXternal Citations (EG)\n)\n(/usr/share/texmf-dist/tex/latex/hyperref/xr-hyper.sty\nPackage: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)\n)\n\nPackage xr Warning:\nNo file ../references/references.aux\nLABELS NOT IMPORTED.\n on input line 35.\n\nPackage xc Warning:\nNo file ../references/references.aux\nLABELS NOT IMPORTED.\n on input line 35.\n``` \nI don't see any reason why this couldn't happen with vanilla sage. For the proposed fix to work it is necessary that the stuff under `../references/*` be built and I don't see any way to insure that, especially if things are built in parallel.",
    "created_at": "2019-06-30T01:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543558",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:30'></a>Replying to [jhpalmieri](#comment%3A26):
> By the way, I am still seeing some missing citations. For example when building the combinat part of the reference manual, citations from the graphs manual are missing. 
> 
> ```
> Latexmk: Log file says output to 'combinat.pdf'
> Latexmk: List of undefined refs and citations:
>   Citation `../graphs/sage/graphs/graph_generators:gqwiki' on page 645 undefined on input line 55570
>   Citation `../graphs/sage/graphs/graph_generators:pt09' on page 645 undefined on input line 55570
>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 588 undefined on input line 50550
>   Citation `../graphs/sage/graphs/strongly_regular_db:bvl84' on page 703 undefined on input line 60839
>   Citation `../graphs/sage/graphs/strongly_regular_db:gs70' on page 1221 undefined on input line 105131
>   Reference `index:module-sage.combinat' on page 3393 undefined on input line 294455
> Latexmk: Summary of warnings from last run of (pdf)latex:
>   Latex failed to resolve 1 reference(s)
>   Latex failed to resolve 5 citation(s)
> === TeX engine is 'pdfTeX'
> ```
> I think this is to be expected, given the proposed solution. The long term fix is #27497.


On a sage-on-gentoo build I see things like

```
(/usr/share/texmf-dist/tex/latex/xcite/xcite.sty
Package: xcite 2011/09/02 v1.0 eXternal Citations (EG)
)
(/usr/share/texmf-dist/tex/latex/hyperref/xr-hyper.sty
Package: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)
)

Package xr Warning:
No file ../references/references.aux
LABELS NOT IMPORTED.
 on input line 35.

Package xc Warning:
No file ../references/references.aux
LABELS NOT IMPORTED.
 on input line 35.
``` 
I don't see any reason why this couldn't happen with vanilla sage. For the proposed fix to work it is necessary that the stuff under `../references/*` be built and I don't see any way to insure that, especially if things are built in parallel.



---

archive/issue_comments_543559.json:
```json
{
    "body": "<a id='comment:31'></a>I think it should be possible to make `en/reference/references` a special case when building the reference manual, to build it first.",
    "created_at": "2019-06-30T04:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543559",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'></a>I think it should be possible to make `en/reference/references` a special case when building the reference manual, to build it first.



---

archive/issue_events_069536.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:39:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28059#event-69536"
}
```



---

archive/issue_comments_543560.json:
```json
{
    "body": "<a id='comment:32'></a>Moving open critical and blocker issues to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543560",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Moving open critical and blocker issues to the next release milestone (optimistically).



---

archive/issue_comments_543561.json:
```json
{
    "body": "<a id='comment:33'></a>Build the bibliography first to make sure that the `aux` file is present:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex 2fa23276ba..f4cca072e2 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -547,6 +547,9 @@ class ReferenceBuilder(AllBuilder):\n                 continue\n             output_dir = self._output_dir(format, lang)\n             L = [(doc, lang, format, kwds) + args for doc in self.get_all_documents(refdir)]\n+            if format == 'pdf' and lang == 'en':\n+                logger.warning('Building bibliography')\n+                getattr(ReferenceSubBuilder('reference/references', 'en'), 'pdf')(*args, **kwds)\n             build_many(build_ref_doc, L)\n             # The html refman must be build at the end to ensure correct\n             # merging of indexes and inventories.\n```",
    "created_at": "2019-07-19T23:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543561",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'></a>Build the bibliography first to make sure that the `aux` file is present:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index 2fa23276ba..f4cca072e2 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -547,6 +547,9 @@ class ReferenceBuilder(AllBuilder):
                 continue
             output_dir = self._output_dir(format, lang)
             L = [(doc, lang, format, kwds) + args for doc in self.get_all_documents(refdir)]
+            if format == 'pdf' and lang == 'en':
+                logger.warning('Building bibliography')
+                getattr(ReferenceSubBuilder('reference/references', 'en'), 'pdf')(*args, **kwds)
             build_many(build_ref_doc, L)
             # The html refman must be build at the end to ensure correct
             # merging of indexes and inventories.
```



---

archive/issue_comments_543562.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/doc-pdf-citations\"",
    "created_at": "2019-07-19T23:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543562",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/doc-pdf-citations"



---

archive/issue_comments_543563.json:
```json
{
    "body": "Changing commit from \"\" to \"67bfb85a907c3fadc6a69236282c48a3b29063dd\"",
    "created_at": "2019-07-19T23:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543563",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "67bfb85a907c3fadc6a69236282c48a3b29063dd"



---

archive/issue_comments_543564.json:
```json
{
    "body": "Changing author from \"\" to \"John Palmieri\"",
    "created_at": "2019-07-19T23:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543564",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "" to "John Palmieri"



---

archive/issue_comments_543565.json:
```json
{
    "body": "<a id='comment:35'></a>In principle this is ready for review, but it has some dependencies: some references need to be moved to the master bibliography file. #28084 would do it, but I don't think that all of the references in `sage/graphs` need to be modified, just those which are referenced elsewhere. I'm not going to mark it as \"needs review\" until I know which ticket to list as a dependency.\n\n---\nNew commits:",
    "created_at": "2019-07-19T23:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543565",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:35'></a>In principle this is ready for review, but it has some dependencies: some references need to be moved to the master bibliography file. #28084 would do it, but I don't think that all of the references in `sage/graphs` need to be modified, just those which are referenced elsewhere. I'm not going to mark it as "needs review" until I know which ticket to list as a dependency.

---
New commits:



---

archive/issue_comments_543566.json:
```json
{
    "body": "<a id='comment:36'></a>Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?",
    "created_at": "2019-09-15T12:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543566",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:36'></a>Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?



---

archive/issue_comments_543567.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [vbraun](#comment%3A36):\n> Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?\n\n\nI will do a test run to check it doesn't break any other doc. If it doesn't, lets merge it.",
    "created_at": "2019-09-15T20:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543567",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:37'></a>Replying to [vbraun](#comment%3A36):
> Any progress here? Maybe this ticket can already be merged even if other references still need to me moved?


I will do a test run to check it doesn't break any other doc. If it doesn't, lets merge it.



---

archive/issue_comments_543568.json:
```json
{
    "body": "<a id='comment:38'></a>Nothing is obviously broken. There may be references missing in some other places.",
    "created_at": "2019-09-15T22:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543568",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:38'></a>Nothing is obviously broken. There may be references missing in some other places.



---

archive/issue_comments_543569.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-15T22:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543569",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_543570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-15T22:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543570",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_543571.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fran\u00e7ois Bissey\"",
    "created_at": "2019-09-15T22:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543571",
    "user": "https://github.com/kiwifb"
}
```

Changing reviewer from "" to "François Bissey"



---

archive/issue_comments_543572.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/doc-pdf-citations\" to \"67bfb85a907c3fadc6a69236282c48a3b29063dd\"",
    "created_at": "2019-09-17T22:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543572",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/doc-pdf-citations" to "67bfb85a907c3fadc6a69236282c48a3b29063dd"



---

archive/issue_events_069537.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-09-17T22:26:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28059#event-69537"
}
```



---

archive/issue_comments_543573.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-09-17T22:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-543573",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
