# Issue 28833: ResourceWarning: unclosed file with SAGE_DEBUG=yes

archive/issues_028596.json:
```json
{
    "body": "Python 3 now emits a ResourceWarning if you use the quick'n dirty `open(...).read()` to read (or write) a file instead of a with context. This leads to lots and lots of test failures of the form:\n\n```\nFile \"src/doc/en/prep/Symbolics-and-Basic-Plotting.rst\", line 487, in doc.en.prep.Symbolics-and-Basic-Plotting\nFailed example:\n    implicit_plot3d(p, (x, -r, r), (y, -r, r), (z, -r, r), plot_points=50, color='yellow')\nExpected:\n    Graphics3d Object\nGot:\n    doctest:warning\n      File \"/home/buildbot-sage/slave/sage_git/build/src/bin/sage-runtests\", line 179, in <module>\n        err = DC.run()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/control.py\", line 1238, in run\n        self.run_doctests()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/control.py\", line 939, in run_do\nctests\n        self.dispatcher.dispatch()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2033, in dispat\nch\n        self.parallel_dispatch()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1925, in parall\nel_dispatch\n        w.start()  # This might take some time\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2200, in start\n        super(DocTestWorker, self).start()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/process.py\", line 112, in start\n        self._popen = self._Popen(self)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/context.py\", line 223, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/popen_fork.py\", line 20, in __init__\n        self._launch(process_obj)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/popen_fork.py\", line 74, in _launch\n        code = process_obj._bootstrap()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/process.py\", line 297, in _bootstrap\n        self.run()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2172, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2504, in __call\n__\n        doctests, extras = self._run(runner, options, results)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 2553, in _run\n        result = runner.run(test)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 897, in run\n        return self._run(test, compileflags, out)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compil\ne_and_execute\n        exec(compiled, globs)\n      File \"<doctest doc.en.prep.Symbolics-and-Basic-Plotting[45]>\", line 1, in <module>\n        implicit_plot3d(p, (x, -r, r), (y, -r, r), (z, -r, r), plot_points=Integer(50), color='yellow')\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 811, in displayhook\n        plain_text, rich_output = self._rich_output_formatter(obj, dict())\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 625, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py\", line 585, in _call_rich_repr\n        return obj._rich_repr_(self)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/tachyon.py\", line 138, in __call__\n        open(modelfile,'w').write(model)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/warnings.py\", line 110, in _showwarnmsg\n        msg.file, msg.line)\n    :\n    ResourceWarning: unclosed file <_io.TextIOWrapper name='/home/buildbot-sage/slave/sage_git/dot_sage/temp/zen/3222347/tmp_j8lfc7ax.dat' mode='w' encoding='UTF-8'>\n    Graphics3d Object\n```\n\nBranch/Commit: 1db03d67c2e30b9b9ae507d7e4a6d4d15b951352\n\nReviewer: Volker Braun\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28833\n\n",
    "closed_at": "2019-12-08T21:19:35Z",
    "created_at": "2019-12-02T18:24:44Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "ResourceWarning: unclosed file with SAGE_DEBUG=yes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28833",
    "user": "https://github.com/vbraun"
}
```
Python 3 now emits a ResourceWarning if you use the quick'n dirty `open(...).read()` to read (or write) a file instead of a with context. This leads to lots and lots of test failures of the form:

```
File "src/doc/en/prep/Symbolics-and-Basic-Plotting.rst", line 487, in doc.en.prep.Symbolics-and-Basic-Plotting
Failed example:
    implicit_plot3d(p, (x, -r, r), (y, -r, r), (z, -r, r), plot_points=50, color='yellow')
Expected:
    Graphics3d Object
Got:
    doctest:warning
      File "/home/buildbot-sage/slave/sage_git/build/src/bin/sage-runtests", line 179, in <module>
        err = DC.run()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1238, in run
        self.run_doctests()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/control.py", line 939, in run_do
ctests
        self.dispatcher.dispatch()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2033, in dispat
ch
        self.parallel_dispatch()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1925, in parall
el_dispatch
        w.start()  # This might take some time
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2200, in start
        super(DocTestWorker, self).start()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2172, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2504, in __call
__
        doctests, extras = self._run(runner, options, results)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2553, in _run
        result = runner.run(test)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 897, in run
        return self._run(test, compileflags, out)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compil
e_and_execute
        exec(compiled, globs)
      File "<doctest doc.en.prep.Symbolics-and-Basic-Plotting[45]>", line 1, in <module>
        implicit_plot3d(p, (x, -r, r), (y, -r, r), (z, -r, r), plot_points=Integer(50), color='yellow')
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 811, in displayhook
        plain_text, rich_output = self._rich_output_formatter(obj, dict())
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 625, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py", line 585, in _call_rich_repr
        return obj._rich_repr_(self)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/tachyon.py", line 138, in __call__
        open(modelfile,'w').write(model)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    ResourceWarning: unclosed file <_io.TextIOWrapper name='/home/buildbot-sage/slave/sage_git/dot_sage/temp/zen/3222347/tmp_j8lfc7ax.dat' mode='w' encoding='UTF-8'>
    Graphics3d Object
```

Branch/Commit: 1db03d67c2e30b9b9ae507d7e4a6d4d15b951352

Reviewer: Volker Braun

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28833





---

archive/issue_comments_403168.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-12-02T18:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403168",
    "user": "https://github.com/vbraun"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_403169.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graphics.",
    "created_at": "2019-12-02T18:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403169",
    "user": "https://github.com/vbraun"
}
```

Changing component from PLEASE CHANGE to graphics.



---

archive/issue_comments_403170.json:
```json
{
    "body": "<a id='comment:2'></a>Here is a first tentative. I may have missed some.\n\n---\nNew commits:",
    "created_at": "2019-12-02T19:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403170",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>Here is a first tentative. I may have missed some.

---
New commits:



---

archive/issue_comments_403171.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-03T08:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403171",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403172.json:
```json
{
    "body": "<a id='comment:4'></a>green bot",
    "created_at": "2019-12-03T14:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403172",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>green bot



---

archive/issue_comments_403173.json:
```json
{
    "body": "<a id='comment:5'></a>There are a couple of others, e.g. use \n\n```\negrep -r 'open\\([^)]*\\)\\.read' src/sage\n```\nbut we can also postpone these for later if you rather want to merge the current state (please set to positive review in that case)",
    "created_at": "2019-12-03T23:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403173",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>There are a couple of others, e.g. use 

```
egrep -r 'open\([^)]*\)\.read' src/sage
```
but we can also postpone these for later if you rather want to merge the current state (please set to positive review in that case)



---

archive/issue_comments_403174.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-04T09:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403174",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403175.json:
```json
{
    "body": "<a id='comment:6'></a>Let us first merge this.",
    "created_at": "2019-12-04T09:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403175",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>Let us first merge this.



---

archive/issue_comments_403176.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-04T09:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403176",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_072902.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-08T21:19:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28833#event-72902"
}
```



---

archive/issue_comments_403177.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-08T21:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28833#issuecomment-403177",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
