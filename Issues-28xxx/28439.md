# Issue 28439: Improve parsing in interact mode of interfaces

archive/issues_028202.json:
```json
{
    "body": "The function `Interface.interact()` gives interactive access to the interpreter session of a pexpect interface that is running in the background. This ticket fixes the following issues with the output:\n\n- whitespace is incorrectly stripped from the front of the output string\n- special characters are not properly escaped\n- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses\n\n---\n\nThe whitespace issues are particularly frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:\n\n```\nsage: macaulay2.interact()\n\n  --> Switching to Macaulay2 <--\n\nmacaulay2: M = ZZ^2\n2\nZZ\n\nZZ-module, free\n```\n\nAn artificial example using a standard interface which shows whitespace and escaping issue:\n\n```\nsage: gap.interact()\n\n  --> Switching to Gap <--\n\ngap: Print(\"  \\\\\\\\\")\n\\\n```\n\nWith the usual `gap.eval()` the escaping is done correctly, but in the case of Gap, whitespace is still stripped from the front.\n\n```\nsage: gap.eval(r'Print(\"  \\\\\\\\\")')\n\\\\\n```\n\nI changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.\n\nAs for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and the results are converted to Gap. Previously, this only worked for very simple expressions not containing any parenthesis.\n\n```\nsage: %gap\n\n  --> Switching to Gap <--\n\ngap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))\n-12\n```\n\nKeywords: macaulay2, gap\n\nBranch/Commit: dc0d96983484834ac32dd7c192d04e23c9f5f8c8\n\nReviewer: Travis Scrimshaw\n\nAuthor: Markus Wageringel\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28439\n\n",
    "closed_at": "2019-09-05T21:32:56Z",
    "created_at": "2019-09-01T11:42:23Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Improve parsing in interact mode of interfaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28439",
    "user": "https://github.com/mwageringel"
}
```
The function `Interface.interact()` gives interactive access to the interpreter session of a pexpect interface that is running in the background. This ticket fixes the following issues with the output:

- whitespace is incorrectly stripped from the front of the output string
- special characters are not properly escaped
- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses

---

The whitespace issues are particularly frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:

```
sage: macaulay2.interact()

  --> Switching to Macaulay2 <--

macaulay2: M = ZZ^2
2
ZZ

ZZ-module, free
```

An artificial example using a standard interface which shows whitespace and escaping issue:

```
sage: gap.interact()

  --> Switching to Gap <--

gap: Print("  \\\\")
\
```

With the usual `gap.eval()` the escaping is done correctly, but in the case of Gap, whitespace is still stripped from the front.

```
sage: gap.eval(r'Print("  \\\\")')
\\
```

I changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.

As for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and the results are converted to Gap. Previously, this only worked for very simple expressions not containing any parenthesis.

```
sage: %gap

  --> Switching to Gap <--

gap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))
-12
```

Keywords: macaulay2, gap

Branch/Commit: dc0d96983484834ac32dd7c192d04e23c9f5f8c8

Reviewer: Travis Scrimshaw

Author: Markus Wageringel

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28439





---

archive/issue_comments_423918.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-09-01T11:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423918",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_423919.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-01T11:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423919",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423920.json:
```json
{
    "body": "<a id='comment:2'></a>I suggest testing this in the terminal, as in the Jupyter notebook there does not seem to be a way to exit the subshells.\n\nThe remaining pyflakes warning is a false positive.",
    "created_at": "2019-09-01T11:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423920",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>I suggest testing this in the terminal, as in the Jupyter notebook there does not seem to be a way to exit the subshells.

The remaining pyflakes warning is a false positive.



---

archive/issue_comments_423921.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-01T14:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423921",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_423922.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-01T15:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423922",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423923.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-01T16:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423923",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423924.json:
```json
{
    "body": "<a id='comment:5'></a>I have fixed another problem, see the description.",
    "created_at": "2019-09-01T16:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423924",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>I have fixed another problem, see the description.



---

archive/issue_comments_423925.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,6 +2,7 @@\n \n - whitespace is incorrectly stripped from the front of the output string\n - special characters are not properly escaped\n+- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses\n \n The whitespace issues are particular frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:\n \n@@ -37,6 +38,17 @@\n \n I changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.\n \n+As for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and converted to Gap.\n+\n+```\n+sage: %gap\n+\n+  --> Switching to Gap <--\n+\n+gap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))\n+-12\n+```\n+\n Comment: 1\n \n Summary: Fix output formatting in interact mode of interfaces\n``````\n",
    "created_at": "2019-09-01T16:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423925",
    "user": "https://github.com/mwageringel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,6 +2,7 @@
 
 - whitespace is incorrectly stripped from the front of the output string
 - special characters are not properly escaped
+- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses
 
 The whitespace issues are particular frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:
 
@@ -37,6 +38,17 @@
 
 I changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.
 
+As for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and converted to Gap.
+
+```
+sage: %gap
+
+  --> Switching to Gap <--
+
+gap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))
+-12
+```
+
 Comment: 1
 
 Summary: Fix output formatting in interact mode of interfaces
``````




---

archive/issue_comments_423926.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-01T18:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423926",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_423927.json:
```json
{
    "body": "<a id='comment:7'></a>Rebased to fix an incorrect trac link in the first commit spotted by the patchbot.",
    "created_at": "2019-09-01T19:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423927",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>Rebased to fix an incorrect trac link in the first commit spotted by the patchbot.



---

archive/issue_comments_423928.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,55 @@\n+The function `Interface.interact()` gives interactive access to the interpreter session of a pexpect interface that is running in the background. This ticket fixes the following issues with the output:\n \n+- whitespace is incorrectly stripped from the front of the output string\n+- special characters are not properly escaped\n+- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses\n+\n+---\n+\n+The whitespace issues are particularly frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:\n+\n+```\n+sage: macaulay2.interact()\n+\n+  --> Switching to Macaulay2 <--\n+\n+macaulay2: M = ZZ^2\n+2\n+ZZ\n+\n+ZZ-module, free\n+```\n+\n+An artificial example using a standard interface which shows whitespace and escaping issue:\n+\n+```\n+sage: gap.interact()\n+\n+  --> Switching to Gap <--\n+\n+gap: Print(\"  \\\\\\\\\")\n+\\\n+```\n+\n+With the usual `gap.eval()` the escaping is done correctly, but in the case of Gap, whitespace is still stripped from the front.\n+\n+```\n+sage: gap.eval(r'Print(\"  \\\\\\\\\")')\n+\\\\\n+```\n+\n+I changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.\n+\n+As for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and the results are converted to Gap. Previously, this only worked for very simple expressions not containing any parenthesis.\n+\n+```\n+sage: %gap\n+\n+  --> Switching to Gap <--\n+\n+gap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))\n+-12\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-09-01T19:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423928",
    "user": "https://github.com/mwageringel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,55 @@
+The function `Interface.interact()` gives interactive access to the interpreter session of a pexpect interface that is running in the background. This ticket fixes the following issues with the output:
 
+- whitespace is incorrectly stripped from the front of the output string
+- special characters are not properly escaped
+- the syntax `sage(...)` for evaluating expressions in Sage does not support nested parentheses
+
+---
+
+The whitespace issues are particularly frequent with interfaces that use ASCII art for printing like Mathematica and Macaulay2:
+
+```
+sage: macaulay2.interact()
+
+  --> Switching to Macaulay2 <--
+
+macaulay2: M = ZZ^2
+2
+ZZ
+
+ZZ-module, free
+```
+
+An artificial example using a standard interface which shows whitespace and escaping issue:
+
+```
+sage: gap.interact()
+
+  --> Switching to Gap <--
+
+gap: Print("  \\\\")
+\
+```
+
+With the usual `gap.eval()` the escaping is done correctly, but in the case of Gap, whitespace is still stripped from the front.
+
+```
+sage: gap.eval(r'Print("  \\\\")')
+\\
+```
+
+I changed the Gap interface to preserve whitespace at the front in order to be able to add a doctest for `interact` using a standard interface.
+
+As for the nested parentheses,  the following example now works. The expressions `sage(...)` are evaluated in Sage and the results are converted to Gap. Previously, this only worked for very simple expressions not containing any parenthesis.
+
+```
+sage: %gap
+
+  --> Switching to Gap <--
+
+gap: 2 + sage((1+2)*gap(-(5-3)^2).sage()) - sage(1+(2-1))
+-12
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_423929.json:
```json
{
    "body": "<a id='comment:8'></a>All of these changes make sense and look good.",
    "created_at": "2019-09-03T00:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423929",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>All of these changes make sense and look good.



---

archive/issue_comments_423930.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-03T00:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423930",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423931.json:
```json
{
    "body": "<a id='comment:9'></a>Thanks.",
    "created_at": "2019-09-03T06:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423931",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>Thanks.



---

archive/issue_comments_423932.json:
```json
{
    "body": "<a id='comment:10'></a>I kept noticing incorrect stripping of initial whitespace without ever\ndoing anything about it.\n\nFinally initial whitespace will be preserved. Wholehearted thanks for that!",
    "created_at": "2019-09-04T14:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423932",
    "user": "https://github.com/slel"
}
```

<a id='comment:10'></a>I kept noticing incorrect stripping of initial whitespace without ever
doing anything about it.

Finally initial whitespace will be preserved. Wholehearted thanks for that!



---

archive/issue_comments_423933.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-09-05T21:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28439#issuecomment-423933",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_071203.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-09-05T21:32:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28439",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28439#event-71203"
}
```
