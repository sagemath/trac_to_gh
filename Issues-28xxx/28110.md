# Issue 28110: Bug in Hilbert series computation

archive/issues_027873.json:
```json
{
    "body": "As reported on [sage devel](https://groups.google.com/forum/#!topic/sage-devel/_ThtY26ITmI), there appear to be errors in the current default algorithm for the computation of Hilbert series/polynomials:\n\n```\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial()\n....: \n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\n<ipython-input-1-8603fe52d058> in <module>()\n      1 P = PolynomialRing(QQ, names=('x', 'y', 'z',)); (x, y, z,) = P._first_ngens(3)\n      2 I = Ideal([x**Integer(3), x*y**Integer(2), y**Integer(4), x**Integer(2)*y*z, y**Integer(3)*z, x**Integer(2)*z**Integer(2), x*y*z**Integer(2), x*z**Integer(3)])\n----> 3 I.hilbert_polynomial()\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)\n    295         if not R.base_ring().is_field():\n    296             raise ValueError(\"Coefficient ring must be a field for function '%s'.\"%(self.f.__name__))\n--> 297         return self.f(self._instance, *args, **kwds)\n    298 \n    299 require_field = RequireField\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in hilbert_polynomial(self, algorithm)\n   2516             out = sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1))\n   2517                       for n,c in enumerate(second_hilbert)) + t.parent().zero()\n-> 2518             assert out.leading_coefficient() >= 0\n   2519             return out\n   2520         elif algorithm == 'singular':\n\nAssertionError: \n```\nSingular can solve this example.\n\n**Keywords:** Hilbert polynomial\n\n**Branch/Commit:** [37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)\n\n**Reviewer:** Fr\u00e9d\u00e9ric Chapoton\n\n**Author:** Grayson Jorgenson\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28110\n\n",
    "closed_at": "2019-08-04T07:25:31Z",
    "created_at": "2019-07-03T20:08:58Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Bug in Hilbert series computation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28110",
    "user": "https://github.com/simon-king-jena"
}
```
As reported on [sage devel](https://groups.google.com/forum/#!topic/sage-devel/_ThtY26ITmI), there appear to be errors in the current default algorithm for the computation of Hilbert series/polynomials:

```
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial()
....: 
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-1-8603fe52d058> in <module>()
      1 P = PolynomialRing(QQ, names=('x', 'y', 'z',)); (x, y, z,) = P._first_ngens(3)
      2 I = Ideal([x**Integer(3), x*y**Integer(2), y**Integer(4), x**Integer(2)*y*z, y**Integer(3)*z, x**Integer(2)*z**Integer(2), x*y*z**Integer(2), x*z**Integer(3)])
----> 3 I.hilbert_polynomial()

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)
    295         if not R.base_ring().is_field():
    296             raise ValueError("Coefficient ring must be a field for function '%s'."%(self.f.__name__))
--> 297         return self.f(self._instance, *args, **kwds)
    298 
    299 require_field = RequireField

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in hilbert_polynomial(self, algorithm)
   2516             out = sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1))
   2517                       for n,c in enumerate(second_hilbert)) + t.parent().zero()
-> 2518             assert out.leading_coefficient() >= 0
   2519             return out
   2520         elif algorithm == 'singular':

AssertionError: 
```
Singular can solve this example.

**Keywords:** Hilbert polynomial

**Branch/Commit:** [37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)

**Reviewer:** Frédéric Chapoton

**Author:** Grayson Jorgenson

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/28110





---

archive/issue_comments_545992.json:
```json
{
    "body": "<a id='comment:1'></a>\nAfter removing the assertion, I get\n\n```\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial(algorithm='singular')\n....: \n3\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial()\n....: \n-3\n```\nSo, for a reason that I do not understand yet, there is a negative count.",
    "created_at": "2019-07-03T20:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545992",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
After removing the assertion, I get

```
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial(algorithm='singular')
....: 
3
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial()
....: 
-3
```
So, for a reason that I do not understand yet, there is a negative count.



---

archive/issue_comments_545993.json:
```json
{
    "body": "<a id='comment:2'></a>\nI think thats just because our numerator of the hilbert series is not normalized to be monic:\n\n```\nsage: P.ideal(x^2, x*y^2, y^2, z*x).hilbert_series()\n(t^3 - 2*t - 1)/(t - 1)\nsage: P.ideal(x^2, x*y^2, y^2).hilbert_series()\n(t^2 + 2*t + 1)/(-t + 1)\n```",
    "created_at": "2019-07-03T22:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545993",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
I think thats just because our numerator of the hilbert series is not normalized to be monic:

```
sage: P.ideal(x^2, x*y^2, y^2, z*x).hilbert_series()
(t^3 - 2*t - 1)/(t - 1)
sage: P.ideal(x^2, x*y^2, y^2).hilbert_series()
(t^2 + 2*t + 1)/(-t + 1)
```



---

archive/issue_comments_545994.json:
```json
{
    "body": "<a id='comment:3'></a>\nI made an attempt at fixing this. If I understand correctly, the Sage algorithm for computing the Hilbert polynomial is working by expanding out the Hilbert series. Past the term of index the Hilbert regularity, the expression for the coefficients becomes the Hilbert polynomial. It seems the line managing the combinatorics of this expansion\n\n```\nsum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1)) for n,c in enumerate(second_hilbert))}}}\n\nis assuming the denominator of the series is of the form {{{(1 - t)^s}}}. I've added a check to ensure this is the case, scaling if needed. Note this issue was only a problem when the denominator of the series had odd degree.\n----\n**New commits:**\n<table></table>\n",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545994",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

<a id='comment:3'></a>
I made an attempt at fixing this. If I understand correctly, the Sage algorithm for computing the Hilbert polynomial is working by expanding out the Hilbert series. Past the term of index the Hilbert regularity, the expression for the coefficients becomes the Hilbert polynomial. It seems the line managing the combinatorics of this expansion

```
sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1)) for n,c in enumerate(second_hilbert))}}}

is assuming the denominator of the series is of the form {{{(1 - t)^s}}}. I've added a check to ensure this is the case, scaling if needed. Note this issue was only a problem when the denominator of the series had odd degree.
----
**New commits:**
<table></table>




---

archive/issue_comments_545995.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545995",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_545996.json:
```json
{
    "body": "**Author:** Grayson Jorgenson",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545996",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

**Author:** Grayson Jorgenson



---

archive/issue_comments_545997.json:
```json
{
    "body": "**Branch:** [u/gjorgenson/28110_hilbert_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/gjorgenson/28110_hilbert_poly)",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545997",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

**Branch:** [u/gjorgenson/28110_hilbert_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/gjorgenson/28110_hilbert_poly)



---

archive/issue_comments_545998.json:
```json
{
    "body": "**Commit:** [7938a7413243b208ba7f6370806a202d512cd61a](https://github.com/sagemath/sagetrac-mirror/commit/7938a7413243b208ba7f6370806a202d512cd61a)",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545998",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

**Commit:** [7938a7413243b208ba7f6370806a202d512cd61a](https://github.com/sagemath/sagetrac-mirror/commit/7938a7413243b208ba7f6370806a202d512cd61a)



---

archive/issue_comments_545999.json:
```json
{
    "body": "<a id='comment:4'></a>\nno space after `:trac:`",
    "created_at": "2019-08-01T15:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-545999",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
no space after `:trac:`



---

archive/issue_comments_546000.json:
```json
{
    "body": "**Changing commit** from \"[7938a7413243b208ba7f6370806a202d512cd61a](https://github.com/sagemath/sagetrac-mirror/commit/7938a7413243b208ba7f6370806a202d512cd61a)\" to \"[37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)\".",
    "created_at": "2019-08-01T22:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546000",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7938a7413243b208ba7f6370806a202d512cd61a](https://github.com/sagemath/sagetrac-mirror/commit/7938a7413243b208ba7f6370806a202d512cd61a)" to "[37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)".



---

archive/issue_comments_546001.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45\">37f3c75</a></td><td><code>28110: remove extra space</code></td></tr></table>\n",
    "created_at": "2019-08-01T22:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546001",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45">37f3c75</a></td><td><code>28110: remove extra space</code></td></tr></table>




---

archive/issue_comments_546002.json:
```json
{
    "body": "<a id='comment:6'></a>\nok, then",
    "created_at": "2019-08-02T07:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546002",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
ok, then



---

archive/issue_comments_546003.json:
```json
{
    "body": "**Reviewer:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2019-08-02T07:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546003",
    "user": "https://github.com/fchapoton"
}
```

**Reviewer:** Frédéric Chapoton



---

archive/issue_comments_546004.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2019-08-02T07:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546004",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_546005.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2019-08-04T07:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546005",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_comments_546006.json:
```json
{
    "body": "**Changing branch** from \"[u/gjorgenson/28110_hilbert_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/gjorgenson/28110_hilbert_poly)\" to \"[37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)\".",
    "created_at": "2019-08-04T07:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28110#issuecomment-546006",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/gjorgenson/28110_hilbert_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/gjorgenson/28110_hilbert_poly)" to "[37f3c75798a21b096e49b3756529457dd62f9e45](https://github.com/sagemath/sagetrac-mirror/commit/37f3c75798a21b096e49b3756529457dd62f9e45)".



---

archive/issue_events_079021.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-04T07:25:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28110",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28110#event-79021"
}
```
