# Issue 28074: Fix caching of Macaulay2 polynomial rings

archive/issues_027837.json:
```json
{
    "body": "This ticket:\n\n- adds caching of univariate Macaulay2 polynomial rings;\n\n- fixes an issue where, upon conversion of an ideal from Sage to Macaulay2, the Macaulay2 ring that is already cached does not get re-used, but is reconstructed instead;\n\n```\nsage: R.<x,y> = QQ[]\nsage: R1 = macaulay2(R)\nsage: I = R.ideal(y^2 - x)\nsage: R2 = macaulay2(I).ring()\nsage: R1._operator('===', R2)   # should be true\nfalse\n```\n\n- moves `is_exact()` from `MPolynomialRing_macaulay2_repr` to `MPolynomialRing_base` where it seems to belong.\n\n\nCC:  @dimpase @saliola\n\nKeywords: Macaulay2\n\nBranch/Commit: 5709e615c731313dedbaa23ec09d07a9b7bf5cf7\n\nReviewer: Dima Pasechnik\n\nAuthor: Markus Wageringel\n\nDependencies: #27979\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28074\n\n",
    "closed_at": "2019-10-06T23:06:56Z",
    "created_at": "2019-06-27T18:52:14Z",
    "labels": [
        "component: interfaces: optional",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Fix caching of Macaulay2 polynomial rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28074",
    "user": "https://github.com/mwageringel"
}
```
This ticket:

- adds caching of univariate Macaulay2 polynomial rings;

- fixes an issue where, upon conversion of an ideal from Sage to Macaulay2, the Macaulay2 ring that is already cached does not get re-used, but is reconstructed instead;

```
sage: R.<x,y> = QQ[]
sage: R1 = macaulay2(R)
sage: I = R.ideal(y^2 - x)
sage: R2 = macaulay2(I).ring()
sage: R1._operator('===', R2)   # should be true
false
```

- moves `is_exact()` from `MPolynomialRing_macaulay2_repr` to `MPolynomialRing_base` where it seems to belong.


CC:  @dimpase @saliola

Keywords: Macaulay2

Branch/Commit: 5709e615c731313dedbaa23ec09d07a9b7bf5cf7

Reviewer: Dima Pasechnik

Author: Markus Wageringel

Dependencies: #27979

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28074





---

archive/issue_comments_418564.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-27T19:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418564",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_418565.json:
```json
{
    "body": "<a id='comment:1'></a>This is accomplished by refactoring and deduplicating some code related to the conversion. In some places, I replaced `_macaulay2_()` methods by implementations of `_macaulay2_init_()` which returns a string to be used as input for the Macaulay2 interpreter. This has the advantage that the generic interface mechanism in `sage.structure.sage_object` then takes care of the caching. The methods `_macaulay2_set_ring()` and `_macaulay2_base_str()` are removed.\n\n(For the future \u2013 not in this ticket \u2013 it would also be nice to have caching when converting in the other direction, from Macaulay2 to Sage, so that the new Sage object remembers the Macaulay2 element it was constructed from. However, none of the interfaces seem to be doing this currently, as far as I can tell, so this could be more complicated to deal with.)\n\nThis branch is based on #27979 to avoid merge conflicts. Only the last commit is new. I tested this with Macaulay2 version 1.12 and Python 2 and 3.\n\n---\nNew commits:",
    "created_at": "2019-06-27T19:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418565",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:1'></a>This is accomplished by refactoring and deduplicating some code related to the conversion. In some places, I replaced `_macaulay2_()` methods by implementations of `_macaulay2_init_()` which returns a string to be used as input for the Macaulay2 interpreter. This has the advantage that the generic interface mechanism in `sage.structure.sage_object` then takes care of the caching. The methods `_macaulay2_set_ring()` and `_macaulay2_base_str()` are removed.

(For the future – not in this ticket – it would also be nice to have caching when converting in the other direction, from Macaulay2 to Sage, so that the new Sage object remembers the Macaulay2 element it was constructed from. However, none of the interfaces seem to be doing this currently, as far as I can tell, so this could be more complicated to deal with.)

This branch is based on #27979 to avoid merge conflicts. Only the last commit is new. I tested this with Macaulay2 version 1.12 and Python 2 and 3.

---
New commits:



---

archive/issue_comments_418566.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-28T15:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418566",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_418567.json:
```json
{
    "body": "<a id='comment:3'></a>I have just fixed 2 pyflakes warnings. The remaining one is about `long` which is dealt with in #27826.",
    "created_at": "2019-06-28T15:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418567",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:3'></a>I have just fixed 2 pyflakes warnings. The remaining one is about `long` which is dealt with in #27826.



---

archive/issue_comments_418568.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-29T09:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_418569.json:
```json
{
    "body": "<a id='comment:5'></a>I rebased on 8.9.beta4 and changed the signature of `is_exact` to resolve a Cython warning.",
    "created_at": "2019-07-29T09:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418569",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>I rebased on 8.9.beta4 and changed the signature of `is_exact` to resolve a Cython warning.



---

archive/issue_comments_418570.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-19T18:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_418571.json:
```json
{
    "body": "<a id='comment:8'></a>Rebased.",
    "created_at": "2019-08-19T18:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418571",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:8'></a>Rebased.



---

archive/issue_comments_418572.json:
```json
{
    "body": "<a id='comment:9'></a>red branch",
    "created_at": "2019-09-18T18:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418572",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>red branch



---

archive/issue_comments_418573.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-18T18:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418573",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_418574.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-18T19:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418574",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_418575.json:
```json
{
    "body": "<a id='comment:10'></a>New commits:",
    "created_at": "2019-09-18T19:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418575",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>New commits:



---

archive/issue_comments_418576.json:
```json
{
    "body": "<a id='comment:11'></a>looks good to me. Sorry for sitting on it for so long.",
    "created_at": "2019-09-18T19:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418576",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>looks good to me. Sorry for sitting on it for so long.



---

archive/issue_comments_418577.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-18T19:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418577",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_418578.json:
```json
{
    "body": "<a id='comment:12'></a>moving milestone to 9.0 (after release of 8.9)",
    "created_at": "2019-09-30T08:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418578",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>moving milestone to 9.0 (after release of 8.9)



---

archive/issue_events_069577.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-09-30T08:12:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28074#event-69577"
}
```



---

archive/issue_events_069578.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-06T23:06:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28074#event-69578"
}
```



---

archive/issue_comments_418579.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-06T23:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28074#issuecomment-418579",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
