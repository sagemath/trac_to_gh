# Issue 28394: comparison of sage rationals with gmpy2 mpq broken

archive/issues_028157.json:
```json
{
    "body": "```\nsage: import gmpy2\nsage: gmpy2.mpq(5,3) == 5/3\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-7445d1641afe> in <module>()\n----> 1 gmpy2.mpq(Integer(5),Integer(3)) == Integer(5)/Integer(3)\n\nTypeError: cannot convert object to mpq\nsage: 5/3 == gmpy2.mpq(5,3)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-593205bfa17f> in <module>()\n----> 1 Integer(5)/Integer(3) == gmpy2.mpq(Integer(5),Integer(3))\n\n/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational.__richcmp__ (build/cythonized/sage/rings/rational.c:9498)()\n    868             c = mpq_cmp_si((<Rational>left).value, PyInt_AS_LONG(right), 1)\n    869         else:\n--> 870             return coercion_model.richcmp(left, right, op)\n    871 \n    872         return rich_to_bool_sgn(op, c)\n\n/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19779)()\n   1946         # we would end up trying the same coercion again.\n   1947         if not y_is_Element and Py_TYPE(y).tp_richcompare:\n-> 1948             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))\n   1949             if res is not NotImplemented:\n   1950                 return res\n\nTypeError: cannot convert object to mpq\n```\nSage integers are perfectly fine\n\n```\nsage: gmpy2.mpz(3) == 3\nTrue\nsage: 3 == gmpy2.mpz(3)\nTrue\n```\n\ngmpy2's [issue #251](https://github.com/aleaxit/gmpy/issues/251)\n\nCC:  @vinklein\n\nBranch/Commit: 21d07f652037874491cfa08dc569d10a30285084\n\nUpstream: Fixed upstream, in a later stable release.\n\nReviewer: Matthias Koeppe\n\nAuthor: Vincent Delecroix\n\nDependencies: #30583\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/28394\n\n",
    "closed_at": "2020-09-23T21:27:52Z",
    "created_at": "2019-08-24T14:15:47Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "comparison of sage rationals with gmpy2 mpq broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28394",
    "user": "https://github.com/videlec"
}
```
```
sage: import gmpy2
sage: gmpy2.mpq(5,3) == 5/3
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-7445d1641afe> in <module>()
----> 1 gmpy2.mpq(Integer(5),Integer(3)) == Integer(5)/Integer(3)

TypeError: cannot convert object to mpq
sage: 5/3 == gmpy2.mpq(5,3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-593205bfa17f> in <module>()
----> 1 Integer(5)/Integer(3) == gmpy2.mpq(Integer(5),Integer(3))

/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational.__richcmp__ (build/cythonized/sage/rings/rational.c:9498)()
    868             c = mpq_cmp_si((<Rational>left).value, PyInt_AS_LONG(right), 1)
    869         else:
--> 870             return coercion_model.richcmp(left, right, op)
    871 
    872         return rich_to_bool_sgn(op, c)

/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19779)()
   1946         # we would end up trying the same coercion again.
   1947         if not y_is_Element and Py_TYPE(y).tp_richcompare:
-> 1948             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))
   1949             if res is not NotImplemented:
   1950                 return res

TypeError: cannot convert object to mpq
```
Sage integers are perfectly fine

```
sage: gmpy2.mpz(3) == 3
True
sage: 3 == gmpy2.mpz(3)
True
```

gmpy2's [issue #251](https://github.com/aleaxit/gmpy/issues/251)

CC:  @vinklein

Branch/Commit: 21d07f652037874491cfa08dc569d10a30285084

Upstream: Fixed upstream, in a later stable release.

Reviewer: Matthias Koeppe

Author: Vincent Delecroix

Dependencies: #30583

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/28394





---

archive/issue_comments_423243.json:
```json
{
    "body": "<a id='comment:1'></a>It looks likes it's a gmpy2 bug.\n\n```\npython3.7\nPython 3.7.4 (default, Jul  9 2019, 03:52:42) \n[GCC 5.4.0 20160609] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from gmpy2 import mpz, mpq\n>>> class Q:\n...     def __mpq__(self): return mpq(3,2)\n... \n>>> q = Q()\n>>> mpq(3, 2) * q\nmpq(9,4)\n>>> mpq(3, 2) == q\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: cannot convert object to mpq\n>>> from gmpy2 import cmp\n>>> cmp(mpq(3,2), q)\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: cannot convert object to mpq\n>>> cmp(mpq(3,2), mpq(3,2))\n0\n```",
    "created_at": "2019-08-26T08:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423243",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:1'></a>It looks likes it's a gmpy2 bug.

```
python3.7
Python 3.7.4 (default, Jul  9 2019, 03:52:42) 
[GCC 5.4.0 20160609] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from gmpy2 import mpz, mpq
>>> class Q:
...     def __mpq__(self): return mpq(3,2)
... 
>>> q = Q()
>>> mpq(3, 2) * q
mpq(9,4)
>>> mpq(3, 2) == q
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: cannot convert object to mpq
>>> from gmpy2 import cmp
>>> cmp(mpq(3,2), q)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: cannot convert object to mpq
>>> cmp(mpq(3,2), mpq(3,2))
0
```



---

archive/issue_comments_423244.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -38,6 +38,8 @@\n True\n ```\n \n+gmpy2's [issue #251](https://github.com/aleaxit/gmpy/issues/251)\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/28394\n```\n",
    "created_at": "2019-08-26T08:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423244",
    "user": "https://github.com/vinklein"
}
```

Description changed:
```diff
--- 
+++ 
@@ -38,6 +38,8 @@
 True
 ```
 
+gmpy2's [issue #251](https://github.com/aleaxit/gmpy/issues/251)
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/28394
```




---

archive/issue_comments_423245.json:
```json
{
    "body": "<a id='comment:4'></a>Do you think this need a patch ?\n\nIMHO it's not necessary. You can call `__mpq__` explicitly if needed :\n\n```\nsage: from gmpy2 import mpq\nsage: q = 5/3\nsage: q.__mpq__() == mpq(5,3)\nTrue\nsage: mpq(q) == mpq(5,3)\nTrue\n```",
    "created_at": "2019-08-27T07:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423245",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>Do you think this need a patch ?

IMHO it's not necessary. You can call `__mpq__` explicitly if needed :

```
sage: from gmpy2 import mpq
sage: q = 5/3
sage: q.__mpq__() == mpq(5,3)
True
sage: mpq(q) == mpq(5,3)
True
```



---

archive/issue_comments_423246.json:
```json
{
    "body": "<a id='comment:5'></a>Thank you. I agree with you that there is no need for a patch.",
    "created_at": "2019-08-27T08:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423246",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Thank you. I agree with you that there is no need for a patch.



---

archive/issue_comments_423247.json:
```json
{
    "body": "<a id='comment:6'></a>Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423247",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Ticket retargeted after milestone closed



---

archive/issue_events_070999.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28394#event-70999"
}
```



---

archive/issue_comments_423248.json:
```json
{
    "body": "<a id='comment:7'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423248",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_071000.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28394#event-71000"
}
```



---

archive/issue_events_071001.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28394#event-71001"
}
```



---

archive/issue_comments_423249.json:
```json
{
    "body": "<a id='comment:8'></a>Why `TypeError: cannot convert object to mpq`\nif converting is as simple as `mpq(5/3)`?",
    "created_at": "2020-09-16T00:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423249",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>Why `TypeError: cannot convert object to mpq`
if converting is as simple as `mpq(5/3)`?



---

archive/issue_comments_423250.json:
```json
{
    "body": "<a id='comment:9'></a>This has been fixed upstream\n\n```\nsage: gmpy2.mpq(5,3) == 5/3\nTrue\nsage: 5/3 == gmpy2.mpq(5,3)\nTrue\n```\nEDIT: in version 2.1.0b4",
    "created_at": "2020-09-16T06:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423250",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>This has been fixed upstream

```
sage: gmpy2.mpq(5,3) == 5/3
True
sage: 5/3 == gmpy2.mpq(5,3)
True
```
EDIT: in version 2.1.0b4



---

archive/issue_comments_423251.json:
```json
{
    "body": "<a id='comment:11'></a>New commits:",
    "created_at": "2020-09-16T07:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423251",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>New commits:



---

archive/issue_comments_423252.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-16T07:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423252",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423253.json:
```json
{
    "body": "<a id='comment:13'></a>New commits:",
    "created_at": "2020-09-16T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423253",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>New commits:



---

archive/issue_comments_423254.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-16T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423254",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423255.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-23T21:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28394#issuecomment-423255",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_071002.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-23T21:27:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28394",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28394#event-71002"
}
```
