# Issue 28489: py3 + OS X: symbolic/expression.pyx

archive/issues_028252.json:
```json
{
    "body": "On OS X, I get intermittent failures with symbolic/expression.pyx:\n\n```\nsage -t src/sage/symbolic/expression.pyx\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 7122, in sage.symbolic.expression.Expression.gcd\nFailed example:\n    gcd(alg + alg*x, x^2 - 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py\", line 1771, in gcd\n        return m(b, **kwargs)\n      File \"sage/symbolic/expression.pyx\", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)\n        cdef GEx x = g_gcd(self._gobj, r._gobj)\n      File \"sage/structure/element.pyx\", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression.Expression.gcd[13]>\", line 1, in <module>\n        gcd(alg + alg*x, x**Integer(2) - Integer(1))\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py\", line 1773, in gcd\n        return m(py_scalar_to_element(b), **kwargs)\n      File \"sage/symbolic/expression.pyx\", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)\n        cdef GEx x = g_gcd(self._gobj, r._gobj)\n      File \"sage/structure/element.pyx\", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 7124, in sage.symbolic.expression.Expression.gcd\nFailed example:\n    gcd(alg - alg*x, x^2 - 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py\", line 1771, in gcd\n        return m(b, **kwargs)\n      File \"sage/symbolic/expression.pyx\", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)\n        cdef GEx x = g_gcd(self._gobj, r._gobj)\n      File \"sage/structure/element.pyx\", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression.Expression.gcd[14]>\", line 1, in <module>\n        gcd(alg - alg*x, x**Integer(2) - Integer(1))\n      File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py\", line 1773, in gcd\n        return m(py_scalar_to_element(b), **kwargs)\n      File \"sage/symbolic/expression.pyx\", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)\n        cdef GEx x = g_gcd(self._gobj, r._gobj)\n      File \"sage/structure/element.pyx\", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'\n**********************************************************************\n1 item had failures:\n   2 of  29 in sage.symbolic.expression.Expression.gcd\n    [2848 tests, 2 failures, 24.89 s]\n----------------------------------------------------------------------\nsage -t src/sage/symbolic/expression.pyx  # 2 doctests failed\n----------------------------------------------------------------------\n```\nI get these about a third of the time.\n\n**CC:**  @vbraun\n\n**Keywords:** random_fail\n\n**Branch:** [fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)\n\n**Upstream:** Reported upstream. No feedback yet.\n\n**Reviewer:** Volker Braun\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\nIssue created by migration from https://trac.sagemath.org/ticket/28489\n\n",
    "closed_at": "2019-12-01T00:38:59Z",
    "created_at": "2019-09-13T18:16:24Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3 + OS X: symbolic/expression.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28489",
    "user": "https://github.com/jhpalmieri"
}
```
On OS X, I get intermittent failures with symbolic/expression.pyx:

```
sage -t src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 7122, in sage.symbolic.expression.Expression.gcd
Failed example:
    gcd(alg + alg*x, x^2 - 1)
Exception raised:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py", line 1771, in gcd
        return m(b, **kwargs)
      File "sage/symbolic/expression.pyx", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)
        cdef GEx x = g_gcd(self._gobj, r._gobj)
      File "sage/structure/element.pyx", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.gcd[13]>", line 1, in <module>
        gcd(alg + alg*x, x**Integer(2) - Integer(1))
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py", line 1773, in gcd
        return m(py_scalar_to_element(b), **kwargs)
      File "sage/symbolic/expression.pyx", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)
        cdef GEx x = g_gcd(self._gobj, r._gobj)
      File "sage/structure/element.pyx", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 7124, in sage.symbolic.expression.Expression.gcd
Failed example:
    gcd(alg - alg*x, x^2 - 1)
Exception raised:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py", line 1771, in gcd
        return m(b, **kwargs)
      File "sage/symbolic/expression.pyx", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)
        cdef GEx x = g_gcd(self._gobj, r._gobj)
      File "sage/structure/element.pyx", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.gcd[14]>", line 1, in <module>
        gcd(alg - alg*x, x**Integer(2) - Integer(1))
      File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.7/site-packages/sage/arith/misc.py", line 1773, in gcd
        return m(py_scalar_to_element(b), **kwargs)
      File "sage/symbolic/expression.pyx", line 7169, in sage.symbolic.expression.Expression.gcd (build/cythonized/sage/symbolic/expression.cpp:40616)
        cdef GEx x = g_gcd(self._gobj, r._gobj)
      File "sage/structure/element.pyx", line 1236, in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1207, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'
**********************************************************************
1 item had failures:
   2 of  29 in sage.symbolic.expression.Expression.gcd
    [2848 tests, 2 failures, 24.89 s]
----------------------------------------------------------------------
sage -t src/sage/symbolic/expression.pyx  # 2 doctests failed
----------------------------------------------------------------------
```
I get these about a third of the time.

**CC:**  @vbraun

**Keywords:** random_fail

**Branch:** [fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)

**Upstream:** Reported upstream. No feedback yet.

**Reviewer:** Volker Braun

**Author:** Frédéric Chapoton

Issue created by migration from https://trac.sagemath.org/ticket/28489





---

archive/issue_comments_446808.json:
```json
{
    "body": "<a id='comment:1'></a>\nI can also get the error while running Sage, using the commands\n\n```\nsage: var('x,y')\n(x, y)\nsage: alg = SR(QQbar(sqrt(2) + I*sqrt(3)))\nsage: gcd(alg + alg*x, x^2 - 1)\nx + 1\n```\nThis also happens about a third of the times I run Sage. In a given Sage session, it either always works or always fails, but if I restart Sage, the behavior can change.",
    "created_at": "2019-09-13T18:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446808",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
I can also get the error while running Sage, using the commands

```
sage: var('x,y')
(x, y)
sage: alg = SR(QQbar(sqrt(2) + I*sqrt(3)))
sage: gcd(alg + alg*x, x^2 - 1)
x + 1
```
This also happens about a third of the times I run Sage. In a given Sage session, it either always works or always fails, but if I restart Sage, the behavior can change.



---

archive/issue_comments_446809.json:
```json
{
    "body": "<a id='comment:2'></a>\nI can reproduce this on OS X, but not on CentOS.",
    "created_at": "2019-09-13T19:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446809",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>
I can reproduce this on OS X, but not on CentOS.



---

archive/issue_comments_446810.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe error can be reproduced only by\n\n```\nalg = QQbar(I); gcd(x, alg)\n```\n\nIt seem that pynac intermittently triggers the following not-allowed operation\n\n```\nsage: N.<i> = NumberField(x^2+1)\nsage: QQbar(I).parent().base()(1) + i\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-fd4130c2c6dc> in <module>()\n----> 1 QQbar(I).parent().base()(Integer(1)) + i\n\n/Users/kwankyu/GitHub/sage-dev/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)()\n   1234         # Left and right are Sage elements => use coercion model\n   1235         if BOTH_ARE_ELEMENT(cl):\n-> 1236             return coercion_model.bin_op(left, right, add)\n   1237 \n   1238         cdef long value\n\n/Users/kwankyu/GitHub/sage-dev/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)()\n   1205         # We should really include the underlying error.\n   1206         # This causes so much headache.\n-> 1207         raise bin_op_exception(op, x, y)\n   1208 \n   1209     cpdef canonical_coercion(self, x, y):\n\nTypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in i with defining polynomial x^2 + 1'\n```\n\npynac experts should help.",
    "created_at": "2019-09-20T02:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446810",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:3'></a>
The error can be reproduced only by

```
alg = QQbar(I); gcd(x, alg)
```

It seem that pynac intermittently triggers the following not-allowed operation

```
sage: N.<i> = NumberField(x^2+1)
sage: QQbar(I).parent().base()(1) + i
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-fd4130c2c6dc> in <module>()
----> 1 QQbar(I).parent().base()(Integer(1)) + i

/Users/kwankyu/GitHub/sage-dev/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10816)()
   1234         # Left and right are Sage elements => use coercion model
   1235         if BOTH_ARE_ELEMENT(cl):
-> 1236             return coercion_model.bin_op(left, right, add)
   1237 
   1238         cdef long value

/Users/kwankyu/GitHub/sage-dev/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10898)()
   1205         # We should really include the underlying error.
   1206         # This causes so much headache.
-> 1207         raise bin_op_exception(op, x, y)
   1208 
   1209     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in i with defining polynomial x^2 + 1'
```

pynac experts should help.



---

archive/issue_comments_446811.json:
```json
{
    "body": "**Upstream:** Reported upstream. No feedback yet.",
    "created_at": "2019-09-20T22:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446811",
    "user": "https://github.com/jhpalmieri"
}
```

**Upstream:** Reported upstream. No feedback yet.



---

archive/issue_comments_446812.json:
```json
{
    "body": "<a id='comment:4'></a>\nReported at https://github.com/pynac/pynac/issues/348.",
    "created_at": "2019-09-20T22:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446812",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
Reported at https://github.com/pynac/pynac/issues/348.



---

archive/issue_comments_446813.json:
```json
{
    "body": "<a id='comment:5'></a>\n\n```\nsage: gcd(x, QQbar(I))\n```\n\nIn Pynac, the above computation raises the error in the [line](https://github.com/pynac/pynac/blob/pynac-0.7.26/ginac/mpoly-singular.cpp#L71)\n\n```\n        map.insert(std::make_pair(e, index));\n```\nof `replace_with_symbol` invoked from [num2canonical](https://github.com/pynac/pynac/blob/pynac-0.7.26/ginac/mpoly-singular.cpp#L106), where the expression `e` is `I` and the `insert` method is from `std::unordered_map`. At this point, using `Log(map);`, the map looks like:\n\n```\n    {4}\n    1 => 4\n    0 => 3\n    x => 2\n    symbol0 => 1\n```\nThe `insert` function will need to compute the hash of the expression `e` (which succeeds) and, upon hash collisions, will need to perform equality tests with elements that are already stored in the map. I do not know where exactly this equality test is implemented, but this must be the step that fails. This explains the randomness in the bug, as the hash values depend on the session, so a collision for `I` might or might not occur. Additionally, this might depend on the implementation of the C++ standard library \u2013 though in principle this bug can occur on every platform, even with Python 2.\n\nThe equality test seems to check whether the difference of two elements is zero, resulting in the computation of `1 + (-I)`. Here, `1` is of type `AlgebraicReal` and `-I` is a `NumberFieldElement_quadratic`.\n\n---\n\nI see two potential ways out:\n\nOne option is to always raise a `NotImplementedError` when attempting to compute the GCD of symbolic polynomials. As per the documentation, it does not reliably give correct results anyway:\n\n```\n        Embedded Sage objects of all kinds get basic support. Note that\n        full algebraic GCD is not implemented yet::\n\n            ...\n            sage: sqrt2 = SR(QQbar(sqrt(2)))\n            sage: gcd(sqrt2 + x, x^2 - 2)    # known bug\n            1\n```\n\nThe other option is to make the following addition work. And by my understanding of the coercion framework, it actually should work, as both arguments coerce to `CLF`, since the quadratic number field `N` comes with a complex embedding:\n\n```\nsage: N, i_neg, emb = QQbar(-I).as_number_field_element()\nsage: AA(1) + i_neg  # this should work\n...\nTypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'\nsage: N.coerce_embedding()\nGeneric morphism:\n  From: Number Field in I with defining polynomial x^2 + 1 with I = 1*I\n  To:   Complex Lazy Field\n  Defn: I -> 1*I\nsage: CLF.has_coerce_map_from(AA), CLF.has_coerce_map_from(N)\n(True, True)\nsage: CLF(AA(1)) + CLF(i_neg)\n1 - 1*I\n```\nMaking this addition work could be quite useful in general. Any suggestions how to solve this?",
    "created_at": "2019-11-10T17:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446813",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>

```
sage: gcd(x, QQbar(I))
```

In Pynac, the above computation raises the error in the [line](https://github.com/pynac/pynac/blob/pynac-0.7.26/ginac/mpoly-singular.cpp#L71)

```
        map.insert(std::make_pair(e, index));
```
of `replace_with_symbol` invoked from [num2canonical](https://github.com/pynac/pynac/blob/pynac-0.7.26/ginac/mpoly-singular.cpp#L106), where the expression `e` is `I` and the `insert` method is from `std::unordered_map`. At this point, using `Log(map);`, the map looks like:

```
    {4}
    1 => 4
    0 => 3
    x => 2
    symbol0 => 1
```
The `insert` function will need to compute the hash of the expression `e` (which succeeds) and, upon hash collisions, will need to perform equality tests with elements that are already stored in the map. I do not know where exactly this equality test is implemented, but this must be the step that fails. This explains the randomness in the bug, as the hash values depend on the session, so a collision for `I` might or might not occur. Additionally, this might depend on the implementation of the C++ standard library – though in principle this bug can occur on every platform, even with Python 2.

The equality test seems to check whether the difference of two elements is zero, resulting in the computation of `1 + (-I)`. Here, `1` is of type `AlgebraicReal` and `-I` is a `NumberFieldElement_quadratic`.

---

I see two potential ways out:

One option is to always raise a `NotImplementedError` when attempting to compute the GCD of symbolic polynomials. As per the documentation, it does not reliably give correct results anyway:

```
        Embedded Sage objects of all kinds get basic support. Note that
        full algebraic GCD is not implemented yet::

            ...
            sage: sqrt2 = SR(QQbar(sqrt(2)))
            sage: gcd(sqrt2 + x, x^2 - 2)    # known bug
            1
```

The other option is to make the following addition work. And by my understanding of the coercion framework, it actually should work, as both arguments coerce to `CLF`, since the quadratic number field `N` comes with a complex embedding:

```
sage: N, i_neg, emb = QQbar(-I).as_number_field_element()
sage: AA(1) + i_neg  # this should work
...
TypeError: unsupported operand parent(s) for +: 'Algebraic Real Field' and 'Number Field in I with defining polynomial x^2 + 1 with I = 1*I'
sage: N.coerce_embedding()
Generic morphism:
  From: Number Field in I with defining polynomial x^2 + 1 with I = 1*I
  To:   Complex Lazy Field
  Defn: I -> 1*I
sage: CLF.has_coerce_map_from(AA), CLF.has_coerce_map_from(N)
(True, True)
sage: CLF(AA(1)) + CLF(i_neg)
1 - 1*I
```
Making this addition work could be quite useful in general. Any suggestions how to solve this?



---

archive/issue_comments_446814.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"random_fail\".",
    "created_at": "2019-11-29T00:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446814",
    "user": "https://github.com/vbraun"
}
```

**Changing keywords** from "" to "random_fail".



---

archive/issue_comments_446815.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis seems all pretty complicated. Can we at least for now just add a `# known bug`? According to the discussion here its not a new bug, we just are now hitting an old one.",
    "created_at": "2019-11-30T00:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446815",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>
This seems all pretty complicated. Can we at least for now just add a `# known bug`? According to the discussion here its not a new bug, we just are now hitting an old one.



---

archive/issue_comments_446816.json:
```json
{
    "body": "**Branch:** [public/ticket/28489](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/28489)",
    "created_at": "2019-11-30T10:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446816",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [public/ticket/28489](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/28489)



---

archive/issue_comments_446817.json:
```json
{
    "body": "**Commit:** [fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)",
    "created_at": "2019-11-30T10:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446817",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)



---

archive/issue_comments_446818.json:
```json
{
    "body": "<a id='comment:8'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530\">fbffb36</a></td><td><code>trac 28489 known bug in gcd for python3 on osX</code></td></tr></table>\n",
    "created_at": "2019-11-30T10:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446818",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530">fbffb36</a></td><td><code>trac 28489 known bug in gcd for python3 on osX</code></td></tr></table>




---

archive/issue_comments_446819.json:
```json
{
    "body": "**Author:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2019-11-30T10:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446819",
    "user": "https://github.com/fchapoton"
}
```

**Author:** Frédéric Chapoton



---

archive/issue_events_252217.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-11-30T10:28:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252217"
}
```



---

archive/issue_comments_446820.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2019-11-30T10:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446820",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_events_252218.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-30T10:44:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252218"
}
```



---

archive/issue_events_252219.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-11-30T10:44:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252219"
}
```



---

archive/issue_events_252220.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-11-30T15:05:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252220"
}
```



---

archive/issue_events_252221.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-11-30T15:05:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252221"
}
```



---

archive/issue_events_252222.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-01T00:38:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252222"
}
```



---

archive/issue_events_252223.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-01T00:38:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28489#event-252223"
}
```



---

archive/issue_comments_446821.json:
```json
{
    "body": "**Changing branch** from \"[public/ticket/28489](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/28489)\" to \"[fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)\".",
    "created_at": "2019-12-01T00:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446821",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/ticket/28489](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/28489)" to "[fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)".



---

archive/issue_comments_446822.json:
```json
{
    "body": "**Changing commit** from \"[fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)\" to \"\".",
    "created_at": "2019-12-02T06:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446822",
    "user": "https://github.com/kwankyu"
}
```

**Changing commit** from "[fbffb36597e4fef6332ca1136381af3feddbc530](https://github.com/sagemath/sagetrac-mirror/commit/fbffb36597e4fef6332ca1136381af3feddbc530)" to "".



---

archive/issue_comments_446823.json:
```json
{
    "body": "<a id='comment:12'></a>\nI feel somewhat guilty about the solution here. Hence I created #28827 to track the issue elsewhere.",
    "created_at": "2019-12-02T06:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28489#issuecomment-446823",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:12'></a>
I feel somewhat guilty about the solution here. Hence I created #28827 to track the issue elsewhere.
