# Issue 28132: Pari initialization is a major contributor to Sage on Windows startup time

archive/issues_027895.json:
```json
{
    "assignees": [],
    "body": "I know this is probably non-trivial, as use of Pari is deeply integrated into some modules.\n\nBut Pari is by several times the largest single contributor to (the already pretty bad) startup time of Sage on Windows:\n\n```\n$ sage -startuptime\n== Slowest module imports (excluding / including children) ==\nexclude/ms include/ms   #parents  module name\n    24.187     69.950          9  sage.rings.polynomial.multi_polynomial_libsingular\n    24.206     47.328          3  sage.graphs.generic_graph\n    25.579    466.882         30  sage.matrix.all\n    26.151    470.708        289  sage.structure.sage_object\n    26.708     26.741          2  sage.parallel.parallelism\n    26.780     26.780         43  math\n    27.199     27.300          5  sage.libs.singular.singular\n    28.246    231.436         14  sage.rings.number_field.number_field\n    28.708     35.944          9  sage.combinat\n    28.828     52.595          4  sage.structure.formal_sum\n    28.856     28.856         53  operator\n    29.700     40.641         52  functools\n    30.051     30.051         98  sys\n    30.725     79.078          2  sage.combinat.root_system\n    31.102     31.169          1  sage.combinat.sloane_functions\n    31.611     39.301          2  sage.matrix.matrix_mod2_dense\n    31.917     31.926          3  pickle\n    32.369     85.047         26  sage.combinat.partition\n    32.700    247.176         80  sage.rings.ring\n    32.745     45.383          4  sage.rings.finite_rings.finite_field_prime_modn\n    33.524     43.634          1  xml.dom.minidom\n    33.598    206.158         10  sage.modular.modform\n    33.683     43.607          2  sage.quadratic_forms.ternary_qf\n    37.933     37.933        115  sage.misc.lazy_import\n    38.449    340.623         10  sage.interfaces.singular\n    39.433     77.988          2  sage.rings.number_field\n    39.848     74.714        124  collections\n    42.590    114.996          2  sage.combinat.sf\n    43.376     43.376        177  six\n    45.717    101.240          3  sage.misc.package\n    46.638     46.696          5  sage.schemes.projective.projective_subscheme\n    47.261     63.320          5  sage.schemes.elliptic_curves\n    52.661    198.099         11  sage.rings.polynomial\n    53.674     53.962          3  sage.modular.arithgroup.arithgroup_element\n    54.008     54.033         18  sage.plot.primitive\n    54.895    158.730          3  sage.graphs\n    55.323    168.474         21  sage.libs.pynac.pynac\n    57.275     69.102          2  sage.combinat.designs.database\n    57.565     69.089        178  six.moves\n    59.939    171.751          3  psutil\n    65.993     65.993         88  copy\n    78.810    702.865         18  sage.rings\n    81.084    175.522         14  sage.rings.qqbar\n   101.130    101.130        590  __future__\n   115.469    411.063          4  sage.matrix\n   123.568    198.585         35  sage.env\n   148.956    167.013         11  sage.interfaces.gap\n   194.212  11545.261          5  sage.all\n   473.093   4168.063        171  sage\n  1360.117   1465.526         34  sage.libs.pari.all\nTotal time (sum over exclusive time): 11725.730ms\n```\n\n(Note: These times are especially bad right now as this computer is already being heavily tasked in the background, but in general this still holds true.)\n\nI realize fully extracting pari from the Sage startup process is not trivial and possibly not even worth the effort.  But it's worth noting that this should be an area of focus for future lazy-import improvements.\n\nAssignee: **@embray**\n\nCC:  @slel @mkoeppe\n\nKeywords: **pari**\n\nBranch/Commit: **[u/embray/ticket-28132](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-28132) @ [a4b4143](https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96)**\n\nAuthor: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/28132_\n\n",
    "created_at": "2019-07-08T09:00:29Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20porting%3A%20cygwin",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/pending",
        "https://github.com/sagemath/sage/labels/needs%20review"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Pari initialization is a major contributor to Sage on Windows startup time",
    "type": "issue",
    "updated_at": "2022-08-25T20:19:16Z",
    "url": "https://github.com/sagemath/sage/issues/28132",
    "user": "https://github.com/embray"
}
```
I know this is probably non-trivial, as use of Pari is deeply integrated into some modules.

But Pari is by several times the largest single contributor to (the already pretty bad) startup time of Sage on Windows:

```
$ sage -startuptime
== Slowest module imports (excluding / including children) ==
exclude/ms include/ms   #parents  module name
    24.187     69.950          9  sage.rings.polynomial.multi_polynomial_libsingular
    24.206     47.328          3  sage.graphs.generic_graph
    25.579    466.882         30  sage.matrix.all
    26.151    470.708        289  sage.structure.sage_object
    26.708     26.741          2  sage.parallel.parallelism
    26.780     26.780         43  math
    27.199     27.300          5  sage.libs.singular.singular
    28.246    231.436         14  sage.rings.number_field.number_field
    28.708     35.944          9  sage.combinat
    28.828     52.595          4  sage.structure.formal_sum
    28.856     28.856         53  operator
    29.700     40.641         52  functools
    30.051     30.051         98  sys
    30.725     79.078          2  sage.combinat.root_system
    31.102     31.169          1  sage.combinat.sloane_functions
    31.611     39.301          2  sage.matrix.matrix_mod2_dense
    31.917     31.926          3  pickle
    32.369     85.047         26  sage.combinat.partition
    32.700    247.176         80  sage.rings.ring
    32.745     45.383          4  sage.rings.finite_rings.finite_field_prime_modn
    33.524     43.634          1  xml.dom.minidom
    33.598    206.158         10  sage.modular.modform
    33.683     43.607          2  sage.quadratic_forms.ternary_qf
    37.933     37.933        115  sage.misc.lazy_import
    38.449    340.623         10  sage.interfaces.singular
    39.433     77.988          2  sage.rings.number_field
    39.848     74.714        124  collections
    42.590    114.996          2  sage.combinat.sf
    43.376     43.376        177  six
    45.717    101.240          3  sage.misc.package
    46.638     46.696          5  sage.schemes.projective.projective_subscheme
    47.261     63.320          5  sage.schemes.elliptic_curves
    52.661    198.099         11  sage.rings.polynomial
    53.674     53.962          3  sage.modular.arithgroup.arithgroup_element
    54.008     54.033         18  sage.plot.primitive
    54.895    158.730          3  sage.graphs
    55.323    168.474         21  sage.libs.pynac.pynac
    57.275     69.102          2  sage.combinat.designs.database
    57.565     69.089        178  six.moves
    59.939    171.751          3  psutil
    65.993     65.993         88  copy
    78.810    702.865         18  sage.rings
    81.084    175.522         14  sage.rings.qqbar
   101.130    101.130        590  __future__
   115.469    411.063          4  sage.matrix
   123.568    198.585         35  sage.env
   148.956    167.013         11  sage.interfaces.gap
   194.212  11545.261          5  sage.all
   473.093   4168.063        171  sage
  1360.117   1465.526         34  sage.libs.pari.all
Total time (sum over exclusive time): 11725.730ms
```

(Note: These times are especially bad right now as this computer is already being heavily tasked in the background, but in general this still holds true.)

I realize fully extracting pari from the Sage startup process is not trivial and possibly not even worth the effort.  But it's worth noting that this should be an area of focus for future lazy-import improvements.

Assignee: **@embray**

CC:  @slel @mkoeppe

Keywords: **pari**

Branch/Commit: **[u/embray/ticket-28132](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-28132) @ [a4b4143](https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96)**

Author: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/28132_





---

archive/issue_events_367569.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-08T09:00:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367569"
}
```



---

archive/issue_events_367570.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-08T09:00:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367570"
}
```



---

archive/issue_events_367571.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-08T09:00:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367571"
}
```



---

archive/issue_events_367572.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-08T09:00:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367572"
}
```



---

archive/issue_comments_440600.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nHow should I understand this? Would it be possible to profile `import sage.libs.pari` to see in detail what's taking all that time? For example, if it's the `virtual_memory_limit()` call, we could try to do something about that.\n\nOn Linux, `import sage.libs.pari` takes about 35ms, which is 2 orders of magnitude faster than on Windows.",
    "created_at": "2019-07-08T09:13:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440600",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'>Comment 1:</a>
How should I understand this? Would it be possible to profile `import sage.libs.pari` to see in detail what's taking all that time? For example, if it's the `virtual_memory_limit()` call, we could try to do something about that.

On Linux, `import sage.libs.pari` takes about 35ms, which is 2 orders of magnitude faster than on Windows.



---

archive/issue_comments_440601.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nReplying to [@jdemeyer](#comment%3A1):\n> How should I understand this? Would it be possible to profile `import sage.libs.pari` to see in detail what's taking all that time? For example, if it's the `virtual_memory_limit()` call, we could try to do something about that.\n> \n> On Linux, `import sage.libs.pari` takes about 35ms, which is 2 orders of magnitude faster than on Windows.\n\nInteresting...I can confirm about the same.  I (wrongly) assumed that maybe it took up a similar proportion of the time, even if less in overall magnitude, but indeed it's barely a significant portion at all.\n\nOkay, being that it specifically bad on Windows I will concern myself less with mere initialization of pari at startup time, at least for now, and more on which part(s) is/are specifically slow on Windows.\n\nProfiling something like this is slightly tricky: [line_profiler](https://github.com/rkern/line_profiler) can work well, but unfortunately not for profiling module-level code.  You have to wrap everything in functions to get it to work well, I've found.  Another way, which is annoying but usually effective for simple cases, is to just manually sprinkle `time()` calls and print statements about and manually do a binary-like search for which statements are taking the most time.",
    "created_at": "2019-07-08T11:23:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440601",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'>Comment 2:</a>
Replying to [@jdemeyer](#comment%3A1):
> How should I understand this? Would it be possible to profile `import sage.libs.pari` to see in detail what's taking all that time? For example, if it's the `virtual_memory_limit()` call, we could try to do something about that.
> 
> On Linux, `import sage.libs.pari` takes about 35ms, which is 2 orders of magnitude faster than on Windows.

Interesting...I can confirm about the same.  I (wrongly) assumed that maybe it took up a similar proportion of the time, even if less in overall magnitude, but indeed it's barely a significant portion at all.

Okay, being that it specifically bad on Windows I will concern myself less with mere initialization of pari at startup time, at least for now, and more on which part(s) is/are specifically slow on Windows.

Profiling something like this is slightly tricky: [line_profiler](https://github.com/rkern/line_profiler) can work well, but unfortunately not for profiling module-level code.  You have to wrap everything in functions to get it to work well, I've found.  Another way, which is annoying but usually effective for simple cases, is to just manually sprinkle `time()` calls and print statements about and manually do a binary-like search for which statements are taking the most time.



---

archive/issue_comments_440602.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nOn my Linux machine, for comparison:\n\n```\n$ ./sage -startuptime\n== Slowest module imports (excluding / including children) ==\nexclude/ms include/ms   #parents  module name\n     3.108      8.143          4  cypari2.pari_instance\n     3.152      3.152          2  _ssl\n     3.160     17.556         10  sage.interfaces.singular\n     3.350     19.718         13  sage.rings.number_field.number_field\n     3.374      3.685         28  sage.rings.real_double\n     3.449      4.391          7  sage.misc\n     3.455     29.250         11  sage.libs.gap.element\n     3.505     15.184         20  inspect\n     3.654      3.744          5  sage.libs.singular.singular\n     3.678     10.988          3  sage.misc.package\n     3.803      6.395        158  cysignals.signals\n     3.804      3.972          3  sage.rings.polynomial.pbori\n     3.867     13.187         38  cypari2.gen\n     3.937      9.706          2  sage.rings.number_field\n     3.981      4.629        175  six.moves\n     4.173      4.266          3  sage.combinat.dyck_word\n     4.224      4.230          1  platform\n     4.235      4.308          1  sage.graphs.matchpoly\n     4.250     17.076         53  sage.rings.polynomial.polynomial_ring_constructor\n     4.250     14.122         26  sage.combinat.partition\n     4.593      5.740          2  decimal\n     4.614      6.759          9  sage.groups.perm_gps.permgroup\n     4.891      5.379          4  sage.rings.finite_rings.finite_field_prime_modn\n     4.915     10.995          9  sage.rings.polynomial.multi_polynomial_libsingular\n     4.963      4.963        577  __future__\n     4.974      8.472          3  sage.graphs.generic_graph\n     5.034      6.896         28  sage.combinat.permutation\n     5.471      6.025          2  sage.matrix.matrix_mod2_dense\n     5.502      5.556          1  sage.combinat.sloane_functions\n     5.576      6.110          9  sage.combinat\n     5.623    115.652        237  sage.rings.integer\n     5.813      7.458          5  sage.schemes.elliptic_curves\n     5.841     26.203        172  sage.rings.integer_ring\n     6.732     30.856         33  sage.libs.pari.all\n     7.400     34.057          4  sage.matrix\n     7.497     11.922         10  sage.interfaces.gap\n     7.577     23.045          2  sage.combinat.sf\n     7.646      7.752          2  sage.rings.complex_mpc\n     8.013    235.740         16  sage.rings.complex_double\n     8.047      8.590          2  tokenize\n     9.808     23.963          3  sage.graphs\n     9.838     11.370          2  sage.combinat.designs.database\n    13.628     13.918          3  sage.modular.arithgroup.arithgroup_element\n    17.845     35.725         80  sage.rings.ring\n    22.151     45.101          3  psutil\n    27.527     80.974         18  sage.rings\n    31.641     45.886         14  sage.rings.qqbar\n    37.474     54.964         21  sage.libs.pynac.pynac\n    63.162    381.349        169  sage\n   107.294   1154.145          5  sage.all\nTotal time (sum over exclusive time): 1175.664ms\n```",
    "created_at": "2019-07-08T11:30:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440602",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'>Comment 3:</a>
On my Linux machine, for comparison:

```
$ ./sage -startuptime
== Slowest module imports (excluding / including children) ==
exclude/ms include/ms   #parents  module name
     3.108      8.143          4  cypari2.pari_instance
     3.152      3.152          2  _ssl
     3.160     17.556         10  sage.interfaces.singular
     3.350     19.718         13  sage.rings.number_field.number_field
     3.374      3.685         28  sage.rings.real_double
     3.449      4.391          7  sage.misc
     3.455     29.250         11  sage.libs.gap.element
     3.505     15.184         20  inspect
     3.654      3.744          5  sage.libs.singular.singular
     3.678     10.988          3  sage.misc.package
     3.803      6.395        158  cysignals.signals
     3.804      3.972          3  sage.rings.polynomial.pbori
     3.867     13.187         38  cypari2.gen
     3.937      9.706          2  sage.rings.number_field
     3.981      4.629        175  six.moves
     4.173      4.266          3  sage.combinat.dyck_word
     4.224      4.230          1  platform
     4.235      4.308          1  sage.graphs.matchpoly
     4.250     17.076         53  sage.rings.polynomial.polynomial_ring_constructor
     4.250     14.122         26  sage.combinat.partition
     4.593      5.740          2  decimal
     4.614      6.759          9  sage.groups.perm_gps.permgroup
     4.891      5.379          4  sage.rings.finite_rings.finite_field_prime_modn
     4.915     10.995          9  sage.rings.polynomial.multi_polynomial_libsingular
     4.963      4.963        577  __future__
     4.974      8.472          3  sage.graphs.generic_graph
     5.034      6.896         28  sage.combinat.permutation
     5.471      6.025          2  sage.matrix.matrix_mod2_dense
     5.502      5.556          1  sage.combinat.sloane_functions
     5.576      6.110          9  sage.combinat
     5.623    115.652        237  sage.rings.integer
     5.813      7.458          5  sage.schemes.elliptic_curves
     5.841     26.203        172  sage.rings.integer_ring
     6.732     30.856         33  sage.libs.pari.all
     7.400     34.057          4  sage.matrix
     7.497     11.922         10  sage.interfaces.gap
     7.577     23.045          2  sage.combinat.sf
     7.646      7.752          2  sage.rings.complex_mpc
     8.013    235.740         16  sage.rings.complex_double
     8.047      8.590          2  tokenize
     9.808     23.963          3  sage.graphs
     9.838     11.370          2  sage.combinat.designs.database
    13.628     13.918          3  sage.modular.arithgroup.arithgroup_element
    17.845     35.725         80  sage.rings.ring
    22.151     45.101          3  psutil
    27.527     80.974         18  sage.rings
    31.641     45.886         14  sage.rings.qqbar
    37.474     54.964         21  sage.libs.pynac.pynac
    63.162    381.349        169  sage
   107.294   1154.145          5  sage.all
Total time (sum over exclusive time): 1175.664ms
```



---

archive/issue_events_367573.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-08T11:45:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "title_is": "Pari initialization is a major contributor to Sage on Windows startup time",
    "title_was": "Avoid initialization of Pari at startup time",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367573"
}
```



---

archive/issue_comments_440603.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nHere's a result from line-profiling `_get_pari_instance`:\n\n```\nTimer unit: 1e-06 s\n\nTotal time: 1.31734 s\nFile: /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/pari/__init__.py\nFunction: _get_pari_instance at line 173\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n   173                                           @profile\n   174                                           def _get_pari_instance():\n   175                                               # There are two constraints for the virtual stack size:\n   176                                               # 1) on 32-bit systems, even virtual memory can be a scarce\n   177                                               #    resource since it is limited by 4GB (of which the kernel\n   178                                               #    needs a significant part)\n   179                                               # 2) the system should actually be able to handle a stack size\n   180                                               #    as large as the complete virtual stack.\n   181                                               # As a simple heuristic, we set the virtual stack to 1/4 of the\n   182                                               # virtual memory.\n   183         1       2898.0   2898.0      0.2      from sage.misc.getusage import virtual_memory_limit\n   184\n   185         1     104868.0 104868.0      8.0      sizemax = virtual_memory_limit() // 4\n   186\n   187         1         11.0     11.0      0.0      from sage.env import CYGWIN_VERSION\n   188         1          2.0      2.0      0.0      if CYGWIN_VERSION and CYGWIN_VERSION < (2, 5, 2):\n   189                                                   # Cygwin's mmap is broken for large NORESERVE mmaps (>~ 4GB) See\n   190                                                   # http://trac.sagemath.org/ticket/20463 So we set the max stack\n   191                                                   # size to a little below 4GB (putting it right on the margin proves\n   192                                                   # too fragile)\n   193                                                   #\n   194                                                   # The underlying issue is fixed in Cygwin v2.5.2\n   195                                                   sizemax = min(sizemax, 0xf0000000)\n   196\n   197         1       1367.0   1367.0      0.1      from cypari2 import Pari\n   198         1    1202219.0 1202219.0     91.3      P = Pari(1000000, sizemax)\n   199\n   200                                               # pari_init_opts() overrides MPIR's memory allocation functions,\n   201                                               # so we need to reset them.\n   202         1       5404.0   5404.0      0.4      from sage.ext.memory import init_memory_functions\n   203         1          4.0      4.0      0.0      init_memory_functions()\n   204\n   205                                               # PARI sets debugmem=1 by default but we do not want those warning\n   206                                               # messages in Sage.\n   207         1        557.0    557.0      0.0      P.default(\"debugmem\", 0)\n   208\n   209                                               # Make sure pari doesn't use threads, regardless of how it was compiled.\n   210                                               # Threads cause some doctest failures (memory issues). Those could probably\n   211                                               # be solved without disabling threads. But that would require figuring out\n   212                                               # some sensible values for `threadsizemax`. See\n   213                                               # https://pari.math.u-bordeaux.fr/dochtml/html/GP_defaults.html\n   214         1          8.0      8.0      0.0      P.default(\"nbthreads\", 1)\n   215\n   216         1          1.0      1.0      0.0      return P\n```\n\nSome chunk of the time is spent in `virtual_memory_limit()`, and that's worth looking into.  But the vast majority is actually spent in the `Pari()` initialization itself.",
    "created_at": "2019-07-08T12:45:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440603",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'>Comment 5:</a>
Here's a result from line-profiling `_get_pari_instance`:

```
Timer unit: 1e-06 s

Total time: 1.31734 s
File: /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/pari/__init__.py
Function: _get_pari_instance at line 173

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
   173                                           @profile
   174                                           def _get_pari_instance():
   175                                               # There are two constraints for the virtual stack size:
   176                                               # 1) on 32-bit systems, even virtual memory can be a scarce
   177                                               #    resource since it is limited by 4GB (of which the kernel
   178                                               #    needs a significant part)
   179                                               # 2) the system should actually be able to handle a stack size
   180                                               #    as large as the complete virtual stack.
   181                                               # As a simple heuristic, we set the virtual stack to 1/4 of the
   182                                               # virtual memory.
   183         1       2898.0   2898.0      0.2      from sage.misc.getusage import virtual_memory_limit
   184
   185         1     104868.0 104868.0      8.0      sizemax = virtual_memory_limit() // 4
   186
   187         1         11.0     11.0      0.0      from sage.env import CYGWIN_VERSION
   188         1          2.0      2.0      0.0      if CYGWIN_VERSION and CYGWIN_VERSION < (2, 5, 2):
   189                                                   # Cygwin's mmap is broken for large NORESERVE mmaps (>~ 4GB) See
   190                                                   # http://trac.sagemath.org/ticket/20463 So we set the max stack
   191                                                   # size to a little below 4GB (putting it right on the margin proves
   192                                                   # too fragile)
   193                                                   #
   194                                                   # The underlying issue is fixed in Cygwin v2.5.2
   195                                                   sizemax = min(sizemax, 0xf0000000)
   196
   197         1       1367.0   1367.0      0.1      from cypari2 import Pari
   198         1    1202219.0 1202219.0     91.3      P = Pari(1000000, sizemax)
   199
   200                                               # pari_init_opts() overrides MPIR's memory allocation functions,
   201                                               # so we need to reset them.
   202         1       5404.0   5404.0      0.4      from sage.ext.memory import init_memory_functions
   203         1          4.0      4.0      0.0      init_memory_functions()
   204
   205                                               # PARI sets debugmem=1 by default but we do not want those warning
   206                                               # messages in Sage.
   207         1        557.0    557.0      0.0      P.default("debugmem", 0)
   208
   209                                               # Make sure pari doesn't use threads, regardless of how it was compiled.
   210                                               # Threads cause some doctest failures (memory issues). Those could probably
   211                                               # be solved without disabling threads. But that would require figuring out
   212                                               # some sensible values for `threadsizemax`. See
   213                                               # https://pari.math.u-bordeaux.fr/dochtml/html/GP_defaults.html
   214         1          8.0      8.0      0.0      P.default("nbthreads", 1)
   215
   216         1          1.0      1.0      0.0      return P
```

Some chunk of the time is spent in `virtual_memory_limit()`, and that's worth looking into.  But the vast majority is actually spent in the `Pari()` initialization itself.



---

archive/issue_comments_440604.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIt seems the main culprit, not *too* surprisingly, is `paristack_setsize` with a large `sizemax`.  If it's smaller, or if `rsize == vsize`, initialization takes mere milliseconds.\n\n*Why* it's so slow I'm not sure.  It could be a limitation of Cygwin or even Windows, though I do find it a bit strange.\n\nWould it be possible, say, to start out with a very small pari stack, and then increase it later only when needed (or even do something like run a thread in the background to take care of that)?",
    "created_at": "2019-07-08T15:18:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440604",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'>Comment 6:</a>
It seems the main culprit, not *too* surprisingly, is `paristack_setsize` with a large `sizemax`.  If it's smaller, or if `rsize == vsize`, initialization takes mere milliseconds.

*Why* it's so slow I'm not sure.  It could be a limitation of Cygwin or even Windows, though I do find it a bit strange.

Would it be possible, say, to start out with a very small pari stack, and then increase it later only when needed (or even do something like run a thread in the background to take care of that)?



---

archive/issue_comments_440605.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI feel a blast from the past... the whole point of `parisizemax` is precisely to avoid resizing the stack on the fly. The idea is to allocate a large \"virtual\" stack with the intention of using only a small part of it, but having the possibility of using it all if needed.\n\nBefore `parisizemax` existed, I recall that Sage used to have a mechanism to retry failed PARI computations if it detected that the PARI stack overflowed. But thanks to `parisizemax`, we got rid of that hack. I'm not looking forward to putting that back.",
    "created_at": "2019-07-08T19:04:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440605",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
I feel a blast from the past... the whole point of `parisizemax` is precisely to avoid resizing the stack on the fly. The idea is to allocate a large "virtual" stack with the intention of using only a small part of it, but having the possibility of using it all if needed.

Before `parisizemax` existed, I recall that Sage used to have a mechanism to retry failed PARI computations if it detected that the PARI stack overflowed. But thanks to `parisizemax`, we got rid of that hack. I'm not looking forward to putting that back.



---

archive/issue_comments_440606.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@jdemeyer](#comment%3A7):\n> I feel a blast from the past... the whole point of `parisizemax` is precisely to avoid resizing the stack on the fly. The idea is to allocate a large \"virtual\" stack with the intention of using only a small part of it, but having the possibility of using it all if needed.\n> \n> Before `parisizemax` existed, I recall that Sage used to have a mechanism to retry failed PARI computations if it detected that the PARI stack overflowed. But thanks to `parisizemax`, we got rid of that hack. I'm not looking forward to putting that back.\n\nRight, I understand, and I agree.  I wonder if there is some way to still enable that as-needed resizing at the cypari2 level in a manner that's reasonably transparent.  In principle it's good to be able to do anyways.",
    "created_at": "2019-07-09T10:53:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440606",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@jdemeyer](#comment%3A7):
> I feel a blast from the past... the whole point of `parisizemax` is precisely to avoid resizing the stack on the fly. The idea is to allocate a large "virtual" stack with the intention of using only a small part of it, but having the possibility of using it all if needed.
> 
> Before `parisizemax` existed, I recall that Sage used to have a mechanism to retry failed PARI computations if it detected that the PARI stack overflowed. But thanks to `parisizemax`, we got rid of that hack. I'm not looking forward to putting that back.

Right, I understand, and I agree.  I wonder if there is some way to still enable that as-needed resizing at the cypari2 level in a manner that's reasonably transparent.  In principle it's good to be able to do anyways.



---

archive/issue_comments_440607.json:
```json
{
    "body": "Attachment: **[cygwin_mmap.png.gz](https://github.com/sagemath/sage/files/ticket28132/cygwin_mmap.png.gz)**",
    "created_at": "2019-07-09T10:54:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440607",
    "user": "https://github.com/embray"
}
```

Attachment: **[cygwin_mmap.png.gz](https://github.com/sagemath/sage/files/ticket28132/cygwin_mmap.png.gz)**



---

archive/issue_comments_440608.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nThe problem is that you can't know how much PARI stack you need in advance. If you're halfway a computation and suddenly the stack turns out to be too small, then what do you do?",
    "created_at": "2019-07-09T10:55:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440608",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'>Comment 9:</a>
The problem is that you can't know how much PARI stack you need in advance. If you're halfway a computation and suddenly the stack turns out to be too small, then what do you do?



---

archive/issue_comments_440609.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nAfter a bit of experimenting I found the awful truth, which is that on Cygwin (at least the current version I'm on (3.13.0-170)) the time taken for an anonymous `mmap` and `munmap` scales logarithmically (with munmap typically taking ~twice as long for some reason).\n\nOn Linux both are more-or-less instant no matter the size.\n\n![](cygwin_mmap.png)",
    "created_at": "2019-07-09T10:57:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440609",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'>Comment 10:</a>
After a bit of experimenting I found the awful truth, which is that on Cygwin (at least the current version I'm on (3.13.0-170)) the time taken for an anonymous `mmap` and `munmap` scales logarithmically (with munmap typically taking ~twice as long for some reason).

On Linux both are more-or-less instant no matter the size.

![](cygwin_mmap.png)



---

archive/issue_comments_440610.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nThanks for that. Does it depend on the flags, in particular `MAP_NORESERVE`?",
    "created_at": "2019-07-09T10:59:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440610",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'>Comment 11:</a>
Thanks for that. Does it depend on the flags, in particular `MAP_NORESERVE`?



---

archive/issue_comments_440611.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@jdemeyer](#comment%3A9):\n> The problem is that you can't know how much PARI stack you need in advance. If you're halfway a computation and suddenly the stack turns out to be too small, then what do you do?\n\nI guess I still don't know enough about how pari works to really be able to answer that.  What does \"halfway [through] a computation\" mean in this case?  If some operation fails due to being out of stack space, I thought it was possible to at least detect that, grow the stack, and start over from the last attempted operation (after all, exception handling of this kind is possible even at the assembly level).",
    "created_at": "2019-07-09T11:00:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440611",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@jdemeyer](#comment%3A9):
> The problem is that you can't know how much PARI stack you need in advance. If you're halfway a computation and suddenly the stack turns out to be too small, then what do you do?

I guess I still don't know enough about how pari works to really be able to answer that.  What does "halfway [through] a computation" mean in this case?  If some operation fails due to being out of stack space, I thought it was possible to at least detect that, grow the stack, and start over from the last attempted operation (after all, exception handling of this kind is possible even at the assembly level).



---

archive/issue_comments_440612.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@embray](#comment%3A12):\n> If some operation fails due to being out of stack space, I thought it was possible to at least detect that, grow the stack\n\nThe problem is that you're not guaranteed that you can grow the stack in-place. And PARI doesn't support moving the stack (pointers would become invalid).\n\nThe `parisizemax` mechanism does precisely what you suggest, but it reserves a large portion of memory to be sure that the stack can be extended in-place.",
    "created_at": "2019-07-09T11:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440612",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@embray](#comment%3A12):
> If some operation fails due to being out of stack space, I thought it was possible to at least detect that, grow the stack

The problem is that you're not guaranteed that you can grow the stack in-place. And PARI doesn't support moving the stack (pointers would become invalid).

The `parisizemax` mechanism does precisely what you suggest, but it reserves a large portion of memory to be sure that the stack can be extended in-place.



---

archive/issue_comments_440613.json:
```json
{
    "body": "Attachment: **[cygwin_mmap_noreserve.png.gz](https://github.com/sagemath/sage/files/ticket28132/cygwin_mmap_noreserve.png.gz)**",
    "created_at": "2019-07-09T11:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440613",
    "user": "https://github.com/embray"
}
```

Attachment: **[cygwin_mmap_noreserve.png.gz](https://github.com/sagemath/sage/files/ticket28132/cygwin_mmap_noreserve.png.gz)**



---

archive/issue_comments_440614.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@jdemeyer](#comment%3A11):\n> Thanks for that. Does it depend on the flags, in particular `MAP_NORESERVE`?\n\nSo with MAP_NORESERVE I get more-or-less the same log scaling (beyond sizes of a few MB) but still several orders of magnitude faster.\n\nI also want to check whether this is endemic specifically to Cygwin, or to the underlying Windows API (`VirtualAlloc`).\n\n![](cygwin_mmap_noreserve.png)",
    "created_at": "2019-07-09T11:14:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440614",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@jdemeyer](#comment%3A11):
> Thanks for that. Does it depend on the flags, in particular `MAP_NORESERVE`?

So with MAP_NORESERVE I get more-or-less the same log scaling (beyond sizes of a few MB) but still several orders of magnitude faster.

I also want to check whether this is endemic specifically to Cygwin, or to the underlying Windows API (`VirtualAlloc`).

![](cygwin_mmap_noreserve.png)



---

archive/issue_comments_440615.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nOne thing that would be helpful is if the cypari interface had an easy way (as a method on the `Pari` class if possible) to resize the stack sizemax allocation later.  I know in principle it's already possible by manually re-calling `Pari.__init__`, but a more dedicated method would be clearer.\n\nThat way I could so something like start with a smaller stack (just for startup), but then resize it after Sage's initial startup is complete (how exactly that would work I'm not exactly sure yet; possibly in a thread...).",
    "created_at": "2019-07-09T12:54:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440615",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'>Comment 15:</a>
One thing that would be helpful is if the cypari interface had an easy way (as a method on the `Pari` class if possible) to resize the stack sizemax allocation later.  I know in principle it's already possible by manually re-calling `Pari.__init__`, but a more dedicated method would be clearer.

That way I could so something like start with a smaller stack (just for startup), but then resize it after Sage's initial startup is complete (how exactly that would work I'm not exactly sure yet; possibly in a thread...).



---

archive/issue_comments_440616.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nLooking yet again at `pari_mainstack_alloc`\n\n```c\nstatic void *\npari_mainstack_malloc(size_t size)\n{\n  /* Check that the system allows reserving \"size\" bytes. This is just\n   * a check, we immediately free the memory. */\n  void *b = mmap(NULL, size, PROT_READ|PROT_WRITE,\n                             MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\n  if (b == MAP_FAILED) return NULL;\n  munmap(b, size);\n\n  /* Map again, this time with MAP_NORESERVE. On some operating systems\n   * like Cygwin, this is needed because remapping with PROT_NONE and\n   * MAP_NORESERVE does not work as expected. */\n  b = mmap(NULL, size, PROT_READ|PROT_WRITE,\n                       MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0);\n  if (b == MAP_FAILED) return NULL;\n  return b;\n}\n```\n\nI wonder if the initial \"check\" is truly necessary.  Yes, it guarantees that the reserved range can theoretically fit in memory, but it makes no guarantee that that memory will be available later if you are overcommitting anyways.\n\nOn Windows it guarantees that at that moment I can commit that many pages of physical memory, but then we immediately give up that guarantee and just leave a range of virtual memory addressees reserved, but not the physical memory.  So a later allocation can still fail regardless.\n\nI guess the point is you can prevent someone from allocating more stack than can ever theoretically possibly be used.  But at least in Sage we already doing that, essentially, by limiting the size to a fraction of `virtual_memory_limit()`.\n\nSo I wonder if there could be some way to disable this check.  Or at least disable it on Cygwin.  I'm not saying it's useless but it's not especially useful either, especially given the overhead it carries.",
    "created_at": "2019-07-09T14:43:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440616",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'>Comment 16:</a>
Looking yet again at `pari_mainstack_alloc`

```c
static void *
pari_mainstack_malloc(size_t size)
{
  /* Check that the system allows reserving "size" bytes. This is just
   * a check, we immediately free the memory. */
  void *b = mmap(NULL, size, PROT_READ|PROT_WRITE,
                             MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
  if (b == MAP_FAILED) return NULL;
  munmap(b, size);

  /* Map again, this time with MAP_NORESERVE. On some operating systems
   * like Cygwin, this is needed because remapping with PROT_NONE and
   * MAP_NORESERVE does not work as expected. */
  b = mmap(NULL, size, PROT_READ|PROT_WRITE,
                       MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0);
  if (b == MAP_FAILED) return NULL;
  return b;
}
```

I wonder if the initial "check" is truly necessary.  Yes, it guarantees that the reserved range can theoretically fit in memory, but it makes no guarantee that that memory will be available later if you are overcommitting anyways.

On Windows it guarantees that at that moment I can commit that many pages of physical memory, but then we immediately give up that guarantee and just leave a range of virtual memory addressees reserved, but not the physical memory.  So a later allocation can still fail regardless.

I guess the point is you can prevent someone from allocating more stack than can ever theoretically possibly be used.  But at least in Sage we already doing that, essentially, by limiting the size to a fraction of `virtual_memory_limit()`.

So I wonder if there could be some way to disable this check.  Or at least disable it on Cygwin.  I'm not saying it's useless but it's not especially useful either, especially given the overhead it carries.



---

archive/issue_comments_440617.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@embray](#comment%3A16):\n> I wonder if the initial \"check\" is truly necessary.  Yes, it guarantees that the reserved range can theoretically fit in memory, but it makes no guarantee that that memory will be available later if you are overcommitting anyways.\n\nYou should see that initial check as a sanity check: if you're doing something silly like reserving a 1TB stack on a system with 4GB of RAM, you'll get an error there. But you are completely right that it doesn't give any guarantees.\n\n> So I wonder if there could be some way to disable this check.  Or at least disable it on Cygwin.\n\nI'm fine with putting that check inside a `#ifndef __CYGWIN__` (or whatever the right macro is).",
    "created_at": "2019-07-09T16:26:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440617",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@embray](#comment%3A16):
> I wonder if the initial "check" is truly necessary.  Yes, it guarantees that the reserved range can theoretically fit in memory, but it makes no guarantee that that memory will be available later if you are overcommitting anyways.

You should see that initial check as a sanity check: if you're doing something silly like reserving a 1TB stack on a system with 4GB of RAM, you'll get an error there. But you are completely right that it doesn't give any guarantees.

> So I wonder if there could be some way to disable this check.  Or at least disable it on Cygwin.

I'm fine with putting that check inside a `#ifndef __CYGWIN__` (or whatever the right macro is).



---

archive/issue_events_367574.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-23T17:58:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367574"
}
```



---

archive/issue_events_367575.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-23T17:58:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "component: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367575"
}
```



---

archive/issue_comments_440618.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nI forgot all about this issue.  It should just require a simple patch to PARI.",
    "created_at": "2021-03-10T15:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440618",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'>Comment 19:</a>
I forgot all about this issue.  It should just require a simple patch to PARI.



---

archive/issue_comments_440619.json:
```json
{
    "body": "Assignee: **@embray**",
    "created_at": "2021-03-10T15:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440619",
    "user": "https://github.com/embray"
}
```

Assignee: **@embray**



---

archive/issue_comments_440620.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nPatch attached, finally.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96\">a4b4143</a></td><td><code>Updated Cygwin patch for PARI 2.13.1 and added additional patch</code></td></tr></table>\n",
    "created_at": "2021-08-18T16:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440620",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'>Comment 20:</a>
Patch attached, finally.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96">a4b4143</a></td><td><code>Updated Cygwin patch for PARI 2.13.1 and added additional patch</code></td></tr></table>




---

archive/issue_comments_440621.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2021-08-18T16:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440621",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_440622.json:
```json
{
    "body": "Branch: **[u/embray/ticket-28132](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-28132)**",
    "created_at": "2021-08-18T16:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440622",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/ticket-28132](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-28132)**



---

archive/issue_events_367576.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-08-18T16:23:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367576"
}
```



---

archive/issue_comments_440623.json:
```json
{
    "body": "Commit: **[a4b4143](https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96)**",
    "created_at": "2021-08-18T16:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440623",
    "user": "https://github.com/embray"
}
```

Commit: **[a4b4143](https://github.com/sagemath/sagetrac-mirror/commit/a4b41430c128349b54c4871a893f6e0f21b0fe96)**



---

archive/issue_events_367577.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-08-18T16:23:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367577"
}
```



---

archive/issue_events_367578.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-08-18T16:23:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367578"
}
```



---

archive/issue_comments_440624.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nNote, I have not tested this due to not having at the moment an up-to-date Cygwin build.  I hope to try it soon.",
    "created_at": "2021-08-18T16:26:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440624",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'>Comment 21:</a>
Note, I have not tested this due to not having at the moment an up-to-date Cygwin build.  I hope to try it soon.



---

archive/issue_comments_440625.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nSeems to work, but based on the testing slelievre and I have done this patch might not be necessary anymore.  It doesn't seem that pari is as significant a startup time contributor as it used to be, and this patch doesn't seem to make a whole lot of difference.\n\nI don't know if it's something cypari2 does differently, or it could be improvements in cygwin's mmap, or even changes in Windows that have sped this up.",
    "created_at": "2021-08-20T16:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440625",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'>Comment 22:</a>
Seems to work, but based on the testing slelievre and I have done this patch might not be necessary anymore.  It doesn't seem that pari is as significant a startup time contributor as it used to be, and this patch doesn't seem to make a whole lot of difference.

I don't know if it's something cypari2 does differently, or it could be improvements in cygwin's mmap, or even changes in Windows that have sped this up.



---

archive/issue_comments_440626.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nIt seems there have been recent improvements to Cygwin's mmap (thanks in part to new Windows APIs, when available).  In particular, this looks relevant: https://cygwin.com/git/?p=newlib-cygwin.git;a=blobdiff;f=winsup/cygwin/mmap.cc;h=feb9e5d0edfdec4f92803cd4fffcad6555e76fa2;hp=662489c8c74667744c5664490bd15391dd5ab3b5;hb=8d0a7701aa9e98bda511ba55f5f2dc210722d3e9;hpb=e18f7f99cc63520eca72b990cb73952ed22208e6",
    "created_at": "2021-08-20T16:17:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440626",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'>Comment 23:</a>
It seems there have been recent improvements to Cygwin's mmap (thanks in part to new Windows APIs, when available).  In particular, this looks relevant: https://cygwin.com/git/?p=newlib-cygwin.git;a=blobdiff;f=winsup/cygwin/mmap.cc;h=feb9e5d0edfdec4f92803cd4fffcad6555e76fa2;hp=662489c8c74667744c5664490bd15391dd5ab3b5;hb=8d0a7701aa9e98bda511ba55f5f2dc210722d3e9;hpb=e18f7f99cc63520eca72b990cb73952ed22208e6



---

archive/issue_comments_440627.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nSome more startup related tickets:\n\n- https://trac.sagemath.org/query?order=id&desc=1&summary=~startup&status=!closed",
    "created_at": "2021-08-21T15:01:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440627",
    "user": "https://github.com/slel"
}
```

<a id='comment:24'>Comment 24:</a>
Some more startup related tickets:

- https://trac.sagemath.org/query?order=id&desc=1&summary=~startup&status=!closed



---

archive/issue_events_367579.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367579"
}
```



---

archive/issue_events_367580.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367580"
}
```



---

archive/issue_comments_440628.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nStalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/28132#issuecomment-440628",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'>Comment 25:</a>
Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_events_367581.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367581"
}
```



---

archive/issue_events_367582.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367582"
}
```



---

archive/issue_events_367583.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-25T20:19:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367583"
}
```



---

archive/issue_events_367584.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-25T20:19:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/28132",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/28132#event-367584"
}
```
