# Issue 30469: Migrate from cblas to blas

Issue created by migration from https://trac.sagemath.org/ticket/30706

Original creator: @tobiasdiez

Original creation time: 2020-10-03 19:40:36

CC:  mkoeppe dimpase fbissey arojas isuruf

Keywords: cblas, blas

While working on #30371, I noticed that cblas is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:


```
    Debian science team maintainers have merged the CBLAS ABI into
    the libblas.so shared object. Everything you need from libcblas.so
    can be found in libblas.so . Please link your program against it
    instead. See also

      https://lists.debian.org/debian-devel/2019/10/msg00273.html
      https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=943712
      https://wiki.debian.org/DebianScience/LinearAlgebraLibraries
```


So I suggest to migrate/rename cblas to blas. The currently submitted changes worked for an editable install, but they might lead to issues with the build process. So advice how to properly do this migration is  welcome; in fact, feel free to hijack this ticket and push the necessary changes directly.


---

Comment by @tobiasdiez created at 2020-10-03 19:42:07

Changing status from new to needs_info.


---

Comment by mkoeppe created at 2020-10-03 19:43:35


```
$ cat build/pkgs/openblas/distros/debian.txt 
libopenblas-dev
```



---

Comment by @tobiasdiez created at 2020-10-03 20:14:56

Also with `openblas` the issue remains, as it adds a `blas.pc` file in `usr/lib/.../pkgconfig` and thus is not found via `-l cblas`. Or do I miss something?


---

Comment by mkoeppe created at 2020-10-03 20:26:20

Are you saying that the .pc files installed on your Ubuntu system are broken?


---

Comment by @tobiasdiez created at 2020-10-03 20:42:37

I wouldn't say broken, but there is no `cblas.pc` file (but a `blas.pc`) which is why the check in `env.py` was not successful without the committed change.


---

Comment by mkoeppe created at 2020-10-03 20:50:08

Supporting BLAS on various platforms is really tricky. See `build/pkgs/openblas/spkg-configure.m4`. To interface with system BLAS, in some configurations we create `.pc` files in `$SAGE_LOCAL`. If you don't run `./configure` and `make`, you won't have those.


---

Comment by @tobiasdiez created at 2020-10-03 21:27:24

Well, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter (or do you suggest to set `SAGE_LOCAL` to say `usr` before calling configure?).

Would it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?


---

Comment by mkoeppe created at 2020-10-03 21:42:27

Replying to [comment:7 gh-tobiasdiez]:
> Well, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter

As I said in #30371, I think it's best to keep the focus narrow -- make #30371 work completely (i.e., pass doctests) when run from within `./sage -sh` so that `$SAGE_LOCAL` is set to a working installation of the Sage distribution.  

Of course I do understand that currently technical problems prevent you from completing the build.

Still, `make -k` can build everything until you get the error with the pip package or whatever is failing. Then for example the .pc files will be available.

> Would it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?

Something like this might work.

Making `sage.env.cython_aliases` more flexible is a good approach, I would think.

Note that this will need thorough testing across the supported platforms.


---

Comment by git created at 2020-10-19 20:30:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-19 20:32:39

Changing status from needs_info to needs_review.


---

Comment by @tobiasdiez created at 2020-10-19 20:32:39

I've now added support for openblas and blas as well. So, this ticket is now ready for review.


---

Comment by mkoeppe created at 2020-10-19 22:19:01

This is going in a good direction but it might conflict with the Sage distribution's support of selecting ATLAS instead of OpenBLAS in `configure`. We can't just go and prefer the openblas.pc without adding a configuration variable that preserves this option.


---

Comment by fbissey created at 2020-10-19 22:32:29

I agree. Preference order should be overridable. You may very well want to build the whole sage with a different blas/lapack stack. What goes in env.py should be able to match whatever you build all the other sage dependencies with, regardless of the presence of openblas.pc.

If anything has to go first without override, I would prefer cblas or blas. This is a generic name and you could override things by providing a .pc in an appropriate PKG_CONFIG_PATH.


---

Comment by git created at 2020-10-19 22:36:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-19 22:40:54

Thanks for the feedback. I wasn't sure about the order myself. I've now changed it to have `cblas` first. So if this package is installed (or a corresponding `pc` file is present), then you get the current behavior. Only in the case it's not installed we fall back to openblas.

I would leave the config option for another ticket.


---

Comment by fbissey created at 2020-10-19 23:50:32

I'll note that my patch to giac's autotools is going to be in sage 9.2 and it uses lapack.pc and blas.pc. I am bringing up giac because I am currently trying the remove `libdir` from RUNPATH in libgiac because it messes up which blas/lapack is loaded in Gentoo.


---

Comment by git created at 2020-10-19 23:55:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-21 11:17:36

Thanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:


```
Traceback (most recent call last):
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 280, in <module>
        main()
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 263, in main
        json_out['return_val'] = hook(**hook_input['kwargs'])
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 133, in prepare_metadata_for_build_wheel
        return hook(metadata_directory, config_settings)
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 157, in prepare_metadata_for_build_wheel
        self.run_setup()
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 248, in run_setup
        super(_BuildMetaLegacyBackend,
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 142, in run_setup
        exec(compile(code, __file__, 'exec'), locals())
      File "setup.py", line 90, in <module>
        aliases = cython_aliases()
      File "/Users/runner/work/sage/sage/src/sage/env.py", line 399, in cython_aliases
        lib = next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))
    StopIteration
```

see https://github.com/tobiasdiez/sage/runs/1285891725?check_suite_focus=true
Its interesting to note that also `./configure` cannot find openblas:
`checking for openblas >= 0.2.20... no`. So I guess it's a more general issue not really related to this ticket.


---

Comment by mkoeppe created at 2020-10-21 18:23:37

Replying to [comment:20 gh-tobiasdiez]:
> Thanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:

Did you use the homebrew setup as explained in README.md?


---

Comment by @tobiasdiez created at 2020-10-21 20:03:16

Not sure, the Readme in root doesn't really contain anything about homebrew. That's what I used: https://github.com/tobiasdiez/sage/actions/runs/319537404/workflow


---

Comment by mkoeppe created at 2020-10-21 20:33:36

My bad, it's actually not in the README but is displayed at the end of ./configure:

```
# To automatically take care of homebrew messages regarding 
# keg-only packages for the current shell session:
  $ source /Users/mkoeppe/s/sage/sage-rebasing/.homebrew-build-env
```



---

Comment by @tobiasdiez created at 2020-11-03 00:47:48

I just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.

Moreover, I would like suggest the following change to `sage_conf.py.in` to make this more reusable.

```
DEFAULT_CBLAS_PC_MODULE = "@SAGE_CBLAS_PC_MODULE" # Set to cblas in configure

def get_cblas_pc_module()
   cblas_pc_modules = [DEFAULT_CBLAS_PC_MODULE, 'cblas', 'openblas', 'blas']
   return next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))
```



---

Comment by mkoeppe created at 2020-11-03 01:13:20

Search logic should go into sage/env.py, not sage_conf.


---

Comment by mkoeppe created at 2020-11-03 01:14:44

Replying to [comment:25 gh-tobiasdiez]:
> I just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.

Yes, this code should be replaced by something equivalent that uses sage.env


---

Comment by git created at 2020-11-03 09:12:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-11-03 09:15:48

Ok, I've now refactored the code slightly and replaced the other usages of the hard-corded `cblas` in `sage/misc/cython.py` and in `sage_setup/library_order.py`.


---

Comment by mkoeppe created at 2020-11-03 16:50:51

Looks good to me, but another reviewer is needed...


---

Comment by dimpase created at 2020-11-04 12:54:19

does this work on platforms where cblas is present in an important way, such as arch linux?


---

Comment by mkoeppe created at 2020-11-04 20:24:13

The behavior as part of building Sage-the-distribution is unchanged by this ticket.


---

Comment by dimpase created at 2020-11-07 21:47:07

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2020-11-08 13:33:40

Thanks!


---

Comment by vbraun created at 2020-11-20 22:15:06

Resolution: fixed
