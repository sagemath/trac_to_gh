# Issue 32370: compatibility with gsl 2.7

archive/issues_032370.json:
```json
{
    "body": "CC:  mkoeppe\n\nKeywords: gsl\n\nGSL 2.7 changes the definition of `gsl_complex`; see https://groups.google.com/g/sage-devel/c/yQ67Wy0gp58/m/jr6f7xtcBQAJ and #32587.\n\nThis patch changes the library code to use the macros provided by GSL instead of directly accessing the data structure, which should make things work with GSL 2.7 as well as older versions.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32607\n\n",
    "created_at": "2021-10-02T02:23:47Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "title": "compatibility with gsl 2.7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32370",
    "user": "lorenz"
}
```
CC:  mkoeppe

Keywords: gsl

GSL 2.7 changes the definition of `gsl_complex`; see https://groups.google.com/g/sage-devel/c/yQ67Wy0gp58/m/jr6f7xtcBQAJ and #32587.

This patch changes the library code to use the macros provided by GSL instead of directly accessing the data structure, which should make things work with GSL 2.7 as well as older versions.

Issue created by migration from https://trac.sagemath.org/ticket/32607





---

archive/issue_comments_461886.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461886",
    "user": "lorenz"
}
```

New commits:



---

archive/issue_comments_461887.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461887",
    "user": "lorenz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461888.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-02T04:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461888",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461889.json:
```json
{
    "body": "multiple errors in the patchbot run",
    "created_at": "2021-10-02T04:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461889",
    "user": "mkoeppe"
}
```

multiple errors in the patchbot run



---

archive/issue_comments_461890.json:
```json
{
    "body": "The bot seems to be running old versions of some these files. In particular, the most common error is\n\n\n```\n      File \"sage/ext/interpreters/wrapper_cdf.pyx\", line 17, in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3144)\n        z._complex.real = creal(dz)\n    AttributeError: 'dict' object has no attribute 'real'\n```\n\n\n\u2014 but line 17 of `wrapper_cdf.pyx` was changed in this patch (indirectly via `sage_setup/autogen/interpreters/specs/cdf.py`) to something different from what the error message shows.\n\nI suppose the bot should be instructed to regenerate `wrapper_cdf.pyx` somehow?",
    "created_at": "2021-10-02T05:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461890",
    "user": "lorenz"
}
```

The bot seems to be running old versions of some these files. In particular, the most common error is


```
      File "sage/ext/interpreters/wrapper_cdf.pyx", line 17, in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3144)
        z._complex.real = creal(dz)
    AttributeError: 'dict' object has no attribute 'real'
```


â€” but line 17 of `wrapper_cdf.pyx` was changed in this patch (indirectly via `sage_setup/autogen/interpreters/specs/cdf.py`) to something different from what the error message shows.

I suppose the bot should be instructed to regenerate `wrapper_cdf.pyx` somehow?



---

archive/issue_comments_461891.json:
```json
{
    "body": "Then the patchbot won't be helpful after all. Next step: Portability testing on GH Actions",
    "created_at": "2021-10-02T05:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461891",
    "user": "mkoeppe"
}
```

Then the patchbot won't be helpful after all. Next step: Portability testing on GH Actions



---

archive/issue_comments_461892.json:
```json
{
    "body": "https://github.com/kgywlytnch/sagetrac-mirror/actions/runs/1301872704\n\nDid I do this right? The failures seem unrelated to what we're doing here.",
    "created_at": "2021-10-07T02:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461892",
    "user": "lorenz"
}
```

https://github.com/kgywlytnch/sagetrac-mirror/actions/runs/1301872704

Did I do this right? The failures seem unrelated to what we're doing here.



---

archive/issue_comments_461893.json:
```json
{
    "body": "Yes, looking good. In particular works without failure on `ubuntu-bionic-standard`, where it's using system GSL 2.4+dfsg-6",
    "created_at": "2021-10-07T02:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461893",
    "user": "mkoeppe"
}
```

Yes, looking good. In particular works without failure on `ubuntu-bionic-standard`, where it's using system GSL 2.4+dfsg-6



---

archive/issue_comments_461894.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-07T02:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461894",
    "user": "mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_461895.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-10-07T03:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461895",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_461896.json:
```json
{
    "body": "\n```\nsage: complex_plot(sqrt(x), (-5, 5), (-5, 5))\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\nAttributeError: 'dict' object has no attribute 'real'\nException ignored in: 'sage.ext.interpreters.wrapper_cdf.CDE_to_dz'\nTraceback (most recent call last):\n  File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py\", line 491, in wrapper\n    return func(*args, **options)\nAttributeError: 'dict' object has no attribute 'real'\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-1-248579947237> in <module>\n----> 1 complex_plot(sqrt(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))\n\n~/Sage/local/lib64/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4052)()\n    360             True\n    361         \"\"\"\n--> 362         return self.get_object()(*args, **kwds)\n    363 \n    364     def __repr__(self):\n\n~/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py in wrapper(*args, **kwds)\n    489                 options['__original_opts'] = kwds\n    490             options.update(kwds)\n--> 491             return func(*args, **options)\n    492 \n    493         #Add the options specified by @options to the signature of the wrapped\n\n~/Sage/local/lib64/python3.9/site-packages/sage/plot/complex_plot.pyx in sage.plot.complex_plot.complex_plot (build/cythonized/sage/plot/complex_plot.c:5949)()\n    398         for x in srange(*x_range, include_endpoint=True):\n    399             sig_check()\n--> 400             row.append(f(new_CDF_element(x, y)))\n    401         z_values.append(row)\n    402 \n\n~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.Wrapper_cdf.__call__ (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:4068)()\n    108         for i from 0 <= i < len(args):\n    109             self._args[i] = CDE_to_dz(args[i])\n--> 110         return dz_to_CDE(interp_cdf(c_args\n    111             , self._constants\n    112             , self._py_constants\n\n~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3142)()\n     15 cdef inline ComplexDoubleElement dz_to_CDE(double_complex dz):\n     16     cdef ComplexDoubleElement z = <ComplexDoubleElement>ComplexDoubleElement.__new__(ComplexDoubleElement)\n---> 17     z._complex.real = creal(dz)\n     18     z._complex.imag = cimag(dz)\n     19     return z\n\nAttributeError: 'dict' object has no attribute 'real'\n```\n",
    "created_at": "2021-10-09T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461896",
    "user": "vbraun"
}
```


```
sage: complex_plot(sqrt(x), (-5, 5), (-5, 5))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
AttributeError: 'dict' object has no attribute 'real'
Exception ignored in: 'sage.ext.interpreters.wrapper_cdf.CDE_to_dz'
Traceback (most recent call last):
  File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py", line 491, in wrapper
    return func(*args, **options)
AttributeError: 'dict' object has no attribute 'real'
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-248579947237> in <module>
----> 1 complex_plot(sqrt(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))

~/Sage/local/lib64/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4052)()
    360             True
    361         """
--> 362         return self.get_object()(*args, **kwds)
    363 
    364     def __repr__(self):

~/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py in wrapper(*args, **kwds)
    489                 options['__original_opts'] = kwds
    490             options.update(kwds)
--> 491             return func(*args, **options)
    492 
    493         #Add the options specified by @options to the signature of the wrapped

~/Sage/local/lib64/python3.9/site-packages/sage/plot/complex_plot.pyx in sage.plot.complex_plot.complex_plot (build/cythonized/sage/plot/complex_plot.c:5949)()
    398         for x in srange(*x_range, include_endpoint=True):
    399             sig_check()
--> 400             row.append(f(new_CDF_element(x, y)))
    401         z_values.append(row)
    402 

~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.Wrapper_cdf.__call__ (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:4068)()
    108         for i from 0 <= i < len(args):
    109             self._args[i] = CDE_to_dz(args[i])
--> 110         return dz_to_CDE(interp_cdf(c_args
    111             , self._constants
    112             , self._py_constants

~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3142)()
     15 cdef inline ComplexDoubleElement dz_to_CDE(double_complex dz):
     16     cdef ComplexDoubleElement z = <ComplexDoubleElement>ComplexDoubleElement.__new__(ComplexDoubleElement)
---> 17     z._complex.real = creal(dz)
     18     z._complex.imag = cimag(dz)
     19     return z

AttributeError: 'dict' object has no attribute 'real'
```




---

archive/issue_comments_461897.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-09T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461897",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_461898.json:
```json
{
    "body": "... that's the issue with incremental builds, same as comment:3",
    "created_at": "2021-10-09T17:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461898",
    "user": "mkoeppe"
}
```

... that's the issue with incremental builds, same as comment:3



---

archive/issue_comments_461899.json:
```json
{
    "body": "hmm well that sounds like a problem with the dependencies, is it fixable?",
    "created_at": "2021-10-09T19:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461899",
    "user": "vbraun"
}
```

hmm well that sounds like a problem with the dependencies, is it fixable?



---

archive/issue_comments_461900.json:
```json
{
    "body": "The relevant code is in `src/sage_setup/autogen/interpreters/__init__.py`, I haven't looked at the details",
    "created_at": "2021-10-09T20:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461900",
    "user": "mkoeppe"
}
```

The relevant code is in `src/sage_setup/autogen/interpreters/__init__.py`, I haven't looked at the details



---

archive/issue_comments_461901.json:
```json
{
    "body": "I am working on a fix.",
    "created_at": "2021-10-09T22:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461901",
    "user": "mkoeppe"
}
```

I am working on a fix.



---

archive/issue_comments_461902.json:
```json
{
    "body": "Fixed in #32659",
    "created_at": "2021-10-10T04:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461902",
    "user": "mkoeppe"
}
```

Fixed in #32659



---

archive/issue_comments_461903.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-10T04:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461903",
    "user": "mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_461904.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32370#issuecomment-461904",
    "user": "vbraun"
}
```

Resolution: fixed
