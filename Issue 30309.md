# Issue 30309: make sure the newest system python3 is selected

Issue created by migration from https://trac.sagemath.org/ticket/30546

Original creator: dimpase

Original creation time: 2020-09-10 11:07:12

CC:  mkoeppe embray mjo

#29033 has introduced an unfortunate bug related to a weird search order in `AC_PATH_PROGS_FEATURE_CHECK()`, which has the outer loop over PATH entries. Thus, a python on the list `[python.foo python.baz ....]` of pythons that comes first in `PATH` and has all the features will be picked, not the first python on the list.

As modifying `PATH` to put the best python 1st might be error-prone (think about Conda, Homebrew, etc), this is fixed by providing an using a modified
version of `AC_PATH_PROGS_FEATURE_CHECK`, called `SAGE_PATH_PROGS_FEATURE_CHECK`.

This is of course an autoconf bug, too, as e.g. `AC_PATH_PROGS()` has a sane order, ie. its outer loop is over the list entries.


---

Comment by dimpase created at 2020-09-10 11:08:36

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-10 11:08:36

perhaps copypasted comments in .m4 file may be trimmed.


---

Comment by mkoeppe created at 2020-09-10 15:08:22

I don't know if this is a defect. If you have a directory containing python3 in the front of your path, shouldn't that be the python we are using?


---

Comment by mkoeppe created at 2020-09-10 15:08:29

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2020-09-10 15:21:08

Why is that the case? It's perfectly fine to have different fully-featured python3.x installed.
It works on Homebrew to use its python3.8 in Sage, while python3 still is python3.7
It works on Gentoo, which may have python3.6-9 installed all at the same time.
(Python plays an important role on Linux, one can't easily bump the version)

E.g. that's what I have on a Gentoo box, without doing anything special:

```
# python3 <tab>
python3            python3.7-config   python3.7m-config  python3.8-config   python3.9-config   
python3.7          python3.7m         python3.8          python3.9          python3-config 
```


On Ubuntu 18.04 one can install python3.8 (the system python is 3.6, and I'm not sure if it works well in Sage)


---

Comment by dimpase created at 2020-09-10 15:27:12

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-09-10 15:34:33

Replying to [comment:5 dimpase]:
> Why is that the case? 

Because the user seems to have expressed a preference for the python3 provided by the directory in the front of the PATH.


---

Comment by dimpase created at 2020-09-10 15:43:24

Replying to [comment:7 mkoeppe]:
> Replying to [comment:5 dimpase]:
> > Why is that the case? 
> 
> Because the user seems to have expressed a preference for the python3 provided by the directory in the front of the PATH.
> 
for this, we should revive `--with-python=` option, not this kinds of silly hacks.

Besides, as I said, it's not always safe to prepend stuff to your PATH.


---

Comment by mkoeppe created at 2020-09-10 16:32:24

Putting the bin directory of a Python installation in the front of the PATH is the standard way of activating a venv, for example.


---

Comment by mkoeppe created at 2020-09-10 16:33:55

Replying to [ticket:30546 dimpase]:
> As modifying `PATH` to put the best python 1st might be error-prone (think about Conda, Homebrew, etc)

I would think this needs some elaboration.


---

Comment by dimpase created at 2020-09-10 17:03:40

Replying to [comment:10 mkoeppe]:
> Replying to [ticket:30546 dimpase]:
> > As modifying `PATH` to put the best python 1st might be error-prone (think about Conda, Homebrew, etc)
> 
> I would think this needs some elaboration.

Say, you build under Homebrew, but want to use system Python, in /usr/bin.
Prepending /usr/bin to your PATH will likely break stuff in Hombrew, as some of it depends on /usr/local/bin being first in your PATH.

Same with Conda - it prepends stuff to PATH, and prepending /usr/bin or /usr/local/bin to PATH under active Conda will likely break it. 

In general, many Python-dependent environments have the concept of "main" Python. We discussed on `sage-devel` that Homebrew modifies `~/.zshrc` (if the account's shell is `zsh`)

```
% cat ~/.zshrc
export PATH="/usr/local/opt/python@3.7/bin:$PATH"
```

Prepending to the PATH here might open a can of worms.


---

Comment by mjo created at 2020-09-10 18:22:42

I think I agree with Matthias here. Prepending locations to the search path is the "standard" way of encouraging autotools to find your preferred version of something, and our widespread use of e.g. `AC_CHECK_PROGS` and `AC_SEARCH_LIBS` relies on that.

In this case maybe it is unexpected that a copy of python-3.6 in `/usr/local/bin` will be preferred over a copy of `python-3.8` in `/usr/bin`, but... does that cause any real problems? We only detect supported versions, so any version we detect should be OK, right?


---

Comment by dimpase created at 2020-09-10 18:40:41

I don't understand - I have given you an example: prepending /usr/bin to PATH on Homebrew or Conda is basically not possible. 

Yet I want to build Sage with Python3.8  in /usr/bin, as opposed to an earlier version which is 1st in the PATH.


---

Comment by mkoeppe created at 2020-09-10 18:43:01

Replying to [comment:11 dimpase]:
> In general, many Python-dependent environments have the concept of "main" Python.

Yes, it's represented by the unversioned "python3" in the front of the PATH.


---

Comment by mkoeppe created at 2020-09-10 18:44:03

Replying to [comment:13 dimpase]:
> I don't understand - I have given you an example: prepending /usr/bin to PATH on Homebrew or Conda is basically not possible. 

Why would anyone want to prepend /usr/bin?


---

Comment by mkoeppe created at 2020-09-10 18:44:51

Changing priority from critical to major.


---

Comment by mkoeppe created at 2020-09-10 18:44:51

Sorry, I don't see evidence of a "critical defect" anywhere here


---

Comment by mkoeppe created at 2020-09-10 18:54:49

Replying to [comment:8 dimpase]:
> we should revive `--with-python=` option

Yes, I think so. Note that it is already possible to do `./configure PYTHON3=/some/path/to/python3`, but this completely disables the check for the suitability of this python.


---

Comment by mjo created at 2020-09-10 18:55:38

Replying to [comment:13 dimpase]:
> I don't understand - I have given you an example: prepending /usr/bin to PATH on Homebrew or Conda is basically not possible. 
> 
> Yet I want to build Sage with Python3.8  in /usr/bin, as opposed to an earlier version which is 1st in the PATH.

I understand. Can you prepend your preferred location to `PATH` only during `./configure`? It's a given that you don't want to prepend it _everywhere_. We have a problem either way. If we make your change, then it becomes harder to override a newer python in `/usr/bin` with an older one in e.g. `/usr/local/bin`.

Bringing back `--with-python` could address both concerns... but does `PATH=whatever ./configure` not work?


---

Comment by dimpase created at 2020-09-10 19:44:43

Replying to [comment:18 mjo]:
> Replying to [comment:13 dimpase]:
> > I don't understand - I have given you an example: prepending /usr/bin to PATH on Homebrew or Conda is basically not possible. 
> > 
> > Yet I want to build Sage with Python3.8  in /usr/bin, as opposed to an earlier version which is 1st in the PATH.
> 
> I understand. Can you prepend your preferred location to `PATH` only during `./configure`? 

This is a very fragile solution. There are many things in /usr/bin that might wreak havoc, imagine some `foobar-config` which has to be called by `./configure`


> It's a given that you don't want to prepend it _everywhere_. We have a problem either way. 


my solution has one advantage - it makes the outcome independent of the order of things in PATH, which is something that users might - and will - screw up.


> If we make your change, then it becomes harder to override a newer python in `/usr/bin` with an older one in e.g. `/usr/local/bin`.
> 
> Bringing back `--with-python` could address both concerns... but does `PATH=whatever ./configure` not work?

it is a bit pointless to discuss whether it works on a box at hand, as it is obviously a very fragile solution, and I explained why.


---

Comment by mjo created at 2020-09-10 19:48:38

Replying to [comment:19 dimpase]:
> it is a bit pointless to discuss whether it works on a box at hand, as it is obviously a very fragile solution, and I explained why. 

We probably don't want normal users doing it to override one specific program (python) and not others, sure. I was just curious. And I had forgotten that `PYTHON3=...` works by virtue of autotools.

I guess we all agree `--with-python` is the most robust answer?


---

Comment by mkoeppe created at 2020-09-10 19:49:23

Replying to [comment:19 dimpase]:
> my solution has one advantage - it makes the outcome independent of the order of things in PATH, which is something that users might - and will - screw up.

But I don't think this is what users want. If there's a `python3` in the front of the PATH, we should not prefer a `python3.8` from the rear of the PATH. This is incompatible with standard practice of activating a venv.


---

Comment by mkoeppe created at 2020-09-10 19:56:56

We could perhaps just reduce this list to just `python3`,
and add the `--with-python` support.


---

Comment by dimpase created at 2020-09-10 20:17:22

Replying to [comment:22 mkoeppe]:
> We could perhaps just reduce this list to just `python3`,

But there are cases where python3 is not what one wants - do you mean to bypass the test then all together? This is not a good idea, we still need to test the input provided by `--with-python=`

> and add the `--with-python` support.


---

Comment by mkoeppe created at 2020-09-10 20:34:16

No, just shorten the list of candidate binary names to just `python3`. Keeping the test and thus the loop over the elements of PATH.

And add `--with-python`.

Both in the same ticket.


---

Comment by dimpase created at 2020-09-10 21:30:44

I don't understand - isn't prepending to PATH a venv's binary directory about a new directory, only containing (links to) things which aren't in the PATH at all, but nothing else?


---

Comment by dimpase created at 2020-09-10 21:35:01

Replying to [comment:15 mkoeppe]:
> Replying to [comment:13 dimpase]:
> > I don't understand - I have given you an example: prepending /usr/bin to PATH on Homebrew or Conda is basically not possible. 
> 
> Why would anyone want to prepend /usr/bin?

if you want to install Sage into a Python that is in /usr/bin, then under the current scheme of things it might not get picked if /usr/bin is not the 1st in PATH.


---

Comment by dimpase created at 2020-09-10 21:37:43

Replying to [comment:24 mkoeppe]:
> No, just shorten the list of candidate binary names to just `python3`.
Then only the unversioned python3 would be possible, no?


---

Comment by mkoeppe created at 2020-09-10 22:09:05

If a user wants a versioned one, they would be using `--with-python=....`


---

Comment by dimpase created at 2020-09-11 07:56:25

Replying to [comment:28 mkoeppe]:
> If a user wants a versioned one, they would be using `--with-python=....`
naturally one will need to run tests, currently encapsulated  in an argument of `AC_PATH_PROGS_FEATURE_CHECK()` on the input.


---

Comment by mkoeppe created at 2020-09-11 15:10:13

Yes.


---

Comment by mkoeppe created at 2020-09-11 16:05:42

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-09-21 10:36:32

Can we get rid of Python 2 checks here? It's pointless to try to build Sage with Python 3, so why bother with

```
AS_IF([test $SAGE_PYTHON_VERSION = 2], [
        dnl If we use Python 2 for Sage, we install Python 3...
```



---

Comment by dimpase created at 2020-09-21 10:48:56

Matthias, please refactor your wall of code in `build/pkgs/python3/spkg-configure.m4` into a separate macro that just checks the features (to be put in `m4/`), and the rest,
its too onerous as it is, with setting various `ac_*_PYTHON3*` variables, very hard for me to proceed here otherwise.

The refactoring should have taken place on #27824, I know...


---

Comment by mkoeppe created at 2020-09-21 15:52:07

Good idea, will do.


---

Comment by mkoeppe created at 2020-09-22 01:05:29

Here you go
----
New commits:


---

Comment by git created at 2020-09-22 01:15:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-23 21:25:43

New commits:


---

Comment by dimpase created at 2020-09-23 21:25:43

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-09-23 21:31:52


```
--- a/src/bin/sage-env-config.in
+++ b/src/bin/sage-env-config.in
@@ -46,7 +46,6 @@ CONFIGURED_OBJCXX="@OBJCXX@"
 #######################################
 # Other configuration (exported)
 #######################################
-export SAGE_PYTHON_VERSION=@SAGE_PYTHON_VERSION@
 export PYTHON_FOR_VENV="@PYTHON_FOR_VENV@"
```

I don't think this is a good idea. User packages' install scripts might depend on it.


---

Comment by mkoeppe created at 2020-09-23 21:35:45


```
-case "$with_python" in
-    3)  SAGE_PYTHON_VERSION=3;;
-    3*) AC_MSG_WARN([the only allowed value for --with-python is 3; specific Python 3.x versions cannot be requested using --with-python.  For compatibility reasons, this is only a warning.  Use './configure PYTHON3=/path/to/python3' to use a specific Python 3 binary for the Sage venv.])
-        SAGE_PYTHON_VERSION=3;;
-    "") SAGE_PYTHON_VERSION=3;;
-    *)
-        AC_MSG_ERROR([the only allowed value for --with-python is 3.  Support for Python 2 has been removed in Sage 9.2.]);;
```

And I think the previously allowed argument `--with-python=3` should still be allowed and be a no-op; and `--with-python=2` should give a specific error message as before.


---

Comment by git created at 2020-09-23 21:50:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-23 21:52:17

there is still one obsolete place, in docker/Dockerfile:


```
ARG WITH_PYTHON=2
ENV WITH_PYTHON $WITH_PYTHON
ARG MAKEFLAGS="-j2"
ENV MAKEFLAGS $MAKEFLAGS
ARG SAGE_NUM_THREADS="2"
ENV SAGE_NUM_THREADS $SAGE_NUM_THREADS
RUN make configure
RUN ./configure --with-python=$WITH_PYTHON
```

can it be removed?


---

Comment by git created at 2020-09-23 21:54:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-23 21:55:50

Yes, looks like it.


---

Comment by mkoeppe created at 2020-09-23 21:56:04

I think you missed a few places in tox.ini


---

Comment by git created at 2020-09-23 22:03:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-23 22:21:30

Need to adjust `.ci/build-docker.sh` too


---

Comment by mkoeppe created at 2020-09-23 22:23:30


```
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -371,7 +371,7 @@ command ``docker build``.  For example::
   [mkoeppe@sage sage]$ docker build . -f Dockerfile \
     --build-arg BASE_IMAGE=ubuntu:latest \
     --build-arg NUMPROC=4 \
-    --build-arg EXTRA_CONFIGURE_ARGS="--with-python=2"
+    --build-arg EXTRA_CONFIGURE_ARGS="--with-python=/usr/opt/python3.42"
```

better to use an example that looks like a binary, not a directory


---

Comment by git created at 2020-09-24 10:24:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-24 10:25:57

OK, should we also get rid of `SAGE_PYTHON3` ?


---

Comment by git created at 2020-09-24 11:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-24 12:59:51

comments 42, 43


---

Comment by dimpase created at 2020-09-24 15:38:48

Replying to [comment:42 mkoeppe]:
> {{{
> --- a/src/bin/sage-env-config.in
> +++ b/src/bin/sage-env-config.in
> `@``@` -46,7 +46,6 `@``@` CONFIGURED_OBJCXX="`@`OBJCXX`@`"
>  #######################################
>  # Other configuration (exported)
>  #######################################
> -export SAGE_PYTHON_VERSION=`@`SAGE_PYTHON_VERSION`@`
>  export PYTHON_FOR_VENV="`@`PYTHON_FOR_VENV`@`"
> }}}
> I don't think this is a good idea. User packages' install scripts might depend on it.
> 
it was never documented, thus, a fair game.


---

Comment by git created at 2020-09-24 16:06:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-24 16:36:23

Replying to [comment:57 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[fc6b49d](https://git.sagemath.org/sage.git/commit/?id=fc6b49d4071a63c83c7ecb2db12b4ff0c43e5568)||`handle --with-python=2 or 3`||

this addesses comment:43


---

Comment by mkoeppe created at 2020-09-24 16:44:54

This seems to work well. I have made some small changes.
----
New commits:


---

Comment by mkoeppe created at 2020-09-24 16:45:57

If OK with you, feel free to set to positive review


---

Comment by mkoeppe created at 2020-09-24 16:53:58

Actually... this still needs to ensure an absolute path for PYTHON_FOR_VENV


---

Comment by git created at 2020-09-24 17:07:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-24 17:09:41

I think this version is good.


---

Comment by git created at 2020-09-24 18:43:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-24 18:43:42

Merged #30576 to avoid merge conflict


---

Comment by git created at 2020-09-24 18:56:18

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-09-24 18:56:37

Meregd #29500 to avoid merge conflict


---

Comment by dimpase created at 2020-09-24 20:25:43

it is broken:

```
$ ./configure --with-python=/usr/bin/python3 >/tmp/p
configure: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable
```

(while just `./configure`, using the same python3, but implicitly, works)

It seems you are repeating the error that took me hours to sort out today, you have two
`AC_PATH_PROGS_FEATURE_CHECK` with the same tag. That's why I made sure only to have one call to AC_PATH_PROGS_FEATURE_CHECK - and why do you need more?


---

Comment by dimpase created at 2020-09-24 20:28:12

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-09-24 20:54:57

Perhaps it's just that AC_PATH_PROGS_FEATURE_CHECK does not like it if the searched executable is already an absolute path?

I may only have tested with executable names without directory...


---

Comment by dimpase created at 2020-09-24 21:44:31

OK, this appears to work. I just convert the name into an absolute one, if needed, by calling `AC_PATH_PROG()`
----
New commits:


---

Comment by dimpase created at 2020-09-24 21:44:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-09-25 01:53:00

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-09-25 11:15:50

I think we really want this in 9.2, not the least as it documents stuff.


---

Comment by dimpase created at 2020-09-25 11:15:50

Changing priority from major to critical.


---

Comment by vbraun created at 2020-09-30 22:30:14

Resolution: fixed
