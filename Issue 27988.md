# Issue 27988: Allow sage to run in the absence of sage-env

archive/issues_027988.json:
```json
{
    "body": "CC:  @saraedum @isuruf @kiwifb @timokau\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28225\n\n",
    "created_at": "2019-07-21T10:20:40Z",
    "labels": [],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Allow sage to run in the absence of sage-env",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27988",
    "user": "https://github.com/antonio-rojas"
}
```
CC:  @saraedum @isuruf @kiwifb @timokau



Issue created by migration from https://trac.sagemath.org/ticket/28225





---

archive/issue_comments_395016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-21T10:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395017.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to distribution.",
    "created_at": "2019-07-21T10:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395017",
    "user": "https://github.com/antonio-rojas"
}
```

Changing component from PLEASE CHANGE to distribution.



---

archive/issue_comments_395018.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-07-21T10:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395018",
    "user": "https://github.com/antonio-rojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_395019.json:
```json
{
    "body": "I have been `sage-env` free for a few releases now in sage-on-gentoo. I ship my own sage script now, but the change I see in the commit are good. I think you should also fix `sage-cython` https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-8.1-sage-cython.patch which won't work with stuff from the environment. I also have this patch for various scripts https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-bin-8.7.patch\n\nI also have \n\n```\n# Replace SAGE_EXTCODE with the installation location\n\tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n\t\tbin/sage-ipynb2rst \\\n\t\tbin/sage-valgrind\n```\n\nwhich may be harder to replace more generally.\n\nI haven't made any fix to runtests, but `DOT_SAGE` should definitely be set - for some exotic usage with valgrind and other tools.",
    "created_at": "2019-07-21T11:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395019",
    "user": "https://github.com/kiwifb"
}
```

I have been `sage-env` free for a few releases now in sage-on-gentoo. I ship my own sage script now, but the change I see in the commit are good. I think you should also fix `sage-cython` https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-8.1-sage-cython.patch which won't work with stuff from the environment. I also have this patch for various scripts https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-bin-8.7.patch

I also have 

```
# Replace SAGE_EXTCODE with the installation location
	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
		bin/sage-ipynb2rst \
		bin/sage-valgrind
```

which may be harder to replace more generally.

I haven't made any fix to runtests, but `DOT_SAGE` should definitely be set - for some exotic usage with valgrind and other tools.



---

archive/issue_comments_395020.json:
```json
{
    "body": "Thanks. Most of these work fine here just because /bin symlinked to /usr/bin, but that certainly shouldn't be assumed",
    "created_at": "2019-07-21T11:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395020",
    "user": "https://github.com/antonio-rojas"
}
```

Thanks. Most of these work fine here just because /bin symlinked to /usr/bin, but that certainly shouldn't be assumed



---

archive/issue_comments_395021.json:
```json
{
    "body": "Yes, I hadn't thought of that scenario at all, where the variable being undefined is actually helpful. But it will break on other system. But that doesn't help with `sage-cython`.",
    "created_at": "2019-07-21T11:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395021",
    "user": "https://github.com/kiwifb"
}
```

Yes, I hadn't thought of that scenario at all, where the variable being undefined is actually helpful. But it will break on other system. But that doesn't help with `sage-cython`.



---

archive/issue_comments_395022.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-21T11:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395022",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395023.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-21T12:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395023",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395024.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> I also have \n> {{{\n> # Replace SAGE_EXTCODE with the installation location\n> \tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n> \t\tbin/sage-ipynb2rst \\\n> \t\tbin/sage-valgrind\n> }}}\n> which may be harder to replace more generally.\n\nFixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)",
    "created_at": "2019-07-21T12:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395024",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:5 fbissey]:
> I also have 
> {{{
> # Replace SAGE_EXTCODE with the installation location
> 	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
> 		bin/sage-ipynb2rst \
> 		bin/sage-valgrind
> }}}
> which may be harder to replace more generally.

Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)



---

archive/issue_comments_395025.json:
```json
{
    "body": "Replying to [comment:10 arojas]:\n> Replying to [comment:5 fbissey]:\n> > I also have \n> > {{{\n> > # Replace SAGE_EXTCODE with the installation location\n> > \tsed -i \"s:\\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g\" \\\n> > \t\tbin/sage-ipynb2rst \\\n> > \t\tbin/sage-valgrind\n> > }}}\n> > which may be harder to replace more generally.\n> \n> Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)\n\nCertainly does look hackish. I would have never thought of using `print` that way. Does this really work?",
    "created_at": "2019-07-21T20:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395025",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:10 arojas]:
> Replying to [comment:5 fbissey]:
> > I also have 
> > {{{
> > # Replace SAGE_EXTCODE with the installation location
> > 	sed -i "s:\$SAGE_EXTCODE:${EPREFIX}/usr/share/sage/ext:g" \
> > 		bin/sage-ipynb2rst \
> > 		bin/sage-valgrind
> > }}}
> > which may be harder to replace more generally.
> 
> Fixed in the latest commit (in a somewhat hackish way, would be nice if someone could come up with a nicer way to do it)

Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?



---

archive/issue_comments_395026.json:
```json
{
    "body": "> Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?\n\nSure it does - we use this kind of thing frequently in Arch build scripts to get the python lib dir independently of the version.",
    "created_at": "2019-07-21T21:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395026",
    "user": "https://github.com/antonio-rojas"
}
```

> Certainly does look hackish. I would have never thought of using `print` that way. Does this really work?

Sure it does - we use this kind of thing frequently in Arch build scripts to get the python lib dir independently of the version.



---

archive/issue_comments_395027.json:
```json
{
    "body": "OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.",
    "created_at": "2019-07-21T21:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395027",
    "user": "https://github.com/kiwifb"
}
```

OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.



---

archive/issue_comments_395028.json:
```json
{
    "body": "How do you deal with `SAGE_LOCAL` in the `sage` script? Because of arch having `/usr/bin` and `/bin` symlinked you may not catch problems in line 7 and 8. There are a number of calls to `SAGE_LOCAL` in that file you are probably missing altogether.",
    "created_at": "2019-07-21T21:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395028",
    "user": "https://github.com/kiwifb"
}
```

How do you deal with `SAGE_LOCAL` in the `sage` script? Because of arch having `/usr/bin` and `/bin` symlinked you may not catch problems in line 7 and 8. There are a number of calls to `SAGE_LOCAL` in that file you are probably missing altogether.



---

archive/issue_comments_395029.json:
```json
{
    "body": "Replying to [comment:13 fbissey]:\n> OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.\n\nAfter line 1078 we also have `$SAGE_EXTCODE` in lines 1099 to 1101.",
    "created_at": "2019-07-21T22:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395029",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:13 fbissey]:
> OK, I am reviewing all my patches and stuff for interesting bits. In `sage/doctest/control.py` There are several commands build with `$SAGE_LOCAL` in a way that requires it to be picked up from the environment (lines 1028, 1078 in code and lines 1026, 1062, 1069 for stuff that could be doctests). We probably want to import `SAGE_LOCAL` from `env.py` instead and insert that value.

After line 1078 we also have `$SAGE_EXTCODE` in lines 1099 to 1101.



---

archive/issue_comments_395030.json:
```json
{
    "body": "Adding my ideas for `sage/doctests/control.py`. Feel free to regain control of the branch.\n----\nNew commits:",
    "created_at": "2019-07-21T22:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395030",
    "user": "https://github.com/kiwifb"
}
```

Adding my ideas for `sage/doctests/control.py`. Feel free to regain control of the branch.
----
New commits:



---

archive/issue_comments_395031.json:
```json
{
    "body": "It may be impossible to completely fix the `sage` script at this stage. Best efforts at improvement would be acceptable to me.",
    "created_at": "2019-07-21T22:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395031",
    "user": "https://github.com/kiwifb"
}
```

It may be impossible to completely fix the `sage` script at this stage. Best efforts at improvement would be acceptable to me.



---

archive/issue_comments_395032.json:
```json
{
    "body": "I think all SAGE_LOCAL usage in the sage executable part that is relevant for !sage-the-distro is gone now\n----\nNew commits:",
    "created_at": "2019-07-21T22:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395032",
    "user": "https://github.com/antonio-rojas"
}
```

I think all SAGE_LOCAL usage in the sage executable part that is relevant for !sage-the-distro is gone now
----
New commits:



---

archive/issue_comments_395033.json:
```json
{
    "body": "I don't think there is anything to add. Time for review?",
    "created_at": "2019-07-21T23:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395033",
    "user": "https://github.com/kiwifb"
}
```

I don't think there is anything to add. Time for review?



---

archive/issue_comments_395034.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-22T02:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395034",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_395035.json:
```json
{
    "body": "I am putting in \"needs review\" to start the patchbots (I hope).",
    "created_at": "2019-07-22T02:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395035",
    "user": "https://github.com/kiwifb"
}
```

I am putting in "needs review" to start the patchbots (I hope).



---

archive/issue_comments_395036.json:
```json
{
    "body": "Some tests are failing locally without sage-env\n\n```\nsage -t --long /usr/lib/python2.7/site-packages/sage/misc/sagedoc.py  # 1 doctest failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/misc/sphinxify.py  # 4 doctests failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/libs/singular/function.pyx  # 1 doctest failed\nsage -t --long /usr/lib/python2.7/site-packages/sage/interfaces/singular.py  # 5 doctests failed\n```\n",
    "created_at": "2019-07-22T06:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395036",
    "user": "https://github.com/antonio-rojas"
}
```

Some tests are failing locally without sage-env

```
sage -t --long /usr/lib/python2.7/site-packages/sage/misc/sagedoc.py  # 1 doctest failed
sage -t --long /usr/lib/python2.7/site-packages/sage/misc/sphinxify.py  # 4 doctests failed
sage -t --long /usr/lib/python2.7/site-packages/sage/libs/singular/function.pyx  # 1 doctest failed
sage -t --long /usr/lib/python2.7/site-packages/sage/interfaces/singular.py  # 5 doctests failed
```




---

archive/issue_comments_395037.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-07-22T06:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395037",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_395038.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-22T07:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395039.json:
```json
{
    "body": "All tests pass now. This branch conflicts with #25786 so it will need rebasing once that one goes in.",
    "created_at": "2019-07-22T07:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395039",
    "user": "https://github.com/antonio-rojas"
}
```

All tests pass now. This branch conflicts with #25786 so it will need rebasing once that one goes in.



---

archive/issue_comments_395040.json:
```json
{
    "body": "I missed the singularpath one because I deal with it in the same patch as I do adjustments to `env.py`. I neglected that. I don't have a problem with `SAGE_DOC_SRC` because I have it default to `SAGE_DOC`  not `SAGE_SRC/doc` in sage-on-gentoo. I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n\nI know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.",
    "created_at": "2019-07-22T07:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395040",
    "user": "https://github.com/kiwifb"
}
```

I missed the singularpath one because I deal with it in the same patch as I do adjustments to `env.py`. I neglected that. I don't have a problem with `SAGE_DOC_SRC` because I have it default to `SAGE_DOC`  not `SAGE_SRC/doc` in sage-on-gentoo. I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.

I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.



---

archive/issue_comments_395041.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n\nThe only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.\n\n> I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.\n\nNo. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.",
    "created_at": "2019-07-22T08:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395041",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:25 fbissey]:
> I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.

The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.

> I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.

No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.



---

archive/issue_comments_395042.json:
```json
{
    "body": "Replying to [comment:26 arojas]:\n> Replying to [comment:25 fbissey]:\n> > I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.\n> \n> The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.\n\nCool, that's a clean up that's almost done then.\n\n> \n> > I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.\n> \n> No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.\n\nAgreed. What to do with that file may be dependent on distro policies as well. It belongs to the location I set `SAGE_DOC` to, by policy in sage-on-gentoo.\n\nThis ticket is dealing with a good number of loose ends, it is quite nice.",
    "created_at": "2019-07-22T08:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395042",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:26 arojas]:
> Replying to [comment:25 fbissey]:
> > I am surprised that's the only place you had to fix. I am expecting anything calling `SAGE_DOC_SRC` at runtime to fail if left at that value.
> 
> The only remaining usages of SAGE_DOC_SRC in sagelib are in sage/doctest/control.py (which adds it to the list of tested dirs when calling sage -t -a) and sage/docs/conf.py (where AFAICS all usages besides the one fixed here are for doc build), so I don't expect more failures.

Cool, that's a clean up that's almost done then.

> 
> > I know there is no doctests in `sage/misc/copying.py` (https://github.com/sagemath/sage/blob/master/src/sage/misc/copying.py) but I am wondering if you do anything about it.
> 
> No. COPYING.txt should probably be installed somewhere in SAGE_SHARE. But given that this is currently broken for distros anyway, I'd say it's material for a different ticket.

Agreed. What to do with that file may be dependent on distro policies as well. It belongs to the location I set `SAGE_DOC` to, by policy in sage-on-gentoo.

This ticket is dealing with a good number of loose ends, it is quite nice.



---

archive/issue_comments_395043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-29T17:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_395044.json:
```json
{
    "body": "Rebased on top of beta 4",
    "created_at": "2019-07-29T17:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395044",
    "user": "https://github.com/antonio-rojas"
}
```

Rebased on top of beta 4



---

archive/issue_comments_395045.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-29T17:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395045",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_395046.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-29T20:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395046",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_395047.json:
```json
{
    "body": "Well, it all looks good to me. Anyone knows why the patchbot doesn't seem to want to pick it? Is it too early after 8.9.beta4?",
    "created_at": "2019-07-29T20:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395047",
    "user": "https://github.com/kiwifb"
}
```

Well, it all looks good to me. Anyone knows why the patchbot doesn't seem to want to pick it? Is it too early after 8.9.beta4?



---

archive/issue_comments_395048.json:
```json
{
    "body": "This is being merge-tested right now. Not runtime but build time, I wish I had spotted some instances of `os.environ` in `sage_setup/docbuild/__init__.py`. \n\nI am hoping the ticket will be merged in the current state and then we can address those little left overs in a follow up ticket.",
    "created_at": "2019-08-02T01:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395048",
    "user": "https://github.com/kiwifb"
}
```

This is being merge-tested right now. Not runtime but build time, I wish I had spotted some instances of `os.environ` in `sage_setup/docbuild/__init__.py`. 

I am hoping the ticket will be merged in the current state and then we can address those little left overs in a follow up ticket.



---

archive/issue_comments_395049.json:
```json
{
    "body": "Another kink I missed before because of my setting of `SAGE_DOC_SRC`. sage doctest the documentation source not the installed one. I guess it also test the source code by looking at SAGE_SRC which default to SAGE_LIB when SAGE_ROOT is undefined. May be we should have gone for a similar model for SAGE_DOC_SRC - instead of the fix currently in `sage/docs/conf.py`?",
    "created_at": "2019-08-02T09:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395049",
    "user": "https://github.com/kiwifb"
}
```

Another kink I missed before because of my setting of `SAGE_DOC_SRC`. sage doctest the documentation source not the installed one. I guess it also test the source code by looking at SAGE_SRC which default to SAGE_LIB when SAGE_ROOT is undefined. May be we should have gone for a similar model for SAGE_DOC_SRC - instead of the fix currently in `sage/docs/conf.py`?



---

archive/issue_comments_395050.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2019-08-02T20:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_395051.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-08-02T20:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395051",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_395052.json:
```json
{
    "body": "I should have said to wait for a follow up ticket. Nevermind, let's see how it plays out.",
    "created_at": "2019-08-02T20:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395052",
    "user": "https://github.com/kiwifb"
}
```

I should have said to wait for a follow up ticket. Nevermind, let's see how it plays out.



---

archive/issue_comments_395053.json:
```json
{
    "body": "Some version of this ticket was merged into 8.9.beta5, and I'm guessing the last commit didn't make it. In any case, the changes that were merged cause an error with Python 3:\n\n```\nsage -t --warn-long 78.7 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 503, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Cython (http://cython.org) is a compiler for code written in the\n    Cython language.  Cython is based on Pyrex by Greg Ewing.\n    ...\nGot:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.9.beta5/src/bin/sage-cython\", line 12, in <module>\n        from sage.env import SAGE_SRC\n    ImportError: No module named sage.env\n    <BLANKLINE>\n```\n\nThe reason is that the `sage-cython` script begins\n\n```/usr/bin/env python\n```\n\nThat means that it uses Python 2 by default. With a Python 3 build, Python 2 doesn't know about the `sage` module.\n\nI'm not sure what you should do instead. Maybe\n\n```\ntry:\n    from sage.env import SAGE_SRC\nexcept ImportError:\n    SAGE_SRC = (something involving SAGE_ROOT or SAGE_LIB?)\n```\n\nWhat variables are guaranteed to be set when `sage-cython` is run?",
    "created_at": "2019-08-03T22:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395053",
    "user": "https://github.com/jhpalmieri"
}
```

Some version of this ticket was merged into 8.9.beta5, and I'm guessing the last commit didn't make it. In any case, the changes that were merged cause an error with Python 3:

```
sage -t --warn-long 78.7 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 503, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Cython (http://cython.org) is a compiler for code written in the
    Cython language.  Cython is based on Pyrex by Greg Ewing.
    ...
Got:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.9.beta5/src/bin/sage-cython", line 12, in <module>
        from sage.env import SAGE_SRC
    ImportError: No module named sage.env
    <BLANKLINE>
```

The reason is that the `sage-cython` script begins

```/usr/bin/env python
```

That means that it uses Python 2 by default. With a Python 3 build, Python 2 doesn't know about the `sage` module.

I'm not sure what you should do instead. Maybe

```
try:
    from sage.env import SAGE_SRC
except ImportError:
    SAGE_SRC = (something involving SAGE_ROOT or SAGE_LIB?)
```

What variables are guaranteed to be set when `sage-cython` is run?



---

archive/issue_comments_395054.json:
```json
{
    "body": "I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.\n\nWe need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.",
    "created_at": "2019-08-03T23:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395054",
    "user": "https://github.com/kiwifb"
}
```

I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.

We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.



---

archive/issue_comments_395055.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-03T23:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395055",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_070175.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-03T23:51:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27988#event-70175"
}
```



---

archive/issue_comments_395056.json:
```json
{
    "body": "c9605200e2b5a1cadefb868fd28ef13ef2bef8c3 was merged and is in 8.9.beta5, go and make a new ticket...",
    "created_at": "2019-08-03T23:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395056",
    "user": "https://github.com/vbraun"
}
```

c9605200e2b5a1cadefb868fd28ef13ef2bef8c3 was merged and is in 8.9.beta5, go and make a new ticket...



---

archive/issue_comments_395057.json:
```json
{
    "body": "Replying to [comment:36 fbissey]:\n> I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.\n\nThe only thing that script does is to check arguments and run `cython`, so it should run fine with the system Python. For distro use, do you even care about how SAGE_SRC is used here? Maybe you could have\n\n```\ntry:\n    SAGE_SRC = os.environ[\"SAGE_SRC\"]\nexcept ImportError:\n    SAGE_SRC = \"/does/not/exist\"\n```\n\nplus some explanatory comments. The whole script is deprecated, so maybe it doesn't matter much what happens to it, but you might cc jdemeyer on the followup ticket.\n \n> We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.\n\nEither one or two: one for your followup issues, maybe a separate one to fix the doctest?",
    "created_at": "2019-08-04T00:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395057",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:36 fbissey]:
> I think `sage-cython` should use the python sage uses otherwise, what's the point? While I don't like it, I am guessing it should use `sage-python23` instead of plain `python`. I am open to contrary opinions.

The only thing that script does is to check arguments and run `cython`, so it should run fine with the system Python. For distro use, do you even care about how SAGE_SRC is used here? Maybe you could have

```
try:
    SAGE_SRC = os.environ["SAGE_SRC"]
except ImportError:
    SAGE_SRC = "/does/not/exist"
```

plus some explanatory comments. The whole script is deprecated, so maybe it doesn't matter much what happens to it, but you might cc jdemeyer on the followup ticket.
 
> We need a follow up ticket for that last commit that didn't make and a couple of things I spotted in `sage_setup` we can throw that in as well.

Either one or two: one for your followup issues, maybe a separate one to fix the doctest?



---

archive/issue_comments_395058.json:
```json
{
    "body": "Filed #28320",
    "created_at": "2019-08-04T09:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395058",
    "user": "https://github.com/antonio-rojas"
}
```

Filed #28320



---

archive/issue_comments_395059.json:
```json
{
    "body": "Follow up: #29022",
    "created_at": "2020-01-17T19:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395059",
    "user": "https://github.com/mkoeppe"
}
```

Follow up: #29022



---

archive/issue_comments_395060.json:
```json
{
    "body": "and #25486",
    "created_at": "2020-01-17T20:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27988#issuecomment-395060",
    "user": "https://github.com/mkoeppe"
}
```

and #25486
