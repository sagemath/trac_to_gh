# Issue 18525: Create coercion between diagram algebras and the symmetric group algebra

Issue created by migration from Trac.

Original creator: ghseeli

Original creation time: 2015-06-22 19:29:29

CC:  alauve s.r.doty saliola tscrim

Keywords: diagram algebra, partition algebra, days65

There is a natural embedding of elements of the symmetric group algebra into diagram algebras, especially the partition algebra and the Brauer algebra. Therefore, there should be a morphism registered to the coercion model to allow for symmetric group algebra elements to be coerced into the appropriate diagram algebras. This morphism is pretty straight forward and will only take a few lines to implement. 


---

Comment by ghseeli created at 2015-06-23 00:27:29

Last 10 new commits:


---

Comment by ghseeli created at 2015-06-23 00:45:23

Alright, so, the code at present does not work. For some reason, I get an MRO error when I try to initialize the SymmetricGroupAlgebra with the same base ring as the DiagramAlgebra. Does anyone have any suggestions about how to fix this?


---

Comment by git created at 2015-06-23 00:46:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-23 01:03:20

An MRO error is extremely strange. I will take a look at this as soon as I can.


---

Comment by ghseeli created at 2015-06-26 17:41:23

Is this a bug in the SymmetricGroupAlgebra?

```
sage: SymmetricGroupAlgebra(SR,3,category = FiniteDimensionalAlgebrasWithBasis(SR))
Traceback
...
TypeError: Cannot create a consistent method resolution
order (MRO) for bases MagmaticAlgebras.subcategory_class, UnitalAlgebras.WithBasis.subcategory_class, AdditiveMagmas.Algebras.subcategory_class
```

But, in a completely new Sage session:

```
sage: SymmetricGroupAlgebra(SR,3)
Symmetric group algebra of order 3 over Symbolic Ring
sage: SymmetricGroupAlgebra(SR,3,category = FiniteDimensionalAlgebrasWithBasis(SR))
Symmetric group algebra of order 3 over Symbolic Ring
```

I have no idea what could be going on here. Is it some clever caching that somehow makes things work? In any event, this is the cause of the issue, I think.

(I tried this in sage6.8beta5)


---

Comment by git created at 2015-06-26 17:53:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-27 05:17:59

Oh wow, that's very interesting behavior...However it is not quite proper input as the category of the Weyl group `W`. Yet it should behave correctly and consistently, or at least give a better error message.


---

Comment by git created at 2015-07-04 02:09:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-08-16 23:34:20

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by ghseeli created at 2015-08-16 23:34:51

Changing status from new to needs_review.


---

Comment by git created at 2015-08-25 02:19:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-08-28 22:50:23

This currently breaks the requirements of a coercion in that the coercion map must be defined on all elements of the domain. So it will need to be a conversion, which you can implement in the `_element_constructor_` method by

```python
if isinstance(x, SymmetricGroupAlgebra.Element) and other_conditions_on_parent(x):
    return convert_to_element_of_self(x)
```

For those diagram algebras which this is well-defined on the entire domain, you can make the call to ``self`` a coercion in the constructor or implement:

```python
def _coerce_map_from_(self, P):
    if isinstance(P, SymmetricGroupAlgebra) and other_conditions(P):
        return True
    return super(self, DiagramAlgebra)._coerce_map_from_(P)
```



---

Comment by vdelecroix created at 2015-09-19 03:24:12

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-09-19 03:24:12

Hello,

Just some sided remarks.

- You have more commits than the number of lines you modified! Moreover most of your commit messages are completely useless. The git history is important since it is used to find out which commit is responsible for a given change. You would better start a new (clean) branch from scratch.
- methods must be documented (see [the developer guide](http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings))

Vincent


---

Comment by tscrim created at 2015-09-19 14:35:39

Replying to [comment:15 vdelecroix]:
> - You have more commits than the number of lines you modified! Moreover most of your commit messages are completely useless. The git history is important since it is used to find out which commit is responsible for a given change. You would better start a new (clean) branch from scratch.

This comment is completely off base. First, learn to use `git blame` and `git log filename` (or `git log -p filename`). Second, the commit messages tell about the changes (although there are some of them that are really long; git practices want the first lines to be short). You are being way too precious about the git history.


---

Comment by ghseeli created at 2015-09-22 02:31:45

Vincent,

Thank you for your feedback. I had intended to change the status from needs_review to needs_work when Travis made his comments 3 weeks ago, so I am sorry you felt compelled to review something that was already in need of a lot of work. I understand that methods must be documented and I will do so accordingly before there is a positive review. However, first, I needed to establish what is going on here, (see the earlier comments about weird coercion behavior) and that is still somewhat (?) in the air. I do agree that my git comments are rather terse, but at the same time, as you note, most of them are rather small and thus looking at the diff should be more than enough to get an idea of what is happening. Furthermore, as someone who develops software semi-professionally, it is not unusual that the number of commits exceeds the number of lines changed. Most software developers would say that the number of lines affected has little correlation with content. Finally, a lot of these commits are due to the age of the ticket. New versions of the beta need to be merged into the branch so that the feature doesn't depart from the current beta. I am sorry that my development cycle has been so slow that this has been necessary. I hope to finish this ticket soon. Thank you for your feedback and I hope you will be more satisfied with the end result when it goes back up for review.

Best,
George


---

Comment by vdelecroix created at 2015-09-22 10:57:49

Hello,

Replying to [comment:17 ghseeli]:
> Finally, a lot of these commits are due to the age of the ticket. New versions of the beta need to be merged into the branch so that the feature doesn't depart from the current beta.

There is no need to merge the last beta.

But anyway, the most important is to do how you feel. And take for the best other's comments to get a better Sage software.

Vincent


---

Comment by git created at 2015-10-10 23:04:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-10-10 23:11:46

Alright, I have now added conversions instead of coercions where appropriate. Furthermore, I have included some appropriate unit tests. I was wondering, should I also include some negative unit tests? As in, verify an error is raised when someone tries to instantiate an invalid algebra element using an inappropriate symmetric group algebra element?

Thank you!


---

Comment by tscrim created at 2015-10-10 23:51:40

Yes, these are also useful to verify that you are checking things properly. Also you should make sure to test corner cases.


---

Comment by git created at 2015-10-11 00:11:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-10-11 00:13:45

Alright, I added some negative unit tests. However, I am now having trouble getting the following test to pass:



```
sage: R.<x> = QQ[]
sage: BA = BrauerAlgebra(2, x, R)
sage: BA.ambient().has_coerce_map_from(BA)
True
```


However, when I run these commands in Sage, the result comes out as expected. Any ideas on why this is happening?


---

Comment by tscrim created at 2015-10-11 03:47:05

My guess is that we have the coercion situation `BA -> X -> A` where `X` is some intermediate object that makes the coercion chain. At some point in the doctests:

1 - `BA` and `A` have been created, but `X` has not.
2 - There is a check in some way for if there is a coercion from `BA` to `A`, which there is not. (This can be something as innocuous as `A(x)` where `x in BA`).
3 - The result of 2 is cached, so even when `X` is created, there is no check to see if there is a coercion path from `BA` to `A`.

However that is just a quick guess from the symptoms. I will take a more detailed look over the next few days.

Side note in case you didn't notice, you have `TESTS:` block which should be `TESTS::`.


---

Comment by git created at 2015-10-11 17:01:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-10-12 00:43:31

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-10-12 00:43:31

Okay, so I figured out what was going on.

<technical>What was happening was you were creating a coercion from a subalgebra to the ambient algebra, but the ambient algebra could be garbage collected because the morphism (which only holds a strong reference to the _codomain_) could be collected and the subalgebra didn't have a strong reference to the ambient algebra. When the ambient algebra was recreated, the morphism was not, and so there was no coercion registered (which is done in the codomains). I reworked things so the lift morphism was strongly referenced, and hence the ambient algebra, by the subalgebra.</technical>

I also reworked the morphisms to the Sage standard practice and expanded coercions to allow when there is also a coercion of base rings. There were also some other misc issues that I fixed as well.

If you're happy with my changes, then you can set a positive review.
----
New commits:


---

Comment by tscrim created at 2015-10-12 00:43:31

Changing priority from minor to major.


---

Comment by ghseeli created at 2015-10-12 02:03:23

Changing status from needs_review to positive_review.


---

Comment by ghseeli created at 2015-10-12 02:04:17

Alright, I now set the ticket to a positive review. Thank you again for all your help Travis! I feel like I am learning a lot more about the internals of Sage.


---

Comment by tscrim created at 2015-10-12 02:37:08

Thanks for your contributions. Feel free to cc me on any future tickets you work on (I suspect I will find them to be useful).


---

Comment by vbraun created at 2015-10-12 22:53:02

Resolution: fixed
