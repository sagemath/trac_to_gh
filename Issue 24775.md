# Issue 24775: Race condition in lazy import cache?

Issue created by migration from https://trac.sagemath.org/ticket/25012

Original creator: @wbl

Original creation time: 2018-03-19 18:38:44

I am running a number of jobs written in sage on a supercomputer. About 20 sage process are all started at the same time. About half an hour later a few fail with the same message at the same time


```
Traceback (most recent call last):
  File "run_cluster.sage.py", line 3, in <module>
    from sage.all_cmdline import *   # import sage library
  File "/global/home/users/wbl/sageinstall/sage-8.1/local/lib/python2.7/site-packages/sage/all_cmdline.py", line 26, in <module>
    from sage.all import *
  File "/global/home/users/wbl/sageinstall/sage-8.1/local/lib/python2.7/site-packages/sage/all.py", line 274, in <module>
    sage.misc.lazy_import.save_cache_file()
  File "sage/misc/lazy_import.pyx", line 1113, in sage.misc.lazy_import.save_cache_file (build/cythonized/sage/misc/lazy_import.c:8384)
  File "/global/home/users/wbl/sageinstall/sage-8.1/local/lib/python2.7/site-packages/sage/misc/temporary_file.py", line 407, in __exit__
    os.unlink(self.target)
OSError: [Errno 2] No such file or directory: '/global/home/users/wbl/.sage/cache/_global_home_users_wbl_sageinstall_sage-8.1_src-lazy_import_cache.pickle'
```


The obvious guess for what is happening is that each of these processes is trying to use the same lazy import cache, and only a few win the race to delete it.


---

Comment by jdemeyer created at 2018-03-19 19:22:28

> The obvious guess for what is happening is that each of these processes is trying to use the same lazy import cache, and only a few win the race to delete it.

That is not what is happening. This code is specifically meant to deal with such race conditions. But somehow it is still breaking anyway. Which filesystem are you using?


---

Comment by @wbl created at 2018-03-19 19:26:45

NFS. Would it work better on Lustre?


---

Comment by jdemeyer created at 2018-03-19 19:35:06

It is well known that NFS tends to break things which work perfectly for local filesystems. I have no idea what "Lustre" is.

Still, it would be interesting to know _why_ it fails on NFS. Can you check with the following diff:

```diff
diff --git a/src/sage/misc/temporary_file.py b/src/sage/misc/temporary_file.py
index da8e199..299555b 100644
--- a/src/sage/misc/temporary_file.py
+++ b/src/sage/misc/temporary_file.py
@@ -477,7 +477,8 @@ class atomic_write(object):
             # Success: move temporary file to target file
             try:
                 os.rename(self.tempname, self.target)
-            except OSError:
+            except OSError as E:
+                print("rename failed: {0}".format(E))
                 os.unlink(self.target)
                 os.rename(self.tempname, self.target)
         else:
```



---

Comment by jdemeyer created at 2018-04-06 08:08:48

Resolution: wontfix
