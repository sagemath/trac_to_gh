# Issue 32650: update sagetex to version 3.6

Issue created by migration from https://trac.sagemath.org/ticket/32887

Original creator: dimpase

Original creation time: 2021-11-16 19:23:55

CC:  kcrisman mkoeppe mjo slelievre jhpalmieri charpent

the previous update was on #30342 - over a year ago.


---

Comment by dimpase created at 2021-11-16 19:27:31

New commits:


---

Comment by dimpase created at 2021-11-16 19:27:31

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-16 23:31:59

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-16 23:31:59

`sagetex` has a new dependency, `pyparsing`, that also needs to be added as dependency of the SPKG. - https://github.com/sagemath/sagetex/blob/master/setup.py#L16

And the 3.6 release is defective - it still identifies itself as 3.5 - https://github.com/sagemath/sagetex/blob/master/setup.py#L7


---

Comment by mkoeppe created at 2021-11-16 23:38:15

Or, rather, what is on https://github.com/sagemath/sagetex/ does not match what is packaged up in the release tarball


---

Comment by git created at 2021-11-17 09:42:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-17 09:45:28

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-11-17 09:45:28

should all be fixed now, sorry. To much different metadata to tie up manually here...


---

Comment by dimpase created at 2021-11-17 11:57:46

I think I'll eventually add a small configure script to set up all the versions right.
If only there was a way to put tarballs up on [GitHub](GitHub) and creating [GitHub](GitHub) releases from
the command line.


---

Comment by mkoeppe created at 2021-11-17 18:17:00

What is the tarball doing on [GitHub](GitHub)? 
Is it not supposed to be on CTAN (https://ctan.org/pkg/sagetex?lang=en) or on PyPI?


---

Comment by dimpase created at 2021-11-17 19:43:03

Replying to [comment:7 mkoeppe]:
> What is the tarball doing on [GitHub](GitHub)? 
> Is it not supposed to be on CTAN (https://ctan.org/pkg/sagetex?lang=en) or on PyPI?

there is something called sagetex.zip on CTAN - but the process of publishing there is manual, and I have not put this there yet.

And I don't know anything about PyPI publishing.


---

Comment by kcrisman created at 2021-11-17 20:04:53

> > Is it not supposed to be on CTAN (https://ctan.org/pkg/sagetex?lang=en) or on PyPI?

Unless something has changed, we do not want it on CTAN, because that will not match versions with Sage.  Dan always made sure that the versions matched (indeed, I think this is in the release instructions for SageTeX?) and so one has to manually move the .sty file, or did have to do.


---

Comment by dimpase created at 2021-11-17 20:19:15

Hmm, what do you mean by "we don't want it on CTAN"? Have you forgotten how we started putting in on CTAN few years ago? (And I did it for versions 3.4 and 3.5, and will do for 3.6)


---

Comment by saraedum created at 2021-11-17 21:54:00

Replying to [comment:6 dimpase]:
> I think I'll eventually add a small configure script to set up all the versions right.
> If only there was a way to put tarballs up on [GitHub](GitHub) and creating [GitHub](GitHub) releases from
> the command line.

Have you looked into rever? I use it to create tarballs for autoconfiscated packages, release them on [GitHub](GitHub) and on PyPI. See, e.g., https://github.com/flatsurf/flatsurf/blob/master/rever.xsh.


---

Comment by kcrisman created at 2021-11-18 02:24:38

> Unless something has changed,

Apparently it has.

> Hmm, what do you mean by "we don't want it on CTAN"? Have you forgotten how we started putting in on CTAN few years ago? (And I did it for versions 3.4 and 3.5, and will do for 3.6)

That is good news, and I hope it will keep track with the Sage versions well.


---

Comment by dimpase created at 2021-11-18 10:40:00

Replying to [comment:12 kcrisman]:
> > Unless something has changed,
> 
> Apparently it has.
> 
> > Hmm, what do you mean by "we don't want it on CTAN"? Have you forgotten how we started putting in on CTAN few years ago? (And I did it for versions 3.4 and 3.5, and will do for 3.6)
> 
> That is good news, and I hope it will keep track with the Sage versions well.

Karl, it's almost 2 years old news:

```
Date: Thu, 24 Jan 2019 18:50:56 +0000
References: <CAKqbAeFMwHMHYbOfA7SOXOJuuv6aBU=89R0Cz8iddJxkmg+64g@mail.gmail.com>
In-Reply-To: <CAKqbAeFMwHMHYbOfA7SOXOJuuv6aBU=89R0Cz8iddJxkmg+64g@mail.gmail.com>
Message-ID: <CAAWYfq211+bChdmArcJAPwK62opKnSxEfERmtS_xBbcV3kEH_A@mail.gmail.com>
Subject: Re: are you guys the CTAN maintainers for SageTeX now?
From: Dima Pasechnik <...>
To: Dan Drake <...>
Cc: Karl-Dieter Crisman <...>
Content-Type: text/plain; charset="UTF-8"

Hi Dan,
the update is in! cf https://ctan.org/pkg/sagetex?lang=en
Cheers,
Dima

On Wed, Jan 23, 2019 at 1:45 AM Dan Drake <> wrote:
>
> Hi Karl-Dieter, Dima,
>
> Following up -- I see the reply from the CTAN guy. Are you guys now considered the CTAN maintainers for SageTeX? Can you update or remove it?
>
> --
> Ceci n'est pas une .signature.
```



---

Comment by kcrisman created at 2021-11-18 12:09:15

> Karl, it's almost 2 years old news:

I give up.  I clearly can no longer keep 'Trac'.


---

Comment by dimpase created at 2021-12-03 11:36:48

Replying to [comment:8 dimpase]:
> Replying to [comment:7 mkoeppe]:
> > What is the tarball doing on [GitHub](GitHub)? 
> > Is it not supposed to be on CTAN (https://ctan.org/pkg/sagetex?lang=en) or on PyPI?
> 
> there is something called sagetex.zip on CTAN - but the process of publishing there is manual, and I have not put this there yet.
> 
> And I don't know anything about PyPI publishing.

The package's Python code (apart from setup.py) is generated by TeX from a .dtx file.
Anyhow, I tried  uploading its Makefile-created tarball (one used by Sage) anf got

```
$ twine upload  dist/*
Uploading distributions to https://upload.pypi.org/legacy/
Uploading sagetex-3.6.tar.gz
100%|████████████████████████| 71.0k/71.0k [00:00<00:00, 73.0kB/s]
Error during upload. Retry with the --verbose option for more details.
HTTPError: 400 Bad Request from https://upload.pypi.org/legacy/
The name 'sagetex' isn't allowed. See https://pypi.org/help/#project-name for more information.
```


Perhaps some metadata is missing, I don't know. There is no sagetex project on PyPI as far as I can tell.

Let's get this in as is, and deal with a better distribution mechanism later.


---

Comment by mjo created at 2021-12-05 21:21:45

Is sagetex actually used by sage? TBH I've managed to avoid it until now.


---

Comment by dimpase created at 2021-12-05 22:09:55

No, sagetex is a !Sage/Latex package.
It's hard to spin it off, cause as a Python package, almost all of it is generated by running TeX on a .dtx file.


---

Comment by mjo created at 2021-12-05 23:38:06

Ok, I see what's happening. Sage needs the python bits installed before the user can use the latex package. Earlier I was wondering why we install this into sage at all, as opposed to just installing it as a latex package. Still, I think it should be optional.

I'll test it out when I get a chance.


---

Comment by mkoeppe created at 2021-12-06 18:50:03

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-12-06 18:50:03

This version is still not on CTAN.


---

Comment by dimpase created at 2021-12-06 19:56:54

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-12-06 19:56:54

We do it in lockstep. I don't want to put anything on CTAN ahead of the update here.

(CTAN updates are pretty quick)


---

Comment by mkoeppe created at 2021-12-06 20:16:18

Does sagetex do anything that depends on the version of Sage?

As far as I can see, it imports nothing from the Sage library and only runs whatever `sage` can be found on PATH (or what is provided using the ``--sage`` option).


---

Comment by dimpase created at 2021-12-06 20:42:15

Itself it does not, but examples and docs do import stuff from Sage. Also, there is a version check: see #8035 (Sage "knows" the version of sagetex it should be using). Maybe it's obsolete.


---

Comment by kcrisman created at 2021-12-06 21:14:09

> Itself it does not, but examples and docs do import stuff from Sage. Also, there is a version check: see #8035 (Sage "knows" the version of sagetex it should be using). 
That was what I referred to above.
> Maybe it's obsolete.
That is possible; no one has checked that out recently.  It would definitely be worth knowing if we could get rid of that requirement (see point 2 in [HACKING.md](https://github.com/sagemath/sagetex/blob/master/HACKING.md)).

The idea (Dan called it "one of the biggest problems with SageTeX") was that if you have the wrong style file, bad things might happen.  Presumably some of those bad things would be different behavior of certain (ST) commands, or some not working at all?  Cc:ing John, who originally suggested this [comment:21:ticket:7617 here] a dozen years ago; I never had that experience personally, but I don't use all the advanced capabilities of ST either.


---

Comment by jhpalmieri created at 2021-12-06 21:54:56

By the way, the information in https://doc.sagemath.org/html/en/tutorial/sagetex.html about the location of `sagetex` is out of date: it should say `SAGEROOT/venv/share/texmf/tex/latex/sagetex/`, and this occurs in several places.


---

Comment by jhpalmieri created at 2021-12-06 23:18:16

I don't have time to think about any of this deeply, but here are changes to the location of the `sagetex` installation in the Sage tree. `git grep "local/share.*sagetex" .` found no more hits.
----
New commits:


---

Comment by jhpalmieri created at 2021-12-06 23:38:40

With both the old and the new versions of `sagetex`, `./sage -f -c sagetex` fails the testsuite. Log uploaded.


---

Attachment


---

Comment by dimpase created at 2021-12-07 00:21:25

Replying to [comment:28 jhpalmieri]:
> With both the old and the new versions of `sagetex`, `./sage -f -c sagetex` fails the testsuite. Log uploaded.

You are running a development version of TeX:

```
pdfTeX 3.141592653-2.6-1.40.23 (TeX Live 2022/dev)
...
LaTeX2e <2021-11-15>
L3 programming layer <2021-11-12>
(/usr/local/texlive/2021/texmf-dist/tex/latex/base/article.cls
...
```


I can't reproduce your error (which is probably about broken/improved(?) TeXLive `xcolor` package):

```
[11] (/usr/local/texlive/2021/texmf-dist/tex/latex/listings/lstlang1.sty)
(./sagetex.sagetex.scmd
consecutive:

! Package xcolor Error: Undefined color `dbluecolor'.

See the xcolor package documentation for explanation.
Type  H <return>  for immediate help.
 ...                                              
```


I'm running a 2020/21 stable version, and where you got your error I see warnings like

```
Package xcolor Warning: Incompatible color definition on input line 3.
...
```


These color definitions there are very old, from 2010 or so.

Perhaps something has changed in xcolor. I'll get back to this tomorrow...


---

Comment by dimpase created at 2021-12-07 00:22:45

Replying to [comment:27 jhpalmieri]:
> I don't have time to think about any of this deeply, but here are changes to the location of the `sagetex` installation in the Sage tree. `git grep "local/share.*sagetex" .` found no more hits.
> ----
> New commits:
> ||[48f33a2](https://git.sagemath.org/sage.git/commit?id=48f33a281998753d3a369a2823fd6a620b8a64d2)||`trac 32887: change location of sagetex to venv/share/texmf/...`||

Oh, OK, there is at least one such place in the package itself, should be fixed too.


---

Comment by dimpase created at 2021-12-07 00:22:45

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2021-12-07 00:54:27

Instead of linking to a private path that will change every once in a while, maybe we should just link to the CTAN for the PDF docs?

If we're uploading to CTAN again, is the advice at the end of the tutorial (avoiding the texlive copy of sagetex) obsolete now? The suggested method of making sagetex visible to latex also gives remarkably bad advice, but I suppose we don't have to fix all of this stuff before doing the upgrade.


---

Comment by mkoeppe created at 2021-12-07 01:45:33

For reference, https://tug.org/texlive/pkgcontrib.html#exec gives guidance how to prepare a TeX package with executable scripts.


---

Comment by jhpalmieri created at 2021-12-07 04:02:09

Replying to [comment:29 dimpase]:
> Replying to [comment:28 jhpalmieri]:
> > With both the old and the new versions of `sagetex`, `./sage -f -c sagetex` fails the testsuite. Log uploaded.
> 
> You are running a development version of TeX:

Strange, I wonder why. On another machine, tests pass.


---

Comment by dimpase created at 2021-12-07 13:42:14

the color warning vs error in comment:29 comes from `xcolor` (the warning, for sure). `xcolor` manual says:

```
Note that whenever a color is used that has been defined via color’s \definecolor
command rather than xcolor’s new \definecolor and friends, a warning message
‘Incompatible color definition’ will be issued.
```

As `tikz` loads `xcolor` anyway, perhaps we should just use it.


---

Comment by dimpase created at 2021-12-07 14:46:17

The following patch to sagetex removes the warning for me (checked with the current xcolor version 2021/10/31, as well as the previous one, from 2016).

John, does it fix the error on your development TeXLive machine?

```diff
--- a/py-and-sty.dtx
+++ b/py-and-sty.dtx
@@ -29,7 +29,7 @@
 % and |listings| for the |sagecommandline| environment.
 %    \begin{macrocode}
 \RequirePackage{listings}
-\RequirePackage{color}
+\RequirePackage{xcolor}
 \lstdefinelanguage{Sage}[]{Python}
   {morekeywords={False,sage,True},sensitive=true}
 \lstdefinelanguage{SageOutput}[]{}
@@ -68,9 +68,9 @@
 \lstdefinestyle{SageOutput}{
   style=DefaultSageOutput,
 }
-\definecolor{dbluecolor}{rgb}{0.01,0.02,0.7}
-\definecolor{dgreencolor}{rgb}{0.2,0.4,0.0}
-\definecolor{dgraycolor}{rgb}{0.30,0.3,0.30}
+\providecolor{dbluecolor}{rgb}{0.01,0.02,0.7}
+\providecolor{dgreencolor}{rgb}{0.2,0.4,0.0}
+\providecolor{dgraycolor}{rgb}{0.30,0.3,0.30}
 %    \end{macrocode}
 % Unsurprisingly, the |\sageplot| command works poorly without graphics
 % support.
```



---

Comment by dimpase created at 2021-12-07 17:31:30

this is the fixed v3.6.

One still has to deal with comment:31
----
New commits:


---

Comment by git created at 2021-12-07 17:32:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-12-07 17:33:01

rebased over latest beta


---

Comment by mkoeppe created at 2021-12-07 18:12:35

That `build/pkgs/sagetex/install-requires.txt` exists (which triggers installation in `SAGE_VENV` instead of `SAGE_LOCAL`) is a mistake introduced in #30719. `sagetex` does not exist on PyPI, so the contents of `install-requires.txt` are wrong.

Overall, I'm skeptical about treating sagetex as a Python package.
As the instructions in https://doc.sagemath.org/html/en/tutorial/sagetex.html#using-sagetex show, after installing it with pip (or Sage package), still manual installation work is needed for the TeX style files. So I would suggest to refocus sagetex as a TeX package and consider CTAN and texlive as the main distribution strategy. Python is merely used as a scripting language.

The section https://doc.sagemath.org/html/en/tutorial/sagetex.html#using-sagetex should just be moved to the sagetex README.

I would think that `sagetex` works with any version of Sage released in the past 5 years at least. This compatibility should probably be documented in sagetex.


(Disclaimer: I have never used sagetex and don't plan to use it.)


---

Comment by jhpalmieri created at 2021-12-07 19:05:23

If it gets installed in SAGE_LOCAL, then my changes to the documentation need to be reverted.


---

Comment by jhpalmieri created at 2021-12-07 19:20:09

The new version doesn't build for me:

```
[sagetex-3.6]   error: can't copy 'sagetex.pdf': doesn't exist or not a regular file
```

and indeed that file is missing from the tarball.


---

Comment by jhpalmieri created at 2021-12-07 19:31:18

If I add the missing pdf files and rebuild the tarball, then the test suite passes with this dev version of TeX.


---

Comment by dimpase created at 2021-12-07 21:01:55

Replying to [comment:39 mkoeppe]:
> That `build/pkgs/sagetex/install-requires.txt` exists (which triggers installation in `SAGE_VENV` instead of `SAGE_LOCAL`) is a mistake introduced in #30719. `sagetex` does not exist on PyPI, so the contents of `install-requires.txt` are wrong.

do you understand the error I get while trying to upload sagetex on PyPI?

```
$ twine upload dist/* --verbose
Using configuration from /home/dima/.pypirc
Uploading distributions to https://upload.pypi.org/legacy/
  dist/sagetex-3.6-py3-none-any.whl (834.0 KB)
  dist/sagetex-3.6.tar.gz (816.7 KB)
username set from config file
password set from config file
username: __token__
password: <hidden>
Uploading sagetex-3.6-py3-none-any.whl
100%|██████████████████████████████████████████████████████████████████████████████████████████████| 837k/837k [00:01<00:00, 644kB/s]
Content received from server:
<html>
 <head>
  <title>400 The name 'sagetex' isn't allowed. See https://pypi.org/help/#project-name for more information.</title>
 </head>
 <body>
  <h1>400 The name 'sagetex' isn't allowed. See https://pypi.org/help/#project-name for more information.</h1>
  The server could not comply with the request since it is either malformed or otherwise incorrect.<br/><br/>
The name &#x27;sagetex&#x27; isn&#x27;t allowed. See https://pypi.org/help/#project-name for more information.


 </body>
</html>
HTTPError: 400 Bad Request from https://upload.pypi.org/legacy/
The name 'sagetex' isn't allowed. See https://pypi.org/help/#project-name for more information.
```

Is it a metadata error, or indeed somehow the name is "reserved"?
> 
> Overall, I'm skeptical about treating sagetex as a Python package.
> As the instructions in https://doc.sagemath.org/html/en/tutorial/sagetex.html#using-sagetex show, after installing it with pip (or Sage package), still manual installation work is needed for the TeX style files. 

If SageTeX (ctan package) is installed and has right version (assuming we drop the version check)
then no manual action is needed.

Else, one needs to `export TEXINPUTS="SAGE_ROOT/venv/share/texmf//:$TEXINPUTS"`
which is obviously scriptable.


---

Comment by mjo created at 2021-12-07 23:36:44

Replying to [comment:39 mkoeppe]:
> 
> Overall, I'm skeptical about treating sagetex as a Python package.
> As the instructions in https://doc.sagemath.org/html/en/tutorial/sagetex.html#using-sagetex show, after installing it with pip (or Sage package), still manual installation work is needed for the TeX style files. So I would suggest to refocus sagetex as a TeX package and consider CTAN and texlive as the main distribution strategy. Python is merely used as a scripting language.
> 

Alas. When you run pdflatex on your latex document, no computation is done. Instead it outputs a `.sage` file, and you have to stop what you're doing, run the `.sage` file (with sage), and then go back and re-run pdflatex some more.

The first few lines of that `.sage` file are...



```python
## -*- encoding: utf-8 -*-
## This file (my.sagetex.sage) was *autogenerated* from my.tex with sagetex.sty version 2020/08/12 v3.5.
import sagetex
```


So, the "latex package" actually requires some special python bits to be installed and visible to sage. That's why it's probably better to have this be a python package that installs some latex bits rather than a latex package that installs some python bits.


---

Comment by mkoeppe created at 2021-12-08 00:02:07

I see, thanks for the explanation, I missed this when I looked at the package.


---

Comment by dimpase created at 2021-12-08 00:04:40

I opened https://github.com/pypa/pypi-support/issues/1516
to possibly release `sagetex` for our use.


---

Comment by dimpase created at 2021-12-08 23:58:05

I am able to put sagetex to testpypi: https://test.pypi.org/project/sagetex/3.6

Can Sage use more than one PyPI repository?


---

Comment by dimpase created at 2021-12-10 22:03:12

Changing status from needs_work to needs_info.


---

Comment by dimpase created at 2021-12-10 22:03:12

OK, I have a working prototype, which invokes either `ninja` or `make` from within `setup.py`.

1) If we use `make`, which is OK for building from source, but not so for modularisation, then there is no pressing need to work on #32992 

2) if we use `ninja`, then it's more work, but we get a more modular setup, as `ninja` is a Python package, and can be listed as a dependency in a Pythonic way - then we need #32992 (which would make `ninja` a proper Python package, and promote it to `standard`).

Please tell me whether should we do 1) or 2) here.


---

Comment by mkoeppe created at 2021-12-10 22:05:21

What do you use these build systems for? There is nothing to be built


---

Comment by dimpase created at 2021-12-10 22:12:05

Well, we build Python modules and scripts from TeX .dtx files. And then we build documentation of `sagetex` using `sagetex`.


---

Comment by mjo created at 2021-12-10 22:14:25

Replying to [comment:48 dimpase]:
> 
> 2) if we use `ninja`, then it's more work, but we get a more modular setup, as `ninja` is a Python package, and can be listed as a dependency in a Pythonic way - then we need #32992 (which would make `ninja` a proper Python package, and promote it to `standard`).

It's not really a python package, someone just uploaded a bunch of exe files to PyPI.


---

Comment by dimpase created at 2021-12-10 22:18:56

Replying to [comment:51 mjo]:
> Replying to [comment:48 dimpase]:
> > 
> > 2) if we use `ninja`, then it's more work, but we get a more modular setup, as `ninja` is a Python package, and can be listed as a dependency in a Pythonic way - then we need #32992 (which would make `ninja` a proper Python package, and promote it to `standard`).
> 
> It's not really a python package, someone just uploaded a bunch of exe files to PyPI.

No. It is a Python package all right nowadays. In my updated `setup.py` I do

```
...
import ninja

class pre_develop(develop):
    """Pre-installation for development mode."""
    def run(self):
        ninja.subprocess.run(['ninja'],check=True)
        develop.run(self)
...
```

and I have `pyproject.toml` that says

```
[build-system]
requires = ["setuptools", "wheel", "ninja"]
build-backend = "setuptools.build_meta"
```



---

Comment by dimpase created at 2021-12-10 22:56:06

What I noticed here is a zombie `maxima` process left running after `sagetex 3.6` is installed (on Debian 10).

With `sagetex 3.5`, I only get a zombie process from `SAGE_CHECK=yes make sagetex`, but not from `make sagetex` without `SAGE_CHECK=yes`, so this is a regression, but the problem is apparently already there in 3.5. (Invoking `sage` from a script, I guess?)


---

Comment by kcrisman created at 2021-12-11 02:18:59

> What I noticed here is a zombie `maxima` process left running after `sagetex 3.6` is installed (on Debian 10).
Maybe from [here](https://github.com/sagemath/sagetex/blob/master/example.tex#L123)?  Because `test.sh` has `checkdotsage example`.


---

Comment by mjo created at 2021-12-12 02:18:50

Replying to [comment:52 dimpase]:
> > 
> > It's not really a python package, someone just uploaded a bunch of exe files to PyPI.
> 
> No. It is a Python package all right nowadays. In my updated `setup.py` I do
> {{{
> ...
> import ninja
> 
>...
>         ninja.subprocess.run(['ninja'],check=True)
>}}}

The pre-built "ninja" executable is zipped into the whl as `data/bin/ninja`. That python module is a small wrapper to make that executable runnable without knowing where it was installed to.

Since sagetex can't be used without sage, and since sage and POSIX both require Make, I think Make is the better option.  Neither Make nor ninja can truly be installed with pip, and Make should already be there.


---

Comment by dimpase created at 2021-12-12 09:46:18

Replying to [comment:55 mjo]:
> Replying to [comment:52 dimpase]:
> > > 
> > > It's not really a python package, someone just uploaded a bunch of exe files to PyPI.
> > 
> > No. It is a Python package all right nowadays. In my updated `setup.py` I do
> > {{{
> > ...
> > import ninja
> > 
> >...
> >         ninja.subprocess.run(['ninja'],check=True)
> >}}}
> 
> The pre-built "ninja" executable is zipped into the whl as `data/bin/ninja`. That python module is a small wrapper to make that executable runnable without knowing where it was installed to.

So what, are you surprised? It's most probably exactly how is should be down in that gehakte tsores (aka Python wheels) format.

It might be instructive to look at ninja package source. It has a cmake file, used by
a Python package `scikit-build`: https://scikit-build.readthedocs.io/en/latest/index.html, which lets you in run `cmake` from `setup.py`.
As you can see in `pyproject.toml`    

```
[build-system]
requires = [
    "setuptools>=42",
    "wheel",
    "scikit-build>=0.12",
]...
```

> 
> Since sagetex can't be used without sage, and since sage and POSIX both require Make, I think Make is the better option.  Neither Make nor ninja can truly be installed with pip, and Make should already be there.

`Make`, I don't know. But `ninja` - yes, it can. Even on, yes, Windows :-)

In a modular world, with Sage installed from wheels, it's not inconsievable to have no Make around. But yes, ninja is there. 

Anyhow, updating our ninja to be able to do this will need `scikit-build` as a dependency, and to speed up this ticket let's stick to `make` for the time being.


---

Comment by mkoeppe created at 2021-12-12 17:36:43

Dima, it's not quite clear to me what problem you are trying to solve with all this complexity. Why can the sdist not just contain the .py files?


---

Comment by dimpase created at 2021-12-12 17:53:39

Most of the sources of the package are in .dtx files. Do we install from source, or not?


---

Comment by dimpase created at 2021-12-12 18:31:04

3.5 and previous releases hackishly contained generated pdf files, which certainly have no place in a proper Python package. 

In 3.6 we strive for purity. :-)


---

Comment by mkoeppe created at 2021-12-12 18:51:21

Replying to [comment:58 dimpase]:
> Most of the sources of the package are in .dtx files. Do we install from source, or not?

I think extracting the .py files should simply be done by developers, perhaps in a "./bootstrap" script before "setup.py sdist" is run.

Regardless of the build system that you use to script it, in the end the `.dtx` is extracted by a run of `latex`. Requiring a user to have an installation of `latex` just to install the `sagetex` python scripts does not seem to be a good idea.


---

Comment by mkoeppe created at 2021-12-12 19:32:18

Perhaps it would be a good idea to generate 2 separate, non-overlapping distributions from the git repository: 

1) The TeX package, which is to be installed on the computer that runs LaTeX. Distributed via CTAN / texlive

2) The Python package, which is to be installed on the computer that runs Sage, in the virtual environment where Sage is installed. Distributed via pip.


---

Comment by dimpase created at 2021-12-12 19:46:57

There in no point in installing sagetex if there is no LaTeX available.


---

Comment by dimpase created at 2021-12-12 19:48:34

Perhaps make installation of sagetex conditional on availability of LaTeX.


---

Comment by mkoeppe created at 2021-12-12 20:09:08

The Python part does not need latex.

Use case: Sage runs on a server. LaTeX runs on overleaf.


---

Comment by dimpase created at 2021-12-12 20:29:49

Replying to [comment:64 mkoeppe]:
> The Python part does not need latex.
> 
> Use case: Sage runs on a server. LaTeX runs on overleaf.

Does this work? I guess not. Anyhow, installing LaTeX on a server is trivial.

Anyway, the work is done already, was just asking in what way I should change 2 or 3  lines, to use either `make`, or `ninja`.
I don't want to throw all this away and do a refactoring because you find the prsent design "complex". It is not complex in a true sense of this word.

It was complex for me because I didn't know how these things work. Now I know, and it's not complex, in fact. All the complexity there is due to idiotic `setuptools`refusal of having built-in pre-install hooks.


---

Comment by mkoeppe created at 2021-12-12 20:44:06

-1, it does not solve any problem.

This change makes the package less pip-installable because now latex is required.


---

Comment by dimpase created at 2021-12-12 20:59:25

Whatever. Feel free to take over.


---

Comment by dimpase created at 2021-12-12 21:13:04

The problems it does solve are

1) the problem of single source --- don't want unconnected versions of TeX files and Python files floating around causing trouble.

2) and non-distribution of generated PDF files. Hello, distibuting PDF files? Really?


---

Comment by mkoeppe created at 2021-12-12 21:23:20

Replying to [comment:65 dimpase]:
> `setuptools` refusal of having built-in pre-install hooks.

You only needed custom `install` and `develop` commands because you forgot to change the list of data files in the "distribution" in the `build` command. Take a look at the setup.py added in #29039.


---

Comment by kcrisman created at 2021-12-13 13:48:38

> The Python part does not need latex.
> 
> Use case: Sage runs on a server. LaTeX runs on overleaf.

At least ideally, one can do the LaTeX on a separate machine from the Sage commands.  That is definitely within Dan's intended vision for SageTeX.  In practice, I think most people who have used SageTeX have ended up just installing whichever one they didn't have (which varied) on their local computer, but we have occasionally had requests for software-as-service for something along these lines, and being able to run Sage on the LaTeX-generated files on a server elsewhere from one's local computer (esp. if someone had trouble installing Sage, which has been known to happen ...) would be useful.  Having Overleaf able to call a Sage server sound cool, though i don't know if they (the OL people) would see that as a high priority ;-)

For what it's worth, similar packages in R are R packages, not TeX packages, I believe.  However, this debate has some other technical details that might override that utility in practice (e.g. `make` versus `ninja` or Python package versus TeX package).

I do think that it is key for SageTeX to be "easily accessible" to anyone using Sage, and so I would disagree with this:

> The section ​https://doc.sagemath.org/html/en/tutorial/sagetex.html#using-sagetex should just be moved to the sagetex README.

Those instructions are easily web-discoverable, and we've certainly had plenty of questions over time asking about that process (and persevering through several false starts).  Most Sage users, especially those using it as a service in some other environment, are just downloading/using a binary and will not necessarily even know about README files; moving the style files might be the only interaction they have with the Sage file tree.


---

Comment by dimpase created at 2021-12-13 19:35:59

Replying to [comment:69 mkoeppe]:
> Replying to [comment:65 dimpase]:
> > `setuptools` refusal of having built-in pre-install hooks.
> 
> You only needed custom `install` and `develop` commands because you forgot to change the list of data files in the "distribution" in the `build` command. Take a look at the setup.py added in #29039.

Replying to [comment:69 mkoeppe]:
> Replying to [comment:65 dimpase]:
> > `setuptools` refusal of having built-in pre-install hooks.
> 
> You only needed custom `install` and `develop` commands because you forgot to change the list of data files in the "distribution" in the `build` command. Take a look at the setup.py added in #29039.

I am not sure I understand this comment. Doing

```diff
--- a/setup.py
+++ b/setup.py
@@ -64,7 +64,4 @@ setup(
          'sagetex.ins',
          'sagetex.sty']),
       ('', ['build.ninja']),  
-      ('share/doc/sagetex', [
-         'example.tex',
-         'sagetex.pdf',
-         'example.pdf'])])
+      ])
```

has no effect (and I'm applying this).
Regarding `install` and `develop`, removing them results in some scripts
no being built, for some reason (maybe due to them not being treated in pythonic way, but just via makefile rules).

I tried few things, to no avail.
Please do a PR against https://github.com/sagemath/sagetex/tree/ninja-dev
if you have a clear picture of how to fix this.


---

Comment by jhpalmieri created at 2021-12-13 20:03:37

Replying to [comment:68 dimpase]:
> 2) and non-distribution of generated PDF files. Hello, distibuting PDF files? Really?

For what it's worth, a number of Sage packages seem to include PDF files in their tarballs:

```
Babel-2.9.1.tar.gz
R-3.6.3.tar.gz
Sphinx-4.2.0.tar.gz
SuiteSparse-5.10.1.tar.gz
arb-2.19.0.tar.gz
argon2-cffi-20.1.0.tar.gz
bzip2-1.0.6-20150304.tar.gz
cddlib-0.94m.tar.gz
cmake-3.21.0.tar.gz
gap-4.11.1.tar.gz
gfan0.6.2.tar.gz
matplotlib-3.3.4.tar.gz
maxima-5.45.0.tar.gz
nauty27r1.tar.gz
nbconvert-6.1.0.tar.gz
openblas-0.3.18.tar.gz
primecount-7.1.tar.gz
readline-8.0.tar.gz
sagetex-3.5.tar.gz
sphinxcontrib-websupport-1.2.1.tar.gz
xz-5.2.5.tar.gz
zlib-1.2.11.tar.gz
giac-1.6.0.47p3.tar.bz2
glpk-5.0.tar.bz2
ppl-1.2.tar.bz2
ratpoints-2.1.3.tar.bz2
tachyon-0.98.9.tar.bz2
numpy-1.21.4.zip
```

So while it's not a bad idea to remove PDF files from the sagetex distribution, it doesn't look (at least to me) like something that should be high priority.


---

Comment by mkoeppe created at 2021-12-13 20:17:56

Replying to [comment:71 dimpase]:
> Please do a PR against https://github.com/sagemath/sagetex/tree/ninja-dev
> if you have a clear picture of how to fix this.

Sorry, I won't work on this - the approach of requiring tooling such as `latex` (plus some build system) to be present in order to install a Python package is a dead end.


---

Comment by dimpase created at 2021-12-13 22:25:48

saying that using, essentially, a part of scikit-build as a building tool is "dead end" is, hmm, funny. 

scikit-build is replacing setuptools+distutils, in particular for building Python extensions, more and more.
https://scikit-build.readthedocs.io/en/latest/


---

Comment by mkoeppe created at 2021-12-13 22:31:57

They are not using latex to extract files.


---

Comment by dimpase created at 2021-12-13 22:48:18

They are using, you know, C compilers, cause some part of a package is written in C. Why the hell we cannot use LaTeX compilers?


---

Comment by dimpase created at 2021-12-13 23:48:44

Replying to [comment:54 kcrisman]:
> > What I noticed here is a zombie `maxima` process left running after `sagetex 3.6` is installed (on Debian 10).
> Maybe from [here](https://github.com/sagemath/sagetex/blob/master/example.tex#L123)?  Because `test.sh` has `checkdotsage example`.

indeed, if I get rid of that `maxima()` call in `example.tex` there are no more zombie `maxima`'s left.
Why is `sage-cleaner` failing to kill them?


---

Comment by jhpalmieri created at 2021-12-14 00:03:43

Replying to [comment:76 dimpase]:
> They are using, you know, C compilers, cause some part of a package is written in C. Why the hell we cannot use LaTeX compilers?

It sounds like you're making an argument that sagetex should become an optional package, because it is insane to add LaTeX as a requirement to build Sage just because of this one package. (MacTeX is a 4.4GB download, for example.)

Can we use something like Overleaf to build the PDF files? Then systems without LaTeX could get by with internet access to build sagetex. I'm actually not sure why it's better to rebuild the PDF files on every machine rather than just building once and downloading them, though. Is it better to save a little storage and burn extra CPU cycles, or save the CPU and ship some extra files?


---

Comment by dimpase created at 2021-12-14 09:45:43

I'm going to add an `spkg-config.m4` which would stop sagetex from installing if no LaTeX can be found, how about this?
This might mean that it will become optional. Not sure at the moment how it will play with out `texlive` spkg - but see #31529.


---

Comment by kcrisman created at 2021-12-14 13:00:30

> > > What I noticed here is a zombie `maxima` process left running after `sagetex 3.6` is installed (on Debian 10).
> > Maybe from [here](https://github.com/sagemath/sagetex/blob/master/example.tex#L123)?  Because `test.sh` has `checkdotsage example`.
> 
> indeed, if I get rid of that `maxima()` call in `example.tex` there are no more zombie `maxima`'s left.
> Why is `sage-cleaner` failing to kill them? 
Possibly related: https://groups.google.com/g/sage-devel/c/epajAbPvg6s


---

Comment by mkoeppe created at 2021-12-14 16:52:22

Replying to [comment:65 dimpase]:
> Replying to [comment:64 mkoeppe]:
> > The Python part does not need latex.
> > 
> > Use case: Sage runs on a server. LaTeX runs on overleaf.
> 
> Does this work? I guess not. 

It does because the Python part does not use latex. The Python code only uses imagemagick (https://github.com/sagemath/sagetex/blob/master/py-and-sty.dtx#L1459) and epstopdf (https://github.com/sagemath/sagetex/blob/master/py-and-sty.dtx#L1421).


---

Comment by kcrisman created at 2021-12-14 17:00:57

> > Does this work? I guess not. 
> 
> It does because the Python part does not use latex.

Again, the original vision definitely would have included this kind of use case, where one created a whole slew of the python/Sage files, processed them somewhere (batch mode?) and then used those included files.  It's not how people typically do use it, since it implies some need for efficiency of scale (and on Mac, TeXShop makes it fairly easy to have it all done in one go), but is something that there isn't any reason to remove support for.  Mostly because Sage is harder for some LaTeX users to install, not so much the other way around :)  For instance, I wonder if it would work very easily at all to do the whole thing in one shell on Windows, unless you started using WSL for everything?  Many LaTeX users on that platform only interact with it via GUI, never even realizing the depths of internal machinery involved.


---

Comment by kcrisman created at 2021-12-14 17:02:48

> It does because the Python part does not use latex. The Python code only uses imagemagick (https://github.com/sagemath/sagetex/blob/master/py-and-sty.dtx#L1459) and epstopdf (https://github.com/sagemath/sagetex/blob/master/py-and-sty.dtx#L1421).

And I think those are run-time dependencies on a need-only basis, correct?  Does Windows have epstopdf standard (I presume not, but ...)?


---

Comment by mkoeppe created at 2021-12-14 17:05:29

Replying to [comment:82 kcrisman]:
> I wonder if it would work very easily at all to do the whole thing in one shell on Windows, unless you started using WSL for everything?  

Yes, that's also a relevant use case. Sage running in WSL or Cygwin, and LaTeX done natively in Windows.


---

Comment by dimpase created at 2021-12-14 17:54:01

My build process generates a wheel for the package, which, of course, contains .py files,
and the generated scripts. It can be used for installation,
if there is no LaTeX (or otherwise).

It doesn't contain pdf files, but that's fine IMHO.


---

Comment by dimpase created at 2021-12-14 18:15:29

The only complication is that one needs a replacement of `sdh_pip_install`, which 1st thing builds a wheel, but here this step should be skipped.


---

Comment by mkoeppe created at 2021-12-14 20:22:45

-1. This would make `sagetex` the only Python package in the Sage distribution that cannot be installed from the sdist.


---

Comment by dimpase created at 2021-12-14 20:43:51

The source installation of this package needs LaTeX, sdist or not.
Something **has** to give. Here are the alternatives I see:

1) keep a hacky tarball package with pdfs and all, that cannot be installed from source in a meaningful way, and would never ever make it to PyPI in that form. 

2) do not install it if there is no LaTeX available.

3) install it from wheel.

4) install it from wheel only if there is no LaTeX available.


---

Comment by mkoeppe created at 2021-12-14 20:48:09

Replying to [comment:88 dimpase]:
> The source installation of this package needs LaTeX, sdist or not.
> Something **has** to give.

Yes, namely:
0) the unnecessary idea that the sdist should ship the dtx file instead of its products.


---

Comment by mkoeppe created at 2021-12-14 21:07:23

Note that an `sdist` is not just a snapshot of the repository. It is prepared by the `build_sdist` build-system hook (https://www.python.org/dev/peps/pep-0517/#id10); in the case of `setuptools` this is equivalent to the invocation `setup.py sdist` (`setuptools.command.sdist`).


---

Comment by dimpase created at 2021-12-14 21:47:42

Replying to [comment:87 mkoeppe]:
> -1. This would make `sagetex` the only Python package in the Sage distribution that cannot be installed from the sdist. 

This argument is bogus.

We have no control over the PyPI packages we already use in Sage in this sense - you simply don't know without extra work whether they can be effortlessly installed with sdist, not from a wheel. E.g. they may be using autotools, so on a machine without autotools one won't be able to install them your supposedly canonical way.


---

Comment by jhpalmieri created at 2021-12-14 22:05:00

I'm confused about the proposal now. Dima, are you talking about excluding only the PDF files, or excluding the PDF files, the .sty files, and other components? That is, will it be usable and just missing some documentation with your proposal, or will it only be usable if LaTeX is already installed? (I am imagining a situation in which someone happens to install Sage first and then LaTeX later, for example, or their LaTeX installation is temporarily broken.)


---

Comment by dimpase created at 2021-12-14 22:21:29

There are a number of proposals. 

One is to require LaTeX for installing sagetex (the counter-argument for this is that one may want to run Sage remotely, and then on the remote one does not need/have LaTeX. Sounds far-fetched to me...). Here,
if sagetex does not get installed due to absense of LaTeX then certainly one can install LaTeX and run `make sagetex` to install it.

Another is to install it from a wheel. (the counter argument, comment:87, is bogus IMHO).
- there is an added complexity here that somehow the name `sagetex` is not liked by PyPI, but this should not be relevant.


---

Comment by jhpalmieri created at 2021-12-14 22:35:33

You could also want to run Sage locally and LaTeX remotely; kcrisman was outlining that option.


---

Comment by dimpase created at 2021-12-14 22:54:55

I figured out why we cannot use sagetex on PyPI - as Fedora blocked it for itself, in its infinite wisdom: 
see https://github.com/pypa/pypi-support/issues/355 and
https://github.com/pypa/pypi-support/issues/355#issuecomment-994116468

I hope they will unblock it soon now.


---

Comment by dimpase created at 2021-12-14 23:03:56

Replying to [comment:94 jhpalmieri]:
> You could also want to run Sage locally and LaTeX remotely; kcrisman was outlining that option.

The wheel installation proposal would work just fine for these remote cases.


---

Comment by mkoeppe created at 2021-12-14 23:16:53

Replying to [comment:91 dimpase]:
> Replying to [comment:87 mkoeppe]:
> > -1. This would make `sagetex` the only Python package in the Sage distribution that cannot be installed from the sdist. 
> 
> We have no control over the PyPI packages we already use in Sage in this sense

We are installing all Python packages from the sdist. That's what sdists are for.

> E.g. they may be using autotools, so on a machine without autotools one won't be able to install them your supposedly canonical way.

Dima, as you know, autotools-based packages do NOT need autotools at the time of installation. Developers need it at the time of preparing a source distribution.


---

Comment by dimpase created at 2021-12-14 23:38:05

Replying to [comment:97 mkoeppe]:
> Replying to [comment:91 dimpase]:
> > Replying to [comment:87 mkoeppe]:
> > > -1. This would make `sagetex` the only Python package in the Sage distribution that cannot be installed from the sdist. 
> > 
> > We have no control over the PyPI packages we already use in Sage in this sense
> 
> We are installing all Python packages from the sdist.

No, not all of them. See e.g. beautifulsoap4:

```
make[1]: Entering directory '/home/dimpase/work/sage/build/make'
make --no-print-directory beautifulsoup4-no-deps
sage-logger -p 'sage --pip install -r "/home/dimpase/work/sage/build/pkgs/beautifulsoup4/requirements.txt"' '/home/dimpase/work/sage/logs/pkgs/beautifulsoup4.log'
[beautifulsoup4] Collecting beautifulsoup4
[beautifulsoup4]   Downloading beautifulsoup4-4.10.0-py3-none-any.whl (97 kB)
[beautifulsoup4] Collecting soupsieve>1.2
[beautifulsoup4]   Downloading soupsieve-2.3.1-py3-none-any.whl (37 kB)
[beautifulsoup4] Installing collected packages: soupsieve, beautifulsoup4
[beautifulsoup4] Successfully installed beautifulsoup4-4.10.0 soupsieve-2.3.1
make[1]: Leaving directory '/home/dimpase/work/sage/build/make'
```


It's not a sdist build, it's a direct installation from wheels, right?


---

Comment by mkoeppe created at 2021-12-15 00:16:42

Yes, we have some optional packages that are directly installed from PyPI using `pip` because we have not bothered to package them as normal packages. `pip` prefers to install wheels when they are available, so this is what's happening.


---

Comment by dimpase created at 2021-12-15 13:31:21

Right, so why not do the same for `sagetex`, if you are squarely against it building with LaTeX? It can become optional, too.


---

Comment by dimpase created at 2021-12-15 13:54:39

Regarding zombie `maxima`, see #33027. The problem is not related to `sagetex`, it's invocation of `maxima()` in any `.sage` script which gives this.


---

Comment by dimpase created at 2021-12-15 14:20:05

We've got `sagetex` back on PyPI, and now have https://pypi.org/project/sagetex/
with sagetex 3.5 uploaded.


---

Comment by kcrisman created at 2021-12-15 17:47:23

> Regarding zombie `maxima`, see #33027. The problem is not related to `sagetex`, it's invocation of `maxima()` in any `.sage` script which gives this.

Good that this was tracked down!  Thanks.


---

Comment by slelievre created at 2022-07-25 09:44:02

Documentation update for new `SAGE_ROOT/venv/share`
location now at #34219.

Can we rebase this ticket on that one, and revive it?


---

Comment by jhpalmieri created at 2022-07-25 17:58:31

As far as the disagreement that has taken up so much of this discussion, maybe we could not distribute the PDF files and instead build them if LaTeX is present on the system. Regardless of whether LaTeX is present, we should distribute the `.sty` files (etc.) so that if someone installs Sage first and LaTeX second, `sagetex` is available to them.


---

Comment by git created at 2022-08-08 21:23:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2022-08-08 21:24:44

now `ninja` is going to be `standard`, we can perhaps make a progress here.


---

Comment by mkoeppe created at 2022-08-08 21:32:17

One needs neither ninja nor cmake here. This is a Python package that installs Python scripts and data files (tex files). Just use setuptools or use something modern like https://github.com/pypa/hatch


---

Comment by slelievre created at 2022-08-09 03:33:53

Note: #34219 (Document that SageTeX is now in SAGE_ROOT/venv/share)
now has positive review.


---

Comment by mkoeppe created at 2022-08-20 16:18:45

Replying to [comment:88 dimpase]:
> The source installation of this package needs LaTeX, sdist or not.
> Something **has** to give. Here are the alternatives I see:
> 
> 1) keep a hacky tarball package with pdfs and all, that cannot be installed from source in a meaningful way, and would never ever make it to PyPI in that form. 
> 
> 2) do not install it if there is no LaTeX available.
> 
> 3) install it from wheel.
> 
> 4) install it from wheel only if there is no LaTeX available.

The problem in this ticket is that Dima is confused about what a "source distribution" (sdist) is and insists that it MUST NOT contain "generated files".
But this is a principle that is unknown to actual Python packaging practice. What goes into an sdist is determined by its purpose -- namely installability.

The `.sty` files etc. are "generated files" -- LaTeX is needed to extract them from the `.dtx` file, the actual source. In Dima's scheme, this makes the installation of the package dependent on LaTeX being installed. This is bad because it stops people from using the Python part of the package on a system that does not have LaTeX, which is a documented use case of sagetex.

What Dima is missing is that there is an actual build phase for building a source distribution. The product of it is the sdist tarball, which one then deposits on PyPI. The very purpose of this build phase is to include files in the source distribution that do not appear in this form in the git repository etc.


---

Comment by mkoeppe created at 2022-08-20 16:22:39

Whether `make`, `ninja`, or a simple `subprocess.run()` is used to launch latex for extracting `.sty` files from the `.dtx` files is irrelevant. Using `ninja` for this is an amusing overkill, but I don't have strong objections to it.


---

Comment by mkoeppe created at 2022-08-20 16:32:00

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2022-08-20 16:38:07

Replying to [comment:88 dimpase]:
> 1) keep a hacky tarball package with pdfs and all, that cannot be installed from source in a meaningful way, and would never ever make it to PyPI in that form. 

PyPI checks that the metadata of an sdist is well-formed and rejects tarballs that exceed a certain size. That's all. There's no "purity test".


---

Comment by charpent created at 2022-08-20 20:48:25

First things first : I agree that it is easier to maintain a complex set of files if one can derive allof them from a set of sources as small as possible. I sympathize wit the idea of deriving both Python and LaTeX files from the same set of files.

`Sagetex`is both a Python package and a LaTeX package, and neither. As a sick  [centaur](https://en.wikipedia.org/wiki/Centaur), who has to consult with both a physician and a veterinarian (unless he is [Χείρων](https://en.wikipedia.org/wiki/Chiron), himself physician...), we must attack both sides of the problem. 

As far as I understand it, we have three distribution targets :

  - The Sage source tree,
  - CTAN,
  - PyPI.

The **Sage source tree** should be unproblematic.

**CTAN** should also be unproblematic, since it does not insist on a `.dtx` format for the source code it distributes. For example, [PythonTeX](https://github.com/gpoore/pythontex) : if the `sagetex.sty` package itself //has// such a `.dtx`source, the associated python scripts have not : from the LaTeX point of niew, they are pure data.

The problem is therefore what can be accepted by **PyPI**. As far as I can tell, We can submit a package including :
  - all our LaTeX and Python files,
  - a `setup.py` file sufficient to install these files (problem : how to detect the target directories for `sagetex.py` ?),
  - a `README.md` file insisting on the fact that directly modifying these files is a Bad Idea(TM), and pointing to
  - a `HACKING.md` file 
    * explaining (mostly by pointers to the relevant documentation) what is a `dtx` is and how to exploit it, and
    * explaining the dependencies and respective roles of `Makefile`, `sagetex.ins` and `sagetex.dtx`, all contained in  
  - a `sagetex-source.tar.gz` archive.

The `HACKING.md` should insist that only the contributions (patches) to `sagetex.ins`, `sagetex.dtx` and `Makefile` will be considered for inclusion.

FWIW : The current `sagetex` tree, with self-compiled source, docimentatin and example (with Tikz graphs) weights in at 4.5 Mbytes, down to 2 MB in `.tar.gz` format. This shouldn't be problematic nowadays...

Unless I'm missing some PyPI submission rule, this should be sufficient to fulfill our constraints :
  - no install dependencies,
  - no building before installing,
  - cleanly modifiable,
  - reasonable size.

As for `ninja` vs `make` :

  - I have no opinion on their respective values ;
  - I know for a fact that building Sage depends on `make` (therefore all Sage builder (are supposed to) know how to use `make`).

If building Sage depends on `ninja` in any way, a decision would depend of their respective values, a point I won't discuss. If this would be the forst case of mandatory `ninja` use in Sage, I will vote for `make` : not force-introducing Yet Another building tool would be a Good Thing (C)(R).

Can we avoid opening yet anorher Religious War(TM) ?

My two €/100...

What am I missing ?


---

Comment by mkoeppe created at 2022-08-20 20:57:36

Replying to [comment:118 charpent]:
> The `HACKING.md` should insist that only the contributions (patches) to `sagetex.ins`, `sagetex.dtx` and `Makefile` will be considered for inclusion.

Yes, and of course only these files are in the git repository (https://github.com/sagemath/sagetex), not the generated files.


---

Comment by mkoeppe created at 2022-08-20 21:05:33

Replying to [comment:118 charpent]:
> If building Sage depends on `ninja` in any way, a decision would depend of their respective values, a point I won't discuss. If this would be the first case of mandatory `ninja` use in Sage, I will vote for `make` : not force-introducing Yet Another building tool would be a Good Thing (C)(R).

There are two things that are called `ninja`. 
We already have in Sage the package that provides the `ninja` executable, see `build/pkgs/ninja_build`. It was needed for building an optional package, but we just recently made it a standard package because it is needed by the next SciPy upgrade (#34081).

But there is also a Python distribution package called `ninja`, which provides the executable and a Python module `ninja`.
We do not have this in Sage, and it is not needed for anything.

Dima's proposed branch (https://github.com/sagemath/sagetex/tree/ninja-dev) uses the Python package - see https://github.com/sagemath/sagetex/blob/ninja-dev/setup.py


---

Comment by charpent created at 2022-08-20 21:13:46

Replying to [comment:119 mkoeppe]:
> Replying to [comment:118 charpent]:
> > The `HACKING.md` should insist that only the contributions (patches) to `sagetex.ins`, `sagetex.dtx` and `Makefile` will be considered for inclusion.
> 
> Yes, and of course only these files are in the git repository (https://github.com/sagemath/sagetex), not the generated files.

We can do that. But this adds to our workload the onus of generating the package(s) submitted to PiPY and CTAN, whoich must contain the executables and LaTeX files.

Of course, these can be further `Makefile` targets... ;-).


---

Comment by charpent created at 2022-08-20 21:18:25

Replying to [comment:120 mkoeppe]:
> Replying to [comment:118 charpent]:
> > If building Sage depends on `ninja` in any way, a decision would depend of their respective values, a point I won't discuss. If this would be the first case of mandatory `ninja` use in Sage, I will vote for `make` : not force-introducing Yet Another building tool would be a Good Thing (C)(R).
> 
> There are two things that are called `ninja`. 
> We already have in Sage the package that provides the `ninja` executable, see `build/pkgs/ninja_build`. It was needed for building an optional package, but we just recently made it a standard package because it is needed by the next SciPy upgrade (#34081).
> 
> But there is also a Python distribution package called `ninja`, which provides the executable and a Python module `ninja`.
> We do not have this in Sage, and it is not needed for anything.
> 
> Dima's proposed branch (https://github.com/sagemath/sagetex/tree/ninja-dev) uses the Python package - see https://github.com/sagemath/sagetex/blob/ninja-dev/setup.py

Can the `ninja` executable be substituted (easily) to the `ninja` Python package (or //vice versa//) ?

If so, coulld it be avantagous to "standardize" on one of them for present //and future// Sage work ?

Dima ?


---

Comment by mkoeppe created at 2022-08-20 21:27:17

Replying to [comment:122 charpent]:
> If so, could it be avantagous to "standardize" on one of them for present //and future// Sage work ?

If Dima wants to use ninja, he can just do that without needing the Python package.

He can just replace

```
import ninja
ninja.subprocess.run(['ninja'],check=True)
```

by

```
import subprocess
subprocess.run(['ninja'],check=True)
```



---

Comment by mkoeppe created at 2022-08-20 21:28:13

In fact `ninja.subprocess` is just the imported `subprocess` module from the Python library.


---

Comment by mkoeppe created at 2022-08-20 21:31:51

Replying to [comment:121 charpent]:
> Replying to [comment:119 mkoeppe]:
> > Replying to [comment:118 charpent]:
> > > The `HACKING.md` should insist that only the contributions (patches) to `sagetex.ins`, `sagetex.dtx` and `Makefile` will be considered for inclusion.
> > 
> > Yes, and of course only these files are in the git repository (https://github.com/sagemath/sagetex), not the generated files.
> 
> We can do that.

I'm not proposing a change - that's what the repository https://github.com/sagemath/sagetex looks like.


---

Comment by charpent created at 2022-08-20 21:44:33

Replying to [comment:125 mkoeppe]:
> Replying to [comment:121 charpent]:
> > Replying to [comment:119 mkoeppe]:
> > > Replying to [comment:118 charpent]:
> > > > The `HACKING.md` should insist that only the contributions (patches) to `sagetex.ins`, `sagetex.dtx` and `Makefile` will be considered for inclusion.
> > > 
> > > Yes, and of course only these files are in the git repository (https://github.com/sagemath/sagetex), not the generated files.
> > 
> > We can do that.
> 
> I'm not proposing a change - that's what the repository https://github.com/sagemath/sagetex looks like.

So, what remains to be done in order to "release" this new version ?


---

Comment by mkoeppe created at 2022-08-20 22:17:02

Replying to [comment:126 charpent]:
> So, what remains to be done in order to "release" this new version ?

The release tarball on GitHub for 3.6 (sagetex-3.6.tar.gz at https://github.com/sagemath/sagetex/releases/tag/v3.6) looks OK. The initial issue raised in comment:2 was fixed.

We can just use this package. I'll push a branch that does that.


---

Comment by mkoeppe created at 2022-08-20 22:28:00

The update on CTAN still needs to be done - sagetex is still at 3.5: https://ctan.org/pkg/sagetex?lang=en - same status as in comment:21
----
New commits:


---

Comment by mkoeppe created at 2022-08-20 22:28:26

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-08-20 22:29:36

Now we need fearless centaur testers


---

Comment by mkoeppe created at 2022-08-20 22:35:48

I have uploaded the tarball from the GitHub release to PyPI:  https://pypi.org/project/sagetex/#history


---

Comment by git created at 2022-08-20 22:45:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-20 22:59:28


```
[sagetex-3.6]   copying example.tex -> build/bdist.macosx-10.14-x86_64/wheel/sagetex-3.6.data/data/share/doc/sagetex
[sagetex-3.6]   error: can't copy 'sagetex.pdf': doesn't exist or not a regular file
```



---

Comment by mkoeppe created at 2022-08-20 22:59:28

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-08-20 23:00:12

OK, that was pointed out in comment:41 already.


---

Comment by git created at 2022-08-20 23:12:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-20 23:12:49

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2022-08-21 08:15:19

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2022-08-21 08:15:19

Replying to [comment:133 mkoeppe]:
> Now we need fearless centaur testers

The centaur runs ... and passes `ptestlong`. Yay !

==> `positive_review`.

Thanks a lot !


---

Comment by dimpase created at 2022-08-21 09:45:19

Does

```
SAGE_CHECK=yes make sagetex
```

pass?


---

Comment by charpent created at 2022-08-21 16:04:43

Sorry for the wait (family obligations... ;-)

Replying to [comment:142 dimpase]:
> Does
> {{{
> SAGE_CHECK=yes make sagetex
> }}}
> pass?

Yep !

HTH,


---

Comment by mkoeppe created at 2022-08-21 16:08:32

Thanks for the review!


---

Comment by vbraun created at 2022-08-30 19:05:32

Resolution: fixed
