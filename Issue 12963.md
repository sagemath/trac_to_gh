# Issue 12963: list_plot3d.py timeout in Solaris

archive/issues_012963.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  @strogdon @kiwifb\n\nThis used to work on Solaris SPARC in sage-5.1.beta3, but no longer in sage-5.1.beta5:\n\n```\nsage -t  --long -force_lib devel/sage/sage/plot/plot3d/list_plot3d.py\n*** *** Error: TIMED OUT! PROCESS KILLED! *** ***\n\n         [5001.6 s]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/13135\n\n",
    "created_at": "2012-06-19T08:25:11Z",
    "labels": [
        "component: graphics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "list_plot3d.py timeout in Solaris",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12963",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: jason, was

CC:  @strogdon @kiwifb

This used to work on Solaris SPARC in sage-5.1.beta3, but no longer in sage-5.1.beta5:

```
sage -t  --long -force_lib devel/sage/sage/plot/plot3d/list_plot3d.py
*** *** Error: TIMED OUT! PROCESS KILLED! *** ***

         [5001.6 s]
```

Issue created by migration from https://trac.sagemath.org/ticket/13135





---

archive/issue_events_036168.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-19T09:02:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36168"
}
```



---

archive/issue_comments_156219.json:
```json
{
    "body": "This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.\n\n```\nsage: l=[]\nsage: for i in range(-5,5):\n          for j in range(-5,5):\n              l.append((normalvariate(0,1),normalvariate(0,1),normalvariate(0,1)))\n\nsage: %time list_plot3d(l,interpolation_type='nn',texture='yellow',num_points=100)\nCPU times: user 0.16 s, sys: 0.01 s, total: 0.18 s\nWall time: 0.18 s\n```",
    "created_at": "2012-06-23T01:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156219",
    "user": "https://github.com/ppurka"
}
```

This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.

```
sage: l=[]
sage: for i in range(-5,5):
          for j in range(-5,5):
              l.append((normalvariate(0,1),normalvariate(0,1),normalvariate(0,1)))

sage: %time list_plot3d(l,interpolation_type='nn',texture='yellow',num_points=100)
CPU times: user 0.16 s, sys: 0.01 s, total: 0.18 s
Wall time: 0.18 s
```



---

archive/issue_comments_156220.json:
```json
{
    "body": "Replying to [comment:4 ppurka]:\n> This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.\n\nDo an explaination of why it could have slowed down a lot because of this ticket?",
    "created_at": "2012-06-23T07:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156220",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 ppurka]:
> This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.

Do an explaination of why it could have slowed down a lot because of this ticket?



---

archive/issue_comments_156221.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Replying to [comment:4 ppurka]:\n> > This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.\n\n> Do an explaination of why it could have slowed down a lot because of this ticket?\n\nI think the way to handle the slow down is to reduce the `num_points` to 100.\n\nIt is not really a \"slow down\" per se, but it actually gives an accurate plot. Before #13135 3d plots of lists of points were just plain wrong.\n\nI think the following is a good means of checking the time that the plot in the revised description takes\n\n```\nsage: %time list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=400).export_jmol('/tmp/a.jmol')            \nCPU times: user 5.37 s, sys: 0.05 s, total: 5.42 s\nWall time: 5.44 s\nsage: %time list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=100).export_jmol('/tmp/a.jmol')\nCPU times: user 0.35 s, sys: 0.00 s, total: 0.35 s\nWall time: 0.35 s\n```\nCan you run this command on the Solaris machine and find out what is the time taken? If it takes much less time on the latter command, then it would be good to have the latter one (with 100 points) instead of the former one (with 400 points).",
    "created_at": "2012-06-23T07:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156221",
    "user": "https://github.com/ppurka"
}
```

Replying to [comment:6 jdemeyer]:
> Replying to [comment:4 ppurka]:
> > This takes 0.18s on my laptop in sage-5.1.beta5. I don't see why it should take >5s on some other hardware unless the hardware is really that slow.

> Do an explaination of why it could have slowed down a lot because of this ticket?

I think the way to handle the slow down is to reduce the `num_points` to 100.

It is not really a "slow down" per se, but it actually gives an accurate plot. Before #13135 3d plots of lists of points were just plain wrong.

I think the following is a good means of checking the time that the plot in the revised description takes

```
sage: %time list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=400).export_jmol('/tmp/a.jmol')            
CPU times: user 5.37 s, sys: 0.05 s, total: 5.42 s
Wall time: 5.44 s
sage: %time list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=100).export_jmol('/tmp/a.jmol')
CPU times: user 0.35 s, sys: 0.00 s, total: 0.35 s
Wall time: 0.35 s
```
Can you run this command on the Solaris machine and find out what is the time taken? If it takes much less time on the latter command, then it would be good to have the latter one (with 100 points) instead of the former one (with 400 points).



---

archive/issue_comments_156222.json:
```json
{
    "body": "Here's an other weird thing: the test takes *much* longer when running the doctests than when run individually.  Inside Sage, there is not much difference with/without the #12798 patches.  But when running the doctest, there is a huge difference.\n\nCould there be a resource leak of some kind?",
    "created_at": "2012-06-23T07:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156222",
    "user": "https://github.com/jdemeyer"
}
```

Here's an other weird thing: the test takes *much* longer when running the doctests than when run individually.  Inside Sage, there is not much difference with/without the #12798 patches.  But when running the doctest, there is a huge difference.

Could there be a resource leak of some kind?



---

archive/issue_comments_156223.json:
```json
{
    "body": "A resource leak might be a possibility. I ran the following two commands:\n\n**Vanilla sage-5.1beta5**\n\n```\n...sage-5.1.beta5/devel/sage\u00bb ../../sage -t --long -force_lib sage/plot/plot3d/list_plot3d.py \nsage -t --long -force_lib \"devel/sage-main/sage/plot/plot3d/list_plot3d.py\"\n\t [10.3 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 10.3 seconds\n```\n\nThen I changed that `list_plot` example to the following:\n\n```\nsage: list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=400).export_jmol(tmp_filename()+'.jmol') # long time\n```\n\n**After change to the `list_plot` example**\n\n```\n...sage-5.1.beta5/devel/sage\u00bb ../../sage -t --long -force_lib sage/plot/plot3d/list_plot3d.py \nsage -t --long -force_lib \"devel/sage-main/sage/plot/plot3d/list_plot3d.py\"\n\t [8.6 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 8.6 seconds\n```\nThat is quite a bit of a difference just for dumping the jmol into a file.\n\nIs there some automated way to measure the memory/cpu usage of a running process?",
    "created_at": "2012-06-23T07:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156223",
    "user": "https://github.com/ppurka"
}
```

A resource leak might be a possibility. I ran the following two commands:

**Vanilla sage-5.1beta5**

```
...sage-5.1.beta5/devel/sage» ../../sage -t --long -force_lib sage/plot/plot3d/list_plot3d.py 
sage -t --long -force_lib "devel/sage-main/sage/plot/plot3d/list_plot3d.py"
	 [10.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 10.3 seconds
```

Then I changed that `list_plot` example to the following:

```
sage: list_plot3d([(0,0,1), (2,3,4), (-1,-1,-1)],num_points=400).export_jmol(tmp_filename()+'.jmol') # long time
```

**After change to the `list_plot` example**

```
...sage-5.1.beta5/devel/sage» ../../sage -t --long -force_lib sage/plot/plot3d/list_plot3d.py 
sage -t --long -force_lib "devel/sage-main/sage/plot/plot3d/list_plot3d.py"
	 [8.6 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 8.6 seconds
```
That is quite a bit of a difference just for dumping the jmol into a file.

Is there some automated way to measure the memory/cpu usage of a running process?



---

archive/issue_events_036169.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-26T06:50:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36169"
}
```



---

archive/issue_events_036170.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-26T06:50:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36170"
}
```



---

archive/issue_events_036171.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36171"
}
```



---

archive/issue_events_036172.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36172"
}
```



---

archive/issue_events_036173.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36173"
}
```



---

archive/issue_events_036174.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36174"
}
```



---

archive/issue_events_036175.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36175"
}
```



---

archive/issue_events_036176.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36176"
}
```



---

archive/issue_events_036177.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36177"
}
```



---

archive/issue_events_036178.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36178"
}
```



---

archive/issue_comments_156224.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-02-28T11:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156224",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_156225.json:
```json
{
    "body": "Example tachyon input",
    "created_at": "2018-02-28T11:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156225",
    "user": "https://github.com/jdemeyer"
}
```

Example tachyon input



---

archive/issue_comments_156226.json:
```json
{
    "body": "Attachment [tachyon.dat](tarball://root/attachments/some-uuid/ticket13135/tachyon.dat) by @jdemeyer created at 2018-02-28 11:35:10\n\nI'm attaching an example Tachyon input file generated by `list_plot3d`.",
    "created_at": "2018-02-28T11:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156226",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [tachyon.dat](tarball://root/attachments/some-uuid/ticket13135/tachyon.dat) by @jdemeyer created at 2018-02-28 11:35:10

I'm attaching an example Tachyon input file generated by `list_plot3d`.



---

archive/issue_comments_156227.json:
```json
{
    "body": "Patch to show the problem",
    "created_at": "2018-02-28T12:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156227",
    "user": "https://github.com/jdemeyer"
}
```

Patch to show the problem



---

archive/issue_events_036179.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-28T12:59:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36179"
}
```



---

archive/issue_events_036180.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-28T12:59:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36180"
}
```



---

archive/issue_comments_156228.json:
```json
{
    "body": "Attachment [nancount.patch](tarball://root/attachments/some-uuid/ticket13135/nancount.patch) by @jdemeyer created at 2018-02-28 12:59:40",
    "created_at": "2018-02-28T12:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156228",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [nancount.patch](tarball://root/attachments/some-uuid/ticket13135/nancount.patch) by @jdemeyer created at 2018-02-28 12:59:40



---

archive/issue_comments_156229.json:
```json
{
    "body": "simpler case maybe\n\n```\nsage: var('x,y')\nsage: f = lambda x,y: x+y if x*x+y*y<=1 else NaN\nsage: plot3d(f,(x,-2,2),(y,-2,2)).tachyon()  \n```",
    "created_at": "2018-02-28T16:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156229",
    "user": "https://github.com/fchapoton"
}
```

simpler case maybe

```
sage: var('x,y')
sage: f = lambda x,y: x+y if x*x+y*y<=1 else NaN
sage: plot3d(f,(x,-2,2),(y,-2,2)).tachyon()  
```



---

archive/issue_comments_156230.json:
```json
{
    "body": "and\n\n```\nsage: G = polygon([(NaN,NaN,NaN)]*3)\nsage: G.tachyon_repr(G.default_render_params())\n['TRI V0 nan nan nan V1 nan nan nan V2 nan nan nan', 'texture3']\n```\nMaybe we should filter this out of tachyon input ? or more generally ?",
    "created_at": "2018-02-28T17:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156230",
    "user": "https://github.com/fchapoton"
}
```

and

```
sage: G = polygon([(NaN,NaN,NaN)]*3)
sage: G.tachyon_repr(G.default_render_params())
['TRI V0 nan nan nan V1 nan nan nan V2 nan nan nan', 'texture3']
```
Maybe we should filter this out of tachyon input ? or more generally ?



---

archive/issue_comments_156231.json:
```json
{
    "body": "Replying to [comment:23 chapoton]:\n> Maybe we should filter this out of tachyon input ? or more generally ?\n\n\nThat doesn't solve the underlying problem. Why are `NaN`s suddenly appearing? That didn't happen before #23696.",
    "created_at": "2018-02-28T19:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156231",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 chapoton]:
> Maybe we should filter this out of tachyon input ? or more generally ?


That doesn't solve the underlying problem. Why are `NaN`s suddenly appearing? That didn't happen before #23696.



---

archive/issue_comments_156232.json:
```json
{
    "body": "Doesn't explain the `NaN` but could the following be what one is observing when doctesting\n\n```\nsage: l = []\nsage: for i in range(-5, 5):\n....:     for j in range(-5, 5):\n....:         l.append((normalvariate(0, 1), normalvariate(0, 1), normalvariate(0, 1)))\n....:         \nsage: %timeit list_plot3d(l, interpolation_type='clough', texture='yellow', num_points=100)\nThe slowest run took 109.32 times longer than the fastest. This could mean that an intermediate result is being cached.\n1 loop, best of 3: 3.11 ms per loop\n```\nThe first run is always the slowest.",
    "created_at": "2018-02-28T20:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156232",
    "user": "https://github.com/strogdon"
}
```

Doesn't explain the `NaN` but could the following be what one is observing when doctesting

```
sage: l = []
sage: for i in range(-5, 5):
....:     for j in range(-5, 5):
....:         l.append((normalvariate(0, 1), normalvariate(0, 1), normalvariate(0, 1)))
....:         
sage: %timeit list_plot3d(l, interpolation_type='clough', texture='yellow', num_points=100)
The slowest run took 109.32 times longer than the fastest. This could mean that an intermediate result is being cached.
1 loop, best of 3: 3.11 ms per loop
```
The first run is always the slowest.



---

archive/issue_comments_156233.json:
```json
{
    "body": "OK in the case of `clough` and `linear` we could able to filter `NaN` at a cost. Both define a function `g` like so\n\n```\n        def g(x, y):\n            z = f([x, y])\n            return (x, y, z)\n```\nI guess `g` could return empty if `z` turns to be a `NaN`. Is it even doable?",
    "created_at": "2018-02-28T22:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156233",
    "user": "https://github.com/kiwifb"
}
```

OK in the case of `clough` and `linear` we could able to filter `NaN` at a cost. Both define a function `g` like so

```
        def g(x, y):
            z = f([x, y])
            return (x, y, z)
```
I guess `g` could return empty if `z` turns to be a `NaN`. Is it even doable?



---

archive/issue_comments_156234.json:
```json
{
    "body": "Filtering `NaN`s is easy, but that is really ignoring the problem. The real problem is that `NaN`s are appearing in a computation which did not produce `NaN`s before #23696.",
    "created_at": "2018-03-01T06:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156234",
    "user": "https://github.com/jdemeyer"
}
```

Filtering `NaN`s is easy, but that is really ignoring the problem. The real problem is that `NaN`s are appearing in a computation which did not produce `NaN`s before #23696.



---

archive/issue_comments_156235.json:
```json
{
    "body": "The interpolation algorithm is completely different, so there is a possibility that this particular algorithm is completely unsuited to this particular set of points. I am now curious to see what the plot look like but that will have to wait until I go back to work tomorrow morning (~14 hours in my time zone).",
    "created_at": "2018-03-01T06:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156235",
    "user": "https://github.com/kiwifb"
}
```

The interpolation algorithm is completely different, so there is a possibility that this particular algorithm is completely unsuited to this particular set of points. I am now curious to see what the plot look like but that will have to wait until I go back to work tomorrow morning (~14 hours in my time zone).



---

archive/issue_comments_156236.json:
```json
{
    "body": "It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.",
    "created_at": "2018-03-01T06:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156236",
    "user": "https://github.com/strogdon"
}
```

It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.



---

archive/issue_comments_156237.json:
```json
{
    "body": "Replying to [comment:31 strogdon]:\n> It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.\n\n\nThanks for the info. If so, filtering them probably is the right thing to do after all.",
    "created_at": "2018-03-01T06:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156237",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:31 strogdon]:
> It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.


Thanks for the info. If so, filtering them probably is the right thing to do after all.



---

archive/issue_comments_156238.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> Replying to [comment:31 strogdon]:\n> > It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.\n\n> \n> Thanks for the info. If so, filtering them probably is the right thing to do after all.\n\n\nYes, this algorithm just doesn't do extrapolation and put NaN for anything that would be an extrapolation. We could set an arbitrary  value, but to what? The average z value of the input? 0?",
    "created_at": "2018-03-01T06:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156238",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:32 jdemeyer]:
> Replying to [comment:31 strogdon]:
> > It may be that the `nan` are a feature of using scipy.interpolate.CloughTocher2DInterpolator. The documentation indicates that if requested points are outside the convex hull then, unless specified, they are filled in with `nan`.

> 
> Thanks for the info. If so, filtering them probably is the right thing to do after all.


Yes, this algorithm just doesn't do extrapolation and put NaN for anything that would be an extrapolation. We could set an arbitrary  value, but to what? The average z value of the input? 0?



---

archive/issue_comments_156239.json:
```json
{
    "body": "Replying to [comment:23 chapoton]:\n> Maybe we should filter this out of tachyon input ? or more generally ?\n\n\nIf you want to filter them, I think the right place is the `triangulate()` method.",
    "created_at": "2018-03-01T08:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156239",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 chapoton]:
> Maybe we should filter this out of tachyon input ? or more generally ?


If you want to filter them, I think the right place is the `triangulate()` method.



---

archive/issue_comments_156240.json:
```json
{
    "body": "I just spent some time with matplotlib code to check what it does for extrapolation. And it looks like it returns `NaN` for those points as well. So the problem should be present as well for `linear` interpolation. I couldn't find anything in the documentation about what the stuff behind `spline` do for extrapolation - by the look of the output picture it just extrapolates.",
    "created_at": "2018-03-01T21:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156240",
    "user": "https://github.com/kiwifb"
}
```

I just spent some time with matplotlib code to check what it does for extrapolation. And it looks like it returns `NaN` for those points as well. So the problem should be present as well for `linear` interpolation. I couldn't find anything in the documentation about what the stuff behind `spline` do for extrapolation - by the look of the output picture it just extrapolates.



---

archive/issue_comments_156241.json:
```json
{
    "body": "There is some discussion also on #12798 about `NaN` coordinates and even a patch.",
    "created_at": "2018-03-02T13:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156241",
    "user": "https://github.com/jdemeyer"
}
```

There is some discussion also on #12798 about `NaN` coordinates and even a patch.



---

archive/issue_comments_156242.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> There is some discussion also on #12798 about `NaN` coordinates and even a patch.\n\nThe patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.",
    "created_at": "2018-03-02T15:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156242",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:36 jdemeyer]:
> There is some discussion also on #12798 about `NaN` coordinates and even a patch.

The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.



---

archive/issue_comments_156243.json:
```json
{
    "body": "Replying to [comment:37 strogdon]:\n> in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.\n\n\nMaybe, but I wouldn't try to fix that here. It would be a non-trivial change to change the `triangulate()` method to better take into account the input points. That is not something that we should fix in this blocker ticket.",
    "created_at": "2018-03-02T15:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156243",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 strogdon]:
> in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.


Maybe, but I wouldn't try to fix that here. It would be a non-trivial change to change the `triangulate()` method to better take into account the input points. That is not something that we should fix in this blocker ticket.



---

archive/issue_comments_156244.json:
```json
{
    "body": "Replying to [comment:38 jdemeyer]:\n> Replying to [comment:37 strogdon]:\n> > in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.\n\n> \n> Maybe, but I wouldn't try to fix that here. It would be a non-trivial change to change the `triangulate()` method to better take into account the input points. That is not something that we should fix in this blocker ticket.\n\nDoes it help your situation? I can't really test whether there is a time savings. I can only verify that the `NaN` are stripped.",
    "created_at": "2018-03-02T17:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156244",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:38 jdemeyer]:
> Replying to [comment:37 strogdon]:
> > in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.

> 
> Maybe, but I wouldn't try to fix that here. It would be a non-trivial change to change the `triangulate()` method to better take into account the input points. That is not something that we should fix in this blocker ticket.

Does it help your situation? I can't really test whether there is a time savings. I can only verify that the `NaN` are stripped.



---

archive/issue_comments_156245.json:
```json
{
    "body": "Replying to [comment:37 strogdon]:\n> The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.\n\nThat is, most of them are gone. There are still a few `corner` ones left.",
    "created_at": "2018-03-02T19:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156245",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:37 strogdon]:
> The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.

That is, most of them are gone. There are still a few `corner` ones left.



---

archive/issue_comments_156246.json:
```json
{
    "body": "Replying to [comment:40 strogdon]:\n> Replying to [comment:37 strogdon]:\n> > The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.\n\n> That is, most of them are gone. There are still a few `corner` ones left.\n\nCan you elaborate on that. I thought `NaN` were not displayed anyway, so I didn't expect a difference before and after stripping them.",
    "created_at": "2018-03-02T19:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156246",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:40 strogdon]:
> Replying to [comment:37 strogdon]:
> > The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.

> That is, most of them are gone. There are still a few `corner` ones left.

Can you elaborate on that. I thought `NaN` were not displayed anyway, so I didn't expect a difference before and after stripping them.



---

archive/issue_comments_156247.json:
```json
{
    "body": "Replying to [comment:41 fbissey]:\n> Replying to [comment:40 strogdon]:\n> > Replying to [comment:37 strogdon]:\n> > > The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.\n\n> > That is, most of them are gone. There are still a few `corner` ones left.\n> \n> Can you elaborate on that. I thought `NaN` were not displayed anyway, so I didn't expect a difference before and after stripping them.\n\nBasically, from my understanding, the stripping is an attempt to find the maximal rectangle that fits inside the convex hull and the 3D surface is drawn over this rectangle. The procedure sometimes fails, most notably at the corners of the constructed rectangle.",
    "created_at": "2018-03-02T19:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156247",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:41 fbissey]:
> Replying to [comment:40 strogdon]:
> > Replying to [comment:37 strogdon]:
> > > The patch does remove the `NaN` values but in so doing it appears the surface is cropped such that it is not displayed over the entire convex hull.

> > That is, most of them are gone. There are still a few `corner` ones left.
> 
> Can you elaborate on that. I thought `NaN` were not displayed anyway, so I didn't expect a difference before and after stripping them.

Basically, from my understanding, the stripping is an attempt to find the maximal rectangle that fits inside the convex hull and the 3D surface is drawn over this rectangle. The procedure sometimes fails, most notably at the corners of the constructed rectangle.



---

archive/issue_comments_156248.json:
```json
{
    "body": "Attachment [before_after_stripping_nan.patch](tarball://root/attachments/some-uuid/ticket13135/before_after_stripping_nan.patch) by @strogdon created at 2018-03-02 20:17:35\n\nbefore and after stripping NaN patch",
    "created_at": "2018-03-02T20:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156248",
    "user": "https://github.com/strogdon"
}
```

Attachment [before_after_stripping_nan.patch](tarball://root/attachments/some-uuid/ticket13135/before_after_stripping_nan.patch) by @strogdon created at 2018-03-02 20:17:35

before and after stripping NaN patch



---

archive/issue_comments_156249.json:
```json
{
    "body": "Patch to see changes before and after stripping the `NaN`s. Apply as `patch -p1 < before_after_stripping_nan.patch` and then rebuild sage, `./sage -b`. To test use that in\ncomment:26 without the `timeit`.",
    "created_at": "2018-03-02T20:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156249",
    "user": "https://github.com/strogdon"
}
```

Patch to see changes before and after stripping the `NaN`s. Apply as `patch -p1 < before_after_stripping_nan.patch` and then rebuild sage, `./sage -b`. To test use that in
comment:26 without the `timeit`.



---

archive/issue_comments_156250.json:
```json
{
    "body": "Yes, I can see there is some differences. What does the plotting do with `NaN`?",
    "created_at": "2018-03-07T21:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156250",
    "user": "https://github.com/kiwifb"
}
```

Yes, I can see there is some differences. What does the plotting do with `NaN`?



---

archive/issue_comments_156251.json:
```json
{
    "body": "Replying to [comment:44 fbissey]:\n> Yes, I can see there is some differences. What does the plotting do with `NaN`?\n\nMy understanding is that points that have associated values of `NaN` are not plotted. When the test is run there should be two plots. The plot where the `NaN` are `stripped` should be displayed above a nearly rectangular region, except possibly, near the corners of the region. It is at these corners where there are some, possibly remaining `NaN`s.",
    "created_at": "2018-03-08T00:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156251",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:44 fbissey]:
> Yes, I can see there is some differences. What does the plotting do with `NaN`?

My understanding is that points that have associated values of `NaN` are not plotted. When the test is run there should be two plots. The plot where the `NaN` are `stripped` should be displayed above a nearly rectangular region, except possibly, near the corners of the region. It is at these corners where there are some, possibly remaining `NaN`s.



---

archive/issue_comments_156252.json:
```json
{
    "body": "From commit [950bdd8145d262e493321bef67d3d57d26f9c464](https://git.sagemath.org/sage.git/diff/src/sage/plot/plot3d/list_plot3d.py?id=950bdd8145d262e493321bef67d3d57d26f9c464) the changes to `src/sage/plot/plot3d/list_plot3d.py` contain\n\n```\n-        T=delaunay.Triangulation(x,y)\n-        f=T.nn_interpolator(z)\n-        f.default_value=0.0\n-        j=numpy.complex(0,1)\n-        vals=f[ymin:ymax:j*num_points,xmin:xmax:j*num_points]\n+        points=[[x[i],y[i]] for i in range(len(x))]\n+        j = numpy.complex(0, 1)\n+        f = interpolate.CloughTocher2DInterpolator(points,z)\n         from .parametric_surface import ParametricSurface\n```\nSo if I'm not mistaken the old `delaunay triagulation` implementation fills points outside the convex hull with zeros, i.e. `f.default_value=0.0`. The same thing can be achieved with scipy.interpolate.CloughTocher2DInterpolator with the change\n\n```diff\ndiff --git a/src/sage/plot/plot3d/list_plot3d.py b/src/sage/plot/plot3d/list_plot3d.py\nindex c0c578b99f..77aeb583ae 100644\n--- a/src/sage/plot/plot3d/list_plot3d.py\n+++ b/src/sage/plot/plot3d/list_plot3d.py\n@@ -461,7 +461,7 @@ def list_plot3d_tuples(v, interpolation_type, texture, **kwds):\n \n         points=[[x[i],y[i]] for i in range(len(x))]\n         j = numpy.complex(0, 1)\n-        f = interpolate.CloughTocher2DInterpolator(points,z)\n+        f = interpolate.CloughTocher2DInterpolator(points,z,fill_value=0.0)\n         from .parametric_surface import ParametricSurface\n         def g(x, y):\n             z = f([x, y])\n```\nIn my opinion the resulting plot is not particularly pleasing but it does reproduce the old behavior. I'm unable to determine whether there is any CPU savings. I do believe that modern graphing algorithms generate these `NaN`s as a mechanism to not plot points and that leaving things as-is is what should be done. In which case the doctest could be marked as `# long time` until the older hardware that doesn't like the `NaN`s is gone. So I would favor either of the above two approaches instead of `stripping` the `NaN`s.",
    "created_at": "2018-03-12T22:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156252",
    "user": "https://github.com/strogdon"
}
```

From commit [950bdd8145d262e493321bef67d3d57d26f9c464](https://git.sagemath.org/sage.git/diff/src/sage/plot/plot3d/list_plot3d.py?id=950bdd8145d262e493321bef67d3d57d26f9c464) the changes to `src/sage/plot/plot3d/list_plot3d.py` contain

```
-        T=delaunay.Triangulation(x,y)
-        f=T.nn_interpolator(z)
-        f.default_value=0.0
-        j=numpy.complex(0,1)
-        vals=f[ymin:ymax:j*num_points,xmin:xmax:j*num_points]
+        points=[[x[i],y[i]] for i in range(len(x))]
+        j = numpy.complex(0, 1)
+        f = interpolate.CloughTocher2DInterpolator(points,z)
         from .parametric_surface import ParametricSurface
```
So if I'm not mistaken the old `delaunay triagulation` implementation fills points outside the convex hull with zeros, i.e. `f.default_value=0.0`. The same thing can be achieved with scipy.interpolate.CloughTocher2DInterpolator with the change

```diff
diff --git a/src/sage/plot/plot3d/list_plot3d.py b/src/sage/plot/plot3d/list_plot3d.py
index c0c578b99f..77aeb583ae 100644
--- a/src/sage/plot/plot3d/list_plot3d.py
+++ b/src/sage/plot/plot3d/list_plot3d.py
@@ -461,7 +461,7 @@ def list_plot3d_tuples(v, interpolation_type, texture, **kwds):
 
         points=[[x[i],y[i]] for i in range(len(x))]
         j = numpy.complex(0, 1)
-        f = interpolate.CloughTocher2DInterpolator(points,z)
+        f = interpolate.CloughTocher2DInterpolator(points,z,fill_value=0.0)
         from .parametric_surface import ParametricSurface
         def g(x, y):
             z = f([x, y])
```
In my opinion the resulting plot is not particularly pleasing but it does reproduce the old behavior. I'm unable to determine whether there is any CPU savings. I do believe that modern graphing algorithms generate these `NaN`s as a mechanism to not plot points and that leaving things as-is is what should be done. In which case the doctest could be marked as `# long time` until the older hardware that doesn't like the `NaN`s is gone. So I would favor either of the above two approaches instead of `stripping` the `NaN`s.



---

archive/issue_comments_156253.json:
```json
{
    "body": "I must say that in a previous comment I mentioned the possibility of using `fill_value`. If `0` reproduce the old behavior we could go with that but I don't think it is an especially good or always appropriate value. As you said if `NaN` means do not plot, then it is more appropriate.\n\nThe problem is not with older hardware, power8 is not especially old, but its handling of NaN is currently poor. I don't know if it can be improved at the software level eventually but I would hope so.",
    "created_at": "2018-03-12T22:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156253",
    "user": "https://github.com/kiwifb"
}
```

I must say that in a previous comment I mentioned the possibility of using `fill_value`. If `0` reproduce the old behavior we could go with that but I don't think it is an especially good or always appropriate value. As you said if `NaN` means do not plot, then it is more appropriate.

The problem is not with older hardware, power8 is not especially old, but its handling of NaN is currently poor. I don't know if it can be improved at the software level eventually but I would hope so.



---

archive/issue_comments_156254.json:
```json
{
    "body": "Replying to [comment:47 fbissey]:\n> I must say that in a previous comment I mentioned the possibility of using `fill_value`. If `0` reproduce the old behavior we could go with that but I don't think it is an especially good or always appropriate value. As you said if `NaN` means do not plot, then it is more appropriate.\n> \n> The problem is not with older hardware, power8 is not especially old, but its handling of NaN is currently poor. I don't know if it can be improved at the software level eventually but I would hope so.\n\nI couldn't check things with vanilla Sage. But I was able to install MPL-1.5.3 on sage-on-gentoo and I could manually replicate the current behavior by setting `f.default_value=numpy.float('nan')` with the old `delaunay triangulation`.",
    "created_at": "2018-03-12T22:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156254",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:47 fbissey]:
> I must say that in a previous comment I mentioned the possibility of using `fill_value`. If `0` reproduce the old behavior we could go with that but I don't think it is an especially good or always appropriate value. As you said if `NaN` means do not plot, then it is more appropriate.
> 
> The problem is not with older hardware, power8 is not especially old, but its handling of NaN is currently poor. I don't know if it can be improved at the software level eventually but I would hope so.

I couldn't check things with vanilla Sage. But I was able to install MPL-1.5.3 on sage-on-gentoo and I could manually replicate the current behavior by setting `f.default_value=numpy.float('nan')` with the old `delaunay triangulation`.



---

archive/issue_comments_156255.json:
```json
{
    "body": "Replying to [comment:46 strogdon]:\n> I do believe that modern graphing algorithms generate these `NaN`s as a mechanism to not plot points and that leaving things as-is is what should be done.\n\n\n-1.\n\nPlotting `NaN`s makes no sense at all. It can only lead to [garbage in, garbage out](https://en.wikipedia.org/wiki/Garbage_in,_garbage_out).\n\nI am actually surprised that removing the `NaN`s changes the output. I haven't looked at the code, but it makes me suspect that maybe the `NaN` removal is not done correctly.",
    "created_at": "2018-03-13T08:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156255",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:46 strogdon]:
> I do believe that modern graphing algorithms generate these `NaN`s as a mechanism to not plot points and that leaving things as-is is what should be done.


-1.

Plotting `NaN`s makes no sense at all. It can only lead to [garbage in, garbage out](https://en.wikipedia.org/wiki/Garbage_in,_garbage_out).

I am actually surprised that removing the `NaN`s changes the output. I haven't looked at the code, but it makes me suspect that maybe the `NaN` removal is not done correctly.



---

archive/issue_comments_156256.json:
```json
{
    "body": "Replying to [comment:49 jdemeyer]:\n> Plotting `NaN`s makes no sense at all. It can only lead to [garbage in, garbage out](https://en.wikipedia.org/wiki/Garbage_in,_garbage_out).\n> \n\nTry it!\n\n```\nsage: import matplotlib.pyplot as plt\nsage: fig, (ax1, ax2) = plt.subplots(1,2)\nsage: ax1.plot([1, 2, 2, 2, 3], [1, 1, NaN, 2, 2]);\nsage: ax2.plot([1, 2, 2, 3], [1, 1, 2, 2]);\nsage: plt.show()\n```\nThere may be other ways, but both scipy and matplotlib know how to handle such things.",
    "created_at": "2018-03-13T21:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156256",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:49 jdemeyer]:
> Plotting `NaN`s makes no sense at all. It can only lead to [garbage in, garbage out](https://en.wikipedia.org/wiki/Garbage_in,_garbage_out).
> 

Try it!

```
sage: import matplotlib.pyplot as plt
sage: fig, (ax1, ax2) = plt.subplots(1,2)
sage: ax1.plot([1, 2, 2, 2, 3], [1, 1, NaN, 2, 2]);
sage: ax2.plot([1, 2, 2, 3], [1, 1, 2, 2]);
sage: plt.show()
```
There may be other ways, but both scipy and matplotlib know how to handle such things.



---

archive/issue_comments_156257.json:
```json
{
    "body": "What's your point? That example is showing a `Line2D` object which is a high-level object: it's a collection of lines, which the low-level renderer will treat as individual lines to be drawn.\n\nIt's precisely the transformation of a high-level object (the input to `list_plot3d`) to a low-level object (a collection of triangles) that is going wrong in this ticket.",
    "created_at": "2018-03-14T10:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156257",
    "user": "https://github.com/jdemeyer"
}
```

What's your point? That example is showing a `Line2D` object which is a high-level object: it's a collection of lines, which the low-level renderer will treat as individual lines to be drawn.

It's precisely the transformation of a high-level object (the input to `list_plot3d`) to a low-level object (a collection of triangles) that is going wrong in this ticket.



---

archive/issue_comments_156258.json:
```json
{
    "body": "In other words: the bug is not about a `NaN` appearing in the input of `list_plot3d`. It is about a `NaN` appearing in the processing of otherwise valid input and being sent to the rendering engine.",
    "created_at": "2018-03-14T10:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156258",
    "user": "https://github.com/jdemeyer"
}
```

In other words: the bug is not about a `NaN` appearing in the input of `list_plot3d`. It is about a `NaN` appearing in the processing of otherwise valid input and being sent to the rendering engine.



---

archive/issue_comments_156259.json:
```json
{
    "body": "Replying to [comment:52 jdemeyer]:\n> In other words: the bug is not about a `NaN` appearing in the input of `list_plot3d`. It is about a `NaN` appearing in the processing of otherwise valid input and being sent to the rendering engine.\n\nOK, so I guess there could be a problem inside `ParametricSurface` which receives input that contains the `NaN`s. A big task to fix that. So perhaps we should do as was done previously with the old code until `ParametricSurface` can be investigated, i.e. fill points outside the convex hull with zeros? I believe we know how to do that with `CloughTocher2DInterpolator`.",
    "created_at": "2018-03-14T14:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156259",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:52 jdemeyer]:
> In other words: the bug is not about a `NaN` appearing in the input of `list_plot3d`. It is about a `NaN` appearing in the processing of otherwise valid input and being sent to the rendering engine.

OK, so I guess there could be a problem inside `ParametricSurface` which receives input that contains the `NaN`s. A big task to fix that. So perhaps we should do as was done previously with the old code until `ParametricSurface` can be investigated, i.e. fill points outside the convex hull with zeros? I believe we know how to do that with `CloughTocher2DInterpolator`.



---

archive/issue_comments_156260.json:
```json
{
    "body": "Replying to [comment:53 strogdon]:\n> OK, so I guess there could be a problem inside `ParametricSurface` which receives input that contains the `NaN`s. A big task to fix that.\n\n\nI still think that it should be possible to just remove all the triangles containing a `NaN`. That can't be too hard.",
    "created_at": "2018-03-14T16:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156260",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:53 strogdon]:
> OK, so I guess there could be a problem inside `ParametricSurface` which receives input that contains the `NaN`s. A big task to fix that.


I still think that it should be possible to just remove all the triangles containing a `NaN`. That can't be too hard.



---

archive/issue_comments_156261.json:
```json
{
    "body": "Doesn't strike me as a release blocker bug...",
    "created_at": "2018-03-25T00:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156261",
    "user": "https://github.com/vbraun"
}
```

Doesn't strike me as a release blocker bug...



---

archive/issue_comments_156262.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2018-03-25T00:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156262",
    "user": "https://github.com/vbraun"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_156263.json:
```json
{
    "body": "It is. It yields a **massive** (orders of magnitude) slowdown on most platforms (x86_64 is the exception here), causing `make ptest` to timeout consistently and it is a recent regression.",
    "created_at": "2018-03-26T05:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156263",
    "user": "https://github.com/jdemeyer"
}
```

It is. It yields a **massive** (orders of magnitude) slowdown on most platforms (x86_64 is the exception here), causing `make ptest` to timeout consistently and it is a recent regression.



---

archive/issue_comments_156264.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2018-03-26T05:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156264",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_156265.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-27T10:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156265",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_156266.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-27T10:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156266",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_156267.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-27T16:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156267",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_156268.json:
```json
{
    "body": "I thought all along that if there was a problem it had to be with the code that does the triangulation, not with the inputs. It's good that someone was capable of sorting through the code. I see no `NaN`s in the output and the surfaces appear to be drawn over the full convex hull. It may be interesting to see what are the CPU savings? But I do see at least one failure\n\n```\nsage -t --long src/sage/plot/plot3d/parametric_surface.pyx\n**********************************************************************\nFile \"src/sage/plot/plot3d/parametric_surface.pyx\", line 257, in sage.plot.plot3d.parametric_surface.ParametricSurface.obj_repr\nFailed example:\n    s[:2]+s[2][:3]+s[3][:3]\nExpected:\n    ['g obj_1',\n     'usemtl texture91',\n     'v -2 -2 0',\n     'v -2 -1.89744 0.399737',\n     'v -1.89744 -1.89744 0',\n     'f 1 2 3 4',\n     'f 2 5 6 3',\n     'f 5 7 8 6']\nGot:\n    ['g obj_1',\n     'usemtl texture111',\n     'v -2 -2 0',\n     'v -2 -1.89744 0.399737',\n     'v -1.89744 -1.89744 0',\n     'f 1 2 3 4',\n     'f 2 5 6 3',\n     'f 5 7 8 6']\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.plot.plot3d.parametric_surface.ParametricSurface.obj_repr\n```",
    "created_at": "2018-03-27T16:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156268",
    "user": "https://github.com/strogdon"
}
```

I thought all along that if there was a problem it had to be with the code that does the triangulation, not with the inputs. It's good that someone was capable of sorting through the code. I see no `NaN`s in the output and the surfaces appear to be drawn over the full convex hull. It may be interesting to see what are the CPU savings? But I do see at least one failure

```
sage -t --long src/sage/plot/plot3d/parametric_surface.pyx
**********************************************************************
File "src/sage/plot/plot3d/parametric_surface.pyx", line 257, in sage.plot.plot3d.parametric_surface.ParametricSurface.obj_repr
Failed example:
    s[:2]+s[2][:3]+s[3][:3]
Expected:
    ['g obj_1',
     'usemtl texture91',
     'v -2 -2 0',
     'v -2 -1.89744 0.399737',
     'v -1.89744 -1.89744 0',
     'f 1 2 3 4',
     'f 2 5 6 3',
     'f 5 7 8 6']
Got:
    ['g obj_1',
     'usemtl texture111',
     'v -2 -2 0',
     'v -2 -1.89744 0.399737',
     'v -1.89744 -1.89744 0',
     'f 1 2 3 4',
     'f 2 5 6 3',
     'f 5 7 8 6']
**********************************************************************
1 item had failures:
   1 of   5 in sage.plot.plot3d.parametric_surface.ParametricSurface.obj_repr
```



---

archive/issue_comments_156269.json:
```json
{
    "body": "Replying to [comment:61 strogdon]:\n> But I do see at least one failure\n\n\nI cannot reproduce that failure but the original test had `texture...` so I'll change that.",
    "created_at": "2018-03-27T18:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156269",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:61 strogdon]:
> But I do see at least one failure


I cannot reproduce that failure but the original test had `texture...` so I'll change that.



---

archive/issue_comments_156270.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-27T18:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_156271.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-27T19:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156271",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_156272.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-27T19:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156272",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_156273.json:
```json
{
    "body": "On my very old, although x86_64, computer\n\n```\nsage -t --long --warn-long 10.0 src/sage/plot/plot3d/list_plot3d.py\n    [45 tests, 23.20 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 23.3 seconds\n    cpu time: 4.4 seconds\n    cumulative wall time: 23.2 seconds\n```\nThe results do visually look to be correct. I can't test on anything but x86_64 but if it is slow elsewhere it's not now due to the `NaN`s.",
    "created_at": "2018-03-27T19:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156273",
    "user": "https://github.com/strogdon"
}
```

On my very old, although x86_64, computer

```
sage -t --long --warn-long 10.0 src/sage/plot/plot3d/list_plot3d.py
    [45 tests, 23.20 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 23.3 seconds
    cpu time: 4.4 seconds
    cumulative wall time: 23.2 seconds
```
The results do visually look to be correct. I can't test on anything but x86_64 but if it is slow elsewhere it's not now due to the `NaN`s.



---

archive/issue_comments_156274.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-28T18:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12963#issuecomment-156274",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_036181.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-28T18:26:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12963",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12963#event-36181"
}
```
