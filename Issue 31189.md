# Issue 31189: Apply flat shading when plotting 3d polyhedra with Three.js

Issue created by migration from https://trac.sagemath.org/ticket/31426

Original creator: slelievre

Original creation time: 2021-02-22 14:57:18

CC:  egourgoulhon @jcamp0x2a @laisrast guenterrote paulmasson slelievre

We should ensure flat shading is the default
when plotting 3d polyhedra with Three.js.

For that, the `plot` method in `src/sage/geometry/polyhedron/base.py`
could be modified to set `threejs_flat_shading` to `True`
for the case of 3d polyhedra.

The special case of Platonic solids (as purely graphics objects)
was done in #27836.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by slelievre created at 2021-10-27 16:39:31

I thought changing the `plot` method
in `src/sage/geometry/polyhedron/base.py`
to set `threejs_flat_shading` to `True`
for the case of 3d polyhedra would do the trick.

I tried this change without success:


```diff
diff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py
index 843fe204cb..918ce178c9 100644
--- a/src/sage/geometry/polyhedron/base.py
+++ b/src/sage/geometry/polyhedron/base.py
@@ -815,6 +815,7 @@ class Polyhedron_base(Element):
              wireframe='blue', fill='green',
              position=None,
              orthonormal=True,  # whether to use orthonormal projections
+             threejs_flat_shading=True,  # flat shading for threejs plotting
              **kwds):
         """
         Return a graphical representation.
@@ -847,6 +848,9 @@ class Polyhedron_base(Element):
         - ``orthonormal`` -- Boolean (default: True); whether to use
           orthonormal projections.

+        - ``threejs_flat_shading`` -- boolean (default: True);
+          whether to apply flat shading when plotting with Three.js
+
         - ``**kwds`` -- optional keyword parameters that are passed to
           all graphics objects.
```


Ideas anyone?


---

Attachment

Flat shading wanted for polyhedra


---

Comment by @LaisRast created at 2021-10-31 18:47:42

I think there are two different things here:

* There is a bug in `plot3d.platonic`:
 As your example shows, when changing the center in one of these Platonic solids, the plot does not respect the default `threejs_flat_shading=True`.
 This is a bug which occurs in the function `prep`.
 To fix it, the assignment `threejs_flat_shading=True` should be set before applying the translation.


* For plots of `geometry.polyhedron`, one can set flat shading as follows:
 {{{
 sage: P = polytopes.cube()
 sage: P.plot(polygon={"threejs_flat_shading": True})
 }}}
 I will set this as the default behavior.
 However, I do not encourage putting `threejs_flat_shading` as a parameter of the function `plot`.
 style-related parameters of `plot` should be passed through the parameters `point`, `line` and `polygon`.


---

Comment by git created at 2021-10-31 18:48:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-11-18 23:06:24

Fill in the author field with your full name
and set to "needs review" if ready.


---

Comment by @LaisRast created at 2021-11-18 23:30:23

Changing keywords from "" to "threejs, flat shading, polyhedra".


---

Comment by @LaisRast created at 2021-11-18 23:30:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by mkoeppe created at 2022-03-03 07:13:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-03 07:13:43

These are nice improvements! Thanks for working on this.


---

Comment by vbraun created at 2022-03-08 08:12:17

Resolution: fixed


---

Comment by slelievre created at 2022-06-28 05:01:50

It seems the wrong shading sometimes persists.

Juanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)
seems to indicate the need for a follow-up.


---

Comment by @LaisRast created at 2022-06-29 22:14:56

Replying to [comment:13 slelievre]:
> It seems the wrong shading sometimes persists.
> 
> Juanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)
> seems to indicate the need for a follow-up.

The situation is as follows:
* When calling `cube()` with `frame_thickness > 0`,
  the returned object is a `Graphics3dGroup` which contains two objects: a box and a frame.
  Otherwise, only the box is returned.

* To the returned object, the function `prep()` is applied,
  which among other things, sets flat shading for the returned object.

* When converting a `Graphics3dGroup` into json for threejs,
  the dictionary `._extra_kwds` (in which flat shading is set) is ignored.
  Only the `._extra_kwds`'s in the child objects are considered.

I think the function `prep()` does not assume to get a `Graphics3dGroup`.
The only case when it receives one is the case above.
Thus, I suggest a workaround just for the `cube()` by applying the flat shading
on the box object at the beginning of `cube()`:

```
    if 'threejs_flat_shading' not in kwds: 
        kwds['threejs_flat_shading'] = True
```

This `kwds` is passed to the box object.

By the way, the current implementations force the flat shading even if the user
explicitly says they do not want it. So
`cube(threejs_flat_shading=False)`
will produce flat shading.
