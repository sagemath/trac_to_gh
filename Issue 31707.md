# Issue 31707: Minimal Periodic/Preperiodic Scheme

Issue created by migration from https://trac.sagemath.org/ticket/31944

Original creator: @EnderWannabe

Original creation time: 2021-06-09 18:38:26

CC:  bhutz

Keywords: gsoc2021

Currently, attempting to use periodic points or preperiodic points to compute the scheme defining the minimal periodic or preperiodic points throws a Not Implemented error. We implement this functionality.

We also add a formal parameter to the periodic and preperiodic functions to facilitate the computation of the formal periodic or formal preperiodic points.


---

Comment by git created at 2021-06-11 18:29:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-15 17:29:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-15 17:30:38

Changing status from new to needs_review.


---

Comment by git created at 2021-06-22 18:10:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by bhutz created at 2021-06-24 14:34:12

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2021-06-24 14:34:12

All my versions of sage are compiling, so this is a code review only without functionality testing. It looks like there will be issues with subschemes.

- formal and dimension 1 are missing the subscheme equations in X

- f_deformed: this is now defined over projective space rather than the subscheme. So the X you eventually get does not include the defining equations of the subscheme. 

- This line is perhaps worth a comment

```
Ideal = f_deformed.preperiodic_points(m, n, return_scheme=True).defining_ideal()
```

that minimal=True and Formal=False does in fact get the formal periodic points for the deformed map (since all (relevant) multiplicities are 1).

- Don't capitalize the variable Ideal


- The same comments about subscheme issues for periodic points version.


- 31906 is included by not listed as a dependency. This doesn't really seem to be a dependency.


---

Comment by git created at 2021-06-24 16:32:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-24 16:32:32

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-06-25 18:20:02

I feel like I'm starting to repeat the same errors over and over again, so here is what I have so far.

- A non-minimal point appears

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
f=DynamicalSystem([x^2-z^2,y^2-21/16*z^2,z^2])
for Q in f.preperiodic_points(1,2,minimal=True,formal=False):
    print(Q, Q.is_preperiodic(f,return_period=True))
```


- line 4221: perhaps add the same comment as on 3897 as this looks redundant at first glance

```
R = f.base_ring()
```


- KeyError

```
P.<x,y>=ProjectiveSpace(QQ,1)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-1*y^2,y^2],domain=X)
F.periodic_points(2,formal=True)
```


- This is wrong:

```
P.<x,y>=ProjectiveSpace(QQ,1)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-3/4*y^2,y^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True)
```


Also wrong

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2+3/4*y^2,y^2,z^2],X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```


Also wrong:

```
P.<x,y,z>=ProjectiveSpace(GF(3),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```


- TypeError

```
P.<x,y,z>=ProjectiveSpace(GF(3),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],X)
F.periodic_points(1,minimal=True,formal=True,return_scheme=True).rational_points()
```


- This gives a TypeError, perhaps catch the good fields and give a more informative error message

```
P.<x,y,z>=ProjectiveSpace(RR,2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```


- Shouldn't this work?

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True)
```


- Why is there no 'c' in this?

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-c*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=False,formal=False,return_scheme=True)
```


But there is here

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-c*y^2,y^2,z^2])
F.periodic_points(2,minimal=False,formal=False,return_scheme=True)
```



---

Comment by bhutz created at 2021-06-25 18:20:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-25 21:54:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-25 21:55:11

Subschemes were very broken, I think because the nth iterate calculated for the subscheme might be very different. I pushed a fix that forgets about the subscheme, then adds the equations back in later. Hopefully that works better.

Function fields aren't implemented, as I don't think there is a flatening morphism for function fields. I added a nice error message.


---

Comment by @EnderWannabe created at 2021-06-25 21:55:19

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-06-28 20:52:28

You fixed most of the subscheme issues, but my first three comments are unaddressed.

Some additional comments on the new code:

- add `domain=PS` to be clear line 3906

```
f = DynamicalSystem(f.defining_polynomials())
```


- I don't understand why dom.defining_polynomials() is on this (3911-3912)

```
if formal and N == 2 and dom == PS:
    X = PS.subscheme([f.dynatomic_polynomial([m,n])] + list(dom.defining_polynomials()))
```


- Why are you using

```
list(X.defining_ideal().gens()
```

rather than

```
list(X.defining_polynomials())
```



---

Comment by git created at 2021-06-29 16:17:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-29 16:19:18

Replying to [comment:14 bhutz]:
> You fixed most of the subscheme issues, but my first three comments are unaddressed.

Latest push should address those, as well as the latest comments.


---

Comment by git created at 2021-07-06 17:17:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-06 22:34:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-09 16:32:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-09 16:42:38

Changing status from needs_review to needs_work.


---

Comment by @EnderWannabe created at 2021-07-09 16:42:38

Minimal seems to be broken for preperiodic points:


```
P.<x,y,z> = ProjectiveSpace(QQ, 2)
f = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])
K = f.preperiodic_points(1, 1, minimal=True, return_scheme=True)
K(P(0,0,1))
(0: 0: 1)
```


But (0:0:1) is a periodic point of period 1 (so it shouldn't be minimal of preperiod (1,1), right?). I'm not sure how to fix this, since


```
K2 = f.preperiodic_points(0, 1, minimal=False, return_scheme=True)
ideal = K.defining_ideal()
ideal2 = K2.defining_ideal()
ideal.saturation(ideal2)[0] == ideal
True
```


Saturation of ideals isn't removing the periodic point.


---

Comment by git created at 2021-07-09 19:42:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by bhutz created at 2021-07-12 19:09:08

The example:

```
P.<x,y,z> = ProjectiveSpace(QQ, 2)
f = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])
```

is not a morphism, so the theorem for the algorithm don't apply (because the variety of preperiodic points is not simply a finite union of points).

Do you have an example that is failing which is a morphism?


---

Comment by @EnderWannabe created at 2021-07-12 19:32:29

Changing status from needs_work to needs_review.


---

Comment by @EnderWannabe created at 2021-07-12 19:32:29

Replying to [comment:22 bhutz]:
> Do you have an example that is failing which is a morphism?

None that I can find. Good catch, thanks for pointing that out. This should be ready for review now.


---

Comment by git created at 2021-07-12 19:33:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-07-13 14:47:27

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2021-07-13 14:47:27

This looks good to me now.


---

Comment by bhutz created at 2021-07-13 15:09:07

Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True


---

Comment by bhutz created at 2021-07-13 15:09:07

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-07-13 16:02:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-13 16:02:16

Changing status from needs_work to needs_review.


---

Comment by @EnderWannabe created at 2021-07-13 16:02:16

Replying to [comment:26 bhutz]:
> Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True

Added


---

Comment by bhutz created at 2021-07-14 16:13:19

The non-morphism check is missed in this case

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
F=DynamicalSystem([x^2-y^2,z^2-y^2,x^2-z^2])
F.preperiodic_points(0,2,minimal=False,formal=True,return_scheme=True)
```


Also, found another weird case giving back the wrong answers

Here are the periods. It's not necessarily wrong that there are lower periods as there are many high multiplicity points here.

```
K=QQ
P.<x,y,z>=ProjectiveSpace(QQ,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=False):
    print(Q,F._is_preperiodic(Q,return_period=True))
```


Checking the multiplicities, we see that nothing is being subtracted out despite there being (1,1) points.

```
P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())


P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=False,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())

P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(1,1,minimal=False,formal=False,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())
```



- Perhaps there is just something weird when minimal=False and formal=True?


---

Comment by bhutz created at 2021-07-14 16:13:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-14 16:37:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-14 16:37:54

Replying to [comment:29 bhutz]:
> Also, found another weird case giving back the wrong answers

I updated the logic around minimal and formal, adding a check for if (m,n) != (0,1). But, I coded it as m != 0 and n != 1, so minimal and formal were being ignored when n = 1 or when m = 0.

Changed to m != 0 or n != 1.

I think the example you gave should work now, however, it hasn't finished running yet. It may never will, since it is actually doing the computations to find the formal scheme now


---

Comment by @EnderWannabe created at 2021-07-14 16:39:36

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-07-14 18:29:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-07-15 15:32:58

Yes, the formal=True is running now. The original example is not finishing, but I ran a shorter one with the same type of properties to check.


---

Comment by bhutz created at 2021-07-15 15:32:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-25 18:51:50

Resolution: fixed


---

Comment by vbraun created at 2021-08-01 08:49:20

This is creating random failures, I've created #32322
