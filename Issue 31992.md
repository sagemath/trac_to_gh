# Issue 31992: Asymptotic Ring BTerms: fix conversion

Issue created by migration from https://trac.sagemath.org/ticket/32229

Original creator: dkrenn

Original creation time: 2021-07-18 11:15:40

CC:  cheuberg behackl @thhagelmayer




---

Comment by git created at 2021-07-18 14:48:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-07-18 14:51:12

5 failing doctests:

1. `FutureWarning` (2 failing doctests), see review item 67 of #31933

2. Negative coefficients in `BTerm`s (2 failing doctests). How to solve this? Is (simply) taking absolute values an option?

3. Positional argument in failing doctests, see review item 73 of #31933.


---

Comment by dkrenn created at 2021-07-18 14:52:46

Changing status from new to needs_review.


---

Comment by dkrenn created at 2021-07-18 14:52:56

Changing status from needs_review to needs_work.


---

Comment by dkrenn created at 2021-07-18 14:53:32

Changing status from needs_work to needs_info.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by cheuberg created at 2021-08-02 19:14:21

Replying to [comment:3 dkrenn]:
> 2. Negative coefficients in `BTerm`s (2 failing doctests). How to solve this? Is (simply) taking absolute values an option?

I think that negative coefficients should be forbidden for B-Terms.


---

Comment by @thhagelmayer created at 2021-08-07 18:09:56

I merged tickets #32215 and #31933 which bumped the sage version to beta4. I also fixed the doctests which were failing after the merge.
----
Last 10 new commits:


---

Comment by behackl created at 2021-08-18 18:21:47

Replying to [comment:3 dkrenn]:
> 5 failing doctests:
> 
> 1. `FutureWarning` (2 failing doctests), see review item 67 of #31933
> 
> 2. Negative coefficients in `BTerm`s (2 failing doctests). How to solve this? Is (simply) taking absolute values an option?
> 
> 3. Positional argument in failing doctests, see review item 73 of #31933.

I believe that 1 and 3 are resolved in the meantime. Regarding 2 I also believe that upon creation of B-Terms, we should take the absolute value of the specified coefficient. That should be relatively easy to take care of; do we just need to adapt `BTerm.__init__`, or other places like `BTermMonoid._convert_construction_` (as indicated by the added TODO) as well?

EDIT: forgot to say: I've reviewed the code here, the implementation looks good to me (and the fact that #32278 works as intended is also a good indicator of the code here doing what it should).


---

Comment by @thhagelmayer created at 2021-08-19 16:34:09

I have reviewed the code and it looks good to me as well.


---

Comment by behackl created at 2021-08-20 09:23:43

I've merged the latest versions of #31933 and #32215, and then added another commit ensuring that we take the absolute value of the passed coefficient when constructing a BTerm. Needs review.
----
Last 10 new commits:


---

Comment by behackl created at 2021-08-20 09:23:43

Changing status from needs_info to needs_review.


---

Comment by @thhagelmayer created at 2021-08-20 16:17:15

I looked at the new changes. Looks good to me.


---

Comment by mmezzarobba created at 2021-09-02 12:28:17

I have just started playing with BTerms. They are a nice addition, thank you all for your work!

The way the validity condition gets lost here looks like a bug to me:

```
sage: n = SR.var('n')
sage: Asy = AsymptoticRing('QQ^n * n^ZZ', QQ)
sage: ET = Asy.term_monoid('exact')
sage: BT = Asy.term_monoid('B')
/home/marc/co/sage/local/lib/python3.9/site-packages/sage/structure/unique_representation.py:1007: FutureWarning: This class/method/function is marked as experimental. It, its functionality or its interface might change without a formal deprecation.
See https://trac.sagemath.org/31922 for details.
  instance = typecall(cls, *args, **options)
sage: bt = Asy(BT(n, valid_from={'n': 10})); bt
B(1.000000000000000*n, n >= 10)
sage: Asy(ET(2^n))*bt
B(1.000000000000000*2^n*n, n >= 0)
```

(This is with 9.5.beta0 + branch from this ticket.)
But maybe I am misunderstanding how BTerms are supposed to behave?


---

Comment by dkrenn created at 2021-09-02 12:42:39

Replying to [comment:16 mmezzarobba]:
> I have just started playing with BTerms. They are a nice addition, thank you all for your work!
> 
> The way the validity condition gets lost here looks like a bug to me:
> {{{
> sage: n = SR.var('n')
> sage: Asy = AsymptoticRing('QQ^n * n^ZZ', QQ)
> sage: ET = Asy.term_monoid('exact')
> sage: BT = Asy.term_monoid('B')
> /home/marc/co/sage/local/lib/python3.9/site-packages/sage/structure/unique_representation.py:1007: FutureWarning: This class/method/function is marked as experimental. It, its functionality or its interface might change without a formal deprecation.
> See https://trac.sagemath.org/31922 for details.
>   instance = typecall(cls, *args, **options)
> sage: bt = Asy(BT(n, valid_from={'n': 10})); bt
> B(1.000000000000000*n, n >= 10)
> sage: Asy(ET(2^n))*bt
> B(1.000000000000000*2^n*n, n >= 0)
> }}}
> (This is with 9.5.beta0 + branch from this ticket.)
> But maybe I am misunderstanding how BTerms are supposed to behave?

Indeed this is wrong. When I remember correctly, at the moment only polynomial terms are fully implemented (by #31933) and I would expect a `NotImplementedError` for the above.


---

Comment by behackl created at 2021-09-02 12:44:10

Changing status from needs_review to needs_work.


---

Comment by behackl created at 2021-09-02 12:44:10

Replying to [comment:16 mmezzarobba]:
> I have just started playing with BTerms. They are a nice addition, thank you all for your work!
> 
> The way the validity condition gets lost here looks like a bug to me:
> {{{
> sage: n = SR.var('n')
> sage: Asy = AsymptoticRing('QQ^n * n^ZZ', QQ)
> sage: ET = Asy.term_monoid('exact')
> sage: BT = Asy.term_monoid('B')
> /home/marc/co/sage/local/lib/python3.9/site-packages/sage/structure/unique_representation.py:1007: FutureWarning: This class/method/function is marked as experimental. It, its functionality or its interface might change without a formal deprecation.
> See https://trac.sagemath.org/31922 for details.
>   instance = typecall(cls, *args, **options)
> sage: bt = Asy(BT(n, valid_from={'n': 10})); bt
> B(1.000000000000000*n, n >= 10)
> sage: Asy(ET(2^n))*bt
> B(1.000000000000000*2^n*n, n >= 0)
> }}}
> (This is with 9.5.beta0 + branch from this ticket.)
> But maybe I am misunderstanding how BTerms are supposed to behave?

Hey! You are definitely right, multiplying BTerms apparently has some problems, I can reproduce it even in a simpler setting:


```
sage: AR.<n> = AsymptoticRing('n^QQ', QQ)
sage: AR.B(42*n, valid_from=3) * AR.B(n, valid_from=5)                                                                                                                                                         
B(42*n^2, n >= 0)
sage: AR.B(42*n, valid_from=3) * n                                                                                                                                                                             
B(42*n^2, n >= 0)
```


I'll investigate where things go wrong. Thanks for checking it out!


---

Comment by git created at 2021-09-02 16:26:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2021-09-02 16:28:18

Curiously, we simply had not implemented multiplication of `BTerms` so far. Now multiplication should respect the bounds; and I've also fixed  `BTermMonoid`s not coercing into `OTermMonoid`s.


---

Comment by behackl created at 2021-09-02 16:28:18

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2021-09-10 09:54:55

Also, I would expect absorption into B-terms to ignore non-growth factors in the absorbed term (and B-term creation to remove non-growth factors, like it replaces the coefficient by its absolute value); this does not seem to be the case. (Not sure if this is something for this ticket, nor if I have already reported it!)


---

Comment by mmezzarobba created at 2021-10-14 12:49:47

I have opened #32692 for the point about non-growth factors raised in my last previous comment.

There are several comments above along the lines of "I have reviewed the code up to this point at it looks good to me". _I_ have reviewed the two commits made in response to my comment, and they look good to me, but I am reluctant to set the ticket to positive review without input from people actually working on asymptotic expansions `:-)`.

What do you think? It there a reason to delay this ticket any longer?


---

Comment by @thhagelmayer created at 2021-10-14 14:45:56

Replying to [comment:22 mmezzarobba]:
> What do you think? It there a reason to delay this ticket any longer?
Sorry for the inconvenience, there is no reason to delay this ticket.

I have reviewed the implementation of multiplication for `BTerms`. LGTM.


---

Comment by @thhagelmayer created at 2021-10-14 14:45:56

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2021-10-14 15:04:22

Replying to [comment:23 gh-thhagelmayer]:
> Sorry for the inconvenience, there is no reason to delay this ticket.

No problem at all--and thank you!


---

Comment by vbraun created at 2021-12-05 11:21:41

Merge conflict


---

Comment by vbraun created at 2021-12-05 11:21:41

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-12-08 11:47:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2021-12-08 14:20:01

Changing status from needs_work to positive_review.


---

Comment by behackl created at 2021-12-08 14:20:01

Resolved conflict and tested locally, should be good now.


---

Comment by vbraun created at 2021-12-19 11:47:51

Resolution: fixed
