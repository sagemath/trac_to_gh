# Issue 27840: shortest_path() goes through remains of deleted DiGraph edges

archive/issues_027840.json:
```json
{
    "body": "CC:  @rajat1433\n\nKeywords: digraph\n\nI am adding an edge twice\u00b9 to a (non-multiedge) DiGraph. It shows up only once in the edge list, the second label overwrites the first.  \nThen I am deleting the edge, and it no longer shows up in the edge list.  \nHowever, when calculating the shortest path the edge is still visited.\n\n```python\n## Minimum repro\nd = DiGraph(multiedges=False)\nd.add_edge(1, 2, 'A')\n# d.plot(edge_labels=True, save_pos=True).show()\n# print(d.edges())\nd.add_edge(1, 2, 'B')\n# print(d.edges())\nd.delete_edge(1, 2)\n# print(d.edges())\n# d.plot(edge_labels=True).show()\nd.shortest_path(1, 2) # result: [1,2], expected: []\n```\n\nI would expect `add_edge` and `delete_edge` to be idempotent - when an edge already exists, it should not get added again (ignoring labels for now), when an edge doesn't exist, deleting it should do nothing. Instead, I need to write `if not graph.has_edge(e): graph.add_edge(e)`.\n\nI'm using [SageMath](SageMath) version 8.6, Release Date: 2019-01-15, with Python 2.7.15 in a Jupyter notebook, on Win7 64bit.\n\n(1: when flow changes in a network, I update the residual graph by putting edges with flow > 0 and removing those with flow <= 0 - regardless whether the edge already exists or not.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/28077\n\n",
    "created_at": "2019-06-28T12:44:25Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "title": "shortest_path() goes through remains of deleted DiGraph edges",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27840",
    "user": "@bergus"
}
```
CC:  @rajat1433

Keywords: digraph

I am adding an edge twiceÂ¹ to a (non-multiedge) DiGraph. It shows up only once in the edge list, the second label overwrites the first.  
Then I am deleting the edge, and it no longer shows up in the edge list.  
However, when calculating the shortest path the edge is still visited.

```python
## Minimum repro
d = DiGraph(multiedges=False)
d.add_edge(1, 2, 'A')
# d.plot(edge_labels=True, save_pos=True).show()
# print(d.edges())
d.add_edge(1, 2, 'B')
# print(d.edges())
d.delete_edge(1, 2)
# print(d.edges())
# d.plot(edge_labels=True).show()
d.shortest_path(1, 2) # result: [1,2], expected: []
```

I would expect `add_edge` and `delete_edge` to be idempotent - when an edge already exists, it should not get added again (ignoring labels for now), when an edge doesn't exist, deleting it should do nothing. Instead, I need to write `if not graph.has_edge(e): graph.add_edge(e)`.

I'm using [SageMath](SageMath) version 8.6, Release Date: 2019-01-15, with Python 2.7.15 in a Jupyter notebook, on Win7 64bit.

(1: when flow changes in a network, I update the residual graph by putting edges with flow > 0 and removing those with flow <= 0 - regardless whether the edge already exists or not.)

Issue created by migration from https://trac.sagemath.org/ticket/28077





---

archive/issue_comments_393200.json:
```json
{
    "body": "Set assignee to @hensc.",
    "created_at": "2019-07-01T15:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393200",
    "user": "@hensc"
}
```

Set assignee to @hensc.



---

archive/issue_comments_393201.json:
```json
{
    "body": "I could fix the bug, but I'm not able to push the new version to trac.\n\n\n\n```\n$ git trac push 28077\nPushing to Trac #28077...\nGuessed remote branch: u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges\nTraceback (most recent call last):\n  File \"/home/hendrik/bin/git-trac\", line 17, in <module>\n    cmdline.launch()\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/cmdline.py\", line 228, in launch\n    app.push(ticket_number, remote=args.remote, force=args.force)\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/app.py\", line 218, in push\n    self.repo.push(remote, force)\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/git_repository.py\", line 196, in push\n    self.git.echo.push('trac', refspec)\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py\", line 340, in meth\n    return self.execute(git_cmd, *args, **kwds)\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py\", line 97, in execute\n    popen_stderr=subprocess.PIPE)\n  File \"/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py\", line 262, in _run\n    raise GitError(result)\ngit_trac.git_error.GitError: git returned with non-zero exit code (1) when executing \"git push trac HEAD:refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges\"\n    STDERR: remote: FATAL: W refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges sage gh-hensc DENIED by fallthru\n    STDERR: remote: error: hook declined to update refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges\n    STDERR: To trac.sagemath.org:sage.git\n    STDERR:  ! [remote rejected]       HEAD -> u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges (hook declined)\n    STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'\n```\n\n\nI'm a first-timer, so I've never made it work. I'm sorry for the inconvenience, but I hope someone can help me.",
    "created_at": "2019-07-01T15:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393201",
    "user": "@hensc"
}
```

I could fix the bug, but I'm not able to push the new version to trac.



```
$ git trac push 28077
Pushing to Trac #28077...
Guessed remote branch: u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges
Traceback (most recent call last):
  File "/home/hendrik/bin/git-trac", line 17, in <module>
    cmdline.launch()
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/cmdline.py", line 228, in launch
    app.push(ticket_number, remote=args.remote, force=args.force)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/app.py", line 218, in push
    self.repo.push(remote, force)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_repository.py", line 196, in push
    self.git.echo.push('trac', refspec)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 340, in meth
    return self.execute(git_cmd, *args, **kwds)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 97, in execute
    popen_stderr=subprocess.PIPE)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 262, in _run
    raise GitError(result)
git_trac.git_error.GitError: git returned with non-zero exit code (1) when executing "git push trac HEAD:refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges"
    STDERR: remote: FATAL: W refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges sage gh-hensc DENIED by fallthru
    STDERR: remote: error: hook declined to update refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges
    STDERR: To trac.sagemath.org:sage.git
    STDERR:  ! [remote rejected]       HEAD -> u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges (hook declined)
    STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```


I'm a first-timer, so I've never made it work. I'm sorry for the inconvenience, but I hope someone can help me.



---

archive/issue_comments_393202.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-07-01T15:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393202",
    "user": "@hensc"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_393203.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-01T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393203",
    "user": "@hensc"
}
```

New commits:



---

archive/issue_comments_393204.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-07-01T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393204",
    "user": "@hensc"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_393205.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-01T19:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393205",
    "user": "@hensc"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_393206.json:
```json
{
    "body": "Welcome to Sagemath.\n\nThis is a very good catch. Actually, we also have:\n\n```\nsage: d = DiGraph(multiedges=False)\nsage: d.add_edge(1, 2, 'B')\nsage: d.delete_edge(1, 2, 'B')\nsage: d.incoming_edges(2)\n[]\nsage: d.add_edge(1, 2, 'B')\nsage: d.add_edge(1, 2, 'B')\nsage: d.delete_edge(1, 2, 'B')\nsage: d.incoming_edges(2)\n[(1, 2, None)]\n```\n\nYou should add a doctest to show that the bug is fixed with a link to this ticket (`:trac:`28077``).",
    "created_at": "2019-07-02T07:02:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393206",
    "user": "dcoudert"
}
```

Welcome to Sagemath.

This is a very good catch. Actually, we also have:

```
sage: d = DiGraph(multiedges=False)
sage: d.add_edge(1, 2, 'B')
sage: d.delete_edge(1, 2, 'B')
sage: d.incoming_edges(2)
[]
sage: d.add_edge(1, 2, 'B')
sage: d.add_edge(1, 2, 'B')
sage: d.delete_edge(1, 2, 'B')
sage: d.incoming_edges(2)
[(1, 2, None)]
```

You should add a doctest to show that the bug is fixed with a link to this ticket (`:trac:`28077``).



---

archive/issue_comments_393207.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-02T09:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393207",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393208.json:
```json
{
    "body": "When debugging I recognized another bug:\nIn the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.\n\nShould I open a new ticket for that or do it in this ticket?",
    "created_at": "2019-07-02T10:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393208",
    "user": "@hensc"
}
```

When debugging I recognized another bug:
In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.

Should I open a new ticket for that or do it in this ticket?



---

archive/issue_comments_393209.json:
```json
{
    "body": "This error is corrected in #27859.\nI let you check with Rajat.",
    "created_at": "2019-07-02T11:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393209",
    "user": "dcoudert"
}
```

This error is corrected in #27859.
I let you check with Rajat.



---

archive/issue_comments_393210.json:
```json
{
    "body": "Replying to [comment:12 gh-hensc]:\n> When debugging I recognized another bug:\n> In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.\n> \n> Should I open a new ticket for that or do it in this ticket?\n\nCould you provide an example of the scenario you are describing?",
    "created_at": "2019-07-02T11:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393210",
    "user": "@rajat1433"
}
```

Replying to [comment:12 gh-hensc]:
> When debugging I recognized another bug:
> In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.
> 
> Should I open a new ticket for that or do it in this ticket?

Could you provide an example of the scenario you are describing?



---

archive/issue_comments_393211.json:
```json
{
    "body": "`@`Rajat: I think it corresponds to the case you fixed in `c_graph.pyx` with\n\n```diff\n         if x == y:\n-            return 0\n+            if distance_flag:\n+                return 0\n+            else:\n+                return [x]\n```\n",
    "created_at": "2019-07-02T11:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393211",
    "user": "dcoudert"
}
```

`@`Rajat: I think it corresponds to the case you fixed in `c_graph.pyx` with

```diff
         if x == y:
-            return 0
+            if distance_flag:
+                return 0
+            else:
+                return [x]
```




---

archive/issue_comments_393212.json:
```json
{
    "body": "but this was the case when src and target vertices were same but gh-hensc is describing a scenario when there is no path between src and target so I was guessing maybe there is some other case...",
    "created_at": "2019-07-02T11:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393212",
    "user": "@rajat1433"
}
```

but this was the case when src and target vertices were same but gh-hensc is describing a scenario when there is no path between src and target so I was guessing maybe there is some other case...



---

archive/issue_comments_393213.json:
```json
{
    "body": "Let's wait for his answer then.",
    "created_at": "2019-07-02T11:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393213",
    "user": "dcoudert"
}
```

Let's wait for his answer then.



---

archive/issue_comments_393214.json:
```json
{
    "body": "Replying to [comment:14 gh-rajat1433]:\n> Replying to [comment:12 gh-hensc]:\n> > When debugging I recognized another bug:\n> > In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.\n> > \n> > Should I open a new ticket for that or do it in this ticket?\n> \n> Could you provide an example of the scenario you are describing?\n\n\n```python\nsage: d = DiGraph()\nsage: d.add_vertices([1, 2])\nsage: d.shortest_path(1, 2, algorithm='BFS')\n      # result: KeyError, expected: []\nsage: d.shortest_path(1, 2, algorithm='Dijkstra_NetworkX')\n      # result: KeyError, expected: []\nsage: d.shortest_path(1, 2, algorithm='Dijkstra_Bid_NetworkX')\n      # result: NetworkXNoPath, expected: []\nsage: d.shortest_path(1, 2, algorithm='Bellman-Ford_Boost')\n      # result: KeyError, expected: []\n```\n",
    "created_at": "2019-07-02T11:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393214",
    "user": "@hensc"
}
```

Replying to [comment:14 gh-rajat1433]:
> Replying to [comment:12 gh-hensc]:
> > When debugging I recognized another bug:
> > In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.
> > 
> > Should I open a new ticket for that or do it in this ticket?
> 
> Could you provide an example of the scenario you are describing?


```python
sage: d = DiGraph()
sage: d.add_vertices([1, 2])
sage: d.shortest_path(1, 2, algorithm='BFS')
      # result: KeyError, expected: []
sage: d.shortest_path(1, 2, algorithm='Dijkstra_NetworkX')
      # result: KeyError, expected: []
sage: d.shortest_path(1, 2, algorithm='Dijkstra_Bid_NetworkX')
      # result: NetworkXNoPath, expected: []
sage: d.shortest_path(1, 2, algorithm='Bellman-Ford_Boost')
      # result: KeyError, expected: []
```




---

archive/issue_comments_393215.json:
```json
{
    "body": "I think that is something we can improve upon. I think it will be a good idea to open a new ticket to fix this.",
    "created_at": "2019-07-02T13:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393215",
    "user": "@rajat1433"
}
```

I think that is something we can improve upon. I think it will be a good idea to open a new ticket to fix this.



---

archive/issue_comments_393216.json:
```json
{
    "body": "I opened ticket #28098 to fix this.",
    "created_at": "2019-07-02T18:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393216",
    "user": "@hensc"
}
```

I opened ticket #28098 to fix this.



---

archive/issue_comments_393217.json:
```json
{
    "body": "Wow, thanks for fixing this so quickly!",
    "created_at": "2019-07-03T21:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393217",
    "user": "@bergus"
}
```

Wow, thanks for fixing this so quickly!



---

archive/issue_comments_393218.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2019-07-04T17:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393218",
    "user": "dcoudert"
}
```

Looks good to me.



---

archive/issue_comments_393219.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-04T17:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393219",
    "user": "dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393220.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-05T15:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-393220",
    "user": "vbraun"
}
```

Resolution: fixed
