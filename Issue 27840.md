# Issue 27840: shortest_path() goes through remains of deleted DiGraph edges

Issue created by migration from https://trac.sagemath.org/ticket/28077

Original creator: @bergus

Original creation time: 2019-06-28 12:44:25

CC:  @rajat1433

Keywords: digraph

I am adding an edge twiceÂ¹ to a (non-multiedge) DiGraph. It shows up only once in the edge list, the second label overwrites the first.  
Then I am deleting the edge, and it no longer shows up in the edge list.  
However, when calculating the shortest path the edge is still visited.

```python
## Minimum repro
d = DiGraph(multiedges=False)
d.add_edge(1, 2, 'A')
# d.plot(edge_labels=True, save_pos=True).show()
# print(d.edges())
d.add_edge(1, 2, 'B')
# print(d.edges())
d.delete_edge(1, 2)
# print(d.edges())
# d.plot(edge_labels=True).show()
d.shortest_path(1, 2) # result: [1,2], expected: []
```

I would expect `add_edge` and `delete_edge` to be idempotent - when an edge already exists, it should not get added again (ignoring labels for now), when an edge doesn't exist, deleting it should do nothing. Instead, I need to write `if not graph.has_edge(e): graph.add_edge(e)`.

I'm using [SageMath](SageMath) version 8.6, Release Date: 2019-01-15, with Python 2.7.15 in a Jupyter notebook, on Win7 64bit.

(1: when flow changes in a network, I update the residual graph by putting edges with flow > 0 and removing those with flow <= 0 - regardless whether the edge already exists or not.)


---

Comment by @hensc created at 2019-07-01 15:00:09

Set assignee to @hensc.


---

Comment by @hensc created at 2019-07-01 15:10:44

I could fix the bug, but I'm not able to push the new version to trac.



```
$ git trac push 28077
Pushing to Trac #28077...
Guessed remote branch: u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges
Traceback (most recent call last):
  File "/home/hendrik/bin/git-trac", line 17, in <module>
    cmdline.launch()
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/cmdline.py", line 228, in launch
    app.push(ticket_number, remote=args.remote, force=args.force)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/app.py", line 218, in push
    self.repo.push(remote, force)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_repository.py", line 196, in push
    self.git.echo.push('trac', refspec)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 340, in meth
    return self.execute(git_cmd, *args, **kwds)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 97, in execute
    popen_stderr=subprocess.PIPE)
  File "/home/hendrik/sage-dev/git-trac-command/git_trac/git_interface.py", line 262, in _run
    raise GitError(result)
git_trac.git_error.GitError: git returned with non-zero exit code (1) when executing "git push trac HEAD:refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges"
    STDERR: remote: FATAL: W refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges sage gh-hensc DENIED by fallthru
    STDERR: remote: error: hook declined to update refs/heads/u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges
    STDERR: To trac.sagemath.org:sage.git
    STDERR:  ! [remote rejected]       HEAD -> u/hensc/shortest_path___goes_through_remains_of_deleted_digraph_edges (hook declined)
    STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```


I'm a first-timer, so I've never made it work. I'm sorry for the inconvenience, but I hope someone can help me.


---

Comment by @hensc created at 2019-07-01 15:37:53

Changing status from new to needs_info.


---

Comment by @hensc created at 2019-07-01 19:29:39

New commits:


---

Comment by @hensc created at 2019-07-01 19:29:39

Changing status from needs_info to needs_work.


---

Comment by @hensc created at 2019-07-01 19:34:10

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2019-07-02 07:02:34

Welcome to Sagemath.

This is a very good catch. Actually, we also have:

```
sage: d = DiGraph(multiedges=False)
sage: d.add_edge(1, 2, 'B')
sage: d.delete_edge(1, 2, 'B')
sage: d.incoming_edges(2)
[]
sage: d.add_edge(1, 2, 'B')
sage: d.add_edge(1, 2, 'B')
sage: d.delete_edge(1, 2, 'B')
sage: d.incoming_edges(2)
[(1, 2, None)]
```

You should add a doctest to show that the bug is fixed with a link to this ticket (`:trac:`28077``).


---

Comment by git created at 2019-07-02 09:52:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @hensc created at 2019-07-02 10:05:42

When debugging I recognized another bug:
In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.

Should I open a new ticket for that or do it in this ticket?


---

Comment by dcoudert created at 2019-07-02 11:00:22

This error is corrected in #27859.
I let you check with Rajat.


---

Comment by @rajat1433 created at 2019-07-02 11:24:20

Replying to [comment:12 gh-hensc]:
> When debugging I recognized another bug:
> In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.
> 
> Should I open a new ticket for that or do it in this ticket?

Could you provide an example of the scenario you are describing?


---

Comment by dcoudert created at 2019-07-02 11:26:53

`@`Rajat: I think it corresponds to the case you fixed in `c_graph.pyx` with

```diff
         if x == y:
-            return 0
+            if distance_flag:
+                return 0
+            else:
+                return [x]
```



---

Comment by @rajat1433 created at 2019-07-02 11:32:25

but this was the case when src and target vertices were same but gh-hensc is describing a scenario when there is no path between src and target so I was guessing maybe there is some other case...


---

Comment by dcoudert created at 2019-07-02 11:36:13

Let's wait for his answer then.


---

Comment by @hensc created at 2019-07-02 11:50:32

Replying to [comment:14 gh-rajat1433]:
> Replying to [comment:12 gh-hensc]:
> > When debugging I recognized another bug:
> > In the documentation of `shortest_path` in `generic_graph.py` it says that an empty list is returned if there is no path between the two vertices. This is correct for the default algorithm but not for most of the other algorithms you can choose.
> > 
> > Should I open a new ticket for that or do it in this ticket?
> 
> Could you provide an example of the scenario you are describing?


```python
sage: d = DiGraph()
sage: d.add_vertices([1, 2])
sage: d.shortest_path(1, 2, algorithm='BFS')
      # result: KeyError, expected: []
sage: d.shortest_path(1, 2, algorithm='Dijkstra_NetworkX')
      # result: KeyError, expected: []
sage: d.shortest_path(1, 2, algorithm='Dijkstra_Bid_NetworkX')
      # result: NetworkXNoPath, expected: []
sage: d.shortest_path(1, 2, algorithm='Bellman-Ford_Boost')
      # result: KeyError, expected: []
```



---

Comment by @rajat1433 created at 2019-07-02 13:13:11

I think that is something we can improve upon. I think it will be a good idea to open a new ticket to fix this.


---

Comment by @hensc created at 2019-07-02 18:58:06

I opened ticket #28098 to fix this.


---

Comment by @bergus created at 2019-07-03 21:03:37

Wow, thanks for fixing this so quickly!


---

Comment by dcoudert created at 2019-07-04 17:02:52

Looks good to me.


---

Comment by dcoudert created at 2019-07-04 17:02:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-05 15:29:17

Resolution: fixed
