# Issue 19726: Build documentation in $SAGE_LOCAL/share/doc/sage

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-01-26 14:37:12

CC:  hivert mmezzarobba




---

Comment by jdemeyer created at 2016-01-27 10:22:24

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-01-27 10:22:24

New commits:


---

Comment by git created at 2016-01-27 10:28:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-28 22:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2016-02-02 10:58:44

This will break the “Help” links in the (classic) notebook, won't it? More generally, though I entirely agree with the goal of this ticket, I'm not sure people like the change. Wouldn't it be possible to keep a compatibility symlink or something? Also, several places in the documentation (starting with `README.txt`) explicitly refer the reader to `src/doc/output`.


---

Comment by mmezzarobba created at 2016-02-02 10:58:44

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2016-02-04 13:47:29

Yeah, I'm not sure exactly what the necessity of this is.  At the very least it would be something where "deprecation" would be useful?


---

Comment by jdemeyer created at 2016-02-04 15:02:49

Replying to [comment:7 kcrisman]:
> I'm not sure exactly what the necessity of this is.

Everything which is compiled/built/installed in the Sage distribution ends up in `$SAGE_LOCAL`... except the documentation. So it's logical to put the built documentation in `$SAGE_LOCAL` too.

> At the very least it would be something where "deprecation" would be useful?

Well, you cannot really deprecate filesystem paths. But a symbolic link can be done indeed.


---

Comment by git created at 2016-02-04 17:06:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-02-04 17:07:11

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-02-06 10:44:44

Replying to [comment:6 mmezzarobba]:
> This will break the “Help” links in the (classic) notebook, won't it?

Fixed in https://github.com/sagemath/sagenb/pull/363


---

Comment by fbissey created at 2016-02-08 08:42:02

I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.


---

Comment by jdemeyer created at 2016-02-08 12:29:33

Replying to [comment:12 fbissey]:
> I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.

I will change the variable names on this ticket if somebody commits to reviewing this ticket then.


---

Comment by fbissey created at 2016-02-09 02:24:04

I am going through the changes in #19127 first. You made it incredibly difficult to build the documentation before having installed sage at all. Unless I was lucky before (possible but unlikely considering the amount of stuff that can go wrong) that's a regression as far as I am concerned. But it is too late for this in that ticket or this ticket.

The code here looks ok to me, it is mostly house keeping.

The html and the pdf documentations are moved to a new home and only the `rst` file are left behind. The only mention left of `SAGE_DOC` in the current form is in `sage/misc/sagedoc.py`, possibly too hard for this ticket but if it is only for building at least some parts of `sagedoc.py` could/should be moved to `sage_setup/docbuild`.
There is also some mention of `SAGE_DOC` and `SAGE_DOC/output` in `sage/misc/latex_macros.py`. Only in documentation and comment blocks. At least two of these should be replaced by `SAGE_DOC_OUTPUT`, the first instance is to quote a path in sage's source tree. Ultimately this should be shipped too in my opinion but at this stage is the only instance of `SAGE_DOC` that is not superfluous once that sage is installed - outside of `sage_setup/docbuild`.


---

Comment by fbissey created at 2016-02-09 02:49:18

In `sage_setup/docbuild/__init__.py` we currently have at line 101 and after

```
        if 'output/html' in output_dir:
            logger.warning("Build finished. The built documents can be found in %s",
                           output_dir)
        elif 'output/pdf' not in output_dir:
            logger.info("Build finished. The built documents can be found in %s",
                           output_dir)
        else:
            logger.info("LaTeX file written to %s; now making PDF.",
                           output_dir)
```

Will we ever see a message "Build finished. The built documents can be found in..." again?


---

Comment by jhpalmieri created at 2016-02-09 03:58:46

> You made it incredibly difficult to build the documentation before having installed sage at all. 

When was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.


---

Comment by fbissey created at 2016-02-09 04:10:38

Replying to [comment:16 jhpalmieri]:
> > You made it incredibly difficult to build the documentation before having installed sage at all. 
> 
> When was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.

Of course `sphinx` was installed. I meant the sage library itself. And yes it was possible, may still be possible with a bit of care. What happens technically is that the docbuilding itself only needs to go through sage's sources, and if you don't call anything from cythonized modules during the building process itself, you don't need anything but the sources. You started to import cythonized stuff (`cachefunc` for starters) and things just broke. It look like you can do stuff from `build/lib` but attention to details is required.


---

Comment by fbissey created at 2016-02-09 04:14:18

Sorry John, I thought that was from Jeroen.


---

Comment by jdemeyer created at 2016-02-09 07:31:37

Replying to [comment:17 fbissey]:
> And yes it was possible

Doesn't autodoc import the modules that it builds the documentation of, to determine `__doc__`? If so, there is no way to build the Sage documentation without building Sage first.


---

Comment by jdemeyer created at 2016-02-09 07:33:42

Replying to [comment:17 fbissey]:
> You started to import cythonized stuff (`cachefunc` for starters)

No, the Sage docbuilder has always used `cachefunc`, that is nothing new.


---

Comment by jdemeyer created at 2016-02-09 07:34:22

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2016-02-09 07:36:45

Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 fbissey]:
> > You started to import cythonized stuff (`cachefunc` for starters)
> 
> No, the Sage docbuilder has always used `cachefunc`, that is nothing new.

Let's not get into this any more and finish this ticket. I may be looking for something stupid.


---

Comment by git created at 2016-02-09 16:15:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-02-09 16:15:50

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-02-09 20:29:08

I am happy with that. Anything further will be for a follow up ticket. And once the PR to `sagenb` is included in a release we should remove the creation of links to the old location. `sagenb` is really the only thing that currently depends on it.


---

Comment by fbissey created at 2016-02-09 20:29:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-02-10 08:20:52

Resolution: fixed


---

Comment by jhpalmieri created at 2016-02-11 22:18:50

For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?


---

Comment by fbissey created at 2016-02-12 01:28:43

Replying to [comment:27 jhpalmieri]:
> For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?

That would be a good idea I would say. Not quite on the top of my laundry list. But if we want to discuss those matters, it shouldn't be on this ticket.


---

Comment by jdemeyer created at 2016-02-12 08:59:11

Old docs are deleted, see `src/sage_setup/docbuild/__main__.py`:

```
    if os.path.exists(old_doc):
        from shutil import rmtree
        rmtree(old_doc)
```

