# Issue 19726: Build documentation in $SAGE_LOCAL/share/doc/sage

archive/issues_019726.json:
```json
{
    "body": "CC:  @hivert @mezzarobba\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19963\n\n",
    "created_at": "2016-01-26T14:37:12Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Build documentation in $SAGE_LOCAL/share/doc/sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19726",
    "user": "@jdemeyer"
}
```
CC:  @hivert @mezzarobba



Issue created by migration from https://trac.sagemath.org/ticket/19963





---

archive/issue_comments_271137.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-27T10:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271137",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_271138.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-01-27T10:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271138",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_271139.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-27T10:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271139",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_271140.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-28T22:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271140",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_271141.json:
```json
{
    "body": "This will break the \u201cHelp\u201d links in the (classic) notebook, won't it? More generally, though I entirely agree with the goal of this ticket, I'm not sure people like the change. Wouldn't it be possible to keep a compatibility symlink or something? Also, several places in the documentation (starting with `README.txt`) explicitly refer the reader to `src/doc/output`.",
    "created_at": "2016-02-02T10:58:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271141",
    "user": "@mezzarobba"
}
```

This will break the “Help” links in the (classic) notebook, won't it? More generally, though I entirely agree with the goal of this ticket, I'm not sure people like the change. Wouldn't it be possible to keep a compatibility symlink or something? Also, several places in the documentation (starting with `README.txt`) explicitly refer the reader to `src/doc/output`.



---

archive/issue_comments_271142.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-02-02T10:58:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271142",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_271143.json:
```json
{
    "body": "Yeah, I'm not sure exactly what the necessity of this is.  At the very least it would be something where \"deprecation\" would be useful?",
    "created_at": "2016-02-04T13:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271143",
    "user": "@kcrisman"
}
```

Yeah, I'm not sure exactly what the necessity of this is.  At the very least it would be something where "deprecation" would be useful?



---

archive/issue_comments_271144.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n> I'm not sure exactly what the necessity of this is.\n\nEverything which is compiled/built/installed in the Sage distribution ends up in `$SAGE_LOCAL`... except the documentation. So it's logical to put the built documentation in `$SAGE_LOCAL` too.\n\n> At the very least it would be something where \"deprecation\" would be useful?\n\nWell, you cannot really deprecate filesystem paths. But a symbolic link can be done indeed.",
    "created_at": "2016-02-04T15:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271144",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 kcrisman]:
> I'm not sure exactly what the necessity of this is.

Everything which is compiled/built/installed in the Sage distribution ends up in `$SAGE_LOCAL`... except the documentation. So it's logical to put the built documentation in `$SAGE_LOCAL` too.

> At the very least it would be something where "deprecation" would be useful?

Well, you cannot really deprecate filesystem paths. But a symbolic link can be done indeed.



---

archive/issue_comments_271145.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-04T17:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271145",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_271146.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-02-04T17:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271146",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_271147.json:
```json
{
    "body": "Replying to [comment:6 mmezzarobba]:\n> This will break the \u201cHelp\u201d links in the (classic) notebook, won't it?\n\nFixed in https://github.com/sagemath/sagenb/pull/363",
    "created_at": "2016-02-06T10:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271147",
    "user": "@jdemeyer"
}
```

Replying to [comment:6 mmezzarobba]:
> This will break the “Help” links in the (classic) notebook, won't it?

Fixed in https://github.com/sagemath/sagenb/pull/363



---

archive/issue_comments_271148.json:
```json
{
    "body": "I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.",
    "created_at": "2016-02-08T08:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271148",
    "user": "@kiwifb"
}
```

I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.



---

archive/issue_comments_271149.json:
```json
{
    "body": "Replying to [comment:12 fbissey]:\n> I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.\n\nI will change the variable names on this ticket if somebody commits to reviewing this ticket then.",
    "created_at": "2016-02-08T12:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271149",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 fbissey]:
> I am unfortunately taking this train after it left the station. I guess the code re-organisation had to happen in #19127 and all. But what a choice of variable names. Seriously `SAGE_DOC_OUTPUT`? Yes I can see where it came from. But seriously I expect my doc to be found under `SAGE_DOC` not `SAGE_DOC_OUTPUT`, that's the natural name to use. The other one could have been `SAGE_DOC_SRC`, and if it isn't used after install I am not sure I would bother putting it in `env.py`.

I will change the variable names on this ticket if somebody commits to reviewing this ticket then.



---

archive/issue_comments_271150.json:
```json
{
    "body": "I am going through the changes in #19127 first. You made it incredibly difficult to build the documentation before having installed sage at all. Unless I was lucky before (possible but unlikely considering the amount of stuff that can go wrong) that's a regression as far as I am concerned. But it is too late for this in that ticket or this ticket.\n\nThe code here looks ok to me, it is mostly house keeping.\n\nThe html and the pdf documentations are moved to a new home and only the `rst` file are left behind. The only mention left of `SAGE_DOC` in the current form is in `sage/misc/sagedoc.py`, possibly too hard for this ticket but if it is only for building at least some parts of `sagedoc.py` could/should be moved to `sage_setup/docbuild`.\nThere is also some mention of `SAGE_DOC` and `SAGE_DOC/output` in `sage/misc/latex_macros.py`. Only in documentation and comment blocks. At least two of these should be replaced by `SAGE_DOC_OUTPUT`, the first instance is to quote a path in sage's source tree. Ultimately this should be shipped too in my opinion but at this stage is the only instance of `SAGE_DOC` that is not superfluous once that sage is installed - outside of `sage_setup/docbuild`.",
    "created_at": "2016-02-09T02:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271150",
    "user": "@kiwifb"
}
```

I am going through the changes in #19127 first. You made it incredibly difficult to build the documentation before having installed sage at all. Unless I was lucky before (possible but unlikely considering the amount of stuff that can go wrong) that's a regression as far as I am concerned. But it is too late for this in that ticket or this ticket.

The code here looks ok to me, it is mostly house keeping.

The html and the pdf documentations are moved to a new home and only the `rst` file are left behind. The only mention left of `SAGE_DOC` in the current form is in `sage/misc/sagedoc.py`, possibly too hard for this ticket but if it is only for building at least some parts of `sagedoc.py` could/should be moved to `sage_setup/docbuild`.
There is also some mention of `SAGE_DOC` and `SAGE_DOC/output` in `sage/misc/latex_macros.py`. Only in documentation and comment blocks. At least two of these should be replaced by `SAGE_DOC_OUTPUT`, the first instance is to quote a path in sage's source tree. Ultimately this should be shipped too in my opinion but at this stage is the only instance of `SAGE_DOC` that is not superfluous once that sage is installed - outside of `sage_setup/docbuild`.



---

archive/issue_comments_271151.json:
```json
{
    "body": "In `sage_setup/docbuild/__init__.py` we currently have at line 101 and after\n\n```\n        if 'output/html' in output_dir:\n            logger.warning(\"Build finished. The built documents can be found in %s\",\n                           output_dir)\n        elif 'output/pdf' not in output_dir:\n            logger.info(\"Build finished. The built documents can be found in %s\",\n                           output_dir)\n        else:\n            logger.info(\"LaTeX file written to %s; now making PDF.\",\n                           output_dir)\n```\n\nWill we ever see a message \"Build finished. The built documents can be found in...\" again?",
    "created_at": "2016-02-09T02:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271151",
    "user": "@kiwifb"
}
```

In `sage_setup/docbuild/__init__.py` we currently have at line 101 and after

```
        if 'output/html' in output_dir:
            logger.warning("Build finished. The built documents can be found in %s",
                           output_dir)
        elif 'output/pdf' not in output_dir:
            logger.info("Build finished. The built documents can be found in %s",
                           output_dir)
        else:
            logger.info("LaTeX file written to %s; now making PDF.",
                           output_dir)
```

Will we ever see a message "Build finished. The built documents can be found in..." again?



---

archive/issue_comments_271152.json:
```json
{
    "body": "> You made it incredibly difficult to build the documentation before having installed sage at all. \n\nWhen was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.",
    "created_at": "2016-02-09T03:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271152",
    "user": "@jhpalmieri"
}
```

> You made it incredibly difficult to build the documentation before having installed sage at all. 

When was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.



---

archive/issue_comments_271153.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> > You made it incredibly difficult to build the documentation before having installed sage at all. \n> \n> When was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.\n\nOf course `sphinx` was installed. I meant the sage library itself. And yes it was possible, may still be possible with a bit of care. What happens technically is that the docbuilding itself only needs to go through sage's sources, and if you don't call anything from cythonized modules during the building process itself, you don't need anything but the sources. You started to import cythonized stuff (`cachefunc` for starters) and things just broke. It look like you can do stuff from `build/lib` but attention to details is required.",
    "created_at": "2016-02-09T04:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271153",
    "user": "@kiwifb"
}
```

Replying to [comment:16 jhpalmieri]:
> > You made it incredibly difficult to build the documentation before having installed sage at all. 
> 
> When was this ever possible? Certainly Sphinx needs to be installed, and docbuilding also reads parts (or all?) of the Sage library.

Of course `sphinx` was installed. I meant the sage library itself. And yes it was possible, may still be possible with a bit of care. What happens technically is that the docbuilding itself only needs to go through sage's sources, and if you don't call anything from cythonized modules during the building process itself, you don't need anything but the sources. You started to import cythonized stuff (`cachefunc` for starters) and things just broke. It look like you can do stuff from `build/lib` but attention to details is required.



---

archive/issue_comments_271154.json:
```json
{
    "body": "Sorry John, I thought that was from Jeroen.",
    "created_at": "2016-02-09T04:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271154",
    "user": "@kiwifb"
}
```

Sorry John, I thought that was from Jeroen.



---

archive/issue_comments_271155.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> And yes it was possible\n\nDoesn't autodoc import the modules that it builds the documentation of, to determine `__doc__`? If so, there is no way to build the Sage documentation without building Sage first.",
    "created_at": "2016-02-09T07:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271155",
    "user": "@jdemeyer"
}
```

Replying to [comment:17 fbissey]:
> And yes it was possible

Doesn't autodoc import the modules that it builds the documentation of, to determine `__doc__`? If so, there is no way to build the Sage documentation without building Sage first.



---

archive/issue_comments_271156.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> You started to import cythonized stuff (`cachefunc` for starters)\n\nNo, the Sage docbuilder has always used `cachefunc`, that is nothing new.",
    "created_at": "2016-02-09T07:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271156",
    "user": "@jdemeyer"
}
```

Replying to [comment:17 fbissey]:
> You started to import cythonized stuff (`cachefunc` for starters)

No, the Sage docbuilder has always used `cachefunc`, that is nothing new.



---

archive/issue_comments_271157.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-02-09T07:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271157",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_271158.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> Replying to [comment:17 fbissey]:\n> > You started to import cythonized stuff (`cachefunc` for starters)\n> \n> No, the Sage docbuilder has always used `cachefunc`, that is nothing new.\n\nLet's not get into this any more and finish this ticket. I may be looking for something stupid.",
    "created_at": "2016-02-09T07:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271158",
    "user": "@kiwifb"
}
```

Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 fbissey]:
> > You started to import cythonized stuff (`cachefunc` for starters)
> 
> No, the Sage docbuilder has always used `cachefunc`, that is nothing new.

Let's not get into this any more and finish this ticket. I may be looking for something stupid.



---

archive/issue_comments_271159.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-09T16:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271159",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_271160.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-02-09T16:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271160",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_271161.json:
```json
{
    "body": "I am happy with that. Anything further will be for a follow up ticket. And once the PR to `sagenb` is included in a release we should remove the creation of links to the old location. `sagenb` is really the only thing that currently depends on it.",
    "created_at": "2016-02-09T20:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271161",
    "user": "@kiwifb"
}
```

I am happy with that. Anything further will be for a follow up ticket. And once the PR to `sagenb` is included in a release we should remove the creation of links to the old location. `sagenb` is really the only thing that currently depends on it.



---

archive/issue_comments_271162.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-02-09T20:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271162",
    "user": "@kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_271163.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-02-10T08:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271163",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_271164.json:
```json
{
    "body": "For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?",
    "created_at": "2016-02-11T22:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271164",
    "user": "@jhpalmieri"
}
```

For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?



---

archive/issue_comments_271165.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?\n\nThat would be a good idea I would say. Not quite on the top of my laundry list. But if we want to discuss those matters, it shouldn't be on this ticket.",
    "created_at": "2016-02-12T01:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271165",
    "user": "@kiwifb"
}
```

Replying to [comment:27 jhpalmieri]:
> For a followup ticket: should we reinstate the line `rm -rf output` in `src/doc/Makefile`? Otherwise the old output will remain and possibly confuse people. Or should the old output be removed somewhere else?

That would be a good idea I would say. Not quite on the top of my laundry list. But if we want to discuss those matters, it shouldn't be on this ticket.



---

archive/issue_comments_271166.json:
```json
{
    "body": "Old docs are deleted, see `src/sage_setup/docbuild/__main__.py`:\n\n```\n    if os.path.exists(old_doc):\n        from shutil import rmtree\n        rmtree(old_doc)\n```\n",
    "created_at": "2016-02-12T08:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19726#issuecomment-271166",
    "user": "@jdemeyer"
}
```

Old docs are deleted, see `src/sage_setup/docbuild/__main__.py`:

```
    if os.path.exists(old_doc):
        from shutil import rmtree
        rmtree(old_doc)
```

