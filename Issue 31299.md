# Issue 31299: Move MathJax from latex to html

Issue created by migration from https://trac.sagemath.org/ticket/31536

Original creator: klee

Original creation time: 2021-03-22 11:13:47

CC:  egourgoulhon




---

Comment by git created at 2021-03-23 15:23:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-23 15:23:29

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by egourgoulhon created at 2021-03-24 12:42:06

As expressed in https://groups.google.com/g/sage-devel/c/Q4kWXdMxC2Q/m/5PT5QRgvAwAJ, I think that the meaning of `%display latex` is clearer to the end user than `%display html`. The latter sounds quite strange while you are working on a notebook in a browser, the main purpose of which is to display html code. 

At the very least, there should be a long deprecation period, when `%display latex` is still available. For instance, on https://sagemanifolds.obspm.fr/examples.html and on https://luth.obspm.fr/~luthier/gourgoulhon/bh16/sage.html, we have tons of notebooks that start with `%display latex`.


---

Comment by git created at 2021-03-24 12:57:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-24 13:26:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2021-03-24 13:48:25

Replying to [comment:9 egourgoulhon]:
> As expressed in https://groups.google.com/g/sage-devel/c/Q4kWXdMxC2Q/m/5PT5QRgvAwAJ, I think that the meaning of `%display latex` is clearer to the end user than `%display html`. The latter sounds quite strange while you are working on a notebook in a browser, the main purpose of which is to display html code. 

Right.

> At the very least, there should be a long deprecation period, when `%display latex` is still available. For instance, on https://sagemanifolds.obspm.fr/examples.html and on https://luth.obspm.fr/~luthier/gourgoulhon/bh16/sage.html, we have tons of notebooks that start with `%display latex`. 

I agree. Though I had decided to follow the deprecation path, now I give up.

I think we can make a compromise. We make the clear distinction between latex representation and html(+mathjax) representation internally or on code level but we keep `%display latex` for end users. 

I will commit a patch soon.


---

Comment by git created at 2021-03-24 14:36:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-03-24 15:38:09

Replying to [comment:12 klee]:
> 
> I think we can make a compromise. We make the clear distinction between latex representation and html(+mathjax) representation internally or on code level but we keep `%display latex` for end users.

Sounds good! Thanks. :-)


---

Comment by egourgoulhon created at 2021-03-24 20:20:27

Does by any chance the code improvement in this ticket fix #31513 ?


---

Comment by git created at 2021-03-24 23:03:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-03-26 17:17:24

I gave a try and it looks OK to me, except that the latex-typeset is broken in the pdf export from the Jupyter notebook. I guess fixing this should wait the resolution of #31513.


---

Comment by klee created at 2021-03-26 22:41:52

Replying to [comment:18 egourgoulhon]:
> I gave a try and it looks OK to me, except that the latex-typeset is broken in the pdf export from the Jupyter notebook. I guess fixing this should wait the resolution of #31513. 

Thanks! I agree.


---

Comment by git created at 2021-03-27 02:09:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-03-27 10:39:33

Thanks for the fix. There is still an issue for the pdf export of matrices. For instance, 

```
%display latex
matrix([[1, x], [0, 0]])
```

produces a typeset matrix in the Jupyter notebook, but not in its pdf export.


---

Comment by egourgoulhon created at 2021-03-27 10:43:06

Another issue is that `%matplotlib notebook` is broken by this ticket: the following cell of a Jupyter notebook:

```
%matplotlib notebook
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.ylabel('some numbers')
plt.show()
```

yields

```
<IPython.core.display.HTML object>
```

instead of the pyplot window.


---

Comment by git created at 2021-03-27 11:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-27 11:21:58

Replying to [comment:22 egourgoulhon]:
> Another issue is that `%matplotlib notebook` is broken by this ticket: the following cell of a Jupyter notebook:
> {{{
> %matplotlib notebook
> import matplotlib.pyplot as plt
> plt.plot([1, 2, 3, 4])
> plt.ylabel('some numbers')
> plt.show()
> }}}
> yields
> {{{
> <IPython.core.display.HTML object>
> }}}
> instead of the pyplot window.

Are you sure? I copy and pasted the same code into sage 9.1 and 9.2. They all fail.


---

Comment by klee created at 2021-03-27 11:23:21

The same code also fails on sage 9.3.beta9 without this ticket.


---

Comment by egourgoulhon created at 2021-03-27 12:29:16

Replying to [comment:25 klee]:
> The same code also fails on sage 9.3.beta9 without this ticket.

It works for me, both with sage 9.2 and 9.3.rc0 (note that it does not work if `%display latex` is set first).


---

Comment by egourgoulhon created at 2021-03-27 12:35:12

Replying to [comment:24 klee]:
> Replying to [comment:22 egourgoulhon]:
> > Another issue is that `%matplotlib notebook` is broken by this ticket: the following cell of a Jupyter notebook:
> > {{{
> > %matplotlib notebook
> > import matplotlib.pyplot as plt
> > plt.plot([1, 2, 3, 4])
> > plt.ylabel('some numbers')
> > plt.show()
> > }}}
> > yields
> > {{{
> > <IPython.core.display.HTML object>
> > }}}
> > instead of the pyplot window.
> 
> Are you sure? I copy and pasted the same code into sage 9.1 and 9.2. They all fail. 

Yes I am sure: it works for me for sage 9.1, 9.2 and 9.3.rc0. It is very convenient to have that pyplot window, because it allows to zoom and pan, contrary to Sage 2d plot outputs. Note that, as said in comment:26, it is broken by `%display latex` though. But

```
%display plain
%matplotlib notebook
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.ylabel('some numbers')
plt.show()
}}} 
works all the time.


---

Attachment

Replying to [comment:27 egourgoulhon]:
> I am sure: it works for me for sage 9.1, 9.2 and 9.3.rc0. It is very convenient to have that pyplot window, because it allows to zoom and pan, contrary to Sage 2d plot outputs. Note that, as said in comment:26, it is broken by `%display latex` though. But
> {{{
> %display plain
> %matplotlib notebook
> import matplotlib.pyplot as plt
> plt.plot([1, 2, 3, 4])
> plt.ylabel('some numbers')
> plt.show()
> }}} 
> works all the time.

I cannot see what you see. Does it work in cocalc for you? I doen't for me. See the attachment.


---

Comment by klee created at 2021-03-27 23:05:58

Anyway, I can observe that with `%display latex`, the failure is of different kind.


---

Comment by git created at 2021-03-28 01:12:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-28 01:13:38

Please check


---

Comment by git created at 2021-03-28 07:04:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-03-28 11:37:59

Replying to [comment:31 klee]:
> Please check

Thanks for the new commits. I confirm that the issue with pdf export of matrices is fixed by them.  However, the issue with matplotlib remains: for the code of comment:27, I still get 

```
<IPython.core.display.HTML object>
```

instead of the pyplot window.


---

Comment by egourgoulhon created at 2021-03-28 13:32:11

Replying to [comment:28 klee]:
> 
> I cannot see what you see. Does it work in cocalc for you? I doen't for me. See the attachment.

No, it does not work in CoCalc for me either (same error message as you). Given that CoCalc's Jupyter notebook is quite customized, I would say that it is a CoCalc issue, rather than a Sage one. Can't you see the pyplot window with Sage 9.3.rc0 on your own machine? (mine is Ubuntu 20.04, with Firefox 86.0.1).


---

Comment by egourgoulhon created at 2021-03-28 14:17:26

Replying to [comment:34 egourgoulhon]:
> Replying to [comment:31 klee]:
> > Please check
> 
> Thanks for the new commits. I confirm that the issue with pdf export of matrices is fixed by them.  However, the issue with matplotlib remains: for the code of comment:27, I still get 
> {{{
> <IPython.core.display.HTML object>
> }}}
> instead of the pyplot window. 

FWIW, for `plt.show()`, the following happens in `SageDisplayFormatter.format`:

```
        # use IPython display for IPython native objects
        if isinstance(obj, IPYTHON_NATIVE_TYPES):     <== this test is passed
            if self.ipython_display_formatter(obj):   <== this test fails
                return {}, {}                         
```

Hence the `return {}, {}` is not performed.


---

Comment by klee created at 2021-03-29 04:17:49

Replying to [comment:35 egourgoulhon]:
> Replying to [comment:28 klee]:
> > 
> > I cannot see what you see. Does it work in cocalc for you? I doen't for me. See the attachment.
> 
> No, it does not work in CoCalc for me either (same error message as you). Given that CoCalc's Jupyter notebook is quite customized, I would say that it is a CoCalc issue, rather than a Sage one. Can't you see the pyplot window with Sage 9.3.rc0 on your own machine? (mine is Ubuntu 20.04, with Firefox 86.0.1). 

No. My system is MacOS 11.2.3 with Chrome 89.0.4389.90. 

I tried to install jupyter-matplotlib extension with jupyterlab 2 and jupyterlab 3. All did not work.

By the way, it works with Python 3 kernel in jupyterlab.


---

Comment by klee created at 2021-03-29 04:26:28

Replying to [comment:36 egourgoulhon]:
> Replying to [comment:34 egourgoulhon]:
> > Replying to [comment:31 klee]:
> > > Please check
> > 
> > Thanks for the new commits. I confirm that the issue with pdf export of matrices is fixed by them.  However, the issue with matplotlib remains: for the code of comment:27, I still get 
> > {{{
> > <IPython.core.display.HTML object>
> > }}}
> > instead of the pyplot window. 
> 
> FWIW, for `plt.show()`, the following happens in `SageDisplayFormatter.format`:
> {{{
>         # use IPython display for IPython native objects
>         if isinstance(obj, IPYTHON_NATIVE_TYPES):     <== this test is passed
>             if self.ipython_display_formatter(obj):   <== this test fails
>                 return {}, {}                         
> }}}
> Hence the `return {}, {}` is not performed. 
> 

`self.ipython_display_formatter(obj)` is an ipython native method. which has nothing to do with sage `%display` magic. I don't understand why it fails with `%display latex` but it works with `%display plain`.


---

Comment by egourgoulhon created at 2021-03-29 07:09:22

Replying to [comment:38 klee]:
> Replying to [comment:36 egourgoulhon]:
> > Replying to [comment:34 egourgoulhon]:
> > > Replying to [comment:31 klee]:
> > > > Please check
> > > 
> > > Thanks for the new commits. I confirm that the issue with pdf export of matrices is fixed by them.  However, the issue with matplotlib remains: for the code of comment:27, I still get 
> > > {{{
> > > <IPython.core.display.HTML object>
> > > }}}
> > > instead of the pyplot window. 
> > 
> > FWIW, for `plt.show()`, the following happens in `SageDisplayFormatter.format`:
> > {{{
> >         # use IPython display for IPython native objects
> >         if isinstance(obj, IPYTHON_NATIVE_TYPES):     <== this test is passed
> >             if self.ipython_display_formatter(obj):   <== this test fails
> >                 return {}, {}                         
> > }}}
> > Hence the `return {}, {}` is not performed. 
> > 
> 
> `self.ipython_display_formatter(obj)` is an ipython native method. which has nothing to do with sage `%display` magic. I don't understand why it fails with `%display latex` but it works with `%display plain`.
> 
No, it fails with `%display plain` as well. All subsequent tests in `SageDisplayFormatter.format` also fail, so at the end

```
        return ipy_format, ipy_metadata
```

is achieved. The same thing happens with Sage 9.3.rc0 (i.e. outside this ticket branch), but for some reason, the output `ipy_format, ipy_metadata` is better handled in that case, so that the pyplot window opens.


---

Comment by klee created at 2021-03-29 07:17:46

Replying to [comment:39 egourgoulhon]:
> Replying to [comment:38 klee]:
> is achieved. The same thing happens with Sage 9.3.rc0 (i.e. outside this ticket branch), but for some reason, the output `ipy_format, ipy_metadata` is better handled in that case, so that the pyplot window opens. 

Which do you mean, with the patch, or without the patch?


---

Comment by klee created at 2021-03-29 07:19:19

Replying to [comment:40 klee]:
> Replying to [comment:39 egourgoulhon]:
> > Replying to [comment:38 klee]:
> > is achieved. The same thing happens with Sage 9.3.rc0 (i.e. outside this ticket branch), but for some reason, the output `ipy_format, ipy_metadata` is better handled in that case, so that the pyplot window opens. 
> 
> Which do you mean, with the patch, or without the patch?

Ah, you meant rc0, without the patch..


---

Comment by egourgoulhon created at 2021-03-29 07:20:23

Replying to [comment:41 klee]:
> Replying to [comment:40 klee]:
> > Replying to [comment:39 egourgoulhon]:
> > > Replying to [comment:38 klee]:
> > > is achieved. The same thing happens with Sage 9.3.rc0 (i.e. outside this ticket branch), but for some reason, the output `ipy_format, ipy_metadata` is better handled in that case, so that the pyplot window opens. 
> > 
> > Which do you mean, with the patch, or without the patch?
> 
> Ah, you meant rc0, without the patch..

Yes (sorry for not having been clear).


---

Comment by egourgoulhon created at 2021-03-29 07:28:45

To summarize: for `plt.show()` in Sage 9.3.rc0, with or without the patch introduced in this ticket, `SageDisplayFormatter.format` terminates by `return ipy_format, ipy_metadata`, whatever the value of `%display`. Then the pyplot window opens correctly only without the patch and without `%display latex`.


---

Comment by egourgoulhon created at 2021-03-29 07:44:17

Replying to [comment:37 klee]:
> Replying to [comment:35 egourgoulhon]:
> > Replying to [comment:28 klee]:
> > > 
> > > I cannot see what you see. Does it work in cocalc for you? I doen't for me. See the attachment.
> > 
> > No, it does not work in CoCalc for me either (same error message as you). Given that CoCalc's Jupyter notebook is quite customized, I would say that it is a CoCalc issue, rather than a Sage one. Can't you see the pyplot window with Sage 9.3.rc0 on your own machine? (mine is Ubuntu 20.04, with Firefox 86.0.1). 
> 
> No. My system is MacOS 11.2.3 with Chrome 89.0.4389.90. 
> 

Strange... On my side, I haven't any special setting regarding matplotlib (it's the default version included in Sage). 

Regarding CoCalc, I've just got the answer from William: it works with Sage 9.2 kernel but you have to start a "Jupyter classic server" (in the "New" menu).


---

Comment by klee created at 2021-03-30 00:58:50

Replying to [comment:44 egourgoulhon]:
> Replying to [comment:37 klee]:
> > Replying to [comment:35 egourgoulhon]:
> > > Replying to [comment:28 klee]:
> > > > 
> > > > I cannot see what you see. Does it work in cocalc for you? I doen't for me. See the attachment.
> > > 
> > > No, it does not work in CoCalc for me either (same error message as you). Given that CoCalc's Jupyter notebook is quite customized, I would say that it is a CoCalc issue, rather than a Sage one. Can't you see the pyplot window with Sage 9.3.rc0 on your own machine? (mine is Ubuntu 20.04, with Firefox 86.0.1). 
> > 
> > No. My system is MacOS 11.2.3 with Chrome 89.0.4389.90. 
> > 
> 
> Strange... On my side, I haven't any special setting regarding matplotlib (it's the default version included in Sage). 

Does it work without installing jupyter-matplotlib extension?

I created a new Ubuntu vm, and installed a fresh sage from source, and installed jupyter-matplotlib from the jupyter extension manager. Even then it doesn't work and shows the same message `Javascript Error: IPython is not defined`. Now even with Python3 kernel.


---

Comment by klee created at 2021-03-30 01:07:51

Replying to [comment:44 egourgoulhon]:
> Replying to [comment:37 klee]:
> 
> Strange... On my side, I haven't any special setting regarding matplotlib (it's the default version included in Sage). 
> 
> Regarding CoCalc, I've just got the answer from William: it works with Sage 9.2 kernel but you have to start a "Jupyter classic server" (in the "New" menu). 

Ok. I finally made it work with the Jupyter classic server. Let me now go back to the ticket.


---

Comment by git created at 2021-03-30 04:30:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-30 04:36:49

I made a rather drastic change, removing `default_mime()` method, which I don't understand clearly. Instead I rely on the ipython class `DisplayObject` to filter out ipython native objects. 

It works well with the examples up to now. But I think it is necessary to test extensively in fear of any bad regressions.


---

Comment by egourgoulhon created at 2021-03-30 08:45:01

Replying to [comment:48 klee]:
> I made a rather drastic change, removing `default_mime()` method, which I don't understand clearly. Instead I rely on the ipython class `DisplayObject` to filter out ipython native objects. 
> 
> It works well with the examples up to now. But I think it is necessary to test extensively in fear of any bad regressions.

Thanks for the new code. The pyplot window is now correctly handled. Unfortunately, two new issues have appeared: 

1/ Outside the context `%matplotlib notebook`, there is no graphical display of `plt.show()`: the output of the Jupyter cell

```
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.ylabel('some numbers')
plt.show()
```

is

```
<Figure size 432x288 with 1 Axes>
```

instead of a png figure displayed by the notebook.

2/ The native IPython rich output method `_repr_latex_` is broken:

```
class A(SageObject):

    def __init__(self, data):
        self._data = data

    def _repr_latex_(self):
        try:
            return '$' + self._data._latex_() + '$'
        except (AttributeError, NotImplementedError):  
            return None  # if None is returned, plain text is used

A(sin(x^2))
```

results in 

```
<__main__.A object at 0x7f0566d4a940>
```

instead of the latex-typeset formula.

These two issues were not present in the previous version of the patch, nor in plain Sage 9.3.rc0.


---

Comment by egourgoulhon created at 2021-03-30 09:15:02

Replying to [comment:45 klee]:
> Replying to [comment:44 egourgoulhon]:
> > Replying to [comment:37 klee]:
> > > Replying to [comment:35 egourgoulhon]:
> > > > Can't you see the pyplot window with Sage 9.3.rc0 on your own machine? (mine is Ubuntu 20.04, with Firefox 86.0.1). 
> > > 
> > > No. My system is MacOS 11.2.3 with Chrome 89.0.4389.90. 
> > > 
> > 
> > Strange... On my side, I haven't any special setting regarding matplotlib (it's the default version included in Sage). 
> 
> Does it work without installing jupyter-matplotlib extension?
> 
Yes, since I don't have installed such an extension: the content of `local/share/jupyter/nbextensions` under my Sage root is 

```
jsmol  jupyter_jsmol  jupyter-js-widgets  mathjax  threejs
```



---

Comment by git created at 2021-03-30 09:34:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-30 09:44:32

The commit fixes 1/ and 2/ with me. Check yours.

Regardless of the patch, the matplotlib interactive display is unstable (visible or invisible randomly) on my installation. Strange...


---

Comment by egourgoulhon created at 2021-03-30 10:08:10

Replying to [comment:54 klee]:
> The commit fixes 1/ and 2/ with me. Check yours.
> 

Thanks. I confirm that both 1/ and 2/ are fixed. Moreover, the new commit also fixes `%matplotlib notebook` in a `%display latex` context, which did not work with Sage 9.2 and 9.3.rc0 ! I've also checked that the pdf export of a Jupyter notebook works nicely. So I would say that everything is green from my side. Let us wait for the pachbot and other reviewers, if any.

> Regardless of the patch, the matplotlib interactive display is unstable (visible or invisible randomly) on my installation. Strange...

Note that there cannot be two interactive pyplot windows in two distinct cells of a given Jupyter notebook; if you open a new window via `plt.show()` in a new cell, the first one becomes blank (in the same cell, it is OK). This might explain what you observe.


---

Comment by egourgoulhon created at 2021-03-30 10:14:30

If everything is OK with this ticket, I propose that it becomes the fix for the blocker #31513.


---

Comment by klee created at 2021-03-30 11:06:30

Replying to [comment:55 egourgoulhon]:
> Replying to [comment:54 klee]:
> > Regardless of the patch, the matplotlib interactive display is unstable (visible or invisible randomly) on my installation. Strange...
> 
> Note that there cannot be two interactive pyplot windows in two distinct cells of a given Jupyter notebook; if you open a new window via `plt.show()` in a new cell, the first one becomes blank (in the same cell, it is OK). This might explain what you observe. 

I see. Thanks.


---

Comment by egourgoulhon created at 2021-03-30 15:56:50

I think the python3 error reported by the patchbot is a false positive, triggered by the presence of `<>` in the string, so we can disregard it. Can you comment on the pyflake errors?


---

Comment by git created at 2021-03-30 22:53:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-03-30 22:56:28

Replying to [comment:58 egourgoulhon]:
> I think the python3 error reported by the patchbot is a false positive, triggered by the presence of `<>` in the string, so we can disregard it. Can you comment on the pyflake errors?

I fixed some pyflakes errors, which are safe to fix. Anyway none of them are new.


---

Comment by egourgoulhon created at 2021-03-31 07:29:42

Replying to [comment:60 klee]:
> 
> I fixed some pyflakes errors, which are safe to fix. 

Thanks!

>Anyway none of them are new.

Indeed. Thanks for having taken this opportunity to fix them.


---

Comment by egourgoulhon created at 2021-03-31 07:31:36

It's time to move on, if we want this in Sage 9.3. Thanks for all your work on this ticket!


---

Comment by egourgoulhon created at 2021-03-31 07:31:36

Changing status from needs_review to positive_review.


---

Comment by klee created at 2021-03-31 08:05:46

Thank you for a careful review. Hope this sail on peacefully.


---

Comment by mkoeppe created at 2021-03-31 15:07:45

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2021-03-31 16:59:08

It would probably be good to revise the ticket summary/description based on https://groups.google.com/g/sage-release/c/fXpbYwaqt9o/m/xYOwhU26CAAJ


---

Comment by jhpalmieri created at 2021-03-31 17:24:44

Replying to [comment:48 klee]:
> I made a rather drastic change, removing `default_mime()` method, which I don't understand clearly. Instead I rely on the ipython class `DisplayObject` to filter out ipython native objects. 
> 
> It works well with the examples up to now. But I think it is necessary to test extensively in fear of any bad regressions.

Because of your last paragraph, I think this can't be a blocker for 9.3: it should be one of the first tickets merged in 9.4 instead.


---

Comment by egourgoulhon created at 2021-03-31 20:49:33

Replying to [comment:66 jhpalmieri]:
> 
> Because of your last paragraph, I think this can't be a blocker for 9.3: it should be one of the first tickets merged in 9.4 instead.

Well, since this paragraph was written, much more tests have been performed. For instance, the patch has been successfully run on [this notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_black_hole_rendering.ipynb), which mixes latex display, Sage 2d and 3d plots, pure Matplotlib plots via pyplot, PIL images and ipywidgets (progress bars).


---

Comment by vbraun created at 2021-04-01 19:45:20

Resolution: fixed
