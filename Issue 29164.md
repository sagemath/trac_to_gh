# Issue 29164: Add documentation of tox and GitHub actions workflow to developer's manual

Issue created by migration from https://trac.sagemath.org/ticket/29401

Original creator: mkoeppe

Original creation time: 2020-03-24 21:26:27

CC:  dimpase jhpalmieri vdelecroix tscrim mjo fbissey slelievre




---

Comment by git created at 2020-03-26 00:57:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 00:59:03

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-03-26 03:50:05

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-03-26 03:50:05

doc does not build.

in `portability_testing.rst` warning:
Could not lex literal_block as "shell-session". 

perhaps it needs tagging as yaml, somehow


---

Comment by dimpase created at 2020-03-26 04:07:44


```diff
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -9,7 +9,7 @@ Testing on multiple platforms
 =============================
 
 Sage is intended to build and run on a variety of platforms,
-including all major Linux distributions, as well as macOS, and
+including all major Linux distributions, as well as MacOS, and
 Windows (with Cygwin).
 
 There is considerable variation between these platforms.
@@ -142,7 +142,9 @@ Using Sage's database of distribution prerequisites
 
 The source code of the Sage distribution contains a database of
 package names in various distributions' package managers.  For
-example, the file ``build/pkgs/debian.txt`` contains the following::
+example, the file ``build/pkgs/debian.txt`` contains the following
+
+.. code-block:: yaml
 
   # This file, build/pkgs/debian.txt, contains names of Debian/Ubuntu packages
   # needed for installation of Sage from source.
```

please apply this patch - then you can set it to positive review.


---

Comment by dimpase created at 2020-03-26 04:07:44

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-03-26 15:18:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-26 15:40:03

I'd add a link to https://wiki.sagemath.org/patchbot in the Sage patchbots section, and there are more typos and formatting issues. Let me post another patch...


---

Comment by dimpase created at 2020-03-26 16:01:33

reviewer patch 2


---

Attachment

please apply this, too


---

Comment by git created at 2020-03-26 18:02:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 18:02:56

Thank you!


---

Comment by jhpalmieri created at 2020-03-26 21:11:08

Trivial request:

```diff
diff --git a/src/doc/en/developer/portability_testing.rst b/src/doc/en/developer/portability_testing.rst
index 20737e3ce1..16ea65340c 100644
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -12,7 +12,7 @@ Sage is intended to build and run on a variety of platforms,
 including all major Linux distributions, as well as MacOS, and
 Windows (with Cygwin).
 
-There is considerable variation between these platforms.
+There is considerable variation among these platforms.
 To ensure that Sage continues to build correctly on users'
 machines, it is crucial to test changes to Sage, in particular
 when external packages are added or upgraded, on a wide
```

Some people may also complain that some of the lines are longer than 80 characters. I don't care much about this.

I just tried out the instructions for Docker. When I was just starting, `apt-get install ...` wasn't working: I needed to run `apt-get update` first (as in https://stackoverflow.com/questions/27273412/cannot-install-packages-inside-docker-ubuntu-image). Should this command be added?

In the "Generating Dockerfiles" section: am I understanding that you don't need to create a new git worktree with this approach? That's not completely clear as written.


---

Comment by jhpalmieri created at 2020-03-26 21:21:22

Also in the "Generating Dockerfiles" section: I tried

```
$ build/bin/write-dockerfile.sh debian "@(standard|optional)" > ../Dockerfile
$ docker build . -f ../Dockerfile ...
```

so as not to pollute my Sage directory with untracked files, but it didn't work:

```
ERRO[0000] Can't add file /Users/palmieri/Desktop/Sage_stuff/git/sage/.git/TEMP/rebase-apply/0001 to tar: io: read/write on closed pipe 
ERRO[0000] Can't close tar writer: io: read/write on closed pipe 
Sending build context to Docker daemon  37.89kB
error during connect: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.40/build?buildargs=%7B%22BASE_IMAGE%22%3A%22ubuntu-latest-sage%22%2C%22NUMPROC%22%3A%224%22%7D&cachefrom=%5B%5D&cgroupparent=&cpuperiod=0&cpuquota=0&cpusetcpus=&cpusetmems=&cpushares=0&dockerfile=.dockerfile.13cd21991950b4666007&labels=%7B%7D&memory=0&memswap=0&networkmode=default&rm=1&shmsize=0&target=&ulimits=null&version=1: archive/tar: write too long
```

Giving an absolute path didn't help. 

Also, once I get this going, where does the build take place? That is, can I look at the log files without running a second iteration of docker?


---

Comment by mkoeppe created at 2020-03-26 21:22:38

Docker contexts are tricky!


---

Comment by mkoeppe created at 2020-03-26 21:24:25

It's easiest to put the Dockerfile somewhere in the tree.


---

Comment by mkoeppe created at 2020-03-26 21:25:05

Thanks for the feedback. I'll revise the writing to address your questions


---

Comment by git created at 2020-03-26 21:27:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-26 23:03:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 23:47:35

Ready for reading


---

Comment by git created at 2020-03-27 00:05:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-27 01:21:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-27 02:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-27 02:58:02

please mention that docker examples in the manual are run on MacOS.
----
New commits:


---

Comment by git created at 2020-03-27 02:58:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-27 03:00:07

I'm curious: at the beginning, why do `make configure` before starting docker?


---

Comment by git created at 2020-03-27 03:13:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-27 03:14:25

Replying to [comment:26 jhpalmieri]:
> I'm curious: at the beginning, why do `make configure` before starting docker?

In the initial examples I am avoiding a discussion of bootstrapping on the container -- because this needs more packages


---

Comment by mkoeppe created at 2020-03-27 03:14:44

Replying to [comment:24 dimpase]:
> please mention that docker examples in the manual are run on MacOS.

Done, please take a look


---

Comment by dimpase created at 2020-03-27 03:42:38

Lists of packages to install are also in Installation manual. Please at least mention this (ideally, add a cross-link)


---

Comment by dimpase created at 2020-03-27 04:11:34

`docker run` does not quite work as shown (I'm trying this on a Debian host). I have

```
$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntylatest        latest              ee59e71b3721        13 minutes ago      1.53GB
```

but

``` 
$ docker run -it   --mount type=bind,source=$(pwd),target=/sage ubuntuminimal
Unable to find image 'ubuntuminimal:latest' locally
docker: Error response from daemon: pull access denied for ubuntuminimal, repository does not exist or may require 'docker login': denied: requested access to the resource is denied.
See 'docker run --help'.
```

I have to use containter ID:

```
$ docker run -it   --mount type=bind,source=$(pwd),target=/sage ee59e71b3721
root@6b44c73a10bb:/# 
```



---

Comment by mkoeppe created at 2020-03-27 04:18:49

You have a typo there: ubuntylatest vs. ubuntuminimal


---

Comment by dimpase created at 2020-03-27 05:02:00

Replying to [comment:34 mkoeppe]:
> You have a typo there: ubuntylatest vs. ubuntuminimal
oops, indeed, sorry for noise.


---

Comment by dimpase created at 2020-03-27 09:17:04

perhaps, add a link to https://docs.docker.com/get-started/part3/ where you talk about sharing of images, and just send people over to "docker docs"


---

Comment by dimpase created at 2020-03-27 09:40:06

please add few lines about tox in general before `Symbolic names of system configurations`, otherwise the jump into tox details is way too steep.


---

Comment by git created at 2020-03-27 14:25:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-28 03:42:54

typos, please apply

```diff
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -293,9 +293,9 @@ The image ``ubuntu-latest-minimal-17`` can be run in as many
 containers as we want and can also be shared with other users or
 developers so that they can run it in a container on their machine.
 (See the Docker documentation on how to `share images on Docker Hub
-<https://docs.docker.com/get-started/part3/>` or to `save images to a
+<https://docs.docker.com/get-started/part3/>`_ or to `save images to a
 tar archive
-<https://docs.docker.com/engine/reference/commandline/save/>`.)
+<https://docs.docker.com/engine/reference/commandline/save/>`_.)
 
 This facilitates collaboration on fixing portability bugs of the Sage
 distribution.  After reproducing a portability bug on a container,
```



---

Comment by git created at 2020-03-28 03:46:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-28 03:57:11

more missing `_` (hopefully all now):

```diff
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -51,13 +51,13 @@ using a Docker client on your Linux, Mac, or Windows box, as well as
 on various cloud services.
 
 To get started, you need to install a `Docker client
-<https://docs.docker.com/install/>`.  The clients are available for
+<https://docs.docker.com/install/>`_.  The clients are available for
 Linux, Mac, and Windows.  The clients for the latter are known as
 "Docker Desktop".
 
 All examples in this section were obtained using Docker Desktop for
 Mac; but the `command-line user interface
-<https://docs.docker.com/engine/reference/commandline/cli/>` for the
+<https://docs.docker.com/engine/reference/commandline/cli/>`_ for the
 other platforms is identical.
 
 All major Linux distributions provide ready-to-use Docker images,
@@ -574,7 +574,7 @@ automating testing, Sage defines symbolic names composed of several
 Automatic Docker-based build testing using tox
 ----------------------------------------------
 
-`tox <https://tox.readthedocs.io/en/latest/>` is a Python package that
+`tox <https://tox.readthedocs.io/en/latest/>`_ is a Python package that
 is widely used for automating tests of Python projects.
 
 Install ``tox`` for use with your system Python, for example using::
```



---

Comment by git created at 2020-03-28 05:00:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-28 05:01:16

Thank you!


---

Comment by mkoeppe created at 2020-03-28 16:09:32

Any more corrections or suggestions for this new section in the manual?


---

Comment by git created at 2020-03-29 03:02:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-29 03:02:57

Rebased on 9.1.beta9, needs review


---

Comment by dimpase created at 2020-03-29 03:28:55

unfinished edit here at line 570, ending with `several`


---

Comment by git created at 2020-03-29 03:36:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-29 04:09:13

make this a proper list:


```diff
--- a/src/doc/en/developer/portability_testing.rst
+++ b/src/doc/en/developer/portability_testing.rst
@@ -854,13 +854,12 @@ workflow have finished.  Each job generates one tarball.
 during the build.
 
 The following procedure seems to work well for testing branches during
-development.  Create a branch from a recent beta release that contains
-the default GitHub Actions configuration; name it ``TESTER``, say.
-Edit ``$SAGE_ROOT/.github/workflows/tox.yml`` to include the system
-configurations that you wish to test.  Commit and push the branch to
-your GitHub fork of sage.  Next, push your development branch to your
-GitHub repository and create a pull request against the ``TESTER``
-branch.  This will trigger the GitHub Actions workflow.
+development:
+
+- Create a branch from a recent beta release that contains the default GitHub Actions configuration; name it ``TESTER``, say.
+- Edit ``$SAGE_ROOT/.github/workflows/tox.yml`` to include the system configurations that you wish to test.
+- Commit and push the branch to your GitHub fork of sage.
+- Push your development branch to your GitHub repository and create a pull request against the ``TESTER`` branch. This will trigger the GitHub Actions workflow.
```


also, there are few lines in the file after this, which do not go into the output.
Perhaps, just remove them.


---

Comment by git created at 2020-03-29 04:27:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-29 08:57:18

OK. Squash these many  commits, I guess, too.


---

Comment by dimpase created at 2020-03-29 08:57:18

Changing status from needs_review to positive_review.


---

Comment by git created at 2020-03-29 14:38:14

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-03-29 14:38:14

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-29 14:38:41

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-29 14:38:41

Thank you!


---

Comment by mkoeppe created at 2020-03-30 20:48:59

Looks like `@`vbraun has merged the unsquashed branch already. Resetting to that.


---

Comment by git created at 2020-03-30 20:49:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-03-30 20:49:31

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-03-30 20:49:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-05 08:30:26

Resolution: fixed
