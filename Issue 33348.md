# Issue 33348: doctest failure when doc html not built/installed but sphinx is available in PYTHONPATH

archive/issues_033348.json:
```json
{
    "body": "Tested on 9.6.beta6:\n\n```\nsage -t --warn-long 59.1 --random-seed=105547399700723726081010659407775307910 src/sage/misc/sagedoc.py\n**********************************************************************\nFile \"src/sage/misc/sagedoc.py\", line 1404, in sage.misc.sagedoc._sage_doc.__call__\nFailed example:\n    browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.sagedoc._sage_doc.__call__[2]>\", line 1, in <module>\n        browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx\n      File \"sage/misc/lazy_import.pyx\", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4256)\n        return self.get_object()(*args, **kwds)\n      File \"/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/sagedoc.py\", line 1450, in __call__\n        html = sphinxify(s)\n      File \"/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/sphinxify.py\", line 122, in sphinxify\n        sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,\n      File \"/usr/lib/python3.10/site-packages/sphinx/application.py\", line 263, in __init__\n        self._init_builder()\n      File \"/usr/lib/python3.10/site-packages/sphinx/application.py\", line 321, in _init_builder\n        self.builder.init()\n      File \"/usr/lib/python3.10/site-packages/sphinx/builders/html/__init__.py\", line 220, in init\n        self.init_templates()\n      File \"/usr/lib/python3.10/site-packages/sphinx/builders/html/__init__.py\", line 268, in init_templates\n        self.theme = theme_factory.create(themename)\n      File \"/usr/lib/python3.10/site-packages/sphinx/theming.py\", line 249, in create\n        raise ThemeError(__('no theme named %r found (missing theme.conf?)') % name)\n    sphinx.errors.ThemeError: no theme named 'sage-classic' found (missing theme.conf?)\n**********************************************************************\n1 item had failures:\n   1 of   6 in sage.misc.sagedoc._sage_doc.__call__\n    [100 tests, 1 failure, 20.72 s]\n```\n\n\nIndeed, this is not new, but I didn't have sphinx installed before.\n\nIt seems to me that the following patch should fix this:\n\n```diff\n--- a/src/sage/misc/sagedoc.py\n+++ b/src/sage/misc/sagedoc.py\n@@ -1401,7 +1401,7 @@ class _sage_doc:\n             \"...**File:**...**Type:**...**Definition:** identity_matrix...\"\n             sage: identity_matrix.__doc__ in browse_sage_doc(identity_matrix, 'rst')\n             True\n-            sage: browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx\n+            sage: browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx sagemath_doc_html\n             '...div...File:...Type:...Definition:...identity_matrix...'\n \n         In the 'text' version, double colons have been replaced with\n```\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33585\n\n",
    "created_at": "2022-03-28T23:36:49Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "doctest failure when doc html not built/installed but sphinx is available in PYTHONPATH",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33348",
    "user": "@tornaria"
}
```
Tested on 9.6.beta6:

```
sage -t --warn-long 59.1 --random-seed=105547399700723726081010659407775307910 src/sage/misc/sagedoc.py
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1404, in sage.misc.sagedoc._sage_doc.__call__
Failed example:
    browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sagedoc._sage_doc.__call__[2]>", line 1, in <module>
        browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx
      File "sage/misc/lazy_import.pyx", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4256)
        return self.get_object()(*args, **kwds)
      File "/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/sagedoc.py", line 1450, in __call__
        html = sphinxify(s)
      File "/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/sphinxify.py", line 122, in sphinxify
        sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,
      File "/usr/lib/python3.10/site-packages/sphinx/application.py", line 263, in __init__
        self._init_builder()
      File "/usr/lib/python3.10/site-packages/sphinx/application.py", line 321, in _init_builder
        self.builder.init()
      File "/usr/lib/python3.10/site-packages/sphinx/builders/html/__init__.py", line 220, in init
        self.init_templates()
      File "/usr/lib/python3.10/site-packages/sphinx/builders/html/__init__.py", line 268, in init_templates
        self.theme = theme_factory.create(themename)
      File "/usr/lib/python3.10/site-packages/sphinx/theming.py", line 249, in create
        raise ThemeError(__('no theme named %r found (missing theme.conf?)') % name)
    sphinx.errors.ThemeError: no theme named 'sage-classic' found (missing theme.conf?)
**********************************************************************
1 item had failures:
   1 of   6 in sage.misc.sagedoc._sage_doc.__call__
    [100 tests, 1 failure, 20.72 s]
```


Indeed, this is not new, but I didn't have sphinx installed before.

It seems to me that the following patch should fix this:

```diff
--- a/src/sage/misc/sagedoc.py
+++ b/src/sage/misc/sagedoc.py
@@ -1401,7 +1401,7 @@ class _sage_doc:
             "...**File:**...**Type:**...**Definition:** identity_matrix..."
             sage: identity_matrix.__doc__ in browse_sage_doc(identity_matrix, 'rst')
             True
-            sage: browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx
+            sage: browse_sage_doc(identity_matrix, 'html', False)             # optional - sphinx sagemath_doc_html
             '...div...File:...Type:...Definition:...identity_matrix...'
 
         In the 'text' version, double colons have been replaced with
```




Issue created by migration from https://trac.sagemath.org/ticket/33585





---

archive/issue_comments_474768.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-03-28T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474768",
    "user": "@tornaria"
}
```

New commits:



---

archive/issue_comments_474769.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-28T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474769",
    "user": "@tornaria"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474770.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-03-28T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474770",
    "user": "@tornaria"
}
```

Changing priority from major to critical.



---

archive/issue_comments_474771.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-29T01:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474771",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474772.json:
```json
{
    "body": "LGTM.",
    "created_at": "2022-03-29T01:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474772",
    "user": "@mkoeppe"
}
```

LGTM.



---

archive/issue_comments_474773.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33348#issuecomment-474773",
    "user": "@vbraun"
}
```

Resolution: fixed
