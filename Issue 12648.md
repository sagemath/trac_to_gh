# Issue 12648: OS X Lion: use "clang" as default C compiler

Issue created by migration from https://trac.sagemath.org/ticket/12820

Original creator: jdemeyer

Original creation time: 2012-04-09 13:27:00

Assignee: GeorgSWeber

William Stein reports this problem while building the GCC spkg:

```
checking for x86_64-apple-darwin11.3.0-gcc...
/Users/wstein/sage/install/sage-5.0.beta12-gcc/spkg/build/gcc-4.6.3/gcc-build/./gcc/xgcc
-B/Users/wstein/sage/install/sage-5.0.beta12-gcc/spkg/build/gcc-4.6.3/gcc-build/./gcc/
-B/Users/wstein/sage/install/sage-5.0.beta12-gcc/local/x86_64-apple-darwin11.3.0/bin/
-B/Users/wstein/sage/install/sage-5.0.beta12-gcc/local/x86_64-apple-darwin11.3.0/lib/
-isystem /Users/wstein/sage/install/sage-5.0.beta12-gcc/local/x86_64-apple-darwin11.3.0/include
-isystem /Users/wstein/sage/install/sage-5.0.beta12-gcc/local/x86_64-apple-darwin11.3.0/sys-include
checking for suffix of object files... configure: error: in
`/Users/wstein/sage/install/sage-5.0.beta12-gcc/spkg/build/gcc-4.6.3/gcc-build/x86_64-apple-darwin11.3.0/libgcc':
configure: error: cannot compute suffix of object files: cannot compile
See `config.log' for more details.
make[4]: *** [configure-stage1-target-libgcc] Error 1
make[3]: *** [stage1-bubble] Error 2
make[2]: *** [all] Error 2
```


The problem seems to be an outdated XCode version which has a broken GCC.  Building with clang instead succeeded.  Therefore, I propose to set "CC=clang" by default on OS X 10.7 or later in sage-env.


---

Comment by jdemeyer created at 2012-04-09 13:27:27

Changing type from PLEASE CHANGE to defect.


---

Comment by jdemeyer created at 2012-04-09 14:35:07

Changing status from new to needs_review.


---

Comment by leif created at 2012-04-13 15:42:10

Shouldn't that currently only be done if we really (decide to) build the GCC spkg, i.e., in `spkg/install` (rather than `sage-env`)?

(Sage currently wouldn't fully build with Clang [3.x].)

Also, are all possible versions of XCode's Clang capable of building GCC?


---

Comment by leif created at 2012-04-13 15:50:12

P.S.: The new spkgs for building Sage with GCC 4.7.x (see meta-ticket #12751) also fix _part of_ the issues we have with `clang`.

(The LinBox spkg at #12762 would still need work in order to build with `clang`, as it currently just adds `-fpermissive` to get around C++11 issues.)


---

Comment by jdemeyer created at 2012-04-13 15:55:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-13 15:55:05

Replying to [comment:3 leif]:
> Shouldn't that currently only be done if we really (decide to) build the GCC spkg, i.e., in `spkg/install` (rather than `sage-env`)?
Or in `sage-env` but depending on `SAGE_BUILD_TOOLCHAIN`.

> (Sage currently wouldn't fully build with Clang [3.x].)
It doesn't build with Apple's GCC either... but you might have a point, in case somebody decides to install a custom GCC outside of Sage.

> Also, are all possible versions of XCode's Clang capable of building GCC?
I'm not sure.  But at least one person reported being able to build GCC with Apple's Clang but not with Apple's GCC.


---

Comment by leif created at 2012-04-13 15:57:59


```
+    # On OS X 10.7 (Lion) or later, use clang as default C compiler
+    # as some older versions of XCode 4 ship broken versions of GCC
+    # which fail to bootstrap GCC-4.6.3.
```


Quoting William:

  _I dropped this [Sage 5.0.beta13] on my OS X 10.7.x laptop, didn't type anything special, typed "make ptestlong", and came back later to see "All tests passed!".  I.e., it built perfectly._

  _Note that I've upgraded both the OS and XCode to the latest released version on this laptop.  I think this is reasonable to require by anybody building Sage from source on OS X 10.7, given that XCode is free._


---

Comment by leif created at 2012-04-13 16:02:48

Replying to [comment:5 jdemeyer]:
> Replying to [comment:3 leif]:
> > Also, are all possible versions of XCode's Clang capable of building GCC?
> I'm not sure.  But at least one person reported being able to build GCC with Apple's Clang but not with Apple's GCC.

Something worth to add to the README(?) / installation instructions.

Perhaps some might have a broken [Apple] GCC, while others may have a Clang version of Apple not suited to build GCC.  Or just add that one should install the latest version of XCode on MacOS X 10.7.x, as William suggested.


---

Comment by jdemeyer created at 2012-04-14 11:25:22

Changing status from needs_work to needs_review.


---

Attachment

Changed the patch to only set `CC=clang` if `[ "$SAGE_BUILD_TOOLCHAIN" = yes ]`.


---

Comment by leif created at 2012-04-14 12:41:42

Changing status from needs_review to positive_review.


---

Comment by leif created at 2012-04-14 12:41:42

Replying to [comment:8 jdemeyer]:
> Changed the patch to only set `CC=clang` if `[ "$SAGE_BUILD_TOOLCHAIN" = yes ]`.

Patch looks ok (and applies to beta13), I just still wonder whether that shouldn't simply be done in `spkg/install` (where also `SAGE_BUILD_TOOLCHAIN` is set; it isn't set anywhere else).

Is there any scenario where a script sourcing `sage-env` (or called by one which does) would need `CC=clang` if `SAGE_BUILD_TOOLCHAIN=yes`, but *isn't* (indirectly) called by `spkg/install` / the "second level" `make`?  (Probably you have some further plans...)

I don't think I'm going to actually test that (on Lion), so rather "theoretical" positive review.  (If someone objects, of course feel free to revert it.)


---

Comment by leif created at 2012-04-14 12:44:22

P.S.: Is the `config.log` from the failure in the description available?  Just curious how or why exactly it failed...


---

Comment by jdemeyer created at 2012-04-14 20:25:37

`config.log`: I've seen it once or a few times, but I can't find it again.  It's some kind of Internal Compiler Error.  Basically, the GCC built by Apple's gcc totally doesn't work, even `-O0` doesn't help.


---

Comment by jdemeyer created at 2012-04-19 06:40:33

Resolution: fixed
