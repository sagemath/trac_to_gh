# Issue 14787: Add Hankel functions and make spherical Bessel and Hankel functions symbolic

Issue created by migration from https://trac.sagemath.org/ticket/15024

Original creator: eviatarbach

Original creation time: 2013-08-09 00:00:25

CC:  burcin chapoton paulmasson

For some reason Sage has spherical Hankel functions but not regular ones. This patch adds Hankel functions and makes spherical Hankel and Bessel functions symbolic, as well as adding arbitrary-precision numeric evaluation.


---

Attachment


---

Comment by eviatarbach created at 2013-08-09 00:04:22

Changing status from new to needs_review.


---

Comment by eviatarbach created at 2013-08-09 00:04:22

Note that this also changes the LaTeX representation for the other Bessel functions by removing `\operatorname`, since in all sources I've seen the function name is italicized.

Patchbot apply trac15024.patch


---

Comment by eviatarbach created at 2013-09-01 01:19:09

New patch gets coverage to 100%, adds `_latex_` methods (for getting a LaTeX representation for the function without arguments), and adds `\left` and `\right` to `_print_latex_`, which I forgot before.

Patchbot apply trac15024_2.patch


---

Attachment


---

Comment by kcrisman created at 2014-04-22 14:50:37

Note also the Struve functions

```
struve_h (v,z)                 Struve H function
struve_l (v,z)                 Struve L function
```

noted at [the symbolics wiki on Trac](http://trac.sagemath.org/wiki/symbolics/functions), which seem to go with the Hankels...


---

Comment by eviatarbach created at 2014-04-23 07:05:36

Yeah, those should be easy to add, although maybe in another ticket.


---

Comment by kcrisman created at 2014-04-23 14:22:31

Sure, this is #16221 now.  By the way, do we really want the Hankel stuff in bessel.py?


---

Comment by rws created at 2014-05-12 08:40:06

Made commit from patch, removed merge conflicts. However:

```
sage -t --long src/sage/functions/special.py  # 2 doctests failed
sage -t --long src/sage/functions/bessel.py  # 12 doctests failed
```


----
New commits:


---

Comment by rws created at 2014-05-12 08:40:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-07-17 14:33:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-07-17 14:39:01

Please review. As to which category Hankel functions are in, if not "bessel", I would propose this hierarchy for orientation: special functions--->holonomic functions--->Bessel functions


---

Comment by rws created at 2014-07-17 14:39:01

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-08-06 16:18:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-20 14:15:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-13 07:39:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-13 08:01:30

Just to let you know: this conflicts with #17130.


---

Comment by git created at 2014-12-11 14:14:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-23 16:27:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-04-20 08:01:49

#18257 makes this ticket fail doctests.


---

Comment by kcrisman created at 2015-05-22 12:31:38

Possibly not a bug with _this_ ticket but in Maxima (actually I think it's in our exponential integral), a branch cut difference between us and Mma in the integral:

```
sage: f(x) = Ei(-I*x) - 6*gamma(-1, I*x) - 15*gamma(-2, I*x) - 15*gamma(-3, I*x)
sage: f(3)
Ei(-3*I) - 6*gamma(-1, 3*I) - 15*gamma(-2, 3*I) - 15*gamma(-3, 3*I)
sage: f(3.)
-0.529089163583971 - 3.36665821311941*I
sage: g(x) = e^(-i*x)/x^3*(i*x^2+5*x-5*i)
sage: g(3.)
```

Also, the spherical Hankels don't make it into the top matter in the reference page - a very brief mention should suffice.


---

Comment by kcrisman created at 2015-05-22 12:45:11

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2015-05-22 12:45:11

[Wikipedia](http://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn.2C_yn) and [DLMF](http://dlmf.nist.gov/10.51) agree that the derivative formulas for the various spherical functions only apply if the index is an integer.  I'm not sure how this connects to [W|A](http://www.wolframalpha.com/input/?i=derivative+of+spherical+bessel+j)'s solution to that.

Also

```
sage: integrate(spherical_bessel_J(1,x)^2,(x,0,oo))
1/6*pi
sage: integrate(spherical_bessel_Y(1,x)^2,(x,0,oo))
-1/6*pi
```

is just too cool not to include.

This is very nicely put together and other than these comments mostly needs just pseudo-random testing that mpmath or whoever doesn't have any weird error spots.  'Needs work' for updating updating documentation, otherwise 'needs info' for the other points raised.


---

Comment by kcrisman created at 2015-05-22 12:49:17

(By the way, I don't know if I want to make #18257 a prereq for adding more symbolic special functions; I totally agree that it should not be ignored, but in the meantime making that arbitrary `+100` bigger again seems better than waiting for someone to figure out a long-term solution to that and then holding various tickets hostage.)


---

Comment by kcrisman created at 2015-06-01 14:19:39

#18257 is good now.


---

Comment by git created at 2015-07-02 07:49:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-07-02 07:50:15

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-08-03 07:15:32

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-08-03 07:15:58

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-10-24 07:47:03

The failing doctest is because with this ticket the expression returned by `random_expr(20, nvars=2)` suddenly contains the nonsymbolic `floor` function which triggers the fail via

```
sage: floor(x,hold=True)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-8-fc5809e0a430> in <module>()
----> 1 floor(x,hold=True)

TypeError: __call__() got an unexpected keyword argument 'hold'
```

Since this is completely unrelated I'll open a separate ticket. EDIT: See #19464.


---

Comment by rws created at 2016-04-03 15:31:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-04-03 15:33:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-04 07:10:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-04-04 07:11:42

Changing status from needs_work to needs_review.


---

Comment by rws created at 2016-06-14 08:07:15

Changing status from needs_review to needs_work.


---

Comment by paulmasson created at 2016-07-05 00:46:14

Symbolic `floor`currently accepts `hold=True`, as does `ceil`. Why is the ticket still dependent on #12121?

Also, in investigating inaccuracies in plotting spherical Bessel functions for arguments less than one I came across this error:


```
sage: spherical_bessel_J(3,.1)
0.951851972086556*l - 5
```


This was supposedly fixed in#2494 but it's back. Will it be fixed when this ticket is merged?

I'd be happy to review this as soon as it's ready to go.


---

Comment by rws created at 2016-07-05 06:05:48

Replying to [comment:37 paulmasson]:
> Symbolic `floor`currently accepts `hold=True`, as does `ceil`. Why is the ticket still dependent on #12121?

You're right. That somehow changed in the meantime.

> Also, in investigating inaccuracies in plotting spherical Bessel functions for arguments less than one I came across this error:
> 
> {{{
> sage: spherical_bessel_J(3,.1)
> 0.951851972086556*l - 5
> }}}

I resolved merge conflicts and, based on beta6, I get

```
sage: spherical_bessel_J(3,.1)
9.51851972086557e-6
```



---

Comment by git created at 2016-07-05 07:09:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-05 07:12:02

I also finally removed unused code in `special.py` and moved associated doctests to better locations. Hope it didn't increase your task too much.


---

Comment by rws created at 2016-07-05 07:12:02

Changing status from needs_work to needs_review.


---

Comment by paulmasson created at 2016-07-05 20:17:36

Updating `special.py` is appropriate to this ticket. In response to a [comment](https://trac.sagemath.org/ticket/15024#comment:6) above, Hankel stuff most certainly belongs in bessel.py since they are Bessel functions.

Unfortunately I'm now seeing changes to `airy.py` and `jacobi.py` that are not appropriate to this ticket. Please fix that.

Also, the branch is missing: can't checkout what's not there!


---

Comment by paulmasson created at 2016-07-05 20:59:42

The apparently missing branch is due to server maintenance.


---

Comment by rws created at 2016-07-06 05:30:07

Replying to [comment:41 paulmasson]:
> Unfortunately I'm now seeing changes to `airy.py` and `jacobi.py` that are not appropriate to this ticket. Please fix that.

I was just moving doctests away from `special.py`. But I can add them to those files in another ticket, no problem, as long as you don't mind that I'm removing them in this ticket.


---

Comment by git created at 2016-07-06 13:08:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-07-07 01:32:28

When running doctests I get the message


```
ImportError: cannot import name meval
```


Similar error when trying to build documentation. Sage crashes on startup, with message in crash log:


```
---> 56 from sage.functions.special import meval
...
ImportError: cannot import name meval
```



---

Comment by git created at 2016-07-07 05:37:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-07 05:38:30

Oops, the change in `airy.pyx` is necessary because `meval` no longer exists.


---

Comment by paulmasson created at 2016-07-08 01:08:22

Doctests all pass. Documentation builds and has multiple preexisting issues, but that should be on a separate ticket.

Random numeric testing of new Hankel functions is accurate. Both functions plot. Symbolics behave as expected.

Per #20496 we are now supposed to escape abbreviated first names in references. There are three instances in the current branch that don't do that. If you fix those then I think it's ready to go.

There are changes in here I was planning to make, so I'm glad I read your list of open symbolics tickets beforehand!


---

Comment by git created at 2016-07-08 12:48:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-08 12:53:30

Thanks for the review. It's good to see again someone is interested in special functions. I am motivated in having at least the most known holonomic functions implemented symbolically (for experimental symbolics) but had stopped because very few tickets were reviewed.
----
New commits:


---

Comment by paulmasson created at 2016-07-08 17:53:41

Positive review after cosmetic changes but there is now a merge conflict with 7.3.beta7.

Do I need to review again after conflict is resolved? What's the protocol on this?


---

Comment by git created at 2016-07-09 06:12:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-09 06:56:50

Replying to [comment:52 paulmasson]:
> Do I need to review again after conflict is resolved? What's the protocol on this?

In principle I could have introduced any possible change with it, so yes. But it is easy to check this, either per eyeball by skimming the diff again, or automatically (I just tried this the first time ever):

```
git diff develop >diff1
git co 821c307        (the commit before the merge)
git diff 7.3.beta6 >diff2
diff -u diff2 diff1
```

The output of the last diff should not contain lines that start with `++/+-/-+/--`. This way I found I somehow introduced some `orig` files into the branch so I'll delete those files. But as introducing and removing these files create completely unnecessary data I'll upload a new branch with an improved merge commit.


---

Comment by paulmasson created at 2016-07-10 04:24:26

Doctests pass and documentation builds. Numerics look good. A few problems resulting from the merge conflict resolution:

1) A line has been modified in `hypergeometric.py`. This modification appears to be inaccurate and has the wrong variable anyway. Please remove the condition `x>0` on `hypergeometric_U`.

2) The definition of the spherical Bessel function of the second kind has been left behind in `special.py` after the definition of spherical harmonics. This one needs to be deleted since it's already in `bessel.py`.

3) The evaluation of spherical harmonics has changed. I'm assuming this is because `meval` is gone, but please confirm. This change has no apparent problems.

4) There are doctests added to the complete elliptic integral which are outside this ticket. Since they pass I'm fine leaving them here, but let me know that they are included just to avoid an extra ticket.

----
New commits:


---

Comment by git created at 2016-07-10 06:32:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-10 06:36:12

Replying to [comment:56 paulmasson]:
> 3) The evaluation of spherical harmonics has changed. I'm assuming this is because `meval` is gone, but please confirm.
Yes.
> 4) There are doctests added to the complete elliptic integral which are outside this ticket. Since they pass I'm fine leaving them here, but let me know that they are included just to avoid an extra ticket.
I cannot avoid the extra ticket but would ask you to leave this part in for now.


---

Comment by paulmasson created at 2016-07-10 17:40:53

Changing status from needs_review to positive_review.


---

Comment by paulmasson created at 2016-07-10 17:40:53

Good to go.


---

Comment by rws created at 2016-07-11 08:02:39

Thanks for your patient work.


---

Comment by vbraun created at 2016-07-12 07:25:37

Resolution: fixed
