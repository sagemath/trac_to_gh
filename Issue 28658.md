# Issue 28658: Meta ticket: Simplify and speed up graph backends

archive/issues_028658.json:
```json
{
    "body": "CC:  @dcoudert @kliem\n\nKeywords: graphs, backends\n\nThis ticket collects tickets simplifying and improving the graph backends.\n\nIt is motivated by the following post:\n\nhttps://groups.google.com/d/msg/sage-devel/JhirgrbcFMc/CVfHhPCdAgAJ\n\nIssue created by migration from https://trac.sagemath.org/ticket/28895\n\n",
    "created_at": "2019-12-18T20:12:51Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta ticket: Simplify and speed up graph backends",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28658",
    "user": "@kliem"
}
```
CC:  @dcoudert @kliem

Keywords: graphs, backends

This ticket collects tickets simplifying and improving the graph backends.

It is motivated by the following post:

https://groups.google.com/d/msg/sage-devel/JhirgrbcFMc/CVfHhPCdAgAJ

Issue created by migration from https://trac.sagemath.org/ticket/28895





---

archive/issue_comments_404759.json:
```json
{
    "body": "The idea is that in the end, most top level function should be handled in `c_graph.pyx`.\nIf possible, only the low level functions are done separate for each backend.\n\nOnce things are unified (as good as different backends allow), one should speed up things. E.g. the following is extremely slow:\n\n\n```\nsage: import itertools\nsage: def test_speed(n):\n....:     G = Graph(n, data_structure='dense')\n....:     edges = itertools.combinations(range(n), 2)\n....:     %time G.add_edges(edges)\n....:     edges = itertools.combinations(range(n), 2)\n....:     %time G.delete_edges(edges)\nsage: test_speed(1000)\nCPU times: user 175 ms, sys: 8 \u00b5s, total: 175 ms\nWall time: 175 ms\nCPU times: user 574 ms, sys: 0 ns, total: 574 ms\nWall time: 574 ms\n```\n\nI got both things down to about 80 ms by calling `add_edges` on the top level and then actually using the unsafe methods wherever possible (if we already obtained the indices safely, there should be nothing preventing as from using unsafe methods). Similar for `delete_edges`.",
    "created_at": "2019-12-18T20:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404759",
    "user": "@kliem"
}
```

The idea is that in the end, most top level function should be handled in `c_graph.pyx`.
If possible, only the low level functions are done separate for each backend.

Once things are unified (as good as different backends allow), one should speed up things. E.g. the following is extremely slow:


```
sage: import itertools
sage: def test_speed(n):
....:     G = Graph(n, data_structure='dense')
....:     edges = itertools.combinations(range(n), 2)
....:     %time G.add_edges(edges)
....:     edges = itertools.combinations(range(n), 2)
....:     %time G.delete_edges(edges)
sage: test_speed(1000)
CPU times: user 175 ms, sys: 8 µs, total: 175 ms
Wall time: 175 ms
CPU times: user 574 ms, sys: 0 ns, total: 574 ms
Wall time: 574 ms
```

I got both things down to about 80 ms by calling `add_edges` on the top level and then actually using the unsafe methods wherever possible (if we already obtained the indices safely, there should be nothing preventing as from using unsafe methods). Similar for `delete_edges`.



---

archive/issue_comments_404760.json:
```json
{
    "body": "Adding this, because I missed it on my first try to optimize `add_edges`. This would have created a mistake in `BipartiteGraph` without a doctest catching on.",
    "created_at": "2019-12-18T20:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404760",
    "user": "@kliem"
}
```

Adding this, because I missed it on my first try to optimize `add_edges`. This would have created a mistake in `BipartiteGraph` without a doctest catching on.



---

archive/issue_comments_404761.json:
```json
{
    "body": "just mentioned that #25465, #28865 are for the same issue.",
    "created_at": "2019-12-20T12:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404761",
    "user": "@dcoudert"
}
```

just mentioned that #25465, #28865 are for the same issue.



---

archive/issue_comments_404762.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404762",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_404763.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404763",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_404764.json:
```json
{
    "body": "#22349 could also be part of this task.",
    "created_at": "2020-04-18T10:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404764",
    "user": "@dcoudert"
}
```

#22349 could also be part of this task.



---

archive/issue_comments_404765.json:
```json
{
    "body": "With #30776 and #30777 things are looking much better:\n\n\n```\nsage: test_speed(1000)                                                                                                                                                                                                                                                                                                                                                     \n\nnow doing dense\nadding edges\nCPU times: user 81.9 ms, sys: 0 ns, total: 81.9 ms\nWall time: 81.9 ms\ncopy to dense\nCPU times: user 10.2 ms, sys: 0 ns, total: 10.2 ms\nWall time: 10.2 ms\ncopy to sparse\nCPU times: user 89.5 ms, sys: 7.87 ms, total: 97.4 ms\nWall time: 97.1 ms\ncopy to statice sparse\nCPU times: user 423 ms, sys: 11.9 ms, total: 435 ms\nWall time: 435 ms\ndelete edges\nCPU times: user 79.1 ms, sys: 0 ns, total: 79.1 ms\nWall time: 79.1 ms\ncopying static sparse to dense\nCPU times: user 81.3 ms, sys: 51 \u00b5s, total: 81.4 ms\nWall time: 81.4 ms\n\nnow doing sparse\nadding edges\nCPU times: user 169 ms, sys: 0 ns, total: 169 ms\nWall time: 169 ms\ncopy to dense\nCPU times: user 158 ms, sys: 0 ns, total: 158 ms\nWall time: 158 ms\ncopy to sparse\nCPU times: user 290 ms, sys: 0 ns, total: 290 ms\nWall time: 290 ms\ncopy to statice sparse\nCPU times: user 544 ms, sys: 0 ns, total: 544 ms\nWall time: 544 ms\ndelete edges\nCPU times: user 166 ms, sys: 0 ns, total: 166 ms\nWall time: 166 ms\ncopying static sparse to sparse\nCPU times: user 187 ms, sys: 0 ns, total: 187 ms\nWall time: 187 ms\nsage: test_speed(2000)                                                                                                                                                                                                                                                                                                                                                     \n\nnow doing dense\nadding edges\nCPU times: user 340 ms, sys: 0 ns, total: 340 ms\nWall time: 340 ms\ncopy to dense\nCPU times: user 40.9 ms, sys: 0 ns, total: 40.9 ms\nWall time: 40.8 ms\ncopy to sparse\nCPU times: user 396 ms, sys: 3.93 ms, total: 400 ms\nWall time: 400 ms\ncopy to statice sparse\nCPU times: user 2 s, sys: 68 ms, total: 2.07 s\nWall time: 2.07 s\ndelete edges\nCPU times: user 321 ms, sys: 32 \u00b5s, total: 321 ms\nWall time: 321 ms\ncopying static sparse to dense\nCPU times: user 396 ms, sys: 0 ns, total: 396 ms\nWall time: 396 ms\n\nnow doing sparse\nadding edges\nCPU times: user 768 ms, sys: 0 ns, total: 768 ms\nWall time: 768 ms\ncopy to dense\nCPU times: user 791 ms, sys: 0 ns, total: 791 ms\nWall time: 791 ms\ncopy to sparse\nCPU times: user 1.32 s, sys: 48 ms, total: 1.36 s\nWall time: 1.36 s\ncopy to statice sparse\nCPU times: user 2.48 s, sys: 0 ns, total: 2.48 s\nWall time: 2.48 s\ndelete edges\nCPU times: user 825 ms, sys: 0 ns, total: 825 ms\nWall time: 825 ms\ncopying static sparse to sparse\nCPU times: user 876 ms, sys: 0 ns, total: 876 ms\nWall time: 876 ms\n```\n",
    "created_at": "2020-10-16T14:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404765",
    "user": "@kliem"
}
```

With #30776 and #30777 things are looking much better:


```
sage: test_speed(1000)                                                                                                                                                                                                                                                                                                                                                     

now doing dense
adding edges
CPU times: user 81.9 ms, sys: 0 ns, total: 81.9 ms
Wall time: 81.9 ms
copy to dense
CPU times: user 10.2 ms, sys: 0 ns, total: 10.2 ms
Wall time: 10.2 ms
copy to sparse
CPU times: user 89.5 ms, sys: 7.87 ms, total: 97.4 ms
Wall time: 97.1 ms
copy to statice sparse
CPU times: user 423 ms, sys: 11.9 ms, total: 435 ms
Wall time: 435 ms
delete edges
CPU times: user 79.1 ms, sys: 0 ns, total: 79.1 ms
Wall time: 79.1 ms
copying static sparse to dense
CPU times: user 81.3 ms, sys: 51 µs, total: 81.4 ms
Wall time: 81.4 ms

now doing sparse
adding edges
CPU times: user 169 ms, sys: 0 ns, total: 169 ms
Wall time: 169 ms
copy to dense
CPU times: user 158 ms, sys: 0 ns, total: 158 ms
Wall time: 158 ms
copy to sparse
CPU times: user 290 ms, sys: 0 ns, total: 290 ms
Wall time: 290 ms
copy to statice sparse
CPU times: user 544 ms, sys: 0 ns, total: 544 ms
Wall time: 544 ms
delete edges
CPU times: user 166 ms, sys: 0 ns, total: 166 ms
Wall time: 166 ms
copying static sparse to sparse
CPU times: user 187 ms, sys: 0 ns, total: 187 ms
Wall time: 187 ms
sage: test_speed(2000)                                                                                                                                                                                                                                                                                                                                                     

now doing dense
adding edges
CPU times: user 340 ms, sys: 0 ns, total: 340 ms
Wall time: 340 ms
copy to dense
CPU times: user 40.9 ms, sys: 0 ns, total: 40.9 ms
Wall time: 40.8 ms
copy to sparse
CPU times: user 396 ms, sys: 3.93 ms, total: 400 ms
Wall time: 400 ms
copy to statice sparse
CPU times: user 2 s, sys: 68 ms, total: 2.07 s
Wall time: 2.07 s
delete edges
CPU times: user 321 ms, sys: 32 µs, total: 321 ms
Wall time: 321 ms
copying static sparse to dense
CPU times: user 396 ms, sys: 0 ns, total: 396 ms
Wall time: 396 ms

now doing sparse
adding edges
CPU times: user 768 ms, sys: 0 ns, total: 768 ms
Wall time: 768 ms
copy to dense
CPU times: user 791 ms, sys: 0 ns, total: 791 ms
Wall time: 791 ms
copy to sparse
CPU times: user 1.32 s, sys: 48 ms, total: 1.36 s
Wall time: 1.36 s
copy to statice sparse
CPU times: user 2.48 s, sys: 0 ns, total: 2.48 s
Wall time: 2.48 s
delete edges
CPU times: user 825 ms, sys: 0 ns, total: 825 ms
Wall time: 825 ms
copying static sparse to sparse
CPU times: user 876 ms, sys: 0 ns, total: 876 ms
Wall time: 876 ms
```




---

archive/issue_comments_404766.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28658#issuecomment-404766",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.
