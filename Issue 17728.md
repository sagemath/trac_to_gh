# Issue 17728: Uniformization of the API to compute the inverse of an element.

Issue created by migration from https://trac.sagemath.org/ticket/17965

Original creator: nthiery

Original creation time: 2015-03-16 17:41:01

CC:  saliola vdelecroix simonking slelievre tscrim

Some classes in Sage implement the inverse of an element through the
inverse method:

```
mistral-/opt/sage/src/sage>grep "def inverse(" **/*.py
algebras/finite_dimensional_algebras/finite_dimensional_algebra_element.py:    def inverse(self):
algebras/iwahori_hecke_algebra.py:            def inverse(self):
categories/coxeter_groups.py:        def inverse(self):
combinat/affine_permutation.py:    def inverse(self):
combinat/permutation.py:    def inverse(self):
combinat/tableau_tuple.py:    def inverse(self,k):
crypto/classical_cipher.py:    def inverse(self):
crypto/classical_cipher.py:    def inverse(self):
crypto/classical_cipher.py:    def inverse(self):
crypto/classical_cipher.py:    def inverse(self):
dynamics/interval_exchanges/iet.py:    def inverse(self):
groups/abelian_gps/element_base.py:    def inverse(self):
groups/abelian_gps/values.py:    def inverse(self):
groups/affine_gps/group_element.py:    def inverse(self):
modules/matrix_morphism.py:    def inverse(self):
rings/number_field/class_group.py:    def inverse(self):
rings/universal_cyclotomic_field/universal_cyclotomic_field.py:        def inverse(self):
schemes/elliptic_curves/formal_group.py:    def inverse(self, prec=20):
schemes/elliptic_curves/weierstrass_transform.py:    def inverse(self):
```


Some other through the ``__invert__`` method:

```
mistral-/opt/sage/src/sage>grep "def __invert__(" **/*.py 
categories/algebras_with_basis.py:        def __invert__(self):
categories/magmas.py:                def __invert__(self):
categories/modules_with_basis.py:    def __invert__(self):
categories/modules_with_basis.py:    def __invert__(self):
combinat/combinatorial_algebra.py:    def __invert__(self):
combinat/sf/dual.py:        def __invert__(self):
combinat/species/generating_series.py:    def __invert__(self):
groups/indexed_free_group.py:        def __invert__(self):
groups/indexed_free_group.py:        def __invert__(self):
groups/matrix_gps/group_element.py:    def __invert__(self):
groups/raag.py:        def __invert__(self):
libs/coxeter3/coxeter_group.py:        def __invert__(self):
logic/boolformula.py:    def __invert__(self):
misc/sage_input.py:    def __invert__(self):
modular/dirichlet.py:    def __invert__(self):
modular/local_comp/smoothchar.py:    def __invert__(self):
modules/matrix_morphism.py:    def __invert__(self):
rings/continued_fraction.py:    def __invert__(self):
rings/finite_rings/element_ext_pari.py:    def __invert__(self):
rings/function_field/function_field_ideal.py:    def __invert__(self):
rings/infinity.py:    def __invert__(self):
rings/multi_power_series_ring_element.py:    def __invert__(self):
rings/number_field/morphism.py:    def __invert__(self):
rings/number_field/number_field_ideal.py:    def __invert__(self):
rings/number_field/number_field_ideal_rel.py:    def __invert__(self):
rings/pari_ring.py:    def __invert__(self):
rings/polynomial/polynomial_quotient_ring_element.py:    def __invert__(self):
rings/qqbar.py:    def __invert__(self):
rings/quotient_ring_element.py:    def __invert__(self):
rings/universal_cyclotomic_field/universal_cyclotomic_field.py:        def __invert__(self):
sandpiles/sandpile.py:    def __invert__(self):
schemes/elliptic_curves/heegner.py:    def __invert__(self):
schemes/elliptic_curves/height.py:    def __invert__(self):
schemes/elliptic_curves/weierstrass_morphism.py:    def __invert__(self):
schemes/elliptic_curves/weierstrass_morphism.py:    def __invert__(self):
schemes/hyperelliptic_curves/monsky_washnitzer.py:    def __invert__(self):
structure/factorization.py:    def __invert__(self):
```


Usually they provide a crosslink so that ``__invert__`` and
``inverse`` are equivalent, but this is done on a case by case bases,
so of course such links are missing here and there:

```
sage: ~AA(sqrt(~2))
1.414213562373095?
sage: AA(sqrt(~2)).inverse()
...
AttributeError: 'AlgebraicReal' object has no attribute 'inverse'
```



```
sage: R.<u,v,w> = QQ[]
sage: f = EllipticCurve_from_cubic(u^3 + v^3 + w^3, [1,-1,0], morphism=True)
sage: f.inverse()
Scheme morphism:
...
sage: ~f
...
TypeError: bad operand type for unary ~: 'WeierstrassTransformationWithInverse_class'
```



Shall we change the code to systematically implement ``__invert__`` as
per Python's convention, and then implement the cross link ``inverse``
-> ``__invert__`` once for all high up in the class hierarchy,
typically in Magmas.ElementMethods?

Caveat: this won't cover all cases since we have invertible elements
that don't belong to a magma; e.g. a isomorphisms between two
different parents; so it will still be necessary to handle a couple
special cases by hand.

See also comment about ``__inverse__`` in
sage.categories.coxeter_groups.py around line 699.

Note: the default implementation ~f = 1/f provided by Element should
probably be implemented in Monoids.ElementMethods; see also #17692.

Note: the qqbar classes also implement an "invert" method, but that's
for a slightly different use case. So we may, or not, want to make
this uniform too. `invert` does not fit Sage's usual verb/noun
convention since it's a verb while it is not inplace.


---

Comment by chapoton created at 2020-07-07 14:44:14

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-07-07 14:44:14

Here is a first attempt. Opinions ?
----
New commits:


---

Comment by git created at 2020-07-07 17:27:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-07-07 19:04:05

In general I think unifying this is a good idea. Something to keep in mind is that `__invert__` will not show up in the documentation, by default. If in some cases there are extensive examples, it could be added to the documentation using `automethod`, though. Probably this is not needed for most of the elements, but in #29723 (inverses of ring homomorphisms) this is the reason why I linked `__invert__` to `inverse`.


---

Comment by git created at 2020-07-07 19:36:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-08 06:32:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-08 06:37:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-07-08 06:41:56

oh, boy, now with an infinite loop in

```
sage -t --long --warn-long 61.5 src/sage/monoids/free_monoid_element.py
```



---

Comment by chapoton created at 2020-08-13 07:37:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-19 08:09:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-01 12:40:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-08 09:17:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-11-08 09:23:01

I am thinking to move the "Inverse" axioms from magmas to monoids. 

Because the notion of inverse does not really make sense in magmas, where left and right inverses can be different.


```
src/sage/categories/magmas.py:        class Inverse(CategoryWithAxiom):
```



---

Comment by nthiery created at 2020-11-08 13:25:49

We may eventually need to have weaker axioms LeftInverses and RightInverses.
But is there an inconvenient in having an axiom that states the existence
of both a left and right inverse that coïncide?


---

Comment by chapoton created at 2020-11-08 13:46:05

Hé, salut. J'essaye juste de démeler la situation, et j'ai une boucle infinie magma->monoid->magma etc etc


---

Comment by nthiery created at 2020-11-08 13:59:45

Salut Frédéric :-)

Ah I see; things like this indeed happen, though hopefully there is a way out.
If it can help, we could have a live chat about it, though not before Tuesday.

Amitiés,


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2022-05-23 18:44:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-24 07:54:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-27 06:27:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-07 08:10:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-07 10:22:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-07 10:23:53

almost ready to go. I hope that somebody will accept to review this long-awaited ticket.


---

Comment by git created at 2022-09-07 12:03:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-07 15:07:34

and the patchbot is now green ! comments welcome


---

Comment by chapoton created at 2022-09-07 15:07:34

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-09-07 15:41:44


```
+        def inverse(self):
+            """
+            Return the inverse of ``self``.
+
+            This an alias for inversion, defined in ``__invert__``.
+
```

"is" is missing


---

Comment by mkoeppe created at 2022-09-07 15:46:04

Do you want to address comment:4 and add some `automethod`?


---

Comment by git created at 2022-09-07 16:44:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-07 16:59:31

I am not so sure about this question about documentation. It is true that the doc inside `__invert__` will be hidden from view.


---

Comment by tscrim created at 2022-09-07 23:49:00

I don't think too many people are going to be looking at the documentation of `__invert__` or `inverse()` as that is generally pretty clear.

That being said, I am not really a fan of putting technical implementation details in public documentation:

```diff
-            This is an alias for inversion, defined in ``__invert__``.
+            This is an alias for inversion, which can be invoked by ``~x``
+            for an instance ``x``.
-
-            Element classes should implement ``__invert__`` only.
```

I would probably put the last part as a code comment. However, in this case, because it is specifications for implementors, it could be okay. The change in the first part is to indicate how a more casual user can use this.

What about for additive monoids? Perhaps we need to add "multiplicative" to the documentation above.

I am not sure how I feel about removing the generic `1 / self` for inverse in `Element`. Is that implemented in one of the categories? Should we be worried about a slowdown with it no longer being Cython?


---

Comment by git created at 2022-09-08 07:17:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-08 07:20:59

Replying to [comment:36 Travis Scrimshaw]:
> I don't think too many people are going to be looking at the documentation of `__invert__` or `inverse()` as that is generally pretty clear.

I agree on that point.
 
> That being said, I am not really a fan of putting technical implementation details in public documentation:
> {{{#!diff
> -            This is an alias for inversion, defined in ``__invert__``.
> +            This is an alias for inversion, which can be invoked by ``~x``
> +            for an instance ``x``.
> -
> -            Element classes should implement ``__invert__`` only.
> }}}
> I would probably put the last part as a code comment. However, in this case, because it is specifications for implementors, it could be okay. The change in the first part is to indicate how a more casual user can use this.

I have changed that according to your suggestion. Implementation detail is now a comment in the code.

> What about for additive monoids? Perhaps we need to add "multiplicative" to the documentation above.

I have no idea. I thought that there was another category for additive monoids ?

> I am not sure how I feel about removing the generic `1 / self` for inverse in `Element`. Is that implemented in one of the categories? Should we be worried about a slowdown with it no longer being Cython?

This is indeed a delicate point. Having both that and the division defined using product by the inverse easily leads to infinite loops. It seems safer to break the possibility of this kind of loop.


---

Comment by tscrim created at 2022-09-08 08:11:29

Replying to [comment:38 Frédéric Chapoton]:
> Replying to [comment:36 Travis Scrimshaw]:
> > That being said, I am not really a fan of putting technical implementation details in public documentation:
> > {{{#!diff
> > -            This is an alias for inversion, defined in ``__invert__``.
> > +            This is an alias for inversion, which can be invoked by ``~x``
> > +            for an instance ``x``.
> > -
> > -            Element classes should implement ``__invert__`` only.
> > }}}
> > I would probably put the last part as a code comment. However, in this case, because it is specifications for implementors, it could be okay. The change in the first part is to indicate how a more casual user can use this.
> 
> I have changed that according to your suggestion. Implementation detail is now a comment in the code.

Thank you.

> > What about for additive monoids? Perhaps we need to add "multiplicative" to the documentation above.
> 
> I have no idea. I thought that there was another category for additive monoids ?

There is, but we try to keep the two somewhat consistent. There is also the join category, where "inverse" becomes slightly vague.

> > I am not sure how I feel about removing the generic `1 / self` for inverse in `Element`. Is that implemented in one of the categories? Should we be worried about a slowdown with it no longer being Cython?
> 
> This is indeed a delicate point. Having both that and the division defined using product by the inverse easily leads to infinite loops. It seems safer to break the possibility of this kind of loop.

I would rather have the infinite loop (which there are protections against) and leave the choice of implementation to the developer. If it does go into an infinite loop, it is indicating that something needs to be implemented (unfortunately, I don't know a good mechanism for checking this). At the very least it is a backwards incompatible change.


---

Comment by git created at 2022-09-08 09:29:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-08 09:34:10

I see no way out other than removing the ``__invert__`` in element.pyx. It is not a cdef method there, by the way. I agree that this is rather backward-incompatible..


---

Comment by tscrim created at 2022-09-08 10:11:59

But basically you want to remove the `1 / self` default implementation to never have an infinite loop? In particular, if we had some sort of ``@`implement_this_or_that` type decorator, you would be fine with it? Or is there a technical issue with having it defined in the category?

I am particularly worried about someone could have implemented an algebraic structure just through `_div_`, and there are things in Sage that use `~x` that are subsequently being called with this algebraic structure. I could imagine something like this for polynomials (without going to the fraction field).


---

Comment by chapoton created at 2022-09-08 11:51:54

here is an experimental branch with the default inverse re-activated, let us see what happens.
----
New commits:


---

Comment by chapoton created at 2022-09-08 19:05:54

well, this seems to be almost green..


---

Comment by tscrim created at 2022-09-09 01:43:15

It seems like that is unrelated. Have you tested locally?


---

Comment by chapoton created at 2022-09-09 07:35:17

the failure is #33161 ; the tests in this file pass with other random seeds


---

Comment by tscrim created at 2022-09-10 00:32:42

I am basically ready to flip the switch. The last thing I probably would like (although not fully convinced) is to have an alias `inverse = __invert__` in the classes that implemented an `inverse` in order to keep the documentation there visible.


---

Comment by chapoton created at 2022-09-10 07:03:16

But this would basically contradict the fact that there is a unique global alias that maps `inverse` to `__invert__` ?


---

Comment by tscrim created at 2022-09-10 07:19:12

It isn't an alias in the Python sense. However, I didn't think your proposal said there should be a unique such redirect.

I don't see any advantages of trying to impose that (it isn't really enforceable either). I think if we are consistent about using `__invert__`, then we won't get a user saying "I get to chose which one I want to do" (not to mention generic division would not work). On the other hand, I don't think this documentation is generally useful though, and not having it would mean that there is a near 0% chance of confusion.


---

Comment by chapoton created at 2022-09-10 08:22:11

Sorry, I am now confused and not sure what you would like me to change.


---

Comment by tscrim created at 2022-09-10 08:27:58

For example, in `algebras/hecke_algebras/ariki_koike_algebra.py`, you are removing the `inverse` function. So it will no longer appear in the documentation and `x.inverse?` will be the generic documentation. I am think is adding a

```python
inverse = __invert__
```

alias there so the documentation won't change.

Anyways, it sounds like you don't really like it and I wasn't convinced of how useful it would be, so we can move on.


---

Comment by chapoton created at 2022-09-16 12:14:45

So, is this a positive review ?


---

Comment by tscrim created at 2022-09-16 12:41:56

Yes.


---

Comment by tscrim created at 2022-09-16 12:41:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-09-17 16:59:20

After these changes, is ticket #17692 still relevant?


---

Comment by tscrim created at 2022-09-17 22:54:50

#17692 is independent of these changes (and the main proposal has already been done somewhere else).

The issue of whether `__invert__` and the (very embedded) `~x` should not be bitwise inverse (compare `~int(5)` to `~Integer(5)`) is not impacted by this change (other than it might be slightly more work to make such a change, but it is now at least applied uniformly, so it is less likely we miss something IMO).


---

Comment by mkoeppe created at 2022-09-18 01:07:48

Replying to [comment:55 Travis Scrimshaw]:
> #17692 is independent of these changes (and the main proposal has already been done somewhere else).
> 
> The issue of whether `__invert__` and the (very embedded) `~x` should not be bitwise inverse (compare `~int(5)` to `~Integer(5)`) is not impacted by this change

No, the bitwise complement question is not the topic of #17692 (it is only mentioned in the very last comment)


---

Comment by tscrim created at 2022-09-18 01:37:41

Replying to [comment:56 Matthias Köppe]:
> Replying to [comment:55 Travis Scrimshaw]:
> > #17692 is independent of these changes (and the main proposal has already been done somewhere else).
> > 
> > The issue of whether `__invert__` and the (very embedded) `~x` should not be bitwise inverse (compare `~int(5)` to `~Integer(5)`) is not impacted by this change
> 
> No, the bitwise complement question is not the topic of #17692 (it is only mentioned in the very last comment)

Either way, #17692 is independent of this ticket. (It probably should be closed (again, the main change has been implemented elsewhere) or converted into a bitwise issue ticket.)


---

Comment by vbraun created at 2022-09-20 20:23:21

Resolution: fixed
