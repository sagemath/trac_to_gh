# Issue 29249: cygwin-standard: rpy2 fails to build

Issue created by migration from https://trac.sagemath.org/ticket/29486

Original creator: mkoeppe

Original creation time: 2020-04-09 16:49:23

CC:  charpent vdelecroix tscrim jpflori embray vbraun dimpase jhpalmieri @darijgr fbissey

This is using system R from cygwin, build running on the [GitHub](GitHub) Actions workflow from #29403:


```
gcc -shared -Wl,--enable-auto-image-base -L/cygdrive/d/a/sage/sage/local/lib -Wl,-rpath,/cygdrive/d/a/sage/sage/local/lib build/temp.cygwin-3.1.4-x86_64-3.7/./rpy/rinterface/_rinterface.o -L/usr/lib/R/lib -L/cygdrive/d/a/sage/sage/local/lib/python3.7/config -L/usr/lib -Lbuild/temp.cygwin-3.1.4-x86_64-3.7 -L/usr/lib/R/lib -lreadline -lR -lpcre -llzma -lbz2 -lz -ltirpc -lrt -ldl -lm -liconv -licuuc -licui18n -lpython3.7m -lr_utils -o build/lib.cygwin-3.1.4-x86_64-3.7/rpy2/rinterface/_rinterface.cpython-37m-x86_64-cygwin.dll -fopenmp
    /usr/lib/gcc/x86_64-pc-cygwin/9.3.0/../../../../x86_64-pc-cygwin/bin/ld: build/temp.cygwin-3.1.4-x86_64-3.7/libr_utils.a(r_utils.o): in function `rpy2_findfun':
    /tmp/pip-req-build-ymc5_3kd/./rpy/rinterface/r_utils.c:58: undefined reference to `Rf_findVarInFrame3'
    /tmp/pip-req-build-ymc5_3kd/./rpy/rinterface/r_utils.c:58:(.text+0xda): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `Rf_findVarInFrame3'
    /usr/lib/gcc/x86_64-pc-cygwin/9.3.0/../../../../x86_64-pc-cygwin/bin/ld: build/temp.cygwin-3.1.4-x86_64-3.7/libr_utils.a(r_utils.o): in function `rpy2_list_attr':
    /tmp/pip-req-build-ymc5_3kd/./rpy/rinterface/r_utils.c:129: undefined reference to `ATTRIB'
    /tmp/pip-req-build-ymc5_3kd/./rpy/rinterface/r_utils.c:129:(.text+0x340): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `ATTRIB'
    /usr/lib/gcc/x86_64-pc-cygwin/9.3.0/../../../../x86_64-pc-cygwin/bin/ld: build/temp.cygwin-3.1.4-x86_64-3.7/libr_utils.a(r_utils.o): in function `rpy2_remove':
    /tmp/pip-req-build-ymc5_3kd/./rpy/rinterface/r_utils.c:152: undefined reference to `Rf_lang4'
```


Full logs can be downloaded at:
- https://github.com/mkoeppe/sage/runs/572730287

The sage-local artifact that has been built can be downloaded at 
- https://github.com/mkoeppe/sage/suites/584124994/artifacts/4126694


---

Comment by mkoeppe created at 2020-04-09 16:49:43

Changing priority from major to critical.


---

Comment by vdelecroix created at 2020-04-10 07:08:57

Did you try the updated rpy2 package from #29441?


---

Comment by mkoeppe created at 2020-04-10 16:34:08

I haven't because this upgrade cannot be used for the 9.1 release cycle; but you can by using the testing infrastructure ticket #29403


---

Comment by mkoeppe created at 2020-04-15 03:24:46

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2020-04-19 19:37:42

Still a problem. I'm trying now whether an update to 2.8.6 (last py2-compatible release) helps


---

Comment by mkoeppe created at 2020-04-19 19:53:42

Same with 2.8.6


---

Comment by mkoeppe created at 2020-04-19 20:03:23

Trying #29441 now


---

Comment by mkoeppe created at 2020-04-19 21:16:34

OK, rpy2 3.2.7 from #29441 installs OK on Cygwin.


---

Comment by mkoeppe created at 2020-04-19 21:30:13

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-19 21:30:13

New commits:


---

Comment by jhpalmieri created at 2020-04-19 23:42:15

If #29441 fixes the problem, can't we just that instead? Or are you proposing this as a temporary solution until #29441 is ready?


---

Comment by mkoeppe created at 2020-04-20 00:32:08

We can't use #29441 because the new version is py3 only. 
When we make the switch to py3-only sage, we can reconsider.


---

Comment by jhpalmieri created at 2020-04-20 00:35:35

This leads to a policy question: does this failure on Cygwin mean that people on OS X, linux, etc., are deprived of having a Sage installation of R? (Does anyone download a Sage binary expecting to get a functioning installation of R?)

Actually, why should R be optional; shouldn't it just be rpy2?


---

Comment by mkoeppe created at 2020-04-20 00:39:00

Yes, we could just make rpy2 optional, that would be fine with me.

I don't really know if we have any users of R and of rpy2.


---

Comment by mkoeppe created at 2020-04-20 00:59:58

And unfortunately nobody responded to my message on sage-devel last month


---

Comment by git created at 2020-04-20 02:03:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-20 02:04:15

OK, how about this version


---

Comment by novoselt created at 2020-04-20 02:40:26

Users of [SageMathCell](SageMathCell) certainly do care about having R available and Sage interface to it functional (which, I believe, is based on rpy2 now). It also seemed to me that 9.1 does not have to support Python2, am I wrong on this?


---

Comment by mkoeppe created at 2020-04-20 02:42:38

Replying to [comment:22 novoselt]:
> Users of [SageMathCell](SageMathCell) certainly do care about having R available and Sage interface to it functional (which, I believe, is based on rpy2 now). 

You can still choose to install it, like any other optional package

> It also seemed to me that 9.1 does not have to support Python2, am I wrong on this?

9.1 still supports Python 2 - see https://wiki.sagemath.org/ReleaseTours/sage-9.1


---

Comment by novoselt created at 2020-04-20 02:54:54

Replying to [comment:23 mkoeppe]:
> Replying to [comment:22 novoselt]:
> > Users of [SageMathCell](SageMathCell) certainly do care about having R available and Sage interface to it functional (which, I believe, is based on rpy2 now). 
> 
> You can still choose to install it, like any other optional package

My point was however that **users** care about it. If they care about it in the context of [SageMathCell](SageMathCell), it is feasible that they care in other cases as well...


---

Comment by mkoeppe created at 2020-04-20 02:57:41

They can install it, and also nothing would stop our binary distributions from installing it, like any other optional packages


---

Comment by mkoeppe created at 2020-04-20 03:11:44

There is barely any integration of R into Sage. There's `sage.interfaces.r` (which uses rpy2) and then a single function in the `sage.stats.r` module. I don't think this makes sense to keep as a standard package


---

Comment by novoselt created at 2020-04-20 03:47:44

Replying to [comment:26 mkoeppe]:
> There is barely any integration of R into Sage. There's `sage.interfaces.r` (which uses rpy2) and then a single function in the `sage.stats.r` module. I don't think this makes sense to keep as a standard package

Um, `sage.interfaces.r` IS the whole point of integration! We don't use it for other parts ourselves, but we make it available for users to use whatever is available through that interface. If it is optional, but binary distributions still include it, I am missing the point of what is standard. And for those who do use binary distributions it is not that easy to install optional packages.

I think dropping Python 2 support would be less noticeable than dropping R installation anywhere.


---

Comment by jhpalmieri created at 2020-04-20 04:02:17

We can drop support now and then reinstate once #29441 is ready (and we've made the transition to Python 3 only). Or we can keep the support now and have a broken build on Cygwin. Are those the two choices?

The ticket description is vague: if we build Sage's R with Cygwin, does everything work; that is, is it only a problem of the system R on Cygwin?


---

Comment by mkoeppe created at 2020-04-20 06:35:26

Replying to [comment:28 jhpalmieri]:
> We can drop support now and then reinstate once #29441 is ready (and we've made the transition to Python 3 only). Or we can keep the support now and have a broken build on Cygwin. Are those the two choices?

Yes.
 
> The ticket description is vague: if we build Sage's R with Cygwin, does everything work; that is, is it only a problem of the system R on Cygwin?

This should be checked. If it works with R from the sage spkg, then disabling use of the system package would be a 3rd option, probably the best one.


---

Comment by fbissey created at 2020-04-20 08:19:53

Suddenly dropping R/rpy2 fells rough. However, we don't have usage data to know how rough it would be.

I'd prefer the third option if it proves workable. Otherwise is it possible to have it optional so that it doesn't build on cygwin but build elsewhere?


---

Comment by mkoeppe created at 2020-04-20 15:58:48

Replying to [comment:29 mkoeppe]:
> > The ticket description is vague: if we build Sage's R with Cygwin, does everything work; that is, is it only a problem of the system R on Cygwin?
> 
> This should be checked. If it works with R from the sage spkg, then disabling use of the system package would be a 3rd option, probably the best one.

It seems that this would work, but I have to check more


---

Comment by git created at 2020-04-20 23:19:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-20 23:22:32

OK, new approach


---

Comment by novoselt created at 2020-04-21 02:27:10

Thank you for figuring it out!


---

Comment by dimpase created at 2020-04-21 03:05:47

OK, this works on non-Cygwin. Now to test on Cygwin...


---

Comment by dimpase created at 2020-04-21 03:11:47

Cygwin tests on https://github.com/dimpase/sage/actions/runs/83451150


---

Comment by dimpase created at 2020-04-21 03:27:31

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-04-21 03:27:31

OK, this works


---

Comment by jhpalmieri created at 2020-04-21 04:15:25

Great, I'm very happy with this alternate approach!


---

Comment by mkoeppe created at 2020-04-21 05:21:25

Thanks!


---

Comment by vbraun created at 2020-04-23 22:33:23

Resolution: fixed
