# Issue 17839: Be nicer with numpy

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-03-28 00:03:04

CC:  tmonteil

Keywords: sd66

Plenty of bugs have been reported for the interaction with numpy:
- #8426: polynomial * constant does not work if constant is a numpy type
- #8949: symbolic functions dont work with numpy.int32
- #9769: symbolic function do not work with numpy.int64 arguments
- #13386: comparison of Sage integer with Numpy integer
- #15695: Coercion problems between numpy and sage floats
- #17758: Intervals and numpy floats do not compare correctly

We solve them all by defining coercions of numpy integers to `ZZ`, numpy floating to `RDF` and numpy complex floating to `CDF`.

Some of them depend on modifying some internal in numpy and will not be solved here:
- - #8824: Make it so that numpy datatypes are integrated into the coercion model


---

Comment by vdelecroix created at 2015-03-28 00:18:40

Set assignee to vdelecroix.


---

Comment by vdelecroix created at 2015-03-28 11:53:55

New commits:


---

Comment by vdelecroix created at 2015-03-28 20:49:31

Not so bad... got three problematic files

```
sage -t --long src/sage/plot/plot.py  # 2 doctests failed
sage -t --long src/sage/plot/graphics.py  # 1 doctest failed
sage -t --long src/doc/en/thematic_tutorials/numerical_sage/numpy.rst  # 1 doctest failed
```



---

Comment by git created at 2015-03-28 21:00:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-28 21:02:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-28 21:08:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-03-28 21:09:25

Changing status from new to needs_review.


---

Comment by chapoton created at 2015-03-31 18:30:20

3 failing doctests, see patchbot report


---

Comment by chapoton created at 2015-03-31 18:30:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-31 19:58:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-03-31 19:58:55

Replying to [comment:9 chapoton]:
> 3 failing doctests, see patchbot report

Is that all?


---

Comment by vdelecroix created at 2015-03-31 19:59:11

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-04-01 16:48:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-04-01 16:48:52

still one failing doctest, see patchbot report.

Désolé de ne pas faire de commentaires plus constructifs, vraiment.


---

Comment by git created at 2015-04-01 21:41:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-01 21:44:47

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-01 21:44:47

Replying to [comment:13 chapoton]:
> still one failing doctest, see patchbot report.
> 
> Désolé de ne pas faire de commentaires plus constructifs, vraiment.

Done!


---

Comment by slabbe created at 2015-04-03 15:17:33

There is a incomplete trac number XYZ:

```
+ This used to fail (see :trac:`XYZ`)::
```



---

Comment by jdemeyer created at 2015-04-04 07:02:12

My intention is to make this depend on #18121.


---

Comment by jdemeyer created at 2015-04-07 10:05:28

This looks wrong to me:

```
sage: numpy.int8('12') + 1/3
12.333333333333334
```

Why is the answer a float???
----
New commits:


---

Comment by jdemeyer created at 2015-04-07 10:05:28

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-07 10:25:08

Replying to [comment:20 jdemeyer]:
> This looks wrong to me:
> {{{
> sage: numpy.int8('12') + 1/3
> 12.333333333333334
> }}}
> Why is the answer a float???

This is because the addition is handled by numpy and not by the rational. Simlarly

```
sage: import numpy
sage: numpy.int64('1') + 1
2
sage: parent(_)
<type 'numpy.int64'>
```

There is a comment somewhere that this can be an upstream request.


---

Comment by vdelecroix created at 2015-04-07 10:36:14

see also #8824


---

Comment by jdemeyer created at 2015-04-07 11:42:54

Replying to [comment:21 vdelecroix]:
> Replying to [comment:20 jdemeyer]:
> > This looks wrong to me:
> > {{{
> > sage: numpy.int8('12') + 1/3
> > 12.333333333333334
> > }}}
> > Why is the answer a float???
> 
> This is because the addition is handled by numpy and not by the rational.
I see. It doesn't use the Sage coercion framework at all.

Could you clarify this in the docstring when you write this example?


---

Comment by jdemeyer created at 2015-04-07 11:49:07

Could you please add doctests for all the tickets you're marking as duplicate of this one? For example, there is no doctest for #8949.


---

Comment by vdelecroix created at 2015-04-07 11:50:16

New commits:


---

Comment by jdemeyer created at 2015-04-07 11:51:14

Changing component from interfaces to coercion.


---

Comment by git created at 2015-04-07 12:13:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-07 15:49:57

Feel free to set this ticket back to needs_review (although somebody needs to review #18121 before this ticket can be formally reviewed).


---

Comment by chapoton created at 2015-04-09 19:54:25

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-22 08:24:57

Various conflicts, rebasing...


---

Comment by jdemeyer created at 2015-04-22 08:24:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-22 09:14:06

New commits:


---

Comment by jdemeyer created at 2015-04-22 09:14:06

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-22 19:31:52

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-22 19:31:52

This is fine for me. And all test pass.

Vincent


---

Comment by jdemeyer created at 2015-04-22 19:46:39

Not so fast, I haven't actually reviewed all your changes.


---

Comment by jdemeyer created at 2015-04-22 19:46:39

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2015-04-23 10:11:15

My comments (all easy to fix):

1. Conversion `numpy.floating` -> `QQ` should use `RR` directly, instead of `numpy.floating` -> `RDF` which then converts to `RR`.

2. The reference to #15965 is wrong.

3. In `src/sage/rings/real_double.pyx`, I would prefer to split up `if S is ZZ or S is QQ or S is RLF or (isinstance(S, RealField_class) and S.prec() >= 53)` in several cases, just like for `CDF` (in particular, if the precision is too small, we can return `None` immediately).

4. Python considers `bool` a subclass of `int`, so

```
issubclass(py_type, int) or issubclass(py_type, long) or issubclass(py_type, bool)
```

can be replaced by

```
issubclass(py_type, int) or issubclass(py_type, long)
```


5. In doctests, please replace `1jr` by the more natural `I` (unless you have a good reason to not do this)

6. In `NumpyToSRMorphism.__init__`, could you raise a `TypeError` if `numpy_type` doesn't satisfy any of the `issubclass()` checks (and add a doctest for this case). Also, the second `if` should better be an `elif`.


---

Comment by jdemeyer created at 2015-04-23 10:12:32

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-23 10:20:42

I'm also wondering if this check is really needed:

```
if ty != type(y + x):
    raise RuntimeError("x + y and y + x have different types...")
```


First of all, I cannot find any case where this happens. Second, even if it does happen, would it really be a problem?


---

Comment by vdelecroix created at 2015-04-23 10:58:06

Replying to [comment:37 jdemeyer]:
> I'm also wondering if this check is really needed:
> {{{
> if ty != type(y + x):
>     raise RuntimeError("x + y and y + x have different types...")
> }}}
> 
> First of all, I cannot find any case where this happens. 


```
sage: numpy.int16(1) + 1.0
2.0
sage: type(_)
<type 'numpy.float64'>
sage: 1.0 + numpy.int16(1)
2.00000000000000
sage: type(_)
<type 'sage.rings.real_mpfr.RealNumber'>
```

But the canonical coercion is fine since we do have a coercion from numpy types to real numbers.

> Second, even if it does happen, would it really be a problem?

I don't know. You would prefer that we get rid of it?

Vincent


---

Comment by vdelecroix created at 2015-04-23 11:14:58

New commits:


---

Comment by vdelecroix created at 2015-04-23 11:14:58

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-23 11:39:09

Replying to [comment:38 vdelecroix]:
> I don't know. You would prefer that we get rid of it?
Given that I see no reason to have the check, I'd rather remove it.

I think you did your search-and-replace a bit too naive, this is a syntax error: `numpy.complex128(-2+.I)`


---

Comment by jdemeyer created at 2015-04-23 11:39:09

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-23 11:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-23 11:52:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-23 12:00:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-25 03:52:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-25 03:52:17

On 32-bit:

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 334, in sage.structure.coerce.CoercionModel_cache_maps
Failed example:
    type(_)
Expected:
    <type 'numpy.int64'>
Got:
    <type 'numpy.int32'>
**********************************************************************
1 item had failures:
   1 of  22 in sage.structure.coerce.CoercionModel_cache_maps
    [272 tests, 1 failure, 0.41 s]
```



---

Comment by jdemeyer created at 2015-04-25 08:57:43

New commits:


---

Comment by jdemeyer created at 2015-04-25 08:57:43

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-25 09:05:54

It does not affect floating point?

```
sage: numpy.int8('12') + 1/3
12.333333333333334
sage: type(_)
<type 'numpy.float64'>
```



---

Comment by vdelecroix created at 2015-04-27 15:04:41

Let's assume that it's right...


---

Comment by vdelecroix created at 2015-04-27 15:04:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-28 04:44:37

Resolution: fixed
