# Issue 32590: Segmentation fault in face iterator

Issue created by migration from https://trac.sagemath.org/ticket/32827

Original creator: @kliem

Original creation time: 2021-11-05 07:14:03

CC:  tmonteil tscrim vbraun

Some patchbots are reporting consistent segmentation faults with combinatorial polyhedron:

E.g.

https://patchbot.sagemath.org/log/32788/Linux/1_SMP_Debian_5.10.70-1_(2021-09-30)/x86_64/5.10.0-9-amd64/tmonteil-lxc1/2021-10-30%2023:39:45


---

Comment by @kliem created at 2021-11-05 07:26:41

`@`tmonteil:

Could you perhaps inspect that bot and the sage version, if it is still running. It could be a bug with #32666 or a bug that shows now, because something is compiled differently, due to code change.

Either way, it would greatly help, if you could inspect a few things:

Does this work:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: Asso.vertex_adjacency_matrix()
[0 1 0 0 0 1 0 0 1 0 0 0 0 0]
[1 0 1 0 0 0 0 1 0 0 0 0 0 0]
[0 1 0 1 0 1 0 0 0 0 0 0 0 0]
[0 0 1 0 1 0 0 0 0 0 0 1 0 0]
[0 0 0 1 0 0 0 1 0 0 0 0 1 0]
[1 0 1 0 0 0 0 0 0 0 0 0 0 1]
[0 0 0 0 0 0 0 1 1 0 1 0 0 0]
[0 1 0 0 1 0 1 0 0 0 0 0 0 0]
[1 0 0 0 0 0 1 0 0 1 0 0 0 0]
[0 0 0 0 0 0 0 0 1 0 1 0 0 1]
[0 0 0 0 0 0 1 0 0 1 0 0 1 0]
[0 0 0 1 0 0 0 0 0 0 0 0 1 1]
[0 0 0 0 1 0 0 0 0 0 1 1 0 0]
[0 0 0 0 0 1 0 0 0 1 0 1 0 0]
```


I guess not.

Now, the combinatorial polyhedron is probably still obtained fine:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
```


Once you have it, there are a number of things to test:


```
sage: C.edges()
```



```
sage: for f in C.face_iter():
....:     print(f)
```


Same for `C.face_iter(dual=True)`, `C.face_iter(0)`, `C.face_iter(0, dual=True)`.

It should help a lot in catching that bug, seeing exactly when there is a segmentation fault.

Please do not recompile, as the bug might hide then. But I don't know.


---

Comment by tmonteil created at 2021-11-05 13:10:45

Replying to [comment:1 gh-kliem]:
> `@`tmonteil:
> 
> Could you perhaps inspect that bot and the sage version, if it is still running. It could be a bug with #32666 or a bug that shows now, because something is compiled differently, due to code change.
> 
> Either way, it would greatly help, if you could inspect a few things:
> 
> Does this work:

On the current state of `tmonteil-lxc1`, wich is a merge between `9.5.beta5` and the branch of #32320 i do not have any error.

On `tmonteil-lxc3`, which is a merge between `9.5.beta5` and the branch of #31635, i have:

> {{{
> sage: Asso = polytopes.associahedron(['A',3])
> sage: Asso.vertex_adjacency_matrix()
> [0 1 0 0 0 1 0 0 1 0 0 0 0 0]
> [1 0 1 0 0 0 0 1 0 0 0 0 0 0]
> [0 1 0 1 0 1 0 0 0 0 0 0 0 0]
> [0 0 1 0 1 0 0 0 0 0 0 1 0 0]
> [0 0 0 1 0 0 0 1 0 0 0 0 1 0]
> [1 0 1 0 0 0 0 0 0 0 0 0 0 1]
> [0 0 0 0 0 0 0 1 1 0 1 0 0 0]
> [0 1 0 0 1 0 1 0 0 0 0 0 0 0]
> [1 0 0 0 0 0 1 0 0 1 0 0 0 0]
> [0 0 0 0 0 0 0 0 1 0 1 0 0 1]
> [0 0 0 0 0 0 1 0 0 1 0 0 1 0]
> [0 0 0 1 0 0 0 0 0 0 0 0 1 1]
> [0 0 0 0 1 0 0 0 0 0 1 1 0 0]
> [0 0 0 0 0 1 0 0 0 1 0 1 0 0]
> }}}
> 
> I guess not.


Indeed:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: Asso.vertex_adjacency_matrix()
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7f2d6c21947b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7f2d6c21f2d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7f2d6c21fff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7f2d6fc47730]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0xe4d0)[0x7f2d112f54d0]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x14466)[0x7f2d112fb466]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x1d3d2)[0x7f2d113723d2]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x1f1d7)[0x7f2d113741d7]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x49d7b)[0x7f2d1139ed7b]
python3(_PyMethodDef_RawFastCallDict+0x22a)[0x5d8c6a]
python3[0x4d743e]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/misc/cachefunc.cpython-37m-x86_64-linux-gnu.so(+0x134cd)[0x7f2d6cdb64cd]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/misc/cachefunc.cpython-37m-x86_64-linux-gnu.so(+0x287eb)[0x7f2d6cdcb7eb]
python3(_PyObject_FastCallKeywords+0x4eb)[0x5da01b]
python3[0x54b3c1]
python3(_PyEval_EvalFrameDefault+0x441d)[0x5524cd]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/misc/cachefunc.cpython-37m-x86_64-linux-gnu.so(+0x10c13)[0x7f2d6cdb3c13]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/misc/cachefunc.cpython-37m-x86_64-linux-gnu.so(+0x10dba)[0x7f2d6cdb3dba]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/misc/cachefunc.cpython-37m-x86_64-linux-gnu.so(+0x287d0)[0x7f2d6cdcb7d0]
python3(_PyObject_FastCallKeywords+0x4eb)[0x5da01b]
python3[0x54b3c1]
python3(_PyEval_EvalFrameDefault+0x441d)[0x5524cd]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3[0x558f25]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyMethodDescr_FastCallKeywords+0x151)[0x4d76a1]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x4fc)[0x54e5ac]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3[0x54b1f0]
python3(_PyEval_EvalFrameDefault+0x13ae)[0x54f45e]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(PyEval_EvalCode+0x23)[0x54e0a3]
python3[0x630ce2]
python3(PyRun_FileExFlags+0x97)[0x630d97]
python3(PyRun_SimpleFileExFlags+0x17f)[0x6319ff]
python3[0x65432e]
python3(_Py_UnixMain+0x2e)[0x65468e]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x7f2d6f6ae09b]
python3(_start+0x2a)[0x5e0e8a]
------------------------------------------------------------------------
Attaching gdb to process id 1024695.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



> Now, the combinatorial polyhedron is probably still obtained fine:
> 
> {{{
> sage: Asso = polytopes.associahedron(['A',3])
> sage: C = Asso.combinatorial_polyhedron()
> }}}
> 
> Once you have it, there are a number of things to test:
> 
> {{{
> sage: C.edges()
> }}}



```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: C.edges()
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7f4e6052547b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7f4e6052b2d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7f4e6052bff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7f4e63513730]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0xe4d0)[0x7f4e04bc24d0]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x14466)[0x7f4e04bc8466]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x1d3d2)[0x7f4e04c3f3d2]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x1f1d7)[0x7f4e04c411d7]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-37m-x86_64-linux-gnu.so(+0x4d73d)[0x7f4e04c6f73d]
python3(_PyMethodDescr_FastCallKeywords+0x3c4)[0x4d7914]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3[0x558f25]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyMethodDescr_FastCallKeywords+0x151)[0x4d76a1]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x4fc)[0x54e5ac]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3[0x54b1f0]
python3(_PyEval_EvalFrameDefault+0x13ae)[0x54f45e]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(PyEval_EvalCode+0x23)[0x54e0a3]
python3[0x630ce2]
python3(PyRun_FileExFlags+0x97)[0x630d97]
python3(PyRun_SimpleFileExFlags+0x17f)[0x6319ff]
python3[0x65432e]
python3(_Py_UnixMain+0x2e)[0x65468e]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x7f4e62f7a09b]
python3(_start+0x2a)[0x5e0e8a]
------------------------------------------------------------------------
Attaching gdb to process id 1024859.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



> {{{
> sage: for f in C.face_iter():
> ....:     print(f)
> }}}


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: for f in C.face_iter():
....:     print(f)
....: 
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7f31646b547b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7f31646bb2d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7f31646bbff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7f31676a3730]
/lib/x86_64-linux-gnu/libc.so.6(+0x15cb0d)[0x7f3167242b0d]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.cpython-37m-x86_64-linux-gnu.so(+0x1305a)[0x7f3108d8b05a]
python3[0x599551]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0xc9ac)[0x7f3108d529ac]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x15948)[0x7f3108d5b948]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x1a2ef)[0x7f3108d602ef]
python3(_PyEval_EvalFrameDefault+0x8cd)[0x54e97d]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3[0x558f25]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyMethodDescr_FastCallKeywords+0x151)[0x4d76a1]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x4fc)[0x54e5ac]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3[0x54b1f0]
python3(_PyEval_EvalFrameDefault+0x13ae)[0x54f45e]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(PyEval_EvalCode+0x23)[0x54e0a3]
python3[0x630ce2]
python3(PyRun_FileExFlags+0x97)[0x630d97]
python3(PyRun_SimpleFileExFlags+0x17f)[0x6319ff]
python3[0x65432e]
python3(_Py_UnixMain+0x2e)[0x65468e]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x7f316710a09b]
python3(_start+0x2a)[0x5e0e8a]
------------------------------------------------------------------------
Attaching gdb to process id 1025024.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



> Same for `C.face_iter(dual=True)`,


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: for f in C.face_iter(dual=True):
....:     print(f)
....: 
------------------------------------------------------------------------
Segmentation fault
```


> `C.face_iter(0)`,


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: for f in C.face_iter(0):
....:     print(f)
....: 
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
A 0-dimensional face of a 3-dimensional combinatorial polyhedron
```


> `C.face_iter(0, dual=True)`.


```
sage: for f in C.face_iter(0, dual=True):
....:     print(f)
....: 
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7f6886f5547b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7f6886f5b2d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7f6886f5bff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7f688a983730]
/lib/x86_64-linux-gnu/libc.so.6(+0x15cb0d)[0x7f688a522b0d]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.cpython-37m-x86_64-linux-gnu.so(+0x1305a)[0x7f682c06a05a]
python3[0x599551]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0xc9ac)[0x7f682c0319ac]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x15948)[0x7f682c03a948]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x1a2ef)[0x7f682c03f2ef]
python3(_PyEval_EvalFrameDefault+0x8cd)[0x54e97d]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3[0x558f25]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyMethodDescr_FastCallKeywords+0x151)[0x4d76a1]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x4fc)[0x54e5ac]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3[0x54b1f0]
python3(_PyEval_EvalFrameDefault+0x13ae)[0x54f45e]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(PyEval_EvalCode+0x23)[0x54e0a3]
python3[0x630ce2]
python3(PyRun_FileExFlags+0x97)[0x630d97]
python3(PyRun_SimpleFileExFlags+0x17f)[0x6319ff]
python3[0x65432e]
python3(_Py_UnixMain+0x2e)[0x65468e]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x7f688a3ea09b]
python3(_start+0x2a)[0x5e0e8a]
------------------------------------------------------------------------
Attaching gdb to process id 1025356.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```


> It should help a lot in catching that bug, seeing exactly when there is a segmentation fault.
> 
> Please do not recompile, as the bug might hide then. But I don't know.


---

Comment by @kliem created at 2021-11-05 13:50:33

Thank you.

That is even worse than I thought, but on the upside this might make debugging easier.

How about:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: C.face_iter()
Iterator over the proper faces of a 3-dimensional combinatorial polyhedron
```


If this works:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: it = C.face_iter()
sage: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport FaceIterator
....: def foo(FaceIterator it):
....:     cdef int d = it.next_dimension()
....:     while d < it.structure.dimension:
....:         print(d)
....:         print(it.n_atom_rep())
....:         a = it.set_atom_rep()
....:         print([it.structure.atom_rep[i] for i in range(a)])
....:         b = it.set_coatom_rep()
....:         print([it.structure.coatom_rep[i] for i in range(b)])
....:         d = it.next_dimension()
....: ''')
sage: foo(it)
```



---

Comment by tmonteil created at 2021-11-05 14:56:40

On both machines, i got: 


```
sage: sage: Asso = polytopes.associahedron(['A',3])
....: sage: C = Asso.combinatorial_polyhedron()
....: sage: C.face_iter()
Iterator over the proper faces of a 3-dimensional combinatorial polyhedron
sage: sage: Asso = polytopes.associahedron(['A',3])
....: sage: C = Asso.combinatorial_polyhedron()
....: sage: it = C.face_iter()
....: sage: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport FaceIterator
....: ....: def foo(FaceIterator it):
....: ....:     cdef int d = it.next_dimension()
....: ....:     while d < it.structure.dimension:
....: ....:         print(d)
....: ....:         print(it.n_atom_rep())
....: ....:         a = it.set_atom_rep()
....: ....:         print([it.structure.atom_rep[i] for i in range(a)])
....: ....:         b = it.set_coatom_rep()
....: ....:         print([it.structure.coatom_rep[i] for i in range(b)])
....: ....:         d = it.next_dimension()
....: ....: ''')
....: sage: foo(it)
2
5
[0, 5, 8, 9, 13]
[8]
2
4
[6, 8, 9, 10]
[7]
2
5
[4, 6, 7, 10, 12]
[6]
2
4
[3, 4, 11, 12]
[5]




2
5
[9, 10, 11, 12, 13]
[3]
2
5
[2, 3, 5, 11, 13]
[2]
2
4
[0, 1, 2, 5]
[1]
2
5
[1, 2, 3, 4, 7]
[0]
1
2
[8, 9]
[7, 8]
1
2
[0, 8]
[4, 8]
1
2
[9, 13]
[3, 8]
1
2
[5, 13]
[2, 8]
1
2
[0, 5]
[1, 8]
0
1
[8]
[4, 7, 8]
0
1
[9]
[3, 7, 8]
0
1
[0]
[1, 4, 8]
0
1
[13]
[2, 3, 8]
0
1
[5]
[1, 2, 8]
1
2
[6, 10]
[6, 7]
1
2
[6, 8]
[4, 7]
1
2
[9, 10]
[3, 7]
0
1
[6]
[4, 6, 7]
0
1
[10]
[3, 6, 7]
1
2
[4, 12]
[5, 6]
1
2
[6, 7]
[4, 6]
1
2
[10, 12]
[3, 6]
1
2
[4, 7]
[0, 6]
0
1
[12]
[3, 5, 6]
0
1
[4]
[0, 5, 6]
0
1
[7]
[0, 4, 6]
1
2
[11, 12]
[3, 5]
1
2
[3, 11]
[2, 5]
1
2
[3, 4]
[0, 5]
0
1
[11]
[2, 3, 5]
0
1
[3]
[0, 2, 5]
1
2
[0, 1]
[1, 4]
1
2
[1, 7]
[0, 4]
0
1
[1]
[0, 1, 4]
1
2
[11, 13]
[2, 3]
1
2
[2, 5]
[1, 2]
1
2
[2, 3]
[0, 2]
0
1
[2]
[0, 1, 2]
1
2
[1, 2]
[0, 1]
```



---

Comment by @kliem created at 2021-11-05 15:46:27

Thank you. Apparently the face iterator works and something with `CombinatorialFace` is failing.

Can you please try the following:


```
sage: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: 
....: cdef class foo:
....:     cdef face_t face
....:     cdef MemoryAllocator mem
....:     
....:     def __cinit__(self):
....:         self.mem = MemoryAllocator()
....:         face_init(self.face, 9, 14, self.mem)
....:         
....:     def test(self):
....:         cdef face_t new_face
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_init(new_face, 9, 14, mem)
....:         print('b')
....:         face_copy(self.face, new_face)
....:         
....:     def test2(self):
....:         cdef face_list_t faces
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_list_init(faces, 9, 9, 14, mem)
....:         cdef face_t new_face
....:         for i in range(9):
....:             print(i)
....:             new_face[0] = faces.faces[i][0]
....:             print(i, 'b')
....:             face_copy(self.face, new_face)
....: ''')
sage: a = foo()
sage: a.test()
sage: a.test2()
```



---

Comment by tmonteil created at 2021-11-05 16:55:45

I got : 


```
sage: sage: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: ....: 
....: ....: cdef class foo:
....: ....:     cdef face_t face
....: ....:     cdef MemoryAllocator mem
....: ....:     
....: ....:     def __cinit__(self):
....: ....:         self.mem = MemoryAllocator()
....: ....:         face_init(self.face, 9, 14, self.mem)
....: ....:         
....: ....:     def test(self):
....: ....:         cdef face_t new_face
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_init(new_face, 9, 14, mem)
....: ....:         print('b')
....: ....:         face_copy(self.face, new_face)
....: ....:         
....: ....:     def test2(self):
....: ....:         cdef face_list_t faces
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_list_init(faces, 9, 9, 14, mem)
....: ....:         cdef face_t new_face
....: ....:         for i in range(9):
....: ....:             print(i)
....: ....:             new_face[0] = faces.faces[i][0]
....: ....:             print(i, 'b')
....: ....:             face_copy(self.face, new_face)
....: ....: ''')
....: sage: a = foo()
....: sage: a.test()
....: sage: a.test2()
....: 
a
b
a
0
0 b
1
1 b
2
2 b
3
3 b
4
4 b
5
5 b
6
6 b
7
7 b
8
8 b
```



---

Comment by @kliem created at 2021-11-05 18:04:14

Ok, thanks. Sorry this is taking so long.

The only thing that I can think of right now, is that one needs to be careful with `__cinit__` and `__init__`.

Can you please try:


```
sage: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: 
....: cdef class foo:
....:     cdef face_t face
....:     cdef MemoryAllocator mem
....:     
....:     def __init__(self):
....:         self.mem = MemoryAllocator()
....:         face_init(self.face, 9, 14, self.mem)
....:         
....:     def test(self):
....:         cdef face_t new_face
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_init(new_face, 9, 14, mem)
....:         print('b')
....:         face_copy(self.face, new_face)
....:         
....:     def test2(self):
....:         cdef face_list_t faces
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_list_init(faces, 9, 9, 14, mem)
....:         cdef face_t new_face
....:         for i in range(9):
....:             print(i)
....:             new_face[0] = faces.faces[i][0]
....:             print(i, 'b')
....:             face_copy(self.face, new_face)
....: ''')
sage: a = foo()
sage: a.test()
sage: a.test2()
```


Also just to confirm:


```
sage: sage: Asso = polytopes.associahedron(['A',3])
sage: it = Asso.face_generator()
sage: f = next(it)
sage: f
A 3-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 14 vertices
sage: f = next(it)
sage: f
A -1-dimensional face of a Polyhedron in QQ^3
sage: f = next(it)
sage: f
A 2-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 5 vertices
```


And:


```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: it = C.face_iter()
sage: f = next(it)
sage: f
A 2-dimensional face of a 3-dimensional combinatorial polyhedron
sage: f = next(it)
sage: f
A 2-dimensional face of a 3-dimensional combinatorial polyhedron
```



```
sage: Asso = polytopes.associahedron(['A',3])
sage: C = Asso.combinatorial_polyhedron()
sage: it = C.face_iter()
sage: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
....: def foo(FaceIterator_base it):
....:     it.next_dimension()
....:     print('a')
....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace)
....:     print('b')
....:     face.__init__(it)
....:     print('c')
....:     return face
....: ''')
sage: foo(it)
a
b
c
A 2-dimensional face of a 3-dimensional combinatorial polyhedron
```




There is definitely a problem with init and cinit as the following shoud not lead to a segmentationfault (but does and also for me):


```
sage: from sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face import CombinatorialFace
sage: face = CombinatorialFace.__new__(CombinatorialFace)
sage: face.ambient_H_indices()
```


I don't know if this is the issue. I can try to fix this `__init__` and `__cinit__` things and see if this solves something.


---

Comment by tmonteil created at 2021-11-05 19:16:41

Here is a raw log, the problem are on `tmonteil-lxc3`, not `tmonteil-lxc1`, sorry for the confusion:


```
sagemath@tmonteil-lxc3:~/sage-9.1$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta5, Release Date: 2021-10-28               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: ....: 
....: ....: cdef class foo:
....: ....:     cdef face_t face
....: ....:     cdef MemoryAllocator mem
....: ....:     
....: ....:     def __init__(self):
....: ....:         self.mem = MemoryAllocator()
....: ....:         face_init(self.face, 9, 14, self.mem)
....: ....:         
....: ....:     def test(self):
....: ....:         cdef face_t new_face
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_init(new_face, 9, 14, mem)
....: ....:         print('b')
....: ....:         face_copy(self.face, new_face)
....: ....:         
....: ....:     def test2(self):
....: ....:         cdef face_list_t faces
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_list_init(faces, 9, 9, 14, mem)
....: ....:         cdef face_t new_face
....: ....:         for i in range(9):
....: ....:             print(i)
....: ....:             new_face[0] = faces.faces[i][0]
....: ....:             print(i, 'b')
....: ....:             face_copy(self.face, new_face)
....: ....: ''')
....: sage: a = foo()
....: sage: a.test()
....: sage: a.test2()
a
b
a
0
0 b
1
1 b
2
2 b
3
3 b
4
4 b
5
5 b
6
6 b
7
7 b
8
8 b
sage: sage: sage: Asso = polytopes.associahedron(['A',3])
....: sage: it = Asso.face_generator()
....: sage: f = next(it)
....: sage: f
A 3-dimensional face of a Polyhedron in QQ^3 defined as the convex hull of 14 vertices
sage: sage: f = next(it)
....: sage: f
A -1-dimensional face of a Polyhedron in QQ^3
sage: sage: f = next(it)
....: sage: f
------------------------------------------------------------------------
Segmentation fault
sagemath@tmonteil-lxc3:~/sage-9.1$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta5, Release Date: 2021-10-28               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: Asso = polytopes.associahedron(['A',3])
....: sage: C = Asso.combinatorial_polyhedron()
....: sage: it = C.face_iter()
....: sage: f = next(it)
....: sage: f
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7fc34e97b47b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7fc34e9812d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7fc34e981ff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7fc3523a9730]
/lib/x86_64-linux-gnu/libc.so.6(+0x15cb0d)[0x7fc351f48b0d]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.cpython-37m-x86_64-linux-gnu.so(+0x1305a)[0x7fc2f3a8605a]
python3[0x599551]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0xc9ac)[0x7fc2f3a4d9ac]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x15948)[0x7fc2f3a56948]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.cpython-37m-x86_64-linux-gnu.so(+0x1a2ef)[0x7fc2f3a5b2ef]
python3[0x556216]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3[0x558f25]
python3(_PyMethodDef_RawFastCallKeywords+0x1b3)[0x5d8833]
python3(_PyEval_EvalFrameDefault+0x42c3)[0x552373]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyEval_EvalFrameDefault+0x1a75)[0x54fb25]
python3[0x4d37a6]
python3(_PyMethodDescr_FastCallKeywords+0x151)[0x4d76a1]
python3(_PyEval_EvalFrameDefault+0x45f8)[0x5526a8]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x4fc)[0x54e5ac]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3[0x54b1f0]
python3(_PyEval_EvalFrameDefault+0x13ae)[0x54f45e]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(_PyFunction_FastCallKeywords+0x482)[0x5d94f2]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyFunction_FastCallKeywords+0x18c)[0x5d91fc]
python3(_PyEval_EvalFrameDefault+0x730)[0x54e7e0]
python3(_PyEval_EvalCodeWithName+0x252)[0x54bcc2]
python3(PyEval_EvalCode+0x23)[0x54e0a3]
python3[0x630ce2]
python3(PyRun_FileExFlags+0x97)[0x630d97]
python3(PyRun_SimpleFileExFlags+0x17f)[0x6319ff]
python3[0x65432e]
python3(_Py_UnixMain+0x2e)[0x65468e]
[1 0 1 0 0 0 0 1 0 0 0 0 0 0]
[0 1 0 1 0 1 0 0 0 0 0 0 0 0]
[0 0 1 0 1 0 0 0 0 0 0 1 0 0]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x7fc351e1009b]
python3(_start+0x2a)[0x5e0e8a]
------------------------------------------------------------------------
Attaching gdb to process id 1027349.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
sagemath@tmonteil-lxc3:~/sage-9.1$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta5, Release Date: 2021-10-28               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: Asso = polytopes.associahedron(['A',3])
....: sage: C = Asso.combinatorial_polyhedron()
....: sage: it = C.face_iter()
....: sage: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
....: ....: def foo(FaceIterator_base it):
....: ....:     it.next_dimension()
....: ....:     print('a')
....: ....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace)
....: ....:     print('b')
....: ....:     face.__init__(it)
....: ....:     print('c')
....: ....:     return face
....: ....: ''')
....: sage: foo(it)
a
b
------------------------------------------------------------------------
Segmentation fault
sagemath@tmonteil-lxc3:~/sage-9.1$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta5, Release Date: 2021-10-28               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: from sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face import CombinatorialFace
....: sage: face = CombinatorialFace.__new__(CombinatorialFace)
....: sage: face.ambient_H_indices()
------------------------------------------------------------------------
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x947b)[0x7f644a84747b]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xf2d8)[0x7f644a84d2d8]
/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xfff0)[0x7f644a84dff0]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7f644e275730]
------------------------------------------------------------------------
Attaching gdb to process id 1027750.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault

```



---

Comment by tmonteil created at 2021-11-05 19:18:36

I edited [comment:2 comment:2] to fix the typo between lxc1 and lxc3, the relative tickets are correct.


---

Comment by @kliem created at 2021-11-05 20:04:26

Thanks for all your help.

I will make a branch, where I put things in `__cinit__` that belong there. I hope that helps.

In the meantime can you yet run the following:


```
sage: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: 
....: cdef class foo:
....:     cdef face_t face
....:     cdef MemoryAllocator mem
....:     
....:     def __init__(self):
....:         self.mem = MemoryAllocator()
....:         face_init(self.face, 9, 14, self.mem)
....:         
....:     def test(self):
....:         cdef face_t new_face
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_init(new_face, 9, 14, mem)
....:         print('b')
....:         face_copy(self.face, new_face)
....:         
....:     def test2(self):
....:         cdef face_list_t faces
....:         cdef mem = MemoryAllocator()
....:         print('a')
....:         face_list_init(faces, 9, 9, 14, mem)
....:         cdef face_t new_face
....:         for i in range(9):
....:             print(i)
....:             new_face[0] = faces.faces[i][0]
....:             print(i, 'b')
....:             face_copy(self.face, new_face)
....: ''')
sage: a = foo()
sage: a.test()
sage: a.test2()
sage: a = foo.__new__(foo)
sage: a.__init__()
sage: a.test()
sage: a.test2()
```


It's different from the above, as it now uses incorrectly `__init__` instead of `__cinit__` as done throughout the module `combinatorial_polyhedron`.


---

Comment by tmonteil created at 2021-11-05 21:04:37

Here it is:


```
sagemath@tmonteil-lxc3:~/sage-9.1$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta5, Release Date: 2021-10-28               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_list_data_structure cimport *
....: ....: 
....: ....: cdef class foo:
....: ....:     cdef face_t face
....: ....:     cdef MemoryAllocator mem
....: ....:     
....: ....:     def __init__(self):
....: ....:         self.mem = MemoryAllocator()
....: ....:         face_init(self.face, 9, 14, self.mem)
....: ....:         
....: ....:     def test(self):
....: ....:         cdef face_t new_face
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_init(new_face, 9, 14, mem)
....: ....:         print('b')
....: ....:         face_copy(self.face, new_face)
....: ....:         
....: ....:     def test2(self):
....: ....:         cdef face_list_t faces
....: ....:         cdef mem = MemoryAllocator()
....: ....:         print('a')
....: ....:         face_list_init(faces, 9, 9, 14, mem)
....: ....:         cdef face_t new_face
....: ....:         for i in range(9):
....: ....:             print(i)
....: ....:             new_face[0] = faces.faces[i][0]
....: ....:             print(i, 'b')
....: ....:             face_copy(self.face, new_face)
....: ....: ''')
....: sage: a = foo()
....: sage: a.test()
....: sage: a.test2()
....: sage: a = foo.__new__(foo)
....: sage: a.__init__()
....: sage: a.test()
....: sage: a.test2()
a
b
a
0
0 b
1
1 b
2
2 b
3
3 b
4
4 b
5
5 b
6
6 b
7
7 b
8
8 b
a
b
a
0
0 b
1
1 b
2
2 b
3
3 b
4
4 b
5
5 b
6
6 b
7
7 b
8
8 b
```



---

Comment by @kliem created at 2021-11-06 20:57:54

The attached branch uses `__cinit__` to avoid having undefined objects around.
----
New commits:


---

Comment by @kliem created at 2021-11-08 07:29:10

Does this help.

If not, if not or if it is not clear, if it helps, I can also do this in a seperate ticket.


---

Comment by @kliem created at 2021-11-08 07:29:10

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-29 00:29:29

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-29 00:29:29

Patchbot shows failures:

```
sage -t --long --random-seed=116540483811314252179005456955637850102 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx
**********************************************************************
File "src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx", line 324, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.__cinit__
Failed example:
    C.f_vector()
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes
Got:
    (1)
**********************************************************************
File "src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx", line 328, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.__cinit__
Failed example:
    C.face_lattice()
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes
Got:
    Finite lattice containing 1 elements
**********************************************************************
```



---

Comment by mkoeppe created at 2021-11-29 00:30:41

I don't see this failures when trying out the ticket on macOS.


---

Comment by mkoeppe created at 2021-11-29 00:30:57

Changing priority from critical to blocker.


---

Comment by git created at 2021-11-29 08:23:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-11-29 08:24:16

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-11-29 09:53:06

The combinatorial what? I think you are missing `polyhedron` in the error message.


---

Comment by git created at 2021-11-29 10:52:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-29 20:03:56

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-11-30 06:31:40

Thank you.


---

Comment by tmonteil created at 2021-11-30 10:23:36

Changing status from positive_review to needs_info.


---

Comment by tmonteil created at 2021-11-30 10:23:36

I rebuilt on the same machine `tmonteil-lxc3` with the new branch, many things were recompiled (so the problem might have disapeared for another reason).

The doctests of `src/sage/geometry/polyhedron/` pass, and all the previous tests that you let me try in that ticket now pass, except the following two:


```
sage: Asso = polytopes.associahedron(['A',3])
....: C = Asso.combinatorial_polyhedron()
....: it = C.face_iter()
....: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
....: def foo(FaceIterator_base it):
....:     it.next_dimension()
....:     print('a')  
....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace)
....:     print('b')  
....:     face.__init__(it)
....:     print('c')  
....:     return face 
....: ''')
....: foo(it)
....: 
a
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-4ddddb9717bb> in <module>
     13     return face
     14 ''')
---> 15 foo(it)

~/.sage/temp/tmonteil-lxc3/1115495/spyx/_home_sagemath__sage_temp_tmonteil_lxc3_1115495_tmp_jjkx1k56_pyx/_home_sagemath__sage_temp_tmonteil_lxc3_1115495_tmp_jjkx1k56_pyx_0.pyx in _home_sagemath__sage_temp_tmonteil_lxc3_1115495_tmp_jjkx1k56_pyx_0.foo()
      4     it.next_dimension()
      5     print('a')
----> 6     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace)
      7     print('b')
      8     face.__init__(it)

~/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.pyx in sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face.CombinatorialFace.__cinit__ (build/cythonized/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.c:4022)()
    141         11
    142     """
--> 143     def __cinit__(self, data, dimension=None, index=None):
    144         r"""
    145         Initialize :class:`CombinatorialFace`.

TypeError: __cinit__() takes at least 1 positional argument (0 given)
```




```
sage: from sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face import CombinatorialFace
....: face = CombinatorialFace.__new__(CombinatorialFace)
....: face.ambient_H_indices()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-d41a0d4cfa81> in <module>
      1 from sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face import CombinatorialFace
----> 2 face = CombinatorialFace.__new__(CombinatorialFace)
      3 face.ambient_H_indices()

~/sage-9.1/local/lib/python3.7/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.pyx in sage.geometry.polyhedron.combinatorial_polyhedron.combinatorial_face.CombinatorialFace.__cinit__ (build/cythonized/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.c:4022)()
    141         11
    142     """
--> 143     def __cinit__(self, data, dimension=None, index=None):
    144         r"""
    145         Initialize :class:`CombinatorialFace`.

TypeError: __cinit__() takes at least 1 positional argument (0 given)
```



As they involve a new `__cinit__` method, it might be intended, is it OK ?


---

Comment by @kliem created at 2021-11-30 10:43:57

Yes, this is intended. `CombinatorialFace` cannot be initialized without a `face_t`.

`face_t` can be provided either by `FaceIterator` or by `PolyhedronFaceLattice`.

You need to run


```
sage: Asso = polytopes.associahedron(['A',3])
....: C = Asso.combinatorial_polyhedron()
....: it = C.face_iter()
....: cython('''
....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
....: def foo(FaceIterator_base it):
....:     it.next_dimension()
....:     print('a')  
....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace, it)
....:     print('b')  
....:     face.__init__(it)
....:     print('c')  
....:     return face 
....: ''')
....: foo(it)
```

now. (Actually, you can also skip the `__init__` completely).


---

Comment by @kliem created at 2021-11-30 10:44:18

Great to hear that it works for now. Thanks for checking.


---

Comment by @kliem created at 2021-11-30 10:44:18

Changing status from needs_info to positive_review.


---

Comment by tmonteil created at 2021-11-30 10:56:09

Replying to [comment:25 gh-kliem]:
> Yes, this is intended. `CombinatorialFace` cannot be initialized without a `face_t`.
> 
> `face_t` can be provided either by `FaceIterator` or by `PolyhedronFaceLattice`.
> 
> You need to run
> 
> {{{
> sage: Asso = polytopes.associahedron(['A',3])
> ....: C = Asso.combinatorial_polyhedron()
> ....: it = C.face_iter()
> ....: cython('''
> ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
> ....: def foo(FaceIterator_base it):
> ....:     it.next_dimension()
> ....:     print('a')  
> ....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace, it)
> ....:     print('b')  
> ....:     face.__init__(it)
> ....:     print('c')  
> ....:     return face 
> ....: ''')
> ....: foo(it)
> }}}
> now. (Actually, you can also skip the `__init__` completely).

Great, i got:


```
sage: sage: Asso = polytopes.associahedron(['A',3])
....: ....: C = Asso.combinatorial_polyhedron()
....: ....: it = C.face_iter()
....: ....: cython('''
....: ....: from sage.geometry.polyhedron.combinatorial_polyhedron.face_iterator cimport *
....: ....: def foo(FaceIterator_base it):
....: ....:     it.next_dimension()
....: ....:     print('a')  
....: ....:     cdef CombinatorialFace face = CombinatorialFace.__new__(CombinatorialFace, it)
....: ....:     print('b')  
....: ....:     face.__init__(it)
....: ....:     print('c')  
....: ....:     return face 
....: ....: ''')
....: ....: foo(it)
a
b
c
A 2-dimensional face of a 3-dimensional combinatorial polyhedron
```



---

Comment by vbraun created at 2021-12-10 20:26:42

Segfaults on 32-bit

```
sage: for _ in range(10):
    points = tuple(tuple(randint(-1000,1000) for _ in range(10))
                   for _ in range(randint(3,15)))
    P = Polyhedron(vertices=points)
    inc = P.incidence_matrix()
    mod_inc = inc.delete_columns([i for i,V in enumerate(P.Hrepresentation()) if V.is_equation()])
    facets = incidence_matrix_to_bit_rep_of_facets(mod_inc)
    vertices = incidence_matrix_to_bit_rep_of_Vrep(mod_inc)
    d1 = P.dimension()
    if d1 == 0:
        continue
    d2 = facets.compute_dimension()
    d3 = vertices.compute_dimension()
    if not d1 == d2 == d3:
        print('calculation_dimension() seems to be incorrect') ## line 235 ##
free(): invalid size
------------------------------------------------------------------------
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x5e62)[0xf67ace62]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x5f06)[0xf67acf06]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x88fe)[0xf67af8fe]
linux-gate.so.1(__kernel_sigreturn+0x0)[0xf7efa570]
linux-gate.so.1(__kernel_vsyscall+0x9)[0xf7efa559]
/lib/i386-linux-gnu/libc.so.6(gsignal+0xc2)[0xf79b5e02]
/lib/i386-linux-gnu/libc.so.6(abort+0x129)[0xf799e306]
/lib/i386-linux-gnu/libc.so.6(+0x7899c)[0xf79f999c]
/lib/i386-linux-gnu/libc.so.6(+0x80a5d)[0xf7a01a5d]
/lib/i386-linux-gnu/libc.so.6(+0x81bef)[0xf7a02bef]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/ext/memory.cpython-39-i386-linux-gnu.so(+0x37b4)[0xafaf97b4]
/var/lib/buildbot/worker/sage_git/build/local/lib/libgmp.so.10(__gmpz_clear+0x2a)[0xf6fecd0a]
/var/lib/buildbot/worker/sage_git/build/local/lib/libppl.so.14(_ZN23Parma_Polyhedra_Library7CO_Tree7destroyEv+0x40)[0xa58e6290]
/var/lib/buildbot/worker/sage_git/build/local/lib/libppl.so.14(_ZN23Parma_Polyhedra_Library22Linear_Expression_ImplINS_10Sparse_RowEED0Ev+0x28)[0xa585a5b8]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/ppl/linear_algebra.cpython-39-i386-linux-gnu.so(+0xfca8)[0xa5948ca8]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(+0x5c90f)[0xf7bcc90f]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(PyNumber_InPlaceAdd+0x61)[0xf7bcf311]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/ppl/linear_algebra.cpython-39-i386-linux-gnu.so(+0xbddc)[0xa5944ddc]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(+0xce637)[0xf7c3e637]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyObject_MakeTpCall+0xa4)[0xf7be89a4]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x7900)[0xf7bac170]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(+0x140fcf)[0xf7cb0fcf]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyFunction_Vectorcall+0xde)[0xf7be864e]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x5bd6)[0xf7baa446]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(+0x140fcf)[0xf7cb0fcf]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyFunction_Vectorcall+0xde)[0xf7be864e]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(+0x7af84)[0xf7beaf84]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(PyVectorcall_Call+0xa9)[0xf7be8369]
/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/libpython3.9.so.1.0(_PyObject_Call+0xe9)[0xf7be84b9]
```



---

Comment by vbraun created at 2021-12-10 20:26:42

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2021-12-12 07:26:45

I wonder if initializing `MemoryAllocator` with:


```
    self.mem = MemoryAllocator()
```


in `__init__` might a problem and if it would be better to use `__new__`?


---

Comment by @kliem created at 2021-12-12 09:10:34

One thing that I found is the following:

https://gmplib.org/list-archives/gmp-bugs/2020-September/004888.html

In `bitset_intrinsics.h` I silently assume that `sizeof(mp_limb_t)` and `GMP_LIMB_BITS` are consistent. It would definitely be safer to just use `sizeof(mp_limb_t)` to compute `LIMBS_PER_64`.


---

Comment by dcoudert created at 2021-12-12 10:03:43

A small issue (I think) in method `_compute_edges_or_ridges` of `base.pyx`:

```diff
-        cdef size_t **edges = <size_t**> mem.malloc(sizeof(size_t**))
+        cdef size_t **edges = <size_t**> mem.malloc(sizeof(size_t*))
```



---

Comment by vbraun created at 2021-12-12 10:18:06

There seem to be multiple memory access issues here, my suggestion is to get comfortable with valgrind. Finding these things is generally pretty easy with it.


---

Comment by @kliem created at 2021-12-12 12:33:30

Apparently, there is at least a bug in memory allocator.

Running the test suite, I get


```
==66729==  Address 0x6e7f020 is 528 bytes inside a block of size 800 free'd
==66729==    at 0x483CABF: free (vg_replace_malloc.c:530)
==66729==    by 0x5C01888: sig_free (memory_allocator.c:2764)
==66729==    by 0x5C01888: __pyx_pf_16memory_allocator_16memory_allocator_15MemoryAllocator_2__dealloc__ (memory_allocator.c:2078)
==66729==    by 0x5C01888: __pyx_pw_16memory_allocator_16memory_allocator_15MemoryAllocator_3__dealloc__ (memory_allocator.c:2044)
==66729==    by 0x5C01888: __pyx_tp_dealloc_16memory_allocator_16memory_allocator_MemoryAllocator (memory_allocator.c:3652)
==66729==    by 0x4859D9C: _Py_DECREF (object.h:478)
==66729==    by 0x4859D9C: __pyx_tp_dealloc_16memory_allocator_4test_TestMemoryAllocator (test.c:3615)
==66729==    by 0x5CF74A: PyDict_Clear (in /usr/bin/python3.8)
==66729==    by 0x6A9C09: ??? (in /usr/bin/python3.8)
==66729==    by 0x5045DA: ??? (in /usr/bin/python3.8)
==66729==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66729==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66729==    by 0x5F6342: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66729==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66729==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66729==    by 0x5F6342: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66729==  Block was alloc'd at
==66729==    at 0x483B873: malloc (vg_replace_malloc.c:299)
==66729==    by 0x5C03224: sig_malloc (memory_allocator.c:2580)
==66729==    by 0x5C03224: __pyx_f_16memory_allocator_6memory_check_allocarray (memory_allocator.c:2956)
==66729==    by 0x5C03224: __pyx_f_16memory_allocator_16memory_allocator_15MemoryAllocator_allocarray (memory_allocator.c:1831)
==66729==    by 0x4861189: __pyx_f_16memory_allocator_16memory_allocator_15MemoryAllocator_aligned_allocarray (test.c:3572)
==66729==    by 0x4861189: __pyx_pf_16memory_allocator_4test_19TestMemoryAllocator_16aligned_allocarray (test.c:2394)
==66729==    by 0x4861189: __pyx_pw_16memory_allocator_4test_19TestMemoryAllocator_17aligned_allocarray (test.c:2363)
==66729==    by 0x503EA8: ??? (in /usr/bin/python3.8)
==66729==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66729==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66729==    by 0x68D5B6: PyEval_EvalCode (in /usr/bin/python3.8)
==66729==    by 0x600F53: ??? (in /usr/bin/python3.8)
==66729==    by 0x5C552F: ??? (in /usr/bin/python3.8)
==66729==    by 0x56BDDC: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66729==    by 0x5F6165: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66729==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
```


And it is not deterministic:


```
==66727==  Address 0x6e7e020 is 96 bytes inside a block of size 1,600 free'd
==66727==    at 0x483CABF: free (vg_replace_malloc.c:530)
==66727==    by 0x5C01888: sig_free (memory_allocator.c:2764)
==66727==    by 0x5C01888: __pyx_pf_16memory_allocator_16memory_allocator_15MemoryAllocator_2__dealloc__ (memory_allocator.c:2078)
==66727==    by 0x5C01888: __pyx_pw_16memory_allocator_16memory_allocator_15MemoryAllocator_3__dealloc__ (memory_allocator.c:2044)
==66727==    by 0x5C01888: __pyx_tp_dealloc_16memory_allocator_16memory_allocator_MemoryAllocator (memory_allocator.c:3652)
==66727==    by 0x4859D9C: _Py_DECREF (object.h:478)
==66727==    by 0x4859D9C: __pyx_tp_dealloc_16memory_allocator_4test_TestMemoryAllocator (test.c:3615)
==66727==    by 0x5CF74A: PyDict_Clear (in /usr/bin/python3.8)
==66727==    by 0x6A9C09: ??? (in /usr/bin/python3.8)
==66727==    by 0x5045DA: ??? (in /usr/bin/python3.8)
==66727==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66727==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66727==    by 0x5F6342: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66727==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66727==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66727==    by 0x5F6342: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66727==  Block was alloc'd at
==66727==    at 0x483DE1A: calloc (vg_replace_malloc.c:752)
==66727==    by 0x5C03798: sig_calloc (memory_allocator.c:2704)
==66727==    by 0x5C03798: __pyx_f_16memory_allocator_6memory_check_calloc (memory_allocator.c:3540)
==66727==    by 0x5C03798: __pyx_f_16memory_allocator_16memory_allocator_15MemoryAllocator_calloc (memory_allocator.c:1748)
==66727==    by 0x48620F9: __pyx_f_16memory_allocator_16memory_allocator_15MemoryAllocator_aligned_calloc (test.c:3514)
==66727==    by 0x48620F9: __pyx_pf_16memory_allocator_4test_19TestMemoryAllocator_14aligned_calloc (test.c:2260)
==66727==    by 0x48620F9: __pyx_pw_16memory_allocator_4test_19TestMemoryAllocator_15aligned_calloc (test.c:2229)
==66727==    by 0x503EA8: ??? (in /usr/bin/python3.8)
==66727==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66727==    by 0x56A0B9: _PyEval_EvalCodeWithName (in /usr/bin/python3.8)
==66727==    by 0x68D5B6: PyEval_EvalCode (in /usr/bin/python3.8)
==66727==    by 0x600F53: ??? (in /usr/bin/python3.8)
==66727==    by 0x5C552F: ??? (in /usr/bin/python3.8)
==66727==    by 0x56BDDC: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
==66727==    by 0x5F6165: _PyFunction_Vectorcall (in /usr/bin/python3.8)
==66727==    by 0x56BF08: _PyEval_EvalFrameDefault (in /usr/bin/python3.8)
```


At a first glance it looks like its trying to free the aligned memory instead of the memory that was actually allocated.


---

Comment by vbraun created at 2021-12-12 13:41:25

there was a bug fixed in #32590, that is merged in 9.5.beta4


---

Comment by @kliem created at 2021-12-12 13:52:53

Replying to [comment:34 vbraun]:
> there was a bug fixed in #32590, that is merged in 9.5.beta4

Thanks for the reminder. Unfortunatly, this was only a test suite bug.


---

Comment by vbraun created at 2021-12-12 14:42:14

My guess is that `528 bytes inside a block of size 800` is too far in for this to be an alignment calculation bug.


---

Comment by @kliem created at 2021-12-13 08:23:23

Well, the problem only appeared for me when running the test suite on sage's memory_allocator. Not for the memory allocator installed through systems python.

Now, I just ran `make memory_allocator-clean` and I don't get those errors anymore. I'm rerunning sage and will see, if it completely went away.


---

Comment by @kliem created at 2021-12-13 09:33:52

Yes, the problem went away. There are various possible conclusions here:

- I don't know how to use valgrind. Very likely. Using `sage --valgrind` seems to be completely useless. Instead I just installed `valgrind` in the system and run

```
valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all python3 foo.py
```

  within the sage shell on various test files. This gives lots and lots of errors. Among them those errors listed above. But they seem to be gone now.
  If I just run

```
   valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all sage -t --long $SAGE_SRC/sage/geometry/polyhedron/combinatorial_polyhedron/
```

  I don't get useful output at all.
- This problem actually goes away by running `make memory-allocator_clean` for whatever reason.
- This problem is elsewhere. E.g. #32827#comment:30, but possibly somewhere else as well.


---

Comment by tmonteil created at 2021-12-13 14:19:37

Can we split the ticket in two tickets :

- about moving `__init__` to `__cinit__` (current branch)
- about memory allocator

If this is doable and the current branch can be merged soon, i will be able to restart my patchbots.


---

Comment by @kliem created at 2021-12-14 12:15:04

I'm not sure that Volker will accept such a split. From what I understand from #32827#comment:28 he rejected the proposed changes not because they do not fix it, but because they lead to a new failure.

What might not work is passing `MemoryAllocator` as an argument to functions for it to allocate memory. But I don't know. I could remove the usage of `MemoryAllocator` from bitsets alltogether and hope that this fixes something.

Another thing that should be fixed is the following: Currently `face_list_t` is only one type and depending on the context it is a shallow copy or not. This is not good practice. Instead one could use `fused_types` again to have a shallow list and a deep list. Depending on the type of the destination `face_list_copy` would then just to the correct thing and same with `face_list_init`.


---

Comment by dcoudert created at 2021-12-14 12:29:03

I don't have a full understanding of the code, but it's surprising to see methods with `MemoryAllocator` as parameter and also the use of tuple `_mem_tuple` to store several memory allocators. Is it really better this way ? Does it help reducing memory consumption significantly ?


---

Comment by @kliem created at 2021-12-14 12:34:29

No, its purpose was not to reduce memory consumption, but to make it easier to take care of the resources. Apparently it is not working.


---

Comment by tmonteil created at 2021-12-14 12:39:42

OK, i will keep `tmonteil-lxc1` and `tmonteil-lxc3` patchbots in their current state until this ticket is merged.


---

Comment by dcoudert created at 2021-12-14 12:42:14

Replying to [comment:42 gh-kliem]:
> No, its purpose was not to reduce memory consumption, but to make it easier to take care of the resources. Apparently it is not working.

Then you can have a single memory allocator for the class, except for methods where allocated objects are local.


---

Comment by @kliem created at 2021-12-14 13:00:01

This would still involve some work regarding interrupts. Currently I use the tuple to only keep the memory after success.


---

Comment by @kliem created at 2021-12-15 14:35:30

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-12-15 14:35:30

Ok, new try. I completely removed the usage of `MemoryAllocator` as argument, hoping that this solves our problem.

A future change would be to distinguish between `deep_face_list_t` and `shallow_face_list_t` (or similar). This would further clean up code. However, I hope it works now.

(It requires slightly more memory now to run the face iterator, as the coatoms are deep copied now, such that all of `FaceIterator.new_faces[i]` are of the same type, namely deeply allocated face lists.)
----
New commits:


---

Comment by @kliem created at 2021-12-16 15:25:51

So the patchbot seems somewhat happy and complains about coverage.

I will add doctests for `__dealloc__` illustrating that an error during initialization does not result in segmentation fault.

Also I will remove the hacks that tell us how far initialization worked out. This can be seen be properly setting values to zero.


---

Comment by @kliem created at 2021-12-16 15:25:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-12-16 18:25:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-12-16 18:26:11

Should be cleaner now.


---

Comment by @kliem created at 2021-12-16 18:26:11

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-12-17 15:32:14

One bot is happy and just reports to random failures:
- #32782#comment:10
- #33039


---

Comment by tmonteil created at 2021-12-18 00:47:06

With the last branch, on `tmonteil-lxc3`, the doctests of `src/sage/geometry/polyhedron/` pass, and all the previous tests that you let me try in that ticket that do not involve `MemoryAllocator` pass as well.


---

Comment by mkoeppe created at 2021-12-18 04:00:09

The tests on GH Actions that have completed so far also look good.


---

Comment by mkoeppe created at 2021-12-18 04:00:09

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-12-18 09:48:14

Thank you.


---

Comment by vbraun created at 2021-12-23 20:26:40

Resolution: fixed


---

Comment by vbraun created at 2021-12-23 20:35:29

This is still borked on 32-bit, I've made #33073 as a follow-up.
