# Issue 24665: optional package deformation fails to build

archive/issues_024665.json:
```json
{
    "body": "CC:  jpflori\n\nOn archlinux\n\n```\n/usr/bin/ld: -r and -pie may not be used together\n```\n\n\nSee the more complete log at XXX\n\nIssue created by migration from https://trac.sagemath.org/ticket/24902\n\n",
    "created_at": "2018-03-05T16:47:42Z",
    "labels": [
        "packages: optional",
        "blocker",
        "bug"
    ],
    "title": "optional package deformation fails to build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24665",
    "user": "vdelecroix"
}
```
CC:  jpflori

On archlinux

```
/usr/bin/ld: -r and -pie may not be used together
```


See the more complete log at XXX

Issue created by migration from https://trac.sagemath.org/ticket/24902





---

archive/issue_comments_345921.json:
```json
{
    "body": "Attachment [deformation-d05941b.log](tarball://root/attachments/some-uuid/ticket24902/deformation-d05941b.log) by vdelecroix created at 2018-03-05 16:48:38",
    "created_at": "2018-03-05T16:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345921",
    "user": "vdelecroix"
}
```

Attachment [deformation-d05941b.log](tarball://root/attachments/some-uuid/ticket24902/deformation-d05941b.log) by vdelecroix created at 2018-03-05 16:48:38



---

archive/issue_comments_345922.json:
```json
{
    "body": "Flint had that issue some time ago. This is caused by the hardening of the toolchain. Look at what has been done for flint here\n[https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch](https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch). Basically you give `-r` directly to the compiler but don't pass it directly to the linker as you would with `-Wl,-r`.",
    "created_at": "2018-03-05T20:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345922",
    "user": "fbissey"
}
```

Flint had that issue some time ago. This is caused by the hardening of the toolchain. Look at what has been done for flint here
[https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch](https://github.com/sagemath/sage/blob/master/build/pkgs/flint/patches/flint-pie-hardening-conflict.patch). Basically you give `-r` directly to the compiler but don't pass it directly to the linker as you would with `-Wl,-r`.



---

archive/issue_comments_345923.json:
```json
{
    "body": "The culprit is this line\n\n```\nMakefile.subdirs:       $(QUIET_CC) $(CC) $(ABI_FLAG) -Wl,-r $^ -o $@ -nostdlib\n```\n\nChange `-Wl,-r` to plain `-r` should get you in business. Can someone also please update `SPKG.txt` with upstream location? Where did you get that tarball from? Has it been processed before being put on the mirror?",
    "created_at": "2018-03-06T01:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345923",
    "user": "fbissey"
}
```

The culprit is this line

```
Makefile.subdirs:       $(QUIET_CC) $(CC) $(ABI_FLAG) -Wl,-r $^ -o $@ -nostdlib
```

Change `-Wl,-r` to plain `-r` should get you in business. Can someone also please update `SPKG.txt` with upstream location? Where did you get that tarball from? Has it been processed before being put on the mirror?



---

archive/issue_comments_345924.json:
```json
{
    "body": "A patch is provided in #24575, should I move it here?",
    "created_at": "2018-03-08T10:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345924",
    "user": "vdelecroix"
}
```

A patch is provided in #24575, should I move it here?



---

archive/issue_comments_345925.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> A patch is provided in #24575, should I move it here?",
    "created_at": "2018-03-08T10:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345925",
    "user": "vdelecroix"
}
```

Replying to [comment:5 vdelecroix]:
> A patch is provided in #24575, should I move it here?



---

archive/issue_comments_345926.json:
```json
{
    "body": "No need we can just mark this ticket as a \"duplicate\" of #24575.",
    "created_at": "2018-03-08T10:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345926",
    "user": "fbissey"
}
```

No need we can just mark this ticket as a "duplicate" of #24575.



---

archive/issue_comments_345927.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-08T10:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345927",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_345928.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-11T17:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345928",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_345929.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2018-04-15T10:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345929",
    "user": "chapoton"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_345930.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345930",
    "user": "vdelecroix"
}
```

Resolution: wontfix



---

archive/issue_comments_345931.json:
```json
{
    "body": "closing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24665#issuecomment-345931",
    "user": "vdelecroix"
}
```

closing positively reviewed duplicates
