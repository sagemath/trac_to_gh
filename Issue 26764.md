# Issue 26764: py3: fix pip_installed_packages

Issue created by migration from https://trac.sagemath.org/ticket/27001

Original creator: chapoton

Original creation time: 2019-01-02 15:42:10

CC:  embray jdemeyer

by using pip3 when appropriate


---

Comment by chapoton created at 2019-01-02 15:42:30

New commits:


---

Comment by chapoton created at 2019-01-02 15:42:30

Changing status from new to needs_review.


---

Comment by embray created at 2019-01-02 15:47:10

This should really be


```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 689e5a2..f7bfbc4 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -48,6 +48,7 @@ from sage.env import SAGE_ROOT, SAGE_PKGS
 import json
 import os
 import subprocess
+import sys
 try:
     # Python 3.3+
     from urllib.request import urlopen
@@ -142,9 +143,12 @@ def pip_installed_packages():
         sage: d['beautifulsoup']   # optional - beautifulsoup
         u'...'
     """
-    proc = subprocess.Popen(["pip", "list", "--no-index", "--format", "json"],
+    proc = subprocess.Popen([sys.executable, "-m", "pip", "list", "--no-index",
+                             "--format", "json"], stdout=subprocess.PIPE)
     stdout = proc.communicate()[0].decode()
-    return {package['name'].lower():package['version'] for package in json.load
+    return {package['name'].lower(): package['version']
+            for package in json.loads(stdout)}
+

 def list_packages(*pkg_types, **opts):
     r"""
```


Apparently I already had this fix in my python3 branch: I apologize for forgetting to make a ticket for it.


---

Comment by embray created at 2019-01-02 15:47:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-01-02 15:52:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-01-02 15:53:10

done


---

Comment by chapoton created at 2019-01-02 15:53:10

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-01-02 15:56:36

Changing priority from major to minor.


---

Comment by embray created at 2019-01-02 15:56:36

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-02 15:56:36

Changing type from enhancement to defect.


---

Comment by embray created at 2019-01-02 15:56:36

Ok thanks!


---

Comment by embray created at 2019-01-15 18:16:10

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by vbraun created at 2019-01-26 15:52:11

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-01-26 15:52:11


```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 412, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
File "src/sage/tests/cmdline.py", line 417, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
1 item had failures:
   2 of 251 in sage.tests.cmdline.test_executable
    [250 tests, 2 failures, 41.92 s]
----------------------------------------------------------------------
sage -t --long src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by chapoton created at 2019-01-27 19:22:31

Erik or Jeroen, any idea on how to fix that ?


---

Comment by chapoton created at 2019-01-29 08:35:38

should I just add `...` before the actual doctest ?


---

Comment by embray created at 2019-01-29 17:16:17

#26457 has discussion about rewriting, if not entirely removing that test.


---

Comment by chapoton created at 2019-02-05 19:32:47

so what should we do here ?


---

Comment by jdemeyer created at 2019-02-06 09:25:57

Replying to [comment:11 chapoton]:
> so what should we do here ?

(edited because original answer was wrong)

It seems that the doctest framework is using `pip_installed_packages` which is now causing Python to be run from an artificially unsafe directory. In this case, it's fine to just change the doctest output.


---

Comment by jhpalmieri created at 2019-02-17 02:30:23

If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).


---

Comment by jhpalmieri created at 2019-02-21 17:24:13

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-02-21 17:24:13

I see two options: either

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..a5e2e6fbbf 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -409,12 +409,21 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.mkdir(d)
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        RuntimeError: refusing to run doctests...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
```

or

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..08bda7c435 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -410,12 +410,10 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
 
```

Here is a branch using the second version.
----
New commits:


---

Comment by chapoton created at 2019-02-22 19:40:16

ok, looks good to me. Jeroen, do you approve ?


---

Comment by embray created at 2019-02-26 14:24:28

I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?


---

Comment by jhpalmieri created at 2019-02-26 18:55:57

It passes tests for me with Python 2 and Python 3, so I guess we fixed it.


---

Comment by embray created at 2019-02-28 15:14:25

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-02-28 15:14:25

I don't remember that, but I guess so!


---

Comment by embray created at 2019-02-28 15:15:08

(I'm not Jeroen, obviously, but I think this seems to reflect his suggestion)


---

Comment by chapoton created at 2019-02-28 15:18:06

I am slightly worried by comment:17 too.

Maybe we should make sure that this is fixed and the doctests are run ?


---

Comment by jdemeyer created at 2019-02-28 15:19:37

Replying to [comment:17 embray]:
> I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?

I somehow seem to recall that this was fixed and that now a `....:` continuation is required after a `sage:` prompt.


---

Comment by chapoton created at 2019-02-28 15:29:16

ok, then let's go.


---

Comment by jdemeyer created at 2019-02-28 15:54:54

Replying to [comment:13 jhpalmieri]:
> If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).

I just posted a new topic on sage-devel `What to do with the sys.path security patch?` referring this.


---

Comment by jhpalmieri created at 2019-02-28 16:09:03

Replying to [comment:21 chapoton]:
> I am slightly worried by comment:17 too.
> 
> Maybe we should make sure that this is fixed and the doctests are run ?

I will confirm that the tests are run: they fail if I change the text.


---

Comment by vbraun created at 2019-03-02 09:38:26

Resolution: fixed
