# Issue 14537: Fix implicit_plot()  so that we can save PDF's

archive/issues_014537.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  @kcrisman @vbraun\n\nIn Sage 5.9:\n\n```\nsage: f = lambda x, y : (abs(cos((x + I * y) ** 4)) - 1) \nsage: g2 = implicit_plot(f,(-4, 4),(-3, 3),linewidth=0.6)\nsage: g2.save('/tmp/cosz4_2.pdf')\nTypeError: Don't know a PDF representation for <type 'sage.rings.real_mpfr.RealLiteral'> objects.\n```\n\nSee also #13732.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14741\n\n",
    "created_at": "2013-06-14T18:58:16Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.11",
    "title": "Fix implicit_plot()  so that we can save PDF's",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14537",
    "user": "https://github.com/zimmermann6"
}
```
Assignee: jason, was

CC:  @kcrisman @vbraun

In Sage 5.9:

```
sage: f = lambda x, y : (abs(cos((x + I * y) ** 4)) - 1) 
sage: g2 = implicit_plot(f,(-4, 4),(-3, 3),linewidth=0.6)
sage: g2.save('/tmp/cosz4_2.pdf')
TypeError: Don't know a PDF representation for <type 'sage.rings.real_mpfr.RealLiteral'> objects.
```

See also #13732.

Issue created by migration from https://trac.sagemath.org/ticket/14741





---

archive/issue_comments_184293.json:
```json
{
    "body": "The plot code should either just convert all floating-point arguments to Python float, or perhaps fix matplotlib. In fact, I'm leaning toward the latter as it seems to be a recurring problem just in the PDF backend. Thoughts?\n\nAlso relevant: Bob the angry flower http://www.angryflower.com/bobsqu.gif",
    "created_at": "2013-06-15T12:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184293",
    "user": "https://github.com/vbraun"
}
```

The plot code should either just convert all floating-point arguments to Python float, or perhaps fix matplotlib. In fact, I'm leaning toward the latter as it seems to be a recurring problem just in the PDF backend. Thoughts?

Also relevant: Bob the angry flower http://www.angryflower.com/bobsqu.gif



---

archive/issue_comments_184294.json:
```json
{
    "body": "I plan to work on this the next few days.\n\n> The plot code should either just convert all floating-point arguments to  Python float, or perhaps fix matplotlib. In fact, I'm leaning toward  the latter as it seems to be a recurring problem just in the PDF  backend. Thoughts?\n\nYes, this is why well-designed languages feature strong typing. ;-)\n\nSpeaking seriously, it looks to me as if the most successful approach would be to patch `matplotlib()`, beginning in line 2079 of `sage/plot/graphics.py`, to make sure the arguments we sent it are `float`s rather than `MPFR` data types.\n\nOr is this the wrong idea?",
    "created_at": "2013-07-06T04:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184294",
    "user": "https://github.com/johnperry-math"
}
```

I plan to work on this the next few days.

> The plot code should either just convert all floating-point arguments to  Python float, or perhaps fix matplotlib. In fact, I'm leaning toward  the latter as it seems to be a recurring problem just in the PDF  backend. Thoughts?

Yes, this is why well-designed languages feature strong typing. ;-)

Speaking seriously, it looks to me as if the most successful approach would be to patch `matplotlib()`, beginning in line 2079 of `sage/plot/graphics.py`, to make sure the arguments we sent it are `float`s rather than `MPFR` data types.

Or is this the wrong idea?



---

archive/issue_comments_184295.json:
```json
{
    "body": "Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.",
    "created_at": "2013-07-06T12:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184295",
    "user": "https://github.com/vbraun"
}
```

Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.



---

archive/issue_comments_184296.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.\n\nThanks. Watch this space for a patch, coming Real Soon Now (TM).",
    "created_at": "2013-07-07T04:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184296",
    "user": "https://github.com/johnperry-math"
}
```

Replying to [comment:4 vbraun]:
> Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.

Thanks. Watch this space for a patch, coming Real Soon Now (TM).



---

archive/issue_comments_184297.json:
```json
{
    "body": "Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class, then modify the `matplotlib` function to ensure the options have type `float`, rather than `RealLiteral`. This keeps the patch short, clean, and simple. I added corresponding doctests, which test fine for me. This fixes the bug on my machine.\n\nI suspect we should be able to remove all the hacks being used in other files to convert options to `float` (e.g., `circle`, `disc`, `line`, ...). That is not part of this patch, though I could add another patch to do so, if desirable.",
    "created_at": "2013-07-13T05:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184297",
    "user": "https://github.com/johnperry-math"
}
```

Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class, then modify the `matplotlib` function to ensure the options have type `float`, rather than `RealLiteral`. This keeps the patch short, clean, and simple. I added corresponding doctests, which test fine for me. This fixes the bug on my machine.

I suspect we should be able to remove all the hacks being used in other files to convert options to `float` (e.g., `circle`, `disc`, `line`, ...). That is not part of this patch, though I could add another patch to do so, if desirable.



---

archive/issue_comments_184298.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-07-13T05:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184298",
    "user": "https://github.com/johnperry-math"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_184299.json:
```json
{
    "body": "Replying to [comment:6 john_perry]:\n> Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class...\n\nIncidentally, I'm rather surprised that such a method doesn't already exist. It would seem useful to a user who knew what s/he was doing.",
    "created_at": "2013-07-13T05:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184299",
    "user": "https://github.com/johnperry-math"
}
```

Replying to [comment:6 john_perry]:
> Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class...

Incidentally, I'm rather surprised that such a method doesn't already exist. It would seem useful to a user who knew what s/he was doing.



---

archive/issue_comments_184300.json:
```json
{
    "body": "According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O",
    "created_at": "2013-07-13T22:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184300",
    "user": "https://github.com/johnperry-math"
}
```

According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O



---

archive/issue_comments_184301.json:
```json
{
    "body": "Replying to [comment:8 john_perry]:\n> According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O\n\nNot quite. ;-) The problem is caused by the patch to trac #14664, which adds a doctest in the same place that I do. I'll fix it, and upload a new patch.\n\nSorry for the noise.",
    "created_at": "2013-07-13T23:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184301",
    "user": "https://github.com/johnperry-math"
}
```

Replying to [comment:8 john_perry]:
> According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O

Not quite. ;-) The problem is caused by the patch to trac #14664, which adds a doctest in the same place that I do. I'll fix it, and upload a new patch.

Sorry for the noise.



---

archive/issue_comments_184302.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-07-13T23:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184302",
    "user": "https://github.com/johnperry-math"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_184303.json:
```json
{
    "body": "I have submitted an updated patch, adding the relevant dependency -- which had another dependency itself.\n\nNeeds review!",
    "created_at": "2013-07-13T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184303",
    "user": "https://github.com/johnperry-math"
}
```

I have submitted an updated patch, adding the relevant dependency -- which had another dependency itself.

Needs review!



---

archive/issue_comments_184304.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-13T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184304",
    "user": "https://github.com/johnperry-math"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_184305.json:
```json
{
    "body": "Its not just RealLiteral that we have to worry about, somebody might compute linewidth from some numerical formula and hand down elements of other \"real fields\", like RealField, RealDoubleField, or RealIntervalField. I would suggest a more relaxed check, something like\n\n```\ntry: \n    if v.parent() in Fields():\n        v = float(v)\nexcept (AttributeError, TypeError):\n    pass\n```\n\nsince I'm pretty sure that floating-point numbers are the only Sage field that can be used as matplotlib parameters.\n\nAlso, it would be nice to save a copy of options and restore them after the call to matplotlib.",
    "created_at": "2013-07-14T01:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184305",
    "user": "https://github.com/vbraun"
}
```

Its not just RealLiteral that we have to worry about, somebody might compute linewidth from some numerical formula and hand down elements of other "real fields", like RealField, RealDoubleField, or RealIntervalField. I would suggest a more relaxed check, something like

```
try: 
    if v.parent() in Fields():
        v = float(v)
except (AttributeError, TypeError):
    pass
```

since I'm pretty sure that floating-point numbers are the only Sage field that can be used as matplotlib parameters.

Also, it would be nice to save a copy of options and restore them after the call to matplotlib.



---

archive/issue_comments_184306.json:
```json
{
    "body": "patch to modify primitive.py and graphics.py; adds set_options() method to GraphicsPrimitive? class and modifies matplotlib() method of Graphics",
    "created_at": "2013-07-14T05:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184306",
    "user": "https://github.com/johnperry-math"
}
```

patch to modify primitive.py and graphics.py; adds set_options() method to GraphicsPrimitive? class and modifies matplotlib() method of Graphics



---

archive/issue_comments_184307.json:
```json
{
    "body": "Attachment [trac_14741_graphics_primitive_options_for_matplotlib.patch](tarball://root/attachments/some-uuid/ticket14741/trac_14741_graphics_primitive_options_for_matplotlib.patch) by @johnperry-math created at 2013-07-14 05:53:09\n\nI've added both requests to the patch. Still needs review. :-)",
    "created_at": "2013-07-14T05:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184307",
    "user": "https://github.com/johnperry-math"
}
```

Attachment [trac_14741_graphics_primitive_options_for_matplotlib.patch](tarball://root/attachments/some-uuid/ticket14741/trac_14741_graphics_primitive_options_for_matplotlib.patch) by @johnperry-math created at 2013-07-14 05:53:09

I've added both requests to the patch. Still needs review. :-)



---

archive/issue_comments_184308.json:
```json
{
    "body": "Looks good to me, thanks!",
    "created_at": "2013-07-14T13:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184308",
    "user": "https://github.com/vbraun"
}
```

Looks good to me, thanks!



---

archive/issue_comments_184309.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-14T13:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184309",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_014296.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-31T12:56:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14537#event-14296"
}
```



---

archive/issue_comments_184310.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-07-31T12:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14537#issuecomment-184310",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
