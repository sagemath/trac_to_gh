# Issue 14537: Fix implicit_plot()  so that we can save PDF's

Issue created by migration from Trac.

Original creator: zimmerma

Original creation time: 2013-06-14 18:58:16

Assignee: jason, was

CC:  kcrisman vbraun

In Sage 5.9:

```
sage: f = lambda x, y : (abs(cos((x + I * y) ** 4)) - 1) 
sage: g2 = implicit_plot(f,(-4, 4),(-3, 3),linewidth=0.6)
sage: g2.save('/tmp/cosz4_2.pdf')
TypeError: Don't know a PDF representation for <type 'sage.rings.real_mpfr.RealLiteral'> objects.
```

See also #13732.


---

Comment by vbraun created at 2013-06-15 12:53:49

The plot code should either just convert all floating-point arguments to Python float, or perhaps fix matplotlib. In fact, I'm leaning toward the latter as it seems to be a recurring problem just in the PDF backend. Thoughts?

Also relevant: Bob the angry flower http://www.angryflower.com/bobsqu.gif


---

Comment by john_perry created at 2013-07-06 04:46:56

I plan to work on this the next few days.

> The plot code should either just convert all floating-point arguments to  Python float, or perhaps fix matplotlib. In fact, I'm leaning toward  the latter as it seems to be a recurring problem just in the PDF  backend. Thoughts?

Yes, this is why well-designed languages feature strong typing. ;-)

Speaking seriously, it looks to me as if the most successful approach would be to patch `matplotlib()`, beginning in line 2079 of `sage/plot/graphics.py`, to make sure the arguments we sent it are `float`s rather than `MPFR` data types.

Or is this the wrong idea?


---

Comment by vbraun created at 2013-07-06 12:18:32

Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.


---

Comment by john_perry created at 2013-07-07 04:34:33

Replying to [comment:4 vbraun]:
> Thats what I meant, convert the floating-point arguments to Python floats **before handing them to matplotlib**.

Thanks. Watch this space for a patch, coming Real Soon Now (TM).


---

Comment by john_perry created at 2013-07-13 05:57:38

Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class, then modify the `matplotlib` function to ensure the options have type `float`, rather than `RealLiteral`. This keeps the patch short, clean, and simple. I added corresponding doctests, which test fine for me. This fixes the bug on my machine.

I suspect we should be able to remove all the hacks being used in other files to convert options to `float` (e.g., `circle`, `disc`, `line`, ...). That is not part of this patch, though I could add another patch to do so, if desirable.


---

Comment by john_perry created at 2013-07-13 05:57:38

Changing status from new to needs_review.


---

Comment by john_perry created at 2013-07-13 05:59:35

Replying to [comment:6 john_perry]:
> Near as I can tell, the best solution is to add a `set_options` method to the `GraphicPrimitive` class...

Incidentally, I'm rather surprised that such a method doesn't already exist. It would seem useful to a user who knew what s/he was doing.


---

Comment by john_perry created at 2013-07-13 22:54:08

According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O


---

Comment by john_perry created at 2013-07-13 23:03:15

Replying to [comment:8 john_perry]:
> According to the patchbot, the patch fails on 5.11.b3. Geez, do I have to download a new version of Sage every week? X-O

Not quite. ;-) The problem is caused by the patch to trac #14664, which adds a doctest in the same place that I do. I'll fix it, and upload a new patch.

Sorry for the noise.


---

Comment by john_perry created at 2013-07-13 23:03:15

Changing status from needs_review to needs_work.


---

Comment by john_perry created at 2013-07-13 23:43:43

I have submitted an updated patch, adding the relevant dependency -- which had another dependency itself.

Needs review!


---

Comment by john_perry created at 2013-07-13 23:43:43

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-07-14 01:42:14

Its not just RealLiteral that we have to worry about, somebody might compute linewidth from some numerical formula and hand down elements of other "real fields", like RealField, RealDoubleField, or RealIntervalField. I would suggest a more relaxed check, something like

```
try: 
    if v.parent() in Fields():
        v = float(v)
except (AttributeError, TypeError):
    pass
```

since I'm pretty sure that floating-point numbers are the only Sage field that can be used as matplotlib parameters.

Also, it would be nice to save a copy of options and restore them after the call to matplotlib.


---

Comment by john_perry created at 2013-07-14 05:52:11

patch to modify primitive.py and graphics.py; adds set_options() method to GraphicsPrimitive? class and modifies matplotlib() method of Graphics


---

Attachment

I've added both requests to the patch. Still needs review. :-)


---

Comment by vbraun created at 2013-07-14 13:45:10

Looks good to me, thanks!


---

Comment by vbraun created at 2013-07-14 13:45:50

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-07-31 12:56:40

Resolution: fixed
