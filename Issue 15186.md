# Issue 15186: Add auto-rebasing mechanism for Cygwin

archive/issues_015186.json:
```json
{
    "body": "CC:  kcrisman dimpase jdemeyer jpflori tscrim\n\nWith Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.\nThis could be automated in the following way\n* try to build\n* if that fails and we're on Cygwin,\n* grep the failing logs for error messages cuased by fork issues\n* if all erros are caused by fork issues:\n  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),\n  * go back to step one\n* if not fails as usual\n\nHaving this would open the way to a buildbot or a patchbot for Cygwin.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15423\n\n",
    "created_at": "2013-11-15T14:47:12Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "enhancement"
    ],
    "title": "Add auto-rebasing mechanism for Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15186",
    "user": "jpflori"
}
```
CC:  kcrisman dimpase jdemeyer jpflori tscrim

With Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.
This could be automated in the following way
* try to build
* if that fails and we're on Cygwin,
* grep the failing logs for error messages cuased by fork issues
* if all erros are caused by fork issues:
  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),
  * go back to step one
* if not fails as usual

Having this would open the way to a buildbot or a patchbot for Cygwin.

Issue created by migration from https://trac.sagemath.org/ticket/15423





---

archive/issue_comments_195006.json:
```json
{
    "body": "I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.\n\nI would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195006",
    "user": "embray"
}
```

I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.

I would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.



---

archive/issue_comments_195007.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195007",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_195008.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2017-04-21T12:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195008",
    "user": "embray"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_195009.json:
```json
{
    "body": "New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.\n----\nNew commits:",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195009",
    "user": "embray"
}
```

New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.
----
New commits:



---

archive/issue_comments_195010.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195010",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195011.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-05T14:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195011",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195012.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195012",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_195013.json:
```json
{
    "body": "Looks like that last commit has a merge conflict.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195013",
    "user": "embray"
}
```

Looks like that last commit has a merge conflict.



---

archive/issue_comments_195014.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-05T14:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195014",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_195015.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-05T14:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195015",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_195016.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195016",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_195017.json:
```json
{
    "body": "LGTM",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195017",
    "user": "jpflori"
}
```

LGTM



---

archive/issue_comments_195018.json:
```json
{
    "body": "In `src/Makefile.in`, is this really needed for the rebase script to work?\n\n```\n    (cd $(srcdir)                                       \\\n     && export SAGE_ROOT=/doesnotexist                          \\\n           SAGE_SRC=/doesnotexist                           \\\n           SAGE_SRC_ROOT=/doesnotexist                          \\\n           SAGE_DOC_SRC=/doesnotexist                           \\\n           SAGE_BUILD_DIR=/doesnotexist                         \\\n           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \\\n           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \\\n```\n\n\nIf not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.\n\nMinor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195018",
    "user": "jdemeyer"
}
```

In `src/Makefile.in`, is this really needed for the rebase script to work?

```
    (cd $(srcdir)                                       \
     && export SAGE_ROOT=/doesnotexist                          \
           SAGE_SRC=/doesnotexist                           \
           SAGE_SRC_ROOT=/doesnotexist                          \
           SAGE_DOC_SRC=/doesnotexist                           \
           SAGE_BUILD_DIR=/doesnotexist                         \
           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \
           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \
```


If not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.

Minor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.



---

archive/issue_comments_195019.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195019",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_195020.json:
```json
{
    "body": "Nah the rebase script does only care about SAGE_LOCAL.",
    "created_at": "2017-05-17T12:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195020",
    "user": "jpflori"
}
```

Nah the rebase script does only care about SAGE_LOCAL.



---

archive/issue_comments_195021.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195021",
    "user": "jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_195022.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195022",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_195023.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195023",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_195024.json:
```json
{
    "body": "Ok, let's go with jeroen solution.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195024",
    "user": "jpflori"
}
```

Ok, let's go with jeroen solution.



---

archive/issue_comments_195025.json:
```json
{
    "body": "You're right, this is fine.",
    "created_at": "2017-05-18T08:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195025",
    "user": "embray"
}
```

You're right, this is fine.



---

archive/issue_comments_195026.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-20T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-195026",
    "user": "vbraun"
}
```

Resolution: fixed
