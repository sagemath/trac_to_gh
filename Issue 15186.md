# Issue 15186: Add auto-rebasing mechanism for Cygwin

archive/issues_015186.json:
```json
{
    "body": "CC:  @kcrisman @dimpase @jdemeyer jpflori @tscrim\n\nWith Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.\nThis could be automated in the following way\n* try to build\n* if that fails and we're on Cygwin,\n* grep the failing logs for error messages cuased by fork issues\n* if all erros are caused by fork issues:\n  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),\n  * go back to step one\n* if not fails as usual\n\nHaving this would open the way to a buildbot or a patchbot for Cygwin.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15423\n\n",
    "created_at": "2013-11-15T14:47:12Z",
    "labels": [
        "component: porting: cygwin"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Add auto-rebasing mechanism for Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15186",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
CC:  @kcrisman @dimpase @jdemeyer jpflori @tscrim

With Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.
This could be automated in the following way
* try to build
* if that fails and we're on Cygwin,
* grep the failing logs for error messages cuased by fork issues
* if all erros are caused by fork issues:
  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),
  * go back to step one
* if not fails as usual

Having this would open the way to a buildbot or a patchbot for Cygwin.

Issue created by migration from https://trac.sagemath.org/ticket/15423





---

archive/issue_events_044903.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44903"
}
```



---

archive/issue_events_044904.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44904"
}
```



---

archive/issue_events_044905.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44905"
}
```



---

archive/issue_events_044906.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44906"
}
```



---

archive/issue_events_044907.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44907"
}
```



---

archive/issue_events_044908.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-13T10:25:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44908"
}
```



---

archive/issue_events_044909.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-13T10:25:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44909"
}
```



---

archive/issue_comments_194742.json:
```json
{
    "body": "I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.\n\nI would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194742",
    "user": "https://github.com/embray"
}
```

I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.

I would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.



---

archive/issue_comments_194743.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194743",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_194744.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2017-04-21T12:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194744",
    "user": "https://github.com/embray"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_194745.json:
```json
{
    "body": "New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.\n----\nNew commits:",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194745",
    "user": "https://github.com/embray"
}
```

New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.
----
New commits:



---

archive/issue_comments_194746.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194746",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_194747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-05T14:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_194748.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194748",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_194749.json:
```json
{
    "body": "Looks like that last commit has a merge conflict.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194749",
    "user": "https://github.com/embray"
}
```

Looks like that last commit has a merge conflict.



---

archive/issue_comments_194750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-05T14:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194750",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_194751.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-05T14:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194751",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_194752.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194752",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_194753.json:
```json
{
    "body": "LGTM",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194753",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

LGTM



---

archive/issue_comments_194754.json:
```json
{
    "body": "In `src/Makefile.in`, is this really needed for the rebase script to work?\n\n```\n    (cd $(srcdir)                                       \\\n     && export SAGE_ROOT=/doesnotexist                          \\\n           SAGE_SRC=/doesnotexist                           \\\n           SAGE_SRC_ROOT=/doesnotexist                          \\\n           SAGE_DOC_SRC=/doesnotexist                           \\\n           SAGE_BUILD_DIR=/doesnotexist                         \\\n           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \\\n           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \\\n```\n\n\nIf not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.\n\nMinor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194754",
    "user": "https://github.com/jdemeyer"
}
```

In `src/Makefile.in`, is this really needed for the rebase script to work?

```
    (cd $(srcdir)                                       \
     && export SAGE_ROOT=/doesnotexist                          \
           SAGE_SRC=/doesnotexist                           \
           SAGE_SRC_ROOT=/doesnotexist                          \
           SAGE_DOC_SRC=/doesnotexist                           \
           SAGE_BUILD_DIR=/doesnotexist                         \
           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \
           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \
```


If not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.

Minor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.



---

archive/issue_comments_194755.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194755",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_194756.json:
```json
{
    "body": "Nah the rebase script does only care about SAGE_LOCAL.",
    "created_at": "2017-05-17T12:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194756",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Nah the rebase script does only care about SAGE_LOCAL.



---

archive/issue_comments_194757.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194757",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_194758.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194758",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_194759.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194759",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_194760.json:
```json
{
    "body": "Ok, let's go with jeroen solution.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194760",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, let's go with jeroen solution.



---

archive/issue_comments_194761.json:
```json
{
    "body": "You're right, this is fine.",
    "created_at": "2017-05-18T08:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194761",
    "user": "https://github.com/embray"
}
```

You're right, this is fine.



---

archive/issue_events_044910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-20T20:07:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15186#event-44910"
}
```



---

archive/issue_comments_194762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-20T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15186#issuecomment-194762",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
