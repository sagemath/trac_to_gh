# Issue 28427: FPyLLL Strategies inside SageMath binaries

archive/issues_028427.json:
```json
{
    "body": "CC:  isuruf malb slelievre vbraun dimpase\n\nDoing:\n\n\n```\ncurl -O https://www.mirrorservice.org/sites/www.sagemath.org/linux/64bit/sage-8.8-Debian_GNU_Linux_8-x86_64.tar.bz2\nunp sage-8.8-Debian_GNU_Linux_8-x86_64.tar.bz2\n./SageMath/sage   \n```\n\n\nThen I get\n\n\n```python\nsage:  from fpylll import *\nsage: BKZ.DEFAULT_STRATEGY\n'/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nullpoints/default.json'\n```\n\n\nThe output should be a filename but it's not. A build from source doesn't have that problem.\n\nSee https://github.com/fplll/fpylll/issues/147\n\nIssue created by migration from https://trac.sagemath.org/ticket/28664\n\n",
    "created_at": "2019-10-28T11:55:01Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "FPyLLL Strategies inside SageMath binaries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28427",
    "user": "malb"
}
```
CC:  isuruf malb slelievre vbraun dimpase

Doing:


```
curl -O https://www.mirrorservice.org/sites/www.sagemath.org/linux/64bit/sage-8.8-Debian_GNU_Linux_8-x86_64.tar.bz2
unp sage-8.8-Debian_GNU_Linux_8-x86_64.tar.bz2
./SageMath/sage   
```


Then I get


```python
sage:  from fpylll import *
sage: BKZ.DEFAULT_STRATEGY
'/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nullpoints/default.json'
```


The output should be a filename but it's not. A build from source doesn't have that problem.

See https://github.com/fplll/fpylll/issues/147

Issue created by migration from https://trac.sagemath.org/ticket/28664





---

archive/issue_comments_401593.json:
```json
{
    "body": "Seems a precompiled Sage binary also cannot load strategy files stored elsewhere, so something is really broken there:\n\n\n```python\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.9, Release Date: 2019-09-29                     \u2502\n\u2502 Using Python 2.7.15. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: from fpylll import *\nsage: BKZ.DEFAULT_STRATEGY_PATH\n'/bulk/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nulls'\nsage: BKZ.DEFAULT_STRATEGY\n'/bulk/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nulls/default.json'\nsage: print load_strategies_json(\"/home/malb/projects/lattices/fplll/strategies/default.json\")[60]\nStrategy< 60, (), 1.00-1.00>\n```\n\n\nThe above should print `Strategy< 60, (40), 0.29-0.50>`\n\nSee https://github.com/fplll/fpylll/issues/159\n\nAny ideas?",
    "created_at": "2019-11-14T16:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401593",
    "user": "malb"
}
```

Seems a precompiled Sage binary also cannot load strategy files stored elsewhere, so something is really broken there:


```python
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.9, Release Date: 2019-09-29                     │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: from fpylll import *
sage: BKZ.DEFAULT_STRATEGY_PATH
'/bulk/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nulls'
sage: BKZ.DEFAULT_STRATEGY
'/bulk/home/malb/software/SageMath/local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nulls/default.json'
sage: print load_strategies_json("/home/malb/projects/lattices/fplll/strategies/default.json")[60]
Strategy< 60, (), 1.00-1.00>
```


The above should print `Strategy< 60, (40), 0.29-0.50>`

See https://github.com/fplll/fpylll/issues/159

Any ideas?



---

archive/issue_comments_401594.json:
```json
{
    "body": "This looks like a bug in binary-pkg which looks for `\\0` character at the end of the path, but the path being stored in a C++ string, the NULL character does not exist at the end.",
    "created_at": "2019-11-21T17:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401594",
    "user": "isuruf"
}
```

This looks like a bug in binary-pkg which looks for `\0` character at the end of the path, but the path being stored in a C++ string, the NULL character does not exist at the end.



---

archive/issue_comments_401595.json:
```json
{
    "body": "Adding -std=c++11 to CXXFLAGS forces the C++ compiler to enforce C++11 which enforces that std::string terminate with `\\0` in the internal buffer.\n\nFrom my limited testing, this fixes the issue.",
    "created_at": "2019-11-21T18:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401595",
    "user": "isuruf"
}
```

Adding -std=c++11 to CXXFLAGS forces the C++ compiler to enforce C++11 which enforces that std::string terminate with `\0` in the internal buffer.

From my limited testing, this fixes the issue.



---

archive/issue_comments_401596.json:
```json
{
    "body": "Oh, thanks!\n\nI'm not clear though on where `-std=c++11` is missing, FPLLL is currently being compiled with:\n\n```\nAX_CXX_COMPILE_STDCXX([11],[noext],[mandatory])\n```\n\n\nwhich should set `-std=c++11`. But from my local testing it doesn't seem to (?)",
    "created_at": "2019-11-23T10:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401596",
    "user": "malb"
}
```

Oh, thanks!

I'm not clear though on where `-std=c++11` is missing, FPLLL is currently being compiled with:

```
AX_CXX_COMPILE_STDCXX([11],[noext],[mandatory])
```


which should set `-std=c++11`. But from my local testing it doesn't seem to (?)



---

archive/issue_comments_401597.json:
```json
{
    "body": "File `m4/ax_cxx_compile_stdcxx.m4` in fplll repo is old. Updating to the latest version fixes the issue.",
    "created_at": "2019-11-23T19:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401597",
    "user": "isuruf"
}
```

File `m4/ax_cxx_compile_stdcxx.m4` in fplll repo is old. Updating to the latest version fixes the issue.



---

archive/issue_comments_401598.json:
```json
{
    "body": "`@`malb, the updated macro at https://github.com/fplll/fplll/pull/394/files forces the `-std=c++11`. New versions of gcc support some C++11 features without the flag, but does not enforce some C++11 features like `\\0` at the end of the string buffer. This default checking is removed in https://github.com/fplll/fplll/pull/394/files#diff-38b7f4802a0916ba0fab7e320746bfdbL62-L69",
    "created_at": "2019-11-23T20:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401598",
    "user": "isuruf"
}
```

`@`malb, the updated macro at https://github.com/fplll/fplll/pull/394/files forces the `-std=c++11`. New versions of gcc support some C++11 features without the flag, but does not enforce some C++11 features like `\0` at the end of the string buffer. This default checking is removed in https://github.com/fplll/fplll/pull/394/files#diff-38b7f4802a0916ba0fab7e320746bfdbL62-L69



---

archive/issue_comments_401599.json:
```json
{
    "body": "Thank you! I'll wait for the fallout of the 5.3.0 release for a bit and then will cut a new release 5.3.1 with that fix in.",
    "created_at": "2019-11-24T10:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401599",
    "user": "malb"
}
```

Thank you! I'll wait for the fallout of the 5.3.0 release for a bit and then will cut a new release 5.3.1 with that fix in.



---

archive/issue_comments_401600.json:
```json
{
    "body": "Fixed in FPLLL 5.3.1",
    "created_at": "2019-12-14T18:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401600",
    "user": "malb"
}
```

Fixed in FPLLL 5.3.1



---

archive/issue_comments_401601.json:
```json
{
    "body": "See #28886 for updates of FP(y)LLL which should fix this issue.",
    "created_at": "2019-12-15T14:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401601",
    "user": "malb"
}
```

See #28886 for updates of FP(y)LLL which should fix this issue.



---

archive/issue_comments_401602.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401602",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_401603.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401603",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_401604.json:
```json
{
    "body": "- #28886, merged in Sage 9.1.beta1, upgraded to FPLLL 5.3.2 and FPyLLL 0.5.1.dev.\n- #30021, merged in Sage 9.2.beta4, upgraded to FPLLL 5.3.3.\n\nOn Debian 10 buster, after downloading Sage 9.1 as follows:\n\n```\n$ SAGE_VERSION=9.1\n$ DEBIAN_VERSION=`source /etc/os-release ; echo $VERSION_ID`\n$ MIRROR=https://www.mirrorservice.org/sites/www.sagemath.org/linux/64bit\n$ TARBALL=sage-$SAGE_VERSION-Debian_GNU_Linux_$DEBIAN_VERSION-x86_64.tar.bz2\n$ curl -O $MIRROR/$TARBALL\n$ tar xf $TARBALL\n```\n\nand launching Sage as follows:\n\n```\n$ ./SageMath/sage -q\n```\n\nrunning the following two commands:\n\n```\nsage: from fpylll import *\nsage: BKZ.DEFAULT_STRATEGY\n```\n\nstill gives the same incorrect result:\n\n```\n'/.../local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nullpointer.'\n```\n\n\nwhile with Sage built from source on the same machine:\n\n```\nsage: from fpylll import *\nsage: BKZ.DEFAULT_STRATEGY\nb'/.../local/share/fplll/strategies/default.json'\n```\n\n\nSo even after #28886 Sage built from source gets this right\nwhile Sage binaries don't.",
    "created_at": "2020-09-16T00:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401604",
    "user": "slelievre"
}
```

- #28886, merged in Sage 9.1.beta1, upgraded to FPLLL 5.3.2 and FPyLLL 0.5.1.dev.
- #30021, merged in Sage 9.2.beta4, upgraded to FPLLL 5.3.3.

On Debian 10 buster, after downloading Sage 9.1 as follows:

```
$ SAGE_VERSION=9.1
$ DEBIAN_VERSION=`source /etc/os-release ; echo $VERSION_ID`
$ MIRROR=https://www.mirrorservice.org/sites/www.sagemath.org/linux/64bit
$ TARBALL=sage-$SAGE_VERSION-Debian_GNU_Linux_$DEBIAN_VERSION-x86_64.tar.bz2
$ curl -O $MIRROR/$TARBALL
$ tar xf $TARBALL
```

and launching Sage as follows:

```
$ ./SageMath/sage -q
```

running the following two commands:

```
sage: from fpylll import *
sage: BKZ.DEFAULT_STRATEGY
```

still gives the same incorrect result:

```
'/.../local/share/fplll/strategieparse error - unpreprocessing_blpruning_parameteError: gptr == nullpointer.'
```


while with Sage built from source on the same machine:

```
sage: from fpylll import *
sage: BKZ.DEFAULT_STRATEGY
b'/.../local/share/fplll/strategies/default.json'
```


So even after #28886 Sage built from source gets this right
while Sage binaries don't.



---

archive/issue_comments_401605.json:
```json
{
    "body": "What causes this difference between the buildbot-produced binaries\nand Sage built from source?",
    "created_at": "2020-09-16T00:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401605",
    "user": "slelievre"
}
```

What causes this difference between the buildbot-produced binaries
and Sage built from source?



---

archive/issue_comments_401606.json:
```json
{
    "body": "Is fplll built with C++11 in the Sage 9.1 binaries?",
    "created_at": "2020-09-16T01:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401606",
    "user": "isuruf"
}
```

Is fplll built with C++11 in the Sage 9.1 binaries?



---

archive/issue_comments_401607.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401607",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_401608.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-09T18:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401608",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401609.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-09T18:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401609",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401610.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2022-02-12T18:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28427",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28427#issuecomment-401610",
    "user": "mkoeppe"
}
```

Resolution: invalid
