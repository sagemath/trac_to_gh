# Issue 23867: Merge the code of ex.solve(...) and solve(...)

Issue created by migration from https://trac.sagemath.org/ticket/24104

Original creator: rws

Original creation time: 2017-10-25 13:31:41

CC:  mforets

Both `Expression.solve(...)` and global `solve(...)` use Maxima for solving (in)equalities but use their own code which agrees in part, and provide some of the same options.  The first allows univariate forms/relations, the second additionally systems, and several variables. Further differences are e.g. that only `ex.solve` uses the pexpect interface, and only `solve` makes several attempts.

In order to give users the full capabilities, regardless how called, and to ease maintenance and addition of improvements, this ticket should move the `ex.solve` code into `solve`, leaving only an interface to it. It will througout use maxima-lib. No doctest should be in need of change, except for improved output.


---

Comment by rws created at 2017-10-25 13:39:46

Changing type from task to enhancement.


---

Comment by rws created at 2017-10-26 08:23:12

Changing status from new to needs_review.


---

Comment by rws created at 2017-10-26 08:23:12

This already passes all tests in symbolic, calculus, tests, and doc. I think the solvers have a good home in `relation.py`. In a next ticket the doctests should be moved.
----
New commits:


---

Comment by tscrim created at 2017-10-28 01:18:15

We can be a bit more concise, which IMO is more readable:

```diff
-        for i in x:
-            if not isinstance(i, Expression):
-                raise TypeError("%s is not a valid variable." % repr(i))
+        if not all(isinstance(i, Expression) for i in x):
+            raise TypeError("%s is not a valid variable" % repr(i))
```


I feel like the handling of `f` being a single expression should be a separate function that is called by `solve` but still in the same file. It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.

I am tempted to keep it as a method of `Expression`, but I agree overall with the purpose of the ticket to have a uniform interface and behavior. This change also gives better code grouping. However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above. Your thoughts and counters?


---

Comment by rws created at 2017-10-28 06:17:54

Replying to [comment:6 tscrim]:
> We can be a bit more concise, which IMO is more readable:
> {{{#!diff
> -        for i in x:
> -            if not isinstance(i, Expression):
> -                raise TypeError("%s is not a valid variable." % repr(i))
> +        if not all(isinstance(i, Expression) for i in x):
> +            raise TypeError("%s is not a valid variable" % repr(i))
> }}}

This will not work because `i` is local to `all`. Actually, I changed that snippet specifically because all of `x` was given in the error, but I wanted to print only the part failing.


---

Comment by rws created at 2017-10-28 06:23:17

Replying to [comment:6 tscrim]:
> I am tempted to keep it as a method of `Expression`

I really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).


---

Comment by rws created at 2017-10-28 06:33:47

Replying to [comment:6 tscrim]:
> However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.

The problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.


---

Comment by rws created at 2017-10-28 06:52:46

However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.


---

Comment by tscrim created at 2017-10-28 08:07:11

Replying to [comment:8 rws]:
> Replying to [comment:6 tscrim]:
> > I am tempted to keep it as a method of `Expression`
> 
> I really would like to have short code snippets in `expression.py` with long functions and documentation elsewhere. You can't put all of symbolics in one file but Python forces us (because classes can't be split).

That's not true. Look at the graph code for a "real world" example, but basically, it does this:

```python
sage: def bar(self, x):  # Say this was in a separate file
....:     return self._y + x
sage: class Foo(object):
....:     _y = 10
....:     bar = bar
sage: F = Foo()
sage: F.bar(5)
15
```



---

Comment by tscrim created at 2017-10-28 08:08:15

Replying to [comment:9 rws]:
> Replying to [comment:6 tscrim]:
> > However, with the current branch, I don't feel like the two functions have been merged as they feel somewhat separate as per my comments above.
> 
> The problem is then that code has to be duplicated, e.g. the variable check above. I'm not averse to the idea in principle, separating out would need looking at the doctests which I didn't want to in this ticket. I propose to try it later when moving the doctests from `expression.py`.

I didn't feel like that would be hard to split out as a separate little helper function to avoid the duplication. Although at the same time it didn't seem like there would be too much in the way of code duplication, but maybe I am not looking closely enough.


---

Comment by tscrim created at 2017-10-28 08:08:37

Replying to [comment:10 rws]:
> However if you don't mind additionally reviewing extended changes to documentation I can put it in this ticket.

I don't mind if it makes things easier to do for you.


---

Comment by rws created at 2017-10-28 08:38:45

Replying to [comment:11 tscrim]:
> That's not true. Look at the graph code for a "real world" example, but basically, it does this:

(dynamically adding methods)

That's true! And I did it a few weeks ago in `interfaces/sympy` <slap head/>


---

Comment by git created at 2017-10-29 16:15:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-29 16:16:03

Replying to [comment:6 tscrim]:
> It always returns something and is effectively called later in `solve` in special cases. IMO, this makes it easier to understand and maintain with independent doctests.

Calling itself is not necessary and it's easy to rewrite without this call. While I agree with having structure in the doctests, they serve as highly visible example when a user inputs `solve?`. Separating them makes them partly inaccessible.

Please review.


---

Comment by tscrim created at 2017-10-29 22:49:23

Thanks. Although I think it would be better for the `is_Expression(f)` case to be a separate function within `relation.py`, say

```python
def _solve_expression(f, x, explicit_solutions, multiplicities, to_poly_solve, solution_dict):
   """
   Solve an expression ``f``. For more information, see :func:`solve`.

   TESTS:

   Only tests that check :trac:`ABCDE` is fixed::
   """
   # Code here
```

This gives better localization of (relevant) tests, does not introduce any doc issues (it is mainly an implementation detail), and can be called with your already parsed input. If you do not agree, then what you currently have is acceptable. Yet, it is quite a big function, and I feel it is more maintainable in smaller bites. I can also do that refactoring too if you'd want.


---

Comment by rws created at 2017-10-30 04:35:22

Please do. I'm a bit entamgled today.


---

Comment by tscrim created at 2017-10-30 08:59:52

Here you go.
----
New commits:


---

Comment by rws created at 2017-10-31 14:10:20

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-10-31 14:10:20

Thanks. LGTM. I added you as author.


---

Comment by vbraun created at 2017-11-02 11:05:57

Resolution: fixed
