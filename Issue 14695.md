# Issue 14695: Anticanonical hypersurfaces cannot handle finite fields

Issue created by migration from https://trac.sagemath.org/ticket/14899

Original creator: novoselt

Original creation time: 2013-07-16 16:58:49

Assignee: AlexGhitza

CC:  vbraun

Keywords: toric

As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion

The problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)


---

Comment by novoselt created at 2013-07-16 17:05:11

I've also added checks that the number of coefficients is correct - it is easy to mess up...


---

Comment by novoselt created at 2013-07-16 17:05:11

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-07-16 17:55:29

I still don't understand why there is the hack with the symbolic ring at all. Can you give an example of an input where it is necessary?


---

Comment by novoselt created at 2013-07-16 18:20:01


```
sage: R = PolynomialRing(QQ, 3, "x").fraction_field()
sage: print R(SR("x0/x1"))
x0/x1
sage: print R("x0/x1")
Traceback (most recent call last):
...
TypeError: no canonical coercion from Fraction Field of Multivariate Polynomial Ring in x0, x1, x2 over Rational Field to Rational Field
```

When entering symbolic coefficients, I find it quite convenient to enter them as `coefficients=["a/b", "c^2", ...]` and it does not work unless we pass through SR. Ideally, having or not having SR conversion should make no difference (apart from speed), but apparently with strings things don't work without SR and with finite fields they don't work with SR.


---

Comment by vbraun created at 2013-07-16 18:37:28

I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.


---

Attachment

Initial patch


---

Comment by vbraun created at 2013-07-16 19:09:23

I've added a patch to allow conversion of strings into fraction fields, this ought to work similar to polynomial rings.


---

Comment by novoselt created at 2013-07-16 20:12:27

Replying to [comment:4 vbraun]:
> I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.

That's a valid point about special constants, but in general it is quite similar to specifying names of generators and constructing base rings manually is a bit annoying especially when you don't want iterated fractions fields. In any case you let it though and prohibiting it now is breaking backward compatibility ;-) It is also on purpose that explicit symbolic coefficients (i.e. elements of SR, not strings) are converted to names in a polynomial ring: polynomials are way faster and more convenient to work with. In general, it would be nice to have Macaulay2 feature of "generic elements of a given ring"...


---

Comment by novoselt created at 2013-07-16 20:21:19

Positive review to Volker's patch, no need in SR with it.


---

Comment by vbraun created at 2013-07-16 20:42:43

But if you really want symbolic coefficients then it should be possible to do so:

```
sage: toric_varieties.P1().anticanonical_hypersurface(coefficients=[sin(x), 1, 1])
[...]
TypeError: unable to convert sin(x) to a rational
```

I don't really mind converting coefficients given as strings to polynomials / fraction field elements but at the end you should find the `common_parent()` and use that.


---

Comment by novoselt created at 2013-07-18 22:07:25

Good point, and it does bug me that "e" given as a string will not be just a variable of the base ring with this name. I think that both convenient and sensible solution it to treat anything in passed strings as a variable name (including e/i/cos) and find a common parent for all other coefficients. Will do this unless there are objections.


---

Comment by novoselt created at 2013-07-18 23:26:02

Make use of Volker's patch


---

Attachment

Done, needs review!


---

Comment by vbraun created at 2013-07-19 03:42:39

Thanks, looks great!


---

Comment by vbraun created at 2013-07-19 03:42:39

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-16 21:14:59

Resolution: fixed
