# Issue 14695: Anticanonical hypersurfaces cannot handle finite fields

archive/issues_014695.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @vbraun\n\nKeywords: toric\n\nAs originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion\n\nThe problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)\n\nIssue created by migration from https://trac.sagemath.org/ticket/14899\n\n",
    "created_at": "2013-07-16T16:58:49Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Anticanonical hypersurfaces cannot handle finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14695",
    "user": "https://github.com/novoselt"
}
```
Assignee: @aghitza

CC:  @vbraun

Keywords: toric

As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion

The problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)

Issue created by migration from https://trac.sagemath.org/ticket/14899





---

archive/issue_comments_186972.json:
```json
{
    "body": "I've also added checks that the number of coefficients is correct - it is easy to mess up...",
    "created_at": "2013-07-16T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186972",
    "user": "https://github.com/novoselt"
}
```

I've also added checks that the number of coefficients is correct - it is easy to mess up...



---

archive/issue_comments_186973.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-07-16T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186973",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_186974.json:
```json
{
    "body": "I still don't understand why there is the hack with the symbolic ring at all. Can you give an example of an input where it is necessary?",
    "created_at": "2013-07-16T17:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186974",
    "user": "https://github.com/vbraun"
}
```

I still don't understand why there is the hack with the symbolic ring at all. Can you give an example of an input where it is necessary?



---

archive/issue_comments_186975.json:
```json
{
    "body": "\n```\nsage: R = PolynomialRing(QQ, 3, \"x\").fraction_field()\nsage: print R(SR(\"x0/x1\"))\nx0/x1\nsage: print R(\"x0/x1\")\nTraceback (most recent call last):\n...\nTypeError: no canonical coercion from Fraction Field of Multivariate Polynomial Ring in x0, x1, x2 over Rational Field to Rational Field\n```\n\nWhen entering symbolic coefficients, I find it quite convenient to enter them as `coefficients=[\"a/b\", \"c^2\", ...]` and it does not work unless we pass through SR. Ideally, having or not having SR conversion should make no difference (apart from speed), but apparently with strings things don't work without SR and with finite fields they don't work with SR.",
    "created_at": "2013-07-16T18:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186975",
    "user": "https://github.com/novoselt"
}
```


```
sage: R = PolynomialRing(QQ, 3, "x").fraction_field()
sage: print R(SR("x0/x1"))
x0/x1
sage: print R("x0/x1")
Traceback (most recent call last):
...
TypeError: no canonical coercion from Fraction Field of Multivariate Polynomial Ring in x0, x1, x2 over Rational Field to Rational Field
```

When entering symbolic coefficients, I find it quite convenient to enter them as `coefficients=["a/b", "c^2", ...]` and it does not work unless we pass through SR. Ideally, having or not having SR conversion should make no difference (apart from speed), but apparently with strings things don't work without SR and with finite fields they don't work with SR.



---

archive/issue_comments_186976.json:
```json
{
    "body": "I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `\"e\"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.",
    "created_at": "2013-07-16T18:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186976",
    "user": "https://github.com/vbraun"
}
```

I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.



---

archive/issue_comments_186977.json:
```json
{
    "body": "Attachment [trac_14899_fraction_field_string.patch](tarball://root/attachments/some-uuid/ticket14899/trac_14899_fraction_field_string.patch) by @vbraun created at 2013-07-16 19:06:38\n\nInitial patch",
    "created_at": "2013-07-16T19:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186977",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14899_fraction_field_string.patch](tarball://root/attachments/some-uuid/ticket14899/trac_14899_fraction_field_string.patch) by @vbraun created at 2013-07-16 19:06:38

Initial patch



---

archive/issue_comments_186978.json:
```json
{
    "body": "I've added a patch to allow conversion of strings into fraction fields, this ought to work similar to polynomial rings.",
    "created_at": "2013-07-16T19:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186978",
    "user": "https://github.com/vbraun"
}
```

I've added a patch to allow conversion of strings into fraction fields, this ought to work similar to polynomial rings.



---

archive/issue_comments_186979.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `\"e\"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.\n\nThat's a valid point about special constants, but in general it is quite similar to specifying names of generators and constructing base rings manually is a bit annoying especially when you don't want iterated fractions fields. In any case you let it though and prohibiting it now is breaking backward compatibility ;-) It is also on purpose that explicit symbolic coefficients (i.e. elements of SR, not strings) are converted to names in a polynomial ring: polynomials are way faster and more convenient to work with. In general, it would be nice to have Macaulay2 feature of \"generic elements of a given ring\"...",
    "created_at": "2013-07-16T20:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186979",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:4 vbraun]:
> I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.

That's a valid point about special constants, but in general it is quite similar to specifying names of generators and constructing base rings manually is a bit annoying especially when you don't want iterated fractions fields. In any case you let it though and prohibiting it now is breaking backward compatibility ;-) It is also on purpose that explicit symbolic coefficients (i.e. elements of SR, not strings) are converted to names in a polynomial ring: polynomials are way faster and more convenient to work with. In general, it would be nice to have Macaulay2 feature of "generic elements of a given ring"...



---

archive/issue_comments_186980.json:
```json
{
    "body": "Positive review to Volker's patch, no need in SR with it.",
    "created_at": "2013-07-16T20:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186980",
    "user": "https://github.com/novoselt"
}
```

Positive review to Volker's patch, no need in SR with it.



---

archive/issue_comments_186981.json:
```json
{
    "body": "But if you really want symbolic coefficients then it should be possible to do so:\n\n```\nsage: toric_varieties.P1().anticanonical_hypersurface(coefficients=[sin(x), 1, 1])\n[...]\nTypeError: unable to convert sin(x) to a rational\n```\n\nI don't really mind converting coefficients given as strings to polynomials / fraction field elements but at the end you should find the `common_parent()` and use that.",
    "created_at": "2013-07-16T20:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186981",
    "user": "https://github.com/vbraun"
}
```

But if you really want symbolic coefficients then it should be possible to do so:

```
sage: toric_varieties.P1().anticanonical_hypersurface(coefficients=[sin(x), 1, 1])
[...]
TypeError: unable to convert sin(x) to a rational
```

I don't really mind converting coefficients given as strings to polynomials / fraction field elements but at the end you should find the `common_parent()` and use that.



---

archive/issue_comments_186982.json:
```json
{
    "body": "Good point, and it does bug me that \"e\" given as a string will not be just a variable of the base ring with this name. I think that both convenient and sensible solution it to treat anything in passed strings as a variable name (including e/i/cos) and find a common parent for all other coefficients. Will do this unless there are objections.",
    "created_at": "2013-07-18T22:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186982",
    "user": "https://github.com/novoselt"
}
```

Good point, and it does bug me that "e" given as a string will not be just a variable of the base ring with this name. I think that both convenient and sensible solution it to treat anything in passed strings as a variable name (including e/i/cos) and find a common parent for all other coefficients. Will do this unless there are objections.



---

archive/issue_comments_186983.json:
```json
{
    "body": "Make use of Volker's patch",
    "created_at": "2013-07-18T23:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186983",
    "user": "https://github.com/novoselt"
}
```

Make use of Volker's patch



---

archive/issue_comments_186984.json:
```json
{
    "body": "Attachment [trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch](tarball://root/attachments/some-uuid/ticket14899/trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch) by @novoselt created at 2013-07-18 23:27:59\n\nDone, needs review!",
    "created_at": "2013-07-18T23:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186984",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch](tarball://root/attachments/some-uuid/ticket14899/trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch) by @novoselt created at 2013-07-18 23:27:59

Done, needs review!



---

archive/issue_comments_186985.json:
```json
{
    "body": "Thanks, looks great!",
    "created_at": "2013-07-19T03:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186985",
    "user": "https://github.com/vbraun"
}
```

Thanks, looks great!



---

archive/issue_comments_186986.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-19T03:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186986",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186987.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-16T21:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14695#issuecomment-186987",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_014433.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:14:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14695",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14695#event-14433"
}
```
