# Issue 30699: Make arb config more flexible and find also flint-arb

Issue created by migration from https://trac.sagemath.org/ticket/30936

Original creator: @tobiasdiez

Original creation time: 2020-11-18 10:32:05

CC:  mkoeppe

If one has flint-arb installed but not arb as a system package, then compilation currently fails unless one explicitly sets `ARB_LIBRARY = flint-arb`. In this ticket, we also check for the existence of flint-arb making this manual step obsolete. This is similar in spirit to #30706, which does the same for CBLAS.

The config file `build/pgks/arb/spkg-configure.m4` does a similar check (I think) and maybe can/needs to be adapted as well. If that's the case I would like to ask if somebody else can implement the necessary changes, as I've no experience with these config files. Thanks!


---

Comment by @tobiasdiez created at 2020-11-18 10:32:30

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-12-18 22:01:13

Merged the latest develop branch and version of #30901.


---

Comment by git created at 2020-12-18 22:01:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-21 03:12:29

Debian renames `libarb` to `libflint-arb` because there is already a different library taking the name `libarb`.  So code that only checks the presence of `libarb` or `libflint-arb` (in whatever order) cannot be correct.


---

Comment by mkoeppe created at 2020-12-21 03:12:29

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-12-21 08:38:05

The code only provides a reasonable fall-back if `SAGE_ARB_LIBRARY` doesn't exist. Thus users on debian just have to set `SAGE_ARB_LIBRARY = "flint-arb"` and everything works as before.  
Do I miss something?

(The purpose of this ticket was not to reimplement the checks in arb/spkg-configure in the setup.py file.)


---

Comment by mkoeppe created at 2020-12-21 17:43:54

The ticket tries to support a use case that is not currently supported (installation of `sagelib` without running `./configure`). Instead of putting more complicated defaults into `env.py`, it would be better to develop a proper solution in `sage.features`.


---

Comment by @tobiasdiez created at 2020-12-22 09:00:00

Want I want to support is installation of sagelib without the sage_conf package since I don't know how to install the latter with pipenv (I could install it by specifying the relative path in the pipfile, but that really ugly). It would be more practical if sage_conf would be a config file in src instead of a python package, but we discussed this already elsewhere...

So in this ticket I provided a reasonable fallback, similar to what is done for singular and gap. How would this be implemented with sage.features?


---

Comment by mkoeppe created at 2020-12-22 14:35:55

Replying to [comment:7 gh-tobiasdiez]:
> Want I want to support is installation of sagelib without the sage_conf package since I don't know how to install the latter with pipenv (I could install it by specifying the relative path in the pipfile, but that really ugly).

The Sage distribution builds a wheel of it, you would just install from there.


---

Comment by mkoeppe created at 2020-12-22 15:20:12

Replying to [comment:7 gh-tobiasdiez]:
> How would this be implemented with sage.features?

You would write a class similar to `CythonFeature` (from `src/sage/features/__init__.py`) with a method revealing the library name.  The class would use the information from `sage.env.ARB_LIBRARY` (get rid of the default); but if unset, it would try to link a test program using `acb_mat_eig_simple` against the library. In fact, using `CythonFeature` for doing this test could pretty much work -- except that I'm not sure if `sage.misc.cython` perhaps pulls in too many modules at the moment.


---

Comment by @tobiasdiez created at 2020-12-23 13:07:55

That sounds reasonable. But it's also more work than I planned to invest into this, so I'll leave this to somebody else to implement.
