# Issue 18504: Random failure in sagespawn.pyx

archive/issues_018504.json:
```json
{
    "body": "CC:  @jdemeyer\n\nThere is at least one race left, see comments for detailss\n\nIssue created by migration from https://trac.sagemath.org/ticket/18741\n\n",
    "created_at": "2015-06-19T22:21:37Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Random failure in sagespawn.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18504",
    "user": "https://github.com/vbraun"
}
```
CC:  @jdemeyer

There is at least one race left, see comments for detailss

Issue created by migration from https://trac.sagemath.org/ticket/18741





---

archive/issue_comments_251239.json:
```json
{
    "body": "Changing keywords from \"\" to \"random_fail\".",
    "created_at": "2015-06-19T22:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251239",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "random_fail".



---

archive/issue_comments_251240.json:
```json
{
    "body": "On Arando (already reported at #17686):\n\n```\nsage -t --long src/sage/interfaces/sagespawn.pyx\n**********************************************************************\nFile \"src/sage/interfaces/sagespawn.pyx\", line 125, in sage.interfaces.sagespawn.SageSpawn.close\nFailed example:\n    while s.isalive():  # long time (5 seconds)\n        sleep(0.1)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.sagespawn.SageSpawn.close[3]>\", line 1, in <module>\n        while s.isalive():  # long time (5 seconds)\n      File \"/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect.py\", line 762, in isalive\n        pid, status = os.waitpid(self.pid, waitpid_options)\n      File \"sage/ext/interrupt/interrupt.pyx\", line 197, in sage.ext.interrupt.interrupt.sage_python_check_interrupt (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:1743)\n        sig_check()\n      File \"sage/ext/interrupt/interrupt.pyx\", line 86, in sage.ext.interrupt.interrupt.sig_raise_exception (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:884)\n        raise KeyboardInterrupt\n    KeyboardInterrupt\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.interfaces.sagespawn.SageSpawn.close\n    [24 tests, 1 failure, 5.08 s]\n```",
    "created_at": "2015-06-19T22:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251240",
    "user": "https://github.com/vbraun"
}
```

On Arando (already reported at #17686):

```
sage -t --long src/sage/interfaces/sagespawn.pyx
**********************************************************************
File "src/sage/interfaces/sagespawn.pyx", line 125, in sage.interfaces.sagespawn.SageSpawn.close
Failed example:
    while s.isalive():  # long time (5 seconds)
        sleep(0.1)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.sagespawn.SageSpawn.close[3]>", line 1, in <module>
        while s.isalive():  # long time (5 seconds)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect.py", line 762, in isalive
        pid, status = os.waitpid(self.pid, waitpid_options)
      File "sage/ext/interrupt/interrupt.pyx", line 197, in sage.ext.interrupt.interrupt.sage_python_check_interrupt (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:1743)
        sig_check()
      File "sage/ext/interrupt/interrupt.pyx", line 86, in sage.ext.interrupt.interrupt.sig_raise_exception (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:884)
        raise KeyboardInterrupt
    KeyboardInterrupt
**********************************************************************
1 item had failures:
   1 of   5 in sage.interfaces.sagespawn.SageSpawn.close
    [24 tests, 1 failure, 5.08 s]
```



---

archive/issue_comments_251241.json:
```json
{
    "body": "On OSX:\n\n```\nsage -t --long src/sage/interfaces/sagespawn.pyx\n    Bad exit: 1\n**********************************************************************\nTests run before process (pid=73714) failed:\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 45 ##\nsage: SageSpawn(\"sleep 1\", name=\"Sleeping Beauty\") ## line 46 ##\nSleeping Beauty with PID 73715 running /bin/sleep 1\nsage: sig_on_count() ## line 48 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 67 ##\nsage: s = SageSpawn(\"true\", name=\"stupid process\") ## line 68 ##\nsage: s  # indirect doctest ## line 69 ##\nstupid process with PID 73717 running /usr/bin/true\nsage: while s.isalive():  # Wait until the process finishes\n    sleep(0.1) ## line 71 ##\nsage: s  # indirect doctest ## line 73 ##\nstupid process finished running /usr/bin/true\nsage: sig_on_count() ## line 75 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 96 ##\nsage: s = SageSpawn(\"sh\", [\"-c\", \"while true; do sleep 1; done\"]) ## line 97 ##\nsage: s._keep_alive() ## line 98 ##\nsage: pid = s.pid ## line 99 ##\nsage: del s ## line 100 ##\nsage: import gc ## line 101 ##\nsage: _ = gc.collect() ## line 102 ##\nsage: from signal import SIGTERM ## line 107 ##\nsage: os.kill(pid, SIGTERM) ## line 108 ##\nsage: sig_on_count() ## line 109 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 122 ##\nsage: s = SageSpawn(\"sleep 1000\") ## line 123 ##\nsage: s.close() ## line 124 ##\nsage: while s.isalive():  # long time (5 seconds)\n    sleep(0.1) ## line 125 ##\nsage: sig_on_count() ## line 127 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 157 ##\nsage: s = SageSpawn(\"sh\", [\"-c\", \"while true; do sleep 1; done\"]) ## line 158 ##\nsage: s.terminate_async(interval=0.2) ## line 163 ##\nsage: while True:\n    try:\n        os.kill(s.pid, 0)\n    except OSError:\n        sleep(0.1)\n    else:\n        break  # process got killed ## line 164 ##\nsage: sig_on_count() ## line 171 ##\n0\n```",
    "created_at": "2015-06-19T22:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251241",
    "user": "https://github.com/vbraun"
}
```

On OSX:

```
sage -t --long src/sage/interfaces/sagespawn.pyx
    Bad exit: 1
**********************************************************************
Tests run before process (pid=73714) failed:
sage: from sage.interfaces.sagespawn import SageSpawn ## line 45 ##
sage: SageSpawn("sleep 1", name="Sleeping Beauty") ## line 46 ##
Sleeping Beauty with PID 73715 running /bin/sleep 1
sage: sig_on_count() ## line 48 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 67 ##
sage: s = SageSpawn("true", name="stupid process") ## line 68 ##
sage: s  # indirect doctest ## line 69 ##
stupid process with PID 73717 running /usr/bin/true
sage: while s.isalive():  # Wait until the process finishes
    sleep(0.1) ## line 71 ##
sage: s  # indirect doctest ## line 73 ##
stupid process finished running /usr/bin/true
sage: sig_on_count() ## line 75 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 96 ##
sage: s = SageSpawn("sh", ["-c", "while true; do sleep 1; done"]) ## line 97 ##
sage: s._keep_alive() ## line 98 ##
sage: pid = s.pid ## line 99 ##
sage: del s ## line 100 ##
sage: import gc ## line 101 ##
sage: _ = gc.collect() ## line 102 ##
sage: from signal import SIGTERM ## line 107 ##
sage: os.kill(pid, SIGTERM) ## line 108 ##
sage: sig_on_count() ## line 109 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 122 ##
sage: s = SageSpawn("sleep 1000") ## line 123 ##
sage: s.close() ## line 124 ##
sage: while s.isalive():  # long time (5 seconds)
    sleep(0.1) ## line 125 ##
sage: sig_on_count() ## line 127 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 157 ##
sage: s = SageSpawn("sh", ["-c", "while true; do sleep 1; done"]) ## line 158 ##
sage: s.terminate_async(interval=0.2) ## line 163 ##
sage: while True:
    try:
        os.kill(s.pid, 0)
    except OSError:
        sleep(0.1)
    else:
        break  # process got killed ## line 164 ##
sage: sig_on_count() ## line 171 ##
0
```



---

archive/issue_comments_251242.json:
```json
{
    "body": "Same on Linux (Snapperkob):\n\n```\nsage -t --long src/sage/interfaces/sagespawn.pyx\n    Killed due to terminate\n**********************************************************************\nTests run before process (pid=10311) failed:\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 45 ##\nsage: SageSpawn(\"sleep 1\", name=\"Sleeping Beauty\") ## line 46 ##\nSleeping Beauty with PID 10312 running /bin/sleep 1\nsage: sig_on_count() ## line 48 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 67 ##\nsage: s = SageSpawn(\"true\", name=\"stupid process\") ## line 68 ##\nsage: s  # indirect doctest ## line 69 ##\nstupid process with PID 10316 running /bin/true\nsage: while s.isalive():  # Wait until the process finishes\n    sleep(0.1) ## line 71 ##\nsage: s  # indirect doctest ## line 73 ##\nstupid process finished running /bin/true\nsage: sig_on_count() ## line 75 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 96 ##\nsage: s = SageSpawn(\"sh\", [\"-c\", \"while true; do sleep 1; done\"]) ## line 97 ##\nsage: s._keep_alive() ## line 98 ##\nsage: pid = s.pid ## line 99 ##\nsage: del s ## line 100 ##\nsage: import gc ## line 101 ##\nsage: _ = gc.collect() ## line 102 ##\nsage: from signal import SIGTERM ## line 107 ##\nsage: os.kill(pid, SIGTERM) ## line 108 ##\nsage: sig_on_count() ## line 109 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 122 ##\nsage: s = SageSpawn(\"sleep 1000\") ## line 123 ##\nsage: s.close() ## line 124 ##\nsage: while s.isalive():  # long time (5 seconds)\n    sleep(0.1) ## line 125 ##\nsage: sig_on_count() ## line 127 ##\n0\nsage: from sage.interfaces.sagespawn import SageSpawn ## line 157 ##\nsage: s = SageSpawn(\"sh\", [\"-c\", \"while true; do sleep 1; done\"]) ## line 158 ##\nsage: s.terminate_async(interval=0.2) ## line 163 ##\nsage: while True:\n    try:\n        os.kill(s.pid, 0)\n    except OSError:\n        sleep(0.1)\n    else:\n        break  # process got killed ## line 164 ##\nsage: sig_on_count() ## line 171 ##\n0\n```",
    "created_at": "2015-06-20T09:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251242",
    "user": "https://github.com/vbraun"
}
```

Same on Linux (Snapperkob):

```
sage -t --long src/sage/interfaces/sagespawn.pyx
    Killed due to terminate
**********************************************************************
Tests run before process (pid=10311) failed:
sage: from sage.interfaces.sagespawn import SageSpawn ## line 45 ##
sage: SageSpawn("sleep 1", name="Sleeping Beauty") ## line 46 ##
Sleeping Beauty with PID 10312 running /bin/sleep 1
sage: sig_on_count() ## line 48 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 67 ##
sage: s = SageSpawn("true", name="stupid process") ## line 68 ##
sage: s  # indirect doctest ## line 69 ##
stupid process with PID 10316 running /bin/true
sage: while s.isalive():  # Wait until the process finishes
    sleep(0.1) ## line 71 ##
sage: s  # indirect doctest ## line 73 ##
stupid process finished running /bin/true
sage: sig_on_count() ## line 75 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 96 ##
sage: s = SageSpawn("sh", ["-c", "while true; do sleep 1; done"]) ## line 97 ##
sage: s._keep_alive() ## line 98 ##
sage: pid = s.pid ## line 99 ##
sage: del s ## line 100 ##
sage: import gc ## line 101 ##
sage: _ = gc.collect() ## line 102 ##
sage: from signal import SIGTERM ## line 107 ##
sage: os.kill(pid, SIGTERM) ## line 108 ##
sage: sig_on_count() ## line 109 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 122 ##
sage: s = SageSpawn("sleep 1000") ## line 123 ##
sage: s.close() ## line 124 ##
sage: while s.isalive():  # long time (5 seconds)
    sleep(0.1) ## line 125 ##
sage: sig_on_count() ## line 127 ##
0
sage: from sage.interfaces.sagespawn import SageSpawn ## line 157 ##
sage: s = SageSpawn("sh", ["-c", "while true; do sleep 1; done"]) ## line 158 ##
sage: s.terminate_async(interval=0.2) ## line 163 ##
sage: while True:
    try:
        os.kill(s.pid, 0)
    except OSError:
        sleep(0.1)
    else:
        break  # process got killed ## line 164 ##
sage: sig_on_count() ## line 171 ##
0
```



---

archive/issue_comments_251243.json:
```json
{
    "body": "On my laptop, I can reproduce the first two, not the third. Those first two seem to be different issues. The first is the process-group-was-not-yet-changed race I mentioned in #17686. But I still need to figure out the \"bad exit\".",
    "created_at": "2015-06-20T10:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251243",
    "user": "https://github.com/jdemeyer"
}
```

On my laptop, I can reproduce the first two, not the third. Those first two seem to be different issues. The first is the process-group-was-not-yet-changed race I mentioned in #17686. But I still need to figure out the "bad exit".



---

archive/issue_comments_251244.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-06-20T12:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251244",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_251245.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-20T12:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251245",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_251246.json:
```json
{
    "body": "Looks good but the 0.125s is IMHO too slow in the poll; If used with a quick-running executable in `@`parallel then we might spend most of the time waiting. IMHO we should just `sleep(0)` (yield to the thread scheduler). Also, the total timeout should probably be larger than 20*0.125 which you should be able to hit in case of low memory / swapping.",
    "created_at": "2015-06-20T14:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251246",
    "user": "https://github.com/vbraun"
}
```

Looks good but the 0.125s is IMHO too slow in the poll; If used with a quick-running executable in `@`parallel then we might spend most of the time waiting. IMHO we should just `sleep(0)` (yield to the thread scheduler). Also, the total timeout should probably be larger than 20*0.125 which you should be able to hit in case of low memory / swapping.



---

archive/issue_comments_251247.json:
```json
{
    "body": "Replying to [comment:9 vbraun]:\n> Looks good but the 0.125s is IMHO too slow in the poll; If used with a quick-running executable in `@`parallel then we might spend most of the time waiting.\n\nThat code is only for the case where you spawn a `pexpect` subprocess (not for ``@`parallel`) and where the process is started and *immediately* killed. If you're doing that too often, you're doing something wrong anyway.",
    "created_at": "2015-06-20T22:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251247",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 vbraun]:
> Looks good but the 0.125s is IMHO too slow in the poll; If used with a quick-running executable in `@`parallel then we might spend most of the time waiting.

That code is only for the case where you spawn a `pexpect` subprocess (not for ``@`parallel`) and where the process is started and *immediately* killed. If you're doing that too often, you're doing something wrong anyway.



---

archive/issue_comments_251248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-20T23:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251248",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_251249.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-21T09:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18504#issuecomment-251249",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052472.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-21T09:11:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18504",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18504#event-52472"
}
```
