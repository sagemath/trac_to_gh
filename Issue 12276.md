# Issue 12276: The binomial implementation does a quotient of gamma values, which is wrong

archive/issues_012276.json:
```json
{
    "body": "Assignee: AlexGhitza\n\nThere are special formulas to apply for quotients of gamma values, since those quotients can be pretty reasonable even though the numerator and denominator are too big, for example:\n\n```\nsage: binomial(float(1000),float(1001))\nnan\nsage: binomial(1000,1001)\n0\n```\n\nand:\n\n```\nsage: binomial(float(1001),float(1000))\nnan\nsage: binomial(1001,1000)\n1001\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12448\n\n",
    "created_at": "2012-02-05T13:41:44Z",
    "labels": [
        "basic arithmetic",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "The binomial implementation does a quotient of gamma values, which is wrong",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12276",
    "user": "Snark"
}
```
Assignee: AlexGhitza

There are special formulas to apply for quotients of gamma values, since those quotients can be pretty reasonable even though the numerator and denominator are too big, for example:

```
sage: binomial(float(1000),float(1001))
nan
sage: binomial(1000,1001)
0
```

and:

```
sage: binomial(float(1001),float(1000))
nan
sage: binomial(1001,1000)
1001
```


Issue created by migration from https://trac.sagemath.org/ticket/12448





---

archive/issue_comments_144250.json:
```json
{
    "body": "Attachment [bug_12448.patch](tarball://root/attachments/some-uuid/ticket12448/bug_12448.patch) by Snark created at 2013-01-03 09:48:25\n\nPatch to make the situation better",
    "created_at": "2013-01-03T09:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144250",
    "user": "Snark"
}
```

Attachment [bug_12448.patch](tarball://root/attachments/some-uuid/ticket12448/bug_12448.patch) by Snark created at 2013-01-03 09:48:25

Patch to make the situation better



---

archive/issue_comments_144251.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-03T09:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144251",
    "user": "Snark"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_144252.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-05T21:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144252",
    "user": "Snark"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144253.json:
```json
{
    "body": "I'm not too happy with my patch after all: binomial(float(1001),float(1)) is still a nan ; I should make it a little smarter.",
    "created_at": "2013-01-05T21:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144253",
    "user": "Snark"
}
```

I'm not too happy with my patch after all: binomial(float(1001),float(1)) is still a nan ; I should make it a little smarter.



---

archive/issue_comments_144254.json:
```json
{
    "body": "The current code (not your patch) looks overly complicated for a binomial function. What is the definition being used? Can't it simply be defined as (assuming `m` is an integer):\n\n```\nx * (x-1)/2 * (x-2)/3 * ... * (x-m+1)/m\n```\n\nDoesn't this hold irrespective of whether `x` is real or integer? The above formula also gives a simple way of implementing the binomial. For `x` integer, the computations from left to right remains an integer all the time. Secondly the computation remains bounded at all times (if the binomial is not large) even if the values of `x` and `m` are large. There is no need to invoke the gamma function. One could also start from the other end to keep the values during the computations even less (note that at each step integral values of `x` and `m` implies that the computations remain integers; so we are not breaking anything):\n\n```\n(x-m+1) * (x-m+1)/2 * (x-m+3)/3 * ... * x/m\n```\n\n\nAm I missing some definition of the binomial here, which contains the gamma function necessarily?",
    "created_at": "2013-01-06T09:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144254",
    "user": "ppurka"
}
```

The current code (not your patch) looks overly complicated for a binomial function. What is the definition being used? Can't it simply be defined as (assuming `m` is an integer):

```
x * (x-1)/2 * (x-2)/3 * ... * (x-m+1)/m
```

Doesn't this hold irrespective of whether `x` is real or integer? The above formula also gives a simple way of implementing the binomial. For `x` integer, the computations from left to right remains an integer all the time. Secondly the computation remains bounded at all times (if the binomial is not large) even if the values of `x` and `m` are large. There is no need to invoke the gamma function. One could also start from the other end to keep the values during the computations even less (note that at each step integral values of `x` and `m` implies that the computations remain integers; so we are not breaking anything):

```
(x-m+1) * (x-m+1)/2 * (x-m+3)/3 * ... * x/m
```


Am I missing some definition of the binomial here, which contains the gamma function necessarily?



---

archive/issue_comments_144255.json:
```json
{
    "body": "There are several things to say about the matter:\n1. for m an integer, indeed the formula you give is correct.\n2. but it's possible to define the binomial with m non-integer using gamma-functions, and I think that's what the one who coded the current floating code had in mind.\n3. my patch is about partially unwinding the gamma factors like you mention (with step by step simplification which avoids overflows) before finally calling the gamma function with small parameters.\n4. but my patch should only start looping when the parameters are indeed big (or it will be slow) and use symmetry so binomial(float(1001),float(1)) works.",
    "created_at": "2013-01-06T10:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144255",
    "user": "Snark"
}
```

There are several things to say about the matter:
1. for m an integer, indeed the formula you give is correct.
2. but it's possible to define the binomial with m non-integer using gamma-functions, and I think that's what the one who coded the current floating code had in mind.
3. my patch is about partially unwinding the gamma factors like you mention (with step by step simplification which avoids overflows) before finally calling the gamma function with small parameters.
4. but my patch should only start looping when the parameters are indeed big (or it will be slow) and use symmetry so binomial(float(1001),float(1)) works.



---

archive/issue_comments_144256.json:
```json
{
    "body": "The case of m noninteger is already properly handled in the code. The code checks whether either m or x-m is an integer and only then proceeds. That's why I think calling the gamma function is not necessary.",
    "created_at": "2013-01-06T10:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144256",
    "user": "ppurka"
}
```

The case of m noninteger is already properly handled in the code. The code checks whether either m or x-m is an integer and only then proceeds. That's why I think calling the gamma function is not necessary.



---

archive/issue_comments_144257.json:
```json
{
    "body": "[attachment:trac_12448-fix_binomial.patch Added a patch] which uses pari now, as was indicated as a future fix in a comment. This speeds up all the floating point binomials by about a factor of 5, and fixes the nan that was being returned from large floats. Needs review now :)\n\nPatchbot apply trac_12448-fix_binomial.patch",
    "created_at": "2013-02-02T13:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144257",
    "user": "ppurka"
}
```

[attachment:trac_12448-fix_binomial.patch Added a patch] which uses pari now, as was indicated as a future fix in a comment. This speeds up all the floating point binomials by about a factor of 5, and fixes the nan that was being returned from large floats. Needs review now :)

Patchbot apply trac_12448-fix_binomial.patch



---

archive/issue_comments_144258.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-02T13:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144258",
    "user": "ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144259.json:
```json
{
    "body": "Patching and compiling are ok on amd64 and armv7l.\n\nOn amd64, doctesting is ok, but on arm, the line 3143:\n  a = binomial(RR(1140000.78), 42000000)\nmakes the line 3213 (added by the patch):\n  return P(pari(x).binomial(m))\nraise an error \"ParriError: (15)\".",
    "created_at": "2013-02-03T20:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144259",
    "user": "Snark"
}
```

Patching and compiling are ok on amd64 and armv7l.

On amd64, doctesting is ok, but on arm, the line 3143:
  a = binomial(RR(1140000.78), 42000000)
makes the line 3213 (added by the patch):
  return P(pari(x).binomial(m))
raise an error "ParriError: (15)".



---

archive/issue_comments_144260.json:
```json
{
    "body": "Can you check which part raises the pari error? Is it `pari(RR(1140000.78))` or the `.binomial()` part, or the coercion part? I don't have an arm box, nor do I know pari, so I can only guess.",
    "created_at": "2013-02-04T00:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144260",
    "user": "ppurka"
}
```

Can you check which part raises the pari error? Is it `pari(RR(1140000.78))` or the `.binomial()` part, or the coercion part? I don't have an arm box, nor do I know pari, so I can only guess.



---

archive/issue_comments_144261.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-02-04T00:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144261",
    "user": "ppurka"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144262.json:
```json
{
    "body": "It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).",
    "created_at": "2013-02-04T06:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144262",
    "user": "Snark"
}
```

It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).



---

archive/issue_comments_144263.json:
```json
{
    "body": "Replying to [comment:10 Snark]:\n> It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).\nSo, it seems to be some overflow problems in arm? Should we just change the example\n\n```\na = binomial(RR(1140000.78), 42000000)\n```\n\nto the one below which works on arm? After all, what this is testing is that the binomial is fast, which is well tested even with something that is half the size of the previous one\n\n```\na = binomial(RR(1140000.78), 23310031)\n```\n\n\nOr, does this point to some problem in pari?",
    "created_at": "2013-02-04T09:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144263",
    "user": "ppurka"
}
```

Replying to [comment:10 Snark]:
> It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).
So, it seems to be some overflow problems in arm? Should we just change the example

```
a = binomial(RR(1140000.78), 42000000)
```

to the one below which works on arm? After all, what this is testing is that the binomial is fast, which is well tested even with something that is half the size of the previous one

```
a = binomial(RR(1140000.78), 23310031)
```


Or, does this point to some problem in pari?



---

archive/issue_comments_144264.json:
```json
{
    "body": "Well, if some piece of code works on a platform but doesn't on another, then there's obviously something to investigate. Is it easy to write a C pari-using test case? I'd gladly give it a try.",
    "created_at": "2013-02-04T09:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144264",
    "user": "Snark"
}
```

Well, if some piece of code works on a platform but doesn't on another, then there's obviously something to investigate. Is it easy to write a C pari-using test case? I'd gladly give it a try.



---

archive/issue_comments_144265.json:
```json
{
    "body": "I would put this problem on sage-devel, if you agree. I don't know pari and neither can I fix architecture specific idiosyncrasies.",
    "created_at": "2013-02-04T09:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144265",
    "user": "ppurka"
}
```

I would put this problem on sage-devel, if you agree. I don't know pari and neither can I fix architecture specific idiosyncrasies.



---

archive/issue_comments_144266.json:
```json
{
    "body": "According to sage-devel, indeed the doctest should be modified so it works on both 64 bits and 32 bits architectures.",
    "created_at": "2013-02-04T09:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144266",
    "user": "Snark"
}
```

According to sage-devel, indeed the doctest should be modified so it works on both 64 bits and 32 bits architectures.



---

archive/issue_comments_144267.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-04T11:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144267",
    "user": "ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144268.json:
```json
{
    "body": "Thanks for following up in sage-devel. I have updated the patch with a smaller number.\n\nPatchbot apply trac_12448-fix_binomial.patch",
    "created_at": "2013-02-04T11:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144268",
    "user": "ppurka"
}
```

Thanks for following up in sage-devel. I have updated the patch with a smaller number.

Patchbot apply trac_12448-fix_binomial.patch



---

archive/issue_comments_144269.json:
```json
{
    "body": "Oops. I just found a failing case - the first example.",
    "created_at": "2013-02-04T15:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144269",
    "user": "ppurka"
}
```

Oops. I just found a failing case - the first example.



---

archive/issue_comments_144270.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-02-04T15:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144270",
    "user": "ppurka"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144271.json:
```json
{
    "body": "Attachment [trac_12448-fix_binomial.patch](tarball://root/attachments/some-uuid/ticket12448/trac_12448-fix_binomial.patch) by ppurka created at 2013-02-05 06:27:09\n\nApply to sage/devel",
    "created_at": "2013-02-05T06:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144271",
    "user": "ppurka"
}
```

Attachment [trac_12448-fix_binomial.patch](tarball://root/attachments/some-uuid/ticket12448/trac_12448-fix_binomial.patch) by ppurka created at 2013-02-05 06:27:09

Apply to sage/devel



---

archive/issue_comments_144272.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-05T06:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144272",
    "user": "ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144273.json:
```json
{
    "body": "Should be fixed now.\n\nPatchbot apply trac_12448-fix_binomial.patch",
    "created_at": "2013-02-05T06:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144273",
    "user": "ppurka"
}
```

Should be fixed now.

Patchbot apply trac_12448-fix_binomial.patch



---

archive/issue_comments_144274.json:
```json
{
    "body": "The new patch applies, compiles and passes all doctests in arith.py on armv7l and amd64.",
    "created_at": "2013-02-05T19:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144274",
    "user": "Snark"
}
```

The new patch applies, compiles and passes all doctests in arith.py on armv7l and amd64.



---

archive/issue_comments_144275.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-05T19:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144275",
    "user": "Snark"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_144276.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-09T12:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12276#issuecomment-144276",
    "user": "jdemeyer"
}
```

Resolution: fixed
