# Issue 12276: The binomial implementation does a quotient of gamma values, which is wrong

Issue created by migration from Trac.

Original creator: Snark

Original creation time: 2012-02-05 13:41:44

Assignee: AlexGhitza

There are special formulas to apply for quotients of gamma values, since those quotients can be pretty reasonable even though the numerator and denominator are too big, for example:

```
sage: binomial(float(1000),float(1001))
nan
sage: binomial(1000,1001)
0
```

and:

```
sage: binomial(float(1001),float(1000))
nan
sage: binomial(1001,1000)
1001
```



---

Attachment

Patch to make the situation better


---

Comment by Snark created at 2013-01-03 09:49:27

Changing status from new to needs_review.


---

Comment by Snark created at 2013-01-05 21:06:48

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-01-05 21:06:48

I'm not too happy with my patch after all: binomial(float(1001),float(1)) is still a nan ; I should make it a little smarter.


---

Comment by ppurka created at 2013-01-06 09:25:17

The current code (not your patch) looks overly complicated for a binomial function. What is the definition being used? Can't it simply be defined as (assuming `m` is an integer):

```
x * (x-1)/2 * (x-2)/3 * ... * (x-m+1)/m
```

Doesn't this hold irrespective of whether `x` is real or integer? The above formula also gives a simple way of implementing the binomial. For `x` integer, the computations from left to right remains an integer all the time. Secondly the computation remains bounded at all times (if the binomial is not large) even if the values of `x` and `m` are large. There is no need to invoke the gamma function. One could also start from the other end to keep the values during the computations even less (note that at each step integral values of `x` and `m` implies that the computations remain integers; so we are not breaking anything):

```
(x-m+1) * (x-m+1)/2 * (x-m+3)/3 * ... * x/m
```


Am I missing some definition of the binomial here, which contains the gamma function necessarily?


---

Comment by Snark created at 2013-01-06 10:19:55

There are several things to say about the matter:
1. for m an integer, indeed the formula you give is correct.
2. but it's possible to define the binomial with m non-integer using gamma-functions, and I think that's what the one who coded the current floating code had in mind.
3. my patch is about partially unwinding the gamma factors like you mention (with step by step simplification which avoids overflows) before finally calling the gamma function with small parameters.
4. but my patch should only start looping when the parameters are indeed big (or it will be slow) and use symmetry so binomial(float(1001),float(1)) works.


---

Comment by ppurka created at 2013-01-06 10:54:55

The case of m noninteger is already properly handled in the code. The code checks whether either m or x-m is an integer and only then proceeds. That's why I think calling the gamma function is not necessary.


---

Comment by ppurka created at 2013-02-02 13:02:21

[attachment:trac_12448-fix_binomial.patch Added a patch] which uses pari now, as was indicated as a future fix in a comment. This speeds up all the floating point binomials by about a factor of 5, and fixes the nan that was being returned from large floats. Needs review now :)

Patchbot apply trac_12448-fix_binomial.patch


---

Comment by ppurka created at 2013-02-02 13:02:21

Changing status from needs_work to needs_review.


---

Comment by Snark created at 2013-02-03 20:17:00

Patching and compiling are ok on amd64 and armv7l.

On amd64, doctesting is ok, but on arm, the line 3143:
  a = binomial(RR(1140000.78), 42000000)
makes the line 3213 (added by the patch):
  return P(pari(x).binomial(m))
raise an error "ParriError: (15)".


---

Comment by ppurka created at 2013-02-04 00:26:28

Can you check which part raises the pari error? Is it `pari(RR(1140000.78))` or the `.binomial()` part, or the coercion part? I don't have an arm box, nor do I know pari, so I can only guess.


---

Comment by ppurka created at 2013-02-04 00:26:50

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-02-04 06:31:12

It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).


---

Comment by ppurka created at 2013-02-04 09:04:31

Replying to [comment:10 Snark]:
> It's the .binomial part which raises an error : binomial(RR(1140000.78), 23310031) works, but binomial(RR(1140000.78), 23310032) raises the error (dichotomy).
So, it seems to be some overflow problems in arm? Should we just change the example

```
a = binomial(RR(1140000.78), 42000000)
```

to the one below which works on arm? After all, what this is testing is that the binomial is fast, which is well tested even with something that is half the size of the previous one

```
a = binomial(RR(1140000.78), 23310031)
```


Or, does this point to some problem in pari?


---

Comment by Snark created at 2013-02-04 09:13:24

Well, if some piece of code works on a platform but doesn't on another, then there's obviously something to investigate. Is it easy to write a C pari-using test case? I'd gladly give it a try.


---

Comment by ppurka created at 2013-02-04 09:14:55

I would put this problem on sage-devel, if you agree. I don't know pari and neither can I fix architecture specific idiosyncrasies.


---

Comment by Snark created at 2013-02-04 09:47:08

According to sage-devel, indeed the doctest should be modified so it works on both 64 bits and 32 bits architectures.


---

Comment by ppurka created at 2013-02-04 11:24:08

Changing status from needs_work to needs_review.


---

Comment by ppurka created at 2013-02-04 11:24:08

Thanks for following up in sage-devel. I have updated the patch with a smaller number.

Patchbot apply trac_12448-fix_binomial.patch


---

Comment by ppurka created at 2013-02-04 15:44:05

Oops. I just found a failing case - the first example.


---

Comment by ppurka created at 2013-02-04 15:44:05

Changing status from needs_review to needs_work.


---

Attachment

Apply to sage/devel


---

Comment by ppurka created at 2013-02-05 06:27:43

Changing status from needs_work to needs_review.


---

Comment by ppurka created at 2013-02-05 06:27:43

Should be fixed now.

Patchbot apply trac_12448-fix_binomial.patch


---

Comment by Snark created at 2013-02-05 19:27:13

The new patch applies, compiles and passes all doctests in arith.py on armv7l and amd64.


---

Comment by Snark created at 2013-02-05 19:27:13

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-02-09 12:12:18

Resolution: fixed
