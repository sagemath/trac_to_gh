# Issue 28550: _add_ method for tensors with indices

Issue created by migration from https://trac.sagemath.org/ticket/28787

Original creator: @LBrunswic

Original creation time: 2019-11-22 13:17:25

CC:  egourgoulhon

Keywords: tensor, contraction, symmetries, tensor with indices, manifolds

One may want to add/contract tensors with indices in the following way : 
 
`T["<sup>ijklm_m]+T["</sup>mklij_m"]`

This entails to implement 
* _get_item_ method 
* _set_item_ method 
* _add_ method
which all keep track of the indices names.



---

Comment by @LBrunswic created at 2019-11-22 13:20:02

Set assignee to @LBrunswic.


---

Comment by git created at 2019-11-23 23:33:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-27 21:08:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-28 02:07:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-28 03:39:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-28 14:05:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2019-11-28 14:06:45

Changing status from new to needs_review.


---

Comment by git created at 2019-11-28 15:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-12-01 20:06:45

Thanks for providing this functionality! The code looks nice. 
However, as revealed by the [patchbot](https://patchbot.sagemath.org/ticket/28787/), there are a few minor issues:
- running `sage -coverage src/sage/tensor/modules/tensor_with_indices.py` reveals incomplete coverage
- `SymmetricGroup` is imported but not used
- there are invalid escape sequences in the lines 

```
            if re.search("[()\[\]]",con) is not None:
                raise ValueError("No symmetry allowed")
            if re.search("[()\[\]]",cov) is not None:
                raise ValueError("No symmetry allowed")
```

  Most probably, you should prefix the string `"[()\[\]]"` with `r` to make it a raw string. _Side remark:_ the error message passed to exceptions should start with a lower case letter; so please change `"No symmetry allowed"` to `"no symmetry allowed"`
- Building the documentation via `sage -docbuild reference/tensor_free_modules html` yields some errors, two of them being related to the characters `\]` and `\[` above and should be fixed with the `r` prefix


---

Comment by git created at 2019-12-02 11:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2019-12-02 11:54:05

Thx for the review. I'm sorry, I'm still familiarizing myself with the tools involved in the review process.


---

Comment by egourgoulhon created at 2019-12-02 13:00:02

Replying to [comment:12 gh-LBrunswic]:
> Thx for the review. I'm sorry, I'm still familiarizing myself with the tools involved in the review process.
No problem. I fully understand this of course. To get access to the patchbot reports, click on the button with the Sage version in the top right of the ticket description panel.


---

Comment by git created at 2019-12-02 13:51:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-02 14:51:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-02 20:40:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-03 14:14:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-03 14:16:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-12-03 20:36:15

Sometime the plugin is wrong:

```
-    EXAMPLES:
+    EXAMPLES::
```

was a wrong move, because this is not followed by doctests, but by more text..


---

Comment by egourgoulhon created at 2019-12-04 11:03:16

Changing status from needs_review to needs_work.


---

Comment by egourgoulhon created at 2019-12-04 11:03:16

I've performed some corrections to the docstrings, including that mentioned by Frédéric (comment:19). Now the documentation should build successfully. Note that some of the changes are mere deletions of white space characters on empty lines or at the end of lines (you should configure your editor to do that automatically when saving the file to disk). 

The documentation of the new functionalities added by this ticket does not appear in the html output (i.e. in `local/share/doc/sage/html/en/reference/tensor_free_modules/sage/tensor/modules/tensor_with_indices.html`) because the doc of underscored methods, such as `__add__`, is not generated. You should therefore add relevant examples in the main docstring of `TensorWithIndices`. 
----
New commits:


---

Comment by egourgoulhon created at 2019-12-04 11:06:30

PS: to see my changes, simply click on the blue `8fcd437` above.


---

Comment by egourgoulhon created at 2019-12-04 11:14:34

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2019-12-04 11:14:34

Setting the ticket back to needs_review for the patchbot to run on it.


---

Comment by @LBrunswic created at 2019-12-04 11:21:42

Thanks a lot, I  spent an unreasonable amount of time yesterday trying to understand what was the problem. 

I will consider putting some time into patchbot to see how one could improve on this. Trying to understand the issue I've already read some of the code of patchbot.


---

Comment by @LBrunswic created at 2019-12-04 11:23:44

Replying to [comment:23 gh-LBrunswic]:
> Thanks a lot, I  spent an unreasonable amount of time yesterday trying to understand what was the problem. 

The worst part being that I was actually able to build sagemath with the doc without errors. Only patchbot was raising errors...

> I will consider putting some time into patchbot to see how one could improve on this. Trying to understand the issue I've already read some of the code of patchbot.


---

Comment by egourgoulhon created at 2019-12-04 12:42:25

Replying to [comment:24 gh-LBrunswic]:
> Replying to [comment:23 gh-LBrunswic]:
> > Thanks a lot, I  spent an unreasonable amount of time yesterday trying to understand what was the problem. 
> 
> The worst part being that I was actually able to build sagemath with the doc without errors. Only patchbot was raising errors...

Actually, the patchbot reports are to be taken with a grain of salt. A human eye has always to take a look. Apart from the `EXAMPLE:` case pointed by Frédéric (maybe in that case the patchbot error was triggered by `EXAMPLE:` not being followed by an empty line), another case is some spurious report of unused import (see e.g. [this example](https://trac.sagemath.org/ticket/27865#comment:13)).


> > I will consider putting some time into patchbot to see how one could improve on this.

Thanks!


---

Comment by git created at 2019-12-04 19:00:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-12-04 19:28:52

Doctest lines after TESTS:: should be indented, as for EXAMPLES::

```
+        TESTS::
+
+        sage: from sage.tensor.modules.tensor_with_indices import TensorWithIndices
+        sage: TensorWithIndices._parse_indices('([..])')  # nested symmetries
+        Traceback (most recent call last):
```


The patchbot plugins are not smart, but there is no simple way to make them smarter. When they give a red light, you should judge by yourself if there is an error or not.


---

Comment by git created at 2019-12-04 19:55:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2019-12-04 20:03:48

I'm not critisizing the work that has been put in the patchbot and I realize the work there is more than simply changing a few regex.
On the contrary, I do appreciate the work that has been put into the review process of sagemath, which includes the patchbot. I feel that improving on the process (and the documentation) is improving sagemath on the long run.


---

Comment by @LBrunswic created at 2019-12-04 20:34:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-12-04 21:34:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2019-12-04 21:38:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-12-05 00:32:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-05 00:35:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-12-05 12:15:52

typo "Decompostion"


---

Comment by git created at 2019-12-05 14:28:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-06 10:39:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-12-06 10:45:30

I've just pushed a new commit, with very minor tweaks (mostly indentation in `_parse_indices()` docstring). 

A last point: could you please document further the argument `permutation` of the method ` permute_indices()`, in particular stating in which format it is expected, possibly providing more examples?


---

Comment by @LBrunswic created at 2019-12-07 01:25:23

Changing status from needs_review to needs_work.


---

Comment by @LBrunswic created at 2019-12-07 01:25:23

I then will add some overloading to accept a permutation given by an element of a symmetric group. This seems natural.


---

Comment by egourgoulhon created at 2019-12-07 08:47:16

Replying to [comment:39 gh-LBrunswic]:
> I then will add some overloading to accept a permutation given by an element of a symmetric group. This seems natural.

I was not asking that much, but simply that you document `permutation` in the `INPUT` section by something like "tuple/list of index positions describing the permutation...". But I agree it is quite natural to pass an element of a symmetric group as well.


---

Comment by @LBrunswic created at 2019-12-19 10:22:49

I struggled with adding more general permutation for several reasons : 
* The word problem is only implemented for permutation group acting on [1,...,n] while we more commonly use 0-indexed notations. Therefore, one would need to translate a permutation acting on [0,...,n-1] into a permutation acting on [1,...,n]. While this is not difficult, it seems particularly unnatural : such conversion should be done in the Permutation group module.  

* The overloading would depends on the overloading of PermutationGroupElement 

Therefore, I think it's better to postpone this supplementaty functionality.


---

Comment by git created at 2019-12-19 10:29:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by egourgoulhon created at 2020-01-12 09:13:46

May I ask about the status of this ticket? Is it again ready for review?


---

Comment by @LBrunswic created at 2020-01-13 09:13:03

I haven't taken the time rework on it since the holydays (and the launch of sage9). I have to go through it again.


---

Comment by git created at 2020-01-13 09:53:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2020-01-13 09:57:22

It seems okay to me, I thought I had asked for review after my previous commit.


---

Comment by @LBrunswic created at 2020-01-13 09:57:53

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2020-01-13 21:24:50

It looks good to me, except that the patchbot "blocks" plugin reports this [error](https://patchbot.sagemath.org/log/28787/Linux/1_SMP_Thu_Nov_14_17:32:43_UTC_2019/x86_64/4.14.152-127.182.amzn2.x86_64/unizaramazon2a/2020-01-13%2013:43:00?plugin=blocks&diff=/log/0/Linux/1_SMP_Thu_Nov_14_17%3A32%3A43_UTC_2019/x86_64/4.14.152-127.182.amzn2.x86_64/unizaramazon2a/2020-01-10%2003%3A55%3A52&ticket=28787&base=9.1.beta0). 
This plugin forbids "Returns" at the start of a new line, see rule no. 6 in line 581 of the [plugin source code](https://github.com/sagemath/sage-patchbot/blob/master/sage_patchbot/plugins.py). This is because, according to [PEP 257](https://www.python.org/dev/peps/pep-0257/), _"The docstring is a phrase ending in a period. It prescribes the function or method's effect as a command ("Do this", "Return that"), not as a description; e.g. don't write "Returns the pathname ..."_. So the doctstring of the method `_parse_indices` should start with "Parse", not "Parses", etc. Could you fix this please?


---

Comment by tscrim created at 2020-01-14 16:39:03

This is likely a doc problem:

```diff
         - ``permutation`` -- permutation that has to be applied to the indices
-            the input should be a ``list`` containing the second line of the permutation
-            in Cauchy notation.
+          the input should be a ``list`` containing the second line of the permutation
+          in Cauchy notation
```



---

Comment by git created at 2020-01-15 22:09:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-15 22:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2020-01-17 20:11:39

Thanks for the changes. The (relevant) patchbot in now all green.

Thanks for this nice enhancement!


---

Comment by egourgoulhon created at 2020-01-17 20:11:39

Changing status from needs_review to positive_review.


---

Comment by @LBrunswic created at 2020-01-17 21:51:12

Thanks! I understand the importance of the constraints on the docstrings but it's plainful to get blocked for a whitespace.


---

Comment by vbraun created at 2020-01-19 20:09:18

On Python 2:

```
[dochtml]   File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/tensor/modules/tensor_with_indices.py", line 941
[dochtml]     [swap(*param, self._tensor.tensor_rank()) for param in swap_params],
[dochtml] SyntaxError: only named arguments may follow *expression
```



---

Comment by vbraun created at 2020-01-19 20:09:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-01-19 22:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @LBrunswic created at 2020-01-20 00:54:12

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-01-20 03:38:06

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-25 17:27:29

Resolution: fixed
