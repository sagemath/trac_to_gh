# Issue 18053: cardinality/is_finite/__hash__ methods for CartesianProduct

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-04-23 14:59:28

CC:  ncohen nthiery

We implement three missing methods in `sage.sets.cartesian_product.CartesianProduct`:
- `__hash__`
- `is_finite`
- `cardinality`


---

Comment by vdelecroix created at 2015-04-23 15:19:32

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-23 15:19:32

New commits:


---

Comment by vdelecroix created at 2015-04-23 15:19:32

Changing keywords from "" to "cartesian_product".


---

Comment by ncohen created at 2015-04-23 15:22:08

HMmmmmmmm `O_o`

I don't know enough about this code to be helpful, but computing the cardinality of those sets seems to be too much. Isn't there a 'is_empty' functio in those classes that you could use instead? And you probably should call `is_empty` before the `is_finite`. Deciding emptyness is probably easier than deciding if it is finite?... Or perhaps not, in some weird cases? `^^;;`


---

Comment by ncohen created at 2015-04-23 15:28:34

Okayokay, it seems that there is no `is_empty` method. You ignore my comment above `^^;`


---

Comment by vdelecroix created at 2015-04-23 15:36:57

Replying to [comment:3 ncohen]:
> HMmmmmmmm `O_o`
> 
> I don't know enough about this code to be helpful, but computing the cardinality of those sets seems to be too much. Isn't there a 'is_empty' functio in those classes that you could use instead? And you probably should call `is_empty` before the `is_finite`. Deciding emptyness is probably easier than deciding if it is finite?... Or perhaps not, in some weird cases? `^^;;`

I would love to have an `is_empty`... What do you think to add it in the sets category (and set the default implementation to be `return not self.cardinality()`?). The code in this branch would be much cleaner with that.


---

Comment by ncohen created at 2015-04-23 16:38:30

> I would love to have an `is_empty`... What do you think to add it in the sets category (and set the default implementation to be `return not self.cardinality()`?). The code in this branch would be much cleaner with that.

I'd say that it would be good, but I do not think that I should be patching category codes given my next-to-zero understanding of how it works.


---

Comment by vdelecroix created at 2015-04-23 18:17:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-23 22:41:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-23 23:06:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-23 23:06:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-04-23 23:57:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-24 00:05:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-04-24 06:26:03

Wasn't there just discussion about avoiding `self` in docstrings at sage-devel? I.e. "Return the cardinality of self." should be "of this set" or "of this cartesian product".

Code seems to work. Just to make sure: should `cartesian_product([ZZ, ZZ]).unrank(42)` work like for example `ZZ.unrank(42)` works?


---

Comment by vdelecroix created at 2015-04-24 08:40:07

Replying to [comment:15 jmantysalo]:
> Wasn't there just discussion about avoiding `self` in docstrings at sage-devel? I.e. "Return the cardinality of self." should be "of this set" or "of this cartesian product".

I can do that.
 
> Code seems to work. Just to make sure: should `cartesian_product([ZZ, ZZ]).unrank(42)` work like for example `ZZ.unrank(42)` works?

No. The order of enumeration of a cartesian products is lexicographic. So a cartesian product of infinite enumerated sets should even *not* be an enumerated set!


---

Comment by nthiery created at 2015-04-24 08:49:55

Replying to [comment:15 jmantysalo]:
> Wasn't there just discussion about avoiding `self` in docstrings at sage-devel? I.e. "Return the cardinality of self." should be "of this set" or "of this cartesian product".

My understanding of the discussion was that ``self`` should not be listed in the INPUT section (I actually need to argue further in the thread for I don't necessarily agree). I don't remember it being a problem elsewhere in the docstring. But I need to reread the thread.

That being said, "of this cartesian product" is a bit redundant but it reads nicely to remind the user of the context. So this can be a good idea here.

Cheers,
                                        Nicolas


---

Comment by jmantysalo created at 2015-04-24 09:19:52

Replying to [comment:16 vdelecroix]:

> No. The order of enumeration of a cartesian products is lexicographic. So a cartesian product of infinite enumerated sets should even *not* be an enumerated set!

OK. And after the patch at least `for x in cartesian_product([ZZ,ZZ])` gives an error.


---

Comment by vdelecroix created at 2015-04-24 09:24:00

Replying to [comment:18 jmantysalo]:
> Replying to [comment:16 vdelecroix]:
> 
> > No. The order of enumeration of a cartesian products is lexicographic. So a cartesian product of infinite enumerated sets should even *not* be an enumerated set!
> 
> OK. And after the patch at least `for x in cartesian_product([ZZ,ZZ])` gives an error.

I will add it to the doc with a comment.

Though, for infinite sets, we can choose an other order for the enumeration. If so, we can put back this method and implement rank/unrank.


---

Comment by git created at 2015-04-24 09:43:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-24 16:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-03 19:19:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-03 19:19:23

Rebased on sage-6.7.beta3

Vincent


---

Comment by git created at 2015-05-11 11:05:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-11 11:07:13

Rebased on sage-6.7.beta4 + docstring for the overriden functions in cartesian products of finite enumerated sets.


---

Comment by vdelecroix created at 2015-05-11 12:22:05

If I do

```
class A:
    f = B.f.im_func
    """
    Some doctests

    TESTS::

       sage: 1+1
       2
    """
```

this is not considered as a doctest. But if instead I do

```
class A:
    my_string = (
        r"""
        TESTS::

            sage: print "Is this a test?"
            Of course not
        """
    )
```

then it is considered as a doctest!!

The algorithm used to detect doctests is clearly wrong!

Vincent


---

Comment by vdelecroix created at 2015-05-11 12:24:44

What should I do for the sake of that ticket?


---

Comment by ncohen created at 2015-05-11 12:53:52

Hire an engineer.


---

Comment by nthiery created at 2015-05-12 16:18:41


```
  - EnumeratedSets.CartesianProducts.ParentMethods.__iter__
    - Description of the iterator
    - Use is_finite or in Sets.Finite? Or put the thing in CartesianProducts.Finite?
  - unrank: ValueError or IndexError?
  - Magmas.FinitelyGenerated.Unital.ParentMethods.is_empty:
    could be an assignment for consistency?
  - Groups.CartesianProducts.order:
    could be an assignment for consistency?
  - Sets.ParentMethods.random_element: use an abstract method + real doc
  - random_element & friends: do we want to make a tuple before passing
    the data to cartesian_product_of_elements?
```

----
New commits:


---

Comment by vdelecroix created at 2015-05-12 21:10:16

As we discussed on the phone with Nicolas: I removed the abstract methods: `is_empty`, `is_finite` and `random_element` from `Sets`. For the first two, we might not want to call `cardinality` as this can easily lead to loop (e.g. #18400). As a rationale: a less specialized method should not try to call a more specialized one. For random_element: adding an optional abstract method would pollute the namespace.

- unrank: `IndexError` is what is uniformly in `categories/*` and also in `combinat/cartesian_product`.
- I moved is_empty from `Magmas.FinitelyGenerated.Unital.ParentMethods.is_empty` to `Magmas.Unital.is_empty` and everything looks fine
- random_element: tuple removed

I will add a second commit for `order` vs `cardinality` in `Groups`.

Vincent
----
New commits:


---

Comment by vdelecroix created at 2015-05-12 22:13:46

Hello,

For `cardinality` vs `order` here is the list of files I had to change:

- algebras/quatalg/quaternion_algebra.py
- algebras/steenrod/steenrod_algebra.py
- groups/abelian_gps/abelian_group.py
- groups/abelian_gps/dual_abelian_group.py
- groups/additive_abelian/additive_abelian_group.py
- groups/group.pyx
- groups/indexed_free_group.py
- groups/matrix_gps/coxeter_group.py
- groups/old.pyx
- groups/pari_group.py
- groups/perm_gps/permgroup.py
- groups/semimonomial_transformations/semimonomial_transformation_group.py
- libs/coxeter3/coxeter.pyx
- modular/abvar/finite_subgroup.py
- modular/abvar/torsion_subgroup.py
- modular/arithgroup/arithgroup_generic.py
- modular/dirichlet.py
- rings/contfrac.py
- rings/finite_rings/finite_field_base.pyx
- rings/finite_rings/finite_field_ext_pari.py
- rings/finite_rings/finite_field_givaro.py
- rings/finite_rings/finite_field_ntl_gf2e.py
- rings/finite_rings/finite_field_prime_modn.py
- rings/finite_rings/homset.py
- rings/finite_rings/integer_mod_ring.py
- rings/integer_ring.pyx
- rings/number_field/galois_group.py
- rings/number_field/morphism.py
- rings/number_field/number_field.py
- rings/polynomial/infinite_polynomial_ring.py
- rings/polynomial/polynomial_quotient_ring.py
- rings/qqbar.py
- rings/rational_field.py
- rings/ring.pyx

In particular it concerns not only groups but:
 - (multiplicative) groups
 - additive (Abelian) groups
 - rings

At least Sage is able to start but I am not sure it fits exactly the purpose of the ticket. If you do not mind I will push that commit in #18410.

Vincent


---

Comment by nthiery created at 2015-05-13 05:31:25

Replying to [comment:32 vdelecroix]:
> For `cardinality` vs `order` here is the list of files I had to change:
> ...

Thanks!

> At least Sage is able to start but I am not sure it fits exactly the purpose of the ticket. If you do not mind I will push that commit in #18410.

+1


---

Comment by ncohen created at 2015-05-13 06:33:41

> As a rationale: a less specialized method should not try to call a more specialized one. 

Are the 'new rationales' just made up when we need them, or should we stop having `.cardinality()` call `__iter__`, as it is exactly the same pattern?

Nathann


---

Comment by vdelecroix created at 2015-05-13 06:44:56

Replying to [comment:34 ncohen]:
> > As a rationale: a less specialized method should not try to call a more specialized one. 
> 
> Are the 'new rationales' just made up when we need them, or should we stop having `.cardinality()` call `__iter__`, as it is exactly the same pattern?

;-) I agree with Nathann that it is perhaps not the best default. Though, let us keep it independent of this ticket. My motivation for the rationale was to avoid loops like

- is_finite asks cardinality
- cardinality asks is_finite before starting to iterate

(which is exactly the problem with projective scheme).

On the other hand, there is sometimes nothing else to do than going through the list of elements to get the cardinality. And you know it: `sage.graphs.independent_sets.IndependentSets`.

Vincent


---

Comment by ncohen created at 2015-05-13 06:49:32

> On the other hand, there is sometimes nothing else to do than going through the list of elements to get the cardinality. And you know it: `sage.graphs.independent_sets.IndependentSets`.

The same goes for `is_empty`. Sometimes all you can do is run the enumeration.

Nathann


---

Comment by vdelecroix created at 2015-05-13 06:55:04

Replying to [comment:36 ncohen]:
> > On the other hand, there is sometimes nothing else to do than going through the list of elements to get the cardinality. And you know it: `sage.graphs.independent_sets.IndependentSets`.
> 
> The same goes for `is_empty`. Sometimes all you can do is run the enumeration.

This is exactly what I did:

```
class EnumeratedSets:
    class ParentMethods:
        def is_empty(self):
            try:
                iter(self).next()
            except StopIteration:
                return False
            else:
                return True
```



---

Comment by ncohen created at 2015-05-13 06:57:44

In your earlier comment you explicitly said that you had removed the methods.


---

Comment by ncohen created at 2015-05-13 07:03:51

Isn't a semigroup a magma too ? `O_o`


---

Comment by vdelecroix created at 2015-05-13 07:07:14

Replying to [comment:38 ncohen]:
> In your earlier comment you explicitly said that you had removed the methods.

I removed it at the level of `Sets` where the implementation was `return self.cardinality() == 0`. Not at the level of enumerated sets. So most parents will have a `is_empty`.


---

Comment by vdelecroix created at 2015-05-13 07:07:56

Replying to [comment:39 ncohen]:
> Isn't a semigroup a magma too ? `O_o`

It is!

```
sage: Semigroups().super_categories()
[Category of magmas]
```

Did you found something strange?


---

Comment by ncohen created at 2015-05-13 07:11:50

I thought for a second that you had defined `is_empty` simultaneously for magmas and semigroups, but apparently I was wrong.


---

Comment by git created at 2015-05-13 07:40:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2015-05-13 07:50:52

I have been through Vincent's last commit. I pushed too minor fixes. I have only a couple points I am wondering about:

- Do we want to import ZZ in sage.sets.cartesian_product? Can we do a local import or lazy import? Or is it just ok?

- In `CartesianProduct._cartesian_product_of_elements`, it would be semantically equivalent to use `zip` rather than `iterator.izip` since we anyway build a tuple right after. Just curious, is one faster than the other in practice (it's a tradeoff between building a list for nothing and using another layer of iterators)?

- Please update the documentation of `Sets.CartesianProducts.ParentMethods._cartesian_product_of_elements` to specify that it should accept any iterable.

- _sets_keys(): do we really want an `IntegerRange` rather than a `range`? I would imagine `IntegerRange` could be faster for containment testing and slower for iteration, so again a tradeoff.

In any cases, I'll be busy all day and don't have a strong opinion on either of the above points. So please make the choice you feel right. And then I consider this as good to go.

Thanks Vincent for all the work!


---

Comment by git created at 2015-05-13 08:46:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-05-13 08:48:23

Replying to [comment:44 nthiery]:
> I have been through Vincent's last commit. I pushed too minor fixes. I have only a couple points I am wondering about:
> 
> - Do we want to import ZZ in sage.sets.cartesian_product? Can we do a local import or lazy import? Or is it just ok?

I think this is fine. I would find it strange to import it in `sage.categories.*` but `sage.sets.cartesian_product` is lazily imported.

> - In `CartesianProduct._cartesian_product_of_elements`, it would be semantically equivalent to use `zip` rather than `iterator.izip` since we anyway build a tuple right after. Just curious, is one faster than the other in practice (it's a tradeoff between building a list for nothing and using another layer of iterators)?

Here you are not building the list from the pairs `(c,x)` but by calling `c(x)`. So I guess that `izip` is always better. From the timing it is very similar and `izip` gets much better as the size of the lists increase. (moreover in `Python 3` the `izip` is just deleted and `zip` becomes `izip`).

> - Please update the documentation of `Sets.CartesianProducts.ParentMethods._cartesian_product_of_elements` to specify that it should accept any iterable.

done.

> - _sets_keys(): do we really want an `IntegerRange` rather than a `range`? I would imagine `IntegerRange` could be faster for containment testing and slower for iteration, so again a tradeoff.

It is *much* faster for containment test and it is currently the only way it is used in `sage.sets.cartesian_product` (the method `cartesian_projection`). If the iteration is slower, then we should just make it faster in `IntegerRange`!

>  In any cases, I'll be busy all day and don't have a strong opinion on either of the above points. So please make the choice you feel right. And then I consider this as good to go.

I am running the long tests and will set positive review if everything is fine.

Vincent


---

Comment by git created at 2015-05-13 09:52:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-13 09:53:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-13 11:00:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-13 20:11:33

Resolution: fixed
