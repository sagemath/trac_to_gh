# Issue 25121: Test safe directory without python subprocess

Issue created by migration from Trac.

Original creator: @timokau

Original creation time: 2018-05-13 19:49:54

CC:  jdemeyer embray slelievre fbissey jhpalmieri

The `test_safe_directory` function currently works by spawning a python subprocess and relying on the `sys_path_security-issue_16202.patch` being applied (https://bugs.python.org/issue16202).

That is not really necessary: This commit changes the implementation to use `os.stat´ instead. That has several disadvantages:

- does not depend on the python patch
- saves the (small) overhead of forking a new python process
- is simpler / more obvious to implement


---

Comment by @timokau created at 2018-05-13 19:50:49

New commits:


---

Comment by @timokau created at 2018-05-13 19:50:49

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-05-14 05:25:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-05-14 05:25:52

This patch changes behaviour. The security check implemented in the Python patch is more complicated that this simple check. It involves group permissions, umask...

This brings us to the main _advantage_ of the subprocess approach: it's very simple to get the same behaviour as Python.


---

Comment by jdemeyer created at 2018-05-14 05:29:05

For Sage, another advantage of the subprocess approach that it is implicitly also a test of the logic in the Python patch.


---

Comment by @timokau created at 2018-05-14 09:28:29

Replying to [comment:2 jdemeyer]:
> This patch changes behaviour. The security check implemented in the Python patch is more complicated that this simple check. It involves group permissions, umask...

For reference: [here](https://gist.github.com/timokau/e3aa33a997e0f3296a9ba53972348031) is the relevant permission checking code. Some of that seems arbitrary to me, for example `/* Only keep group bit if the current group ID is the same as the group of "parent" */`. But it probably wouldn't be too hard to implement that logic in python.

> This brings us to the main _advantage_ of the subprocess approach: it's very simple to get the same behaviour as Python.

> For Sage, another advantage of the subprocess approach that it is implicitly also a test of the logic in the Python patch.

But whats the value in that? Only sages python has that behaviour anyways and the upstream patch looks like a loosing battle.

Currently the result is that [debian](https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-python_security.patch) and [gentoo](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-safepython.patch) (and nix) simply disable the test while arch just failes it.


---

Comment by @timokau created at 2018-05-14 09:29:24

Changing status from needs_work to needs_review.


---

Comment by @timokau created at 2018-05-14 09:29:24

Changing to needs_review because I don't know what work is needed yet: Do you want me to implement more of that python patch logic in sage?


---

Comment by jdemeyer created at 2018-05-14 09:48:52

Replying to [comment:4 gh-timokau]:
> and the upstream patch looks like a loosing battle.

I don't see it as a "battle". If upstream Python wants to continue shipping their Python with a huge security hole, it's their problem. That's how I see it.


---

Comment by @timokau created at 2018-05-14 10:00:47

Replying to [comment:6 jdemeyer]:
> Replying to [comment:4 gh-timokau]:
> > and the upstream patch looks like a loosing battle.
> 
> I don't see it as a "battle". If upstream Python wants to continue shipping their Python with a huge security hole, it's their problem. That's how I see it.

Right, but if it makes packaging harder that makes it our problem, too. In the end its not really sages place to judge and test for that behaviour. I'm not suggesting to remove the patch from "sage-the-distribution", just that the doctests don't depend on it. In my opinion thats better than every distribution removing the test individually.


---

Comment by @timokau created at 2018-06-30 16:43:55

Can I do anything to push this ticket forward `@`jdemeyer?


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by saraedum created at 2018-10-10 11:40:30

Imho we should not depend on a patched Python in our doctesting.

I appreciate the patch to Python as such. Loading random modules from `.` is certainly something that many people are not aware of so it made sense to patch this upstream and to backport that patch to Sage-the-distribution.

I am not convinced that we should change Python's doctesting behaviour as such. We should change not common behaviour, I think: if Python does not check that the current directory is safe in its built-in doctesting, we should not do that either; after all we're just a Python library. But I can imagine that some disagree.

Anyway, we should not check that we are running on patched Python. So my proposal is to make this a Python3 check instead.


---

Comment by saraedum created at 2018-10-10 11:43:59

Hm…somehow I was under the impression that the warning was part of Python3 now...that does not seem to be the case.

In that case, I propose to remove that doctest completely.


---

Comment by saraedum created at 2018-10-10 12:24:06

I tried to start a more general discussion at #26457.


---

Comment by embray created at 2018-10-28 17:03:23

+1.  My one concern is that this might have impact on Cygwin if the directory in question is not on a mount with POSIX permissions emulation, but I need to check.


---

Comment by chapoton created at 2019-05-24 15:21:47

Can we move on either here or in #27529, please ?


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by git created at 2019-10-05 10:59:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2019-10-05 11:00:15

Rebased for sage 9.0.


---

Comment by chapoton created at 2019-11-13 07:58:02

red branch


---

Comment by chapoton created at 2019-11-13 07:58:02

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2019-11-13 08:34:34

Since there doesn't seem to be any chance for this to get merged, I won't push this any further. Luckily it will become irrelevant with the python3 switch anyways, since the relevant test is marked py2 only.


---

Comment by embray created at 2019-11-13 17:44:12

Replying to [comment:23 gh-timokau]:
> Since there doesn't seem to be any chance for this to get merged, I won't push this any further. Luckily it will become irrelevant with the python3 switch anyways, since the relevant test is marked py2 only.

I think it might be that the patch in question was never ported to Python 3.  So, when as part of #28000 we go through and remove all the `# py2` tests, it will just go away anyways, I guess :)


---

Comment by @timokau created at 2019-11-13 17:48:13

Exactly, problem solved :)


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-03-22 21:39:58

Needs rebasing


---

Comment by mkoeppe created at 2020-03-22 23:04:35

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-22 23:04:35

New commits:


---

Comment by dimpase created at 2020-03-23 02:39:39

let me try to test this on "interesting" platforms


---

Comment by mkoeppe created at 2020-03-23 09:26:12

Works for me at https://github.com/mkoeppe/sage/actions/runs/61077298


---

Comment by mkoeppe created at 2020-03-23 12:43:00

Replying to [comment:31 dimpase]:
> let me try to test this on "interesting" platforms
Probably should be tested on cygwin


---

Comment by dimpase created at 2020-03-23 15:51:43

Can't cygwin testing be done via GH Actions?


---

Comment by mkoeppe created at 2020-03-23 17:04:23

Replying to [comment:34 dimpase]:
> Can't cygwin testing be done via GH Actions?
Yes, but at the moment the build is timing out before it can do "make ptest"


---

Comment by dimpase created at 2020-03-23 17:17:02

I imagine a minimal build in cygwin is hopless, but a standard one, with python3 from the system ticket, should be quick enough to do at least "make build"
followed by testing of some files


---

Comment by mkoeppe created at 2020-03-23 17:26:00

I've created #29397 to activate more system packages on cygwin


---

Comment by dimpase created at 2020-03-24 14:54:29

Let's merge this, and worry about cygwin later.


---

Comment by dimpase created at 2020-03-24 14:54:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-24 16:24:50

OK, I agree


---

Comment by vbraun created at 2020-03-29 00:24:20

Resolution: fixed
