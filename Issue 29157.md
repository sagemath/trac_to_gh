# Issue 29157: Drop the python2 patch sys_path_security-issue_16202

Issue created by migration from https://trac.sagemath.org/ticket/29394

Original creator: mkoeppe

Original creation time: 2020-03-22 21:00:33

CC:  vbraun jdemeyer embray slelievre @timokau fbissey arojas nthiery isuruf pcpa thansen infinity0 snark cschwan jhpalmieri

This patch, applied by #13579 ("Python sys.path security risk") 7 years ago was never accepted in upstream Python. We do not bother to do the same in python3; and it causes build problems (#29367).

Related tickets:
- #25358 Test safe directory without python subprocess
- #26457 Do not depend on a patched Python


---

Comment by mkoeppe created at 2020-03-22 21:20:03

New commits:


---

Comment by mkoeppe created at 2020-03-22 21:20:03

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-03-22 21:21:21

Good riddance.


---

Comment by fbissey created at 2020-03-22 21:21:21

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-03-22 22:33:30

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2020-03-22 22:36:17

Doctest failures with a Python 2 build, so let's get rid of the offending doctests.
----
New commits:


---

Comment by jhpalmieri created at 2020-03-22 22:36:17

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2020-03-22 22:38:53

Hum, I thought it was going to be handled in a different ticket, but yes that test should go, of course. And that's the only place I know where the issue would crop up.


---

Comment by fbissey created at 2020-03-22 22:38:53

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-03-22 22:39:44

Do we need to delete the function `test_safe_directory` in `doctest/control.py`?


---

Comment by fbissey created at 2020-03-22 22:41:57

Replying to [comment:9 jhpalmieri]:
> Do we need to delete the function `test_safe_directory` in `doctest/control.py`?

I wouldn't think it is needed. After all it works well with python without change. Let me double check.


---

Comment by jhpalmieri created at 2020-03-22 22:42:27

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2020-03-22 22:42:27

To partially answer my own question: that function gives another doctest failure with a Python 2 build. Its docstring also says "This is only relevant with Python 2, because Sage's Python 2 is patched to give a warning when the current directory is unsafe, but Python 3 is not." So I think we should remove the function entirely.


---

Comment by fbissey created at 2020-03-22 22:45:16

Oh right, I am forgetting we are still doing py2 builds here. Yes it should go.


---

Comment by jhpalmieri created at 2020-03-22 22:46:38

I'll provide a branch which removes it. If you're happy with that, once I run tests successfully with Python 2, I can set to positive review on your behalf.


---

Comment by mkoeppe created at 2020-03-22 22:47:41

#25358 has a better fix for test_safe_directory


---

Comment by git created at 2020-03-22 22:48:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-03-22 22:50:49

Replying to [comment:14 mkoeppe]:
> #25358 has a better fix for test_safe_directory

So, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.


---

Comment by jhpalmieri created at 2020-03-22 22:53:58

Replying to [comment:16 fbissey]:
> Replying to [comment:14 mkoeppe]:
> > #25358 has a better fix for test_safe_directory

If you want to try to revive that, you can. It can be done on #25358, with this ticket as a prerequisite, since one of the main obstacles there was the patched Python. Once we remove this patch to Python, the current incarnation of `test_safe_directory` is no longer relevant, as far as I can tell.
 
> So, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.

That ticket had completely stalled, though.


---

Comment by fbissey created at 2020-03-22 23:00:11

Thanks John, we have to make a decision on what we do with #25358 (and how fast) before we proceed with the current changes. Plain removal is attractive to me. Less code.


---

Comment by mkoeppe created at 2020-03-22 23:01:33

I think test_safe_directory is a useful security mechanism.
Its current **implementation** depends on the patch that we are now dropping (and hence on Python2)


---

Comment by mkoeppe created at 2020-03-22 23:05:32

Replying to [comment:17 jhpalmieri]:
> Replying to [comment:16 fbissey]:
> > Replying to [comment:14 mkoeppe]:
> > > #25358 has a better fix for test_safe_directory
> 
> If you want to try to revive that, you can.

Done

> It can be done on #25358, with this ticket as a prerequisite

No, present ticket depends on #25358


---

Comment by mkoeppe created at 2020-03-22 23:10:16

New commits:


---

Comment by mkoeppe created at 2020-03-22 23:10:16

Changing status from needs_work to needs_review.


---

Comment by @timokau created at 2020-03-22 23:33:34

For what it's worth I gave up on #25358 because jdmeyer had a pretty strong opinion on that. I'm not sure if that has changed. If it was up to me, I think I'd vote complete removal too. #25358 was intended as a compromise.


---

Comment by mkoeppe created at 2020-03-22 23:34:51

If we want, we can of course keep *both* tests in #25358. Keeping py2 as "secure" as it was; and adding security to py3.


---

Comment by jhpalmieri created at 2020-03-22 23:46:36

We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?


---

Comment by mkoeppe created at 2020-03-23 00:05:54

Replying to [comment:26 jhpalmieri]:
> We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?
Right, it would be purely decorative or for the hypothetical situation that someone decides to run sagelib with a patched python2.


---

Comment by mkoeppe created at 2020-03-23 00:46:01

Testing this branch at https://github.com/mkoeppe/sage/actions/runs/61077298
(on top of other tickets)


---

Comment by jhpalmieri created at 2020-03-23 04:45:53

This passes tests for me on OS X with builds based on Python 2 and Python 3.


---

Comment by dimpase created at 2020-03-24 14:18:06

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-24 14:18:06

lgtm


---

Comment by mkoeppe created at 2020-03-24 16:24:37

Thanks


---

Comment by vbraun created at 2020-03-29 00:23:53

Resolution: fixed
