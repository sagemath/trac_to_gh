# Issue 29157: Drop the python2 patch sys_path_security-issue_16202

archive/issues_029157.json:
```json
{
    "body": "CC:  vbraun jdemeyer embray slelievre @timokau fbissey arojas nthiery isuruf pcpa thansen infinity0 snark cschwan jhpalmieri\n\nThis patch, applied by #13579 (\"Python sys.path security risk\") 7 years ago was never accepted in upstream Python. We do not bother to do the same in python3; and it causes build problems (#29367).\n\nRelated tickets:\n- #25358 Test safe directory without python subprocess\n- #26457 Do not depend on a patched Python\n\nIssue created by migration from https://trac.sagemath.org/ticket/29394\n\n",
    "created_at": "2020-03-22T21:00:33Z",
    "labels": [
        "packages: optional",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Drop the python2 patch sys_path_security-issue_16202",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29157",
    "user": "mkoeppe"
}
```
CC:  vbraun jdemeyer embray slelievre @timokau fbissey arojas nthiery isuruf pcpa thansen infinity0 snark cschwan jhpalmieri

This patch, applied by #13579 ("Python sys.path security risk") 7 years ago was never accepted in upstream Python. We do not bother to do the same in python3; and it causes build problems (#29367).

Related tickets:
- #25358 Test safe directory without python subprocess
- #26457 Do not depend on a patched Python

Issue created by migration from https://trac.sagemath.org/ticket/29394





---

archive/issue_comments_412750.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-03-22T21:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412750",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_412751.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-22T21:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412751",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_412752.json:
```json
{
    "body": "Good riddance.",
    "created_at": "2020-03-22T21:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412752",
    "user": "fbissey"
}
```

Good riddance.



---

archive/issue_comments_412753.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-22T21:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412753",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_412754.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-22T22:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412754",
    "user": "jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_412755.json:
```json
{
    "body": "Doctest failures with a Python 2 build, so let's get rid of the offending doctests.\n----\nNew commits:",
    "created_at": "2020-03-22T22:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412755",
    "user": "jhpalmieri"
}
```

Doctest failures with a Python 2 build, so let's get rid of the offending doctests.
----
New commits:



---

archive/issue_comments_412756.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-22T22:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412756",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_412757.json:
```json
{
    "body": "Hum, I thought it was going to be handled in a different ticket, but yes that test should go, of course. And that's the only place I know where the issue would crop up.",
    "created_at": "2020-03-22T22:38:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412757",
    "user": "fbissey"
}
```

Hum, I thought it was going to be handled in a different ticket, but yes that test should go, of course. And that's the only place I know where the issue would crop up.



---

archive/issue_comments_412758.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-22T22:38:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412758",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_412759.json:
```json
{
    "body": "Do we need to delete the function `test_safe_directory` in `doctest/control.py`?",
    "created_at": "2020-03-22T22:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412759",
    "user": "jhpalmieri"
}
```

Do we need to delete the function `test_safe_directory` in `doctest/control.py`?



---

archive/issue_comments_412760.json:
```json
{
    "body": "Replying to [comment:9 jhpalmieri]:\n> Do we need to delete the function `test_safe_directory` in `doctest/control.py`?\n\nI wouldn't think it is needed. After all it works well with python without change. Let me double check.",
    "created_at": "2020-03-22T22:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412760",
    "user": "fbissey"
}
```

Replying to [comment:9 jhpalmieri]:
> Do we need to delete the function `test_safe_directory` in `doctest/control.py`?

I wouldn't think it is needed. After all it works well with python without change. Let me double check.



---

archive/issue_comments_412761.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-22T22:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412761",
    "user": "jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_412762.json:
```json
{
    "body": "To partially answer my own question: that function gives another doctest failure with a Python 2 build. Its docstring also says \"This is only relevant with Python 2, because Sage's Python 2 is patched to give a warning when the current directory is unsafe, but Python 3 is not.\" So I think we should remove the function entirely.",
    "created_at": "2020-03-22T22:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412762",
    "user": "jhpalmieri"
}
```

To partially answer my own question: that function gives another doctest failure with a Python 2 build. Its docstring also says "This is only relevant with Python 2, because Sage's Python 2 is patched to give a warning when the current directory is unsafe, but Python 3 is not." So I think we should remove the function entirely.



---

archive/issue_comments_412763.json:
```json
{
    "body": "Oh right, I am forgetting we are still doing py2 builds here. Yes it should go.",
    "created_at": "2020-03-22T22:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412763",
    "user": "fbissey"
}
```

Oh right, I am forgetting we are still doing py2 builds here. Yes it should go.



---

archive/issue_comments_412764.json:
```json
{
    "body": "I'll provide a branch which removes it. If you're happy with that, once I run tests successfully with Python 2, I can set to positive review on your behalf.",
    "created_at": "2020-03-22T22:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412764",
    "user": "jhpalmieri"
}
```

I'll provide a branch which removes it. If you're happy with that, once I run tests successfully with Python 2, I can set to positive review on your behalf.



---

archive/issue_comments_412765.json:
```json
{
    "body": "#25358 has a better fix for test_safe_directory",
    "created_at": "2020-03-22T22:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412765",
    "user": "mkoeppe"
}
```

#25358 has a better fix for test_safe_directory



---

archive/issue_comments_412766.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-22T22:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412766",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_412767.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> #25358 has a better fix for test_safe_directory\n\nSo, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.",
    "created_at": "2020-03-22T22:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412767",
    "user": "fbissey"
}
```

Replying to [comment:14 mkoeppe]:
> #25358 has a better fix for test_safe_directory

So, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.



---

archive/issue_comments_412768.json:
```json
{
    "body": "Replying to [comment:16 fbissey]:\n> Replying to [comment:14 mkoeppe]:\n> > #25358 has a better fix for test_safe_directory\n\nIf you want to try to revive that, you can. It can be done on #25358, with this ticket as a prerequisite, since one of the main obstacles there was the patched Python. Once we remove this patch to Python, the current incarnation of `test_safe_directory` is no longer relevant, as far as I can tell.\n \n> So, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.\n\nThat ticket had completely stalled, though.",
    "created_at": "2020-03-22T22:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412768",
    "user": "jhpalmieri"
}
```

Replying to [comment:16 fbissey]:
> Replying to [comment:14 mkoeppe]:
> > #25358 has a better fix for test_safe_directory

If you want to try to revive that, you can. It can be done on #25358, with this ticket as a prerequisite, since one of the main obstacles there was the patched Python. Once we remove this patch to Python, the current incarnation of `test_safe_directory` is no longer relevant, as far as I can tell.
 
> So, that's why I thought that stuff was dealt with in another ticket. I am not completely losing my marbles.

That ticket had completely stalled, though.



---

archive/issue_comments_412769.json:
```json
{
    "body": "Thanks John, we have to make a decision on what we do with #25358 (and how fast) before we proceed with the current changes. Plain removal is attractive to me. Less code.",
    "created_at": "2020-03-22T23:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412769",
    "user": "fbissey"
}
```

Thanks John, we have to make a decision on what we do with #25358 (and how fast) before we proceed with the current changes. Plain removal is attractive to me. Less code.



---

archive/issue_comments_412770.json:
```json
{
    "body": "I think test_safe_directory is a useful security mechanism.\nIts current **implementation** depends on the patch that we are now dropping (and hence on Python2)",
    "created_at": "2020-03-22T23:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412770",
    "user": "mkoeppe"
}
```

I think test_safe_directory is a useful security mechanism.
Its current **implementation** depends on the patch that we are now dropping (and hence on Python2)



---

archive/issue_comments_412771.json:
```json
{
    "body": "Replying to [comment:17 jhpalmieri]:\n> Replying to [comment:16 fbissey]:\n> > Replying to [comment:14 mkoeppe]:\n> > > #25358 has a better fix for test_safe_directory\n> \n> If you want to try to revive that, you can.\n\nDone\n\n> It can be done on #25358, with this ticket as a prerequisite\n\nNo, present ticket depends on #25358",
    "created_at": "2020-03-22T23:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412771",
    "user": "mkoeppe"
}
```

Replying to [comment:17 jhpalmieri]:
> Replying to [comment:16 fbissey]:
> > Replying to [comment:14 mkoeppe]:
> > > #25358 has a better fix for test_safe_directory
> 
> If you want to try to revive that, you can.

Done

> It can be done on #25358, with this ticket as a prerequisite

No, present ticket depends on #25358



---

archive/issue_comments_412772.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-03-22T23:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412772",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_412773.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-22T23:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412773",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_412774.json:
```json
{
    "body": "For what it's worth I gave up on #25358 because jdmeyer had a pretty strong opinion on that. I'm not sure if that has changed. If it was up to me, I think I'd vote complete removal too. #25358 was intended as a compromise.",
    "created_at": "2020-03-22T23:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412774",
    "user": "@timokau"
}
```

For what it's worth I gave up on #25358 because jdmeyer had a pretty strong opinion on that. I'm not sure if that has changed. If it was up to me, I think I'd vote complete removal too. #25358 was intended as a compromise.



---

archive/issue_comments_412775.json:
```json
{
    "body": "If we want, we can of course keep *both* tests in #25358. Keeping py2 as \"secure\" as it was; and adding security to py3.",
    "created_at": "2020-03-22T23:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412775",
    "user": "mkoeppe"
}
```

If we want, we can of course keep *both* tests in #25358. Keeping py2 as "secure" as it was; and adding security to py3.



---

archive/issue_comments_412776.json:
```json
{
    "body": "We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?",
    "created_at": "2020-03-22T23:46:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412776",
    "user": "jhpalmieri"
}
```

We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?



---

archive/issue_comments_412777.json:
```json
{
    "body": "Replying to [comment:26 jhpalmieri]:\n> We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?\nRight, it would be purely decorative or for the hypothetical situation that someone decides to run sagelib with a patched python2.",
    "created_at": "2020-03-23T00:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412777",
    "user": "mkoeppe"
}
```

Replying to [comment:26 jhpalmieri]:
> We can't keep the secure py2 test if we're getting rid of the patch, or am I misunderstanding you?
Right, it would be purely decorative or for the hypothetical situation that someone decides to run sagelib with a patched python2.



---

archive/issue_comments_412778.json:
```json
{
    "body": "Testing this branch at https://github.com/mkoeppe/sage/actions/runs/61077298\n(on top of other tickets)",
    "created_at": "2020-03-23T00:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412778",
    "user": "mkoeppe"
}
```

Testing this branch at https://github.com/mkoeppe/sage/actions/runs/61077298
(on top of other tickets)



---

archive/issue_comments_412779.json:
```json
{
    "body": "This passes tests for me on OS X with builds based on Python 2 and Python 3.",
    "created_at": "2020-03-23T04:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412779",
    "user": "jhpalmieri"
}
```

This passes tests for me on OS X with builds based on Python 2 and Python 3.



---

archive/issue_comments_412780.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-24T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412780",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_412781.json:
```json
{
    "body": "lgtm",
    "created_at": "2020-03-24T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412781",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_412782.json:
```json
{
    "body": "Thanks",
    "created_at": "2020-03-24T16:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412782",
    "user": "mkoeppe"
}
```

Thanks



---

archive/issue_comments_412783.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-29T00:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29157#issuecomment-412783",
    "user": "vbraun"
}
```

Resolution: fixed
