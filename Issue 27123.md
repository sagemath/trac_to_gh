# Issue 27123: upgrade eclib to v20190226

archive/issues_027123.json:
```json
{
    "body": "CC:  @slel @kiwifb @timokau\n\nKeywords: eclib, upgrade\n\nRelease v20170815 introduced a modular symbol scaling bug (while sorting out modular symbol scaling essentially correctly) in functions not currently used by Sage.  Other releases since the current one in Sage (v20180815) make some interface changes including precision handling (now using bits not digits), so some Sage code changes are likely to be necessary.\n\nUpdated source: http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/eclib-20190226.tar.bz2\n\nIssue created by migration from https://trac.sagemath.org/ticket/27360\n\n",
    "closed_at": "2019-03-13T18:29:33Z",
    "created_at": "2019-02-26T11:10:16Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "upgrade eclib to v20190226",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27123",
    "user": "https://github.com/JohnCremona"
}
```
CC:  @slel @kiwifb @timokau

Keywords: eclib, upgrade

Release v20170815 introduced a modular symbol scaling bug (while sorting out modular symbol scaling essentially correctly) in functions not currently used by Sage.  Other releases since the current one in Sage (v20180815) make some interface changes including precision handling (now using bits not digits), so some Sage code changes are likely to be necessary.

Updated source: http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/eclib-20190226.tar.bz2

Issue created by migration from https://trac.sagemath.org/ticket/27360





---

archive/issue_comments_381562.json:
```json
{
    "body": "Changing keywords from \"eclib\" to \"eclib, upgrade\".",
    "created_at": "2019-02-26T13:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381562",
    "user": "https://github.com/slel"
}
```

Changing keywords from "eclib" to "eclib, upgrade".



---

archive/issue_comments_381563.json:
```json
{
    "body": "Thanks for adding the new keyword.  I have built 8.7.beta5 and am starting to test.",
    "created_at": "2019-02-26T14:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381563",
    "user": "https://github.com/JohnCremona"
}
```

Thanks for adding the new keyword.  I have built 8.7.beta5 and am starting to test.



---

archive/issue_comments_381564.json:
```json
{
    "body": "The current tarball's configure script sets compiler flags which result in code requiring an optional FLINT module which Sage's FLINT does not have, which I have on my own machine and always forget to remove for Sage.  I will replace it.  (The module is hmod_mat which allows for linear algebra mod p using 32-bit integers.)",
    "created_at": "2019-02-26T14:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381564",
    "user": "https://github.com/JohnCremona"
}
```

The current tarball's configure script sets compiler flags which result in code requiring an optional FLINT module which Sage's FLINT does not have, which I have on my own machine and always forget to remove for Sage.  I will replace it.  (The module is hmod_mat which allows for linear algebra mod p using 32-bit integers.)



---

archive/issue_comments_381565.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-27T10:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381565",
    "user": "https://github.com/JohnCremona"
}
```

New commits:



---

archive/issue_comments_381566.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-27T10:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381566",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_381567.json:
```json
{
    "body": "I did the testing on a python3 build of Sage.",
    "created_at": "2019-02-27T10:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381567",
    "user": "https://github.com/JohnCremona"
}
```

I did the testing on a python3 build of Sage.



---

archive/issue_comments_381568.json:
```json
{
    "body": "Typo: `procision`",
    "created_at": "2019-02-27T10:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381568",
    "user": "https://github.com/jdemeyer"
}
```

Typo: `procision`



---

archive/issue_comments_381569.json:
```json
{
    "body": "Replying to [comment:6 cremona]:\n> I did the testing on a python3 build of Sage.\n\n\nThat is what I thought but it seems that the steps make distclean; make build took me back to python2 (where all is well with the patch uploaded).\n\nI will build the branch from scratch again, this time making sure it is python3.",
    "created_at": "2019-02-27T15:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381569",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:6 cremona]:
> I did the testing on a python3 build of Sage.


That is what I thought but it seems that the steps make distclean; make build took me back to python2 (where all is well with the patch uploaded).

I will build the branch from scratch again, this time making sure it is python3.



---

archive/issue_comments_381570.json:
```json
{
    "body": "Replying to [comment:9 cremona]:\n> make distclean [..] took me back to python2\n\n\nIndeed. `make distclean` is meant to remove everything, including output generated by `./configure` indicating that you wanted a Python 3 build.",
    "created_at": "2019-02-27T15:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381570",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 cremona]:
> make distclean [..] took me back to python2


Indeed. `make distclean` is meant to remove everything, including output generated by `./configure` indicating that you wanted a Python 3 build.



---

archive/issue_comments_381571.json:
```json
{
    "body": "Thanks -- I misunderstood Vincent's recent instructions on sage-devel.  So now the situation is that this branch works fine under python2 but not under python3 where the output buffering issue arises.  To be clear: after switching to this commit and putting the new source tarball into upstream/ I do\n\n```\nmake distclean\n./configure --with-python=3\nMAKE='make -j20' make\n./sage -t src/sage/libs/eclib\n```\nand see doctest failures in 2 files all of which (by eye) are caused by output buffering.\n\nThe same happens on a different machine and a python3 build of vanilla 8.7.beta5 so this issue is *not* related to the eclib upgrade at all.  For that reason it might be better to open a new ticket for it, and not hold up this one.",
    "created_at": "2019-02-27T16:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381571",
    "user": "https://github.com/JohnCremona"
}
```

Thanks -- I misunderstood Vincent's recent instructions on sage-devel.  So now the situation is that this branch works fine under python2 but not under python3 where the output buffering issue arises.  To be clear: after switching to this commit and putting the new source tarball into upstream/ I do

```
make distclean
./configure --with-python=3
MAKE='make -j20' make
./sage -t src/sage/libs/eclib
```
and see doctest failures in 2 files all of which (by eye) are caused by output buffering.

The same happens on a different machine and a python3 build of vanilla 8.7.beta5 so this issue is *not* related to the eclib upgrade at all.  For that reason it might be better to open a new ticket for it, and not hold up this one.



---

archive/issue_comments_381572.json:
```json
{
    "body": "As a *proof* that this is the issue, after\n\n```\n export PYTHONUNBUFFERED=1\n```\nthe test\n\n```\n./sage -t src/sage/libs/eclib\n```\nruns fine.  I suppose that we do not want to turn off all python output buffering always?",
    "created_at": "2019-02-27T16:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381572",
    "user": "https://github.com/JohnCremona"
}
```

As a *proof* that this is the issue, after

```
 export PYTHONUNBUFFERED=1
```
the test

```
./sage -t src/sage/libs/eclib
```
runs fine.  I suppose that we do not want to turn off all python output buffering always?



---

archive/issue_comments_381573.json:
```json
{
    "body": "The last comment is surprising to me... how would disabling *Python* buffering fix buffering issues in *eclib*?",
    "created_at": "2019-02-28T06:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381573",
    "user": "https://github.com/jdemeyer"
}
```

The last comment is surprising to me... how would disabling *Python* buffering fix buffering issues in *eclib*?



---

archive/issue_comments_381574.json:
```json
{
    "body": "Minor nitpick, but why this change?\n\n```diff\n-    r\"\"\"\n-    Set the global NTL real number precision.  This has a massive\n+    r\"\"\" Set the global NTL real number bit precision.  This has a massive\n```\nI don't know if it's right or wrong to format docstrings like that, but in any case this seems to go against the typical Sage docstring style. And if you really insist on starting the text on the line with the `\"\"\"` I would at least remove the leading space before `Set the`.",
    "created_at": "2019-02-28T08:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381574",
    "user": "https://github.com/jdemeyer"
}
```

Minor nitpick, but why this change?

```diff
-    r"""
-    Set the global NTL real number precision.  This has a massive
+    r""" Set the global NTL real number bit precision.  This has a massive
```
I don't know if it's right or wrong to format docstrings like that, but in any case this seems to go against the typical Sage docstring style. And if you really insist on starting the text on the line with the `"""` I would at least remove the leading space before `Set the`.



---

archive/issue_comments_381575.json:
```json
{
    "body": "Is `-DNTL_ALL` now superfluous? If so, you could remove the line\n\n```\n# distutils: extra_compile_args = -DNTL_ALL\n```\nfrom `src/sage/libs/eclib/__init__.pxd`",
    "created_at": "2019-02-28T09:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381575",
    "user": "https://github.com/jdemeyer"
}
```

Is `-DNTL_ALL` now superfluous? If so, you could remove the line

```
# distutils: extra_compile_args = -DNTL_ALL
```
from `src/sage/libs/eclib/__init__.pxd`



---

archive/issue_comments_381576.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> The last comment is surprising to me... how would disabling *Python* buffering fix buffering issues in *eclib*?\n\n\nWell if you ignore my \"proof\" remark it seems to be a fact that setting that environment variable fixes the issue.  Nothing has changed in eclib regarding buffering.\n\nOne fix would be to make changes in the Sage interface so that whenever an eclib function is called which outputs to stdout, the python stdout is flushed first.  It would be possible to add flushing functions in eclib itself but that does not seem the right approach to me.",
    "created_at": "2019-02-28T09:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381576",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:13 jdemeyer]:
> The last comment is surprising to me... how would disabling *Python* buffering fix buffering issues in *eclib*?


Well if you ignore my "proof" remark it seems to be a fact that setting that environment variable fixes the issue.  Nothing has changed in eclib regarding buffering.

One fix would be to make changes in the Sage interface so that whenever an eclib function is called which outputs to stdout, the python stdout is flushed first.  It would be possible to add flushing functions in eclib itself but that does not seem the right approach to me.



---

archive/issue_comments_381577.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Is `-DNTL_ALL` now superfluous? If so, you could remove the line\n> \n> ```\n> # distutils: extra_compile_args = -DNTL_ALL\n> ```\n> from `src/sage/libs/eclib/__init__.pxd`\n\n\nYou are right, and I will remove that line.",
    "created_at": "2019-02-28T09:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381577",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:15 jdemeyer]:
> Is `-DNTL_ALL` now superfluous? If so, you could remove the line
> 
> ```
> # distutils: extra_compile_args = -DNTL_ALL
> ```
> from `src/sage/libs/eclib/__init__.pxd`


You are right, and I will remove that line.



---

archive/issue_comments_381578.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Minor nitpick, but why this change?\n> \n> ```diff\n> -    r\"\"\"\n> -    Set the global NTL real number precision.  This has a massive\n> +    r\"\"\" Set the global NTL real number bit precision.  This has a massive\n> ```\n> I don't know if it's right or wrong to format docstrings like that, but in any case this seems to go against the typical Sage docstring style. And if you really insist on starting the text on the line with the `\"\"\"` I would at least remove the leading space before `Set the`.\n\n\nSorry that is an artefact introduced by emacs python mode which I usually change back manually.  I'll do that.",
    "created_at": "2019-02-28T09:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381578",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:14 jdemeyer]:
> Minor nitpick, but why this change?
> 
> ```diff
> -    r"""
> -    Set the global NTL real number precision.  This has a massive
> +    r""" Set the global NTL real number bit precision.  This has a massive
> ```
> I don't know if it's right or wrong to format docstrings like that, but in any case this seems to go against the typical Sage docstring style. And if you really insist on starting the text on the line with the `"""` I would at least remove the leading space before `Set the`.


Sorry that is an artefact introduced by emacs python mode which I usually change back manually.  I'll do that.



---

archive/issue_comments_381579.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-28T09:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381580.json:
```json
{
    "body": "I created #27383 for the buffering issues.",
    "created_at": "2019-02-28T09:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381580",
    "user": "https://github.com/jdemeyer"
}
```

I created #27383 for the buffering issues.



---

archive/issue_comments_381581.json:
```json
{
    "body": "There is still `procision`",
    "created_at": "2019-02-28T09:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381581",
    "user": "https://github.com/jdemeyer"
}
```

There is still `procision`



---

archive/issue_comments_381582.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-28T09:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381582",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381583.json:
```json
{
    "body": "Thanks -- I fixed the typo and assume that the buffering questions will be fixed in #27383.",
    "created_at": "2019-02-28T09:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381583",
    "user": "https://github.com/JohnCremona"
}
```

Thanks -- I fixed the typo and assume that the buffering questions will be fixed in #27383.



---

archive/issue_comments_381584.json:
```json
{
    "body": "I have no more comments on the branch, now testing...",
    "created_at": "2019-02-28T10:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381584",
    "user": "https://github.com/jdemeyer"
}
```

I have no more comments on the branch, now testing...



---

archive/issue_comments_381585.json:
```json
{
    "body": "On a 32-bit machine I get\n\n```\nsage -t --warn-long 43.4 src/sage/libs/eclib/mwrank.pyx\n**********************************************************************\nFile \"src/sage/libs/eclib/mwrank.pyx\", line 365, in sage.libs.eclib.mwrank._Curvedata.cps_bound\nFailed example:\n    E.cps_bound()\nExpected:\n    0.11912451909250964\nGot:\n    0.11912451909250982\n**********************************************************************\nFile \"src/sage/libs/eclib/mwrank.pyx\", line 404, in sage.libs.eclib.mwrank._Curvedata.height_constant\nFailed example:\n    E.height_constant()\nExpected:\n    0.11912451909250964\nGot:\n    0.11912451909250982\n**********************************************************************\nFile \"src/sage/libs/eclib/mwrank.pyx\", line 1344, in sage.libs.eclib.mwrank._two_descent.regulator\nFailed example:\n    D2.regulator()\nExpected:\n    0.41714355875838\nGot:\n    0.417143558758384\n**********************************************************************\n```\nand\n\n```\nsage -t --warn-long 43.4 src/sage/libs/eclib/interface.py\n**********************************************************************\nFile \"src/sage/libs/eclib/interface.py\", line 601, in sage.libs.eclib.interface.mwrank_EllipticCurve.regulator\nFailed example:\n    E.regulator()\nExpected:\n    0.051111408239969\nGot:\n    0.05111140823996884\n**********************************************************************\nFile \"src/sage/libs/eclib/interface.py\", line 1083, in sage.libs.eclib.interface.mwrank_MordellWeil.regulator\nFailed example:\n    E.regulator()\nExpected:\n    0.41714355875838\nGot:\n    0.417143558758384\n**********************************************************************\n```",
    "created_at": "2019-02-28T15:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381585",
    "user": "https://github.com/jdemeyer"
}
```

On a 32-bit machine I get

```
sage -t --warn-long 43.4 src/sage/libs/eclib/mwrank.pyx
**********************************************************************
File "src/sage/libs/eclib/mwrank.pyx", line 365, in sage.libs.eclib.mwrank._Curvedata.cps_bound
Failed example:
    E.cps_bound()
Expected:
    0.11912451909250964
Got:
    0.11912451909250982
**********************************************************************
File "src/sage/libs/eclib/mwrank.pyx", line 404, in sage.libs.eclib.mwrank._Curvedata.height_constant
Failed example:
    E.height_constant()
Expected:
    0.11912451909250964
Got:
    0.11912451909250982
**********************************************************************
File "src/sage/libs/eclib/mwrank.pyx", line 1344, in sage.libs.eclib.mwrank._two_descent.regulator
Failed example:
    D2.regulator()
Expected:
    0.41714355875838
Got:
    0.417143558758384
**********************************************************************
```
and

```
sage -t --warn-long 43.4 src/sage/libs/eclib/interface.py
**********************************************************************
File "src/sage/libs/eclib/interface.py", line 601, in sage.libs.eclib.interface.mwrank_EllipticCurve.regulator
Failed example:
    E.regulator()
Expected:
    0.051111408239969
Got:
    0.05111140823996884
**********************************************************************
File "src/sage/libs/eclib/interface.py", line 1083, in sage.libs.eclib.interface.mwrank_MordellWeil.regulator
Failed example:
    E.regulator()
Expected:
    0.41714355875838
Got:
    0.417143558758384
**********************************************************************
```



---

archive/issue_comments_381586.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-28T15:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381586",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_381587.json:
```json
{
    "body": "Oh misery.  I don't have a 32-bit machine to test on.  But I also have no idea why there should be any difference.  I don't think I have ever before had to deal with 32/64-bit issues with eclib in Sage.  Sage uses NTL floating point (which used to require siwtching on with the NTL_ALL flag but now is on by default) and that is 32/64-independent.",
    "created_at": "2019-02-28T16:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381587",
    "user": "https://github.com/JohnCremona"
}
```

Oh misery.  I don't have a 32-bit machine to test on.  But I also have no idea why there should be any difference.  I don't think I have ever before had to deal with 32/64-bit issues with eclib in Sage.  Sage uses NTL floating point (which used to require siwtching on with the NTL_ALL flag but now is on by default) and that is 32/64-independent.



---

archive/issue_comments_381588.json:
```json
{
    "body": "Could there be a problem with the precision handling? I made this change:\n\n```diff\ndiff --git a/src/sage/libs/eclib/wrap.cpp b/src/sage/libs/eclib/wrap.cpp\nindex de70e6b..88fcebe 100644\n--- a/src/sage/libs/eclib/wrap.cpp\n+++ b/src/sage/libs/eclib/wrap.cpp\n@@ -250,5 +250,7 @@ char* two_descent_regulator(struct two_descent* t)\n   bigfloat reg = t->regulator();\n   ostringstream instore;\n   instore << reg;\n-  return stringstream_to_char(instore);\n+  char *ptr = stringstream_to_char(instore);\n+  printf(\"two_descent_regulator(): %s\\n\", ptr);\n+  return ptr;\n }\n```\nto debug the `bigfloat` object `t->regulator()`.\n\nOn 64-bit, I get\n\n```\nsage: E = mwrank_EllipticCurve([0, 0, 1, -1, 0]); E.regulator()\ntwo_descent_regulator(): 0.051111408239968840235886099756942021609538202280852964249242761521097051665601926126276280166145013158726830156913137573334269246681032033729207105828\n0.05111140823996884\n```\n\nOn 32-bit, I get\n\n```\nsage: E = mwrank_EllipticCurve([0, 0, 1, -1, 0]); E.regulator()\ntwo_descent_regulator(): 0.0511114082399688402358860997569420216095382\n0.05111140823996884\n```",
    "created_at": "2019-02-28T22:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381588",
    "user": "https://github.com/jdemeyer"
}
```

Could there be a problem with the precision handling? I made this change:

```diff
diff --git a/src/sage/libs/eclib/wrap.cpp b/src/sage/libs/eclib/wrap.cpp
index de70e6b..88fcebe 100644
--- a/src/sage/libs/eclib/wrap.cpp
+++ b/src/sage/libs/eclib/wrap.cpp
@@ -250,5 +250,7 @@ char* two_descent_regulator(struct two_descent* t)
   bigfloat reg = t->regulator();
   ostringstream instore;
   instore << reg;
-  return stringstream_to_char(instore);
+  char *ptr = stringstream_to_char(instore);
+  printf("two_descent_regulator(): %s\n", ptr);
+  return ptr;
 }
```
to debug the `bigfloat` object `t->regulator()`.

On 64-bit, I get

```
sage: E = mwrank_EllipticCurve([0, 0, 1, -1, 0]); E.regulator()
two_descent_regulator(): 0.051111408239968840235886099756942021609538202280852964249242761521097051665601926126276280166145013158726830156913137573334269246681032033729207105828
0.05111140823996884
```

On 32-bit, I get

```
sage: E = mwrank_EllipticCurve([0, 0, 1, -1, 0]); E.regulator()
two_descent_regulator(): 0.0511114082399688402358860997569420216095382
0.05111140823996884
```



---

archive/issue_comments_381589.json:
```json
{
    "body": "I applied this patch to debug:\n\n```diff\ndiff --git a/src/sage/libs/eclib/wrap.cpp b/src/sage/libs/eclib/wrap.cpp\nindex de70e6b..74d92a4 100644\n--- a/src/sage/libs/eclib/wrap.cpp\n+++ b/src/sage/libs/eclib/wrap.cpp\n@@ -250,5 +250,7 @@ char* two_descent_regulator(struct two_descent* t)\n   bigfloat reg = t->regulator();\n   ostringstream instore;\n   instore << reg;\n-  return stringstream_to_char(instore);\n+  char *ptr = stringstream_to_char(instore);\n+  printf(\"two_descent_regulator():\\n%s\\nprecision = %ld\\nas double = %a\\n\", ptr, reg.precision(), to_double(reg));\n+  return ptr;\n }\n```\n\nWhat I see when I run the doctests on 64-bit:\n\n```\nsage -t src/sage/libs/eclib/interface.py                                                                                                                                \n**********************************************************************\nFile \"src/sage/libs/eclib/interface.py\", line 601, in sage.libs.eclib.interface.mwrank_EllipticCurve.regulator\nFailed example:\n    E.regulator()\nExpected:\n    0.051111408239969\nGot:\n    two_descent_regulator():\n    0.051111408239969\n    precision = 53\n    as double = 0x1.a2b4645afb41dp-5\n    0.051111408239969\n**********************************************************************\n```\nSo the precision is only 53 bits here. So one of the tests preceding it apparently changes the precision from 150 to 53.",
    "created_at": "2019-03-01T09:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381589",
    "user": "https://github.com/jdemeyer"
}
```

I applied this patch to debug:

```diff
diff --git a/src/sage/libs/eclib/wrap.cpp b/src/sage/libs/eclib/wrap.cpp
index de70e6b..74d92a4 100644
--- a/src/sage/libs/eclib/wrap.cpp
+++ b/src/sage/libs/eclib/wrap.cpp
@@ -250,5 +250,7 @@ char* two_descent_regulator(struct two_descent* t)
   bigfloat reg = t->regulator();
   ostringstream instore;
   instore << reg;
-  return stringstream_to_char(instore);
+  char *ptr = stringstream_to_char(instore);
+  printf("two_descent_regulator():\n%s\nprecision = %ld\nas double = %a\n", ptr, reg.precision(), to_double(reg));
+  return ptr;
 }
```

What I see when I run the doctests on 64-bit:

```
sage -t src/sage/libs/eclib/interface.py                                                                                                                                
**********************************************************************
File "src/sage/libs/eclib/interface.py", line 601, in sage.libs.eclib.interface.mwrank_EllipticCurve.regulator
Failed example:
    E.regulator()
Expected:
    0.051111408239969
Got:
    two_descent_regulator():
    0.051111408239969
    precision = 53
    as double = 0x1.a2b4645afb41dp-5
    0.051111408239969
**********************************************************************
```
So the precision is only 53 bits here. So one of the tests preceding it apparently changes the precision from 150 to 53.



---

archive/issue_comments_381590.json:
```json
{
    "body": "Another obvious thing to ask is why does the eclib interface uses strings for conversion? For the regulator, an NTL `RR` is converted to a string and then to a Python `float`. It would be more efficient and more reliable to use the NTL conversion function `to_double`.\n\n(Edit: I don't think that it would fix the doctest failures, it's just something that I saw while reading the code)",
    "created_at": "2019-03-01T09:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381590",
    "user": "https://github.com/jdemeyer"
}
```

Another obvious thing to ask is why does the eclib interface uses strings for conversion? For the regulator, an NTL `RR` is converted to a string and then to a Python `float`. It would be more efficient and more reliable to use the NTL conversion function `to_double`.

(Edit: I don't think that it would fix the doctest failures, it's just something that I saw while reading the code)



---

archive/issue_comments_381591.json:
```json
{
    "body": "The problem is obvious: you have a doctest `sage: mwrank_set_precision(50)` which means that all following doctests are run with a precision much lower than default.",
    "created_at": "2019-03-01T09:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381591",
    "user": "https://github.com/jdemeyer"
}
```

The problem is obvious: you have a doctest `sage: mwrank_set_precision(50)` which means that all following doctests are run with a precision much lower than default.



---

archive/issue_comments_381592.json:
```json
{
    "body": "Replying to [comment:29 jdemeyer]:\n> Another obvious thing to ask is why does the eclib interface uses strings for conversion? For the regulator, an NTL `RR` is converted to a string and then to a Python `float`. It would be more efficient and more reliable to use the NTL conversion function `to_double`.\n\n\nI agree.  I didn't write the wrapping code -- I have only tweaked it so take changes to eclib into account.\n\nDo you know how to convert an NTL RR into an element of RealField() or some other Sage real type?\n\n> \n> (Edit: I don't think that it would fix the doctest failures, it's just something that I saw while reading the code)",
    "created_at": "2019-03-01T10:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381592",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:29 jdemeyer]:
> Another obvious thing to ask is why does the eclib interface uses strings for conversion? For the regulator, an NTL `RR` is converted to a string and then to a Python `float`. It would be more efficient and more reliable to use the NTL conversion function `to_double`.


I agree.  I didn't write the wrapping code -- I have only tweaked it so take changes to eclib into account.

Do you know how to convert an NTL RR into an element of RealField() or some other Sage real type?

> 
> (Edit: I don't think that it would fix the doctest failures, it's just something that I saw while reading the code)



---

archive/issue_comments_381593.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> The problem is obvious: you have a doctest `sage: mwrank_set_precision(50)` which means that all following doctests are run with a precision much lower than default.\n\n\nOf course, how stupid.  This hardly needs a doctest; it would be silly to use the default here;  perhaps the doctest should be expanded to save the current precision, set it to a new value and then rest it.  I will do that.",
    "created_at": "2019-03-01T10:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381593",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:30 jdemeyer]:
> The problem is obvious: you have a doctest `sage: mwrank_set_precision(50)` which means that all following doctests are run with a precision much lower than default.


Of course, how stupid.  This hardly needs a doctest; it would be silly to use the default here;  perhaps the doctest should be expanded to save the current precision, set it to a new value and then rest it.  I will do that.



---

archive/issue_comments_381594.json:
```json
{
    "body": "`@`jdemeyer: after editing the file wrap.cpp what exactly needs to be done to rebuild sage?  I have the impression that neither \"sage -b\" nor \"make\" caused that file to be recompiled when it changed.",
    "created_at": "2019-03-01T10:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381594",
    "user": "https://github.com/JohnCremona"
}
```

`@`jdemeyer: after editing the file wrap.cpp what exactly needs to be done to rebuild sage?  I have the impression that neither "sage -b" nor "make" caused that file to be recompiled when it changed.



---

archive/issue_comments_381595.json:
```json
{
    "body": "Yes, I noticed that too and created a new ticket #27389. To solve this problem concretely, remove all copies of `wrap.cpp` in the `src/build` directory and try again.",
    "created_at": "2019-03-01T10:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381595",
    "user": "https://github.com/jdemeyer"
}
```

Yes, I noticed that too and created a new ticket #27389. To solve this problem concretely, remove all copies of `wrap.cpp` in the `src/build` directory and try again.



---

archive/issue_comments_381596.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> Yes, I noticed that too and created a new ticket #27389. To solve this problem concretely, remove all copies of `wrap.cpp` in the `src/build` directory and try again.\n\n\nThanks for that tip.",
    "created_at": "2019-03-01T10:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381596",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:34 jdemeyer]:
> Yes, I noticed that too and created a new ticket #27389. To solve this problem concretely, remove all copies of `wrap.cpp` in the `src/build` directory and try again.


Thanks for that tip.



---

archive/issue_comments_381597.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-01T14:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381598.json:
```json
{
    "body": "The latest commit d63916a address some of the issues discovered.\n1. By adding a couple of \"cou<<flush;\" statememts in the c++ wrapper file wrap.cpp I think I have dealt with that problem under python3.  At the same time I deleted some flushing which was there already but redundant.  The result works fine in python3.\n2. Fixed an interface bug where I called eclib's set_precision() instead of set_bit_precision.  The former still takes a decimal precision input.\n3. Fixed a doctesting bug where one test left the preciaion at a different value than the usual default.\n4. Avoid converting an NTL:RR to a float via strings by using iNTL's to_double() as suggested, returning a double.\n\nAll that left a lot of computed number ending in some different digits.  I fixed those doctests in the stupid way, i.e. changing the expected digits to what I now get.  But I only tested on a 64-bit machine.  If there are problems on 32-bit I will probably get around that by replacing some trailing digits by \"...\".\n\nPutting this back to \"needs review\", and the testing and debugging help already received are much appreciated.",
    "created_at": "2019-03-01T14:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381598",
    "user": "https://github.com/JohnCremona"
}
```

The latest commit d63916a address some of the issues discovered.
1. By adding a couple of "cou<<flush;" statememts in the c++ wrapper file wrap.cpp I think I have dealt with that problem under python3.  At the same time I deleted some flushing which was there already but redundant.  The result works fine in python3.
2. Fixed an interface bug where I called eclib's set_precision() instead of set_bit_precision.  The former still takes a decimal precision input.
3. Fixed a doctesting bug where one test left the preciaion at a different value than the usual default.
4. Avoid converting an NTL:RR to a float via strings by using iNTL's to_double() as suggested, returning a double.

All that left a lot of computed number ending in some different digits.  I fixed those doctests in the stupid way, i.e. changing the expected digits to what I now get.  But I only tested on a 64-bit machine.  If there are problems on 32-bit I will probably get around that by replacing some trailing digits by "...".

Putting this back to "needs review", and the testing and debugging help already received are much appreciated.



---

archive/issue_comments_381599.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-01T14:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381599",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_381600.json:
```json
{
    "body": "There is still a `mwrank_set_precision(50)` doctest in `src/sage/libs/eclib/interface.py`, shouldn't that be fixed too?",
    "created_at": "2019-03-01T14:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381600",
    "user": "https://github.com/jdemeyer"
}
```

There is still a `mwrank_set_precision(50)` doctest in `src/sage/libs/eclib/interface.py`, shouldn't that be fixed too?



---

archive/issue_comments_381601.json:
```json
{
    "body": "Replying to [comment:37 cremona]:\n> At the same time I deleted some flushing which was there already but redundant.\n\n\nAs explained in #27383, it's flushing the wrong buffers anyway (the Python buffers, not the C buffers used by eclib).",
    "created_at": "2019-03-01T15:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381601",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 cremona]:
> At the same time I deleted some flushing which was there already but redundant.


As explained in #27383, it's flushing the wrong buffers anyway (the Python buffers, not the C buffers used by eclib).



---

archive/issue_comments_381602.json:
```json
{
    "body": "Speaking of getting/setting precision, I wonder why there are `get_precision` and `set_precision` functions in both `src/sage/libs/eclib/mwrank.pyx` and `src/sage/libs/eclib/interface.py`. There is probably a historical reason for this, but it's confusing.\n\nI suggest to remove the `get_precision` and `set_precision` functions from `src/sage/libs/eclib/interface.py` and then adjust the imports in `src/sage/libs/eclib/all.py`.\n\nNote that the docstring for these functions in `src/sage/libs/eclib/mwrank.pyx` and `src/sage/libs/eclib/interface.py` are different, so they should be merged.",
    "created_at": "2019-03-01T15:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381602",
    "user": "https://github.com/jdemeyer"
}
```

Speaking of getting/setting precision, I wonder why there are `get_precision` and `set_precision` functions in both `src/sage/libs/eclib/mwrank.pyx` and `src/sage/libs/eclib/interface.py`. There is probably a historical reason for this, but it's confusing.

I suggest to remove the `get_precision` and `set_precision` functions from `src/sage/libs/eclib/interface.py` and then adjust the imports in `src/sage/libs/eclib/all.py`.

Note that the docstring for these functions in `src/sage/libs/eclib/mwrank.pyx` and `src/sage/libs/eclib/interface.py` are different, so they should be merged.



---

archive/issue_comments_381603.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-01T15:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381603",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_381604.json:
```json
{
    "body": "I'll fix this.",
    "created_at": "2019-03-04T09:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381604",
    "user": "https://github.com/jdemeyer"
}
```

I'll fix this.



---

archive/issue_comments_381605.json:
```json
{
    "body": "Replying to [comment:42 jdemeyer]:\n> I'll fix this.\n\n\nThanks -- but I also could do it.\n\nThe eclib wrapping happened in 2007 or 2006, by William --I made many changes to eclib at the time to make an interface even possible, but did not do the wrapping as at that time I had never written a single line of python.  After that William often suggested that it needed to be redone from scratch but the intersection of people who had the expertise to do that was always empty.",
    "created_at": "2019-03-04T09:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381605",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:42 jdemeyer]:
> I'll fix this.


Thanks -- but I also could do it.

The eclib wrapping happened in 2007 or 2006, by William --I made many changes to eclib at the time to make an interface even possible, but did not do the wrapping as at that time I had never written a single line of python.  After that William often suggested that it needed to be redone from scratch but the intersection of people who had the expertise to do that was always empty.



---

archive/issue_comments_381606.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-04T09:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381606",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381607.json:
```json
{
    "body": "Rebased to 8.7.beta6 and partially squashed. The last 4 commits are by me and fix various minor things. Each of these commits is more or less independent.",
    "created_at": "2019-03-04T09:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381607",
    "user": "https://github.com/jdemeyer"
}
```

Rebased to 8.7.beta6 and partially squashed. The last 4 commits are by me and fix various minor things. Each of these commits is more or less independent.



---

archive/issue_comments_381608.json:
```json
{
    "body": "Thanks.  The diffs look good and I will do my own testing once the rebuild is done.  As soon as we are both happy I think we can set this to Positive Review though I do not know what the strange colour of the patchbot icon means.",
    "created_at": "2019-03-04T11:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381608",
    "user": "https://github.com/JohnCremona"
}
```

Thanks.  The diffs look good and I will do my own testing once the rebuild is done.  As soon as we are both happy I think we can set this to Positive Review though I do not know what the strange colour of the patchbot icon means.



---

archive/issue_comments_381609.json:
```json
{
    "body": "Replying to [comment:48 cremona]:\n> I do not know what the strange colour of the patchbot icon means.\n\n\nThat it's a package upgrade and the patchbot doesn't (or can't) know how to deal with those.",
    "created_at": "2019-03-04T11:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381609",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:48 cremona]:
> I do not know what the strange colour of the patchbot icon means.


That it's a package upgrade and the patchbot doesn't (or can't) know how to deal with those.



---

archive/issue_comments_381610.json:
```json
{
    "body": "This passes all tests in `src/sage/libs/eclib/` and `src/sage/schemes/elliptic_curves/` both on 32-bit and 64-bit Linux.",
    "created_at": "2019-03-04T11:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381610",
    "user": "https://github.com/jdemeyer"
}
```

This passes all tests in `src/sage/libs/eclib/` and `src/sage/schemes/elliptic_curves/` both on 32-bit and 64-bit Linux.



---

archive/issue_comments_381611.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-04T11:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381611",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_381612.json:
```json
{
    "body": "When I test this on a python3 build, then there are some doctest failures in elliptic_curves most of which are unrelated unresolved python3 things, except perhaps one in height.py:\n\n```\nFile \"src/sage/schemes/elliptic_curves/height.py\", line 1934, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.min_gr\nFailed example:\n    H.min_gr(.1,5,True) # long time (~22s)\nExpected:\n    B_1(1) = 1540.199246369678\n    ...\n    halving mu to 0.25 and increasing n_max to 6\n    ...\n    halving mu to 0.001953125 and increasing n_max to 13\n    doubling mu to 0.0078125\n    doubling mu to 0.015625\n    height bound in [0.0078125, 0.015625] using n_max = 13\n    ...\n    height bound in [0.0120485220735, 0.0131390064883] using n_max = 13\n    0.012048522073499539\nGot:\n    B_1(1) = 1540.199246369678\n    B_2(1) = 621360.723701339\n    B_3(1) = 13686380726.84389\n    B_4(1) = 1.6459300096812694e+16\n    B_5(1) = 4.322868545515137e+22\n    halving mu to 0.25 and increasing n_max to 6\n    halving mu to 0.125 and increasing n_max to 7\n    halving mu to 0.0625 and increasing n_max to 8\n    halving mu to 0.03125 and increasing n_max to 9\n    halving mu to 0.015625 and increasing n_max to 10\n    halving mu to 0.0078125 and increasing n_max to 11\n    halving mu to 0.00390625 and increasing n_max to 12\n    halving mu to 0.001953125 and increasing n_max to 13\n    doubling mu to 0.0078125\n    doubling mu to 0.015625\n    height bound in [0.0078125, 0.015625] using n_max = 13\n    height bound in [0.011048543456039806, 0.015625000000000003] using n_max = 13\n    height bound in [0.011048543456039806, 0.01313900648833929] using n_max = 13\n    height bound in [0.012048522073499539, 0.01313900648833929] using n_max = 13\n    0.012048522073499539\n**********************************************************************\n```\nwhere the penultimate line (only) is slightly different.  Did that test really pass for you?",
    "created_at": "2019-03-04T14:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381612",
    "user": "https://github.com/JohnCremona"
}
```

When I test this on a python3 build, then there are some doctest failures in elliptic_curves most of which are unrelated unresolved python3 things, except perhaps one in height.py:

```
File "src/sage/schemes/elliptic_curves/height.py", line 1934, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.min_gr
Failed example:
    H.min_gr(.1,5,True) # long time (~22s)
Expected:
    B_1(1) = 1540.199246369678
    ...
    halving mu to 0.25 and increasing n_max to 6
    ...
    halving mu to 0.001953125 and increasing n_max to 13
    doubling mu to 0.0078125
    doubling mu to 0.015625
    height bound in [0.0078125, 0.015625] using n_max = 13
    ...
    height bound in [0.0120485220735, 0.0131390064883] using n_max = 13
    0.012048522073499539
Got:
    B_1(1) = 1540.199246369678
    B_2(1) = 621360.723701339
    B_3(1) = 13686380726.84389
    B_4(1) = 1.6459300096812694e+16
    B_5(1) = 4.322868545515137e+22
    halving mu to 0.25 and increasing n_max to 6
    halving mu to 0.125 and increasing n_max to 7
    halving mu to 0.0625 and increasing n_max to 8
    halving mu to 0.03125 and increasing n_max to 9
    halving mu to 0.015625 and increasing n_max to 10
    halving mu to 0.0078125 and increasing n_max to 11
    halving mu to 0.00390625 and increasing n_max to 12
    halving mu to 0.001953125 and increasing n_max to 13
    doubling mu to 0.0078125
    doubling mu to 0.015625
    height bound in [0.0078125, 0.015625] using n_max = 13
    height bound in [0.011048543456039806, 0.015625000000000003] using n_max = 13
    height bound in [0.011048543456039806, 0.01313900648833929] using n_max = 13
    height bound in [0.012048522073499539, 0.01313900648833929] using n_max = 13
    0.012048522073499539
**********************************************************************
```
where the penultimate line (only) is slightly different.  Did that test really pass for you?



---

archive/issue_comments_381613.json:
```json
{
    "body": "I tested Python 2, not Python 3. Did you test both Python 2 and Python 3 or only Python 3?\n\nI would find it quite surprising that you get different numerical noise on Python 3 compared to Python 2. More likely, it depends on the machine and not on the Python version.",
    "created_at": "2019-03-04T14:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381613",
    "user": "https://github.com/jdemeyer"
}
```

I tested Python 2, not Python 3. Did you test both Python 2 and Python 3 or only Python 3?

I would find it quite surprising that you get different numerical noise on Python 3 compared to Python 2. More likely, it depends on the machine and not on the Python version.



---

archive/issue_comments_381614.json:
```json
{
    "body": "Replying to [comment:53 jdemeyer]:\n> I tested Python 2, not Python 3. Did you test both Python 2 and Python 3 or only Python 3?\n\n\nOnly Python 3\n\n> \n> I would find it quite surprising that you get different numerical noise on Python 3 compared to Python 2. More likely, it depends on the machine and not on the Python version.\n\n\nMe too.  The only numerical computation with output other than halving or doubling is line 1975 of height.py where math.sqrt() is used on a float.  Perhaps mu and eps should be in RDF from the start, as the output is coerced in there at the end.  But this does not explain the discrepancy, it must be a machine difference.",
    "created_at": "2019-03-04T14:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381614",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:53 jdemeyer]:
> I tested Python 2, not Python 3. Did you test both Python 2 and Python 3 or only Python 3?


Only Python 3

> 
> I would find it quite surprising that you get different numerical noise on Python 3 compared to Python 2. More likely, it depends on the machine and not on the Python version.


Me too.  The only numerical computation with output other than halving or doubling is line 1975 of height.py where math.sqrt() is used on a float.  Perhaps mu and eps should be in RDF from the start, as the output is coerced in there at the end.  But this does not explain the discrepancy, it must be a machine difference.



---

archive/issue_comments_381615.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-11T06:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381615",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381616.json:
```json
{
    "body": "I tested this again (on x86_64 laptop with Sage 8.7.beta7 under Python 2) and all long tests in `src/sage/schemes/elliptic_curves/` do pass for me.",
    "created_at": "2019-03-11T07:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381616",
    "user": "https://github.com/jdemeyer"
}
```

I tested this again (on x86_64 laptop with Sage 8.7.beta7 under Python 2) and all long tests in `src/sage/schemes/elliptic_curves/` do pass for me.



---

archive/issue_comments_381617.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-11T08:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_381618.json:
```json
{
    "body": "This should work now.",
    "created_at": "2019-03-11T08:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381618",
    "user": "https://github.com/jdemeyer"
}
```

This should work now.



---

archive/issue_comments_381619.json:
```json
{
    "body": "What is the difference between  the commits in comment 56 and those in comment 45?",
    "created_at": "2019-03-11T09:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381619",
    "user": "https://github.com/JohnCremona"
}
```

What is the difference between  the commits in comment 56 and those in comment 45?



---

archive/issue_comments_381620.json:
```json
{
    "body": "Replying to [comment:60 cremona]:\n> What is the difference between  the commits in comment 56 and those in comment 45?\n\n\nI just rebased to 8.7.beta7 (which includes #27389)",
    "created_at": "2019-03-11T09:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381620",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:60 cremona]:
> What is the difference between  the commits in comment 56 and those in comment 45?


I just rebased to 8.7.beta7 (which includes #27389)



---

archive/issue_comments_381621.json:
```json
{
    "body": "So should I rebuild my python3 using your rebase and test again what I saw at comment 53?  Or should we leave this to be dealt with later when other python3 issues are finally fixed?",
    "created_at": "2019-03-11T10:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381621",
    "user": "https://github.com/JohnCremona"
}
```

So should I rebuild my python3 using your rebase and test again what I saw at comment 53?  Or should we leave this to be dealt with later when other python3 issues are finally fixed?



---

archive/issue_comments_381622.json:
```json
{
    "body": "I built and tested this on Python 3 myself. I can indeed reproduce the failure from [comment:52]. I'll try to figure out why it's happening, if only because I'm honestly curious.",
    "created_at": "2019-03-11T10:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381622",
    "user": "https://github.com/jdemeyer"
}
```

I built and tested this on Python 3 myself. I can indeed reproduce the failure from [comment:52]. I'll try to figure out why it's happening, if only because I'm honestly curious.



---

archive/issue_comments_381623.json:
```json
{
    "body": "OK, the difference between Python 2 and 3 is that the same numbers are *printed* differently. So this suggests a different fix: use `%r` which always print floats exactly.",
    "created_at": "2019-03-11T10:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381623",
    "user": "https://github.com/jdemeyer"
}
```

OK, the difference between Python 2 and 3 is that the same numbers are *printed* differently. So this suggests a different fix: use `%r` which always print floats exactly.



---

archive/issue_comments_381624.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-11T10:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381624",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_381625.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-11T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381626.json:
```json
{
    "body": "Well spotted, and thanks for fixing.  I'm still building the previous version but will continue.",
    "created_at": "2019-03-11T10:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381626",
    "user": "https://github.com/JohnCremona"
}
```

Well spotted, and thanks for fixing.  I'm still building the previous version but will continue.



---

archive/issue_comments_381627.json:
```json
{
    "body": "I made a few more minor fixes in that function, in particular replacing `/= 2` by `*= 0.5` (dividing an integer by an integer has different semantics in Python 3, so this might fix a not yet discovered Python 3 bug). I could have written `/= 2.0` but decided that the multiplication would be faster too (not that it matters here).",
    "created_at": "2019-03-11T10:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381627",
    "user": "https://github.com/jdemeyer"
}
```

I made a few more minor fixes in that function, in particular replacing `/= 2` by `*= 0.5` (dividing an integer by an integer has different semantics in Python 3, so this might fix a not yet discovered Python 3 bug). I could have written `/= 2.0` but decided that the multiplication would be faster too (not that it matters here).



---

archive/issue_comments_381628.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-11T10:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381628",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_381629.json:
```json
{
    "body": "When I pull your commit 901eaf8 on top of 8936611 I get a merge conflict in height.py.  That seems to be because the parent of your latest commit is not 8936611 but 3ff16c1.  Did you mean to get rid of commit 8936611?",
    "created_at": "2019-03-11T11:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381629",
    "user": "https://github.com/JohnCremona"
}
```

When I pull your commit 901eaf8 on top of 8936611 I get a merge conflict in height.py.  That seems to be because the parent of your latest commit is not 8936611 but 3ff16c1.  Did you mean to get rid of commit 8936611?



---

archive/issue_comments_381630.json:
```json
{
    "body": "Don't pull. Just checkout my branch.",
    "created_at": "2019-03-11T11:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381630",
    "user": "https://github.com/jdemeyer"
}
```

Don't pull. Just checkout my branch.



---

archive/issue_comments_381631.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> Don't pull. Just checkout my branch.\n\nOf course.  For some reason I had created a new  branch tracking trac/u/jdemeyer/eclib.  Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...",
    "created_at": "2019-03-11T11:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381631",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:70 jdemeyer]:
> Don't pull. Just checkout my branch.

Of course.  For some reason I had created a new  branch tracking trac/u/jdemeyer/eclib.  Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...



---

archive/issue_comments_381632.json:
```json
{
    "body": "OK, so testing all the elliptic_curves directory with a python3 build the only failures I get are ones which have nothing to do with this fix.\n\nFor the record there is one failure in each of ell_rational_field, ell_number_field, and padic_lseries.  The one in ell_rational_field has been fixed in #27432.",
    "created_at": "2019-03-11T12:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381632",
    "user": "https://github.com/JohnCremona"
}
```

OK, so testing all the elliptic_curves directory with a python3 build the only failures I get are ones which have nothing to do with this fix.

For the record there is one failure in each of ell_rational_field, ell_number_field, and padic_lseries.  The one in ell_rational_field has been fixed in #27432.



---

archive/issue_comments_381633.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-11T12:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381633",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_381634.json:
```json
{
    "body": "Replying to [comment:71 cremona]:\n> Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...\n\n\nI think you're right in principle. On the other hand, sometimes it is more practical to just rebase a branch. For example, having one commit and then another one which reverts that is just adding noise to the git history. In that case, I'd rather just remove the commit.",
    "created_at": "2019-03-11T12:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381634",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:71 cremona]:
> Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...


I think you're right in principle. On the other hand, sometimes it is more practical to just rebase a branch. For example, having one commit and then another one which reverts that is just adding noise to the git history. In that case, I'd rather just remove the commit.



---

archive/issue_comments_381635.json:
```json
{
    "body": "Replying to [comment:73 jdemeyer]:\n> Replying to [comment:71 cremona]:\n> > Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...\n\n> \n> I think you're right in principle. On the other hand, sometimes it is more practical to just rebase a branch. For example, having one commit and then another one which reverts that is just adding noise to the git history. In that case, I'd rather just remove the commit.\n\n*and* as a courtesy to others, add a comment on trac to say that that is what you have done!",
    "created_at": "2019-03-11T12:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381635",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:73 jdemeyer]:
> Replying to [comment:71 cremona]:
> > Still, I think it may be bad practice to upload a branch with same name as an old one but which does not have the old one as parent...

> 
> I think you're right in principle. On the other hand, sometimes it is more practical to just rebase a branch. For example, having one commit and then another one which reverts that is just adding noise to the git history. In that case, I'd rather just remove the commit.

*and* as a courtesy to others, add a comment on trac to say that that is what you have done!



---

archive/issue_comments_381636.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-13T18:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381636",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067939.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-13T18:29:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27123#event-67939"
}
```



---

archive/issue_comments_381637.json:
```json
{
    "body": "Good news! This ticket took a bit longer than expected...",
    "created_at": "2019-03-14T14:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381637",
    "user": "https://github.com/jdemeyer"
}
```

Good news! This ticket took a bit longer than expected...



---

archive/issue_comments_381638.json:
```json
{
    "body": "I would like to publicly thank Jeroen for his work on this.  It's not the first time that eclib's inclusion in Sage has led to improvements in the library itself.\n\nThe less good news is that some of my code it not converging well with the new precision handling (decimal to bits) but not in a part which affects Sage, so there will not be another ticket to upgrade again.  Well, not this month.",
    "created_at": "2019-03-14T14:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27123#issuecomment-381638",
    "user": "https://github.com/JohnCremona"
}
```

I would like to publicly thank Jeroen for his work on this.  It's not the first time that eclib's inclusion in Sage has led to improvements in the library itself.

The less good news is that some of my code it not converging well with the new precision handling (decimal to bits) but not in a part which affects Sage, so there will not be another ticket to upgrade again.  Well, not this month.
