# Issue 26968: Sage ignores libs from pkgconfig

Issue created by migration from https://trac.sagemath.org/ticket/27205

Original creator: thansen

Original creation time: 2019-02-02 13:31:29

CC:  fbissey cpernet arojas dimpase mkoeppe isuruf vbraun

When sage uses pkgconfig to determine compile flags, for example in `src/module_list.py` and `src/sage/env.py` it only extracts the "libraries" but not the "libs" field from pkg-config. In the case of fflas-ffpack this field (as well as cflags) contains `-fopenmp`. So sage builds but does not link with this flag which leads to missing symbols on Ubuntu:


```
ImportError: /<<PKGBUILDDIR>>/debian/build/usr/lib/python2.7/dist-packages/sage/matrix/matrix_modn_sparse.so: undefined symbol: GOMP_loop_ull_runtime_start
```


This was mentioned in https://bugs.debian.org/919573 .


---

Comment by jdemeyer created at 2019-02-03 11:46:15

I think we are either misusing `pkgconfig` or there is something wrong with `pkgconfig` upstream.


---

Comment by thansen created at 2019-02-03 12:05:02

`pkg-config --libs` or `pkgconfig.libs(pkg)` in Python gives the LDFLAGS required for the package. According to the manpage of pkg-config this splits into `pkg-config --libs-only-l`, `pkg-config --libs-only-L` and `pkg-config --libs-only-other`. 

What sage does is to get `pkg-config --libs-only-l`, `pkg-config --libs-only-L` by means of `pkgconfig.parse(pkg)['libraries']` and `pkgconfig.parse(pkg)['library_dirs']`, missing the content of `pkg-config --libs-only-other`.


---

Comment by thansen created at 2019-02-05 15:10:57

There is `extra_link_args` to specify the remaining LDFLAGS in distutils extensions.


---

Comment by thansen created at 2019-02-06 10:56:27

I created this patch which takes care of the extra flags only for linbox and fflas-ffpack for now:

https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/u1-pkgconfig-extra-link-flags.patch

To apply it here, should I do the same for all modules that use pkgconfig in env.py and module_list.py?


---

Comment by fbissey created at 2019-02-06 22:03:18

Clearly an oversight on my part when I last updated that pkg-config bit. I didn't know about `--libs-only-other` and thought we would get something like `-fopenmp` from `cflags`. I see `pkgconfig` (the python binding) had a few new releases since I last updated it, but nothing that would help.

I think we should make a feature request for upstream `pkgconfig` so we can simplify the stuff in your patch. Did you make one? 

For the case at hand here in Gentoo I don't have any problems with linking. I am guessing this is because `libgomp` is in the `NEEDED` list of `libfflas`. I am more concerned that `-fopenmp` in not in `CFLAGS` where it could have an impact on section of headers being used. At linking it only bring the openmp runtime (libgomp when using gcc) which feels a little bit too late and is only interesting if you have a direct use of openmp symbol or indirect but unresolved ones (which is not the case for me here).


---

Comment by fbissey created at 2019-02-06 22:35:12

I have opened https://github.com/matze/pkgconfig/issues/38 for upstream pkgconfig to help deal with this issue. Of course in the meantime the debian patch is OK.


---

Comment by thansen created at 2019-02-07 00:14:08

Thanks. On Debian `-fopenmp` _is_ in the cflags of linbox and fflas-ffpack. That's precisely why this was discovered: If you build with this flag you also need to link with it. The build failed on Ubuntu with a missing symbol from libgomp. For some reason that I don't know the build didn't fail on Debian.


---

Comment by fbissey created at 2019-02-07 00:21:45

Well, I have been giving this some thoughts and I have come to the conclusion that you cannot have that problem unless either `libfflas.so` or `libffpack.so` is underlinked relative to `libgomp`. linbox, while it does have a openmp configure option, doesn't link to the openmp runtime as far as I can see. So the trouble come from fflas-ffpack.


---

Comment by fbissey created at 2019-02-07 00:29:38

After closer inspection it could also happen if you use openblas compiled with openmp and it is underlinked. I guess that's another possibility, and in that case adding fflas-ffpack's flag to fix it, is just accidental.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by embray created at 2019-11-13 13:33:46

I have also been seeing problems like this on Cygwin lately, though I'm not sure where it began.

I've been compiling fflas-ffpack with `FFLAS_FFPACK_CONFIGURE=--disable-openmp`.


---

Comment by mkoeppe created at 2020-04-14 07:21:10

I think this is showing up in https://github.com/mkoeppe/sage/runs/581024689?check_suite_focus=true too


---

Comment by mkoeppe created at 2020-04-15 14:40:14

Changing priority from major to blocker.


---

Comment by dimpase created at 2020-04-15 17:10:45

this seems to be related to OpenMP:

```
2020-04-12T20:04:09.1360983Z   [dochtml]   ImportError: /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.cpython-37m-x86_64-linux-gnu.so: undefined symbol: GOMP_loop_ull_maybe_nonmonotonic_runtime_next
```



---

Comment by isuruf created at 2020-04-15 22:06:30

Looks like fflas-ffpack have openmp pragmas on their header files. Sage should detect whether `__FFLASFFPACK_USE_OPENMP` is defined in `spkg-configure.m4` and add `-fopenmp` to `extra_link_args` until the `pkgconfig` issue is fixed


---

Comment by mkoeppe created at 2020-04-17 01:21:21

New commits:


---

Comment by git created at 2020-04-17 03:05:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-17 04:32:16

Fixes the problem on `debian-bullseye-standard`.


---

Comment by mkoeppe created at 2020-04-17 04:32:16

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-04-17 08:28:17

good catch. needs testing.

by the way, is there a ticket to make gh action testing doable from CLI?


---

Comment by mkoeppe created at 2020-04-17 15:59:18

Tests running at https://github.com/mkoeppe/sage/actions/runs/80516747


---

Comment by mkoeppe created at 2020-04-17 16:03:03

Replying to [comment:28 dimpase]:
> by the way, is there a ticket to make gh action testing doable from CLI?

No ticket; but from a comment in #29087:
`gh pr create -f -d` would be a command line interface to trigger the GH actions run. â€‹https://cli.github.com/manual/gh_pr_create


---

Comment by mkoeppe created at 2020-04-18 04:14:12

The tests are ready; needs review


---

Comment by mkoeppe created at 2020-04-18 16:05:30

Let's get this into 9.1 please...


---

Comment by dimpase created at 2020-04-18 16:16:51

lgtm, thanks.


---

Comment by dimpase created at 2020-04-18 16:16:51

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-18 18:03:51

Thanks!


---

Comment by vbraun created at 2020-04-20 22:22:38

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-04-20 22:22:38

See patchbot:

```
[sagelib-9.1.rc0] g++: error: LINBOXSAGE_LIBS@: No such file or directory
```



---

Comment by mkoeppe created at 2020-04-20 22:54:52

Should have bumped the patch level


---

Comment by git created at 2020-04-20 22:56:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-20 22:56:37

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-04-23 22:33:30

Resolution: fixed


---

Comment by @kliem created at 2020-04-24 05:09:02

Does this ticket fix the following error when building the documentation?


```
 [dochtml] installing. Log file: logs/dochtml.log
  [dochtml] error installing, exit status 1. End of log file:
  [dochtml]   Traceback (most recent call last):
  [dochtml]     File "/sage/local/lib/python3.7/runpy.py", line 183, in _run_module_as_main
  [dochtml]       mod_name, mod_spec, code = _get_module_details(mod_name, _Error)
  [dochtml]     File "/sage/local/lib/python3.7/runpy.py", line 142, in _get_module_details
  [dochtml]       return _get_module_details(pkg_main_name, error)
  [dochtml]     File "/sage/local/lib/python3.7/runpy.py", line 109, in _get_module_details
  [dochtml]       __import__(pkg_name)
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 59, in <module>
  [dochtml]       import sage.all
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage/all.py", line 132, in <module>
  [dochtml]       from sage.matrix.all     import *
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage/matrix/__init__.py", line 2, in <module>
  [dochtml]       import sage.matrix.args
  [dochtml]     File "sage/matrix/args.pyx", line 23, in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21217)
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage/matrix/matrix_space.py", line 46, in <module>
  [dochtml]       from . import matrix_modn_sparse
  [dochtml]   ImportError: /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.cpython-37m-x86_64-linux-gnu.so: undefined symbol: GOMP_loop_ull_maybe_nonmonotonic_runtime_next
  [dochtml] Full log file: logs/dochtml.log
```


E.g. on ubuntu-focal or debian bullseye: [https://github.com/mkoeppe/sage/runs/610674634](https://github.com/mkoeppe/sage/runs/610674634)

This is a new bug that appears to have been introduced in 9.1.rc1.


---

Comment by mkoeppe created at 2020-04-24 14:09:43

Yes, this ticket fixes this bug.
