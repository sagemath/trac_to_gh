# Issue 20389: lazy_import'ed modules broken on introspection

archive/issues_020389.json:
```json
{
    "body": "CC:  jdemeyer vdelecroix @kliem\n\n*Steps to reproduce*: extract the attached archive containing a\ntrivial module bar lazy imported from a module foo in the current\ndirectory, and run sage:\n\n\n```\nsage: import foo\nsage: foo.bar?\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-04fe32111b22> in <module>()\n----> 1 get_ipython().magic(u'pinfo foo.bar')\n\n/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)\n   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')\n   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)\n-> 2163         return self.run_line_magic(magic_name, magic_arg_s)\n   2164 \n   2165     #-------------------------------------------------------------------------\n\n\n... last 3 frames repeated, from the frame below ...\n\n/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)\n   1765         typ = type(obj)\n   1766 \n-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)\n   1768     if s:\n   1769         pos = _extract_embedded_position(s)\n\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\n\n\n*Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused\nwhen detecting that `foo.bar` is of type `LazyImport` (and not module)\nand trying to recover its documentation from there.\n\n\n*Use case*: some Sage modules contain only documentation:\n\n- `sage.combinat.tutorial`\n- `sage.combinat.primer`\n- `sage.modules.tutorial_free_module`\n- `sage.categories.primer`\n- `sage.categories.tutorial`\n\nand more will come. It would be nice to lazy import them to reduce the\nmemory and startup footprint.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20626\n\n",
    "created_at": "2016-05-19T07:08:23Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "title": "lazy_import'ed modules broken on introspection",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20389",
    "user": "nthiery"
}
```
CC:  jdemeyer vdelecroix @kliem

*Steps to reproduce*: extract the attached archive containing a
trivial module bar lazy imported from a module foo in the current
directory, and run sage:


```
sage: import foo
sage: foo.bar?
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-04fe32111b22> in <module>()
----> 1 get_ipython().magic(u'pinfo foo.bar')

/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)
   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')
   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
-> 2163         return self.run_line_magic(magic_name, magic_arg_s)
   2164 
   2165     #-------------------------------------------------------------------------


... last 3 frames repeated, from the frame below ...

/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)
   1765         typ = type(obj)
   1766 
-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)
   1768     if s:
   1769         pos = _extract_embedded_position(s)

RuntimeError: maximum recursion depth exceeded in __instancecheck__
```


*Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused
when detecting that `foo.bar` is of type `LazyImport` (and not module)
and trying to recover its documentation from there.


*Use case*: some Sage modules contain only documentation:

- `sage.combinat.tutorial`
- `sage.combinat.primer`
- `sage.modules.tutorial_free_module`
- `sage.categories.primer`
- `sage.categories.tutorial`

and more will come. It would be nice to lazy import them to reduce the
memory and startup footprint.

Issue created by migration from https://trac.sagemath.org/ticket/20626





---

archive/issue_comments_281099.json:
```json
{
    "body": "Possibly related: documentation of lazy imports includes various `lazy_import` stuff\n\n```\nsage: %pinfo piecewise\nType:            LazyImport\nString form:     piecewise\nFile:            ~/Sage/src/sage/misc/lazy_import.pyx\nDocstring:\n   Piecewise function    <---- this section is the only one that is correct\n\n   EXAMPLES:\n\n      sage: var('x, y')\n      (x, y)\n      sage: f = piecewise([((0,1), x^2*y), ([-1,0], -x*y^2)], var=x);  f\n      piecewise(x|-->x^2*y on (0, 1), x|-->-x*y^2 on [-1, 0]; x)\n      sage: f(1/2)\n      1/4*y\n      sage: f(-1/2)\n      1/2*y^2\n\nClass docstring:\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_integer = LazyImport('sage.rings.all', 'Integer')\n      sage: my_integer(4)\n      4\n      sage: my_integer('101', base=2)\n      5\n      sage: my_integer(3/2)\n      Traceback (most recent call last):\n      ...\n      TypeError: no conversion of this rational to integer\nInit docstring:\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_isprime = LazyImport('sage.all', 'is_prime')\n      sage: my_isprime(5)\n      True\n      sage: my_isprime(55)\n      False\nCall docstring:\n   Calling self calls the wrapped object.\n\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_isprime = LazyImport('sage.all', 'is_prime')\n      sage: my_isprime(12)\n      False\n      sage: my_isprime(13)\n      True\n```\n",
    "created_at": "2016-05-22T08:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281099",
    "user": "vbraun"
}
```

Possibly related: documentation of lazy imports includes various `lazy_import` stuff

```
sage: %pinfo piecewise
Type:            LazyImport
String form:     piecewise
File:            ~/Sage/src/sage/misc/lazy_import.pyx
Docstring:
   Piecewise function    <---- this section is the only one that is correct

   EXAMPLES:

      sage: var('x, y')
      (x, y)
      sage: f = piecewise([((0,1), x^2*y), ([-1,0], -x*y^2)], var=x);  f
      piecewise(x|-->x^2*y on (0, 1), x|-->-x*y^2 on [-1, 0]; x)
      sage: f(1/2)
      1/4*y
      sage: f(-1/2)
      1/2*y^2

Class docstring:
   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_integer = LazyImport('sage.rings.all', 'Integer')
      sage: my_integer(4)
      4
      sage: my_integer('101', base=2)
      5
      sage: my_integer(3/2)
      Traceback (most recent call last):
      ...
      TypeError: no conversion of this rational to integer
Init docstring:
   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_isprime = LazyImport('sage.all', 'is_prime')
      sage: my_isprime(5)
      True
      sage: my_isprime(55)
      False
Call docstring:
   Calling self calls the wrapped object.

   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_isprime = LazyImport('sage.all', 'is_prime')
      sage: my_isprime(12)
      False
      sage: my_isprime(13)
      True
```




---

archive/issue_comments_281100.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-06T13:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281100",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_281101.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2017-04-06T13:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281101",
    "user": "jdemeyer"
}
```

Last 10 new commits:



---

archive/issue_comments_281102.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-04-06T20:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281102",
    "user": "jdemeyer"
}
```

Resolution: wontfix



---

archive/issue_comments_281103.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281103",
    "user": "jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_281104.json:
```json
{
    "body": "Resolution changed from wontfix to ",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281104",
    "user": "jdemeyer"
}
```

Resolution changed from wontfix to 



---

archive/issue_comments_281105.json:
```json
{
    "body": "Hi Jeroen,\nI am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify? Thanks!",
    "created_at": "2017-04-07T03:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281105",
    "user": "nthiery"
}
```

Hi Jeroen,
I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify? Thanks!



---

archive/issue_comments_281106.json:
```json
{
    "body": "Replying to [comment:12 nthiery]:\n> Hi Jeroen,\n> I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify?\n\nI got quite negative reactions (mostly from Nils Bruin but also from Erik Bray) on #22752, which is a dependency of this ticket and #15648.\n\nSo either\n\n1. Nils and/or Erik need to reimplement lazy imports \"their way\".\n\n2. Nils and/or Erik should realize that my code on #22752 wasn't so bad anyway.\n\n3. We try to fix #15648 and #20626 with the current implementation of lazy imports, without #22752.",
    "created_at": "2017-04-07T07:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281106",
    "user": "jdemeyer"
}
```

Replying to [comment:12 nthiery]:
> Hi Jeroen,
> I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify?

I got quite negative reactions (mostly from Nils Bruin but also from Erik Bray) on #22752, which is a dependency of this ticket and #15648.

So either

1. Nils and/or Erik need to reimplement lazy imports "their way".

2. Nils and/or Erik should realize that my code on #22752 wasn't so bad anyway.

3. We try to fix #15648 and #20626 with the current implementation of lazy imports, without #22752.



---

archive/issue_comments_281107.json:
```json
{
    "body": "Hi there,\nWhile searching for lazy import issues I stumbled back on this ticket. It seems things have evolved a bit since the last comment with #22752 being merged. Does it change the status of this ticket?\n\nCheers,",
    "created_at": "2018-07-22T15:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281107",
    "user": "nthiery"
}
```

Hi there,
While searching for lazy import issues I stumbled back on this ticket. It seems things have evolved a bit since the last comment with #22752 being merged. Does it change the status of this ticket?

Cheers,



---

archive/issue_comments_281108.json:
```json
{
    "body": "I am reverting to the ticket description before #22752. Do you still have that \"attached archive containing a trivial module bar lazy imported\"?",
    "created_at": "2018-07-22T15:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281108",
    "user": "jdemeyer"
}
```

I am reverting to the ticket description before #22752. Do you still have that "attached archive containing a trivial module bar lazy imported"?



---

archive/issue_comments_281109.json:
```json
{
    "body": "update milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281109",
    "user": "vdelecroix"
}
```

update milestone 8.3 -> 8.4



---

archive/issue_comments_281110.json:
```json
{
    "body": "Prompted by Sam, I tried to recreate the archive with several variants of:\n\n\n```\nmkdir -p foo/bar\ntouch foo/bar/__init__.py\ncat > foo/__init.py__ <<EOF\nfrom sage.misc.lazy_import import LazyImport\nbar = LazyImport('foo', 'bar')\nEOF\n```\n\n\nHowever -- not quite surprisingly -- that fails:\n\n\n```\nsage                                                                                                                  \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: import foo\nsage: foo.bar\n------------------------------------------------------------------------\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9a64)[0x7f49349d7a64]\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9b19)[0x7f49349d7b19]\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xd57f)[0x7f49349db57f]\n/lib/x86_64-linux-gnu/libc.so.6(+0x46470)[0x7f49373fe470]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(+0xe2e44)[0x7f49376c8e44]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(PyUnicode_New+0x8b)[0x7f49376e98fb]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(_PyUnicodeWriter_PrepareInternal+0x1c1)[0x7f493770fad1]\n```\n\n\nI can't remember which idiom I had tried back then. Maybe that\nidiom does not exist anymore.\n\nIt would be useful though to have some idiom that enables to lazy\nimport a submodule into a module, making sure that one can indeed\ninspect its documentation.",
    "created_at": "2020-09-19T04:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20389#issuecomment-281110",
    "user": "nthiery"
}
```

Prompted by Sam, I tried to recreate the archive with several variants of:


```
mkdir -p foo/bar
touch foo/bar/__init__.py
cat > foo/__init.py__ <<EOF
from sage.misc.lazy_import import LazyImport
bar = LazyImport('foo', 'bar')
EOF
```


However -- not quite surprisingly -- that fails:


```
sage                                                                                                                  
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: import foo
sage: foo.bar
------------------------------------------------------------------------
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9a64)[0x7f49349d7a64]
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9b19)[0x7f49349d7b19]
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xd57f)[0x7f49349db57f]
/lib/x86_64-linux-gnu/libc.so.6(+0x46470)[0x7f49373fe470]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(+0xe2e44)[0x7f49376c8e44]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(PyUnicode_New+0x8b)[0x7f49376e98fb]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(_PyUnicodeWriter_PrepareInternal+0x1c1)[0x7f493770fad1]
```


I can't remember which idiom I had tried back then. Maybe that
idiom does not exist anymore.

It would be useful though to have some idiom that enables to lazy
import a submodule into a module, making sure that one can indeed
inspect its documentation.
