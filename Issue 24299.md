# Issue 24299: FastFloatConverter fails to convert complex I

archive/issues_024299.json:
```json
{
    "body": "CC:  @orlitzky\n\n\n```\nsage: from sage.symbolic.expression_conversions import FastFloatConverter\nsage: f = FastFloatConverter(I)\n/home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\nSee http://trac.sagemath.org/5930 for details.\n  #!/usr/bin/env python\n<sage.symbolic.expression_conversions.FastFloatConverter object at 0x7fdec25cf110>\nsage: f()\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    206         except TypeError as err:\n    207             if 'self must be a numeric expression' not in err.args:\n--> 208                 raise err\n    209 \n    210         operator = ex.operator()\n\nTypeError: unable to coerce to a real number\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24536\n\n",
    "created_at": "2018-01-14T07:02:56Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "FastFloatConverter fails to convert complex I",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24299",
    "user": "https://github.com/rwst"
}
```
CC:  @orlitzky


```
sage: from sage.symbolic.expression_conversions import FastFloatConverter
sage: f = FastFloatConverter(I)
/home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
See http://trac.sagemath.org/5930 for details.
  #!/usr/bin/env python
<sage.symbolic.expression_conversions.FastFloatConverter object at 0x7fdec25cf110>
sage: f()
/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    206         except TypeError as err:
    207             if 'self must be a numeric expression' not in err.args:
--> 208                 raise err
    209 
    210         operator = ex.operator()

TypeError: unable to coerce to a real number
```


Issue created by migration from https://trac.sagemath.org/ticket/24536





---

archive/issue_comments_339817.json:
```json
{
    "body": "Apparently \"Float\" literally means Python (real) \"float\" not floating-point. Of course then expressions containing `I` raise errors, even if the outcome is real. The original case was the usage by `find_local_maximum`---so that never worked, and the restriction was undocumented.",
    "created_at": "2018-01-14T07:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339817",
    "user": "https://github.com/rwst"
}
```

Apparently "Float" literally means Python (real) "float" not floating-point. Of course then expressions containing `I` raise errors, even if the outcome is real. The original case was the usage by `find_local_maximum`---so that never worked, and the restriction was undocumented.



---

archive/issue_comments_339818.json:
```json
{
    "body": "The documentation of `fast_float` states\n\n```\ndef fast_float(ex, *vars):\n    \"\"\"\n    Returns an object which provides fast floating point evaluation of\n    the symbolic expression *ex*.\n```\n\nbut\n\n```\nsage: from sage.symbolic.expression_conversions import fast_float\nsage: ff = fast_float(abs(x+I))\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1574: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\nSee http://trac.sagemath.org/5930 for details.\n  return FastFloatConverter(ex, *vars)()\n```\n\ngives the ticket error.",
    "created_at": "2018-01-14T07:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339818",
    "user": "https://github.com/rwst"
}
```

The documentation of `fast_float` states

```
def fast_float(ex, *vars):
    """
    Returns an object which provides fast floating point evaluation of
    the symbolic expression *ex*.
```

but

```
sage: from sage.symbolic.expression_conversions import fast_float
sage: ff = fast_float(abs(x+I))
/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1574: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
See http://trac.sagemath.org/5930 for details.
  return FastFloatConverter(ex, *vars)()
```

gives the ticket error.



---

archive/issue_comments_339819.json:
```json
{
    "body": "Relevant: #5572. Somewhat related: #13559, #16899.",
    "created_at": "2018-01-14T07:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339819",
    "user": "https://github.com/rwst"
}
```

Relevant: #5572. Somewhat related: #13559, #16899.



---

archive/issue_comments_339820.json:
```json
{
    "body": "Note that changing the call from `find_local_maximum(abs(x+I),-1,1)` to\n\n\n```\nfind_local_maximum(lambda x: abs(x+I),-1,1)\n```\n\n\nThen everything works fine.",
    "created_at": "2019-02-13T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339820",
    "user": "https://github.com/johanrosenkilde"
}
```

Note that changing the call from `find_local_maximum(abs(x+I),-1,1)` to


```
find_local_maximum(lambda x: abs(x+I),-1,1)
```


Then everything works fine.



---

archive/issue_comments_339821.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2021-07-22T00:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339821",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_339822.json:
```json
{
    "body": "The fix for this will be similar to the one in #8450. After #32234, we're using `fast_callable()` on these expressions with `domain=float`, which converts all *intermediate* expression-evaluation results to `float`. Obviously that causes problems with the `x+I` in `abs(x+I)`. To work around that, we can probably just run the computation with `domain=CDF` and then convert the answer to `float` if its imaginary part is small enough. (But we don't want to return NaN if the end result has a nontrivial imaginary part, like we do when plotting.)",
    "created_at": "2021-07-29T13:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339822",
    "user": "https://github.com/orlitzky"
}
```

The fix for this will be similar to the one in #8450. After #32234, we're using `fast_callable()` on these expressions with `domain=float`, which converts all *intermediate* expression-evaluation results to `float`. Obviously that causes problems with the `x+I` in `abs(x+I)`. To work around that, we can probably just run the computation with `domain=CDF` and then convert the answer to `float` if its imaginary part is small enough. (But we don't want to return NaN if the end result has a nontrivial imaginary part, like we do when plotting.)



---

archive/issue_comments_339823.json:
```json
{
    "body": "Set assignee to @orlitzky.",
    "created_at": "2021-07-29T13:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339823",
    "user": "https://github.com/orlitzky"
}
```

Set assignee to @orlitzky.



---

archive/issue_comments_339824.json:
```json
{
    "body": "I'll deal with it once the prereqs start to settle.",
    "created_at": "2021-07-29T13:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339824",
    "user": "https://github.com/orlitzky"
}
```

I'll deal with it once the prereqs start to settle.



---

archive/issue_comments_339825.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-07-29T13:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339825",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_339826.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-24T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339826",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339827.json:
```json
{
    "body": "As promised, I've factored out a superclass of the `FastCallablePlotWrapper` that won't ignore complex results and will instead raise an error. This is more suitable for functions like `find_root()` and `find_local_minimum()` where a complex result can't really be ignored.\n\nThose two functions (and the \"maximum\" alias) have been updated, but I'm sure there are others where the same strategy can easily be applied.\n----\nNew commits:",
    "created_at": "2022-02-24T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339827",
    "user": "https://github.com/orlitzky"
}
```

As promised, I've factored out a superclass of the `FastCallablePlotWrapper` that won't ignore complex results and will instead raise an error. This is more suitable for functions like `find_root()` and `find_local_minimum()` where a complex result can't really be ignored.

Those two functions (and the "maximum" alias) have been updated, but I'm sure there are others where the same strategy can easily be applied.
----
New commits:



---

archive/issue_comments_339828.json:
```json
{
    "body": "\n```\n+      * ``CDF`` has none of the other issues, because ``CDF`` has its\n+        own specialized interpreter, a lexicographic ordering (for\n+        min/max),\n```\n\n\nShould we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:\n\n```\nsage: CDF(1+2*I) < CDF(1-2*I)\nFalse\nsage: complex(1+2*I) < complex(1-2*I)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-3575b3aa8341> in <module>\n----> 1 complex(Integer(1)+Integer(2)*I) < complex(Integer(1)-Integer(2)*I)\n\nTypeError: '<' not supported between instances of 'complex' and 'complex'\n```\n",
    "created_at": "2022-02-24T18:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339828",
    "user": "https://github.com/mkoeppe"
}
```


```
+      * ``CDF`` has none of the other issues, because ``CDF`` has its
+        own specialized interpreter, a lexicographic ordering (for
+        min/max),
```


Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:

```
sage: CDF(1+2*I) < CDF(1-2*I)
False
sage: complex(1+2*I) < complex(1-2*I)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-3575b3aa8341> in <module>
----> 1 complex(Integer(1)+Integer(2)*I) < complex(Integer(1)-Integer(2)*I)

TypeError: '<' not supported between instances of 'complex' and 'complex'
```




---

archive/issue_comments_339829.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> \n> Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:\n\nI wonder why it was added? Someone had to go to the trouble. In any case, we'd have to find some other solution for these wrappers if the ordering was removed. Right now we're fortunate that CDF reasonably handles everything that people want to do with real numbers, so long as the imaginary parts are small.",
    "created_at": "2022-02-24T18:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339829",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:14 mkoeppe]:
> 
> Should we (in a separate ticket) get rid of this ordering? It's in contrast to python3's built-in `complex`:

I wonder why it was added? Someone had to go to the trouble. In any case, we'd have to find some other solution for these wrappers if the ordering was removed. Right now we're fortunate that CDF reasonably handles everything that people want to do with real numbers, so long as the imaginary parts are small.



---

archive/issue_comments_339830.json:
```json
{
    "body": "I think it's just a leftover of python 2 semantics in which everything could be compared with everything",
    "created_at": "2022-02-24T18:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339830",
    "user": "https://github.com/mkoeppe"
}
```

I think it's just a leftover of python 2 semantics in which everything could be compared with everything



---

archive/issue_comments_339831.json:
```json
{
    "body": "Similar issue for number field elements - in ticket #20028",
    "created_at": "2022-02-25T06:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339831",
    "user": "https://github.com/mkoeppe"
}
```

Similar issue for number field elements - in ticket #20028



---

archive/issue_comments_339832.json:
```json
{
    "body": "I've opened #33417",
    "created_at": "2022-02-25T18:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339832",
    "user": "https://github.com/mkoeppe"
}
```

I've opened #33417



---

archive/issue_comments_339833.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-25T22:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339833",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_339834.json:
```json
{
    "body": "Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?",
    "created_at": "2022-02-26T17:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339834",
    "user": "https://github.com/mkoeppe"
}
```

Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?



---

archive/issue_comments_339835.json:
```json
{
    "body": "I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:\n\n```\n+        from sage.ext.fast_callable import FastCallableFloatWrapper\n+        f = self._plot_fast_callable(var)\n+        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)\n```\n\nIs this needed?",
    "created_at": "2022-02-26T17:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339835",
    "user": "https://github.com/mkoeppe"
}
```

I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:

```
+        from sage.ext.fast_callable import FastCallableFloatWrapper
+        f = self._plot_fast_callable(var)
+        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)
```

Is this needed?



---

archive/issue_comments_339836.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:\n> {{{\n> +        from sage.ext.fast_callable import FastCallableFloatWrapper\n> +        f = self._plot_fast_callable(var)\n> +        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)\n> }}}\n> Is this needed?\n\nThe `_plot_fast_callable()` method returns only a fast-callable over CDF, not a wrapper. When plotting, the wrapper is added during `setup_for_eval_on_grid()` to support fast-callables that don't arise from `expr.plot()`. Given that, if `_plot_fast_callable()` returned a wrapper, 'we would eventually try to wrap it twice during `expr.plot()`.",
    "created_at": "2022-02-26T21:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339836",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:21 mkoeppe]:
> I haven't looked at the code in much detail yet, but `FastCallablePlotWrapper` inherits from `FastCallableFloatWrapper`, but also you are double-wrapping `var` here:
> {{{
> +        from sage.ext.fast_callable import FastCallableFloatWrapper
> +        f = self._plot_fast_callable(var)
> +        ff = FastCallableFloatWrapper(f, imag_tol=imaginary_tolerance)
> }}}
> Is this needed?

The `_plot_fast_callable()` method returns only a fast-callable over CDF, not a wrapper. When plotting, the wrapper is added during `setup_for_eval_on_grid()` to support fast-callables that don't arise from `expr.plot()`. Given that, if `_plot_fast_callable()` returned a wrapper, 'we would eventually try to wrap it twice during `expr.plot()`.



---

archive/issue_comments_339837.json:
```json
{
    "body": "Replying to [comment:20 mkoeppe]:\n> Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?\n\nSo you're not satisfied with solving easy problems all day? =)\n\nIt's awkward, and I'm open to suggestions.\n\nI think the original name that I chose for the plotting wrapper was `FastCallableOutputWrapper`, which is more or less what it does. It wraps a fast-callable, and converts its output to... something else. But I was already aware that this ticket was going to require a different wrapping behavior. Since the behavior of the plot wrapper (returning `NaN` when it gets a complex answer) is so unique to plotting, I settled on `FastCallablePlotWrapper`.\n\nThe class for this ticket then sits beneath an abstract `FastCallableOutputWrapper` in my head. Unlike the plot wrapper, it doesn't do anything unusual during conversion, so it would rightly sit beside sibling classes such as `FastCallableComplexWrapper` or `FastCallableIntWrapper`.\n\nI thought about naming this class `FastCallableFloatOutputWrapper`, and maybe that's a better choice, since \"Plot\" isn't what the \"Plot\" wrapper outputs. It's just so looooooooong.",
    "created_at": "2022-02-26T21:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339837",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:20 mkoeppe]:
> Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?

So you're not satisfied with solving easy problems all day? =)

It's awkward, and I'm open to suggestions.

I think the original name that I chose for the plotting wrapper was `FastCallableOutputWrapper`, which is more or less what it does. It wraps a fast-callable, and converts its output to... something else. But I was already aware that this ticket was going to require a different wrapping behavior. Since the behavior of the plot wrapper (returning `NaN` when it gets a complex answer) is so unique to plotting, I settled on `FastCallablePlotWrapper`.

The class for this ticket then sits beneath an abstract `FastCallableOutputWrapper` in my head. Unlike the plot wrapper, it doesn't do anything unusual during conversion, so it would rightly sit beside sibling classes such as `FastCallableComplexWrapper` or `FastCallableIntWrapper`.

I thought about naming this class `FastCallableFloatOutputWrapper`, and maybe that's a better choice, since "Plot" isn't what the "Plot" wrapper outputs. It's just so looooooooong.



---

archive/issue_comments_339838.json:
```json
{
    "body": "In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?",
    "created_at": "2022-02-26T22:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339838",
    "user": "https://github.com/mkoeppe"
}
```

In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?



---

archive/issue_comments_339839.json:
```json
{
    "body": "Replying to [comment:24 mkoeppe]:\n> In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?\n\nHow about `UnembedFloatFromCDF` and `UnembedPlotFloatFromCDF`?\n\nFor now we could also do `UnembedFloatFromCDF(nan_on_error=<bool>)` to cover both cases, but then if the class hierarchy is ever extended upwards or laterally, the `nan_on_error` parameter isn't going to be consistent.",
    "created_at": "2022-02-27T15:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339839",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:24 mkoeppe]:
> In the implementation of `FastCallableFloatWrapper` I don't really see anything that is specific to using a fast callable. Perhaps it would make sense to generalize the concept, to get to a more manageable naming scheme?

How about `UnembedFloatFromCDF` and `UnembedPlotFloatFromCDF`?

For now we could also do `UnembedFloatFromCDF(nan_on_error=<bool>)` to cover both cases, but then if the class hierarchy is ever extended upwards or laterally, the `nan_on_error` parameter isn't going to be consistent.



---

archive/issue_comments_339840.json:
```json
{
    "body": "So this should be `CDF.coerce_map_from(float).section()`?",
    "created_at": "2022-02-27T17:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339840",
    "user": "https://github.com/mkoeppe"
}
```

So this should be `CDF.coerce_map_from(float).section()`?



---

archive/issue_comments_339841.json:
```json
{
    "body": "NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html",
    "created_at": "2022-02-27T18:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339841",
    "user": "https://github.com/mkoeppe"
}
```

NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html



---

archive/issue_comments_339842.json:
```json
{
    "body": "Replying to [comment:26 mkoeppe]:\n> So this should be `CDF.coerce_map_from(float).section()`?\n\nIn spirit, but with a tolerance, so that the the underlying routine doesn't crash when numerical issues cause a `0.0000000000001*I` to appear. Additionally, in the plotting class, we choose to return `nan` upon encountering a complex result so that the corresponding point is \"skipped.\"",
    "created_at": "2022-02-27T18:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339842",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:26 mkoeppe]:
> So this should be `CDF.coerce_map_from(float).section()`?

In spirit, but with a tolerance, so that the the underlying routine doesn't crash when numerical issues cause a `0.0000000000001*I` to appear. Additionally, in the plotting class, we choose to return `nan` upon encountering a complex result so that the corresponding point is "skipped."



---

archive/issue_comments_339843.json:
```json
{
    "body": "Yes, so we would have a signaling and a non-signaling version of it",
    "created_at": "2022-02-27T18:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339843",
    "user": "https://github.com/mkoeppe"
}
```

Yes, so we would have a signaling and a non-signaling version of it



---

archive/issue_comments_339844.json:
```json
{
    "body": "Some more random facts:\n\n```\nsage: numpy.real(complex(CDF(1,1)))\n1.0\nsage: numpy.real(CDF(1,1))\n<built-in method real of sage.rings.complex_double.ComplexDoubleElement object at 0x1526bc8c0>\n```\n\n:(",
    "created_at": "2022-02-27T18:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339844",
    "user": "https://github.com/mkoeppe"
}
```

Some more random facts:

```
sage: numpy.real(complex(CDF(1,1)))
1.0
sage: numpy.real(CDF(1,1))
<built-in method real of sage.rings.complex_double.ComplexDoubleElement object at 0x1526bc8c0>
```

:(



---

archive/issue_comments_339845.json:
```json
{
    "body": "Replying to [comment:27 mkoeppe]:\n> NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html\n\nThat would basically work here, although I think it might be slower to go from CDF through numpy and back. The main downside to that though is that the error message will be thrown deep in some plotting or optimization routine when it receives a complex number. In the current branch I've chosen to raise an error immediately, in the wrapper, \"ValueError: complex fast-callable function result...\" that is usually going to better explain the problem.",
    "created_at": "2022-02-27T18:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339845",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:27 mkoeppe]:
> NumPy has https://numpy.org/doc/stable/reference/generated/numpy.real_if_close.html

That would basically work here, although I think it might be slower to go from CDF through numpy and back. The main downside to that though is that the error message will be thrown deep in some plotting or optimization routine when it receives a complex number. In the current branch I've chosen to raise an error immediately, in the wrapper, "ValueError: complex fast-callable function result..." that is usually going to better explain the problem.



---

archive/issue_comments_339846.json:
```json
{
    "body": "I didn't mean to say that we should use this numpy function. Just collecting existing idioms and interfaces.\n\nI was looking for a name for this operation (\"convert to float if close to a real number, NaN otherwise) - and so far haven't found anything in Python, NumPy, C++ reference, ...",
    "created_at": "2022-02-27T18:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339846",
    "user": "https://github.com/mkoeppe"
}
```

I didn't mean to say that we should use this numpy function. Just collecting existing idioms and interfaces.

I was looking for a name for this operation ("convert to float if close to a real number, NaN otherwise) - and so far haven't found anything in Python, NumPy, C++ reference, ...



---

archive/issue_comments_339847.json:
```json
{
    "body": "I guess one would need to figure out what complex infinities should convert to.",
    "created_at": "2022-02-27T18:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339847",
    "user": "https://github.com/mkoeppe"
}
```

I guess one would need to figure out what complex infinities should convert to.



---

archive/issue_comments_339848.json:
```json
{
    "body": "Also relevant: https://docs.python.org/3/library/cmath.html#cmath.isclose (which accepts both `rel_tol` and `abs_tol`). \"The IEEE 754 special values of NaN, inf, and -inf will be handled according to IEEE rules. Specifically, [...] inf and -inf are only considered close to themselves.\" - this forgets to talk about complex infinities.",
    "created_at": "2022-02-27T18:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339848",
    "user": "https://github.com/mkoeppe"
}
```

Also relevant: https://docs.python.org/3/library/cmath.html#cmath.isclose (which accepts both `rel_tol` and `abs_tol`). "The IEEE 754 special values of NaN, inf, and -inf will be handled according to IEEE rules. Specifically, [...] inf and -inf are only considered close to themselves." - this forgets to talk about complex infinities.



---

archive/issue_comments_339849.json:
```json
{
    "body": "Not sure how well developed the built-in `complex` type is:\n\n```\nsage: cmath.inf + float(1e-16)*cmath.infj\n(nan+infj)\n```\n\n??",
    "created_at": "2022-02-27T18:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339849",
    "user": "https://github.com/mkoeppe"
}
```

Not sure how well developed the built-in `complex` type is:

```
sage: cmath.inf + float(1e-16)*cmath.infj
(nan+infj)
```

??



---

archive/issue_comments_339850.json:
```json
{
    "body": "OK that's https://bugs.python.org/issue25453, open since 2015",
    "created_at": "2022-02-27T19:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339850",
    "user": "https://github.com/mkoeppe"
}
```

OK that's https://bugs.python.org/issue25453, open since 2015



---

archive/issue_comments_339851.json:
```json
{
    "body": "Here's another one:\n\n```\nsage: cmath.rect(math.inf, 0)\n(inf+0j)\nsage: cmath.rect(1, math.pi/4)\n(0.7071067811865476+0.7071067811865475j)\nsage: cmath.rect(math.inf, math.pi/4)\n(inf+infj)\nsage: cmath.rect(math.inf, pi/2)\n(inf+infj)                             # What?\nsage: cmath.rect(math.inf, 2*pi)\n(inf-infj)                             # Help?!\n```\n\nhttps://docs.python.org/3/library/cmath.html#cmath.rect",
    "created_at": "2022-02-27T19:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339851",
    "user": "https://github.com/mkoeppe"
}
```

Here's another one:

```
sage: cmath.rect(math.inf, 0)
(inf+0j)
sage: cmath.rect(1, math.pi/4)
(0.7071067811865476+0.7071067811865475j)
sage: cmath.rect(math.inf, math.pi/4)
(inf+infj)
sage: cmath.rect(math.inf, pi/2)
(inf+infj)                             # What?
sage: cmath.rect(math.inf, 2*pi)
(inf-infj)                             # Help?!
```

https://docs.python.org/3/library/cmath.html#cmath.rect



---

archive/issue_comments_339852.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-28T15:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339852",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_339853.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-03T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339853",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339854.json:
```json
{
    "body": "Replying to [comment:23 mjo]:\n> Replying to [comment:20 mkoeppe]:\n> > Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?\n> \n> So you're not satisfied with solving easy problems all day? =)\n> \n> It's awkward, and I'm open to suggestions.\n\nLet's postpone this to another ticket. The current branch certainly does what it promises, the implementation looks fine, and tests pass.",
    "created_at": "2022-03-03T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339854",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:23 mjo]:
> Replying to [comment:20 mkoeppe]:
> > Maybe a better name can be found for `FastCallablePlotWrapper` that expresses better what it does?
> 
> So you're not satisfied with solving easy problems all day? =)
> 
> It's awkward, and I'm open to suggestions.

Let's postpone this to another ticket. The current branch certainly does what it promises, the implementation looks fine, and tests pass.



---

archive/issue_comments_339855.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-06T23:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339855",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_339856.json:
```json
{
    "body": "On OSX:\n\n```\n**********************************************************************\nFile \"src/doc/de/thematische_anleitungen/sage_gymnasium.rst\", line 534, in doc.de.thematische_anleitungen.sage_gymnasium\nFailed example:\n    find_root(f, 0.5, 5)\nExpected:\n    0.6299605249475858\nGot:\n    0.6299605249475857\n**********************************************************************\n1 item had failures:\n   1 of 294 in doc.de.thematische_anleitungen.sage_gymnasium\n    [207 tests, 1 failure, 5.86 s]\n**********************************************************************\n```\n",
    "created_at": "2022-03-06T23:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339856",
    "user": "https://github.com/vbraun"
}
```

On OSX:

```
**********************************************************************
File "src/doc/de/thematische_anleitungen/sage_gymnasium.rst", line 534, in doc.de.thematische_anleitungen.sage_gymnasium
Failed example:
    find_root(f, 0.5, 5)
Expected:
    0.6299605249475858
Got:
    0.6299605249475857
**********************************************************************
1 item had failures:
   1 of 294 in doc.de.thematische_anleitungen.sage_gymnasium
    [207 tests, 1 failure, 5.86 s]
**********************************************************************
```




---

archive/issue_comments_339857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-08T23:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339857",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339858.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-08T23:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339858",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339859.json:
```json
{
    "body": "Untested (no macOS), but that should take care of it.",
    "created_at": "2022-03-08T23:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339859",
    "user": "https://github.com/orlitzky"
}
```

Untested (no macOS), but that should take care of it.



---

archive/issue_comments_339860.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-08T23:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339860",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_022693.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-12T15:11:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24299#event-22693"
}
```



---

archive/issue_comments_339861.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-12T15:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24299#issuecomment-339861",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
