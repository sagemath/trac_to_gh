# Issue 32930: Improve is_functional of lrs feature

Issue created by migration from https://trac.sagemath.org/ticket/33167

Original creator: slabbe

Original creation time: 2022-01-14 14:11:17

CC:  @mwageringel mjo

From #33101#comment:3 :

"_This was after a distclean. I had not explicitly installed lrslib, it was on the system. If I understand the config.log correctly, the system lrslib was not accepted by Sage. Yet, ptestlong runs the optional lrslib tests._"


```
## ------------------------------------------------------- ##
## Checking whether SageMath should install SPKG lrslib... ##
## ------------------------------------------------------- ##
configure:30190: checking whether any of gmp flint is installed as or will be installed as SPKG
configure:30194: result: yes; install lrslib as well
configure:30296: no suitable system package found for SPKG lrslib
```


----

In this ticket, we add to the `is_functional` method a check corresponding to the check made in `build/pkgs/lrslib/spkg-configure.m4` so that if `lrslib` is not picked up by sagemath at configuration/build time, than it is not picked up by sagemath at runtime or during doctests.


---

Comment by slabbe created at 2022-01-14 14:13:27

New commits:


---

Comment by slabbe created at 2022-01-14 14:13:27

Changing status from new to needs_review.


---

Comment by git created at 2022-01-14 14:14:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-01-14 14:15:14

Forced push to rename the commit message to mention #33167 instead of #33101.


---

Comment by slabbe created at 2022-01-14 14:19:06

I wonder if we should not check both `lrs` and `lrsnash` executables in the same `is_functional` method. Maybe a `JoinFeature` would be better here, as it is done for instance for `graphviz`. What does the reviewer think?


---

Comment by slabbe created at 2022-01-14 14:24:32

(this comment is copied from #33101#comment:19 where I originally posted the branch)

For now, I just imported the test made in the m4 file into the `is_functional` method. On my machine everything works, so I can not test it properly. If I made stuff correctly, the following should now return False for affected users like gh-mwageringel :


```
sage: from sage.features.lrs import Lrs
sage: Lrs().is_present()
FeatureTestResult('lrslib', True)
sage: Lrs().is_functional()
FeatureTestResult('lrslib', True)
```



---

Comment by mjo created at 2022-01-15 00:34:42

Why do we need a feature for lrs at all when we have an optional package for it? If we simply remove the feature, the spkg-configure check will handle this, won't it?


---

Comment by mjo created at 2022-01-15 03:46:35

Replying to [comment:9 mjo]:
> Why do we need a feature for lrs at all when we have an optional package for it? If we simply remove the feature, the spkg-configure check will handle this, won't it?

Nevermind, I found #30746.


---

Comment by @mwageringel created at 2022-01-15 12:52:48

Replying to [comment:5 slabbe]:
> For now, I just imported the test made in the m4 file into the `is_functional` method. On my machine everything works, so I can not test it properly. If I made stuff correctly, the following should now return False for affected users like gh-mwageringel :

This is not the case, I am afraid. I get the same output:

```
sage: from sage.features.lrs import Lrs
sage: Lrs().is_present()
FeatureTestResult('lrslib', True)
sage: Lrs().is_functional()
FeatureTestResult('lrslib', True)
```

My system lrslib seems to be mostly functional, as all the doctests apart from #33101 pass. But it is rejected by the .m4 file because of the dependency on flint – my Sage builds its own flint, so would also build its own lrslib.


---

Comment by mjo created at 2022-01-15 14:30:42

Replying to [comment:11 gh-mwageringel]:
> My system lrslib seems to be mostly functional, as all the doctests apart from #33101 pass. But it is rejected by the .m4 file because of the dependency on flint – my Sage builds its own flint, so would also build its own lrslib.

This is probably a mistake in the `spkg-configure.m4` for lrslib. If all we do is run the executables from lrslib, we don't care if they're linked to a mismatched version of flint/gmp.


---

Comment by @mwageringel created at 2022-01-17 20:39:55

Replying to [comment:12 mjo]:
> Replying to [comment:11 gh-mwageringel]:
> This is probably a mistake in the `spkg-configure.m4` for lrslib. If all we do is run the executables from lrslib, we don't care if they're linked to a mismatched version of flint/gmp.

Yes, this seems to be the case. I have removed the check for gmp/flint from the .m4 file. Now it works as I would expect – this is the relevant output of configure:

```
Checking whether SageMath should install SPKG lrslib...
checking for lrsnash... lrsnash
checking whether lrsnash can handle the new input format... yes
configure: will use system package and not install SPKG lrslib
```

This is the first time I have edited an .m4 file, so I hope I did not break anything.

Besides that, I have removed a `print` call from the `is_functional` check which was probably not intended in the first place.
----
New commits:


---

Comment by mjo created at 2022-01-18 00:57:14

Replying to [comment:13 gh-mwageringel]:
> This is the first time I have edited an .m4 file, so I hope I did not break anything.

It looks like you deleted the `DEPCHECK` line and its matching `])`, and then un-indented the stuff between? That should be right.

m4 and the `./configure` script are all "stringly typed," so really the only way we have of testing is to run `./configure` in every configuration and watch the output.


---

Comment by @mwageringel created at 2022-01-19 18:27:56

Replying to [comment:15 mjo]:
> It looks like you deleted the `DEPCHECK` line and its matching `])`, and then un-indented the stuff between?

Yes, exactly.

> m4 and the `./configure` script are all "stringly typed," so really the only way we have of testing is to run `./configure` in every configuration and watch the output.

For another data point, I have tested this by replacing the lrsnash binary by a non-functional one, which also leads to the intended result:

```
Checking whether SageMath should install SPKG lrslib...
checking for lrsnash... lrsnash
checking whether lrsnash can handle the new input format... no
configure: no suitable system package found for SPKG lrslib
```



---

Comment by slabbe created at 2022-01-26 20:12:56

Since I saw the problem described in #33231, I wonder if the line

```
result = subprocess.run(command, capture_output=True, text=True)
```

should be put inside of a `try` to catch `OSError` type of failures?


---

Comment by mjo created at 2022-01-27 01:09:37

Replying to [comment:17 slabbe]:
> Since I saw the problem described in #33231, I wonder if the line
> {{{
> result = subprocess.run(command, capture_output=True, text=True)
> }}}
> should be put inside of a `try` to catch `OSError` type of failures?

Yeah, just about anything can go wrong. Another example:


```
sage: from sage.features.imagemagick import ImageMagick
sage: ImageMagick().is_functional()
...
PermissionError: [Errno 13] Permission denied: 'convert'
```


Or with a dangling symlink from graphicsmagick,


```
...
FileNotFoundError: [Errno 2] No such file or directory: 'convert'
```


These aren't normal scenarios, but if there's no way to disable the check, the test suite can't crash whenever e.g. someone installs a broken tool in `/usr/local/bin`.


---

Comment by slabbe created at 2022-01-27 08:56:04

I am now wondering if it should be a join feature instead.
----
New commits:


---

Comment by git created at 2022-01-27 14:09:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-01-27 14:10:40

I made an error in the commit message. I just force-pushed the last commit.


---

Comment by slelievre created at 2022-01-30 15:44:20

Set milestone to sage-9.6 after Sage 9.5 release.


---

Comment by mkoeppe created at 2022-02-03 00:43:57

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-03 00:43:57

Replying to [comment:13 gh-mwageringel]:
> Replying to [comment:12 mjo]:
> > Replying to [comment:11 gh-mwageringel]:
> > This is probably a mistake in the `spkg-configure.m4` for lrslib. If all we do is run the executables from lrslib, we don't care if they're linked to a mismatched version of flint/gmp.
> 
> Yes, this seems to be the case. I have removed the check for gmp/flint from the .m4 file. 

I don't like this change. `polymake` does using lrslib as a library. This is why we need the DEPCHECK.


---

Comment by mjo created at 2022-02-03 01:35:00

Replying to [comment:23 mkoeppe]:
> > 
> > Yes, this seems to be the case. I have removed the check for gmp/flint from the .m4 file. 
> 
> I don't like this change. `polymake` does using lrslib as a library. This is why we need the DEPCHECK.
> 

Do we link against polymake?


---

Comment by mkoeppe created at 2022-02-03 01:36:01

Yes


---

Comment by mjo created at 2022-02-03 01:39:44

Ok, I guess put it back then. A comment would be nice too. We can't expect people to be aware of all second-order optional reverse dependencies when reading these files.


---

Comment by @mwageringel created at 2022-02-03 08:34:18

Replying to [comment:26 mjo]:
> Ok, I guess put it back then. A comment would be nice too.

I have removed the respective commit from the branch and added a comment instead in the last commit.
----
New commits:


---

Comment by @mwageringel created at 2022-02-03 08:34:18

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-03 17:59:09

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2022-02-05 12:59:33

Thanks.


---

Comment by vbraun created at 2022-02-13 10:17:10

Resolution: fixed


---

Comment by mkoeppe created at 2022-03-05 20:49:28

Follow-up: #33466
