# Issue 12327: The density() function of a sparse matrix looks at every matrix entry

Issue created by migration from Trac.

Original creator: jason

Original creation time: 2012-02-11 20:49:15

Assignee: jason, was

CC:  rbeezer

The implementation of the density method for a sparse matrix is insane.  It loops through every single index possible and asks if each entry is zero or nonzero:


```
sage: A=matrix(5000,5000,{(1,2): 1})
sage: A.density()
1/25000000
```


An implementation that instead relied on `A.nonzero_positions()` would be orders of magnitude faster.


---

Comment by ppurka created at 2012-02-13 05:38:18

Changing status from new to needs_review.


---

Comment by ppurka created at 2012-02-13 05:38:18

Replying to [ticket:12499 jason]:
> The implementation of the density method for a sparse matrix is insane.  It loops through every single index possible and asks if each entry is zero or nonzero:
> 
> {{{
> sage: A=matrix(5000,5000,{(1,2): 1})
> sage: A.density()
> 1/25000000
> }}}

Thanks for the idea. An implementation is in [attachment:trac_12499-faster-sparse-matrix-density.patch]. It passes all doctests in `devel/sage/sage/matrix`.

> An implementation that instead relied on `A.nonzero_positions()` would be orders of magnitude faster.

The _orders of magnitude_ turns out to be `10^7` (or 1 billion % in market-speak ;)) for the above example:

```
sage: A=matrix(5000,5000,{(1,2): 1})
sage: timeit('A.density()')
5 loops, best of 3: 11.3 s per loop
sage: timeit('QQ(len(A.nonzero_positions()))/QQ(A.nrows()*A.ncols())')
625 loops, best of 3: 15.6 µs per loop
```



---

Comment by dsm created at 2012-02-13 15:41:39

I think we can improve this further, especially for denser matrices, by adding copy=False:


```

sage: A = MatrixSpace(ZZ, 5000,sparse=True).random_element(density=0.02)
sage: A
5000 x 5000 sparse matrix over Integer Ring (type 'print A.str()' to see all of the entries)
sage: %timeit QQ(len(A.nonzero_positions()))/(QQ(A.nrows()*A.ncols()))        
25 loops, best of 3: 16.5 ms per loop
sage: %timeit QQ(len(A.nonzero_positions(copy=False)))/QQ(A.nrows()*A.ncols())
625 loops, best of 3: 14.3 µs per loop
sage: %timeit QQ(len(A.nonzero_positions(copy=False)))/(A.nrows()*A.ncols())  
625 loops, best of 3: 13.3 µs per loop
```


Removing the second QQ is a micro-optimization but buys you a little..


---

Comment by ppurka created at 2012-02-13 15:55:59

Apply to devel/sage


---

Attachment

Replying to [comment:2 dsm]:
> I think we can improve this further, especially for denser matrices, by adding copy=False:
> Removing the second QQ is a micro-optimization but buys you a little..

Thanks a lot! I am not so familiar with the matrix code. The patch has been updated.


---

Comment by jason created at 2012-02-13 18:30:37

I'm curious: is there any reason why we shouldn't just replace the base class implementation in matrix2.pyx?  I thought general matrices had a nonzero_positions function, and it may be just as fast as what is done now.  I don't know, but just an idea.


---

Comment by jason created at 2012-02-13 18:31:18

(It may very well be that replacing the matrix2.pyx version is much slower because then it has to store and return a huge list of nonzero_positions...)


---

Comment by jason created at 2012-02-13 18:31:54

(Note also that my comment shouldn't prevent a positive review---it's more of just a curious question...)


---

Comment by ppurka created at 2012-02-22 15:25:52

Replying to [comment:5 jason]:
> (It may very well be that replacing the matrix2.pyx version is much slower because then it has to store and return a huge list of nonzero_positions...)

I think you are right there. Returning a huge list will be computationally intensive - the code will be nearly similar to the current code in matrix2.pyx, requiring two `for` loops (see `nonzero_positions` in matrix0.pyx. And the list itself will also gobble up tons of memory. The current method seems best for general matrices.


---

Comment by rbeezer created at 2012-03-18 22:36:43

Changing status from needs_review to positive_review.


---

Comment by rbeezer created at 2012-03-18 22:36:43

Changing keywords from "" to "rd2".


---

Comment by rbeezer created at 2012-03-18 22:36:43

Looks good.  Positive review.


---

Comment by jdemeyer created at 2012-03-23 15:21:18

Resolution: fixed
