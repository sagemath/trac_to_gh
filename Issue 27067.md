# Issue 27067: Bug in factorization of simple symbolic expressions

Issue created by migration from https://trac.sagemath.org/ticket/27304

Original creator: egourgoulhon

Original creation time: 2019-02-16 16:24:07

CC:  rws bpage

Keywords: factor, exponential

As reported in this [ask.sagemath question](https://ask.sagemath.org/question/45469), we have currently (Sage 8.7.beta3):

```
sage: factor(exp(-x)+2*exp(x))
3*e^x
```

This bug is there since at least Sage 8.4.beta4. It is not in Sage 8.3, hence it must have been introduced between 8.4.beta0 and 8.4.beta4.


---

Comment by charpent created at 2019-02-16 17:05:08

Changing priority from major to critical.


---

Comment by charpent created at 2019-02-16 17:05:08

in the same vein :

```
sage: e^(x+2*I*pi)
cosh(-x) - sinh(-x)
```

which is true, but largely not what we seek...

```
sage: e^(x+2*I*pi)==e^x
cosh(-x) - sinh(-x) == e^x
sage: bool(e^(x+2*I*pi)==e^x)
False
```

which is false. But :

```
sage: e^(x+2*I*pi).maxima_methods().exponentialize()
cosh(-x) - sinh(-x)
sage: (e^(x+2*I*pi)).maxima_methods().exponentialize()
e^x
```


Deserves to be `critical`, if not `blocker`.


---

Comment by egourgoulhon created at 2019-02-16 17:12:46

A difference between Sage 8.3 (where the factorization works) and Sage 8.4.beta4 is that in Sage 8.3 the factorization is performed by **Maxima**: cf. these lines of `src/sage/symbolic/expression.pyx` 

```
    def factor(self, dontfactor=[]):
        from sage.calculus.calculus import symbolic_expression_from_maxima_string, symbolic_expression_from_string
        if len(dontfactor) > 0:
            m = self._maxima_()
            name = m.name()
            varstr = ','.join(['_SAGE_VAR_'+str(v) for v in dontfactor])
            cmd = 'block([dontfactor:[%s]],factor(%s))'%(varstr, name)
            return symbolic_expression_from_maxima_string(cmd)
        else:
            try:
                from sage.rings.all import QQ
                f = self.polynomial(QQ)
                w = repr(f.factor())
                return symbolic_expression_from_string(w)
            except (TypeError, NotImplementedError):
                pass
            return self.parent()(self._maxima_().factor())

```

while in Sage 8.4.beta4 and later, it is performed by **pynac** (via the function `g_factor`):

```
     def factor(self, dontfactor=[]):
        from sage.calculus.calculus import symbolic_expression_from_maxima_string
        cdef GEx x
        cdef bint b
        if dontfactor:
            m = self._maxima_()
            name = m.name()
            varstr = ','.join(['_SAGE_VAR_' + str(v) for v in dontfactor])
            cmd = 'block([dontfactor:[%s]],factor(%s))' % (varstr, name)
            return symbolic_expression_from_maxima_string(cmd)
        sig_on()
        try:
            b = g_factor(self._gobj, x)
        finally:
            sig_off()
        if b:
            return new_Expression_from_GEx(self._parent, x)
        else:
            return self
```

Maxima is correct there: in Sage 8.7.beta3, we have

```
./sage -maxima
(%i1) factor(2*exp(x) + exp(-x));     
                                - x      2 x
(%o1)                         %e    (2 %e    + 1)
```

So I would say it is a pynac bug.


---

Comment by egourgoulhon created at 2019-02-16 17:14:04

Changing keywords from "factor, exponential" to "factor, exponential, pynac".


---

Comment by egourgoulhon created at 2019-02-17 10:27:42

The change from Maxima factorization to Pynac one, which triggered the bug, was introduced in #23835, which has been merged in Sage 8.4.beta3.


---

Comment by charpent created at 2019-02-17 11:32:03

This sage-support [post](https://groups.google.com/d/msg/sage-support/tSE0z2ajwug/nHSuCX6_GQAJ) might be related...


---

Comment by embray created at 2019-03-25 10:41:19

Moving all blocker/critical issues from 8.7 to 8.8.


---

Comment by slelievre created at 2019-04-06 16:27:44

Changing priority from critical to blocker.


---

Comment by behackl created at 2019-05-10 18:39:01

Would it be an option to let pynac handle factorization only when called on a rational function and call maxima (just as it was before #23835) otherwise?


---

Comment by charpent created at 2019-05-13 13:58:49

Replying to [comment:12 behackl]:
> Would it be an option to let pynac handle factorization only when called on a rational function and call maxima (just as it was before #23835) otherwise?

**Seconded :**

If that means reverting the changes brought in by #23835, and if that does not break other changes intervening since, this would be a reasonable option (even if bad for performance), and would give people who know what they're talking about time to poner our next move...


---

Comment by egourgoulhon created at 2019-05-13 20:02:54

Replying to [comment:13 charpent]:
> Replying to [comment:12 behackl]:
> > Would it be an option to let pynac handle factorization only when called on a rational function and call maxima (just as it was before #23835) otherwise?
> 
> **Seconded :**
> 

Idem, +1. This sounds a good strategy for the short term. It would indeed be a pity if Sage 8.8 is shipped with such a bug. 
Benjamin, do you intend to take this in charge?


---

Comment by behackl created at 2019-05-14 08:48:56

Replying to [comment:14 egourgoulhon]:
> 
> Idem, +1. This sounds a good strategy for the short term. It would indeed be a pity if Sage 8.8 is shipped with such a bug. 
> Benjamin, do you intend to take this in charge?
> 

I already thought a bit about it, so yes, I will prepare a branch with the (short-term) bugfix I proposed above.


---

Comment by egourgoulhon created at 2019-05-14 09:04:36

Replying to [comment:15 behackl]:
> 
> I already thought a bit about it, so yes, I will prepare a branch with the (short-term) bugfix I proposed above.

Great!


---

Comment by behackl created at 2019-05-14 09:45:32

This is what I would suggest. I'm entirely open for suggestions regarding the name as well as the code for `is_rational_expression`.

Locally, I only checked the doctests in `expression.pyx`, maybe a patchbot finds further occurrences of the symbolic `factor` method where the output has to be changed.
----
New commits:


---

Comment by behackl created at 2019-05-14 09:45:32

Changing status from new to needs_review.


---

Comment by charpent created at 2019-05-14 20:05:51

On top of  8.8.beta5+#27738, builds and passes `ptestlong` exept for a transient (and already reported twice):

```
----------------------------------------------------------------------
sage -t --long --warn-long 151.5 src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py  # 1 doctest failed
----------------------------------------------------------------------
```

which passes when ran standalone.

==> `positive_review`.


---

Comment by charpent created at 2019-05-14 20:05:51

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-05-15 08:24:02

Thank you Benjamin!


---

Comment by vbraun created at 2019-05-21 12:16:08

Resolution: fixed
