# Issue 22787: Replacement of sage/libs/ppl.pyx by pplpy

Issue created by migration from https://trac.sagemath.org/ticket/23024

Original creator: vklein

Original creation time: 2017-05-18 12:30:47

CC:  vdelecroix fbissey embray slelievre

Keywords: thursdaysbdx, ppl, pplpy

Remove ppl.pyx extension and replace with pplpy[https://github.com/videlec/pplpy/](https://github.com/videlec/pplpy/) package.

Some steps :
- list any ticket proposing to extend ppl functionalities in Sage (if yes, open issues on github with cross links)
- see if anybody changed sage/libs/ppl.pyx since the fork (if yes, list the commit and port them into pplpy)
- prepare a package for pplpy as documented in the developer guide
- replace the Sage code calling sage/libs/ppl.pyx to call pplpy


---

Comment by vklein created at 2017-05-18 17:51:48

Changing type from PLEASE CHANGE to enhancement.


---

Comment by git created at 2017-06-07 07:41:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2017-06-07 07:52:09

For testing purpose you can use the following tarball of [pplpy](http://www.labri.fr/perso/vklein/pplpy-0.7.tar.gz) (outdated, use the one in the ticket's description)


---

Comment by vdelecroix created at 2017-06-07 10:24:06

Salut Vincent,

Your branch appears in red which means that there are merge issues (possibly trivial). Would be better to rebase it on the latest beta.


---

Comment by vdelecroix created at 2017-06-07 11:09:30

1) Pickling should be fixed

```diff
-        sage: TestSuite(Asso).run()
+        sage: TestSuite(Asso).run(skip='_test_pickling')
```

It works with `pplpy` used from Python

```
>>> x = ppl.Variable(0)
>>> y = ppl.Variable(1)
>>> z = ppl.Variable(2)
>>> gs.insert(ppl.point(x+y+2*z))
>>> gs.insert(ppl.point(x-y))
>>> gs.insert(ppl.point(z))
>>> P = ppl.C_Polyhedron(gs)
>>> import pickle
>>> pickle.loads(pickle.dumps(P)) == P
True
```



2) I don't see the point of the function `mpz_to_sage_integer`. You can just do `[Integer(x) for x in my_mpz_list]`. For example

```
v_coords = (1,) + tuple(mpz_to_sage_integer(v.coefficients()))
```

can be replaced by

```
v_coords = (1,) + tuple(Integer(c) for c in v.coefficients())
```

Moreover, the name is confusing since the fuction converts a *list* of mpz integers.

3) Some possible simplifications

- In `ppl_backend.pyx`:
`Integer(g.coefficient(Variable(variable))) / Integer(g.divisor())` -> 
`Rational(g.coefficient(Variable(variable)) / g.divisor())`

- In `ppl_lattice_polytope.py`: `assert Integer(v.divisor()).is_one()` -> `assert v.divisor() == 1`


---

Comment by git created at 2017-06-07 14:23:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vklein created at 2017-06-07 15:40:43

Replying to [comment:9 vdelecroix]:
> 3) Some possible simplifications
> 
> - In `ppl_backend.pyx`:
> `Integer(g.coefficient(Variable(variable))) / Integer(g.divisor())` -> 
> `Rational(g.coefficient(Variable(variable)) / g.divisor())`
> 
> - In `ppl_lattice_polytope.py`: `assert Integer(v.divisor()).is_one()` -> `assert v.divisor() == 1`

It will be nice, but coercion for gmpy2 types is required for doing this (#23052).


---

Comment by git created at 2017-06-07 15:49:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-06-07 20:46:51

Replying to [comment:11 vklein]:
> Replying to [comment:9 vdelecroix]:
> > 3) Some possible simplifications
> > 
> > - In `ppl_backend.pyx`:
> > `Integer(g.coefficient(Variable(variable))) / Integer(g.divisor())` -> 
> > `Rational(g.coefficient(Variable(variable)) / g.divisor())`
> > 
> > - In `ppl_lattice_polytope.py`: `assert Integer(v.divisor()).is_one()` -> `assert v.divisor() == 1`
> 
> It will be nice, but coercion for gmpy2 types is required for doing this (#23052).

Where? The first involves a direct call `Rational(mpq_type)` and the second comparison between `mpz` and Python integer. Which operation is mixing gmpy2 types with Sage types?


---

Comment by vklein created at 2017-06-08 08:44:17

Replying to [comment:13 vdelecroix]:
> 
> Where? The first involves a direct call `Rational(mpq_type)` and the second comparison between `mpz` and Python integer. Which operation is mixing gmpy2 types with Sage types?
You're right, tests failures in ppl_backend.pyx with the suggested code are not coercion related. Forget my previous comment.


---

Comment by git created at 2017-06-08 18:00:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2017-06-08 18:04:05

As pplpy has evolved to fix pickling with cPickle download [pplpy](http://www.labri.fr/perso/vklein/pplpy-0.7.tar.gz) again to update your local package.


---

Comment by git created at 2017-06-09 14:04:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-15 12:48:03

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by vklein created at 2017-06-15 13:02:06

As pplpy has evolved to fix pickling with cPickle download ​pplpy again to update your local package.


---

Comment by git created at 2017-11-17 15:31:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2017-11-24 18:47:36

[pplpy 0.7](https://pypi.python.org/pypi/pplpy/0.7) is out


---

Comment by git created at 2017-12-19 15:40:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vklein created at 2017-12-19 15:42:44

Rebase on 22928 (with 22928 based on 8.2.beta0)


---

Comment by vdelecroix created at 2017-12-19 21:22:56

You need to provide a link to the pplpy tarball.


---

Comment by vdelecroix created at 2017-12-19 21:27:51

And proper deprecation has to be done for `sage.libs.ppl` so that a user doing

```
sage: from sage.libs.ppl import whatever
```

should not get an `ImportError` but a warning. See http://doc.sagemath.org/html/en/reference/misc/sage/misc/superseded.htm


---

Comment by vklein created at 2017-12-20 10:32:38

And by proper deprecation do you mean keeping sage.libs.ppl fully functioning with his doctests ? Or do we prefer to shutdown sage.libs.ppl functionalities (Functions don't do their old work and just return a warning) ?


---

Comment by vdelecroix created at 2017-12-20 10:41:03

Replying to [comment:30 vklein]:
> And by proper deprecation do you mean keeping sage.libs.ppl fully functioning with his doctests ? Or do we prefer to shutdown sage.libs.ppl functionalities (Functions don't do their old work and just return a warning) ?

The aim is not to keep `sage.libs.ppl` but to just to have some indirection in the import so that you do not break user's code. As `sage.libs.ppl` will not here anymore I do not expect the full doctesuite to pass as it used to be. But the following kind of things should work (and be doctested)

```
sage: from sage.libs.ppl import Variable, Constraint_System, C_Polyhedron
UserWarning: proper deprecation message
sage: x = Variable(0)
sage: y = Variable(1)
sage: cs = Constraint_System()
sage: cs.insert(x >= 0)
sage: cs.insert(x <= 3)
sage: cs.insert(y >= 0)
sage: cs.insert(y <= 3)
sage: poly_from_constraints = C_Polyhedron(cs)
```

And the various objects constructed above are of course from pplpy.

You can have a look at other places in the sage code and look for "deprecation" and "lazy_import".


---

Comment by vklein created at 2017-12-20 11:10:53

Well, i spoke with Sebastien L. and if the goal is to let one year for developers to adapt their old code, doing an indirection is not enough. Mainly because pplpy use gmpy2 (some functions return and calls are differents).

Therefore it seems like we should keep `sage.libs.ppl` old code with added warnings.


---

Comment by fbissey created at 2017-12-21 01:47:51

Just a small request can you put upstream's address in SPKG.txt? Of course you are available on pypi but it is not the same as being able to find where to fill bugs and what the current issues are straight away.


---

Comment by git created at 2017-12-21 07:57:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2017-12-21 08:01:17

Done, thanks for noticing that.


---

Comment by git created at 2017-12-21 09:41:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2017-12-21 09:45:31

Deprecation of `sage.libs.ppl` added. As the whole module is deprecated i choose to send deprecation warning at import time.


---

Comment by vdelecroix created at 2017-12-21 10:05:52

Replying to [comment:38 vklein]:
> Deprecation of `sage.libs.ppl` added. As the whole module is deprecated i choose to send deprecation warning at import time.

Good solution.

Now, we just need to wait for #22928...


---

Comment by vdelecroix created at 2017-12-21 15:56:48

Did you run the testsuite!?

```
sage -t src/sage/geometry/lattice_polytope.py
**********************************************************************
File "src/sage/geometry/lattice_polytope.py", line 1608, in sage.geometry.lattice_polytope.LatticePolytopeClass.boundary_point_indices
Failed example:
    face.points()
Exception raised:
    Traceback (most recent call last):
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.lattice_polytope.LatticePolytopeClass.boundary_point_indices[4]>", line 1, in <module>
        face.points()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/geometry/lattice_polytope.py", line 3680, in points
        l = gcd(v)
    NameError: global name 'gcd' is not defined
```



---

Comment by git created at 2017-12-21 16:37:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2017-12-21 16:42:35

Yes i have see this one. 
The last remaining problem is a SEGFAULT when running ppl_lattice_polytope.py doctests.


---

Comment by vdelecroix created at 2017-12-21 16:46:10

Could you post the log here?


---

Comment by vklein created at 2017-12-21 16:53:33

Replying to [comment:43 vdelecroix]:
> Could you post the log here?
[segfault_ppl_lattice_polytope.log](http://www.labri.fr/perso/vklein/segfault_ppl_lattice_polytope.log)

Short story is 

```
sage: LatticePolytope_PPL((0,0),(1/2,1))
```

cause a Segfault.


---

Comment by vdelecroix created at 2017-12-21 17:19:01

Isn't it https://github.com/aleaxit/gmpy/pull/174?


---

Comment by vdelecroix created at 2017-12-21 17:27:58

At least with the patch applied I got

```
sage: from sage.geometry.polyhedron.ppl_lattice_polytope import LatticePolytope_PPL
sage: LatticePolytope_PPL((0,0),(1/2,1))
Traceback (most recent call last):
...
TypeError: rational is not an integer
```



---

Comment by vdelecroix created at 2017-12-21 17:33:46

See #24417


---

Comment by vklein created at 2017-12-21 18:27:21

Replying to [comment:45 vdelecroix]:
> Isn't it https://github.com/aleaxit/gmpy/pull/174?
Yes it is ! Nicely done.


---

Comment by git created at 2018-01-31 16:40:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2018-01-31 16:45:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-01-31 16:56:29

You are adding `sage.libs.gmpy2` in `7596cff` and removing it in `91b5d52`...


---

Comment by vklein created at 2018-01-31 17:01:22

Yes adding it was one of our old solutions. Before having a better include in pplpy's `setup.py` if i remember correctly. All of this historical things can be squashed later.


---

Comment by vklein created at 2018-01-31 17:02:45

It's the same for `ppl.pyx` we don't need to show that we deleted it and restore and deprecate later.


---

Comment by vdelecroix created at 2018-02-01 08:21:20

There are a lot of trailing whitespaces that should be removed.


---

Comment by git created at 2018-02-01 09:45:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-02-01 09:49:06

History rewrited. Trailing whitespaces removed in `real_mpfr.pyx`, `complex_mpc.pyx` and `complex_number.pyx` files.


---

Comment by vdelecroix created at 2018-02-02 13:49:36

I don't understand why you are modifying `pplpy/SPKG.txt`, `pplpy/checksums.ini`, `pplpy/spkg-check`, etc in both `886424b` and `​a6e1cc7`.


---

Comment by vdelecroix created at 2018-02-03 09:47:39

Build fine and all tests pass on my computer!


---

Comment by jdemeyer created at 2018-02-05 08:50:28

Use `sdh_pip_install` instead of `$PIP_INSTALL`


---

Comment by jdemeyer created at 2018-02-05 08:52:26

Is the license of pplpy really `GPL version 3`? Or do you mean `GPL version 3 or later`? The difference is important.


---

Comment by jdemeyer created at 2018-02-05 08:54:43

This looks like a strange way to check if something is one:

```
Integer(p.divisor()).is_one()
```

What's wrong with

```
p.divisor() == 1
```



---

Comment by vklein created at 2018-02-05 08:57:29

Replying to [comment:61 jdemeyer]:
> Is the license of pplpy really `GPL version 3`? Or do you mean `GPL version 3 or later`? The difference is important.
Yes the current one is `GPL version 3` (see [LICENSE.txt](https://github.com/videlec/pplpy/blob/master/LICENSE.txt)). Is it better to say `GPL version 3 or later` anyway ?


---

Comment by jdemeyer created at 2018-02-05 09:01:24

In `backend_ppl.py` you do `from gmpy2 import mpz` but you're not using it.


---

Comment by jdemeyer created at 2018-02-05 09:04:32

Replying to [comment:63 vklein]:
> Is it better to say `GPL version 3 or later` anyway ?

See https://github.com/videlec/pplpy/issues/28


---

Comment by vklein created at 2018-02-05 10:02:43

Replying to [comment:62 jdemeyer]:
> What's wrong with
> {{{
> p.divisor() == 1
> }}}
p.divisor() return a `gmpy2.mpz`.


---

Comment by git created at 2018-02-05 10:16:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-02-05 23:00:18

Replying to [comment:66 vklein]:
> Replying to [comment:62 jdemeyer]:
> > What's wrong with
> > {{{
> > p.divisor() == 1
> > }}}
> p.divisor() return a `gmpy2.mpz`.

What is wrong with

```
>>> gmpy2.mpz(1) == 1
True
```



---

Comment by vklein created at 2018-02-06 08:10:11

Replying to [comment:68 vdelecroix]:
> ...
> What is wrong with
> {{{
> >>> gmpy2.mpz(1) == 1
> True
> }}}
\\

In this case you compare a python `int` with a `gmpy2.mpz`. \\

But with sage's `Integer` : 

```
sage: gmpy2.mpz(1) == 1
False
```


Edit: Hum ok my bad.


---

Comment by git created at 2018-02-06 08:40:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-02-06 16:27:35

self-testing fails:


```
$ SAGE_CHECK=yes ./sage -f pplpy
...
[pplpy-0.7] Successfully installed pplpy-0.7
[pplpy-0.7] Cleaning up...
[pplpy-0.7] 
[pplpy-0.7] real	0m38.345s
[pplpy-0.7] user	0m36.490s
[pplpy-0.7] sys	0m1.835s
[pplpy-0.7] Copying package files from temporary location /home/dima/Sage/sage-dev/local/var/tmp/sage/build/pplpy-0.7/inst to /home/dima/Sage/sage-dev/local
[pplpy-0.7] Running the test suite for pplpy-0.7...
[pplpy-0.7] running test
[pplpy-0.7] error: cannot copy tree './tests': not a directory
[pplpy-0.7] 
```



---

Comment by vklein created at 2018-02-06 17:09:09

Indeed. https://github.com/videlec/pplpy/issues/30


---

Comment by embray created at 2019-01-18 13:11:27

This would still be a good thing to do IMO, in general.


---

Comment by git created at 2019-01-22 17:08:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-01-22 17:13:21

Rebased on sage8.6


---

Comment by git created at 2019-01-23 18:36:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-01-23 18:37:21

upgrade pplpy to 0.8.1


---

Comment by vklein created at 2019-01-23 18:37:21

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-01-24 07:04:45

Apparently a merge failure with sage 8.7.beta0


---

Comment by git created at 2019-01-24 10:34:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-01-24 10:35:59

Solve merge failure with sage 8.7.beta0.


---

Comment by dimpase created at 2019-01-24 10:55:06

- off-topic - Vincent, please provide info on 
https://github.com/OpenDreamKit/OpenDreamKit/issues/281


---

Comment by vdelecroix created at 2019-01-27 16:57:49

You should set `gmpy2` and `pplpy` as dependencies of the Sage library (otherwise building the Cython code might fail). This is done in `build/make/deps`.


---

Comment by vdelecroix created at 2019-01-27 16:57:49

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-01-27 16:59:37

Why

```diff
-            sage: TestSuite(P).run(skip='_test_pickling')
+            sage: TestSuite(P).run(skip=('_test_pickling'))
```



---

Comment by vdelecroix created at 2019-01-27 17:00:55

And

```diff
-    def _repr_(self):
+    def __repr__(self):
```



---

Comment by vdelecroix created at 2019-01-27 17:26:49

The links in the documentation `:class:`ppl.C_Polyhedron``, `:class:`~ppl.Polyhedron``, etc are broken. These should not be sphinx links at all.


---

Comment by dimpase created at 2019-01-27 18:07:28

Does pplpy build/install its own docs? This kind of setup is used e.g. in cvxopt.


---

Comment by vdelecroix created at 2019-01-27 18:10:19

Replying to [comment:91 dimpase]:
> Does pplpy build/install its own docs? This kind of setup is used e.g. in cvxopt.

It does build documentation if you ask it to. Tough it does not install anything (perhaps it should?). But even with properly installed documentation, I don't see how to make linking work properly.


---

Comment by dimpase created at 2019-01-27 18:21:08

Packages install docs into `$SAGE_LOCAL/share/doc/`. I guess that docs can be linked to docs in Sage code via relative paths, i.e. `../../..`


---

Comment by vklein created at 2019-01-28 16:04:03

Replying to [comment:89 vdelecroix]:
> And
> {{{#!diff
> -    def _repr_(self):
> +    def __repr__(self):
> }}}

That's because `LatticePolytope_PPL_class` now inherit from pplpy's `C_Polyhedron` and therefore `LatticePolytope_PPL_class` is not a `SageObject`.


---

Comment by vklein created at 2019-01-28 16:58:18

Replying to [comment:93 dimpase]:
> Packages install docs into `$SAGE_LOCAL/share/doc/`. I guess that docs can be linked to docs in Sage code via relative paths, i.e. `../../..` 

I can try. \\
But i can see a potential problem here: most packages seems to install documentation on if `[This is the Trac macro *"$SAGE_SPKG_INSTALL_DOCS" = yes * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#"$SAGE_SPKG_INSTALL_DOCS" = yes -macro)`. \\
If we do the same for pplpy, given `$SAGE_SPKG_INSTALL_DOCS` default value is not `yes` that mean that the links will be broken by default.

I think there is many distinct questions :\\
- 1. Should we install a pplpy documentation ?
- 2. If yes should we install it only if `"$SAGE_SPKG_INSTALL_DOCS" = yes` ?
- 3. If yes to 1. and yes to 2. should we link the sagemaths documentation with pplpy's.


---

Comment by git created at 2019-01-28 17:03:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-01-29 07:19:17

It is a good practice to have the first line of the commit below 50 characters. More precisely, any commit message should be

```
one line with <= 50 characters
(optional) linebreak
(optional) more extensive paragraph with lines <= 72 characters
```



---

Comment by vdelecroix created at 2019-01-29 07:59:09

Replying to [comment:95 vklein]:
> Replying to [comment:93 dimpase]:
> > Packages install docs into `$SAGE_LOCAL/share/doc/`. I guess that docs can be linked to docs in Sage code via relative paths, i.e. `../../..` 
> 
> I can try. \\
> But i can see a potential problem here: most packages seems to install documentation on if `[This is the Trac macro *"$SAGE_SPKG_INSTALL_DOCS" = yes * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#"$SAGE_SPKG_INSTALL_DOCS" = yes -macro)`. \\
> If we do the same for pplpy, given `$SAGE_SPKG_INSTALL_DOCS` default value is not `yes` that mean that the links will be broken by default.
> 
> I think there is many distinct questions :\\
> - 1. Should we install a pplpy documentation ?
> - 2. If yes should we install it only if `"$SAGE_SPKG_INSTALL_DOCS" = yes` ?
> - 3. If yes to 1. and yes to 2. should we link the sagemaths documentation with pplpy's.

I don't know what is the way to proceed. See https://gitlab.com/videlec/pplpy/issues/12

For now I would say:
- remove all links in the Sage documentation
- in each relevant module, make a reference to the pplpy development website (https://gitlab.com/videlec/pplpy) and pplpy documentation website (http://www.labri.fr/perso/vdelecro/pplpy/latest/).


---

Comment by dimpase created at 2019-01-29 09:41:16

I've left comments in https://gitlab.com/videlec/pplpy/issues/12
namely there appears to be a Sphinx extension to link different projects.

It's too early to start blindly removing links to docs, probably there is a more intelligent way to preserve what is already there.


---

Comment by vdelecroix created at 2019-01-29 14:10:40

Replying to [comment:95 vklein]:
> Replying to [comment:93 dimpase]:
> > Packages install docs into `$SAGE_LOCAL/share/doc/`. I guess that docs can be linked to docs in Sage code via relative paths, i.e. `../../..` 
> 
> I can try. \\
> But i can see a potential problem here: most packages seems to install documentation on if `[This is the Trac macro *"$SAGE_SPKG_INSTALL_DOCS" = yes * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#"$SAGE_SPKG_INSTALL_DOCS" = yes -macro)`. \\
> If we do the same for pplpy, given `$SAGE_SPKG_INSTALL_DOCS` default value is not `yes` that mean that the links will be broken by default.
> 
> I think there is many distinct questions :\\
> - 1. Should we install a pplpy documentation ?

We should compile *and* install.

> - 2. If yes should we install it only if `"$SAGE_SPKG_INSTALL_DOCS" = yes` ?

I don't know. Where is `SAGE_SPKG_INSTALL_DOCS` documented?

> - 3. If yes to 1. and yes to 2. should we link the sagemaths documentation with pplpy's.

See #27164.


---

Comment by vklein created at 2019-01-29 15:37:55

Replying to [comment:100 vdelecroix]:
> ...
> > - 2. If yes should we install it only if `"$SAGE_SPKG_INSTALL_DOCS" = yes` ?
> 
> I don't know. Where is `SAGE_SPKG_INSTALL_DOCS` documented?
> 

Here http://doc.sagemath.org/html/en/installation/source.html.


**SAGE_SPKG_INSTALL_DOCS** - if set to yes, then install package-specific documentation to $SAGE_ROOT/local/share/doc/PACKAGE_NAME/ when an spkg is installed. This option may not be supported by all spkgs. Some spkgs might also assume that certain programs are available on the system (for example, latex or pdflatex).


---

Comment by git created at 2019-01-29 16:25:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-01-29 18:31:15

Replying to [comment:101 vklein]:
> Replying to [comment:100 vdelecroix]:
> > ...
> > > - 2. If yes should we install it only if `"$SAGE_SPKG_INSTALL_DOCS" = yes` ?
> > 
> > I don't know. Where is `SAGE_SPKG_INSTALL_DOCS` documented?
> > 
> 
> Here http://doc.sagemath.org/html/en/installation/source.html.
> 
> 
> **SAGE_SPKG_INSTALL_DOCS** - if set to yes, then install package-specific documentation to $SAGE_ROOT/local/share/doc/PACKAGE_NAME/ when an spkg is installed. This option may not be supported by all spkgs. Some spkgs might also assume that certain programs are available on the system (for example, latex or pdflatex).

I believe it has been done that way a long time ago when Sage was not thought modular at all. Some of the package documentation (including pplpy) might be automatically installed unless SAGE_SPKG_INSTALL_DOCS is explicitely set to "no".


---

Comment by git created at 2019-01-30 15:53:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-01-30 15:55:33

For testing purpose use https://www.labri.fr/perso/vklein/pplpy-0.8.2b0.tar.gz with `ef89978`.


---

Comment by vklein created at 2019-01-30 16:03:43

`ef89978` Implements the compilation and installation of pplpy's documentation.

The current implementation drawback is that pplpy is compiled two times (one time for package installation and one time using "inplace" build in preparation for sphinx).

To avoid that i am looking for an elegant and generic way to express `PYTHONPATH=$PYTHONPATH:$SAGE_DESTDIR_LOCAL/lib/python2.7/site-packages`.

I haven't find an environment variable for `lib/python2.7/site-packages` or something equivalent.

Any help is welcomed.


---

Comment by git created at 2019-01-30 17:15:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-01-30 17:20:20

`d8c41f6` Fix intersphinx question.

I wait for returns for [#comment:106](https://trac.sagemath.org/ticket/23024#comment:106) and for a new pplpy official version before setting this ticket in need_review.


---

Comment by dimpase created at 2019-01-30 17:39:06

I wonder whether you tried to set up a link to pplpy docs in Sage's reference manual, something that ought to be done for many more packages...


---

Comment by vklein created at 2019-01-30 17:52:28

Replying to [comment:109 dimpase]:
> I wonder whether you tried to set up a link to pplpy docs in Sage's reference manual, something that ought to be done for many more packages...
\\

I am not sure what is your question about.\\

I have think about doing the intersphinx link at reference level yes. But IMHO doing it under common is a better call.\\

I haven't tried to do direct html link with relative path.


---

Comment by dimpase created at 2019-01-30 17:58:49

I meant to ask whether you managed to replace the docs link to PPL backend
in the reference manual, such as
http://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/backend_ppl.html
(its local equivalent would have something else instead of `http://doc.sagemath.org/` part, naturally)
with the link to the pplpy docs.


---

Comment by vdelecroix created at 2019-01-30 19:02:03

Crossed links does not work for me (e.g. the `ppl.C_Polyhedron` in the file `en/reference/discrete_geometry/sage/geometry/polyhedron/ppl_lattice_polytope.html`) ... did you do something special in order to make it work for you?


---

Comment by vklein created at 2019-01-31 07:45:49

Replying to [comment:112 vdelecroix]:
> Crossed links does not work for me (e.g. the `ppl.C_Polyhedron` in the file `en/reference/discrete_geometry/sage/geometry/polyhedron/ppl_lattice_polytope.html`) ... did you do something special in order to make it work for you?

Maybe try a `make doc-clean`. ``ppl.C_Polyhedron`` should have been replaced by ``ppl.polyhedron.C_Polyhedron``.


---

Comment by vdelecroix created at 2019-01-31 07:51:51

Replying to [comment:113 vklein]:
> Replying to [comment:112 vdelecroix]:
> > Crossed links does not work for me (e.g. the `ppl.C_Polyhedron` in the file `en/reference/discrete_geometry/sage/geometry/polyhedron/ppl_lattice_polytope.html`) ... did you do something special in order to make it work for you?
> 
> Maybe try a `make doc-clean`. ``ppl.C_Polyhedron`` should have been replaced by ``ppl.polyhedron.C_Polyhedron``.

I did `make doc-clean`, `sage -f pplpy` and `make doc`.


---

Comment by vdelecroix created at 2019-01-31 07:53:14

I know what I did wrong: I did not pull your last commits... sorry for the noise.


---

Comment by vdelecroix created at 2019-01-31 08:12:54

It is working now!


---

Comment by vdelecroix created at 2019-01-31 08:15:29

I will make a new release of pplpy.

Could you ask about [comment:106] on sage-devel? This is a general problem when a package needs to be installed before being able to build the docs. Perhaps this is a problem with the package itself or in the way our current staged installation works in Sage. But then, it is not clear to me how to solve it.


---

Comment by vklein created at 2019-01-31 08:51:57

For comment:106 : link to the post on sage-devel https://groups.google.com/forum/#!topic/sage-devel/IOn7wneT8xo


---

Comment by vklein created at 2019-01-31 09:07:17

Replying to [comment:111 dimpase]:
> I meant to ask whether you managed to replace the docs link to PPL backend
> in the reference manual, such as
> http://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/backend_ppl.html
> (its local equivalent would have something else instead of `http://doc.sagemath.org/` part, naturally)
> with the link to the pplpy docs.\\


I managed to replace the doc links of type `sage.libs.ppl.*`. But there is no such kind of doclinks under `backend_ppl.html`. Class like `sage.geometry.polyhedron.base_QQ.Polyhedron_QQ` are still sage classes.


---

Comment by vdelecroix created at 2019-01-31 13:12:01

Alternative: include the compiled doc in the source tarball so that the spkg-install script just need to copy it...


---

Comment by dimpase created at 2019-01-31 13:14:57

Replying to [comment:120 vdelecroix]:
> Alternative: include the compiled doc in the source tarball so that the spkg-install script just need to copy it...
 
-1. I'd rather run the installation twice than this.


---

Comment by vklein created at 2019-01-31 13:18:28

Replying to [comment:120 vdelecroix]:
> Alternative: include the compiled doc in the source tarball so that the spkg-install script just need to copy it...

Why not. It will increase the tarball size of something like 200 kbytes.


---

Comment by vklein created at 2019-01-31 13:23:40

Replying to [comment:121 dimpase]:
> Replying to [comment:120 vdelecroix]:
> > Alternative: include the compiled doc in the source tarball so that the spkg-install script just need to copy it...
>  
> -1. I'd rather run the installation twice than this.

Why ? (I personally have no preferences between the two solutions).


---

Comment by dimpase created at 2019-01-31 13:24:24

Replying to [comment:122 vklein]:
> Replying to [comment:120 vdelecroix]:
> > Alternative: include the compiled doc in the source tarball so that the spkg-install script just need to copy it...
> 
> Why not. It will increase the tarball size of something like 200 kbytes.

The external tarball can contain extra 200K, sure, but already "just copying" has to be done properly, in order not to break package de-installation.
Besides, there is no guarantee it would look nice enough, so that it matches the current Sage docs style, etc.


---

Comment by vklein created at 2019-01-31 13:29:38

Ok i see. And i agree that having the same sphinx install generating both documentation is a good thing.


---

Comment by git created at 2019-02-01 08:35:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vklein created at 2019-02-01 08:42:28

Upgrade pplpy to 8.2.\\
Rebase on sage 8.7.beta1.\\
\\
For the doc generation, i think we can go with the double compilation now and switch\\
to a better solution later if we find one.


---

Comment by git created at 2019-02-01 08:55:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-02-01 08:57:17

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-02-01 08:57:17

Rewrite ticket history.


---

Comment by vdelecroix created at 2019-02-01 11:09:38

To my mind, a better solution has to be found for

```
+    # Compile pplpy's documentation
+    sage-python23 setup.py build_ext --inplace
+    PYTHONPATH=$PYTHONPATH:$(pwd)
+    cd docs
+    $MAKE html
```



---

Comment by dimpase created at 2019-02-01 12:05:13

As long as gmpy2 is optional, this package cannot be standard, as it depends on gmpy2.

(Edit - I misread the ticket description, hence the edit). I recall last time there was a discussion about gmpy2 being standard, there were quite a bit of objections. Do they still stand?


---

Comment by vklein created at 2019-02-01 16:00:39

Yes, this is the discussion link https://groups.google.com/forum/?#!topic/sage-devel/qoxVng1__0A.

The discussion/objections where more about what types pplpy should return (Sage numbers or gmpy2 numbers).

The last 3 messages for gmpy2 solution have never been answered, but rereading the thread it's true that it doesn't mean that we have an explicit consensus.

I put this ticket on hold in wait for better solution for generating documentation.\\

I will repost on the discussion thread when this ticket is ready.


---

Comment by vklein created at 2019-02-01 16:00:39

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-02-01 23:53:53

Replying to [comment:130 vdelecroix]:
> To my mind, a better solution has to be found for
> {{{
> +    # Compile pplpy's documentation
> +    sage-python23 setup.py build_ext --inplace
> +    PYTHONPATH=$PYTHONPATH:$(pwd)
> +    cd docs
> +    $MAKE html
> }}}

the question is - are you prepared to patch pplpy sources?
Comparing their docs/Makefile with https://github.com/sagemath/sagenb/blob/master/doc/Makefile
seems to say that there are sphinx options one might try to use to do everything in one build, not in two.


---

Comment by vklein created at 2019-02-06 10:45:35

I haven't find a decisive difference between the two Makefile. The most obvious one being that pplpy use `sphinx-build -b` and sagenb use `sphinx-build -M`.\\
\\
I have tried with `-M` and get the same result.\\
I think the reason it works with `sagenb` is because it doesn't have cython files and therefore the source directory is enough for the sphinx build to succeed.


---

Comment by git created at 2019-02-14 14:03:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-02-14 14:12:07

Add a workaround to avoid two build and rebase on 8.7.beta3.


---

Comment by vdelecroix created at 2019-02-14 14:25:36

It is not working for me

```
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl'; the following exception was raised:
[pplpy-0.8.2] No module named ppl
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.constraint'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.constraint
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.linear_algebra'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.linear_algebra
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.generator'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.generator
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.polyhedron'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.polyhedron
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.mip_problem'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.mip_problem
```



---

Comment by vdelecroix created at 2019-02-14 14:25:49

And shouldn't `python` be `python23`?


---

Comment by vdelecroix created at 2019-02-14 14:28:44

And the command you provided is very suspicious to me. Inside the sage shell

```
$ python -c "import site; print(site.getusersitepackages().replace(site.getuserbase(), ''))"
/home/vincent/.sage/local/lib/python2.7/site-packages
```

And using string `replace` is not an option

```
>>> import site
>>> site.getusersitepackages()
'/home/vincent/.sage/local/lib/python2.7/site-packages'
>>> site.getuserbase()
'/home/vincent/.sage//local'
```



---

Comment by vdelecroix created at 2019-02-14 14:35:55

This already looks more reasonable

```
>>> import sysconfig
>>> sysconfig.get_paths(expand=False)
{'purelib': '{base}/lib/python{py_version_short}/site-packages',
 'stdlib': '{base}/lib/python{py_version_short}',
 'scripts': '{base}/bin',
 'platinclude': '{platbase}/include/python{py_version_short}',
 'include': '{base}/include/python{py_version_short}',
 'data': '{base}', 'platstdlib':
 '{platbase}/lib/python{py_version_short}',
 'platlib': '{platbase}/lib/python{py_version_short}/site-packages'
}
```



---

Comment by vdelecroix created at 2019-02-14 14:48:19

I believe that what you want is

```
>>> import sysconfig
>>> py_version_short = sysconfig.get_config_vars()['py_version_short']
>>> path = sysconfig.get_path('platlib', expand=False)
>>> path.format(platbase="$SAGE_DESTDIR_LOCAL", py_version_short=py_version_short)
'$SAGE_DESTDIR_LOCAL/lib/python2.7/site-packages'
```



---

Comment by vklein created at 2019-02-14 15:03:14

the site module is already supposed to do the job in a generic way : 


```
def _get_path(userbase):
    version = sys.version_info

    if os.name == 'nt':
        return f'{userbase}\\Python{version[0]}{version[1]}\\site-packages'

    if sys.platform == 'darwin' and sys._framework:
        return f'{userbase}/lib/python/site-packages'

    return f'{userbase}/lib/python{version[0]}.{version[1]}/site-packages'
```


Python version is not always used


---

Comment by git created at 2019-02-14 15:12:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-02-14 15:14:20

Replying to [comment:138 vdelecroix]:
> And shouldn't `python` be `python23`?
Yes you are right.\\
Workaround fixed and enhanced with Erik Bray's help.


---

Comment by vdelecroix created at 2019-02-14 15:20:00

Same as before

```
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl'; the following exception was raised:
[pplpy-0.8.2] No module named ppl
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.constraint'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.constraint
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.linear_algebra'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.linear_algebra
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.generator'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.generator
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.polyhedron'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.polyhedron
[pplpy-0.8.2] WARNING: autodoc: failed to import module u'ppl.mip_problem'; the following exception was raised:
[pplpy-0.8.2] No module named ppl.mip_problem
```



---

Comment by vklein created at 2019-02-14 15:35:06

Can you post or mail me the whole log ?


---

Comment by vklein created at 2019-02-14 15:53:09

Ok i have an obvious bug in my `spgk_install` file


---

Comment by git created at 2019-02-14 20:46:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-02-14 20:46:59

It's fixed sorry for the previous commit.


---

Comment by vdelecroix created at 2019-02-14 20:59:50

Why does sphinx inventory connect to internet!?

```
[pplpy-0.8.2] loading intersphinx inventory from http://docs.python.org/objects.inv...
```



---

Comment by vklein created at 2019-02-14 21:07:56

I believe because of `pplpy's` `conf.py` last line :

```
# Example configuration for intersphinx: refer to the Python standard library.
intersphinx_mapping = {'http://docs.python.org/': None}
```


This says pplpy's intersphinx needs python's `objects.inv`.

Wich isn't true if i am not wrong ( I don't remember a sphinx link to python documentation in pplpy's documentation)


---

Comment by vdelecroix created at 2019-02-14 22:28:53

new tarball ready


---

Comment by git created at 2019-02-14 22:54:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-14 23:28:30

Ticket ready for review.

Don't set this ticket to positive review right now.\\
We need to clarify the discussion 
https://groups.google.com/forum/?#!topic/sage-devel/qoxVng1__0A first.


---

Comment by vklein created at 2019-02-14 23:28:30

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-02-18 10:14:32

Replying to [comment:154 vklein]:
> Don't set this ticket to positive review right now.\\
> We need to clarify the discussion 
> https://groups.google.com/forum/?#!topic/sage-devel/qoxVng1__0A first.

What is the status of the discussion now?


---

Comment by vdelecroix created at 2019-02-19 10:03:05

Note: for the documentation build, there is also the possibility to use the `spkg-postinst` script (that is run after the installation in `$SAGE_LOCAL`).


---

Comment by vklein created at 2019-02-19 12:48:13

Replying to [comment:156 vdelecroix]:
> Note: for the documentation build, there is also the possibility to use the `spkg-postinst` script (that is run after the installation in `$SAGE_LOCAL`).

Yes that's true. The reason to keep the documentation build in `spkg-inst` is because it's currently the standard way of doing it. Tell me what you prefer.


---

Comment by vdelecroix created at 2019-02-19 13:05:42

Replying to [comment:157 vklein]:
> Replying to [comment:156 vdelecroix]:
> > Note: for the documentation build, there is also the possibility to use the `spkg-postinst` script (that is run after the installation in `$SAGE_LOCAL`).
> 
> Yes that's true. The reason to keep the documentation build in `spkg-inst` is because it's currently the standard way of doing it. Tell me what you prefer.

To my knowledge, no package had this problem before (ie building the doc depending on the library being installed). Everything that would avoid modifying `PYTHONPATH` looks nicer to me. But that is my own feeling.


---

Comment by git created at 2019-02-19 14:12:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-19 14:15:38

Ok seems fair. `spkg-postinst` script added.


---

Comment by vdelecroix created at 2019-02-19 14:28:45

Having a comment in the `spkg-install` script is good but I think that it would be even nicer with an explanation of why this is moved inside the `spkg-postinst` script.


---

Comment by git created at 2019-02-19 14:42:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-19 14:45:34

Ok, explanation added.


---

Comment by vdelecroix created at 2019-02-19 14:50:06

The current status is good for me. Thanks Vincent.

Any comment Dima?


---

Comment by dimpase created at 2019-02-20 07:54:50

How about src/sage/numerical/backends/ppl_backend.pyx ?
Do you at least have a ticket to work on replacing this with pplpy?


---

Comment by vklein created at 2019-02-20 08:04:32

ppl_backend.pyx is modified in this ticket. This is not replaced but `ppl_backend.pyx` methods use pplpy instead of using sage.lib.ppl.

see: https://git.sagemath.org/sage.git/diff/src/sage/numerical/backends/ppl_backend.pyx?id=fed0a135795f8f076d7ffaf69aecc84f2f096b5d


---

Comment by vklein created at 2019-02-20 09:10:18

`@`Dima tell me if you think it's ok or if you think `ppl_backend.pyx` should be reworked in another way.


---

Comment by dimpase created at 2019-02-20 09:34:37

I recall that ppl_backend.pyx had a tricky part due to the inability of PPL to work with rationals - everything had to be integer. I don't know whether this is still the case.
Potentially, if it, or/and pplpy can now work directly with rationals, it might be worthwhile to change, as computing common denominators lead to blowup of coefficients.


---

Comment by vdelecroix created at 2019-02-20 09:51:44

Replying to [comment:168 dimpase]:
> I recall that ppl_backend.pyx had a tricky part due to the inability of PPL to work with rationals - everything had to be integer. I don't know whether this is still the case.
> Potentially, if it, or/and pplpy can now work directly with rationals, it might be worthwhile to change, as computing common denominators lead to blowup of coefficients.

The PPL Coefficient type is hardcoded in the Cython wrapper as

```
ctypedef mpz_class PPL_Coefficient
```

This implies that all computations with pplpy are done with GMP mpz. I agree that PPL supports computations with `mpz_class`, `mpq_class` as well as various native integer types (from `char` to `long long`). Nothing has changed on this side yet. This feature request is disjoint from this ticket which aims to be a simple transition from Sage source code to standalone library.


---

Comment by dimpase created at 2019-02-20 09:53:03

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-02-20 09:53:03

looks good to me then.


---

Comment by vdelecroix created at 2019-02-20 09:54:48

Replying to [comment:169 vdelecroix]:
> Replying to [comment:168 dimpase]:
> > I recall that ppl_backend.pyx had a tricky part due to the inability of PPL to work with rationals - everything had to be integer. I don't know whether this is still the case.
> > Potentially, if it, or/and pplpy can now work directly with rationals, it might be worthwhile to change, as computing common denominators lead to blowup of coefficients.
> 
> The PPL Coefficient type is hardcoded in the Cython wrapper as
> {{{
> ctypedef mpz_class PPL_Coefficient
> }}}
> This implies that all computations with pplpy are done with GMP mpz. I agree that PPL supports computations with `mpz_class`, `mpq_class` as well as various native integer types (from `char` to `long long`). Nothing has changed on this side yet. This feature request is disjoint from this ticket which aims to be a simple transition from Sage source code to standalone library.

This is high priority and I opened an issue: https://gitlab.com/videlec/pplpy/issues/14


---

Comment by vklein created at 2019-02-20 10:25:22

Thanks to all reviewers.


---

Comment by vbraun created at 2019-02-22 23:39:29

merge conflict


---

Comment by vbraun created at 2019-02-22 23:39:29

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-02-25 09:27:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-02-25 09:29:30

Rebase on 8.7.beta5


---

Comment by vklein created at 2019-02-25 09:29:38

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-02-25 09:30:16

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-02-25 09:54:15

Looking at the diff, I have several minor comments:

1. Don't change whitespace in `src/module_list.py` for no good reason.

2. In various places, you use `list(...)`. Why not use a list comprehension instead?

3. In multi-line imports, the preferred style is to use parentheses instead of `\`.

4. The deprecation message is really strangely formatted: it shouldn't start with a newline and there shouldn't be a huge amount of indentation in the second line. I would probably write it all on one line without any newlines at all.

5. What's the meaning of the `/...` at the start of the deprecation warnings in doctests? I have never seen that.

6. In `_add_rational_constraint`, why do you `cdef Rational rhs`? Since `numerator` and `denominator` are pure Python methods, this is a pessimization.


---

Comment by jdemeyer created at 2019-02-25 09:54:15

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-02-25 10:33:09

Replying to [comment:178 jdemeyer]:
> Looking at the diff, I have several minor comments:
> 2. In various places, you use `list(...)`. Why not use a list comprehension instead?

I wonder if there shouldn't be something like this mentioned in the developer docs (do we have a style guide)?

This is a comment I've made in review on dozens of tickets at this point.

Short list comprehensions (it's trickier when they get nested) are _often_ clearer than any alternative, and are usually much more efficient from the Python interpreter's standpoint as well.


---

Comment by vklein created at 2019-02-25 10:48:51

> 5. What's the meaning of the `/...` at the start of the deprecation warnings in doctests? I have never seen that.

It means the line begin with `/` then something before `DeprecationWarning...`.
I think i have done that because the `print(err)` result begin by the path `$SAGE_LOCAL/src/bin/sage-eval`.


---

Comment by jdemeyer created at 2019-02-25 11:02:59

I see now. Those aren't "normal" doctests, they are actually run in a subprocess.


---

Comment by git created at 2019-02-25 12:57:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-25 12:59:52

Comments 1,2,3,4 and 6 implemented.


---

Comment by vklein created at 2019-02-25 12:59:52

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-02-27 07:27:11

Changing priority from minor to major.


---

Comment by vdelecroix created at 2019-02-27 08:35:41

Jeroen?


---

Comment by jdemeyer created at 2019-02-27 08:53:35

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-02-27 08:53:35

Good for me if this passes doctests (I haven't checked)


---

Comment by vdelecroix created at 2019-02-27 09:04:53

Replying to [comment:186 jdemeyer]:
> Good for me if this passes doctests (I haven't checked)

This I did (and I belive Vincent K also)


---

Comment by vklein created at 2019-02-27 09:37:33

After the last commit i only did tests on all modified files and everything under `sage/geometry`. I will launch a `sage -t -a --long` just to be extra sure.


---

Comment by embray created at 2019-02-28 13:21:39

Changing status from positive_review to needs_review.


---

Comment by embray created at 2019-02-28 13:21:39

I would like to test this on Windows.  I can do that in a few minutes.


---

Comment by embray created at 2019-02-28 13:22:30

Set assignee to embray.


---

Comment by embray created at 2019-02-28 14:16:19

One minor comment just looking at the patch: To complement the `pplpy/spkg-postinst` script, it would be good, albeit not strictly necessary, to include a `pplpy/spkg-postrm` script that removes that documentation directory in its entirety, if it was installed.  That way it's a bit tidier if you also remove or upgrade pplpy and its documentation changes.


---

Comment by vklein created at 2019-02-28 14:28:04

Ok, when exactly are `spkg-postrm` scripts called ? `sage -f pkgname` after the uninstall ?

Anyways i will wait for Owner field to be empty before pushing any new commit.


---

Comment by embray created at 2019-02-28 14:45:28

Yeah, pplpy doesn't build on Cygwin:


```
[pplpy-0.8.3]     g++ -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o build/temp.cygwin-2.9.0-x86_64-2.7/ppl/ppl_shim.o -L/home/embray/src/sagemath/sage/local/lib/python2.7/config -L/home/embray/src/sagemath/sage/local/lib -lppl -lm -lpython2.7 -o build/lib.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.dll
[pplpy-0.8.3]     build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o: In function `Parma_Polyhedra_Library::Bit_Row::clear()':
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40661: undefined reference to `__imp___gmpz_set_ui'
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40661:(.text+0x14c): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp___gmpz_set_ui'
[pplpy-0.8.3]     build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o: In function `Parma_Polyhedra_Library::Bit_Row::~Bit_Row()':
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40618: undefined reference to `__imp___gmpz_clear'
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40618:(.text+0x235): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp___gmpz_clear'
[pplpy-0.8.3]     build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o: In function `__pyx_pf_3ppl_10bit_arrays_7Bit_Row___cinit__':
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40588: undefined reference to `__imp___gmpz_init'
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40588:(.text+0x2c9): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp___gmpz_init'
[pplpy-0.8.3]     build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o: In function `Parma_Polyhedra_Library::Bit_Row::clear_from(unsigned long)':
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40639: undefined reference to `__imp___gmpz_tdiv_r_2exp'
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40639:(.text+0x1dd0): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp___gmpz_tdiv_r_2exp'
[pplpy-0.8.3]     build/temp.cygwin-2.9.0-x86_64-2.7/ppl/bit_arrays.o: In function `Parma_Polyhedra_Library::Bit_Row::set(unsigned long)':
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40629: undefined reference to `__imp___gmpz_setbit'
[pplpy-0.8.3]     /home/embray/src/sagemath/sage/local/include/ppl.hh:40629:(.text+0x239d): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp___gmpz_setbit'
[pplpy-0.8.3]     collect2: error: ld returned 1 exit status
[pplpy-0.8.3]     error: command 'g++' failed with exit status 1
[pplpy-0.8.3]     Running setup.py install for pplpy: finished with status 'error'
```


This looks...unsurprising to me. I think I can fix this easily-enough, I hope.


---

Comment by embray created at 2019-02-28 14:46:52

Replying to [comment:192 vklein]:
> Ok, when exactly are `spkg-postrm` scripts called ? `sage -f pkgname` after the uninstall ?

Basically, at the end of `sage-spkg-uninstall` (which is called by `sage -f` among other things).  This is also called when upgrading a package so that's why I thought it might matter eventually, at least in a minor way.


---

Comment by embray created at 2019-02-28 15:08:23

**Upstream PR:** https://gitlab.com/videlec/pplpy/merge_requests/6

We can either see if Vincent wants to make an 0.8.4 release for this fix, or I'm just as happy for now to include this as a patch in the Sage SPKG.


---

Comment by embray created at 2019-02-28 15:08:23

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-02-28 15:17:38

Replying to [comment:195 embray]:
> **Upstream PR:** https://gitlab.com/videlec/pplpy/merge_requests/6
> 
> We can either see if Vincent wants to make an 0.8.4 release for this fix, or I'm just as happy for now to include this as a patch in the Sage SPKG.

Let us do that.


---

Comment by vdelecroix created at 2019-02-28 15:17:50

(the release 0.8.4)


---

Comment by vdelecroix created at 2019-02-28 15:24:14

new release (ticket description updated)


---

Comment by embray created at 2019-02-28 15:44:50

That was quick, thank you :)

Not sure yet if it's a showstopper, but I'm also having a weird problem with error handling in the gmpy2 in Sage.  This following example should raise a `TypeError` exception:


```
$ python -c 'import gmpy2;  gmpy2.is_fermat_prp(1234, "a")'
Aborted (core dumped)
```


I also built the latest gmpy2 from source, and when I run it in that source tree I get the correct behavior:


```
$ python -c 'import gmpy2;  gmpy2.is_fermat_prp(1234, "a")'
Traceback (most recent call last):
  File "<string>", line 1, in <module>
TypeError: is_fermat_prp() requires 2 integer arguments
```


Perhaps it was just a bug in gmpy2 that has since been fixed upstream?  Not sure.


---

Comment by embray created at 2019-02-28 15:50:44

Indeed, that particular bug was already fixed upstream: https://github.com/aleaxit/gmpy/commit/533a62cf2b2cf3673e1d6b0f3c2d0c64548a3908

I just wanted to make sure.   I think I only hit on it because I was running the tests from gmpy2's current' master branch against our slightly older version, and hit that bug specifically because they added a regression test when they fixed it.  Other than that all `spkg-check` tests pass on Cygwin for gmpy2 and pplpy :)


---

Comment by embray created at 2019-02-28 15:57:28

All good on my end in terms of Sage doctests, I think.  I'm doing one more full run just to be sure but I can think of no reason it should work differently.

So just update to the just-released pplpy 0.8.4 and you can set back to postive_review.  The spkg-postrm would be good to have too but I don't consider it a blocker.


---

Comment by vklein created at 2019-02-28 15:58:21

Ok i don't think doing a gmpy2 patch for this commit is worth it. 

`@`Erik: Tell me when you're ok and i will update this ticket with `pplpy's` upgrade and `spkg-postrm`.


---

Comment by embray created at 2019-02-28 16:04:59

Changing assignee from embray to vklein.


---

Comment by embray created at 2019-02-28 16:04:59

Yep. Once you're done with that feel free to set back to positive_review.


---

Comment by vklein created at 2019-02-28 16:20:30

Ok thank you for your help.


---

Comment by git created at 2019-02-28 16:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-28 16:52:34

Upgrade to pplpy 0.8.4 and add a spkg-postrm script to clean the documentation.
A reviewer should validate `​829317e` in order to set this ticket in positive review.


---

Comment by vklein created at 2019-02-28 17:04:25

Remove assignee vklein.


---

Comment by vklein created at 2019-02-28 17:04:33

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-02-28 17:04:48

doing some testing...


---

Comment by vdelecroix created at 2019-02-28 17:13:45

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2019-02-28 17:13:45

`spkg-postrm` works as expected. Thanks Vincent!


---

Comment by slelievre created at 2019-03-01 20:59:54

Adding "upgrade" to keywords to emphasize the need to upload new tarball to our download mirrors.


---

Comment by slelievre created at 2019-03-01 20:59:54

Changing keywords from "thursdaysbdx, ppl, pplpy" to "thursdaysbdx, ppl, pplpy, upgrade".


---

Comment by vbraun created at 2019-03-02 09:39:27

Resolution: fixed


---

Comment by novoselt created at 2019-03-03 04:57:02

There were several instances of removal similar to `self._PPL_C_Polyhedron.set_immutable()` - is this functionality no longer supported? This was done for objects that are cached and if a user ever modifies the polyhedron, things will get wrong.


---

Comment by vdelecroix created at 2019-03-03 09:54:57

Replying to [comment:213 novoselt]:
> There were several instances of removal similar to `self._PPL_C_Polyhedron.set_immutable()` - is this functionality no longer supported? This was done for objects that are cached and if a user ever modifies the polyhedron, things will get wrong.

Indeed, it is not supported anymore. Also you can not cache a `PPL_C_Polyhedron`: https://gitlab.com/videlec/pplpy/blob/master/ppl/polyhedron.pyx#L86-102

In sage, the pplpy polyhedra are only used as attribute from which the user is not supposed to have direct access (unless she knows very well what she is doing). The higher level `Polyhedron_base` still implements this mutability flag.

Could you give a concrete example of a problematic behavior?


---

Comment by novoselt created at 2019-03-04 16:33:55

Well I don't have an example from "real life" given that these objects used to be immutable and that I generally knew what I am doing, but the situation I have described is not at all impossible. Although the method returning PPL representation is underscored. There is also a discrepancy with documentation at
https://github.com/sagemath/sage/blob/develop/src/sage/geometry/cone.py#L1373
which claims that supplied polytope will be made immutable.


---

Comment by vdelecroix created at 2019-03-04 19:23:55

Please continue the discussion at #27423 since this ticket is closed.
