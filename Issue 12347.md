# Issue 12347: cvxopt should only add -lcblas when that library exists

Issue created by migration from https://trac.sagemath.org/ticket/12519

Original creator: jdemeyer

Original creation time: 2012-02-16 10:15:22

Assignee: tbd

The following is Sage-specific code in cvxopt's `setup.py`:

```
if os.popen('sage_fortran --version').read()[:3]=='G95':
    libraries = ['m','lapack','gsl','gslcblas','blas','f95']
    GCC_LIB_DIR=SAGE_LIB
    if os.path.exists(GCC_LIB_DIR + "/gcc-lib"):
       GCC_LIB_DIR += "/gcc-lib/"
       GCC_LIB_DIR += os.listdir(GCC_LIB_DIR)[0] + "/"
       GCC_LIB_DIR += os.listdir(GCC_LIB_DIR)[0] + "/"
    libdirs = [ATLAS_LIB_DIR,GCC_LIB_DIR]
elif os.environ['UNAME'] == 'CYGWIN':
    libraries = ['lapack','gsl','gslcblas','blas', 'gfortran']
else:
    libraries = ['m','lapack','gsl','blas','gslcblas','cblas','gfortran','atlas']
```


At the end, `cblas` is added, even though this isn't installed on Darwin.  This gives problem on OS X 10.4 with #12369 (without #12369, the first "if" evaluates to True).


---

Comment by jdemeyer created at 2012-02-23 22:07:14

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-02-24 20:38:43

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-02-24 20:38:43

In spkg-install, these lines should be removed:

```
# Solaris-specific and other patches
cp -p patches/cvxopt.h src/src/C/

# patch to use always use GSL's random
cp -p patches/__init__.py src/src/python/

# setting Sage-specific libraries locations, etc.
cp -p patches/setup.py src/src/
```

since they are taken care of by patch.


---

Comment by dimpase created at 2012-02-24 23:22:56

Replying to [comment:4 jdemeyer]:

Am I correct in saying that this was caused by Darwin being determined by the presence of G95, which is no longer the right way to do this (or perhaps it never was --- mea culpa then...) ?

Regarding the failures of tests on OSX 10.7 (see #12011): it would be great if the exact Sage version (gcc/clang?) /Xcode version/hardware state (32 vs 64 bits) on these are reported. As it looks at the moment, that there is a bug in Apple-supplied
lapack/blas, and this might force us to build Atlas on OSX 10.7 and use it.


---

Comment by jhpalmieri created at 2012-02-25 16:55:00

Replying to [comment:6 dimpase]:
> Regarding the failures of tests on OSX 10.7 (see #12011): it would be great if the exact Sage version (gcc/clang?) /Xcode version/hardware state (32 vs 64 bits) on these are reported. 

In my experience, the tests fail on every OS X 10.7 machine I've tried, with Xcode 4.1, 4.2, 4.3, with both gcc and clang.

> As it looks at the moment, that there is a bug in Apple-supplied
> lapack/blas, and this might force us to build Atlas on OSX 10.7 and use it.

That would be unfortunate. I also wonder why we don't see doctest failures elsewhere in Sage if there are bugs in these libraries.


---

Attachment

Diff for the cvxopt spkg, for review only


---

Comment by jdemeyer created at 2012-02-27 15:47:22

Fixed, needs review.


---

Comment by jdemeyer created at 2012-02-27 15:47:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-02-27 15:49:51

Replying to [comment:7 jhpalmieri]:
> That would be unfortunate. I also wonder why we don't see doctest failures elsewhere in Sage if there are bugs in these libraries.

Because the cvxopt test suite itself is more complete than Sage?  Maybe it just fails on some corner case which isn't in the doctests.  I agree it would be a good idea to add a doctest to catch the OS X 10.7 failures.


---

Comment by dimpase created at 2012-02-27 22:32:47

Replying to [comment:7 jhpalmieri]:
> > As it looks at the moment, that there is a bug in Apple-supplied
> > lapack/blas, and this might force us to build Atlas on OSX 10.7 and use it.
> 
> That would be unfortunate. I also wonder why we don't see doctest failures elsewhere in Sage if there are bugs in these libraries.

I asked upstream for examples demonstrating lapack/blas bug(s) on OSX 10.7. They are looking into it.


---

Comment by dimpase created at 2012-03-05 13:18:06

Replying to [comment:7 jhpalmieri]:

> In my experience, the tests fail on every OS X 10.7 machine I've tried, with Xcode 4.1, 4.2, 4.3, with both gcc and clang.

here is a beautiful OSX 10.7-specific bug (got it on sqrt5 with Sage 5.0.beta6):
(the syntax const-M, for M a matrix, is supposed to replace each M_ij with const-M_ij)


```
from cvxopt import matrix
b=matrix([ 1.00e+00, 1.63e-01, 2.83e-01, 9.47e-01, 2.32e-01, 4.85e-01,
9.57e-01, 7.44e-01])
c=1.-b
print "b :\n", b
print "1-b:\n", c


b :
[ 1.00e+00]
[ 1.63e-01]
[ 2.83e-01]
[ 9.47e-01]
[ 2.32e-01]
[ 4.85e-01]
[ 9.57e-01]
[ 7.44e-01]

1-b:
[-1.00e+00]
[-1.63e-01]
[-2.83e-01]
[-9.47e-01]
[-2.32e-01]
[-4.85e-01]
[-9.57e-01]
[-7.44e-01]
```


Interestingly, a shorter vector b works OK...

Do you have any idea what goes wrong here?
(this is actually the bug responsible for failure of "acent" test in [here](http://sage.math.washington.edu/home/palmieri/misc/cvxopt-1.1.3.log))


---

Comment by jdemeyer created at 2012-03-05 13:21:32

Replying to [comment:11 dimpase]:
> Do you have any idea what goes wrong here?
Probably Apple shipping a broken BLAS.  See #12011.


---

Comment by dimpase created at 2012-03-05 13:50:59

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 dimpase]:
> > Do you have any idea what goes wrong here?
> Probably Apple shipping a broken BLAS.  See #12011.
that's what one of CVXOPT people says (as I reported :)), but it would be good to know for sure.
I've reported this example upstream (to CVXOPT), too. 

I forgot to mention that this is a plain Python example. To run it in Sage proper, one needs to do first

```
sage: preparser(on=False)
```



---

Comment by dimpase created at 2012-03-06 10:34:25

Replying to [comment:13 dimpase]:
> > Probably Apple shipping a broken BLAS.  See #12011.

confirmed! see the following sage-devel [thread](https://groups.google.com/d/topic/sage-devel/f1XvpcK0KxE/discussion)


---

Comment by jdemeyer created at 2012-03-06 13:21:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-03-06 13:21:19

This needs to be coordinated with #12011.


---

Attachment

For reproducing the failure on Lion


---

Attachment

For reproducing the failure on Lion


---

Comment by kcrisman created at 2012-03-06 14:45:33

For reproducing the failure on Lion


---

Attachment

Replying to [comment:14 dimpase]:
> Replying to [comment:13 dimpase]:
> > > Probably Apple shipping a broken BLAS.  See #12011.
> 
> confirmed! see the following sage-devel [thread](https://groups.google.com/d/topic/sage-devel/f1XvpcK0KxE/discussion)

In fact, it turns out to be a CVXOPT bug. Please see this
[message](https://groups.google.com/d/msg/sage-devel/f1XvpcK0KxE/oSFsKrA7MfkJ) and this [discussion](https://discussions.apple.com/message/17795537))

So we do not need Atlas on OSX 10.7, after all (or at least not yet).


---

Comment by dimpase created at 2012-03-09 01:19:36

Replying to [comment:16 dimpase]:
> Replying to [comment:14 dimpase]:
> > Replying to [comment:13 dimpase]:
> > > > Probably Apple shipping a broken BLAS.  See #12011.
> > 
> > confirmed! see the following sage-devel [thread](https://groups.google.com/d/topic/sage-devel/f1XvpcK0KxE/discussion)
> 
> In fact, it turns out to be a CVXOPT bug. Please see this
> [message](https://groups.google.com/d/msg/sage-devel/f1XvpcK0KxE/oSFsKrA7MfkJ) and this [discussion](https://discussions.apple.com/message/17795537))
> 
> So we do not need Atlas on OSX 10.7, after all (or at least not yet).

Hopefully CVXOPT people can fix this quickly: the affected BLAS calls are used quite a bit in their code, so I'd prefer to wait for them to have it fixed rather than going at it myself (it looks straightforward, but quite a bit of code...)


---

Comment by dimpase created at 2012-03-09 01:19:36

Changing status from needs_work to needs_info.


---

Comment by dimpase created at 2012-03-09 01:21:49

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2012-03-09 01:22:28

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2012-03-09 01:22:28

Please revert to using Apple's blas, not GSL's ones.


---

Comment by jdemeyer created at 2012-03-09 07:40:18

Replying to [comment:19 dimpase]:
> Please revert to using Apple's blas, not GSL's ones.

Please clarify...


---

Comment by jdemeyer created at 2012-03-09 07:40:18

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2012-03-09 07:59:20

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 dimpase]:
> > Please revert to using Apple's blas, not GSL's ones.
> 
> Please clarify...

Can we link cvxopt against Apple's cblas (aka "-framework Accelerate") on MacOSX?
I suppose inclusion of gslcblas in the list of libaries means we use this very slow beast...


---

Comment by dimpase created at 2012-03-09 07:59:20

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2012-03-09 08:39:19

Replying to [comment:21 dimpase]:
> I suppose inclusion of gslcblas in the list of libaries means we use this very slow beast...

Are you sure?  If we're not using Apple's BLAS, how do you explain that cvxopt fails its self-tests only on OS X 10.7?

Anyway: let me also clarify that I'm simply restoring the old behaviour, such that `cvxopt` builds with GCC 4.6.2.  So if there really is something to be done, I prefer to get this ticket reviewed as-is and continue on a different ticket.


---

Comment by jdemeyer created at 2012-03-09 08:39:19

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2012-03-09 08:49:26

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 dimpase]:
> > I suppose inclusion of gslcblas in the list of libaries means we use this very slow beast...
> 
> Are you sure?  If we're not using Apple's BLAS, how do you explain that cvxopt fails its self-tests only on OS X 10.7?

`-lblas` links against Apple's "classical" BLAS (which you call with Fortran conventions), and use names ending with '_'. And 
that's how CVXOPT makes these fateful calls to daxpy(). 

Actually, it occurs to me now that it's GSL extension of CVXOPT that needs its GSLCBLAS, nothing else.
Sorry for noise. Please disregard my request on this. 
 
> 
> Anyway: let me also clarify that I'm simply restoring the old behaviour, such that `cvxopt` builds with GCC 4.6.2.  So if there really is something to be done, I prefer to get this ticket reviewed as-is and continue on a different ticket.

OK, I'll look into it ASAP.


---

Comment by dimpase created at 2012-03-10 08:11:27

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 dimpase]:
> > I suppose inclusion of gslcblas in the list of libaries means we use this very slow beast...
> 
> Are you sure?  If we're not using Apple's BLAS, how do you explain that cvxopt fails its self-tests only on OS X 10.7?
> 
> Anyway: let me also clarify that I'm simply restoring the old behaviour, such that `cvxopt` builds with GCC 4.6.2.  So if there really is something to be done, I prefer to get this ticket reviewed as-is and continue on a different ticket.

looks OK on OSX 10.6.8, and on 10.5.8 PPC (installs with SAGE_CHECK=yes). I presume you have tested on OSX 10.4.
Positive review. 
I'd like to coordinate the upgrade to (now available) cvxopt 1.1.4 with them fixing the OSX 10.7-specific bug.


---

Comment by dimpase created at 2012-03-10 08:11:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-13 08:24:12

Resolution: fixed
