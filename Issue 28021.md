# Issue 28021: Fork errors in sage.misc.cython doctests

Issue created by migration from https://trac.sagemath.org/ticket/28258

Original creator: embray

Original creation time: 2019-07-25 10:52:01

I've seen fork-related problems in the tests of this module before, although this is the first time it's come up again in a while.

They seem to occur because the temporarily generated DLL modules output by `cython()` can end up in an address space that overlaps with some other modules, and then any subsequent `fork()` will fail.

The problem tends to manifest itself, in the test failures, in the form of an error like:


```
EnvironmentError: pkg-config is probably not installed. Could not run pkg-config: OSError(11, 'Resource temporarily unavailable')
```


This is because Python is trying to `fork()` to run the `pkg-config` program, and that fails.  The problem isn't really anything to do with `pkg-config` itself.

Two strange observations:

* It works _most of the time_ if I run 
  {{{
  ./sage -t --serial --long src/sage/misc/cython.py
  }}}
  Which means the tests are not running from a forked process to begin with.  It's still strange though, because running `pkg-config` in the tests still means `fork()` is being called during the serial test run, and not failing.

* It works _some of the time_, or sometimes with at least fewer failures, if I run:
  {{{
  ./sage -t --verbose --long src/sage/misc/cython.py
  }}}
  This implies to me that there might be some kind of race condition involved, since merely running with the verbose output seems to decrease the chances of failure.


---

Comment by embray created at 2019-07-25 10:52:08

Set assignee to embray.


---

Comment by jhpalmieri created at 2019-07-25 18:03:07

Tangent: why is `--serial` not listed in the options when I run `sage -t -h`? Are there other undocumented Sage doctesting options?


---

Comment by embray created at 2019-11-13 17:08:32

Changing priority from major to critical.


---

Comment by embray created at 2019-11-13 17:08:32

I've been seeing this more and more lately--perhaps something about changes to `rebase` (of which I know there have been some lately), or some other DLLs in the Cygwin distribution--but it's now quite frequent that the DLLs generated at runtime by `cython()` are based, by default, in such a way that they overlap.  So when `fork()` is  called (especially probable in many of the tests where `cython()` is used), it crashes.


---

Comment by embray created at 2019-11-13 17:38:57

Changing status from new to needs_review.


---

Comment by embray created at 2019-11-13 17:38:57

The attached branch fixes the problem to my satisfaction.  It can never be fully "fixed" as what we're dealing with here is a fundamental limitation of !Windows/Cygwin.  But we can _mitigate_ the problem and this does so well.  See the commit message for more details.
----
New commits:


---

Comment by vbraun created at 2019-12-02 18:10:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-12-04 22:43:42

Resolution: fixed
