# Issue 27799: revert #21161

Issue created by migration from https://trac.sagemath.org/ticket/28036

Original creator: chapoton

Original creation time: 2019-06-21 10:02:29

CC:  embray jdemeyer vdelecroix jipilab cremona tscrim mmezzarobba mkoeppe

Because this is causing some random infinite loops.

Another symptom:

The doctest 

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
```

when it does not fail, and then one calls

```
K.coerce_embedding()
```

again, makes sage crash.

Removing the change of repr made in #21161 fixes that.


---

Comment by chapoton created at 2019-06-21 11:10:49

Adding the single line

```
gen = self.gen_embedding()
```

is enough to trigger the crash.


---

Comment by chapoton created at 2019-06-21 11:12:08

This may be considered as a blocker, no ?


---

Comment by chapoton created at 2019-06-21 11:12:08

Changing priority from critical to blocker.


---

Comment by @timokau created at 2019-06-21 11:21:46

Thank you for analyzing this issue! Previous discussion in https://github.com/cschwan/sage-on-gentoo/issues/541, were we assumed it was distro related.

I agree that it should be included in 8.8.


---

Comment by jipilab created at 2019-06-21 11:29:57

Replying to [comment:2 chapoton]:
> Adding the single line
> {{{
> gen = self.gen_embedding()
> }}}
> is enough to trigger the crash.

I do not get a crash with 8.8.rc2... :-S Hmm.

So there is no way to bypass the current issue and still be able to know via the `repr` that the NumberField is embedded? This is in itself problematic, right?

Reverting completely #21161 would be too bad... Isn't there any way to remove the crash caused by calling


```
gen = self.gen_embedding()
```


?


---

Comment by chapoton created at 2019-06-21 11:57:18

Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.


---

Comment by jipilab created at 2019-06-21 12:46:42

Replying to [comment:6 chapoton]:
> Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.

Hmm. I also tested with py3-sage. But I might have some obscure side effects...


---

Comment by chapoton created at 2019-06-21 12:54:28

Here is a branch that fixes the crash.. Not sure if this is the right thing to do. And no idea if this prevents the random infinite loop to re-appear.
----
New commits:


---

Comment by chapoton created at 2019-06-21 14:44:26

the fix proposal provokes a few failing doctests, that may not be so simple..


---

Comment by chapoton created at 2019-06-21 15:18:14

Here is another proposal.. (not really convincing either)
----
New commits:


---

Comment by mmezzarobba created at 2019-06-21 17:41:58

Replying to [comment:12 chapoton]:
> Here is another proposal.. (not really convincing either)

Did you test it? I don't understand how it can work, since `_embedding` is a cdef attribute. Apart from that, the idea looks sensible enough to me.

Another option may be to use a lazy string for the error message that causes the loop.


---

Comment by mkoeppe created at 2019-06-21 18:18:35

Replying to [comment:14 mmezzarobba]:
> Another option may be to use a lazy string for the error message that causes the loop.

+1


---

Comment by git created at 2019-06-21 18:22:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2019-06-21 18:25:18

I was able to reproduce this error. I agree it's a blocker. Using `LazyFormat` seems to fix it for me. Please test.


---

Comment by mkoeppe created at 2019-06-21 18:25:18

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2019-06-21 18:26:03

(Sorry for overwriting your branch.)


---

Comment by chapoton created at 2019-06-21 18:55:21

This is a better solution indeed. Works fine for me (on py3-sage).


---

Comment by dimpase created at 2019-06-21 20:28:23

can that 1-line way to crash above be put into a doctest?


---

Comment by mkoeppe created at 2019-06-22 05:28:50

Replying to [comment:21 dimpase]:
> can that 1-line way to crash above be put into a doctest?
I don't know how to reproduce the crash with a single doctest.


---

Comment by chapoton created at 2019-06-22 05:57:21

add one line

```
K.coerce_embedding()
```

after the line

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
```



---

Comment by mkoeppe created at 2019-06-22 07:26:29

This triggers the error for me in an interactive session; but not if I add it to the doctest...


---

Comment by vbraun created at 2019-06-22 08:17:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-06-23 10:16:09

Resolution: fixed
