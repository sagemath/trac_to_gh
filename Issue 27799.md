# Issue 27799: revert #21161

archive/issues_027799.json:
```json
{
    "body": "CC:  @embray @jdemeyer @videlec @jplab @JohnCremona @tscrim @mezzarobba @mkoeppe\n\nBecause this is causing some random infinite loops.\n\nAnother symptom:\n\nThe doctest \n\n```\nFile \"src/sage/structure/parent.pyx\", line 1734, in sage.structure.parent.Parent.hom.register_embedding\nFailed example:\n    K.coerce_embedding()(a)\n```\n\nwhen it does not fail, and then one calls\n\n```\nK.coerce_embedding()\n```\n\nagain, makes sage crash.\n\nRemoving the change of repr made in #21161 fixes that.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28036\n\n",
    "created_at": "2019-06-21T10:02:29Z",
    "labels": [
        "number fields",
        "critical",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "revert #21161",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27799",
    "user": "@fchapoton"
}
```
CC:  @embray @jdemeyer @videlec @jplab @JohnCremona @tscrim @mezzarobba @mkoeppe

Because this is causing some random infinite loops.

Another symptom:

The doctest 

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
```

when it does not fail, and then one calls

```
K.coerce_embedding()
```

again, makes sage crash.

Removing the change of repr made in #21161 fixes that.

Issue created by migration from https://trac.sagemath.org/ticket/28036





---

archive/issue_comments_392656.json:
```json
{
    "body": "Adding the single line\n\n```\ngen = self.gen_embedding()\n```\n\nis enough to trigger the crash.",
    "created_at": "2019-06-21T11:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392656",
    "user": "@fchapoton"
}
```

Adding the single line

```
gen = self.gen_embedding()
```

is enough to trigger the crash.



---

archive/issue_comments_392657.json:
```json
{
    "body": "This may be considered as a blocker, no ?",
    "created_at": "2019-06-21T11:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392657",
    "user": "@fchapoton"
}
```

This may be considered as a blocker, no ?



---

archive/issue_comments_392658.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2019-06-21T11:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392658",
    "user": "@fchapoton"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_392659.json:
```json
{
    "body": "Thank you for analyzing this issue! Previous discussion in https://github.com/cschwan/sage-on-gentoo/issues/541, were we assumed it was distro related.\n\nI agree that it should be included in 8.8.",
    "created_at": "2019-06-21T11:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392659",
    "user": "@timokau"
}
```

Thank you for analyzing this issue! Previous discussion in https://github.com/cschwan/sage-on-gentoo/issues/541, were we assumed it was distro related.

I agree that it should be included in 8.8.



---

archive/issue_comments_392660.json:
```json
{
    "body": "Replying to [comment:2 chapoton]:\n> Adding the single line\n> {{{\n> gen = self.gen_embedding()\n> }}}\n> is enough to trigger the crash.\n\nI do not get a crash with 8.8.rc2... :-S Hmm.\n\nSo there is no way to bypass the current issue and still be able to know via the `repr` that the NumberField is embedded? This is in itself problematic, right?\n\nReverting completely #21161 would be too bad... Isn't there any way to remove the crash caused by calling\n\n\n```\ngen = self.gen_embedding()\n```\n\n\n?",
    "created_at": "2019-06-21T11:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392660",
    "user": "@jplab"
}
```

Replying to [comment:2 chapoton]:
> Adding the single line
> {{{
> gen = self.gen_embedding()
> }}}
> is enough to trigger the crash.

I do not get a crash with 8.8.rc2... :-S Hmm.

So there is no way to bypass the current issue and still be able to know via the `repr` that the NumberField is embedded? This is in itself problematic, right?

Reverting completely #21161 would be too bad... Isn't there any way to remove the crash caused by calling


```
gen = self.gen_embedding()
```


?



---

archive/issue_comments_392661.json:
```json
{
    "body": "Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.",
    "created_at": "2019-06-21T11:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392661",
    "user": "@fchapoton"
}
```

Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.



---

archive/issue_comments_392662.json:
```json
{
    "body": "Replying to [comment:6 chapoton]:\n> Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.\n\nHmm. I also tested with py3-sage. But I might have some obscure side effects...",
    "created_at": "2019-06-21T12:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392662",
    "user": "@jplab"
}
```

Replying to [comment:6 chapoton]:
> Nota Bene: I got the crash/not crash when using py3-sage. Not tried with py2-sage.

Hmm. I also tested with py3-sage. But I might have some obscure side effects...



---

archive/issue_comments_392663.json:
```json
{
    "body": "Here is a branch that fixes the crash.. Not sure if this is the right thing to do. And no idea if this prevents the random infinite loop to re-appear.\n----\nNew commits:",
    "created_at": "2019-06-21T12:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392663",
    "user": "@fchapoton"
}
```

Here is a branch that fixes the crash.. Not sure if this is the right thing to do. And no idea if this prevents the random infinite loop to re-appear.
----
New commits:



---

archive/issue_comments_392664.json:
```json
{
    "body": "the fix proposal provokes a few failing doctests, that may not be so simple..",
    "created_at": "2019-06-21T14:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392664",
    "user": "@fchapoton"
}
```

the fix proposal provokes a few failing doctests, that may not be so simple..



---

archive/issue_comments_392665.json:
```json
{
    "body": "Here is another proposal.. (not really convincing either)\n----\nNew commits:",
    "created_at": "2019-06-21T15:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392665",
    "user": "@fchapoton"
}
```

Here is another proposal.. (not really convincing either)
----
New commits:



---

archive/issue_comments_392666.json:
```json
{
    "body": "Replying to [comment:12 chapoton]:\n> Here is another proposal.. (not really convincing either)\n\nDid you test it? I don't understand how it can work, since `_embedding` is a cdef attribute. Apart from that, the idea looks sensible enough to me.\n\nAnother option may be to use a lazy string for the error message that causes the loop.",
    "created_at": "2019-06-21T17:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392666",
    "user": "@mezzarobba"
}
```

Replying to [comment:12 chapoton]:
> Here is another proposal.. (not really convincing either)

Did you test it? I don't understand how it can work, since `_embedding` is a cdef attribute. Apart from that, the idea looks sensible enough to me.

Another option may be to use a lazy string for the error message that causes the loop.



---

archive/issue_comments_392667.json:
```json
{
    "body": "Replying to [comment:14 mmezzarobba]:\n> Another option may be to use a lazy string for the error message that causes the loop.\n\n+1",
    "created_at": "2019-06-21T18:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392667",
    "user": "@mkoeppe"
}
```

Replying to [comment:14 mmezzarobba]:
> Another option may be to use a lazy string for the error message that causes the loop.

+1



---

archive/issue_comments_392668.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-21T18:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392668",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_392669.json:
```json
{
    "body": "I was able to reproduce this error. I agree it's a blocker. Using `LazyFormat` seems to fix it for me. Please test.",
    "created_at": "2019-06-21T18:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392669",
    "user": "@mkoeppe"
}
```

I was able to reproduce this error. I agree it's a blocker. Using `LazyFormat` seems to fix it for me. Please test.



---

archive/issue_comments_392670.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-21T18:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392670",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_392671.json:
```json
{
    "body": "(Sorry for overwriting your branch.)",
    "created_at": "2019-06-21T18:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392671",
    "user": "@mkoeppe"
}
```

(Sorry for overwriting your branch.)



---

archive/issue_comments_392672.json:
```json
{
    "body": "This is a better solution indeed. Works fine for me (on py3-sage).",
    "created_at": "2019-06-21T18:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392672",
    "user": "@fchapoton"
}
```

This is a better solution indeed. Works fine for me (on py3-sage).



---

archive/issue_comments_392673.json:
```json
{
    "body": "can that 1-line way to crash above be put into a doctest?",
    "created_at": "2019-06-21T20:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392673",
    "user": "@dimpase"
}
```

can that 1-line way to crash above be put into a doctest?



---

archive/issue_comments_392674.json:
```json
{
    "body": "Replying to [comment:21 dimpase]:\n> can that 1-line way to crash above be put into a doctest?\nI don't know how to reproduce the crash with a single doctest.",
    "created_at": "2019-06-22T05:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392674",
    "user": "@mkoeppe"
}
```

Replying to [comment:21 dimpase]:
> can that 1-line way to crash above be put into a doctest?
I don't know how to reproduce the crash with a single doctest.



---

archive/issue_comments_392675.json:
```json
{
    "body": "add one line\n\n```\nK.coerce_embedding()\n```\n\nafter the line\n\n```\nFile \"src/sage/structure/parent.pyx\", line 1734, in sage.structure.parent.Parent.hom.register_embedding\nFailed example:\n    K.coerce_embedding()(a)\n```\n",
    "created_at": "2019-06-22T05:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392675",
    "user": "@fchapoton"
}
```

add one line

```
K.coerce_embedding()
```

after the line

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
```




---

archive/issue_comments_392676.json:
```json
{
    "body": "This triggers the error for me in an interactive session; but not if I add it to the doctest...",
    "created_at": "2019-06-22T07:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392676",
    "user": "@mkoeppe"
}
```

This triggers the error for me in an interactive session; but not if I add it to the doctest...



---

archive/issue_comments_392677.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-22T08:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392677",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392678.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-23T10:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27799",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27799#issuecomment-392678",
    "user": "@vbraun"
}
```

Resolution: fixed
