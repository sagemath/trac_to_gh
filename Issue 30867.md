# Issue 30867: sage.geometry.polyhedron: Replace use of TestSuite by pytest

archive/issues_030867.json:
```json
{
    "body": "CC:  @tobiasdiez nthiery tscrim @kliem\n\n`sage.geometry.polyhedron` provides an opportunity to study use of `pytest` as a replacement for `TestSuite` (proposed in #30738) in a small self-contained codebase.\n\n`_test_` methods for `Polyhedron_base` were only recently introduced in tickets such as #29934.\n\nImportant design constraint:\n\n- The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as `PyNormaliz`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31104\n\n",
    "created_at": "2020-12-24T20:09:10Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "sage.geometry.polyhedron: Replace use of TestSuite by pytest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30867",
    "user": "mkoeppe"
}
```
CC:  @tobiasdiez nthiery tscrim @kliem

`sage.geometry.polyhedron` provides an opportunity to study use of `pytest` as a replacement for `TestSuite` (proposed in #30738) in a small self-contained codebase.

`_test_` methods for `Polyhedron_base` were only recently introduced in tickets such as #29934.

Important design constraint:

- The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as `PyNormaliz`.


Issue created by migration from https://trac.sagemath.org/ticket/31104





---

archive/issue_comments_441175.json:
```json
{
    "body": "There are over 90 calls of TestSuite in `sage.geometry.polyhedron`. Which of these tests should be replaced?\n\n> The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as PyNormaliz. \n\nThat's straightforward to implement using pytest's mark mechanism: https://docs.pytest.org/en/stable/example/markers.html. Question: should the tests on optional packages be automatically skipped if the optional package is not installed (`mark.skipif`) or do you want to have the option to include/exclude all tests depending on the optional package (e.g. add `mark.pynormaliz` to the test class/method and then select all tests relying on pyronmaliz with `pytest -m pynormaliz` or exclude them with `pytest -m \"not pynormaliz\"`)? In the latter case, in which granularity (specific optional package, all optional packages)?",
    "created_at": "2020-12-25T10:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30867",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30867#issuecomment-441175",
    "user": "@tobiasdiez"
}
```

There are over 90 calls of TestSuite in `sage.geometry.polyhedron`. Which of these tests should be replaced?

> The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as PyNormaliz. 

That's straightforward to implement using pytest's mark mechanism: https://docs.pytest.org/en/stable/example/markers.html. Question: should the tests on optional packages be automatically skipped if the optional package is not installed (`mark.skipif`) or do you want to have the option to include/exclude all tests depending on the optional package (e.g. add `mark.pynormaliz` to the test class/method and then select all tests relying on pyronmaliz with `pytest -m pynormaliz` or exclude them with `pytest -m "not pynormaliz"`)? In the latter case, in which granularity (specific optional package, all optional packages)?



---

archive/issue_comments_441176.json:
```json
{
    "body": "Replying to [comment:1 gh-tobiasdiez]:\n> > The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as PyNormaliz. \n> \n> That's straightforward to implement using pytest's mark mechanism: https://docs.pytest.org/en/stable/example/markers.html. \n\nThanks for the pointer. \n\n> Question: should the tests on optional packages be automatically skipped if the optional package is not installed (`mark.skipif`) or do you want to have the option to include/exclude all tests depending on the optional package (e.g. add `mark.pynormaliz` to the test class/method and then select all tests relying on pyronmaliz with `pytest -m pynormaliz` or exclude them with `pytest -m \"not pynormaliz\"`)? \n\nSame as in the existing `sage -t` -- there's autodetection of packages/features, but the user can also pass `--optional=....` to override. See `sage.doctest.control` (which will need adjustments also in the course of the modularization effort).\n\nIn fact, given that any feasible transition plan will necessarily have both `TestSuite` and `pytest` tests in the codebase for some time, we should probably invoke `pytest` either from the doctests, or from the doctesting control script.",
    "created_at": "2020-12-25T19:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30867",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30867#issuecomment-441176",
    "user": "mkoeppe"
}
```

Replying to [comment:1 gh-tobiasdiez]:
> > The polyhedron objects that can be tested depend on the presence of optional packages / Python modules such as PyNormaliz. 
> 
> That's straightforward to implement using pytest's mark mechanism: https://docs.pytest.org/en/stable/example/markers.html. 

Thanks for the pointer. 

> Question: should the tests on optional packages be automatically skipped if the optional package is not installed (`mark.skipif`) or do you want to have the option to include/exclude all tests depending on the optional package (e.g. add `mark.pynormaliz` to the test class/method and then select all tests relying on pyronmaliz with `pytest -m pynormaliz` or exclude them with `pytest -m "not pynormaliz"`)? 

Same as in the existing `sage -t` -- there's autodetection of packages/features, but the user can also pass `--optional=....` to override. See `sage.doctest.control` (which will need adjustments also in the course of the modularization effort).

In fact, given that any feasible transition plan will necessarily have both `TestSuite` and `pytest` tests in the codebase for some time, we should probably invoke `pytest` either from the doctests, or from the doctesting control script.
