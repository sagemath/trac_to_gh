# Issue 32819: conda-forge-standard: Runtime error in sage.libs.giac

archive/issues_032819.json:
```json
{
    "body": "CC:  @isuruf @kiwifb @dimpase @videlec\n\n... while docbuilding\n\n\n```\n[sagemath_doc_html-none] Traceback (most recent call last):\n[sagemath_doc_html-none]   File \"sage/libs/giac/giac.pyx\", line 1121, in sage.libs.giac.giac.Pygen.eval (build/cythonized/sage/libs/giac/giac.cpp:143102)\n[sagemath_doc_html-none]     result=GIAC_protecteval(self.gptr[0],giacsettings.eval_level,context_ptr)\n[sagemath_doc_html-none]   File \"sage/libs/giac/giac.pyx\", line 739, in sage.libs.giac.giac.GiacSetting.eval_level.__get__ (build/cythonized/sage/libs/giac/giac.cpp:10554)\n[sagemath_doc_html-none]     return (self.cas_setup()[7][3])._val\n[sagemath_doc_html-none]   File \"sage/libs/giac/giac.pyx\", line 1036, in sage.libs.giac.giac.Pygen.__getitem__ (build/cythonized/sage/libs/giac/giac.cpp:142533)\n[sagemath_doc_html-none]     ans=Pygen(cmd).eval()\n[sagemath_doc_html-none]   File \"sage/libs/giac/giac.pyx\", line 1125, in sage.libs.giac.giac.Pygen.eval (build/cythonized/sage/libs/giac/giac.cpp:143178)\n[sagemath_doc_html-none]     raise RuntimeError\n[sagemath_doc_html-none] RuntimeError\n[sagemath_doc_html-none] \n[sagemath_doc_html-none] During handling of the above exception, another exception occurred:\n[sagemath_doc_html-none] \n```\n\n\n\n(Previously reported in #32087#comment:33)\n\nIssue created by migration from https://trac.sagemath.org/ticket/33056\n\n",
    "created_at": "2021-12-21T05:06:12Z",
    "labels": [
        "component: porting",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "conda-forge-standard: Runtime error in sage.libs.giac",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32819",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @isuruf @kiwifb @dimpase @videlec

... while docbuilding


```
[sagemath_doc_html-none] Traceback (most recent call last):
[sagemath_doc_html-none]   File "sage/libs/giac/giac.pyx", line 1121, in sage.libs.giac.giac.Pygen.eval (build/cythonized/sage/libs/giac/giac.cpp:143102)
[sagemath_doc_html-none]     result=GIAC_protecteval(self.gptr[0],giacsettings.eval_level,context_ptr)
[sagemath_doc_html-none]   File "sage/libs/giac/giac.pyx", line 739, in sage.libs.giac.giac.GiacSetting.eval_level.__get__ (build/cythonized/sage/libs/giac/giac.cpp:10554)
[sagemath_doc_html-none]     return (self.cas_setup()[7][3])._val
[sagemath_doc_html-none]   File "sage/libs/giac/giac.pyx", line 1036, in sage.libs.giac.giac.Pygen.__getitem__ (build/cythonized/sage/libs/giac/giac.cpp:142533)
[sagemath_doc_html-none]     ans=Pygen(cmd).eval()
[sagemath_doc_html-none]   File "sage/libs/giac/giac.pyx", line 1125, in sage.libs.giac.giac.Pygen.eval (build/cythonized/sage/libs/giac/giac.cpp:143178)
[sagemath_doc_html-none]     raise RuntimeError
[sagemath_doc_html-none] RuntimeError
[sagemath_doc_html-none] 
[sagemath_doc_html-none] During handling of the above exception, another exception occurred:
[sagemath_doc_html-none] 
```



(Previously reported in #32087#comment:33)

Issue created by migration from https://trac.sagemath.org/ticket/33056





---

archive/issue_comments_467302.json:
```json
{
    "body": "Does `giac` even start and work on that machine - without going through sage.",
    "created_at": "2021-12-21T06:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467302",
    "user": "https://github.com/kiwifb"
}
```

Does `giac` even start and work on that machine - without going through sage.



---

archive/issue_comments_467303.json:
```json
{
    "body": "No, it looks it's broken\n\n```\n(base) root@a22492f2faa5:/sage# which giac\n/opt/conda/bin/giac\n(base) root@a22492f2faa5:/sage# giac\n// Maximum number of parallel threads 10\nWarning adding 1 ) at end of input\nSegmentation fault\n```\n\n\n(This is an image built with `tox -e docker-conda-forge-standard`)",
    "created_at": "2021-12-21T06:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467303",
    "user": "https://github.com/mkoeppe"
}
```

No, it looks it's broken

```
(base) root@a22492f2faa5:/sage# which giac
/opt/conda/bin/giac
(base) root@a22492f2faa5:/sage# giac
// Maximum number of parallel threads 10
Warning adding 1 ) at end of input
Segmentation fault
```


(This is an image built with `tox -e docker-conda-forge-standard`)



---

archive/issue_comments_467304.json:
```json
{
    "body": "OK, that's one suspicion correct from the doctest failure. It is still quite strange, it starts and then breaks down rather than just going straight to segfault. Multiple versions of some libraries trying to load?",
    "created_at": "2021-12-21T06:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467304",
    "user": "https://github.com/kiwifb"
}
```

OK, that's one suspicion correct from the doctest failure. It is still quite strange, it starts and then breaks down rather than just going straight to segfault. Multiple versions of some libraries trying to load?



---

archive/issue_comments_467305.json:
```json
{
    "body": "bump to 9.6",
    "created_at": "2022-01-29T08:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467305",
    "user": "https://github.com/fchapoton"
}
```

bump to 9.6



---

archive/issue_comments_467306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-16T20:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467306",
    "user": "https://github.com/isuruf"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467307.json:
```json
{
    "body": "Fixed in https://github.com/conda-forge/giac-feedstock/pull/28\n\nGiac was storing aide_cas location in the build machine in a C++\nstring and that failed with conda's relocation helper which only\nworks with C strings.\n\nFixed it by using dladdr to get the full path to lib/libgiac.so.0\nand reconstructed the path.",
    "created_at": "2022-02-16T20:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467307",
    "user": "https://github.com/isuruf"
}
```

Fixed in https://github.com/conda-forge/giac-feedstock/pull/28

Giac was storing aide_cas location in the build machine in a C++
string and that failed with conda's relocation helper which only
works with C strings.

Fixed it by using dladdr to get the full path to lib/libgiac.so.0
and reconstructed the path.



---

archive/issue_comments_467308.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-17T16:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467308",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467309.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-20T14:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32819#issuecomment-467309",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_029741.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-20T14:33:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32819",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32819#event-29741"
}
```
