# Issue 18715: heavy performance regression with real/imag(ex)

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-07-25 15:07:00

This is the first Symbench test. Sage around 4.3 took 0.3s (see http://wiki.sagemath.org/symbench#Problem_R1) but Sage-6.8rc0 needs 10 minutes:

```
sage: def f(z): return sqrt(1/3)*z^2 + i/3
sage: real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))))
```

while

```
sage: %timeit real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))).expand())
10 loops, best of 3: 23.5 ms per loop
```

A simplified version of this is:

```
sage: real((((((((((sqrt(3)+I)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2
```




---

Comment by rws created at 2015-07-26 07:19:33

Profiling with callgrind reveals remarkable things, even with only 6 f's. Although Pynac accounts for less than 1 per cent of the time, a whopping 150,000 of numerics are created;  88,000 calls to `ex::is_zero`; 50,000 to `Integer(long)`. The 3,400 calls of `atan2` show that the formula `power(abs(basis),c)*exp(-d*atan2(b,a))*cos(c*atan2(b,a)+d*log(abs(basis)))` is used to compute `real((1/3)^(1/2))` over and over.

The simplest solution would be to expand before taking the real part in Pynac.

However, there is probably more in this use case regarding performance improvement.


---

Comment by vdelecroix created at 2015-09-13 18:37:56

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-09-13 18:39:04

Ralf,

With #18980 the problem seems to disappear. Should we close it as a duplicate?

Vincent


---

Comment by vdelecroix created at 2015-09-13 18:39:11

Changing status from needs_review to needs_info.


---

Comment by rws created at 2015-09-14 05:41:47

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2015-09-14 12:00:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-25 08:22:06

Resolution: fixed
