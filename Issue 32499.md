# Issue 32499: LU permutation matrix has the wrong base ring

Issue created by migration from https://trac.sagemath.org/ticket/32736

Original creator: mmarco

Original creation time: 2021-10-21 16:50:04

CC:  tscrim dimpase slelievre

According to the documentation, the matrices returned by the `LU` method have coefficients in the fraction field of the input's base ring.

However, it is not actually the case:


```
sage: M = Matrix(FiniteField(11), [[2,3],[4,5]])
sage: P, L, U = M.LU()
sage: P.base_ring()
Integer Ring
}}} 

This can lead to the following consecuences:

{{{
sage: M*P.inverse()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-bdd492b898a9> in <module>
----> 1 M*P.inverse()

~/sage/local/lib/python3.9/site-packages/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23965)()
   3813 
   3814         if BOTH_ARE_ELEMENT(cl):
-> 3815             return coercion_model.bin_op(left, right, mul)
   3816 
   3817         cdef long value

~/sage/local/lib/python3.9/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11723)()
   1246         # We should really include the underlying error.
   1247         # This causes so much headache.
-> 1248         raise bin_op_exception(op, x, y)
   1249 
   1250     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 2 dense matrices over Finite Field of size 11' and 'Full MatrixSpace of 2 by 2 sparse matrices over Rational Field'
}}}

This happens because the inverse of `P` has coefficients in the rationals, and they cannot be coerced into finite fields.




---

Comment by mmarco created at 2021-10-21 17:41:18

Changing status from new to needs_review.


---

Comment by git created at 2021-10-21 17:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-10-21 23:22:38

While this works, I feel the better place to fix this would be to change the `to_matrix()` to take a `base_ring` (with default being `ZZ`) input so you do not create a transient matrix (and possibly matrix space).

A while-we-are-at-it thing: the initial call `sage.combinat.permutation.Permutation(perm)` is somewhat expensive due to extra checks. So I would ultimately change this line to

```python
Sm = sage.combinat.permutation.Permutations(m)
P = Sm.element_class(Sm, perm, check_input=False).to_matrix(F)
```

However, even the permutation element is transient (but less so than the matrix IMO), and perhaps the best thing to do for speed is to factor out the `to_matrix()` to a separate function that can take a (ducktyped) list input (e.g., a `tuple` or `Permutation`). This can be for a separate ticket too.


---

Comment by nbruin created at 2021-10-22 04:47:28

The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...


---

Comment by dimpase created at 2021-10-22 10:19:23

Permutation matrices are orthogonal, so the inverse is just transpose.


---

Comment by mmarco created at 2021-10-23 10:21:19

Replying to [comment:5 nbruin]:
> The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...


The inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.


---

Comment by nbruin created at 2021-10-23 21:06:02

Replying to [comment:7 mmarco]:
> The inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.

The group GL(n,ZZ) only contains matrices that have determinant +-1. That's why computing an inverse there works. Mathematically, using GL(n,ZZ) is a perfectly fine solution, but there may be performance penaltieswe might need to consider.

Dima's comment is spot-on as well: we could use GO(n,ZZ), which could lead to a more efficient inverse routine. Same reservations about overhead of instantiating the parent, though.

As the implementation of inverse on matrix groups over ZZ shows, the routine that actually gets used in "inverse_of_unit", which is available on matrices over ZZ in general.

So the problem in the code above can already be solved by using

```
M*P.inverse_of_unit()
```

(and `M*P.T` would work too, by Dima's comment)

So I think this ticket can be resolved by fixing the documentation of LU and perhaps including a pointer that `inverse` may lead to inadvertent base ring changes, which can be avoided with `inverse_of_unit`.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by dimpase created at 2022-03-04 17:33:46

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-03-04 17:33:46

Matrix factorisations are somewhat tricky. Some won't be in the field generated by the matrix entries, e.g. Cholesky. Some will be, e.g. LDL*, or LU. So I vote for this fix.


---

Comment by vbraun created at 2022-03-09 23:38:19

Resolution: fixed
