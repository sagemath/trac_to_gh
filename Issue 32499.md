# Issue 32499: LU permutation matrix has the wrong base ring

archive/issues_032499.json:
```json
{
    "body": "CC:  @tscrim @dimpase @slel\n\nAccording to the documentation, the matrices returned by the `LU` method have coefficients in the fraction field of the input's base ring.\n\nHowever, it is not actually the case:\n\n```\nsage: M = Matrix(FiniteField(11), [[2,3],[4,5]])\nsage: P, L, U = M.LU()\nsage: P.base_ring()\nInteger Ring\n``` \n\nThis can lead to the following consecuences:\n\n```\nsage: M*P.inverse()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-6-bdd492b898a9> in <module>\n----> 1 M*P.inverse()\n\n~/sage/local/lib/python3.9/site-packages/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23965)()\n   3813 \n   3814         if BOTH_ARE_ELEMENT(cl):\n-> 3815             return coercion_model.bin_op(left, right, mul)\n   3816 \n   3817         cdef long value\n\n~/sage/local/lib/python3.9/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11723)()\n   1246         # We should really include the underlying error.\n   1247         # This causes so much headache.\n-> 1248         raise bin_op_exception(op, x, y)\n   1249 \n   1250     cpdef canonical_coercion(self, x, y):\n\nTypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 2 dense matrices over Finite Field of size 11' and 'Full MatrixSpace of 2 by 2 sparse matrices over Rational Field'\n```\n\nThis happens because the inverse of `P` has coefficients in the rationals, and they cannot be coerced into finite fields.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32736\n\n",
    "closed_at": "2022-03-09T23:38:19Z",
    "created_at": "2021-10-21T16:50:04Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "LU permutation matrix has the wrong base ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32499",
    "user": "https://github.com/miguelmarco"
}
```
CC:  @tscrim @dimpase @slel

According to the documentation, the matrices returned by the `LU` method have coefficients in the fraction field of the input's base ring.

However, it is not actually the case:

```
sage: M = Matrix(FiniteField(11), [[2,3],[4,5]])
sage: P, L, U = M.LU()
sage: P.base_ring()
Integer Ring
``` 

This can lead to the following consecuences:

```
sage: M*P.inverse()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-bdd492b898a9> in <module>
----> 1 M*P.inverse()

~/sage/local/lib/python3.9/site-packages/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23965)()
   3813 
   3814         if BOTH_ARE_ELEMENT(cl):
-> 3815             return coercion_model.bin_op(left, right, mul)
   3816 
   3817         cdef long value

~/sage/local/lib/python3.9/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11723)()
   1246         # We should really include the underlying error.
   1247         # This causes so much headache.
-> 1248         raise bin_op_exception(op, x, y)
   1249 
   1250     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 2 dense matrices over Finite Field of size 11' and 'Full MatrixSpace of 2 by 2 sparse matrices over Rational Field'
```

This happens because the inverse of `P` has coefficients in the rationals, and they cannot be coerced into finite fields.



Issue created by migration from https://trac.sagemath.org/ticket/32736





---

archive/issue_comments_463008.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-21T17:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463008",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463009.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T17:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463009",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463010.json:
```json
{
    "body": "While this works, I feel the better place to fix this would be to change the `to_matrix()` to take a `base_ring` (with default being `ZZ`) input so you do not create a transient matrix (and possibly matrix space).\n\nA while-we-are-at-it thing: the initial call `sage.combinat.permutation.Permutation(perm)` is somewhat expensive due to extra checks. So I would ultimately change this line to\n\n```python\nSm = sage.combinat.permutation.Permutations(m)\nP = Sm.element_class(Sm, perm, check_input=False).to_matrix(F)\n```\nHowever, even the permutation element is transient (but less so than the matrix IMO), and perhaps the best thing to do for speed is to factor out the `to_matrix()` to a separate function that can take a (ducktyped) list input (e.g., a `tuple` or `Permutation`). This can be for a separate ticket too.",
    "created_at": "2021-10-21T23:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463010",
    "user": "https://github.com/tscrim"
}
```

While this works, I feel the better place to fix this would be to change the `to_matrix()` to take a `base_ring` (with default being `ZZ`) input so you do not create a transient matrix (and possibly matrix space).

A while-we-are-at-it thing: the initial call `sage.combinat.permutation.Permutation(perm)` is somewhat expensive due to extra checks. So I would ultimately change this line to

```python
Sm = sage.combinat.permutation.Permutations(m)
P = Sm.element_class(Sm, perm, check_input=False).to_matrix(F)
```
However, even the permutation element is transient (but less so than the matrix IMO), and perhaps the best thing to do for speed is to factor out the `to_matrix()` to a separate function that can take a (ducktyped) list input (e.g., a `tuple` or `Permutation`). This can be for a separate ticket too.



---

archive/issue_comments_463011.json:
```json
{
    "body": "The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...",
    "created_at": "2021-10-22T04:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463011",
    "user": "https://github.com/nbruin"
}
```

The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...



---

archive/issue_comments_463012.json:
```json
{
    "body": "Permutation matrices are orthogonal, so the inverse is just transpose.",
    "created_at": "2021-10-22T10:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463012",
    "user": "https://github.com/dimpase"
}
```

Permutation matrices are orthogonal, so the inverse is just transpose.



---

archive/issue_comments_463013.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...\n\n\n\nThe inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.",
    "created_at": "2021-10-23T10:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463013",
    "user": "https://github.com/miguelmarco"
}
```

Replying to [comment:5 nbruin]:
> The natural base ring of a permutation matrix is indeed the integers. I think the right solution here is to compute the inverse of P over the integers as well. One option might be to return the answer in GL(n,ZZ) [it does know how to invert its matrices over ZZ], but perhaps that causes too much overhead ...



The inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.



---

archive/issue_comments_463014.json:
```json
{
    "body": "Replying to [comment:7 mmarco]:\n> The inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.\n\n\nThe group GL(n,ZZ) only contains matrices that have determinant +-1. That's why computing an inverse there works. Mathematically, using GL(n,ZZ) is a perfectly fine solution, but there may be performance penaltieswe might need to consider.\n\nDima's comment is spot-on as well: we could use GO(n,ZZ), which could lead to a more efficient inverse routine. Same reservations about overhead of instantiating the parent, though.\n\nAs the implementation of inverse on matrix groups over ZZ shows, the routine that actually gets used in \"inverse_of_unit\", which is available on matrices over ZZ in general.\n\nSo the problem in the code above can already be solved by using\n\n```\nM*P.inverse_of_unit()\n```\n(and `M*P.T` would work too, by Dima's comment)\n\nSo I think this ticket can be resolved by fixing the documentation of LU and perhaps including a pointer that `inverse` may lead to inadvertent base ring changes, which can be avoided with `inverse_of_unit`.",
    "created_at": "2021-10-23T21:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463014",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:7 mmarco]:
> The inverse of an integer matrix will, in general have coefficients in the rationals. Only when the determinant is 1 or -1 will be integers. I think it is important to keep the contract that the parent of the output depends only on the parent of the input.


The group GL(n,ZZ) only contains matrices that have determinant +-1. That's why computing an inverse there works. Mathematically, using GL(n,ZZ) is a perfectly fine solution, but there may be performance penaltieswe might need to consider.

Dima's comment is spot-on as well: we could use GO(n,ZZ), which could lead to a more efficient inverse routine. Same reservations about overhead of instantiating the parent, though.

As the implementation of inverse on matrix groups over ZZ shows, the routine that actually gets used in "inverse_of_unit", which is available on matrices over ZZ in general.

So the problem in the code above can already be solved by using

```
M*P.inverse_of_unit()
```
(and `M*P.T` would work too, by Dima's comment)

So I think this ticket can be resolved by fixing the documentation of LU and perhaps including a pointer that `inverse` may lead to inadvertent base ring changes, which can be avoided with `inverse_of_unit`.



---

archive/issue_comments_463015.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463015",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_events_086649.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32499#event-86649"
}
```



---

archive/issue_comments_463016.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-04T17:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463016",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463017.json:
```json
{
    "body": "Matrix factorisations are somewhat tricky. Some won't be in the field generated by the matrix entries, e.g. Cholesky. Some will be, e.g. LDL*, or LU. So I vote for this fix.",
    "created_at": "2022-03-04T17:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463017",
    "user": "https://github.com/dimpase"
}
```

Matrix factorisations are somewhat tricky. Some won't be in the field generated by the matrix entries, e.g. Cholesky. Some will be, e.g. LDL*, or LU. So I vote for this fix.



---

archive/issue_comments_463018.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-09T23:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32499#issuecomment-463018",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086650.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32499",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32499#event-86650"
}
```
