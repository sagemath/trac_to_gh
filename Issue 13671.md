# Issue 13671: Test memory allocation in distances_all_pairs

Issue created by migration from https://trac.sagemath.org/ticket/13875

Original creator: dcoudert

Original creation time: 2012-12-28 11:35:13

Assignee: jason, ncohen, rlm

CC:  ncohen

This patch adds tests on memory allocation in the distances_all_pairs module. This is to prevent returning NULL pointers when the memory space is insufficient to allocate data structure.

These tests are not doctested since the behavior depends on the computer (ram).


---

Comment by dcoudert created at 2012-12-28 11:41:19

Changing status from new to needs_review.


---

Comment by ncohen created at 2012-12-28 11:46:16

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2012-12-28 11:46:16

Hellooooooooooooooo !!!

You cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.

Besides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !

Oh. And I am not sure that it is wise to return as a message "Not enough space". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.

Nathann


---

Comment by dcoudert created at 2012-12-28 12:41:32

> You cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.

done.

> Besides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !

No, this ticket is hopefully independent on the hyperbolicity patch. Furthermore, it don't change the behavior of the hyperbolicity patch. I have tested all possible combinations and I have no conflicts.

> Oh. And I am not sure that it is wise to return as a message "Not enough space". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.

done.


---

Comment by dcoudert created at 2012-12-28 12:41:32

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2012-12-28 12:42:44

?.. BUt in the hyperbolicity patch you test that the pointers you are given by these methods are not null, don't you ? ANd after your patch they cannot be NULL anymore ?...

Nathann


---

Comment by dcoudert created at 2012-12-28 14:01:59

If we have to indicate dependencies, it's in the other way. We may change patch #13808 according the behavior of this one, but this patch don't depend on patch #13808. I have therefore removed the dependency.

Furthermore, it is true that with this patch some tests in patch #13808 become useless. However, I think it is better to be on the safe side and to let them in case something else happen. The cost of these tests is clearly negligible.


---

Comment by ncohen created at 2012-12-28 22:23:50

Yoooooooooo !!

Well, the point of not having #13808 depend on this very patch is that #13808 is complicated enough *AND* already reviewed. And what's the point of testing whether the pointers are not null when the function cannot return NULL pointers ? It is checked, the function just can't return NULL pointers `O_o` The cost is negligible but what's the point as what it does is useless ? The code is not that easy to read, so let's remove the maximum amount of useless stuff ! And if we happen to copy/paste code from this file to another one, we won't copy useless checks at the same time ! `O_o`

Nathann


---

Comment by dcoudert created at 2012-12-29 00:32:01

OK, you win ;-)
I have removed the test in hyperbolicity.pyx and so added the dependency.


---

Comment by ncohen created at 2012-12-29 09:24:15

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2012-12-29 09:24:15

`^^;`

Thanks !

As before, though, there are memory leaks if `t_prec` is allocated but not `prec`.


```
 t_prec = <unsigned short *> sage_malloc(n*n*sizeof(short)) 
 if t_prec==NULL: 
     raise MemoryError() 
 prec = <unsigned short **> sage_malloc(n*sizeof(short *)) 
 if prec==NULL: 
     raise MemoryError() 
```


You should add a `sage_free(t_prec)` before the second `raise MemoryError()`, and it hppens several timees in the file.

Nathann


---

Attachment

Fixed.


---

Comment by dcoudert created at 2012-12-29 10:01:44

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2012-12-29 11:38:20

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2012-12-29 11:38:20

Looks good `:-)`

(and I love my hggett script `:-P`)

Nathann


---

Comment by dcoudert created at 2012-12-29 11:42:32

Thanks for the review and for the script ;-)


---

Comment by jdemeyer created at 2013-01-12 08:53:33

Resolution: fixed
