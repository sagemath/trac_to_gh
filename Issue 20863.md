# Issue 20863: division error in normalize_coordinates

Issue created by migration from https://trac.sagemath.org/ticket/21100

Original creator: bhutz

Original creation time: 2016-07-26 20:36:33

When the gcd is a multivariate polynomial, it does not cancel upon scaling


```
R.<a,b>=QQ[]
P.<x,y,z>=ProjectiveSpace(R,2)
H=End(P)
f=H([a*(x+y)*x^2,b*(x+y)*y^2,(x+y)*z^2])
f.normalize_coordinates()
```


This division can be done through maxima


---

Comment by bhutz created at 2016-07-26 21:31:48

This fixes the found bug. I haven't found any additional examples that we should be able to compute that we cannot. Searching for some additional difficult examples would be good.
----
New commits:


---

Comment by bhutz created at 2016-07-26 21:31:48

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-07-26 22:56:11

I would prefer

```
def normalize_coordinates(self, method=None):
    if method is None:
        # document why it is done this way
        try:
            self.normalize_coordinates(method='singular')
        except (TypeError, NotImplementedError):
            self.normalize_coordinates(method='maxima')
    elif method == 'singular':
        # do singular way
    elif method == 'maxima':
        # do maxima way
    else:
        raise ValueError("method={} not available".format(method))
```

This way you could have doctests for:
- the singular failure reported in this doctest
- comparison between maxima and singular versions

By the way, why do you catch both `TypeError` and `NotImplementedError`?

Does it work on last versions of singular?


---

Comment by vdelecroix created at 2016-07-26 22:56:11

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2016-07-27 01:11:18

Yes, I see the logic in that. I can do it that way.

err...I'll need to check but the NotImplementedError may not occur in this case. That is a carry over from dynatomic_polynomial where a similar thing is done. I'll look into the 'method' approach for that function too so the singular failure can be tracked.

as for the most recent version of singular. I'm not sure, this fails on sage 7.3.beta9 and whatever singular is in that. I don't have a stand-alone singular.


---

Comment by vdelecroix created at 2016-07-27 01:37:30

We are far away in Sage. Singular 4.0.2 is available (see #17254 almost 2 years old ticket) and Sage ships 3.1.7.


---

Comment by git created at 2016-07-27 01:40:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-07-27 01:42:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-07-27 01:49:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-07-27 02:03:27

I did not see, but with what I proposed you might end up computing twice the GCD... don't know if it is a big problem.


---

Comment by vdelecroix created at 2016-07-27 02:15:47

actually three times!


---

Comment by vdelecroix created at 2016-07-27 02:25:42

Another option seems to flatten the polynomial ring in order to make singular happier

```
sage: R.<a,b> = QQ[]
sage: P.<x,y,z> = R[]
sage: p0 = a*(x+y)*x^2
sage: g = x + y
sage: p0.quo_rem(g)
Traceback (most recent call last):
...
TypeError: no conversion of this ring to a Singular ring defined
sage: Pflat.<x,y,z,a,b> = QQ[]
sage: p0 = Pflat(str(p0))   # conversion hack ;-)
sage: g = Pflat(g)
sage: p0.quo_rem(g)
(x^2*a, 0)
```



---

Comment by vdelecroix created at 2016-07-27 02:28:15

We can introduce a method to multivariate polynomial ring to build a "flattening morphism" like `QQ[a,b][x,y,z] -> QQ[a,b,x,y,z]` (as soon as variable names do not clash).


---

Attachment


---

Comment by bhutz created at 2016-07-27 12:06:50

Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.

I didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.

Do you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?


---

Comment by vdelecroix created at 2016-07-27 13:41:53

Replying to [comment:13 bhutz]:
> Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.
> 
> I didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.
> 
> Do you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?

I guess the flattening can be done in another ticket. Concerning this one, it can either wait for flattening or it can be closed and refactored later on. If you have time for working on it please go ahead.


---

Comment by bhutz created at 2016-07-27 15:37:16

flattening is now #21106


---

Comment by bhutz created at 2016-07-27 21:53:04

This ticket is now superseded by #21108.


---

Comment by vdelecroix created at 2016-07-27 22:07:21

Not necessarily. In `dynatomic_polynomial` there are still problematic rings, namely
- p-adic ring
- fraction fields
Will they appear in `normalize_coordinates`?


---

Comment by bhutz created at 2016-07-27 22:16:38

No, the further problematic rings treated in dynatomic don't have gcds, so it doesn't get that far.

I do think some of the special casing in dynatomic can now also be removed. I was going to do that in a different ticket.


---

Comment by bhutz created at 2016-07-27 22:26:05

in further testing, it looks like the _maxima_ still is needed in dynatomic_polynomial


---

Comment by vdelecroix created at 2016-07-28 12:12:56

What do you want to do with this one? If you want to close it you should change the milestone to `duplicate/won't fix`.


---

Comment by vdelecroix created at 2016-07-28 14:04:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-08-30 13:32:25

Resolution: wontfix


---

Comment by embray created at 2016-08-30 13:32:25

Determined to be invalid/duplicate/wontfix (closing as "wontfix" as a catch-all resolution).
