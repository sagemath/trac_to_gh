# Issue 32845: segfault: illegal (popcnt) instruction in primecount

Issue created by migration from https://trac.sagemath.org/ticket/33082

Original creator: mjo

Original creation time: 2021-12-26 14:48:40

CC:  dimpase


```
$ sage
...
Unhandled SIGILL: An illegal instruction occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Illegal instruction
```


This is from primecount, which appends `-mpopcnt` to `CXXFLAGS` even when the CPU does not support it.


---

Comment by mkoeppe created at 2021-12-26 18:02:52

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-12-26 18:39:57

https://github.com/kimwalisch/primecount/blob/master/doc/libprimecount.md#maximum-portability


---

Comment by mkoeppe created at 2021-12-26 18:48:51

Indeed - it adds the flag whenever the compiler supports it https://github.com/kimwalisch/primecount/blob/master/CMakeLists.txt#L321


---

Comment by mkoeppe created at 2021-12-26 18:52:08

Given that for us only the branch `#if defined(__GNUC__) ||    __has_builtin(__builtin_popcountl)` is relevant (https://github.com/kimwalisch/primecount/blob/master/include/popcnt.hpp#L29), I think we can just unconditionally set `WITH_POPCNT=OFF`.


---

Comment by mkoeppe created at 2021-12-26 19:02:45

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-26 19:02:45

New commits:


---

Comment by git created at 2021-12-26 19:03:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-12-26 21:29:22

Looks like it should work, but can you add a comment to the spkg-install mentioning that e.g. `WITH_POPCNT=OFF` is harmless on gcc when popcnt is available? That way if we ever `git grep gcc` to support other compilers, we find the comment.


---

Comment by git created at 2021-12-26 21:35:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-12-26 21:35:25

strange that the upstream doesn't check that popcount is availble. Should we open an issue there?
----
New commits:


---

Comment by mjo created at 2021-12-26 22:54:11

Thanks, everything works with this branch after `make primecount-clean; make primecount`.


---

Comment by mjo created at 2021-12-26 22:54:11

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-26 23:08:08

Replying to [comment:10 dimpase]:
> strange that the upstream doesn't check that popcount is availble. Should we open an issue there?
Already did, see ticket description


---

Comment by vbraun created at 2021-12-29 21:43:13

Resolution: fixed
