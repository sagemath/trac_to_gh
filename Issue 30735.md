# Issue 30735: Symlinks and system packages

archive/issues_030735.json:
```json
{
    "body": "CC:  @jcamp0x2a @kiwifb @mkoeppe @EmmanuelCharpentier @enriqueartal @jhpalmieri @seblabbe @antonio-rojas @defeo @novoselt @dimpase\n\nKeywords: threejs jsmol jupyter\n\nFrom Matthias Koeppe on #30915:\n\nThe issue is about share/jupyter/nbextensions/threejs and the fact that there will be several unrelated copies of that.\n\nHere is an example.\n\nLet's say system jupyter is installed in /usr, so the notebook server is accessing /usr/share/jupyter/nbextensions.\nSage-9.x may be installed in /home/x/sage-9.x/local/ and may need threejs r122.\nSage-9.y may be installed in /home/x/sage-9.y/local/ and may need threejs r155.\nLet's say r122 and r155 are mutually incompatible.\nAs `@`enriqueartal has reported above, our offline threejs graphics needs /usr/share/jupyter/nbextensions/threejs/. But the system does not provide it -- it must come from Sage. If we create a symlink /usr/share/jupyter/nbextensions/threejs -> /home/x/sage-9.x/local/share/jupyter/nbextensions/threejs, then Sage 9.x will work with the system jupyter notebook; but Sage 9.y will not.\n\nDo you agree?\n\nSo this means that we need a versioned installation scheme. The details of this installation scheme is what I am trying to discuss with you, in particular because it is certainly related to that new repository.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30972\n\n",
    "created_at": "2020-11-27T21:45:43Z",
    "labels": [
        "component: graphics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Symlinks and system packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30735",
    "user": "https://github.com/paulmasson"
}
```
CC:  @jcamp0x2a @kiwifb @mkoeppe @EmmanuelCharpentier @enriqueartal @jhpalmieri @seblabbe @antonio-rojas @defeo @novoselt @dimpase

Keywords: threejs jsmol jupyter

From Matthias Koeppe on #30915:

The issue is about share/jupyter/nbextensions/threejs and the fact that there will be several unrelated copies of that.

Here is an example.

Let's say system jupyter is installed in /usr, so the notebook server is accessing /usr/share/jupyter/nbextensions.
Sage-9.x may be installed in /home/x/sage-9.x/local/ and may need threejs r122.
Sage-9.y may be installed in /home/x/sage-9.y/local/ and may need threejs r155.
Let's say r122 and r155 are mutually incompatible.
As `@`enriqueartal has reported above, our offline threejs graphics needs /usr/share/jupyter/nbextensions/threejs/. But the system does not provide it -- it must come from Sage. If we create a symlink /usr/share/jupyter/nbextensions/threejs -> /home/x/sage-9.x/local/share/jupyter/nbextensions/threejs, then Sage 9.x will work with the system jupyter notebook; but Sage 9.y will not.

Do you agree?

So this means that we need a versioned installation scheme. The details of this installation scheme is what I am trying to discuss with you, in particular because it is certainly related to that new repository.

Issue created by migration from https://trac.sagemath.org/ticket/30972





---

archive/issue_comments_438829.json:
```json
{
    "body": "I'm no expert on Python, especially the way implementations my differ, but it can access the local file system and Sage already has `THREEJS_DIR`. Why not set the symlink to Three.js or any package when the kernel initially loads? That way the system package will use whatever version accompanies the kernel.",
    "created_at": "2020-11-27T21:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438829",
    "user": "https://github.com/paulmasson"
}
```

I'm no expert on Python, especially the way implementations my differ, but it can access the local file system and Sage already has `THREEJS_DIR`. Why not set the symlink to Three.js or any package when the kernel initially loads? That way the system package will use whatever version accompanies the kernel.



---

archive/issue_comments_438830.json:
```json
{
    "body": "That's not a solution because a user may want to use two different Sage versions at the same time.",
    "created_at": "2020-11-27T21:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438830",
    "user": "https://github.com/mkoeppe"
}
```

That's not a solution because a user may want to use two different Sage versions at the same time.



---

archive/issue_comments_438831.json:
```json
{
    "body": "Replying to [comment:2 mkoeppe]:\n> That's not a solution because a user may want to use two different Sage versions at the same time.\n\nWhy exactly would someone want to do this? I can see a user not wanting to upgrade to the newest version, but why would they use an older version when the newer one will almost certainly be an improvement?",
    "created_at": "2020-11-28T00:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438831",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:2 mkoeppe]:
> That's not a solution because a user may want to use two different Sage versions at the same time.

Why exactly would someone want to do this? I can see a user not wanting to upgrade to the newest version, but why would they use an older version when the newer one will almost certainly be an improvement?



---

archive/issue_comments_438832.json:
```json
{
    "body": "Should we use JUPYTER_PATH for this kind of things? https://jupyter.readthedocs.io/en/latest/use/jupyter-directories.html",
    "created_at": "2020-11-28T00:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438832",
    "user": "https://github.com/kiwifb"
}
```

Should we use JUPYTER_PATH for this kind of things? https://jupyter.readthedocs.io/en/latest/use/jupyter-directories.html



---

archive/issue_comments_438833.json:
```json
{
    "body": "Replying to [comment:3 paulmasson]:\n> Replying to [comment:2 mkoeppe]:\n> > That's not a solution because a user may want to use two different Sage versions at the same time.\n\n> Why exactly would someone want to do this?\n\nUsers have complex needs.",
    "created_at": "2020-11-28T00:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438833",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 paulmasson]:
> Replying to [comment:2 mkoeppe]:
> > That's not a solution because a user may want to use two different Sage versions at the same time.

> Why exactly would someone want to do this?

Users have complex needs.



---

archive/issue_comments_438834.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> Replying to [comment:3 paulmasson]:\n> > Replying to [comment:2 mkoeppe]:\n> > > That's not a solution because a user may want to use two different Sage versions at the same time.\n\n> > Why exactly would someone want to do this?\n> \n> Users have complex needs.\n\nConsidering that I don't even use Sage, I'll need a better answer than this before devoting more time to this issue. We are not required to support every feature desired by end users. We can simply tell them to run only one kernel at a time. Who is making the decision to support this option?",
    "created_at": "2020-11-28T00:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438834",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:5 mkoeppe]:
> Replying to [comment:3 paulmasson]:
> > Replying to [comment:2 mkoeppe]:
> > > That's not a solution because a user may want to use two different Sage versions at the same time.

> > Why exactly would someone want to do this?
> 
> Users have complex needs.

Considering that I don't even use Sage, I'll need a better answer than this before devoting more time to this issue. We are not required to support every feature desired by end users. We can simply tell them to run only one kernel at a time. Who is making the decision to support this option?



---

archive/issue_comments_438835.json:
```json
{
    "body": "Replying to [comment:4 fbissey]:\n> Should we use JUPYTER_PATH for this kind of things? https://jupyter.readthedocs.io/en/latest/use/jupyter-directories.html\n\n\nI don't think this can be solved by using environment variables. The issue is that the notebook may access different kernels when the kernelspec is installed, and (apparently) the notebook webserver is expected to serve the local threejs files. Now these files are kernel-specific (because they are tied to the sagelib version).\n\nFrancois, how do you currently install these files in gentoo packaging?\n(Overall I think we need some input from downstream packaging to make progress here.)",
    "created_at": "2020-11-28T01:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438835",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:4 fbissey]:
> Should we use JUPYTER_PATH for this kind of things? https://jupyter.readthedocs.io/en/latest/use/jupyter-directories.html


I don't think this can be solved by using environment variables. The issue is that the notebook may access different kernels when the kernelspec is installed, and (apparently) the notebook webserver is expected to serve the local threejs files. Now these files are kernel-specific (because they are tied to the sagelib version).

Francois, how do you currently install these files in gentoo packaging?
(Overall I think we need some input from downstream packaging to make progress here.)



---

archive/issue_comments_438836.json:
```json
{
    "body": "For \"sagelib\" I disable https://github.com/sagemath/sage/blob/develop/src/sage/repl/ipython_kernel/install.py#L281 because of the way I have to install documentation following Gentoo's guidelines (not everyone in Gentoo is happy with the current way of doing this) and I do the stuff from that line manually. For the rest, sagelib's kernel install is used - it wasn't always the case.\n\nI just change the kernel specs to use the current python directly.\n\nI don't support any versioning of sage whatsoever. Multiple pythons are supported and work thanks to the current Gentoo python infrastructure that supports it. But stuff in `/usr/share/jupyter/` has to be somewhat python independent really.\n\n```\nfbissey@moonloop ~ $ ll /usr/share/jupyter/kernels/sagemath/\ntotal 20K\ndrwxr-xr-x 2 root root 4.0K Nov 27 12:55 .\ndrwxr-xr-x 4 root root 4.0K Apr 21  2020 ..\nlrwxrwxrwx 1 root root   30 Nov 27 12:53 doc -> ../../../doc/sage-9999/html/en\n-rw-r--r-- 1 root root  134 Nov 27 12:53 kernel.json\nlrwxrwxrwx 1 root root   93 Nov 27 12:53 logo-64x64.png -> ../../../../..//usr/lib/python3.8/site-packages/sage/ext_data/notebook-ipython/logo-64x64.png\nlrwxrwxrwx 1 root root   87 Nov 27 12:53 logo.svg -> ../../../../..//usr/lib/python3.8/site-packages/sage/ext_data/notebook-ipython/logo.svg\nfbissey@moonloop ~ $ ll /usr/share/jupyter/nbextensions/\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Nov 27 12:55 .\ndrwxr-xr-x 5 root root 4.0K Oct 26 21:37 ..\nlrwxrwxrwx 1 root root   16 Nov 27 12:53 jsmol -> /usr/share/jsmol\ndrwxr-xr-x 2 root root 4.0K Nov 19 15:56 jupyter-js-widgets\nlrwxrwxrwx 1 root root   18 Nov 27 12:53 mathjax -> /usr/share/mathjax\nlrwxrwxrwx 1 root root   23 Nov 27 12:53 threejs -> /usr/share/sage/threejs\n```\n`sage-9999` is just sage straight from the git develop branch, so right now 9.2.beta3 (but in my case, Volker's develop branch).\n\nUsers who want versioning, usually are after reproducibility. In that case system packaging is not part of the solution. containers on the other are an ideal tool for that.",
    "created_at": "2020-11-28T01:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438836",
    "user": "https://github.com/kiwifb"
}
```

For "sagelib" I disable https://github.com/sagemath/sage/blob/develop/src/sage/repl/ipython_kernel/install.py#L281 because of the way I have to install documentation following Gentoo's guidelines (not everyone in Gentoo is happy with the current way of doing this) and I do the stuff from that line manually. For the rest, sagelib's kernel install is used - it wasn't always the case.

I just change the kernel specs to use the current python directly.

I don't support any versioning of sage whatsoever. Multiple pythons are supported and work thanks to the current Gentoo python infrastructure that supports it. But stuff in `/usr/share/jupyter/` has to be somewhat python independent really.

```
fbissey@moonloop ~ $ ll /usr/share/jupyter/kernels/sagemath/
total 20K
drwxr-xr-x 2 root root 4.0K Nov 27 12:55 .
drwxr-xr-x 4 root root 4.0K Apr 21  2020 ..
lrwxrwxrwx 1 root root   30 Nov 27 12:53 doc -> ../../../doc/sage-9999/html/en
-rw-r--r-- 1 root root  134 Nov 27 12:53 kernel.json
lrwxrwxrwx 1 root root   93 Nov 27 12:53 logo-64x64.png -> ../../../../..//usr/lib/python3.8/site-packages/sage/ext_data/notebook-ipython/logo-64x64.png
lrwxrwxrwx 1 root root   87 Nov 27 12:53 logo.svg -> ../../../../..//usr/lib/python3.8/site-packages/sage/ext_data/notebook-ipython/logo.svg
fbissey@moonloop ~ $ ll /usr/share/jupyter/nbextensions/
total 12K
drwxr-xr-x 3 root root 4.0K Nov 27 12:55 .
drwxr-xr-x 5 root root 4.0K Oct 26 21:37 ..
lrwxrwxrwx 1 root root   16 Nov 27 12:53 jsmol -> /usr/share/jsmol
drwxr-xr-x 2 root root 4.0K Nov 19 15:56 jupyter-js-widgets
lrwxrwxrwx 1 root root   18 Nov 27 12:53 mathjax -> /usr/share/mathjax
lrwxrwxrwx 1 root root   23 Nov 27 12:53 threejs -> /usr/share/sage/threejs
```
`sage-9999` is just sage straight from the git develop branch, so right now 9.2.beta3 (but in my case, Volker's develop branch).

Users who want versioning, usually are after reproducibility. In that case system packaging is not part of the solution. containers on the other are an ideal tool for that.



---

archive/issue_comments_438837.json:
```json
{
    "body": "I would propose the following installation scheme in `share/` and (via symlink) `share/jupyter/nbextensions/`:\n\n```\n - threejs-sage        (renamed to indicate that it is a fork)\n   - r122/             (subdirectory for the version, replaces meaningless \"build\")\n     - three.min.js\n```",
    "created_at": "2020-11-28T02:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438837",
    "user": "https://github.com/mkoeppe"
}
```

I would propose the following installation scheme in `share/` and (via symlink) `share/jupyter/nbextensions/`:

```
 - threejs-sage        (renamed to indicate that it is a fork)
   - r122/             (subdirectory for the version, replaces meaningless "build")
     - three.min.js
```



---

archive/issue_comments_438838.json:
```json
{
    "body": "I would also propose to store the version of `threejs` that is required by the scripts / templates in `src/sage/ext_data/threejs/` in a text file in that directory.\n\nFrom a packaging point of view it makes no sense to read this from the `version` file that is installed in `THREEJS_DIR`.",
    "created_at": "2020-11-28T03:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438838",
    "user": "https://github.com/mkoeppe"
}
```

I would also propose to store the version of `threejs` that is required by the scripts / templates in `src/sage/ext_data/threejs/` in a text file in that directory.

From a packaging point of view it makes no sense to read this from the `version` file that is installed in `THREEJS_DIR`.



---

archive/issue_comments_438839.json:
```json
{
    "body": "Here's a draft (untested)\n\n---\nLast 10 new commits:",
    "created_at": "2020-11-28T03:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438839",
    "user": "https://github.com/mkoeppe"
}
```

Here's a draft (untested)

---
Last 10 new commits:



---

archive/issue_comments_438840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-28T03:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438840",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438841.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-28T04:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438841",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_438842.json:
```json
{
    "body": "I guess I can accomodate that. I already ship threejs as a sage specific component in `/usr/share/sage`. I have to think if I will allow several versions of threejs on the system at once.",
    "created_at": "2020-11-28T04:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438842",
    "user": "https://github.com/kiwifb"
}
```

I guess I can accomodate that. I already ship threejs as a sage specific component in `/usr/share/sage`. I have to think if I will allow several versions of threejs on the system at once.



---

archive/issue_comments_438843.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-28T05:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438843",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438844.json:
```json
{
    "body": "This version passes the testsuite. Manual testing would be appreciated.",
    "created_at": "2020-11-28T05:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438844",
    "user": "https://github.com/mkoeppe"
}
```

This version passes the testsuite. Manual testing would be appreciated.



---

archive/issue_comments_438845.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> This version passes the testsuite. Manual testing would be appreciated.\n\n\nI had to update the path in `sage.repl.rich_output.backend_ipython.BackendIPythonNotebook.threejs_offline_scripts` similar to what you did for `BackendIPythonCommandline` in order to avoid 404s in jupyter/jupyterlab.\n\nSince I already had the fix locally, I hope you don't mind that I've gone ahead and pushed it and pointed the ticket at it.\n\nRan both `online=True` and `online=False` for the command-line, jupyter, and jupyterlab. I also verified that the CDN fallback works for jupyter and jupyterlab (for the \"Save as HTML\" feature).\n\n---\nNew commits:",
    "created_at": "2020-11-29T02:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438845",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:22 mkoeppe]:
> This version passes the testsuite. Manual testing would be appreciated.


I had to update the path in `sage.repl.rich_output.backend_ipython.BackendIPythonNotebook.threejs_offline_scripts` similar to what you did for `BackendIPythonCommandline` in order to avoid 404s in jupyter/jupyterlab.

Since I already had the fix locally, I hope you don't mind that I've gone ahead and pushed it and pointed the ticket at it.

Ran both `online=True` and `online=False` for the command-line, jupyter, and jupyterlab. I also verified that the CDN fallback works for jupyter and jupyterlab (for the "Save as HTML" feature).

---
New commits:



---

archive/issue_comments_438846.json:
```json
{
    "body": "Thanks for catching and fixing this!",
    "created_at": "2020-11-29T03:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438846",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for catching and fixing this!



---

archive/issue_comments_438847.json:
```json
{
    "body": "If the plan is to start shipping multiple old versions of Three.js with every new Sage release, then I don't much like that idea. If goes against the entire sense of improving software with a new release.\n\nI would rather implement an idea Joshua raised some time ago on a ticket I can't locate: separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template. If that were a separate package it would track the correct version of Three.js by default.\n\nJoshua, can you remember which ticket had your thoughts on this? Are you game to take a crack at implementing this?",
    "created_at": "2020-12-03T00:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438847",
    "user": "https://github.com/paulmasson"
}
```

If the plan is to start shipping multiple old versions of Three.js with every new Sage release, then I don't much like that idea. If goes against the entire sense of improving software with a new release.

I would rather implement an idea Joshua raised some time ago on a ticket I can't locate: separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template. If that were a separate package it would track the correct version of Three.js by default.

Joshua, can you remember which ticket had your thoughts on this? Are you game to take a crack at implementing this?



---

archive/issue_comments_438848.json:
```json
{
    "body": "Replying to [comment:25 paulmasson]:\n> [...] goes against the entire sense of improving software with a new release.\n\n\nHardly. It's just like installing old versions of shared libraries in a system in addition to the current libraries so that old programs can continue to run.",
    "created_at": "2020-12-03T00:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438848",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:25 paulmasson]:
> [...] goes against the entire sense of improving software with a new release.


Hardly. It's just like installing old versions of shared libraries in a system in addition to the current libraries so that old programs can continue to run.



---

archive/issue_comments_438849.json:
```json
{
    "body": "Replying to [comment:25 paulmasson]:\n> separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template.\n\n\nThe problem remains that the Javascript code needs to be accessed by the Jupyter installation (notebook server), whereas the template needs to be accessed by Sage (Python code). These are in general separate installations - as I have explained with the example in the ticket description. So I don't think that this will help unless I misunderstand something there.",
    "created_at": "2020-12-03T00:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438849",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:25 paulmasson]:
> separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template.


The problem remains that the Javascript code needs to be accessed by the Jupyter installation (notebook server), whereas the template needs to be accessed by Sage (Python code). These are in general separate installations - as I have explained with the example in the ticket description. So I don't think that this will help unless I misunderstand something there.



---

archive/issue_comments_438850.json:
```json
{
    "body": "Also, note that this ticket here does not change how many versions of the javascript file are installed by the distribution. It only changes the installation path to include a version number, which solves the problem described in the ticket description.",
    "created_at": "2020-12-03T04:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438850",
    "user": "https://github.com/mkoeppe"
}
```

Also, note that this ticket here does not change how many versions of the javascript file are installed by the distribution. It only changes the installation path to include a version number, which solves the problem described in the ticket description.



---

archive/issue_comments_438851.json:
```json
{
    "body": "Replying to [comment:25 paulmasson]:\n> I would rather implement an idea Joshua raised some time ago on a ticket I can't locate: separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template. If that were a separate package it would track the correct version of Three.js by default.\n> \n> Joshua, can you remember which ticket had your thoughts on this?\n\n\nI believe this was comment:4:ticket:30620 and comment:7:ticket:30620 (\"Three.js: future of examples/js files\").\n\nI don't think it'd solve the present versioning issue, though. We'd just be worrying about providing multiple offline versions of this new package instead.",
    "created_at": "2020-12-03T15:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438851",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:25 paulmasson]:
> I would rather implement an idea Joshua raised some time ago on a ticket I can't locate: separate the Three.js viewer as a stand-alone package and keep all the versioning issues there. All of the dependencies of Sage on Three.js are in the template. If that were a separate package it would track the correct version of Three.js by default.
> 
> Joshua, can you remember which ticket had your thoughts on this?


I believe this was comment:4:ticket:30620 and comment:7:ticket:30620 ("Three.js: future of examples/js files").

I don't think it'd solve the present versioning issue, though. We'd just be worrying about providing multiple offline versions of this new package instead.



---

archive/issue_comments_438852.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-12-04T19:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438852",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_438853.json:
```json
{
    "body": "Needs review. Let's please get this in - it's a prerequisite so that we can write sane instructions on how to run a fully functional [SageMath](SageMath) jupyter kernel in a system jupyter notebook or jupyterlab (#30476) into Sage 9.3",
    "created_at": "2020-12-04T19:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438853",
    "user": "https://github.com/mkoeppe"
}
```

Needs review. Let's please get this in - it's a prerequisite so that we can write sane instructions on how to run a fully functional [SageMath](SageMath) jupyter kernel in a system jupyter notebook or jupyterlab (#30476) into Sage 9.3



---

archive/issue_comments_438854.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438854",
    "user": "https://github.com/mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_438855.json:
```json
{
    "body": "Changing keywords from \"threejs jsmol jupyter\" to \"threejs, jsmol, jupyter, sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438855",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "threejs jsmol jupyter" to "threejs, jsmol, jupyter, sd111".



---

archive/issue_comments_438856.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-05T01:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438856",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438857.json:
```json
{
    "body": "I went ahead and re-tested the branch in the command-line, jupyter, and jupyterlab with both `online=True` and `online=False` and checked that plots saved using the `Save as HTML` feature still function.\n\nI don't know how frowned upon it is to positively review a ticket you're listed as one of the authors of, but since this ticket has been in review for awhile without a bite, I'm going to go ahead and do so. Please feel free to change it back if there is any objection.",
    "created_at": "2021-01-05T01:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438857",
    "user": "https://github.com/jcamp0x2a"
}
```

I went ahead and re-tested the branch in the command-line, jupyter, and jupyterlab with both `online=True` and `online=False` and checked that plots saved using the `Save as HTML` feature still function.

I don't know how frowned upon it is to positively review a ticket you're listed as one of the authors of, but since this ticket has been in review for awhile without a bite, I'm going to go ahead and do so. Please feel free to change it back if there is any objection.



---

archive/issue_comments_438858.json:
```json
{
    "body": "Thanks. I have reviewed the changes that you made on the ticket.",
    "created_at": "2021-01-05T01:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438858",
    "user": "https://github.com/mkoeppe"
}
```

Thanks. I have reviewed the changes that you made on the ticket.



---

archive/issue_comments_438859.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2021-01-05T02:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438859",
    "user": "https://github.com/paulmasson"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_438860.json:
```json
{
    "body": "I strongly object to the two authors reviewing this ticket. I have yet to receive a cogent answer as to why someone would want to run two or more versions of Sage at the same time. This ticket also needs more input from distribution managers, who may not want to support this behavior. There need to be other voices clearly in favor of the direction this ticket moves, a direction I for one do not support.",
    "created_at": "2021-01-05T02:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438860",
    "user": "https://github.com/paulmasson"
}
```

I strongly object to the two authors reviewing this ticket. I have yet to receive a cogent answer as to why someone would want to run two or more versions of Sage at the same time. This ticket also needs more input from distribution managers, who may not want to support this behavior. There need to be other voices clearly in favor of the direction this ticket moves, a direction I for one do not support.



---

archive/issue_comments_438861.json:
```json
{
    "body": "Replying to [comment:37 paulmasson]:\n> I strongly object to the two authors reviewing this ticket. I have yet to receive a cogent answer as to why someone would want to run two or more versions of Sage at the same time. This ticket also needs more input from distribution managers, who may not want to support this behavior. There need to be other voices clearly in favor of the direction this ticket moves, a direction I for one do not support.\n\n\nApologies. I did not realize there were outstanding questions about the use case's validity, of which I can not personally attest. Just saw that it was in review for awhile yet functioning 'correctly' (to ticket's spec).",
    "created_at": "2021-01-05T02:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438861",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:37 paulmasson]:
> I strongly object to the two authors reviewing this ticket. I have yet to receive a cogent answer as to why someone would want to run two or more versions of Sage at the same time. This ticket also needs more input from distribution managers, who may not want to support this behavior. There need to be other voices clearly in favor of the direction this ticket moves, a direction I for one do not support.


Apologies. I did not realize there were outstanding questions about the use case's validity, of which I can not personally attest. Just saw that it was in review for awhile yet functioning 'correctly' (to ticket's spec).



---

archive/issue_comments_438862.json:
```json
{
    "body": "Paul, if you have a specific technical objection to the change that this ticket proposes, it would probably be helpful for the discussion to try to articulate it.",
    "created_at": "2021-01-05T03:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438862",
    "user": "https://github.com/mkoeppe"
}
```

Paul, if you have a specific technical objection to the change that this ticket proposes, it would probably be helpful for the discussion to try to articulate it.



---

archive/issue_comments_438863.json:
```json
{
    "body": "Let's discuss what the ticket changes step by step.\n\n1) renames directories from `threejs` to `threejs-sage` (in share/ and share/jupyter/nbextensions/) to reflect the fact that it is a Sage-specific fork\n\nfor example in this change\n\n```\n-THREEJS_DIR = \"@prefix@/share/threejs\"\n+THREEJS_DIR = \"@prefix@/share/threejs-sage\"\n```\n\nAny concerns or objections to that?",
    "created_at": "2021-01-05T03:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438863",
    "user": "https://github.com/mkoeppe"
}
```

Let's discuss what the ticket changes step by step.

1) renames directories from `threejs` to `threejs-sage` (in share/ and share/jupyter/nbextensions/) to reflect the fact that it is a Sage-specific fork

for example in this change

```
-THREEJS_DIR = "@prefix@/share/threejs"
+THREEJS_DIR = "@prefix@/share/threejs-sage"
```

Any concerns or objections to that?



---

archive/issue_comments_438864.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-01-05T17:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438864",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_438865.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-17T19:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438865",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_events_080873.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-08T19:45:31Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30735#event-80873"
}
```



---

archive/issue_comments_438866.json:
```json
{
    "body": "please rebase",
    "created_at": "2021-06-21T15:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438866",
    "user": "https://github.com/dimpase"
}
```

please rebase



---

archive/issue_comments_438867.json:
```json
{
    "body": "Use cases for having several versions of Sage installed\n\n- install new version & keep old one for code you lack time to adapt\n- stable release for normal use, beta for development work\n- keep several versions around for the sake of bisecting\n  breaking changes\n- bare version and version with many optional packages installed",
    "created_at": "2021-06-21T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438867",
    "user": "https://github.com/slel"
}
```

Use cases for having several versions of Sage installed

- install new version & keep old one for code you lack time to adapt
- stable release for normal use, beta for development work
- keep several versions around for the sake of bisecting
  breaking changes
- bare version and version with many optional packages installed



---

archive/issue_comments_438868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-22T01:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438869.json:
```json
{
    "body": "Replying to [comment:6 paulmasson]:\n> Replying to [comment:5 mkoeppe]:\n> > Replying to [comment:3 paulmasson]:\n> > > Replying to [comment:2 mkoeppe]:\n> > > > That's not a solution because a user may want to use two different Sage versions at the same time.\n\n> > > Why exactly would someone want to do this?\n> > \n> > Users have complex needs.\n\n> Considering that I don't even use Sage, I'll need a better answer than this before devoting more time to this issue. We are not required to support every feature desired by end users. We can simply tell them to run only one kernel at a time. Who is making the decision to support this option?\n\nfor instance one can have two copies of Sage built with different compilers. At least for Sage development purposes it's very normal to have several installations of Sage on a box.",
    "created_at": "2021-06-24T10:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438869",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:6 paulmasson]:
> Replying to [comment:5 mkoeppe]:
> > Replying to [comment:3 paulmasson]:
> > > Replying to [comment:2 mkoeppe]:
> > > > That's not a solution because a user may want to use two different Sage versions at the same time.

> > > Why exactly would someone want to do this?
> > 
> > Users have complex needs.

> Considering that I don't even use Sage, I'll need a better answer than this before devoting more time to this issue. We are not required to support every feature desired by end users. We can simply tell them to run only one kernel at a time. Who is making the decision to support this option?

for instance one can have two copies of Sage built with different compilers. At least for Sage development purposes it's very normal to have several installations of Sage on a box.



---

archive/issue_comments_438870.json:
```json
{
    "body": "How does one test this with, say, jupyterlab installed by Homebrew?",
    "created_at": "2021-06-24T11:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438870",
    "user": "https://github.com/dimpase"
}
```

How does one test this with, say, jupyterlab installed by Homebrew?



---

archive/issue_comments_438871.json:
```json
{
    "body": "Replying to [comment:50 dimpase]:\n> How does one test this with, say, jupyterlab installed by Homebrew?\n\n\nYou would follow the instructions in our manual added in #30476\n(https://doc.sagemath.org/html/en/installation/launching.html#setting-up-sagemath-as-a-jupyter-kernel-in-an-existing-jupyter-notebook-or-jupyterlab-installation)",
    "created_at": "2021-06-24T23:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438871",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:50 dimpase]:
> How does one test this with, say, jupyterlab installed by Homebrew?


You would follow the instructions in our manual added in #30476
(https://doc.sagemath.org/html/en/installation/launching.html#setting-up-sagemath-as-a-jupyter-kernel-in-an-existing-jupyter-notebook-or-jupyterlab-installation)



---

archive/issue_comments_438872.json:
```json
{
    "body": "Unfortunately these instructions are outdated: on macOS I get\n\n```\n% jupyter kernelspec install --user `pwd`/local/share/jupyter/kernels/sagemath                             \nTraceback (most recent call last):\n  File \"/usr/local/Cellar/jupyterlab/3.0.16/libexec/bin/jupyter-kernelspec\", line 33, in <module>\n    sys.exit(load_entry_point('jupyter-client==6.1.12', 'console_scripts', 'jupyter-kernelspec')())\n  File \"/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/traitlets/config/application.py\", line 845, in launch_instance\n    app.start()\n  File \"/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspecapp.py\", line 266, in start\n    return self.subapp.start()\n  File \"/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspecapp.py\", line 132, in start\n    self.kernel_spec_manager.install_kernel_spec(self.sourcedir,\n  File \"/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspec.py\", line 340, in install_kernel_spec\n    shutil.copytree(source_dir, destination)\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/shutil.py\", line 557, in copytree\n    return _copytree(entries=entries, src=src, dst=dst, symlinks=symlinks,\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/shutil.py\", line 513, in _copytree\n    raise Error(errors)\nshutil.Error: [('/Users/dima/sage/local/share/jupyter/kernels/sagemath/doc', '/Users/dima/Library/Jupyter/kernels/sagemath/doc', \"[Errno 2] No such file or directory: '/Users/dima/sage/local/share/jupyter/kernels/sagemath/doc'\")]\n```",
    "created_at": "2021-06-27T19:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438872",
    "user": "https://github.com/dimpase"
}
```

Unfortunately these instructions are outdated: on macOS I get

```
% jupyter kernelspec install --user `pwd`/local/share/jupyter/kernels/sagemath                             
Traceback (most recent call last):
  File "/usr/local/Cellar/jupyterlab/3.0.16/libexec/bin/jupyter-kernelspec", line 33, in <module>
    sys.exit(load_entry_point('jupyter-client==6.1.12', 'console_scripts', 'jupyter-kernelspec')())
  File "/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/traitlets/config/application.py", line 845, in launch_instance
    app.start()
  File "/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspecapp.py", line 266, in start
    return self.subapp.start()
  File "/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspecapp.py", line 132, in start
    self.kernel_spec_manager.install_kernel_spec(self.sourcedir,
  File "/usr/local/Cellar/jupyterlab/3.0.16/libexec/lib/python3.9/site-packages/jupyter_client/kernelspec.py", line 340, in install_kernel_spec
    shutil.copytree(source_dir, destination)
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/shutil.py", line 557, in copytree
    return _copytree(entries=entries, src=src, dst=dst, symlinks=symlinks,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/shutil.py", line 513, in _copytree
    raise Error(errors)
shutil.Error: [('/Users/dima/sage/local/share/jupyter/kernels/sagemath/doc', '/Users/dima/Library/Jupyter/kernels/sagemath/doc', "[Errno 2] No such file or directory: '/Users/dima/sage/local/share/jupyter/kernels/sagemath/doc'")]
```



---

archive/issue_comments_438873.json:
```json
{
    "body": "Looks to me like someone forgot to build the documentation",
    "created_at": "2021-06-27T19:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438873",
    "user": "https://github.com/mkoeppe"
}
```

Looks to me like someone forgot to build the documentation



---

archive/issue_comments_438874.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-27T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438874",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438875.json:
```json
{
    "body": "OK, this works, sorry for noise.",
    "created_at": "2021-06-27T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438875",
    "user": "https://github.com/dimpase"
}
```

OK, this works, sorry for noise.



---

archive/issue_comments_438876.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-06-27T20:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438876",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_438877.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-29T17:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30735#issuecomment-438877",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080874.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-29T17:39:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30735",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30735#event-80874"
}
```
