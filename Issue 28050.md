# Issue 28050: alarm test failure in CombinatorialPolyhedron.f_vector

Issue created by migration from https://trac.sagemath.org/ticket/28287

Original creator: embray

Original creation time: 2019-07-30 09:27:32

CC:  @kliem

Keywords: f_vector, polytopes

Ever since the merging of #26887 I get this one test failure:


```
sage -t --long --warn-long 157.3 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx
**********************************************************************
File "src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx", line 1132, in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector
Failed example:
    try:
        alarm(0.5)
        C.f_vector()
    except:
        print("alarm!")
Expected:
    alarm!
Got:
    (1,
     25,
     300,
     2300,
     12650,
     53130,
     177100,
     480700,
     1081575,
     2042975,
     3268760,
     4457400,
     5200300,
     5200300,
     4457400,
     3268760,
     2042975,
     1081575,
     480700,
     177100,
     53130,
     12650,
     2300,
     300,
     25,
     1)
**********************************************************************
1 item had failures:
   1 of  12 in sage.geometry.polyhedron.combinatorial_polyhedron.base.CombinatorialPolyhedron.f_vector
    [324 tests, 1 failure, 6.49 s]
```


It's a minor issue, but I mark the ticket priority as "critical" as this is likely to affect others as well, and constitutes a regression.  There's no way to guarantee that 0.5 seconds, or any amount of time really, is short enough to trigger the alarm as soon as the test requires (though if nothing else it should be a shorter time).

Although, if as [this comment](https://trac.sagemath.org/ticket/26887#comment:184) states, there is no explicit reason for these tests, I would just remove them.


---

Comment by embray created at 2019-07-30 09:29:32

Also I'll note that, in the process of trying to test this manually, I got bitten by [this issue](https://groups.google.com/d/msg/sage-devel/xjADjJJChtU/jzicLwjAFQAJ) again, which I see now that we never made a ticket for.  I'll go do that now.


---

Comment by embray created at 2019-07-30 09:49:52

In fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.


---

Comment by @kliem created at 2019-07-30 11:01:41

Replying to [comment:3 embray]:
> In fact, although I can get this test to pass at the command prompt by itself, I can't seem to get the copy in the source code to pass when I modify it to lower the alarm() time.  It seems there are results being cached from earlier tests that cause that call to `C.f_vector()` to return almost immediately.

There is nothing being cashed at that point. Also if there was something being cashed or `C.f_vector` would be faster than `alarm`, `alarm` would escape the `try ... except` environment and would cause sage to crash. This didn't seem to be the issue. (Also the specific calculation takes 1.92 s at my machine. As `f_vector` is not parallelized (yet), I doubt that your machine can do it under a second.)

What I think is happening, is that the `alarm` is triggered, but has no effect. For some reason the alarm just vanishes and the procedure keeps on going. This would also explain many patchbot reports, where there is a timeout with this module.

I don't seem to be the only one with this problem: https://patchbot.sagemath.org/log/27973/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-07-25%2015:09:25?short

As a resolution one could either figure out,
- why `alarm` doesn't trigger anything in some cases (I don't think I will be successful with this) or
- we can just delete all the tests including alarm interrupts in `CombinatorialPolyhedron` (as stated in the description of this ticket).

I would prefer the second option, as the first depends on somebody with time and knowledge. We won't have a certificate anymore that the methods in `CombinatorialPolyhedron` can be interrupted, so we have to trust anyone making changes to not break the ability to interrupt.


---

Comment by @kliem created at 2019-07-30 11:11:33

One more example for `alarm` being messed up with `sage -t`:

https://groups.google.com/d/msg/sage-devel/wqnilUCLsT4/4riK4FnhDQAJ

In sage/rings/integer.pyx the alarm interrupts takes much longer than they should take, when using `sage -t`.


---

Comment by @kliem created at 2019-07-30 13:01:05

New commits:


---

Comment by @kliem created at 2019-07-30 13:01:05

Changing status from new to needs_review.


---

Comment by embray created at 2019-08-02 09:07:32

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-08-02 09:07:32

Thanks, I think maybe that's the best for now.  Writing a test like this to work reliably is hard, and unless there's a specific _regression_ to test related to interruptability I don't know that such tests add much value.

If you do want to have one, it has to be a case where it for sure won't return unless interrupted.


---

Comment by vbraun created at 2019-08-04 07:25:33

Resolution: fixed
