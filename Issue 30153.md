# Issue 30153: Update PyPI url and a few others

Issue created by migration from https://trac.sagemath.org/ticket/30390

Original creator: slelievre

Original creation time: 2020-08-19 13:16:30

CC:  slelievre

Keywords: https, pypi, optional packages

This ticket updates the PyPI url in `src/sage/misc/package.py`.

This makes `sage --optional` work properly for PyPI packages.

In passing we update a few more urls.


---

Comment by slelievre created at 2020-08-19 13:20:35

I put component "scripts", please change if needed.
----
New commits:


---

Comment by slelievre created at 2020-08-19 13:20:58

Changing status from new to needs_review.


---

Comment by slelievre created at 2020-08-19 13:21:41

Changing type from enhancement to defect.


---

Comment by slabbe created at 2020-08-19 14:00:05

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-08-19 14:00:05

I can confirm the bug on 9.2.beta9:


```
$ sage -optional
[package]...............................[latest version] ([version])

/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pyx' at https://pypi.python.org/pypi
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pybtex' at https://pypi.python.org/pypi
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='nibabel' at https://pypi.python.org/pypi
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pyflakes' at https://pypi.python.org/pypi
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
...
```


With the branch applied, I still get a problem:


```
$ sage -optional
[package]...............................[latest version] ([version])

/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pyx' at https://pypi.org/project
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pybtex' at https://pypi.org/project
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='nibabel' at https://pypi.org/project
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/package.py:120: UserWarning: failed to fetch the version of pkg='pyflakes' at https://pypi.org/project
  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
...
```



---

Comment by slabbe created at 2020-08-19 14:03:46

Maybe this would improve the warning which get printed:


```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 2b065b8..ef032d7 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -117,7 +117,7 @@ def pip_remote_version(pkg, pypi_url=DEFAULT_PYPI, ignore_URLError=False):
     except URLError:
         if ignore_URLError:
             import warnings
-            warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, pypi_url))
+            warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, url))
             return
         else:
             raise
```



---

Comment by slabbe created at 2020-08-19 14:05:32

Also, it is true that url `https://pypi.org/project/pyflakes/json/` is now broken. That function needs to be updated.


---

Comment by dimpase created at 2020-08-19 14:31:09

could you improve the text about `patches` ? There are no patches to be submitted on trac since, what, 2014?


---

Comment by slelievre created at 2020-08-19 14:59:14

Main task here: fix `DEFAULT_PYPI` url in `src/sage/misc/package.py`.

Sorry I failed at that. Please help me figure it out.

I went for fixing PyPI urls in any file that had them,
and for fixing other urls in those files; maybe that
goes to a different ticket. Feel free to simplify here.

Any further documentation updates are welcome but
in my opinion belong in a separate ticket.


---

Comment by slelievre created at 2020-08-19 15:24:25

Got it.


---

Comment by slelievre created at 2020-08-19 15:26:20

Changing `/pypi` to `/project` in the url after the domain name was wrong.


---

Comment by git created at 2020-08-19 15:27:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-08-19 15:27:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-08-19 18:24:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-08-19 18:33:32

The documentation fixes regarding patch vs branch look good to me.

Please check that the url changes are an improvement, and that `sage --optional` now works with the changed `DEFAULT_PYPI` url used to get the json file for PyPI packages. Ideally, test with some optional packages installed.


---

Comment by slabbe created at 2020-08-20 08:12:31

I have a problem with my current sage installation which can't access to internet. So, I can't properly review this ticket. But the new url seems good in the browser.


---

Comment by dimpase created at 2020-08-20 15:55:32

could you give a full example of a call that did not work before this branch, and is meant to work with it merged?


---

Comment by slabbe created at 2020-08-20 16:11:32

you are right, just updated description of the ticket to answer your question


---

Comment by dimpase created at 2020-08-21 07:25:02

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-21 07:25:02

lgtm


---

Comment by vbraun created at 2020-08-24 22:22:55


```
[dochtml] OSError: /home/release/Sage/src/doc/en/faq/faq-contribute.rst:169: WARNING: Title underline too short.
```



---

Comment by vbraun created at 2020-08-24 22:22:55

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-08-25 06:22:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-25 07:40:03

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2020-08-25 07:40:03

oops. Should be fixed now (docs build, checked)


---

Comment by vbraun created at 2020-08-30 08:39:25

Resolution: fixed
