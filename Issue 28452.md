# Issue 28452: py3: fix doctests with cbc

archive/issues_028452.json:
```json
{
    "body": "The following doctests are failing with py3 and cbc, but not with py2. This is due to a different behavior of `round` called in `get_variable_value`.\n\n```\n\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28689\n\n",
    "created_at": "2019-11-02T12:48:59Z",
    "labels": [
        "component: linear programming",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3: fix doctests with cbc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28452",
    "user": "https://github.com/dcoudert"
}
```
The following doctests are failing with py3 and cbc, but not with py2. This is due to a different behavior of `round` called in `get_variable_value`.

```

```


Issue created by migration from https://trac.sagemath.org/ticket/28689





---

archive/issue_comments_401374.json:
```json
{
    "body": "The proposed solution unifies the behavior with cplex backend.\n----\nNew commits:",
    "created_at": "2019-11-02T12:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401374",
    "user": "https://github.com/dcoudert"
}
```

The proposed solution unifies the behavior with cplex backend.
----
New commits:



---

archive/issue_comments_401375.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-02T12:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401375",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401376.json:
```json
{
    "body": "When I try to install `cbc`, I get an error:\n\n```\nmkdir: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/cbc-2.9.4.p0/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/include/coin: File exists\nmake[5]: *** [install-includecoinHEADERS] Error 1\nmake[5]: *** Waiting for unfinished jobs....\n```\n\nI think it's a race condition. Please try building with `MAKE=\"make -j4\"` (for example) to see if you run into this. For me, this fixes it:\n\n```diff\ndiff --git a/build/pkgs/cbc/spkg-install b/build/pkgs/cbc/spkg-install\nindex 058c488ea7..d1b6446620 100644\n--- a/build/pkgs/cbc/spkg-install\n+++ b/build/pkgs/cbc/spkg-install\n@@ -15,4 +15,4 @@ sed -i -e \"s/clock\\_gettime ()/Grrrrrrrrrrrr\\ ()/g\" Cbc/configure || \\\n sdh_configure --enable-cbc-parallel --enable-parallel \\\n               --enable-gnu-packages --enable-static\n sdh_make\n-sdh_make_install\n+sdh_make_install -j1\n```\n",
    "created_at": "2019-11-02T16:23:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401376",
    "user": "https://github.com/jhpalmieri"
}
```

When I try to install `cbc`, I get an error:

```
mkdir: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/cbc-2.9.4.p0/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/include/coin: File exists
make[5]: *** [install-includecoinHEADERS] Error 1
make[5]: *** Waiting for unfinished jobs....
```

I think it's a race condition. Please try building with `MAKE="make -j4"` (for example) to see if you run into this. For me, this fixes it:

```diff
diff --git a/build/pkgs/cbc/spkg-install b/build/pkgs/cbc/spkg-install
index 058c488ea7..d1b6446620 100644
--- a/build/pkgs/cbc/spkg-install
+++ b/build/pkgs/cbc/spkg-install
@@ -15,4 +15,4 @@ sed -i -e "s/clock\_gettime ()/Grrrrrrrrrrrr\ ()/g" Cbc/configure || \
 sdh_configure --enable-cbc-parallel --enable-parallel \
               --enable-gnu-packages --enable-static
 sdh_make
-sdh_make_install
+sdh_make_install -j1
```




---

archive/issue_comments_401377.json:
```json
{
    "body": "I don't understand what you are asking me to try, and note that I'm using a 5 years old macbook air with a dual core i7 1,7 GHz CPU...",
    "created_at": "2019-11-02T16:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401377",
    "user": "https://github.com/dcoudert"
}
```

I don't understand what you are asking me to try, and note that I'm using a 5 years old macbook air with a dual core i7 1,7 GHz CPU...



---

archive/issue_comments_401378.json:
```json
{
    "body": "Please set `MAKE=\"make -j2\"` and `MAKEFLAGS=\"-j2\"` (since your machine has 2 cores) and try to build `cbc`. I have these variables set to make sure I get a parallel build, and `cbc` fails for me; I'm asking if you see the same behavior. (It may be `MAKEFLAGS` rather than `MAKE` which is causing the problem, but the Sage installation guide suggests using either, so we should support setting either.)\n\nIf you do see this problem, then see if my proposed fix works.\n\nMaybe other reviewers could do the same testing.",
    "created_at": "2019-11-02T16:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401378",
    "user": "https://github.com/jhpalmieri"
}
```

Please set `MAKE="make -j2"` and `MAKEFLAGS="-j2"` (since your machine has 2 cores) and try to build `cbc`. I have these variables set to make sure I get a parallel build, and `cbc` fails for me; I'm asking if you see the same behavior. (It may be `MAKEFLAGS` rather than `MAKE` which is causing the problem, but the Sage installation guide suggests using either, so we should support setting either.)

If you do see this problem, then see if my proposed fix works.

Maybe other reviewers could do the same testing.



---

archive/issue_comments_401379.json:
```json
{
    "body": "I tried with `-j2` and it's working (`./sage -f cbc`). However, with `-j4` it's failing.",
    "created_at": "2019-11-02T19:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401379",
    "user": "https://github.com/dcoudert"
}
```

I tried with `-j2` and it's working (`./sage -f cbc`). However, with `-j4` it's failing.



---

archive/issue_comments_401380.json:
```json
{
    "body": "For me, too.",
    "created_at": "2019-11-02T19:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401380",
    "user": "https://github.com/jhpalmieri"
}
```

For me, too.



---

archive/issue_comments_401381.json:
```json
{
    "body": "feel free to push required changes here (branch in public)",
    "created_at": "2019-11-03T17:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401381",
    "user": "https://github.com/dcoudert"
}
```

feel free to push required changes here (branch in public)



---

archive/issue_comments_401382.json:
```json
{
    "body": "I get a doctest failure:\n\n```\nsage -t --long --warn-long 64.7 src/sage/numerical/backends/gurobi_backend.pyx\n**********************************************************************\nFile \"src/sage/numerical/backends/gurobi_backend.pyx\", line 13, in sage.numerical.backends.gurobi_backend\nFailed example:\n    g.feedback_edge_set(value_only = True, constraint_generation = False)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.numerical.backends.gurobi_backend[1]>\", line 1, in <module>\n        g.feedback_edge_set(value_only = True, constraint_generation = False)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py\", line 1638, in feedback_edge_set\n        value_only=True, solver=solver, verbose=verbose)\n      File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py\", line 1727, in feedback_edge_set\n        return Integer(round(p.solve(objective_only=True, log=verbose)))\n    TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.numerical.backends.gurobi_backend\n    [10 tests, 1 failure, 0.16 s]\n```\n\nI don't know what this has to do with `cbc`, but I get it when it's installed, I don't when it's not.",
    "created_at": "2019-11-03T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401382",
    "user": "https://github.com/jhpalmieri"
}
```

I get a doctest failure:

```
sage -t --long --warn-long 64.7 src/sage/numerical/backends/gurobi_backend.pyx
**********************************************************************
File "src/sage/numerical/backends/gurobi_backend.pyx", line 13, in sage.numerical.backends.gurobi_backend
Failed example:
    g.feedback_edge_set(value_only = True, constraint_generation = False)
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.numerical.backends.gurobi_backend[1]>", line 1, in <module>
        g.feedback_edge_set(value_only = True, constraint_generation = False)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py", line 1638, in feedback_edge_set
        value_only=True, solver=solver, verbose=verbose)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py", line 1727, in feedback_edge_set
        return Integer(round(p.solve(objective_only=True, log=verbose)))
    TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
**********************************************************************
1 item had failures:
   1 of   3 in sage.numerical.backends.gurobi_backend
    [10 tests, 1 failure, 0.16 s]
```

I don't know what this has to do with `cbc`, but I get it when it's installed, I don't when it's not.



---

archive/issue_comments_401383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-03T19:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401383",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-04T17:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401384",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401385.json:
```json
{
    "body": "I don't have gurobi installed, but  I have the same issue with `coin` (with and without this patch).\n\n```\nsage: G = digraphs.DeBruijn(2, 3)\nsage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-1312c6b79adf> in <module>()\n----> 1 G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')\n\n/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)\n   1621             D.allow_loops(False)\n   1622             FAS = D.feedback_edge_set(constraint_generation=constraint_generation,\n-> 1623                                           value_only=value_only, solver=solver, verbose=verbose)\n   1624             if value_only:\n   1625                 return FAS + self.number_of_loops()\n\n/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)\n   1725 \n   1726             if value_only:\n-> 1727                 return Integer(round(p.solve(objective_only=True, log=verbose)))\n   1728             else:\n   1729                 p.solve(log=verbose)\n\nTypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method\nsage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='glpk')\n6\nsage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='cplex')\n6\n```\n\n\nApplying the same receipe than for `cplex` and `gurobi` in method `get_objective_value` fix the issue for me.",
    "created_at": "2019-11-04T17:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401385",
    "user": "https://github.com/dcoudert"
}
```

I don't have gurobi installed, but  I have the same issue with `coin` (with and without this patch).

```
sage: G = digraphs.DeBruijn(2, 3)
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-1312c6b79adf> in <module>()
----> 1 G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')

/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)
   1621             D.allow_loops(False)
   1622             FAS = D.feedback_edge_set(constraint_generation=constraint_generation,
-> 1623                                           value_only=value_only, solver=solver, verbose=verbose)
   1624             if value_only:
   1625                 return FAS + self.number_of_loops()

/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)
   1725 
   1726             if value_only:
-> 1727                 return Integer(round(p.solve(objective_only=True, log=verbose)))
   1728             else:
   1729                 p.solve(log=verbose)

TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='glpk')
6
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='cplex')
6
```


Applying the same receipe than for `cplex` and `gurobi` in method `get_objective_value` fix the issue for me.



---

archive/issue_comments_401386.json:
```json
{
    "body": "I don't have gurobi installed either, by the way.",
    "created_at": "2019-11-04T18:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401386",
    "user": "https://github.com/jhpalmieri"
}
```

I don't have gurobi installed either, by the way.



---

archive/issue_comments_401387.json:
```json
{
    "body": "The corresponding doctest in `gurobi_backend.pyx` is on purpose not restricted to a particular backend. So when you installed `cbc / coin` you highlighted an issue with this solver (it was your default). I have not seen it as I have `cplex` as default solver, and the issue has been fixed for `cplex` and `gurobi` in #27773. It should now be fixed for all solvers.",
    "created_at": "2019-11-04T18:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401387",
    "user": "https://github.com/dcoudert"
}
```

The corresponding doctest in `gurobi_backend.pyx` is on purpose not restricted to a particular backend. So when you installed `cbc / coin` you highlighted an issue with this solver (it was your default). I have not seen it as I have `cplex` as default solver, and the issue has been fixed for `cplex` and `gurobi` in #27773. It should now be fixed for all solvers.



---

archive/issue_comments_401388.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-08T18:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401388",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401389.json:
```json
{
    "body": "Okay, looks good to me.",
    "created_at": "2019-11-08T18:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401389",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, looks good to me.



---

archive/issue_comments_401390.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-14T23:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28452#issuecomment-401390",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_026336.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-11-14T23:19:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28452",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28452#event-26336"
}
```
