# Issue 28452: py3: fix doctests with cbc

Issue created by migration from https://trac.sagemath.org/ticket/28689

Original creator: dcoudert

Original creation time: 2019-11-02 12:48:59

The following doctests are failing with py3 and cbc, but not with py2. This is due to a different behavior of `round` called in `get_variable_value`.

```

```



---

Comment by dcoudert created at 2019-11-02 12:53:57

The proposed solution unifies the behavior with cplex backend.
----
New commits:


---

Comment by dcoudert created at 2019-11-02 12:53:57

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-11-02 16:23:50

When I try to install `cbc`, I get an error:

```
mkdir: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/var/tmp/sage/build/cbc-2.9.4.p0/inst/Users/palmieri/Desktop/Sage_stuff/git/sage/local/include/coin: File exists
make[5]: *** [install-includecoinHEADERS] Error 1
make[5]: *** Waiting for unfinished jobs....
```

I think it's a race condition. Please try building with `MAKE="make -j4"` (for example) to see if you run into this. For me, this fixes it:

```diff
diff --git a/build/pkgs/cbc/spkg-install b/build/pkgs/cbc/spkg-install
index 058c488ea7..d1b6446620 100644
--- a/build/pkgs/cbc/spkg-install
+++ b/build/pkgs/cbc/spkg-install
@@ -15,4 +15,4 @@ sed -i -e "s/clock\_gettime ()/Grrrrrrrrrrrr\ ()/g" Cbc/configure || \
 sdh_configure --enable-cbc-parallel --enable-parallel \
               --enable-gnu-packages --enable-static
 sdh_make
-sdh_make_install
+sdh_make_install -j1
```



---

Comment by dcoudert created at 2019-11-02 16:32:26

I don't understand what you are asking me to try, and note that I'm using a 5 years old macbook air with a dual core i7 1,7 GHz CPU...


---

Comment by jhpalmieri created at 2019-11-02 16:49:35

Please set `MAKE="make -j2"` and `MAKEFLAGS="-j2"` (since your machine has 2 cores) and try to build `cbc`. I have these variables set to make sure I get a parallel build, and `cbc` fails for me; I'm asking if you see the same behavior. (It may be `MAKEFLAGS` rather than `MAKE` which is causing the problem, but the Sage installation guide suggests using either, so we should support setting either.)

If you do see this problem, then see if my proposed fix works.

Maybe other reviewers could do the same testing.


---

Comment by dcoudert created at 2019-11-02 19:34:15

I tried with `-j2` and it's working (`./sage -f cbc`). However, with `-j4` it's failing.


---

Comment by jhpalmieri created at 2019-11-02 19:58:48

For me, too.


---

Comment by dcoudert created at 2019-11-03 17:01:05

feel free to push required changes here (branch in public)


---

Comment by jhpalmieri created at 2019-11-03 19:01:37

I get a doctest failure:

```
sage -t --long --warn-long 64.7 src/sage/numerical/backends/gurobi_backend.pyx
**********************************************************************
File "src/sage/numerical/backends/gurobi_backend.pyx", line 13, in sage.numerical.backends.gurobi_backend
Failed example:
    g.feedback_edge_set(value_only = True, constraint_generation = False)
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.numerical.backends.gurobi_backend[1]>", line 1, in <module>
        g.feedback_edge_set(value_only = True, constraint_generation = False)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py", line 1638, in feedback_edge_set
        value_only=True, solver=solver, verbose=verbose)
      File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py", line 1727, in feedback_edge_set
        return Integer(round(p.solve(objective_only=True, log=verbose)))
    TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
**********************************************************************
1 item had failures:
   1 of   3 in sage.numerical.backends.gurobi_backend
    [10 tests, 1 failure, 0.16 s]
```

I don't know what this has to do with `cbc`, but I get it when it's installed, I don't when it's not.


---

Comment by git created at 2019-11-03 19:02:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-04 17:46:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-11-04 17:48:43

I don't have gurobi installed, but  I have the same issue with `coin` (with and without this patch).

```
sage: G = digraphs.DeBruijn(2, 3)
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-1312c6b79adf> in <module>()
----> 1 G.feedback_edge_set(value_only = True, constraint_generation = False, solver='coin')

/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)
   1621             D.allow_loops(False)
   1622             FAS = D.feedback_edge_set(constraint_generation=constraint_generation,
-> 1623                                           value_only=value_only, solver=solver, verbose=verbose)
   1624             if value_only:
   1625                 return FAS + self.number_of_loops()

/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py in feedback_edge_set(self, constraint_generation, value_only, solver, verbose)
   1725 
   1726             if value_only:
-> 1727                 return Integer(round(p.solve(objective_only=True, log=verbose)))
   1728             else:
   1729                 p.solve(log=verbose)

TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='glpk')
6
sage: G.feedback_edge_set(value_only = True, constraint_generation = False, solver='cplex')
6
```


Applying the same receipe than for `cplex` and `gurobi` in method `get_objective_value` fix the issue for me.


---

Comment by jhpalmieri created at 2019-11-04 18:15:04

I don't have gurobi installed either, by the way.


---

Comment by dcoudert created at 2019-11-04 18:54:32

The corresponding doctest in `gurobi_backend.pyx` is on purpose not restricted to a particular backend. So when you installed `cbc / coin` you highlighted an issue with this solver (it was your default). I have not seen it as I have `cplex` as default solver, and the issue has been fixed for `cplex` and `gurobi` in #27773. It should now be fixed for all solvers.


---

Comment by jhpalmieri created at 2019-11-08 18:34:46

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-11-08 18:34:46

Okay, looks good to me.


---

Comment by vbraun created at 2019-11-14 23:19:20

Resolution: fixed
