# Issue 18996: ecm doesn't build with Xcode 7.0

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2015-09-17 21:15:38

CC:  fbissey zimmerma

As the summary says. [Log file](http://www.math.washington.edu/~palmieri/Sage/ecm-6.4.4.log).


---

Comment by fbissey created at 2015-09-17 22:25:04

Hi Paul,

this is different from the build failure that is currently on the `gmp-ecm` tracker. By the look of things it is something that has been going on for a while but xcode 7.0 made it break. With the previous version of xcode we had this kind of message

```
/bin/sh ../libtool   --mode=compile gcc  -march=corei7 -mtune=corei7-avx -g -O3  -fPIC -c -o mulredc1.lo mulredc1.s
libtool: compile:  gcc -march=corei7 -mtune=corei7-avx -g -O3 -fPIC -c mulredc1.s -o mulredc1.o
/bin/sh ../libtool   --mode=compile gcc  -march=corei7 -mtune=corei7-avx -g -O3  -fPIC -c -o mulredc2.lo mulredc2.s
libtool: compile:  gcc -march=corei7 -mtune=corei7-avx -g -O3 -fPIC -c mulredc2.s -o mulredc2.o
mulredc2.s:40:Alignment too large: 15. assumed.
mulredc2.s:150:Alignment too large: 15. assumed.
/bin/sh ../libtool   --mode=compile gcc  -march=corei7 -mtune=corei7-avx -g -O3  -fPIC -c -o mulredc3.lo mulredc3.s
libtool: compile:  gcc -march=corei7 -mtune=corei7-avx -g -O3 -fPIC -c mulredc3.s -o mulredc3.o
mulredc3.s:40:Alignment too large: 15. assumed.
mulredc3.s:26:Alignment too large: 15. assumed.
```

As can be seen in the log attached to the ticket "it stopped" assuming and decided it was invalid.


---

Comment by zimmerma created at 2015-09-18 06:13:23

I see two ways to solve this issue:

1) the easy way with `--disable-asm-redc`. There should not be too much speed regression (if any).

2) the hard way. Maybe the alignment values should be replaced by something different, or simply removed. If GMP compiles successfully on the same machine, you could copy what GMP does. It seems other people hit the same issue, but I say no definite solution with google.

Paul


---

Comment by jhpalmieri created at 2015-09-18 15:10:24

Replying to [comment:3 zimmerma]:
> I see two ways to solve this issue:
> 
> 1) the easy way with `--disable-asm-redc`. There should not be too much speed regression (if any).

This works for me, or at least the package installs and passes its test suite.


---

Comment by vbraun created at 2015-09-23 21:17:52

Afaik:
* gcc/gas uses byte count on most platforms: `.align 64` 
* llvm/clang use log2: `.align 6`
Looks like xcode 7 now errors out instead of limiting it to `2^15`. Using `.p2align` would be unambiguous (and the latter behavior).


---

Comment by fbissey created at 2015-09-24 02:14:27

Replying to [comment:5 vbraun]:
> Afaik:
> * gcc/gas uses byte count on most platforms: `.align 64` 
> * llvm/clang use log2: `.align 6`
> Looks like xcode 7 now errors out instead of limiting it to `2^15`. Using `.p2align` would be unambiguous (and the latter behavior).

So you suggest to replace `.align 64` by `.p2align 6`? I will have a go at that a little bit later.


---

Comment by jhpalmieri created at 2015-09-24 04:12:17

Replying to [comment:6 fbissey]:
> Replying to [comment:5 vbraun]:
> > Afaik:
> > * gcc/gas uses byte count on most platforms: `.align 64` 
> > * llvm/clang use log2: `.align 6`
> > Looks like xcode 7 now errors out instead of limiting it to `2^15`. Using `.p2align` would be unambiguous (and the latter behavior).
> 
> So you suggest to replace `.align 64` by `.p2align 6`? I will have a go at that a little bit later.

I also had to replace `.align 32,,16` with `.p2align 5,,4`. It builds with those changes. Should the patch only be applied on OS X? On OS X with a new version of Xcode? Always?


---

Comment by fbissey created at 2015-09-24 07:04:29

It should always work - on all x86. Remember that before xcode 7.0 there was already a warning that it wasn't correct so that should take care of the warning in the pre-xcode 7 environment. Another option would be to replace `.align` with `.balign` (and the values wouldn't have to be expressed in power of 2 then).


---

Comment by zimmerma created at 2015-09-24 07:10:37

please submit a patch: I will apply it upstream if it passes all tests.
Paul


---

Comment by vbraun created at 2015-09-24 07:17:43

+1 to applying it unconditionally. There may be platforms where the asm doesn't understand `.p2align` but those are probably rare by now.


---

Comment by jhpalmieri created at 2015-09-24 14:45:35

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2015-09-24 14:45:35

Here is a patch. Paul, for upstream, note that it patches the `.asm` source files to be built, not the `.py` and `.m4` files that autogenerate the source.
----
New commits:


---

Comment by jhpalmieri created at 2015-09-24 17:20:18

By the way, although I produced the patch/branch, I was basically just following the suggestions of others. So probably someone else should be the author, and I can be one of the reviewers. From the point of view of reviewing, I can verify that Sage builds with these changes, but that doesn't mean I understand the changes.


---

Comment by vbraun created at 2015-09-24 18:30:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-25 07:52:48

Resolution: fixed


---

Comment by zimmerma created at 2015-09-25 09:35:25

I wonder why the patch is so long. The asm files are generated automatically. Here is the
patch I applied upstream:

```
--- x86_64/mulredc.m4   (revision 2730)
+++ x86_64/mulredc.m4   (working copy)
`@``@` -30,7 +30,7 `@``@`
 `include(`config.m4')'
 
        TEXT
-.align 64 # Opteron L1 code cache line is 64 bytes long
+.p2align 6 # Opteron L1 code cache line is 64 bytes long
        GLOBL GSYM_PREFIX``''mulredc`'LENGTH
        TYPE(GSYM_PREFIX``_mulredc``_LENGTH,``function'')
 
`@``@` -248,7 +248,7 `@``@`
 # i > 0 passes
 #########################################################################
 
-.align 32,,16
+.p2align 5,,4
 LABEL_SUFFIX(1)
 
 # register values at loop entry: %TP = tmp, %I = i, %YP = y, %MP = m
```

Paul


---

Comment by fbissey created at 2015-09-25 09:53:30

Stupid question! If the assembly files are generated automatically, why are they distributed? Does that mean that `m4` is a requirement for `gmp-ecm`?


---

Comment by zimmerma created at 2015-09-25 11:11:10

good point. Only `mulredc1.asm` needs to be distributed. I've fixed that upstream in revision 2732.
Paul


---

Comment by jhpalmieri created at 2015-09-25 14:57:31

I didn't say it correctly: those files can be autogenerated, but they're not by default. The file `x86_64/README` explains why:

```
mulredc[1..20].asm are size-specific asm functions for mulredc.
These are generated by the Python autogen.py script (old version, still
used for sizes 1 and 2) and the m4 script mulredc.m4 (all other sizes). 
In order to avoid dependency on the Python and m4 packages, this generation 
is not done automatically with the autoconf/automake stuff.
```



---

Comment by zimmerma created at 2015-09-25 15:34:18

sorry I missed that. Thank you John.


---

Comment by leif created at 2016-08-03 03:21:15

Replying to [comment:16 zimmerma]:
> Here is the
> patch I applied upstream:
> {{{
> --- x86_64/mulredc.m4   (revision 2730)
> +++ x86_64/mulredc.m4   (working copy)
> `@``@` -30,7 +30,7 `@``@`
>  `include(`config.m4')'
>  
>         TEXT
> -.align 64 # Opteron L1 code cache line is 64 bytes long
> +.p2align 6 # Opteron L1 code cache line is 64 bytes long
>         GLOBL GSYM_PREFIX``''mulredc`'LENGTH
>         TYPE(GSYM_PREFIX``_mulredc``_LENGTH,``function'')
>  
> `@``@` -248,7 +248,7 `@``@`
>  # i > 0 passes
>  #########################################################################
>  
> -.align 32,,16
> +.p2align 5,,4
>  LABEL_SUFFIX(1)
>  
>  # register values at loop entry: %TP = tmp, %I = i, %YP = y, %MP = m
> }}}

You could have changed the comment as well, as the L1 cache line size is 64 bytes on any (recent) Intel x86_64, too. ;-)


---

Comment by zimmerma created at 2016-08-22 11:32:51

> You could have changed the comment as well, as the L1 cache line size is 64 bytes on any (recent) Intel x86_64, too. ;-)

indeed, I've changed Opteron to x86_64 upstream (revision 2974).

Paul
