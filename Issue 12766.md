# Issue 12766: several spkg's don't install if the .hg repos have been deleted

Issue created by migration from https://trac.sagemath.org/ticket/12938

Original creator: was

Original creation time: 2012-05-10 19:23:55

Assignee: tbd

For security *and* size purposes, some people delete all the .hg repos from
Sage.  This breaks installing precisely four of them: extcode, sage, sage_root, sage_scripts.  This ticket fixes all these.


---

Attachment

apply to the Sage library (in SAGE_ROOT/devel/sage/)


---

Comment by kini created at 2012-05-25 04:15:11

apply to $SAGE_ROOT/data/extcode


---

Attachment

apply to $SAGE_LOCAL/bin


---

Attachment

apply to $SAGE_ROOT


---

Comment by kini created at 2012-05-25 04:26:30

Changing status from new to needs_review.


---

Comment by kini created at 2012-05-25 04:26:30

I guess this should fix everything...


---

Comment by kini created at 2012-05-25 04:26:30

Changing keywords from "" to "sd40.5".


---

Comment by was created at 2012-05-25 18:57:19

I'm testing this on sage.math by build/testing from scratch with the four .hg repos mentioned above deleted.


---

Comment by was created at 2012-05-25 21:01:57

The sage_scripts part fails:

```
gcc version 4.6.3 (GCC) 
****************************************************
./spkg-install: line 24: /scratch/wstein/ref/sage-5.0/local/bin//.hg/hgrc: No such file or directory

```


That this won't work is obvious if you look at spkg-install.


---

Comment by was created at 2012-05-25 21:02:05

Changing status from needs_review to needs_work.


---

Comment by kini created at 2012-05-25 21:41:34

I don't really understand what you did. To make this work you will need to do `sage -sdist` first, then build from that. At what point are the .hg repos deleted?


---

Comment by was created at 2012-05-25 22:28:23

Replying to [comment:6 kini]:
> I don't really understand what you did.

 1. Extra sage-5.0.tar
 2. tar xf something.spkg
 3. Apply your patch(es)
 4. Delete .hg directory
 5. sage -pkg something 
 6. make


---

Comment by kini created at 2012-05-25 22:54:01

OK, so please instead try this:

1. Have a Sage installation
2. Apply my patches (and your patch) to the repos in the installation of Sage
3. Run `sage --sdist`
4. Unpack the resulting `sage-whatever.tar`
5. Go to `spkg/standard`
6. `tar xf` the four SPKGs
7. Delete `.hg` directory
8. `sage -pkg` the four SPKGs
9. `make` in the root of the extracted Sage source distro


---

Comment by kini created at 2012-05-26 02:38:25

Yeah, this needs more work. There is a ton of usage of hg throughout the scripts. Big mess.


---

Comment by ohanar created at 2012-06-18 06:37:09

the extcode spkg should be fixed in #13123.


---

Comment by chapoton created at 2014-03-04 12:43:38

This seems to be a mercurially dead ticket, now that we have switched to git.


---

Comment by chapoton created at 2014-03-04 12:43:38

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2014-03-04 13:20:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-03-04 17:00:46

Resolution: wontfix
