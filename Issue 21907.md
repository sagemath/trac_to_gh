# Issue 21907: simplify the Graphics3d object of polyhedra

Issue created by migration from https://trac.sagemath.org/ticket/22144

Original creator: chapoton

Original creation time: 2017-01-06 14:17:56

CC:  ohanar kcrisman niles vivianepons ams

Currently, every face is in its own IndexFaceSet.

One can use one IndexFaceSet for all the faces together.

This may help simplify the STL or PLY export later.


---

Comment by chapoton created at 2017-01-06 14:18:48

New commits:


---

Comment by chapoton created at 2017-01-06 14:18:48

Changing status from new to needs_review.


---

Comment by git created at 2017-01-06 16:41:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-01-06 16:59:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-07 08:18:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-10 12:33:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-01-10 20:18:44

could you please try

```
sage: P = polytopes.truncated_octahedron()
sage: Q = P.plot().all[-1]
sage: Q.save('machin.stl')
```

it works for me. The second line isolate the IndexFaceSet from other bells and whistles (plot of edges and vertices)

useful: https://threejs.org/editor/


---

Comment by ams created at 2017-01-11 08:59:48

I tried your example.  

For me, the second line still was a `Graphics3DGroup` so no `face_list` attribute that `save(...stl)` uses at this point in its code. So `Q.save('machin.stl')` fails with the error message `'Graphics3dGroup' object has no attribute 'face_list'`.  

However, `P.plot().all[-1].all[i]` will give a `Graphics3D Object` for every appropriate `i` ( here there are 14 faces, so `i in range(14)`). Then we can recover the full list of faces by putting all faces together. 


```
sage: P = polytopes.truncated_octahedron()
sage: Q = P.plot().all[-1].all[:-1]
sage: my_face_list = [face for face_as_IFS in Q for face in face_as_IFS.face_list()] 
```


And then, I can call the `save(....stl')` method on an IndexFaceSet built out from this list.


```
sage: from sage.plot.plot3d.index_face_set import IndexFaceSet
sage: polytope_as_IFS = IndexFaceSet(my_face_list)
sage: polytope_as_IFS.save('machin.stl')
```


It will again fail, but for a different reason - the faces are not triangles. 

[Edit] By the way, I was testing on the develop branch checked out from the github repository.


---

Comment by chapoton created at 2017-01-11 09:01:18

well, of course (but I should have said that), I meant "try with the branch applied"


---

Comment by ams created at 2017-01-11 09:21:51

Replying to [comment:11 chapoton]:
> well, of course (but I should have said that), I meant "try with the branch applied"

Oh, my fault.  

OK, after switching branches it did worked. Coool!!!  

The text file looks fine and I verified that after import to Blender that there were not duplicated vertices and the normals are consistent.


---

Comment by ams created at 2017-01-11 09:43:48

Please, can you explain at what point the truncated octahedron faces are triangulated in this example?   

It seems to me that you do it very early in the workflow, somewhere inside the `plot` call (anyway `P` has not method `triangulate`). But you don't need the triangulated faces for all 3D file formats exports. I agree you need triangular faces for `stl`, and `3ds`, however triangular faces are not required for `obj`.


---

Comment by ams created at 2017-01-11 10:04:29

Blender screenshot showing inconsistent normals on the exported stl.


---

Attachment

Sorry, it seems I overlooked some inconsistently oriented normals on the first test. ![](blender_wrong_normals.png)

You can see after importing the `machin.stl` file generated with your example into Blender that part of the normals is pointing inwards and part is pointing outwards. Of course, it is possible to correct it afterwards, after exporting, but it would be nice to have normals of polyhedrons already consistent when saved to `stl` format.


---

Comment by chapoton created at 2017-01-11 11:04:05

sorry, I was not available this morning, I should be there after lunch

yes, there is an issue about orientation of faces, that needs to be investigated.


---

Comment by git created at 2017-01-11 12:55:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-01-11 12:56:15

could you please try again with the new branch ?


---

Comment by ams created at 2017-01-11 13:54:08

Blender screenshot showing that normals are not yet consistently pointing outwards.


---

Attachment

The export to `stl` still works but the normals are not yet consistent and pointing outwards.

![](blender-still-wrong-normals.png)


---

Comment by chapoton created at 2017-01-11 13:59:03

really ? ...surprising. Did you rebuild sage ? using "sage -br"

When I try this using https://threejs.org/editor/
it seems that all facets are correctly oriented..


---

Comment by ams created at 2017-01-11 14:00:52

Yes, I did rebuild. I will try uploading my model into the website you listed.  

Can you explain how do you test using https://threejs.org/editor/ ? Where do you upload the stl, or do you use directly the faces as lists of vertices ?


---

Comment by ams created at 2017-01-11 14:10:45

Wait, wait, what does it mean to rebuild using `sage -br` ? The way I did the rebuild was


```
$ git pull trac u/chapoton/22144
$ make
}}} 

Should I pass a parameter to `make`, like `--force-something` or `--sage-br` in order to ensure that it recompiles the interesting function ?


---

Comment by chapoton created at 2017-01-11 14:11:12

I upload the stl (using the file menu / import). When facets were wrong, some of them did no appear until one ask (in the geometry panel) to show every triangle with both sides.


---

Comment by chapoton created at 2017-01-11 14:13:01

"sage -br" should be equivalent to "make" here. It does not care about building the doc, which is faster in general. In some sense "sage -br" is like a small-scale "make", that is sufficient very often when you do not switch branch


---

Comment by ams created at 2017-01-11 14:20:38

Blender screenshot of consistent normals pointing outwards.


---

Attachment

Ok, I see now that I was not looking at the good file. I looked at the old version of the `stl`, sorry.  

The version generated with the new code has consistent normals pointing outwards. 

![](blender-consistent-normals.png)

congrats, so how did you got it ?


---

Comment by chapoton created at 2017-01-11 14:22:59

ok, good.

I just reversed the list the vertices when needed. You can look at my latest commit by clicking on the link "commits" besides the name of the branch near the top of this page


---

Comment by ams created at 2017-01-11 14:30:50

Oh, thank you ! Actually, the link (commits) disappear when the site auto-updates with new inputs to the ticket's discussion (at least on this computer). Updating the site in the browser solves this issue.


---

Comment by ams created at 2017-01-11 14:38:33

How do you know that the `facet_equation.A()` is already pointing outwards ? 

(cf. `_init_solid_3d(self, polyhedron)` in the commit f71dba9c48b8dc477d00a6a76397fb3a95bc7619)


---

Comment by chapoton created at 2017-01-11 14:41:50

Well, I assumed that the facet_equations are coming from the defining inequations of the polytope, so must be all coherent.

It was either everybody inwards or everybody outwards, so I tried < 0 and it works.


---

Comment by ams created at 2017-01-11 14:51:01

So you think it will be _always_ everybody outwards ? 

I was also thinking that this method will not translate easily to polyhedra that are not convex polytopes. But I am not even sure whether you can define those in Sage... and anyway, if it is possible to have, let say, a genus 1 polyhedron, it would be a different question and a different ticket.


---

Comment by chapoton created at 2017-01-11 14:58:37

Well, I have not checked this, really, I admit. The idea is that inequalities are always stored as "vector . (?,?,?) + scalar >= 0". So taking the vector part of a facet should give the same normal in a coherent way, unless somebody somewhere has decided to change signs for some strange reason.

I have launched my patchbot to check that no doctest is broken anywhere else in sage.

Maybe you should check that some of the examples in Polyhedron? still plot as expected. In particular for open polyhedra, cones, etc. A priori, there should be no problem, but it's better to check a little bit.


---

Comment by ams created at 2017-01-11 15:05:23

Ok, I'll do that. 

I have one more question, I cannot figure out in the code where do you actually triangulate the polyhedron's faces. I am worried about it because I am interested in both `stl` and `obj` formats for export and in `obj` I prefer to use _quadri_s rather than _tri_s.


---

Comment by chapoton created at 2017-01-11 15:08:58

the chopping into triangles is done in the commit

trac 22144 enhance stl ouput (for polyhedra in particular)

and happens inside the stl string method, so will not affect other file format exports.

you can see the context by clicking on the commit and then enlarging the value of "context" in the little menu "diff options" on the right


---

Comment by chapoton created at 2017-01-11 15:10:43

by the way, the better normals for facets should also have enhanced the obj output..


---

Comment by git created at 2017-01-11 15:28:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ams created at 2017-01-11 16:12:20

I went trough all of the examples in `plot3d?` The plot looked reasonably good. But did you wanted to test the on-screen image or the `stl` export ? 

None of those examples could export to `stl` before (I mean in Sage 7.4), but now, some of them manage to actually export : 
  

```
sage: plot3d(lambda x, y: x^2 + y^2, (-2,2), (-2,2)).save('rho2.stl')
```



```
sage: plot3d(sin(x*y), (x, -pi, pi), (y, -pi, pi)).save('sinxy.stl')
```


and many others.

Those who do not work, have options added (other than `plot_points` or `mesh` or `transformation`), like for example:


```
sage: x,y = var('x,y')
sage: P = plot3d(x+y+sin(x*y), (x,-10,10),(y,-10,10), opacity=0.87, color='blue')
sage: Q = plot3d(x-2*y-cos(x*y),(x,-10,10),(y,-10,10),opacity=0.3,color='red')
sage: (P+Q).save('twoplanes.stl')
```



---

Comment by chapoton created at 2017-01-11 16:18:25

No, I was just meaning to check the displayed plots. Thanks for doing that.

Your job as a reviewer, if you accept it:

- check that all doctests pass (wait for the bot, and run the tests yourself on the modified files)
- check that the doc is good and correctly formatted (should be ok, but you can think of improvements)
- be sure that this is an improvement over the existing situation
- ideally, be sure that there is no better solution to do the same thing (should not apply here)

This should be an easy review, I think. If you have more questions or suggestions, I am all ears. Once you are satisfied, set to positive review and put your name in the reviewer field at top of the page.

I also think one could keep further enhancements to later tickets.


---

Comment by VivianePons created at 2017-01-11 17:52:07

Changing keywords from "" to "days82".


---

Comment by git created at 2017-01-11 18:15:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ams created at 2017-01-11 23:15:22

There is one test 

`$ sage -t src/sage/geometry/polyhedron/plot.py`  

that fails.


```
Failed example:
    proj.polygons
Expected:
    [[2, 0, 1], [3, 0, 1], [3, 0, 2], [3, 1, 2]]
Got:
    [[1, 0, 2], [3, 0, 1], [2, 0, 3], [3, 1, 2]]
```


I looked through the example, and exported the stl in this precise example. It works, and normal are consistent, so maybe you should change the expected result accordingly in the doc.


---

Comment by chapoton created at 2017-01-12 07:33:59

yes, done already


---

Comment by ams created at 2017-01-12 09:34:30

Changing status from needs_review to positive_review.


---

Comment by ams created at 2017-01-12 09:34:30

Good job! All tests passed on my computer and the documentation looks good.


---

Comment by chapoton created at 2017-01-17 16:38:48

a sequel in #22196, to use the much more efficient binary STL format instead


---

Comment by vbraun created at 2017-01-21 21:21:38

Resolution: fixed
