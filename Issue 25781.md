# Issue 25781: Race conditions because of DESTDIR

archive/issues_025781.json:
```json
{
    "body": "CC:  @embray @dimpase @jhpalmieri\n\nUsing a staging directory for package install can introduce race conditions. For example, when installing a Python package, the package is installed first and then the `egg-info` directory is installed. The latter is what `pkg_resources` uses to consider a package \"installed\".\n\nIf the `egg-info` directory is copied to `site-packages` before the actual Python package, then this can happen for example:\n\n```\nInstalling alabaster-0.7.10\nInstalling package alabaster using pip2\nIgnoring indexes: https://pypi.python.org/simple\nProcessing /home/jdemeyer/sage-test/local/var/tmp/sage/build/alabaster-0.7.10/src\n  Running setup.py (path:/tmp/pip-0ac_4C-build/setup.py) egg_info for package from file:///home/jdemeyer/sage-test/local/var/tmp/sage/build/alabaster-0.7.10/src\n    Running command python setup.py egg_info\n    running egg_info\n    creating pip-egg-info/alabaster.egg-info\n    writing pip-egg-info/alabaster.egg-info/PKG-INFO\n    writing top-level names to pip-egg-info/alabaster.egg-info/top_level.txt\n    writing dependency_links to pip-egg-info/alabaster.egg-info/dependency_links.txt\n    writing manifest file 'pip-egg-info/alabaster.egg-info/SOURCES.txt'\n    Traceback (most recent call last):\n      File \"<string>\", line 1, in <module>\n      File \"/tmp/pip-0ac_4C-build/setup.py\", line 37, in <module>\n        'Programming Language :: Python :: 3.4',\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/__init__.py\", line 129, in setup\n        return distutils.core.setup(**attrs)\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/distutils/core.py\", line 151, in setup\n        dist.run_commands()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/distutils/dist.py\", line 953, in run_commands\n        self.run_command(cmd)\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/distutils/dist.py\", line 972, in run_command\n        cmd_obj.run()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py\", line 278, in run\n        self.find_sources()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py\", line 293, in find_sources\n        mm.run()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py\", line 524, in run\n        self.add_defaults()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py\", line 563, in add_defaults\n        rcfiles = list(walk_revctrl())\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/sdist.py\", line 20, in walk_revctrl\n        for item in ep.load()(dirname):\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2405, in load\n        return self.resolve()\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2411, in resolve\n        module = __import__(self.module_name, fromlist=['__name__'], level=0)\n      File \"/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools_scm/__init__.py\", line 9, in <module>\n        from .utils import trace\n    ImportError: No module named utils\n```\n\nWhat you see here is that `setuptools_scm` is used by `pkg_resources` even though the package `setuptools_scm` has not fully been installed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26018\n\n",
    "created_at": "2018-08-07T10:17:58Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Race conditions because of DESTDIR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25781",
    "user": "@jdemeyer"
}
```
CC:  @embray @dimpase @jhpalmieri

Using a staging directory for package install can introduce race conditions. For example, when installing a Python package, the package is installed first and then the `egg-info` directory is installed. The latter is what `pkg_resources` uses to consider a package "installed".

If the `egg-info` directory is copied to `site-packages` before the actual Python package, then this can happen for example:

```
Installing alabaster-0.7.10
Installing package alabaster using pip2
Ignoring indexes: https://pypi.python.org/simple
Processing /home/jdemeyer/sage-test/local/var/tmp/sage/build/alabaster-0.7.10/src
  Running setup.py (path:/tmp/pip-0ac_4C-build/setup.py) egg_info for package from file:///home/jdemeyer/sage-test/local/var/tmp/sage/build/alabaster-0.7.10/src
    Running command python setup.py egg_info
    running egg_info
    creating pip-egg-info/alabaster.egg-info
    writing pip-egg-info/alabaster.egg-info/PKG-INFO
    writing top-level names to pip-egg-info/alabaster.egg-info/top_level.txt
    writing dependency_links to pip-egg-info/alabaster.egg-info/dependency_links.txt
    writing manifest file 'pip-egg-info/alabaster.egg-info/SOURCES.txt'
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/tmp/pip-0ac_4C-build/setup.py", line 37, in <module>
        'Programming Language :: Python :: 3.4',
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/__init__.py", line 129, in setup
        return distutils.core.setup(**attrs)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/distutils/core.py", line 151, in setup
        dist.run_commands()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/distutils/dist.py", line 953, in run_commands
        self.run_command(cmd)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/distutils/dist.py", line 972, in run_command
        cmd_obj.run()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py", line 278, in run
        self.find_sources()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py", line 293, in find_sources
        mm.run()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py", line 524, in run
        self.add_defaults()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/egg_info.py", line 563, in add_defaults
        rcfiles = list(walk_revctrl())
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools/command/sdist.py", line 20, in walk_revctrl
        for item in ep.load()(dirname):
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2405, in load
        return self.resolve()
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2411, in resolve
        module = __import__(self.module_name, fromlist=['__name__'], level=0)
      File "/home/jdemeyer/sage-test/local/lib/python2.7/site-packages/setuptools_scm/__init__.py", line 9, in <module>
        from .utils import trace
    ImportError: No module named utils
```

What you see here is that `setuptools_scm` is used by `pkg_resources` even though the package `setuptools_scm` has not fully been installed.

Issue created by migration from https://trac.sagemath.org/ticket/26018





---

archive/issue_comments_363965.json:
```json
{
    "body": "Very naive fix at least for Python packages:\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 9b90421..eaf271e 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -881,7 +881,7 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     FILE_LIST=\"\"\n     FIRST=1\n     old_IFS=\"$IFS\"; IFS=$'\\n'\n-    for filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n+    for filename in $(find \"$PREFIX\" -type f -o -type l | sort -r); do\n         filename=\"${filename#$PREFIX}\"\n         if [ $FIRST -eq 1 ]; then\n             FILE_LIST=\"\\\"$filename\\\"\"\n```\n",
    "created_at": "2018-08-07T10:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363965",
    "user": "@jdemeyer"
}
```

Very naive fix at least for Python packages:

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 9b90421..eaf271e 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -881,7 +881,7 @@ if [ -d "$SAGE_DESTDIR" ]; then
     FILE_LIST=""
     FIRST=1
     old_IFS="$IFS"; IFS=$'\n'
-    for filename in $(find "$PREFIX" -type f -o -type l | sort); do
+    for filename in $(find "$PREFIX" -type f -o -type l | sort -r); do
         filename="${filename#$PREFIX}"
         if [ $FIRST -eq 1 ]; then
             FILE_LIST="\"$filename\""
```




---

archive/issue_comments_363966.json:
```json
{
    "body": "Thanks for figuring out what was going on there.  Do you know a reliable way to reproduce this?  I wonder why I've never seen it before.",
    "created_at": "2018-08-07T10:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363966",
    "user": "@embray"
}
```

Thanks for figuring out what was going on there.  Do you know a reliable way to reproduce this?  I wonder why I've never seen it before.



---

archive/issue_comments_363967.json:
```json
{
    "body": "Another thing to note: Previously we worked around this kind of race condition by putting a lock around `pip`, so only one package can be pip-installed at a time.  Now we still have that lock, but I think it's not actually necessary (though maybe still worth keeping?) since we in general do not pip-install packages to the same site-packages at the same time (when using DESTDIR).\n\nHowever, similar problems arise if packages can be copied into site-packages by sage-spkg while other python packages are simultaneously being installed.  So maybe we keep the exiting pip lock, but also require sage-spkg to obey it somehow.",
    "created_at": "2018-08-07T10:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363967",
    "user": "@embray"
}
```

Another thing to note: Previously we worked around this kind of race condition by putting a lock around `pip`, so only one package can be pip-installed at a time.  Now we still have that lock, but I think it's not actually necessary (though maybe still worth keeping?) since we in general do not pip-install packages to the same site-packages at the same time (when using DESTDIR).

However, similar problems arise if packages can be copied into site-packages by sage-spkg while other python packages are simultaneously being installed.  So maybe we keep the exiting pip lock, but also require sage-spkg to obey it somehow.



---

archive/issue_comments_363968.json:
```json
{
    "body": "I just had this happen trying to rebuild the Windows patchbot, which broke again, for some reason.\n\nWhile I believe this is a more general problem in principle, it's happening specifically because installing `setuptools_scm` can alter the behavior of pip (in particular, it installs some `setuptools.file_finder` entrypoints).  It's also pulled in as a `setup_requires` from a couple of packages that have it listed as a prerequisite.\n\nThis is relatively unusual, and I think among packages installed by Sage, `setuptools_scm` is probably the only one like this.  So I wonder if we shouldn't just list it as a prerequisite to almost all Python packages, like we currently do with pip.",
    "created_at": "2018-08-14T10:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363968",
    "user": "@embray"
}
```

I just had this happen trying to rebuild the Windows patchbot, which broke again, for some reason.

While I believe this is a more general problem in principle, it's happening specifically because installing `setuptools_scm` can alter the behavior of pip (in particular, it installs some `setuptools.file_finder` entrypoints).  It's also pulled in as a `setup_requires` from a couple of packages that have it listed as a prerequisite.

This is relatively unusual, and I think among packages installed by Sage, `setuptools_scm` is probably the only one like this.  So I wonder if we shouldn't just list it as a prerequisite to almost all Python packages, like we currently do with pip.



---

archive/issue_comments_363969.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-14T10:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363969",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_363970.json:
```json
{
    "body": "Just as one possible idea, what about this?\n\nTechnically, what I called `$(PYTHON_TOOLCHAIN)`, could just be spelled \"setuptools_scm\", since there's already a direct dependency sequence of `setuptools -> pip -> setuptools_scm`.  But I like that having a `PYTHON_TOOLCHAIN` variable makes this relationship to other packages explicit, and can be modified in one place.\n----\nNew commits:",
    "created_at": "2018-08-14T10:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363970",
    "user": "@embray"
}
```

Just as one possible idea, what about this?

Technically, what I called `$(PYTHON_TOOLCHAIN)`, could just be spelled "setuptools_scm", since there's already a direct dependency sequence of `setuptools -> pip -> setuptools_scm`.  But I like that having a `PYTHON_TOOLCHAIN` variable makes this relationship to other packages explicit, and can be modified in one place.
----
New commits:



---

archive/issue_comments_363971.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-14T10:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363971",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363972.json:
```json
{
    "body": "(had to fix one case, `build/pkgs/simplegeneric/dependencies`, where my `sed` call was a little over-aggressive; I should have made it just apply to the first line :)",
    "created_at": "2018-08-14T10:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363972",
    "user": "@embray"
}
```

(had to fix one case, `build/pkgs/simplegeneric/dependencies`, where my `sed` call was a little over-aggressive; I should have made it just apply to the first line :)



---

archive/issue_comments_363973.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> Another thing to note: Previously we worked around this kind of race condition by putting a lock around `pip`, so only one package can be pip-installed at a time.  Now we still have that lock, but I think it's not actually necessary (though maybe still worth keeping?) since we in general do not pip-install packages to the same site-packages at the same time (when using DESTDIR).\n\nGood thinking! The problem is that the part which copies files from `DESTDIR` to the final installation directory is not locked. Adding an exclusive lock there would also mitigate this and maybe also #18438.",
    "created_at": "2018-08-16T08:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363973",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 embray]:
> Another thing to note: Previously we worked around this kind of race condition by putting a lock around `pip`, so only one package can be pip-installed at a time.  Now we still have that lock, but I think it's not actually necessary (though maybe still worth keeping?) since we in general do not pip-install packages to the same site-packages at the same time (when using DESTDIR).

Good thinking! The problem is that the part which copies files from `DESTDIR` to the final installation directory is not locked. Adding an exclusive lock there would also mitigate this and maybe also #18438.



---

archive/issue_comments_363974.json:
```json
{
    "body": "I have in the past considered putting a lock around any kind of writing to `$SAGE_LOCAL`--not for any *specific* reason but it just seemed like it would probably be a good idea.  I had a feeling problems *like* this one would come up less frequently with such a lock.  However, for that to be practical, while still keeping parallel builds reasonably fast, we need as many packages as possible using `DESTDIR` builds.\n\nI can experiment with that, if you think it's a good idea.  In the meantime what do you think about the workaround I attached?  I think it makes a certain amount of sense independently of this issue, but I'm not sure.",
    "created_at": "2018-08-16T11:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363974",
    "user": "@embray"
}
```

I have in the past considered putting a lock around any kind of writing to `$SAGE_LOCAL`--not for any *specific* reason but it just seemed like it would probably be a good idea.  I had a feeling problems *like* this one would come up less frequently with such a lock.  However, for that to be practical, while still keeping parallel builds reasonably fast, we need as many packages as possible using `DESTDIR` builds.

I can experiment with that, if you think it's a good idea.  In the meantime what do you think about the workaround I attached?  I think it makes a certain amount of sense independently of this issue, but I'm not sure.



---

archive/issue_comments_363975.json:
```json
{
    "body": "I don't understand the branch: it looks like `pip` need not be installed before all of the packages that (without the branch) have it as a dependency. In any case, with a Python 3 build, I get\n\n```\nNo record that 'setuptools_scm' was ever installed; skipping uninstall\nInstalling setuptools_scm-1.15.6\nyour setuptools is too old (<12)\nsetuptools_scm functionality is degraded\n/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.4.beta5/local/bin/python3: No module named pip\n```\n\nPerhaps `pip` should not have `$(PYTHON_TOOLCHAIN)` as a dependency.",
    "created_at": "2018-09-20T15:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363975",
    "user": "@jhpalmieri"
}
```

I don't understand the branch: it looks like `pip` need not be installed before all of the packages that (without the branch) have it as a dependency. In any case, with a Python 3 build, I get

```
No record that 'setuptools_scm' was ever installed; skipping uninstall
Installing setuptools_scm-1.15.6
your setuptools is too old (<12)
setuptools_scm functionality is degraded
/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.4.beta5/local/bin/python3: No module named pip
```

Perhaps `pip` should not have `$(PYTHON_TOOLCHAIN)` as a dependency.



---

archive/issue_comments_363976.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-20T16:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363976",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_363977.json:
```json
{
    "body": "Similar error with a Python 2 build. I don't think it's too much to ask for you to actually try your own branch before marking it as \"needs review\". Please do better in the future.",
    "created_at": "2018-09-20T16:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363977",
    "user": "@jhpalmieri"
}
```

Similar error with a Python 2 build. I don't think it's too much to ask for you to actually try your own branch before marking it as "needs review". Please do better in the future.



---

archive/issue_comments_363978.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> Similar error with a Python 2 build. I don't think it's too much to ask for you to actually try your own branch before marking it as \"needs review\". Please do better in the future.\n\nWith respect, this is extremely condescending and unnecessary.  I'm a professional software engineer and you are not my employer or my mentor--you don't have to tell me how to do my job.  Obviously I tested it, being that it's a fairly non-trivial change.  I see what the problem is about pip and I'm not sure why I didn't hit on it, though I only would have if I were fully rebuilding from scratch (I believe, instead, I was doing some `./sage -f` calls that were designed to trigger the race condition).\n\nSage-the-distribution is a very large, complex pile of software, and it's difficult to test all possible scenarios, especially for builds.  I'm not sure what you think the point of \"needs review\" is, if not to provide peer-review, which includes peer-testing.  If you feel your time has been wasted you were also welcome to check the current results of the patchbots (which also show a build failure) and point that out rather than lecturing me needlessly.",
    "created_at": "2018-09-21T12:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363978",
    "user": "@embray"
}
```

Replying to [comment:12 jhpalmieri]:
> Similar error with a Python 2 build. I don't think it's too much to ask for you to actually try your own branch before marking it as "needs review". Please do better in the future.

With respect, this is extremely condescending and unnecessary.  I'm a professional software engineer and you are not my employer or my mentor--you don't have to tell me how to do my job.  Obviously I tested it, being that it's a fairly non-trivial change.  I see what the problem is about pip and I'm not sure why I didn't hit on it, though I only would have if I were fully rebuilding from scratch (I believe, instead, I was doing some `./sage -f` calls that were designed to trigger the race condition).

Sage-the-distribution is a very large, complex pile of software, and it's difficult to test all possible scenarios, especially for builds.  I'm not sure what you think the point of "needs review" is, if not to provide peer-review, which includes peer-testing.  If you feel your time has been wasted you were also welcome to check the current results of the patchbots (which also show a build failure) and point that out rather than lecturing me needlessly.



---

archive/issue_comments_363979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-21T13:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363979",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363980.json:
```json
{
    "body": "Updated to ensure that `$(PYTHON_TOOLCHAIN)` is not used in the dependencies of the `PYTHON_TOOLCHAIN` members themselves.\n\nIIRC (it was several weeks ago) I did do this in the first place, but I think when I ran `sed` over the remaining packages I might have forgotten to exclude `pip` and `setuptools_scm` in particular.\n\nOf course, let's wait and see what my patchbot says.",
    "created_at": "2018-09-21T13:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363980",
    "user": "@embray"
}
```

Updated to ensure that `$(PYTHON_TOOLCHAIN)` is not used in the dependencies of the `PYTHON_TOOLCHAIN` members themselves.

IIRC (it was several weeks ago) I did do this in the first place, but I think when I ran `sed` over the remaining packages I might have forgotten to exclude `pip` and `setuptools_scm` in particular.

Of course, let's wait and see what my patchbot says.



---

archive/issue_comments_363981.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-21T13:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363981",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_363982.json:
```json
{
    "body": "My point is exactly that this is a ticket about building Sage from scratch, so running `make distclean; make` is one of the first things to test, it seems to me.\n\nEdit: let me tone this down a little.\n\nSo here is a serious question: if I think you have not done a good job on this ticket, should I not say anything? I think it's not bad to provide constructive criticism, like saying \"you should have run `make distclean; make` before marking this as `needs_review`.\"",
    "created_at": "2018-09-21T14:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363982",
    "user": "@jhpalmieri"
}
```

My point is exactly that this is a ticket about building Sage from scratch, so running `make distclean; make` is one of the first things to test, it seems to me.

Edit: let me tone this down a little.

So here is a serious question: if I think you have not done a good job on this ticket, should I not say anything? I think it's not bad to provide constructive criticism, like saying "you should have run `make distclean; make` before marking this as `needs_review`."



---

archive/issue_comments_363983.json:
```json
{
    "body": "Let me put this another way. As you have no doubt experienced, in the Sage community there are different styles of reviewers. Some are very thorough, while some will take a glance at the code and say \"looks good to me, positive review\". One can get away with that superficial kind of review some of the time, for example a Python 3 ticket which just replaces some `iteritems` by `items`, but on a ticket like this, it needs thorough testing. I believe that the burden of that thorough testing falls on both the author and the reviewer. In this particular case, the problem gets caught by the patchbots, but that does not always happen.\n\nSo especially on a ticket involving Sage's build process, I think it is important for both the authors and the reviewers to be more careful and thorough than they might otherwise be. It's better to get it right the first time than to merge a ticket with problems and have to put out a bunch of fires later.",
    "created_at": "2018-09-21T16:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363983",
    "user": "@jhpalmieri"
}
```

Let me put this another way. As you have no doubt experienced, in the Sage community there are different styles of reviewers. Some are very thorough, while some will take a glance at the code and say "looks good to me, positive review". One can get away with that superficial kind of review some of the time, for example a Python 3 ticket which just replaces some `iteritems` by `items`, but on a ticket like this, it needs thorough testing. I believe that the burden of that thorough testing falls on both the author and the reviewer. In this particular case, the problem gets caught by the patchbots, but that does not always happen.

So especially on a ticket involving Sage's build process, I think it is important for both the authors and the reviewers to be more careful and thorough than they might otherwise be. It's better to get it right the first time than to merge a ticket with problems and have to put out a bunch of fires later.



---

archive/issue_comments_363984.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> My point is exactly that this is a ticket about building Sage from scratch, so running `make distclean; make` is one of the first things to test, it seems to me.\n\nIt isn't necessarily though.  The issue at hand can occur in any situation where, at the most, the python2 package needs to be rebuilt, as do its dependencies.  A full build from scratch was not necessary to test it--I had found it sufficient for reliably reproducing the problem to do `./sage -f <something>` where I forget exactly what `<something>` was but it was one of python's early dependencies.  Possibly something fast, that wouldn't require a whole lot of other packages to be rebuilt.  Now that I look, it I think it was probably sqlite.\n\n\n> Edit: let me tone this down a little.\n> \n> So here is a serious question: if I think you have not done a good job on this ticket, should I not say anything? I think it's not bad to provide constructive criticism, like saying \"you should have run `make distclean; make` before marking this as `needs_review`.\"\n\nI think that would have been completely fair, though I have mixed feelings about \"before marking this as needs_review\".  What I find insulting is the assumption that I (or anyone, if it were someone else) just didn't test it at all.  It might be a little more reasonable if were something that *obviously* would never have worked at all under *any* circumstances, like having a syntax error in some code such that it would not have even compiled.\n\nEven then there are cases I've seen, both from myself and others, where I had something working fine, but accidentally hit a key in my editor and inserted a stray symbol somewhere just before committing the change.  I almost always review my diff before committing, but something like that can be easy to fix (and of course if I did skip diff review entirely, that's on me).  In fact, as I pointed out, this was in some ways such a case, since I had it \"right\" in the first place but then made a mistake before committing.  I did do a diff review but it was the sort that was easy to glaze over since it was dozens of almost equivalent changes.\n\nBut I don't think anyone should be lectured to about setting a ticket to \"needs review\" if there happens to be a mistake.  That's the whole point of asking for review--it's saying \"I've done everything I can *or have time for* to work on this; please take a look\".",
    "created_at": "2018-09-24T14:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363984",
    "user": "@embray"
}
```

Replying to [comment:16 jhpalmieri]:
> My point is exactly that this is a ticket about building Sage from scratch, so running `make distclean; make` is one of the first things to test, it seems to me.

It isn't necessarily though.  The issue at hand can occur in any situation where, at the most, the python2 package needs to be rebuilt, as do its dependencies.  A full build from scratch was not necessary to test it--I had found it sufficient for reliably reproducing the problem to do `./sage -f <something>` where I forget exactly what `<something>` was but it was one of python's early dependencies.  Possibly something fast, that wouldn't require a whole lot of other packages to be rebuilt.  Now that I look, it I think it was probably sqlite.


> Edit: let me tone this down a little.
> 
> So here is a serious question: if I think you have not done a good job on this ticket, should I not say anything? I think it's not bad to provide constructive criticism, like saying "you should have run `make distclean; make` before marking this as `needs_review`."

I think that would have been completely fair, though I have mixed feelings about "before marking this as needs_review".  What I find insulting is the assumption that I (or anyone, if it were someone else) just didn't test it at all.  It might be a little more reasonable if were something that *obviously* would never have worked at all under *any* circumstances, like having a syntax error in some code such that it would not have even compiled.

Even then there are cases I've seen, both from myself and others, where I had something working fine, but accidentally hit a key in my editor and inserted a stray symbol somewhere just before committing the change.  I almost always review my diff before committing, but something like that can be easy to fix (and of course if I did skip diff review entirely, that's on me).  In fact, as I pointed out, this was in some ways such a case, since I had it "right" in the first place but then made a mistake before committing.  I did do a diff review but it was the sort that was easy to glaze over since it was dozens of almost equivalent changes.

But I don't think anyone should be lectured to about setting a ticket to "needs review" if there happens to be a mistake.  That's the whole point of asking for review--it's saying "I've done everything I can *or have time for* to work on this; please take a look".



---

archive/issue_comments_363985.json:
```json
{
    "body": "Replying to [comment:17 jhpalmieri]:\n> So especially on a ticket involving Sage's build process, I think it is important for both the authors and the reviewers to be more careful and thorough than they might otherwise be. It's better to get it right the first time than to merge a ticket with problems and have to put out a bunch of fires later.\n\nI don't disagree of course.  Part of the problem is that we do not have a QA department to set review policy.  But you will never, ever get everything \"right the first time\" and that's why we have peer review and continuous integration in the first place (and even with those things some things will be wrong and that's OK).\n\nIn the meantime, I think there would be less of a problem here if there were a test policy and review policy for build issues.  Lacking that, you can't point fingers if someone didn't follow a policy that doesn't exist. (Though as I've noted, I don't think it's fair to \"point fingers\" at all on code that is still under review in the first place).\n\nI appreciate your code reviews so I hope you'll keep doing them as they are very valuable; but please don't assume that if something is broken it's not because the contributor was lazy or careless or doesn't know what they're doing.",
    "created_at": "2018-09-24T14:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363985",
    "user": "@embray"
}
```

Replying to [comment:17 jhpalmieri]:
> So especially on a ticket involving Sage's build process, I think it is important for both the authors and the reviewers to be more careful and thorough than they might otherwise be. It's better to get it right the first time than to merge a ticket with problems and have to put out a bunch of fires later.

I don't disagree of course.  Part of the problem is that we do not have a QA department to set review policy.  But you will never, ever get everything "right the first time" and that's why we have peer review and continuous integration in the first place (and even with those things some things will be wrong and that's OK).

In the meantime, I think there would be less of a problem here if there were a test policy and review policy for build issues.  Lacking that, you can't point fingers if someone didn't follow a policy that doesn't exist. (Though as I've noted, I don't think it's fair to "point fingers" at all on code that is still under review in the first place).

I appreciate your code reviews so I hope you'll keep doing them as they are very valuable; but please don't assume that if something is broken it's not because the contributor was lazy or careless or doesn't know what they're doing.



---

archive/issue_comments_363986.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-02T17:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363986",
    "user": "@vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_363987.json:
```json
{
    "body": "Per #26990, the `future` package also inserts itself at a fairly \"low level\" in that it ends up getting imported, once it's installed, by other Python build tools like setuptools and/or pip.  So it should also be included in the list of toolchain packages.",
    "created_at": "2019-01-03T14:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363987",
    "user": "@embray"
}
```

Per #26990, the `future` package also inserts itself at a fairly "low level" in that it ends up getting imported, once it's installed, by other Python build tools like setuptools and/or pip.  So it should also be included in the list of toolchain packages.



---

archive/issue_comments_363988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-03T14:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363988",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363989.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-03T14:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363989",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363990.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-03T17:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363990",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363991.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-03T17:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363991",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_363992.json:
```json
{
    "body": "Rebased on 8.6.beta1, added future to the list of PYTHON_TOOLCHAIN packages and ensured that those packages are installed in order and can't be installed in parallel.  This should still work otherwise.",
    "created_at": "2019-01-03T17:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363992",
    "user": "@embray"
}
```

Rebased on 8.6.beta1, added future to the list of PYTHON_TOOLCHAIN packages and ensured that those packages are installed in order and can't be installed in parallel.  This should still work otherwise.



---

archive/issue_comments_363993.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363993",
    "user": "@embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_363994.json:
```json
{
    "body": "red branch",
    "created_at": "2019-03-01T19:24:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363994",
    "user": "@fchapoton"
}
```

red branch



---

archive/issue_comments_363995.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-01T19:24:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363995",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_363996.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363996",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_363997.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363997",
    "user": "@embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_363998.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363998",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_363999.json:
```json
{
    "body": "I have started to see this race conditions in automatic builds (for which I use high parallelization) now quite regularly. \nFor example https://github.com/mkoeppe/sage/runs/581024663?check_suite_focus=true",
    "created_at": "2020-04-13T00:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-363999",
    "user": "@mkoeppe"
}
```

I have started to see this race conditions in automatic builds (for which I use high parallelization) now quite regularly. 
For example https://github.com/mkoeppe/sage/runs/581024663?check_suite_focus=true



---

archive/issue_comments_364000.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-04-13T00:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364000",
    "user": "@mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_364001.json:
```json
{
    "body": "Rebased to 9.1.rc0.\n----\nNew commits:",
    "created_at": "2020-04-15T02:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364001",
    "user": "@jhpalmieri"
}
```

Rebased to 9.1.rc0.
----
New commits:



---

archive/issue_comments_364002.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-15T02:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364002",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_364003.json:
```json
{
    "body": "Looks good to me, I'll try this out on one of my next GH Action runs",
    "created_at": "2020-04-15T02:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364003",
    "user": "@mkoeppe"
}
```

Looks good to me, I'll try this out on one of my next GH Action runs



---

archive/issue_comments_364004.json:
```json
{
    "body": "By the way, I ran \"git grep pip build/pkgs/*/dependencies\" and similarly searched for \"setuptools\" and \"future\". I think I caught everything that needed changing. There are a few packages (I think notedown and pandoc_attributes are the only ones) with dependencies like\n\n```\n$(PYTHON) $(PYTHON_TOOLCHAIN) | pip nbformat nbconvert six pandoc_attributes\n```\n\nand I left those as is.",
    "created_at": "2020-04-15T02:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364004",
    "user": "@jhpalmieri"
}
```

By the way, I ran "git grep pip build/pkgs/*/dependencies" and similarly searched for "setuptools" and "future". I think I caught everything that needed changing. There are a few packages (I think notedown and pandoc_attributes are the only ones) with dependencies like

```
$(PYTHON) $(PYTHON_TOOLCHAIN) | pip nbformat nbconvert six pandoc_attributes
```

and I left those as is.



---

archive/issue_comments_364005.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-04-15T03:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364005",
    "user": "@mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_364006.json:
```json
{
    "body": "tests run at https://github.com/mkoeppe/sage/actions/runs/78581820",
    "created_at": "2020-04-15T04:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364006",
    "user": "@mkoeppe"
}
```

tests run at https://github.com/mkoeppe/sage/actions/runs/78581820



---

archive/issue_comments_364007.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-15T19:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364007",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364008.json:
```json
{
    "body": "This seems to be working well. Thanks!",
    "created_at": "2020-04-15T19:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364008",
    "user": "@mkoeppe"
}
```

This seems to be working well. Thanks!



---

archive/issue_comments_364009.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-16T22:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364009",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_364010.json:
```json
{
    "body": "As was to be expected, this helped but did not resolve the issue completely. Follow-up: \n\n- #29585 More race conditions with Python package installations because of DESTDIR",
    "created_at": "2020-04-26T02:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25781#issuecomment-364010",
    "user": "@mkoeppe"
}
```

As was to be expected, this helped but did not resolve the issue completely. Follow-up: 

- #29585 More race conditions with Python package installations because of DESTDIR
