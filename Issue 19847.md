# Issue 19847: residue: mathematically wrong output

archive/issues_019847.json:
```json
{
    "body": "CC:  rws cheuberg\n\nThe complex function `f(s) = 1/(1 - 2^(-s))` has poles of residue `1/log(2)` at `s = 2*k*pi*I/log(2)` for all integers `k`.\n\nCurrently sage recognize these poles just at `s=0`:\n\n\n```\nsage: f(s).residue(s==0)\n1/log(2)\nsage: f(s).residue(s==2*pi*I/log(2))\n0\n```\n\n\nIn essence, this happens because the `series`-method does not recognize the pole. The priority is critical because mathematically wrong output is produced.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20084\n\n",
    "created_at": "2016-02-18T21:53:45Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "title": "residue: mathematically wrong output",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19847",
    "user": "behackl"
}
```
CC:  rws cheuberg

The complex function `f(s) = 1/(1 - 2^(-s))` has poles of residue `1/log(2)` at `s = 2*k*pi*I/log(2)` for all integers `k`.

Currently sage recognize these poles just at `s=0`:


```
sage: f(s).residue(s==0)
1/log(2)
sage: f(s).residue(s==2*pi*I/log(2))
0
```


In essence, this happens because the `series`-method does not recognize the pole. The priority is critical because mathematically wrong output is produced.

Issue created by migration from https://trac.sagemath.org/ticket/20084





---

archive/issue_comments_272714.json:
```json
{
    "body": "The most elegant solution would of course be the automatic simplification of expressions like `2^(something/log(2)) --> exp(something)`, such that\n\n```\nsage: 2^(2*pi*I/log(2))\n1\n```\n\n\nHowever, I'm not sure if that can be achieved so easily.\n\nA second suggestion would be something like\n\n```diff\ndiff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\nindex 3a5c864..175bcad 100644\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -4076,7 +4076,7 @@ cdef class Expression(CommutativeRingElement):\n             a = 0\n         if a == infinity:\n             return (-self.subs({x: 1/x}) / x**2).residue(x == 0)\n-        return self.subs({x: x+a}).series(x == 0, 0).coefficient(x, -1)\n+        return self.subs({x: x+a}).canonicalize_radical().series(x == 0, 0).coefficient(x, -1)\n \n     def taylor(self, *args):\n         r\"\"\"\n```\n\nwhere there are several ways to refine this approach: \n\n- introduce an additional keyword that could disable this additional simplification such that performance does not suffer necessarily,\n- only try to simplify for complex arguments of `a`\n\nand so on.\n\nThoughts?",
    "created_at": "2016-02-18T21:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272714",
    "user": "behackl"
}
```

The most elegant solution would of course be the automatic simplification of expressions like `2^(something/log(2)) --> exp(something)`, such that

```
sage: 2^(2*pi*I/log(2))
1
```


However, I'm not sure if that can be achieved so easily.

A second suggestion would be something like

```diff
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index 3a5c864..175bcad 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -4076,7 +4076,7 @@ cdef class Expression(CommutativeRingElement):
             a = 0
         if a == infinity:
             return (-self.subs({x: 1/x}) / x**2).residue(x == 0)
-        return self.subs({x: x+a}).series(x == 0, 0).coefficient(x, -1)
+        return self.subs({x: x+a}).canonicalize_radical().series(x == 0, 0).coefficient(x, -1)
 
     def taylor(self, *args):
         r"""
```

where there are several ways to refine this approach: 

- introduce an additional keyword that could disable this additional simplification such that performance does not suffer necessarily,
- only try to simplify for complex arguments of `a`

and so on.

Thoughts?



---

archive/issue_comments_272715.json:
```json
{
    "body": "This is just the quick workaround from above.\n----\nNew commits:",
    "created_at": "2016-02-18T22:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272715",
    "user": "behackl"
}
```

This is just the quick workaround from above.
----
New commits:



---

archive/issue_comments_272716.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2016-02-18T22:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272716",
    "user": "behackl"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_272717.json:
```json
{
    "body": "Please add an example doctest to illustrate what you're fixing.",
    "created_at": "2016-02-19T02:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272717",
    "user": "was"
}
```

Please add an example doctest to illustrate what you're fixing.



---

archive/issue_comments_272718.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2016-02-19T02:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272718",
    "user": "was"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_272719.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-19T05:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272719",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272720.json:
```json
{
    "body": "Is it ready for review?",
    "created_at": "2016-03-05T06:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272720",
    "user": "rws"
}
```

Is it ready for review?



---

archive/issue_comments_272721.json:
```json
{
    "body": "update from the future:\n\n\n```\nsage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))\n1/log(2)\nsage: version()\n'SageMath version 7.6.beta6, Release Date: 2017-03-03'\n```\n\n\nsome updates in `series` may affect that now it can recognize the pole without having to call `canonicalize_radical()`?",
    "created_at": "2017-04-13T11:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272721",
    "user": "mforets"
}
```

update from the future:


```
sage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))
1/log(2)
sage: version()
'SageMath version 7.6.beta6, Release Date: 2017-03-03'
```


some updates in `series` may affect that now it can recognize the pole without having to call `canonicalize_radical()`?



---

archive/issue_comments_272722.json:
```json
{
    "body": "Yes, I have faint memory of improving something with `series` itself some time ago; thanks for reminding me.\n\nActually, there are more problems with `residue`. Take, for example,\n\n\n```\nsage: (1/sqrt(x^2)).residue(x==0)\n0\nsage: (1/sqrt(x^2)).canonicalize_radical().residue(x==0)\n1\n```\n\n\n(Note that this is, in some sense, a pathological example.)\n\nThe ideal fix in this case (IMHO) would be to throw an error that the residue could not be computed as the \"correct\" branch of the root could not be chosen automatically. I think that just applying `canonicalize_radical` before computing the residue just introduces more grief as the user looses all control over which branch is chosen.\n\nIn any case: the original problem reported with this ticket is solved, so this is probably just wontfix. Other opinions?\n\n\nReplying to [comment:6 mforets]:\n> update from the future:\n> \n> {{{\n> sage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))\n> 1/log(2)\n> sage: version()\n> 'SageMath version 7.6.beta6, Release Date: 2017-03-03'\n> }}}\n> \n> some updates in `series` may affect that now it can recognize the pole without having to call `canonicalize_radical()`?",
    "created_at": "2017-04-13T14:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272722",
    "user": "behackl"
}
```

Yes, I have faint memory of improving something with `series` itself some time ago; thanks for reminding me.

Actually, there are more problems with `residue`. Take, for example,


```
sage: (1/sqrt(x^2)).residue(x==0)
0
sage: (1/sqrt(x^2)).canonicalize_radical().residue(x==0)
1
```


(Note that this is, in some sense, a pathological example.)

The ideal fix in this case (IMHO) would be to throw an error that the residue could not be computed as the "correct" branch of the root could not be chosen automatically. I think that just applying `canonicalize_radical` before computing the residue just introduces more grief as the user looses all control over which branch is chosen.

In any case: the original problem reported with this ticket is solved, so this is probably just wontfix. Other opinions?


Replying to [comment:6 mforets]:
> update from the future:
> 
> {{{
> sage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))
> 1/log(2)
> sage: version()
> 'SageMath version 7.6.beta6, Release Date: 2017-03-03'
> }}}
> 
> some updates in `series` may affect that now it can recognize the pole without having to call `canonicalize_radical()`?



---

archive/issue_comments_272723.json:
```json
{
    "body": "Replying to [comment:7 behackl]:\n> Yes, I have faint memory of improving something with `series` itself some time ago; thanks for reminding me.\n> ...\n> In any case: the original problem reported with this ticket is solved, so this is probably just wontfix. Other opinions?\n\ncool. for what i've been told from other tickets, i suppose this one should should still provide the test (not wontfix): \n\n\n```\nCheck that :trac:`20084` is fixed::\n\n    sage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))\n    1/log(2)\n```\n\n\n> Actually, there are more problems with residue.\n> ...\n> (Note that this is, in some sense, a pathological example.)\n\nyes. one could come up with other examples (e.g. examples involving log(z)). i agree that just applying `canonicalize_radical` is not a good idea for the reason you stated. but is there a simple way to identify these cases without much hurdle? does this belong to `series` method or is sth that can be done at the level of `residue`?",
    "created_at": "2017-04-17T17:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272723",
    "user": "mforets"
}
```

Replying to [comment:7 behackl]:
> Yes, I have faint memory of improving something with `series` itself some time ago; thanks for reminding me.
> ...
> In any case: the original problem reported with this ticket is solved, so this is probably just wontfix. Other opinions?

cool. for what i've been told from other tickets, i suppose this one should should still provide the test (not wontfix): 


```
Check that :trac:`20084` is fixed::

    sage: (1/(1 - 2^-x)).residue(x == 2*pi*I/log(2))
    1/log(2)
```


> Actually, there are more problems with residue.
> ...
> (Note that this is, in some sense, a pathological example.)

yes. one could come up with other examples (e.g. examples involving log(z)). i agree that just applying `canonicalize_radical` is not a good idea for the reason you stated. but is there a simple way to identify these cases without much hurdle? does this belong to `series` method or is sth that can be done at the level of `residue`?



---

archive/issue_comments_272724.json:
```json
{
    "body": "`@`behackl : if you remove the `canonicalize_radical` keeping the test, i can review it! (or the other way round). \n\nwrt handling pathological examples, yes IMO it is a relevant future task, although as pointed out before i cannot help right now, since i'm not visualizing a workaround :/",
    "created_at": "2017-05-05T17:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272724",
    "user": "mforets"
}
```

`@`behackl : if you remove the `canonicalize_radical` keeping the test, i can review it! (or the other way round). 

wrt handling pathological examples, yes IMO it is a relevant future task, although as pointed out before i cannot help right now, since i'm not visualizing a workaround :/



---

archive/issue_comments_272725.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-05-18T19:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272725",
    "user": "chapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_272726.json:
```json
{
    "body": "looks good to me\n----\nNew commits:",
    "created_at": "2017-05-18T19:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272726",
    "user": "chapoton"
}
```

looks good to me
----
New commits:



---

archive/issue_comments_272727.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2017-05-19T06:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272727",
    "user": "chapoton"
}
```

Changing priority from critical to major.



---

archive/issue_comments_272728.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-19T22:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19847#issuecomment-272728",
    "user": "vbraun"
}
```

Resolution: fixed
