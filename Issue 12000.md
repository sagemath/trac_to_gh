# Issue 12000: R doctest starts X11 on OSX

archive/issues_012000.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  @kcrisman @jasongrout @jhpalmieri\n\nKeywords: R r-project graphics OSX X11\n\nJohn Palmeri reports that, with the R package from #12057, this doctest is problematic (line 352):\n\n```\n    sage: s = r.eval('capabilities(\"png\")') # Should be on Linux and Solaris\n```\n\nOn his Mac OS X 10.6.8 box, doctesting this starts up the X server but does not display any actual graphics. This is new: it didn't do this in Sage 4.8.alpha3.\n\nThis does not happen on all OSX machines. The intented R configuration on OSX is without X11 support, and only Aqua capabilities. \n\nIt might be a bug or misconfiguration in the X installation that it opens up even though nobody is draw a window.\n\nThis can be avoided by unsetting `DISPLAY` in the R session, but then R does no longer report png output capabilities:\n\n```\n> Sys.unsetenv(\"DISPLAY\") \n> capabilities(\"png\")\n  png \nFALSE \n> capabilities(\"aqua\")\naqua \nTRUE \n```\n\nIts unclear whether that would really be an issue in Sage.\n\nSomebody with a Mac might want to trace where exactly R starts up the X server. The equivalent of strace on Linux seems to be http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man1/dtruss.1m.html\n\n```\nsage -sh\ndtruss -f R\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12172\n\n",
    "created_at": "2011-12-17T11:31:10Z",
    "labels": [
        "component: doctest coverage",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "R doctest starts X11 on OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12000",
    "user": "https://github.com/vbraun"
}
```
Assignee: mvngu

CC:  @kcrisman @jasongrout @jhpalmieri

Keywords: R r-project graphics OSX X11

John Palmeri reports that, with the R package from #12057, this doctest is problematic (line 352):

```
    sage: s = r.eval('capabilities("png")') # Should be on Linux and Solaris
```

On his Mac OS X 10.6.8 box, doctesting this starts up the X server but does not display any actual graphics. This is new: it didn't do this in Sage 4.8.alpha3.

This does not happen on all OSX machines. The intented R configuration on OSX is without X11 support, and only Aqua capabilities. 

It might be a bug or misconfiguration in the X installation that it opens up even though nobody is draw a window.

This can be avoided by unsetting `DISPLAY` in the R session, but then R does no longer report png output capabilities:

```
> Sys.unsetenv("DISPLAY") 
> capabilities("png")
  png 
FALSE 
> capabilities("aqua")
aqua 
TRUE 
```

Its unclear whether that would really be an issue in Sage.

Somebody with a Mac might want to trace where exactly R starts up the X server. The equivalent of strace on Linux seems to be http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man1/dtruss.1m.html

```
sage -sh
dtruss -f R
```


Issue created by migration from https://trac.sagemath.org/ticket/12172





---

archive/issue_comments_137988.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2011-12-17T11:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137988",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_137989.json:
```json
{
    "body": "When I run \"dtruss -f R\", it exits immediately \u2014 it doesn't enter an interactive mode where I can give it commands. \n\nMeanwhile, we could unconditionally disable X11 on Darwin in spkg-install. I can produce a new spkg if people think this is a reasonable solution.",
    "created_at": "2011-12-17T17:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137989",
    "user": "https://github.com/jhpalmieri"
}
```

When I run "dtruss -f R", it exits immediately â€” it doesn't enter an interactive mode where I can give it commands. 

Meanwhile, we could unconditionally disable X11 on Darwin in spkg-install. I can produce a new spkg if people think this is a reasonable solution.



---

archive/issue_comments_137990.json:
```json
{
    "body": "> Meanwhile, we could unconditionally disable X11 on Darwin in spkg-install. I can produce a new spkg if people think this is a reasonable solution.\nYes, we should only need Aqua on Darwin for R graphics.  We'd need to test this on a few systems - in particular yours! - but I don't see why this should cause trouble.",
    "created_at": "2011-12-17T21:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137990",
    "user": "https://github.com/kcrisman"
}
```

> Meanwhile, we could unconditionally disable X11 on Darwin in spkg-install. I can produce a new spkg if people think this is a reasonable solution.
Yes, we should only need Aqua on Darwin for R graphics.  We'd need to test this on a few systems - in particular yours! - but I don't see why this should cause trouble.



---

archive/issue_comments_137991.json:
```json
{
    "body": "New spkg up, and I've also posted the patch applied to the spkg (for review purposes).",
    "created_at": "2011-12-17T22:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137991",
    "user": "https://github.com/jhpalmieri"
}
```

New spkg up, and I've also posted the patch applied to the spkg (for review purposes).



---

archive/issue_comments_137992.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-12-17T22:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137992",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_137993.json:
```json
{
    "body": "Just to be clear; the R package *can* still pop up a window with graphics, right?  It'd just be an \"aqua\" window, rather than an X window, right?",
    "created_at": "2011-12-17T23:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137993",
    "user": "https://github.com/jasongrout"
}
```

Just to be clear; the R package *can* still pop up a window with graphics, right?  It'd just be an "aqua" window, rather than an X window, right?



---

archive/issue_comments_137994.json:
```json
{
    "body": "If you can tell me commands to pop open a window with graphics, I'll try it out on my OS X box with this new spkg.  (It should work in theory, using \"aqua\" as you say.)",
    "created_at": "2011-12-18T00:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137994",
    "user": "https://github.com/jhpalmieri"
}
```

If you can tell me commands to pop open a window with graphics, I'll try it out on my OS X box with this new spkg.  (It should work in theory, using "aqua" as you say.)



---

archive/issue_comments_137995.json:
```json
{
    "body": "do `sage -R`, and then type `demo(graphics)`.  Hit return a bunch of times and a window should pop up with a bunch of graphics that cycle through it in the demo.  Thanks.",
    "created_at": "2011-12-18T01:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137995",
    "user": "https://github.com/jasongrout"
}
```

do `sage -R`, and then type `demo(graphics)`.  Hit return a bunch of times and a window should pop up with a bunch of graphics that cycle through it in the demo.  Thanks.



---

archive/issue_comments_137996.json:
```json
{
    "body": "Yup, it works (for me, anyway).",
    "created_at": "2011-12-18T02:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137996",
    "user": "https://github.com/jhpalmieri"
}
```

Yup, it works (for me, anyway).



---

archive/issue_comments_137997.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-12-18T13:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137997",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137998.json:
```json
{
    "body": "Please rebase to #12131...",
    "created_at": "2011-12-18T13:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137998",
    "user": "https://github.com/jdemeyer"
}
```

Please rebase to #12131...



---

archive/issue_comments_137999.json:
```json
{
    "body": "Okay, rebased spkg is up, and I've also updated the patch.",
    "created_at": "2011-12-18T17:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-137999",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, rebased spkg is up, and I've also updated the patch.



---

archive/issue_comments_138000.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-12-18T17:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138000",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138001.json:
```json
{
    "body": "for review only",
    "created_at": "2011-12-18T17:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138001",
    "user": "https://github.com/jhpalmieri"
}
```

for review only



---

archive/issue_comments_138002.json:
```json
{
    "body": "Attachment [trac_12172-r-spkg.patch](tarball://root/attachments/some-uuid/ticket12172/trac_12172-r-spkg.patch) by @kcrisman created at 2012-01-24 01:43:16\n\nThe patch looks ok, modulo my usual having to look up shell syntax.  (Trifle annoying that someone forgot to update the version number in the GPL listing, but I'm not going to mess with that since it wasn't done on the upgrade.)\n\nThe problem is that I can't test whether it fixes the problem, really. With Sage 4.8:\n\n```\n$./sage -t devel/sage/sage/interfaces/r.py \nsage -t  \"devel/sage/sage/interfaces/r.py\"                  \n\t [9.7 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 9.7 seconds\n```\n\nEven though I have the offending file!\n\n```\n$ ls /usr/include/X11/\nCallbackI.h\tIntrinsicP.h\tVarargsI.h\tXfuncproto.h\tXthreads.h\nComposite.h\tObject.h\tVendor.h\tXfuncs.h\tXtos.h\nCompositeP.h\tObjectP.h\tVendorP.h\tXlib.h\t\tXtrans\nConstrainP.h\tPM\t\tX.h\t\tXlibConf.h\tXutil.h\nConstraint.h\tPassivGraI.h\tX10.h\t\tXlibint.h\tXw32defs.h\nConvertI.h\tRectObj.h\tXF86keysym.h\tXlocale.h\tXwindows.h\nCore.h\t\tRectObjP.h\tXKBlib.h\tXmd.h\t\tXwinsock.h\nCoreP.h\t\tResConfigP.h\tXWDFile.h\tXmu\t\tap_keysym.h\nCreateI.h\tResourceI.h\tXalloca.h\tXos.h\t\tbitmaps\nDECkeysym.h\tSM\t\tXarch.h\t\tXos_r.h\t\tcursorfont.h\nEventI.h\tSelectionI.h\tXatom.h\t\tXosdefs.h\tdri\nHPkeysym.h\tShell.h\t\tXauth.h\t\tXpoll.h\t\textensions\nHookObjI.h\tShellI.h\tXaw\t\tXprintAppUtil\tfonts\nICE\t\tShellP.h\tXcms.h\t\tXprintUtil\tkeysym.h\nImUtil.h\tStringDefs.h\tXcursor\t\tXproto.h\tkeysymdef.h\nInitialI.h\tSunkeysym.h\tXdefs.h\t\tXprotostr.h\txpm.h\nIntrinsic.h\tThreadsI.h\tXdmcp.h\t\tXregion.h\nIntrinsicI.h\tTranslateI.h\tXft\t\tXresource.h\n```\n\nSo the best I can do is to say that it doesn't seem to break anything...  Well, I'm going to see if I can break graphics by changing to this spkg.  I'll report back momentarily.",
    "created_at": "2012-01-24T01:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138002",
    "user": "https://github.com/kcrisman"
}
```

Attachment [trac_12172-r-spkg.patch](tarball://root/attachments/some-uuid/ticket12172/trac_12172-r-spkg.patch) by @kcrisman created at 2012-01-24 01:43:16

The patch looks ok, modulo my usual having to look up shell syntax.  (Trifle annoying that someone forgot to update the version number in the GPL listing, but I'm not going to mess with that since it wasn't done on the upgrade.)

The problem is that I can't test whether it fixes the problem, really. With Sage 4.8:

```
$./sage -t devel/sage/sage/interfaces/r.py 
sage -t  "devel/sage/sage/interfaces/r.py"                  
	 [9.7 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 9.7 seconds
```

Even though I have the offending file!

```
$ ls /usr/include/X11/
CallbackI.h	IntrinsicP.h	VarargsI.h	Xfuncproto.h	Xthreads.h
Composite.h	Object.h	Vendor.h	Xfuncs.h	Xtos.h
CompositeP.h	ObjectP.h	VendorP.h	Xlib.h		Xtrans
ConstrainP.h	PM		X.h		XlibConf.h	Xutil.h
Constraint.h	PassivGraI.h	X10.h		Xlibint.h	Xw32defs.h
ConvertI.h	RectObj.h	XF86keysym.h	Xlocale.h	Xwindows.h
Core.h		RectObjP.h	XKBlib.h	Xmd.h		Xwinsock.h
CoreP.h		ResConfigP.h	XWDFile.h	Xmu		ap_keysym.h
CreateI.h	ResourceI.h	Xalloca.h	Xos.h		bitmaps
DECkeysym.h	SM		Xarch.h		Xos_r.h		cursorfont.h
EventI.h	SelectionI.h	Xatom.h		Xosdefs.h	dri
HPkeysym.h	Shell.h		Xauth.h		Xpoll.h		extensions
HookObjI.h	ShellI.h	Xaw		XprintAppUtil	fonts
ICE		ShellP.h	Xcms.h		XprintUtil	keysym.h
ImUtil.h	StringDefs.h	Xcursor		Xproto.h	keysymdef.h
InitialI.h	Sunkeysym.h	Xdefs.h		Xprotostr.h	xpm.h
Intrinsic.h	ThreadsI.h	Xdmcp.h		Xregion.h
IntrinsicI.h	TranslateI.h	Xft		Xresource.h
```

So the best I can do is to say that it doesn't seem to break anything...  Well, I'm going to see if I can break graphics by changing to this spkg.  I'll report back momentarily.



---

archive/issue_comments_138003.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-24T02:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138003",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_138004.json:
```json
{
    "body": "Okay, graphics still work fine, as far as I can tell, in all places they should.  We should have disabled this anyway, and I don't know why we didn't figure out that the logic for disabling on Darwin was incorrect.  I'm going to give this positive review.",
    "created_at": "2012-01-24T02:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138004",
    "user": "https://github.com/kcrisman"
}
```

Okay, graphics still work fine, as far as I can tell, in all places they should.  We should have disabled this anyway, and I don't know why we didn't figure out that the logic for disabling on Darwin was incorrect.  I'm going to give this positive review.



---

archive/issue_comments_138005.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-29T11:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12000#issuecomment-138005",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_012041.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-29T11:17:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12000",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12000#event-12041"
}
```
