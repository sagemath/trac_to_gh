# Issue 30598: tox.ini: Test with homebrew llvm

archive/issues_030598.json:
```json
{
    "body": "CC:  dimpase jhpalmieri vdelecroix fbissey\n\nhttps://groups.google.com/d/msg/sage-devel/5lzj9n57oRI/09AtJyUBBQAJ\n\nIssue created by migration from https://trac.sagemath.org/ticket/30835\n\n",
    "created_at": "2020-10-27T16:05:27Z",
    "labels": [
        "porting",
        "major",
        "enhancement"
    ],
    "title": "tox.ini: Test with homebrew llvm",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30598",
    "user": "mkoeppe"
}
```
CC:  dimpase jhpalmieri vdelecroix fbissey

https://groups.google.com/d/msg/sage-devel/5lzj9n57oRI/09AtJyUBBQAJ

Issue created by migration from https://trac.sagemath.org/ticket/30835





---

archive/issue_comments_437110.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437110",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_437111.json:
```json
{
    "body": "Is there a need to distinguish several versions of clang / LLVM on the same system for portability testing purposes?",
    "created_at": "2021-07-09T22:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437111",
    "user": "mkoeppe"
}
```

Is there a need to distinguish several versions of clang / LLVM on the same system for portability testing purposes?



---

archive/issue_comments_437112.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> Is there a need to distinguish several versions of clang / LLVM on the same system for portability testing purposes?\n\nthat's probably too much trouble. There is  a distinction w.r.t. which standard C++ library clang uses, GNU's (libstdc++) or LLVM's (libc++), which is more important.",
    "created_at": "2021-07-10T10:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437112",
    "user": "dimpase"
}
```

Replying to [comment:3 mkoeppe]:
> Is there a need to distinguish several versions of clang / LLVM on the same system for portability testing purposes?

that's probably too much trouble. There is  a distinction w.r.t. which standard C++ library clang uses, GNU's (libstdc++) or LLVM's (libc++), which is more important.



---

archive/issue_comments_437113.json:
```json
{
    "body": "Here's some preliminary distro package information - just guesswork based on reading https://repology.org/project/llvm/versions\n\nHelp with refining it is welcome\n----\nNew commits:",
    "created_at": "2021-07-10T17:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437113",
    "user": "mkoeppe"
}
```

Here's some preliminary distro package information - just guesswork based on reading https://repology.org/project/llvm/versions

Help with refining it is welcome
----
New commits:



---

archive/issue_comments_437114.json:
```json
{
    "body": "What's the Fortran situation with LLVM? Use flang or gfortran?",
    "created_at": "2021-07-10T18:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437114",
    "user": "mkoeppe"
}
```

What's the Fortran situation with LLVM? Use flang or gfortran?



---

archive/issue_comments_437115.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-10T18:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437115",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437116.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-10T19:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437116",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437117.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> What's the Fortran situation with LLVM? Use flang or gfortran?\n\nflang is still not quite ready for prime time\n(I managed to build Sage using flang/clang, but it was not stable)\n\ngfortran is good.",
    "created_at": "2021-07-10T19:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437117",
    "user": "dimpase"
}
```

Replying to [comment:7 mkoeppe]:
> What's the Fortran situation with LLVM? Use flang or gfortran?

flang is still not quite ready for prime time
(I managed to build Sage using flang/clang, but it was not stable)

gfortran is good.



---

archive/issue_comments_437118.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-10T21:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437118",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_437119.json:
```json
{
    "body": "I tried `tox -e local-direct-llvm` on Fedora 32, seems to work.",
    "created_at": "2021-07-13T10:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437119",
    "user": "dimpase"
}
```

I tried `tox -e local-direct-llvm` on Fedora 32, seems to work.



---

archive/issue_comments_437120.json:
```json
{
    "body": "How do I actually run tests in such a local setup (I can't use docker on that machine)",
    "created_at": "2021-07-13T10:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437120",
    "user": "dimpase"
}
```

How do I actually run tests in such a local setup (I can't use docker on that machine)



---

archive/issue_comments_437121.json:
```json
{
    "body": "You can do `tox -e local-direct-llvm -- ptest`, or `tox -e local-direct-llvm -- bash` if you want a shell",
    "created_at": "2021-07-13T16:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437121",
    "user": "mkoeppe"
}
```

You can do `tox -e local-direct-llvm -- ptest`, or `tox -e local-direct-llvm -- bash` if you want a shell



---

archive/issue_comments_437122.json:
```json
{
    "body": "I feel like I've had this happen before: I ran `tox -e local-homebrew-macos-standard-llvm` and by yesterday at 18:13 (according to the timestamp on the file in `logs/pkgs`) it said \"  [networkx-2.5.1] successfully installed.\" Then it sat there with no apparent activity until I hit ctrl-C today at 09:56.",
    "created_at": "2021-07-13T16:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437122",
    "user": "jhpalmieri"
}
```

I feel like I've had this happen before: I ran `tox -e local-homebrew-macos-standard-llvm` and by yesterday at 18:13 (according to the timestamp on the file in `logs/pkgs`) it said "  [networkx-2.5.1] successfully installed." Then it sat there with no apparent activity until I hit ctrl-C today at 09:56.



---

archive/issue_comments_437123.json:
```json
{
    "body": "Prime suspect is `gfan`'s testsuite - see #32088",
    "created_at": "2021-07-13T17:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437123",
    "user": "mkoeppe"
}
```

Prime suspect is `gfan`'s testsuite - see #32088



---

archive/issue_comments_437124.json:
```json
{
    "body": "I reran and `gfan`'s testsuite passed. (I had deleted the old log files, so I don't know if that was the problem the first time.) `pillow` failed to build, though. (This is OS X 11.4.)",
    "created_at": "2021-07-13T20:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437124",
    "user": "jhpalmieri"
}
```

I reran and `gfan`'s testsuite passed. (I had deleted the old log files, so I don't know if that was the problem the first time.) `pillow` failed to build, though. (This is OS X 11.4.)



---

archive/issue_comments_437125.json:
```json
{
    "body": "Attachment [pillow-8.1.2.log](tarball://root/attachments/some-uuid/ticket30835/pillow-8.1.2.log) by jhpalmieri created at 2021-07-13 20:24:15",
    "created_at": "2021-07-13T20:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437125",
    "user": "jhpalmieri"
}
```

Attachment [pillow-8.1.2.log](tarball://root/attachments/some-uuid/ticket30835/pillow-8.1.2.log) by jhpalmieri created at 2021-07-13 20:24:15



---

archive/issue_comments_437126.json:
```json
{
    "body": "Replying to [comment:21 jhpalmieri]:\n> `pillow` failed to build, though. (This is OS X 11.4.)\nI think this is just that some of Apple's system headers can only be compiled with Apple's compiler.",
    "created_at": "2021-07-13T22:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437126",
    "user": "mkoeppe"
}
```

Replying to [comment:21 jhpalmieri]:
> `pillow` failed to build, though. (This is OS X 11.4.)
I think this is just that some of Apple's system headers can only be compiled with Apple's compiler.



---

archive/issue_comments_437127.json:
```json
{
    "body": "[I asked a question like this before](https://trac.sagemath.org/ticket/31567#comment:32), but should there be a `make` target (or similar) that cleans up the `.tox` directory? Or if we are using `tox`, are we just supposed to know what we're doing? Maybe [this](https://stackoverflow.com/questions/59563746/how-to-clean-a-tox-environment-after-running) is relevant.",
    "created_at": "2021-07-13T23:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437127",
    "user": "jhpalmieri"
}
```

[I asked a question like this before](https://trac.sagemath.org/ticket/31567#comment:32), but should there be a `make` target (or similar) that cleans up the `.tox` directory? Or if we are using `tox`, are we just supposed to know what we're doing? Maybe [this](https://stackoverflow.com/questions/59563746/how-to-clean-a-tox-environment-after-running) is relevant.



---

archive/issue_comments_437128.json:
```json
{
    "body": "I think what you want, in addition to just removing the .tox directory, is #31111 (`tox -e local-direct`: Clean up the effects of previous `tox -e local-....`)",
    "created_at": "2021-07-13T23:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437128",
    "user": "mkoeppe"
}
```

I think what you want, in addition to just removing the .tox directory, is #31111 (`tox -e local-direct`: Clean up the effects of previous `tox -e local-....`)



---

archive/issue_comments_437129.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Replying to [comment:21 jhpalmieri]:\n> > `pillow` failed to build, though. (This is OS X 11.4.)\n> I think this is just that some of Apple's system headers can only be compiled with Apple's compiler.\n\nNo, if you just do\n\n```diff\n+++ b/build/pkgs/pillow/spkg-install.in\n@@ -10,7 +10,7 @@ if [ \"$UNAME\" = \"Darwin\" ] ; then\n     # #29019\n     # https://github.com/python-pillow/Pillow/issues/3438#issuecomment-555019284\n     # https://apple.stackexchange.com/questions/372032/usr-include-missing-on-macos-catalina-with-xcode-11/372600#372600\n-    export CPATH=\"$CPATH:`xcrun --show-sdk-path`/usr/include\"\n+    export CFLAGS=\"$CFLAGS -DTARGET_OS_IPHONE=0 -DTARGET_OS_OSX=1 -DTARGET_OS_MACCATALYST=0\"\n fi\n \n if [ \"$CONDA_PREFIX\" != \"\" ]; then\n```\n\nthen Pillow builds with Homebrew's clang (perhaps there is a more intelligent way, including some header?).",
    "created_at": "2021-07-15T10:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437129",
    "user": "dimpase"
}
```

Replying to [comment:22 mkoeppe]:
> Replying to [comment:21 jhpalmieri]:
> > `pillow` failed to build, though. (This is OS X 11.4.)
> I think this is just that some of Apple's system headers can only be compiled with Apple's compiler.

No, if you just do

```diff
+++ b/build/pkgs/pillow/spkg-install.in
@@ -10,7 +10,7 @@ if [ "$UNAME" = "Darwin" ] ; then
     # #29019
     # https://github.com/python-pillow/Pillow/issues/3438#issuecomment-555019284
     # https://apple.stackexchange.com/questions/372032/usr-include-missing-on-macos-catalina-with-xcode-11/372600#372600
-    export CPATH="$CPATH:`xcrun --show-sdk-path`/usr/include"
+    export CFLAGS="$CFLAGS -DTARGET_OS_IPHONE=0 -DTARGET_OS_OSX=1 -DTARGET_OS_MACCATALYST=0"
 fi
 
 if [ "$CONDA_PREFIX" != "" ]; then
```

then Pillow builds with Homebrew's clang (perhaps there is a more intelligent way, including some header?).



---

archive/issue_comments_437130.json:
```json
{
    "body": "with the patch in comment:25, I can build and doctest Sage on Homebrew  llvm/clang/clang++ just fine (modulo few known errors).\n(perpending `/usr/local/opt/llvm/bin` to PATH)",
    "created_at": "2021-07-15T11:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437130",
    "user": "dimpase"
}
```

with the patch in comment:25, I can build and doctest Sage on Homebrew  llvm/clang/clang++ just fine (modulo few known errors).
(perpending `/usr/local/opt/llvm/bin` to PATH)



---

archive/issue_comments_437131.json:
```json
{
    "body": "Upstream report?",
    "created_at": "2021-07-15T16:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437131",
    "user": "mkoeppe"
}
```

Upstream report?



---

archive/issue_comments_437132.json:
```json
{
    "body": "Replying to [comment:27 mkoeppe]:\n> Upstream report?\ndo you have any idea what Pillow is doing in a non-standard way while building Python extensions?\n(after all, everything else builds, and these `TARGET_OS_...` are used in the SDK's `stdio.h` and `stdlib.h`)\n\nPerhaps it's a setuptools bug?",
    "created_at": "2021-07-15T17:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437132",
    "user": "dimpase"
}
```

Replying to [comment:27 mkoeppe]:
> Upstream report?
do you have any idea what Pillow is doing in a non-standard way while building Python extensions?
(after all, everything else builds, and these `TARGET_OS_...` are used in the SDK's `stdio.h` and `stdlib.h`)

Perhaps it's a setuptools bug?



---

archive/issue_comments_437133.json:
```json
{
    "body": "Pillow's setup.py does a lot of \"discovery\", the details are messy. To isolate what is happening here, you could use the `PILLOW_BUILD_EXT` setting from tox.ini that I use for the `macos-nohomebrew` environment",
    "created_at": "2021-07-15T17:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437133",
    "user": "mkoeppe"
}
```

Pillow's setup.py does a lot of "discovery", the details are messy. To isolate what is happening here, you could use the `PILLOW_BUILD_EXT` setting from tox.ini that I use for the `macos-nohomebrew` environment



---

archive/issue_comments_437134.json:
```json
{
    "body": "Replying to [ticket:30835 mkoeppe]:\n> Portability issues (solving them should not be a prerequisite for the present ticket):\n\nLet me emphasize that the scope of this ticket should be to add the test environments, which will facilitate testing and porting. \n\nIt is not within the scope to do all the porting work.",
    "created_at": "2021-07-15T17:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437134",
    "user": "mkoeppe"
}
```

Replying to [ticket:30835 mkoeppe]:
> Portability issues (solving them should not be a prerequisite for the present ticket):

Let me emphasize that the scope of this ticket should be to add the test environments, which will facilitate testing and porting. 

It is not within the scope to do all the porting work.



---

archive/issue_comments_437135.json:
```json
{
    "body": "Replying to [comment:29 mkoeppe]:\n> Pillow's setup.py does a lot of \"discovery\", the details are messy. To isolate what is happening here, you could use the `PILLOW_BUILD_EXT` setting from tox.ini that I use for the `macos-nohomebrew` environment\n\nI am not sure I understand how to \n\"use the `PILLOW_BUILD_EXT` setting from tox.ini\"",
    "created_at": "2021-07-15T18:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437135",
    "user": "dimpase"
}
```

Replying to [comment:29 mkoeppe]:
> Pillow's setup.py does a lot of "discovery", the details are messy. To isolate what is happening here, you could use the `PILLOW_BUILD_EXT` setting from tox.ini that I use for the `macos-nohomebrew` environment

I am not sure I understand how to 
"use the `PILLOW_BUILD_EXT` setting from tox.ini"



---

archive/issue_comments_437136.json:
```json
{
    "body": "If I \n\n```\nexport PILLOW_BUILD_EXT=\"--disable-platform-guessing --disable-jpeg2000 --disable-imagequant --disable-tiff --disable-lcms --disable-webp --disable-webpmux --disable-xcb\"\n```\n\nit cannot find `zlib`. If I remove `--disable-platform-guessing` it fails with \n\n```\nbuilding 'PIL._imagingmath' extension\nclang -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -O2 -g -march=native -g -I/usr/local/Cellar/jpeg/9d/include -I/usr\n/local/Cellar/openjpeg/2.4.0/include/openjpeg-2.4 -I/usr/local/Cellar/libtiff/4.3.0/include -I/Users/dima/sage/local/var/tmp/sage/build/pillow-8.1.2/src -I/usr/local/Cellar/freetype/2.10.4/include/freetype2 -I/usr/local/Cellar/little-cms2\n/2.12/include -I/Users/dima/sage/local/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include -I/usr/local/include -I/usr/local/Cellar/freetype/2.10.4/include -I/Users/dima/sag\ne/local/include -I/usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c src/_imagingmath.c -o build/temp.macosx-11-x86_64-3.9/src/_imagingmath.o\nclang -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -O2 -g -march=native -g -DHAVE_LIBZ -DPILLOW_VERSION=\\\"8.1.2\\\" -I/\nusr/local/Cellar/jpeg/9d/include -I/usr/local/Cellar/openjpeg/2.4.0/include/openjpeg-2.4 -I/usr/local/Cellar/libtiff/4.3.0/include -I/Users/dima/sage/local/var/tmp/sage/build/pillow-8.1.2/src -I/usr/local/Cellar/freetype/2.10.4/include/fr\neetype2 -I/usr/local/Cellar/little-cms2/2.12/include -I/Users/dima/sage/local/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include -I/usr/local/include -I/usr/local/Cellar/fr\neetype/2.10.4/include -I/Users/dima/sage/local/include -I/usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c src/_imaging.c -o build/temp.macosx-11-x86_64-3.9/src/_imaging.o\nIn file included from In file included from src/_imagingft.c:22:\nIn file included from /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9/Python.h:25:\nIn file included from /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdio.h:64:\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/_stdio.h:93:16: warning: pointer is missing a nullability type specifier (_Nonnull, _Nullable, or _Null_unspecified) [-Wnullability\n-completeness]\n        unsigned char   *_base;\n                        ^\n...\nIn file included from /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9/Python.h:25:\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdio.h:220:5: error: 'TARGET_OS_IPHONE' is not defined, evaluates to 0 [-Werror,-Wundef-prefix=TARGET_OS_]\n#if TARGET_OS_IPHONE\n    ^\n...\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdlib.h:181:5: error: 'TARGET_OS_IPHONE' is not defined, evaluates to 0 [-Werror,-Wundef-prefix=TARGET_OS_]\n#if TARGET_OS_IPHONE\n   ^\n```\n",
    "created_at": "2021-07-15T19:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437136",
    "user": "dimpase"
}
```

If I 

```
export PILLOW_BUILD_EXT="--disable-platform-guessing --disable-jpeg2000 --disable-imagequant --disable-tiff --disable-lcms --disable-webp --disable-webpmux --disable-xcb"
```

it cannot find `zlib`. If I remove `--disable-platform-guessing` it fails with 

```
building 'PIL._imagingmath' extension
clang -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -O2 -g -march=native -g -I/usr/local/Cellar/jpeg/9d/include -I/usr
/local/Cellar/openjpeg/2.4.0/include/openjpeg-2.4 -I/usr/local/Cellar/libtiff/4.3.0/include -I/Users/dima/sage/local/var/tmp/sage/build/pillow-8.1.2/src -I/usr/local/Cellar/freetype/2.10.4/include/freetype2 -I/usr/local/Cellar/little-cms2
/2.12/include -I/Users/dima/sage/local/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include -I/usr/local/include -I/usr/local/Cellar/freetype/2.10.4/include -I/Users/dima/sag
e/local/include -I/usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c src/_imagingmath.c -o build/temp.macosx-11-x86_64-3.9/src/_imagingmath.o
clang -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -O2 -g -march=native -g -DHAVE_LIBZ -DPILLOW_VERSION=\"8.1.2\" -I/
usr/local/Cellar/jpeg/9d/include -I/usr/local/Cellar/openjpeg/2.4.0/include/openjpeg-2.4 -I/usr/local/Cellar/libtiff/4.3.0/include -I/Users/dima/sage/local/var/tmp/sage/build/pillow-8.1.2/src -I/usr/local/Cellar/freetype/2.10.4/include/fr
eetype2 -I/usr/local/Cellar/little-cms2/2.12/include -I/Users/dima/sage/local/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include -I/usr/local/include -I/usr/local/Cellar/fr
eetype/2.10.4/include -I/Users/dima/sage/local/include -I/usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c src/_imaging.c -o build/temp.macosx-11-x86_64-3.9/src/_imaging.o
In file included from In file included from src/_imagingft.c:22:
In file included from /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9/Python.h:25:
In file included from /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdio.h:64:
/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/_stdio.h:93:16: warning: pointer is missing a nullability type specifier (_Nonnull, _Nullable, or _Null_unspecified) [-Wnullability
-completeness]
        unsigned char   *_base;
                        ^
...
In file included from /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/include/python3.9/Python.h:25:
/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdio.h:220:5: error: 'TARGET_OS_IPHONE' is not defined, evaluates to 0 [-Werror,-Wundef-prefix=TARGET_OS_]
#if TARGET_OS_IPHONE
    ^
...
/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/stdlib.h:181:5: error: 'TARGET_OS_IPHONE' is not defined, evaluates to 0 [-Werror,-Wundef-prefix=TARGET_OS_]
#if TARGET_OS_IPHONE
   ^
```




---

archive/issue_comments_437137.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-16T10:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437137",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_437138.json:
```json
{
    "body": "OK, let's deal with Homebrew clang on #32207",
    "created_at": "2021-07-16T10:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437138",
    "user": "dimpase"
}
```

OK, let's deal with Homebrew clang on #32207



---

archive/issue_comments_437139.json:
```json
{
    "body": "Thanks",
    "created_at": "2021-07-16T14:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437139",
    "user": "mkoeppe"
}
```

Thanks



---

archive/issue_comments_437140.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30598#issuecomment-437140",
    "user": "vbraun"
}
```

Resolution: fixed
