# Issue 17072: SubHypergraphSearch

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2014-11-08 16:45:39

CC:  jmantysalo dimpase vdelecroix stefan

At long long long long last.

I have been wanting to write this for ages but never really needed it. And one should never implement something unless one needs it.

Here it is. It does what `SubgraphSearch` already does for graphs, but it does it for hypergraphs. The code is just a simple eunmeration of all possibilities, with a couple of cuts. The implementation tries to make this as cheap as possible.

We now have a `IncidenceStructure.isomorphic_substructures_iterator` whose name is similar to the new `Poset.has_isomorphic_subposet`.

Oh, and it does not work if the pattern you try to find had >64 points. It is already very large considering how hard it is to run this code anyway, plus making it work for >64 implied a +50% cost even for small instances on my use case. So I thought it was not worth it.

Right now it handles induced and non-induced hypergraph. Later, in another patch, it can be improved into a way to deal with another definition of "substructure" and compute things like the VC-dimension, in case somebody cares.


---

Comment by ncohen created at 2014-11-08 16:46:39

Changing status from new to needs_review.


---

Comment by git created at 2014-11-08 16:54:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-11-08 17:02:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2014-11-10 19:12:41

Changing component from PLEASE CHANGE to combinatorial designs.


---

Comment by git created at 2014-11-16 10:02:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-11-26 15:23:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-12-25 15:45:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2014-12-25 15:45:38

(it was conflicting with the latest beta)


---

Comment by ncohen created at 2015-02-24 14:43:50

Guys ?... This feature is really cool, I swear. Plus you probably will not find it anywhere else..


---

Comment by dimpase created at 2015-02-25 09:36:23

Do you iterate over embeddings of H in G, factoring out the automorphisms of H?
(i.e. if f is an automorphism of H, and g an embedding of H, do  distinguish g(H) and g(H^f) ?)


---

Comment by ncohen created at 2015-02-25 09:38:07

No, this code does not. It enumerates all labelled copies, and the number of copies of H that you will find in H is `|aut(H)|`.


---

Comment by dimpase created at 2015-02-25 10:05:58

Replying to [comment:12 ncohen]:
> No, this code does not. It enumerates all labelled copies, and the number of copies of H that you will find in H is `|aut(H)|`.

it should say `distinct` copies, or even `distinct (unlabelled)` copies.


---

Comment by dimpase created at 2015-02-25 10:41:32

The stuff should be tested on a 32-bit system, just to make sure there is no arch-specific bugs...


---

Comment by ncohen created at 2015-02-25 10:43:34

> The stuff should be tested on a 32-bit system, just to make sure there is no arch-specific bugs...

Well, you can if you have one but I tried to be careful with respect to that and explicitly wrote `uint64_t` when I needed a 64-bits integer. Usually the 'int' variables that I use represent the vertex of a hypergraph, so I do not think that it will overflow anytime soon `:-P`


---

Comment by dimpase created at 2015-02-25 10:45:14

Trying out the patch, I get

```
Error building the documentation.
Traceback (most recent call last):
  File "/home/dima/software/sage/src/doc/common/builder.py", line 1623, in <module>
    getattr(get_builder(name), type)()
  File "/home/dima/software/sage/src/doc/common/builder.py", line 296, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/home/dima/software/sage/src/doc/common/builder.py", line 503, in _wrapper
    x.get(99999)
  File "/home/dima/software/sage/local/lib/python/multiprocessing/pool.py", line 558, in get
    raise self._value
OSError: [combinat ] /home/dima/software/sage/local/lib/python2.7/site-packages/sage/combinat/designs/__init__.py:docstring of sage.combinat.designs.__init__:32: WARNING: undefined label: sage.combinat.designs.subhypergraph_search (if the link has no caption the label must precede a section header)

make: *** [doc-html] Error 1

```



---

Comment by git created at 2015-02-25 10:51:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-02-25 10:53:05

That's because the documentation of the combinat/ folder now work in a different way from the rest of Sage's doc. It is meant to be distributed with no central index of files, and I had forgotten to add my new file to the new index of files it creates.

I also changed 'disjoint' into 'distinct unlabelled', and rebased everything on the latest beta.

Nathann


---

Comment by dimpase created at 2015-02-25 10:53:38


```
+ As the automorphism group of `C_5` has size 10, the number of distinct
+ labelled copies is 12. 
```


it should say `unlabelled`


---

Comment by git created at 2015-02-25 10:54:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-02-25 11:53:23

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2015-02-25 11:53:23

Replying to [comment:15 ncohen]:
> > The stuff should be tested on a 32-bit system, just to make sure there is no arch-specific bugs...
> 
> Well, you can if you have one but I tried to be careful with respect to that and explicitly wrote `uint64_t` when I needed a 64-bits integer. Usually the 'int' variables that I use represent the vertex of a hypergraph, so I do not think that it will overflow anytime soon `:-P`

OK, it works both on 64 and 32 bit (arando is still alive).
LGTM.


---

Comment by ncohen created at 2015-02-25 12:05:57

Wow ! Thank you very much.

Nathann


---

Comment by vbraun created at 2015-02-25 23:31:26

I got this on OSX:

```
sage -t --long src/sage/combinat/designs/incidence_structures.py
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 586, in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
Failed example:
    sum(1 for _ in IP.isomorphic_substructures_iterator(IC))
Expected:
    120
Got:
    0
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 598, in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
Failed example:
    sum(1 for _ in IP.isomorphic_substructures_iterator(IC,induced=True))
Expected:
    120
Got:
    0
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 606, in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
Failed example:
    sum(1 for _ in IP.isomorphic_substructures_iterator(IC))
Expected:
    420
Got:
    0
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 608, in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
Failed example:
    sum(1 for _ in IP.isomorphic_substructures_iterator(IC,induced=True))
Expected:
    60
Got:
    0
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 615, in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
Failed example:
    sum(1 for _ in H.isomorphic_substructures_iterator(H))
Expected:
    5616
Got:
    1
**********************************************************************
1 item had failures:
   5 of  16 in sage.combinat.designs.incidence_structures.IncidenceStructure.isomorphic_substructures_iterator
    [287 tests, 5 failures, 2.07 s]
```

Just as a stab in the dark, this is often a sign of comparisons by memory location somewhere. Somehow many Python objects end in different orders in ram on OSX.


---

Comment by vbraun created at 2015-02-26 07:11:18

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2015-02-26 07:40:06

Can you give me access to an OSX machine ? I can't debug in the dark.

Nathann


---

Comment by dimpase created at 2015-02-26 09:22:14

Replying to [comment:25 ncohen]:
> Can you give me access to an OSX machine ? I can't debug in the dark.

If you can't find an OSX machine around, I can hook up a spare laptop running OSX so that you can ssh into it.Hopefully this will be fast enough. Do you still have access to arando box? Anyhow, you will need to ssh into arando, and from it to the laptop.
I'll have to figure out how to make ssh from laptop persistent.

Dima


---

Comment by ncohen created at 2015-02-26 09:59:19

Hello,

> If you can't find an OSX machine around, I can hook up a spare laptop running OSX so that you can ssh into it.Hopefully this will be fast enough. Do you still have access to arando box? Anyhow, you will need to ssh into arando, and from it to the laptop.

I just tried again the instructions you gave me on the 13/06/13 to connect to arando, but I got the following (on boxen):


```
ncohen`@`boxen:~$ ssh -p21925 localhost
ssh: connect to host localhost port 21925: Connection refused
```


A colleague of mine who has a Mac laptop "may" come in the afternoon. And if she is willing I "could" take it from her for a while, and compile Sage from its sources and stuff.

But really it would be cool if the same machine that Volker uses for his tests could be used for debugging, because really it is very very troublesome to get some code to work on an architecture that I do not have access to.

Nathann


---

Comment by vbraun created at 2015-02-26 18:18:09

I can give you access, just email me your ssh key. The box is not always on, so let me know when you need it.


---

Comment by dimpase created at 2015-02-26 18:21:19

Replying to [comment:28 vbraun]:
> I can give you access, just email me your ssh key. The box is not always on, so let me know when you need it.

I think we're all set, Nathann uses an OSX laptop I hooked up via arando. At least it's not under any other load.


---

Comment by ncohen created at 2015-02-26 20:53:02

I have spent severa hours on this bug, and all I can say right now is that after a call to qsort, what is sorted on my machine is not sorted on the OSX machine.


---

Comment by vbraun created at 2015-02-26 21:09:44

Sounds like your comparison function is not a total order. This is illegal, and qsort behavior will be undefined (and different depending on the algorithm used by qsort, its often not quick sort but depends on the size of the input etc.).


---

Comment by dimpase created at 2015-02-26 21:27:16


```
  The comparison function must return an integer less than, equal to, or greater than zero if the first
     argument is considered to be respectively less than, equal to, or greater than the second.
```


and you return `True/False`!


---

Comment by git created at 2015-02-27 07:48:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-02-27 07:49:41

> and you return `True/False`!

That was it. The function returned 1 or 0, and Linux seemed to do the job alright with that. Mac OS X did not.

Nathann


---

Comment by ncohen created at 2015-02-27 07:50:21

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-02-28 21:24:16

Resolution: fixed
