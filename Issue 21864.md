# Issue 21864: giac testsuite fails

Issue created by migration from https://trac.sagemath.org/ticket/22101

Original creator: vbraun

Original creation time: 2016-12-26 18:48:29

CC:  frederichan fbissey jpflori tmonteil

This is on 32-bit: 

```
2424[giac-1.2.2.103]   ***   bug in PARI/GP (Segmentation Fault), please report.  
2425[giac-1.2.2.103] 79,1202c79,88
[...]
3549[giac-1.2.2.103] < 
3550[giac-1.2.2.103] ---
3551[giac-1.2.2.103] > [[-1]],
3552[giac-1.2.2.103] > [[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],
3553[giac-1.2.2.103] > [matrix[[0,1,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,1],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[1,0,0,0,0],[0,1,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,1,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,1],[0,0,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[1,0,0,0,0],[0,1,0,0,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,1,0,0,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,1,0]],matrix[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,1]]],
3554[giac-1.2.2.103] > [1,1,1,1,1,1,1,1,1,1,1,1,1],
3555[giac-1.2.2.103] > matrix[[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[0,1,0,1,1]],
3556[giac-1.2.2.103] > poly1[2,0,a+3],
3557[giac-1.2.2.103] > [1,1,0,0,0,0,1],
3558[giac-1.2.2.103] > [0],
3559[giac-1.2.2.103] > [1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],
3560[giac-1.2.2.103] > []
3561[giac-1.2.2.103] FAIL: chk_fhan1
[...]
5481[giac-1.2.2.103] ====================
5482[giac-1.2.2.103] 1 of 30 tests failed
5483[giac-1.2.2.103] ====================
```



---

Comment by frederichan created at 2017-01-08 16:30:30

(Feel free to add me in CC for tracs about giac or giacpy)

I was able to reproduce the problem with giac 1.2.2.103 on a debian 8.6 i686.
But updating to latest (stable )upstream release seems to fix the problem.

So I will build a branch like this.


---

Comment by frederichan created at 2017-01-09 23:23:03

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-01-11 08:52:06

I might review this (which is mostly testing on various systems). Feel free to remind me if I haven't done that in the next 10 days.


---

Comment by jdemeyer created at 2017-01-25 09:29:15

I first need to look at #22159, which also involves giac.


---

Comment by git created at 2017-02-07 15:15:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2017-02-07 15:19:52

Changing status from needs_review to needs_work.


---

Comment by frederichan created at 2017-02-08 09:25:53

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-02-13 09:46:17

The upgrade looks simple enough.
Could someone test it on a 32 bit system?
I fear we also have problems on non-x86_64 systems...
See #22280


---

Comment by tscrim created at 2017-02-13 15:33:08

I would punt it to the buildbots, where there is a 32 bit machine IIRC, by setting a positive review.


---

Comment by jdemeyer created at 2017-02-16 08:53:46

giac ships with an ancient version of `config.guess` (timestamp: 2008-01-23, not kidding!).

Please apply a fix similar to #19714 such that it will at least try to build on recent systems.


---

Comment by jdemeyer created at 2017-02-16 08:53:46

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-02-16 09:02:23

Something else: in `spkg-src`, where does the download link `http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source/giac$SOURCEORIG.tar.gz` come from? I don't see that documented anywhere on the official giac site. The only links to sources on
https://www-fourier.ujf-grenoble.fr/~parisse/giac_compile.html
that I can find point to
https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_stable.tgz
and
https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_unstable.tgz
(which strangely do NOT contain version numbers!)

Am I missing something?


---

Comment by jdemeyer created at 2017-02-16 09:05:23

Replying to [comment:13 jdemeyer]:
> giac ships with an ancient version of `config.guess` (timestamp: 2008-01-23, not kidding!).

Note that there are 2 versions of `config.guess` in the sources:

```
-rwxr-xr-x 1 jdemeyer jdemeyer 44826 Feb  7 11:25 config.guess
-rwxr-xr-x 1 jdemeyer jdemeyer 44892 Oct  7  2008 config/config.guess
```

The one which is used is `config/config.guess`.


---

Comment by jdemeyer created at 2017-02-16 09:57:39

With an updated `config.guess`, this _builds_ on ppc64le but it gives a Segmentation fault when computing `1+1`:

```
$ giac 
// Maximum number of parallel threads 192
// Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
// Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
// Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
Help file /home/jdemeyer/sage-git/local/share/giac/doc/en/aide_cas not found
Added 26 synonyms
Welcome to giac readline interface
(c) 2001,2016 B. Parisse & others
Homepage http://www-fourier.ujf-grenoble.fr/~parisse/giac.html
Released under the GPL license 3.0 or above
See http://www.gnu.org for license details
May contain BSD licensed software parts (lapack, atlas, tinymt)
-------------------------------------------------
Press CTRL and D simultaneously to finish session
Type ?commandname for help
0>> 1+1
Segmentation fault
```



---

Comment by fbissey created at 2017-02-16 10:17:36

Replying to [comment:16 jdemeyer]:
> With an updated `config.guess`, this _builds_ on ppc64le but it gives a Segmentation fault when computing `1+1`:
> {{{
> $ giac 
> // Maximum number of parallel threads 192
> // Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
> // Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
> // Giac share root-directory:/home/jdemeyer/sage-git/local/share/giac/
> Help file /home/jdemeyer/sage-git/local/share/giac/doc/en/aide_cas not found
> Added 26 synonyms
> Welcome to giac readline interface
> (c) 2001,2016 B. Parisse & others
> Homepage http://www-fourier.ujf-grenoble.fr/~parisse/giac.html
> Released under the GPL license 3.0 or above
> See http://www.gnu.org for license details
> May contain BSD licensed software parts (lapack, atlas, tinymt)
> -------------------------------------------------
> Press CTRL and D simultaneously to finish session
> Type ?commandname for help
> 0>> 1+1
> Segmentation fault
> }}}
I don't get that on power7

```
// Maximum number of parallel threads 64
// Giac share root-directory:/shared/work_no_backup/ppc64-prefix/usr/share/giac/
// Giac share root-directory:/shared/work_no_backup/ppc64-prefix/usr/share/giac/
// Unable to find keyword file /shared/work_no_backup/ppc64-prefix/usr/share/giac/doc/en/keywords
// Giac share root-directory:/shared/work_no_backup/ppc64-prefix/usr/share/giac/
Help file /shared/work_no_backup/ppc64-prefix/usr/share/giac/doc/en/aide_cas not found
Added 0 synonyms
Welcome to giac readline interface
(c) 2001,2016 B. Parisse & others
Homepage http://www-fourier.ujf-grenoble.fr/~parisse/giac.html
Released under the GPL license 3.0 or above
See http://www.gnu.org for license details
May contain BSD licensed software parts (lapack, atlas, tinymt)
-------------------------------------------------
Press CTRL and D simultaneously to finish session
Type ?commandname for help
0>> 1+1
NULL(1,1)
// Time 0
```

Does the test suite passes for you (#22280)?


---

Comment by jdemeyer created at 2017-02-16 10:51:08

Replying to [comment:17 fbissey]:
> Does the test suite passes for you (#22280)?

Given that even `1+1` segfaults, I did not state the obvious fact that the test suite also fails miserably.


---

Comment by fbissey created at 2017-02-17 00:52:52

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 fbissey]:
> > Does the test suite passes for you (#22280)?
> 
> Given that even `1+1` segfaults, I did not state the obvious fact that the test suite also fails miserably.

Yes, completely silly of me - even if I was juggling several things at the time of the remark. Do you think it is related to `pari` or something different? Have you been able to narrow it down from a backtrace?


---

Comment by jdemeyer created at 2017-02-17 08:34:21

Replying to [comment:19 fbissey]:
> Do you think it is related to `pari` or something different? Have you been able to narrow it down from a backtrace?


I have not investigated yet.


---

Comment by frederichan created at 2017-02-18 08:39:39

Replying to [comment:14 jdemeyer]:
> Something else: in `spkg-src`, where does the download link `http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source/giac$SOURCEORIG.tar.gz` come from? I don't see that documented anywhere on the official giac site. The only links to sources on
> https://www-fourier.ujf-grenoble.fr/~parisse/giac_compile.html
> that I can find point to
> https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_stable.tgz
> and
> https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_unstable.tgz
> (which strangely do NOT contain version numbers!)
> 
> Am I missing something?
I am following the REAME file in following:
http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source
it says that
https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_stable.tgz
is a link to the latest version in the debian directory. So for a pakcage it is better to point directly to an explicit number.


---

Comment by jdemeyer created at 2017-02-18 08:44:12

Replying to [comment:21 frederichan]:
> I am following the REAME file in following:
> http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source

My question still stands: how did you find this directory? I don't see that documented anywhere on the official giac site.


---

Comment by fbissey created at 2017-02-18 09:10:33

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 frederichan]:
> > I am following the REAME file in following:
> > http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source
> 
> My question still stands: how did you find this directory? I don't see that documented anywhere on the official giac site.

It's not -I cannot find it either. I cannot even remember how I found about that directory a few months ago. There are a few routes from the info on the web-site but it is all indirect and require a bit of exploration. For example if you go to https://www-fourier.ujf-grenoble.fr/~parisse/giac/ where it says the latest sources are located you can find the `README` file mentioned by Frederic. 

The other way is to explore from the address indicated as the source of the debian repo.

Finally Han Frederic updated the address in `SPKG.txt` about 2 years ago
https://github.com/sagemath/sage/commit/43c68cc1cf32f9e93fdf90c4f4599f636a2aec70
That's probably where I got it from. Someone could ask Han how he knew but I suspect that's because he has direct contact with the author.


---

Comment by frederichan created at 2017-02-18 10:52:15

All this started from the very long discussion in #12375.  From my comment 126 I guess that it ended with some direct mail of parisse to me that he started doing this. I don't remember if the webpage was more explicit at this time.
I have asked to enhance the giac webpage there:
http://xcas.e.ujf-grenoble.fr/XCAS/viewtopic.php?f=19&t=1784


---

Comment by jdemeyer created at 2017-02-19 10:24:40

> Replying to [comment:19 fbissey]:
> Do you think it is related to `pari` or something different? Have you been able to narrow it down from a backtrace?

It doesn't look related to PARI, but it might be related to threading:

```
Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x3fffb459f180 (LWP 157861)]
0x00003fffb7b9f618 in giac::gen::in_eval (this=0x3fffb459e768, level=25, evaled=..., contextptr=0x3fffffffda40) at gen.cc:2105
2105                evaled=(*Sommet.ptr())(evaled,contextptr);
(gdb) bt
#0  0x00003fffb7b9f618 in giac::gen::in_eval (this=0x3fffb459e768, level=25, evaled=..., contextptr=0x3fffffffda40) at gen.cc:2105
#1  0x00003fffb7b9ce74 in giac::gen::eval (this=0x3fffb459e768, level=25, contextptr=0x3fffffffda40) at gen.cc:1893
#2  0x00003fffb789f578 in giac::protecteval (g=..., level=25, contextptr=0x3fffffffda40) at prog.cc:7001
#3  0x00003fffb767d904 in giac::in_thread_eval (arg=0x1006c618) at global.cc:3467
#4  0x00003fffb5af8070 in start_thread () from /lib/powerpc64le-linux-gnu/libpthread.so.0
#5  0x00003fffb5783230 in clone () from /lib/powerpc64le-linux-gnu/libc.so.6
(gdb) list
2100                  evaled=_SYMBptr->feuille;
2101              }
2102              if (is_ifte)
2103                evaled=ifte(evaled,true,contextptr);
2104              else
2105                evaled=(*Sommet.ptr())(evaled,contextptr);
2106              elevel=slevel;
2107            }
2108            else
2109              evaled=_SYMBptr->eval(level,contextptr);
(gdb) print Sommet.ptr()
$3 = (giac::unary_function_abstract *) 0xb7f7bad8
(gdb) print (*Sommet.ptr())
Cannot access memory at address 0xb7f7bad8
```



---

Comment by jdemeyer created at 2017-02-19 10:25:19

Patches should apply without fuzz:

```
Applying ../patches/nofltk-check.patch
patching file check/testgeo
patching file check/TP00-sol.cas
patching file check/TP00-sol.cas.out1
Hunk #1 succeeded at 66 with fuzz 2.
patching file check/TP02-sol.cas
patching file check/TP09-sol.cas
patching file check/TP19-sol.cas
```



---

Comment by git created at 2017-03-14 10:30:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2017-03-14 10:35:05

I have asked to update config.guess there:
http://xcas.e.ujf-grenoble.fr/XCAS/viewtopic.php?f=4&t=1787
As I can see a new config.guess in the unstable tarball I am waiting for the next stable 1.2.3.27


---

Comment by git created at 2017-03-16 13:54:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2017-03-16 14:01:21

I have built a patch with a recent config.guess so that we don't need to wait for the latest stable version of giac.


---

Comment by tmonteil created at 2017-03-16 14:06:31

Great, does it need review ?


---

Comment by frederichan created at 2017-03-16 14:59:22

Up to now I have only tried the built and the giac testsuite  with sage 7.6beta2. I was building new sage before putting the need review tag but if you have something ready to start the tests I don't plan to change the branch anymore.


---

Comment by tmonteil created at 2017-03-16 16:39:55

OK. Compilation and self-tests pass with this branch merged to `7.6.rc0` on 32bit virtual machine for `giac` and `giacpy_sage`. `make ptestling` is on the way.


---

Comment by tmonteil created at 2017-03-17 09:23:11

Does `make ptestlong` pass on `x86_64` ?


---

Comment by fbissey created at 2017-03-17 11:23:25

Why was `libpng` dropped from the dependency list? `configure` looks for it and for consistency's sake we'd rather it be sage's one rather the system one - or none at all - depending on the system. Unless you tell me it is not actually used.


---

Comment by tmonteil created at 2017-03-17 12:16:37

`make ptestlong` passes on `i386` (with `giacpy_sage` i got the bug addressed in #21884).


---

Comment by frederichan created at 2017-03-17 13:26:23

Replying to [comment:36 fbissey]:
> Why was `libpng` dropped from the dependency list? `configure` looks for it and for consistency's sake we'd rather it be sage's one rather the system one - or none at all - depending on the system. Unless you tell me it is not actually used.
Indeed I have added in spkg-install:

```
--disable-png
```



---

Comment by tmonteil created at 2017-03-17 14:09:12

Replying to [comment:38 frederichan]:
> Replying to [comment:36 fbissey]:
> > Why was `libpng` dropped from the dependency list? `configure` looks for it and for consistency's sake we'd rather it be sage's one rather the system one - or none at all - depending on the system. Unless you tell me it is not actually used.
> Indeed I have added in spkg-install:
> {{{
> --disable-png
> }}}

Compilation of giac works for me without the `--disable-png` option. Isn't it preferable to do the libpng stuff in #22159 (where there is an issue that might be solved in a different way), and focus here only on package upgrade and  `config.guess` ?


---

Comment by jpflori created at 2017-03-17 14:18:30

I think people had issue because of conflicting png version, so the easiest solution is to disable png completely first and devise a proper way to only use Sage provided png version in another ticket.

Otherwise if only this ticket gets included we'll end up with a broken solution in some cases.


---

Comment by jpflori created at 2017-03-17 14:18:49

(Not to mention that giac only works on x86 and x86_64...)


---

Comment by tmonteil created at 2017-03-17 14:21:24

OK. Did someone check this on `x86_64` ? If yes, let us positive review so that it can enter the next release.


---

Comment by frederichan created at 2017-03-17 18:41:25

So on x86_64 with sage 7.6rc1 + giacpy_sage
I have tested this branch with the branch of #21884 rebased then
ptestlong passed.


---

Comment by tmonteil created at 2017-03-17 18:45:52

Changing status from needs_work to positive_review.


---

Comment by tmonteil created at 2017-03-17 18:45:52

Changing priority from major to blocker.


---

Comment by tmonteil created at 2017-03-17 18:45:52

It is not a complete fix for #22280 but at lease it fixes it for the `i386` arch.


---

Comment by vbraun created at 2017-03-19 16:25:43

Resolution: fixed


---

Comment by tmonteil created at 2019-08-27 19:48:04

Changing keywords from "" to "sdl".
