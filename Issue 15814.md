# Issue 15814: fast_callable can return ipow with exponents in the base ring

Issue created by migration from https://trac.sagemath.org/ticket/16051

Original creator: bhutz

Original creation time: 2014-04-03 11:45:12

fast_callable returns a string of operations. However, due to how caching
of constants is done, the integer power function (ipow) can have constants
in the base ring. This is because it checks the list of constants by comparing
with == without taking into consideration the parent/type.


---

Comment by bhutz created at 2014-04-03 11:50:47

Set assignee to bhutz.


---

Comment by bhutz created at 2014-04-03 11:50:47

Made the comparison to be by type and value instead of just value
----
New commits:


---

Comment by bhutz created at 2014-04-03 11:52:48

Changing status from new to needs_review.


---

Comment by nbruin created at 2014-04-03 15:10:42

I think parent, when it is available, is a more reliable attribute to determine the mathematical identity of an element (and hence with what constants it can be folded). I think `sage.structure.parent` is the right routine to use, because it will fall back on `type` if `parent` is not available:

```
sage: parent(1)
Integer Ring
sage: parent(int(1))
<type 'int'>
sage: parent(ZZ)
<type 'sage.rings.integer_ring.IntegerRing_class'>
```

One example where going by `parent` is ostensibly better than going by `type` is:

```
sage: a=RealField(1000)(1)
sage: b=RealField(200)(1)
sage: a==b
True
sage: (type(a),a)==(type(b),b)
True
sage: (parent(a),a)==(parent(b),b)
False
```

We shouldn't be folding constants that have different precision.

I don't have examples available, but it's certainly not ruled out that elements of different types could have the same parent (to allow for different representation methods in the same parent, for instance). I don't know if we should be folding constants in those cases.

In any of the cases where this matters other than to distinguish integer powers from from other constants one is really stretching the application domain of `fast_callable` anyway.


---

Comment by git created at 2014-04-03 16:01:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2014-04-03 16:06:30

I wasn't aware of the instance of parent. That is definitely better, so I've changed it.

The instances I'm looking at is evaluating polynomials where the base ring can be something interesting like a powerseries ring, i.e. morphisms of projective space where base of projective space is something interesting. Mostly, when we implement fast evaluation for morphisms of projective space in #15920, we just don't want to break anything that currently works.


---

Comment by bhutz created at 2014-04-03 16:07:02

opps. I meant #15780.


---

Comment by drose created at 2014-05-01 14:58:43

I have run the complete doctest against this ticket. Â Everything is good.


---

Comment by drose created at 2014-05-01 14:59:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-07 08:30:57

Resolution: fixed
