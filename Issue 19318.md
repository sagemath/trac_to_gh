# Issue 19318: Implement a containment for cartesian_product

archive/issues_019318.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  sage-combinat vdelecroix\n\nWe currently have this:\n\n```\nsage: C = cartesian_product([range(5), range(5)])\nsage: (1, 1) in C\nFalse\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19555\n\n",
    "created_at": "2015-11-08T22:12:47Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Implement a containment for cartesian_product",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19318",
    "user": "tscrim"
}
```
Assignee: sage-combinat

CC:  sage-combinat vdelecroix

We currently have this:

```
sage: C = cartesian_product([range(5), range(5)])
sage: (1, 1) in C
False
```


Issue created by migration from https://trac.sagemath.org/ticket/19555





---

archive/issue_comments_265296.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-11-08T22:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265296",
    "user": "tscrim"
}
```

New commits:



---

archive/issue_comments_265297.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-08T22:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265297",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_265298.json:
```json
{
    "body": "I admittedly do not know much about such matters, but isn't the problemm here that the object is not a 'facade' object, while you expect it to be in your bug report?\n\nNathann",
    "created_at": "2015-11-09T20:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265298",
    "user": "ncohen"
}
```

I admittedly do not know much about such matters, but isn't the problemm here that the object is not a 'facade' object, while you expect it to be in your bug report?

Nathann



---

archive/issue_comments_265299.json:
```json
{
    "body": "Replying to [comment:2 ncohen]:\n> I admittedly do not know much about such matters, but isn't the problemm here that the object is not a 'facade' object, while you expect it to be in your bug report?\n\nMore or less. The current generic code (from `sage.structure.parent`) tries to compare the tuple with the corresponding object of the cartesian product. And they of course compare as different:\n\n```\nsage: C = cartesian_product([srange(5), srange(5)])\nsage: c = C((1,1))\nsage: c\n(1, 1)\nsage: c == (1,1)\nFalse\nsage: (1,1) == c\nFalse\n```\n\n\nWarning: your example is completely broken\n\n```\nsage: C = cartesian_product([range(5), range(5)])\nsage: C((1r,1r))\n(1, 1)\nsage: C((1,1))\nTraceback (most recent call last):\n...\nTypeError: Cannot convert int to sage.structure.element.Element\n```\n\n\nWarning++: you can not use `range` and `srange` in the same Sage session since `FiniteEnumeratedSet` uses `UniqueRepresentation`... I guess a safer way to implement this unique representation, would be to force a common universe for the elements... (see #19562)",
    "created_at": "2015-11-09T20:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265299",
    "user": "vdelecroix"
}
```

Replying to [comment:2 ncohen]:
> I admittedly do not know much about such matters, but isn't the problemm here that the object is not a 'facade' object, while you expect it to be in your bug report?

More or less. The current generic code (from `sage.structure.parent`) tries to compare the tuple with the corresponding object of the cartesian product. And they of course compare as different:

```
sage: C = cartesian_product([srange(5), srange(5)])
sage: c = C((1,1))
sage: c
(1, 1)
sage: c == (1,1)
False
sage: (1,1) == c
False
```


Warning: your example is completely broken

```
sage: C = cartesian_product([range(5), range(5)])
sage: C((1r,1r))
(1, 1)
sage: C((1,1))
Traceback (most recent call last):
...
TypeError: Cannot convert int to sage.structure.element.Element
```


Warning++: you can not use `range` and `srange` in the same Sage session since `FiniteEnumeratedSet` uses `UniqueRepresentation`... I guess a safer way to implement this unique representation, would be to force a common universe for the elements... (see #19562)



---

archive/issue_comments_265300.json:
```json
{
    "body": "The issue of the element constructor is worked around on #19554 (see #19553 for the general issue).",
    "created_at": "2015-11-09T20:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265300",
    "user": "tscrim"
}
```

The issue of the element constructor is worked around on #19554 (see #19553 for the general issue).



---

archive/issue_comments_265301.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-12-04T01:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265301",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_265302.json:
```json
{
    "body": "1. What is the rationale for having tuple being considered as elements of the cartesian product?\n\n2. With this version `__contains__` and `Element.__eq__` are not compatible\n\n```\nsage: (1,1) in C\nTrue\nsage: any(x == (1,1) for x in C)\nFalse\n```\n",
    "created_at": "2015-12-04T01:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265302",
    "user": "vdelecroix"
}
```

1. What is the rationale for having tuple being considered as elements of the cartesian product?

2. With this version `__contains__` and `Element.__eq__` are not compatible

```
sage: (1,1) in C
True
sage: any(x == (1,1) for x in C)
False
```




---

archive/issue_comments_265303.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-06T17:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265303",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265304.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-12-06T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265304",
    "user": "tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_265305.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> 1. What is the rationale for having tuple being considered as elements of the cartesian product?\n\nThey are just wrappers around tuples, and at times, it is beneficial to not wrap/unwrap such objects, such as if the Cartesian product is the set of keys of a dict/Family.\n\n> 2. With this version `__contains__` and `Element.__eq__` are not compatible\n> {{{\n> sage: (1,1) in C\n> True\n> sage: any(x == (1,1) for x in C)\n> False\n> }}}\n\nGood point. I added equality of tuples.",
    "created_at": "2015-12-06T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265305",
    "user": "tscrim"
}
```

Replying to [comment:6 vdelecroix]:
> 1. What is the rationale for having tuple being considered as elements of the cartesian product?

They are just wrappers around tuples, and at times, it is beneficial to not wrap/unwrap such objects, such as if the Cartesian product is the set of keys of a dict/Family.

> 2. With this version `__contains__` and `Element.__eq__` are not compatible
> {{{
> sage: (1,1) in C
> True
> sage: any(x == (1,1) for x in C)
> False
> }}}

Good point. I added equality of tuples.



---

archive/issue_comments_265306.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> Replying to [comment:6 vdelecroix]:\n> > 1. What is the rationale for having tuple being considered as elements of the cartesian product?\n> \n> They are just wrappers around tuples, and at times, it is beneficial to not wrap/unwrap such objects, such as if the Cartesian product is the set of keys of a dict/Family.\n\nThen in that case I would actually implement an option in `CartesianProduct` to actually **use** tuples directly.",
    "created_at": "2015-12-06T17:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265306",
    "user": "vdelecroix"
}
```

Replying to [comment:8 tscrim]:
> Replying to [comment:6 vdelecroix]:
> > 1. What is the rationale for having tuple being considered as elements of the cartesian product?
> 
> They are just wrappers around tuples, and at times, it is beneficial to not wrap/unwrap such objects, such as if the Cartesian product is the set of keys of a dict/Family.

Then in that case I would actually implement an option in `CartesianProduct` to actually **use** tuples directly.



---

archive/issue_comments_265307.json:
```json
{
    "body": "Err.. Just wondering aloud: is it safe to enable equality with tuples? It means that the hash has to be the same, doesn't it?\n\nNathann",
    "created_at": "2015-12-06T17:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265307",
    "user": "ncohen"
}
```

Err.. Just wondering aloud: is it safe to enable equality with tuples? It means that the hash has to be the same, doesn't it?

Nathann



---

archive/issue_comments_265308.json:
```json
{
    "body": "\n```\nsage: A = cartesian_product([ZZ, ZZ])\nsage: elt = A((1,1))\nsage: hash(elt)\n3713081631935493181\nsage: hash((1,1))\n3713081631935493181\n```\n",
    "created_at": "2015-12-06T17:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265308",
    "user": "tscrim"
}
```


```
sage: A = cartesian_product([ZZ, ZZ])
sage: elt = A((1,1))
sage: hash(elt)
3713081631935493181
sage: hash((1,1))
3713081631935493181
```




---

archive/issue_comments_265309.json:
```json
{
    "body": "Oh, okay okay then. I didn't see a hash function in the file, and so I wondered if we were sure that the parent was not involved.",
    "created_at": "2015-12-06T17:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265309",
    "user": "ncohen"
}
```

Oh, okay okay then. I didn't see a hash function in the file, and so I wondered if we were sure that the parent was not involved.



---

archive/issue_comments_265310.json:
```json
{
    "body": "The default hash of `ElementWrapper` is the hash of the wrapper value.",
    "created_at": "2015-12-06T17:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265310",
    "user": "tscrim"
}
```

The default hash of `ElementWrapper` is the hash of the wrapper value.



---

archive/issue_comments_265311.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-06T23:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265311",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_265312.json:
```json
{
    "body": "Equality does not work (see patchbot report). And what about [comment:9 comment:9]?",
    "created_at": "2015-12-06T23:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265312",
    "user": "vdelecroix"
}
```

Equality does not work (see patchbot report). And what about [comment:9 comment:9]?



---

archive/issue_comments_265313.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-07T01:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265313",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265314.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-12-07T01:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265314",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_265315.json:
```json
{
    "body": "With regards to comment:9, we don't want them to be tuples because we want all of the category information to be inherited, e.g.\n\n```\nsage: C = cartesian_product([ZZ, ZZ])\nsage: x = C.an_element()\nsage: x\n(1, 1)\nsage: x.is_one()\nTrue\n```\n",
    "created_at": "2015-12-07T01:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265315",
    "user": "tscrim"
}
```

With regards to comment:9, we don't want them to be tuples because we want all of the category information to be inherited, e.g.

```
sage: C = cartesian_product([ZZ, ZZ])
sage: x = C.an_element()
sage: x
(1, 1)
sage: x.is_one()
True
```




---

archive/issue_comments_265316.json:
```json
{
    "body": "I fully agree on the above example and there are many others. As you said, wrapping has a cost. Having an option looks reasonable\n\n```\nsage: C = cartesian_product([range(5), range(5)], with_elements_as_tuple=True)\nsage: C.element_class\n<type 'tuple'>\n```\n\nThough, I am just asking for your opinion. I am not considering it good for inclusion in this ticket.\n\nOn the other hand, with your laxism with respect to tuples the equality test is about 3x slower. We had\n\n```\nsage: C = cartesian_product([srange(5), srange(5)])\nsage: c = C((1,1))\nsage: d = C((1,1))\nsage: e = C((1,2))\nsage: %timeit c == d and c == e\n1000000 loops, best of 3: 327 ns per loop\n```\n\nAnd with your branch\n\n```\nsage: %timeit c == d and c == e\n100000 loops, best of 3: 1.93 \u00b5s per loop\n```\n\nIf the comparison has to be touched, it has to be at the level of `ElementWrapper`. Probably a new class.",
    "created_at": "2015-12-07T02:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265316",
    "user": "vdelecroix"
}
```

I fully agree on the above example and there are many others. As you said, wrapping has a cost. Having an option looks reasonable

```
sage: C = cartesian_product([range(5), range(5)], with_elements_as_tuple=True)
sage: C.element_class
<type 'tuple'>
```

Though, I am just asking for your opinion. I am not considering it good for inclusion in this ticket.

On the other hand, with your laxism with respect to tuples the equality test is about 3x slower. We had

```
sage: C = cartesian_product([srange(5), srange(5)])
sage: c = C((1,1))
sage: d = C((1,1))
sage: e = C((1,2))
sage: %timeit c == d and c == e
1000000 loops, best of 3: 327 ns per loop
```

And with your branch

```
sage: %timeit c == d and c == e
100000 loops, best of 3: 1.93 µs per loop
```

If the comparison has to be touched, it has to be at the level of `ElementWrapper`. Probably a new class.



---

archive/issue_comments_265317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-10T04:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265317",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265318.json:
```json
{
    "body": "Ahh...the speed of Cython. I created a new class in between `ElementWrapper` and `CartesianProduct.Element` that has specialized equality comparisons against the wrapped class.\n\nCurrent:\n\n```\nsage: C = cartesian_product([ZZ, ZZ])\nsage: c = C((1, 1))\nsage: d = C((1, 1))\nsage: e = C((1, 2))\nsage: %timeit c == d\n1000000 loops, best of 3: 183 ns per loop\nsage: %timeit c == e\n10000000 loops, best of 3: 183 ns per loop\n```\n\nvs old:\n\n```\nsage: %timeit c == d\n1000000 loops, best of 3: 175 ns per loop\nsage: %timeit c == e\n10000000 loops, best of 3: 179 ns per loop\n```\n\nSo we might loose up to ~2%, but I think this will get lost in noise if someone is doing Cartesian products of things with any harder comparison operators. (Although IMO the previous slowdown would likely have been negligible in computations (at least I would recommend using `itertools` and `tuple`s if this was an issue)).\n\nAs suggested in the parenthetical, if you wanted this to be a facade parent for tuples, which is I think what you would end up with, then you likely could just use `itertools`.",
    "created_at": "2015-12-10T04:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265318",
    "user": "tscrim"
}
```

Ahh...the speed of Cython. I created a new class in between `ElementWrapper` and `CartesianProduct.Element` that has specialized equality comparisons against the wrapped class.

Current:

```
sage: C = cartesian_product([ZZ, ZZ])
sage: c = C((1, 1))
sage: d = C((1, 1))
sage: e = C((1, 2))
sage: %timeit c == d
1000000 loops, best of 3: 183 ns per loop
sage: %timeit c == e
10000000 loops, best of 3: 183 ns per loop
```

vs old:

```
sage: %timeit c == d
1000000 loops, best of 3: 175 ns per loop
sage: %timeit c == e
10000000 loops, best of 3: 179 ns per loop
```

So we might loose up to ~2%, but I think this will get lost in noise if someone is doing Cartesian products of things with any harder comparison operators. (Although IMO the previous slowdown would likely have been negligible in computations (at least I would recommend using `itertools` and `tuple`s if this was an issue)).

As suggested in the parenthetical, if you wanted this to be a facade parent for tuples, which is I think what you would end up with, then you likely could just use `itertools`.



---

archive/issue_comments_265319.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> As suggested in the parenthetical, if you wanted this to be a facade parent for tuples, which is I think what you would end up with, then you likely could just use `itertools`.\n\nBut itertools does not care about `rank`, `unrank`, `__contains__`. Python iterators might not be rich enough.\n\nVincent",
    "created_at": "2015-12-24T15:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265319",
    "user": "vdelecroix"
}
```

Replying to [comment:19 tscrim]:
> As suggested in the parenthetical, if you wanted this to be a facade parent for tuples, which is I think what you would end up with, then you likely could just use `itertools`.

But itertools does not care about `rank`, `unrank`, `__contains__`. Python iterators might not be rich enough.

Vincent



---

archive/issue_comments_265320.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-24T15:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265320",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_265321.json:
```json
{
    "body": "Well, we'll see if such a situation arises. Thanks for the review.",
    "created_at": "2015-12-24T22:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265321",
    "user": "tscrim"
}
```

Well, we'll see if such a situation arises. Thanks for the review.



---

archive/issue_comments_265322.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-25T16:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19318",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19318#issuecomment-265322",
    "user": "vbraun"
}
```

Resolution: fixed
