# Issue 28333: fix matrix inversion over ZZ

archive/issues_028333.json:
```json
{
    "body": "CC:  vdelecroix jhpalmieri\n\nThis was broken by #28189.\n\nProbably due to the new \"inverse_of_unit\" method taking over the existing one.\n\nThis cause the following to never stop:\n\n```\nsage: P = posets.TamariLattice(7)\nsage: H = P._hasse_diagram\nsage: M = H._leq_matrix\nsage: M.inverse_of_unit()\n```\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28570\n\n",
    "created_at": "2019-10-07T16:06:01Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "fix matrix inversion over ZZ",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28333",
    "user": "chapoton"
}
```
CC:  vdelecroix jhpalmieri

This was broken by #28189.

Probably due to the new "inverse_of_unit" method taking over the existing one.

This cause the following to never stop:

```
sage: P = posets.TamariLattice(7)
sage: H = P._hasse_diagram
sage: M = H._leq_matrix
sage: M.inverse_of_unit()
```




Issue created by migration from https://trac.sagemath.org/ticket/28570





---

archive/issue_comments_400155.json:
```json
{
    "body": "Possibly relevant point: Prior to #28189, this routine returned a sparse matrix. If sparsity isn't taken into account in the new code that could very well explain a drastic slow-down.",
    "created_at": "2019-10-07T16:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400155",
    "user": "nbruin"
}
```

Possibly relevant point: Prior to #28189, this routine returned a sparse matrix. If sparsity isn't taken into account in the new code that could very well explain a drastic slow-down.



---

archive/issue_comments_400156.json:
```json
{
    "body": "First, the command `M.inverse_of_unit()` does actually finish for me, eventually. It takes 5 minutes or so, in contrast to `~M` which takes under 1 second.\n\nFrom [reading the old code](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/categories/rings.py#n1117), it looks like `M.inverse_of_unit()` just computed the inverse and then coerced the inverse matrix to have the same base ring. In the new version, it tries to be more clever, in particular calling `M.adjugate()`. I think `M.adjugate()` is the problem for sparse integer matrices, or indeed for integer matrices in general. Even in 8.9, running `M.adjugate()` or `M.dense_matrix().adjugate()` on the matrix in the ticket description takes a long time.\n\nOne way around this would be to add an `elif` clause to the new `inverse_of_unit` which handles the case when the base ring is the integers. I don't know if this is the best choice.",
    "created_at": "2019-10-07T19:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400156",
    "user": "jhpalmieri"
}
```

First, the command `M.inverse_of_unit()` does actually finish for me, eventually. It takes 5 minutes or so, in contrast to `~M` which takes under 1 second.

From [reading the old code](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/categories/rings.py#n1117), it looks like `M.inverse_of_unit()` just computed the inverse and then coerced the inverse matrix to have the same base ring. In the new version, it tries to be more clever, in particular calling `M.adjugate()`. I think `M.adjugate()` is the problem for sparse integer matrices, or indeed for integer matrices in general. Even in 8.9, running `M.adjugate()` or `M.dense_matrix().adjugate()` on the matrix in the ticket description takes a long time.

One way around this would be to add an `elif` clause to the new `inverse_of_unit` which handles the case when the base ring is the integers. I don't know if this is the best choice.



---

archive/issue_comments_400157.json:
```json
{
    "body": "and we also have now the following not-so-funny bug:\n\n```\nsage: m = matrix(Zmod(13**3),2,2,[3,5,7,11],sparse=True)\nsage: m.inverse()     \n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-12-91aa9265ee1c> in <module>()\n----> 1 m.inverse()\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.inverse (build/cythonized/sage/matrix/matrix2.c:66498)()\n   8919 \n   8920         \"\"\"\n-> 8921         return ~self\n   8922 \n   8923     def adjugate(self):\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__invert__ (build/cythonized/sage/matrix/matrix0.c:35802)()\n   5400                 return ~self.matrix_over_field()\n   5401             else:\n-> 5402                 return self.inverse_of_unit()\n   5403         else:\n   5404             A = self.augment(self.parent().identity_matrix())\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.inverse_of_unit (build/cythonized/sage/matrix/matrix0.c:36801)()\n   5501             # CRT or p-adic lifting.\n   5502             N = R.characteristic()\n-> 5503             m, D = self.lift_centered()._invert_flint()\n   5504             if not D.gcd(N).is_one():\n   5505                 raise ZeroDivisionError(\"input matrix must be nonsingular\")\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4607)()\n    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    488         \"\"\"\n--> 489         return self.getattr_from_category(name)\n    490 \n    491     cdef getattr_from_category(self, name):\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4716)()\n    500         else:\n    501             cls = P._abstract_element_class\n--> 502         return getattr_from_other_class(self, cls, name)\n    503 \n    504     def __dir__(self):\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)()\n    392         dummy_error_message.cls = type(self)\n    393         dummy_error_message.name = name\n--> 394         raise AttributeError(dummy_error_message)\n    395     attribute = <object>attr\n    396     # Check for a descriptor (__get__ in Python)\n\nAttributeError: 'sage.matrix.matrix_integer_sparse.Matrix_integer_sparse' object has no attribute '_invert_flint'\n```\n",
    "created_at": "2019-10-08T18:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400157",
    "user": "chapoton"
}
```

and we also have now the following not-so-funny bug:

```
sage: m = matrix(Zmod(13**3),2,2,[3,5,7,11],sparse=True)
sage: m.inverse()     
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-12-91aa9265ee1c> in <module>()
----> 1 m.inverse()

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.inverse (build/cythonized/sage/matrix/matrix2.c:66498)()
   8919 
   8920         """
-> 8921         return ~self
   8922 
   8923     def adjugate(self):

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__invert__ (build/cythonized/sage/matrix/matrix0.c:35802)()
   5400                 return ~self.matrix_over_field()
   5401             else:
-> 5402                 return self.inverse_of_unit()
   5403         else:
   5404             A = self.augment(self.parent().identity_matrix())

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.inverse_of_unit (build/cythonized/sage/matrix/matrix0.c:36801)()
   5501             # CRT or p-adic lifting.
   5502             N = R.characteristic()
-> 5503             m, D = self.lift_centered()._invert_flint()
   5504             if not D.gcd(N).is_one():
   5505                 raise ZeroDivisionError("input matrix must be nonsingular")

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4607)()
    487             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    488         """
--> 489         return self.getattr_from_category(name)
    490 
    491     cdef getattr_from_category(self, name):

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4716)()
    500         else:
    501             cls = P._abstract_element_class
--> 502         return getattr_from_other_class(self, cls, name)
    503 
    504     def __dir__(self):

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)()
    392         dummy_error_message.cls = type(self)
    393         dummy_error_message.name = name
--> 394         raise AttributeError(dummy_error_message)
    395     attribute = <object>attr
    396     # Check for a descriptor (__get__ in Python)

AttributeError: 'sage.matrix.matrix_integer_sparse.Matrix_integer_sparse' object has no attribute '_invert_flint'
```




---

archive/issue_comments_400158.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> and we also have now the following not-so-funny bug\n\nOne would almost think the reviewer on that ticket could have done a more thorough job :-)\n\nMore seriously, I think this shows we are running into weaknesses of our review system. I don't have concrete suggestions on how to improve it, but if this kind of thing happens more often, it might be worth considering if there are procedural changes we can make that reduce the likelihood of such bugs slipping through, without unduly narrowing the bottleneck that review already is.",
    "created_at": "2019-10-08T18:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400158",
    "user": "nbruin"
}
```

Replying to [comment:3 chapoton]:
> and we also have now the following not-so-funny bug

One would almost think the reviewer on that ticket could have done a more thorough job :-)

More seriously, I think this shows we are running into weaknesses of our review system. I don't have concrete suggestions on how to improve it, but if this kind of thing happens more often, it might be worth considering if there are procedural changes we can make that reduce the likelihood of such bugs slipping through, without unduly narrowing the bottleneck that review already is.



---

archive/issue_comments_400159.json:
```json
{
    "body": "Trying to fix one of the problems.\n----\nNew commits:",
    "created_at": "2019-10-08T19:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400159",
    "user": "chapoton"
}
```

Trying to fix one of the problems.
----
New commits:



---

archive/issue_comments_400160.json:
```json
{
    "body": "Not related, but also quite bad:\n\n```\nsage: m = matrix(Zmod(2**2),1,1,[1],sparse=True)\nsage: m.det()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-10-6b1d86e9fa93> in <module>()\n----> 1 m.det()\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.det (build/cythonized/sage/matrix/matrix2.c:16941)()\n   1918             6\n   1919         \"\"\"\n-> 1920         return self.determinant(*args, **kwds)\n   1921 \n   1922     def apply_morphism(self, phi):\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.determinant (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:9560)()\n    844 \n    845         if algorithm is None or algorithm == \"linbox\":\n--> 846             r, d = self._rank_det_linbox()\n    847             self.cache('rank', r)\n    848             self.cache('det', d)\n\n/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse._rank_det_linbox (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:8655)()\n    682 \n    683         if not is_prime(self.p):\n--> 684             raise TypeError(\"only GF(p) supported via LinBox\")\n    685 \n    686         cdef givaro.Modular_uint64 * F = new givaro.Modular_uint64(<uint64_t> self.p)\n\nTypeError: only GF(p) supported via LinBox\n```\n",
    "created_at": "2019-10-08T19:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400160",
    "user": "chapoton"
}
```

Not related, but also quite bad:

```
sage: m = matrix(Zmod(2**2),1,1,[1],sparse=True)
sage: m.det()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-10-6b1d86e9fa93> in <module>()
----> 1 m.det()

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.det (build/cythonized/sage/matrix/matrix2.c:16941)()
   1918             6
   1919         """
-> 1920         return self.determinant(*args, **kwds)
   1921 
   1922     def apply_morphism(self, phi):

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.determinant (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:9560)()
    844 
    845         if algorithm is None or algorithm == "linbox":
--> 846             r, d = self._rank_det_linbox()
    847             self.cache('rank', r)
    848             self.cache('det', d)

/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/matrix/matrix_modn_sparse.pyx in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse._rank_det_linbox (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:8655)()
    682 
    683         if not is_prime(self.p):
--> 684             raise TypeError("only GF(p) supported via LinBox")
    685 
    686         cdef givaro.Modular_uint64 * F = new givaro.Modular_uint64(<uint64_t> self.p)

TypeError: only GF(p) supported via LinBox
```




---

archive/issue_comments_400161.json:
```json
{
    "body": "Replying to [comment:6 chapoton]:\n> Not related, but also quite bad:\n\nThis one is also not new: it's been present at least since Sage 8.6.",
    "created_at": "2019-10-08T20:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400161",
    "user": "jhpalmieri"
}
```

Replying to [comment:6 chapoton]:
> Not related, but also quite bad:

This one is also not new: it's been present at least since Sage 8.6.



---

archive/issue_comments_400162.json:
```json
{
    "body": "`_adjugate` does that :\n\n```\nA = self.charpoly().shift(-1)(self)\n```\n\nwhich seems to be a rather terrible idea for matrices of large size.",
    "created_at": "2019-10-09T14:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400162",
    "user": "chapoton"
}
```

`_adjugate` does that :

```
A = self.charpoly().shift(-1)(self)
```

which seems to be a rather terrible idea for matrices of large size.



---

archive/issue_comments_400163.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-09T15:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400163",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_400164.json:
```json
{
    "body": "Here is a proposal. Please review",
    "created_at": "2019-10-09T15:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400164",
    "user": "chapoton"
}
```

Here is a proposal. Please review



---

archive/issue_comments_400165.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-09T15:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400165",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_400166.json:
```json
{
    "body": "green bot",
    "created_at": "2019-10-09T17:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400166",
    "user": "chapoton"
}
```

green bot



---

archive/issue_comments_400167.json:
```json
{
    "body": "I am not sure this is a smart move. Your proposed solution performs a modular inversion for each coefficient instead of a single one. Here is a use case where one can identify a x2 slowdown.\n\n```\nsage: def inv1(m):\n....:     p = m.base_ring().characteristic()           \n....:     minv, d = m.lift_centered()._invert_flint()\n....:     return d.inverse_mod(p) * minv.change_ring(R)\nsage: def inv2(m):\n....:     return (~self.lift_centered()).change_ring(R)\nsage: p = next_prime(2**50)\nsage: R = GF(p)\nsage: m = random_matrix(R, 50)   # assuming we get something invertible...\nsage: %timeit minv = inv1(m)\n10 loops, best of 3: 93.5 ms per loop\nsage: %timeit minv = inv2(m)\n10 loops, best of 3: 174 ms per loop\n```\n",
    "created_at": "2019-10-09T17:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400167",
    "user": "vdelecroix"
}
```

I am not sure this is a smart move. Your proposed solution performs a modular inversion for each coefficient instead of a single one. Here is a use case where one can identify a x2 slowdown.

```
sage: def inv1(m):
....:     p = m.base_ring().characteristic()           
....:     minv, d = m.lift_centered()._invert_flint()
....:     return d.inverse_mod(p) * minv.change_ring(R)
sage: def inv2(m):
....:     return (~self.lift_centered()).change_ring(R)
sage: p = next_prime(2**50)
sage: R = GF(p)
sage: m = random_matrix(R, 50)   # assuming we get something invertible...
sage: %timeit minv = inv1(m)
10 loops, best of 3: 93.5 ms per loop
sage: %timeit minv = inv2(m)
10 loops, best of 3: 174 ms per loop
```




---

archive/issue_comments_400168.json:
```json
{
    "body": "Hello Vincent. Feel free to propose a much better fix.",
    "created_at": "2019-10-09T17:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400168",
    "user": "chapoton"
}
```

Hello Vincent. Feel free to propose a much better fix.



---

archive/issue_comments_400169.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-10-09T18:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400169",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_400170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-10T08:22:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400170",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_400171.json:
```json
{
    "body": "The case of fields is in fact handled by the previous part of the code.",
    "created_at": "2019-10-10T08:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400171",
    "user": "chapoton"
}
```

The case of fields is in fact handled by the previous part of the code.



---

archive/issue_comments_400172.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-10-10T08:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400172",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_400173.json:
```json
{
    "body": "I ran an experiment:\n\n```\nsage: p = next_prime(2**50)\nsage: R = GF(p)\nsage: %timeit random_matrix(R, 50).inverse_of_unit()\n```\n\nWithout this branch:\n\n```\n10 loops, best of 5: 186 ms per loop\n```\n\nWith this branch:\n\n```\n10 loops, best of 5: 185 ms per loop\n```\n\nAs Fr\u00e9d\u00e9ric says, fields are handled elsewhere, so of course there is no slowdown with this branch.\n\nAre there other concerns? It certainly fixes the integer slowdown and the `Z/p**n` bug from comment:3.",
    "created_at": "2019-10-10T16:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400173",
    "user": "jhpalmieri"
}
```

I ran an experiment:

```
sage: p = next_prime(2**50)
sage: R = GF(p)
sage: %timeit random_matrix(R, 50).inverse_of_unit()
```

Without this branch:

```
10 loops, best of 5: 186 ms per loop
```

With this branch:

```
10 loops, best of 5: 185 ms per loop
```

As Frédéric says, fields are handled elsewhere, so of course there is no slowdown with this branch.

Are there other concerns? It certainly fixes the integer slowdown and the `Z/p**n` bug from comment:3.



---

archive/issue_comments_400174.json:
```json
{
    "body": "Looks good to me. Thanks for fixing my stupid mistake from #28189!",
    "created_at": "2019-10-10T16:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400174",
    "user": "vdelecroix"
}
```

Looks good to me. Thanks for fixing my stupid mistake from #28189!



---

archive/issue_comments_400175.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-10T16:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400175",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400176.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-12T22:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400176",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_400177.json:
```json
{
    "body": "Replying to [comment:4 nbruin]:\n> More seriously, I think this shows we are running into weaknesses of our review system. I don't have concrete suggestions on how to improve it, but if this kind of thing happens more often, it might be worth considering if there are procedural changes we can make that reduce the likelihood of such bugs slipping through, without unduly narrowing the bottleneck that review already is.\n\nHere's an idea, but I don't know how feasible it is: extract every test in the `matrix` directory and make sure it works with both sparse and dense matrices. (Maybe not every test: maybe you don't want to mess with the ones in `*_dense.*`, etc.)",
    "created_at": "2019-10-16T23:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28333#issuecomment-400177",
    "user": "jhpalmieri"
}
```

Replying to [comment:4 nbruin]:
> More seriously, I think this shows we are running into weaknesses of our review system. I don't have concrete suggestions on how to improve it, but if this kind of thing happens more often, it might be worth considering if there are procedural changes we can make that reduce the likelihood of such bugs slipping through, without unduly narrowing the bottleneck that review already is.

Here's an idea, but I don't know how feasible it is: extract every test in the `matrix` directory and make sure it works with both sparse and dense matrices. (Maybe not every test: maybe you don't want to mess with the ones in `*_dense.*`, etc.)
