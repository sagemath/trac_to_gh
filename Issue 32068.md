# Issue 32068: Upgrade networkx to 2.6

Issue created by migration from https://trac.sagemath.org/ticket/32305

Original creator: arojas

Original creation time: 2021-07-29 16:38:53

CC:  mkoeppe fbissey dcoudert slelievre @collares




---

Comment by arojas created at 2021-07-29 17:39:57

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2021-07-29 17:39:57

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by arojas created at 2021-07-29 17:39:57

New commits:


---

Comment by arojas created at 2021-07-29 17:41:50

`RandomBarabasiAlbert` is broken with m=1, reported upstream https://github.com/networkx/networkx/issues/4995


```
File "src/sage/graphs/generators/random.py", line 176, in sage.graphs.generators.random.RandomBarabasiAlbert
Failed example:
    graphs.RandomBarabasiAlbert(6, 1).is_tree()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.random.RandomBarabasiAlbert[9]>", line 1, in <module>
        graphs.RandomBarabasiAlbert(Integer(6), Integer(1)).is_tree()
      File "/usr/lib/python3.9/site-packages/sage/graphs/generators/random.py", line 182, in RandomBarabasiAlbert
        return Graph(networkx.barabasi_albert_graph(n, m, seed=seed))
      File "<class 'networkx.utils.decorators.argmap'> compilation 12", line 4, in argmap_barabasi_albert_graph_9
        from pathlib import Path
      File "/usr/lib/python3.9/site-packages/networkx/generators/random_graphs.py", line 678, in barabasi_albert_graph
        targets = _random_subset(repeated_nodes, m, seed)
      File "/usr/lib/python3.9/site-packages/networkx/generators/random_graphs.py", line 613, in _random_subset
        x = rng.choice(seq)
      File "/usr/lib/python3.9/random.py", line 346, in choice
        return seq[self._randbelow(len(seq))]
    IndexError: list index out of range
**********************************************************************
```



---

Comment by @sheerluck created at 2021-07-29 20:59:08

in `networkx/generators/classic.py`

in function `def star_graph(n, create_using=None):`

in line `if isinstance(n_name, int):`

for python that condition is true.

for sage it is not.


```
networkx.barabasi_albert_graph(6, int(1))  # works in sage
```



---

Comment by git created at 2021-07-29 21:08:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-07-29 21:10:15

Replying to [comment:4 gh-sheerluck]:
> in `networkx/generators/classic.py`
> 
> in function `def star_graph(n, create_using=None):`
> 
> in line `if isinstance(n_name, int):`
> 
> for python that condition is true.
> 
> for sage it is not.

Right, thanks


---

Comment by arojas created at 2021-07-29 21:12:08

Changing status from new to needs_review.


---

Comment by git created at 2021-07-29 21:15:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-04 10:11:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-12 01:16:59

The version constraints in `build/pkgs/networkx/install-requires.txt` will need to be adjusted to include the version that we update to.

Do the doctest changes require the upgrade, or do we expect that networkx 2.4 still works?


---

Comment by git created at 2021-08-14 08:37:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-08-14 08:38:49

Replying to [comment:11 mkoeppe]:
> Do the doctest changes require the upgrade, or do we expect that networkx 2.4 still works?

Everything is fine with older networkx except for the test in `digraph.py`, which returns a different (still correct) topological sorting.


---

Comment by mkoeppe created at 2021-08-25 19:41:48

Replying to [comment:13 arojas]:
> Replying to [comment:11 mkoeppe]:
> > Do the doctest changes require the upgrade, or do we expect that networkx 2.4 still works?
> 
> Everything is fine with older networkx except for the test in `digraph.py`, which returns a different (still correct) topological sorting.

I think it would be better to rewrite this doctest so that it accepts both versions


---

Comment by dcoudert created at 2021-08-26 09:38:59

Something like that could do the job

```sage
sage: def is_valid_topological_sort(D, order):
....:     pos = {u: i for i, u in enumerate(order)}
....:     for u, v in D.edges(labels=False):
....:         if pos[u] > pos[v]:
....:             return False
....:     return True
sage:
sage: order = list(D.topological_sort(implementation="NetworkX"))
sage: is_valid_topological_sort(D, order)
True
```



---

Comment by git created at 2021-09-02 18:23:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-09-02 18:24:49

tests pass with networkx 2.5 now


---

Comment by mkoeppe created at 2021-09-04 23:24:34

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-04 23:24:34

The tests look fine.


---

Comment by vbraun created at 2021-09-07 20:52:23

Resolution: fixed
