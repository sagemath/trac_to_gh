# Issue 17429: False positive for memory leak check on OSX

archive/issues_017429.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/17666\n\n",
    "created_at": "2015-01-24T19:05:35Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "False positive for memory leak check on OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17429",
    "user": "vbraun"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/17666





---

archive/issue_comments_232785.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-01-24T19:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232785",
    "user": "vbraun"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_232786.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2015-01-24T19:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232786",
    "user": "vbraun"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_232787.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-24T19:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232787",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_232788.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-01-24T19:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232788",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_232789.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-01-24T22:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232789",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_232790.json:
```json
{
    "body": "How do we know it's a *false* positive?",
    "created_at": "2015-01-24T22:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232790",
    "user": "jdemeyer"
}
```

How do we know it's a *false* positive?



---

archive/issue_comments_232791.json:
```json
{
    "body": "For what it's worth, I've run tests about 100 times on an OS X machine and haven't gotten any failures.",
    "created_at": "2015-01-24T23:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232791",
    "user": "jhpalmieri"
}
```

For what it's worth, I've run tests about 100 times on an OS X machine and haven't gotten any failures.



---

archive/issue_comments_232792.json:
```json
{
    "body": "An actual memory leak leaks memory every time...",
    "created_at": "2015-01-24T23:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232792",
    "user": "vbraun"
}
```

An actual memory leak leaks memory every time...



---

archive/issue_comments_232793.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> An actual memory leak leaks memory every time...\nDepending on the implementation, that doesn't need to be the case. `malloc` usually pre-allocates more memory than strictly needed. Your test would pass even if there was an actual memory leak.\n\nI think a better test would be that the amount of memory needed to execute `leak(10000)` n times is bounded by a constant which does not depend on n.\nSomething like (pseudocode):\n\n```\nL = []\nfor i in range(10):\n    leak(10000)\n    L.append(memory_usage())\nm = max(L)  # taking the max because the memory usage might increase and decrease\nfor i in range(10):\n    leak(10000)\n    assert memory_usage() <= m\n```\n",
    "created_at": "2015-01-25T09:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232793",
    "user": "jdemeyer"
}
```

Replying to [comment:6 vbraun]:
> An actual memory leak leaks memory every time...
Depending on the implementation, that doesn't need to be the case. `malloc` usually pre-allocates more memory than strictly needed. Your test would pass even if there was an actual memory leak.

I think a better test would be that the amount of memory needed to execute `leak(10000)` n times is bounded by a constant which does not depend on n.
Something like (pseudocode):

```
L = []
for i in range(10):
    leak(10000)
    L.append(memory_usage())
m = max(L)  # taking the max because the memory usage might increase and decrease
for i in range(10):
    leak(10000)
    assert memory_usage() <= m
```




---

archive/issue_comments_232794.json:
```json
{
    "body": "And you need to run at least as many iterations such that a leak would have to fill up the current process space. Which is IMHO way too slow for a doctest. A good enough heuristic is to hope that at least one of the tested OSes has a malloc pool granularity that is small enough (less than 16 * 10000)",
    "created_at": "2015-01-25T13:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232794",
    "user": "vbraun"
}
```

And you need to run at least as many iterations such that a leak would have to fill up the current process space. Which is IMHO way too slow for a doctest. A good enough heuristic is to hope that at least one of the tested OSes has a malloc pool granularity that is small enough (less than 16 * 10000)



---

archive/issue_comments_232795.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-29T08:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232795",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_232796.json:
```json
{
    "body": "`@`vbraun: what is the result of\n\n```\nfor i in range(100):\n    print leak(10000)\n```\n",
    "created_at": "2015-01-29T13:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232796",
    "user": "jdemeyer"
}
```

`@`vbraun: what is the result of

```
for i in range(100):
    print leak(10000)
```




---

archive/issue_comments_232797.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-01-29T13:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232797",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_232798.json:
```json
{
    "body": "The result is that it takes way longer than what a long doctest ought to use:\n\n```\nsage: %time [leak(10000) for i in range(100)]\nCPU times: user 1min 16s, sys: 327 ms, total: 1min 17s\nWall time: 1min 15s\n```\n\nOutput on OSX is:\n\n```\n[155189248, 0, 0, 0, 83886080, 0, 0, 0, 79691776, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n```\n",
    "created_at": "2015-01-29T13:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232798",
    "user": "vbraun"
}
```

The result is that it takes way longer than what a long doctest ought to use:

```
sage: %time [leak(10000) for i in range(100)]
CPU times: user 1min 16s, sys: 327 ms, total: 1min 17s
Wall time: 1min 15s
```

Output on OSX is:

```
[155189248, 0, 0, 0, 83886080, 0, 0, 0, 79691776, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
```




---

archive/issue_comments_232799.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-29T13:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232799",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_232800.json:
```json
{
    "body": "That output suggests that the test could better be written as\n\n```\nsage: for i in range(10):\n....:    leak(10000)\nsage: leak(10000)\n0\n```\n",
    "created_at": "2015-01-29T15:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232800",
    "user": "jdemeyer"
}
```

That output suggests that the test could better be written as

```
sage: for i in range(10):
....:    leak(10000)
sage: leak(10000)
0
```




---

archive/issue_comments_232801.json:
```json
{
    "body": "Tried that, didn't work reliably.",
    "created_at": "2015-01-29T15:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232801",
    "user": "vbraun"
}
```

Tried that, didn't work reliably.



---

archive/issue_comments_232802.json:
```json
{
    "body": "How about checking for 5 *consequtive* zero values? What I want to avoid is that the doctest would accept `[1000000, 0, 1000000, 0, 1000000, 0, 1000000,...]` which would probably still be a memory leak.",
    "created_at": "2015-01-29T15:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232802",
    "user": "jdemeyer"
}
```

How about checking for 5 *consequtive* zero values? What I want to avoid is that the doctest would accept `[1000000, 0, 1000000, 0, 1000000, 0, 1000000,...]` which would probably still be a memory leak.



---

archive/issue_comments_232803.json:
```json
{
    "body": "Isn't that just a variant of increasing the count by an order of magnitude? Too slow.",
    "created_at": "2015-01-29T15:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232803",
    "user": "vbraun"
}
```

Isn't that just a variant of increasing the count by an order of magnitude? Too slow.



---

archive/issue_comments_232804.json:
```json
{
    "body": "Replying to [comment:15 vbraun]:\n> Isn't that just a variant of increasing the count by an order of magnitude? Too slow.\nDoing 10 tests (your commit) is fine, but doing *14 tests* (5 consequtive zeros in your example `[155189248, 0, 0, 0, 83886080, 0, 0, 0, 79691776, 0, 0, 0, 0, 0]` is an order of magnitude slower?",
    "created_at": "2015-01-29T15:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232804",
    "user": "jdemeyer"
}
```

Replying to [comment:15 vbraun]:
> Isn't that just a variant of increasing the count by an order of magnitude? Too slow.
Doing 10 tests (your commit) is fine, but doing *14 tests* (5 consequtive zeros in your example `[155189248, 0, 0, 0, 83886080, 0, 0, 0, 79691776, 0, 0, 0, 0, 0]` is an order of magnitude slower?



---

archive/issue_comments_232805.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-02-04T10:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232805",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_232806.json:
```json
{
    "body": "Please explain why 14 is an order of magnitude more than 10...",
    "created_at": "2015-02-04T10:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232806",
    "user": "jdemeyer"
}
```

Please explain why 14 is an order of magnitude more than 10...



---

archive/issue_comments_232807.json:
```json
{
    "body": "If you want to change the patch then be my guest, but I had enough of it.",
    "created_at": "2015-02-04T14:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232807",
    "user": "vbraun"
}
```

If you want to change the patch then be my guest, but I had enough of it.



---

archive/issue_comments_232808.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2015-02-04T14:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232808",
    "user": "vbraun"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_232809.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-02-05T10:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232809",
    "user": "jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_232810.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-05T10:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232810",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_232811.json:
```json
{
    "body": "Does this work for you?",
    "created_at": "2015-02-05T10:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232811",
    "user": "jdemeyer"
}
```

Does this work for you?



---

archive/issue_comments_232812.json:
```json
{
    "body": "I'm travelling right now so I can't test it on OSX, but it should fail as it ought to at least once print \"Leaked N bytes\" with N>0.\n\nAlso, the first couple of iterations will always succeed (even if there is a leak) as singular has pre-allocated buckets, and as long as you don't exhaust these no new memory will be allocated. At least in the original leak I did need the `leak(50000)` to fill these up.",
    "created_at": "2015-02-05T14:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232812",
    "user": "vbraun"
}
```

I'm travelling right now so I can't test it on OSX, but it should fail as it ought to at least once print "Leaked N bytes" with N>0.

Also, the first couple of iterations will always succeed (even if there is a leak) as singular has pre-allocated buckets, and as long as you don't exhaust these no new memory will be allocated. At least in the original leak I did need the `leak(50000)` to fill these up.



---

archive/issue_comments_232813.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-05T14:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232813",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232814.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-05T15:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232814",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_232815.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-08T15:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17429#issuecomment-232815",
    "user": "vbraun"
}
```

Resolution: fixed
