# Issue 23860: Broken paths in cython()'d modules

archive/issues_023860.json:
```json
{
    "body": "CC:  @jdemeyer @kiwifb\n\nKeywords: sageinspect cython cythonize\n\nAs discussed [on the mailing list](https://groups.google.com/d/msg/sage-release/r920G2EVTBU/1-Xk7ZIEAgAJ), when cythonizing a module, the hard-coded path to that file saved in the module is written as a relative path if the current working directory is somewhere along the path that the module file resides.\n\nThat is, if the cython module is at\n\n\n```\n/home/sage/.sage/temp/cython/mymodule.pyx\n```\n\n\nand the current working directory is `/home/sage`, then the module's path is written as\n\n\n```\n.sage/temp/cython/mymodule.pyx\n```\n\n.\n\nThis breaks `sage.misc.sageinspect._extract_embedded_position` which assumes that files generated with `cython()` are relative to the `SPYX_TMP` variable.\n\nThis could be considered a defect in Cython, but it's also easy to work around for now by chdir()-ing into the `SPYX_TMP` directory before running `cythonize()`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24097\n\n",
    "created_at": "2017-10-24T14:25:00Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Broken paths in cython()'d modules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23860",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer @kiwifb

Keywords: sageinspect cython cythonize

As discussed [on the mailing list](https://groups.google.com/d/msg/sage-release/r920G2EVTBU/1-Xk7ZIEAgAJ), when cythonizing a module, the hard-coded path to that file saved in the module is written as a relative path if the current working directory is somewhere along the path that the module file resides.

That is, if the cython module is at


```
/home/sage/.sage/temp/cython/mymodule.pyx
```


and the current working directory is `/home/sage`, then the module's path is written as


```
.sage/temp/cython/mymodule.pyx
```

.

This breaks `sage.misc.sageinspect._extract_embedded_position` which assumes that files generated with `cython()` are relative to the `SPYX_TMP` variable.

This could be considered a defect in Cython, but it's also easy to work around for now by chdir()-ing into the `SPYX_TMP` directory before running `cythonize()`.

Issue created by migration from https://trac.sagemath.org/ticket/24097





---

archive/issue_comments_334034.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-10-24T15:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334034",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_334035.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-24T15:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334035",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334036.json:
```json
{
    "body": "Marked as critical just because this regression prevents new builds of the docker container from being pushed, since the script that does so requires all tests to pass (though perhaps this requirement could be relaxed somewhat for pre-releases...)\n----\nNew commits:",
    "created_at": "2017-10-24T15:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334036",
    "user": "https://github.com/embray"
}
```

Marked as critical just because this regression prevents new builds of the docker container from being pushed, since the script that does so requires all tests to pass (though perhaps this requirement could be relaxed somewhat for pre-releases...)
----
New commits:



---

archive/issue_comments_334037.json:
```json
{
    "body": "Depends on #24088 only because I can't build without it.",
    "created_at": "2017-10-24T15:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334037",
    "user": "https://github.com/embray"
}
```

Depends on #24088 only because I can't build without it.



---

archive/issue_comments_334038.json:
```json
{
    "body": "missing `::` in the doc in sage inspect",
    "created_at": "2017-10-24T17:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334038",
    "user": "https://github.com/fchapoton"
}
```

missing `::` in the doc in sage inspect



---

archive/issue_comments_334039.json:
```json
{
    "body": "What does the docker container do differently that causes this bug to only appear there? Or in other words, how could I reproduce this bug?",
    "created_at": "2017-10-24T19:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334039",
    "user": "https://github.com/jdemeyer"
}
```

What does the docker container do differently that causes this bug to only appear there? Or in other words, how could I reproduce this bug?



---

archive/issue_comments_334040.json:
```json
{
    "body": "OK, after reading your mailing list post again, I understand the problem. It happens when you rundoctest from `$HOME`.\n\nBut I think the bug is really in `_extract_embedded_position`: it shouldn't assume that the path is relative to `SPYX_TMP`. In other words, the following patch also fixes the problem for me and I think it is a better solution:\n\n```diff\ndiff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py\nindex c8e79e0..2628e07 100644\n--- a/src/sage/misc/sageinspect.py\n+++ b/src/sage/misc/sageinspect.py\n@@ -222,10 +222,16 @@ def _extract_embedded_position(docstring):\n         return None\n \n     raw_filename = res.group('FILENAME')\n-    filename = os.path.join(SAGE_SRC, raw_filename)\n-    if not os.path.isfile(filename):\n-        from sage.misc.misc import SPYX_TMP\n-        filename = os.path.join(SPYX_TMP, '_'.join(raw_filename.split('_')[:-1]), raw_filename)\n+    if os.path.isfile(raw_filename):\n+        filename = os.path.abspath(raw_filename)\n+    else:\n+        # Maybe the path is relative to SAGE_SRC\n+        sagesrcfile = os.path.join(SAGE_SRC, raw_filename)\n+        if os.path.isfile(sagesrcfile):\n+            filename = sagesrcfile\n+        else:\n+            # No idea, keep raw path\n+            filename = raw_filename\n     lineno = int(res.group('LINENO'))\n     original = res.group('ORIGINAL')\n     return (original, filename, lineno)\n```\n",
    "created_at": "2017-10-24T20:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334040",
    "user": "https://github.com/jdemeyer"
}
```

OK, after reading your mailing list post again, I understand the problem. It happens when you rundoctest from `$HOME`.

But I think the bug is really in `_extract_embedded_position`: it shouldn't assume that the path is relative to `SPYX_TMP`. In other words, the following patch also fixes the problem for me and I think it is a better solution:

```diff
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index c8e79e0..2628e07 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -222,10 +222,16 @@ def _extract_embedded_position(docstring):
         return None
 
     raw_filename = res.group('FILENAME')
-    filename = os.path.join(SAGE_SRC, raw_filename)
-    if not os.path.isfile(filename):
-        from sage.misc.misc import SPYX_TMP
-        filename = os.path.join(SPYX_TMP, '_'.join(raw_filename.split('_')[:-1]), raw_filename)
+    if os.path.isfile(raw_filename):
+        filename = os.path.abspath(raw_filename)
+    else:
+        # Maybe the path is relative to SAGE_SRC
+        sagesrcfile = os.path.join(SAGE_SRC, raw_filename)
+        if os.path.isfile(sagesrcfile):
+            filename = sagesrcfile
+        else:
+            # No idea, keep raw path
+            filename = raw_filename
     lineno = int(res.group('LINENO'))
     original = res.group('ORIGINAL')
     return (original, filename, lineno)
```




---

archive/issue_comments_334041.json:
```json
{
    "body": "Hmm--I don't particularly like this either.  If I understand your point, it's that this code in `_extract_embedded_position` should be able to work on arbitrary modules.  But then, if it's a relative path, there's really know way of knowing where it's relative to.  In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.  How would this handle the case where it's relative to `SPYX_TMP`?\n\nThis `if os.path.isfile(raw_filename): filename = os.path.abspath(raw_filename)` works if the filename is already an absolute path *or* if the file is a relative path and we just happen to be in the directory it's relative to.  For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.\n\nI think for now my solution is better because it explicitly addresses correct handling of modules that were compiled by Sage's `cython()` function.",
    "created_at": "2017-10-25T08:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334041",
    "user": "https://github.com/embray"
}
```

Hmm--I don't particularly like this either.  If I understand your point, it's that this code in `_extract_embedded_position` should be able to work on arbitrary modules.  But then, if it's a relative path, there's really know way of knowing where it's relative to.  In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.  How would this handle the case where it's relative to `SPYX_TMP`?

This `if os.path.isfile(raw_filename): filename = os.path.abspath(raw_filename)` works if the filename is already an absolute path *or* if the file is a relative path and we just happen to be in the directory it's relative to.  For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.

I think for now my solution is better because it explicitly addresses correct handling of modules that were compiled by Sage's `cython()` function.



---

archive/issue_comments_334042.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> missing `::` in the doc in sage inspect\n\nOh I see what you're saying. I'll fix that.",
    "created_at": "2017-10-25T08:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334042",
    "user": "https://github.com/embray"
}
```

Replying to [comment:3 chapoton]:
> missing `::` in the doc in sage inspect

Oh I see what you're saying. I'll fix that.



---

archive/issue_comments_334043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-25T08:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334044.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.\n\nThat is not a wild guess. This is correct for functions in the Sage library, which is the most important use case.",
    "created_at": "2017-10-25T08:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334044",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 embray]:
> In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.

That is not a wild guess. This is correct for functions in the Sage library, which is the most important use case.



---

archive/issue_comments_334045.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.\n\nOK, I see your point and I agree.\n\nBut then I have some further comments:\n\n1. Instead of changing the directory to `target_dir` and then using some dubious code in `_extract_embedded_position` to reconstruct the path, why not change directory to some other directory (say `SAGE_LOCAL`) to force Cython to write an absolute path in the first place?\n\n2. Only the `cythonize()` call should be inside the `restore_cwd()` context, not the whole `try/except` block.",
    "created_at": "2017-10-25T09:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334045",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 embray]:
> For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.

OK, I see your point and I agree.

But then I have some further comments:

1. Instead of changing the directory to `target_dir` and then using some dubious code in `_extract_embedded_position` to reconstruct the path, why not change directory to some other directory (say `SAGE_LOCAL`) to force Cython to write an absolute path in the first place?

2. Only the `cythonize()` call should be inside the `restore_cwd()` context, not the whole `try/except` block.



---

archive/issue_comments_334046.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:6 embray]:\n> > In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.\n> \n> That is not a wild guess. This is correct for functions in the Sage library, which is the most important use case.\n\nSorry, I was unclear. It's not a \"wild guess\" and I agree that part of the code is actually fine.  All I meant was that it's still a *heuristic* approach that can in theory be wrong (but probably isn't).",
    "created_at": "2017-10-25T09:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334046",
    "user": "https://github.com/embray"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:6 embray]:
> > In fact it's making a wild guess when it checks if it's relative to `SAGE_SRC`.
> 
> That is not a wild guess. This is correct for functions in the Sage library, which is the most important use case.

Sorry, I was unclear. It's not a "wild guess" and I agree that part of the code is actually fine.  All I meant was that it's still a *heuristic* approach that can in theory be wrong (but probably isn't).



---

archive/issue_comments_334047.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> Replying to [comment:6 embray]:\n> > For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.\n> \n> OK, I see your point and I agree.\n> \n> But then I have some further comments:\n> \n> 1. Instead of changing the directory to `target_dir` and then using some dubious code in `_extract_embedded_position` to reconstruct the path, why not change directory to some other directory (say `SAGE_LOCAL`) to force Cython to write an absolute path in the first place?\n\nI considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.\n\n> 2. Only the `cythonize()` call should be inside the `restore_cwd()` context, not the whole `try/except` block.\n\nHeh, I actually had a small debate with myself about this.  I'm not saying I disagree but why do you think it should be inverted?",
    "created_at": "2017-10-25T09:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334047",
    "user": "https://github.com/embray"
}
```

Replying to [comment:10 jdemeyer]:
> Replying to [comment:6 embray]:
> > For example, you could `cython()` a function, then change directories, then try to inspect the function and this would fail.
> 
> OK, I see your point and I agree.
> 
> But then I have some further comments:
> 
> 1. Instead of changing the directory to `target_dir` and then using some dubious code in `_extract_embedded_position` to reconstruct the path, why not change directory to some other directory (say `SAGE_LOCAL`) to force Cython to write an absolute path in the first place?

I considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.

> 2. Only the `cythonize()` call should be inside the `restore_cwd()` context, not the whole `try/except` block.

Heh, I actually had a small debate with myself about this.  I'm not saying I disagree but why do you think it should be inverted?



---

archive/issue_comments_334048.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> I'm not saying I disagree but why do you think it should be inverted?\n\nBecause it is easier to understand if the minimal amount of code is inside the context. Otherwise, you give the impression that the `except:` block should be executed also in a specific directory.",
    "created_at": "2017-10-25T09:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334048",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 embray]:
> I'm not saying I disagree but why do you think it should be inverted?

Because it is easier to understand if the minimal amount of code is inside the context. Otherwise, you give the impression that the `except:` block should be executed also in a specific directory.



---

archive/issue_comments_334049.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> I considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.\n\nIdeally, Cython should just use absolute paths. That was, no hacks in `_extract_embedded_position` are needed.",
    "created_at": "2017-10-25T09:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334049",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 embray]:
> I considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.

Ideally, Cython should just use absolute paths. That was, no hacks in `_extract_embedded_position` are needed.



---

archive/issue_comments_334050.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Replying to [comment:12 embray]:\n> > I considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.\n> \n> Ideally, Cython should just use absolute paths. That was, no hacks in `_extract_embedded_position` are needed.\n\nWell, yes, but we need this worked around now and I don't want to wait for/depend on a fix to Cython.",
    "created_at": "2017-10-25T10:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334050",
    "user": "https://github.com/embray"
}
```

Replying to [comment:14 jdemeyer]:
> Replying to [comment:12 embray]:
> > I considered that, but it seemed like *more* of a hack around Cython.  The current approach feels more explicit, along the lines of how we guess a path might be relative to `SAGE_SRC`.  I'd be fine with either approach if you have strong feelings about it but I like this better and I don't think it's all that dubious.
> 
> Ideally, Cython should just use absolute paths. That was, no hacks in `_extract_embedded_position` are needed.

Well, yes, but we need this worked around now and I don't want to wait for/depend on a fix to Cython.



---

archive/issue_comments_334051.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Replying to [comment:12 embray]:\n> > I'm not saying I disagree but why do you think it should be inverted?\n> \n> Because it is easier to understand if the minimal amount of code is inside the context. Otherwise, you give the impression that the `except:` block should be executed also in a specific directory.\n\nTrue, but you could also argue the other way around it makes less clear exactly what the exception handling pertains to.  In this case it's clear enough, but it's also just as clear that there's nothing in the exception handling that's dependent on the current directory.  \n\nPerhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.  I just added it because I've written the same context manager almost every time I've wanted some code that temporarily changes directories.",
    "created_at": "2017-10-25T10:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334051",
    "user": "https://github.com/embray"
}
```

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 embray]:
> > I'm not saying I disagree but why do you think it should be inverted?
> 
> Because it is easier to understand if the minimal amount of code is inside the context. Otherwise, you give the impression that the `except:` block should be executed also in a specific directory.

True, but you could also argue the other way around it makes less clear exactly what the exception handling pertains to.  In this case it's clear enough, but it's also just as clear that there's nothing in the exception handling that's dependent on the current directory.  

Perhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.  I just added it because I've written the same context manager almost every time I've wanted some code that temporarily changes directories.



---

archive/issue_comments_334052.json:
```json
{
    "body": "Replying to [comment:16 embray]:\n> Perhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.\n\nActually, that makes a lot of sense here, especially because we already have a `try` block.",
    "created_at": "2017-10-25T10:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334052",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 embray]:
> Perhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.

Actually, that makes a lot of sense here, especially because we already have a `try` block.



---

archive/issue_comments_334053.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Replying to [comment:16 embray]:\n> > Perhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.\n> \n> Actually, that makes a lot of sense here, especially because we already have a `try` block.\n\nIndeed; I'll just drop the context manager for now and maybe it add it back in later.",
    "created_at": "2017-10-25T10:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334053",
    "user": "https://github.com/embray"
}
```

Replying to [comment:17 jdemeyer]:
> Replying to [comment:16 embray]:
> > Perhaps in a case like this the context manager is almost more of a distraction and deserves to be simply a `finally:` statement.
> 
> Actually, that makes a lot of sense here, especially because we already have a `try` block.

Indeed; I'll just drop the context manager for now and maybe it add it back in later.



---

archive/issue_comments_334054.json:
```json
{
    "body": "On second thought, I ended up keeping the context manager as a utility, as it's useful for implementing the regression test (indeed most of the times I find myself in need of such a utility it's for testing).  So I only used it in the doctest for now.",
    "created_at": "2017-10-25T11:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334054",
    "user": "https://github.com/embray"
}
```

On second thought, I ended up keeping the context manager as a utility, as it's useful for implementing the regression test (indeed most of the times I find myself in need of such a utility it's for testing).  So I only used it in the doctest for now.



---

archive/issue_comments_334055.json:
```json
{
    "body": "Kept basically the same logic in sageinspect for now, but I think clarified the approach somewhat.  Still open to other ideas, including just forcing Cython to write an absolute path. \n----\nNew commits:",
    "created_at": "2017-10-25T11:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334055",
    "user": "https://github.com/embray"
}
```

Kept basically the same logic in sageinspect for now, but I think clarified the approach somewhat.  Still open to other ideas, including just forcing Cython to write an absolute path. 
----
New commits:



---

archive/issue_comments_334056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-25T11:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334057.json:
```json
{
    "body": "Funny that you put `os.chdir(target_dir)` inside the `try`. I remember a long discussion about that :-)",
    "created_at": "2017-10-25T11:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334057",
    "user": "https://github.com/jdemeyer"
}
```

Funny that you put `os.chdir(target_dir)` inside the `try`. I remember a long discussion about that :-)



---

archive/issue_comments_334058.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Funny that you put `os.chdir(target_dir)` inside the `try`. I remember a long discussion about that :-)\n\nI thought about that....  I did it because I didn't want to have the discussion again.",
    "created_at": "2017-10-25T12:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334058",
    "user": "https://github.com/embray"
}
```

Replying to [comment:23 jdemeyer]:
> Funny that you put `os.chdir(target_dir)` inside the `try`. I remember a long discussion about that :-)

I thought about that....  I did it because I didn't want to have the discussion again.



---

archive/issue_comments_334059.json:
```json
{
    "body": "So is this fine for now?",
    "created_at": "2017-10-25T12:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334059",
    "user": "https://github.com/embray"
}
```

So is this fine for now?



---

archive/issue_comments_334060.json:
```json
{
    "body": "Replying to [comment:25 embray]:\n> So is this fine for now?  \n\nI still think that this would be better fixed upstream in Cython (I just wrote to cython-devel about it). How important/urgent is this ticket?",
    "created_at": "2017-10-25T12:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334060",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 embray]:
> So is this fine for now?  

I still think that this would be better fixed upstream in Cython (I just wrote to cython-devel about it). How important/urgent is this ticket?



---

archive/issue_comments_334061.json:
```json
{
    "body": "It is urgent because it's a regression in the tests.  With the fix the overall approach is no better/worse than it was before except that it doesn't break due to the user's current directory so it's an obvious improvement.",
    "created_at": "2017-10-25T12:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334061",
    "user": "https://github.com/embray"
}
```

It is urgent because it's a regression in the tests.  With the fix the overall approach is no better/worse than it was before except that it doesn't break due to the user's current directory so it's an obvious improvement.



---

archive/issue_comments_334062.json:
```json
{
    "body": "In other words, I'm going to change the default behavior of the docker images just to work around a minor regression in the test suite that is demonstrably fixed.",
    "created_at": "2017-10-25T12:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334062",
    "user": "https://github.com/embray"
}
```

In other words, I'm going to change the default behavior of the docker images just to work around a minor regression in the test suite that is demonstrably fixed.



---

archive/issue_comments_334063.json:
```json
{
    "body": "I can live with this as work-around. I still think that it should be fixed in a better way in the future.\n\nDid you verify that your docker image works with the latest version of this ticket?",
    "created_at": "2017-10-25T12:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334063",
    "user": "https://github.com/jdemeyer"
}
```

I can live with this as work-around. I still think that it should be fixed in a better way in the future.

Did you verify that your docker image works with the latest version of this ticket?



---

archive/issue_comments_334064.json:
```json
{
    "body": "Yes, in fact that was the first place I tested it.  Feel free to open a follow-up ticket if you think it should be updated later.",
    "created_at": "2017-10-25T12:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334064",
    "user": "https://github.com/embray"
}
```

Yes, in fact that was the first place I tested it.  Feel free to open a follow-up ticket if you think it should be updated later.



---

archive/issue_comments_334065.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-25T12:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334065",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334066.json:
```json
{
    "body": "Sorry, one final detail: I don't like to add more stuff to `sage.misc.misc`. Would you agree to add `restore_cwd` to `sage.misc.sage_ostools` (or some other more specific module)?",
    "created_at": "2017-10-26T08:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334066",
    "user": "https://github.com/jdemeyer"
}
```

Sorry, one final detail: I don't like to add more stuff to `sage.misc.misc`. Would you agree to add `restore_cwd` to `sage.misc.sage_ostools` (or some other more specific module)?



---

archive/issue_comments_334067.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-10-26T08:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334067",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_334068.json:
```json
{
    "body": "I certainly don't mind moving it (I would suggest breaking up `sage.misc.misc` even further eventually).  I just wasn't sure where would be better.  I don't know about `sage_ostools` (do we really need \"sage\" in the name of that module? It seems superfluous...)\n\nInstead ISTM there's a case for some kind of `pathutils` module for filename/path-related utilities.",
    "created_at": "2017-10-26T10:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334068",
    "user": "https://github.com/embray"
}
```

I certainly don't mind moving it (I would suggest breaking up `sage.misc.misc` even further eventually).  I just wasn't sure where would be better.  I don't know about `sage_ostools` (do we really need "sage" in the name of that module? It seems superfluous...)

Instead ISTM there's a case for some kind of `pathutils` module for filename/path-related utilities.



---

archive/issue_comments_334069.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-10-27T10:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334069",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_334070.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-10-27T10:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334070",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_334071.json:
```json
{
    "body": "Moved to `sage_ostools`.",
    "created_at": "2017-10-27T10:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334071",
    "user": "https://github.com/jdemeyer"
}
```

Moved to `sage_ostools`.



---

archive/issue_comments_334072.json:
```json
{
    "body": "I'm not crazy about \"sage_ostools\", but whatever works.",
    "created_at": "2017-10-27T12:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334072",
    "user": "https://github.com/embray"
}
```

I'm not crazy about "sage_ostools", but whatever works.



---

archive/issue_comments_334073.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-30T07:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23860#issuecomment-334073",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
