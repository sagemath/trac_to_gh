# Issue 30179: Make tox a standard package

Issue created by migration from https://trac.sagemath.org/ticket/30416

Original creator: mkoeppe

Original creation time: 2020-08-21 17:43:03

CC:  jhpalmieri @tobiasdiez chapoton slelievre mjo

see #30410; this will need a discussion/vote at sage-devel.


---

Comment by mkoeppe created at 2020-09-09 17:03:44

New commits:


---

Comment by mkoeppe created at 2020-09-09 17:03:44

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-09-09 18:19:34

Should there also be an `spkg-configure.m4` file? (As a policy issue, should all new standard packages be encouraged, required if at all possible, to have such files, to try to maintain the momentum toward working well with distros?)


---

Comment by mkoeppe created at 2020-09-09 18:21:01

That's a good idea, and I would support adding this policy too.


---

Comment by mkoeppe created at 2020-09-09 18:21:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-09-09 21:02:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-09 21:07:46

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-09-09 21:34:06

Replying to [comment:6 mkoeppe]:
> That's a good idea, and I would support adding this policy too.

See #30543 for documentation for spkg-configure.m4 and the statement of this policy.


---

Comment by jhpalmieri created at 2020-09-09 22:41:34

We're missing some dependencies:

```
install_requires = 
	filelock>=3.0.0
	packaging>=14
	pluggy>=0.12.0
	py>=1.4.17
	six>=1.14.0 # required when virtualenv>=20
	toml>=0.9.4
        virtualenv!=20.0.0,!=20.0.1,!=20.0.2,!=20.0.3,!=20.0.4,!=20.0.5,!=20.0.6,!=20.0.7,>=16.0.0
	colorama>=0.4.1 ;platform_system=="Windows"
	importlib-metadata>=0.12,<2;python_version<"3.8"
```

When I run `./sage --tox --version`, I get

```
ModuleNotFoundError: No module named 'pluggy'
```



---

Comment by mkoeppe created at 2020-09-10 00:00:35

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-09-10 00:00:35

Indeed, thanks for catching this.


---

Comment by git created at 2020-09-10 00:41:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-12-27 18:07:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-27 18:29:03

Added these dependencies using the new tool described at https://wiki.sagemath.org/ReleaseTours/sage-9.3#For_developers:_Setting_up_Python_packages_from_PyPI_as_Sage_packages

Untested so far - possibly needs more dependencies

And probably the dependencies that are only needed by `tox` should be marked as not required if system tox is found.


---

Comment by mkoeppe created at 2021-01-02 04:23:15

`virtualenv` has the following additional dependencies:

```
        appdirs>=1.4.3,<2
        distlib>=0.3.1,<1
        filelock>=3.0.0,<4
        six>=1.9.0,<2   # keep it >=1.9.0 as it may cause problems on LTS platforms
        importlib-metadata>=0.12;python_version<"3.8"
        importlib-resources>=1.0;python_version<"3.7"
```



---

Comment by git created at 2021-01-02 04:39:11

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-05-27 22:52:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-05-27 23:11:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-27 23:12:55

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-05-28 05:27:16

`py` doesn't build for me; even if it did, it looks like it's trying to download things at the start of its build process. Log attached.


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-05-28 16:50:33

It's a little unfortunate that the top-level `configure` recognizes that

```
configure:38013: checking for tox >= 2.5.0
configure:38096: result: /usr/local/bin/tox
configure:38107: will use system package and not install SPKG tox
```

but our build system isn't smart enough to skip its dependencies.


---

Comment by mkoeppe created at 2021-05-28 16:55:36

Great point! I'll see what I can do about this


---

Comment by git created at 2021-05-29 00:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-29 01:06:52

Here's something that will avoid installing 4 packages in this case:
- `appdirs`, `distlib`, `filelock`, `virtualenv`

I haven't added the same logic to the other packages:
- `pluggy`, `py`, `toml` -- because they will also be needed as dependencies of `pytest` (see #31110)
- `importlib_resources` -- because it is useful as a backport package (see #31306)


---

Comment by jhpalmieri created at 2021-05-31 03:53:25

Okay, thanks, looks good.


---

Comment by jhpalmieri created at 2021-05-31 03:53:25

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-05-31 05:32:42

Thanks!


---

Comment by vbraun created at 2021-06-20 08:14:31

Resolution: fixed


---

Comment by @kliem created at 2021-06-22 09:00:47

Replying to [comment:26 jhpalmieri]:
> `py` doesn't build for me; even if it did, it looks like it's trying to download things at the start of its build process. Log attached.

What was the resolution to this?

I'm getting build failure of sage because of this now. It's not terrible and I guess `py` isn't needed by anything. But I'm also wondering, why it is a dependency of `tox` and `pytest` in the first place. Neither of them lists `py` as a dependency. Where do we use it?


---

Comment by mkoeppe created at 2021-06-22 13:41:09

Replying to [comment:35 gh-kliem]:
> Replying to [comment:26 jhpalmieri]:
> > `py` doesn't build for me; even if it did, it looks like it's trying to download things at the start of its build process. Log attached.
> 
> What was the resolution to this?

The missing dependency on `setuptools_scm` was added

> I'm getting build failure of sage because of this now. It's not terrible and I guess `py` isn't needed by anything. But I'm also wondering, why it is a dependency of `tox` and `pytest` in the first place. Neither of them lists `py` as a dependency. Where do we use it?

It's an `install_requires` of tox: https://github.com/tox-dev/tox/blob/master/setup.cfg
