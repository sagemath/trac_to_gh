# Issue 30558: bootstrap-clean must remove src/bin/sage-env-config

Issue created by migration from https://trac.sagemath.org/ticket/30795

Original creator: dimpase

Original creation time: 2020-10-19 12:46:46

CC:  vbraun mjo mkoeppe

Otherwise on partially configured trees this might be a problem.
Here is a reproduction of a real bug I hit with a student today

```
dima@hilbert /mnt/opt/Sage/sage-clang $ echo Foo > src/bin/sage-env-config
dima@hilbert /mnt/opt/Sage/sage-clang $ make bootstrap-clean 
...
dima@hilbert /mnt/opt/Sage/sage-clang $ ./bootstrap 
rm -rf config configure build/make/Makefile-auto.in
rm -f src/doc/en/installation/*.txt
rm -rf src/doc/en/reference/spkg/*.rst
rm -f src/doc/en/reference/repl/*.txt
src/bin/sage-env-config: line 1: Foo: command not found
must source sage-env-config before sage-env
src/doc/bootstrap:56: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt
src/doc/bootstrap:56: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt
src/doc/bootstrap:56: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt
src/doc/bootstrap:56: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt
src/doc/bootstrap:56: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt
src/doc/bootstrap:65: installing src/doc/en/reference/spkg/*.rst
src/doc/bootstrap:97: installing src/doc/en/reference/repl/options.txt
/mnt/opt/Sage/sage-clang/src/bin/sage-env-config: line 1: Foo: command not found
must source sage-env-config before sage-env
Error setting environment variables by sourcing '/mnt/opt/Sage/sage-clang/src/bin/sage-env';
possibly contact sage-devel (see http://groups.google.com/group/sage-devel).
```



---

Comment by dimpase created at 2020-10-19 12:51:51

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-10-19 17:37:52

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2020-10-19 17:37:52

This does not seem to be the right branch


---

Comment by git created at 2020-10-19 19:09:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-10-19 19:10:51

should be ok now,
sorry for pushing this branch from a wrong window.


---

Comment by mkoeppe created at 2020-10-19 19:28:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-10-24 11:08:39

Better development experience can't be a blocker


---

Comment by vbraun created at 2020-10-24 11:08:39

Changing priority from blocker to major.


---

Comment by mkoeppe created at 2020-10-31 22:19:24

Changing priority from major to critical.


---

Comment by vbraun created at 2020-11-01 00:42:19

Resolution: fixed


---

Comment by vbraun created at 2020-11-01 01:00:18

Resolution changed from fixed to 


---

Comment by vbraun created at 2020-11-01 01:00:18

This breaks `make clean && ./sage -sdist`, which is what I'm using to create the source tarballs. One could require to first build Sage before making source tarballs, but I think thats a) complicated and b) error-prone as build artifacts going to sneak into source tarballs.


---

Comment by vbraun created at 2020-11-01 01:00:18

Changing status from closed to new.


---

Comment by dimpase created at 2020-11-01 09:35:32

Replying to [comment:10 vbraun]:
> This breaks `make clean && ./sage -sdist`, which is what I'm using to create the source tarballs. One could require to first build Sage before making source tarballs, but I think thats a) complicated and b) error-prone as build artifacts going to sneak into source tarballs.

but `sage-env-config` **is** a build artefact!


---

Comment by dimpase created at 2020-11-01 10:01:22

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-11-01 10:01:22

Replying to [comment:10 vbraun]:
> This breaks `make clean && ./sage -sdist`, which is what I'm using to create the source tarballs. One could require to first build Sage before making source tarballs,

no, why? All `sdist` needs is to know SAGE_ROOT and SAGE_SRC - and this info definitely does not need Sage to be built.
I.e.

```
make clean && SAGE_ROOT=`pwd` SAGE_SRC=`pwd`/src ./sage -sdist
```

should work for you. If we really must, we can provide such defaults in `build/bin/sage-sdist`.

Please tell us how we should proceed here.


---

Comment by vbraun created at 2020-11-01 12:59:43

sage -sdist should work without setting environment variables. The path could also be hardcoded in the sage launcher script.


---

Comment by mkoeppe created at 2020-11-01 16:15:21

Volker, is having `SAGE_SRC` configurable by environment setting needed for your release management scripts? Otherwise I would suggest that we get rid of this configuration option.


---

Comment by mkoeppe created at 2020-11-01 16:20:16

The problem reported on the original ticket description is fixed in #30841.

But I think it's time to clean up the `-clean` targets - see #21566, #21775.


---

Comment by mkoeppe created at 2020-11-17 07:38:07

Changing priority from critical to major.


---

Comment by dimpase created at 2021-01-18 17:25:50

is this already merged? Can it be closed, or?


---

Comment by mkoeppe created at 2021-01-18 17:46:30

I think it can be closed.


---

Comment by dimpase created at 2021-01-18 19:19:20

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-06-06 15:10:37

Resolution: duplicate
