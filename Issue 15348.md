# Issue 15348: Random failure in SimplicialComplex.is_cohen_macaulay

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2013-12-25 12:32:04

CC:  jdemeyer roed slabbe

This is fairly unlikely but occasionally comes up on the buildbot:

```
sage -t --long src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2236, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay
Failed example:
    S.is_cohen_macaulay(ncpus=3)
Expected:
    False
Got:
    [Errno 2] No such file or directory: '/home/buildbot/build/sage/snapperkob/sage_git/dot_sage/temp/snapperkob/10634/dir_n0BDmn/10759.out'
    False
```

Apparently the code uses `@`parallel and there was already a race fixed in #14150.


---

Comment by vbraun created at 2013-12-25 12:32:29

Full log (but really nothing interesting) at http://build.sagemath.org/sage/builders/%20%20fast%20AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29%20incremental/builds/28/steps/shell_3/logs/stdio


---

Comment by vbraun created at 2013-12-25 12:34:50

My guess would be that forke'd process writes temp file, and parent tries to read it after the fork quits. That is inherently racy since the sage cleaner will attempt to delete the child's temp files as it has another pid.


---

Comment by vbraun created at 2014-07-25 05:00:16

Changing keywords from "" to "random_fail".


---

Comment by vbraun created at 2015-11-09 04:29:19

Still happens occasionally


---

Comment by leif created at 2016-07-31 09:06:41

Seen this today for the first ever I think.  (Sage 7.3.rc0)


---

Comment by leif created at 2016-07-31 09:14:33

Replying to [comment:8 leif]:
> Seen this today for the first ever I think.  (Sage 7.3.rc0)

P.S.:  Same error, different test:

```
sage -t --long --warn-long 68.2 src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2813, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay
Failed example:
    X.is_cohen_macaulay(ZZ)
Expected:
    False
Got:
    [Errno 2] No such file or directory: '/home/leif/.sage/temp/tunguska/16183/dir_5o8pnH/16223.out'
    False
**********************************************************************
```



---

Comment by jhpalmieri created at 2016-07-31 17:28:59

I've seen this a few times recently, too.


---

Comment by dimpase created at 2017-02-02 16:14:13

still there in 7.5 and [7.6.betas](https://groups.google.com/d/msg/sage-release/TMI3trb0G74/8z7F8V52DgAJ).


---

Comment by jhpalmieri created at 2017-02-24 20:58:21

I wonder if it would help if the tests all used just 1 CPU.


---

Comment by jdemeyer created at 2017-02-25 07:12:00

Replying to [comment:13 jhpalmieri]:
> I wonder if it would help if the tests all used just 1 CPU.

Maybe, but that's not fixing the problem, just hiding it.

If you want to "fix" the problem but not hide it, just add `# known bug`.


---

Comment by dimpase created at 2017-02-25 12:11:38

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 jhpalmieri]:
> > I wonder if it would help if the tests all used just 1 CPU.
> 
> Maybe, but that's not fixing the problem, just hiding it.
> 
> If you want to "fix" the problem but not hide it, just add `# known bug`.

at least it would be good to know what part of the code in question writes temp files with extension .out
(In my admittedly limited experience with parallel code I never saw slaves doing any file I/O; if they do they ought to clean up after themselves, otherwise there is not telling as to what will happen)


---

Comment by jhpalmieri created at 2017-02-25 15:56:09

It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.


---

Comment by dimpase created at 2017-02-26 20:31:53

Replying to [comment:16 jhpalmieri]:
> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.

As a rule, I get it on a gentoo linux laptop, running on a 4-core Intel i7, and the usual ext4 file systems on an SSD.


---

Comment by jdemeyer created at 2017-02-27 16:07:47

See #22462.


---

Comment by slabbe created at 2017-07-04 15:39:40

Replying to [comment:16 jhpalmieri]:
> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.

I almost always get this problem when running `MAKE='make -j8' make ptestlong` on a Ubuntu 16.04, with 8 cpus, with file system ext4.

I am now running `make testlong` in serially to see the difference.


---

Comment by slabbe created at 2017-07-05 19:05:08

> I am now running `make testlong` in serially to see the difference.

I get `All tests passed!` with `make testlong`.


---

Comment by jdemeyer created at 2017-07-07 08:13:08

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-07-07 08:13:08

New commits:


---

Comment by slabbe created at 2017-07-11 13:32:20

On a machine that almost always gives the error on `is_cohen_macaulay`, I get `All tests passed!` on a single run of `MAKE='make -j6' make ptestlong`.


---

Comment by slabbe created at 2017-07-11 16:04:38

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2017-07-11 16:04:38

On a second run of `make ptestlong`, I still do not get the error. -> Great! Positive review.


---

Comment by embray created at 2017-07-17 08:48:54

Thanks for investigating this.  I've been seeing this problem too, but thought it was a weird case of the sage-cleaner being overly aggressive for some reason.


---

Comment by vbraun created at 2017-07-26 22:13:04

Resolution: fixed
