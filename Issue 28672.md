# Issue 28672: Allow overriding "when building, check that user isn't root" for use in Docker containers

Issue created by migration from https://trac.sagemath.org/ticket/28909

Original creator: mkoeppe

Original creation time: 2019-12-25 20:49:51

CC:  fbissey jhpalmieri dimpase vbraun jdemeyer saraedum

#17420 added `AX_CHECK_ROOT`, which refuses to configure a sage build as root, as a safety measure protecting users from getting themselves into trouble with `sudo make`.

On containers, however, building as root is quite natural, and we should provide an option ``--enable-user-0`` (and fix all related build system bugs...)
This would allow us to simplify `docker/Dockerfile`, which currently works around it: 

```
# Sage refuses to build as root, so we add a "sage" user that can sudo without a password.
# We also want this user at runtime as some commands in sage know about the user that was used during build.
ARG HOME=/home/sage
RUN adduser --quiet --shell /bin/bash --gecos "Sage user,101,," --disabled-password --home "$HOME" sage \
    && echo "sage ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/01-sage \
    && chmod 0440 /etc/sudoers.d/01-sage
# Run everything from now on as the sage user in sage's home
USER sage
ENV HOME $HOME
```

For example, GitHub Actions do not like Docker containers that make use of the `USER` command:  https://help.github.com/en/actions/automating-your-workflow-with-github-actions/virtual-environments-for-github-hosted-runners#docker-container-filesystem


Reported build failures as root user:
- https://groups.google.com/forum/#!searchin/sage-devel/17420%7Csort:date/sage-devel/kBMh22r1E90/LdZkK2JMoMIJ


---

Comment by mkoeppe created at 2019-12-26 17:27:07

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2019-12-26 17:27:07

New commits:


---

Comment by saraedum created at 2019-12-26 17:35:45

Is there some other way we can work around the [GitHub](GitHub) Actions problem? Afaik it's considered bad (though common) practice to run processes inside containers as root.


---

Comment by vbraun created at 2019-12-26 21:22:31

Bad but common practice nicely sums up the current state of affairs...


---

Comment by vbraun created at 2019-12-27 09:22:02

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2019-12-28 15:54:09

Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.

~~What's the situation with [GitHub](GitHub) Actions exactly? They ignore `USER` or they do not allow it at all? If they just ignore it, can we `su` to `sage` in our entrypoint if we happen to be root?~~

So, problem seems to be that `GITHUB_WORKSPACE` is owned by `root`. If you are not root you do not get access to that. I don't know enough about [GitHub](GitHub) Actions but it seems that their interface is very limited, so you don't get to change the `USER`. (And you also don't get to run an initialization container that could `chmod` the workspace.)


---

Comment by mkoeppe created at 2019-12-28 16:23:17

Replying to [comment:8 saraedum]:
> Thanks for adding this configuration option. It makes sense to be able to override this. However, I don't think we should change our docker images to run as root. It might be helpful for some people but at the same time it creates a problem for other use cases.

I think in this discussion, one should distinguish building sage from running sage:
- I think building sage as root in the container is unproblematic.
- A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... 
- There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)


---

Comment by saraedum created at 2019-12-28 17:20:04

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 saraedum]:
> I think in this discussion, one should distinguish building sage from running sage:
True.

> - I think building sage as root in the container is unproblematic.

Yes, but it probably does not win you much.

> - A docker image intended to provide a ready to use jupyter server clearly has no business of running that sever as root; in fact, perhaps it should actually be running as a less privileged user than the one that owns the sage installation... 

Some people want to be able to pip install things for example. For this it makes sense to own the Sage installation. (without being root.)

> - There is value in having a Docker image in which sagemath is installed as root in `/usr/local` and no special preparations such as users or entrypoints are made. This image would then be easy to use in [GitHub](GitHub) actions or similar contexts. (Right now I am using conda to set up such a Docker image for my purposes - but it would be nice to have an official Docker image of sagemath that is built from source.)

I agree but having a separate image comes at a significant maintenance cost.


---

Comment by chapoton created at 2020-01-01 21:02:12

What is the intended meaning of positive review for a sage-wishlist ticket ?


---

Comment by mkoeppe created at 2020-01-02 14:56:13

Replying to [comment:11 chapoton]:
> What is the intended meaning of positive review for a sage-wishlist ticket ?
I think it means "wish granted".


---

Comment by vbraun created at 2020-01-09 23:44:25

Resolution: fixed
