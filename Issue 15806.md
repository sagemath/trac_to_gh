# Issue 15806: Hilbert Symbol introduces bugs from Pari

Issue created by migration from Trac.

Original creator: annahaensch

Original creation time: 2014-04-01 18:02:55

For a field F and for a prime p, ( , )_p denotes the Hilbert Symbol over F localized at p.  It is well known that (a,b)_p*(a,c)_p=(a,bc)_p for any a, b in F (cf O'meara 63:12).  But I'm getting:


```
sage: K.<a>=NumberField(x^2+5)
sage: p=K.primes_above(2)[0];p
Fractional ideal (2, a + 1)
sage: K.hilbert_symbol(2*a,-1,p)
1
sage: K.hilbert_symbol(2*a,2,p)
1
sage: K.hilbert_symbol(2*a,-2,p)
-1
```


Performing the same calculations using pari commands yields the same results -- unsurprising since hilbert_symbol just calls pari's nfhilbert():



```
sage: p
Fractional ideal (2, a + 1)
sage: q=p.pari_prime()
sage: pari(K).nfhilbert(2*a,-1,p.pari_prime())
1
sage: pari(K).nfhilbert(2*a,2,p.pari_prime())
1
sage: pari(K).nfhilbert(2*a,-2,p.pari_prime())
-1
```



So it looks like pari is introducing the bug.  Checking against Magma gives 1,-1,-1 respectively for the three Hilbert symbols, which is what you would expect to get.


---

Comment by pbruin created at 2014-04-01 19:42:24

By the basic properties of the Hilbert symbol, (2, -1)<sub>_p_</sub> = (2, 2)<sub>_p_</sub> = (2, -2)<sub>_p_</sub> = 1 for any _p_.  Hence if _p_ is the unique prime dividing 2 in _K_, some other correct values are
* (_a_, 2)<sub>_p_</sub> = -1
* (_a_, -2)<sub>_p_</sub> = -1
* (_a_, -1)<sub>_p_</sub> = 1
PARI also computes (_a_, 2)<sub>_p_</sub> incorrectly.  In the latest version of PARI/GP (2.7.0, not yet in Sage), one has

```
gp > K=nfinit(x^2+5);
gp > p=idealfactor(K,2)[1,1];
gp > a=Mod(x,K.pol);
gp > nfhilbert(K,a,2,p)
%4 = 1  # should be -1
gp > nfhilbert(K,a,-2,p)
%5 = -1
gp > nfhilbert(K,a,-1,p)
%6 = 1
```

Have you reported the bug to the PARI developers?  (See `http://pari.math.u-bordeaux.fr/Bugs/Reporting.html` for how to do this.)


---

Comment by annahaensch created at 2014-04-02 06:45:29

I reported the bug to pari and it has been fixed.  So I guess now we just have to wait for the next pari update in sage.


---

Comment by annahaensch created at 2014-04-02 08:41:03

Changing status from new to needs_review.


---

Comment by pbruin created at 2014-04-02 09:20:22

It would be good to add this example as a doctest to `NumberField.hilbert_symbol()`.  A PARI upgrade is done in #15767, but we may have to add the fix as a patch depending on whether it will be fixed in the version used there.


---

Comment by pbruin created at 2014-04-02 09:20:22

Changing status from needs_review to needs_work.


---

Comment by annahaensch created at 2014-04-02 11:55:44

The fix won't be implemented into the pari until the release of 2.8 (I confirmed this with Bill Allombert), so it will take some time for this piece to work it's way into Sage.  And so I agree, the best thing to do is to build a patch to fix the bug, but I'm not sure how to do that.  

In the meantime, I will add my example as a doctest to the current NumberField.py file.  That patch will be forthcoming.


---

Comment by annahaensch created at 2014-04-02 15:34:20

Adds incorrect hilbert_symbol outputs to doctest


---

Attachment

Sorry, my last comment wasn't very clear.  I meant to say that this ticket should stay open until the bug is fixed (either directly in a PARI release, via a patch in the PARI package that Sage uses, or via a workaround in the Sage library), and that the doctest should check that the bug is fixed, i.e. that the output of `hilbert_symbol()` is mathematically correct.

I read Bill Allombert's reply at `http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1561`; I would interpret it as saying that _automatically_ it is only guaranteed to be fixed in 2.8, but if it is considered serious enough (which would be logical given that it is a mathematical error) it might also be included in the next stable bugfix release, which is 2.7.1.  In the latter case, Sage should be able to profit from it soon.


---

Comment by annahaensch created at 2014-04-03 08:39:06

I see.  That makes a lot of sense.  I wasn't sure if Sage only updated PARI at major releases or along the way.  In that case, maybe there is not such a great urgency to patch a fix into sage since we should see it reflected soon enough.  

Then just to be clear, should I change the current doctest to reflect the mathematically correct answer, i.e., 



```
sage: K.<a>=NumberField(x^2+5)
sage: p=K.primes_above(2)[0];p
Fractional ideal (2, a + 1)
sage: K.hilbert_symbol(2*a,-1,p)
1
sage: K.hilbert_symbol(2*a,2,p)
-1
sage: K.hilbert_symbol(2*a,-2,p)
-1
```


So that doctests return errors only until the bug is fixed?  And after that point it will just be another nice correct example?  Thanks for the helpful comments!


---

Attachment

Use instead of trac_16043.patch


---

Comment by pbruin created at 2014-05-02 14:25:05

The bug will be fixed in PARI 2.7.1, which is scheduled to be released on 12 May (see http://pari.math.u-bordeaux.fr/archives/pari-dev-1405/msg00000.html).


---

Comment by jdemeyer created at 2014-05-05 11:20:11

Follow-up upstream bug: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1569](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1569)


---

Comment by pbruin created at 2014-05-23 12:13:16

Replying to [comment:10 jdemeyer]:
> Follow-up upstream bug: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1569](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1569)
This one is also fixed in PARI 2.7.1, which was released last week.  (The log entry in the `CHANGES` file seems to have been inadvertently omitted, though.)


---

Comment by pbruin created at 2014-08-22 13:55:33

Changing type from defect to task.


---

Comment by pbruin created at 2014-08-22 13:55:33

Changing priority from major to minor.


---

Comment by pbruin created at 2014-08-22 13:55:33

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2014-08-22 13:55:33

Here is a Git branch, with doctests checking that both of the above PARI bugs have been fixed.

Note: this is based on 6.4.beta1, #15767 needs to be merged separately until the next beta is out.


---

Comment by jdemeyer created at 2014-08-28 21:00:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-06 11:02:40

Resolution: fixed
