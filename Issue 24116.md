# Issue 24116: Upgrade to MPFR 4.0.0

Issue created by migration from https://trac.sagemath.org/ticket/24353

Original creator: jdemeyer

Original creation time: 2017-12-09 17:05:23

CC:  zimmerma fbissey

Currently, there is a release candidate:

*Tarball*: http://www.mpfr.org/mpfr-4.0.0/mpfr-4.0.0-rc1.tar.bz2


---

Comment by jdemeyer created at 2017-12-09 19:10:50

As reported on the MPFR mailing list by other people, this breaks MPC:

```
/bin/bash ../libtool  --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I..   -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include -m64 -O2 -march=corei7-
mul.c:179:1: error: conflicting types for 'mpfr_fmma'
 mpfr_fmma (mpfr_ptr z, mpfr_srcptr a, mpfr_srcptr b, mpfr_srcptr c,
 ^
In file included from mpc.h:25:0,
                 from mpc-impl.h:30,
                 from mul.c:22:
../../../../../../../include/mpfr.h:731:6: note: previous declaration of 'mpfr_fmma' was here
 __MPFR_DECLSPEC int mpfr_fmma (mpfr_ptr, mpfr_srcptr, mpfr_srcptr, mpfr_srcptr,
      ^
Makefile:532: recipe for target 'mul.lo' failed
make[6]: *** [mul.lo] Error 1
```

----
New commits:


---

Comment by git created at 2017-12-14 14:38:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by zimmerma created at 2018-01-08 12:42:46

> Unfortunately, it seems that MPFI is a dead project

Fabrice Rouillier tells me he is preparing the release of MPFI 1.5.2. Stay tuned!


---

Comment by jdemeyer created at 2018-01-08 13:41:41

Replying to [comment:9 zimmerma]:
> Fabrice Rouillier tells me he is preparing the release of MPFI 1.5.2. Stay tuned!

Is this personal communication or is this on some public channel? In the latter case, do you have a link?


---

Comment by zimmerma created at 2018-01-08 13:43:56

> Is this personal communication or is this on some public channel?

it is personal communication. If/when I have some information about a release candidate,
I will post it here.


---

Comment by zimmerma created at 2018-01-08 15:40:51

MPFI 1.5.2 is available from https://gforge.inria.fr/frs/?group_id=157


---

Comment by git created at 2018-01-08 16:10:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-01-08 16:12:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-08 18:30:55

There are a few obvious doctest failures in `src/sage/rings/real_mpfr.pyx`. All should be easy to fix.


---

Comment by zimmerma created at 2018-01-08 19:20:05

I am curious to know which failures you get.


---

Comment by git created at 2018-01-09 08:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-01-09 09:16:49

I added a few fixes in the last commit. With this, all tests pass. So, this ticket is technically needs_review, modulo the fact that there is no MPC release yet...


---

Comment by zimmerma created at 2018-01-09 11:00:52

in the last commit:

> faithful rounding (currently experimental; not supported for every operation)

"not supported for every operation" is not correct: it is supported, but not guaranteed correct for every operation.

Apart from that, I am ok with this commit.

We expect to release MPC 1.1 this week or next week.


---

Comment by git created at 2018-01-09 11:17:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-09 11:24:59

Replying to [comment:20 zimmerma]:
> "not supported for every operation" is not correct: it is supported, but not guaranteed correct for every operation.

Fixed.

> Apart from that, I am ok with this commit.

OK, I'm adding you as reviewer.


---

Comment by zimmerma created at 2018-01-12 14:19:08

MPC 1.1.0 is now available from https://ftp.gnu.org/gnu/mpc


---

Comment by git created at 2018-01-12 14:56:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-12 14:57:16

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-01-12 15:59:41

all tests pass on quasar (ubuntu x86_64)


---

Comment by zimmerma created at 2018-01-16 10:11:20

I did:

```
$ git co u/jdemeyer/upgrade_to_mpfr_4_0_0
$ git pull
$ make build
```

and got an error:

```
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/mp
fr/mpfr-4.0.0.tar.bz2'
Traceback (most recent call last):
  File "/tmp/sage/build/bin/sage-download-file", line 28, in <module>
    run_safe()
  File "/tmp/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 118, in
 run_safe
    run()
  File "/tmp/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 100, in
 run
    app.download_tarball(args.url_or_tarball, args.destination)
  File "/tmp/sage/build/bin/../sage_bootstrap/download/app.py", line 43, in down
load_tarball
    tarball.download()
  File "/tmp/sage/build/bin/../sage_bootstrap/tarball.py", line 161, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror ne
twork
************************************************************************
Error downloading mpfr-4.0.0.tar.bz2
```



---

Comment by jdemeyer created at 2018-01-16 10:13:43

You need to manually download the 3 tarballs mentioned on this ticket and put them in the `upstream` directory in your Sage installation.


---

Comment by zimmerma created at 2018-01-16 15:43:13

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2018-01-16 15:43:13

modulo the fact that the patchbot is happy, I give a positive review.


---

Comment by vbraun created at 2018-01-18 18:09:19

Resolution: fixed
