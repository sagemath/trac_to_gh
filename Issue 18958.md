# Issue 18958: Make tensor of CombinatorialFreeModule use cartesian_product

archive/issues_018958.json:
```json
{
    "body": "CC:  @nthiery @tscrim @yyyyx4 @videlec @jhpalmieri\n\nThe last class to use `sage.combinat.cartesian_product.CartesianProduct_iters` is the `CombinatorialFreeModule`. It is not simple to get rid of this since there is no check in constructing element of a combinatorial free module... hence changing the basis from being tuples to be element of a cartesian product might lead to subtle errors (e.g. http://trac.sagemath.org/ticket/18411#comment:24).\n\nIssue created by migration from https://trac.sagemath.org/ticket/19195\n\n",
    "created_at": "2015-09-13T02:06:58Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Make tensor of CombinatorialFreeModule use cartesian_product",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18958",
    "user": "@videlec"
}
```
CC:  @nthiery @tscrim @yyyyx4 @videlec @jhpalmieri

The last class to use `sage.combinat.cartesian_product.CartesianProduct_iters` is the `CombinatorialFreeModule`. It is not simple to get rid of this since there is no check in constructing element of a combinatorial free module... hence changing the basis from being tuples to be element of a cartesian product might lead to subtle errors (e.g. http://trac.sagemath.org/ticket/18411#comment:24).

Issue created by migration from https://trac.sagemath.org/ticket/19195





---

archive/issue_comments_259967.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-03T20:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259967",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_259968.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259968",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_259969.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-10T21:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259969",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259970.json:
```json
{
    "body": "Rebased. Some doctests need to be updated. In particular:\n\n```\n**********************************************************************\nFile \"src/sage/combinat/free_module.py\", line 1520, in sage.combinat.free_module.CombinatorialFreeModule.CombinatorialFreeModule_Tensor._coerce_map_from_\nFailed example:\n    S.an_element()\nExpected:\n    3*B[0] # B[-1] + 2*B[0] # B[0] + 2*B[0] # B[1]\n...\n    UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.\n    3*B[0] # B[-1] + B[0] # B[0] + 2*B[0] # B[1] + B[1] # B[1]\n```\n",
    "created_at": "2022-08-10T21:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259970",
    "user": "@mkoeppe"
}
```

Rebased. Some doctests need to be updated. In particular:

```
**********************************************************************
File "src/sage/combinat/free_module.py", line 1520, in sage.combinat.free_module.CombinatorialFreeModule.CombinatorialFreeModule_Tensor._coerce_map_from_
Failed example:
    S.an_element()
Expected:
    3*B[0] # B[-1] + 2*B[0] # B[0] + 2*B[0] # B[1]
...
    UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.
    3*B[0] # B[-1] + B[0] # B[0] + 2*B[0] # B[1] + B[1] # B[1]
```




---

archive/issue_comments_259971.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-11T04:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259971",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259972.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> {{{\n>     UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.\n>     3*B[0] # B[-1] + B[0] # B[0] + 2*B[0] # B[1] + B[1] # B[1]\n> }}}\n\nRelated recent discussion in #33287",
    "created_at": "2022-08-11T05:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259972",
    "user": "@mkoeppe"
}
```

Replying to [comment:11 mkoeppe]:
> {{{
>     UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.
>     3*B[0] # B[-1] + B[0] # B[0] + 2*B[0] # B[1] + B[1] # B[1]
> }}}

Related recent discussion in #33287



---

archive/issue_comments_259973.json:
```json
{
    "body": "I think this warning (from `Sets.CartesianProducts.ParentMethods.__iter__`, added in #18411) is useless and is best removed. It's essentially warning that it may be constructing an infinite order of the wrong order type. But this is irrelevant for any algorithm",
    "created_at": "2022-08-11T05:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259973",
    "user": "@mkoeppe"
}
```

I think this warning (from `Sets.CartesianProducts.ParentMethods.__iter__`, added in #18411) is useless and is best removed. It's essentially warning that it may be constructing an infinite order of the wrong order type. But this is irrelevant for any algorithm



---

archive/issue_comments_259974.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> I think this warning (from `Sets.CartesianProducts.ParentMethods.__iter__`, added in #18411) is useless and is best removed. It's essentially warning that it may be constructing an infinite order of the wrong order type. But this is irrelevant for any algorithm\n\nI take this back. I now propose that instead of issuing a warning, Cartesian products of possibly infinite factors should be enumerated using the existing, poorly named function `sage.misc.mrange.cantor_product` (enumeration in the order of increasing sums-of-ranks).",
    "created_at": "2022-08-11T18:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259974",
    "user": "@mkoeppe"
}
```

Replying to [comment:16 mkoeppe]:
> I think this warning (from `Sets.CartesianProducts.ParentMethods.__iter__`, added in #18411) is useless and is best removed. It's essentially warning that it may be constructing an infinite order of the wrong order type. But this is irrelevant for any algorithm

I take this back. I now propose that instead of issuing a warning, Cartesian products of possibly infinite factors should be enumerated using the existing, poorly named function `sage.misc.mrange.cantor_product` (enumeration in the order of increasing sums-of-ranks).



---

archive/issue_comments_259975.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-11T18:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259975",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-11T18:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259976",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259977.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-11T18:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259977",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259978.json:
```json
{
    "body": "Doctest failures in 2 files remain:\n\n```\nsage -t --long --random-seed=231229664758049651431332547293032544509 src/sage/algebras/steenrod/steenrod_algebra.py  # Timed out\nsage -t --long --random-seed=231229664758049651431332547293032544509 src/sage/homology/hochschild_complex.py  # 10 doctests failed\n```\n",
    "created_at": "2022-08-11T21:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259978",
    "user": "@mkoeppe"
}
```

Doctest failures in 2 files remain:

```
sage -t --long --random-seed=231229664758049651431332547293032544509 src/sage/algebras/steenrod/steenrod_algebra.py  # Timed out
sage -t --long --random-seed=231229664758049651431332547293032544509 src/sage/homology/hochschild_complex.py  # 10 doctests failed
```




---

archive/issue_comments_259979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-11T21:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259979",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259980.json:
```json
{
    "body": "Only one file, `src/sage/algebras/steenrod/steenrod_algebra.py` needs a closer look by experts:\n\n```\nUserWarning: Testing equality of infinite sets which will not end in case of equality\n\n    TypeError: <class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'> is not hashable and does not implement _cache_key()\n    ------------------------------------------------------------\n    The following tests failed: _test_antipode\n\n(times out)\n```\n",
    "created_at": "2022-08-11T21:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259980",
    "user": "@mkoeppe"
}
```

Only one file, `src/sage/algebras/steenrod/steenrod_algebra.py` needs a closer look by experts:

```
UserWarning: Testing equality of infinite sets which will not end in case of equality

    TypeError: <class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'> is not hashable and does not implement _cache_key()
    ------------------------------------------------------------
    The following tests failed: _test_antipode

(times out)
```




---

archive/issue_comments_259981.json:
```json
{
    "body": "This is the doctest that times out:\n\n```\nsage: d = a.change_basis('comm_long'); d.coproduct() ## line 3392 ##\n```\n\n\n`sage.sets.set_from_iterator.EnumeratedSetFromIterator.__eq__` gives the warning and then indeed times out trying to compare the following sets:\n\n```\n(Pdb) p self\nbasis key family of mod 2 Steenrod algebra, pst_revz basis\n(Pdb) p other\nbasis key family of mod 2 Steenrod algebra, comm_revz_long basis\n(Pdb) p type(self)\n<class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'>\n(Pdb) p type(other)\n<class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'>\n```\n",
    "created_at": "2022-08-12T06:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259981",
    "user": "@mkoeppe"
}
```

This is the doctest that times out:

```
sage: d = a.change_basis('comm_long'); d.coproduct() ## line 3392 ##
```


`sage.sets.set_from_iterator.EnumeratedSetFromIterator.__eq__` gives the warning and then indeed times out trying to compare the following sets:

```
(Pdb) p self
basis key family of mod 2 Steenrod algebra, pst_revz basis
(Pdb) p other
basis key family of mod 2 Steenrod algebra, comm_revz_long basis
(Pdb) p type(self)
<class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'>
(Pdb) p type(other)
<class 'sage.sets.set_from_iterator.EnumeratedSetFromIterator_with_category'>
```




---

archive/issue_comments_259982.json:
```json
{
    "body": "This equality test is needed by the `UniqueRepresentation` behavior of `sage.sets.cartesian_product.CartesianProduct`",
    "created_at": "2022-08-12T06:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259982",
    "user": "@mkoeppe"
}
```

This equality test is needed by the `UniqueRepresentation` behavior of `sage.sets.cartesian_product.CartesianProduct`



---

archive/issue_comments_259983.json:
```json
{
    "body": "Unfortunately, while I see the doctest failure, I can't replicate it in an interactive session, so it's hard to debug. I think the problem arises in the lines\n\n```\n            for (a,b), coeff in x:\n                result.append((tensor((A._change_basis_on_basis(a, basis),\n                                       A._change_basis_on_basis(b, basis))),coeff))\n\n```\n\n(lines 1376-8).",
    "created_at": "2022-08-12T18:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259983",
    "user": "@jhpalmieri"
}
```

Unfortunately, while I see the doctest failure, I can't replicate it in an interactive session, so it's hard to debug. I think the problem arises in the lines

```
            for (a,b), coeff in x:
                result.append((tensor((A._change_basis_on_basis(a, basis),
                                       A._change_basis_on_basis(b, basis))),coeff))

```

(lines 1376-8).



---

archive/issue_comments_259984.json:
```json
{
    "body": "Here's a minimal reproducer:\n\n```\n            sage: SteenrodAlgebra(basis='pst').Sq(0,1).coproduct()\n            sage: a = Sq(2)\n            sage: d = a.change_basis('comm_long'); d.coproduct()\n```\n",
    "created_at": "2022-08-12T20:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259984",
    "user": "@mkoeppe"
}
```

Here's a minimal reproducer:

```
            sage: SteenrodAlgebra(basis='pst').Sq(0,1).coproduct()
            sage: a = Sq(2)
            sage: d = a.change_basis('comm_long'); d.coproduct()
```




---

archive/issue_comments_259985.json:
```json
{
    "body": "The bases for \"mod 2 Steenrod algebra, pst_revz basis\" and \"mod 2 Steenrod algebra, comm_revz_long basis\" have the same indexing sets, although the corresponding algebra elements are different. Therefore the same will be true for their tensor squares. As a result, I'm not sure what to do about this.",
    "created_at": "2022-08-12T20:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259985",
    "user": "@jhpalmieri"
}
```

The bases for "mod 2 Steenrod algebra, pst_revz basis" and "mod 2 Steenrod algebra, comm_revz_long basis" have the same indexing sets, although the corresponding algebra elements are different. Therefore the same will be true for their tensor squares. As a result, I'm not sure what to do about this.



---

archive/issue_comments_259986.json:
```json
{
    "body": "\n```\nsage: s_pst = SteenrodAlgebra(basis='pst')\nsage: s_comm_long = SteenrodAlgebra(basis='comm_long')\nsage: s_pst.basis()\nLazy family (Term map from basis key family of mod 2 Steenrod algebra, pst_revz basis to mod 2 Steenrod algebra, pst_revz basis(i))_{i in basis key family of mod 2 Steenrod algebra, pst_revz basis}\nsage: s_comm_long.basis()\nLazy family (Term map from basis key family of mod 2 Steenrod algebra, comm_revz_long basis to mod 2 Steenrod algebra, comm_revz_long basis(i))_{i in basis key family of mod 2 Steenrod algebra, comm_revz_long basis}\nsage: s_pst.basis() == s_comm_long.basis()\n/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/sets/set_from_iterator.py:311: UserWarning: Testing equality of infinite sets basis key family of mod 2 Steenrod algebra, pst_revz basis and basis key family of mod 2 Steenrod algebra, comm_revz_long basis,  which will not end in case of equality\n```\n",
    "created_at": "2022-08-12T20:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259986",
    "user": "@mkoeppe"
}
```


```
sage: s_pst = SteenrodAlgebra(basis='pst')
sage: s_comm_long = SteenrodAlgebra(basis='comm_long')
sage: s_pst.basis()
Lazy family (Term map from basis key family of mod 2 Steenrod algebra, pst_revz basis to mod 2 Steenrod algebra, pst_revz basis(i))_{i in basis key family of mod 2 Steenrod algebra, pst_revz basis}
sage: s_comm_long.basis()
Lazy family (Term map from basis key family of mod 2 Steenrod algebra, comm_revz_long basis to mod 2 Steenrod algebra, comm_revz_long basis(i))_{i in basis key family of mod 2 Steenrod algebra, comm_revz_long basis}
sage: s_pst.basis() == s_comm_long.basis()
/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/sets/set_from_iterator.py:311: UserWarning: Testing equality of infinite sets basis key family of mod 2 Steenrod algebra, pst_revz basis and basis key family of mod 2 Steenrod algebra, comm_revz_long basis,  which will not end in case of equality
```




---

archive/issue_comments_259987.json:
```json
{
    "body": "It seems we either need a better `__eq__` for `LazyFamily` in general, or just more specific `Family` implementation for these basis key families",
    "created_at": "2022-08-12T20:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259987",
    "user": "@mkoeppe"
}
```

It seems we either need a better `__eq__` for `LazyFamily` in general, or just more specific `Family` implementation for these basis key families



---

archive/issue_comments_259988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-12T20:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259988",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259989.json:
```json
{
    "body": "This fixes the comparison in comment:31, but not the original problem",
    "created_at": "2022-08-12T21:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259989",
    "user": "@mkoeppe"
}
```

This fixes the comparison in comment:31, but not the original problem



---

archive/issue_comments_259990.json:
```json
{
    "body": "\n```\nsage: s_pst = SteenrodAlgebra(basis='pst')\nsage: s_comm_long = SteenrodAlgebra(basis='comm_long')\nsage: s_pst.basis().keys() == s_comm_long.basis().keys()\n/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/sets/set_from_iterator.py:311: UserWarning: Testing equality of infinite sets basis key family of mod 2 Steenrod algebra, pst_revz basis and basis key family of mod 2 Steenrod algebra, comm_revz_long basis,  which will not end in case of equality\n```\n",
    "created_at": "2022-08-12T21:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259990",
    "user": "@mkoeppe"
}
```


```
sage: s_pst = SteenrodAlgebra(basis='pst')
sage: s_comm_long = SteenrodAlgebra(basis='comm_long')
sage: s_pst.basis().keys() == s_comm_long.basis().keys()
/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/sets/set_from_iterator.py:311: UserWarning: Testing equality of infinite sets basis key family of mod 2 Steenrod algebra, pst_revz basis and basis key family of mod 2 Steenrod algebra, comm_revz_long basis,  which will not end in case of equality
```




---

archive/issue_comments_259991.json:
```json
{
    "body": "Right, these sets of keys are the same.",
    "created_at": "2022-08-12T21:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259991",
    "user": "@jhpalmieri"
}
```

Right, these sets of keys are the same.



---

archive/issue_comments_259992.json:
```json
{
    "body": "Although they have different string representations, so I don't know why the latest change doesn't catch it.",
    "created_at": "2022-08-12T22:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259992",
    "user": "@jhpalmieri"
}
```

Although they have different string representations, so I don't know why the latest change doesn't catch it.



---

archive/issue_comments_259993.json:
```json
{
    "body": "The latest change was for `LazyFamily`, not for `EnumeratedSetFromIterator`.",
    "created_at": "2022-08-12T22:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259993",
    "user": "@mkoeppe"
}
```

The latest change was for `LazyFamily`, not for `EnumeratedSetFromIterator`.



---

archive/issue_comments_259994.json:
```json
{
    "body": "`EnumeratedSetFromIterator` does not look at names; `__eq__` is equality as sets",
    "created_at": "2022-08-12T22:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259994",
    "user": "@mkoeppe"
}
```

`EnumeratedSetFromIterator` does not look at names; `__eq__` is equality as sets



---

archive/issue_comments_259995.json:
```json
{
    "body": "This fixes the problem for me, but I don't know if it's the right thing to do:\n\n```diff\ndiff --git a/src/sage/sets/set_from_iterator.py b/src/sage/sets/set_from_iterator.py\nindex 3a2360383e..90218aa426 100644\n--- a/src/sage/sets/set_from_iterator.py\n+++ b/src/sage/sets/set_from_iterator.py\n@@ -297,6 +297,8 @@ class EnumeratedSetFromIterator(Parent):\n             True\n         \"\"\"\n         if isinstance(other, EnumeratedSetFromIterator):\n+            if repr(self) != repr(other):\n+                return False\n             # trick to allow equality between infinite sets\n             # this assume that the function does not return randomized data!\n             if (self._func == other._func and\n```\n",
    "created_at": "2022-08-12T22:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259995",
    "user": "@jhpalmieri"
}
```

This fixes the problem for me, but I don't know if it's the right thing to do:

```diff
diff --git a/src/sage/sets/set_from_iterator.py b/src/sage/sets/set_from_iterator.py
index 3a2360383e..90218aa426 100644
--- a/src/sage/sets/set_from_iterator.py
+++ b/src/sage/sets/set_from_iterator.py
@@ -297,6 +297,8 @@ class EnumeratedSetFromIterator(Parent):
             True
         """
         if isinstance(other, EnumeratedSetFromIterator):
+            if repr(self) != repr(other):
+                return False
             # trick to allow equality between infinite sets
             # this assume that the function does not return randomized data!
             if (self._func == other._func and
```




---

archive/issue_comments_259996.json:
```json
{
    "body": "If we want to go in the direction (making the factors \"less unique\"), I'd think we could give `EnumeratedSetFromIterator` an additional argument `unique_tag` (default None), which would be compared (instead of repr)",
    "created_at": "2022-08-12T22:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259996",
    "user": "@mkoeppe"
}
```

If we want to go in the direction (making the factors "less unique"), I'd think we could give `EnumeratedSetFromIterator` an additional argument `unique_tag` (default None), which would be compared (instead of repr)



---

archive/issue_comments_259997.json:
```json
{
    "body": "They have a \"name\" attribute already; we could use that. Edit: a \"name\" argument, not an attribute.",
    "created_at": "2022-08-12T22:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259997",
    "user": "@jhpalmieri"
}
```

They have a "name" attribute already; we could use that. Edit: a "name" argument, not an attribute.



---

archive/issue_comments_259998.json:
```json
{
    "body": "Of course that boils down to use repr.",
    "created_at": "2022-08-12T22:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259998",
    "user": "@jhpalmieri"
}
```

Of course that boils down to use repr.



---

archive/issue_comments_259999.json:
```json
{
    "body": "\n```diff\ndiff --git a/src/sage/sets/set_from_iterator.py b/src/sage/sets/set_from_iterator.py\nindex 3a2360383e..dbb448b829 100644\n--- a/src/sage/sets/set_from_iterator.py\n+++ b/src/sage/sets/set_from_iterator.py\n@@ -297,6 +297,9 @@ class EnumeratedSetFromIterator(Parent):\n             True\n         \"\"\"\n         if isinstance(other, EnumeratedSetFromIterator):\n+            if hasattr(self, '__custom_name') or hasattr(other, '__custom_name'):\n+                if repr(self) != repr(other):\n+                    return False\n             # trick to allow equality between infinite sets\n             # this assume that the function does not return randomized data!\n             if (self._func == other._func and\n```\n",
    "created_at": "2022-08-12T22:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-259999",
    "user": "@jhpalmieri"
}
```


```diff
diff --git a/src/sage/sets/set_from_iterator.py b/src/sage/sets/set_from_iterator.py
index 3a2360383e..dbb448b829 100644
--- a/src/sage/sets/set_from_iterator.py
+++ b/src/sage/sets/set_from_iterator.py
@@ -297,6 +297,9 @@ class EnumeratedSetFromIterator(Parent):
             True
         """
         if isinstance(other, EnumeratedSetFromIterator):
+            if hasattr(self, '__custom_name') or hasattr(other, '__custom_name'):
+                if repr(self) != repr(other):
+                    return False
             # trick to allow equality between infinite sets
             # this assume that the function does not return randomized data!
             if (self._func == other._func and
```




---

archive/issue_comments_260000.json:
```json
{
    "body": "I think this is too dangerous, it's breaking the extensionality of sets",
    "created_at": "2022-08-12T22:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260000",
    "user": "@mkoeppe"
}
```

I think this is too dangerous, it's breaking the extensionality of sets



---

archive/issue_comments_260001.json:
```json
{
    "body": "I think a solution may be to change `sage.sets.cartesian_product.CartesianProduct` so that it only uses `UniqueRepresentation` if it can safely do so",
    "created_at": "2022-08-12T22:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260001",
    "user": "@mkoeppe"
}
```

I think a solution may be to change `sage.sets.cartesian_product.CartesianProduct` so that it only uses `UniqueRepresentation` if it can safely do so



---

archive/issue_comments_260002.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-12T22:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260002",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260003.json:
```json
{
    "body": "This fixes comment:29. Haven't checked yet if it breaks anything",
    "created_at": "2022-08-12T22:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260003",
    "user": "@mkoeppe"
}
```

This fixes comment:29. Haven't checked yet if it breaks anything



---

archive/issue_comments_260004.json:
```json
{
    "body": "This produces a lot of doctest failures:\n\n```\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/asymptotic_expansion_generators.py  # 86 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/symbolic/expression.pyx  # 3 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/doctest/forker.py  # 3 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/homology/hochschild_complex.py  # 2 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/pushout.py  # 6 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/asymptotic_ring.py  # 236 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/hecke_algebras/ariki_koike_algebra.py  # 13 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/term_monoid.py  # 99 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/askey_wilson.py  # 2 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/growth_group.py  # 114 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/root_system/extended_affine_weyl_group.py  # 404 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/growth_group_cartesian.py  # 118 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/symbolic/ring.pyx  # 5 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/sets_cat.py  # 2 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/schur_algebra.py  # 1 doctest failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/magmas.py  # 4 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/doc/en/thematic_tutorials/lie/affine.rst  # 1 doctest failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/groups/group_semidirect_product.py  # 35 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/sets/family.py  # 3 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/big_oh.py  # 2 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/sets/cartesian_product.py  # 2 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/posets/cartesian_product.py  # 48 doctests failed\nsage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/cartesian_product.py  # 2 doctests failed\n```\n",
    "created_at": "2022-08-12T23:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260004",
    "user": "@jhpalmieri"
}
```

This produces a lot of doctest failures:

```
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/asymptotic_expansion_generators.py  # 86 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/symbolic/expression.pyx  # 3 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/doctest/forker.py  # 3 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/homology/hochschild_complex.py  # 2 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/pushout.py  # 6 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/asymptotic_ring.py  # 236 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/hecke_algebras/ariki_koike_algebra.py  # 13 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/term_monoid.py  # 99 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/askey_wilson.py  # 2 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/growth_group.py  # 114 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/root_system/extended_affine_weyl_group.py  # 404 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/asymptotic/growth_group_cartesian.py  # 118 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/symbolic/ring.pyx  # 5 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/sets_cat.py  # 2 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/algebras/schur_algebra.py  # 1 doctest failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/categories/magmas.py  # 4 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/doc/en/thematic_tutorials/lie/affine.rst  # 1 doctest failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/groups/group_semidirect_product.py  # 35 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/sets/family.py  # 3 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/rings/big_oh.py  # 2 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/sets/cartesian_product.py  # 2 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/posets/cartesian_product.py  # 48 doctests failed
sage -t --long --random-seed=269458505477710295233910752449959854719 src/sage/combinat/cartesian_product.py  # 2 doctests failed
```




---

archive/issue_comments_260005.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-12T23:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260005",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_260006.json:
```json
{
    "body": "Here's a simpler version that also creates such failures",
    "created_at": "2022-08-12T23:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260006",
    "user": "@mkoeppe"
}
```

Here's a simpler version that also creates such failures



---

archive/issue_comments_260007.json:
```json
{
    "body": "But hey, no failures in `algebras/steenrod`, `homology,` or `topology`, so it's all good with me. ;)",
    "created_at": "2022-08-13T00:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260007",
    "user": "@jhpalmieri"
}
```

But hey, no failures in `algebras/steenrod`, `homology,` or `topology`, so it's all good with me. ;)



---

archive/issue_comments_260008.json:
```json
{
    "body": "OK some of the failures were already present in 2a17576 (comment:33)",
    "created_at": "2022-08-13T00:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260008",
    "user": "@mkoeppe"
}
```

OK some of the failures were already present in 2a17576 (comment:33)



---

archive/issue_comments_260009.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-13T00:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260009",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_260010.json:
```json
{
    "body": "I'm still seeing a lot of error messages of the form\n\n```\nFile \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta8/src/sage/rings/asymptotic/growth_group_cartesian.py\", line 320, in __init__\nGenericGrowthGroup.__init__(self, sets[0], Vars, self.category(), **kwds)\nTypeError: __init__() got an unexpected keyword argument 'flatten'\n```\n\nAlso a few in `pushout.py`:\n\n```\nFile \"sage/misc/classcall_metaclass.pyx\", line 320, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__\n return cls.classcall(cls, *args, **kwds)\nTypeError: __classcall__() missing 1 required positional argument: 'category'\n```\n",
    "created_at": "2022-08-13T02:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260010",
    "user": "@jhpalmieri"
}
```

I'm still seeing a lot of error messages of the form

```
File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta8/src/sage/rings/asymptotic/growth_group_cartesian.py", line 320, in __init__
GenericGrowthGroup.__init__(self, sets[0], Vars, self.category(), **kwds)
TypeError: __init__() got an unexpected keyword argument 'flatten'
```

Also a few in `pushout.py`:

```
File "sage/misc/classcall_metaclass.pyx", line 320, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__
 return cls.classcall(cls, *args, **kwds)
TypeError: __classcall__() missing 1 required positional argument: 'category'
```




---

archive/issue_comments_260011.json:
```json
{
    "body": "https://github.com/sagemath/sagetrac-mirror/actions/runs/2850051513 only sees the error in steenrod with e969448",
    "created_at": "2022-08-13T03:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260011",
    "user": "@mkoeppe"
}
```

https://github.com/sagemath/sagetrac-mirror/actions/runs/2850051513 only sees the error in steenrod with e969448



---

archive/issue_comments_260012.json:
```json
{
    "body": "Note I backed out 6d5f261",
    "created_at": "2022-08-13T03:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260012",
    "user": "@mkoeppe"
}
```

Note I backed out 6d5f261



---

archive/issue_comments_260013.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T04:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260013",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260014.json:
```json
{
    "body": "OK here's a better version of the same approach, it passes all tests for me",
    "created_at": "2022-08-13T04:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260014",
    "user": "@mkoeppe"
}
```

OK here's a better version of the same approach, it passes all tests for me



---

archive/issue_comments_260015.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T04:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260015",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260016.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-13T04:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260016",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_260017.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T04:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260017",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260018.json:
```json
{
    "body": "Thank you for working on this. It definitely would be good to have things more centralized. Hopefully these comments are fairly simple to incorporate.\n\nI think this is a very dangerous test:\n\n```python\nif not repr(self) == repr(other):\n```\n\n(which it should use `!=` anyways) because\n\n```\nsage: x = 1.0\nsage: y = 1\nsage: repr(x) == repr(y)\nFalse\nsage: x == y\nTrue\nsage: hash(x) == hash(y)\nTrue\n```\n\nEqual objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.\n\nOn the other hand, I disagree with this reasoning:\n\n```\nTwo :class:`EnumeratedSetFromIterator` objects that are not known to be finite\ncannot be reliably tested for equality. Therefore, we do not put such objects\nin the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.\n```\n\nIt depends on what you mean by equality. Now we normally think of equality of sets as containment in both ways, but it might be better to think of them like knots or polytopes. You might have the same polytope (same subset of **R**<sup>n</sup>) but different representations. So it could make sense for them to not be equal. Consequently, I do not support this disabling of `UniqueRepresentation`. Either you need to remove that altogether, which I strongly oppose because of the consequences with parents and how much nicer `UniqueRepresentation` behavior makes things, or you test by equality, which uses whatever definition of equality the object uses.\n\nThis statement is needs correcting:\n\n```diff\n-When the first factor is infinite (or not known to be finite), it still\n+When all but the first factor is known to be finite, it\n uses the lexicographic order::\n```\n\nI believe your code would produce\n\n```\nsage: list(islice(cantor_product(NN, NN, GF(2)), 6))\n[(0, 0, 0), (1, 0, 0), (0, 1, 0), (0, 0, 1), (2, 0, 0), (1, 1, 0)]\n```\n\n\nSomething else to be aware of is elements of `cartesian_product` are actual Sage elements rather than `list`s. So this could lead to performance regressions. Lots of things use the `CFM_tensor` class; all of the Hopf algebras basically. We might want a base or sub class of the `cartesian_product` that acts as a fa\u00e7ade parent for tuples. So the only difference is essentially in the `_element_constructor_` and/or `__call__`.\n\nI am wondering why we did not put `EnumeratedSets().CartesianProducts()` in the category of `EnumeratedSets()`. We might want to do this to have access to some of the generic methods from there, such as `unrank()`. Likewise, it would be good to port over some of these extra methods to `cartesian_product`, which would improve the (generic) implementation, and/or move things into the category.",
    "created_at": "2022-08-13T07:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260018",
    "user": "@tscrim"
}
```

Thank you for working on this. It definitely would be good to have things more centralized. Hopefully these comments are fairly simple to incorporate.

I think this is a very dangerous test:

```python
if not repr(self) == repr(other):
```

(which it should use `!=` anyways) because

```
sage: x = 1.0
sage: y = 1
sage: repr(x) == repr(y)
False
sage: x == y
True
sage: hash(x) == hash(y)
True
```

Equal objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.

On the other hand, I disagree with this reasoning:

```
Two :class:`EnumeratedSetFromIterator` objects that are not known to be finite
cannot be reliably tested for equality. Therefore, we do not put such objects
in the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.
```

It depends on what you mean by equality. Now we normally think of equality of sets as containment in both ways, but it might be better to think of them like knots or polytopes. You might have the same polytope (same subset of **R**<sup>n</sup>) but different representations. So it could make sense for them to not be equal. Consequently, I do not support this disabling of `UniqueRepresentation`. Either you need to remove that altogether, which I strongly oppose because of the consequences with parents and how much nicer `UniqueRepresentation` behavior makes things, or you test by equality, which uses whatever definition of equality the object uses.

This statement is needs correcting:

```diff
-When the first factor is infinite (or not known to be finite), it still
+When all but the first factor is known to be finite, it
 uses the lexicographic order::
```

I believe your code would produce

```
sage: list(islice(cantor_product(NN, NN, GF(2)), 6))
[(0, 0, 0), (1, 0, 0), (0, 1, 0), (0, 0, 1), (2, 0, 0), (1, 1, 0)]
```


Something else to be aware of is elements of `cartesian_product` are actual Sage elements rather than `list`s. So this could lead to performance regressions. Lots of things use the `CFM_tensor` class; all of the Hopf algebras basically. We might want a base or sub class of the `cartesian_product` that acts as a façade parent for tuples. So the only difference is essentially in the `_element_constructor_` and/or `__call__`.

I am wondering why we did not put `EnumeratedSets().CartesianProducts()` in the category of `EnumeratedSets()`. We might want to do this to have access to some of the generic methods from there, such as `unrank()`. Likewise, it would be good to port over some of these extra methods to `cartesian_product`, which would improve the (generic) implementation, and/or move things into the category.



---

archive/issue_comments_260019.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> I think this is a very dangerous test:\n> {{{#!python\n> if not repr(self) == repr(other):\n> }}}\n> (which it should use `!=` anyways) because\n> {{{\n> sage: x = 1.0\n> sage: y = 1\n> sage: repr(x) == repr(y)\n> False\n> sage: x == y\n> True\n> sage: hash(x) == hash(y)\n> True\n> }}}\n> Equal objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.\n\nNo, the `repr` comparison was already in the old method. It's only reordered.",
    "created_at": "2022-08-13T07:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260019",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 tscrim]:
> I think this is a very dangerous test:
> {{{#!python
> if not repr(self) == repr(other):
> }}}
> (which it should use `!=` anyways) because
> {{{
> sage: x = 1.0
> sage: y = 1
> sage: repr(x) == repr(y)
> False
> sage: x == y
> True
> sage: hash(x) == hash(y)
> True
> }}}
> Equal objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.

No, the `repr` comparison was already in the old method. It's only reordered.



---

archive/issue_comments_260020.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> On the other hand, I disagree with this reasoning:\n> {{{\n> Two :class:`EnumeratedSetFromIterator` objects that are not known to be finite\n> cannot be reliably tested for equality. Therefore, we do not put such objects\n> in the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.\n> }}}\n> It depends on what you mean by equality. Now we normally think of equality [...] or you test by equality, which uses whatever definition of equality the object uses.\n\nI think you are trying to tell me that when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.\n\nI agree with this, it needs to be corrected.\n\n\n```\nsage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator\nsage: F = EnumeratedSetFromIterator(lambda: iter([1, 2]))\nsage: F.category()\nCategory of facade enumerated sets\nsage: cartesian_product([F, F]) is cartesian_product([F, F])   # as intended\nFalse\nsage: cartesian_product([F, F]) == cartesian_product([F, F])   # BUG\nFalse\n```\n",
    "created_at": "2022-08-13T07:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260020",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 tscrim]:
> On the other hand, I disagree with this reasoning:
> {{{
> Two :class:`EnumeratedSetFromIterator` objects that are not known to be finite
> cannot be reliably tested for equality. Therefore, we do not put such objects
> in the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.
> }}}
> It depends on what you mean by equality. Now we normally think of equality [...] or you test by equality, which uses whatever definition of equality the object uses.

I think you are trying to tell me that when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.

I agree with this, it needs to be corrected.


```
sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
sage: F = EnumeratedSetFromIterator(lambda: iter([1, 2]))
sage: F.category()
Category of facade enumerated sets
sage: cartesian_product([F, F]) is cartesian_product([F, F])   # as intended
False
sage: cartesian_product([F, F]) == cartesian_product([F, F])   # BUG
False
```




---

archive/issue_comments_260021.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-13T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260021",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_260022.json:
```json
{
    "body": "Replying to [comment:64 mkoeppe]:\n> Replying to [comment:63 tscrim]:\n> > I think this is a very dangerous test:\n> > {{{#!python\n> > if not repr(self) == repr(other):\n> > }}}\n> > (which it should use `!=` anyways) because\n> > {{{\n> > sage: x = 1.0\n> > sage: y = 1\n> > sage: repr(x) == repr(y)\n> > False\n> > sage: x == y\n> > True\n> > sage: hash(x) == hash(y)\n> > True\n> > }}}\n> > Equal objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.\n> \n> No, the `repr` comparison was already in the old method. It's only reordered.\n\nI misread the original code; after that test was true, it would compare the `repr`. This is very strange logic. I agree that it does not change the behavior. However, I still stand by my statement about it being a dangerous test.",
    "created_at": "2022-08-13T07:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260022",
    "user": "@tscrim"
}
```

Replying to [comment:64 mkoeppe]:
> Replying to [comment:63 tscrim]:
> > I think this is a very dangerous test:
> > {{{#!python
> > if not repr(self) == repr(other):
> > }}}
> > (which it should use `!=` anyways) because
> > {{{
> > sage: x = 1.0
> > sage: y = 1
> > sage: repr(x) == repr(y)
> > False
> > sage: x == y
> > True
> > sage: hash(x) == hash(y)
> > True
> > }}}
> > Equal objects need not have equal (string) representations. So you have introduced a change in behavior in a way that does not respect equality.
> 
> No, the `repr` comparison was already in the old method. It's only reordered.

I misread the original code; after that test was true, it would compare the `repr`. This is very strange logic. I agree that it does not change the behavior. However, I still stand by my statement about it being a dangerous test.



---

archive/issue_comments_260023.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> I am wondering why we did not put `EnumeratedSets().CartesianProducts()` in the category of `EnumeratedSets()`. We might want to do this \n\n+1",
    "created_at": "2022-08-13T07:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260023",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 tscrim]:
> I am wondering why we did not put `EnumeratedSets().CartesianProducts()` in the category of `EnumeratedSets()`. We might want to do this 

+1



---

archive/issue_comments_260024.json:
```json
{
    "body": "Replying to [comment:65 mkoeppe]:\n> Replying to [comment:63 tscrim]:\n> > On the other hand, I disagree with this reasoning:\n> > {{{\n> > Two :class:`EnumeratedSetFromIterator` objects that are not known to be finite\n> > cannot be reliably tested for equality. Therefore, we do not put such objects\n> > in the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.\n> > }}}\n> > It depends on what you mean by equality. Now we normally think of equality [...] or you test by equality, which uses whatever definition of equality the object uses.\n> \n> I think you are trying to tell me that when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.\n\nNo, that is not what I am saying. I am saying you should either fully and completely remove `UniqueRepresentation` from being a base class (likely downgrading to `CachedRepresentation`) or understand and learn to live with equality is not always mathematical equality. IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.",
    "created_at": "2022-08-13T07:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260024",
    "user": "@tscrim"
}
```

Replying to [comment:65 mkoeppe]:
> Replying to [comment:63 tscrim]:
> > On the other hand, I disagree with this reasoning:
> > {{{
> > Two :class:`EnumeratedSetFromIterator` objects that are not known to be finite
> > cannot be reliably tested for equality. Therefore, we do not put such objects
> > in the :class:`~sage.structure.unique_representation.UniqueRepresentation` cache.
> > }}}
> > It depends on what you mean by equality. Now we normally think of equality [...] or you test by equality, which uses whatever definition of equality the object uses.
> 
> I think you are trying to tell me that when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.

No, that is not what I am saying. I am saying you should either fully and completely remove `UniqueRepresentation` from being a base class (likely downgrading to `CachedRepresentation`) or understand and learn to live with equality is not always mathematical equality. IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.



---

archive/issue_comments_260025.json:
```json
{
    "body": "Replying to [comment:67 tscrim]:\n> I still stand by my statement about it being a dangerous test.\n\nI fully agree, but I consider it beyond the scope of this ticket",
    "created_at": "2022-08-13T07:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260025",
    "user": "@mkoeppe"
}
```

Replying to [comment:67 tscrim]:
> I still stand by my statement about it being a dangerous test.

I fully agree, but I consider it beyond the scope of this ticket



---

archive/issue_comments_260026.json:
```json
{
    "body": "Replying to [comment:69 tscrim]:\n> IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.\n\nSure it is, but I don't agree with your conclusion.\n\nThere is a simple fix - we can just push this a level lower, namely into the implementation of CachedRepresentation/UniqueRepresentation.",
    "created_at": "2022-08-13T07:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260026",
    "user": "@mkoeppe"
}
```

Replying to [comment:69 tscrim]:
> IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.

Sure it is, but I don't agree with your conclusion.

There is a simple fix - we can just push this a level lower, namely into the implementation of CachedRepresentation/UniqueRepresentation.



---

archive/issue_comments_260027.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T07:46:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260027",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260028.json:
```json
{
    "body": "Here's the fix for the category",
    "created_at": "2022-08-13T07:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260028",
    "user": "@mkoeppe"
}
```

Here's the fix for the category



---

archive/issue_comments_260029.json:
```json
{
    "body": "Replying to [comment:71 mkoeppe]:\n> Replying to [comment:69 tscrim]:\n> > IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.\n> \n> Sure it is, but I don't agree with your conclusion.\n>\n> There is a simple fix - we can just push this a level lower, namely into the implementation of CachedRepresentation/UniqueRepresentation.\n\nI don't understand this last part. The issue is you have a subclass of `UniqueRepresentation` that does not implement the `UniqueRepresentation` protocol (only a `CachedRepresentation`). So it should be a `CachedRepresentation`. This is okay, and you could have a subclass for those Cartesian products of finite sets that inherits from `UniqueRepresentation`. Not only does this make the code more complicated, it also effects the speed and reliability of other implementations.",
    "created_at": "2022-08-13T08:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260029",
    "user": "@tscrim"
}
```

Replying to [comment:71 mkoeppe]:
> Replying to [comment:69 tscrim]:
> > IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.
> 
> Sure it is, but I don't agree with your conclusion.
>
> There is a simple fix - we can just push this a level lower, namely into the implementation of CachedRepresentation/UniqueRepresentation.

I don't understand this last part. The issue is you have a subclass of `UniqueRepresentation` that does not implement the `UniqueRepresentation` protocol (only a `CachedRepresentation`). So it should be a `CachedRepresentation`. This is okay, and you could have a subclass for those Cartesian products of finite sets that inherits from `UniqueRepresentation`. Not only does this make the code more complicated, it also effects the speed and reliability of other implementations.



---

archive/issue_comments_260030.json:
```json
{
    "body": "Replying to [comment:72 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[278b7c7](https://git.sagemath.org/sage.git/commit/?id=278b7c7ec6eccc9125cd4066c15c3c16268b1382)||`src/sage/categories/enumerated_sets.py: Make (finitary) Cartesian products of enumerated enumerated`||\n\nThis caused some doctest failures:\n\n```\nFile \"sage/categories/sets_cat.py\", line 2273, in sage.categories.sets_cat.Sets.CartesianProducts.ParentMethods.__iter__\nFailed example:\n    it = iter(cartesian_product([ZZ, GF(2)]))\nException raised:\n    Traceback (most recent call last):\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.categories.sets_cat.Sets.CartesianProducts.ParentMethods.__iter__[13]>\", line 1, in <module>\n        it = iter(cartesian_product([ZZ, GF(Integer(2))]))\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/categories/enumerated_sets.py\", line 238, in __iter__\n        raise NotImplementedError(\"iterator called but not implemented\")\n    NotImplementedError: iterator called but not implemented\n```\n",
    "created_at": "2022-08-13T16:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260030",
    "user": "@mkoeppe"
}
```

Replying to [comment:72 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[278b7c7](https://git.sagemath.org/sage.git/commit/?id=278b7c7ec6eccc9125cd4066c15c3c16268b1382)||`src/sage/categories/enumerated_sets.py: Make (finitary) Cartesian products of enumerated enumerated`||

This caused some doctest failures:

```
File "sage/categories/sets_cat.py", line 2273, in sage.categories.sets_cat.Sets.CartesianProducts.ParentMethods.__iter__
Failed example:
    it = iter(cartesian_product([ZZ, GF(2)]))
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.sets_cat.Sets.CartesianProducts.ParentMethods.__iter__[13]>", line 1, in <module>
        it = iter(cartesian_product([ZZ, GF(Integer(2))]))
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/categories/enumerated_sets.py", line 238, in __iter__
        raise NotImplementedError("iterator called but not implemented")
    NotImplementedError: iterator called but not implemented
```




---

archive/issue_comments_260031.json:
```json
{
    "body": "Let's do these category improvements in a separate ticket, #34356.",
    "created_at": "2022-08-13T16:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260031",
    "user": "@mkoeppe"
}
```

Let's do these category improvements in a separate ticket, #34356.



---

archive/issue_comments_260032.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-13T16:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260032",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_260033.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T16:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260033",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260034.json:
```json
{
    "body": "Replying to [comment:74 tscrim]:\n> The issue is you have a subclass of `UniqueRepresentation` that does not implement the `UniqueRepresentation` protocol (only a `CachedRepresentation`). So it should be a `CachedRepresentation`.\n\nActually, not even a `CachedRepresentation`. I've now introduced a new class `WithPicklingByInitArgs`, which `CachedRepresentation` subclasses.",
    "created_at": "2022-08-13T16:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260034",
    "user": "@mkoeppe"
}
```

Replying to [comment:74 tscrim]:
> The issue is you have a subclass of `UniqueRepresentation` that does not implement the `UniqueRepresentation` protocol (only a `CachedRepresentation`). So it should be a `CachedRepresentation`.

Actually, not even a `CachedRepresentation`. I've now introduced a new class `WithPicklingByInitArgs`, which `CachedRepresentation` subclasses.



---

archive/issue_comments_260035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T16:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260035",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260036.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> This statement is needs correcting:\n> {{{#!diff\n> -When the first factor is infinite (or not known to be finite), it still\n> +When all but the first factor is known to be finite, it\n>  uses the lexicographic order::\n> }}}\n\nI have rephrased in a similar way for clarity",
    "created_at": "2022-08-13T17:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260036",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 tscrim]:
> This statement is needs correcting:
> {{{#!diff
> -When the first factor is infinite (or not known to be finite), it still
> +When all but the first factor is known to be finite, it
>  uses the lexicographic order::
> }}}

I have rephrased in a similar way for clarity



---

archive/issue_comments_260037.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T17:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260037",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260038.json:
```json
{
    "body": "Passes tests for me.",
    "created_at": "2022-08-13T19:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260038",
    "user": "@jhpalmieri"
}
```

Passes tests for me.



---

archive/issue_comments_260039.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T19:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260039",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T20:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260040",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260041.json:
```json
{
    "body": "Replying to [comment:65 mkoeppe]:\n> when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.\n> \n> I agree with this, it needs to be corrected.\n> \n> {{{\n> sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator\n> sage: F = EnumeratedSetFromIterator(lambda: iter([1, 2]))\n> sage: F.category()\n> Category of facade enumerated sets\n> sage: cartesian_product([F, F]) is cartesian_product([F, F])   # as intended\n> False\n> sage: cartesian_product([F, F]) == cartesian_product([F, F])   # BUG\n> False\n> }}}\n\nI have added this test (still fails)",
    "created_at": "2022-08-13T20:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260041",
    "user": "@mkoeppe"
}
```

Replying to [comment:65 mkoeppe]:
> when I disabled `UniqueRepresentation`, I also need to disable `WithEqualityById`.
> 
> I agree with this, it needs to be corrected.
> 
> {{{
> sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
> sage: F = EnumeratedSetFromIterator(lambda: iter([1, 2]))
> sage: F.category()
> Category of facade enumerated sets
> sage: cartesian_product([F, F]) is cartesian_product([F, F])   # as intended
> False
> sage: cartesian_product([F, F]) == cartesian_product([F, F])   # BUG
> False
> }}}

I have added this test (still fails)



---

archive/issue_comments_260042.json:
```json
{
    "body": "Maybe this is a stupid question, but should that doctest pass? According to the documentation for `EnumeratedSetFromIterator`:\n\n```\n    - ``category`` -- (default: ``None``) an optional category for that\n      enumerated set. If you know that your iterator will stop after a finite\n      number of steps you should set it as :class:`FiniteEnumeratedSets`, conversely if\n      you know that your iterator will run over and over you should set it as\n      :class:`InfiniteEnumeratedSets`.\n```\n\nIf we use \n\n```\nF = EnumeratedSetFromIterator(lambda: iter([1, 2]), category=FiniteEnumeratedSets())\n```\n\nthen the doctest passes. How is it supposed to function if it doesn't know whether the arguments are finite?",
    "created_at": "2022-08-13T21:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260042",
    "user": "@jhpalmieri"
}
```

Maybe this is a stupid question, but should that doctest pass? According to the documentation for `EnumeratedSetFromIterator`:

```
    - ``category`` -- (default: ``None``) an optional category for that
      enumerated set. If you know that your iterator will stop after a finite
      number of steps you should set it as :class:`FiniteEnumeratedSets`, conversely if
      you know that your iterator will run over and over you should set it as
      :class:`InfiniteEnumeratedSets`.
```

If we use 

```
F = EnumeratedSetFromIterator(lambda: iter([1, 2]), category=FiniteEnumeratedSets())
```

then the doctest passes. How is it supposed to function if it doesn't know whether the arguments are finite?



---

archive/issue_comments_260043.json:
```json
{
    "body": "At the moment, there's no code for it because `CartesianProduct` just relies on `WithEqualityById`. \n\nTo give equality to Cartesian products without `WithEqualityById`, we could just compare the factors for equality (this is if-and-only-if because no flattening is implemented in our Cartesian products). In the example, the factors are `EnumeratedSetFromIterator`, and for these `__eq__` just loops to exhaustion to decide equality.",
    "created_at": "2022-08-13T21:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260043",
    "user": "@mkoeppe"
}
```

At the moment, there's no code for it because `CartesianProduct` just relies on `WithEqualityById`. 

To give equality to Cartesian products without `WithEqualityById`, we could just compare the factors for equality (this is if-and-only-if because no flattening is implemented in our Cartesian products). In the example, the factors are `EnumeratedSetFromIterator`, and for these `__eq__` just loops to exhaustion to decide equality.



---

archive/issue_comments_260044.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T21:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260044",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260045.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T23:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260045",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260046.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T23:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260046",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260047.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-13T23:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260047",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260048.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> Something else to be aware of is elements of `cartesian_product` are actual Sage elements rather than `list`s. So this could lead to performance regressions. Lots of things use the `CFM_tensor` class; all of the Hopf algebras basically. We might want a base or sub class of the `cartesian_product` that acts as a fa\u00e7ade parent for tuples. So the only difference is essentially in the `_element_constructor_` and/or `__call__`.\n\nThe choice of element class is now set in the subclass `CartesianProduct_with_element_wrapper` of `CartesianProduct_base`",
    "created_at": "2022-08-13T23:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260048",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 tscrim]:
> Something else to be aware of is elements of `cartesian_product` are actual Sage elements rather than `list`s. So this could lead to performance regressions. Lots of things use the `CFM_tensor` class; all of the Hopf algebras basically. We might want a base or sub class of the `cartesian_product` that acts as a façade parent for tuples. So the only difference is essentially in the `_element_constructor_` and/or `__call__`.

The choice of element class is now set in the subclass `CartesianProduct_with_element_wrapper` of `CartesianProduct_base`



---

archive/issue_comments_260049.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-14T00:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260049",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260050.json:
```json
{
    "body": "Replying to [comment:71 mkoeppe]:\n> Replying to [comment:69 tscrim]:\n> > IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.\n> \n> Sure it is\n\nI have a clean implementation now",
    "created_at": "2022-08-14T00:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260050",
    "user": "@mkoeppe"
}
```

Replying to [comment:71 mkoeppe]:
> Replying to [comment:69 tscrim]:
> > IMO, what you are doing has a very strong code smell as it is breaking many rules of OOP.
> 
> Sure it is

I have a clean implementation now



---

archive/issue_comments_260051.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-14T00:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260051",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-14T01:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260052",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260053.json:
```json
{
    "body": "Some MRO problems in sage/rings/asymptotic",
    "created_at": "2022-08-14T04:23:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260053",
    "user": "@mkoeppe"
}
```

Some MRO problems in sage/rings/asymptotic



---

archive/issue_comments_260054.json:
```json
{
    "body": "Yes, I see those, too.",
    "created_at": "2022-08-15T22:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260054",
    "user": "@jhpalmieri"
}
```

Yes, I see those, too.



---

archive/issue_comments_260055.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-08-17T00:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260055",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_260056.json:
```json
{
    "body": "The MRO errors are gone now, but in the same files I get errors like the following.\n\n```\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/structure/unique_representation.py\", line 569, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 471, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2380)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/rings/asymptotic/growth_group_cartesian.py\", line 1444, in __init__\n        super(UnivariateProduct, self).__init__(\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/rings/asymptotic/growth_group_cartesian.py\", line 311, in __init__\n        CartesianProductPoset.__init__(self, sets, category, order, **kwds)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/combinat/posets/cartesian_product.py\", line 114, in __init__\n        super().__init__(sets, category, **kwargs)\n    TypeError: __init__() missing 1 required positional argument: 'category'\n```\n\n\nI think what's happening there is that `super().__init__` is being used in a situation where the `__init__` methods do not have compatible signatures.\n\n\n```\nclass GenericGrowthGroup(UniqueRepresentation, Parent, WithLocals):\n    def __init__(self, base, category, var): ...\nclass CartesianProduct_base(WithPicklingByInitArgs, Parent):\n    def __init__(self, sets, category, flatten=False): ...\nclass CartesianProductPoset(CartesianProduct_unique):\n    def __init__(self, sets, category, order=None, **kwargs):\n```\n",
    "created_at": "2022-08-17T01:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260056",
    "user": "@mkoeppe"
}
```

The MRO errors are gone now, but in the same files I get errors like the following.

```
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/structure/unique_representation.py", line 569, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 471, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2380)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/rings/asymptotic/growth_group_cartesian.py", line 1444, in __init__
        super(UnivariateProduct, self).__init__(
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/rings/asymptotic/growth_group_cartesian.py", line 311, in __init__
        CartesianProductPoset.__init__(self, sets, category, order, **kwds)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/combinat/posets/cartesian_product.py", line 114, in __init__
        super().__init__(sets, category, **kwargs)
    TypeError: __init__() missing 1 required positional argument: 'category'
```


I think what's happening there is that `super().__init__` is being used in a situation where the `__init__` methods do not have compatible signatures.


```
class GenericGrowthGroup(UniqueRepresentation, Parent, WithLocals):
    def __init__(self, base, category, var): ...
class CartesianProduct_base(WithPicklingByInitArgs, Parent):
    def __init__(self, sets, category, flatten=False): ...
class CartesianProductPoset(CartesianProduct_unique):
    def __init__(self, sets, category, order=None, **kwargs):
```




---

archive/issue_comments_260057.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-17T01:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260057",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260058.json:
```json
{
    "body": "Now what remains are lots of infinite recursions involving `_element_constructor_` in sage/rings/asymptotic",
    "created_at": "2022-08-17T01:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18958#issuecomment-260058",
    "user": "@mkoeppe"
}
```

Now what remains are lots of infinite recursions involving `_element_constructor_` in sage/rings/asymptotic
