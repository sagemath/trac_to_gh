# Issue 28474: Fix spkg-install of p_group_cohomology

Issue created by migration from https://trac.sagemath.org/ticket/28711

Original creator: SimonKing

Original creation time: 2019-11-08 22:02:35

CC:  embray jhpalmieri mjo fbissey dimpase

The three parts of p_group_cohomology, namely a c-library libmodres and a bunch of Cython and Python modules and a documentation using sphinx, are supposed to allow DESTDIR install. However, if I understand correctly, the current spkg-install script prevents this. The purpose of this ticket is to fix it.


---

Comment by SimonKing created at 2019-11-08 22:02:55

The spkg-install script does use sdh_configure, sdh_make and sdh_pip_install, but is also uses "$MAKE install" and "$MAKE html" and "cp -r". I guess "$MAKE install" should become "sdh_make_install", but I don't know what to do with "$MAKE html" and "cp -r" which is used to build and install the package documentation.


---

Comment by jhpalmieri created at 2019-11-08 22:15:57

Can you use `$MAKE html` to build the documentation and then `sdh_install` to install it?


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-07-15 21:24:07

Also it looks like dependencies are not right.
https://github.com/mkoeppe/sage/runs/874569119


---

Comment by jhpalmieri created at 2020-07-15 21:35:17

There have for a long time been issues with installation of `p_group_cohomology`: it seems that you have to install `meataxe` and then run `sage -b` and then install `p_group_cohomology`. Something like that, anyway. If someone could straighten that out, that would be great.


---

Comment by fbissey created at 2020-07-15 21:39:31

I have been reluctant to work on `p_group_cohomology` for a long time because of the state of `meataxe` - in the installation department. I am not planning to work on this until there is proof of improvement. In the past I would have been willing to help with that, nowadays I am considering myself overcommitted already.


---

Comment by mkoeppe created at 2020-07-15 21:42:38

Thanks for the info. Then let's postpone work on this until after modularization of sagelib, which will eliminate this complicated dependency.


---

Comment by SimonKing created at 2020-10-15 16:28:25

There is an issue that came up at #30349: Apparently there is a problem with the installation folder of gap code that is part of the package. It isn't clear to me how this should be fixed.


---

Comment by SimonKing created at 2020-10-15 16:33:14

On the other ticket, Dima stated:

///

You can call GAP and examine GAPInfo.RootPaths. When looking for a package, GAP appends pkg/ to each directory in this list, cf. 9.2 GAP Root Directories in its manual.

IMHO, Python wheels are build to be relocateable, so it's futile to try to install GAP data via setup.py. I'd say, install a GAP package separately, not from setup.py from spkg-install. By the way, GAP now has its own package manager. Maybe you can use it (​https://github.com/gap-packages/PackageManager) - it's in gap_packages, I think. 

///

So, I'll have a look at it.

Question: When using GAP's package manager, it would probably be possible to do it in the setup.py, using libgap. Should I keep it there, or is it cleaner to move installation of GAP code to spkg-install?


---

Comment by dimpase created at 2020-10-15 18:49:52

one can do this in setup.py regardless, getting a proper path to install a GAP package to is just

```
sage: next(filter(lambda l: l.sage().startswith(SAGE_LOCAL), libgap.eval('GAPInfo.RootPaths'))).sage()+'pkg/'                                                                                                                          
'/mnt/opt/Sage/sage-dev/local/share/gap/pkg/'
```



---

Comment by dimpase created at 2020-10-15 18:52:38

not sure how "pythonic" this is though.


---

Comment by SimonKing created at 2020-10-15 20:29:05

Replying to [comment:14 SimonKing]:
> IMHO, Python wheels are build to be relocateable, so it's futile to try to install GAP data via setup.py. I'd say, install a GAP package separately, not from setup.py from spkg-install. By the way, GAP now has its own package manager. Maybe you can use it (​https://github.com/gap-packages/PackageManager) - it's in gap_packages, I think. 

Do I understand correctly that GAP's PackageManager is for installing packages from the GAP ecosystem? What I want to do is to use some GAP code that is NOT an upstream GAP package (not even an unofficial "submitted" package).

Anyway, using some GAP infrastructure to install my files, rather than hacking paths, seems the right approach to me.


---

Comment by SimonKing created at 2020-10-15 20:46:12

I see one and a half clear disadvantages of the PackageManager:

The PackageManager is provided by the gap_packages spkg. Thus, p_group_cohomology would need yet another dependency. I'd rather avoid to add it. It should be enough to have the Small Groups library in GAP (which I think meanwhile is available without installing optional spkgs).

The "half" disadvantage is the GAP-typical lack of a clear documentation. The documentation of InstallPackage says that one way to install a package is to provide the URL of a valid PackageInfo.g file. But nowhere is defined (at least I couldn't find it at https://gap-packages.github.io/PackageManager/doc/chap0.html) what constitutes a "valid" PackageInfo.g file.

In other words, it is explained how to install a package, but it is not explained how to create a package that can be installed.

Do you have pointers how to create a GAP package?


---

Comment by SimonKing created at 2020-10-15 20:47:25

PS: I just installed the gap_package spkg, but apparently it does not provide the PackageManager.

So, I guess it is no option.


---

Comment by SimonKing created at 2020-10-15 21:43:44

I am unhappy, because I don't see a good solution for the installation problems of the GAP parts of the spkg.

WHAT NEEDS TO BE AVAILABLE:
- A couple of .g files, containing function definitions.

CURRENT APPROACH:
- Install the files into $SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/
- Let setup.py do the installation

CURRENT PROBLEM:
- As reported on #30349, Sage totally messes up the path. Note that I have never seen that problem, myself.
- It is argued that installation of the .g files should be done in spkg-install, not in setup.py.

ALTERNATIVE APPROACH:
- Put the files somewhere else, such as $SAGE_LOCAL/share/gap/pkg/
- Let spkg-install do the installation, perhaps via some GAP tool

PROBLEM WITH THE ALTERNATIVE APPROACH:
- I don't consider the couple of .g files a "package" for GAP.
- Potential GAP tools seem to be not part of the gap_packages spkg. Thus, aren't readily available in Sage.

So, I believe the current approach is just fine: We need a place for some GAP readable files, that logically belong to a Sage package (p_group_cohomology) but can hardly be seen a stand-alone GAP package. Thus, some place in $SAGE_LOCAL/share/sage/ext/gap seems just right to me.

Only we need to understand why, according to #30349, Sage puts stuff into $SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/, although setup.py clearly states, `data_files=[(os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")`.


---

Comment by SimonKing created at 2020-10-15 21:49:36

AHA! Can it be that $SAGE_LOCAL/share/sage has been removed?

```
sage: 'sage' in os.listdir(os.path.join(SAGE_LOCAL,"share"))                                                       
False
sage: 'gap' in os.listdir(os.path.join(SAGE_LOCAL,"share"))                                                        
True
```


Then of course a different location is needed. In that case, os.listdir(os.path.join(SAGE_LOCAL,"share","gap","pkg","p_group_cohomology")) seems good to me.

EDIT: Since it isn't really a GAP package, os.listdir(os.path.join(SAGE_LOCAL,"share","p_group_cohomology")) seems better!


---

Comment by mkoeppe created at 2020-10-15 21:59:57

Replying to [comment:20 SimonKing]:
> I am unhappy, because I don't see a good solution for the installation problems of the GAP parts of the spkg.
> 
> WHAT NEEDS TO BE AVAILABLE:
> - A couple of .g files, containing function definitions.

I think such data files should just be installed next to the python files of the package.
Just like `src/sage/interfaces/sage-maxima.lisp`


---

Comment by mkoeppe created at 2020-10-15 22:02:19

It should definitely not depend on the environment variable `SAGE_LOCAL` at all.
Background: pip-installable packages should be installable into various virtual environments.


---

Comment by SimonKing created at 2020-10-15 22:02:58

Replying to [comment:22 mkoeppe]:
> I think such data files should just be installed next to the python files of the package.
> Just like `src/sage/interfaces/sage-maxima.lisp`

Does it mean you suggest that the python and cython files be moved into the sage src library?


---

Comment by SimonKing created at 2020-10-15 22:07:25

Replying to [comment:23 mkoeppe]:
> It should definitely not depend on the environment variable `SAGE_LOCAL` at all.
> Background: pip-installable packages should be installable into various virtual environments. 

I don't understand that. Do you say that a fixed Sage installation has no fixed paths relative to SAGE_ROOT? Then how can any spkg tell where stuff ought to be installed?

Does it also mean I cannot keep the cohomology ring data base in its current location?


---

Comment by mkoeppe created at 2020-10-15 22:12:32

Non-Python packages will continue to be installed into SAGE_LOCAL (which defaults to SAGE_ROOT/local but can be configured differently already now) by the Sage distribution.
In Sage 9.3, users will have more flexibility where Python packages such as sagelib are installed.


---

Comment by SimonKing created at 2020-10-15 22:25:37

Replying to [comment:26 mkoeppe]:
> Non-Python packages will continue to be installed into SAGE_LOCAL (which defaults to SAGE_ROOT/local but can be configured differently already now) by the Sage distribution.
> In Sage 9.3, users will have more flexibility where Python packages such as sagelib are installed.

Argh. Sounds like a lot of work.

Problems:
- Where to install the data base? It used to be put into SAGE_SHARE. Is it still fine?
- Do we put the Python and Cython files into SAGE_SRC? Then:
  - Is it really ok to have a Python file float around that cannot be imported unless some optional package is installed?
  - Can one build the documentation of optional Cython extension modules?
  - Can one make all doc tests optional without adding "#optional: p_group_cohomology" into each line?


---

Comment by mkoeppe created at 2020-10-16 00:55:10

Actually there is nothing wrong with keeping the Python/Cython part of your package separate from the Sage source tree. It should just be made sure that it is pip-installable into an arbitrary Python environment and does not try to use SAGE_LOCAL or SAGE_SHARE to determine installation locations.


---

Comment by mkoeppe created at 2020-10-16 05:45:43

On the Sage packaging side, a package `modular_resolution` should probably be split out from the package `p_group_cohomology` and become a dependency. 

I assume that only the !Python/Cython part of `p_group_cohomology`, not the C library, depends on `meataxe`?


---

Comment by SimonKing created at 2020-10-16 06:10:06

Replying to [comment:29 mkoeppe]:
> On the Sage packaging side, a package `modular_resolution` should probably be split out from the package `p_group_cohomology` and become a dependency. 

The problem I have with that depends on the definition of "can", when you say it "can" independently be used. I believe splitting `modular_resolution` off makes no sense. If one uses `modular_resolution`, one would also use `p_group_cohomology`-

> I assume that only the !Python/Cython part of `p_group_cohomology`, not the C library, depends on `meataxe`?

Wrong. The C library, that I inherited from David Green, makes intense use of meataxe, and is the only reason why I added meataxe as an optional spkg.


---

Comment by SimonKing created at 2020-10-16 08:11:00

Replying to [comment:28 mkoeppe]:
> Actually there is nothing wrong with keeping the Python/Cython part of your package separate from the Sage source tree. It should just be made sure that it is pip-installable into an arbitrary Python environment and does not try to use SAGE_LOCAL or SAGE_SHARE to determine installation locations.

That's what currently is the case. As you can see from spkg-install, installation of stuff is using pip.

The only question is where to install the data base, and where/how to install the .g files.

Concerning the data base: Currently the data base is installed when installing the C library `libmodres`. Requirements: It must be a location that is readable for all users of Sage; write permission is only needed during package installation. So, what I currently do in Makefile.am, namely

```
dbdir           = $(datadir)/pGroupCohomology
dist_db_DATA    = group_cohomology_database.tar
install-data-hook:
        cd $(DESTDIR)$(dbdir) && tar xf $(dist_db_DATA) && rm $(dist_db_DATA)

uninstall-hook:
        rm -r $(DESTDIR)$(dbdir)
```

should be the right thing to do, shouldn't it??

Concerning the .g files: If I understand correctly, many GAP packages are installed by just unpacking a .tar.gz into GAP's pkg/ folder. So, I could imagine to create a mock GAP package `pGroupCohomologyHelpers` ("Helpers" meaning that the package is not supposed to be of any use on its own), by creating a folder `/pGroupCohomologyHelpers` in GAP's `pkg/` folder, which contains a file `init.g`, that in turn reads the code from my current .g files (that perhaps should be renamed as .gap files).

Then, one could just do libgap.LoadPackage("pGroupCohomologyHelpers"), without the trouble to explicitly referring to the SAGE_LOCAL variable at run time.

The question is: How to locate GAP's `pkg/` folder at installation time, without messing around with SAGE_LOCAL? How can I make GAP reveal the location, using a shell command, so that spkg-install can install the .g files?


---

Comment by SimonKing created at 2020-10-16 10:04:34

I changed the ticket description. Do you agree that it correctly reflects the discussion so far?

If I see that correctly, only two real issues remain: How to determine GAP's pkg folder during installation? How to install the documentation after building it?


---

Comment by SimonKing created at 2020-10-16 11:03:42

Is it safe to assume that GAP's pkg folder lies in DESTDIR/share/gap/pkg/?

If so, then I think the two issues actually boil down to a single question: What syntax to use for sdh_install to let spkg-install put stuff in a sub-folder of DESTDIR?


---

Comment by dimpase created at 2020-10-16 11:14:28

Replying to [comment:19 SimonKing]:
> PS: I just installed the gap_package spkg, but apparently it does not provide the PackageManager.
> 
> So, I guess it is no option.

oops, it's not in the current GAP 4.10 bundled with Sage, but it is in GAP 4.11 (#29314) - although 
now I see I didn't include it in #29314 - although it can be done. 

Unfortunately #29314 is  getting stuck on Volker's buildbot, only him seems to be able to debug the problem :-(


---

Comment by SimonKing created at 2020-10-16 11:34:21

Replying to [comment:34 dimpase]:
> oops, it's not in the current GAP 4.10 bundled with Sage, but it is in GAP 4.11 (#29314) - although 
> now I see I didn't include it in #29314 - although it can be done. 

Even if the package manager could be included, I think one should try to not make it a dependency.

*If* we agree that creating a !pGroupCohomologyHelpers module for GAP, being put into GAP's pkg/ folder, is a clean solution, and *if* ((GAP is able to tell the pkg/ folder's path) or (DESTDIR/share/gap/pkg is safe to use)), then we don't need GAP's package manager. sdh_install (as soon as someone gives me a pointer to its documentation) would be enough.


---

Comment by dimpase created at 2020-10-16 12:27:42

Replying to [comment:35 SimonKing]:
> Replying to [comment:34 dimpase]:
> > oops, it's not in the current GAP 4.10 bundled with Sage, but it is in GAP 4.11 (#29314) - although 
> > now I see I didn't include it in #29314 - although it can be done. 
> 
> Even if the package manager could be included, I think one should try to not make it a dependency.
> 
> *If* we agree that creating a !pGroupCohomologyHelpers module for GAP, being put into GAP's pkg/ folder, is a clean solution, 

if you don't do this then you'd need to use GAP's `Read()` rather than `LoadPackage()` to load the
GAP files, and then you'd need to use the full path to the files.

One can try using https://github.com/gap-system/PackageMaker to generate the needed for a package boilerplate.



> and *if* ((GAP is able to tell the pkg/ folder's path) or (DESTDIR/share/gap/pkg is safe to use)), then we don't need GAP's package manager.

we can put `PackageManager` into `gap` rather than `gap_packages`, then it won't be a dependency.


> sdh_install (as soon as someone gives me a pointer to its documentation) would be enough.
see its source with comments in 
`build/bin/sage-dist-helpers`

(that's all the docs there are, ATM, I think)


---

Comment by dimpase created at 2020-10-16 13:18:53

I played a bit with GAP's PackageMaker, it produced the following:

https://github.com/dimpase/p_group_cohomology_helper

(this is just a boilerplate with your address etc, no actual GAP code added). Hope this helps.


---

Comment by SimonKing created at 2020-10-16 13:38:54

Replying to [comment:37 dimpase]:
> I played a bit with GAP's PackageMaker, it produced the following:
> 
> https://github.com/dimpase/p_group_cohomology_helper
> 
> (this is just a boilerplate with your address etc, no actual GAP code added). Hope this helps.

Thank you!

It sounds like a lot of work to change the current code in the required format for a package.

I wonder what functions I'd need to declare as global functions. Currently, the code is split into several .g files: GapMaxels.g, GapMB.g, GapSgs.g. Suppose a function from GapMaxels is used in GapMB: Do I need to declare such function as global? And if a function from GapMB is used in another function of GapMB: Do I need to declare such function as global?

Is it really needed to make a full package (even if it is boiler plate)? My hope was that I can keep it simpler and that I wouldn't need to write separate documentation for David Green's GAP code.

EDIT: I cloned your github repository.


---

Comment by SimonKing created at 2020-10-16 13:58:50

Replying to [comment:36 dimpase]:
> > sdh_install (as soon as someone gives me a pointer to its documentation) would be enough.
> see its source with comments in 
> `build/bin/sage-dist-helpers`
> 
> (that's all the docs there are, ATM, I think)

It says

```
# - sdh_install [-T] SRC [SRC...] DEST
#
#    Copies one or more files or directories given as SRC (recursively in the
#    case of directories) into the destination directory DEST, while ensuring
#    that DEST and all its parent directories exist.  DEST should be a path
#    under $SAGE_LOCAL, generally.  For DESTDIR installs the $SAGE_DESTDIR path
#    is automatically prepended to the destination.
#
#    The -T option treats DEST as a normal file instead (e.g. for copying a
#    file to a different filename).  All directory components are still created
#    in this case.
```


Does it mean that when one provide a path `os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")` in setup.py, then $SAGE_DESTDIR would be prepended to this ABSOLUTE path??? It seems this is the exactly how the install path of my GAP files got messed up as reported in #30349!! I'll add a comment there.


---

Comment by dimpase created at 2020-10-16 14:11:43

I'm away from keyboard until late pm. I guess it should not be hard to wrap this up as a hotfix, though


---

Comment by SimonKing created at 2020-10-16 16:30:47

Replying to [comment:37 dimpase]:
> I played a bit with GAP's PackageMaker, it produced the following:
> 
> https://github.com/dimpase/p_group_cohomology_helper
> 
> (this is just a boilerplate with your address etc, no actual GAP code added). Hope this helps.

I have created a fork and made the package actually usable. See https://github.com/simon-king-jena/p_group_cohomology_helper


---

Comment by jhpalmieri created at 2020-10-16 16:36:08

FYI: there is some documentation on `sdh_install` and related functions in the Developer's Guide: https://doc.sagemath.org/html/en/developer/packaging.html#helper-functions. It's the same as in `build/bin/sage-dist-helpers`, but at least the documentation is public.


---

Comment by SimonKing created at 2020-10-16 16:49:28

In spkg-install, I currently have

```
# building modular_resolution
cd `ls -d modular_resolution*`
sdh_configure || sdh_die "Error configuring modular_resolution"
sdh_make || sdh_die "Error making modular_resolution"
# sdh_make install got broken by trac ticket #24106
$MAKE install || sdh_die "Error installing modular_resolution"
cd ..
```


Has sdh_make_install been fixed? Is it enough to just do

```
# build and install modular_resolution
cd `ls -d modular_resolution*`
sdh_configure || sdh_die "Error configuring modular_resolution"
sdh_make_install || sdh_die "Error making modular_resolution"
cd ..
```

?


---

Comment by jhpalmieri created at 2020-10-16 17:47:46

I don't know your answer about `sdh_make_install`, but the code could just read

```
cd ...
sdh_configure
sdh_make_install # assuming this works
```

`sdh_die` is called automatically by the other helper functions, so you don't need to call it yourself.

Re #24106: do you know what got broken? I don't see any comments or notes about follow-ups on that ticket.


---

Comment by mkoeppe created at 2020-10-16 17:50:39

Replying to [comment:39 SimonKing]:
> Does it mean that when one provide a path `os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")` in setup.py, then $SAGE_DESTDIR would be prepended to this ABSOLUTE path?

Yes, that's how the staged install works.


---

Comment by SimonKing created at 2020-10-16 18:01:02

Replying to [comment:45 mkoeppe]:
> Replying to [comment:39 SimonKing]:
> > Does it mean that when one provide a path `os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")` in setup.py, then $SAGE_DESTDIR would be prepended to this ABSOLUTE path?
> 
> Yes, that's how the staged install works.

So, you say that MOST spkgs are currently broken, because they have all things like this in spkg-install?

```
sdh_install doc/ref doc/tut "$SAGE_SHARE/doc/gap/"
sdh_install -T src "${SAGE_SHARE}/jmol"
```

Just grep for SAGE_SHARE or SAGE_LOCAL in `$SAGE_ROOT/build/pkgs`.


---

Comment by SimonKing created at 2020-10-16 18:09:13

It seems to me that #30151 will not be available soon. So, in order to fix spkg-install of p_group_cohomology SOON, I suggest to remove this dependency.

Since #29152 may soon be reviewed (and fixes something with meataxe), it could make sense to replace #30151 by #29152 as a dependency. But not STRICTLY needed, IMHO.


---

Comment by mkoeppe created at 2020-10-16 18:23:23

Replying to [comment:46 SimonKing]:
> So, you say that MOST spkgs are currently broken

No. `sdh_install` works. It installs into `SAGE_DESTDIR` and then `sage-spkg` copies from there to the actual install directory.


---

Comment by mkoeppe created at 2020-10-16 18:25:40

Replying to [comment:47 SimonKing]:
> It seems to me that #30151 will not be available soon. So, in order to fix spkg-install of p_group_cohomology SOON, I suggest to remove this dependency.

Without #30151, there is no non-broken way to make sure that the optional extension depending on meataxe is already installed.


---

Comment by mkoeppe created at 2020-10-16 18:30:24

Replying to [comment:33 SimonKing]:
> Is it safe to assume that GAP's pkg folder lies in DESTDIR/share/gap/pkg/?

No. The C library package should either have a configure option for the gap install directory, or should discover it from a gap executable in PATH.


---

Comment by mkoeppe created at 2020-10-16 18:30:35

(deleted)


---

Comment by mkoeppe created at 2020-10-16 18:32:38

Replying to [comment:31 SimonKing]:
> Replying to [comment:28 mkoeppe]:
> > Actually there is nothing wrong with keeping the Python/Cython part of your package separate from the Sage source tree. It should just be made sure that it is pip-installable into an arbitrary Python environment and does not try to use SAGE_LOCAL or SAGE_SHARE to determine installation locations.
> 
> That's what currently is the case. As you can see from spkg-install, installation of stuff is using pip.

Yes, but it should be separate package - whose spkg-install only contains `sdh_pip_install` and nothing else


---

Comment by SimonKing created at 2020-10-16 18:33:04

Replying to [comment:49 mkoeppe]: 
> Without #30151, there is no non-broken way to make sure that the optional extension depending on meataxe is already installed.

How is the following broken?

```
# Check if meataxe was properly installed
sage -c "import sage.libs.meataxe" || sdh_die "sage.libs.meataxe cannot be imported. To solve this, it is enough to retry installation of p_group_cohomology"
```



---

Comment by mkoeppe created at 2020-10-16 18:37:15

It is broken because it is not reflected in the declared `dependencies` of the package.


---

Comment by mkoeppe created at 2020-10-16 18:38:03

Thus, it is not possible to install it robustly using `./configure --enable-meataxe --enable-p_group_cohomology && make`


---

Comment by SimonKing created at 2020-10-16 18:38:39

Replying to [comment:50 mkoeppe]:
> Replying to [comment:33 SimonKing]:
> > Is it safe to assume that GAP's pkg folder lies in DESTDIR/share/gap/pkg/?
> 
> No. The C library package should either have a configure option for the gap install directory, or should discover it from a gap executable in PATH.

What do you mean by "the C library package"? If you mean modular_resolution: This has never been related with installation of the GAP part of the package.

Anyway. In the branch that I am currently testing (not posted yet), it is the job of spkg-install to put the Singular and GAP helpers into the right places, `"$SAGE_SHARE/singular/LIB/"` or `"$SAGE_SHARE/gap/pkg/"`, using sdh_install. I'll see if this works for me, then post it here, and then you can tell if that's fine.


---

Comment by SimonKing created at 2020-10-16 18:40:50

Replying to [comment:54 mkoeppe]:
> It is broken because it is not reflected in the declared `dependencies` of the package.

Right. But waiting for #30151 means that for a potentially long time, p_group_cohomology will not install. When we keep the current check for meataxe, it may be broken, but it will build.


---

Comment by mkoeppe created at 2020-10-16 19:05:20

Replying to [comment:56 SimonKing]:
> What do you mean by "the C library package"? If you mean modular_resolution: This has never been related with installation of the GAP part of the package.

OK, thanks for the clarification. I retract this particular suggestion then.

> Anyway. In the branch that I am currently testing (not posted yet), it is the job of spkg-install to put the Singular and GAP helpers into the right places, `"$SAGE_SHARE/singular/LIB/"` or `"$SAGE_SHARE/gap/pkg/"`, using sdh_install. I'll see if this works for me, then post it here, and then you can tell if that's fine.

This is not good - an spkg should either be a pip-installable Python package, or it should be a non-Python package (which can install anywhere in SAGE_LOCAL).


---

Comment by SimonKing created at 2020-10-16 19:05:26

Something else is broken: Trying to install, I get

```
[p_group_cohomology-3.3.2]   creating build/temp.linux-x86_64-3.7/build/c_files-3.7/pGroupCohomology
[p_group_cohomology-3.3.2]   gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g -fstack-protector-strong -Wformat -Werror=format-security -g -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -I/home/king/Sage/git/py3/local/lib/python3.7/site-packages/sage/cpython -I/home/king/Sage/git/py3/local/lib/python3.7/site-packages/cysignals -I/home/king/Sage/git/py3/local/lib/python3.7/site-packages -I/home/king/Sage/git/py3/local/lib/python3.7/site-packages/sage/ext -I/usr/include/python3.7m -I/home/king/Sage/git/py3/local/lib/python3.7/site-packages/numpy/core/include -I/home/king/Sage/git/py3/local/include -I/usr/include/python3.7m -c build/c_files-3.7/pGroupCohomology/resolution.c -o build/temp.linux-x86_64-3.7/build/c_files-3.7/pGroupCohomology/resolution.o
[p_group_cohomology-3.3.2]   build/c_files-3.7/pGroupCohomology/resolution.c:644:39: fatal error: modular_resolution/pgroup.h: No such file or directory
[p_group_cohomology-3.3.2]   compilation terminated.
[p_group_cohomology-3.3.2]   error: command 'gcc' failed with exit status 1
[p_group_cohomology-3.3.2]   Building wheel for pGroupCohomology (setup.py): finished with status 'error'
[p_group_cohomology-3.3.2]   ERROR: Failed building wheel for pGroupCohomology
[p_group_cohomology-3.3.2]   Running setup.py clean for pGroupCohomology
[p_group_cohomology-3.3.2]   Running command /home/king/Sage/git/py3/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-req-build-vx2ktc1p/setup.py'"'"'; __file__='"'"'/tmp/pip-req-build-vx2ktc1p/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' clean --all
[p_group_cohomology-3.3.2]   running clean
```

Why the hack is `pgrou.h` not found? It is supposed to be installed by making modular_resolution, which has worked and hasn't changed since a long time.


---

Comment by SimonKing created at 2020-10-16 19:07:43

Replying to [comment:58 mkoeppe]:
> This is not good - an spkg should either be a pip-installable Python package, or it should be a non-Python package (which can install anywhere in SAGE_LOCAL).

What about C libraries? What about additional files needed to make a pip-installable python package work?


---

Comment by mkoeppe created at 2020-10-16 19:08:46

Replying to [comment:60 SimonKing]:
> Replying to [comment:58 mkoeppe]:
> > This is not good - an spkg should either be a pip-installable Python package, or it should be a non-Python package (which can install anywhere in SAGE_LOCAL).
> 
> What about C libraries? What about additional files needed to make a pip-installable python package work?

Anything that `setup.py` builds, including extension modules, is fine.

Standalone libraries that would be installed in $SAGE_LOCAL/lib/ are not fine.


---

Comment by SimonKing created at 2020-10-16 19:13:49

Replying to [comment:59 SimonKing]:
> Why the hack is `pgrou.h` not found? It is supposed to be installed by making modular_resolution, which has worked and hasn't changed since a long time.

This is (I guess) the moment when pgroup.h is supposed to be installed:

```
[p_group_cohomology-3.3.2]  /usr/bin/install -c -m 644 fileplus.h fp_decls.h modular_resolution.h pgroup.h pgroup_decls.h nDiag.h urbild_decls.h nBuchberger_decls.h pcommon.h slice_decls.h '/home/king/Sage/git/py3/local/var/tmp/sage/build/p_group_cohomology-3.3.2/inst/home/king/Sage/git/py3/local/include/modular_resolution'
```


I guess it again is a staged process. But why stuff isn't moved to its final destination? modular_resolution uses an autotoolised build system, so, why is 

```
sdh_configure || sdh_die "Error configuring modular_resolution"
sdh_make_install || sdh_die "Error making modular_resolution"
```

not working any more?


---

Comment by SimonKing created at 2020-10-16 19:15:05

Replying to [comment:61 mkoeppe]:
> Standalone libraries that would be installed in $SAGE_LOCAL/lib/ are not fine.

That's a show stopper.

EDIT: Why and on what ticket has that changed?


---

Comment by SimonKing created at 2020-10-16 19:38:50

Replying to [comment:58 mkoeppe]:
> This is not good - an spkg should either be a pip-installable Python package, or it should be a non-Python package (which can install anywhere in SAGE_LOCAL).

When you say that an spkg shouldn't be formed by a python package and a non-python package, then you suggest to split p_group_cohomology.

Would the following be the right way to split the current p_group_cohomology spkg into three spkgs?
1. modular_resolution, depending on meataxe-the-C-library, that installs 
   - a standalone C library libmodres.so -- of course(!!) in $SAGE_LOCAL/lib, where else would a C library be installed?
   - some executables in $SAGE_LOCAL/bin, linked against libmodres
2. p_group_cohomology_helper, that installs
   - a GAP helper module in $SAGE_LOCAL/share/gap/pkg/
   - a Singular helper module in $SAGE_LOCAL/share/singular/LIB/
   - a data base in $SAGE_LOCAL/share/p_group_cohomology/
3. p_group_cohomology, depending on meataxe-the-Cython-extension, that is pip-installable

The computation of cohomology rings needs all the above! So, when you seriously state that "Standalone libraries that would be installed in $SAGE_LOCAL/lib/ are not fine.", then you should tell what to do instead.


---

Comment by SimonKing created at 2020-10-16 19:44:43

Replying to [comment:62 SimonKing]:
modular_resolution uses an autotoolised build system, so, why is 
> {{{
> sdh_configure || sdh_die "Error configuring modular_resolution"
> sdh_make_install || sdh_die "Error making modular_resolution"
> }}}
> not working any more?

Got it. In the previous version of spkg-install.in, it was stated that `# sdh_make install got broken by trac ticket #24106`. So, sdh_make_install apparently is still broken...


---

Comment by mkoeppe created at 2020-10-16 20:07:02

Replying to [comment:64 SimonKing]:
> Replying to [comment:58 mkoeppe]:
> > This is not good - an spkg should either be a pip-installable Python package, or it should be a non-Python package (which can install anywhere in SAGE_LOCAL).
> 
> When you say that an spkg shouldn't be formed by a python package and a non-python package, then you suggest to split p_group_cohomology.

Yes.

> Would the following be the right way to split the current p_group_cohomology spkg into three spkgs?
> 1. modular_resolution, depending on meataxe-the-C-library, that installs 
>    - a standalone C library libmodres.so -- of course(!!) in $SAGE_LOCAL/lib, where else would a C library be installed?
>    - some executables in $SAGE_LOCAL/bin, linked against libmodres

Yes.

> 2. p_group_cohomology_helper, that installs
>    - a GAP helper module in $SAGE_LOCAL/share/gap/pkg/
>    - a Singular helper module in $SAGE_LOCAL/share/singular/LIB/
>    - a data base in $SAGE_LOCAL/share/p_group_cohomology/

Perhaps; although it could also make sense to make them actually part of the pip-installable package -- in which case the install location would NOT be `$SAGE_LOCAL/share/...` but next to the Python modules (this would depend on setting some load paths for GAP or Singular so that the modules would be found, I suppose - but I do not know enough about these systems). In that case, the installation would be done using `setup.py`'s `package_data` or similar.

> 3. p_group_cohomology, depending on meataxe-the-Cython-extension, that is pip-installable

Yes.

> The computation of cohomology rings needs all the above! So, when you seriously state that "Standalone libraries that would be installed in `$SAGE_LOCAL/lib/` are not fine

... I meant here: for a Python package!

Non-Python packages, of course, will install in `$SAGE_LOCAL`.


---

Comment by SimonKing created at 2020-10-16 22:19:07

Something I don't understand (and has been broken before): When I open install the package including the documentation, then the documentation is built and installed --- but the resulting html files are broken. But if I open the p_group_cohomology tar ball, cd into pGroupCohomology-3.2.2/doc and do "make html" in a Sage shell, the resulting html files are fine (except that I am not totally happy about syntax highlighting for the examples in the documentation).

So, apparently there is a difference between building the documentation during `sage -i p_group_cohomology` and building the documentation manually. Although I believe what I described above (namely "make html" in a Sage shell) is exactly what happens during package installation, too.

Can someone explain the problem? The same problem occurred in previous versions of p_group_cohomology, so, I don't think I broke something.


---

Comment by jhpalmieri created at 2020-10-16 22:29:15

I'm not going to be much help for what's broken, but for the syntax highlighting, you might want to take all or parts of src/sage/docs/conf.py. In particular the lines 

```
from sphinx import highlighting
```

and

```
pygments_style = 'sphinx'
```

and

```
highlighting.lexers['ipycon'] = IPythonConsoleLexer(in1_regex=r'sage: ', in2_regex=r'[.][.][.][.]: ')
highlighting.lexers['ipython'] = IPyLexer()
highlight_language = 'ipycon'
```

are relevant.


---

Comment by SimonKing created at 2020-10-16 23:17:28

Replying to [comment:68 jhpalmieri]:
> I'm not going to be much help for what's broken, but for the syntax highlighting, you might want to take all or parts of src/sage/docs/conf.py. ...

Nice! Thank you! It now looks much better (at least when built manually).


---

Comment by SimonKing created at 2020-10-17 07:54:37

Unfortunately there is a problem with [travis-ci](https://travis-ci.org/github/sagemath/p_group_cohomology).

Testing fails before it was even tried to install p_group_cohomology. Namely, it fails when doing "sage -b" after installing meataxe. The error is:

```
make: *** No targets specified and no makefile found.  Stop.

The command "docker exec cohomology sage -b" failed and exited with 2 during .
```

Of course that command did work in the past.


---

Comment by SimonKing created at 2020-10-17 08:23:55

Damned. I am now running tests on my machine, and many/most fail, apparently because of yet another internal change in Sage, in the category framework, as it seems:

```
[p_group_cohomology-3.3.2]         H1 = COHO(Integer(8),Integer(3),root=tmp_root1)
[p_group_cohomology-3.3.2]       File "/home/king/Sage/git/py3/local/lib/python3.7/site-packages/sage/categories/unital_algebras.py", line 117, in __init_extra__
[p_group_cohomology-3.3.2]         deprecation(19225, "the attribute _no_generic_basering_coercion is deprecated, implement _coerce_map_from_base_ring() instead")
[p_group_cohomology-3.3.2]       File "/home/king/Sage/git/py3/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 100, in deprecation
[p_group_cohomology-3.3.2]         warning(trac_number, message, DeprecationWarning, stacklevel)
[p_group_cohomology-3.3.2]       File "/home/king/Sage/git/py3/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 146, in warning
[p_group_cohomology-3.3.2]         warn(message, warning_class, stacklevel)
[p_group_cohomology-3.3.2]       File "/usr/lib/python3.7/warnings.py", line 110, in _showwarnmsg
[p_group_cohomology-3.3.2]         msg.file, msg.line)
[p_group_cohomology-3.3.2]     :
[p_group_cohomology-3.3.2]     DeprecationWarning: the attribute _no_generic_basering_coercion is deprecated, implement _coerce_map_from_base_ring() instead
[p_group_cohomology-3.3.2]     See http://trac.sagemath.org/19225 for details.
```



---

Comment by SimonKing created at 2020-10-17 08:32:02

Replying to [comment:71 SimonKing]:
> Damned. I am now running tests on my machine, and many/most fail, apparently because of yet another internal change in Sage, in the category framework, as it seems:

Needless to say that #19225 doesn't clearly explain what to do in order to replace the ugly _no_generic_basering_coercion by something better. Should one simply remove it or what? And "of course" clicking on the branch of #19225 doesn't show a diff to the pre-#19225 state, i.e., I cannot infer from the changes in the code what I'd have to do now.

Sometimes I still miss patches attached to tickets.


---

Comment by SimonKing created at 2020-10-17 11:02:52

Hooray! After simply removing the hack that was deprecated by #19225, I get

```
[p_group_cohomology-3.3.2] ----------------------------------------------------------------------
[p_group_cohomology-3.3.2] All tests passed!
[p_group_cohomology-3.3.2] ----------------------------------------------------------------------
```

That was withoug #30151, though.

**Problems solved:**
- setup.py is not messing around with SAGE_LOCAL. Instead, stuff that needs to be installed relative to the root of the Sage installation is now put in place by spkg-install using sdh_install.
- The GAP part of the package has become a proper GAP package, that is installed where GAP expects packages (and can actually be loaded by `LoadPackage(...)`).
- A hack that has been deprecated in #19225 is removed.

**Remaining problems:**
1. Documentation does still not build correctly, although it can be built separately.
2. I'm not using #30151 yet. **Question**: Do I understand correctly that I need to change the dependencies of the ticket as follows?
  {{{
$(PYTHON) cython cysignals singular sage-meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | pip matplotlib gap xz $(SAGERUNTIME)
  }}}
  Or can this by simplified due to #30151?
3. The package consists of several sub-packages. One may consider to split them, perhaps even to put the python and cython parts into the Sage src tree, analogously to #30151.

Problem 2 should be addressed here. I suggest problems 1 and 3 will be tackled in two new tickets. Agreed?


---

Comment by SimonKing created at 2020-10-17 11:08:49

Replying to [comment:73 SimonKing]:
> **Remaining problems:**
> ...
> 2. I'm not using #30151 yet. **Question**: Do I understand correctly that I need to change the dependencies of the ticket as follows?
>   {{{
> $(PYTHON) cython cysignals singular sage-meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | pip matplotlib gap xz $(SAGERUNTIME)
>   }}}
>   Or can this by simplified due to #30151?
> ...
> 
> Problem 2 should be addressed here. ...

On the other hand: #30151 doesn't work yet, because of circular imports. So, in order to fix p_group_cohomology ASAP, I suggest to remove the dependency on #30151. Instead, I suggest that this ticket will be a dependency for #30151, so that, once the circular import problem is solved, `build/pkgs/p_group_cohomology/dependencies` can be modified there, not here. Do you think that's reasonable?


---

Comment by SimonKing created at 2020-10-17 11:30:09

For now, I'll proceed as announced in the previous two comments.

Remark: I did add a tag v3.3.2 to my local git repository of the cohomology package. However, when pushing to github, the tag did not arrive there. Why? Anyway, I posted the tarball of the package on github.
----
New commits:


---

Comment by SimonKing created at 2020-10-17 11:30:09

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-10-17 14:27:09

could you also remove the 1st 2 lines of spkg-install and add meataxe to `dependencies` ?


---

Comment by mkoeppe created at 2020-10-17 15:45:42

Replying to [comment:76 SimonKing]:
> Remark: I did add a tag v3.3.2 to my local git repository of the cohomology package. However, when pushing to github, the tag did not arrive there. Why? Anyway, I posted the tarball of the package on github.

Try `git push origin v3.3.2`


---

Comment by mkoeppe created at 2020-10-17 15:50:51

This change seems to be undoing some changes that we made in the past to get the dependencies right -- probably a mistake?

```
--- a/build/pkgs/p_group_cohomology/dependencies
+++ b/build/pkgs/p_group_cohomology/dependencies
@@ -1 +1 @@
-$(PYTHON) cython cysignals singular meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | $(PYTHON_TOOLCHAIN) matplotlib gap xz $(SAGERUNTIME) ipywidgets
+$(PYTHON) cython cysignals singular meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | pip matplotlib gap xz $(SAGERUNTIME)
```



---

Comment by mkoeppe created at 2020-10-17 15:51:58

Replying to [comment:74 SimonKing]:
> in order to fix p_group_cohomology ASAP, I suggest to remove the dependency on #30151. Instead, I suggest that this ticket will be a dependency for #30151

OK


---

Comment by mkoeppe created at 2020-10-17 15:52:45

Please add `upstream_url` to `checksums.ini`


---

Comment by mkoeppe created at 2020-10-17 15:55:18

Replying to [comment:73 SimonKing]:
> **Remaining problems:**
> 1. Documentation does still not build correctly, although it can be built separately.
> ...
> 3. The package consists of several sub-packages. One may consider to split them, perhaps even to put the python and cython parts into the Sage src tree, analogously to #30151.
> 
> ... I suggest problems 1 and 3 will be tackled in two new tickets. Agreed?

Sounds like a good plan


---

Comment by mkoeppe created at 2020-10-17 16:01:08

Also see comment:44


---

Comment by mkoeppe created at 2020-10-17 17:07:11

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2020-10-17 19:38:42

Replying to [comment:78 mkoeppe]:
> Replying to [comment:76 SimonKing]:
> > Remark: I did add a tag v3.3.2 to my local git repository of the cohomology package. However, when pushing to github, the tag did not arrive there. Why? Anyway, I posted the tarball of the package on github.
> 
> Try `git push origin v3.3.2`

When creating the release, github asked me for a tag, so, I added the tag v3.3.2 there.

Is that a problem? It is supposed to be the same tag on the same commit. But perhaps git considers it as "different history"?


---

Comment by SimonKing created at 2020-10-17 19:40:25

Replying to [comment:77 dimpase]:
> could you also remove the 1st 2 lines of spkg-install and add meataxe to `dependencies` ?

No.

First of all, meataxe IS in dependencies:

```
$(PYTHON) cython cysignals singular meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | pip matplotlib gap xz $(SAGERUNTIME)
```


Secondly, installing meataxe is not enough, as it is required to do `sage -b` after installation. That's why there are the first two lines in spkg-install.in.


---

Comment by SimonKing created at 2020-10-17 19:43:22

Replying to [comment:44 jhpalmieri]:
> I don't know your answer about `sdh_make_install`, but the code could just read
> {{{
> cd ...
> sdh_configure
> sdh_make_install # assuming this works
> }}}

Nope, sdh_make_install is still broken. I tried, but it didn't work.

> Re #24106: do you know what got broken? I don't see any comments or notes about follow-ups on that ticket.

No idea.


---

Comment by mkoeppe created at 2020-10-17 19:45:03

Replying to [comment:86 SimonKing]:
> When creating the release, github asked me for a tag, so, I added the tag v3.3.2 there.
> 
> Is that a problem? It is supposed to be the same tag on the same commit. But perhaps git considers it as "different history"?

Looking at https://github.com/sagemath/p_group_cohomology/commits/v3.3.2, I see that the tag is on the HEAD commit of master branch. This looks fine.


---

Comment by git created at 2020-10-17 19:52:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2020-10-17 19:54:14

In the previous two commits, I revert the changes to "dependencies" (no idea where the change came from) and added upstream_url. Hope the definition of upstream_url is correct.


---

Comment by SimonKing created at 2020-10-17 19:54:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-10-17 19:54:39

What problem do you see with `sdh_make_install`?


---

Comment by mkoeppe created at 2020-10-17 20:15:00

Replying to [comment:91 SimonKing]:
> Hope the definition of upstream_url is correct.

Something downloads but ....

```
[p_group_cohomology-3.3.2]     raise ChecksumError('checksum does not match')
[p_group_cohomology-3.3.2] ChecksumError: checksum does not match
[p_group_cohomology-3.3.2] ************************************************************************
[p_group_cohomology-3.3.2] ************************************************************************
[p_group_cohomology-3.3.2] Error downloading p_group_cohomology-3.3.2.tar.xz
```



---

Attachment

Error with sdh_make_install


---

Comment by SimonKing created at 2020-10-17 20:22:15

Replying to [comment:92 mkoeppe]:
> What problem do you see with `sdh_make_install`?

Whith

```
...
# build and install modular_resolution
cd `ls -d modular_resolution*`
sdh_configure
# sdh_make install got broken by trac ticket #24106
sdh_make_install
cd ..
...
```

I get :attachment:p_group_cohomology-3.3.2.log when first removing libmodres.* from SAGE_LOCAL/lib and modular_resolution from SAGE_LOCAL/include, then doing sage -f p_group_cohomology.


---

Comment by mkoeppe created at 2020-10-17 20:27:37

OK, what's happening here is that your package is not ready for the staged install because the "make install" of the C library goes to the staging directory, so the second step will not find it in `SAGE_LOCAL`.  

This is working as designed. The problem will go away if you split out modres as a separate spkg.


---

Comment by SimonKing created at 2020-10-17 20:32:57

Replying to [comment:93 mkoeppe]:
> Replying to [comment:91 SimonKing]:
> > Hope the definition of upstream_url is correct.
> 
> Something downloads but ....
> {{{
> [p_group_cohomology-3.3.2]     raise ChecksumError('checksum does not match')
> [p_group_cohomology-3.3.2] ChecksumError: checksum does not match
> [p_group_cohomology-3.3.2] ************************************************************************
> [p_group_cohomology-3.3.2] ************************************************************************
> [p_group_cohomology-3.3.2] Error downloading p_group_cohomology-3.3.2.tar.xz
> }}}

Thank you. I downloaded the tarball from github, and it did indeed differ. I modified the release on github, and now it seems to work.


---

Comment by mkoeppe created at 2020-10-17 20:46:21

https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 does not seem to have a source tarball


---

Comment by mkoeppe created at 2020-10-17 21:38:19

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-10-17 22:11:58

Replying to [comment:97 mkoeppe]:
> https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 does not seem to have a source tarball 

it is much better to upload a tarball produced on your machine, rather than rely on GitHub's produced tarballs, which are known to change overtime sometimes.
On https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 click  on "Edit Release"
and upload the tarball you want there.


---

Comment by dimpase created at 2020-10-17 22:20:47

Replying to [comment:87 SimonKing]:
> Replying to [comment:77 dimpase]:
> > could you also remove the 1st 2 lines of spkg-install and add meataxe to `dependencies` ?
> 
> No.
> 
> First of all, meataxe IS in dependencies:
> {{{
> $(PYTHON) cython cysignals singular meataxe $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/structure/element.pxd $(SAGE_SRC)/sage/matrix/matrix_gfpn_dense.pxd $(SAGE_SRC)/sage/matrix/matrix0.pxd $(SAGE_SRC)/sage/libs/meataxe.pxd $(SAGE_SRC)/sage/rings/morphism.pxd | pip matplotlib gap xz $(SAGERUNTIME)
> }}}
> 
it seems to be the only  spkg that lists *files* as dependencies.
I don't understand the need for these. Yes, your package depends on sagelib as a whole, thus on these files too.


> Secondly, installing meataxe is not enough, as it is required to do `sage -b` after installation. That's why there are the first two lines in spkg-install.in.

Then replace these two lines by `sage -b` !


---

Comment by SimonKing created at 2020-10-17 22:31:18

Replying to [comment:97 mkoeppe]:
> https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 does not seem to have a source tarball 

WTF? When I removed the old tarball (that I did produce on my own machine, by the way), I immediately replaced it by - again - the tarball from my machine. And afterwards I could download it by wget.


---

Comment by SimonKing created at 2020-10-17 22:36:50

Replying to [comment:99 dimpase]:
> Replying to [comment:97 mkoeppe]:
> > https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 does not seem to have a source tarball 
> 
> it is much better to upload a tarball produced on your machine, rather than rely on GitHub's produced tarballs, which are known to change overtime sometimes.

Both the old broken one and the new non-broken one are from my machine. Travis knows how to create a tarball for my package, but github doesn't.

> On https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2 click  on "Edit Release"
> and upload the tarball you want there.

I did now, and I hope it is fine now.


---

Comment by mkoeppe created at 2020-10-17 22:43:44

The checksum still does not match...


---

Comment by SimonKing created at 2020-10-17 22:43:57

Replying to [comment:100 dimpase]:
> it seems to be the only  spkg that lists *files* as dependencies.
> I don't understand the need for these. Yes, your package depends on sagelib as a whole, thus on these files too.

I have no idea how exactly "dependencies" work. I don't recall who created the "dependencies" file for p_group_cohomology.

I suppose the rationale is: If one would give "sagelib" as a dependency, p_group_cohomology would be rebuilt (which takes a long time) for EACH SINGLE TOTALLY UNRELATED change in the Sage library. That's not nice. Therefore it is a good idea to be more specific and only mention those Cython headers that really are used by the Cython modules of p_group_cohomology.

> > Secondly, installing meataxe is not enough, as it is required to do `sage -b` after installation. That's why there are the first two lines in spkg-install.in.
> 
> Then replace these two lines by `sage -b` !

I was told not to do that, IIRC.


---

Comment by mkoeppe created at 2020-10-17 22:50:12

Replying to [comment:104 SimonKing]:
> I suppose the rationale is: If one would give "sagelib" as a dependency, p_group_cohomology would be rebuilt (which takes a long time) for EACH SINGLE TOTALLY UNRELATED change in the Sage library. That's not nice. Therefore it is a good idea to be more specific and only mention those Cython headers that really are used by the Cython modules of p_group_cohomology.

I agree with this reasoning. In particular, note that `sagelib` is rebuilt every time.


---

Comment by mkoeppe created at 2020-10-17 22:51:07

Replying to [comment:104 SimonKing]:
> > > Secondly, installing meataxe is not enough, as it is required to do `sage -b` after installation. That's why there are the first two lines in spkg-install.in.
> > 
> > Then replace these two lines by `sage -b` !
> 
> I was told not to do that, IIRC.

Yes, let's not do that. The proper fix will come in the follow-up ticket, as discussed above.


---

Comment by SimonKing created at 2020-10-17 22:51:26

Replying to [comment:103 mkoeppe]:
> The checksum still does not match...

The tarball in SAGE_ROOT/upstream is bitwise identical with what I downloaded.

Anyway. If the checksums do not match, I suggest to clean things up. Namely, AFTER adding the tag "v3.3.2", I did a few changes in the index.rst file of the documentation. If I see that correctly, these changes are not part of the tarball that is posted on github.

Since the numbers do not match, I will now
- make sure to include my latest changes (to the documentation) in the release.
- move the tag v3.3.2 to the corresponding commit, both locally and on github.
- upload the release tarball on github
- change the checksum, if necessary.


---

Comment by git created at 2020-10-17 23:06:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2020-10-17 23:08:00

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2020-10-17 23:08:00

Replying to [comment:107 SimonKing]:
> Since the numbers do not match, I will now
> - make sure to include my latest changes (to the documentation) in the release.
> - move the tag v3.3.2 to the corresponding commit, both locally and on github.
> - upload the release tarball on github
> - change the checksum, if necessary.

Done. I think it is fine now.


---

Comment by mkoeppe created at 2020-10-17 23:14:46

I don't know what's happening here, but the checksums stil do not match. (..deleted..)


---

Comment by mkoeppe created at 2020-10-17 23:18:43

Replying to [comment:110 mkoeppe]:
> I don't know what's happening here, but the checksums still do not match. 

Looks like this one was a malfunction on my side


---

Comment by mkoeppe created at 2020-10-17 23:29:24

It has built OK now on macOS


---

Comment by jhpalmieri created at 2020-10-18 01:41:17

I think the problem with the documentation is this: if you install the documentation in `spkg-install.in`, then the package hasn't been installed yet — it's in a staging area — so it cannot be imported into Python, which is necessary for the docbuilding process. So move the docbuilding stuff to `spkg-postinst.in`:

```diff
diff --git a/build/pkgs/p_group_cohomology/spkg-install.in b/build/pkgs/p_group_cohomology/spkg-install.in
index bcae3a8a47..aef761f9a6 100644
--- a/build/pkgs/p_group_cohomology/spkg-install.in
+++ b/build/pkgs/p_group_cohomology/spkg-install.in
@@ -17,9 +17,3 @@ sdh_install singular_helper/dickson.lib "$SAGE_SHARE/singular/LIB/" || sdh_die "
 # building pGroupCohomology (and its documentation)
 cd `ls -d pGroupCohomology*`
 sdh_pip_install .
-
-if [ "x$SAGE_SPKG_INSTALL_DOCS" = xyes ] ; then
-    cd doc
-    $MAKE html || sdh_die "Error building documentation"
-    sdh_install build/html/* "$SAGE_SHARE/doc/p_group_cohomology/" || sdh_die "Error moving documentation to $SAGE_SHARE/doc/p_group_cohomology"
-fi
diff --git a/build/pkgs/p_group_cohomology/spkg-postinst.in b/build/pkgs/p_group_cohomology/spkg-postinst.in
new file mode 100644
index 0000000000..ec485455db
--- /dev/null
+++ b/build/pkgs/p_group_cohomology/spkg-postinst.in
@@ -0,0 +1,8 @@
+cd src
+cd `ls -d pGroupCohomology*`
+
+if [ "x$SAGE_SPKG_INSTALL_DOCS" = xyes ] ; then
+    cd doc
+    $MAKE html || sdh_die "Error building documentation"
+    sdh_install build/html/* "$SAGE_SHARE/doc/p_group_cohomology/" || sdh_die "Error moving documentation to $SAGE_SHARE/doc/p_group_cohomology"
+fi
```



---

Comment by mkoeppe created at 2020-10-18 03:04:04

The problem with the checksum error on automatic download was also reproduced on GH Actions: 

```
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/p_group_cohomology/p_group_cohomology-3.3.2.tar.xz'
Attempting to download from https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2/p_group_cohomology-3.3.2.tar.xz
[......................................................................]
************************************************************************
Traceback (most recent call last):
  File "/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 130, in run_safe
    run()
  File "/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 112, in run
    app.download_tarball(args.url_or_tarball, args.destination, args.allow_upstream)
  File "/sage/build/bin/../sage_bootstrap/download/app.py", line 41, in download_tarball
    tarball.download(allow_upstream=allow_upstream)
  File "/sage/build/bin/../sage_bootstrap/tarball.py", line 177, in download
    raise ChecksumError('checksum does not match')
ChecksumError: checksum does not match
```



---

Comment by mkoeppe created at 2020-10-18 03:06:52

Hm......

```
(sage-sh) mkoeppe@egret:sage-rebasing$ sage-download-file https://github.com/sagemath/p_group_cohomology/releases/tag/v3.3.2/p_group_cohomology-3.3.2.tar.xz > A
[......................................................................]
(sage-sh) mkoeppe@egret:sage-rebasing$ file A
A: HTML document text, UTF-8 Unicode text, with very long lines
(sage-sh) mkoeppe@egret:sage-rebasing$ head A





<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://github.githubassets.com">
```



---

Comment by mkoeppe created at 2020-10-18 03:58:27

New commits:


---

Comment by SimonKing created at 2020-10-18 07:13:54

Replying to [comment:114 jhpalmieri]:
> I think the problem with the documentation is this: if you install the documentation in `spkg-install.in`, then the package hasn't been installed yet — it's in a staging area — so it cannot be imported into Python, which is necessary for the docbuilding process. So move the docbuilding stuff to `spkg-postinst.in`:

Sure, that makes sense! Thank you for spotting it!

I'll try, and if it works, I will also remove the comment from the doc that states that docbuilding during package installation is broken.


---

Comment by SimonKing created at 2020-10-18 07:58:06

Thank you very much, when using spkg-postinst, building the documentation works!
----
New commits:


---

Comment by SimonKing created at 2020-10-18 07:59:04

PS: The new tarball (removing the remark on broken docbuild) is on github.


---

Comment by dimpase created at 2020-10-19 08:49:50

OK, but one doctest is failing

```
$ ./sage -tp src/sage/tests/modular_group_cohomology.py
Running doctests with ID 2020-10-19-09-47-51-87beac43.
Git branch: public/graphs/30386
Using --optional=bliss,build,debian,dochtml,gap_packages,libsemigroups,meataxe,memlimit,p_group_cohomology,pip,sage,sage_spkg
Doctesting 1 file using 4 threads.
sage -t --warn-long 81.6 --random-seed=0 src/sage/tests/modular_group_cohomology.py
**********************************************************************
File "src/sage/tests/modular_group_cohomology.py", line 20, in sage.tests.modular_group_cohomology
Failed example:
    H == H0                                       # optional - p_group_cohomology
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  18 in sage.tests.modular_group_cohomology
    [17 tests, 1 failure, 3.98 s]
----------------------------------------------------------------------
sage -t --warn-long 81.6 --random-seed=0 src/sage/tests/modular_group_cohomology.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 4.0 seconds
    cpu time: 3.4 seconds
    cumulative wall time: 4.0 seconds
```

note that also at Sage prompt computing H and H0 gives

```
sage: H0.gens()                                                                                                                                                      
[1,
 a_2_1: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 c_2_2: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 c_4_4: 4-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_1_0: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_1_1: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_3_3: 3-Cocycle in H^*(SmallGroup(64,14); GF(2))]
sage: H.gens()                                                                                                                                                       
[1,
 a_2_1: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 c_2_2: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 c_4_4: 4-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_1_0: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_1_1: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
 a_3_3: 3-Cocycle in H^*(SmallGroup(64,14); GF(2))]
sage: H0.is_isomorphic(H)                                                                                                                                            
('1*a_2_1', '1*c_2_2', '1*c_4_4', '1*a_1_0', '1*a_1_1', '1*a_3_3')
sage: H.is_isomorphic(H0)                                                                                                                                            
('1*a_2_1', '1*c_2_2', '1*c_4_4', '1*a_1_0', '1*a_1_1', '1*a_3_3')
sage: H==H0                                                                                                                                                          
False
```


not sure how serious it is - if it's not, and you don't have time to fix it now, just mark it as a known error, and open another ticket.


---

Comment by SimonKing created at 2020-10-19 09:00:24

Replying to [comment:123 dimpase]:
> OK, but one doctest is failing

Thank you for spotting this! Indeed I forgot that there are some doctests in the Sage src tree, and only tested the package's own test suite.

> note that also at Sage prompt computing H and H0 gives
> {{{
> sage: H0.gens()                                                                                                                                                      
> [1,
>  a_2_1: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  c_2_2: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  c_4_4: 4-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_1_0: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_1_1: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_3_3: 3-Cocycle in H^*(SmallGroup(64,14); GF(2))]
> sage: H.gens()                                                                                                                                                       
> [1,
>  a_2_1: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  c_2_2: 2-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  c_4_4: 4-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_1_0: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_1_1: 1-Cocycle in H^*(SmallGroup(64,14); GF(2)),
>  a_3_3: 3-Cocycle in H^*(SmallGroup(64,14); GF(2))]
> sage: H0.is_isomorphic(H)                                                                                                                                            
> ('1*a_2_1', '1*c_2_2', '1*c_4_4', '1*a_1_0', '1*a_1_1', '1*a_3_3')
> sage: H.is_isomorphic(H0)                                                                                                                                            
> ('1*a_2_1', '1*c_2_2', '1*c_4_4', '1*a_1_0', '1*a_1_1', '1*a_3_3')
> sage: H==H0                                                                                                                                                          
> False
> }}}

Hm. I'll have a closer look. Two cohomology rings should evaluate equal if the two ring representations are identical. This should be the case here, as there is an isomorphism mapping the generators one to one.

... unless there is a tail reduction of the relations in one case but not in the other case.

> not sure how serious it is - if it's not, and you don't have time to fix it now, just mark it as a known error, and open another ticket. 

At least I'll have a look now.


---

Comment by SimonKing created at 2020-10-19 09:06:41

Interesting:

```
sage: H.set_ring()                                                                                  
sage: H.relation_ideal()                                                                            
a_1_0^2,
a_1_0*a_1_1,
a_1_1^3,
a_2_1*a_1_0,
a_2_1^2+a_2_1*a_1_1^2,
a_1_0*a_3_3+a_2_1*a_1_1^2,
a_1_1*a_3_3+a_2_1*a_1_1^2,
a_2_1*a_3_3,
a_3_3^2
sage: H0.set_ring()                                                                                 
sage: H0.relation_ideal()                                                                           
a_1_0^2,
a_1_0*a_1_1,
a_1_1^3,
a_2_1*a_1_0,
a_2_1^2+a_2_1*a_1_1^2,
a_1_0*a_3_3+a_2_1*a_1_1^2,
a_1_1*a_3_3+a_2_1*a_1_1^2,
a_2_1*a_3_3,
a_3_3^2
sage: H.rels()                                                                                      
['a_1_0^2',
 'a_1_0*a_1_1',
 'a_1_1^3',
 'a_2_1*a_1_0',
 'a_2_1^2+a_2_1*a_1_1^2',
 'a_1_0*a_3_3+a_2_1*a_1_1^2',
 'a_1_1*a_3_3+a_2_1*a_1_1^2',
 'a_2_1*a_3_3',
 'a_3_3^2']
sage: H0.rels()                                                                                     
['a_1_0^2',
 'a_1_0*a_1_1',
 'a_1_1^3',
 'a_2_1*a_1_0',
 'a_2_1^2+a_2_1*a_1_1^2',
 'a_1_1*a_3_3+a_2_1^2',
 'a_1_0*a_3_3+a_2_1^2',
 'a_2_1*a_3_3',
 'a_3_3^2']
```

So, Singular says that the two ideals are identical, but the string representation stored in the cohomology ring is different.


---

Comment by dimpase created at 2020-10-19 09:10:00

The relations of H and H0 are equal as sets, but not as lists:

```
sage: H.rels()                                                                                                                                                       
['a_1_0^2',
 'a_1_0*a_1_1',
 'a_1_1^3',
 'a_2_1*a_1_0',
 'a_2_1^2+a_2_1*a_1_1^2',
 'a_1_0*a_3_3+a_2_1*a_1_1^2',
 'a_1_1*a_3_3+a_2_1*a_1_1^2',
 'a_2_1*a_3_3',
 'a_3_3^2']
sage: H0.rels()                                                                                                                                                      
['a_1_0^2',
 'a_1_0*a_1_1',
 'a_1_1^3',
 'a_2_1*a_1_0',
 'a_2_1^2+a_2_1*a_1_1^2',
 'a_1_1*a_3_3+a_2_1^2',
 'a_1_0*a_3_3+a_2_1^2',
 'a_2_1*a_3_3',
 'a_3_3^2']
```


EDIT - oops, sorry, there are just a bit different - as you noticed already, I suppose.


---

Comment by SimonKing created at 2020-10-19 09:10:37

Indeed, the problem is the missing interreduction:

```
sage: H0.set_ring()                                                                                 
sage: I = singular.ideal(H0.rels())                                                                 
sage: str(I) == str(H0.relation_ideal())                                                            
False
sage: str(I.interred()) == str(H0.relation_ideal())                                                 
True
```

Hm. What to do about it?


---

Comment by SimonKing created at 2020-10-19 09:11:51

Replying to [comment:126 dimpase]:
> The relations of H and H0 are equal as sets, but not as lists:

No, they aren't. They are equal after doing interreduction.

```
sage: set(H0.rels()) == set(H.rels())                                                               
False
```



---

Comment by SimonKing created at 2020-10-19 09:13:51

Back to the question what to do about it.

The point of the equality check is to provide a VERY QUICK test. So, I wouldn't like to do interreduction before comparing.

But one could fix the doctest by checking that the two rings are indeed isomorphic by mapping the list of generators one-to-one.


---

Comment by dimpase created at 2020-10-19 09:18:28

I would not call what we see here a "pythonic" equality. What we see here is more like 
`1/2==2/4` - the jury is still out on whether this should be True or False.

On the other hand what we have here is a stronger kind of equvalence than just a (graded) ring isomorphism, no?


---

Comment by git created at 2020-10-19 09:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2020-10-19 09:27:09

Replying to [comment:130 dimpase]:
> I would not call what we see here a "pythonic" equality. What we see here is more like 
> `1/2==2/4` - the jury is still out on whether this should be True or False.

I chose "equality of cohomology rings" to mean "equality of ring representations".

So, with this choice, one would have `1/2==2/4` if and only if `1/2` is represented in the same way (namely as a REDUCED fraction) as `2/4`.

Note that to check whether two ideals represent the same set of polynomials, one would need to compute Gröbner bases. But that's very expensive. Therefore, it was decided by Sage (at least in the past, I don't know if that has changed) to not do the expensive test, but to compare generators instead.

And that's what I do here, too.

> On the other hand what we have here is a stronger kind of equvalence than just a (graded) ring isomorphism, no?

Sure. I wrote a research paper (with Bettina Eick) on classifying the cohomology rings of groups of order <=81 up to graded isomorphism. And that's a totally different problem.

Here, equality is not "isomorphism of graded rings", but "identity of ring representations".


---

Comment by dimpase created at 2020-10-19 09:51:56

OK, good.
One can still try to find more errors here: https://github.com/mkoeppe/sage/actions/runs/313251166
but I guess it's OK.


---

Comment by dimpase created at 2020-10-19 09:51:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-10-19 23:19:18

Looking good. On to #30787...?


---

Comment by vbraun created at 2020-10-31 18:07:39

Resolution: fixed
