# Issue 28253: Let Sage preparser honour PEP 515 (py3)

Issue created by migration from https://trac.sagemath.org/ticket/28490

Original creator: tmonteil

Original creation time: 2019-09-14 00:43:21

CC:  slelievre

In Python 3, underscored numbers like `10_000_000.0` are allowed, but the preparser does not handle them yet, see [this as question](https://ask.sagemath.org/question/47908/sage-is-not-preparsing-python-3-underscored-integers/).


---

Comment by slelievre created at 2019-09-14 20:52:46

Changing keywords from "" to "preparser, py3".


---

Comment by jhpalmieri created at 2019-10-18 21:59:05

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-10-18 21:59:05

Here is an attempt. This does at least one other thing: it no longer allows leading zeroes in integers. This is not valid Python syntax, so Sage should not allow it, either.


---

Comment by git created at 2019-10-18 22:12:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tmonteil created at 2019-10-18 23:04:37

In my understanding of the PEP (confirmed by testing on a ipython3 console), trailing underscores are not allowed, however we currently have:


```
sage: 100_000_
100000
```


Also, perhaps could you show the feature in action with a concrete example, something like:


```
The preparser can handle PEP 515 (see :trac:`28490`)::

    sage: 1_000_000 + 3_000
    1003000
```



---

Comment by tmonteil created at 2019-10-18 23:04:37

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-10-19 04:43:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-19 04:45:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-10-19 04:46:31

Okay, trailing underscores now should fail, and I added the doctest.


---

Comment by jhpalmieri created at 2019-10-19 04:46:31

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2019-10-19 09:31:38

The patchbots seem unhappy, apparently the doctests do not behave the same there.


---

Comment by jhpalmieri created at 2019-10-19 15:39:19

The doctests pass with Python 3, not with Python 2. I guess there is a question: using underscores is only valid starting in Python. Do we want to allow this in Sage built with Python 2?

Also, a leading zero is valid in Python 2 but not in Python 3. What should we do about that?


---

Comment by git created at 2019-10-19 15:47:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-10-19 15:48:08

I propose to allow underscores with Python 2.


---

Comment by tmonteil created at 2019-10-19 16:05:47

My personal opinion:

- write a simple code with Python 3 in mind only, to avoid cumbersome code, since Python2 will be dropped soon anyway (an i guess nobody using Python 2 will complain that 1000_000 should not be accepted)
- use `# py2` and `# py3` in doctests to make patchbots happy.


---

Comment by jhpalmieri created at 2019-10-19 18:38:08

That's mostly what I did, except that with my code and Sage + Python 2, leading zeroes are still allowed. Aside from the `# py2` and `# py3` doctest tags, the only thing I've added to support Python 2 is to insert `if (six.PY3 and ...)` instead of `if (...)`. (This is to deal with leading zeroes.)


---

Comment by jhpalmieri created at 2019-12-12 18:16:04

ping?


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by vdelecroix created at 2020-02-22 15:42:49

Could you factorize

```
        # Multiple consecutive underscores is invalid Python
        # syntax. Do not preparse.
        if num.find('__') != -1:
            continue

        # Trailing underscore is invalid Python syntax. Do not
        # preparse.
        if num.endswith('_'):
            continue
```

into

```
        # Multiple consecutive underscores or trailing underscore
        # is invalid Python syntax. Do not preparse.
        if num.find('__') != -1 or num.endswith('_'):
            continue
```



---

Comment by git created at 2020-02-24 21:15:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2020-02-24 21:15:43

Replying to [comment:17 vdelecroix]:
> Could you factorize
> {{{
>         # Multiple consecutive underscores is invalid Python
>         # syntax. Do not preparse.
>         if num.find('__') != -1:
>             continue
> 
>         # Trailing underscore is invalid Python syntax. Do not
>         # preparse.
>         if num.endswith('_'):
>             continue
> }}}
> into
> {{{
>         # Multiple consecutive underscores or trailing underscore
>         # is invalid Python syntax. Do not preparse.
>         if num.find('__') != -1 or num.endswith('_'):
>             continue
> }}}

Done.


---

Comment by vdelecroix created at 2020-02-24 22:49:24

Why would you change `123_456` to `123456`? This works perfectly fine

```
sage: preparser(False)
sage: Integer(123_456)
123456
sage: preparser(True)
```

The only problem seems to be that `.0` is too often converted to `.gen(0)`

```
sage: preparse("100_000.0")
'100_000.gen(0)'
```



---

Comment by vdelecroix created at 2020-02-24 22:59:20

Couldn't you simply change `dec_num` to something like `dec_num = r"\d+(_\d+)*"` ?


---

Comment by vdelecroix created at 2020-02-24 23:01:31

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2020-02-24 23:01:31

And it is not the role of the Sage preparser to implement PEP requests.


---

Comment by vdelecroix created at 2020-02-24 23:03:44

In other words: it is good to make strings with underscored be recognized as numbers. But do not modify the input string beyond what is strictly necessary.


---

Comment by vdelecroix created at 2020-02-25 00:11:32

I put a branch at `public/28490` which contains (I hope) the correct regexps. I also added more doctests for floating point numbers.

Of course `Integer('1_23')` and `RealNumber('1_1.')` are broken. But this is IMHO a distinct problem.


---

Comment by jhpalmieri created at 2020-02-25 00:40:29

Replying to [comment:20 vdelecroix]:
> Why would you change `123_456` to `123456`? This works perfectly fine

5 months ago, when the ticket was opened, Python 2 was the default for Sage, and all of these things were completely broken with Python 2. Should this ticket provide support for Python 2? I haven't looked at your changes, so I don't know if they do.

> And it is not the role of the Sage preparser to implement PEP requests. 

It's not a request anymore, it's been merged into Python. Whose role is it to make sure that valid Python 3 syntax, like `100_000.0`, is interpreted properly in Sage?


---

Comment by jhpalmieri created at 2020-02-25 00:42:29

By the way, I removed `dec_num` because it was redundant: covered (I think) by the other regexps.


---

Comment by vdelecroix created at 2020-02-25 09:21:04

Replying to [comment:25 jhpalmieri]:
> Replying to [comment:20 vdelecroix]:
> > Why would you change `123_456` to `123456`? This works perfectly fine
> 
> 5 months ago, when the ticket was opened, Python 2 was the default for Sage, and all of these things were completely broken with Python 2. Should this ticket provide support for Python 2? I haven't looked at your changes, so I don't know if they do.

Python 2 is supposed to be dropped in sage-9.2. It should be supported for the next 9.1 release.
 
> > And it is not the role of the Sage preparser to implement PEP requests. 
> 
> It's not a request anymore, it's been merged into Python. Whose role is it to make sure that valid Python 3 syntax, like `100_000.0`, is interpreted properly in Sage?

Agreed. Did you have a look at `public/28490`? It does not touch to the interpreter beyond the update of regexp.


---

Comment by jhpalmieri created at 2020-02-25 18:03:15

I looked at your branch. It doesn't work with Python 2, for what that's worth:

```
sage: 123_456
  File "<ipython-input-1-d4d70e3ee054>", line 1
    Integer(123_456)
                  ^
SyntaxError: invalid syntax
```

I also get a few doctest failures with Python 3, but they should be easy to fix.

You can delete `dec_num` since it is redundant.

```diff
diff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py
index a699394d1b..9b877285e9 100644
--- a/src/sage/repl/preparse.py
+++ b/src/sage/repl/preparse.py
@@ -830,14 +830,13 @@ def preparse_numeric_literals(code, extract=False):
 
     global all_num_regex
     if all_num_regex is None:
-        dec_num = r"\b\d+(_\d+)*"
         hex_num = r"\b0x[0-9a-f]+(_[0-9a-f]+)*"
         oct_num = r"\b0o[0-7]+(_[0-7]+)*"
         bin_num = r"\b0b[01]+(_[01]+)*"
         # This is slightly annoying as floating point numbers may start
         # with a decimal point, but if they do the \b will not match.
         float_num = r"((\b\d+(_\d+)*([.](\d+(_\d+)*)?)?)|([.]\d+(_\d+)*))(e[-+]?\d+(_\d+)*)?"
-        all_num = r"((%s)|(%s)|(%s)|(%s)|(%s))(rj|rL|jr|Lr|j|L|r|)\b" % (hex_num, oct_num, bin_num, float_num, dec_num)
+        all_num = r"((%s)|(%s)|(%s)|(%s))(rj|rL|jr|Lr|j|L|r|)\b" % (hex_num, oct_num, bin_num, float_num)
         all_num_regex = re.compile(all_num, re.I)
 
     for m in all_num_regex.finditer(code):
```

The preparser is still broken with your branch:

```
sage: preparse('100_00.0')
"RealNumber('100_00.gen(0)')"
```

We need to fix this and add a doctest.


---

Comment by jhpalmieri created at 2020-02-25 18:59:15

First, with this change:

```diff
diff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py
index a699394d1b..dd798f06b7 100644
--- a/src/sage/repl/preparse.py
+++ b/src/sage/repl/preparse.py
@@ -1300,7 +1300,7 @@ def preparse(line, reset=True, do_time=False, ignore_prompts=False,
 
     # Generators
     # R.0 -> R.gen(0)
-    L = re.sub(r'([_a-zA-Z]\w*|[)\]])\.(\d+)', r'\1.gen(\2)', L)
+    L = re.sub(r'([a-zA-Z]\w*|[)\]])\.(\d+)', r'\1.gen(\2)', L)
 
     # Use ^ for exponentiation and ^^ for xor
     # (A side effect is that **** becomes xor as well.)
```

`preparse(100_000.0)` works, but `100_000.0` does not:

```
sage: preparse('100_000.0')
"RealNumber('100_000.0')"
sage: 100_000.0
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to convert '100_000.0' to a real number
```

So that's some progress. Then this change fixes the conversion to `RealNumber`:

```diff
diff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx
index 26cfddc0a2..8ec11ae38f 100644
--- a/src/sage/rings/real_mpfr.pyx
+++ b/src/sage/rings/real_mpfr.pyx
@@ -1482,6 +1482,7 @@ cdef class RealNumber(sage.structure.element.RingElement):
             mpfr_set_z(self.value, (<gmpy2.mpz>x).z, parent.rnd)
         else:
             s = str(x).replace(' ','')
+            s = str(x).replace('_','')
             s_lower = s.lower()
             if s_lower == 'infinity':
                 raise ValueError('can only convert signed infinity to RR')
```



---

Comment by vdelecroix created at 2020-02-25 21:07:17

Replying to [comment:28 jhpalmieri]:
> I looked at your branch. It doesn't work with Python 2, for what that's worth:
> {{{
> sage: 123_456
>   File "<ipython-input-1-d4d70e3ee054>", line 1
>     Integer(123_456)
>                   ^
> SyntaxError: invalid syntax
> }}}

It *does* work with Python2 as the above `SyntaxError` is the expected behavior

```
$ python2 -c '123_456'
  File "<string>", line 1
    123_456
          ^
SyntaxError: invalid syntax
```

I don't see why we would change that in Sage.


---

Comment by vdelecroix created at 2020-02-25 21:11:34

Replying to [comment:29 jhpalmieri]:
> First, with this change:
> {{{
> <SNIP>
> }}}
> `preparse(100_000.0)` works, but `100_000.0` does not:
> {{{
> <SNIP>
> }}}
> So that's some progress.

Nice! To my mind, this is the end. `RealNumber` should accept this kind of strings as `float` does.

```
sage: float('1_1.1_1e1_1')
1111000000000.0
```

It is not the job of the preparser to modify the input string.

> Then this change fixes the conversion to `RealNumber`:
> {{{
> <SNIP>
> }}}

Which is precisely what I don't wnat to do here!


---

Comment by jhpalmieri created at 2020-02-25 21:22:42

Replying to [comment:31 vdelecroix]:
> > Then this change fixes the conversion to `RealNumber`:
> > {{{
> > <SNIP>
> > }}}
> 
> Which is precisely what I don't wnat to do here!

Why not? This is in the `__init__` method for `RealNumber`, where the string is already modified, as you can see from the surrounding lines. It's not in the preparser. Where else would you want to fix it?


---

Comment by vdelecroix created at 2020-02-25 21:24:55

Replying to [comment:32 jhpalmieri]:
> Replying to [comment:31 vdelecroix]:
> > > Then this change fixes the conversion to `RealNumber`:
> > > {{{
> > > <SNIP>
> > > }}}
> > 
> > Which is precisely what I don't wnat to do here!
> 
> Why not? This is in the `__init__` method for `RealNumber`, where the string is already modified, as you can see from the surrounding lines. It's not in the preparser. Where else would you want to fix it?

Oups. I misread. It is fine modifying `RealNumber`. But the title and description has to be modified as it is not only about touching the preparser. Also `Integer` and `Rational` constructors have to be fixed.


---

Comment by vdelecroix created at 2020-02-25 21:28:28

Your 'fix' from the first part of [comment:29 comment:29] was not one... I will update the branch in a second.


---

Comment by vdelecroix created at 2020-02-25 21:32:21

New commits:


---

Comment by git created at 2020-02-25 21:32:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-25 21:40:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-25 21:42:20

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-02-25 22:33:55

With your branch in Python 2, `Integer('1_3')` returns 13 but plain `1_3` raises a `SyntaxError`. Is that what you intended? It's not consistent behavior.


---

Comment by vdelecroix created at 2020-02-26 08:37:50

Replying to [comment:39 jhpalmieri]:
> With your branch in Python 2, `Integer('1_3')` returns 13 but plain `1_3` raises a `SyntaxError`. Is that what you intended? It's not consistent behavior.

It is not nice I agree. But I do not quite see inconsistency. Some constructors (like `Integer.__init__`) can perfectly support additional syntax. The problem to me is that on Python2, `1_3.` does not raise an error. But I do not want to worry about Python2. If you find a non invasive solution, feel free to add to the branch.

Related comment: it would be interesting to benchmark the two options for the preparser `123 -> Integer(123)` to `123 -> Integer('123')`. See the noticeable slowdown mentioned in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/Pc1qgjd_SzQ).


---

Comment by git created at 2020-02-26 20:04:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-02-26 20:08:10

Okay, good enough, I think.


---

Comment by jhpalmieri created at 2020-02-26 20:08:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-02-27 23:12:43

Resolution: fixed
