# Issue 31146: Bug converting zero Laurent series to power series

Issue created by migration from https://trac.sagemath.org/ticket/31383

Original creator: mmezzarobba

Original creation time: 2021-02-11 13:43:47

An issue found by Thibaut Verron:

```
sage: S.<x> = PowerSeriesRing(QQ)
sage: L = Frac(S)
sage: s = L(O(x^2))*x^(-1)
sage: s.power_series()
TypeError: self is not a power series
```



---

Comment by mmezzarobba created at 2021-02-11 13:52:47

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2021-02-11 14:12:44

New commits:


---

Comment by mmezzarobba created at 2021-02-12 08:02:19

So the doctest I added fails on the patchbot, but I am unable to reproduce the failure. Does anyone have a clue what may be going wrong?


---

Comment by @DaveWitteMorris created at 2021-02-12 09:53:33

I think the problem is that the previous doctest is

```
sage: L.<t> = LaurentSeriesRing(GF(2))
sage: R.<x,y> = PolynomialRing(L)
sage: O = L._power_series_ring
sage: S.<x,y> = PolynomialRing(O)
sage: t**(-1)*x*y in S
False
```

Tbis redefines the variable `O`, which messes up your doctest. Changing this variable to a different letter should fix the problem.

However, I do think there is a different bug in the code, because the following should return `TypeError: self is not a power series`, instead of `O(x^0)`:

```
sage: S.<x> = PowerSeriesRing(QQ)                                                                                                                          
sage: L = Frac(S)                                                                                                                                          
sage: s = L(O(x^2))*x^(-3)                                                                                                                                 
sage: s.power_series()                                                                                                                                     
O(x^0)
```



---

Comment by mmezzarobba created at 2021-02-12 10:09:29

Replying to [comment:4 gh-DaveWitteMorris]:
> I think the problem is that the previous doctest is
> {{{
> sage: L.<t> = LaurentSeriesRing(GF(2))
> sage: R.<x,y> = PolynomialRing(L)
> sage: O = L._power_series_ring
> sage: S.<x,y> = PolynomialRing(O)
> sage: t**(-1)*x*y in S
> False
> }}}
> Tbis redefines the variable `O`, which messes up your doctest. Changing this variable to a different letter should fix the problem.

Oh, thanks. I'm stupid!

> However, I do think there is a different bug in the code, because the following should return `TypeError: self is not a power series`, instead of `O(x^0)`:
> {{{
> sage: S.<x> = PowerSeriesRing(QQ)                                                                                                                          
> sage: L = Frac(S)                                                                                                                                          
> sage: s = L(O(x<sup>2))*x</sup>(-3)                                                                                                                                 
> sage: s.power_series()                                                                                                                                     
> O(x^0)
> }}}

That's debatable given how power series (for some reason I don't understand) are considered to be zero when all of their known coefficients are zero. But I think I agree with you...


---

Comment by git created at 2021-02-12 10:21:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @DaveWitteMorris created at 2021-02-14 01:45:40

This looks good to me. Thanks for fixing the problem.

However, the docstring starts immediately with `EXAMPLE`. Would you be willing to add a short descriptive blurb at the start? I was thinking something like:

```
Return a power series that is equal to `self`.

A `TypeError` is raised if `self` has a term (or an error term `O(x^k)`)
whose exponent is negative.
```



---

Comment by git created at 2021-02-14 08:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2021-02-14 08:41:33

Replying to [comment:7 gh-DaveWitteMorris]:
> However, the docstring starts immediately with `EXAMPLE`. Would you be willing to add a short descriptive blurb at the start?

That's a bit out of scope for this ticket, but fine.

I don't want to document the fact that it raises a `TypeError` though, because I don't think it is the correct choice (it should be a `ValueError`).


---

Comment by @DaveWitteMorris created at 2021-02-14 08:54:59

Thanks, that's excellent. (I agree that `ValueError` seems like a better choice.) 

You can set to positive review on my behalf when the patchbot is green again.


---

Comment by @DaveWitteMorris created at 2021-02-14 23:24:49

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-02-14 23:30:43

A trivial docstring point: ```self``` with code formatting is better than the latex formatted ``self`` IMO.


---

Comment by mmezzarobba created at 2021-02-15 05:45:40

Replying to [comment:12 tscrim]:
> A trivial docstring point: ```self``` with code formatting is better than the latex formatted ``self`` IMO.

Oh, right. I thought I had changed that. Thank you.


---

Comment by git created at 2021-02-15 05:46:48

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-02-15 05:46:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by @DaveWitteMorris created at 2021-02-16 04:09:50

Sorry for the mistake in my review comment. Thanks for fixing it!


---

Comment by @DaveWitteMorris created at 2021-02-16 04:09:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-09 00:01:28

Resolution: fixed
