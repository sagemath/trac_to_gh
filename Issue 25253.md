# Issue 25253: Fix Matrix_gfpn_dense.rescale_row_c

Issue created by migration from https://trac.sagemath.org/ticket/25490

Original creator: SimonKing

Original creation time: 2018-06-01 10:22:05

CC:  tscrim

Keywords: MeatAxe rescale row

There are two problems with `Matrix_gfpn_dense.rescale_row_c`:
1. The optional argument `start_col` is not supported - see also #25476.
2. It is assumed that the field and the row size (which are global variables in MeatAxe) are correctly assigned to, but this assumption is easily violated:

```
sage: K.<x> = GF(25)
sage: L.<y> = GF(81)
sage: M = MatrixSpace(K,1,25)(sorted(list(K)))
sage: N = MatrixSpace(L,5,5)(sorted(list(L))[:25])
sage: M.rescale_row(0,2)
sage: M
[      0       2       1   x + 1   x + 3       x   x + 1   x + 2   x + 3   x + 4     2*x 2*x + 1 2*x + 2 2*x + 3 2*x + 4     3*x 3*x + 1 3*x + 2 3*x + 3 3*x + 4     4*x 4*x + 1 4*x + 2 4*x + 3 4*x + 4]
sage: M = MatrixSpace(K,1,25)(sorted(list(K)))
sage: M.rescale_row(0,2)
sage: M
[      0       2       4       1       3     2*x 2*x + 2 2*x + 4 2*x + 1 2*x + 3     4*x 4*x + 2 4*x + 4 4*x + 1 4*x + 3       x   x + 2   x + 4   x + 1   x + 3     3*x 3*x + 2 3*x + 4 3*x + 1 3*x + 3]
```

So, in the first part of the example, creation of `N` makes MeatAxe believe that the current row size is 5 and the field has 81 elements, and therefore rescaling `M` is doomed.


---

Comment by SimonKing created at 2018-06-01 10:53:36

As it turns out, there are several places in which I forgot to assign the field and/or row size before calling a `Ff*` function from MeatAxe. So, I am fixing these as well. Note that it is fine to call an `Ff*` function for a matrix after calling a `Mat*` function from MeatAxe, because the `Mat*` functions all assign the correct field and row size.


---

Comment by tscrim created at 2018-06-01 10:54:32

Sounds good.


---

Comment by SimonKing created at 2018-06-01 17:26:03

I fixed a couple of places where field and row size are not assigned, and I enabled the use of the optional `start_col` argument of `add_multiple_of_row_c` and `rescale_row_c`. Tests in sage/matrix/ pass.
----
New commits:


---

Comment by SimonKing created at 2018-06-01 17:26:03

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-06-01 17:27:04

PS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.


---

Comment by jdemeyer created at 2018-06-06 12:41:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-06 13:12:25

New commits:


---

Comment by jdemeyer created at 2018-06-06 13:12:25

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-06-06 13:13:10

Replying to [comment:6 SimonKing]:
> PS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.

This part has been moved to #25518.


---

Comment by tscrim created at 2018-06-07 06:06:24

This looks like a mistake:

```diff
@@ -1231,6 +1317,7 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
         """
         if self.Data == NULL:
             raise ValueError("The matrix must not be empty")
+        FfSetField(self.Data.Field)
         cdef Matrix_gfpn_dense left
         FfSetField(self.Data.Field)
         cdef FEL r
```


Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.


---

Comment by jdemeyer created at 2018-06-07 07:38:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-07 07:38:57

Replying to [comment:11 tscrim]:
> This looks like a mistake

Yes, I guess the same patch was added on two different tickets (#25079 and #25490).


---

Comment by SimonKing created at 2018-06-07 07:43:04

Replying to [comment:11 tscrim]:
> This looks like a mistake:
> {{{#!diff
> `@``@` -1231,6 +1317,7 `@``@` cdef class Matrix_gfpn_dense(Matrix_dense):
>          """
>          if self.Data == NULL:
>              raise ValueError("The matrix must not be empty")
> +        FfSetField(self.Data.Field)
>          cdef Matrix_gfpn_dense left
>          FfSetField(self.Data.Field)
>          cdef FEL r
> }}}

Right, setting the field twice is a mistake.

> Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.

Patching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.


---

Comment by tscrim created at 2018-06-07 09:15:00

Replying to [comment:13 SimonKing]:
> Replying to [comment:11 tscrim]:
> > Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.
> 
> Patching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.

It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead (and this might be something the library might benefit from having internally). However, I am content with the current state here (modulo the double set).


---

Comment by jdemeyer created at 2018-06-07 09:17:44

Replying to [comment:14 tscrim]:
> It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead

If you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.


---

Comment by tscrim created at 2018-06-07 09:52:57

Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 tscrim]:
> > It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead
> 
> If you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.

I am just referring to some of the unnecessary extra variables that are used or extra error checks. For instance, things like

```c
  /* "sage/groups/perm_gps/permgroup_element.pyx":244
 *     if isinstance(g, Permutation):
 *         return g.cycle_tuples()
 *     if isinstance(g, PermutationGroupElement):             # <<<<<<<<<<<<<<
 *         g = g.cycle_tuples()
 *     if isinstance(g, str):
 */
  __pyx_t_3 = __Pyx_TypeCheck(__pyx_v_g, __pyx_ptype_4sage_6groups_8perm_gps_17permgroup_element_PermutationGroupElement); 
  __pyx_t_4 = (__pyx_t_3 != 0);
  if (__pyx_t_4) {
```

Granted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away, but I still wonder if takes up a few extra CPU cycles, which multiplied by times they occur could result in faster code.


---

Comment by tscrim created at 2018-06-07 09:54:01

I should make it clear I do not have any concrete example where I could write C code that would be definitely faster than Cython's version. Although I have not currently tried such a comparison.


---

Comment by tscrim created at 2018-06-07 10:16:17

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-06-07 10:16:17

From looking at the C code of the added here, the Cython really should not have any real overhead.

I just removed the duplicate mentioned above. I suppose the proper thing is to have someone else check this rather than simply setting it to a positive review.
----
New commits:


---

Comment by jdemeyer created at 2018-06-07 11:46:40

Replying to [comment:16 tscrim]:
> Granted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away

I'm pretty sure that this is the case indeed. Recent compilers are very good at this.

Anyway, I thought that you were referring to "pure C" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.


---

Comment by tscrim created at 2018-06-08 02:30:25

Replying to [comment:19 jdemeyer]:
> Anyway, I thought that you were referring to "pure C" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.

Only in a very small part. Although it is nice to see with proper typing for everything that it basically is a straight translation to C.


---

Comment by tscrim created at 2018-06-29 09:49:40

Can someone verify my change? That is the only thing missing from a positive review here.


---

Comment by SimonKing created at 2018-06-29 12:42:15

Replying to [comment:21 tscrim]:
> Can someone verify my change? That is the only thing missing from a positive review here.

Are you only talking about commit:1a97f39? That's of course totally fine, FfSetField was called twice where it should only be called once.

So, if that's the only issue, it is "positive review".


---

Comment by tscrim created at 2018-06-29 13:08:09

Yep, that was it.


---

Comment by tscrim created at 2018-06-29 13:08:09

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-06-29 13:08:20

Changing keywords from "MeatAxe rescale row" to "MeatAxe rescale row, days94".


---

Comment by vbraun created at 2018-06-30 15:21:16

Resolution: fixed
