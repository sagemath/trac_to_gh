# Issue 10565: Include David Perkinson's sandpile module in the sage library

Issue created by migration from https://trac.sagemath.org/ticket/10618

Original creator: mhampton

Original creation time: 2011-01-13 04:35:42

Assignee: jason, ncohen, rlm

CC:  dperkinson wdj ddrake

Keywords: abelian sandpile model

Since David Perkinson's sandpile module (for studying the Abelian Sandpile Model; see for example: [http://en.wikipedia.org/wiki/Bak-Tang-Wiesenfeld_sandpile](http://en.wikipedia.org/wiki/Bak-Tang-Wiesenfeld_sandpile) or [http://people.reed.edu/~davidp/sand/](http://people.reed.edu/~davidp/sand/)) is already written as a properly formatted Sage module it makes sense to include it in the Sage library.

This module involves a variety of mathematics but it seems to make the most sense in the graphs module.

Some parts of the module require 4ti2, currently an experimental package (but there is no reason it can't be at least an optional package), but this can be explained in the relevant docstrings.

In case any mathematical justification is needed, this model is of considerable and rising interest.  For example, at the joint math meetings in 2011 there was a talk by Yuval Peres of Microsoft Research surveying it: [http://www.ams.org/amsmtgs/2125_abstracts/1067-a0-38.pdf](http://www.ams.org/amsmtgs/2125_abstracts/1067-a0-38.pdf).


---

Attachment

adds module to graphs folder and the all.py in graphs


---

Comment by mhampton created at 2011-01-13 04:36:46

Changing status from new to needs_review.


---

Comment by wdj created at 2011-01-14 19:56:52

Changing status from needs_review to needs_work.


---

Comment by wdj created at 2011-01-14 19:56:52

This applies fine to a clone of sage-4.6.1.rc1. However, it fails a ton of doctests. These might pass if the (optional/experimanetal) spkgs were installed. The point is, it should pass if nothing is installed. However, there were also these:


```

    sage: D.__dict__
Expected:
    {'_sandpile': Digraph on 3 vertices, '_effective_div': [{0: 2, 1: 0, 2: 0}, {0: 0, 1: 1, 2: 1}], '_linear_system': {'inhomog': [[1, 0, 0], [0, -1, -1], [0, 0, 0]], 'num_inhomog': 3, 'num_homog': 2, 'homog': [[-1, -1, -1], [1, 1, 1]]}, '_vertices': [0, 1, 2]}
Got:
    {'_sandpile': Digraph on 3 vertices, '_vertices': [0, 1, 2]}
```

and

```

    sage: D._set_linear_system()
Expected nothing
Got:
    <BLANKLINE>
                     **********************************
                     *** This method requires 4ti2. ***
                     **********************************
    <BLANKLINE>
                Read the beginning of sandpile.sage or see the Sage Sandpiles
                documentation for installation instructions.
    <BLANKLINE>
}}
for example.

This occurred on both an ubuntu machine and a 10.6.6 mac.


---

Comment by mhampton created at 2011-01-15 18:40:24

Thanks for taking a look.  I'll try to fix this up.  I think the 4ti2 functions can be flagged "optional".


---

Comment by mhampton created at 2011-01-16 10:51:20

OK, all tests pass for me now and the coverage is 100%.

The only problem that I see now is how to deal with namespace issues.  I think classes like "Divisor" have too general a name to get imported into Sage at the top level, which is what this patch currently does.  I see three alternatives at least:

1) Rename functions and classes to be clearly sandpile specific.  E.g., rename the Divisor class to something like SandpileDivisor.  

2) Don't import this module into the namespace at all, so users would have to do: 

```
sage: from sage.sandpiles import * 
```

themselves.

3) Import the module in its own namespace, so for instance you would have to do:

```
sage: S = sandpiles.complete_sandpile(4)
```


I would rank these as 1 > 2 > 3, but this is an important decision since it will be a pain to change later.


---

Comment by wdj created at 2011-01-16 17:10:10

Replying to [comment:6 mhampton]:
> OK, all tests pass for me now and the coverage is 100%.
> 


Not for me:


```
sage -t -force_lib "devel/sage/sage/sandpiles/sandpile.py"  
**********************************************************************
File "/Users/wdj/sagefiles/sage-4.6.1.rc1/devel/sage/sage/sandpiles/sandpile.py", line 5173:
    sage: for p in P:
       sum([partition_sandpile(S, i).betti(verbose=False)[-Integer(1)] for i in p])
Exception raised:
    Traceback (most recent call last):
      File "/Users/wdj/sagefiles/sage-4.6.1.rc1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/wdj/sagefiles/sage-4.6.1.rc1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/wdj/sagefiles/sage-4.6.1.rc1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_160[3]>", line 1, in <module>
        for p in P:###line 5173:
    sage: for p in P:
    NameError: name 'P' is not defined
**********************************************************************
1 items had failures:
   1 of   5 in __main__.example_160
***Test Failed*** 1 failures.
```

This sort of failure occurs on both a 10.6.6 imac and an ubuntu machine.


> The only problem that I see now is how to deal with namespace issues.  
> I think classes like "Divisor" have too general a name to get imported into 
> Sage at the top level, which is what this patch currently does.  
> I see three alternatives at least:
> 
> 1) Rename functions and classes to be clearly sandpile specific.  
> E.g., rename the Divisor class to something like SandpileDivisor.  
> 


I agree. I actually suggested this when David P was asking for suggestions
years ago in reply to his post asking for comments on a first version.


---

Comment by mhampton created at 2011-01-16 23:38:41

Supersedes previous patch.


---

Attachment

Sorry about that, I'm not sure how I missed that.  I have tried once again, new patch has same name as the last one.


---

Comment by wdj created at 2011-01-17 14:41:20

This installed and pases sage -testall on imac running 10.6.6 and sage-4.6.1.rc1. However, the instll of 4ti2 failed. I'll try it on a linux machine.


---

Comment by wdj created at 2011-01-17 17:27:28

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-01-17 17:27:28

Replying to [comment:9 wdj]:
> This installed and passes sage -testall on imac running 10.6.6 and 
> sage-4.6.1.rc1. However, the install of 4ti2 failed. I'll try it on a linux machine.

To be more precise, the instuctions on installing 4ti2 given in the
docstrings to this module fail. If you instead use the instructions 
given in http://trac.sagemath.org/sage_trac/ticket/8217#comment:5
then 4ti2 does install fine.

I'll report back on the results of running sage -testall -optional ASAP.


---

Comment by wdj created at 2011-01-17 22:31:03

Changing status from needs_review to needs_info.


---

Comment by wdj created at 2011-01-17 22:31:03

This looks good in the sense that the docstrings do not fail after 4ti2 (and glpk) is added.

I am willing to give this a positive review. However, there are still some problems with the docstrings - (a) the naming issue mentioned above, (b) one date in the AUTHOR field has the wrong year, (c) the instructions on installing 4ti2 lead to the old package which does not install. 

Should these be fixed in a separate ticket?


---

Comment by mhampton created at 2011-01-18 02:04:54

Changing status from needs_info to needs_work.


---

Comment by mhampton created at 2011-01-18 02:04:54

No, I think we should get this pretty much right before it officially goes in - it would be annoying to change names later since we'd have to formally deprecate everything.  I'll ask David Perkinson directly what he thinks about the namespace issues.


---

Attachment


---

Comment by mhampton created at 2011-01-27 04:58:45

David Perkinson is OK with the idea of renaming some functions and classes to avoid confusion in the top namespace.  The attached patch - trac_10618_sandpiles.2.patch - is a first attempt at resolving this aspect of the module.


---

Comment by wdj created at 2011-02-01 12:47:54

Applying only trac_10618_sandpiles.2.patch to 4.6.1.rc0 on an ubuntu machine resulted in all tests passed in sage -testall. This is without 4ti2.

I think you still need
http://sage.math.washington.edu/home/mhampton/4ti2-1.3.2.p1.spkg
as opposed to the version on the sage webpage.
I will test this next.

Also, I think you need to add to the intro of this ticket that only the last patch need be applied.


---

Comment by wdj created at 2011-02-01 12:47:54

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-02-02 14:28:35

Replying to [comment:14 wdj]:
> Applying only trac_10618_sandpiles.2.patch to 4.6.1.rc0 on an ubuntu machine resulted in all tests passed in sage -testall. This is without 4ti2.
> 
> I think you still need
> http://sage.math.washington.edu/home/mhampton/4ti2-1.3.2.p1.spkg
> as opposed to the version on the sage webpage.
> I will test this next.

All tests passed! Positive review, though the ticket
http://trac.sagemath.org/sage_trac/ticket/8217 is related...

Thanks Marshall!


> 
> Also, I think you need to add to the intro of this ticket that only the last patch need be applied.


---

Comment by wdj created at 2011-02-02 14:28:35

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-02-22 17:04:49

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-02-22 17:04:49

The commit message of the patch should contain the ticket number.


---

Comment by jdemeyer created at 2011-03-04 13:27:51

I get various doctest failures:

```
sage -t  -force_lib devel/sage/sage/sandpiles/sandpile.py
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2/devel/sage-main/sage/sandpiles/sandpile.py", line 1815:
    sage: S.unsaturated_ideal().gens()
Expected:
    (x1^3 - x4*x3*x0, x2^3 - x5*x3*x0, x3^2 - x5*x2, x4^2 - x3*x1, x5^2 - x3*x2)
Got:
    [x1^3 - x4*x3*x0, x2^3 - x5*x3*x0, x3^2 - x5*x2, x4^2 - x3*x1, x5^2 - x3*x2]
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2/devel/sage-main/sage/sandpiles/sandpile.py", line 1817:
    sage: S.ideal().gens()
Expected:
    (x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2)
Got:
    [x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2]
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2/devel/sage-main/sage/sandpiles/sandpile.py", line 1840:
    sage: S.ideal(True)
Expected:
    (x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2)
Got:
    [x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2]
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2/devel/sage-main/sage/sandpiles/sandpile.py", line 1842:
    sage: S.ideal().gens()  # another way to get the generators
Expected:
    (x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2)
Got:
    [x2 - x0, x3^2 - x5*x0, x5*x3 - x0^2, x4^2 - x3*x1, x5^2 - x3*x0, x1^3 - x4*x3*x0, x4*x1^2 - x5*x0^2]
**********************************************************************
```



---

Comment by mhampton created at 2011-03-14 12:20:58

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-03-14 14:32:55

Installs fine to 4.7.a1 and passes sage -testall.


---

Comment by wdj created at 2011-03-14 14:32:55

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-03-16 11:28:27

Again: you should change the commit message of the patch such that the first line mentions the ticket number.  Use `hg qrefresh -e` for that.


---

Comment by jdemeyer created at 2011-03-16 11:28:27

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-03-19 17:37:15

On which machine did you check where to write "# long time"?  It seems that most of these "long time" doctests take less than 1 second on `sage.math.washington.edu`, which means that they should not be marked "long time".

For example, this doctest on line 196::

```
sage: from sage.sandpiles import *
sage: g = {0: {},                    \
               1: {0: 1, 2: 1, 3: 1},    \
               2: {1: 1, 3: 1, 4: 1},    \
               3: {1: 1, 2: 1, 4: 1},    \
               4: {2: 1, 3: 1}}
sage: S = Sandpile(g,0)
sage: S.resolution() # long time (minutes)
'R^1 <-- R^7 <-- R^15 <-- R^13 <-- R^4'
```


Even though the test claims "minutes", in reality it takes about half a second.


---

Comment by mhampton created at 2011-03-19 19:53:44

Apply only this patch.


---

Attachment

I'm not sure why those used to take so much longer.  Its possible that some changes in the Singular interface since then sped things up.  Anyway, now testing everything without the 4ti2 dependencies takes abour 24 seconds on my laptop, and including the 4ti2 stuff it takes about 30 seconds.  So I removed all the "long time" flags.

I also put the ticket number on the commit message.


---

Comment by mhampton created at 2011-03-19 19:55:48

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-03-19 22:52:24

Changing status from needs_review to positive_review.


---

Comment by wdj created at 2011-03-19 22:52:24

Installs fine to 4.7.a1 and passes sage -testall.

Hope this stays as a positive review this time.

Thanks again Marshall for creating this.


---

Comment by jdemeyer created at 2011-03-21 09:42:48

Resolution: fixed


---

Comment by jdemeyer created at 2011-04-18 16:02:12

It seems that testing this module can give enormously different timings depending on the machine.  Any clue why?

On `sage.math.washington.edu`:


```
$ ./sage -t "devel/sage/sage/sandpiles/sandpile.py"
[...]
Total time for all tests: 23.7 seconds
```


But on my laptop (Gentoo Linux, Intel Core 2 Duo, gcc 4.4.3):

```
$ ./sage -t "devel/sage/sage/sandpiles/sandpile.py"
sage -t  "devel/sage/sage/sandpiles/sandpile.py"
*** *** Error: TIMED OUT! PROCESS KILLED! *** ***
```

(i.e. it takes more than 360 seconds)


---

Comment by jdemeyer created at 2011-04-18 16:45:22

Please check the thread
[http://groups.google.com/group/sage-devel/browse_thread/thread/5db90b3681e7dbcb](http://groups.google.com/group/sage-devel/browse_thread/thread/5db90b3681e7dbcb)

Something fishy with the `sandpile.py` timings...
