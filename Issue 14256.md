# Issue 14256: GCC-4.8.0 miscompiles some sig_on() statements

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-04-16 14:37:47

Assignee: GeorgSWeber

With #14452 and #14453, the are crashes in libGAP due to a GCC bug: [http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56982](http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56982)

Compiling with `-fno-tree-dominator-opts` seems to fix the issue, we should add this flag to compile Cython code with GCC >= 4.8.0.


---

Comment by jdemeyer created at 2013-04-16 18:34:09

Changing priority from major to critical.


---

Comment by jdemeyer created at 2013-04-16 18:34:09

Changing status from new to needs_review.


---

Comment by jpflori created at 2013-04-16 20:39:33

I guess the plan is to patch Sage again when GCC fixes the problem (hopefully in 4.8.1 and 4.9.?)?


---

Comment by vbraun created at 2013-04-16 21:00:25

Are we going to remember this, or will that just linger around forever until some setup-archaeologist finds it again? I would prefer just to shitlist a particular version, so if it still crashes the next time then we'll know that its not fixed ;-) 

In fact, the imho best way is to stick it into the compiler wrapper so that everything (and not just the sage library) gets no-tree-dominator-opts enforced if and only if the gcc version is affected. Though thats a bit of a longer project...

So, if you want to go on with this bandaid then thats good enough for now.


---

Comment by jdemeyer created at 2013-04-16 21:35:06

Replying to [comment:6 vbraun]:
> Are we going to remember this, or will that just linger around forever until some setup-archaeologist finds it again? I would prefer just to shitlist a particular version, so if it still crashes the next time then we'll know that its not fixed ;-)
Well, at least it has the necessary pointers to the Sage and GCC bug report, so the setup-archaeologist should be able to determine whether or not the fix is still needed. I find undocumented work-arounds far worse than obsolete work-arounds.

About this particular fix: it doesn't currently give doctest failures. If we only apply this fix for GCC-4.8.0 and GCC-4.8.1 comes out without the bug fix, who will remember to check for this bug?


---

Comment by jpflori created at 2013-04-16 22:20:28

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 vbraun]:
> > Are we going to remember this, or will that just linger around forever until some setup-archaeologist finds it again? I would prefer just to shitlist a particular version, so if it still crashes the next time then we'll know that its not fixed ;-)
> Well, at least it has the necessary pointers to the Sage and GCC bug report, so the setup-archaeologist should be able to determine whether or not the fix is still needed. I find undocumented work-arounds far worse than obsolete work-arounds.
> 
> About this particular fix: it doesn't currently give doctest failures. If we only apply this fix for GCC-4.8.0 and GCC-4.8.1 comes out without the bug fix, who will remember to check for this bug?
I agree its a saner approach to hope archeologists will limit the GCC versions for which the fix is applied.
At worst, it won't be applied when GCC 4.10 gets stable.

Great you mentioned both the upstream bug and this track ticket in the patch.
Maybe a direct indication of what the bug is could help, e.g. adding "which let sig_on() miscompile" after "bug".
Even without it I'll give it positive_review, when I can reproduce the problem and check its indeed solved with the patch.
(I assume the space between 'null' and '"""' is there for ease of reading.)
From #14460, I thought the crash appeared when doctesting sage/structure/element.pyx?
But after recompiling libgap, this file, and everything in sage/libs/gap, using gcc-4.8 from debian running "./sage -t" on this file is fine.
You mention that there are no failing doctests, so I may have missed something.

Using the code you posted at gcc bugtracker I get

```
[jp`@`jp-x220]% cd ../bla                            ~/boulot/sage/sage-5.9.beta5
[jp`@`jp-x220]% gcc-4.8 -Og jmp.c                               ~/boulot/sage/bla
[jp`@`jp-x220]% ./a.out                                         ~/boulot/sage/bla
Returning 1
x = 0, n = 1
Returning 0
x = 42, n = 1
zsh: abort      ./a.out
```

So I guess debian's gcc does not include a magical fix.


---

Comment by nbruin created at 2013-04-17 00:34:45

Replying to [comment:7 jdemeyer]:

> About this particular fix: it doesn't currently give doctest failures. If we only apply this fix for GCC-4.8.0 and GCC-4.8.1 comes out without the bug fix, who will remember to check for this bug?

Would it be easily doable to include a doctest that DOES fail in the presence of this bug?


---

Comment by jdemeyer created at 2013-04-17 06:24:14

Replying to [comment:9 nbruin]:
> Would it be easily doable to include a doctest that DOES fail in the presence of this bug?
Yes, as I mentioned #14453 does that.


---

Comment by jdemeyer created at 2013-04-17 06:33:48

Replying to [comment:8 jpflori]:
> Maybe a direct indication of what the bug is could help, e.g. adding "which let sig_on() miscompile" after "bug".

Done.


---

Comment by jpflori created at 2013-04-17 07:11:31

Replying to [comment:10 jdemeyer]:
> Replying to [comment:9 nbruin]:
> > Would it be easily doable to include a doctest that DOES fail in the presence of this bug?
> Yes, as I mentioned #14453 does that.
I meant #14453 in my previous post.
I'll rebuild the Sage library and retry doctesting sage/libs/gap/element.pyx


---

Comment by jpflori created at 2013-04-17 09:51:08

I've rebuilt Sage (5.9.beta5 + #10508) completely using Debian gcc/g++/gfortran 4.8.0 without any env variables except for MAKE, CC, GXX, FC and SAGE_ATLAS_ARCH, then applied #14453, rerun "./sage -b", but "./sage -t devel/sage/sage/libs/gap/element.pyx" still passes its doctests...

I don't doubt GCC is broken as I can reproduce its buggy behavior on the piece of code you provided, but it would have been nice to confirm the fix indeed fixes potential problems in Sage.

Last minute info: ok I just needed to set CFLAGS="-Og" to reproduce the bug, I guess this should be more explicitely documented.
It's stated on the GCC ticket but nowhere on Sage's Trac.


---

Comment by jpflori created at 2013-04-17 09:55:59

And when "-Og" is used, then the fix indeed fixes the problem.

So let's mention "-Og" that in the patch as well (let's say in setup.py where the fix is triggered, not sure it will be easy to find near the problematic doctest itself, for that the archeologist will have to come to the trac ticket).


---

Comment by jpflori created at 2013-04-17 09:55:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-04-17 10:06:40

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jpflori created at 2013-04-17 10:09:18

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-17 10:19:11

By the way, there is lots of activity on the GCC ticket. It seems some variation of this bug is reproducible back to GCC 4.1.


---

Comment by leif created at 2013-04-17 22:40:06

Replying to [comment:19 jdemeyer]:
> By the way, there is lots of activity on the GCC ticket. It seems some variation of this bug is reproducible back to GCC 4.1.

Well, if that's true, are you sure same or similar can't happen within the Sage library with GCC versions != 4.![89]*?

On the other hand, if the bug only shows up in conjunction with `-Og` (or maybe `-Os` as well), does it make sense to add `-fno-tree-dominator-opts` regardless of the setting of `CFLAGS` etc., and for every extension module?




IMHO the scenario is specific enough that it's not worth fixing it within Sage at all (and there's an easy "work-around": just add `-fno-tree-dominator-opts` to `CFLAGS` in case it also contains -- not to say "you added" --  `-Og` [and GCC is 4.8.0]).

We do not add a potentially missing `-fno-strict-aliasing` for compiling Cython-generated code (which is a much more common or likely case, and btw. completely independent of the compiler version), nor do we add `-fno-ipa-cp-clone` when building R (with GCC 4.7.x and `-O3`).


---

Comment by jpflori created at 2013-04-17 23:38:31

Replying to [comment:20 leif]:
> On the other hand, if the bug only shows up in conjunction with `-Og` (or maybe `-Os` as well), does it make sense to add `-fno-tree-dominator-opts` regardless of the setting of `CFLAGS` etc., and for every extension module?
Good point.

> nor do we add -fno-ipa-cp-clone when building R (with GCC 4.7.x and -O3).
Maybe we should :) especially that we ship 4.7.x in Sage.


---

Comment by jdemeyer created at 2013-04-18 06:36:16

Replying to [comment:20 leif]:
> Well, if that's true, are you sure same or similar can't happen within the Sage library with GCC versions != 4.![89]*?
Perhaps...

> the bug only shows up in conjunction with `-Og`
This is unfounded speculation.

> does it make sense to add `-fno-tree-dominator-opts` regardless of the setting of `CFLAGS` etc., and for every extension module?
Absolutely, since we don't know the precise conditions which trigger the bug. As I said, `sig_on()` error handling is rarely doctested, so we cannot rely on doctests to check for this bug.


---

Comment by jdemeyer created at 2013-04-18 07:55:12

So, what is your opinion on adding `-fno-dominator-opts` for all GCC versions >= 4.1?


---

Comment by leif created at 2013-04-18 11:57:28

Replying to [comment:22 jdemeyer]:
> Replying to [comment:20 leif]:
> > the bug only shows up in conjunction with `-Og`
> This is unfounded speculation.

Besides that I wrote _"if ..."_, it's as "founded" as the conclusion that (solely) adding `-fno-tree-dominator-opts` solves the issue.


---

Comment by jdemeyer created at 2013-04-19 13:53:08

Resolution: fixed


---

Comment by jdemeyer created at 2013-05-31 11:50:56

Bug still exists in GCC-4.8.1.


---

Comment by jpflori created at 2013-05-31 11:59:28

Too bad.

I was thinking about this and must admit Volker had a point.
We unconditionnally pass "-fno-..." whereas without further tweaking gcc 4.8.0 (and so 4.8.1 as well) correctly compiles sig_on statements.
Of course according to Jeroen we don't really know (or do we now?) what options trigger the miscompile, so it is the safest choice to always pass "-fno-...".

But then why not treat cases where -O3 is passed to CFLAGS and R miscompiles and so on...

(By the way I've remarked that Python has the bad habit to override CFLAGS by adding the content of an OPT variable on the compile command line...)


---

Comment by jdemeyer created at 2013-05-31 12:18:44

Replying to [comment:27 jpflori]:
> gcc 4.8.0 (and so 4.8.1 as well) correctly compiles sig_on statements.
Same answer as I made before: what makes you think that this is true?

> But then why not treat cases where -O3 is passed to CFLAGS and R miscompiles and so on...
I never said we shouldn't fix that. But this is a less serious issue, since `-fipa-cp-clone` is not added by the default R flags of `-O2`. Assuming the user does not use custom `CFLAGS`, adding `-fno-ipa-cp-clone` will not make a difference.

> (By the way I've remarked that Python has the bad habit to override CFLAGS by adding the content of an OPT variable on the compile command line...)
At least, the flags added by Sage come at the very end of the command line.


---

Comment by jpflori created at 2013-05-31 12:40:25

Replying to [comment:28 jdemeyer]:
> Replying to [comment:27 jpflori]:
> > gcc 4.8.0 (and so 4.8.1 as well) correctly compiles sig_on statements.
> Same answer as I made before: what makes you think that this is true?
Or that it is not true?
From your report it seemed you got segfaults only when passing
> 
> > But then why not treat cases where -O3 is passed to CFLAGS and R miscompiles and so on...
> I never said we shouldn't fix that. But this is a less serious issue, since `-fipa-cp-clone` is not added by the default R flags of `-O2`. Assuming the user does not use custom `CFLAGS`, adding `-fno-ipa-cp-clone` will not make a difference.
I agree, I only posted all of this here so that I don't lose it in my mind.
> 
> > (By the way I've remarked that Python has the bad habit to override CFLAGS by adding the content of an OPT variable on the compile command line...)
> At least, the flags added by Sage come at the very end of the command line.
Not really sure, I had a really painful experience lately building Python on a Raspberry Pi.
Doing something like "CFLAGS="-O -g" ./sage -i python.spkg" does not work.
Doing "OPT= CFLAG="-O -g" ..." would work.
Look at configure.ac and Makefile.pre.in, the only thing that comes in $CFLAGS after $OPT is $EXTRA_CFLAGS (which is surely meant to be mostly user defined).
Anyway it's not really the place to discuss this.


---

Comment by jdemeyer created at 2013-05-31 12:48:54

Replying to [comment:29 jpflori]:
> Or that it is not true?
The principle of being on the safe side means that, in the case of doubt, assume something can go wrong.

> From your report it seemed you got segfaults only when passing
...the `-Og` flag. (I guess this is what you wanted to write).

And that's even true: the particular segfault in libGAP only occurs with `-Og`. But there could very well be other segfaults, not found by doctests, in other parts of Sage, with the default flags.


---

Comment by jdemeyer created at 2013-05-31 12:49:52

Let me copy this sentence from the ticket description:

libGAP is one of the few places in Sage where non-trivial use of the sig_on() signal handling is actually tested, so there might be many more places where the problem could occur.


---

Comment by jpflori created at 2013-05-31 12:54:52

Yeah I agree, no harm meant at all.

The best solution would be to live in a world where GCC never exposes bugs.
And as I've said before, I'm ok with the solution which was merged, I even gave positive_review, I just hope the situation would be better.
At some point we'll have to rule out all versions of GCC :)
