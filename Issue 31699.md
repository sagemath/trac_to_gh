# Issue 31699: doc-pdf fails: Japanese characters creeping into Italian tour of Sage

archive/issues_031699.json:
```json
{
    "body": "CC:  @zlscherr fbissey @kliem mkoeppe\n\nWhen building it/a_tour_of_sage, I see this error:\n\n```\n    ! Package inputenc Error: Unicode character \u30ea (U+30EA)\n```\n\nIndeed, the file `local/share/doc/sage/latex/it/a_tour_of_sage/a_tour_of_sage.tex has the line\n\n```\n    \\renewcommand{\\releasename}{\u30ea\u30ea\u30fc\u30b9}\n```\n\nWhy does the Italian tour have these Japanese characters in it? A few lines earlier, I also see\n\n```\n    \\date{2021\u5e7406\u670808\u65e5}\n```\n\nand at the bottom\n\n```\n    \\renewcommand{\\indexname}{\u7d22\u5f15}\n```\n\nThese lines are the same as in ja/a_tour_of_sage/a_tour_of_sage.tex.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31936\n\n",
    "created_at": "2021-06-08T21:33:08Z",
    "labels": [
        "documentation",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "doc-pdf fails: Japanese characters creeping into Italian tour of Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31699",
    "user": "jhpalmieri"
}
```
CC:  @zlscherr fbissey @kliem mkoeppe

When building it/a_tour_of_sage, I see this error:

```
    ! Package inputenc Error: Unicode character リ (U+30EA)
```

Indeed, the file `local/share/doc/sage/latex/it/a_tour_of_sage/a_tour_of_sage.tex has the line

```
    \renewcommand{\releasename}{リリース}
```

Why does the Italian tour have these Japanese characters in it? A few lines earlier, I also see

```
    \date{2021年06月08日}
```

and at the bottom

```
    \renewcommand{\indexname}{索引}
```

These lines are the same as in ja/a_tour_of_sage/a_tour_of_sage.tex.

Issue created by migration from https://trac.sagemath.org/ticket/31936





---

archive/issue_comments_452913.json:
```json
{
    "body": "Since maybe Sage 9.3, some interface elements of\nthe (English language) (html) developer guide appear\nin Japanese for me in Sage built from source.\n\nComparing the online version and my local version\nof the \"Git setup\" page for instance:\n\n- https://doc.sagemath.org/html/en/developer/git_setup.html\n- file:///path_to_sage/local/share/doc/sage/html/en/developer/git_setup.html\n\nthe correspondence is as follows.\n\nMenu headers in the left menu:\n\n- Table of Contents - \u76ee\u6b21\n- Previous topic - \u524d\u306e\u30c8\u30d4\u30c3\u30af\u3078\n- Next topic - \u6b21\u306e\u30c8\u30d4\u30c3\u30af\u3078\n- This Page - \u3053\u306e\u30da\u30fc\u30b8\n- Quick search - \u30af\u30a4\u30c3\u30af\u691c\u7d22\n\nNavigation menu (top right and bottom right):\n\n- previous - \u524d\u3078\n- next - \u6b21\u3078\n- index - \u7d22\u5f15",
    "created_at": "2021-06-08T22:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452913",
    "user": "slelievre"
}
```

Since maybe Sage 9.3, some interface elements of
the (English language) (html) developer guide appear
in Japanese for me in Sage built from source.

Comparing the online version and my local version
of the "Git setup" page for instance:

- https://doc.sagemath.org/html/en/developer/git_setup.html
- file:///path_to_sage/local/share/doc/sage/html/en/developer/git_setup.html

the correspondence is as follows.

Menu headers in the left menu:

- Table of Contents - 目次
- Previous topic - 前のトピックへ
- Next topic - 次のトピックへ
- This Page - このページ
- Quick search - クイック検索

Navigation menu (top right and bottom right):

- previous - 前へ
- next - 次へ
- index - 索引



---

archive/issue_comments_452914.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-06-09T00:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452914",
    "user": "jhpalmieri"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_452915.json:
```json
{
    "body": "Oh, I see that too. Ticket summary changed.",
    "created_at": "2021-06-09T00:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452915",
    "user": "jhpalmieri"
}
```

Oh, I see that too. Ticket summary changed.



---

archive/issue_comments_452916.json:
```json
{
    "body": "The Sphinx upgrade #31696 doesn't help.",
    "created_at": "2021-06-09T04:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452916",
    "user": "jhpalmieri"
}
```

The Sphinx upgrade #31696 doesn't help.



---

archive/issue_comments_452917.json:
```json
{
    "body": "I cannot reproduce this on (Gentoo) Linux. Everything looks fine.\nOn the other hand, I see it (Japanese menus) on macOS 11.4, too.",
    "created_at": "2021-06-09T15:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452917",
    "user": "dimpase"
}
```

I cannot reproduce this on (Gentoo) Linux. Everything looks fine.
On the other hand, I see it (Japanese menus) on macOS 11.4, too.



---

archive/issue_comments_452918.json:
```json
{
    "body": "#30551 changed various locale settings, perhaps it's the culprit.",
    "created_at": "2021-06-09T16:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452918",
    "user": "dimpase"
}
```

#30551 changed various locale settings, perhaps it's the culprit.



---

archive/issue_comments_452919.json:
```json
{
    "body": "The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).",
    "created_at": "2021-06-10T02:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452919",
    "user": "jhpalmieri"
}
```

The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).



---

archive/issue_comments_452920.json:
```json
{
    "body": "Do we have some kind of race condition between languages? Does the problem persists when building serially?",
    "created_at": "2021-06-10T02:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452920",
    "user": "fbissey"
}
```

Do we have some kind of race condition between languages? Does the problem persists when building serially?



---

archive/issue_comments_452921.json:
```json
{
    "body": "If I unset `MAKE`, I think that makes it build serially, and I still see the problem. I wonder if it comes from lines like this in `src/doc/ja/a_tour_of_sage/conf.py`:\n\n```\nfrom sage.docs.conf import release, latex_elements\nfrom sage.docs.conf import *  # NOQA\n```\n\nand similar lines in other `conf.py` files. Could modifications to configuration variables get passed between different builds?",
    "created_at": "2021-06-10T02:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452921",
    "user": "jhpalmieri"
}
```

If I unset `MAKE`, I think that makes it build serially, and I still see the problem. I wonder if it comes from lines like this in `src/doc/ja/a_tour_of_sage/conf.py`:

```
from sage.docs.conf import release, latex_elements
from sage.docs.conf import *  # NOQA
```

and similar lines in other `conf.py` files. Could modifications to configuration variables get passed between different builds?



---

archive/issue_comments_452922.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).\nNice catch. Previously the different languages were isolated in separate processes via `build_many`, now they run serially in the same Python process, so there's a potential for state to persist.",
    "created_at": "2021-06-10T03:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452922",
    "user": "mkoeppe"
}
```

Replying to [comment:7 jhpalmieri]:
> The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).
Nice catch. Previously the different languages were isolated in separate processes via `build_many`, now they run serially in the same Python process, so there's a potential for state to persist.



---

archive/issue_comments_452923.json:
```json
{
    "body": "#31948 (Reimplement parallel docbuild using make) could be a solution; or a simpler workaround using `os.system` (or similar) to run the separate documents serially in separate processes.",
    "created_at": "2021-06-10T03:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452923",
    "user": "mkoeppe"
}
```

#31948 (Reimplement parallel docbuild using make) could be a solution; or a simpler workaround using `os.system` (or similar) to run the separate documents serially in separate processes.



---

archive/issue_comments_452924.json:
```json
{
    "body": "I think that #31948 fixes this. Once that's merged and tested, we should close this ticket.",
    "created_at": "2021-06-17T16:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452924",
    "user": "jhpalmieri"
}
```

I think that #31948 fixes this. Once that's merged and tested, we should close this ticket.



---

archive/issue_comments_452925.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-23T16:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452925",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452926.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-23T16:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452926",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452927.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-06-24T20:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31699#issuecomment-452927",
    "user": "mkoeppe"
}
```

Resolution: invalid
