# Issue 31699: doc-pdf fails: Japanese characters creeping into Italian tour of Sage

Issue created by migration from https://trac.sagemath.org/ticket/31936

Original creator: jhpalmieri

Original creation time: 2021-06-08 21:33:08

CC:  @zlscherr fbissey @kliem mkoeppe

When building it/a_tour_of_sage, I see this error:

```
    ! Package inputenc Error: Unicode character リ (U+30EA)
```

Indeed, the file `local/share/doc/sage/latex/it/a_tour_of_sage/a_tour_of_sage.tex has the line

```
    \renewcommand{\releasename}{リリース}
```

Why does the Italian tour have these Japanese characters in it? A few lines earlier, I also see

```
    \date{2021年06月08日}
```

and at the bottom

```
    \renewcommand{\indexname}{索引}
```

These lines are the same as in ja/a_tour_of_sage/a_tour_of_sage.tex.


---

Comment by slelievre created at 2021-06-08 22:25:58

Since maybe Sage 9.3, some interface elements of
the (English language) (html) developer guide appear
in Japanese for me in Sage built from source.

Comparing the online version and my local version
of the "Git setup" page for instance:

- https://doc.sagemath.org/html/en/developer/git_setup.html
- file:///path_to_sage/local/share/doc/sage/html/en/developer/git_setup.html

the correspondence is as follows.

Menu headers in the left menu:

- Table of Contents - 目次
- Previous topic - 前のトピックへ
- Next topic - 次のトピックへ
- This Page - このページ
- Quick search - クイック検索

Navigation menu (top right and bottom right):

- previous - 前へ
- next - 次へ
- index - 索引


---

Comment by jhpalmieri created at 2021-06-09 00:05:45

Changing priority from critical to blocker.


---

Comment by jhpalmieri created at 2021-06-09 00:05:45

Oh, I see that too. Ticket summary changed.


---

Comment by jhpalmieri created at 2021-06-09 04:59:44

The Sphinx upgrade #31696 doesn't help.


---

Comment by dimpase created at 2021-06-09 15:06:27

I cannot reproduce this on (Gentoo) Linux. Everything looks fine.
On the other hand, I see it (Japanese menus) on macOS 11.4, too.


---

Comment by dimpase created at 2021-06-09 16:50:20

#30551 changed various locale settings, perhaps it's the culprit.


---

Comment by jhpalmieri created at 2021-06-10 02:00:03

The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).


---

Comment by fbissey created at 2021-06-10 02:18:42

Do we have some kind of race condition between languages? Does the problem persists when building serially?


---

Comment by jhpalmieri created at 2021-06-10 02:43:18

If I unset `MAKE`, I think that makes it build serially, and I still see the problem. I wonder if it comes from lines like this in `src/doc/ja/a_tour_of_sage/conf.py`:

```
from sage.docs.conf import release, latex_elements
from sage.docs.conf import *  # NOQA
```

and similar lines in other `conf.py` files. Could modifications to configuration variables get passed between different builds?


---

Comment by mkoeppe created at 2021-06-10 03:14:44

Replying to [comment:7 jhpalmieri]:
> The problem is #31344, in particular commit [b4ceee5](https://git.sagemath.org/sage.git/commit/?id=b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a).
Nice catch. Previously the different languages were isolated in separate processes via `build_many`, now they run serially in the same Python process, so there's a potential for state to persist.


---

Comment by mkoeppe created at 2021-06-10 03:23:15

#31948 (Reimplement parallel docbuild using make) could be a solution; or a simpler workaround using `os.system` (or similar) to run the separate documents serially in separate processes.


---

Comment by jhpalmieri created at 2021-06-17 16:09:47

I think that #31948 fixes this. Once that's merged and tested, we should close this ticket.


---

Comment by mkoeppe created at 2021-06-23 16:00:43

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-06-23 16:11:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-24 20:15:37

Resolution: invalid
