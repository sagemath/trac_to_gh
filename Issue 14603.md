# Issue 14603: build system for sage (the library)

Issue created by migration from Trac.

Original creator: felixs

Original creation time: 2013-06-22 21:03:30

Assignee: Felix Salfelder

CC:  leif fbissey jondo

Sage ("the library") needs a build system that works outside of sage ("the distribution").


---

Comment by leif created at 2013-06-22 22:24:14

Changing assignee from Felix Salfelder to felixs.


---

Comment by jdemeyer created at 2013-07-21 21:56:23

Why would this be a blocker?


---

Comment by jdemeyer created at 2013-07-21 21:56:23

Changing priority from blocker to major.


---

Comment by felixs created at 2013-08-09 09:27:05

Replying to [comment:5 jdemeyer]:
> Why would this be a blocker?

it's not, sorry.

i have created a dist tarball from my WIP branch. it is contained in [http://tool.em.cs.uni-frankfurt.de/~felix/sagelib](http://tool.em.cs.uni-frankfurt.de/~felix/sagelib). please comment or help to improve it.


---

Comment by felixs created at 2013-08-28 15:09:29

Changing keywords from "" to "sagelib".


---

Comment by git created at 2013-09-01 11:23:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-09-02 20:14:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by felixs created at 2013-09-03 08:44:28

Changing status from new to needs_review.


---

Comment by felixs created at 2013-09-03 08:44:28

A clean `sagelib` package that works outside of sage (the distribution) requires something like #14796. I will open another ticket...


---

Comment by git created at 2013-09-06 14:38:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-09-08 09:27:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-09-12 08:36:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-09-12 10:07:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2013-12-29 18:17:40

Needs to be rebased.


---

Comment by jdemeyer created at 2013-12-29 18:17:40

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-03-01 14:28:48

I wonder if Felix could give an update on the status of this work.  Obviously it hasn't been touched in a long while and needs to be rebased.  But it seems like a lot of the heavy lifting has been done and this provides a good starting point for overhauling Sage's build.

What is the status of the Sage community's interest in this sort of work?


---

Comment by felixs created at 2016-09-11 08:57:52

Hi Erik.

maybe you can reycle the configure.ac (and most path related patches) for sagelib. the canonical transition would be to reuse the python build system for a start (templatize setup.py, call it from make...)

i could not get anywhere before rewriting the whole thing to automake, as setup.py did/does not work (until today?). mostly due to

- lack of automatic dependency tracking
  (C/C++ compilers only write makefiles, setup.py does not use them. cython -MF is not ready yet)
- missing VPATH builds
  (requirement for mere sanity, also for distcheck, cf. #21469),

rendering the approach useless for debugging/development on foreign distros.

eventually all this was of no use for sage (the distribution) until a functional top-level build system would be in place. it might still facilitate packaging and use...

i am not totally up to date with the recent (last ~3 years) changes, and YMMV.


---

Comment by jdemeyer created at 2016-09-12 15:07:52

`@`felixs: I think it is a bit strange that you're trying to use a autotools-based build system for a Python package. I don't know if that has ever been done. I agree in principle that autotools is better than whatever Python provides. However, you should weigh this against the fact that this would be very non-standard. I guess that distros would hate us for doing that.


---

Comment by felixs created at 2016-09-12 16:26:26

Replying to [comment:23 jdemeyer]:
> `@`felixs: I think it is a bit strange that you're trying to use a autotools-based build system for a Python package.

hi Jeroen

the reason i pulled in autotools was initially just autoconf. if you can make autoconf+setup.py.in work, then you don't need automake. likewise, if you reimplement autoconf in python etcpp. there are many ways, most of which involve "implement a viable alternative to autotools", which in my understanding is beyond the scope of this project.

> I don't know if that has ever been done.

automake supports python for a loong time. i am not "trying to use" rather than "suggesting" to use it. the cython rules i wrote for sagelib back then are now in use for another project (where, coincidentally, cython is used on some interface code).

> I guess that distros would hate us for doing that.

that i don't understand. package maintainers usually keep saying things like "people, use auto{conf,tools,make}". cannot think of a way that would make packageing any easier. (care to explain?)


---

Comment by jdemeyer created at 2016-09-12 19:33:19

Replying to [comment:24 felixs]:
> that i don't understand. package maintainers usually keep saying things like "people, use auto{conf,tools,make}".

...as alternative to home-brew build systems. But I have never seen a package maintainer say that as alternative to `setup.py`.


---

Comment by felixs created at 2016-09-12 20:27:10

> But I have never seen a package maintainer say that as alternative to setup.py.

true/plausible. the typical python package has simple dependencies and does not use cython. no need for a chainsaw.

still, i see no evidence why someone might "hate us" for using auto* (for whichever sort of package). instead (let me repeat), the autotools implement
- VPATH
- (pre build) configuration
- (compile time) dependencies
- a make based build process
all of which immediately facilitate development, testing, debugging and thus packaging.


---

Comment by jdemeyer created at 2016-09-12 20:36:36

Replying to [comment:26 felixs]:
> instead (let me repeat), the autotools implement
> - VPATH
> - (pre build) configuration
> - (compile time) dependencies
> - a make based build process
> all of which immediately facilitate development, testing, debugging and thus packaging.

The autotools implement that for a typical C/C++ package. They don't really implement all that for Python packages. Which means that we have to implement that ourselves.


---

Comment by felixs created at 2016-09-12 21:02:19

>  The autotools implement that for a typical C/C++ package. 

at least the four bullet points are intended to work for a lot more, including python packages [1]. arguably, to compile cython stuff, some custom (make) rules are required, but we had that. and it could be changed (=moved into automake).

> They don't really implement all that

what exactly do you mean? please give an example.

thanks

[1] http://ftp.gnu.org/old-gnu/Manuals/automake-1.6.1/html_node/automake_59.html


---

Comment by jdemeyer created at 2016-09-12 21:06:43

OK, that looks interesting. I didn't know that `automake` could do that.


---

Comment by fbissey created at 2016-09-12 21:22:48

Yes it wexist but it is not always implemented in a nice way for package maintainer. In most case I have seen that used, you have a main package using autoconf and then they have some python bindings. Typically if if the python bits support multiple versions of python, as a package maintainer I would prefer it in a separate package. 

In a distro you will usually provide bindings for all of the versions of python you support when feasible. When it is integrated as part of a bigger package it is usually a pain to cycle through different versions of python. Once it is a separate package, autotools, cmake or setup.py, I don't really care any more, I'll easily cycle on both.

Admittedly software detection and so on is easier with something else than python...


---

Comment by leif created at 2016-09-12 22:13:58

Replying to [comment:30 fbissey]:
> Admittedly software detection and so on is easier with something else than python...

SConstruct! B)


---

Comment by fbissey created at 2016-09-12 22:18:35

<curled in a ball and rocking on his chair>I will not feed the trolls. I will not feed the trolls......


---

Comment by leif created at 2016-09-12 22:26:34

Jeroen *loves* SC...


---

Comment by jdemeyer created at 2016-09-13 09:56:16

Replying to [comment:30 fbissey]:
> Admittedly software detection and so on is easier with something else than python...

For the record: in https://github.com/sagemath/cysignals I am using `autoconf` for the configuration but I am still using `distutils` to build and install.


---

Comment by felixs created at 2016-09-13 10:28:33

Replying to [comment:34 jdemeyer]:
> For the record:

here's the autotoolized sage (dist [1] + lib [2]). this is where i gave up. i never touched the sage code since then... watch out for configure.ac and various m4 scripts. note that all subdirectories in src are standalone packages.

[1] https://github.com/felix-salfelder/sage/tree/autotools

[2] https://github.com/felix-salfelder/sage/tree/autotools/src


---

Comment by embray created at 2016-09-22 14:47:16

I have mixed feelings about the whole thing, but it's worth noting that it's getting closer and closer to the point where what's in `setup.py` won't matter as much as it does now.  distutils is still the "easiest" way to build Python modules, so somewhere in there there will still likely be a setup.py for a while.

But there's been _some_ progress on better supporting binary wheels on Linux (see for example https://www.python.org/dev/peps/pep-0513/, though that obviously doesn't cut it for Sage).  There's also progress being made on standardizing a "source distribution" format for Python packages that isn't necessarily tied to any one build system.  This means it will be fine, for example, to use autoconf to build Sage.  It's fine now, even, it just doesn't fit in as as well (yet) with the Python ecosystem.

I think regardless, it will also help to further break up sage so that Python wrappers for its various dependencies are external projects themselves.  I realize that's a much bigger problem though and not always practical.


---

Comment by embray created at 2016-09-22 15:09:26

Also, all that said, there are examples of Pythonic build configuration too.  One of the best is matplotlib's: https://github.com/matplotlib/matplotlib/blob/master/setupext.py

Matplotlib has quite a few external, non-Python dependencies--nowhere close to Sage, but more than most Python packages, and it handles this nicely.  Yes, it bothers me that it's "hand rolled", but most of that stuff in matplotlib can, and probably should, be factored out to an external package (with documentation!) that others can use.  And I would rather be writing Python than m4 scriptlets >_<

Numpy has a similar system (used also by Scipy), but matplotlib's is a bit cleaner (even it has a few things I would do a little differently, but the concept is sound).


---

Comment by mkoeppe created at 2020-09-15 18:42:53

Outdated, should be closed


---

Comment by mkoeppe created at 2020-09-15 18:42:53

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2021-09-18 09:50:19

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2021-09-18 10:03:59

Resolution: invalid
