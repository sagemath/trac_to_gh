# Issue 20106: Adding sage/misc/tikz_picture.py

Issue created by migration from https://trac.sagemath.org/ticket/20343

Original creator: slabbe

Original creation time: 2016-04-01 12:33:17

CC:  dkrenn jipilab slelievre chapoton

From my optional Sage package [1] slabbe-0.2.spkg.

[1] https://github.com/seblabbe/slabbe


---

Comment by slabbe created at 2016-04-01 13:32:02

Changing status from new to needs_review.


---

Comment by slabbe created at 2016-04-01 13:32:02

New commits:


---

Comment by dkrenn created at 2016-04-04 18:31:05

A comment:

```
t = TikzPicture(latex(transducers.GrayCode()))
t.pdf()
```

does not work as the preamble is not set correctly. However, there is

```
from sage.combinat.finite_state_machine import setup_latex_preamble
setup_latex_preamble()
```

(as well as the corresponding function in `sage.graphs.graph_latex`) to set this correctly, but it seems to be ignored by `TikzPicture`. 

In contrast, 

```
view(transducers.GrayCode())
```

works, but I have no idea if `setup_latex_preamble` is called (not needed to be done manually) or if tikz is included anyways.


---

Comment by slabbe created at 2016-04-04 19:36:54

Replying to [comment:5 dkrenn]:
> A comment:
> {{{
> t = TikzPicture(latex(transducers.GrayCode()))
> t.pdf()
> }}}
> does not work as the preamble is not set correctly.

As it is now, the user must set the libraries. This should work:

```
t = TikzPicture(latex(transducers.GrayCode()), tikzlibraries=['automata'])
t.pdf()
```


I am still not sure about the proper way to choose the arguments for the `__init__` function and their especially their default values. Should the arguments be empty by default? equal to the current sage latex preamble? or full of a big load of libraries?


---

Comment by dkrenn created at 2016-04-05 08:34:12

Replying to [comment:6 slabbe]:
> Replying to [comment:5 dkrenn]:
> > A comment:
> > {{{
> > t = TikzPicture(latex(transducers.GrayCode()))
> > t.pdf()
> > }}}
> > does not work as the preamble is not set correctly.
> 
> As it is now, the user must set the libraries. This should work:
> {{{
> t = TikzPicture(latex(transducers.GrayCode()), tikzlibraries=['automata'])
> t.pdf()
> }}}

Works, thanks.

> I am still not sure about the proper way to choose the arguments for the `__init__` function and their especially their default values. Should the arguments be empty by default? equal to the current sage latex preamble? or full of a big load of libraries?

Without much thinking, I vote for: The second, equal to the current sage latex preamble.


---

Comment by git created at 2016-04-07 22:58:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2016-12-09 09:32:55

My module has evolved in my package slabbe, therefore the branch here is not up to date anymore. Also, I intend to make it more general during the next year allowing any content not only tikzpicture code. Therefore, I deleted the branch posted here.


---

Comment by slabbe created at 2016-12-09 20:35:14

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2016-12-09 20:35:14

Changing status to needs work.


---

Comment by jipilab created at 2017-03-10 11:36:41

As a follow-up ticket to make use of this is #22506.


---

Comment by caruso created at 2021-03-31 13:15:04

I'll be happy to revive this ticket.
----
New commits:


---

Comment by git created at 2021-03-31 13:38:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-31 16:14:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2021-03-31 16:25:46

I'm not convinced by all the methods `from_dot_string`, `from_graph`, etc. in the class `TikzPicture`. I would say that this code should instead be in the classes implementing the object we want to display. E.g. it could be a method `_tikz_`, just as `_latex_`, and `TikzPicture` just calls it.

What's your opinion?


---

Comment by slabbe created at 2021-04-01 10:35:20

There is no class for `dot strings`. Graphs already have a `_latex_` method which returns a tikz picture string. It is what is used with for instance `view(G)`. The `from_graph` class method really is using `dot2tex` + `graphviz` which is not the same layout sometimes. It is true that maybe adding a `_tikz_` would avoid to replace the current behavior of `_latex_`. But then, having two different behaviors will be non pedagogical (how to know there is another one). Also, changing the default behavior will lead to problems...

I think it will be easier to add the new module as is and later on, in other tickets, add such `_tikz_` methods in other parts of sage where it makes sense.


---

Comment by caruso created at 2021-04-01 17:17:45

Changing status from needs_work to needs_review.


---

Comment by caruso created at 2021-04-01 17:17:45

OK. Let's keep it for another ticket.


---

Comment by caruso created at 2021-04-01 17:17:52

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-04-01 19:03:48

please no "from future import ..."

Returns should be Return


---

Comment by caruso created at 2021-04-01 20:49:27

Changing status from positive_review to needs_work.


---

Comment by caruso created at 2021-04-01 20:49:27

Also if pdflatex is not installed on the machine, some doctests fail.
I don't know if this should be fixed but I think so because otherwise patchbots complain.


---

Comment by slabbe created at 2021-04-08 08:30:19

New commits:


---

Comment by git created at 2021-04-08 08:32:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-08 08:40:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-04-08 08:42:55

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2021-04-08 08:42:55

I added a bunch of `#optional latex` and `#optional imagemagick` tags. That should fix most of the issues.

I also added one `# optional pdf2svg` for which I am not sure about. I don't know if the doctest framework know about this tag. I change to needs review to check that on the patchbot.


---

Comment by vdelecroix created at 2021-04-08 10:11:35

Why do you make it part of Sage and not an independent Python module? These could easily be declared as optional/standard packages afterwards.


---

Comment by slabbe created at 2021-04-08 15:26:53

Yes, I agree with that option too. Lately, I was thinking more about this option.

But, the module also depends on many things that are in Sage which would make this module quite unusable outside of sage as it is currently. For example:

To check if Graphviz is there:

```
from sage.features.graphviz import Graphviz
```


To check if pdflatex, convert and other programs are available:

```
from sage.misc.latex import have_pdflatex, have_convert, have_program
```


To load the latex macros from sage:

```
from sage.misc.latex import _Latex_prefs
from sage.misc.latex_macros import sage_latex_macros
```


To create a temporary file inside the sage folder of temporary files:

```
from sage.misc.temporary_file import tmp_filename
```


To open viewers:

```
from sage.misc.viewer import browser
from sage.misc.viewer import pdf_viewer
from sage.misc.viewer import png_viewer
```


To check whether we are in the JupyterNotebook or not:

```
from sage.repl.rich_output.backend_ipython import BackendIPythonNotebook
from sage.repl.rich_output.buffer import OutputBuffer
```



---

Comment by git created at 2021-04-08 15:35:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-06-10 17:24:26

Replying to [comment:29 slabbe]:
> Yes, I agree with that option too. Lately, I was thinking more about this option.

The main advantage with that option is that the package can change versions independently of sage.

> But, the module also depends on many things that are in Sage which would make this module quite unusable outside of sage as it is currently. For example:

This would be a Python module that depends on sage. There is nothing bad with that situation. And this is not the only one.


---

Comment by slabbe created at 2021-06-24 08:51:37

I am thinking about what to do now, either work on this ticket or create a new package. If I create a sagemath-tikzpicture package that imports many parts of sagemath, I will be responsible for fixing the package each time sagemath changes something that I import. On the other hand, if that modules goes into sagemath, then, it will become the responsability of the person which changes the dependencies to also fix the tikzpicture module. I agree with the idea of modularization, but for the above reason, I would prefer to make it go into sage. What do you think?


---

Comment by caruso created at 2021-07-02 15:24:19

I prefer to have this directly in sage since I think that there are many other places in sage where it would be great to have a tikz output.


---

Comment by mkoeppe created at 2021-07-02 15:51:09

Because this module does not depend on any external libraries, there is nothing gained in the direction of modularization by making this a separate distribution package. 

But perhaps you can find a better place for it than sage.misc? How about `sage.typeset` or `sage.plot`?


---

Comment by git created at 2021-07-15 10:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-07-15 10:38:32

I think we are close to it. The doctests work on my machine:


```
sage -t --optional=sage,optional,external --long --show-skipped tikzpicture.py 
```


gives


```
Using --optional=4ti2,ccache,cryptominisat,debian,dot2tex,e_antic,external,fricas,glucose,latte_int,lidia,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,sage,sage_numerical_backends_coin,sage_spkg
External software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,rubiks,scilab
Doctesting 1 file.
sage -t --long --random-seed=0 tikzpicture.py
    19 not tested tests not run
    1 pdf2svg test not run
    0 tests not run because we ran out of time
    [161 tests, 15.43 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 15.6 seconds
    cpu time: 8.2 seconds
    cumulative wall time: 15.4 seconds
External software detected for doctesting: imagemagick,latex
```


TODO:

- Let's see what the patchbot says.
- The doctest tagged with `pdf2svg` is not recognized by the `--optional=external`. Maybe something needs to be done on the detection of external packages.
- One issue is that the current `_rich_repr_` always uses png instead of svg in the Jupyter Notebook even if I define `'svg'` before `'png'` in the `prefer_vector` tuple. I think that issue can be dealt in a later ticket.

That's it! Needs review!


---

Comment by mkoeppe created at 2021-07-15 16:39:46

This ad-hoc system package advice 

```
+        if not have_program('pdf2svg'):
+            raise RuntimeError("pdf2svg does not seem to be installed. "
+                    "Install it for example with ``brew install pdf2svg``"
+                    " or ``apt-get install pdf2svg``.")
+
```

should be replaced by a `Feature` and an spkg `pdf2svg` with `distros/` information from
https://repology.org/project/pdf2svg/versions


---

Comment by slabbe created at 2021-07-15 20:42:46

Ok, I will add a Feature for pdf2svg.

Also, patchbot says this:

```
src/sage/plot/tikzpicture.py:98:1 'subprocess.CalledProcessError' imported but unused
found 1 pyflakes errors in the modified files
```


Another TODO is to allow to get some verbosity useful when compilation of the picture breaks. I am writting it here not to forget.

I will work on that soon or later.


---

Comment by mkoeppe created at 2021-07-26 18:08:29

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-04 10:56:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by slabbe created at 2021-11-04 11:02:57

I rebased on top of current #32650.

Current TODOS are:

 - verbosity when compilation breaks
 - add distro info stuff in pdf2svg (should be done in #32650)
 - improve rich repr to use svg not always png


---

Comment by git created at 2021-11-04 14:23:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-04 22:15:43

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2021-11-04 22:15:43

With the recent commit and subsequent work done in #32650, the remainings TODOs are:

 - improve rich repr to use svg not always png 

and as I suggested before, this one could be dealt in another ticket as it is still functional with png's in the Jupyter notebook.

Needs review!


---

Comment by mkoeppe created at 2021-11-25 18:19:58

In a similar direction as comment:17, I think that the `from_graph...` and `from_poset` class methods should rather be changed to methods of `Graph` and `Poset`.


---

Comment by mkoeppe created at 2021-11-25 18:20:39

Also https://pypi.org/project/tikzplotlib/ looks interesting


---

Comment by git created at 2021-12-09 10:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-12-09 10:07:22

I added two commits to do few improvements.


---

Comment by slabbe created at 2021-12-09 10:27:17

Replying to [comment:54 mkoeppe]:
> In a similar direction as comment:17, I think that the `from_graph...` and `from_poset` class methods should rather be changed to methods of `Graph` and `Poset`.

If you want to go in that direction, we need to have a design discussion before spending time changing the graph code. As you know,


```
sage: g = graphs.PetersenGraph()
sage: hasattr(g, '_latex_')
True
```


which returns an object of type:


```
sage: type(latex(g))
<class 'sage.misc.latex.LatexExpr'>
```


This latex expression starts with `\begin{tikzpicture}` and ends with `\end{tikzpicture}` which also depends on `\usepackage{tkz-graph}`:


```
sage: latex(g)
\begin{tikzpicture}                                                                                    
\definecolor{cv0}{rgb}{0.0,0.0,0.0}                                                                    
\definecolor{cfv0}{rgb}{1.0,1.0,1.0}                                                                   
...
\Edge[lw=0.1cm,style={color=cv6v9,},](v6)(v9)
\Edge[lw=0.1cm,style={color=cv7v9,},](v7)(v9)
%
\end{tikzpicture}
```


Notice that this output can be provided to `TikzPicture` with no problem with `t = TikzPicture(latex(g), usepackage=['tkz-graph'])` and `t.pdf()` works etc.

I don't think here we want to replace the output of `g._latex_` by an object of type `TikzPicture` since a such change would break a lot of code.

An option is to create a new method `def tikz(self)` instead. I can do something like that. It could return the `TikzPicture(latex(g), usepackage=['tkz-graph'])` by default and if one asks, it could use the graphviz + dot2tex output instead. But, I was thinking of doing this in another ticket as a follow up, as this will open discussions that will just make longer before this ticket can go in.

Or maybe you would rather like to remove the `from_graph` and the `from_poset` methods to avoid to have to maintain them in the future? Well, currently, the `from_graph` also allows to merge the multiple edges which is something that would not go in the `tikz` method of a graph. Also, keeping the `from_graph` would make the passage from this module to sage easier for me because I have been using this method over and over and over in my research code.


---

Comment by slabbe created at 2021-12-09 10:36:08

I created ticket #33002 for the addition of a method to return an object of type `TikzPicture` in graph, posets and polyhedron code.


---

Comment by git created at 2021-12-09 10:57:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-12-09 11:37:40

Replying to [comment:50 slabbe]:
> With the recent commit and subsequent work done in #32650, the remainings TODOs are:
> 
>  - improve rich repr to use svg not always png 
> 
> and as I suggested before, this one could be dealt in another ticket as it is still functional with png's in the Jupyter notebook.

Also, I want to say that I believe that the `sage.repl` code is broken with respect to showing svg files.


```
# Jupyter cell 1
g = graphs.PetersenGraph()
from sage.plot.tikzpicture import TikzPicture
t = TikzPicture(latex(g), usepackage=['tkz-graph'])
t # works: it shows a png
```



```
# Jupyter cell 2
from sage.repl.rich_output import get_display_manager
dm = get_display_manager()
assert dm.preferences.graphics is None
dm.preferences.graphics = 'raster'
t  # works: it shows a png
```




```
# Jupyter cell 3
dm.preferences.graphics = 'vector'
t   # broken: it does not show anything
```


The following shows that the Jupyter notebook is able to handle a svg correctly:


```
# Jupyter cell 4
t.svg('a.svg')
from IPython.core.display import SVG
SVG(filename='a.svg')
```


I suggest to fix the issue with the showing of svg in another ticket.


---

Comment by git created at 2021-12-09 17:21:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-09 18:44:48

Replying to [comment:58 slabbe]:
> Replying to [comment:54 mkoeppe]:
> > In a similar direction as comment:17, I think that the `from_graph...` and `from_poset` class methods should rather be changed to methods of `Graph` and `Poset`.

> I don't think here we want to replace the output of `g._latex_` by an object of type `TikzPicture` since a such change would break a lot of code.

I agree

> An option is to create a new method `def tikz(self)` instead. I can do something like that.

Yes, this is what I meant


---

Comment by git created at 2022-01-04 13:20:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by slabbe created at 2022-01-04 13:21:11

There was a syntax error in the file due to the previous commit. I fixed that.

I also rebased the branch on top of 9.5.beta9.


---

Comment by git created at 2022-01-04 13:35:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-01-04 13:37:16

I confirm it works on my side:


```
$ sage -t tikzpicture.py 
[...]
Doctesting 1 file.
sage -t --random-seed=33963620693510224516081799230454604818 tikzpicture.py
    [158 tests, 4.59 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Features detected for doctesting: 
```

and

```
$ sage -t --show-skipped --long --optional=sage,optional,external tikzpicture.py 
[...]
Doctesting 1 file.
sage -t --long --random-seed=204572532264437349038334999704478431314 tikzpicture.py
    24 not tested tests not run
    2 pdftocairo tests not run
    0 tests not run because we ran out of time
    [188 tests, 15.97 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Features detected for doctesting: imagemagick,latex,pdf2svg
```



---

Attachment


---

Comment by slabbe created at 2022-01-04 14:06:58

Updating the description: adding a screenshot of the behavior in Jupyter, hoping it motivates someone to review the ticket.


---

Comment by vdelecroix created at 2022-01-05 16:52:58

Why this default `usepackage=['amsmath']`?


---

Comment by vdelecroix created at 2022-01-05 16:55:24

Moreover, you should **never** have a list as a default argument which is plugged as an attribute

```
sage: class A():
....:     def __init__(self, a=[]):
....:         self.a = a
sage: x = A()
sage: x.a.append(2)
sage: y = A()
sage: y.a
[2]
```



---

Comment by git created at 2022-01-05 18:04:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-01-05 18:06:20

You are right. I also avoided the usage of `shell=True` for security reasons, see https://docs.python.org/3/library/subprocess.html#security-considerations

Doing so, the `cmd` needs to be a list and not a string. This is better also because it allows filenames to contain spaces: _"Providing a sequence of arguments is generally preferred, as it allows the module to take care of any required escaping and quoting of arguments (e.g. to permit spaces in file names)"_, see https://docs.python.org/3/library/subprocess.html#frequently-used-arguments


---

Comment by vdelecroix created at 2022-01-05 18:15:05

Replying to [comment:77 slabbe]:
> [...]
> This is better also because it allows filenames to contain spaces
> [...]

If `'m y p i c t u r e.pdf'` is an explicitely supported filename, it would make sense to mention it and test it. If it is an obscure feature, nevermind.


---

Comment by git created at 2022-01-05 20:04:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-01-05 20:05:33

Replying to [comment:78 vdelecroix]:
> If `'m y p i c t u r e.pdf'` is an explicitely supported filename, it would make sense to mention it and test it. If it is an obscure feature, nevermind.

Yes, why not. I added a doctest confirming it works.

I also added a missing long doctest tag.

Needs review!


---

Comment by slabbe created at 2022-01-06 11:16:08

There is a time window right now for this ticket to get into sage-9.5 maybe within the first rc.

The patchbots are green. I will be available in the next days to fix quickly any remaining issues.


---

Comment by vdelecroix created at 2022-01-06 18:00:51

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2022-01-06 18:07:18

Thank you!! I was holding by breathe since 6 years!

I will add a nice section in the release notes if it makes it in 9.5.


---

Comment by vbraun created at 2022-02-13 00:28:04


```
**********************************************************************
File "src/sage/plot/tikzpicture.py", line 73, in sage.plot.tikzpicture
Failed example:
    _ = t.png(view=False)      # long time (2s) # optional imagemagick
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.tikzpicture[14]>", line 1, in <module>
        _ = t.png(view=False)      # long time (2s) # optional imagemagick
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 505, in png
        _filename_pdf = self.pdf(filename=None, view=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 443, in pdf
        result.check_returncode()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/subprocess.py", line 460, in check_returncode
        raise CalledProcessError(self.returncode, self.args, self.stdout,
    subprocess.CalledProcessError: Command '['lualatex', '-interaction=nonstopmode', 'tikz_544oxd7o.tex']' returned non-zero exit status 1.
**********************************************************************
File "src/sage/plot/tikzpicture.py", line 494, in sage.plot.tikzpicture.StandaloneTex.png
Failed example:
    path_to_file = t.png(filename) # long time (2s)   # optional imagemagick
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.tikzpicture.StandaloneTex.png[7]>", line 1, in <module>
        path_to_file = t.png(filename) # long time (2s)   # optional imagemagick
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 505, in png
        _filename_pdf = self.pdf(filename=None, view=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 443, in pdf
        result.check_returncode()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/subprocess.py", line 460, in check_returncode
        raise CalledProcessError(self.returncode, self.args, self.stdout,
    subprocess.CalledProcessError: Command '['lualatex', '-interaction=nonstopmode', 'tikz_ikxvujw2.tex']' returned non-zero exit status 1.
**********************************************************************
File "src/sage/plot/tikzpicture.py", line 495, in sage.plot.tikzpicture.StandaloneTex.png
Failed example:
    path_to_file[-4:]              # long time (fast) # optional imagemagick
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.tikzpicture.StandaloneTex.png[8]>", line 1, in <module>
        path_to_file[-Integer(4):]              # long time (fast) # optional imagemagick
    NameError: name 'path_to_file' is not defined
**********************************************************************
File "src/sage/plot/tikzpicture.py", line 579, in sage.plot.tikzpicture.StandaloneTex.svg
Failed example:
    path_to_file = t.svg(filename, program='pdftocairo') # long time (2s)   # optional pdftocairo
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.tikzpicture.StandaloneTex.svg[7]>", line 1, in <module>
        path_to_file = t.svg(filename, program='pdftocairo') # long time (2s)   # optional pdftocairo
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 588, in svg
        _filename_pdf = self.pdf(filename=None, view=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/tikzpicture.py", line 443, in pdf
        result.check_returncode()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/subprocess.py", line 460, in check_returncode
        raise CalledProcessError(self.returncode, self.args, self.stdout,
    subprocess.CalledProcessError: Command '['lualatex', '-interaction=nonstopmode', 'tikz_o2ho82xz.tex']' returned non-zero exit status 1.
**********************************************************************
File "src/sage/plot/tikzpicture.py", line 580, in sage.plot.tikzpicture.StandaloneTex.svg
Failed example:
    path_to_file[-4:]                                    # long time (fast) # optional pdftocairo
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.tikzpicture.StandaloneTex.svg[8]>", line 1, in <module>
        path_to_file[-Integer(4):]                                    # long time (fast) # optional pdftocairo
    NameError: name 'path_to_file' is not defined
**********************************************************************
```



---

Comment by vbraun created at 2022-02-13 00:28:04

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2022-02-13 17:48:30

Indeed, the failures show that when latex is not installed, there are missing optional `latex` tags. Sorry Volker.


---

Comment by git created at 2022-02-17 09:14:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by slabbe created at 2022-02-17 09:24:11

Added the missing latex tag. Also rebased on 9.6.beta1.


---

Comment by slabbe created at 2022-02-17 09:43:37

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2022-02-19 09:16:30

Why not using `else` here

```
+        if program == 'pdflatex':
+            pdflatex().require()
+        elif program == 'lualatex':
+            lualatex().require()
+        elif program not in ['pdflatex','lualatex']:
+            raise ValueError("program(={}) should be pdflatex or lualatex".format(program))
```



---

Comment by vdelecroix created at 2022-02-19 09:17:03

Why do you prefix `filename_png`, `filename_pdf`, etc with an additional underscore, ie `_filename_png`, `_filename_pdf`?


---

Comment by git created at 2022-02-22 08:45:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-02-22 08:47:43

Replying to [comment:90 vdelecroix]:
> Why not using `else` here

You are right. I don't know why I did not use else. I added a commit to fix that.


---

Comment by slabbe created at 2022-02-22 08:50:45

Replying to [comment:91 vdelecroix]:
> Why do you prefix `filename_png`, `filename_pdf`, etc with an additional underscore, ie `_filename_png`, `_filename_pdf`?

The reason is to distinguish the variable `filename` (input given from the user) from the variable `_filename` (name of a temporary file created by the method). See the code of the method `svg` where both `filename` and `_filename` are used. For consistency, the same principle is used in all methods.

Needs review!


---

Comment by vdelecroix created at 2022-02-22 09:26:17

Replying to [comment:94 slabbe]:
> Replying to [comment:91 vdelecroix]:
> > Why do you prefix `filename_png`, `filename_pdf`, etc with an additional underscore, ie `_filename_png`, `_filename_pdf`?
> 
> The reason is to distinguish the variable `filename` (input given from the user) from the variable `_filename` (name of a temporary file created by the method). See the code of the method `svg` where both `filename` and `_filename` are used. For consistency, the same principle is used in all methods.
> 
> Needs review!

Instead of the very unconventional `_filename` variable name you would better use `temporary_filename`, `temporary_filename_tex`, `temporary_filename_pdf`, etc.


---

Comment by git created at 2022-02-22 14:15:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-02-22 14:17:27

Replying to [comment:95 vdelecroix]:
> Instead of the very unconventional `_filename` variable name you would better use `temporary_filename`, `temporary_filename_tex`, `temporary_filename_pdf`, etc.

Ok, I renamed it as `s/_filename/temp_filename/g`.

Needs review!


---

Comment by vdelecroix created at 2022-02-22 14:22:22

Instead of `from_graph`, `from_poset`, ... wouldn't it make more sense to have `Graph.tikz()`, `Poset.tikz()`, etc? In the former design the `TikzPicture` code would end up with a ton of methods dealing with various specific objects.


---

Comment by vdelecroix created at 2022-02-22 14:22:45

Or alternatively: `__tikz__()` if you want to hide it.


---

Comment by caruso created at 2022-02-22 14:24:36

See comment:17 :-)


---

Comment by vdelecroix created at 2022-02-22 14:30:25

I agree with Xavier ! The current branch proposes to make `TikzPicture.from_XXX` the default conversion function. If the design is wrong, better to change it now than in a hypothetical future.


---

Comment by slabbe created at 2022-02-22 14:48:34

Replying to [comment:101 vdelecroix]:
> I agree with Xavier ! The current branch proposes to make `TikzPicture.from_XXX` the default conversion function. If the design is wrong, better to change it now than in a hypothetical future.

See also comment:54 from mkoeppe who suggested the same thing.

Then, please read follow-up comment:58, and answer to my answer in comment:58.


---

Comment by vdelecroix created at 2022-02-22 14:54:47

Ideally, `TikzPicture` should inherit from `LatexExpr` so that returning a `TikzPicture` from a `_latex_` method would not be a breaking change.

For the purpose of merging this ticket quickly, the simplest way out is to move the `from_XXX` as private standalone functions `def _from_XXX` and stating explicitely that these are just demo functions that will be removed in the future.


---

Comment by slabbe created at 2022-02-22 15:14:27

Replying to [comment:103 vdelecroix]:
> Ideally, `TikzPicture` should inherit from `LatexExpr` so that returning a `TikzPicture` from a `_latex_` method would not be a breaking change.

Well, `LatexExpr` already inherits from the Python class `str` which makes it full of methods that, as a user, I don't want to see in the list of methods seen with tab-completion on an object of type `TikzPicture`.

> For the purpose of merging this ticket quickly, the simplest way out is to move the `from_XXX` as private standalone functions `def _from_XXX` and stating explicitely that these are just demo functions that will be removed in the future.

Ok, let me think about that again, maybe this Thursday at Bordeaux Sage Thursdays, we can discuss this and converge to choices on how this is done for graphs (`tkz-berge` vs graphviz + dot2tex) and for polytopes (the actual `tikz()` method vs a new `tikz()` or `__tikz__()` method).


---

Comment by slabbe created at 2022-02-22 16:34:02

Replying to [comment:103 vdelecroix]:
> For the purpose of merging this ticket quickly, the simplest way out is to move the `from_XXX` as private standalone functions `def _from_XXX` and stating explicitely that these are just demo functions that will be removed in the future.

There are four such methods right now:

```
    def from_dot_string(cls, dotdata, prog='dot'):
    def from_graph(cls, graph, merge_multiedges=True,
    def from_graph_with_pos(cls, graph, scale=1, merge_multiedges=True,
    def from_poset(cls, poset, **kwds):
```


As you suggest, I can change those taking a graph or a poset sage object into a private method:

```
    def from_dot_string(cls, dotdata, prog='dot'):
    def _from_graph(cls, graph, merge_multiedges=True,
    def _from_graph_with_pos(cls, graph, scale=1, merge_multiedges=True,
    def _from_poset(cls, poset, **kwds):
```


But, there is no sage object for a dot string. So, do I keep `from_dot_string` as it is or do you want me to make it private as well?


---

Comment by vdelecroix created at 2022-02-22 16:40:13

Replying to [comment:105 slabbe]:
> Replying to [comment:103 vdelecroix]:
> > For the purpose of merging this ticket quickly, the simplest way out is to move the `from_XXX` as private standalone functions `def _from_XXX` and stating explicitely that these are just demo functions that will be removed in the future.
> 
> There are four such methods right now:
> {{{
>     def from_dot_string(cls, dotdata, prog='dot'):
>     def from_graph(cls, graph, merge_multiedges=True,
>     def from_graph_with_pos(cls, graph, scale=1, merge_multiedges=True,
>     def from_poset(cls, poset, **kwds):
> }}}
> 
> As you suggest, I can change those taking a graph or a poset sage object into a private method:
> {{{
>     def from_dot_string(cls, dotdata, prog='dot'):
>     def _from_graph(cls, graph, merge_multiedges=True,
>     def _from_graph_with_pos(cls, graph, scale=1, merge_multiedges=True,
>     def _from_poset(cls, poset, **kwds):
> }}}
> 
> But, there is no sage object for a dot string. So, do I keep `from_dot_string` as it is or do you want me to make it private as well?

It should be fine to keep `from_dot_string`.

The only reason to make the three others private is to avoid that sage users rely on them. They will be changed without notice.


---

Comment by git created at 2022-02-23 20:31:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-02-23 20:32:40

Replying to [comment:106 vdelecroix]:
> It should be fine to keep `from_dot_string`.
> 
> The only reason to make the three others private is to avoid that sage users rely on them. They will be changed without notice.

Ok, I did that. Needs review.


---

Comment by vdelecroix created at 2022-02-24 06:18:31

It would be better not to advertize them in the module docstring

```diff
- If dot2tex Sage optional package and graphviz are installed, then the following
- one liner works allowing to create a nice tikzpicture from a graph with
- vertices and edges placed according to graphviz::
-
-    sage: t = TikzPicture._from_graph(g)  # optional: dot2tex # long time (3s)
-
```


And you can add a sentence explaining the transducer example that comes after.


---

Comment by vdelecroix created at 2022-02-24 06:22:07

I would also add a sentence somewhere in the module docstring about the fact that tikz is a latex package (called `pgf-tikz` by the way) and a reference to the page https://www.ctan.org/pkg/pgf. You sort of assume that everybody knows tikz which is not a reasonable assumption.


---

Comment by git created at 2022-02-24 10:07:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by slabbe created at 2022-02-24 10:08:38

I rebased the branch on 9.6.beta2. No new commit for now.


---

Comment by git created at 2022-02-24 10:15:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2022-02-24 10:24:30

The following reference will not work `:mod:`sage.misc.latex.py`` (you need to remove the `.py`).


---

Comment by git created at 2022-02-24 10:30:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-24 10:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-02-24 10:31:45

Needs review!


---

Comment by vdelecroix created at 2022-02-24 14:42:42

pycodestyle is broken as it does not detect the prefix `r` in front of the string...

```
src/sage/plot/tikzpicture.py:258:34: W605 invalid escape sequence '\d'
src/sage/plot/tikzpicture.py:259:34: W605 invalid escape sequence '\e'
```



---

Comment by vdelecroix created at 2022-02-24 14:44:58

Your module does not seem to be included in the reference manual. You have to add an entry to `src/doc/en/reference/misc/index.rst`.


---

Comment by vdelecroix created at 2022-02-24 14:44:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-24 17:49:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-02-24 17:49:42

Needs review!


---

Comment by slabbe created at 2022-02-24 17:49:42

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2022-02-24 20:49:00

I did not notice before but why did you put your module in `sage/plot` rather than `sage/misc` (where all the current latex code is)?


---

Comment by slabbe created at 2022-02-24 21:13:57

Replying to [comment:122 vdelecroix]:
> I did not notice before but why did you put your module in `sage/plot` rather than `sage/misc` (where all the current latex code is)?

This was suggested in comment:34 by mkoeppe, to which I agree. The goal of the module is about drawing stuff, so it is natural to put it in `sage/plot`.

It is not true that all latex code is in misc. You also have `graph_latex.py` file in `sage/graphs`.

Also, to my opinion, `sage/misc/latex.py` is not soooo well-written (I repeat, this is an opinion). It is a module on which it is tough to build on top / reuse. You may want to look at the code which implements `view` to get an example. Who really wants to use this? I think the future will be more active if the features present in that module are re-thought and re-written else where and eventually it gets just replaced. The deprecation of the `have_latex` and friends methods done in #32650 is one of the many steps towards that. The creation of a module to deal with tikzpicture is another step towards that.


---

Comment by mkoeppe created at 2022-02-24 21:44:48

Replying to [comment:123 slabbe]:
> This was suggested in comment:34 by mkoeppe, to which I agree.

Not sure if I still agree with myself ;)


---

Comment by vdelecroix created at 2022-02-25 09:09:42

It might be true that `sage.misc.latex` is a mess. But given that
1. `tikzpicture.py` shares some functionalities with `sage.misc.latex` (including code duplication)
2. `sage.misc.latex` is widely used
3. you claim that `StandaloneTex`/`TikzPicture` is part of the future of `sage.misc.latex`
I would like to
1. have an idea of what is the future of `sage.misc.latex` (you said that a _step forward_ but there is no destination)
2. have the tools that will replace `sage.misc.latex` close to it in the sage source code or at the very least a mention of them in its documentation

What I want to avoid is that this ticket only adds a module `n+1` to sagemath which does a small variation of module `1`, module `2` and module `n` independently of all of them.


---

Comment by slabbe created at 2022-02-25 17:04:52

Ok, let me do more changes (next week).


---

Comment by slabbe created at 2022-02-25 17:04:52

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-04 17:10:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-04 18:21:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-10 11:12:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-03-10 11:13:37

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2022-03-10 11:13:37

Gave more importance to the `Standalone` class. Updated and improved the documentation.

Needs review!


---

Comment by slabbe created at 2022-03-17 16:48:00

New commits:


---

Comment by slabbe created at 2022-03-17 16:48:35

Needs review!


---

Comment by mkoeppe created at 2022-03-17 17:13:51


```
+Loading few latex packages::
```

-> "a" few


---

Comment by mkoeppe created at 2022-03-17 17:19:20


```
+#*****************************************************************************
+#       Copyright (C) 2015-2022 Sébastien Labbé <slabqc@gmail.com>
+#
+#  Distributed under the terms of the GNU General Public License version 2 (GPLv2)
+#
+#  The full text of the GPLv2 is available at:
+#
+#                  http://www.gnu.org/licenses/
```

This is not our standard license header; are you sure you want to mark it as "v2 only"?
Other files say "Distributed under the terms of the GNU General Public License (GPL); either version 2 of the License, or (at your option) any later version."


---

Comment by mkoeppe created at 2022-03-17 17:20:07


```
+Adding a border in the options avoids croping the vertices of a graph::
```

-> cropping


---

Comment by mkoeppe created at 2022-03-17 17:25:00


```
+        sage: t = TikzPicture(s, standalone_config=["border=4mm"], usepackage=['tkz-graph']) # optional latex
+        sage: _ = t.pdf(view=False)             # long time (2s) # optional latex
```

This should also be marked `# optional - latex_package_tkz_graph`
(occurs several times)


---

Comment by mkoeppe created at 2022-03-17 17:36:58


```
+            sage: dotdata = G.graphviz_string()
+            sage: tikz = TikzPicture.from_dot_string(dotdata) # optional dot2tex # long time (3s)
```

this should probably also be marked as `# optional - graphviz`


---

Comment by mkoeppe created at 2022-03-17 17:39:43

Also, could you please mark the doctests using graphs as `# optional - sage.graphs` and the doctests using posets as `# optional - sage.combinat`?


---

Comment by mkoeppe created at 2022-03-17 17:43:08

Overall looking great!


---

Comment by slabbe created at 2022-03-19 09:29:27

Thanks for your review! I will improve the code accordingly.


---

Comment by git created at 2022-03-19 09:37:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-03-19 09:38:37

It remains to fix the doctests tags. I will do this later.


---

Comment by slabbe created at 2022-03-21 13:28:29

Replying to [comment:137 mkoeppe]:
> {{{
> +        sage: t = TikzPicture(s, standalone_config=["border=4mm"], usepackage=['tkz-graph']) # optional latex
> +        sage: _ = t.pdf(view=False)             # long time (2s) # optional latex
> }}}
> This should also be marked `# optional - latex_package_tkz_graph`
> (occurs several times)

Only the line `t.pdf()` really needs the `latex_package_tkz_graph` optional tag. So I added this tag where necessary. Creating a Python string containing `'\usetikzlibrary{tkz-graph}'` by itself does not depend on the latex package. So, I did not added the optional tag everywhere.


---

Comment by slabbe created at 2022-03-21 13:30:02

Replying to [comment:138 mkoeppe]:
> {{{
> +            sage: dotdata = G.graphviz_string()
> +            sage: tikz = TikzPicture.from_dot_string(dotdata) # optional dot2tex # long time (3s)
> }}}
> this should probably also be marked as `# optional - graphviz`

At some point in time, it was changed that the installation of `dot2tex` fails if `graphviz` is not installed. But, whatever, maybe it is better to add `graphviz` optional tag as well, which I did (commits to be pushed soonafter).


---

Comment by slabbe created at 2022-03-21 13:31:01

Replying to [comment:139 mkoeppe]:
> Also, could you please mark the doctests using graphs as `# optional - sage.graphs` and the doctests using posets as `# optional - sage.combinat`?

Ok, done.


---

Comment by git created at 2022-03-21 13:31:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-03-21 13:32:31

Replying to [comment:139 mkoeppe]:
> Also, could you please mark the doctests using graphs as `# optional - sage.graphs` and the doctests using posets as `# optional - sage.combinat`?

Also I could make the doctests less dependent on graphs stuff.


---

Comment by git created at 2022-03-21 14:48:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-03-21 14:53:22

Needs review!


---

Comment by mkoeppe created at 2022-03-21 17:50:44

Looking great.

These lines and what depends on them should be marked `# optional - sage.symbolic` (for #32432, #32601)

```
+            sage: f(x) = -1 / x
+            sage: g(x) = 1 / (x + 1)
```


Other than that, from my side it's positive review.


---

Comment by slelievre created at 2022-03-21 22:40:18

Replying to [comment:151 mkoeppe]:
> These lines and what depends on them should be marked `# optional - sage.symbolic` (for #32432, #32601)
> {{{
> +            sage: f(x) = -1 / x
> +            sage: g(x) = 1 / (x + 1)
> }}}
> 
> Other than that, from my side it's positive review.

Alternatively, use lambda functions instead of symbolic ones:

```diff
-            sage: f(x) = -1 / x
-            sage: g(x) = 1 / (x + 1)
+            sage: f = lambda x: -1 / x
+            sage: g = lambda x: 1 / (x + 1)
```



---

Comment by mkoeppe created at 2022-03-21 22:42:19

No, they wouldn't show up well in the plots.


---

Comment by caruso created at 2022-03-22 15:29:38

Great! I think it is time to give a positive review to this ticket!


---

Comment by caruso created at 2022-03-22 15:29:38

Changing status from needs_review to positive_review.


---

Comment by git created at 2022-03-22 19:31:08

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-03-22 19:31:08

Changing status from positive_review to needs_review.


---

Comment by slabbe created at 2022-03-22 19:33:51

Replying to [comment:154 caruso]:
> Great! I think it is time to give a positive review to this ticket!

I added the doctests tags `sage.symbolic` to answer the latest comment. Needs review again. Sorry.

I also updated the title of the ticket.


---

Comment by slabbe created at 2022-03-23 12:47:18

Patchbot is green. We can change the status to positive review.

But, maybe before, we could check if all tests pass on a machine with no latex installed, because Volker is using such a computer to test tickets, see comment:85. Do someone has a machine with no latex? Or is there an easy way to mimic its absence?


---

Comment by slelievre created at 2022-03-23 16:27:12

There must be a way to use tox for that...


---

Comment by slabbe created at 2022-03-24 10:14:04

I found a computer with no latex and no imagemagick:


```
$ pdflatex -v

La commande « pdflatex » n'a pas été trouvée, mais peut être installée avec :

sudo apt install texlive-latex-base
```



```
$ lualatex -v

La commande « lualatex » n'a pas été trouvée, mais peut être installée avec :

sudo apt install texlive-latex-base
```



```
$ convert -v

La commande « convert » n'a pas été trouvée, mais peut être installée avec :

sudo apt install graphicsmagick-imagemagick-compat  # version 1.4+really1.3.35-1, or
sudo apt install imagemagick-6.q16                  # version 8:6.9.10.23+dfsg-2.1ubuntu11.4
sudo apt install imagemagick-6.q16hdri              # version 8:6.9.10.23+dfsg-2.1ubuntu11.4
```

on which I installed sage:

```
$ ./sage -version
SageMath version 9.6.beta5, Release Date: 2022-03-12
```


on which I merged this ticket, I confirm the doctests work:


```
./sage -t src/sage/misc/latex_standalone.py 
no stored timings available
Running doctests with ID 2022-03-24-11-08-32-82df3068.
Git branch: 20343
Using --optional=debian,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --random-seed=224621707555152601217192014946498015018 src/sage/misc/latex_standalone.py
    [216 tests, 0.29 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.3 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.3 seconds
Features detected for doctesting: graphviz,sage.combinat,sage.graphs,sage.symbolic
Pytest is not installed, skip checking tests that rely on it.
```



```
$ ./sage -t --optional=sage,optional,external --long src/sage/misc/latex_standalone.py 
too few successful tests, not using stored timings
Running doctests with ID 2022-03-24-11-08-54-06354475.
Git branch: 20343
Using --optional=debian,external,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,cplex,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,jupymake,kenzo,latex,latex_package_tkz_graph,latte_int,lrslib,lualatex,macaulay2,magma,maple,mathematica,matlab,mcqd,meataxe,nauty,octave,palp,pandoc,pdf2svg,pdflatex,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,scilab,sphinx,tdlib,xelatex
Doctesting 1 file.
sage -t --long --random-seed=318237908393715923968305484155979250546 src/sage/misc/latex_standalone.py
    [216 tests, 0.29 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.3 seconds
Features detected for doctesting: graphviz,pdftocairo,sage.combinat,sage.graphs,sage.symbolic
Pytest is not installed, skip checking tests that rely on it.
```



---

Comment by caruso created at 2022-03-24 10:21:52

Changing status from needs_review to positive_review.


---

Comment by caruso created at 2022-03-24 10:21:52

Nice! I give back a positive review to this ticket.


---

Comment by slabbe created at 2022-03-24 13:06:27

Super!


---

Comment by vbraun created at 2022-03-30 22:33:17

Resolution: fixed


---

Comment by chapoton created at 2022-04-02 20:23:56

this has introduced wrong indentation

```
src/sage/misc/latex_standalone.py:688:12: E111 indentation is not a multiple of four
src/sage/misc/latex_standalone.py:689:16: E111 indentation is not a multiple of four
src/sage/misc/latex_standalone.py:690:12: E111 indentation is not a multiple of four
src/sage/misc/latex_standalone.py:691:16: E111 indentation is not a multiple of four
```



---

Comment by chapoton created at 2022-04-03 08:10:44

so please swiftly review #33635


---

Comment by jhpalmieri created at 2022-06-02 17:00:18

Could this possibly be leading to the bad LaTeX that's causing the problem with  `view(crystals.Tableaux("A3",shape=[2,1]))` — see https://groups.google.com/g/sage-support/c/1u4m-Osz6jY/m/PAM-1C40AwAJ?


---

Comment by jhpalmieri created at 2022-06-02 23:07:14

In case this is relevant to the `view(crystals....)` failure, that is now #33947.


---

Comment by slabbe created at 2022-06-03 07:24:17

Replying to [comment:169 jhpalmieri]:
> Could this possibly be leading to the bad LaTeX that's causing the problem with  `view(crystals.Tableaux("A3",shape=[2,1]))` — see https://groups.google.com/g/sage-support/c/1u4m-Osz6jY/m/PAM-1C40AwAJ?

No. The problem reported on sage-support is with respect to Sage 9.3. The `TikzPicture` code went into sage in 9.6. Also, for now, no other file is using the new `TikzPicture` module.
