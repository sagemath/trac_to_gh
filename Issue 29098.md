# Issue 29098: Always find SAGE_NTL_PREFIX and call Singular configure with it

Issue created by migration from https://trac.sagemath.org/ticket/29335

Original creator: mkoeppe

Original creation time: 2020-03-15 04:26:05

CC:  dimpase embray fbissey @mwageringel arojas

As observed in #29104, Singular's configure may fail to find NTL even if Sage finds a system NTL. It continues to build, but the result is broken.

The details:

NTL's `spkg-configure.m4` (from #27265/#27822) uses `AC_CHECK_HEADER`/`AC_LINK_IFELSE`/`AC_RUN_IFELSE` and therefore is able to find NTL in an environment where the user has set CPPFLAGS and LDFLAGS accordingly.
In that case, it sets `AC_SUBST(SAGE_NTL_PREFIX, [''])`

Then `build/bin/sage-build-env-config.in` does:

```
# This is usually blank if the system NTL is used, or $SAGE_LOCAL otherwise
export SAGE_NTL_PREFIX="@SAGE_NTL_PREFIX@"
if [ -n "$SAGE_NTL_PREFIX" ]; then
    # Many packages that depend on NTL accept a --with-ntl=<prefix> flag to
    # their ./configure scripts.  When using the system's NTL this is not
    # generally necessary, but when using the NTL package installed in
    # SAGE_LOCAL it is useful to pass it.
    export SAGE_CONFIGURE_NTL="--with-ntl=$SAGE_NTL_PREFIX"
fi
```


But Singular's `configure` (via its `m4/ntl-check.m4`) insists to find the headers in `NTL_HOME_PATH`, which defaults to `DEFAULT_CHECKING_PATH="/usr /usr/local /sw /opt/local"`, which can of course be quite wrong.

We should always provide the --with-ntl=PREFIX option to Singular -- and make it an error if Singular's configure cannot find NTL.


---

Comment by mkoeppe created at 2020-03-15 04:33:52

Singular's checks for GMP and FLINT are almost as bad, but because the check for the header file is commented out, it happens to accept the libraries that are accessible via CPPFLAGS and LDFLAGS.


---

Comment by mkoeppe created at 2020-03-15 04:57:32

New commits:


---

Comment by mkoeppe created at 2020-03-15 05:23:06

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-03-15 05:24:02

Those detections are a bit better in newer versions of singular, but still a bit off. My pull request to sanitize the new `flint` detection code has been accepted but that's not the only thing that should be sanitized. https://github.com/Singular/Sources/pull/981


---

Comment by mkoeppe created at 2020-03-15 15:51:21

Glad to hear that upstream accepts build cleanup patches!


---

Comment by mkoeppe created at 2020-03-15 15:57:19

The fix on this ticket works (see #29104 / https://github.com/mkoeppe/sage/runs/508693083) - but it turns out that homebrew's NTL is not suitable:

```
  [singular-4.1.1p2.p0]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64
  [singular-4.1.1p2.p0]   clang: error: linker command failed with exit code 1 (use -v to see invocation)
  [singular-4.1.1p2.p0]   make[8]: *** [libSingular.la] Error 1
```

This is something that our `ntl/spkg-configure.m4` should be checking. (This is #29339.)


---

Comment by mkoeppe created at 2020-03-16 15:18:30

Ready for review


---

Comment by dimpase created at 2020-03-16 16:01:16

what's going on in `./configure` with NTL headers? Why is it there, and not in the corresponding `spkg-configure.m4` ?

Why one cannot just use `AC_CHECK_HEADER(S)()`, instead of a dodgy loop?


---

Comment by mkoeppe created at 2020-03-16 16:07:36

Making upstream singular configuration non-dodgy is beyond the scope of this ticket.


---

Comment by dimpase created at 2020-03-16 16:27:19

oops, sorry, I have not realised that's Singular's `./configure`
(stress and jetlag :-( )

how about we just pass it what's Sage already knows about NTL headers, i.e.
`SAGE_NTL_PREFIX` ?


---

Comment by mkoeppe created at 2020-03-16 16:28:31

The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.


---

Comment by mkoeppe created at 2020-03-16 16:29:31

(see ticket description)


---

Comment by dimpase created at 2020-03-16 17:04:42

Replying to [comment:14 mkoeppe]:
> The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.

But we can, as we call AC_CHECK_HEADER, and it sets `ac_cv_header_`<header-file>
so we can easily store it somewhere.


---

Comment by mkoeppe created at 2020-03-16 17:07:15

ac_cv_header_NTL_ZZ_h=yes


---

Comment by dimpase created at 2020-03-16 18:02:53

OK, but we can use `AX_ABSOLUTE_HEADER()` - as used in MPIR's spkg-configure.m4
to get the absolute path.

IMHO this way we don't have to patch Singular at all, right? Just pass the value, whatever it is.


---

Comment by mkoeppe created at 2020-03-16 18:11:34

I wouldn't consider use of this terrible macro an improvement.


---

Comment by mkoeppe created at 2020-03-16 18:12:33

In particular, reconstructing an install prefix from the location of a header file is NOT a good technical solution.


---

Comment by dimpase created at 2020-03-16 18:27:04

if you don't want a terrible macro, you can parse `NTL/config_log.h` to get the value of `DEF_PREFIX`, which is exactly the prefix we're after. If it's not defined, one can look for`PREFIX`, which would amount for the same thing. Finally, if neither are defined,
the prefix is `/usr/local`.
Cf. https://www.shoup.net/ntl/doc/tour-unix.html


---

Comment by mkoeppe created at 2020-03-16 19:00:23

Sorry, none of these are improvements over the simple patch.


---

Comment by dimpase created at 2020-03-18 02:41:41

OK. Upstream really needs to get this stuff fixed.


---

Comment by dimpase created at 2020-03-18 02:41:41

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-18 03:07:01

Thanks.


---

Comment by vbraun created at 2020-03-22 23:20:45

Resolution: fixed
