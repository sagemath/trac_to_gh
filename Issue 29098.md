# Issue 29098: Fix Singular configure so it accepts NTL installed in nonstandard locations

archive/issues_029098.json:
```json
{
    "body": "CC:  @dimpase @embray @kiwifb @mwageringel @antonio-rojas\n\nAs observed in #29104, Singular's configure may fail to find NTL even if Sage finds a system NTL. It continues to build, but the result is broken.\n\nThe details:\n\nNTL's `spkg-configure.m4` (from #27265/#27822) uses `AC_CHECK_HEADER`/`AC_LINK_IFELSE`/`AC_RUN_IFELSE` and therefore is able to find NTL in an environment where the user has set CPPFLAGS and LDFLAGS accordingly.\nIn that case, it sets `AC_SUBST(SAGE_NTL_PREFIX, [''])`\n\nThen `build/bin/sage-build-env-config.in` does:\n\n```\n# This is usually blank if the system NTL is used, or $SAGE_LOCAL otherwise\nexport SAGE_NTL_PREFIX=\"@SAGE_NTL_PREFIX@\"\nif [ -n \"$SAGE_NTL_PREFIX\" ]; then\n    # Many packages that depend on NTL accept a --with-ntl=<prefix> flag to\n    # their ./configure scripts.  When using the system's NTL this is not\n    # generally necessary, but when using the NTL package installed in\n    # SAGE_LOCAL it is useful to pass it.\n    export SAGE_CONFIGURE_NTL=\"--with-ntl=$SAGE_NTL_PREFIX\"\nfi\n```\n\nBut Singular's `configure` (via its `m4/ntl-check.m4`) insists to find the headers in `NTL_HOME_PATH`, which defaults to `DEFAULT_CHECKING_PATH=\"/usr /usr/local /sw /opt/local\"`, which can of course be quite wrong.\n\n\nOn this ticket, we use a simple patch that modifies Singular's NTL detection code to make it similar to its GMP and FLINT detection codes. \n\n\nAn alternative solution would be to always provide the --with-ntl=PREFIX option to Singular.\nWe should also make it an error if Singular's configure cannot find NTL.\n\nSee also: #25993 - Upgrade Singular\n\nIssue created by migration from https://trac.sagemath.org/ticket/29335\n\n",
    "closed_at": "2020-03-22T23:20:45Z",
    "created_at": "2020-03-15T04:26:05Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Fix Singular configure so it accepts NTL installed in nonstandard locations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29098",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @embray @kiwifb @mwageringel @antonio-rojas

As observed in #29104, Singular's configure may fail to find NTL even if Sage finds a system NTL. It continues to build, but the result is broken.

The details:

NTL's `spkg-configure.m4` (from #27265/#27822) uses `AC_CHECK_HEADER`/`AC_LINK_IFELSE`/`AC_RUN_IFELSE` and therefore is able to find NTL in an environment where the user has set CPPFLAGS and LDFLAGS accordingly.
In that case, it sets `AC_SUBST(SAGE_NTL_PREFIX, [''])`

Then `build/bin/sage-build-env-config.in` does:

```
# This is usually blank if the system NTL is used, or $SAGE_LOCAL otherwise
export SAGE_NTL_PREFIX="@SAGE_NTL_PREFIX@"
if [ -n "$SAGE_NTL_PREFIX" ]; then
    # Many packages that depend on NTL accept a --with-ntl=<prefix> flag to
    # their ./configure scripts.  When using the system's NTL this is not
    # generally necessary, but when using the NTL package installed in
    # SAGE_LOCAL it is useful to pass it.
    export SAGE_CONFIGURE_NTL="--with-ntl=$SAGE_NTL_PREFIX"
fi
```

But Singular's `configure` (via its `m4/ntl-check.m4`) insists to find the headers in `NTL_HOME_PATH`, which defaults to `DEFAULT_CHECKING_PATH="/usr /usr/local /sw /opt/local"`, which can of course be quite wrong.


On this ticket, we use a simple patch that modifies Singular's NTL detection code to make it similar to its GMP and FLINT detection codes. 


An alternative solution would be to always provide the --with-ntl=PREFIX option to Singular.
We should also make it an error if Singular's configure cannot find NTL.

See also: #25993 - Upgrade Singular

Issue created by migration from https://trac.sagemath.org/ticket/29335





---

archive/issue_comments_411379.json:
```json
{
    "body": "Singular's checks for GMP and FLINT are almost as bad, but because the check for the header file is commented out, it happens to accept the libraries that are accessible via CPPFLAGS and LDFLAGS.",
    "created_at": "2020-03-15T04:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411379",
    "user": "https://github.com/mkoeppe"
}
```

Singular's checks for GMP and FLINT are almost as bad, but because the check for the header file is commented out, it happens to accept the libraries that are accessible via CPPFLAGS and LDFLAGS.



---

archive/issue_comments_411380.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-03-15T04:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411380",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_411381.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-15T05:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411381",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411382.json:
```json
{
    "body": "Those detections are a bit better in newer versions of singular, but still a bit off. My pull request to sanitize the new `flint` detection code has been accepted but that's not the only thing that should be sanitized. https://github.com/Singular/Sources/pull/981",
    "created_at": "2020-03-15T05:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411382",
    "user": "https://github.com/kiwifb"
}
```

Those detections are a bit better in newer versions of singular, but still a bit off. My pull request to sanitize the new `flint` detection code has been accepted but that's not the only thing that should be sanitized. https://github.com/Singular/Sources/pull/981



---

archive/issue_comments_411383.json:
```json
{
    "body": "Glad to hear that upstream accepts build cleanup patches!",
    "created_at": "2020-03-15T15:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411383",
    "user": "https://github.com/mkoeppe"
}
```

Glad to hear that upstream accepts build cleanup patches!



---

archive/issue_comments_411384.json:
```json
{
    "body": "The fix on this ticket works (see #29104 / https://github.com/mkoeppe/sage/runs/508693083) - but it turns out that homebrew's NTL is not suitable:\n\n```\n  [singular-4.1.1p2.p0]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64\n  [singular-4.1.1p2.p0]   clang: error: linker command failed with exit code 1 (use -v to see invocation)\n  [singular-4.1.1p2.p0]   make[8]: *** [libSingular.la] Error 1\n```\nThis is something that our `ntl/spkg-configure.m4` should be checking. (This is #29339.)",
    "created_at": "2020-03-15T15:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411384",
    "user": "https://github.com/mkoeppe"
}
```

The fix on this ticket works (see #29104 / https://github.com/mkoeppe/sage/runs/508693083) - but it turns out that homebrew's NTL is not suitable:

```
  [singular-4.1.1p2.p0]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64
  [singular-4.1.1p2.p0]   clang: error: linker command failed with exit code 1 (use -v to see invocation)
  [singular-4.1.1p2.p0]   make[8]: *** [libSingular.la] Error 1
```
This is something that our `ntl/spkg-configure.m4` should be checking. (This is #29339.)



---

archive/issue_comments_411385.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-03-16T15:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411385",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review



---

archive/issue_comments_411386.json:
```json
{
    "body": "what's going on in `./configure` with NTL headers? Why is it there, and not in the corresponding `spkg-configure.m4` ?\n\nWhy one cannot just use `AC_CHECK_HEADER(S)()`, instead of a dodgy loop?",
    "created_at": "2020-03-16T16:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411386",
    "user": "https://github.com/dimpase"
}
```

what's going on in `./configure` with NTL headers? Why is it there, and not in the corresponding `spkg-configure.m4` ?

Why one cannot just use `AC_CHECK_HEADER(S)()`, instead of a dodgy loop?



---

archive/issue_comments_411387.json:
```json
{
    "body": "Making upstream singular configuration non-dodgy is beyond the scope of this ticket.",
    "created_at": "2020-03-16T16:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411387",
    "user": "https://github.com/mkoeppe"
}
```

Making upstream singular configuration non-dodgy is beyond the scope of this ticket.



---

archive/issue_comments_411388.json:
```json
{
    "body": "oops, sorry, I have not realised that's Singular's `./configure`\n(stress and jetlag :-( )\n\nhow about we just pass it what's Sage already knows about NTL headers, i.e.\n`SAGE_NTL_PREFIX` ?",
    "created_at": "2020-03-16T16:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411388",
    "user": "https://github.com/dimpase"
}
```

oops, sorry, I have not realised that's Singular's `./configure`
(stress and jetlag :-( )

how about we just pass it what's Sage already knows about NTL headers, i.e.
`SAGE_NTL_PREFIX` ?



---

archive/issue_comments_411389.json:
```json
{
    "body": "The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.",
    "created_at": "2020-03-16T16:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411389",
    "user": "https://github.com/mkoeppe"
}
```

The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.



---

archive/issue_comments_411390.json:
```json
{
    "body": "(see ticket description)",
    "created_at": "2020-03-16T16:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411390",
    "user": "https://github.com/mkoeppe"
}
```

(see ticket description)



---

archive/issue_comments_411391.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.\n\n\nBut we can, as we call AC_CHECK_HEADER, and it sets `ac_cv_header_`<header-file>\nso we can easily store it somewhere.",
    "created_at": "2020-03-16T17:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411391",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:14 mkoeppe]:
> The problem is that we do not really determine SAGE_NTL_PREFIX. It is empty if the system package is used.


But we can, as we call AC_CHECK_HEADER, and it sets `ac_cv_header_`<header-file>
so we can easily store it somewhere.



---

archive/issue_comments_411392.json:
```json
{
    "body": "ac_cv_header_NTL_ZZ_h=yes",
    "created_at": "2020-03-16T17:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411392",
    "user": "https://github.com/mkoeppe"
}
```

ac_cv_header_NTL_ZZ_h=yes



---

archive/issue_comments_411393.json:
```json
{
    "body": "OK, but we can use `AX_ABSOLUTE_HEADER()` - as used in MPIR's spkg-configure.m4\nto get the absolute path.\n\nIMHO this way we don't have to patch Singular at all, right? Just pass the value, whatever it is.",
    "created_at": "2020-03-16T18:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411393",
    "user": "https://github.com/dimpase"
}
```

OK, but we can use `AX_ABSOLUTE_HEADER()` - as used in MPIR's spkg-configure.m4
to get the absolute path.

IMHO this way we don't have to patch Singular at all, right? Just pass the value, whatever it is.



---

archive/issue_comments_411394.json:
```json
{
    "body": "I wouldn't consider use of this terrible macro an improvement.",
    "created_at": "2020-03-16T18:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411394",
    "user": "https://github.com/mkoeppe"
}
```

I wouldn't consider use of this terrible macro an improvement.



---

archive/issue_comments_411395.json:
```json
{
    "body": "In particular, reconstructing an install prefix from the location of a header file is NOT a good technical solution.",
    "created_at": "2020-03-16T18:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411395",
    "user": "https://github.com/mkoeppe"
}
```

In particular, reconstructing an install prefix from the location of a header file is NOT a good technical solution.



---

archive/issue_comments_411396.json:
```json
{
    "body": "if you don't want a terrible macro, you can parse `NTL/config_log.h` to get the value of `DEF_PREFIX`, which is exactly the prefix we're after. If it's not defined, one can look for`PREFIX`, which would amount for the same thing. Finally, if neither are defined,\nthe prefix is `/usr/local`.\nCf. https://www.shoup.net/ntl/doc/tour-unix.html",
    "created_at": "2020-03-16T18:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411396",
    "user": "https://github.com/dimpase"
}
```

if you don't want a terrible macro, you can parse `NTL/config_log.h` to get the value of `DEF_PREFIX`, which is exactly the prefix we're after. If it's not defined, one can look for`PREFIX`, which would amount for the same thing. Finally, if neither are defined,
the prefix is `/usr/local`.
Cf. https://www.shoup.net/ntl/doc/tour-unix.html



---

archive/issue_comments_411397.json:
```json
{
    "body": "Sorry, none of these are improvements over the simple patch.",
    "created_at": "2020-03-16T19:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411397",
    "user": "https://github.com/mkoeppe"
}
```

Sorry, none of these are improvements over the simple patch.



---

archive/issue_comments_411398.json:
```json
{
    "body": "OK. Upstream really needs to get this stuff fixed.",
    "created_at": "2020-03-18T02:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411398",
    "user": "https://github.com/dimpase"
}
```

OK. Upstream really needs to get this stuff fixed.



---

archive/issue_comments_411399.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-18T02:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411399",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411400.json:
```json
{
    "body": "Thanks.",
    "created_at": "2020-03-18T03:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411400",
    "user": "https://github.com/mkoeppe"
}
```

Thanks.



---

archive/issue_comments_411401.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-22T23:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29098#issuecomment-411401",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074680.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-22T23:20:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29098",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29098#event-74680"
}
```
