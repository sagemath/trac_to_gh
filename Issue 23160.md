# Issue 23160: Replace pip2/3-lock with a generic sage-flock command

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-07-10 14:36:14

CC:  jdemeyer

I suggested something like this on #21672 but didn't have immediate need to follow up on it.

Something like this will be useful for making Windows builds more reliable, however, as there are some operations that can fail if they are run simultaneously during parallel builds.

In particular I'm trying to trace down failures with DLL rebasing, and at least part of the problem is that rebase can fail if it's being multiple times simultaneously as can happen during a parallel build (especially toward the end of the build when lots of Python packages are being installed--these are fast and often results in multiple rebases being run simultaneously).

With tickets like #22509 it will also be possible to make further restrictions, such as not running rebase while a package is being uninstalled.


---

Comment by embray created at 2017-07-10 14:36:56

(CC: jdemeyer, original author of the script)
----
New commits:


---

Comment by embray created at 2017-07-10 14:36:56

Changing status from new to needs_review.


---

Comment by embray created at 2017-09-06 08:53:07

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-09-06 08:53:07

Apparently this has a bug...


---

Comment by git created at 2017-09-06 09:15:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-09-06 09:16:37

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-19 10:51:57

*ping*

I actually increasingly need this as it's difficult to get through a parallel build on Cygwin now without it failing a few times due to the lack of locking around rebase.


---

Comment by jdemeyer created at 2017-10-25 09:51:43

Why did you remove `sys.stderr.flush()`?


---

Comment by jdemeyer created at 2017-10-25 09:56:46

I think it would be good to mention somewhere in a comment that this may be used in build scripts, but only for packages depending on Python.

The help mentions

```
The command may also be a Python module in which case it is run in the same
Python interpreter as this script (a small optimization to avoid restarting the
Python interpreter).
```

but I don't see that in the implementation.


---

Comment by jdemeyer created at 2017-10-25 09:56:46

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-25 10:06:35

Replying to [comment:6 jdemeyer]:
> Why did you remove `sys.stderr.flush()`?

See also https://mail.python.org/pipermail/python-list/2015-November/698421.html

It seems that Python 2 has unbuffered `sys.stderr` by default, which means that the flushing is not needed.

But this was changed in Python 3, so the flushing would be required there.


---

Comment by embray created at 2017-10-25 11:27:53

Ah, good catch.  I had mistakenly assume that the `print()` function would automatically flush by default.

As for being "only for packages depending on Python" that has me wondering now what the best thing would be to do with this.  Maybe it should be moved to `build/bin`.  I need to use it for basically all packages, and the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).  But this script is also used at runtime (just for pip install, currently), in which case it should use Sage's Python.  Any ideas?


---

Comment by git created at 2017-10-25 11:33:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-25 11:37:57

Replying to [comment:9 embray]:
> the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).

If I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.


---

Comment by jdemeyer created at 2017-10-25 11:39:21

Replying to [comment:10 git]:
> ||[e960c8a](https://git.sagemath.org/sage.git/commit/?id=e960c8aad05190eda6f4f836ce4c15dd663d82ff)||`Turns out print() does not flush I/O by default`||

The `flush` keyword is Python 3 only.


---

Comment by embray created at 2017-10-25 12:20:56

D'oh, how annoying.  In that case I'll just switch it back to `sys.stderr.write...`.


---

Comment by embray created at 2017-10-25 12:22:54

Replying to [comment:11 jdemeyer]:
> Replying to [comment:9 embray]:
> > the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).
> 
> If I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.

That's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290

The question is, should the script live in `build/bin` or `src/bin`, and what should go in the shebang line?  This is unclear for Python scripts that we want to work at build time and run time...


---

Comment by git created at 2017-10-25 12:25:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-25 12:25:57

Replying to [comment:9 embray]:
> I need to use it for basically all packages

What is your use case?


---

Comment by embray created at 2017-10-25 12:31:41

See description.


---

Comment by embray created at 2017-10-25 12:34:30

To clarify, the `sage-rebase` command opens, and often writes to, every DLL installed in `$SAGE_LOCAL`.  It is run at the end of every package build.  If two packages complete build/installation at the same time, then there is a race to run `sage-rebase`, and the second one can fail, causing the build to halt.  This especially happens while installing the Python packages because there are a large number of packages being installed quickly one after the other.  But it can happen (and has happened) in principle any other time.  So I need to put a lock around `sage-rebase` to prevent it from being run simultaneously for multiple packages.


---

Comment by jdemeyer created at 2017-10-25 12:37:09

Replying to [comment:14 embray]:
> what should go in the shebang line?

If you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.


---

Comment by embray created at 2017-10-25 12:45:32

Replying to [comment:19 jdemeyer]:
> Replying to [comment:14 embray]:
> > what should go in the shebang line?
> 
> If you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.

But that's the problem, because if it's intended to be used at runtime it should in that case be using Sage's Python (I guess?), and with `SAGE_PYTHON3=yes` this is incorrect since `python` still means `python2.7`.

That said, the original use case for this was with `pip`, and running `pip` is still arguably a "build" action, so maybe this should just be moved to `build/bin` to emphasize that it's a build tool.  It can use the system python by default and/or Sage's Python 2 because ultimately it doesn't matter what Python this is run with since it just execs the program it wraps.


---

Comment by git created at 2017-10-25 12:48:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-25 12:49:16

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-25 12:49:16

You've convinced me (and/or I've convinced myself) that this is the best approach.


---

Comment by jdemeyer created at 2017-10-25 13:17:39

Replying to [comment:14 embray]:
> That's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290

But then you need to ensure that your script can find this `argparse` module.


---

Comment by jdemeyer created at 2017-10-25 13:17:39

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-25 13:41:01

Okay, I was under the mistaken assumption, for some reason, that this was added to `PYTHONPATH` during builds.


---

Comment by git created at 2017-10-26 09:45:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-26 09:45:48

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-31 15:25:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-11-03 12:44:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-11-14 09:44:14

Changing priority from major to critical.


---

Comment by embray created at 2017-11-14 09:44:14

This is increasingly critical since not having it can lead to failures even in the patchbot base build, causing the patchbot to exit.


---

Comment by vbraun created at 2017-12-11 01:04:13

Resolution: fixed
