# Issue 10440: Upgrade Cython to 0.14

Issue created by migration from https://trac.sagemath.org/ticket/10493

Original creator: jason

Original creation time: 2010-12-18 20:26:50

Assignee: tbd

CC:  robertwb fbissey

Version 0.14 was recently released, and has some bugfixes and nice features.


---

Comment by robertwb created at 2010-12-19 09:43:39

We're in pretty good shape. There's a couple of minor patches to the library that need to go in, but other than that upgrading to 0.14 should be pretty straightforward. See, e.g. https://sage.math.washington.edu:8091/hudson/view/ExtLibs/job/sage-tests/


---

Comment by jdemeyer created at 2011-01-12 01:46:59

Changing keywords from "" to "cython spkg".


---

Comment by jdemeyer created at 2011-01-12 01:46:59

Is the `__getattr__` patch (in the 0.13 Cython spkg) still needed?


---

Comment by robertwb created at 2011-01-12 02:01:26

No, that is now handled via a flag. There are several bugfixes in 0.14.1 that I'd like to get in, which should be out shortly (before 4.6.2 is at release candidate for sure, and I knew we missed the window for 4.6.1) which is why I haven't done anything on this ticket yet.


---

Comment by vbraun created at 2011-01-12 04:38:08

Updated package with just the `__getattr__` patches removed as they are now in the upstream source:

http://www.stp.dias.ie/~vbraun/Sage/spkg/cython-0.14.spkg


---

Comment by robertwb created at 2011-01-12 06:29:31

Thanks, but that is not sufficient, as we need to pass the appropriate flags. 

The most recent spkg can be found at https://sage.math.washington.edu:8091/hudson/job/sage-build/lastSuccessfulBuild/artifact/cython-devel.spkg (though the Sage library requires a couple of patches as well).


---

Comment by jason created at 2011-02-08 20:36:10

Updating the description to upgrade to 0.14.1, which is now the most recent release.  Has anyone worked on an 0.14.1 spkg?


---

Attachment

Spkg at http://sage.math.washington.edu/home/robertwb/cython/cython-0.14.1.spkg


---

Comment by robertwb created at 2011-02-09 07:41:28

Changing status from new to needs_review.


---

Comment by jason created at 2011-02-09 22:25:39

Replying to [comment:1 robertwb]:
> There's a couple of minor patches to the library that need to go in

Is this still the case with the 0.14.1 spkg?


---

Comment by fbissey created at 2011-02-09 23:13:49

I think that's what the patch is all about. I applied it to 4.6.2.alpha4 and it happily built and sage -testall did not show any problems for me. But may be the following warnings should be addressed

```
warning: sage/combinat/combinat_cython.pyx:14:0: 'stdlib' is deprecated, use 'libc.stdlib'
warning: sage/ext/interpreters/wrapper_rdf.pxd:3:0: 'python_object' is deprecated, use 'cpython'
warning: sage/rings/polynomial/polynomial_real_mpfr_dense.pyx:7:0: 'python_int' is deprecated, use 'cpython'
warning: sage/rings/polynomial/polynomial_real_mpfr_dense.pyx:8:0: 'python_float' is deprecated, use 'cpython'
warning: sage/ext/interpreters/wrapper_cdf.pxd:3:0: 'python_object' is deprecated, use 'cpython'
warning: sage/ext/interpreters/wrapper_rdf.pxd:3:0: 'python_object' is deprecated, use 'cpython'
warning: sage/ext/interpreters/wrapper_py.pxd:3:0: 'python_object' is deprecated, use 'cpython'
warning: sage/ext/interpreters/wrapper_rr.pxd:3:0: 'python_object' is deprecated, use 'cpython'
warning: sage/ext/interpreters/wrapper_el.pxd:3:0: 'python_object' is deprecated, use 'cpython'
```

And possibly

```
warning: sage/modular/modsym/p1list.pyx:703:17: cdef variable 'i' declared after it is used
```

Finally I am wondering about these

```
warning: sage/matrix/matrix0.pyx:53:22: Function signature does not match previous declaration
warning: sage/matrix/matrix_window.pyx:9:17: Function signature does not match previous declaration
warning: sage/matrix/matrix_sparse.pyx:18:33: Function signature does not match previous declaration
```

But all these were present before upgrading to cython-0.14.1.
We could use the opportunity to fix some of them before they bite us later, especially the deprecated ones.


---

Comment by fbissey created at 2011-02-09 23:16:54

Forgot these two:

```
warning: sage/structure/parent.pyx:124:4: dict already a builtin Cython type
warning: sage/symbolic/pynac.pyx:589:5: Function 'py_get_parent_char' previously declared as 'extern'
```



---

Comment by robertwb created at 2011-02-09 23:20:41

Yes, the (attached) patch is still needed. There's some significant cleanup that I want to do, including fixing these warnings, but I think that should be a separate ticket.


---

Comment by fbissey created at 2011-02-09 23:41:06

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2011-02-09 23:41:06

Well if you open a separate ticket for these warnings I am quite happy to give this a positive review. I have built it on linux-86, linux-amd64 and OS X 10.5. 
It all looks good to me.


---

Comment by robertwb created at 2011-02-10 03:17:05

Ticket for warnings at #10764.


---

Comment by jdemeyer created at 2011-02-24 10:42:35

After building sage-4.6.2.rc0 and applying the spkg and patch from this ticket:

```
$ ./sage -ba-force
[...]
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/usr/local/src/sage-4.6.2.rc0/local//include -I/usr/local/src/sage-4.6.2.rc0/local//include/csage -I/usr/local/src/sage-4.6.2.rc0/devel//sage/sage/ext -I/usr/local/src/sage-4.6.2.rc0/local/include/python2.6 -c sage/combinat/combinat_cython.c -o build/temp.linux-x86_64-2.6/sage/combinat/combinat_cython.o -w
sage/combinat/combinat_cython.c: In function '__pyx_pf_4sage_8combinat_15combinat_cython__stirling_number2':
sage/combinat/combinat_cython.c:2431:13: error: incompatible types when assigning to type 'mpz_t' from type 'struct __mpz_struct *'
error: command 'gcc' failed with exit status 1
sage: There was an error installing modified sage library code.
```


This is using

```
$ gcc --version
gcc-4.4.3 (Gentoo 4.4.3-r2 p1.2) 4.4.3
Copyright (C) 2010 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```



---

Comment by jdemeyer created at 2011-02-24 10:42:35

Changing status from positive_review to needs_work.


---

Comment by jason created at 2011-02-24 15:31:07

Why is the deprecation warning in polynomial_compiled.pyx commented out in this patch?  If it is not being used, shouldn't it just be removed?


---

Comment by robertwb created at 2011-02-24 18:00:06

I'm not sure why the gcc error--I'll take a look at that. (I'm guessing that's some new code?)

As for commenting out the deprecation warning, the issue is that decorators aren't implemented for Cython special functions. They used to be silently ignored, but now an error is raised. When they're supported, we should put this back in.


---

Comment by robertwb created at 2011-02-25 05:39:16

Somehow one of the fixes for http://trac.cython.org/cython_trac/ticket/654 was merged into the release at the last minute, which is incompatible with how we declare many of the *_t types. I'll post a new spkg disabling this "fix."


---

Comment by robertwb created at 2011-02-25 05:52:56

I've created a new spkg. All tests pass.


---

Comment by robertwb created at 2011-02-25 05:52:56

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2011-02-25 08:19:41

Replying to [comment:19 robertwb]:
> Somehow one of the fixes for http://trac.cython.org/cython_trac/ticket/654 was merged into the release at the last minute, which is incompatible with how we declare many of the *_t types. I'll post a new spkg disabling this "fix." 

How come you and I never got affected by it?


---

Comment by robertwb created at 2011-02-25 08:27:50

I'm not sure, but maybe the last spkg was the rc, and the fix for this issue was not supposed to go in this release, but we messed up and it did.


---

Comment by jdemeyer created at 2011-02-25 16:44:32

It works for me now, so I'm putting back the positive review.


---

Comment by jdemeyer created at 2011-02-25 16:44:32

Changing status from needs_review to positive_review.


---

Comment by robertwb created at 2011-02-25 17:20:41

Thanks.


---

Comment by jdemeyer created at 2011-03-08 21:46:01

Resolution: fixed


---

Comment by jdemeyer created at 2011-05-04 09:01:19

*Please fix*: the SPKG.txt must be updated, there is no mention of this ticket.


---

Comment by jdemeyer created at 2011-05-04 09:01:19

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2011-05-04 09:01:19

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-05-04 09:01:19

Changing status from closed to new.


---

Comment by robertwb created at 2011-05-05 06:59:36

The SPKG.txt has been updated, see http://sage.math.washington.edu/home/robertwb/cython/cython-0.14.1.p2.spkg


---

Comment by robertwb created at 2011-05-05 06:59:36

Changing status from new to needs_review.


---

Attachment

I made some further changes to SPKG.txt: [http://boxen.math.washington.edu/home/jdemeyer/spkg/cython-0.14.1.p3.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/cython-0.14.1.p3.spkg)


---

Comment by robertwb created at 2011-05-06 06:17:36

I'm happy with your spkg.txt.


---

Comment by robertwb created at 2011-05-06 06:17:36

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-05-06 07:18:11

Resolution: fixed
