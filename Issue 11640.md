# Issue 11640: traceback with load and attach of .sage files

Issue created by migration from Trac.

Original creator: mstreng

Original creation time: 2011-09-18 09:12:00

Assignee: jason

CC:  johanbosman

When debugging code that is loaded into or attached to a Sage session from a .sage file,
the tracebacks are not very informative: they refer to <string> instead
of to the file name, and give no line numbers or code snippets. This
makes it hard to find out where the error is.

Example:

Suppose I have some files loaded with "load" or "attach", and one of them is a .sage file with

```
class Bar():
     def function_with_common_name(self):
         # lots of lines of code
         1/0
         # lots of lines of code

# other classes that also have functions named function_with_common_name

def foo():
     # lots of lines of code
     a = Bar()
     a.function_with_common_name()
     # lots of lines of code
```


Now I do

```
sage: foo()
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)

/home/marco/<ipython console> in <module>()

/home/marco/<string> in foo()

/home/marco/<string> in function_with_common_name(self)

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/structure/element.so
in sage.structure.element.RingElement.__div__
(sage/structure/element.c:11981)()

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer.so
in sage.rings.integer.Integer._div_ (sage/rings/integer.c:11944)()

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer_ring.so
in sage.rings.integer_ring.IntegerRing_class._div
(sage/rings/integer_ring.c:5142)()

ZeroDivisionError: Rational division by zero
```


The cause of the problem was pinpointed by Cornado PLG and he gives the following fix:

Search preparser.py for `elif fpath.endswith('.sage')` and change to the code below:

```
    elif fpath.endswith('.sage'):
        s = preparse_file(open(fpath).read())
        f = open(fpath + '.py', 'w')
        f.write(s)
        f.close()
        execfile(fpath + '.py', globals) 
```


For an explanation of why this works, and for a discussion of what would be the best way to fix this, see
[http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)


---

Attachment


---

Comment by mstreng created at 2011-09-22 15:37:59

All tests passed on sage 4.7


---

Comment by mstreng created at 2011-09-22 15:37:59

Changing status from new to needs_review.


---

Comment by mstreng created at 2011-09-22 19:06:35

Changing status from needs_review to needs_info.


---

Comment by mstreng created at 2011-09-22 19:06:35

Judging from the patchbot results, it doesn't seem to work after all.

What exactly does spawn('sage') do? It always started a Sage session of the same Sage version and the same Sage installation when I tried it out (it was not in the PATH, but it was in the working directory). Maybe it doesn't work on all machines or it depends on the working directory?

Any idea of how to do these tests so that they succeed with patch and fail without?


---

Comment by mstreng created at 2011-10-07 14:56:00

only apply 11812.patch


---

Comment by mstreng created at 2011-10-07 14:56:00

Changing status from needs_info to needs_review.


---

Comment by leif created at 2011-10-10 02:59:50

A few minor issues:

 * `if preparse_to_file == None:` should be `if preparse_to_file `*`is`*` None:`.

 * There's some mark-up missing in the docstrings (also in parts you didn't add).
 
 * In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in _math_ mode.




I'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.

You can also use continuation lines in examples and doctests by the way, but again they're (currently still) a bit different such that you cannot directly paste them from a Sage session, i.e., you have to use the Python form instead of Sage's (cf. #10458).


---

Comment by mstreng created at 2011-10-10 10:30:55

simpler patch: fixes the problem without adding complicated new doctests


---

Attachment

Replying to [comment:7 leif]:
>  * `if preparse_to_file == None:` should be `if preparse_to_file `*`is`*` None:`.
>  * There's some mark-up missing in the docstrings (also in parts you didn't add).

Thanks, all corrected (I think).

>  * In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in _math_ mode.

Not sure what you mean: I don't see where in this docstring single backticks are or should be used. I did add some double backticks though.


> I'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.

The problem with the doctest is that I couldn't create a test that really checks whether #11812 was fixed:

 * The content of the traceback in the example `sage: attach('myfile.sage')` on line 1573 of [attachment:trac_11812-traceback_attach.patch] is ignored in doctests according to [this link](http://docs.python.org/library/doctest.html#what-about-exceptions). And indeed, that example passes the doctests even with #11812 not applied.

 * The test with pexpect in that attachment seemed to work on my computer, but doesn't really, according to [patchbot](http://patchbot.sagemath.org/log/11812/linux/ubuntu/hardy/sage.math.washington.edu/2011-09-22%2008:56:39%20-0700). The problem is that I don't quite understand which sage installation is used in this test.

So I had to remove the test. As the example isn't tested anyway, I decided to keep things simple by removing that as well and adding a few explanatory comments to the code.


---

Comment by mstreng created at 2011-10-10 10:55:23

I would like to remind the patchbot to apply 11812.patch only.


---

Comment by mstreng created at 2011-10-13 10:53:50

Changing status from needs_review to needs_work.


---

Comment by mstreng created at 2011-10-13 10:53:50

Oops, this patch works only from the moment you attach the file until the moment it changes: if I change my file in another terminal, and then do `sage: foo()` again, it gets reloaded without good tracebacks.


---

Comment by mstreng created at 2011-10-15 09:06:27

I'm writing a new patch.

Unrelated to that, see also #11925.


---

Attachment


---

Comment by mstreng created at 2011-10-16 13:47:27

New patch that does work. Apply 11812.3.patch only.
(testing now)


---

Attachment

All tests pass!!


---

Comment by mstreng created at 2011-10-16 16:25:43

Changing status from needs_work to needs_review.


---

Comment by johanbosman created at 2011-10-17 12:42:02

Changing status from needs_review to positive_review.


---

Comment by johanbosman created at 2011-10-17 12:42:02

Looks good. ;).


---

Comment by mstreng created at 2011-10-18 08:57:04

Changing keywords from "" to "load attach traceback".


---

Comment by mstreng created at 2011-10-18 08:57:04

Replying to [comment:14 johanbosman]:

Thanks!


---

Comment by jdemeyer created at 2011-10-19 18:52:48

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2014-11-20 18:32:57

Replying to [ticket:11812 mstreng]:
> The patch fixes this for attach, but not for load (because of efficiency reasons).

What exactly are these "efficiency reasons"? Are people really executing `load` or `attach` in tight loops? I think that one should *always* have good tracebacks, so I would always use temporary files.


---

Comment by mstreng created at 2014-11-21 07:50:06

Replying to [comment:20 jdemeyer]:
> Replying to [ticket:11812 mstreng]:
> > The patch fixes this for attach, but not for load (because of efficiency reasons).
> 
> What exactly are these "efficiency reasons"?

With a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.

> Are people really executing `load` or `attach` in tight loops?

I can't imagine that anyone would do that.

> I think that one should *always* have good tracebacks, so I would always use temporary files.

I completely agree. However, it seemed during the original discussion that I was the only one who always wanted good tracebacks. And someone made the switch to memory on purpose, for efficiency reasons.


---

Comment by jdemeyer created at 2014-11-21 09:35:24

Replying to [comment:21 mstreng]:
> With a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.
I am thinking about #71 and it _might_ be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.

> And someone made the switch to memory on purpose
Indeed.

> for efficiency reasons.
That's not clear to me, maybe it was just to simplify the code?


---

Comment by mstreng created at 2014-11-21 10:26:37

Replying to [comment:22 jdemeyer]:
> I am thinking about #71 and it _might_ be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.

Sounds good.

Anyway, to get good tracebacks by default also for load, all you need to do is change


```
load_debug_mode = False 
attach_debug_mode = True 
```

both to `True` in sage/misc/preparser.py, except that the name `debug_mode` is a bit confusing when it is the default.

> maybe it was just to simplify the code?

Simplifying and improving the code was indeed the purpose of #7514, where the switch to memory was made. The efficiency reason for the switch to memory was suggested to me by various people, not including the author of #7514.
