# Issue 22442: port Sage to FreeBSD 11.

archive/issues_022442.json:
```json
{
    "body": "CC:  stephen fbissey jdemeyer jpflori\n\nFreeBSD as of version 10 uses clang by default, and is closer to OSX in other ways too, so it would be a good free testing ground for the use of clang with Sage. \n\nFew details I figured out.\n\n* install gcc6 and create fake gfortran by making a link to gcc6\n* install gmake, gawk, gsed, and create fake make and sed to point to gmake and gsed\n* make sure /bin/sh is actually bash\n* hack configure.ac to make freebsd applowed platform\n* get rid of cephes - it causes linking problems with libm, and is probably not needs any more anyway\n* figure out what to do with Sage's libz and libbz - they cause linking problems (needless to say, \n* gf2x only builds with SAGE_FAT_BINARY on\n* ...\n\nIssue created by migration from https://trac.sagemath.org/ticket/22679\n\n",
    "created_at": "2017-03-24T07:36:15Z",
    "labels": [
        "porting: BSD",
        "major",
        "enhancement"
    ],
    "title": "port Sage to FreeBSD 11.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22442",
    "user": "dimpase"
}
```
CC:  stephen fbissey jdemeyer jpflori

FreeBSD as of version 10 uses clang by default, and is closer to OSX in other ways too, so it would be a good free testing ground for the use of clang with Sage. 

Few details I figured out.

* install gcc6 and create fake gfortran by making a link to gcc6
* install gmake, gawk, gsed, and create fake make and sed to point to gmake and gsed
* make sure /bin/sh is actually bash
* hack configure.ac to make freebsd applowed platform
* get rid of cephes - it causes linking problems with libm, and is probably not needs any more anyway
* figure out what to do with Sage's libz and libbz - they cause linking problems (needless to say, 
* gf2x only builds with SAGE_FAT_BINARY on
* ...

Issue created by migration from https://trac.sagemath.org/ticket/22679





---

archive/issue_comments_312614.json:
```json
{
    "body": "cf my comments at\nhttps://github.com/numpy/numpy/issues/8530\n\nfor the need for /lib/libgcc_s.so.1 to be replaced.\n\nBasically, gcc/gfortran and clang's toolchains are slightly incompatible; while workarounds are in place for OSX,\nlinking on freebsd makes it more or less mandatory.",
    "created_at": "2017-03-24T13:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312614",
    "user": "dimpase"
}
```

cf my comments at
https://github.com/numpy/numpy/issues/8530

for the need for /lib/libgcc_s.so.1 to be replaced.

Basically, gcc/gfortran and clang's toolchains are slightly incompatible; while workarounds are in place for OSX,
linking on freebsd makes it more or less mandatory.



---

archive/issue_comments_312615.json:
```json
{
    "body": "one of internal giac tests fail (harmlessly, I hope):\n\n```\n< -sqrt(6)*I*sqrt(sqrt(13)+3),sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*sqrt(sqrt(13)-3),sqrt(6)*sqrt(sqrt(13)-3),0,\n---\n> sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*sqrt(sqrt(13)-3),sqrt(6)*sqrt(sqrt(13)-3),0,\nFAIL: chk_fhan16\n```\n",
    "created_at": "2017-03-26T09:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312615",
    "user": "dimpase"
}
```

one of internal giac tests fail (harmlessly, I hope):

```
< -sqrt(6)*I*sqrt(sqrt(13)+3),sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*sqrt(sqrt(13)-3),sqrt(6)*sqrt(sqrt(13)-3),0,
---
> sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*I*sqrt(sqrt(13)+3),-sqrt(6)*sqrt(sqrt(13)-3),sqrt(6)*sqrt(sqrt(13)-3),0,
FAIL: chk_fhan16
```




---

archive/issue_comments_312616.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-27T08:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312616",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_312617.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-27T09:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312617",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312618.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-27T09:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312618",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312619.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-03-27T13:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312619",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_312620.json:
```json
{
    "body": "builds and runs, modulo ad hoc fixing arb and flint linking issue:\n\n```\n$ ln -sf $SAGE_LOCAL/lib/libarb.so.1.1.1 $SAGE_LOCAL/lib/libarb.so.1\n$ ln -sf $SAGE_LOCAL/lib/libflint.so.13.5.2 $SAGE_LOCAL/lib/libflint.so.13\n```\n",
    "created_at": "2017-03-27T14:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312620",
    "user": "dimpase"
}
```

builds and runs, modulo ad hoc fixing arb and flint linking issue:

```
$ ln -sf $SAGE_LOCAL/lib/libarb.so.1.1.1 $SAGE_LOCAL/lib/libarb.so.1
$ ln -sf $SAGE_LOCAL/lib/libflint.so.13.5.2 $SAGE_LOCAL/lib/libflint.so.13
```




---

archive/issue_comments_312621.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-27T14:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312621",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312622.json:
```json
{
    "body": "without cephes, missing `cpow()` (shows up during building docs). \nAnd this is how things are on [official FreeBSD](https://www.freebsd.org/cgi/man.cgi?query=complex&sektion=3&manpath=FreeBSD+11.0-RELEASE+and+Ports#end).\n\nThus reverting `f5a9b80`. After thus, make completes.\n\nRunning tests now.\n----\nNew commits:",
    "created_at": "2017-03-27T14:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312622",
    "user": "dimpase"
}
```

without cephes, missing `cpow()` (shows up during building docs). 
And this is how things are on [official FreeBSD](https://www.freebsd.org/cgi/man.cgi?query=complex&sektion=3&manpath=FreeBSD+11.0-RELEASE+and+Ports#end).

Thus reverting `f5a9b80`. After thus, make completes.

Running tests now.
----
New commits:



---

archive/issue_comments_312623.json:
```json
{
    "body": "Question to linking experts:\n\nI am not sure whether letting cephes create `libm.so` rather than something like `libm_complex.so` is a good idea. At least I do not see how one can in such a configuration link an executable that needs things from the \"normal\" `libm` as well as from cephes---in particular as Sage has moved away from using things like `LD_LIBRARY_PATH` to using `-rpath` to link. E.g. consider\n\n```\n#include <math.h>\n#include <complex.h>\n#include <stdio.h>\nint main()\n{\n        double e=exp2(2.0);\n        double complex c=clog(2.0);\n        printf(\"\\n e=%f\\n\", e);\n        printf(\"\\n c=%f + i%f\\n\", creal(c), cimag(c));\n        return 0;\n}\n```\n\nWith two different `libm`'s, I don't see a way to create a working executable (with clang). However if I rename\ncephes' `libm` to `libm_complex` then (from SAGE_ROOT) the result of \n\n```\ncc -I./local/include t.c -lm -L./local/lib -lm_complex -Wl,-rpath=./local/lib\n```\n \nworks just fine.",
    "created_at": "2017-03-28T08:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312623",
    "user": "dimpase"
}
```

Question to linking experts:

I am not sure whether letting cephes create `libm.so` rather than something like `libm_complex.so` is a good idea. At least I do not see how one can in such a configuration link an executable that needs things from the "normal" `libm` as well as from cephes---in particular as Sage has moved away from using things like `LD_LIBRARY_PATH` to using `-rpath` to link. E.g. consider

```
#include <math.h>
#include <complex.h>
#include <stdio.h>
int main()
{
        double e=exp2(2.0);
        double complex c=clog(2.0);
        printf("\n e=%f\n", e);
        printf("\n c=%f + i%f\n", creal(c), cimag(c));
        return 0;
}
```

With two different `libm`'s, I don't see a way to create a working executable (with clang). However if I rename
cephes' `libm` to `libm_complex` then (from SAGE_ROOT) the result of 

```
cc -I./local/include t.c -lm -L./local/lib -lm_complex -Wl,-rpath=./local/lib
```
 
works just fine.



---

archive/issue_comments_312624.json:
```json
{
    "body": "Replying to [comment:22 dimpase]:\n> Question to linking experts:\n> \n> I am not sure whether letting cephes create `libm.so` rather than something like `libm_complex.so` is a good idea. At least I do not see how one can in such a configuration link an executable that needs things from the \"normal\" `libm` as well as from cephes---in particular as Sage has moved away from using things like `LD_LIBRARY_PATH` to using `-rpath` to link. E.g. consider\n> {{{\n> #include <math.h>\n> #include <complex.h>\n> #include <stdio.h>\n> int main()\n> {\n>         double e=exp2(2.0);\n>         double complex c=clog(2.0);\n>         printf(\"\\n e=%f\\n\", e);\n>         printf(\"\\n c=%f + i%f\\n\", creal(c), cimag(c));\n>         return 0;\n> }\n> }}}\n> With two different `libm`'s, I don't see a way to create a working executable (with clang). However if I rename\n> cephes' `libm` to `libm_complex` then (from SAGE_ROOT) the result of \n> {{{\n> cc -I./local/include t.c -lm -L./local/lib -lm_complex -Wl,-rpath=./local/lib\n> }}} \n> works just fine.\n\nI am not entirely sure because I think freeBSD doesn't use sonames. But linking with two shared libraries of the same name is at best awkward. The linker can take `-lm` several times and several paths with `-L`, not a problem. The problem is at runtime. Let's see an elf shared object on linux, say openblas:\n\n```\nfbissey@moonloop ~ $ readelf -d /usr/lib64/libopenblas_threads_haswellp-r0.2.15.so\n\nDynamic section at offset 0x3e3b60 contains 27 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libopenblas_threads.so.0]\n 0x000000000000000c (INIT)               0x2ab38\n....\n```\n\nThe linker effectively create a table of libraries to be loaded at runtime. It also can include runtime path to search first before the normal order from `ld.so.conf`. But you see that if two libraries have strictly the same name the first one to be found will be the only one used.\n\nIf you link a library the linker may not complain if it cannot resolve some symbols because it cannot combine the two `libm.so`. Undefined symbols are legal in a library. It is not in an executable. I am not quite sure in that case if the linker can even see the two different set of symbols at the same time. In any case you will still have the problem at run time.\n\nApart from different name the only way out is to have one of the two being static instead of dynamic and then you pass it to the linker as an object with its full path (not just `-L$path -lm` but `$path/libm.a`).",
    "created_at": "2017-03-28T09:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312624",
    "user": "fbissey"
}
```

Replying to [comment:22 dimpase]:
> Question to linking experts:
> 
> I am not sure whether letting cephes create `libm.so` rather than something like `libm_complex.so` is a good idea. At least I do not see how one can in such a configuration link an executable that needs things from the "normal" `libm` as well as from cephes---in particular as Sage has moved away from using things like `LD_LIBRARY_PATH` to using `-rpath` to link. E.g. consider
> {{{
> #include <math.h>
> #include <complex.h>
> #include <stdio.h>
> int main()
> {
>         double e=exp2(2.0);
>         double complex c=clog(2.0);
>         printf("\n e=%f\n", e);
>         printf("\n c=%f + i%f\n", creal(c), cimag(c));
>         return 0;
> }
> }}}
> With two different `libm`'s, I don't see a way to create a working executable (with clang). However if I rename
> cephes' `libm` to `libm_complex` then (from SAGE_ROOT) the result of 
> {{{
> cc -I./local/include t.c -lm -L./local/lib -lm_complex -Wl,-rpath=./local/lib
> }}} 
> works just fine.

I am not entirely sure because I think freeBSD doesn't use sonames. But linking with two shared libraries of the same name is at best awkward. The linker can take `-lm` several times and several paths with `-L`, not a problem. The problem is at runtime. Let's see an elf shared object on linux, say openblas:

```
fbissey@moonloop ~ $ readelf -d /usr/lib64/libopenblas_threads_haswellp-r0.2.15.so

Dynamic section at offset 0x3e3b60 contains 27 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libopenblas_threads.so.0]
 0x000000000000000c (INIT)               0x2ab38
....
```

The linker effectively create a table of libraries to be loaded at runtime. It also can include runtime path to search first before the normal order from `ld.so.conf`. But you see that if two libraries have strictly the same name the first one to be found will be the only one used.

If you link a library the linker may not complain if it cannot resolve some symbols because it cannot combine the two `libm.so`. Undefined symbols are legal in a library. It is not in an executable. I am not quite sure in that case if the linker can even see the two different set of symbols at the same time. In any case you will still have the problem at run time.

Apart from different name the only way out is to have one of the two being static instead of dynamic and then you pass it to the linker as an object with its full path (not just `-L$path -lm` but `$path/libm.a`).



---

archive/issue_comments_312625.json:
```json
{
    "body": "Replying to [comment:23 fbissey]:\n> If you link a library the linker may not complain if it cannot resolve some symbols because it cannot combine the two `libm.so`. Undefined symbols are legal in a library. It is not in an executable. I am not quite sure in that case if the linker can even see the two different set of symbols at the same time. In any case you will still have the problem at run time.\n\nThere is no `/lib/libm.so`, only `/lib/libm.so.5`.\n\nI think the idea at the time of old Sage port to FreeBSD (#9543) was that `$SAGE_LOCAL/lib/libm.so` serves as a replacement for system's `libm`.\nBut it seems that even though the former (renamed) is linked to the latter, \n\n```\n$ ldd local/lib/libm_complex.so \nlocal/lib/libm_complex.so:\n        libc.so.7 => /lib/libc.so.7 (0x800823000)\n        libm.so.5 => /lib/libm.so.5 (0x80120c000)\n\n```\n\nthis still leads to\nugly linker errors complaining about absent `exp2`. More specifically, if I remove `-lm` from the invocation above I get\n\n```\n$ cc -I./local/include t.c -L./local/lib -lm_complex -Wl,-rpath=./local/lib\n\n/usr/bin/ld: undefined reference to symbol `exp2@@FBSD_1.0' (try adding -lm)\n//lib/libm.so.5: could not read symbols: Bad value\n```\n\n(the latter is puzzling - it knows where to look for `exp2`, but bails out...)\n\n\n \n> \n> Apart from different name the only way out is to have one of the two being static instead of dynamic and then you pass it to the linker as an object with its full path (not just `-L$path -lm` but `$path/libm.a`).\n\nthis is not really better than creating a separate dynamic library, IMHO.",
    "created_at": "2017-03-28T10:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312625",
    "user": "dimpase"
}
```

Replying to [comment:23 fbissey]:
> If you link a library the linker may not complain if it cannot resolve some symbols because it cannot combine the two `libm.so`. Undefined symbols are legal in a library. It is not in an executable. I am not quite sure in that case if the linker can even see the two different set of symbols at the same time. In any case you will still have the problem at run time.

There is no `/lib/libm.so`, only `/lib/libm.so.5`.

I think the idea at the time of old Sage port to FreeBSD (#9543) was that `$SAGE_LOCAL/lib/libm.so` serves as a replacement for system's `libm`.
But it seems that even though the former (renamed) is linked to the latter, 

```
$ ldd local/lib/libm_complex.so 
local/lib/libm_complex.so:
        libc.so.7 => /lib/libc.so.7 (0x800823000)
        libm.so.5 => /lib/libm.so.5 (0x80120c000)

```

this still leads to
ugly linker errors complaining about absent `exp2`. More specifically, if I remove `-lm` from the invocation above I get

```
$ cc -I./local/include t.c -L./local/lib -lm_complex -Wl,-rpath=./local/lib

/usr/bin/ld: undefined reference to symbol `exp2@@FBSD_1.0' (try adding -lm)
//lib/libm.so.5: could not read symbols: Bad value
```

(the latter is puzzling - it knows where to look for `exp2`, but bails out...)


 
> 
> Apart from different name the only way out is to have one of the two being static instead of dynamic and then you pass it to the linker as an object with its full path (not just `-L$path -lm` but `$path/libm.a`).

this is not really better than creating a separate dynamic library, IMHO.



---

archive/issue_comments_312626.json:
```json
{
    "body": "Is `/lib/libm.so.5` a real library? What does running `file` on it says?",
    "created_at": "2017-03-28T10:18:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312626",
    "user": "fbissey"
}
```

Is `/lib/libm.so.5` a real library? What does running `file` on it says?



---

archive/issue_comments_312627.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> Is `/lib/libm.so.5` a real library? What does running `file` on it says?\n\n```\n$ file /lib/libm.so.5 \n/lib/libm.so.5: ELF 64-bit LSB shared object, x86-64, version 1 (FreeBSD), dynamically linked, stripped\n```\n",
    "created_at": "2017-03-28T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312627",
    "user": "dimpase"
}
```

Replying to [comment:25 fbissey]:
> Is `/lib/libm.so.5` a real library? What does running `file` on it says?

```
$ file /lib/libm.so.5 
/lib/libm.so.5: ELF 64-bit LSB shared object, x86-64, version 1 (FreeBSD), dynamically linked, stripped
```




---

archive/issue_comments_312628.json:
```json
{
    "body": "OK that leaves us with the next stupid question: are you compiling in 32bits? Finally can you move `-lm` after `-lm_complex`?",
    "created_at": "2017-03-28T11:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312628",
    "user": "fbissey"
}
```

OK that leaves us with the next stupid question: are you compiling in 32bits? Finally can you move `-lm` after `-lm_complex`?



---

archive/issue_comments_312629.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> OK that leaves us with the next stupid question: are you compiling in 32bits? Finally can you move `-lm` after `-lm_complex`?\n\nit's 64-bit, and yes, I can build and run the result of\n\n```\n$ cc -I./local/include t.c -L./local/lib -lm_complex -lm -Wl,-rpath=./local/lib\n```\n\njust fine.\n\nCertainly, having a new library to add, instead of providing a replacement for libm, is a pain, although a limited to few packages one.",
    "created_at": "2017-03-28T11:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312629",
    "user": "dimpase"
}
```

Replying to [comment:27 fbissey]:
> OK that leaves us with the next stupid question: are you compiling in 32bits? Finally can you move `-lm` after `-lm_complex`?

it's 64-bit, and yes, I can build and run the result of

```
$ cc -I./local/include t.c -L./local/lib -lm_complex -lm -Wl,-rpath=./local/lib
```

just fine.

Certainly, having a new library to add, instead of providing a replacement for libm, is a pain, although a limited to few packages one.



---

archive/issue_comments_312630.json:
```json
{
    "body": "`--as-needed` is probably your default behavior which means order is important. I suspect you are using the \"gold\" linker instead of the \"bfd\" (classic) one [don't remember how to check for that]. Short of passing `-Wl,--no-as-needed` I don't know how to make the order irrelevant.",
    "created_at": "2017-03-28T11:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312630",
    "user": "fbissey"
}
```

`--as-needed` is probably your default behavior which means order is important. I suspect you are using the "gold" linker instead of the "bfd" (classic) one [don't remember how to check for that]. Short of passing `-Wl,--no-as-needed` I don't know how to make the order irrelevant.



---

archive/issue_comments_312631.json:
```json
{
    "body": "Just a reminder that https://svnweb.freebsd.org/ports/head/math/sage/ used to be maintained.\nMaybe some stuff can be pulled from there.",
    "created_at": "2017-03-28T11:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312631",
    "user": "jpflori"
}
```

Just a reminder that https://svnweb.freebsd.org/ports/head/math/sage/ used to be maintained.
Maybe some stuff can be pulled from there.



---

archive/issue_comments_312632.json:
```json
{
    "body": "See also #12858, #14651, #14392 and in general [this report](https://trac.sagemath.org/query?status=!closed&component=porting%3A+BSD).  I'm sure username stephen would be happy to help but we didn't really take much stuff in terms of patches lately so perhaps that is why it was no longer maintained.",
    "created_at": "2017-03-28T13:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312632",
    "user": "kcrisman"
}
```

See also #12858, #14651, #14392 and in general [this report](https://trac.sagemath.org/query?status=!closed&component=porting%3A+BSD).  I'm sure username stephen would be happy to help but we didn't really take much stuff in terms of patches lately so perhaps that is why it was no longer maintained.



---

archive/issue_comments_312633.json:
```json
{
    "body": "Replying to [comment:30 jpflori]:\n> Just a reminder that https://svnweb.freebsd.org/ports/head/math/sage/ used to be maintained.\n> Maybe some stuff can be pulled from there.\nthey have there (as well as in #14491) an `ld` wrapper that uses `--copy-dt-needed-entries` option to\nrecursively search libraries. And indeed the following (with the \"classical\" GNU buntils ld) gives working `a.out`.\n\n```\n$ cc -c -I./local/include t.c\n$ /usr/local/bin/ld --eh-frame-hdr -dynamic-linker /libexec/ld-elf.so.1 -L./local/lib --copy-dt-needed-entries -rpath=./local/lib /usr/lib/crt1.o /usr/lib/crti.o t.o -lc -lm_complex /usr/lib/crtn.o\n```\n\n\nBut this option has a different name with the default linker, as far as testing and manuals say.\n\n```\n/usr/bin/ld: unrecognized option '--copy-dt-needed-entries'\n```\n\nThe reason is that the default linker used by clang is\n\n```\n$ /usr/bin/ld -v\nGNU ld 2.17.50 [FreeBSD] 2007-07-03\n```\n\n\nThe corresponding option is called `--add-needed`. (It's possible to find this by calling `/usr/bin/ld --help`.) So the right command (giving working `a.out`) to pull system's `libm` with the custom (renamed to `libm_complex`) `libm` is\n\n```\ncc -I./local/include -L./local/lib -Wl,--add-needed -Wl,-rpath=./local/lib -lm_complex t.c\n```\n",
    "created_at": "2017-03-28T13:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312633",
    "user": "dimpase"
}
```

Replying to [comment:30 jpflori]:
> Just a reminder that https://svnweb.freebsd.org/ports/head/math/sage/ used to be maintained.
> Maybe some stuff can be pulled from there.
they have there (as well as in #14491) an `ld` wrapper that uses `--copy-dt-needed-entries` option to
recursively search libraries. And indeed the following (with the "classical" GNU buntils ld) gives working `a.out`.

```
$ cc -c -I./local/include t.c
$ /usr/local/bin/ld --eh-frame-hdr -dynamic-linker /libexec/ld-elf.so.1 -L./local/lib --copy-dt-needed-entries -rpath=./local/lib /usr/lib/crt1.o /usr/lib/crti.o t.o -lc -lm_complex /usr/lib/crtn.o
```


But this option has a different name with the default linker, as far as testing and manuals say.

```
/usr/bin/ld: unrecognized option '--copy-dt-needed-entries'
```

The reason is that the default linker used by clang is

```
$ /usr/bin/ld -v
GNU ld 2.17.50 [FreeBSD] 2007-07-03
```


The corresponding option is called `--add-needed`. (It's possible to find this by calling `/usr/bin/ld --help`.) So the right command (giving working `a.out`) to pull system's `libm` with the custom (renamed to `libm_complex`) `libm` is

```
cc -I./local/include -L./local/lib -Wl,--add-needed -Wl,-rpath=./local/lib -lm_complex t.c
```




---

archive/issue_comments_312634.json:
```json
{
    "body": "Replying to [comment:29 fbissey]:\n> `--as-needed` is probably your default behavior which means order is important. I suspect you are using the \"gold\" linker instead of the \"bfd\" (classic) one [don't remember how to check for that]. Short of passing `-Wl,--no-as-needed` I don't know how to make the order irrelevant.\n\nHave a look at `library_order_list` in `src/module_list.py` to deal with ordering of libraries.",
    "created_at": "2017-03-28T13:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312634",
    "user": "jdemeyer"
}
```

Replying to [comment:29 fbissey]:
> `--as-needed` is probably your default behavior which means order is important. I suspect you are using the "gold" linker instead of the "bfd" (classic) one [don't remember how to check for that]. Short of passing `-Wl,--no-as-needed` I don't know how to make the order irrelevant.

Have a look at `library_order_list` in `src/module_list.py` to deal with ordering of libraries.



---

archive/issue_comments_312635.json:
```json
{
    "body": "Somewhat ironically, `numpy` now conflics with cephes (via `<complex.h>` header), as it adapted some FreeBSD code by `stephen` for its use in complex arithmetic. :-)\nFortunately, it appears to be only the header-level conflict.",
    "created_at": "2017-03-28T14:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312635",
    "user": "dimpase"
}
```

Somewhat ironically, `numpy` now conflics with cephes (via `<complex.h>` header), as it adapted some FreeBSD code by `stephen` for its use in complex arithmetic. :-)
Fortunately, it appears to be only the header-level conflict.



---

archive/issue_comments_312636.json:
```json
{
    "body": "running make as follows\n\n```\nLDFLAGS=\"-L./local/lib -Wl,--add-needed -lm\" $MAKE build\n```\n\nallows the build do finish, and pass many tests. Some of docbuilding crashes with rather puzzling (most probably related to multi-processing/threading) errors like\n\n```\n[dochtml] [hyperboli] loading pickled environment... not yet created\n[dochtml] \n[dochtml] Internal or unrecoverable error in:\n[dochtml] Got signal before environment was installed on our thread\n[dochtml]   [2: No such file or directory]\n[dochtml] \n[dochtml] ;;; ECL C Backtrace\n[dochtml] ;;;    0 ecl_internal_error (0x89a790705) \n[dochtml] ;;;    1 init_unixint (0x89a7b6b70) \n[dochtml] ;;;    2 init_unixint (0x89a7b6912) \n[dochtml] ;;;    3 pthread_sigmask (0x80105779d) \n[dochtml] ;;;    4 pthread_getspecific (0x801056d6f) \n[dochtml] ;;;    5 unknown (0x7ffffffff193) \n[dochtml] ;;;    6 GC_push_all_stacks (0x89ab1b7aa) \n[dochtml] ;;;    7 GC_mark_some (0x89ab10a93) \n[dochtml] ;;;    8 GC_stopped_mark (0x89ab08b3a) \n[dochtml] ;;;    9 GC_try_to_collect_inner (0x89ab08a31) \n[dochtml] ;;;   10 GC_init (0x89ab14593) \n[dochtml] ;;;   11 init_alloc (0x89a7ca9f9) \n[dochtml] ;;;   12 cl_boot (0x89a694a4b) \n[dochtml] ;;;   13 initecl (0x89a218bc0) \n[dochtml] ;;;   14 initecl (0x89a20a9f5) \n[dochtml] ;;;   15 initecl (0x89a208678) \n[dochtml] ;;;   16 _PyImport_LoadDynamicModule (0x8009334fc) \n[dochtml] ;;;   17 PyImport_AppendInittab (0x800931eff) \n[dochtml] ;;;   18 PyImport_AppendInittab (0x8009319b4) \n[dochtml] ;;;   19 PyImport_ImportModuleLevel (0x800930abe) \n[dochtml] ;;;   20 _PyBuiltin_Init (0x80090b187) \n[dochtml] ;;;   21 PyObject_Call (0x800871454) \n[dochtml] ;;;   22 PyEval_EvalFrameEx (0x800915f47) \n[dochtml] ;;;   23 PyEval_EvalCodeEx (0x800910505) \n[dochtml] ;;;   24 PyEval_EvalCode (0x80090fcd6) \n[dochtml] ;;;   25 PyImport_ExecCodeModuleEx (0x80092f521) \n[dochtml] ;;;   26 PyImport_AppendInittab (0x800932598) \n[dochtml] ;;;   27 PyImport_AppendInittab (0x800931eff) \n[dochtml] ;;;   28 PyImport_AppendInittab (0x8009319b4) \n[dochtml] ;;;   29 PyImport_ImportModuleLevel (0x800930abe) \n[dochtml] ;;;   30 _PyBuiltin_Init (0x80090b187) \n[dochtml] ;;;   31 PyEval_EvalFrameEx (0x800917ab0) \n```\n\n\nbuilding docs with make -j1 works. Running tests now.",
    "created_at": "2017-03-28T15:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312636",
    "user": "dimpase"
}
```

running make as follows

```
LDFLAGS="-L./local/lib -Wl,--add-needed -lm" $MAKE build
```

allows the build do finish, and pass many tests. Some of docbuilding crashes with rather puzzling (most probably related to multi-processing/threading) errors like

```
[dochtml] [hyperboli] loading pickled environment... not yet created
[dochtml] 
[dochtml] Internal or unrecoverable error in:
[dochtml] Got signal before environment was installed on our thread
[dochtml]   [2: No such file or directory]
[dochtml] 
[dochtml] ;;; ECL C Backtrace
[dochtml] ;;;    0 ecl_internal_error (0x89a790705) 
[dochtml] ;;;    1 init_unixint (0x89a7b6b70) 
[dochtml] ;;;    2 init_unixint (0x89a7b6912) 
[dochtml] ;;;    3 pthread_sigmask (0x80105779d) 
[dochtml] ;;;    4 pthread_getspecific (0x801056d6f) 
[dochtml] ;;;    5 unknown (0x7ffffffff193) 
[dochtml] ;;;    6 GC_push_all_stacks (0x89ab1b7aa) 
[dochtml] ;;;    7 GC_mark_some (0x89ab10a93) 
[dochtml] ;;;    8 GC_stopped_mark (0x89ab08b3a) 
[dochtml] ;;;    9 GC_try_to_collect_inner (0x89ab08a31) 
[dochtml] ;;;   10 GC_init (0x89ab14593) 
[dochtml] ;;;   11 init_alloc (0x89a7ca9f9) 
[dochtml] ;;;   12 cl_boot (0x89a694a4b) 
[dochtml] ;;;   13 initecl (0x89a218bc0) 
[dochtml] ;;;   14 initecl (0x89a20a9f5) 
[dochtml] ;;;   15 initecl (0x89a208678) 
[dochtml] ;;;   16 _PyImport_LoadDynamicModule (0x8009334fc) 
[dochtml] ;;;   17 PyImport_AppendInittab (0x800931eff) 
[dochtml] ;;;   18 PyImport_AppendInittab (0x8009319b4) 
[dochtml] ;;;   19 PyImport_ImportModuleLevel (0x800930abe) 
[dochtml] ;;;   20 _PyBuiltin_Init (0x80090b187) 
[dochtml] ;;;   21 PyObject_Call (0x800871454) 
[dochtml] ;;;   22 PyEval_EvalFrameEx (0x800915f47) 
[dochtml] ;;;   23 PyEval_EvalCodeEx (0x800910505) 
[dochtml] ;;;   24 PyEval_EvalCode (0x80090fcd6) 
[dochtml] ;;;   25 PyImport_ExecCodeModuleEx (0x80092f521) 
[dochtml] ;;;   26 PyImport_AppendInittab (0x800932598) 
[dochtml] ;;;   27 PyImport_AppendInittab (0x800931eff) 
[dochtml] ;;;   28 PyImport_AppendInittab (0x8009319b4) 
[dochtml] ;;;   29 PyImport_ImportModuleLevel (0x800930abe) 
[dochtml] ;;;   30 _PyBuiltin_Init (0x80090b187) 
[dochtml] ;;;   31 PyEval_EvalFrameEx (0x800917ab0) 
```


building docs with make -j1 works. Running tests now.



---

archive/issue_comments_312637.json:
```json
{
    "body": "\"interesting\" error message: 10 such errors, leading to segfaults in total in testlong, all related to\n(un)picklings and libpng. What the meaning of \"Application\" in these messages? And what is the reason? Missing or wrong `-I` option for the compiler?\n\n```\nsage -t --long src/sage/coding/binary_code.pyx\n    Killed due to segmentation fault\n...\nsage: from sage.coding.binary_code import * ## line 824 ##\nsage: M = Matrix(GF(2), [[1,1,1,1]]) ## line 825 ##\nsage: B = BinaryCode(M) ## line 826 ##\nsage: loads(dumps(B)) == B ## line 827 ##\nlibpng warning: Application was compiled with png.h from libpng-1.6.27+apng\nlibpng warning: Application  is  running with png.c from libpng-1.2.51\nGD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library\n```\n\n\nThe rest---for the early days like this---looks not too bad, apart from code related to elliptic curves (probably another well-localised bug, only not quite clear where):\n\n```\nsage/coding/binary_code.pyx  # Killed due to segmentation fault\nsage/coding/linear_code.py  # Killed due to segmentation fault\nsage/crypto/mq/sr.py  # Killed due to segmentation fault\nsage/graphs/generic_graph.py  # Killed due to segmentation fault\nsage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault\nsage/homology/chain_complex.py  # Killed due to illegal instruction\nsage/interfaces/mwrank.py  # 5 doctests failed\nsage/interfaces/singular.py  # 2 doctests failed\nsage/interfaces/tests.py  # 1 doctest failed\nsage/lfunctions/sympow.py  # 4 doctests failed\nsage/libs/eclib/interface.py  # 34 doctests failed\nsage/libs/eclib/mwrank.pyx  # 3 doctests failed\nsage/matrix/matrix_gf2e_dense.pyx  # Killed due to segmentation fault\nsage/matrix/matrix_mod2_dense.pyx  # Killed due to segmentation fault\nsage/misc/benchmark.py  # 3 doctests failed\nsage/numerical/sdp.pyx  # 1 doctest failed\nsage/plot/graphics.py  # 1 doctest failed\nsage/plot/plot.py  # 1 doctest failed\nsage/rings/complex_double.pyx  # 2 doctests failed\nsage/rings/padics/CR_template.pxi  # 2 doctests failed\nsage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to segmentation fault\nsage/rings/polynomial/pbori.pyx  # Killed due to abort\nsage/rings/polynomial/polydict.pyx  # 1 doctest failed\nsage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed\nsage/schemes/elliptic_curves/BSD.py  # 23 doctests failed\nsage/schemes/elliptic_curves/constructor.py  # 11 doctests failed\nsage/schemes/elliptic_curves/ell_egros.py  # 9 doctests failed\nsage/schemes/elliptic_curves/ell_generic.py  # 14 doctests failed\nsage/schemes/elliptic_curves/ell_number_field.py  # 16 doctests failed\nsage/schemes/elliptic_curves/ell_point.py  # 13 doctests failed\nsage/schemes/elliptic_curves/ell_rational_field.py  # Timed out\nsage/schemes/elliptic_curves/ell_tate_curve.py  # 4 doctests failed\nsage/schemes/elliptic_curves/heegner.py  # 48 doctests failed\nsage/schemes/elliptic_curves/height.py  # 2 doctests failed\nsage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed\nsage/schemes/elliptic_curves/padic_lseries.py  # 2 doctests failed\nsage/schemes/elliptic_curves/padics.py  # 34 doctests failed \nsage/schemes/elliptic_curves/sha_tate.py  # Killed due to segmentation fault\nsage/structure/coerce.pyx  # 1 doctest failed\nsage/structure/element.pyx  # 1 doctest failed\nsage/structure/sage_object.pyx  # Killed due to bus error\nsage/tests/benchmark.py  # 1 doctest failed\nsage/tests/book_stein_ent.py  # 3 doctests failed\nsage/tests/cmdline.py  # 3 doctests failed\ndoc/en/constructions/algebraic_geometry.rst  # 1 doctest failed\ndoc/en/developer/coding_basics.rst  # 1 doctest failed\ndoc/en/developer/coding_in_other.rst  # 1 doctest failed\ndoc/en/prep/Calculus.rst  # 1 doctest failed\ndoc/en/thematic_tutorials/explicit_methods_in_number_theory/elliptic_curves.rst  # 11 doctests failed\n```\n",
    "created_at": "2017-03-28T19:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312637",
    "user": "dimpase"
}
```

"interesting" error message: 10 such errors, leading to segfaults in total in testlong, all related to
(un)picklings and libpng. What the meaning of "Application" in these messages? And what is the reason? Missing or wrong `-I` option for the compiler?

```
sage -t --long src/sage/coding/binary_code.pyx
    Killed due to segmentation fault
...
sage: from sage.coding.binary_code import * ## line 824 ##
sage: M = Matrix(GF(2), [[1,1,1,1]]) ## line 825 ##
sage: B = BinaryCode(M) ## line 826 ##
sage: loads(dumps(B)) == B ## line 827 ##
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
libpng warning: Application  is  running with png.c from libpng-1.2.51
GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library
```


The rest---for the early days like this---looks not too bad, apart from code related to elliptic curves (probably another well-localised bug, only not quite clear where):

```
sage/coding/binary_code.pyx  # Killed due to segmentation fault
sage/coding/linear_code.py  # Killed due to segmentation fault
sage/crypto/mq/sr.py  # Killed due to segmentation fault
sage/graphs/generic_graph.py  # Killed due to segmentation fault
sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault
sage/homology/chain_complex.py  # Killed due to illegal instruction
sage/interfaces/mwrank.py  # 5 doctests failed
sage/interfaces/singular.py  # 2 doctests failed
sage/interfaces/tests.py  # 1 doctest failed
sage/lfunctions/sympow.py  # 4 doctests failed
sage/libs/eclib/interface.py  # 34 doctests failed
sage/libs/eclib/mwrank.pyx  # 3 doctests failed
sage/matrix/matrix_gf2e_dense.pyx  # Killed due to segmentation fault
sage/matrix/matrix_mod2_dense.pyx  # Killed due to segmentation fault
sage/misc/benchmark.py  # 3 doctests failed
sage/numerical/sdp.pyx  # 1 doctest failed
sage/plot/graphics.py  # 1 doctest failed
sage/plot/plot.py  # 1 doctest failed
sage/rings/complex_double.pyx  # 2 doctests failed
sage/rings/padics/CR_template.pxi  # 2 doctests failed
sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to segmentation fault
sage/rings/polynomial/pbori.pyx  # Killed due to abort
sage/rings/polynomial/polydict.pyx  # 1 doctest failed
sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed
sage/schemes/elliptic_curves/BSD.py  # 23 doctests failed
sage/schemes/elliptic_curves/constructor.py  # 11 doctests failed
sage/schemes/elliptic_curves/ell_egros.py  # 9 doctests failed
sage/schemes/elliptic_curves/ell_generic.py  # 14 doctests failed
sage/schemes/elliptic_curves/ell_number_field.py  # 16 doctests failed
sage/schemes/elliptic_curves/ell_point.py  # 13 doctests failed
sage/schemes/elliptic_curves/ell_rational_field.py  # Timed out
sage/schemes/elliptic_curves/ell_tate_curve.py  # 4 doctests failed
sage/schemes/elliptic_curves/heegner.py  # 48 doctests failed
sage/schemes/elliptic_curves/height.py  # 2 doctests failed
sage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed
sage/schemes/elliptic_curves/padic_lseries.py  # 2 doctests failed
sage/schemes/elliptic_curves/padics.py  # 34 doctests failed 
sage/schemes/elliptic_curves/sha_tate.py  # Killed due to segmentation fault
sage/structure/coerce.pyx  # 1 doctest failed
sage/structure/element.pyx  # 1 doctest failed
sage/structure/sage_object.pyx  # Killed due to bus error
sage/tests/benchmark.py  # 1 doctest failed
sage/tests/book_stein_ent.py  # 3 doctests failed
sage/tests/cmdline.py  # 3 doctests failed
doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed
doc/en/developer/coding_basics.rst  # 1 doctest failed
doc/en/developer/coding_in_other.rst  # 1 doctest failed
doc/en/prep/Calculus.rst  # 1 doctest failed
doc/en/thematic_tutorials/explicit_methods_in_number_theory/elliptic_curves.rst  # 11 doctests failed
```




---

archive/issue_comments_312638.json:
```json
{
    "body": "libpng-related segfaults are \"cured\" by #22159 ; this is of course fixing the symptom, not the root cause---as #22159 happens to carry the same version of libpng as the system-wide version.",
    "created_at": "2017-03-28T23:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312638",
    "user": "dimpase"
}
```

libpng-related segfaults are "cured" by #22159 ; this is of course fixing the symptom, not the root cause---as #22159 happens to carry the same version of libpng as the system-wide version.



---

archive/issue_comments_312639.json:
```json
{
    "body": "It is strange I would have expected runpath to cover you for that. If runpath don't allow to load a library other than the one in the system default location, what's the point? \"Application\" looks like it is coming from inside libpng itself, so that's an helpful message from png devs.\n\nDo you have `readelf` available? If so could we have a look at `readelf -d local/lib/python/site-packages/sage/coding/binary_code.so` when it is in a failing state?",
    "created_at": "2017-03-28T23:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312639",
    "user": "fbissey"
}
```

It is strange I would have expected runpath to cover you for that. If runpath don't allow to load a library other than the one in the system default location, what's the point? "Application" looks like it is coming from inside libpng itself, so that's an helpful message from png devs.

Do you have `readelf` available? If so could we have a look at `readelf -d local/lib/python/site-packages/sage/coding/binary_code.so` when it is in a failing state?



---

archive/issue_comments_312640.json:
```json
{
    "body": "after applying #22159 branch, I got\n\n```\nsage/crypto/mq/sr.py  # 7 doctests failed\nsage/interfaces/mwrank.py  # 5 doctests failed\nsage/interfaces/singular.py  # 2 doctests failed\nsage/interfaces/tests.py  # 1 doctest failed\nsage/lfunctions/sympow.py  # 4 doctests failed\nsage/libs/eclib/interface.py  # 34 doctests failed\nsage/libs/eclib/mwrank.pyx  # 3 doctests failed \nsage/misc/benchmark.py  # 3 doctests failed  \nsage/numerical/sdp.pyx  # 1 doctest failed\nsage/plot/graphics.py  # 1 doctest failed\nsage/plot/plot.py  # 1 doctest failed\nsage/rings/complex_double.pyx  # 2 doctests failed\nsage/rings/padics/CR_template.pxi  # 2 doctests failed \nsage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to segmentation fault\nsage/rings/polynomial/pbori.pyx  # Killed due to abort\nsage/rings/polynomial/polydict.pyx  # 1 doctest failed\nsage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed\nsage/schemes/elliptic_curves/BSD.py  # 23 doctests failed\nsage/schemes/elliptic_curves/constructor.py  # 11 doctests failed\nsage/schemes/elliptic_curves/ell_egros.py  # 9 doctests failed\nsage/schemes/elliptic_curves/ell_generic.py  # 14 doctests failed\nsage/schemes/elliptic_curves/ell_number_field.py  # 16 doctests failed\nsage/schemes/elliptic_curves/ell_point.py  # 13 doctests failed \nsage/schemes/elliptic_curves/ell_rational_field.py  # 61 doctests failed\nsage/schemes/elliptic_curves/ell_tate_curve.py  # 4 doctests failed\nsage/schemes/elliptic_curves/heegner.py  # 48 doctests failed\nsage/schemes/elliptic_curves/height.py  # 2 doctests failed\nsage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed\nsage/schemes/elliptic_curves/padic_lseries.py  # 2 doctests failed \nsage/schemes/elliptic_curves/padics.py  # 34 doctests failed\nsage/schemes/elliptic_curves/sha_tate.py  # Killed due to segmentation fault\nsage/structure/coerce.pyx  # 1 doctest failed\nsage/structure/element.pyx  # 1 doctest failed\nsage/structure/sage_object.pyx  # Killed due to abort\nsage/tests/benchmark.py  # 1 doctest failed\nsage/tests/book_stein_ent.py  # 3 doctests failed \nsage/tests/cmdline.py  # 3 doctests failed\ndoc/en/constructions/algebraic_geometry.rst  # 1 doctest failed\ndoc/en/developer/coding_basics.rst  # 1 doctest failed\ndoc/en/prep/Calculus.rst  # 1 doctest failed\ndoc/en/thematic_tutorials/explicit_methods_in_number_theory/elliptic_curves.rst  # 11 doctests failed\n```\n",
    "created_at": "2017-03-29T07:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312640",
    "user": "dimpase"
}
```

after applying #22159 branch, I got

```
sage/crypto/mq/sr.py  # 7 doctests failed
sage/interfaces/mwrank.py  # 5 doctests failed
sage/interfaces/singular.py  # 2 doctests failed
sage/interfaces/tests.py  # 1 doctest failed
sage/lfunctions/sympow.py  # 4 doctests failed
sage/libs/eclib/interface.py  # 34 doctests failed
sage/libs/eclib/mwrank.pyx  # 3 doctests failed 
sage/misc/benchmark.py  # 3 doctests failed  
sage/numerical/sdp.pyx  # 1 doctest failed
sage/plot/graphics.py  # 1 doctest failed
sage/plot/plot.py  # 1 doctest failed
sage/rings/complex_double.pyx  # 2 doctests failed
sage/rings/padics/CR_template.pxi  # 2 doctests failed 
sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to segmentation fault
sage/rings/polynomial/pbori.pyx  # Killed due to abort
sage/rings/polynomial/polydict.pyx  # 1 doctest failed
sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed
sage/schemes/elliptic_curves/BSD.py  # 23 doctests failed
sage/schemes/elliptic_curves/constructor.py  # 11 doctests failed
sage/schemes/elliptic_curves/ell_egros.py  # 9 doctests failed
sage/schemes/elliptic_curves/ell_generic.py  # 14 doctests failed
sage/schemes/elliptic_curves/ell_number_field.py  # 16 doctests failed
sage/schemes/elliptic_curves/ell_point.py  # 13 doctests failed 
sage/schemes/elliptic_curves/ell_rational_field.py  # 61 doctests failed
sage/schemes/elliptic_curves/ell_tate_curve.py  # 4 doctests failed
sage/schemes/elliptic_curves/heegner.py  # 48 doctests failed
sage/schemes/elliptic_curves/height.py  # 2 doctests failed
sage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed
sage/schemes/elliptic_curves/padic_lseries.py  # 2 doctests failed 
sage/schemes/elliptic_curves/padics.py  # 34 doctests failed
sage/schemes/elliptic_curves/sha_tate.py  # Killed due to segmentation fault
sage/structure/coerce.pyx  # 1 doctest failed
sage/structure/element.pyx  # 1 doctest failed
sage/structure/sage_object.pyx  # Killed due to abort
sage/tests/benchmark.py  # 1 doctest failed
sage/tests/book_stein_ent.py  # 3 doctests failed 
sage/tests/cmdline.py  # 3 doctests failed
doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed
doc/en/developer/coding_basics.rst  # 1 doctest failed
doc/en/prep/Calculus.rst  # 1 doctest failed
doc/en/thematic_tutorials/explicit_methods_in_number_theory/elliptic_curves.rst  # 11 doctests failed
```




---

archive/issue_comments_312641.json:
```json
{
    "body": "Replying to [comment:38 fbissey]:\n> It is strange I would have expected runpath to cover you for that. If runpath don't allow to load a library other than the one in the system default location, what's the point? \"Application\" looks like it is coming from inside libpng itself, so that's an helpful message from png devs.\n\nOK, I'll rebuild without #22159 and post the outputs of readelf and ldd. Anyway,\nwith #22159 I get\n\n```\n$ ldd local/lib/python/site-packages/sage/coding/binary_code.so\nlocal/lib/python/site-packages/sage/coding/binary_code.so:\n        libm.so => /usr/home/dima/Sage/sage/local/lib/libm.so (0x801256000)\n        libgmp.so.22 => /usr/home/dima/Sage/sage/local/lib/libgmp.so.22 (0x801462000)\n        libpython2.7.so.1 => /usr/home/dima/Sage/sage/local/lib/libpython2.7.so.1 (0x8016e6000)\n        libpari-gmp.so.5 => /usr/home/dima/Sage/sage/local/lib/libpari-gmp.so.5 (0x801c00000)\n        libthr.so.3 => /lib/libthr.so.3 (0x802678000)\n        libc.so.7 => /lib/libc.so.7 (0x800823000)\n        libm.so.5 => /lib/libm.so.5 (0x80289f000)\n        libutil.so.9 => /lib/libutil.so.9 (0x802aca000)\n\nreadelf:\n\n0x0000000000000001 (NEEDED)             Shared library: [libm.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.22]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp.so.5]\n 0x0000000000000001 (NEEDED)             Shared library: [libthr.so.3]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.7]\n 0x000000000000000f (RPATH)              Library rpath: [/usr/home/dima/Sage/sage/local/lib]\n 0x000000000000001d (RUNPATH)            Library runpath: [/usr/home/dima/Sage/sage/local/lib]\n```\n\n\nso there is no sign of `libpng` anywhere; I looked further in Python's dynamically loaded modules in `local/lib/python2.7/lib-dynload/`, but even there I do not see `libpng`.\n\nWhat does load it, and how? Is it a sort of dynamic loading (`dlopen`?) that is not recorded by the linker?\nWould one have to resort to analysing a dump or running under gdb? Uh-oh...",
    "created_at": "2017-03-29T07:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312641",
    "user": "dimpase"
}
```

Replying to [comment:38 fbissey]:
> It is strange I would have expected runpath to cover you for that. If runpath don't allow to load a library other than the one in the system default location, what's the point? "Application" looks like it is coming from inside libpng itself, so that's an helpful message from png devs.

OK, I'll rebuild without #22159 and post the outputs of readelf and ldd. Anyway,
with #22159 I get

```
$ ldd local/lib/python/site-packages/sage/coding/binary_code.so
local/lib/python/site-packages/sage/coding/binary_code.so:
        libm.so => /usr/home/dima/Sage/sage/local/lib/libm.so (0x801256000)
        libgmp.so.22 => /usr/home/dima/Sage/sage/local/lib/libgmp.so.22 (0x801462000)
        libpython2.7.so.1 => /usr/home/dima/Sage/sage/local/lib/libpython2.7.so.1 (0x8016e6000)
        libpari-gmp.so.5 => /usr/home/dima/Sage/sage/local/lib/libpari-gmp.so.5 (0x801c00000)
        libthr.so.3 => /lib/libthr.so.3 (0x802678000)
        libc.so.7 => /lib/libc.so.7 (0x800823000)
        libm.so.5 => /lib/libm.so.5 (0x80289f000)
        libutil.so.9 => /lib/libutil.so.9 (0x802aca000)

readelf:

0x0000000000000001 (NEEDED)             Shared library: [libm.so]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.22]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp.so.5]
 0x0000000000000001 (NEEDED)             Shared library: [libthr.so.3]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.7]
 0x000000000000000f (RPATH)              Library rpath: [/usr/home/dima/Sage/sage/local/lib]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/home/dima/Sage/sage/local/lib]
```


so there is no sign of `libpng` anywhere; I looked further in Python's dynamically loaded modules in `local/lib/python2.7/lib-dynload/`, but even there I do not see `libpng`.

What does load it, and how? Is it a sort of dynamic loading (`dlopen`?) that is not recorded by the linker?
Would one have to resort to analysing a dump or running under gdb? Uh-oh...



---

archive/issue_comments_312642.json:
```json
{
    "body": "1) note that it says `GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library` so we are talking about something using libgd.\n\n2) the error may not be in that file but in another part of sage that is called from that file.\n\nCheck `sage/matrix/matrix_mod2_dense.so`.",
    "created_at": "2017-03-29T08:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312642",
    "user": "fbissey"
}
```

1) note that it says `GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library` so we are talking about something using libgd.

2) the error may not be in that file but in another part of sage that is called from that file.

Check `sage/matrix/matrix_mod2_dense.so`.



---

archive/issue_comments_312643.json:
```json
{
    "body": "Actually there may even be a `gd-png` executable. I have the following executables installed by `gd`\n\n```\n/usr/bin/annotate\n/usr/bin/bdftogd\n/usr/bin/gd2copypal\n/usr/bin/gd2togif\n/usr/bin/gd2topng\n/usr/bin/gdcmpgif\n/usr/bin/gdlib-config\n/usr/bin/gdparttopng\n/usr/bin/gdtopng\n/usr/bin/giftogd2\n/usr/bin/pngtogd\n/usr/bin/pngtogd2\n/usr/bin/webpng\n```\n",
    "created_at": "2017-03-29T08:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312643",
    "user": "fbissey"
}
```

Actually there may even be a `gd-png` executable. I have the following executables installed by `gd`

```
/usr/bin/annotate
/usr/bin/bdftogd
/usr/bin/gd2copypal
/usr/bin/gd2togif
/usr/bin/gd2topng
/usr/bin/gdcmpgif
/usr/bin/gdlib-config
/usr/bin/gdparttopng
/usr/bin/gdtopng
/usr/bin/giftogd2
/usr/bin/pngtogd
/usr/bin/pngtogd2
/usr/bin/webpng
```




---

archive/issue_comments_312644.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-29T10:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312644",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312645.json:
```json
{
    "body": "Replying to [comment:41 fbissey]:\n> 1) note that it says `GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library` so we are talking about something using libgd.\n> \n> 2) the error may not be in that file but in another part of sage that is called from that file.\n> \n> Check `sage/matrix/matrix_mod2_dense.so`.\nOK, I've rebuilt with old (Sage's current) libpng:\n\n```\n$ ldd local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so\nlocal/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so:\n        libm.so => /usr/home/dima/Sage/sage/local/lib/libm.so (0x801255000)\n        libgmp.so.22 => /usr/home/dima/Sage/sage/local/lib/libgmp.so.22 (0x801461000)\n        libm4ri-0.0.20140914.so => /usr/home/dima/Sage/sage/local/lib/libm4ri-0.0.20140914.so (0x8016e5000)\n        libpng12.so.0 => /usr/home/dima/Sage/sage/local/lib/libpng12.so.0 (0x801917000)\n        libz.so => /usr/home/dima/Sage/sage/local/lib/libz.so (0x801b40000)\n        libpython2.7.so.1 => /usr/home/dima/Sage/sage/local/lib/libpython2.7.so.1 (0x801d57000)\n        libpari-gmp.so.5 => /usr/home/dima/Sage/sage/local/lib/libpari-gmp.so.5 (0x802200000)\n        libthr.so.3 => /lib/libthr.so.3 (0x802c78000)\n        libc.so.7 => /lib/libc.so.7 (0x800823000)\n        libm.so.5 => /lib/libm.so.5 (0x802e9f000)\n        libutil.so.9 => /lib/libutil.so.9 (0x8030ca000)\n```\n\nAnd got these errors back, too:\n\n```\nsage -t --long src/sage/matrix/matrix_mod2_dense.pyx  # Killed due to illegal instruction\n...\nsage: b*a ## line 39 ##\n[1 0 1]\n[1 0 0]\nsage: TestSuite(a).run() ## line 43 ##\nlibpng warning: Application was compiled with png.h from libpng-1.6.27+apng\nlibpng warning: Application  is  running with png.c from libpng-1.2.51\nGD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library\n```\n\nThat is, if we are trusting the error message, somewhere wrong headers (and a library, I suppose) were used for compilation, isn't it?",
    "created_at": "2017-03-29T11:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312645",
    "user": "dimpase"
}
```

Replying to [comment:41 fbissey]:
> 1) note that it says `GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library` so we are talking about something using libgd.
> 
> 2) the error may not be in that file but in another part of sage that is called from that file.
> 
> Check `sage/matrix/matrix_mod2_dense.so`.
OK, I've rebuilt with old (Sage's current) libpng:

```
$ ldd local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so
local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so:
        libm.so => /usr/home/dima/Sage/sage/local/lib/libm.so (0x801255000)
        libgmp.so.22 => /usr/home/dima/Sage/sage/local/lib/libgmp.so.22 (0x801461000)
        libm4ri-0.0.20140914.so => /usr/home/dima/Sage/sage/local/lib/libm4ri-0.0.20140914.so (0x8016e5000)
        libpng12.so.0 => /usr/home/dima/Sage/sage/local/lib/libpng12.so.0 (0x801917000)
        libz.so => /usr/home/dima/Sage/sage/local/lib/libz.so (0x801b40000)
        libpython2.7.so.1 => /usr/home/dima/Sage/sage/local/lib/libpython2.7.so.1 (0x801d57000)
        libpari-gmp.so.5 => /usr/home/dima/Sage/sage/local/lib/libpari-gmp.so.5 (0x802200000)
        libthr.so.3 => /lib/libthr.so.3 (0x802c78000)
        libc.so.7 => /lib/libc.so.7 (0x800823000)
        libm.so.5 => /lib/libm.so.5 (0x802e9f000)
        libutil.so.9 => /lib/libutil.so.9 (0x8030ca000)
```

And got these errors back, too:

```
sage -t --long src/sage/matrix/matrix_mod2_dense.pyx  # Killed due to illegal instruction
...
sage: b*a ## line 39 ##
[1 0 1]
[1 0 0]
sage: TestSuite(a).run() ## line 43 ##
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
libpng warning: Application  is  running with png.c from libpng-1.2.51
GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library
```

That is, if we are trusting the error message, somewhere wrong headers (and a library, I suppose) were used for compilation, isn't it?



---

archive/issue_comments_312646.json:
```json
{
    "body": "this is how to reproduce it at the Sage prompt, with more details (pickling is the problem):\n\n```\nsage: from sage.misc.all import loads, dumps\nsage: a=matrix(GF(2),3,range(9),sparse=False); a\n\n[0 1 0]\n[1 0 1]\n[0 1 0]\nsage: dumps(a)\nlibpng warning: Application was compiled with png.h from libpng-1.6.27+apng\n...\nSegmentation fault (core dumped)\n```\n\ndigging out what dumps does gives\n\n```\nsage: from six.moves import cPickle\nsage: # or just import cPickle # makes no difference\nsage: a=matrix(GF(2),3,range(9),sparse=False)\nsage: cPickle.dumps(a)\nlibpng warning: Application was compiled with png.h from libpng-1.6.27+apng\n...\n```\n\n\ndigging more gives:\n\n```\nsage: a=matrix(GF(2),3,range(9),sparse=False)\nsage: from sage.matrix.matrix_mod2_dense import to_png\nsage: to_png(a,\"/tmp/blah\")\nlibpng warning: Application was compiled with png.h from libpng-1.6.27+apng\nlibpng warning: Application  is  running with png.c from libpng-1.2.51\nGD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library\n```\n\n\n`to_png` calls `gdImage*` things from `libgd`, which in turn call `gd_png`; this uses `libpng`.\nNow one can see the cause of trouble: \n\nit's a bug in `libgd` configure, which places `-I/usr/local/include` in front of \n`-I$SAGE_LOCAL/include/...`; more precisely, there is an old FreeBSD-specific\npatch in its spkg-install, which causes this thing, 4cf1a0c642a.\n\nRemoving it fixes this problem. Duh...",
    "created_at": "2017-03-29T14:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312646",
    "user": "dimpase"
}
```

this is how to reproduce it at the Sage prompt, with more details (pickling is the problem):

```
sage: from sage.misc.all import loads, dumps
sage: a=matrix(GF(2),3,range(9),sparse=False); a

[0 1 0]
[1 0 1]
[0 1 0]
sage: dumps(a)
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
...
Segmentation fault (core dumped)
```

digging out what dumps does gives

```
sage: from six.moves import cPickle
sage: # or just import cPickle # makes no difference
sage: a=matrix(GF(2),3,range(9),sparse=False)
sage: cPickle.dumps(a)
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
...
```


digging more gives:

```
sage: a=matrix(GF(2),3,range(9),sparse=False)
sage: from sage.matrix.matrix_mod2_dense import to_png
sage: to_png(a,"/tmp/blah")
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
libpng warning: Application  is  running with png.c from libpng-1.2.51
GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library
```


`to_png` calls `gdImage*` things from `libgd`, which in turn call `gd_png`; this uses `libpng`.
Now one can see the cause of trouble: 

it's a bug in `libgd` configure, which places `-I/usr/local/include` in front of 
`-I$SAGE_LOCAL/include/...`; more precisely, there is an old FreeBSD-specific
patch in its spkg-install, which causes this thing, 4cf1a0c642a.

Removing it fixes this problem. Duh...



---

archive/issue_comments_312647.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-29T15:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312647",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_312648.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-29T22:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312648",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312649.json:
```json
{
    "body": "You should split the `libgd` commit to its own ticket. It really should be fixed. Is your `eclib` stuff in upstream already? Or in an issue on github?",
    "created_at": "2017-03-29T22:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312649",
    "user": "fbissey"
}
```

You should split the `libgd` commit to its own ticket. It really should be fixed. Is your `eclib` stuff in upstream already? Or in an issue on github?



---

archive/issue_comments_312650.json:
```json
{
    "body": "fixed few ugly c++ bugs in eclib in #22711.\nThis makes clang much happier, many more doctests work.",
    "created_at": "2017-03-29T22:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312650",
    "user": "dimpase"
}
```

fixed few ugly c++ bugs in eclib in #22711.
This makes clang much happier, many more doctests work.



---

archive/issue_comments_312651.json:
```json
{
    "body": "Replying to [comment:49 fbissey]:\n> You should split the `libgd` commit to its own ticket. It really should be fixed.\n\nwell, it's FreeBSD-only issue, it's OK to wait until more stuff for it is ready...",
    "created_at": "2017-03-29T22:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312651",
    "user": "dimpase"
}
```

Replying to [comment:49 fbissey]:
> You should split the `libgd` commit to its own ticket. It really should be fixed.

well, it's FreeBSD-only issue, it's OK to wait until more stuff for it is ready...



---

archive/issue_comments_312652.json:
```json
{
    "body": "Now it's down to something relatively small---mostly numerical noise:\n\n\n```\nsrc/sage/rings/polynomial/multi_polynomial_sequence.py  # Timed out (with segmentation fault after interrupt)\nsrc/sage/symbolic/series.pyx  # Killed due to kill signal\nsrc/sage/rings/polynomial/pbori.pyx  # Killed due to abort\nsrc/sage/plot/plot.py  # 1 doctest failed\nsrc/sage/schemes/elliptic_curves/ell_rational_field.py  # 2 doctests failed\nsrc/sage/plot/graphics.py  # 1 doctest failed\nsrc/sage/tests/cmdline.py  # 1 doctest failed\nsrc/sage/interfaces/tests.py  # Timed out\nsrc/sage/structure/element.pyx  # 1 doctest failed\nsrc/doc/en/prep/Calculus.rst  # 1 doctest failed\nsrc/sage/doctest/forker.py  # 1 doctest failed\nsrc/sage/structure/sage_object.pyx  # Timed out (with abort after interrupt)\nsrc/sage/crypto/mq/sr.py  # 7 doctests failed\nsrc/sage/schemes/elliptic_curves/lseries_ell.py  # 1 doctest failed\nsrc/sage/interfaces/singular.py  # 2 doctests failed\nsrc/sage/lfunctions/sympow.py  # 4 doctests failed\nsrc/sage/structure/coerce.pyx  # 1 doctest failed\nsrc/doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed\nsrc/sage/rings/complex_double.pyx  # 2 doctests failed\nsrc/sage/numerical/sdp.pyx  # 1 doctest failed\nsrc/sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed\nsrc/sage/rings/polynomial/polydict.pyx  # 1 doctest failed\n```\n",
    "created_at": "2017-03-29T23:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312652",
    "user": "dimpase"
}
```

Now it's down to something relatively small---mostly numerical noise:


```
src/sage/rings/polynomial/multi_polynomial_sequence.py  # Timed out (with segmentation fault after interrupt)
src/sage/symbolic/series.pyx  # Killed due to kill signal
src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
src/sage/plot/plot.py  # 1 doctest failed
src/sage/schemes/elliptic_curves/ell_rational_field.py  # 2 doctests failed
src/sage/plot/graphics.py  # 1 doctest failed
src/sage/tests/cmdline.py  # 1 doctest failed
src/sage/interfaces/tests.py  # Timed out
src/sage/structure/element.pyx  # 1 doctest failed
src/doc/en/prep/Calculus.rst  # 1 doctest failed
src/sage/doctest/forker.py  # 1 doctest failed
src/sage/structure/sage_object.pyx  # Timed out (with abort after interrupt)
src/sage/crypto/mq/sr.py  # 7 doctests failed
src/sage/schemes/elliptic_curves/lseries_ell.py  # 1 doctest failed
src/sage/interfaces/singular.py  # 2 doctests failed
src/sage/lfunctions/sympow.py  # 4 doctests failed
src/sage/structure/coerce.pyx  # 1 doctest failed
src/doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed
src/sage/rings/complex_double.pyx  # 2 doctests failed
src/sage/numerical/sdp.pyx  # 1 doctest failed
src/sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed
src/sage/rings/polynomial/polydict.pyx  # 1 doctest failed
```




---

archive/issue_comments_312653.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-29T23:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312653",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312654.json:
```json
{
    "body": "Dima, how are you skipping the building of gcc? Or you don't like I do on OS X?",
    "created_at": "2017-04-03T22:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312654",
    "user": "fbissey"
}
```

Dima, how are you skipping the building of gcc? Or you don't like I do on OS X?



---

archive/issue_comments_312655.json:
```json
{
    "body": "Replying to [comment:54 fbissey]:\n> Dima, how are you skipping the building of gcc? Or you don't like I do on OS X?\n\nIt's easy in this case.\nI've installed FreeBSD's package gcc6, which comes, well, with gcc-6.3, and does not install gcc or gfortran. Then I made a symbolic link pointing gfortran to gfortran6.\nAnd building with SAGE_INSTALL_GCC=no does the trick.\n\nPS. I'm on vacation for another week, replies might be slow :-)",
    "created_at": "2017-04-03T23:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312655",
    "user": "dimpase"
}
```

Replying to [comment:54 fbissey]:
> Dima, how are you skipping the building of gcc? Or you don't like I do on OS X?

It's easy in this case.
I've installed FreeBSD's package gcc6, which comes, well, with gcc-6.3, and does not install gcc or gfortran. Then I made a symbolic link pointing gfortran to gfortran6.
And building with SAGE_INSTALL_GCC=no does the trick.

PS. I'm on vacation for another week, replies might be slow :-)



---

archive/issue_comments_312656.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-04-05T07:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312656",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_312657.json:
```json
{
    "body": "Replying to [comment:49 fbissey]:\n> You should split the `libgd` commit to its own ticket.  It really should be fixed.\nthis is #22785, ready for review.",
    "created_at": "2017-04-08T20:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312657",
    "user": "dimpase"
}
```

Replying to [comment:49 fbissey]:
> You should split the `libgd` commit to its own ticket.  It really should be fixed.
this is #22785, ready for review.



---

archive/issue_comments_312658.json:
```json
{
    "body": "sympow tests of analytic_rank fail on curves of even rank, and works for odd rank, does not matter whether sympow is built with clang 3.8 or with gcc 6.3.\n\nUsing `clang-devel`, which is `clang-4.0.0`, makes the `sympow` tests pass. This is probably due to it using `llvm-as` rather than `as`, with is horribly old (version 2.17, dates back to 2007) on FreeBSD. \n\nLooks like we're converging to the state we have on OSX w.r.t. clang (#12426).",
    "created_at": "2017-04-12T11:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312658",
    "user": "dimpase"
}
```

sympow tests of analytic_rank fail on curves of even rank, and works for odd rank, does not matter whether sympow is built with clang 3.8 or with gcc 6.3.

Using `clang-devel`, which is `clang-4.0.0`, makes the `sympow` tests pass. This is probably due to it using `llvm-as` rather than `as`, with is horribly old (version 2.17, dates back to 2007) on FreeBSD. 

Looks like we're converging to the state we have on OSX w.r.t. clang (#12426).



---

archive/issue_comments_312659.json:
```json
{
    "body": "Replying to [comment:64 dimpase]:\n> Using `clang-devel`, which is `clang-4.0.0`, makes the `sympow` tests pass. This is probably due to it using `llvm-as` rather than `as`, with is horribly old (version 2.17, dates back to 2007) on FreeBSD. \n\nAlternatively, using `/usr/local/bin/as` (version 2.28) instead, makes `sympow` tests pass, too.",
    "created_at": "2017-04-12T12:02:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312659",
    "user": "dimpase"
}
```

Replying to [comment:64 dimpase]:
> Using `clang-devel`, which is `clang-4.0.0`, makes the `sympow` tests pass. This is probably due to it using `llvm-as` rather than `as`, with is horribly old (version 2.17, dates back to 2007) on FreeBSD. 

Alternatively, using `/usr/local/bin/as` (version 2.28) instead, makes `sympow` tests pass, too.



---

archive/issue_comments_312660.json:
```json
{
    "body": "ccache, gfan,lcalc,tachyon need to have their LDFLAGS sorted due to `libm` linking, \nas  our special LDFLAGS must come first in the linking list of parameters.\nWorked around for the time being by adding LDFLAGS to CC and CXX, i.e.\n\n```\n$ CXX=\"$CXX $LDFLAGS\" CC=\"$CC $LDFLAGS\" make \n```\n\n\nhowever, it seems that passing unrecognised options to the compiler has strange side effects on `sympow` - it creates an executable that fails tests it fails if built with old `as` (sic!).",
    "created_at": "2017-04-13T08:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312660",
    "user": "dimpase"
}
```

ccache, gfan,lcalc,tachyon need to have their LDFLAGS sorted due to `libm` linking, 
as  our special LDFLAGS must come first in the linking list of parameters.
Worked around for the time being by adding LDFLAGS to CC and CXX, i.e.

```
$ CXX="$CXX $LDFLAGS" CC="$CC $LDFLAGS" make 
```


however, it seems that passing unrecognised options to the compiler has strange side effects on `sympow` - it creates an executable that fails tests it fails if built with old `as` (sic!).



---

archive/issue_comments_312661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-13T10:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312661",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312662.json:
```json
{
    "body": "#22812 and #22840 deal with misplaced LDFLAGS.",
    "created_at": "2017-04-20T15:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312662",
    "user": "dimpase"
}
```

#22812 and #22840 deal with misplaced LDFLAGS.



---

archive/issue_comments_312663.json:
```json
{
    "body": "Apart from #22799, which is responsible for majority of failing doctests, the only other real worry is the double unpickling crash\nafter the line ` sage.structure.sage_object.unpickle_all() ## line 1563 ##`\nin `src/sage/structure/sage_object.pyx`.",
    "created_at": "2017-04-21T14:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312663",
    "user": "dimpase"
}
```

Apart from #22799, which is responsible for majority of failing doctests, the only other real worry is the double unpickling crash
after the line ` sage.structure.sage_object.unpickle_all() ## line 1563 ##`
in `src/sage/structure/sage_object.pyx`.



---

archive/issue_comments_312664.json:
```json
{
    "body": "TODO: gf2x needs CPP and CXXCPP to be set to `\"clang-devel -E\"` if we like to run its tuning.\n\n(and probably a fresh autoreconf run)",
    "created_at": "2017-04-28T15:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312664",
    "user": "dimpase"
}
```

TODO: gf2x needs CPP and CXXCPP to be set to `"clang-devel -E"` if we like to run its tuning.

(and probably a fresh autoreconf run)



---

archive/issue_comments_312665.json:
```json
{
    "body": "`clang-devel`? is this a freeBSDism? No such thing on OS X. `AC_PROG_CPP` would usually test `$CC -E` (or `$CXX -E` depending on the language selected).",
    "created_at": "2017-04-28T20:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312665",
    "user": "fbissey"
}
```

`clang-devel`? is this a freeBSDism? No such thing on OS X. `AC_PROG_CPP` would usually test `$CC -E` (or `$CXX -E` depending on the language selected).



---

archive/issue_comments_312666.json:
```json
{
    "body": "clang-devel == clang 4.0.0 on FreeBSD 11.0.",
    "created_at": "2017-04-28T20:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312666",
    "user": "dimpase"
}
```

clang-devel == clang 4.0.0 on FreeBSD 11.0.



---

archive/issue_comments_312667.json:
```json
{
    "body": "`ptest` now gives\n\n```\nsage -t --warn-long 54.2 src/sage/structure/sage_object.pyx  # Killed due to abort\nsage -t --warn-long 54.2 src/sage/interfaces/tests.py  # 1 doctest failed\nsage -t --warn-long 54.2 src/sage/tests/cmdline.py  # 1 doctest failed\nsage -t --warn-long 54.2 src/sage/homology/simplicial_complex.py  # 1 doctest failed\nsage -t --warn-long 54.2 src/sage/interfaces/singular.py  # 2 doctests failed\nsage -t --warn-long 54.2 src/sage/libs/lcalc/lcalc_Lfunction.pyx  # 1 doctest failed\nsage -t --warn-long 54.2 src/doc/en/developer/coding_in_other.rst  # 1 doctest failed\nsage -t --warn-long 54.2 src/doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed\nsage -t --warn-long 54.2 src/sage/numerical/sdp.pyx  # 1 doctest failed\n```\n\nall of this was seen before --- numerical noise or a different order of output, random weird failures, or crash at 2nd unpickle.all.",
    "created_at": "2017-06-26T10:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312667",
    "user": "dimpase"
}
```

`ptest` now gives

```
sage -t --warn-long 54.2 src/sage/structure/sage_object.pyx  # Killed due to abort
sage -t --warn-long 54.2 src/sage/interfaces/tests.py  # 1 doctest failed
sage -t --warn-long 54.2 src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --warn-long 54.2 src/sage/homology/simplicial_complex.py  # 1 doctest failed
sage -t --warn-long 54.2 src/sage/interfaces/singular.py  # 2 doctests failed
sage -t --warn-long 54.2 src/sage/libs/lcalc/lcalc_Lfunction.pyx  # 1 doctest failed
sage -t --warn-long 54.2 src/doc/en/developer/coding_in_other.rst  # 1 doctest failed
sage -t --warn-long 54.2 src/doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed
sage -t --warn-long 54.2 src/sage/numerical/sdp.pyx  # 1 doctest failed
```

all of this was seen before --- numerical noise or a different order of output, random weird failures, or crash at 2nd unpickle.all.



---

archive/issue_comments_312668.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-26T14:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312668",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312669.json:
```json
{
    "body": "wow, now `ptest` gives just this:\n\n```\nsage -t --warn-long 50.1 src/sage/interfaces/tests.py  # 1 doctest failed\nsage -t --warn-long 50.1 src/sage/tests/cmdline.py  # 1 doctest failed\nsage -t --warn-long 50.1 src/sage/homology/simplicial_complex.py  # 1 doctest failed\nsage -t --warn-long 50.1 src/sage/geometry/cone.py  # Timed out\nsage -t --warn-long 50.1 src/sage/numerical/sdp.pyx  # 1 doctest failed\n```\n\n(with the timed out test running fine if repeated separately)\n\nApparently it's due to flint and arb properly set up at the right moment, and not at some later moment, and/or more stable clang version.",
    "created_at": "2017-06-26T16:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312669",
    "user": "dimpase"
}
```

wow, now `ptest` gives just this:

```
sage -t --warn-long 50.1 src/sage/interfaces/tests.py  # 1 doctest failed
sage -t --warn-long 50.1 src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --warn-long 50.1 src/sage/homology/simplicial_complex.py  # 1 doctest failed
sage -t --warn-long 50.1 src/sage/geometry/cone.py  # Timed out
sage -t --warn-long 50.1 src/sage/numerical/sdp.pyx  # 1 doctest failed
```

(with the timed out test running fine if repeated separately)

Apparently it's due to flint and arb properly set up at the right moment, and not at some later moment, and/or more stable clang version.



---

archive/issue_comments_312670.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-03T17:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312670",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312671.json:
```json
{
    "body": "New branch is `u/dimpase/fbsd-support`, keeping the old one for browsing purposes a.t.m.",
    "created_at": "2017-08-04T10:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312671",
    "user": "dimpase"
}
```

New branch is `u/dimpase/fbsd-support`, keeping the old one for browsing purposes a.t.m.



---

archive/issue_comments_312672.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-08-30T15:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312672",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_312673.json:
```json
{
    "body": "now `MAKE=\"make -j1 make ptest` has just 3 failures:\n\n```\nsage -t --warn-long 79.3 src/sage/interfaces/tests.py  # 1 doctest failed\nsage -t --warn-long 79.3 src/sage/numerical/sdp.pyx  # 1 doctest failed\nsage -t --warn-long 79.3 src/sage/tests/cmdline.py  # 1 doctest failed\n```\n\nof which the 1st is something to look at:\n\n```\nFile \"src/sage/interfaces/tests.py\", line 36, in sage.interfaces.tests\nFailed example:\n    subprocess.call(\"echo syntax error | gap\", **kwds)\nExpected:\n    0\nGot:\n    136\n```\n\n2nd is just numerical noise, the 3rd is\n\n```\nFile \"src/sage/tests/cmdline.py\", line 534, in sage.tests.cmdline.test_executable\nFailed example:\n    out\nExpected:\n    '120\\n'\nGot:\n    '#E  Could not create interval timer. Timeouts will not be supported\\n120\\n'\n```\n\n\nA bigger problem is with `-jX` for `X>1`; it's not really possible to build docs, one gets weird segfaults related to ECL/Maxima. It's very likely that they are of the same nature as the following weirdness (they look very similar): start Sage, type\n\n```\nsage: from sage.interfaces.maxima_lib import \n```\n\nand hit Tab. This segfaults with\n\n```\nInternal or unrecoverable error in:                               \nGot signal before environment was installed on our thread         \n  [2: No such file or directory]                                  \n\n;;; ECL C Backtrace\n;;;    0 ecl_internal_error (0x87d790765) \n;;;    1 init_unixint (0x87d7b6bd0) \n;;;    2 init_unixint (0x87d7b6972) \n;;;    3 pthread_sigmask (0x80103779d) \n;;;    4 pthread_getspecific (0x801036d6f) \n;;;    5 unknown (0x7ffffffff193) \n;;;    6 GC_push_all_stacks (0x87db1ea2c) \n;;;    7 GC_mark_some (0x87db12eec) \n;;;    8 GC_stopped_mark (0x87db09baa) \n;;;    9 GC_try_to_collect_inner (0x87db09a75) \n;;;   10 GC_init (0x87db16f4f) \n;;;   11 init_alloc (0x87d7caa59) \n;;;   12 cl_boot (0x87d694a5b) \n;;;   13 initecl (0x87d218340) \n;;;   14 initecl (0x87d20a43f) \n;;;   15 initecl (0x87d207e28) \n;;;   16 _PyImport_LoadDynamicModule (0x800b3ed1c) \n;;;   17 PyImport_AppendInittab (0x800b3d71f) \n;;;   18 PyImport_AppendInittab (0x800b3d1a8) \n;;;   19 PyImport_ImportModuleLevel (0x800b3c2ce) \n;;;   20 _PyBuiltin_Init (0x800b162d7) \n;;;   21 PyObject_Call (0x800a7d3e3) \n;;;   22 PyEval_EvalFrameEx (0x800b2121c) \n;;;   23 PyEval_EvalCodeEx (0x800b1b5d4) \n;;;   24 PyEval_EvalCode (0x800b1ad96) \n;;;   25 PyImport_ExecCodeModuleEx (0x800b3ad11) \n;;;   26 PyImport_AppendInittab (0x800b3ddb8) \n;;;   27 PyImport_AppendInittab (0x800b3d71f) \n;;;   28 PyImport_AppendInittab (0x800b3d1a8) \n;;;   29 PyImport_ImportModuleLevel (0x800b3c2ce) \n;;;   30 _PyBuiltin_Init (0x800b162d7) \n;;;   31 PyEval_EvalFrameEx (0x800b22dd1) \nSegmentation fault (core dumped)\n```\n\n----\nLast 10 new commits:",
    "created_at": "2017-08-30T15:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312673",
    "user": "dimpase"
}
```

now `MAKE="make -j1 make ptest` has just 3 failures:

```
sage -t --warn-long 79.3 src/sage/interfaces/tests.py  # 1 doctest failed
sage -t --warn-long 79.3 src/sage/numerical/sdp.pyx  # 1 doctest failed
sage -t --warn-long 79.3 src/sage/tests/cmdline.py  # 1 doctest failed
```

of which the 1st is something to look at:

```
File "src/sage/interfaces/tests.py", line 36, in sage.interfaces.tests
Failed example:
    subprocess.call("echo syntax error | gap", **kwds)
Expected:
    0
Got:
    136
```

2nd is just numerical noise, the 3rd is

```
File "src/sage/tests/cmdline.py", line 534, in sage.tests.cmdline.test_executable
Failed example:
    out
Expected:
    '120\n'
Got:
    '#E  Could not create interval timer. Timeouts will not be supported\n120\n'
```


A bigger problem is with `-jX` for `X>1`; it's not really possible to build docs, one gets weird segfaults related to ECL/Maxima. It's very likely that they are of the same nature as the following weirdness (they look very similar): start Sage, type

```
sage: from sage.interfaces.maxima_lib import 
```

and hit Tab. This segfaults with

```
Internal or unrecoverable error in:                               
Got signal before environment was installed on our thread         
  [2: No such file or directory]                                  

;;; ECL C Backtrace
;;;    0 ecl_internal_error (0x87d790765) 
;;;    1 init_unixint (0x87d7b6bd0) 
;;;    2 init_unixint (0x87d7b6972) 
;;;    3 pthread_sigmask (0x80103779d) 
;;;    4 pthread_getspecific (0x801036d6f) 
;;;    5 unknown (0x7ffffffff193) 
;;;    6 GC_push_all_stacks (0x87db1ea2c) 
;;;    7 GC_mark_some (0x87db12eec) 
;;;    8 GC_stopped_mark (0x87db09baa) 
;;;    9 GC_try_to_collect_inner (0x87db09a75) 
;;;   10 GC_init (0x87db16f4f) 
;;;   11 init_alloc (0x87d7caa59) 
;;;   12 cl_boot (0x87d694a5b) 
;;;   13 initecl (0x87d218340) 
;;;   14 initecl (0x87d20a43f) 
;;;   15 initecl (0x87d207e28) 
;;;   16 _PyImport_LoadDynamicModule (0x800b3ed1c) 
;;;   17 PyImport_AppendInittab (0x800b3d71f) 
;;;   18 PyImport_AppendInittab (0x800b3d1a8) 
;;;   19 PyImport_ImportModuleLevel (0x800b3c2ce) 
;;;   20 _PyBuiltin_Init (0x800b162d7) 
;;;   21 PyObject_Call (0x800a7d3e3) 
;;;   22 PyEval_EvalFrameEx (0x800b2121c) 
;;;   23 PyEval_EvalCodeEx (0x800b1b5d4) 
;;;   24 PyEval_EvalCode (0x800b1ad96) 
;;;   25 PyImport_ExecCodeModuleEx (0x800b3ad11) 
;;;   26 PyImport_AppendInittab (0x800b3ddb8) 
;;;   27 PyImport_AppendInittab (0x800b3d71f) 
;;;   28 PyImport_AppendInittab (0x800b3d1a8) 
;;;   29 PyImport_ImportModuleLevel (0x800b3c2ce) 
;;;   30 _PyBuiltin_Init (0x800b162d7) 
;;;   31 PyEval_EvalFrameEx (0x800b22dd1) 
Segmentation fault (core dumped)
```

----
Last 10 new commits:



---

archive/issue_comments_312674.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2017-08-31T08:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312674",
    "user": "dimpase"
}
```

Last 10 new commits:



---

archive/issue_comments_312675.json:
```json
{
    "body": "ticket description should be edited on an updated ticket page, duh...",
    "created_at": "2017-08-31T08:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312675",
    "user": "dimpase"
}
```

ticket description should be edited on an updated ticket page, duh...



---

archive/issue_comments_312676.json:
```json
{
    "body": "The segfault in the bottom part of comment 87 remains the same if `gc` and `libatomic_ops` are rebuilt with threads disabled.",
    "created_at": "2017-08-31T16:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312676",
    "user": "dimpase"
}
```

The segfault in the bottom part of comment 87 remains the same if `gc` and `libatomic_ops` are rebuilt with threads disabled.



---

archive/issue_comments_312677.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-08T11:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312677",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-10-06T13:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312678",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_312679.json:
```json
{
    "body": "New code for `RiemannSurface` uses Voronoi from scipy. But the latter is broken on FreeBSD:\n\n```\n$ ./sage --python\nPython 2.7.13 (default, Oct 11 2017, 17:41:18) \n[GCC 4.2.1 Compatible Clang 6.0.0 ] on freebsd11\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import numpy as np\n>>> points = np.array([[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2],[2, 0], [2, 1], [2, 2]])\n>>> from scipy.spatial import Voronoi\n>>> Voronoi(points)\nSegmentation fault (core dumped)\n```\n\n(might be due to careless use of threading...)\n\nNote that the previously used in Sage version of scipy 0.17.1, still works.",
    "created_at": "2017-10-11T17:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312679",
    "user": "dimpase"
}
```

New code for `RiemannSurface` uses Voronoi from scipy. But the latter is broken on FreeBSD:

```
$ ./sage --python
Python 2.7.13 (default, Oct 11 2017, 17:41:18) 
[GCC 4.2.1 Compatible Clang 6.0.0 ] on freebsd11
Type "help", "copyright", "credits" or "license" for more information.
>>> import numpy as np
>>> points = np.array([[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2],[2, 0], [2, 1], [2, 2]])
>>> from scipy.spatial import Voronoi
>>> Voronoi(points)
Segmentation fault (core dumped)
```

(might be due to careless use of threading...)

Note that the previously used in Sage version of scipy 0.17.1, still works.



---

archive/issue_comments_312680.json:
```json
{
    "body": "it turns out that scipy's Voronoi works with the system's Python 2.7.14, but not with Sage's one (there are BSD-only Python patches; trying them now).",
    "created_at": "2017-10-20T12:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312680",
    "user": "dimpase"
}
```

it turns out that scipy's Voronoi works with the system's Python 2.7.14, but not with Sage's one (there are BSD-only Python patches; trying them now).



---

archive/issue_comments_312681.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-11T16:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312681",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_312682.json:
```json
{
    "body": "Please see #26249 for a followup, for FreeBSD version 12, where things are considerably simpler.",
    "created_at": "2018-09-11T16:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312682",
    "user": "dimpase"
}
```

Please see #26249 for a followup, for FreeBSD version 12, where things are considerably simpler.



---

archive/issue_comments_312683.json:
```json
{
    "body": "Changing type from enhancement to task.",
    "created_at": "2018-09-11T16:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312683",
    "user": "dimpase"
}
```

Changing type from enhancement to task.



---

archive/issue_comments_312684.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-13T09:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312684",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_312685.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-09-13T10:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22442#issuecomment-312685",
    "user": "jdemeyer"
}
```

Resolution: wontfix
