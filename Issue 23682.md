# Issue 23682: Sage library: standardize on C99 and C++11

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-09-22 11:39:50

CC:  fbissey

I suggest to fix a default version of the C and C++ standard to compile the Sage library with.

The reason is that different C/C++ compiler come with different standards as default (older GCC defaults to C89 and C++98, newer GCC default to C11 and C++11 and I have no idea what Clang does). Explicitly adding a `-std=` flag will hide those differences.

I suggest to default to C99 and C++11 because those are the versions which are already explicitly listed in a few places. So choosing those versions would also reduce some clutter in `module_list.py`. And given that we can already use `-std=c99` and `-std=c++11`, we know that our compilers support that.


---

Comment by fbissey created at 2017-09-22 12:14:33

New commits:


---

Comment by jdemeyer created at 2017-09-22 12:16:37

New commits:


---

Comment by git created at 2017-09-22 12:19:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-22 12:29:20

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-22 12:29:20

With this ticket, Sage builds fine with GCC 4.9.4 on Gentoo Linux x86_64.


---

Comment by jdemeyer created at 2017-09-22 12:42:02

Also builds fine with GCC 5.3.0 on Ubuntu 16.04.1 LTS ppc64le.


---

Comment by fbissey created at 2017-09-24 02:30:58

I also did something to `ntl` some time ago that was purposely avoiding c++11 so some packages downstream wouldn't break for lack of support. `NTL_THREADS=off` actually disable C++11. When it is on `ntl` uses C++11 threads. Now that all the downstream packages do/can do C++11 we should turn it on, or at a minimum leave the switch alone.


---

Comment by jdemeyer created at 2017-09-25 07:16:18

Replying to [comment:10 fbissey]:
> I also did something to `ntl` some time ago that was purposely avoiding c++11 so some packages downstream wouldn't break for lack of support. `NTL_THREADS=off` actually disable C++11. When it is on `ntl` uses C++11 threads. Now that all the downstream packages do/can do C++11 we should turn it on, or at a minimum leave the switch alone.

Sorry, I tried to read this paragraph several times but I don't understand what you mean or how it is related to this ticket.


---

Comment by fbissey created at 2017-09-25 08:16:07

Let me try again. In one of the upgrade of `ntl` _I_ purposefully disabled a switch enabling C++11 because `ntl` consumers such as `eclib` and `singular` couldn't use it (as in they would fail to build if it was enabled). 

I suggest that stopping to prevent `ntl` from using C++11 construct is in scope for this ticket.


---

Comment by jdemeyer created at 2017-09-25 13:27:56

Replying to [comment:12 fbissey]:
> I suggest that stopping to prevent `ntl` from using C++11 construct is in scope for this ticket.

This ticket is only about the Sage library, in other words the Cython modules using those libraries. So are you talking about Cython modules or about the libraries themselves?


---

Comment by jdemeyer created at 2017-09-25 13:47:05

Strangely, this leads to doctest failures on `i386`:

```
sage -t --warn-long 69.4 src/sage/rings/real_double.pyx
**********************************************************************
File "src/sage/rings/real_double.pyx", line 2056, in sage.rings.real_double.RealDoubleElement.log10
Failed example:
    r = RDF('16.0'); r.log10()
Expected:
    1.2041199826559246
Got:
    1.2041199826559248
**********************************************************************
File "src/sage/rings/real_double.pyx", line 2172, in sage.rings.real_double.RealDoubleElement.exp10
Failed example:
    r.exp10()
Expected:
    5.011872336272702e-33
Got:
    5.0118723362727734e-33
**********************************************************************
```



---

Comment by jdemeyer created at 2017-09-25 13:47:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-09-26 09:37:45

I debugged the `i386` failures. It seems that, with GCC-6.2.0, the literal number `2.30258509299404568402` is treated as `double` with GNU extensions `-std=gnu89` but as `long double` with `-std=c89` (or `-std=c99`, this doesn't matter).


---

Comment by git created at 2017-09-26 11:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-26 11:21:55

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2017-09-26 20:17:56

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-09-26 20:17:56

Looks good to me and the bot is green. You talked about that before, how much time and effort would be needed to remove `lcalc` in your opinion? You said `pari` could be used directly instead and `lcalc` is obviously just rotting away.


---

Comment by jdemeyer created at 2017-09-27 09:02:05

Replying to [comment:18 fbissey]:
> how much time and effort would be needed to remove `lcalc` in your opinion?

I think it would be a good project for https://pari.math.u-bordeaux.fr/Events/PARI2018/


---

Comment by vbraun created at 2017-09-29 22:27:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-09-29 22:27:36

Reviewer name...


---

Comment by fbissey created at 2017-09-30 00:51:14

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-10-04 19:26:56

Merge failure


---

Comment by vbraun created at 2017-10-04 19:26:56

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-10-05 08:48:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-05 08:48:37

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-10-07 10:49:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-07 10:49:17

This breaks on GCC 6.3.0 and 7.2.1, but works on older versions:

```
[  1/318] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/buildbot/slave/sage_git/build/local/include -I/home/buildbot/slave/sage_git/build/local/include/python2.7 -I/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/home/buildbot/slave/sage_git/build/src -I/home/buildbot/slave/sage_git/build/src/sage/ext -Ibuild/cythonized -I/home/buildbot/slave/sage_git/build/local/include/python2.7 -c build/cythonized/sage/libs/linbox/linbox_flint_interface.cpp -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/linbox/linbox_flint_interface.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -U_LB_DEBUG -DDISABLE_COMMENTATOR -Wall -DNDEBUG -UFFLASFFPACK_DEBUG -D__FFLASFFPACK_HAVE_CBLAS -g -O2 -DFFLAS_COMPILED -DFFPACK_COMPILED -fPIC -mmmx -mpopcnt -msse -msse2 -msse3 -msse4.1 -msse4.2 -mavx -mavx2 -mfma -mbmi -mbmi2 -mfpmath=sse -fabi-version=6 -I/home/buildbot/slave/sage_git/build/local/include/linbox -I/home/buildbot/slave/sage_git/build/local/include -std=c++11
In file included from /usr/include/c++/6/bits/move.h:57:0,
                 from /usr/include/c++/6/bits/nested_exception.h:40,
                 from /usr/include/c++/6/exception:173,
                 from /usr/include/c++/6/ios:39,
                 from /usr/include/c++/6/ostream:38,
                 from /usr/include/c++/6/iostream:39,
                 from /home/buildbot/slave/sage_git/build/local/include/linbox/linbox-config.h:45,
                 from build/cythonized/sage/libs/linbox/linbox_flint_interface.cpp:655:
/usr/include/c++/6/type_traits: In instantiation of ‘struct std::make_unsigned<__int128 unsigned>’:
/home/buildbot/slave/sage_git/build/local/include/givaro/modular-int64.h:46:60:   required from ‘class Givaro::Modular<long int, __int128 unsigned>’
/home/buildbot/slave/sage_git/build/local/include/givaro/modular-int64.inl:32:36:   required from here
/usr/include/c++/6/type_traits:1831:62: error: invalid use of incomplete type ‘class std::__make_unsigned_selector<__int128 unsigned, false, false>’
     { typedef typename __make_unsigned_selector<_Tp>::__type type; };
                                                              ^~~~
/usr/include/c++/6/type_traits:1788:11: note: declaration of ‘class std::__make_unsigned_selector<__int128 unsigned, false, false>’
     class __make_unsigned_selector;
           ^~~~~~~~~~~~~~~~~~~~~~~~
/usr/include/c++/6/type_traits: In instantiation of ‘struct std::make_unsigned<__int128>’:
/home/buildbot/slave/sage_git/build/local/include/givaro/modular-int64.h:46:60:   required from ‘class Givaro::Modular<long int, __int128>’
/home/buildbot/slave/sage_git/build/local/include/givaro/modular-int64.inl:36:35:   required from here
/usr/include/c++/6/type_traits:1831:62: error: invalid use of incomplete type ‘class std::__make_unsigned_selector<__int128, false, false>’
     { typedef typename __make_unsigned_selector<_Tp>::__type type; };
                                                              ^~~~
```



---

Comment by fbissey created at 2017-10-07 11:08:12

I get it too with gcc 6.4.0.


---

Comment by jdemeyer created at 2017-10-13 10:06:29

OK, I diagnosed this.

Linbox really needs GNU extensions, it compiles with `-std=gnu++11` but not with `-std=c++11`.

When building Linbox, it checks for C++11 support. With GCC 5.x, a flag is required to add C++11 support. By default, `configure` tries `-std=gnu++11` first. So, the `-std=gnu++11` flag is added to the `CXXFLAGS` of Linbox, which is propagated to the Sage library using the pkgconfig mechanism.

When building Linbox with GCC 6 or 7, the default is `-std=gnu++11` (or `-std=gnu++14` but that difference doesn't matter here). So Linbox doesn't add any `-std` flag to `CXXFLAGS`. Now this ticket sees that no `-std` flag is added, so it adds `-std=c++11` which breaks Linbox.


---

Comment by jdemeyer created at 2017-10-13 12:27:17

It's actually slightly more complicated than that: Linbox actually never stores `-std=gnu++11` in its pkgconfig cflags. The `-std=gnu++11` was being picked up by fflas-ffpack.


---

Comment by jdemeyer created at 2017-10-13 13:20:53

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2017-10-14 00:52:02

Replying to [comment:28 jdemeyer]:
> It's actually slightly more complicated than that: Linbox actually never stores `-std=gnu++11` in its pkgconfig cflags. The `-std=gnu++11` was being picked up by fflas-ffpack.

It is actually tricky to do because the m4 macros that looks for support for C99 and C++11/14 do not return  a flag. They return a new value for CC/CXX, the needed flag, if any,  is not easily accessible from the macro.


---

Comment by cpernet created at 2017-10-16 14:31:56

To make it even worse: Givaro (which is the real culprint here) uses `std=gnu++11` with gcc but switches to `std=c++11` when compiling with clang. This is due to a sequence of bugs as explained there:
https://github.com/linbox-team/givaro/issues/47

Surprinsingly, `--std=c++11` does not make the compilation fail with clang.
Therefore, one should be carefull not to "force" the `gnu++11` flag, although in the context of sage compilation, it may be a safe assumption that we are using gcc.

I take note that Givaro/FFLAS-FFPACK/LinBox should be more consistent in the c++11 flag that they expose in their .pc file. Since LinBox depends on FFLAS which depends on Givaro, I would preferably only state the c++11 flag in Givaro.
However, I was told [1] not to pollute the CFLAGS field in pkgconfig with anything else than preprocessor flags (-I and -D and -U).

[1] https://github.com/linbox-team/givaro/pull/46


---

Comment by vbraun created at 2017-10-29 22:45:36

I'm getting this on one particual 32-bit buildbot:

```
**********************************************************************
File "src/sage/libs/lcalc/lcalc_Lfunction.pyx", line 197, in sage.libs.lcalc.lcalc_Lfunction.Lfunction.hardy_z_function
Failed example:
    L.hardy_z_function(2.1).imag().abs() < 1.0e-16
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  15 in sage.libs.lcalc.lcalc_Lfunction.Lfunction.hardy_z_function
    [103 tests, 1 failure, 1.06 s]
----------------------------------------------------------------------
```

Actual return value is 2.11895733177441e-16. Can you also switch that to # abs tol for better doctest diagnostics?


---

Comment by vbraun created at 2017-10-29 22:45:36

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-10-30 13:38:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-30 13:38:59

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2017-10-30 14:22:07

thanks!


---

Comment by vbraun created at 2017-10-30 14:22:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-11-01 18:07:44

Resolution: fixed
