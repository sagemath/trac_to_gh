# Issue 21445: Add a separate "cythonize" command to setup.py

Issue created by migration from https://trac.sagemath.org/ticket/21682

Original creator: embray

Original creation time: 2016-10-11 15:31:23

CC:  mkoeppe

Keywords: cython distutils

This is a follow-on to #21600.  It adds a new `cythonize` command to the `setup.py`, and moves most of the logic for running `cythonize()` (previously in the customized `build_ext`) command, into this new command.

The new `cythonize` command is run always from `build_ext` anyways, but this has a couple advantages:

1) It is possible to run _just_ `cythonize`, without compiling extension modules.  This maybe isn't that common, but can be useful for development, especially when testing issues with Cython itself.  It will also be useful for generating source distributions, where we might want to ship Cythonized sources in the source tarball, and hence would need to generate them as part of the process of building the tarball (without necessarily compiling).

This also allows passing options directly from the command-line to `cythonize`.  This isn't much taken advantage of currently but the possibility is there.

2) Code is clearer and more modular.  Specific details for compiling cython code are kept separate from details for compiling C/C++ code.


---

Comment by embray created at 2016-10-11 15:32:33

I have a few other to-do issues in this code, but they're not essential.  Not sure if they should be worried about for now, or in a follow-up issue if this code is accepted.


---

Comment by jdemeyer created at 2016-10-11 15:45:04

I suggest that you first discuss this with upstream `cython`.


---

Comment by git created at 2016-11-07 12:27:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-07 12:27:57

Rebased--I agree this could also be worth bringing upstream in some form, but do you have any other comments?


---

Comment by embray created at 2016-11-07 12:28:05

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-11-07 12:51:14

Replying to [comment:4 embray]:
> do you have any other comments?

It would be better to separate the Sage-specific parts from the general code which could be upstreamed.


---

Comment by jdemeyer created at 2016-11-07 12:58:57

Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?


---

Comment by jdemeyer created at 2016-11-07 13:07:18

Why did you change

```
os.environ.get('SAGE_DEBUG', None) != 'no'
```

to

```
os.environ.get('SAGE_DEBUG', 'no') != 'no'
```



---

Comment by jdemeyer created at 2016-11-07 13:12:10

Regarding this:

```
    # TODO: This works for the C sources themselves, but this logic
    # should also apply to Cython sources--shouldn't the be rebuilt
    # if this file changes?  Alternatively, we could add more details
    # (e.g. cythonize() flags) to the .cython_version file
```

I implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.

You are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.


---

Comment by jdemeyer created at 2016-11-07 13:41:31

I would suggest to simplify

```
        if self.parallel is None:
            self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))

        if isinstance(self.parallel, str):
            try:
                self.parallel = int(self.parallel)
            except ValueError:
                raise DistutilsOptionError("parallel should be an integer")
```

to

```
        if self.parallel is None:
            self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)

        try:
            self.parallel = int(self.parallel)
        except ValueError:
            raise DistutilsOptionError("parallel should be an integer")
```



---

Comment by jdemeyer created at 2016-11-07 13:50:30

In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?


---

Comment by embray created at 2016-11-07 14:40:49

Replying to [comment:8 jdemeyer]:
> Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?

I think that was my first inclination as well.  I went with `cythonize` just to emphasize that this was mostly a wrapper around that, but I think you've convinced me (just by confirming my initial idea) over toward `build_cython`


---

Comment by embray created at 2016-11-07 14:42:21

Replying to [comment:9 jdemeyer]:
> Why did you change
> {{{
> os.environ.get('SAGE_DEBUG', None) != 'no'
> }}}
> to
> {{{
> os.environ.get('SAGE_DEBUG', 'no') != 'no'
> }}}

I don't think I meant to.  I think originally it _was_ `os.environ.get('SAGE_DEBUG', 'no')` and the fact that it's changed now might be a symptom of rebasing.  I'll fix that.  I definitely like the current spelling better.


---

Comment by embray created at 2016-11-07 14:43:32

Replying to [comment:11 jdemeyer]:
> I would suggest to simplify
> {{{
>         if self.parallel is None:
>             self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))
> 
>         if isinstance(self.parallel, str):
>             try:
>                 self.parallel = int(self.parallel)
>             except ValueError:
>                 raise DistutilsOptionError("parallel should be an integer")
> }}}
> to
> {{{
>         if self.parallel is None:
>             self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)
> 
>         try:
>             self.parallel = int(self.parallel)
>         except ValueError:
>             raise DistutilsOptionError("parallel should be an integer")
> }}}

Agreed


---

Comment by embray created at 2016-11-07 14:48:46

Replying to [comment:12 jdemeyer]:
> In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?

Yes, IIRC that was in anticipation of fixing #21535, but I left the actual value hard-coded for now so as to not change existing behavior (since currently setting it to anything else will break other things that hard-code `SAGE_CYTHONIZED`).  For the purposes of this ticket as a stand-alone enhancement that is confusing though.  I could leave the internal `build_dir` attribute for now and just get rid of the user option (temporarily).


---

Comment by jdemeyer created at 2016-11-07 15:01:09

Replying to [comment:14 embray]:
> I definitely like the current spelling better.

It's not just a matter of spelling. It is a functional difference.


---

Comment by jdemeyer created at 2016-11-07 15:01:34

For history about this `os.environ.get('SAGE_DEBUG', None)`, see #13881.


---

Comment by embray created at 2016-11-07 15:30:38

I agree, I wasn't being flippant :)


---

Comment by embray created at 2016-11-07 15:34:04

Replying to [comment:10 jdemeyer]:
> Regarding this:
> {{{
>     # TODO: This works for the C sources themselves, but this logic
>     # should also apply to Cython sources--shouldn't the be rebuilt
>     # if this file changes?  Alternatively, we could add more details
>     # (e.g. cythonize() flags) to the .cython_version file
> }}}
> I implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.
> 
> You are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.

What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?


---

Comment by jdemeyer created at 2016-11-07 15:43:52

Replying to [comment:20 embray]:
> What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?

I think that's a good idea. But that should be an independent ticket. I don't see the need for the "backwards compat for the old format" though.


---

Comment by embray created at 2016-11-07 15:50:28

Opened an upstream issue at https://github.com/cython/cython/issues/1514

A generic build_cython command could take most any `cythonize()` arguments as options.  A sage-specific wrapper around that would just be setting (or possibly enforcing) certain defaults.


---

Comment by embray created at 2016-11-07 15:52:02

Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 embray]:
> > What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?
> 
> I think that's a good idea. But that should be an independent ticket. I don't see the need for the "backwards compat for the old format" though.

Agree it's a separate issue.  As for backwards-compat, it at least needs to fail gracefully if the existing file is not in the new format, and rebuild + regenerate the file but that's fine.


---

Comment by embray created at 2016-11-08 12:11:04

Replying to [comment:9 jdemeyer]:
> Why did you change
> {{{
> os.environ.get('SAGE_DEBUG', None) != 'no'
> }}}
> to
> {{{
> os.environ.get('SAGE_DEBUG', 'no') != 'no'
> }}}

Actually, just to make sure I'm clear about this, is the point that debug should be enabled _by default_ if SAGE_DEBUG is not explicitly set to "no"?


---

Comment by jdemeyer created at 2016-11-08 12:54:05

Replying to [comment:25 embray]:
> Actually, just to make sure I'm clear about this, is the point that debug should be enabled _by default_ if SAGE_DEBUG is not explicitly set to "no"?

Exactly.


---

Comment by embray created at 2016-11-08 12:57:35

I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.  I'd be happy to change that in Sage's build_* commands, but it should be changed across the board, and a `--no-debug` option to turn it off is added.  But it would be simpler to not make it the default.

Instead, if we want to enable debug by default (which I agree is the best choice for development) we can either add it in the setup.cfg (but it would have to be removed when making a release) or in your local pydistutils.cfg.  

Or am I missing something here?


---

Comment by embray created at 2016-11-08 12:59:49

(I realize that the "gdb_debug" option for Cythonize and the "debug" option for building C sources are not the same thing, but they also kind of go hand-in-hand).


---

Comment by embray created at 2016-11-08 13:04:32

Nevermind--I read the docs for `SAGE_DEBUG` and that gave me a better understanding.  I'll play around a bit more with how the command-line option works, but I agree that the behavior you requested is consistent with how the `SAGE_DEBUG` environment variable itself should be interpreted.

I think for the `build_cython` command I'll remove the `--debug` option entirely, and make `gdb_debug=True` by default pending the value of `SAGE_DEBUG` (that is, identical to the previous behavior).  There's no huge advantage to having an option to explicitly disable it.


---

Comment by git created at 2016-11-08 13:23:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-11-08 13:35:49

Replying to [comment:27 embray]:
> I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.

In practice, `--debug` is the default because Python compiles by default with `-g` (even twice!). The _default_ gcc command line starts with

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC
```

(Sage adds the `-Wno-unused` flag to this and removes `-Wstrict-prototypes`)

Adding the `--debug` option to distutils adds an _additional_ `-g` but that doesn't change anything really.


---

Comment by jdemeyer created at 2016-11-08 13:36:37

Replying to [comment:29 embray]:
> There's no huge advantage to having an option to explicitly disable it.

The only potential advantage would be disk space (and maybe build time).


---

Comment by jdemeyer created at 2016-11-22 16:44:36

I recently did some work on the `setup.py` for `cysignals` and I realized that it makes the most sense to run Cython as _first_ build command, before `build_py`. This is because `build_py` handles `package_data` and we may want to handle Cython-generated files as `package_data` some day (see #20108).

For this reason, in `cysignals` I decided to run Cython in the base `build` command.


---

Comment by embray created at 2016-11-23 11:01:34

I see--that does make sense.  It simplifies things too--we can just insert `build_cython` into the front of the `build` sub-commands list.


---

Comment by git created at 2016-11-23 11:08:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-12-08 19:40:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-12-09 12:45:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-12-09 12:46:11

Rebased
----
New commits:


---

Comment by embray created at 2016-12-09 12:46:11

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-12-29 12:29:06

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-12-29 12:29:06

Needs rebasing, and should work with #21682


---

Comment by mkoeppe created at 2016-12-29 17:06:37

You mean #22106?


---

Comment by embray created at 2016-12-30 11:51:14

Yes, I meant #22106.  Thanks for the catch.


---

Comment by embray created at 2017-03-29 15:37:22

Ah, since #22106 is at least in "positive review" status I should rebase this on it.


---

Comment by git created at 2017-03-29 15:45:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-03-29 15:46:23

Rebased this on top of the current branch for #22106, which should be good to merge it looks like.

Other than the rebasing I don't think this needed any additional work.


---

Comment by embray created at 2017-03-29 15:46:23

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-04-01 15:29:30

Merged with `8.0.beta0`
----
New commits:


---

Comment by git created at 2017-04-01 16:12:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-01 16:25:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-04-02 07:40:05

Erik, I'm happy with this. If you like my changes, you can set this to positive_review.


---

Comment by embray created at 2017-04-03 06:58:04

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-04-03 06:58:04

I'm happy with the last change except in the `sage_build_cython.initialize_options` it should also set `self.extensions = None`.  I know, it's a bit silly, but I like to stick to the convention on this. (The reason for this convention has to do with how distutils commands can set their options from options on other commands, i.e. `self.set_undefined_options`. No, it's not likely to be used this way here, but I do also like that documents what attributes _should_ be set on the finalized command.)


---

Comment by git created at 2017-04-03 08:41:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-04-03 09:17:29

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-04-03 09:40:55

Thanks!


---

Comment by vbraun created at 2017-04-05 19:38:02

Resolution: fixed
