# Issue 22467: Create a variant of the polymake pexpect interface using polymake's simulate_shell_input

Issue created by migration from https://trac.sagemath.org/ticket/22704

Original creator: mkoeppe

Original creation time: 2017-03-28 23:10:45

CC:  simonking jipilab @sophiasage @laisrast @kliem @sebasguts vdelecroix tscrim

Keywords: days84

As suggested by Gawrilow in https://forum.polymake.org/viewtopic.php?f=8&t=544, we could create a variant of the polymake pexpect interface that does not go through pty's but rather replaces the relevant send/receive methods of pexpect by calls to `simulate_shell_input` (linking to libpolymake).

We do want to keep the current pty-based pexpect interface, though, because it may be handy for running polymake on a remote server; or for guarding against a crashing polymake (sigh).


---

Comment by mkoeppe created at 2019-04-27 09:37:59

Here's a first version. 
----
Last 10 new commits:


---

Comment by git created at 2019-04-27 11:19:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-27 13:24:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-27 13:40:43

Some polymake errors are not properly signalled by Polymake: Only the stderr slot [2] is filled but the error slot [3] is empty

```
sage: from JuPyMake import ExecuteCommand
sage: ExecuteCommand('help("Triangulation");')
(True, '', "polymake:  ERROR: unknown help topic 'Triangulation'\n", '')
```



---

Comment by git created at 2019-04-27 14:54:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-27 15:25:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-27 16:08:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-27 17:42:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-30 15:56:47

Signal handling issues are solved in new version of JuPyMake - waiting for a new release


---

Comment by jipilab created at 2019-05-01 08:03:36

This is coming from #24905, which is already set as positive review.

Could you correct the following pyflakes warnings:


```
+src/sage/geometry/polyhedron/backend_polymake.py:29: 'sage.rings.all.QQ' imported but unused
+src/sage/geometry/polyhedron/backend_polymake.py:29: 'sage.rings.all.ZZ' imported but unused
```



---

Comment by git created at 2019-05-02 11:46:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-02 11:57:47

Crashes are fixed.


---

Comment by git created at 2019-05-02 12:07:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-02 12:09:35

Signal handling fixed by jupymake update


---

Comment by mkoeppe created at 2019-05-02 13:45:07

polymake's error handling bug is reported upstream.


---

Comment by mkoeppe created at 2019-05-02 13:47:34

Apart from 1 remaining doctest regarding the form of some error messages, this is ready for review!


---

Comment by mkoeppe created at 2019-05-02 13:47:34

Changing status from new to needs_review.


---

Comment by git created at 2019-05-08 13:57:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-08 17:04:29

does this need #24905 ?


---

Comment by mkoeppe created at 2019-05-08 19:26:52

I did this work on top of the #24905 branch because otherwise there would be big merge conflicts.


---

Comment by dimpase created at 2019-05-08 21:18:59

that's what I get after trying this on Linux:

```
$ ./sage -tp --optional=bliss,build,dochtml,e_antic,gap_packages,jupymake,lidia,lrslib,memlimit,ninja_build,normaliz,python2,polymake,sage src/sage/interfaces/polymake.py 
too many failed tests, not using stored timings
Running doctests with ID 2019-05-08-22-08-17-11941b32.
Git branch: testwip
Using --optional=bliss,build,dochtml,e_antic,gap_packages,jupymake,lidia,lrslib,memlimit,ninja_build,normaliz,polymake,python2,sage
Doctesting 1 file using 4 threads.
sage -t src/sage/interfaces/polymake.py
**********************************************************************
File "src/sage/interfaces/polymake.py", line 765, in sage.interfaces.polymake.PolymakeAbstract.application
Failed example:
    polymake.eval('application "killerapp";')         # optional - polymake
Expected:
    Traceback (most recent call last):
    ...
    PolymakeError: Unknown application killerapp
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.PolymakeAbstract.application[15]>", line 1, in <module>
        polymake.eval('application "killerapp";')         # optional - polymake
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/polymake.py", line 2520, in eval
        raise PolymakeError(error)
    PolymakeError: Can't locate object method "compile_scope" via package "Polymake::Core::Shell::Mock" at /mnt/opt/Sage/sage-dev/local/share/polymake/perllib/Polymake/utils.pl line 247.
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of  17 in sage.interfaces.polymake.PolymakeAbstract.application
    [317 tests, 1 failure, 9.54 s]
----------------------------------------------------------------------
sage -t src/sage/interfaces/polymake.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by dimpase created at 2019-05-08 21:21:49

and also

```
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 175, in sage.geometry.polyhedron.base.Polyhedron_base._sage_input_
Failed example:
    P = Polyhedron(vertices = [[1, 0], [0, 1]], rays = [[1, 1]], backend='polymake') # optional - polymake
Expected nothing
Got:
     gmp v.6.1
...
File "src/sage/geometry/polyhedron/backend_polymake.py", line 59, in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake
Failed example:
    p = Polyhedron(vertices=[(0,0),(1,0),(0,1)], rays=[(1,1)],   # optional - polymake
                   lines=[], backend='polymake')
Expected nothing
Got:
     gmp v.6.1
```



---

Comment by mkoeppe created at 2019-05-09 09:08:38

Replying to [comment:30 dimpase]:
> that's what I get after trying this on Linux:
> {{{
> $ ./sage -tp --optional=bliss,build,dochtml,e_antic,gap_packages,jupymake,lidia,lrslib,memlimit,ninja_build,normaliz,python2,polymake,sage src/sage/interfaces/polymake.py 
> ....
>        raise PolymakeError(error)
>     PolymakeError: Can't locate object method "compile_scope" via package "Polymake::Core::Shell::Mock" at /mnt/opt/Sage/sage-dev/local/share/polymake/perllib/Polymake/utils.pl line 247.
> }}}

Yes, I know this one - see ticket description. I have reported it upstream.


---

Comment by mkoeppe created at 2019-05-09 09:10:39

Replying to [comment:31 dimpase]:
> and also
> {{{
> **********************************************************************
> File "src/sage/geometry/polyhedron/base.py", line 175, in sage.geometry.polyhedron.base.Polyhedron_base._sage_input_
> Failed example:
>     P = Polyhedron(vertices = [[1, 0], [0, 1]], rays = [This is the Trac macro *1, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 1-macro), backend='polymake') # optional - polymake
> Expected nothing
> Got:
>      gmp v.6.1
> ...
> File "src/sage/geometry/polyhedron/backend_polymake.py", line 59, in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake
> Failed example:
>     p = Polyhedron(vertices=[(0,0),(1,0),(0,1)], rays=[(1,1)],   # optional - polymake
>                    lines=[], backend='polymake')
> Expected nothing
> Got:
>      gmp v.6.1
> }}}
Looks like this message comes from lrslib, I'll investigate


---

Comment by mkoeppe created at 2019-05-09 09:18:36

Actually on my machine polymake does not find the installed lrslib (it's looking for liblrs but we only have liblrsgmp.)


---

Comment by dimpase created at 2019-05-09 09:29:05

I also only have `liblrsgmp`. Not sure if the following helps, but still:


```
$ ldd local/lib/libpolymake.so
	linux-vdso.so.1 (0x00007fff97bbb000)
	libperl.so.5.28 => /usr/lib64/libperl.so.5.28 (0x00007fcae6d94000)
	libxml2.so.2 => /usr/lib64/libxml2.so.2 (0x00007fcae6bef000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fcae6be9000)
	libmpfr.so.6 => /mnt/opt/Sage/sage-dev/local/lib/libmpfr.so.6 (0x00007fcae6b6a000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fcae68df000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fcae68bc000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/libstdc++.so.6 (0x00007fcae6642000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fcae6505000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/libgcc_s.so.1 (0x00007fcae64eb000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fcae631b000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fcae62e2000)
	libicuuc.so.64 => /usr/lib64/libicuuc.so.64 (0x00007fcae60f1000)
	libz.so.1 => /lib64/libz.so.1 (0x00007fcae5ecf000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fcae71bd000)
	libicudata.so.64 => /usr/lib64/libicudata.so.64 (0x00007fcae4489000)
```

the rest of polymake libs are statically linked, so it's not as easy to gather whether lrs has anything to do with it.


---

Comment by mkoeppe created at 2019-05-09 09:39:23

Replying to [comment:34 mkoeppe]:
> Actually on my machine polymake does not find the installed lrslib (it's looking for liblrs but we only have liblrsgmp.)

This belongs to the polymake 3.4 upgrade ticket (#24905).


---

Comment by dimpase created at 2019-05-09 11:15:40

Replying to [comment:33 mkoeppe]:
> Replying to [comment:31 dimpase]:
> > and also
> > {{{
> > **********************************************************************
> > File "src/sage/geometry/polyhedron/base.py", line 175, in sage.geometry.polyhedron.base.Polyhedron_base._sage_input_
> > Failed example:
> >     P = Polyhedron(vertices = [[1, 0], [0, 1]], rays = [This is the Trac macro *1, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 1-macro), backend='polymake') # optional - polymake
> > Expected nothing
> > Got:
> >      gmp v.6.1
> > ...
> > File "src/sage/geometry/polyhedron/backend_polymake.py", line 59, in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake
> > Failed example:
> >     p = Polyhedron(vertices=[(0,0),(1,0),(0,1)], rays=[(1,1)],   # optional - polymake
> >                    lines=[], backend='polymake')
> > Expected nothing
> > Got:
> >      gmp v.6.1
> > }}}
> Looks like this message comes from lrslib, I'll investigate

After the lrs fix on #27803, one of these 2 errors is still present:


```
File "src/sage/geometry/polyhedron/base.py", line 175, in sage.geometry.polyhedron.base.Polyhedron_base._sage_input_
Failed example:
    P = Polyhedron(vertices = [[1, 0], [0, 1]], rays = [[1, 1]], backend='polymake') # optional - polymake
Expected nothing
Got:
     gmp v.6.1
```



---

Comment by mkoeppe created at 2019-05-09 11:40:21

Yes, and with #27803 I can reproduce it. I think these errors appear non-deterministicaly.


---

Comment by dimpase created at 2019-05-09 11:47:50

Replying to [comment:38 mkoeppe]:
> Yes, and with #27803 I can reproduce it. I think these errors appear non-deterministicaly. 

I think it is deterministic, and occurs on the 1st invocation of the polymake interface.
Try starting Sage and running

```
P = Polyhedron(vertices = [[1, 0], [0, 1]], rays = [[1, 1]], backend='polymake')
```

repeatedly.


---

Comment by mkoeppe created at 2019-05-09 12:10:40

Replying to [comment:39 dimpase]:
> I think it is deterministic, and occurs on the 1st invocation of the polymake interface.
You are right.


---

Comment by mkoeppe created at 2019-05-09 12:25:47

The new behavior from this ticket comes from the fact that with the new in-process polymake, lrslib prints directly to stdout, so this output is not captured.
Perhaps lrslib should be configured with `LRS_QUIET`.


---

Comment by mkoeppe created at 2019-05-09 12:27:52

Replying to [comment:42 mkoeppe]:
> Perhaps lrslib should be configured with `LRS_QUIET`.
lrslib 070 removes this output unconditionally.


---

Comment by git created at 2019-05-09 13:00:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-09 13:02:30

The lrslib 070 update (#27745) is too much work for today. Instead I configure lrslib with LRS_QUIET (#27805).


---

Comment by dimpase created at 2019-05-09 15:06:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-05-09 15:06:55

OK, this is fixed by #27805 indeed.
----
New commits:


---

Comment by mkoeppe created at 2019-05-09 16:03:47

I've put the remaining minor issue to a follow-up ticket, #27807 (Polymake-jupymake interface: Fix polymake's error handling in Shell::Mock)


---

Comment by mkoeppe created at 2019-05-09 16:12:43

Should I make that last failing doctest less specific regarding the error message for this ticket? (Before it's fixed fully in #27807)


---

Comment by dimpase created at 2019-05-09 16:14:30

If you like, you can tag it "known error".


---

Comment by git created at 2019-05-09 16:20:22

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-05-09 16:20:22

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2019-05-10 10:00:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-11 13:40:52

Merge conflict


---

Comment by vbraun created at 2019-05-11 13:40:52

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-05-11 15:02:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-11 15:06:11

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-05-14 12:37:24

Resolution: fixed


---

Comment by mkoeppe created at 2019-07-21 20:33:19

The upstream package jupymake seems to be missing on the sage mirrors


---

Comment by jipilab created at 2019-07-28 11:40:09

Do I understand correctly that in the current version jupymake is necessary for polymake to function properly? Shouldn't jupymake become a dependancy of polymake?


---

Comment by mkoeppe created at 2019-07-29 23:13:05

Replying to [comment:58 jipilab]:
> Do I understand correctly that in the current version jupymake is necessary for polymake to function properly? Shouldn't jupymake become a dependancy of polymake?
No, there are two interface classes, which both work. `PolymakeExpect` (aliases to `Polymake`) and `PolymakeJupyMake`.
Depending on whether you have jupymake, `polymake` is set to an instance of one or the other.
