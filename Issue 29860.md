# Issue 29860: Several instances of MaximaLib

Issue created by migration from https://trac.sagemath.org/ticket/30097

Original creator: mkoeppe

Original creation time: 2020-07-09 03:08:25

CC:  dimpase nbruin jpflori charpent

Maxima essentially just uses a single Common Lisp package `:MAXIMA`.

After loading Maxima, we just rename the package and remove maxima from `*MODULES*`
Then we can load another copy.


```
sage: from sage.interfaces.maxima_lib import ecl_eval
sage: var('y', domain='real')
y
sage:  ecl_eval('''(symbol-package '$besselexpand)''')
<ECL: #<"MAXIMA" package>>
sage: ecl_eval('''(rename-package 'maxima "MINIMA")''')
<ECL: #<"MINIMA" package>>
sage:  ecl_eval('''(symbol-package '$besselexpand)''')
<ECL: #<"MINIMA" package>>
sage:  ecl_eval('''(require 'maxima)''')
<ECL: NIL>
sage: ecl_eval('''*modules*''')
<ECL: ("CMP" "SB-BSD-SOCKETS" "SOCKETS" "MAXIMA" "ECL-CDB" "BYTECMP")>
sage: ecl_eval('''(delete "MAXIMA" *modules* :test #'string=)''')
<ECL: ("CMP" "SB-BSD-SOCKETS" "SOCKETS" "ECL-CDB" "BYTECMP")>
sage:  ecl_eval('''(require 'maxima)''')
<ECL: ("MAXIMA")>
# loaded another copy!
```



---

Comment by mkoeppe created at 2020-07-09 06:00:32

New commits:


---

Comment by git created at 2020-07-09 06:51:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-09 06:55:03

Unfinished, setting it to needs-review so that the patchbot runs


---

Comment by mkoeppe created at 2020-07-09 06:55:03

Changing status from new to needs_review.


---

Comment by git created at 2020-07-09 07:55:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-09 08:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-09 08:10:59

More work to be done, but some preliminary testing makes sense


---

Comment by dimpase created at 2020-07-09 13:40:21

Are you planning to use this to switch SR to maxima_lib ?


---

Comment by mkoeppe created at 2020-07-09 14:03:04

`SR` is already using maxima_lib.


---

Comment by mkoeppe created at 2020-07-09 14:05:05

I hope to switch the remaining uses of maxima, mostly in doctests, to the second copy of `maxima_lib` when this ticket is ready, so that we can retire maxima_pexpect.


---

Comment by git created at 2020-07-09 14:36:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-09 14:57:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-09 15:10:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-09 15:32:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-09 15:44:36

Ready for testing/review


---

Comment by mkoeppe created at 2020-07-09 18:15:12

Some details still need to be fixed: 
 - When ECL objects are passed to an interface object, it needs to be checked that it is for the correct copy of the package. 
 - The doctests do not really test the second copy
 - Some doctests fail because things now print with their package:

```
File "src/sage/interfaces/maxima_lib_2.py", line 1509, in sage.interfaces.maxima_lib_2.dummy_integrate
Failed example:
    f.ecl()
Expected:
    <ECL: ((%INTEGRATE SIMP) (($F SIMP) $X) $X)>
Got:
    <ECL: ((MAXIMA_LIB::%INTEGRATE MAXIMA_LIB::SIMP)
     ((MAXIMA_LIB::$F MAXIMA_LIB::SIMP) MAXIMA_LIB::$X) MAXIMA_LIB::$X)>
```



---

Comment by git created at 2020-07-09 19:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2020-07-09 20:29:12

It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.

If you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:

https://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime

the trick would now be to somehow parametrize the name of the corresponding package in ecl, but that should be quite solvable (if all else fails, we could park a global counter somewhere outside the maxima_lib package -- for instance in ECL if all else fails -- that it can use to see how many copies already exist)

A thing to be careful about it that in CL, at least for the REPL, there is global state as to what the "current package" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.

--------

If we're going down this route, you probably want reconsider the placement of some of the initialization code too. I think there might be some things in maxima_lib that prime it towards  "calculus" use. Having a "vanilla" maxima_lib interface would be one of the uses I could see.


---

Comment by mkoeppe created at 2020-07-09 21:31:50

Replying to [comment:22 nbruin]:
> It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.

That's a good point and certainly worth checking; I hope we can find and change such uses as part of #30071.

But there are lots of uses of maxima in doctests too.  If we switch these ones over to `maxima_calculus`, this might be advertising potentially unsafe uses to users. 

And the doctests are what have prompted this ticket -- we currently have problems with the Maxima pexpect on Cygwin on #22191 (update ECL to 20.4.24).

Let's have this discussion -- on concrete uses of maxima -- on #30071.


---

Comment by mkoeppe created at 2020-07-09 21:35:02

Replying to [comment:22 nbruin]:
> If you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:
> 
> https://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime

Instead of doing this, I think it would be better to rewrite the Python module so that the module globals are placed in the interface object instead. Trivial to do, but a huge patch, which is why I haven't done this on this ticket.

> A thing to be careful about it that in CL, at least for the REPL, there is global state as to what the "current package" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.

Yes, my current code is taking care of this already. There are just some minor details remaining.


---

Comment by git created at 2020-07-10 05:07:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-10 21:51:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-11 19:51:58

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dimpase created at 2020-07-18 12:04:12

there are things like

```
sage -t --long --warn-long 177.3 src/doc/en/constructions/plotting.rst
**********************************************************************
File "src/doc/en/constructions/plotting.rst", line 216, in doc.en.constructions.plotting
Failed example:
    maxima.eval('load("plotdf");')
Expected:
    '".../share/maxima/.../share/dynamics/plotdf.lisp"'
Got:
    '\\"/home/scratch2/dimpase/sage/sage/local/share/maxima/5.42.2/share/dynamics/plotdf.lisp\\"'
**********************************************************************
```

and LISP errors such as

```
File "src/sage/symbolic/expression.pyx", line 12389, in sage.symbolic.expression.Expression.integral
Failed example:
    sin(x).integral(x)
Exception raised:
    Traceback (most recent call last):
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.integral[1]>", line 1, in <module>
        sin(x).integral(x)
      File "sage/symbolic/expression.pyx", line 12437, in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:64526)
        return integral(self, *args, **kwds)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py", line 963, in integrate
        return indefinite_integral(expression, v, hold=hold)
      File "sage/symbolic/function.pyx", line 1138, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12274)
        res = super(BuiltinFunction, self).__call__(
      File "sage/symbolic/function.pyx", line 602, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7051)
        res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py", line 117, in _eval_
        A = integrator(f, x)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/external.py", line 44, in maxima_integrator
        result = maxima.sr_integral(expression,v)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 877, in sr_integral
        return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 1763, in max_to_sr
        sage_expr=SR(maxima(expr))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/interface.py", line 303, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 472, in _coerce_from_special_method
        return MaximaLibElement(self,self._create(x))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 690, in _create
        maxima_eval([[msetq], maxima_read(name), value])
      File "sage/libs/ecl.pyx", line 852, in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:8507)
        return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))
      File "sage/libs/ecl.pyx", line 365, in sage.libs.ecl.ecl_safe_apply (build/cythonized/sage/libs/ecl.c:5835)
        raise RuntimeError("ECL says: {}".format(
    RuntimeError: ECL says: In form
    ((MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP) MAXIMA_LIB::|$_SAGE_VAR_x|)
    FUNCTION: Not a valid argument (MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP).
```



---

Comment by mkoeppe created at 2020-07-18 16:38:46

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
