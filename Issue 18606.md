# Issue 18606: Differentiable manifolds: vector fields and tensor fields

Issue created by migration from https://trac.sagemath.org/ticket/18843

Original creator: egourgoulhon

Original creation time: 2015-07-02 12:36:29

Assignee: egourgoulhon

CC:  mbejger bpillet bpage

Keywords: differentiable manifold, tensor field, vector field, differential form

This ticket implements tensor fields (among which vector fields and differential forms) on differentiable manifolds. This is a follow-up of #18783 within the [SageManifolds project](http://sagemanifolds.obspm.fr/) (see the metaticket #18528 for an overview). As in #18783, the topological field K over which the differentiable manifold is defined is generic (with sufficient structure to define differentiability, e.g. a complete metric field), although in most applications, K=*R* or K=*C*.

This ticket implements the following Python classes:

1/ Parent classes:
- `VectorFieldModule`: module of vector fields on a differentiable manifold
- `VectorFieldFreeModule`: free module of vector fields on a parallelizable differentiable manifold
- `TensorFieldModule`: module of tensor fields of a given type (k,l) on a differentiable manifold
- `TensorFieldFreeModule`: free module of tensor fields of a given type (k,l) on a parallelizable
  differentiable manifold
- `DiffFormModule`: module of differential forms of a given degree p (p-forms) on a differentiable
  manifold
- `DiffFormFreeModule`: free module of differential forms of a given degree p (p-forms) on a
  parallelizable differentiable manifold
- `AutomorphismFieldGroup`: general linear group of the module of vector fields on a differentiable
  manifold
- `AutomorphismFieldParalGroup`: general linear group of the free module of vector fields on a 
  parallelizable differentiable manifold

2/ Element classes:

- `TensorField`: tensor field on a differentiable manifold
  - `VectorField`: vector field on a differentiable manifold
  - `DiffForm`: p-form on differentiable manifold
  - `AutomorphismField`: field of tangent-space automorphisms on a differentiable manifold
- `TensorFieldParal`: tensor field on a parallelizable differentiable manifold
  - `VectorFieldParal`: vector field on a parallelizable differentiable manifold
  - `DiffFormParal`: p-form on parallelizable differentiable manifold
  - `AutomorphismFieldParal`: field of tangent-space automorphisms on a parallelizable differentiable
    manifold

3/ Other classes:

- `VectorFrame`: vector frame on a differentiable manifold
  - `CoordFrame`: coordinate vector frame on a differentiable manifold
- `CoFrame`: coframe (frame of 1-forms) on a differentiable manifold
  - `CoordCoFrame`: coordinate coframe on a differentiable manifold


---

Comment by git created at 2015-07-06 08:22:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-07 06:31:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-07 14:36:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-08 07:05:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-08 13:25:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-09 06:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-04 12:53:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-09 17:13:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-16 15:04:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-22 16:18:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-24 13:19:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-14 14:19:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-14 20:40:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-15 15:33:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by egourgoulhon created at 2015-10-15 20:57:19

Changing status from new to needs_review.


---

Comment by git created at 2015-10-19 09:23:12

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-11-18 15:37:18

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-11-22 15:08:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-22 16:56:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-02 16:29:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-06 22:38:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-18 11:26:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2016-01-03 20:01:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-11 20:29:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-30 13:23:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-06 15:51:10

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2016-05-10 12:39:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-13 12:18:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-06-24 14:47:58

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2016-06-24 14:47:58

Okay, here's the first round. Overall, the code looks okay, but I haven't check things in detail yet. I've made my way through most of the doc; there are likely some other doc fixes that I will need to do, but I've done a fair bit of clean-up. However, there are some issues:

- To run the tests on `tensorfield.py` takes ~172 seconds (that is after marking a bunch of them as `# long time`). This is too long IMO, and we need to either find a way to speed things up or simplify the tests somehow (smaller manifolds perhaps?) so they don't take so long. One or two non-trivial top-level examples are good. For the doctests, it just needs to be small examples showing the functionality. For any more complicated examples needed to do a more complete test should either be relatively small (in terms of number of lines) and be marked as `# long time` or you need to have a separate file with the complete examples where most (all?) tests are marked as `# long time`.

- I'm not sure about importing `xder` into the global namespace. `exterior_derivative` I am okay with since it is explicit, but `xder` is not a descriptive name IMO. If you want it, then you can import it in your `init.sage` file (in the `~/.sage` folder).

- I added some long versions of each of the names. It is good to at least have the long name. I actually changed `exterior_der` to `exterior_derivative`. I am not opposed to having an alias to `xder` though.

- While in general, it is good to adhere to 80 character lines, sometimes it just makes it harder read (which is why it is a guideline). I exercised some judgment and made some lines go over this because IMO they become easier to read.

- We will probably want to use the coercion framework, so `__mul__` which handles the scalar action should become `acted_upon` or `_rmul_` (and `_lmul_`).

I believe this is the biggest of the remaining SageManifolds tickets, so we just need to power through this and the rest should be easy...


---

Comment by egourgoulhon created at 2016-06-25 13:31:32

Replying to [comment:35 tscrim]:
> Okay, here's the first round.

Thank you very much for reviewing this!

> Overall, the code looks okay, but I haven't check things in detail yet. I've made my way through most of the doc; there are likely some other doc fixes that I will need to do, but I've done a fair bit of clean-up. However, there are some issues:
> 
> - To run the tests on `tensorfield.py` takes ~172 seconds (that is after marking a bunch of them as `# long time`). This is too long IMO, and we need to either find a way to speed things up or simplify the tests somehow (smaller manifolds perhaps?) so they don't take so long. One or two non-trivial top-level examples are good. For the doctests, it just needs to be small examples showing the functionality. For any more complicated examples needed to do a more complete test should either be relatively small (in terms of number of lines) and be marked as `# long time` or you need to have a separate file with the complete examples where most (all?) tests are marked as `# long time`.

OK I will try to shorten significantly the doctests. 

> 
> - I'm not sure about importing `xder` into the global namespace. `exterior_derivative` I am okay with since it is explicit, but `xder` is not a descriptive name IMO. If you want it, then you can import it in your `init.sage` file (in the `~/.sage` folder).

I agree `xder` is not as descriptive as `exterior_derivative`. Certainly the latter should be the primary function name. However for the end user manipulating a lot of differential forms, it is certainly desirable to have a short name (in addition to TAB completion), as `diff` is a short name for `derivative`. We may even think of a shorter name, like `xd`, as a reminder of the standard mathematical notation *d*.
> 
> - I added some long versions of each of the names. It is good to at least have the long name. I actually changed `exterior_der` to `exterior_derivative`. I am not opposed to having an alias to `xder` though.
> 
> - While in general, it is good to adhere to 80 character lines, sometimes it just makes it harder read (which is why it is a guideline). I exercised some judgment and made some lines go over this because IMO they become easier to read.

OK. 

> 
> - We will probably want to use the coercion framework, so `__mul__` which handles the scalar action should become `acted_upon` or `_rmul_` (and `_lmul_`).

Yes, this seems desirable. I'll try it.

> 
> I believe this is the biggest of the remaining SageManifolds tickets,

Yes, certainly.

> so we just need to power through this and the rest should be easy...


---

Comment by tscrim created at 2016-06-25 14:50:53

Replying to [comment:36 egourgoulhon]:
> Replying to [comment:35 tscrim]:
> > Okay, here's the first round.
> 
> Thank you very much for reviewing this!

No problem. Sorry its taken so long. Hopefully I can make it through this soon.

> > - I'm not sure about importing `xder` into the global namespace. `exterior_derivative` I am okay with since it is explicit, but `xder` is not a descriptive name IMO. If you want it, then you can import it in your `init.sage` file (in the `~/.sage` folder).
> 
> I agree `xder` is not as descriptive as `exterior_derivative`. Certainly the latter should be the primary function name. However for the end user manipulating a lot of differential forms, it is certainly desirable to have a short name (in addition to TAB completion), as `diff` is a short name for `derivative`. We may even think of a shorter name, like `xd`, as a reminder of the standard mathematical notation *d*.

We currently have no `differential` function, just its shorten `diff`, which is the Sage equivalent for `derivative`. I am not opposed to having an `xder` alias, just importing it into the global namespace (by default) as it is not a "standard" short name. However, you could include the import of `xder` as part of the examples/tutorials. I do think that `xder` is okay as a method alias for `exterior_derivative` as well.

IMO `xd`, like `d`, is too short and generic to be useful at the top-level.


---

Comment by egourgoulhon created at 2016-06-26 10:10:24

Replying to [comment:37 tscrim]:
> 
> We currently have no `differential` function, just its shorten `diff`, which is the Sage equivalent for `derivative`. I am not opposed to having an `xder` alias, just importing it into the global namespace (by default) as it is not a "standard" short name. However, you could include the import of `xder` as part of the examples/tutorials. 

I agree that the exterior derivative is too specialized to have it in the global namespace of any sage session. On the other side, end users working with differential forms may feel cumbersome to perform some import in each of their sessions. A solution could be to modify the top function `Manifold` so that it imports `xder` into the global namespace. Is such a thing possible/desirable?


---

Comment by tscrim created at 2016-06-26 13:17:43

Replying to [comment:38 egourgoulhon]:
> Replying to [comment:37 tscrim]:
> > 
> > We currently have no `differential` function, just its shorten `diff`, which is the Sage equivalent for `derivative`. I am not opposed to having an `xder` alias, just importing it into the global namespace (by default) as it is not a "standard" short name. However, you could include the import of `xder` as part of the examples/tutorials. 
> 
> I agree that the exterior derivative is too specialized to have it in the global namespace of any sage session. On the other side, end users working with differential forms may feel cumbersome to perform some import in each of their sessions. A solution could be to modify the top function `Manifold` so that it imports `xder` into the global namespace. Is such a thing possible/desirable? 

This is what the `init.sage` is for. It is called every time Sage is loaded. I feel that one import to setup an environment with a convenience function is very little to ask. IMO, it is not good for the entry point `Manifold` to have side effects.


---

Comment by egourgoulhon created at 2016-06-26 13:50:17

Replying to [comment:39 tscrim]:
> Replying to [comment:38 egourgoulhon]:
> > I agree that the exterior derivative is too specialized to have it in the global namespace of any sage session. On the other side, end users working with differential forms may feel cumbersome to perform some import in each of their sessions. A solution could be to modify the top function `Manifold` so that it imports `xder` into the global namespace. Is such a thing possible/desirable? 
> 
> This is what the `init.sage` is for. It is called every time Sage is loaded.

What about the SageMathCloud? It's certainly technically possible to define some `init.sage` there, but one has to open a terminal and edit a file, etc.

Also a drawback of `init.sage` is that your worksheets cannot easily be shared with somebody else, or made publicly available for repeating the calculation.

> I feel that one import to setup an environment with a convenience function is very little to ask. IMO, it is not good for the entry point `Manifold` to have side effects.

What about `Manifold.import_convenience_functions(verbose=True)` or something like this? It could 
(i) put functions like `xder` in the global namespace and (ii) print out the list of such functions if `verbose` is `True`.


---

Comment by egourgoulhon created at 2016-06-26 14:00:27

Replying to [comment:40 egourgoulhon]:
> 
> What about `Manifold.import_convenience_functions(verbose=True)` or something like this? It could 
> (i) put functions like `xder` in the global namespace and (ii) print out the list of such functions if `verbose` is `True`.

Granted: `from sage.manifolds.utilities import xder` is as short to write...


---

Comment by tscrim created at 2016-06-26 14:02:02

Replying to [comment:40 egourgoulhon]:
> Replying to [comment:39 tscrim]:
> > Replying to [comment:38 egourgoulhon]:
> > > I agree that the exterior derivative is too specialized to have it in the global namespace of any sage session. On the other side, end users working with differential forms may feel cumbersome to perform some import in each of their sessions. A solution could be to modify the top function `Manifold` so that it imports `xder` into the global namespace. Is such a thing possible/desirable? 
> > 
> > This is what the `init.sage` is for. It is called every time Sage is loaded.
> 
> What about the SageMathCloud? It's certainly technically possible to define some `init.sage` there, but one has to open a terminal and edit a file, etc.
> 
> Also a drawback of `init.sage` is that your worksheets cannot easily be shared with somebody else, or made publicly available for repeating the calculation.

For SMC worksheets, you can easily have the setup in an `%auto` block.

> > I feel that one import to setup an environment with a convenience function is very little to ask. IMO, it is not good for the entry point `Manifold` to have side effects.
> 
> What about `Manifold.import_convenience_functions(verbose=True)` or something like this? It could 
> (i) put functions like `xder` in the global namespace and (ii) print out the list of such functions if `verbose` is `True`.

That is no different than doing a usual import. I guess a question that I have is how many such functions do you think there will eventually be?


---

Comment by egourgoulhon created at 2016-06-26 14:09:32

Replying to [comment:42 tscrim]:
> > 
> > What about `Manifold.import_convenience_functions(verbose=True)` or something like this? It could 
> > (i) put functions like `xder` in the global namespace and (ii) print out the list of such functions if `verbose` is `True`.
> 
> That is no different than doing a usual import.

Yes I realized this just after posting my comment...

> I guess a question that I have is how many such functions do you think there will eventually be?

Not much... So let's stay with the usual import ;-)


---

Comment by git created at 2016-06-28 14:35:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-06-28 14:53:48

Replying to [comment:35 tscrim]:
> - To run the tests on `tensorfield.py` takes ~172 seconds (that is after marking a bunch of them as `# long time`). This is too long IMO, and we need to either find a way to speed things up or simplify the tests somehow (smaller manifolds perhaps?) so they don't take so long. One or two non-trivial top-level examples are good. For the doctests, it just needs to be small examples showing the functionality. For any more complicated examples needed to do a more complete test should either be relatively small (in terms of number of lines) and be marked as `# long time` or you need to have a separate file with the complete examples where most (all?) tests are marked as `# long time`.

By selecting simpler examples, the last commit decreases by a factor ~2 the doctest time of `tensorfield.py`. It's difficult to go below this because the manifold dimension is already at its minimum (for a non-parallelizable manifold): it is 2 for all tests.

> 
> - I'm not sure about importing `xder` into the global namespace. `exterior_derivative` I am okay with since it is explicit, but `xder` is not a descriptive name IMO. If you want it, then you can import it in your `init.sage` file (in the `~/.sage` folder).

`xder` is no longer in the global namespace. I've also suppressed `exterior_derivative`, but maybe we can restore the latter, as you suggest. 


> 
> - I added some long versions of each of the names. It is good to at least have the long name. I actually changed `exterior_der` to `exterior_derivative`. I am not opposed to having an alias to `xder` though.

In the same spirit, I have renamed `lie_der` to `lie_derivative` and set `lie_der` as an alias to it. 
> 
> 
> - We will probably want to use the coercion framework, so `__mul__` which handles the scalar action should become `acted_upon` or `_rmul_` (and `_lmul_`).
> 

Actually `_rmul_` is already implemented in tensor fields and handles the scalar action. The current `__mul__` handles mostly the tensor product. Since this is an external operation (w.r.t. the parent module), I am not sure that it can be changed to some single underscore method within the coercion framework. Note that we already had `__mul__` for handling tensor products in ` sage.tensor.modules.free_module_tensor.FreeModuleTensor`.


---

Comment by egourgoulhon created at 2016-06-28 14:54:09

Changing status from needs_work to needs_review.


---

Comment by bpage created at 2016-08-17 15:43:57

I checked out this commit with 7.4 beta0.  All of my Jupyter worksheets that use forms and vectors seem to work fine.  I would like to encourage you to include this functionality in Sage in the next possible release. I would give this a positive review except that the commit is still based on an older release of Sage and that milestone has passed.


---

Comment by tscrim created at 2016-08-17 23:40:05

I am (still) making my way through my second pass of the code and doc, but hopefully soon I will have finished.


---

Comment by egourgoulhon created at 2016-08-18 11:42:47

Replying to [comment:49 tscrim]:
> I am (still) making my way through my second pass of the code and doc, but hopefully soon I will have finished.

Thanks for this update and your work on this.

Replying to [comment:47 bpage]: good to know that all your Jupyter worksheets passed. However, we should really wait for Travis detailed review before concluding with this ticket.


---

Comment by git created at 2016-10-01 16:33:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-10-01 16:37:28

I (finally) made it through the code again, and most of my changes were smaller documentation cleanups and fixes. I changed some custom caching into ``@`cached_method` (IIRC it is faster) and separated out the zero element into `zero` (with ``@`cached_method`). If you're good with my changes, then we can set this to positive review (and hopefully sneak this into 7.4).


---

Comment by git created at 2016-10-02 15:49:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-10-02 16:14:32

Replying to [comment:52 tscrim]:
> I (finally) made it through the code again, and most of my changes were smaller documentation cleanups and fixes. I changed some custom caching into ``@`cached_method` (IIRC it is faster) and separated out the zero element into `zero` (with ``@`cached_method`).

Thank you very much for your review and the changes in the code!

I've committed a few minor changes: besides fixing some documentation error (missing blank line),
- this reverts to the previous version of comparison to zero in `TensorField.__eq__`: indeed the following code in commit 7cf4ff4 

```
 if other == 0:
     return self.is_zero()
 elif other in ZZ:
     return False
```

  could return True for `a == b` with `a` being a zero vector, say, and `b` being a zero 2-form. We do not want this behavior, do we? We should only allow for the possibility to write `a == 0` as a shortcut for `a.is_zero()`. 
- this changes some syntax to make the code compatible with Python 3 (in view of the future migration): all the `.itervalues()` and `.iteritems()` have been replaced by `.values()` and `.items()` respectively. I've not used the functions `itervalues` and `iteritems` from `six`, since all dictionaries are small and changing from an iterator to a list (in the Python 2.7 version) should not make a big difference (for instance, I've checked that there is no change in the doctest time). 

> If you're good with my changes, then we can set this to positive review (and hopefully sneak this into 7.4).

It's OK for me ;-)


---

Comment by tscrim created at 2016-10-02 16:54:25

I'm okay with your changes modulo the straight revert to this `isinstance(other, (int, Integer))`. What if `other = QQ.zero()`? A better check (if slightly more in terms of time) is `other in ZZ`:

```
sage: vector([0,0,0]) == 0
True
sage: vector([0,0,0]) in ZZ
False
```

Although in principle, the comparison `a == b` should convert to a common parent...


---

Comment by git created at 2016-10-02 18:35:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-10-02 18:41:33

Replying to [comment:55 tscrim]:
> A better check (if slightly more in terms of time) is `other in ZZ`:
OK, I've implemented it in the last commit.


---

Comment by tscrim created at 2016-10-02 20:57:35

Thanks.


---

Comment by tscrim created at 2016-10-02 20:57:35

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2016-10-02 21:07:49

Thank you for the detailed review work and the resulting enhancement of the code!


---

Comment by vbraun created at 2016-10-03 18:32:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-10-03 18:32:37


```
[dochtml] OSError: [manifolds] /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/manifolds/chart.py:docstring of sage.manifolds.chart:21: WARNING: citation not found: Lee13
```



---

Comment by git created at 2016-10-03 18:51:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-10-03 18:54:14

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2016-10-03 18:54:14

Replying to [comment:60 vbraun]:
> {{{
> [dochtml] OSError: [manifolds] /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/manifolds/chart.py:docstring of sage.manifolds.chart:21: WARNING: citation not found: Lee13
> }}}
Oups! Sorry about this.
The last commit adds the missing reference.


---

Comment by egourgoulhon created at 2016-10-03 19:27:36

Having checked that, after a make doc-clean && make doc, the issue is fixed, I am taking the liberty of setting the ticket back to posivite review.


---

Comment by egourgoulhon created at 2016-10-03 19:27:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-19 20:42:28

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-10-19 20:42:28

Conflicts with #21454


---

Comment by git created at 2016-10-22 10:21:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-10-22 15:29:40

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2016-10-22 15:29:40

Replying to [comment:64 vbraun]:
> Conflicts with #21454
Fixed!


---

Comment by tscrim created at 2016-10-22 20:01:22

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2016-10-23 09:38:04

Replying to [comment:67 tscrim]:

Thanks!


---

Comment by vbraun created at 2016-10-29 14:26:50

Resolution: fixed
