# Issue 20318: descents for Permutations : cleanup

Issue created by migration from https://trac.sagemath.org/ticket/20555

Original creator: chapoton

Original creation time: 2016-05-04 12:17:33

CC:  hivert tscrim darij nthiery stumpc5

the descents in permutations need a little care to behave like the
other Coxeter groups. Let us do that.

As a benefit, the descents will now follow the usual combinatorics convention.

Plus adding a new test in the testesuite of Coxeter groups.


---

Comment by chapoton created at 2016-05-04 12:19:48

Changing status from new to needs_review.


---

Comment by chapoton created at 2016-05-04 12:19:48

Changing keywords from "" to "permutation".


---

Comment by chapoton created at 2016-05-04 12:19:48

New commits:


---

Comment by git created at 2016-05-04 12:34:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-04 14:03:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-05-04 14:12:39

There is a (very) good reason for descents of permutations to be 0-based indices: they correspond to the positions in the list, which are also 0-based, where there is a descent. This is also a perfectly valid definition and almost certainly corresponds to the initial definition of a descent. Personally I am for switching the descents convention, but this is a major backwards incompatible change that is highly likely to break personal code. Also there will not be deprecation period. Much care must be taken here.

A possible way to introduce a deprecation would be to have an optional argument to `descents` for being 0-based, which is `True` by default. If this argument is `True`, then we print a deprecation warning. At the very least, this requires a posting of sage(-combinat)-devel notifying of the behavior change.


---

Comment by stumpc5 created at 2016-05-04 14:14:47

I am personally not totally convinced that this change is the right way to go - I think it is a typical example that it is simply very hard to make notions that are consistent all over sage:

1. Let w be a finite word in a totally ordered alphabet,say {1,...,n}. Its descents are the positions i such that w_i > w_{i+1}. Since python indexes words (or rather lists/tuples) starting with 0, it is natural to write w = w_0 w_1 ... w_m.

2. Let w be a permutation of {1,...,n}. A descent of w is an index i such that w*(i i+1) ls weak order smaller than w. But on the other hand, its one-line notation is a word, it inherits the notion of descents from above, which now differs in a shift by 1.

(There are tons of other examples already in the combinatorics part of sage, and the category framework makes that *really* hard to properly organize imho.)


---

Comment by stumpc5 created at 2016-05-04 14:15:54

(only now seeing that Travis also answered similarly some secs earlier...)


---

Comment by git created at 2016-05-05 06:44:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-05 07:18:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-08 09:01:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-05-08 19:36:40

ok, guys. I have added a from_zero argument in the descents of permutations.

Given that our permutations are indexed by 1,...,n, I really think that there is no
good reason to have the descents starting at 0. But of course, one need to be user-friendly, so let us for the moment just prepare for this change.

The branch would work if I disactivate the test for descents in the testsuites for permutations.

I propose to do that, and also to add a deprecation when using `from_zero=True`
even if it looks rather strange to me to do that for a default value of the argument.

Any comments ?


---

Comment by stumpc5 created at 2016-05-09 09:18:47

There are now a few testsuite failures. Beside from that, I am okay with the new procedure to handle the descents in permutations.


---

Comment by git created at 2016-05-09 11:23:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-10 08:54:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-05-11 06:29:06

ok, patchbot is green, and ticket ready for review


---

Comment by stumpc5 created at 2016-05-11 08:29:36

A few minor questions:

```
+            for i in self.index_set():
+                si = s[i]
+                tester.assert_(i in si.descents(side='left'))
+                tester.assert_(i in si.descents(side='right'))
+                tester.assert_(i not in si.descents(positive=True, side='left'))
+                tester.assert_(i not in si.descents(positive=True, side='right'))
```

* Is it correct to test `self.index_set`, which could in principle be different from {1,...,n}?
* You could possibly be even more specific on the assertions, such as `[i] == si.descents(side='left')`.


```
+ d = [0] + self.descents(from_zero=False) + [len(self)]
```

* Isn't this `+ [len(self)]` exactly the `final_descent` flag?


---

Comment by git created at 2016-05-11 09:08:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-05-11 09:09:34

Thanks for having a look.

I do not understand you first point.

I changed the second point, but now we need to wait and see if the patchbot is still green.

I changed the third point too.


---

Comment by stumpc5 created at 2016-05-11 09:32:20

> I do not understand you first point.

Maybe I misunderstand the `tester`, but isn't this test supposed to pass always? What if I use `index_set = ['A','B','C']`, would it still pass then with this test?


```
tester.assert_(i not in si.descents(positive=True, side='left'))
tester.assert_(i not in si.descents(positive=True, side='right'))
```

If you want, you could be also explicit in those tests.

Beside those two points, I give it a positive review given the patchbot turns green.


---

Comment by chapoton created at 2016-05-11 09:41:38

Concerning the first point, the very same kind of loop over self.index_set is already used in the similar method `test_has_descent` just above in the code. So in general I think we do expect descents to be elements of the index set.

Concerning the second point, should I really change that ? I would prefer not to.


---

Comment by stumpc5 created at 2016-05-11 09:56:05

> So in general I think we do expect descents to be elements of the index set.

I see, I was actually missing this point before.

> Concerning the second point, should I really change that ? I would prefer not to.

Okay, your decision.

Waiting for the patchbot, and also for Travis' okay...


---

Comment by chapoton created at 2016-05-11 11:19:56

bot is green.


---

Comment by tscrim created at 2016-05-11 14:24:08

Sorry for the delay in my comments. Here they are:

- I think it is better to use the more explicit `tester.assertEqual` and `tester.assertNotIn` (they have better default error messages).
- You also need to have some sort of warning message saying that the behavior of `ParkingFunction.ides` has changed.
- Some docstring changes:
  {{{#!diff
         INPUT:
 
-        - ``final_descent`` -- optional boolean (default ``False``)
-          If ``True``, the last position of a non-empty
-          permutation is also considered as a descent.
+        - ``final_descent`` -- boolean (default ``False``);
+          if ``True``, the last position of a non-empty
+          permutation is also considered as a descent
 
-        - ``side`` -- optional, ``'right'`` (default) or ``'left'``
-          If ``'left'``, return the descents of the inverse permutation.
+        - ``side`` -- ``'right'`` (default) or ``'left'``;
+          if ``'left'``, return the descents of the inverse permutation
 
-        - ``positive`` -- optional boolean (default ``False``)
-          If ``True``, return the positions that are not descents.
+        - ``positive`` -- boolean (default ``False``);
+          if ``True``, return the positions that are not descents
 
-        - ``from_zero`` -- optional boolean (default ``True``)
-          If ``False``, return the positions starting from `1`
+        - ``from_zero`` -- boolean (default ``True``);
+          if ``False``, return the positions starting from `1`
  }}}
  Similarly for `idescents`.
- Your deprecation message does not match the docstring. If `from_zero` is going to be removed, we should explicitly state in that in the docstring. Also the default behavior either will change or this argument should not be deprecated.


As a counterpoint, the (very) good reasons that descents start at 0 is because Python uses 0-based indexing:

```
sage: p = Permutation([5,3,2,4,1])
sage: p.descents()
[0, 1, 3]
sage: p[0]
5
```

This would break this behavior with the current branch, and actually, thinking a bit more now about it, we should add some documentation to this point.
(I am pretty sure the position of the descent must correspond to the position of the larger value for the related math to work, but it's been awhile since I've thought about these things.)

However, I think with sufficient advertising on sage-devel and this deprecation, the migration should be smooth.


---

Comment by git created at 2016-05-11 16:24:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-05-12 08:48:40

Replying to [comment:26 tscrim]:
> As a counterpoint, the (very) good reasons that descents start at 0 is because Python uses 0-based indexing:
> {{{
> sage: p = Permutation([5,3,2,4,1])
> sage: p.descents()
> [0, 1, 3]
> sage: p[0]
> 5
> }}}
> This would break this behavior with the current branch, and actually, thinking a bit more now about it, we should add some documentation to this point.
> (I am pretty sure the position of the descent must correspond to the position of the larger value for the related math to work, but it's been awhile since I've thought about these things.)

I do totally agree with the math part. But I am less convinced of the sage part:

```
sage: p = Permutation([5,3,2,4,1])
sage: p[0]
5
```

I would consider `p[0]` an implementation detail (as this might mean something in one-line notation, or the first cycle in cycle decomposition, or whatever else, depending on the implementation of permutations) and not a mathematically well-defined operation. In my eyes, the mathematical operation is

```
sage: p(1)
5
```

which matches Frédéric's indexing.


---

Comment by tscrim created at 2016-05-12 23:30:36

Replying to [comment:28 stumpc5]:
> Replying to [comment:26 tscrim]:
> I would consider `p[0]` an implementation detail (as this might mean something in one-line notation, or the first cycle in cycle decomposition, or whatever else, depending on the implementation of permutations) and not a mathematically well-defined operation. In my eyes, the mathematical operation is
> {{{
> sage: p(1)
> 5
> }}}
> which matches Frédéric's indexing.

If you think of the permutation as an automorphism of [n], yes, but if you think of it as an ordering of [n] written as (p<sub>0</sub>, p<sub>1</sub>, ..., p<sub>n-1</sub>), then `p[i]` corresponds to p<sub>i</sub>. So it is a little more than an implementation detail. Moreover, this perspective makes the descent set independent of the index set and/or the objects we are permuting.

Also, what is both of your opinions on removing the `from_zero` option or just changing the default?

`@`chapoton Thanks for the changes.


---

Comment by chapoton created at 2016-05-13 06:56:13

I would rather just change the default value of `from_zero`, after one year of deprecation.


---

Comment by stumpc5 created at 2016-05-13 07:52:45

Replying to [comment:29 tscrim]:
> If you think of the permutation as an automorphism of [n], yes, but if you think of it as an ordering of [n] written as (p<sub>0</sub>, p<sub>1</sub>, ..., p<sub>n-1</sub>), then `p[i]` corresponds to p<sub>i</sub>. So it is a little more than an implementation detail. Moreover, this perspective makes the descent set independent of the index set and/or the objects we are permuting.

A priori, one could consider the list [Travis,Frédéric,Christian] a permutation, but one cannot multiply such permutations (in contrary to permutations in Sage). I think, you implicitly expect the objects to be totally ordered (that is actually also needed to define descents in the first place) and indeed in bijection with {1,...,n} or {0,...,n-1}, and the list just to be one-line notation for the bijection.

I more believe our "argument" is closer to the surface: it is mathematically more common to start labelling with 1, so it was decided to have permutations of {1,...,n} per default instead of {0,...,n-1}, and it is pythonically more common to start labelling with 0. These two handmade choices conflict whenever they meet in the code, and one has to choose one over the other to go on.

Indeed, I think it would have been better to make permutations  on {0,...,n-1} standard, and as well indexing sets. This would
* have generally not resulted in the above conflict,
* result in many speed improvements everywhere, see
   {{{
   sage: %timeit p[0]
   1000000 loops, best of 3: 610 ns per loop
   sage: %timeit p(1)
   100000 loops, best of 3: 2.74 µs per loop
   }}}
* cleaner code as one does not always need to do the +1/-1 thing for lookups (see the code on reflection groups).

But that choice is made and not reversible, so we have to argue what to do whenever we see that conflict appearing.

> Also, what is both of your opinions on removing the `from_zero` option or just changing the default?

I do not have a strong opinion there, both choices have their rights to be taken. If I'd do it myself, I would maybe leave the option and make it `from_one` per default. (I would also make the name of the option the default behaviour, don't you think so?)


---

Comment by tscrim created at 2016-05-13 16:29:04

Since we are only wanting to change the default behavior, we should have the default value be `None` (not necessarily changing the doc), where we emit the deprecation warning in this case. That way when someone explicitly passes `True`, they don't needlessly see the deprecation warning (as their code will correctly work once we change the default behavior).

Also, do we want to call the option `from_zero` or `from_one`? It is better to make that decision here.


---

Comment by git created at 2016-05-13 18:20:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-05-15 07:49:01

I would rather keep `from_zero`. After the change of default value, it will be the best name in my opinion.


---

Comment by tscrim created at 2016-05-15 14:15:17

This LGTM. Christian?


---

Comment by stumpc5 created at 2016-05-15 16:26:39

I still see one ```from_zero`` -- boolean (default ``True``)` which should be `(default ``None``)` and don't have a computer currently to change it. Beside that, it's good to go I think.


---

Comment by chapoton created at 2016-05-15 16:27:30

None is a technical detail. It does indeed default to True


---

Comment by tscrim created at 2016-05-15 16:28:29

The default "is" `True`, it's just we need the actual to be `None` for technical reasons (the deprecation warning).


---

Comment by stumpc5 created at 2016-05-15 16:33:24

Changing status from needs_review to positive_review.


---

Comment by stumpc5 created at 2016-05-15 16:33:24

Well, okay then...


---

Comment by vbraun created at 2016-05-19 22:38:45

Resolution: fixed
