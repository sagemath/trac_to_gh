# Issue 26755: Fix new (lib) gap on py3

archive/issues_026755.json:
```json
{
    "body": "CC:  chapoton embray jdemeyer\n\nThere are py3-specific bugs in the new lib gap, as of #22626.\nSome of them stem from error handler not being fully string/bytes clean.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26992\n\n",
    "created_at": "2019-01-02T03:54:14Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Fix new (lib) gap on py3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26755",
    "user": "dimpase"
}
```
CC:  chapoton embray jdemeyer

There are py3-specific bugs in the new lib gap, as of #22626.
Some of them stem from error handler not being fully string/bytes clean.

Issue created by migration from https://trac.sagemath.org/ticket/26992





---

archive/issue_comments_376261.json:
```json
{
    "body": "reducing the number of words in that string:\n\n```\nsage:  libgap.eval('Complex Field with;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nThe above exception was the direct cause of the following exception:\n\nSystemError                               Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)()\n    508     if msg != NULL:\n    509         msg_py = char_to_str(msg)\n--> 510         msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n    511                                 'NoMethodFound\\n', '').strip()\n    512     else:\n\nSystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set\nException ignored in: 'sage.libs.gap.util.error_handler'\nTraceback (most recent call last):\n  File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\nSystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-b7d3bc318a36> in <module>()\n----> 1 libgap.eval('Complex Field with;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)()\n    440         if nresults > 1:  # to mimick the old libGAP\n    441             # TODO: Get rid of this restriction eventually?\n--> 442             raise ValueError('can only evaluate a single statement')\n    443 \n    444         # Get the result of the first statement\n\nValueError: can only evaluate a single statement\n```\n\nstill the same\n\n\n```\nsage:  libgap.eval('Complex Field;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()\n    430         GAP_Enter()\n--> 431         result = GAP_EvalString(cmd)\n    432         # We can assume that the result object is a GAP PList (plain list)\n\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nDuring handling of the above exception, another exception occurred:\n\nValueError                                Traceback (most recent call last)\n<ipython-input-2-124a0085564b> in <module>()\n----> 1 libgap.eval('Complex Field;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()\n    459         return ELM0_LIST(result, 2)\n    460     except RuntimeError as msg:\n--> 461         raise ValueError(f'libGAP: {msg}')\n    462     finally:\n    463         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\n```\n\nthis is different, more sane - this is treated as a single statement, at least.\n\n\n```\nsage:  libgap.eval('Complex;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()\n    430         GAP_Enter()\n--> 431         result = GAP_EvalString(cmd)\n    432         # We can assume that the result object is a GAP PList (plain list)\n\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nDuring handling of the above exception, another exception occurred:\n\nValueError                                Traceback (most recent call last)\n<ipython-input-4-4f8aa29a844d> in <module>()\n----> 1 libgap.eval('Complex;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()\n    459         return ELM0_LIST(result, 2)\n    460     except RuntimeError as msg:\n--> 461         raise ValueError(f'libGAP: {msg}')\n    462     finally:\n    463         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\n```\n\nlooks OK.",
    "created_at": "2019-01-02T09:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376261",
    "user": "dimpase"
}
```

reducing the number of words in that string:

```
sage:  libgap.eval('Complex Field with;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
RuntimeError: Error, Variable: 'Complex' must have a value

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)()
    508     if msg != NULL:
    509         msg_py = char_to_str(msg)
--> 510         msg_py = msg_py.replace('For debugging hints type ?Recovery from '
    511                                 'NoMethodFound\n', '').strip()
    512     else:

SystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set
Exception ignored in: 'sage.libs.gap.util.error_handler'
Traceback (most recent call last):
  File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
SystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-b7d3bc318a36> in <module>()
----> 1 libgap.eval('Complex Field with;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)()
    440         if nresults > 1:  # to mimick the old libGAP
    441             # TODO: Get rid of this restriction eventually?
--> 442             raise ValueError('can only evaluate a single statement')
    443 
    444         # Get the result of the first statement

ValueError: can only evaluate a single statement
```

still the same


```
sage:  libgap.eval('Complex Field;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()
    430         GAP_Enter()
--> 431         result = GAP_EvalString(cmd)
    432         # We can assume that the result object is a GAP PList (plain list)

RuntimeError: Error, Variable: 'Complex' must have a value

During handling of the above exception, another exception occurred:

ValueError                                Traceback (most recent call last)
<ipython-input-2-124a0085564b> in <module>()
----> 1 libgap.eval('Complex Field;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()
    459         return ELM0_LIST(result, 2)
    460     except RuntimeError as msg:
--> 461         raise ValueError(f'libGAP: {msg}')
    462     finally:
    463         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
```

this is different, more sane - this is treated as a single statement, at least.


```
sage:  libgap.eval('Complex;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()
    430         GAP_Enter()
--> 431         result = GAP_EvalString(cmd)
    432         # We can assume that the result object is a GAP PList (plain list)

RuntimeError: Error, Variable: 'Complex' must have a value

During handling of the above exception, another exception occurred:

ValueError                                Traceback (most recent call last)
<ipython-input-4-4f8aa29a844d> in <module>()
----> 1 libgap.eval('Complex;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()
    459         return ELM0_LIST(result, 2)
    460     except RuntimeError as msg:
--> 461         raise ValueError(f'libGAP: {msg}')
    462     finally:
    463         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
```

looks OK.



---

archive/issue_comments_376262.json:
```json
{
    "body": "And with python2 one gets the intended (roughly, what GAP reports):\n\n```\nsage:  libgap.eval('Complex Field with 53 bits of precision;')\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-8255f9147a12> in <module>()\n----> 1 libgap.eval('Complex Field with 53 bits of precision;')\n\n/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6563)()\n    473         return ELM0_LIST(result, 2)\n    474     except RuntimeError as msg:\n--> 475         raise ValueError(f'libGAP: {msg}')\n    476     finally:\n    477         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^\nError, Variable: 'with' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^^^^^^^^^\nError, Variable: 'bits' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nError, Variable: 'precision' must have a value\n```\n",
    "created_at": "2019-01-02T09:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376262",
    "user": "dimpase"
}
```

And with python2 one gets the intended (roughly, what GAP reports):

```
sage:  libgap.eval('Complex Field with 53 bits of precision;')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-8255f9147a12> in <module>()
----> 1 libgap.eval('Complex Field with 53 bits of precision;')

/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6563)()
    473         return ELM0_LIST(result, 2)
    474     except RuntimeError as msg:
--> 475         raise ValueError(f'libGAP: {msg}')
    476     finally:
    477         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^
Error, Variable: 'with' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^^^^^^^^^
Error, Variable: 'bits' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Error, Variable: 'precision' must have a value
```




---

archive/issue_comments_376263.json:
```json
{
    "body": "The error comes from the new-style-formatted string in\n\n```\n--> 475    raise ValueError(f'libGAP: {msg}')\n```\n\nAnd indeed, this looks very dangerous coding style, as `f'` formatting allows Python expressions inside, and so a carefully constructed GAP error message may do really fun things...",
    "created_at": "2019-01-02T10:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376263",
    "user": "dimpase"
}
```

The error comes from the new-style-formatted string in

```
--> 475    raise ValueError(f'libGAP: {msg}')
```

And indeed, this looks very dangerous coding style, as `f'` formatting allows Python expressions inside, and so a carefully constructed GAP error message may do really fun things...



---

archive/issue_comments_376264.json:
```json
{
    "body": "No, actually, it's merely GAP producing a string that needs extra sanitation (in Python3).\nSpecifically, if I do the following\n\n```\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -507,8 +507,8 @@ cdef object extract_libgap_errout():\n     msg = CSTR_STRING(r)\n     if msg != NULL:\n         msg_py = char_to_str(msg)\n-        msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n-                                'NoMethodFound\\n', '').strip()\n+        #msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n+        #                        'NoMethodFound\\n', '').strip()\n     else:\n         # Shouldn't happen but just in case...\n         msg_py = \"\"\n```\n\nthen all the tests on this file pass.\n\nSo, somehow, Python3 cannot correctly do search/replace/strip here, while Python2 can.\nAny idea what to do?",
    "created_at": "2019-01-02T10:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376264",
    "user": "dimpase"
}
```

No, actually, it's merely GAP producing a string that needs extra sanitation (in Python3).
Specifically, if I do the following

```
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -507,8 +507,8 @@ cdef object extract_libgap_errout():
     msg = CSTR_STRING(r)
     if msg != NULL:
         msg_py = char_to_str(msg)
-        msg_py = msg_py.replace('For debugging hints type ?Recovery from '
-                                'NoMethodFound\n', '').strip()
+        #msg_py = msg_py.replace('For debugging hints type ?Recovery from '
+        #                        'NoMethodFound\n', '').strip()
     else:
         # Shouldn't happen but just in case...
         msg_py = ""
```

then all the tests on this file pass.

So, somehow, Python3 cannot correctly do search/replace/strip here, while Python2 can.
Any idea what to do?



---

archive/issue_comments_376265.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-01-02T10:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376265",
    "user": "dimpase"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_376266.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2019-01-02T13:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376266",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_376267.json:
```json
{
    "body": "The main issue here (which I've encountered before in other contexts) is that in Python 3 a lot of the interpreter and core types and modules are much stricter about checking whether or not an exception is already pending before trying to go down various code paths (without this you can end up in strange situations where built-in methods get called even after an exception has been raised).\n\nIn this case, the code in the error handler which manipulates the exception message (using Python) could break if the error handler was entered recursively, so it had to be reorganized slightly to account for this possibility.\n\nI also added `with gil` to both the error handler callback and the gasman callback: Although this isn't strictly necessary at the moment (it seems we don't release the GIL when entering libgap code) this was my first suspicion, and it's a good thing to do anyways just in case.\n----\nNew commits:",
    "created_at": "2019-01-02T13:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376267",
    "user": "embray"
}
```

The main issue here (which I've encountered before in other contexts) is that in Python 3 a lot of the interpreter and core types and modules are much stricter about checking whether or not an exception is already pending before trying to go down various code paths (without this you can end up in strange situations where built-in methods get called even after an exception has been raised).

In this case, the code in the error handler which manipulates the exception message (using Python) could break if the error handler was entered recursively, so it had to be reorganized slightly to account for this possibility.

I also added `with gil` to both the error handler callback and the gasman callback: Although this isn't strictly necessary at the moment (it seems we don't release the GIL when entering libgap code) this was my first suspicion, and it's a good thing to do anyways just in case.
----
New commits:



---

archive/issue_comments_376268.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-02T13:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376268",
    "user": "embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_376269.json:
```json
{
    "body": "looks good to me - on py3 docbuilding (that was the place I saw this bug 1st) still breaks somewhere later, but this (a problem with `facade-sets` label) is another story for another ticket.",
    "created_at": "2019-01-03T15:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376269",
    "user": "dimpase"
}
```

looks good to me - on py3 docbuilding (that was the place I saw this bug 1st) still breaks somewhere later, but this (a problem with `facade-sets` label) is another story for another ticket.



---

archive/issue_comments_376270.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-03T15:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376270",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_376271.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376271",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_376272.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-16T20:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376272",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_376273.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2019-01-16T20:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376273",
    "user": "vbraun"
}
```

Merge conflict



---

archive/issue_comments_376274.json:
```json
{
    "body": "A mystery merge conflict.",
    "created_at": "2019-01-18T10:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376274",
    "user": "embray"
}
```

A mystery merge conflict.



---

archive/issue_comments_376275.json:
```json
{
    "body": "Well, the pull request here is stalled..\n\nhttps://github.com/sagemath/git-trac-command/pull/30",
    "created_at": "2019-01-18T10:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376275",
    "user": "chapoton"
}
```

Well, the pull request here is stalled..

https://github.com/sagemath/git-trac-command/pull/30



---

archive/issue_comments_376276.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-01-28T10:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376276",
    "user": "chapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_376277.json:
```json
{
    "body": "trivial conflict fixed\n----\nNew commits:",
    "created_at": "2019-01-28T10:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376277",
    "user": "chapoton"
}
```

trivial conflict fixed
----
New commits:



---

archive/issue_comments_376278.json:
```json
{
    "body": "Follow-up ticket: #27155",
    "created_at": "2019-01-28T10:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376278",
    "user": "jdemeyer"
}
```

Follow-up ticket: #27155



---

archive/issue_comments_376279.json:
```json
{
    "body": "Note that this usage of `PyErr_Fetch()` is a memory leak: the objects which are returned by `PyErr_Fetch` should be deallocated explicitly (if you are dealing with `PyObject*` instead of `object`, Cython doesn't take care of refcounts). I'll fix that on #27155.",
    "created_at": "2019-01-28T11:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376279",
    "user": "jdemeyer"
}
```

Note that this usage of `PyErr_Fetch()` is a memory leak: the objects which are returned by `PyErr_Fetch` should be deallocated explicitly (if you are dealing with `PyObject*` instead of `object`, Cython doesn't take care of refcounts). I'll fix that on #27155.



---

archive/issue_comments_376280.json:
```json
{
    "body": "I'm getting a quite consistent error (with or without 27155)\n\n```\n**********************************************************************\nFile \"src/sage/groups/matrix_gps/coxeter_group.py\", line 421, in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite\nFailed example:\n    [l for l in range(2, 9) if\n     CoxeterGroup([[1,3,2,2,2], [3,1,3,3,2], [2,3,1,2,2],\n                   [2,3,2,1,l], [2,2,2,l,1]]).is_finite()]\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite[2]>\", line 3, in <module>\n        [Integer(2),Integer(3),Integer(2),Integer(1),l], [Integer(2),Integer(2),Integer(2),l,Integer(1)]]).is_finite()]\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)\n        return self.get_object()(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/root_system/coxeter_group.py\", line 132, in CoxeterGroup\n        return CoxeterMatrixGroup(data, base_ring, index_set)\n      File \"sage/misc/classcall_metaclass.pyx\", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1700)\n        return cls.classcall(cls, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 233, in __classcall_private__\n        data, base_ring, data.index_set())\n      File \"sage/misc/cachefunc.pyx\", line 1005, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6067)\n        w = self.f(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 497, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2150)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 303, in __init__\n        for i in range(n)]\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 284, in val\n        return E(2 * x) + ~E(2 * x)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/universal_cyclotomic_field.py\", line 1258, in gen\n        return self.element_class(self, libgap.E(n)**k)\n      File \"sage/libs/gap/element.pyx\", line 1062, in sage.libs.gap.element.GapElement.__pow__ (build/cythonized/sage/libs/gap/element.c:10893)\n        sig_on()\n    SystemError: calling remove_from_pari_stack() inside sig_on()\n**********************************************************************\n1 item had failures:\n   1 of   6 in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite\n    [136 tests, 1 failure, 4.76 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2019-02-02T15:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376280",
    "user": "vbraun"
}
```

I'm getting a quite consistent error (with or without 27155)

```
**********************************************************************
File "src/sage/groups/matrix_gps/coxeter_group.py", line 421, in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite
Failed example:
    [l for l in range(2, 9) if
     CoxeterGroup([[1,3,2,2,2], [3,1,3,3,2], [2,3,1,2,2],
                   [2,3,2,1,l], [2,2,2,l,1]]).is_finite()]
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite[2]>", line 3, in <module>
        [Integer(2),Integer(3),Integer(2),Integer(1),l], [Integer(2),Integer(2),Integer(2),l,Integer(1)]]).is_finite()]
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)
        return self.get_object()(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/root_system/coxeter_group.py", line 132, in CoxeterGroup
        return CoxeterMatrixGroup(data, base_ring, index_set)
      File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1700)
        return cls.classcall(cls, *args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 233, in __classcall_private__
        data, base_ring, data.index_set())
      File "sage/misc/cachefunc.pyx", line 1005, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6067)
        w = self.f(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 497, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2150)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 303, in __init__
        for i in range(n)]
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 284, in val
        return E(2 * x) + ~E(2 * x)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/universal_cyclotomic_field.py", line 1258, in gen
        return self.element_class(self, libgap.E(n)**k)
      File "sage/libs/gap/element.pyx", line 1062, in sage.libs.gap.element.GapElement.__pow__ (build/cythonized/sage/libs/gap/element.c:10893)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
**********************************************************************
1 item had failures:
   1 of   6 in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite
    [136 tests, 1 failure, 4.76 s]
----------------------------------------------------------------------
sage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_376281.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-02-02T15:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376281",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_376282.json:
```json
{
    "body": "Yes, this #27140. I was hoping to fix that error on top of #26992 and #27155.",
    "created_at": "2019-02-04T11:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376282",
    "user": "jdemeyer"
}
```

Yes, this #27140. I was hoping to fix that error on top of #26992 and #27155.



---

archive/issue_comments_376283.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-02-04T11:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376283",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_376284.json:
```json
{
    "body": "To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.",
    "created_at": "2019-02-05T15:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376284",
    "user": "jdemeyer"
}
```

To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.



---

archive/issue_comments_376285.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-06T10:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26755#issuecomment-376285",
    "user": "vbraun"
}
```

Resolution: fixed
