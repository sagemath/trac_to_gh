# Issue 22084: pow broken for PARI exponents

Issue created by migration from https://trac.sagemath.org/ticket/22321

Original creator: defeo

Original creation time: 2017-02-07 13:44:57

CC:  jdemeyer vdelecroix

Keywords: PARI, coercion

the `Integer.__pow__(self, n, modulus)` assumes that `n` is either an integer, or a Sage `Element`. This breaks with the latest changes to the PARI interface:


```
sage: 1^pari(1.0)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-87bc840c4f35> in <module>()
----> 1 Integer(1)**pari(RealNumber('1.0'))

/data/dfl/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (/data/dfl/sage/src/build/cythonized/sage/rings/integer.c:13909)()
   2029             nn = pyobject_to_long(n)
   2030         except TypeError:
-> 2031             s = parent_c(n)(self)
   2032             return s**n
   2033         except OverflowError:

TypeError: __init__() takes exactly 0 positional arguments (1 given)
```



---

Comment by jdemeyer created at 2017-02-07 14:09:20

Changing type from PLEASE CHANGE to enhancement.


---

Comment by defeo created at 2017-02-07 14:45:03

If we keep going along this path, `pari(x)` will be reduntant with `Gen(x)`. Then we won't need `libs.pari.pari` to be a _callable namespace_ anymore, nor will we need the `PariInstance` class. At that point cypari would start resembling an ordinary Python module, with no crazy hacks. Using it would look like


```
>>> from cypari import *
>>> x = Gen('x')
>>> p = x**2 + 3
>>> K = nfinit(p)
>>> K == p.nfinit()
True
```


At that point, it would seem logical to rename `Gen` to `Pari`, or at least to have such an alias.

I like this!

Anyway, none of this seems to be strictly needed for #20238, does it?


---

Comment by jdemeyer created at 2017-02-07 16:28:54

Replying to [comment:2 defeo]:
> Anyway, none of this seems to be strictly needed for #20238, does it?

No. But we should decide what we want to do before the splitting of `cypari2` and what after. Fixing `Gen.__init__` would make sense before the split. Maybe you should decide when to do this, because you created this ticket (I changed the title because this is why `__pow__` didn't work).


---

Comment by defeo created at 2017-02-07 16:46:13

> No. But we should decide what we want to do before the splitting of cypari2 and what after. Fixing Gen.__init__ would make sense before the split. 

I think we need to discuss this longer. Voice would be preferable.

> I changed the title because this is why `__pow__` didn't work

Well, `__pow__` doesn't work because it expects `Gen` to work in some way, but that expectation is not an absolute necessity. It is indeed a sensible way for a class to behave, though.


---

Comment by defeo created at 2017-02-08 17:31:20

This is the best I could come up with. The constructor just calls `objtogen`, and then makes a copy of the result.

The copy is unnecessary most of the time, however I don't see how we can avoid it for, e.g. `Gen(GF(2)(0))`, i.e. when the argument is an object with a `_pari_()` method. Given that you are not allowed to override `__new__`, I think we are stuck with this.
----
New commits:


---

Comment by defeo created at 2017-02-08 17:31:20

Changing status from new to needs_info.


---

Comment by jdemeyer created at 2017-02-08 19:21:37

I guess this would work.

A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`). The `_pari_` method would be hard to support without a copy, unless we require that `_pari_` needs to return a new object every time (it cannot be cached).

However, I'm not saying that this should be done now.

I was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?


---

Comment by defeo created at 2017-02-08 22:17:49

> A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).

No pickling surprises?

> unless we require that `_pari_` needs to return a new object every time (it cannot be cached).

That looks risky.
> I was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?

I had the same thought.


---

Comment by jdemeyer created at 2017-02-09 08:38:17

Replying to [comment:8 defeo]:
> > A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).
> 
> No pickling surprises?

I don't think so. There shouldn't be any difference between the global callable `objtogen` and the global callable `Gen`.


---

Comment by jdemeyer created at 2017-03-28 12:29:44

Resolution: wontfix


---

Comment by jdemeyer created at 2017-03-28 12:29:44

Closing as "let's fix this in `CyPari2`".
