# Issue 22084: pow broken for PARI exponents

archive/issues_022084.json:
```json
{
    "body": "CC:  jdemeyer vdelecroix\n\nKeywords: PARI, coercion\n\nthe `Integer.__pow__(self, n, modulus)` assumes that `n` is either an integer, or a Sage `Element`. This breaks with the latest changes to the PARI interface:\n\n\n```\nsage: 1^pari(1.0)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-87bc840c4f35> in <module>()\n----> 1 Integer(1)**pari(RealNumber('1.0'))\n\n/data/dfl/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (/data/dfl/sage/src/build/cythonized/sage/rings/integer.c:13909)()\n   2029             nn = pyobject_to_long(n)\n   2030         except TypeError:\n-> 2031             s = parent_c(n)(self)\n   2032             return s**n\n   2033         except OverflowError:\n\nTypeError: __init__() takes exactly 0 positional arguments (1 given)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22321\n\n",
    "created_at": "2017-02-07T13:44:57Z",
    "labels": [
        "interfaces",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "pow broken for PARI exponents",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22084",
    "user": "defeo"
}
```
CC:  jdemeyer vdelecroix

Keywords: PARI, coercion

the `Integer.__pow__(self, n, modulus)` assumes that `n` is either an integer, or a Sage `Element`. This breaks with the latest changes to the PARI interface:


```
sage: 1^pari(1.0)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-87bc840c4f35> in <module>()
----> 1 Integer(1)**pari(RealNumber('1.0'))

/data/dfl/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (/data/dfl/sage/src/build/cythonized/sage/rings/integer.c:13909)()
   2029             nn = pyobject_to_long(n)
   2030         except TypeError:
-> 2031             s = parent_c(n)(self)
   2032             return s**n
   2033         except OverflowError:

TypeError: __init__() takes exactly 0 positional arguments (1 given)
```


Issue created by migration from https://trac.sagemath.org/ticket/22321





---

archive/issue_comments_306805.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2017-02-07T14:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306805",
    "user": "jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_306806.json:
```json
{
    "body": "If we keep going along this path, `pari(x)` will be reduntant with `Gen(x)`. Then we won't need `libs.pari.pari` to be a *callable namespace* anymore, nor will we need the `PariInstance` class. At that point cypari would start resembling an ordinary Python module, with no crazy hacks. Using it would look like\n\n\n```\n>>> from cypari import *\n>>> x = Gen('x')\n>>> p = x**2 + 3\n>>> K = nfinit(p)\n>>> K == p.nfinit()\nTrue\n```\n\n\nAt that point, it would seem logical to rename `Gen` to `Pari`, or at least to have such an alias.\n\nI like this!\n\nAnyway, none of this seems to be strictly needed for #20238, does it?",
    "created_at": "2017-02-07T14:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306806",
    "user": "defeo"
}
```

If we keep going along this path, `pari(x)` will be reduntant with `Gen(x)`. Then we won't need `libs.pari.pari` to be a *callable namespace* anymore, nor will we need the `PariInstance` class. At that point cypari would start resembling an ordinary Python module, with no crazy hacks. Using it would look like


```
>>> from cypari import *
>>> x = Gen('x')
>>> p = x**2 + 3
>>> K = nfinit(p)
>>> K == p.nfinit()
True
```


At that point, it would seem logical to rename `Gen` to `Pari`, or at least to have such an alias.

I like this!

Anyway, none of this seems to be strictly needed for #20238, does it?



---

archive/issue_comments_306807.json:
```json
{
    "body": "Replying to [comment:2 defeo]:\n> Anyway, none of this seems to be strictly needed for #20238, does it?\n\nNo. But we should decide what we want to do before the splitting of `cypari2` and what after. Fixing `Gen.__init__` would make sense before the split. Maybe you should decide when to do this, because you created this ticket (I changed the title because this is why `__pow__` didn't work).",
    "created_at": "2017-02-07T16:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306807",
    "user": "jdemeyer"
}
```

Replying to [comment:2 defeo]:
> Anyway, none of this seems to be strictly needed for #20238, does it?

No. But we should decide what we want to do before the splitting of `cypari2` and what after. Fixing `Gen.__init__` would make sense before the split. Maybe you should decide when to do this, because you created this ticket (I changed the title because this is why `__pow__` didn't work).



---

archive/issue_comments_306808.json:
```json
{
    "body": "> No. But we should decide what we want to do before the splitting of cypari2 and what after. Fixing Gen.__init__ would make sense before the split. \n\nI think we need to discuss this longer. Voice would be preferable.\n\n> I changed the title because this is why `__pow__` didn't work\n\nWell, `__pow__` doesn't work because it expects `Gen` to work in some way, but that expectation is not an absolute necessity. It is indeed a sensible way for a class to behave, though.",
    "created_at": "2017-02-07T16:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306808",
    "user": "defeo"
}
```

> No. But we should decide what we want to do before the splitting of cypari2 and what after. Fixing Gen.__init__ would make sense before the split. 

I think we need to discuss this longer. Voice would be preferable.

> I changed the title because this is why `__pow__` didn't work

Well, `__pow__` doesn't work because it expects `Gen` to work in some way, but that expectation is not an absolute necessity. It is indeed a sensible way for a class to behave, though.



---

archive/issue_comments_306809.json:
```json
{
    "body": "This is the best I could come up with. The constructor just calls `objtogen`, and then makes a copy of the result.\n\nThe copy is unnecessary most of the time, however I don't see how we can avoid it for, e.g. `Gen(GF(2)(0))`, i.e. when the argument is an object with a `_pari_()` method. Given that you are not allowed to override `__new__`, I think we are stuck with this.\n----\nNew commits:",
    "created_at": "2017-02-08T17:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306809",
    "user": "defeo"
}
```

This is the best I could come up with. The constructor just calls `objtogen`, and then makes a copy of the result.

The copy is unnecessary most of the time, however I don't see how we can avoid it for, e.g. `Gen(GF(2)(0))`, i.e. when the argument is an object with a `_pari_()` method. Given that you are not allowed to override `__new__`, I think we are stuck with this.
----
New commits:



---

archive/issue_comments_306810.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-02-08T17:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306810",
    "user": "defeo"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_306811.json:
```json
{
    "body": "I guess this would work.\n\nA better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`). The `_pari_` method would be hard to support without a copy, unless we require that `_pari_` needs to return a new object every time (it cannot be cached).\n\nHowever, I'm not saying that this should be done now.\n\nI was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?",
    "created_at": "2017-02-08T19:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306811",
    "user": "jdemeyer"
}
```

I guess this would work.

A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`). The `_pari_` method would be hard to support without a copy, unless we require that `_pari_` needs to return a new object every time (it cannot be cached).

However, I'm not saying that this should be done now.

I was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?



---

archive/issue_comments_306812.json:
```json
{
    "body": "> A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).\n\nNo pickling surprises?\n\n> unless we require that `_pari_` needs to return a new object every time (it cannot be cached).\n\nThat looks risky.\n> I was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?\n\nI had the same thought.",
    "created_at": "2017-02-08T22:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306812",
    "user": "defeo"
}
```

> A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).

No pickling surprises?

> unless we require that `_pari_` needs to return a new object every time (it cannot be cached).

That looks risky.
> I was thinking of something else: usually, the Python convention is that special methods have double underscores. Should we replace `_pari_` by `__pari__`?

I had the same thought.



---

archive/issue_comments_306813.json:
```json
{
    "body": "Replying to [comment:8 defeo]:\n> > A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).\n> \n> No pickling surprises?\n\nI don't think so. There shouldn't be any difference between the global callable `objtogen` and the global callable `Gen`.",
    "created_at": "2017-02-09T08:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306813",
    "user": "jdemeyer"
}
```

Replying to [comment:8 defeo]:
> > A better way would be to move the code of `objtogen` into `Gen.__init__` (and then we could remove `objtogen`).
> 
> No pickling surprises?

I don't think so. There shouldn't be any difference between the global callable `objtogen` and the global callable `Gen`.



---

archive/issue_comments_306814.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-03-28T12:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306814",
    "user": "jdemeyer"
}
```

Resolution: wontfix



---

archive/issue_comments_306815.json:
```json
{
    "body": "Closing as \"let's fix this in `CyPari2`\".",
    "created_at": "2017-03-28T12:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22084",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22084#issuecomment-306815",
    "user": "jdemeyer"
}
```

Closing as "let's fix this in `CyPari2`".
