# Issue 26986: Legacy uninstaller should be run if no stamp file is present

archive/issues_026986.json:
```json
{
    "body": "CC:  embray\n\nIt happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.\n\nThis can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27223\n\n",
    "created_at": "2019-02-05T09:01:21Z",
    "labels": [
        "build",
        "critical",
        "enhancement"
    ],
    "title": "Legacy uninstaller should be run if no stamp file is present",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26986",
    "user": "jdemeyer"
}
```
CC:  embray

It happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.

This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.

Issue created by migration from https://trac.sagemath.org/ticket/27223





---

archive/issue_comments_379946.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-05T09:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379946",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_379947.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-05T09:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379947",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379948.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-05T09:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379948",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379949.json:
```json
{
    "body": "This is what I found as well.  I was going to post a fix to this last night but didn't have time.",
    "created_at": "2019-02-05T12:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379949",
    "user": "embray"
}
```

This is what I found as well.  I was going to post a fix to this last night but didn't have time.



---

archive/issue_comments_379950.json:
```json
{
    "body": "I'm not sure why you changed this message:\n\n\n```diff\n     if keep_files:\n-        print(\"Removing stamp file '{0}' but keeping package files\".format(\n-            stamp_file))\n+        print(\"Removing stamp file but keeping package files\")\n         remove_stamp_files(stamp_files)\n         return\n```\n\n\nIsn't it a little bit more helpful to actually specify what file the message is referring to?",
    "created_at": "2019-02-05T12:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379950",
    "user": "embray"
}
```

I'm not sure why you changed this message:


```diff
     if keep_files:
-        print("Removing stamp file '{0}' but keeping package files".format(
-            stamp_file))
+        print("Removing stamp file but keeping package files")
         remove_stamp_files(stamp_files)
         return
```


Isn't it a little bit more helpful to actually specify what file the message is referring to?



---

archive/issue_comments_379951.json:
```json
{
    "body": "Other than that, this is just a slightly different formatted version of what I did, so you can set positive review after addressing my one question.",
    "created_at": "2019-02-05T12:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379951",
    "user": "embray"
}
```

Other than that, this is just a slightly different formatted version of what I did, so you can set positive review after addressing my one question.



---

archive/issue_comments_379952.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Isn't it a little bit more helpful to actually specify what file the message is referring to?\n\nMainly because it's not guaranteed that there is exactly one stamp file.\n\nAlso, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.",
    "created_at": "2019-02-05T12:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379952",
    "user": "jdemeyer"
}
```

Replying to [comment:8 embray]:
> Isn't it a little bit more helpful to actually specify what file the message is referring to?

Mainly because it's not guaranteed that there is exactly one stamp file.

Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.



---

archive/issue_comments_379953.json:
```json
{
    "body": "> Also, it happens regularly that the stamp file $SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.\n\nI do consider this a separate issue.  I would like to eventually remove the `spkg-legacy-uninstall` files entirely.  Most of them are not well maintained and their use at all is inconsistent (this is true before the idea of moving that functionality into a separate file).\n\nIn other words, even `spkg-legacy-uninstall` scripts are not a reliable way to deal with partial/failed installations.  I would rather fix this more directly.  For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the \"installation\" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.\n\nThere should also be better error/interrupt handling in the sage-spkg script so that \"partial installs\" can be immediately rolled back when possible.\n\nThe downside to this approach is if an install is interrupted before it's complete, you still have a valid stamp file suggesting the installation was completed.  To address this, maybe it should be written first to a different location (after all, in this case it is serving merely as a file manifest) and then moved into its final location after the successful installation.",
    "created_at": "2019-02-05T12:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379953",
    "user": "embray"
}
```

> Also, it happens regularly that the stamp file $SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.

I do consider this a separate issue.  I would like to eventually remove the `spkg-legacy-uninstall` files entirely.  Most of them are not well maintained and their use at all is inconsistent (this is true before the idea of moving that functionality into a separate file).

In other words, even `spkg-legacy-uninstall` scripts are not a reliable way to deal with partial/failed installations.  I would rather fix this more directly.  For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the "installation" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.

There should also be better error/interrupt handling in the sage-spkg script so that "partial installs" can be immediately rolled back when possible.

The downside to this approach is if an install is interrupted before it's complete, you still have a valid stamp file suggesting the installation was completed.  To address this, maybe it should be written first to a different location (after all, in this case it is serving merely as a file manifest) and then moved into its final location after the successful installation.



---

archive/issue_comments_379954.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> Replying to [comment:8 embray]:\n> > Isn't it a little bit more helpful to actually specify what file the message is referring to?\n> \n> Mainly because it's not guaranteed that there is exactly one stamp file.\n\nThat is rarely the case though.  And in any case the message still says \"Removing stamp file\", singular.\n\n> Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.\n\nThat's fine; I don't care where it goes.",
    "created_at": "2019-02-05T12:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379954",
    "user": "embray"
}
```

Replying to [comment:10 jdemeyer]:
> Replying to [comment:8 embray]:
> > Isn't it a little bit more helpful to actually specify what file the message is referring to?
> 
> Mainly because it's not guaranteed that there is exactly one stamp file.

That is rarely the case though.  And in any case the message still says "Removing stamp file", singular.

> Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.

That's fine; I don't care where it goes.



---

archive/issue_comments_379955.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the \"installation\" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.\n\nI think it's too hard to ensure that the stamp file is consistent with the actual installed files. I've had similar issues with `pip` too where `pip` would think that a package is not installed but still some files belonging to that package are installed.\n\nSo rather than improving the stamp files, I would rather improve installation in the case that the stamp files are missing or wrong.",
    "created_at": "2019-02-05T15:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379955",
    "user": "jdemeyer"
}
```

Replying to [comment:11 embray]:
> For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the "installation" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.

I think it's too hard to ensure that the stamp file is consistent with the actual installed files. I've had similar issues with `pip` too where `pip` would think that a package is not installed but still some files belonging to that package are installed.

So rather than improving the stamp files, I would rather improve installation in the case that the stamp files are missing or wrong.



---

archive/issue_comments_379956.json:
```json
{
    "body": "Under normal circumstances it's actually exactly consistent, except in the cases of files that are created post-installation which are handled differently.  So I think you'd have to be more specific what you think the problem is.\n\nI'm also not talking about \"improving stamp files\", but rather strategies for managing broken installations.  The \"stamp file\" here is really serving two purposes (where previously it served only one):\n\n* It is an indication that a package installed successfully.\n* It is a manifest of (expected) installed files.\n\nInstallation, when done correctly, is just copying a tree of files from one place to another.  In order to roll back a partial/unsuccessful installation you want to have that manifest somewhere, but not in the actual \"stamp file\" as its existence indicates a successful install.  So what I'm suggesting is instead writing it to something like \".<pkg-name>-<version>.tmp\" prior to installation, and then following a successful installing moving it to \"<pkg-name>-<version>\".\n\nThe uninstall program would also be able to look for these \".<pkg-name>-<version>.tmp\" files in order to clean up broken installations.",
    "created_at": "2019-02-05T15:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379956",
    "user": "embray"
}
```

Under normal circumstances it's actually exactly consistent, except in the cases of files that are created post-installation which are handled differently.  So I think you'd have to be more specific what you think the problem is.

I'm also not talking about "improving stamp files", but rather strategies for managing broken installations.  The "stamp file" here is really serving two purposes (where previously it served only one):

* It is an indication that a package installed successfully.
* It is a manifest of (expected) installed files.

Installation, when done correctly, is just copying a tree of files from one place to another.  In order to roll back a partial/unsuccessful installation you want to have that manifest somewhere, but not in the actual "stamp file" as its existence indicates a successful install.  So what I'm suggesting is instead writing it to something like ".<pkg-name>-<version>.tmp" prior to installation, and then following a successful installing moving it to "<pkg-name>-<version>".

The uninstall program would also be able to look for these ".<pkg-name>-<version>.tmp" files in order to clean up broken installations.



---

archive/issue_comments_379957.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-05T16:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379957",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379958.json:
```json
{
    "body": "Looks good to me.  I'm sorry I didn't say anything sooner, though I will say your fix is a little cleaner than mine--you restructured things a bit such that there was less duplication than what I had.",
    "created_at": "2019-02-05T16:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379958",
    "user": "embray"
}
```

Looks good to me.  I'm sorry I didn't say anything sooner, though I will say your fix is a little cleaner than mine--you restructured things a bit such that there was less duplication than what I had.



---

archive/issue_comments_379959.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-05T16:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379959",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379960.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-08T12:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26986#issuecomment-379960",
    "user": "vbraun"
}
```

Resolution: fixed
