# Issue 30900: subs fails in obscure circumstances

Issue created by migration from https://trac.sagemath.org/ticket/31137

Original creator: charpent

Original creation time: 2020-12-30 07:40:02

CC:  slelievre

Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :

```
    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
    (A, L, G, R, f, k, n, q, u, beta, gamma)
    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))
    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()
    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()
    sage: bool(R1==R2)
    True
    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()
    sage: bool(R1==R3)
    True
    sage: bool(R2==R3)
    True
```


So far, so good. But, whereas :


```
    sage: import sympy
    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))
    True
```


works, `mathematica` seems to fail somehow (more troubling) : :


```
    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))
    False
```


And (case in point), 


```
    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))
```


**never returns.**

(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a "Memory Error" exception, which I couldn't reproduce either).

Possibly related : #30378

Priority set to `critical`, because it affects a very basic feature of `Sage`.


---

Comment by slelievre created at 2020-12-31 13:50:56

Seems to have a lot to do with `factor`.

I also got a crash when interrupting the computation:


```
KeyboardInterrupt:
Exception ignored in: 'sage.libs.pynac.pynac.py_repr'
Traceback (most recent call last):
  File "sage/rings/integer.pyx", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.
c:8427)
  File "sage/rings/integer.pyx", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901
1)
KeyboardInterrupt:
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



---

Comment by slelievre created at 2020-12-31 14:04:14

Seems expressions resulting from `factor` behave strangely.
Not sure what role `subs` plays here.


---

Comment by slelievre created at 2020-12-31 14:04:14

Changing keywords from "" to "factor".


---

Comment by slelievre created at 2020-12-31 14:11:37

What seemed to be hanging was just taking a long time.
Still, the result is surprising.

```
sage: len(str(R3s))  # long time -- 1,292,914,505
1292914505
```



---

Comment by @DaveWitteMorris created at 2021-01-12 02:25:12

Changing priority from critical to minor.


---

Comment by @DaveWitteMorris created at 2021-01-12 02:25:12

The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-01-12 02:25:12

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-01-24 19:57:43

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-01-24 19:57:43

only the patch for expression.pyx is needed here, with the rest in #30446


---

Comment by git created at 2021-01-24 22:21:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-01-24 22:24:43

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2021-01-24 22:24:43

LGTM


---

Comment by slelievre created at 2021-01-25 08:26:28

Can we improve the ticket summary and ticket description?


---

Comment by dimpase created at 2021-01-25 09:57:41

it just adds an extra doctest, which used to fail before #30446


---

Comment by slelievre created at 2021-01-25 20:07:56

Thanks for the explanation.


---

Comment by vbraun created at 2021-03-09 00:00:32

Resolution: fixed
