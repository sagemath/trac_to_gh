# Issue 30900: subs fails in obscure circumstances

archive/issues_030900.json:
```json
{
    "body": "CC:  @slel\n\nReported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :\n\n```\n    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n    (A, L, G, R, f, k, n, q, u, beta, gamma)\n    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))\n    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()\n    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()\n    sage: bool(R1==R2)\n    True\n    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()\n    sage: bool(R1==R3)\n    True\n    sage: bool(R2==R3)\n    True\n```\n\nSo far, so good. But, whereas :\n\n```\n    sage: import sympy\n    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))\n    True\n```\n\nworks, `mathematica` seems to fail somehow (more troubling) : :\n\n```\n    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))\n    False\n```\n\nAnd (case in point), \n\n```\n    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))\n```\n\n**never returns.**\n\n(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a \"Memory Error\" exception, which I couldn't reproduce either).\n\nPossibly related : #30378\n\nPriority set to `critical`, because it affects a very basic feature of `Sage`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31137\n\n",
    "created_at": "2020-12-30T07:40:02Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "subs fails in obscure circumstances",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30900",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
CC:  @slel

Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :

```
    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
    (A, L, G, R, f, k, n, q, u, beta, gamma)
    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))
    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()
    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()
    sage: bool(R1==R2)
    True
    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()
    sage: bool(R1==R3)
    True
    sage: bool(R2==R3)
    True
```

So far, so good. But, whereas :

```
    sage: import sympy
    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))
    True
```

works, `mathematica` seems to fail somehow (more troubling) : :

```
    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))
    False
```

And (case in point), 

```
    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))
```

**never returns.**

(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a "Memory Error" exception, which I couldn't reproduce either).

Possibly related : #30378

Priority set to `critical`, because it affects a very basic feature of `Sage`.

Issue created by migration from https://trac.sagemath.org/ticket/31137





---

archive/issue_comments_441066.json:
```json
{
    "body": "Seems to have a lot to do with `factor`.\n\nI also got a crash when interrupting the computation:\n\n```\nKeyboardInterrupt:\nException ignored in: 'sage.libs.pynac.pynac.py_repr'\nTraceback (most recent call last):\n  File \"sage/rings/integer.pyx\", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.\nc:8427)\n  File \"sage/rings/integer.pyx\", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901\n1)\nKeyboardInterrupt:\n------------------------------------------------------------------------\n...\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\nSegmentation fault\n```",
    "created_at": "2020-12-31T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441066",
    "user": "https://github.com/slel"
}
```

Seems to have a lot to do with `factor`.

I also got a crash when interrupting the computation:

```
KeyboardInterrupt:
Exception ignored in: 'sage.libs.pynac.pynac.py_repr'
Traceback (most recent call last):
  File "sage/rings/integer.pyx", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.
c:8427)
  File "sage/rings/integer.pyx", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901
1)
KeyboardInterrupt:
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



---

archive/issue_comments_441067.json:
```json
{
    "body": "Seems expressions resulting from `factor` behave strangely.\nNot sure what role `subs` plays here.",
    "created_at": "2020-12-31T14:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441067",
    "user": "https://github.com/slel"
}
```

Seems expressions resulting from `factor` behave strangely.
Not sure what role `subs` plays here.



---

archive/issue_comments_441068.json:
```json
{
    "body": "Changing keywords from \"\" to \"factor\".",
    "created_at": "2020-12-31T14:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441068",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "factor".



---

archive/issue_comments_441069.json:
```json
{
    "body": "What seemed to be hanging was just taking a long time.\nStill, the result is surprising.\n\n```\nsage: len(str(R3s))  # long time -- 1,292,914,505\n1292914505\n```",
    "created_at": "2020-12-31T14:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441069",
    "user": "https://github.com/slel"
}
```

What seemed to be hanging was just taking a long time.
Still, the result is surprising.

```
sage: len(str(R3s))  # long time -- 1,292,914,505
1292914505
```



---

archive/issue_comments_441070.json:
```json
{
    "body": "Changing priority from critical to minor.",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441070",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing priority from critical to minor.



---

archive/issue_comments_441071.json:
```json
{
    "body": "The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.\n\n---\nNew commits:",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441071",
    "user": "https://github.com/DaveWitteMorris"
}
```

The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.

---
New commits:



---

archive/issue_comments_441072.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441072",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_441073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-24T19:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441073",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_441074.json:
```json
{
    "body": "only the patch for expression.pyx is needed here, with the rest in #30446",
    "created_at": "2021-01-24T19:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441074",
    "user": "https://github.com/dimpase"
}
```

only the patch for expression.pyx is needed here, with the rest in #30446



---

archive/issue_comments_441075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-01-24T22:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_441076.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-01-24T22:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441076",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_441077.json:
```json
{
    "body": "LGTM",
    "created_at": "2021-01-24T22:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441077",
    "user": "https://github.com/dimpase"
}
```

LGTM



---

archive/issue_comments_441078.json:
```json
{
    "body": "Can we improve the ticket summary and ticket description?",
    "created_at": "2021-01-25T08:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441078",
    "user": "https://github.com/slel"
}
```

Can we improve the ticket summary and ticket description?



---

archive/issue_comments_441079.json:
```json
{
    "body": "it just adds an extra doctest, which used to fail before #30446",
    "created_at": "2021-01-25T09:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441079",
    "user": "https://github.com/dimpase"
}
```

it just adds an extra doctest, which used to fail before #30446



---

archive/issue_comments_441080.json:
```json
{
    "body": "Thanks for the explanation.",
    "created_at": "2021-01-25T20:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441080",
    "user": "https://github.com/slel"
}
```

Thanks for the explanation.



---

archive/issue_comments_441081.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-09T00:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30900#issuecomment-441081",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081360.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-09T00:00:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30900",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30900#event-81360"
}
```
