# Issue 14432: ECL spkg : dirty workarounds?

Issue created by migration from https://trac.sagemath.org/ticket/14636

Original creator: Snark

Original creation time: 2013-05-24 11:55:45

Assignee: jdemeyer

CC:  jpflori

My debian/sage experiments have uncovered two problems with sage's ecl package:

(1) it is compiled with unicode disabled ; this is to avoid errors, like those which can be read about in [this gentoo report](https://github.com/cschwan/sage-on-gentoo/issues/2). But that doesn't look like a real solution! Wouldn't it be possible to add a conversion step somewhere to make sage work with an unicode-enabled unicode? or what about ecl's --output-encoding argument?

(2) I'm annoyed by the fact that SIGCHLD was disabled by directly patching the sources -- wouldn't it be possible to change this by modifying an rc file or some such, whose path would be given to ecl at startup?


---

Comment by jdemeyer created at 2013-05-24 12:15:11

Replying to [ticket:14636 Snark]:
> (2) I'm annoyed by the fact that SIGCHLD was disabled by directly patching the sources
I don't see any patch doing this, please clarify...


---

Comment by leif created at 2013-05-24 12:20:48

Replying to [ticket:14636 Snark]:
> (2) I'm annoyed by the fact that SIGCHLD was disabled by directly patching the sources -- wouldn't it be possible to change this by modifying an rc file or some such, whose path would be given to ecl at startup?

Which *library* does read start-up files? ;-)


---

Comment by Snark created at 2013-05-24 13:15:45

`@`jdemeyer: disable_sigchdl_handler.patch is what you're looking for.

`@`leif: good catch! I had the impression that maxima was used as a library within ecl, but that ecl was used through its commandline. But indeed now that you ask, I see there is also a direct use of ecl-as-a-library. What saves the day though is that sage's ecl.pyx calls cl_boot itself, and hence it should be possible to modify the setting before that call. I should be able to do something about it.


---

Comment by nbruin created at 2013-05-24 14:22:40

(1) unicode: I suppose there are no fundamental obstacles for that. However, you'll have to essentially rewrite the ecllib wrapper. With Py3 this might become worthwhile, since that has unicode strings internally anyway (although undoubtedly stored with an encoding different from ecl's). Also, our main use, Maxima, is solidly pre-unicode, so I don't think there will be any benefits for us and probably extra problems from Maxima possibly getting unexpected data.

(2) signals: ECL has very complex and ingenious infrastructure to deal with signals, and it expects to handle signals itself (which is a bit odd for a library). With threads enabled there will be a separate thread for asynchronous signals, and Boehm repurposes some exotic signals to sync threads on GC events. We cannot afford to submit to ECL's way of handling signals, so we do some pretty horrible stuff with signals when starting ECL anyway (and every time we call into ECL for longer times!) Disabling SIGCHLD is probably the least of your worries. Also, I don't think ECL does anything with SIGCHLD events anyway (other than possibly installing its own handler to provide a hook for ecl programs and which by default ignores the signal)


---

Comment by jdemeyer created at 2013-05-24 15:05:01

Replying to [comment:3 Snark]:
> `@`jdemeyer: disable_sigchdl_handler.patch is what you're looking for.
Sorry, I was looking at an older version of the ECL spkg (this patch is a very recent addition).


---

Comment by Snark created at 2013-05-24 16:00:10

`@`nbruin(1) where is the ticket about the python3 transition? As far as I know, a few sagenb deps (notably twisted and flask if I remember well) and some of sage's standard packages (for example pil) are a concern in that matter, but I can't find the relevant ticket.

`@`nbruin(2) I'll manage to deal with it : there's just an option to set in sage/libs/


---

Comment by Snark created at 2013-05-24 16:09:14

I just found that sage/libs/ecl.pxd has a copy of ecl's src/h/external.h's ecl_option enum... lacking the ECL_OPT_TRAP_SIGCHLD item! That means all subsequent items in the list are off-by-one... how is that code even supposed to run correctly!?


---

Comment by nbruin created at 2013-05-24 16:26:58

Replying to [comment:7 Snark]:
> I just found that sage/libs/ecl.pxd has a copy of ecl's src/h/external.h's ecl_option enum... lacking the ECL_OPT_TRAP_SIGCHLD item! That means all subsequent items in the list are off-by-one... how is that code even supposed to run correctly!?

I assume that's an "extern" definition. It just gets translated literally into the C-source which then uses the values that `external.h` provides. Just as `cdef typedef extern struct` can afford to only mention the fields that are of interest, or even only with approximate types.

It may well be that particular member wasn't in ecl when the wrapper was written. Add it if you need it.


---

Comment by jdemeyer created at 2013-05-24 20:25:51

Replying to [comment:6 Snark]:
> `@`nbruin(1) where is the ticket about the python3 transition? As far as I know, a few sagenb deps (notably twisted and flask if I remember well) and some of sage's standard packages (for example pil) are a concern in that matter, but I can't find the relevant ticket.

I don't think there is a ticket yet, because it's obvious it's not going to happen anytime soon.


---

Comment by Snark created at 2013-05-24 20:38:02

Replying to [comment:9 jdemeyer]:
> Replying to [comment:6 Snark]:
> > `@`nbruin(1) where is the ticket about the python3 transition? As far as I know, a few sagenb deps (notably twisted and flask if I remember well) and some of sage's standard packages (for example pil) are a concern in that matter, but I can't find the relevant ticket.
> 
> I don't think there is a ticket yet, because it's obvious it's not going to happen anytime soon.

A ticket isn't just about something which will happen just now ; it's a central place where ideas get gathered about an issue. In this case, a ticket listing what is holding back sage for the switch to python3 would probably be worthy.


---

Comment by nbruin created at 2013-05-24 21:19:26

Replying to [comment:7 Snark]:
> I just found that sage/libs/ecl.pxd has a copy of ecl's src/h/external.h's ecl_option enum... lacking the ECL_OPT_TRAP_SIGCHLD item!

Ah, indeed! You should just add that in `ecl.pxd` and do

```
    ecl_set_option(ECL_OPT_TRAP_SIGCHLD, 0)
```

before the boot call. Looked like Volker went for the quick-and-dirty solution there on #14055.

Note that even with that option, ECL still does install a SIGCHLD handler. However, we're not putting that back when we call ECL. Does SIGCHLD also need special treatment in `eclsig.c`? Jeroen is the expert on that file.


---

Comment by jdemeyer created at 2013-05-24 21:29:30

Replying to [comment:11 nbruin]:
> Note that even with that option, ECL still does install a SIGCHLD handler.
Preferably, we don't have any `SIGCHLD` handler at all. Note that `SIGCHLD` is an unusual signal: it is the only signal which is _ignored_ by default. Therefore, having a `SIGCHLD` handler which does nothing is still quite different from having no handler (and ignoring the signal).

Maybe it can be made to work with `eclsig.c`, but at least it requires some work.


---

Comment by nbruin created at 2013-05-25 00:19:16

Replying to [comment:12 jdemeyer]:
> Preferably, we don't have any `SIGCHLD` handler at all. Note that `SIGCHLD` is an unusual signal: it is the only signal which is _ignored_ by default. Therefore, having a `SIGCHLD` handler which does nothing is still quite different from having no handler (and ignoring the signal).

I wondered about that. It's not clear to me why in our situation it even makes a difference what we do to `ECL_OPT_TRAP_SIGCHLD`(but given that Volker's fix had effect apparently it does).

The Sage `SIGCHLD` should be the `default` or `ignore` handler. Right after calling `cl_boot` we reset all handlers back to the sage handlers, so it shouldn't matter what ECL installs. We only change back some select handlers in `eclsig.c` and `SIGCHLD` is not one of them. Is there something that `ecl` changes that doesn't get reverted by `sigaction`?


---

Attachment

ECL spkg without the SIGCHLD patch to upstream


---

Comment by Snark created at 2013-05-25 07:01:21

Patch programmatically disabling SIGCHLD in sagelib's ECL code


---

Comment by Snark created at 2013-05-25 07:06:32

Changing status from new to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2013-05-25 09:25:00

Please add the following doctest (`sage/tests/interrupt.pyx` is a good place for this test):

```
"""
Show that `SIGCHLD` is completely ignored by default. If the process
`p` finishes, there should be no `SIGCHLD` signal, so ``select()`` will
simply time out::

    sage: from select import select
    sage: import subprocess

    sage: p = subprocess.Popen(["sleep", "1"])  # long time
    sage: select([], [], [], 1.5)               # long time
    ([], [], [])
    sage: p.poll()                              # long time
    0

We now do the same but after installing a dummy `SIGCHLD`
handler::

    sage: import signal
    sage: def dummy_handler(a,b):
    ....:    pass
    sage: signal.signal(signal.SIGCHLD, dummy_handler)  # random
    sage: p = subprocess.Popen(["sleep", "1"])  # long time
    sage: select([], [], [], 1.5)               # long time
    Traceback (most recent call last):
    ...
    error: (4, 'Interrupted system call')
    sage: p.poll()                              # long time
    0

Reset the `SIGCHLD` handler::

    sage: signal.signal(signal.SIGCHLD, signal.SIG_IGN)  # random
"""
```



---

Comment by jdemeyer created at 2013-05-25 09:25:00

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-05-25 09:31:19

There is another complication with the test: the doctesting framework itself messes with `SIGCHLD`, so it needs slightly more work... let me think about it.


---

Comment by nbruin created at 2013-05-25 15:08:13

Unicode: See #12985. When I implemented `ecl.pyx` unicode support in ecl was not the default, so it was natural to skip it. I haven't kept up with its development, so I'm of little help for unicode-specific things. It looks like they got something close to working on #12985, though.

Given that all of calculus is designed to work with `str`, not with `unicode`, I think there is very little benefit in converting the ecl interface in being fully unicode aware (other than not having to turn off unicode support when building ecl), so the approach there (letting ecl work with unicode strings but convert them to ascii as soon as they leave ecl) is probably the quickest to get going.


---

Comment by leif created at 2013-05-25 17:39:05

Replying to [comment:10 Snark]:
> Replying to [comment:9 jdemeyer]:
> > Replying to [comment:6 Snark]:
> > > `@`nbruin(1) where is the ticket about the python3 transition? As far as I know, a few sagenb deps (notably twisted and flask if I remember well) and some of sage's standard packages (for example pil) are a concern in that matter, but I can't find the relevant ticket.
> > 
> > I don't think there is a ticket yet, because it's obvious it's not going to happen anytime soon.
> 
> A ticket isn't just about something which will happen just now ; it's a central place where ideas get gathered about an issue. In this case, a ticket listing what is holding back sage for the switch to python3 would probably be worthy.

You have to dig deeper (on trac and sage-devel); there have been related tickets and threads years ago, as the Python devs keep claiming _"There will be no further 2.x release after ..."_, and they do so since at least 2.4 IIRC.

(AFAIK the tickets mainly addressed removing [future] incompatibilities to Python 3.x from the Sage library, but also mention which upstream packages don't or won't [ever :-) ] work with Python 3.x, to that time of course.)

----

W.r.t. "holding back":  There's _no need_ to switch to Python 3.x ... ;-)


---

Comment by Snark created at 2013-05-26 09:27:41

Let's put this ticket back to need review : the patch which needs work is a patch about the handling of SIGCHLD in sage which is the matter of #14639.

What needs reviewing here is what is point (2) in the description : the move of the SIGCHLD code from a dirty patch within the ECL spkg to a correct ECL-library call in the sage library. The patch and the spkg I propose are a full solution to this issue ; I have already checked their correctness.


---

Comment by Snark created at 2013-05-26 09:27:41

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2013-05-26 09:38:58

As to python 3.x Christopher started to track the status of the various package with regards to python 3:
https://github.com/cschwan/sage-on-gentoo/issues/212

As to #12985 with Paulo's patch (Paulo used to package sage for Mandriva and now does sage for Fedora), if you build ecl with unicode you have to rebuild maxima and sage's ecl bits so it is all in sync. Had weird doctests issues but haven't checked lately. Look like Julien thinks it is all in order now.


---

Comment by Snark created at 2013-05-26 10:08:07

`@`fbissey:
1. I think Christopher forgot PIL ;
2. At #12985, I only checked patched-sage against current-ecl -- I'm now trying patched-sage against unicode-ecl, but since I don't have any fast computer, it takes almost a full day for a complete build+doctest...
3. let's stop discussing py3 in this ticket as it's unrelated ;-)


---

Comment by Snark created at 2013-05-27 17:59:57

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-05-29 13:47:29

Patch against ecl's p3 for p4


---

Attachment

Patch for sagelib -- about (1)


---

Attachment

Patch for sagelib -- about (2)


---

Comment by Snark created at 2013-05-29 13:53:14

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2013-05-30 11:37:33

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-05-30 13:34:16

What do you mean by "SIGCHLD doctest"? My modification doesn't change the situation -- it changes how one obtains it: the current way is by patching upstream sources, the patched way is by calling an api function.


---

Comment by jdemeyer created at 2013-05-30 13:39:18

Replying to [comment:28 Snark]:
> My modification doesn't change the situation
I am not convinced that this is true. I'm not at all saying that you're wrong, just saying that it's not obvious that you're right. A doctest can prove that you're right.


---

Comment by Snark created at 2013-05-30 14:10:10

Just look at the current situation: there is a patch to add a zero in a structure. What does my patch do? It calls a function to add a zero in a structure. No doctest will be able to say whether the zero was obtained by patching or by calling a function -- but for distribution packagers, that makes all the difference, since there's no way they'll just patch upstream just for sage.

Even if I convince you, don't close or apply the changes: I'm working on a better set of modifications to also get rid of the disabled threading stuff.


---

Comment by nbruin created at 2013-06-03 12:05:50

Replying to [comment:30 Snark]:
> I'm working on a better set of modifications to also get rid of the disabled threading stuff.
It's great if you can get that to work.

I considered enabling threading in ECL as fundamentally incompatible with the way we use it in Sage. It will cause ECL to split off a dedicated thread to handle asynchronous events and it will cause Boehm to repurpose some exotic signals to synchronize thread on garbage collection, and those signals will confuse the sage signal handler if it happens to receive them.

We are switching signal handlers upon entry/exit of ECL. With multiple threads it is not clear anymore whether sage or ECL should be in control of asynch signals at any one time.

We won't get much benefit from the change either: our main use, Maxima, uses global data structures everywhere and wasn't built with multi-processing in mind at all. It will not be able to utilize multiple threads for a long time.


---

Comment by Snark created at 2013-06-03 18:40:08

Ah, Nils, your explanations are really interesting: that would explain why I see signals (30=SIGPWR) without understanding exactly what happens.

Though there is something you miss when you say that there is not much to benefit from the change: debian's ecl is built with threads, so if sage is to be properly packaged, then it has to work with threads!


---

Comment by nbruin created at 2013-06-03 19:13:56

Replying to [comment:32 Snark]:
> Ah, Nils, your explanations are really interesting: that would explain why I see signals (30=SIGPWR) without understanding exactly what happens.

You might want to read a bit of source for this. It was enlightening to me at the time. If I remember correctly, Boehm decides at runtime whether to use those signals (IIRC it keeps track of a list of threads registered with it and if that list is longer than one, it issues those signals), so you may be able to avoid those quite easily as soon as you get ECL to not create threads.

See [ECL_OPT_SIGNAL_HANDLING_THREAD](http://ecls.sourceforge.net/new-manual/ch30s03.html) for ECL (and probably the source!) If this means we get no signal handling at all in ECL, we have a bit of a problem, of course. We still want `CTRL-C` and perhaps even `SIGALRM` to work. What we really need is that `ENABLE_THREADS` is a boot-time option.

See also #11752, although I think that with the latest ECL upgrade it was found that threading had become even more default than before and hence had to be explicitly disabled at boottime.

> Though there is something you miss when you say that there is not much to benefit from the change: debian's ecl is built with threads, so if sage is to be properly packaged, then it has to work with threads!

I seriously think that's going to be a no-go. While ECL's and sage's way of handling signals are both sensible on their own, I think they are quite incompatible. Without any threads, we can sort of manage by switching the handlers. But I'm afraid that when ECL is compiled with thread support, it insists on handling async events on a separate thread under its own control. I was hoping you had a brilliant insight.


---

Comment by Snark created at 2013-06-03 19:35:26

Well, I have seen the ECL_OPT_SIGNAL_HANDLING_THREAD option, because indeed choosing whether to enable threading at runtime vs compile-time is the way to go. I just need to find the time to do proper experiments.


---

Comment by vbraun created at 2013-06-04 13:42:05

The patch to disable the ECL SIGCHLD handler is from #14055. We had a very subtle race between a SIGCHLD and ECL's handler. When you move this to ecl_set_option then you are booting up ECL with the SIGCHLD handler, right? This seems to open up a new window for race conditions. ECL should default to no SIGCHLD handler, possibly enabling it by an option.


---

Comment by nbruin created at 2013-06-04 21:30:03

Replying to [comment:35 vbraun]:
> The patch to disable the ECL SIGCHLD handler is from #14055. We had a very subtle race between a SIGCHLD and ECL's handler. When you move this to ecl_set_option then you are booting up ECL with the SIGCHLD handler, right?

Nope. `ecl_set_option` is called _prior_ to `cl_boot`, which does all ecl initialization. The fix on #14055 patched ECL to change the _default_ value of the boot option. The inclusion of an explicit `ecl_set_option` prior to `cl_boot` is the appropriate way of overriding the default value and should be preferred over patching ecl.


---

Comment by jpflori created at 2013-06-10 08:32:00

FYI ECL 13.5.1 has been released:
* https://sourceforge.net/mailarchive/message.php?msg_id=30906130


---

Comment by Snark created at 2013-06-10 09:08:23

I'll give it a try. I'm still going nowhere :-/


---

Comment by fbissey created at 2013-06-10 11:10:36

Replying to [comment:37 jpflori]:
> FYI ECL 13.5.1 has been released:
> * https://sourceforge.net/mailarchive/message.php?msg_id=30906130
and it's terrible it switched to asdf 3 and in Sage-on-gentoo we haven't been able to build a working maxima_lib with it for the last 10 days.


---

Comment by jpflori created at 2013-06-10 15:06:47

It says ASDF 2.32 in the changelog, doesn't it?


---

Comment by Snark created at 2013-06-10 15:08:46

I can confirm the new ECL doesn't fit in-place. :'-(


---

Comment by fbissey created at 2013-06-10 21:08:08

Replying to [comment:40 jpflori]:
> It says ASDF 2.32 in the changelog, doesn't it?
I am not sure that's correct. I'll have to check. From the git clone I have Juan hadn't committed asdf 3.0.1 yet. However I think it was not many commits away from 3.0.

One of the main point is that ecl use to have the asdf-bundle extension (né asdf-ecl as they say) and that extension has been merged in asdf (2.66?) and underwent some changes in the process.

We have a formula to build a maxima.fas with the new ecl but it leads to segfault when we load it (from sage or even from ecl itself).

In Gentoo the lisp team has decided to move things to asdf 3.0.1 as fast as they can, but the harm for maxima_lib has been somewhat before 3.0.1.
See [https://github.com/cschwan/sage-on-gentoo/issues/226](https://github.com/cschwan/sage-on-gentoo/issues/226) for our status.

This is our current formula to build maxima.fas

```
		cd src
		ecl \
			-eval '(require `asdf)' \
			-eval '(push "./" asdf:*central-registry*)' \
			-eval "(asdf:initialize-output-translations \
				'(:output-translations :disable-cache :inherit-configuration))" \
			-eval '(load "maxima-build.lisp")' \
			-eval '(asdf:make-build :maxima :type :fasl)' \
			-eval '(quit)'
		ECLLIB=`ecl -eval "(princ (SI:GET-LIBRARY-PATHNAME))" -eval "(quit)"`
		insinto "${ECLLIB#${EPREFIX}}"
		newins maxima.fasb maxima.fas
```



---

Comment by nbruin created at 2013-06-12 06:28:59

Two comments that might be useful:
 - When I figured out the original formula, I used trial and error and a bit of reading documentation. I found something that worked and didn't look like it was using any illegal hacks, I was happy. The new formula looks fine in that respect too, so if it works use it!
 - The `.fasb` files were used by ADSF to avoid overwriting files produced by ECL's native build routines. As far as I could see the format is the same as the `.fas` files. I did the rename to ensure that `(require `maxima)` would work without first doing `(require `asdf)` (which was necessary for recognising what to do with `.fasb` files). Since ASDF is getting more closely integrated into ECL, you may be able to modify or avoid this renaming step.


---

Comment by fbissey created at 2013-06-12 07:00:00

Thanks for the encouragement Nils. It is not impossible that we have in fact uncovered some kind of bug.  If Martin is right we go through an initialisation twice and the second time we fall into an infinite loop.


---

Comment by fbissey created at 2013-06-15 11:01:56

Just a head up about ecl 13.1.5 and asdf upgrade issues. We have a working maxima_lib in sage-on-gentoo. So we can upgrade ecl as we now have a procedure and patch for maxima (both 5.29.1 and 5.30.0 but issues with 5.30.0 are documented in another ticket).


---

Comment by Snark created at 2013-07-09 16:11:38

I finally found the time to have look ; the spkg-src script fails with "mv: cannot stat `gmp': No such file or directory"... this is with upstream's 12.12.1 tarball.

Where is the ticket with the ecl 13.1.5 discussion?


---

Comment by fbissey created at 2013-07-09 21:37:58

We had a long thread about it - or rather the new asdf - on github for sage-on-gentoo. No spkg at this stage. The short of it is that ecl should be fine without patches. maxima, any version, needs a patch to produce what we want. The current procedure just won't work.
[https://github.com/cschwan/sage-on-gentoo/issues/226](https://github.com/cschwan/sage-on-gentoo/issues/226)


---

Comment by Snark created at 2013-07-10 10:03:22

François, if you have a way to have a no-patch-ecl+lightly-patched-maxima combination to work, perhaps it would be best to push it into sage and be done with this ticket?


---

Comment by fbissey created at 2013-07-10 10:33:12

Now that I am starting to remember stuff, removing the "dirty workaround" discussed in this ticket will break one doctest at least. But then I haven't tested your patches either.

I have problems getting enough time to work on sage these days and it will probably become worse until September. I cannot give you expectation that I will make the two spkgs in question in a timely fashion.


---

Comment by dimpase created at 2013-08-14 06:39:36

by the way, `patches/disable_sigchdl_handler.patch` apparently breaks OSX PPC support.


---

Comment by Snark created at 2013-08-14 06:46:00

Dima, then my first patch which moves the change into sagelib should there break too. That would probably mean there's an upstream issue on OSX PPC... Can you check?


---

Comment by vbraun created at 2013-08-14 10:42:26

Can you be a bit more vague about what does not work on OSX PPC without the sigchld handler?


---

Comment by dimpase created at 2013-08-14 12:32:05

Replying to [comment:53 vbraun]:
> Can you be a bit more vague about what does not work on OSX PPC without the sigchld handler?
Let me try using `less`,  as `more` is not installed :–)

Not very informative segfault with `ecl-12.12.1.p4`:

```
...
;*** Lisp core booted ****
ECL (Embeddable Common Lisp)

;;;
;;; Welcome to bare.lsp. Let's bring this instance up!
;;;
;;;
;;; About to load lsp/load.lsp
;;; 
;;; Loading src:lsp;export.lsp/bin/sh: line 1: 97036 Segmentation fault      ECLDIR=`pwd`/ ./ecl_min compile
make[4]: *** [bin/ecl] Error 139
make[3]: *** [all] Error 2
Error - Failed to build ECL ... exiting
...
```



---

Comment by dimpase created at 2013-08-14 15:29:56

Replying to [comment:52 Snark]:
> Dima, then my first patch which moves the change into sagelib should there break too. That would probably mean there's an upstream issue on OSX PPC... Can you check?

it turns out that reenabling Altivec back in `p2` was the cause of trouble. If I reapply the patch from #11297

```
--- a/spkg-install	Wed Jun 05 19:56:22 2013 +0000
+++ b/spkg-install	Wed Aug 14 23:25:31 2013 +0800
@@ -48,6 +48,12 @@
     CXXFLAGS="-g -O2 $CXXFLAGS"
 fi
 
+if [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then 
+# Disabling altivec instructions (trac 11297) 
+    CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec" 
+    export CFLAGS 
+fi 
+
 # These are all used by GNU to specify compilers.
 echo "Using CC=$CC"
 echo "Using CXX=$CXX"
```

then `p4` works for me. Sorry for noise.


---

Comment by Snark created at 2013-08-26 07:18:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-08-26 07:33:09

1) I don't think the work issue "SIGCHLD doctest" has been addressed.

2) Why do you stop removing unneeded stuff from the upstream sources? It adds 4.5MB for absolutely no reason.


---

Comment by jdemeyer created at 2013-08-26 07:33:09

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-08-26 07:34:02

Also in `SPKG.txt`, there is something wrong with the sentence "don't path to disable SIGCHLD."


---

Comment by Snark created at 2013-08-26 09:49:20

Replying to [comment:58 jdemeyer]:
> 1) I don't think the work issue "SIGCHLD doctest" has been addressed.

I don't have any failing doctest: what exactly do you want? Again, I'm just moving something from patching upstream to calling an api...

> 2) Why do you stop removing unneeded stuff from the upstream sources? It adds 4.5MB for absolutely no reason.

If unicode isn't disabled, it's not unneeded anymore.


---

Comment by Snark created at 2013-08-26 19:29:54

I made a new p5 spkg, available at the same place, and also updated the p4 to p5 patch here.


---

Comment by Snark created at 2013-08-27 08:16:38

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2013-08-27 18:07:20

Replying to [comment:60 Snark]:

> If unicode isn't disabled, it's not unneeded anymore.
That may be true for the `contrib/encodings` and `contrib/unicode` subdirectories, but do you now need `msvc`, `src/gc-unstable`, `src/libffi` and all of `src/gmp`? Your attached patch suggests you're not removing those either anymore. The attached patch also doesn't reflect the edits to spkg-make that you probably made.


---

Comment by Snark created at 2013-08-27 18:46:24

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-08-27 18:46:24

My attached patch wasn't reflecting edits to spkg-src because I didn't touch it. The next version will modify it, and only not to remove the unicode-related directories.

I'll push the new patch when I'll have checked it's ok. For now I just know it builds correctly.


---

Attachment

Patch against ecl's p4 for p5


---

Comment by Snark created at 2013-08-28 17:50:49

Changing status from needs_work to needs_review.


---

Comment by Snark created at 2013-08-28 17:50:49

No failing doctest ; now src/ is generated by a patched spkg-src.


---

Comment by Snark created at 2013-09-01 19:42:31

It's still ok with 5.12.beta4.


---

Comment by jdemeyer created at 2013-09-04 08:41:23

Replying to [comment:60 Snark]:
> Again, I'm just moving something from patching upstream to calling an api...
Again, that's only a *claim*. A doctest can *prove* you are right.


---

Comment by Snark created at 2013-09-04 10:44:06

Changing status from needs_review to needs_work.


---

Comment by Snark created at 2013-09-04 10:44:06

Replying to [comment:67 jdemeyer]:
> Replying to [comment:60 Snark]:
> > Again, I'm just moving something from patching upstream to calling an api...
> Again, that's only a *claim*. A doctest can *prove* you are right.

OOOHHH!!!! You want me to ADD a doctest!

I'm not sure it makes much sense to follow a line "a=0" by a doctest "a==0", but if you want I'll add one.


---

Comment by fbissey created at 2013-10-03 11:55:52

I see that trac_14636_2.patch is the same (up to a slight edit in the commit) than the patch in #12985 so incorporating this ticket would make it a duplicate.
I think you should go ahead and add the doctest.


---

Comment by vbraun created at 2013-11-21 02:13:51

In the spirit of having one ticket per issue I've broken off the part about using and doctesting `ecl_set_option(ECL_OPT_TRAP_SIGCHLD, 0)` into a new ticket at #15441


---

Comment by vbraun created at 2014-04-09 00:06:02

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-04-09 00:06:02

Duplicate of #12985, so close one of them. This one.


---

Comment by gagern created at 2014-04-17 11:34:47

Replying to [comment:49 Snark]:
> François, if you have a way to have a no-patch-ecl+lightly-patched-maxima combination to work, perhaps it would be best to push it into sage and be done with this ticket?

I've just pushed the build formula used on sage-on-gentoo into a branch associated with ticket:16178.


---

Comment by gagern created at 2014-06-16 20:48:42

Replying to [comment:37 jpflori]:
> FYI ECL 13.5.1 has been released:
> * https://sourceforge.net/mailarchive/message.php?msg_id=30906130

With [ticket:16178 the new maxima build system] included in sage 6.2, do you want to aim for an ECL update for 6.3?


---

Comment by pbruin created at 2014-12-01 11:03:05

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-12-01 11:03:05

Since the relevant changes were made in #12985 and #15441, we should close this as a duplicate.


---

Comment by vbraun created at 2014-12-01 11:42:16

Resolution: duplicate
