# Issue 25549: Fix introspection with ? in conda and  ArchLinux

Issue created by migration from https://trac.sagemath.org/ticket/25786

Original creator: saraedum

Original creation time: 2018-07-06 11:22:02

CC:  arojas jdemeyer slelievre

Currently, introspection does not work in conda and ArchLinux:

```
sage: ZZ?
…
/usr/lib/python2.7/site-packages/sage/misc/sagedoc.pyc in process_extlinks(s, embedded)
    497     oldpath = sys.path
    498     sys.path = [os.path.join(SAGE_DOC_SRC, 'common')] + oldpath
--> 499     from conf import extlinks
    500     sys.path = oldpath
    501     for key in extlinks:

ImportError: cannot import name extlinks
```


The problem is that `src/doc/common/conf.py` is not in the place that Sage expects.

I don't think that we should require the documentation configuration to be installed for Sage to work.


---

Comment by jdemeyer created at 2018-07-06 11:26:39

Is this needs review?
----
New commits:


---

Comment by saraedum created at 2018-07-06 11:28:10

I had a comment in #24655 that `src/doc/en/introspect` is required as well…let's see if that's still the case.


---

Comment by saraedum created at 2018-07-06 11:28:51

jdemeyer: No, I have not tested this yet. But feel free to give feedback if you know something about this :)


---

Comment by saraedum created at 2018-07-06 11:29:45

See #25787 for a followup regarding the docker images.


---

Comment by jdemeyer created at 2018-07-06 11:31:23

In any case, I agree with the idea behind the patch.


---

Comment by saraedum created at 2018-07-06 11:33:54

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-07-06 11:34:28

So, if the patchbot and my tests are Ok, then this is a positive review?


---

Comment by jdemeyer created at 2018-07-06 11:35:53

Replying to [comment:9 saraedum]:
> So, if the patchbot and my tests are Ok, then this is a positive review?

Yes


---

Comment by arojas created at 2018-07-06 12:19:49

This still doesn't allow introspection on Arch without having the doc sources installed, due to 

```
    # Sphinx constructor: Sphinx(srcdir, confdir, outdir, doctreedir,
    # buildername, confoverrides, status, warning, freshenv).
    confdir = os.path.join(SAGE_DOC_SRC, 'en', 'introspect')

    open(os.path.join(srcdir, 'docutils.conf'), 'w').write(r"""
[parsers]
smart_quotes = no
""")
    doctreedir = os.path.join(srcdir, 'doctrees')
    confoverrides = {'html_context': {}, 'master_doc': 'docstring'}

    import sys
    old_sys_path = list(sys.path)  # Sphinx modifies sys.path
    sphinx_app = Sphinx(srcdir, confdir, srcdir, doctreedir, format,
                        confoverrides, None, None, True)
    sphinx_app.build(None, [rst_name])
    sys.path = old_sys_path
```

in misc/sphinxify.py


---

Comment by git created at 2018-07-07 22:59:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-07-07 23:01:06

arojas: Right, now it works for me. But probably the `from common.conf import *` is there for a reason and I should not simply delete it.


---

Comment by jdemeyer created at 2018-07-08 06:16:57

I really prefer one ticket, one issue.


---

Comment by jdemeyer created at 2018-07-08 06:17:43

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-07-09 16:09:42

Replying to [comment:16 jdemeyer]:
> I really prefer one ticket, one issue.

I believe that this is one issue: "Fix introspection with ? in conda and ArchLinux". And even the solution can be seen as one thing: "Make Sage runtime not depend on documentation configuration."


---

Comment by saraedum created at 2018-07-09 16:12:23

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-07-09 16:12:23

The patchbots report weird errors that seem unrelated to the changes here…let me try this out locally.


---

Comment by jdemeyer created at 2018-07-12 10:48:06

I moved the first part to #25843 and gave positive review to that.


---

Comment by slelievre created at 2018-08-25 17:04:17

Changing keywords from "" to "conda, Arch Linux, introspection".


---

Comment by arojas created at 2018-08-26 07:09:17

Updating slightly misleading description - introspection works fine in Arch if the sagemath-doc package is installed.


---

Comment by jdemeyer created at 2018-09-04 20:25:09

One thing I don't like is the style of the long `"""`-quoted strings in between code. This could be made more readable by moving the strings outside of the function. Something like


```
# At module level
layout_html = r"""
<div class="docstring">
    {% block body %} {% endblock %}
</div>"""
```



```
# Inside the function
    with open(os.path.join(templatesdir, 'layout.html'), 'w') as filed:
        filed.write(layout_html)
```



---

Comment by git created at 2018-10-03 12:51:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-08 11:36:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2018-10-15 06:24:09

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2018-10-15 06:24:09

`OMIT` is removed from `src/sage_setup/docbuild/build_options.py`, but it is needed in `src/sage_setup/docbuild/__init__.py`


---

Comment by git created at 2019-06-18 21:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-18 21:32:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-06-18 21:47:22

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2019-06-19 00:06:19

I like it. It helps me remove some manual installs in sage-on-gentoo. In fact I may not have to install the `common` folder and all the stuff I put in it anymore. This may be a bigger win than it looks like.


---

Comment by fbissey created at 2019-06-19 00:48:44

The patchbot reports a few broken doctests over formatting.

```
File "src/sage/misc/sagedoc.py", line 196, in sage.misc.sagedoc.detex
Failed example:
    detex(r'Some math: `n \geq k`.  A website: \url{sagemath.org}.')
Expected:
    'Some math: n >= k.  A website: sagemath.org.\n'
Got:
    'Some math: *n geq k*.  A website: sagemath.org.\n'
```

as an example.


---

Comment by saraedum created at 2019-06-28 11:55:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-06-28 12:14:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-07-01 13:57:05

isuruf commented that following seems to be missing.


```
from sage.env import SAGE_DOC_SRC
sys.path.append(SAGE_DOC_SRC)
from common.conf import *
```



---

Comment by isuruf created at 2019-07-02 17:41:50

Maybe move `src/doc/common/conf.py` to `src/sage/docs/conf.py` and update the imports?


---

Comment by isuruf created at 2019-07-10 14:44:45

What do you think about the above suggestion? I can update this branch if you agree


---

Comment by saraedum created at 2019-07-10 14:50:39

Sorry, yes please go ahead :)


---

Comment by fbissey created at 2019-07-16 03:07:47

It would be nice to finish this. I would add that the clean up should probably also include this line https://github.com/sagemath/sage/blob/master/src/sage_setup/docbuild/build_options.py#L12

```
OMIT = ["introspect"]  # docs/dirs to omit when listing and building 'all'
```

This ticket is removing that folder altogether. Do we even need `OMIT`?  If we don't, I think we could remove that logic in a follow up ticket.


---

Comment by isuruf created at 2019-07-16 06:09:28

`@`saraedum can you pull https://github.com/isuruf/sage/commit/863d433d402c9257768929f7d62c4bd478eabbc8


---

Comment by saraedum created at 2019-07-16 06:15:32

Sure. You can also just push to this ticket, there is no ownership as with [GitHub](GitHub) PRs here.


---

Comment by git created at 2019-07-16 06:18:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2019-07-16 06:29:04

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2019-07-16 06:36:21

Is there a reason why we should not squash one layer here, i.e., move `conf.py` one level up so that we can write `from sage.docs.conf import *`?


---

Comment by isuruf created at 2019-07-16 06:38:29

No reason. I previously had some other files in `sage/docs/conf` and were removed later.


---

Comment by git created at 2019-07-16 06:39:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-16 06:43:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-07-16 06:44:57

`@`isuruf: Could  you have a look at my latest changes? (That I did not test yet, because I have not built recent Sage…)


---

Comment by isuruf created at 2019-07-16 07:00:14

Looks good to me. Thanks


---

Comment by fbissey created at 2019-07-16 07:45:35

There is strange stuff about `lcalc` in the branch. May be some rebasing is needed?


---

Comment by git created at 2019-07-16 07:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-07-16 07:51:52

Thanks fbissey. That should not have been here.


---

Comment by isuruf created at 2019-07-16 14:35:23

New commits:


---

Comment by git created at 2019-07-16 16:00:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2019-07-16 21:55:13

I think the patchbot is happy with it (the last run had a failure that should be unrelated). Anything to add or is it completely ready for review?


---

Comment by isuruf created at 2019-07-16 21:56:26

> Anything to add or is it completely ready for review? 

Nothing to add. Ready for review


---

Comment by fbissey created at 2019-07-16 22:02:25

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2019-07-16 22:02:25

Looks good to me :)


---

Comment by vbraun created at 2019-07-23 21:03:51

Resolution: fixed
