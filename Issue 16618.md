# Issue 16618: Make finite fields satisfy comparison by identity

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2014-08-19 19:50:51

CC:  jpflori simonking nbruin

Keywords: finite field comparison

For efficiency and simplicity, finite fields should compare equal if and only if they are identical.  Ideally this would be accomplished by inheriting from `WithEqualityById`.  Since `FiniteField` is a Cython class and Cython does not support multiple inheritance, we implement this by copying the `__hash__()` and `__richcmp__()` methods from `WithEqualityById`.


---

Comment by pbruin created at 2014-08-19 20:36:49

Changing status from new to needs_review.


---

Comment by pbruin created at 2014-08-21 11:11:22

Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).


---

Comment by SimonKing created at 2014-08-21 14:28:48

Replying to [comment:2 pbruin]:
> Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).

I thought that the kind of memory leaks he mentions has meanwhile been fixed. IIRC, having non-leaking bidirectional coercion was the motivation of using weak references to (co?)domain and parent of coercion maps.

So, can you or Nils give an actual example of a leak caused by bidirectional coercion in the current sage version? Or could you point me to a relevant leak-fixing ticket that has not been merged yet?


---

Comment by jpflori created at 2014-08-21 14:35:15

Do we want coercions anyway?
Wouldn't conversions be enough?

I'd say the user ending up with two different implementations of the same finite field (with same defining polynomial) surely knows how she ended up there.
So doing nothing automagically is surely better than arbitrarly choosing one of the possible directions for coercion and pushing everything there, isn't it?

Of course if when using a given implem of the finite field, you may end up with a polynomial ring based on another implem, coercion is still needed.
But now that we make sure that different implems are considered different, that should not happen.

(I may be talking non sense, I did not look at the code yet.)


---

Comment by pbruin created at 2014-08-21 14:41:52

I'll try to see if I can produce a memory leak using multidirectional coercions.  Anyway, I think that if we want these coercions, it is probably better to do this on a different ticket.


---

Comment by pbruin created at 2014-08-21 14:56:44

The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:

```
import gc
for i in range(10000):
    var = 'a' + str(i)
    F0 = FiniteField(2^3, var, impl='givaro')
    F1 = FiniteField(2^3, var, impl='pari_ffelt')
    _ = F0.coerce_map_from(F1)
    _ = F1.coerce_map_from(F0)
    if(i % 100 == 0):
        gc.collect()
        print(get_memory_usage())
```

[Edit: the correct option is `impl` instead of `implementation`, but it doesn't affect the memory leak.]


---

Comment by SimonKing created at 2014-08-21 15:26:25

Replying to [comment:6 pbruin]:
> The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:

What is / where to find the "other branch"?


---

Comment by pbruin created at 2014-08-21 15:27:59

Replying to [comment:7 SimonKing]:
> What is / where to find the "other branch"?
`u/pbruin/16855-finite_field_comparison` (see comment:2)


---

Comment by git created at 2014-08-21 16:37:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2014-09-04 18:35:14

Replying to [comment:4 jpflori]:
> Do we want coercions anyway?
> Wouldn't conversions be enough?

There is certainly a mechanism in place for caching conversions (as maps) that would lead to exactly the same memory leak. A coercion in one direction combined with a conversion in the other could lead to the same leak.

It may be that there are ways to have a conversion and *not* a cached map. In any case, however these things get solved, it's worth convincing yourself that no memory leak has been created via the usual test:

```
for p in primerange(<large>):
  <create fields with p>
  <exercise them (add, multiply, build polynomial rings over them)>
gc.collect()
```

and ensure that there is not a large number of finite fields still in memory (or just watch if memory consumption spirals out of control)


---

Comment by jdemeyer created at 2014-09-04 20:15:44

While this ticket makes the bug at #16934 go away, we still have the following bug:

```
sage: k1.<a> = GF(17^14, impl="pari_ffelt")
sage: _ = a/2
sage: k2.<a> = GF(17^14, impl="pari_ffelt")
sage: k1 is k2
False
```



---

Comment by git created at 2014-10-31 10:16:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-10-31 10:21:36

Replying to [comment:11 jdemeyer]:
> While this ticket makes the bug at #16934 go away, we still have the following bug:
> {{{
> sage: k1.<a> = GF(17^14, impl="pari_ffelt")
> sage: _ = a/2
> sage: k2.<a> = GF(17^14, impl="pari_ffelt")
> sage: k1 is k2
> False
> }}}
This was actually solved by #16934.


---

Comment by jpflori created at 2014-10-31 14:53:21

And this conflicts with #16983.


---

Comment by pbruin created at 2014-10-31 15:09:36

Replying to [comment:14 jpflori]:
> And this conflicts with #16983.
Those conflicts should be resolved by the merge commit from comment:12, or am I missing something?  Ticket #17165 also seems to merge normally.


---

Comment by jpflori created at 2014-10-31 16:06:43

I think #16983 isn't in any beta/rc/final release yet.
The merge is trivial though.
I've just done it and everything is fine for me.
I'd prefer you to do it though as I've done it in a branch with other (non-related so I hardly believe it was the reason for confusing git) stuff merged in.


---

Comment by pbruin created at 2014-10-31 16:39:23

Replying to [comment:16 jpflori]:
> I think #16983 isn't in any beta/rc/final release yet.
It is in 6.4.rc0, see https://groups.google.com/forum/#!topic/sage-release/xgmJ3nAcUOY
(that is the version I merged with)


---

Comment by jpflori created at 2014-11-03 10:40:52

Oh yes you're right.
I just had a look at the empty "merged in" field.


---

Comment by jpflori created at 2014-11-03 10:41:54

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2014-11-03 10:41:54

So I guess it is dark magic I used which confused git.


---

Comment by pbruin created at 2014-11-03 14:39:01

Replying to [comment:18 jpflori]:
> Oh yes you're right.
> I just had a look at the empty "merged in" field.
For some reason that field is not used anymore since the switch to Git.  I think that Volker advocates using `git log` or the release notes to find out when a ticket was merged (which I find unfortunate since those methods are less convenient than the "merged in" field).  Anyway, thanks for the review.


---

Comment by vbraun created at 2014-11-07 16:15:21

Resolution: fixed
