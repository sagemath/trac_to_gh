# Issue 16618: Make finite fields satisfy comparison by identity

archive/issues_016618.json:
```json
{
    "body": "CC:  jpflori simonking @nbruin\n\nKeywords: finite field comparison\n\nFor efficiency and simplicity, finite fields should compare equal if and only if they are identical.  Ideally this would be accomplished by inheriting from `WithEqualityById`.  Since `FiniteField` is a Cython class and Cython does not support multiple inheritance, we implement this by copying the `__hash__()` and `__richcmp__()` methods from `WithEqualityById`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16855\n\n",
    "created_at": "2014-08-19T19:50:51Z",
    "labels": [
        "component: finite rings",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Make finite fields satisfy comparison by identity",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16618",
    "user": "https://github.com/pjbruin"
}
```
CC:  jpflori simonking @nbruin

Keywords: finite field comparison

For efficiency and simplicity, finite fields should compare equal if and only if they are identical.  Ideally this would be accomplished by inheriting from `WithEqualityById`.  Since `FiniteField` is a Cython class and Cython does not support multiple inheritance, we implement this by copying the `__hash__()` and `__richcmp__()` methods from `WithEqualityById`.

Issue created by migration from https://trac.sagemath.org/ticket/16855





---

archive/issue_comments_218782.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-19T20:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218782",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_218783.json:
```json
{
    "body": "Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).",
    "created_at": "2014-08-21T11:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218783",
    "user": "https://github.com/pjbruin"
}
```

Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).



---

archive/issue_comments_218784.json:
```json
{
    "body": "Replying to [comment:2 pbruin]:\n> Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).\n\n\nI thought that the kind of memory leaks he mentions has meanwhile been fixed. IIRC, having non-leaking bidirectional coercion was the motivation of using weak references to (co?)domain and parent of coercion maps.\n\nSo, can you or Nils give an actual example of a leak caused by bidirectional coercion in the current sage version? Or could you point me to a relevant leak-fixing ticket that has not been merged yet?",
    "created_at": "2014-08-21T14:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218784",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:2 pbruin]:
> Changing branch to not introduce coercions between different implementations of the same finite field, since this will lead to memory leaks; see Nils Bruin's comments [here](https://groups.google.com/d/msg/sage-devel/c8cCvT84CLo/436vAxVoBdMJ).


I thought that the kind of memory leaks he mentions has meanwhile been fixed. IIRC, having non-leaking bidirectional coercion was the motivation of using weak references to (co?)domain and parent of coercion maps.

So, can you or Nils give an actual example of a leak caused by bidirectional coercion in the current sage version? Or could you point me to a relevant leak-fixing ticket that has not been merged yet?



---

archive/issue_comments_218785.json:
```json
{
    "body": "Do we want coercions anyway?\nWouldn't conversions be enough?\n\nI'd say the user ending up with two different implementations of the same finite field (with same defining polynomial) surely knows how she ended up there.\nSo doing nothing automagically is surely better than arbitrarly choosing one of the possible directions for coercion and pushing everything there, isn't it?\n\nOf course if when using a given implem of the finite field, you may end up with a polynomial ring based on another implem, coercion is still needed.\nBut now that we make sure that different implems are considered different, that should not happen.\n\n(I may be talking non sense, I did not look at the code yet.)",
    "created_at": "2014-08-21T14:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218785",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Do we want coercions anyway?
Wouldn't conversions be enough?

I'd say the user ending up with two different implementations of the same finite field (with same defining polynomial) surely knows how she ended up there.
So doing nothing automagically is surely better than arbitrarly choosing one of the possible directions for coercion and pushing everything there, isn't it?

Of course if when using a given implem of the finite field, you may end up with a polynomial ring based on another implem, coercion is still needed.
But now that we make sure that different implems are considered different, that should not happen.

(I may be talking non sense, I did not look at the code yet.)



---

archive/issue_comments_218786.json:
```json
{
    "body": "I'll try to see if I can produce a memory leak using multidirectional coercions.  Anyway, I think that if we want these coercions, it is probably better to do this on a different ticket.",
    "created_at": "2014-08-21T14:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218786",
    "user": "https://github.com/pjbruin"
}
```

I'll try to see if I can produce a memory leak using multidirectional coercions.  Anyway, I think that if we want these coercions, it is probably better to do this on a different ticket.



---

archive/issue_comments_218787.json:
```json
{
    "body": "The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:\n\n```\nimport gc\nfor i in range(10000):\n    var = 'a' + str(i)\n    F0 = FiniteField(2^3, var, impl='givaro')\n    F1 = FiniteField(2^3, var, impl='pari_ffelt')\n    _ = F0.coerce_map_from(F1)\n    _ = F1.coerce_map_from(F0)\n    if(i % 100 == 0):\n        gc.collect()\n        print(get_memory_usage())\n```\n[Edit: the correct option is `impl` instead of `implementation`, but it doesn't affect the memory leak.]",
    "created_at": "2014-08-21T14:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218787",
    "user": "https://github.com/pjbruin"
}
```

The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:

```
import gc
for i in range(10000):
    var = 'a' + str(i)
    F0 = FiniteField(2^3, var, impl='givaro')
    F1 = FiniteField(2^3, var, impl='pari_ffelt')
    _ = F0.coerce_map_from(F1)
    _ = F1.coerce_map_from(F0)
    if(i % 100 == 0):
        gc.collect()
        print(get_memory_usage())
```
[Edit: the correct option is `impl` instead of `implementation`, but it doesn't affect the memory leak.]



---

archive/issue_comments_218788.json:
```json
{
    "body": "Replying to [comment:6 pbruin]:\n> The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:\n\n\nWhat is / where to find the \"other branch\"?",
    "created_at": "2014-08-21T15:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218788",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:6 pbruin]:
> The following does not leak memory with the current branch, but does leak memory after applying the additional commit `fcc623fd` from the other branch:


What is / where to find the "other branch"?



---

archive/issue_comments_218789.json:
```json
{
    "body": "Replying to [comment:7 SimonKing]:\n> What is / where to find the \"other branch\"?\n\n`u/pbruin/16855-finite_field_comparison` (see comment:2)",
    "created_at": "2014-08-21T15:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218789",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:7 SimonKing]:
> What is / where to find the "other branch"?

`u/pbruin/16855-finite_field_comparison` (see comment:2)



---

archive/issue_comments_218790.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-21T16:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_218791.json:
```json
{
    "body": "Replying to [comment:4 jpflori]:\n> Do we want coercions anyway?\n> Wouldn't conversions be enough?\n\n\nThere is certainly a mechanism in place for caching conversions (as maps) that would lead to exactly the same memory leak. A coercion in one direction combined with a conversion in the other could lead to the same leak.\n\nIt may be that there are ways to have a conversion and *not* a cached map. In any case, however these things get solved, it's worth convincing yourself that no memory leak has been created via the usual test:\n\n```\nfor p in primerange(<large>):\n  <create fields with p>\n  <exercise them (add, multiply, build polynomial rings over them)>\ngc.collect()\n```\nand ensure that there is not a large number of finite fields still in memory (or just watch if memory consumption spirals out of control)",
    "created_at": "2014-09-04T18:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218791",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:4 jpflori]:
> Do we want coercions anyway?
> Wouldn't conversions be enough?


There is certainly a mechanism in place for caching conversions (as maps) that would lead to exactly the same memory leak. A coercion in one direction combined with a conversion in the other could lead to the same leak.

It may be that there are ways to have a conversion and *not* a cached map. In any case, however these things get solved, it's worth convincing yourself that no memory leak has been created via the usual test:

```
for p in primerange(<large>):
  <create fields with p>
  <exercise them (add, multiply, build polynomial rings over them)>
gc.collect()
```
and ensure that there is not a large number of finite fields still in memory (or just watch if memory consumption spirals out of control)



---

archive/issue_comments_218792.json:
```json
{
    "body": "While this ticket makes the bug at #16934 go away, we still have the following bug:\n\n```\nsage: k1.<a> = GF(17^14, impl=\"pari_ffelt\")\nsage: _ = a/2\nsage: k2.<a> = GF(17^14, impl=\"pari_ffelt\")\nsage: k1 is k2\nFalse\n```",
    "created_at": "2014-09-04T20:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218792",
    "user": "https://github.com/jdemeyer"
}
```

While this ticket makes the bug at #16934 go away, we still have the following bug:

```
sage: k1.<a> = GF(17^14, impl="pari_ffelt")
sage: _ = a/2
sage: k2.<a> = GF(17^14, impl="pari_ffelt")
sage: k1 is k2
False
```



---

archive/issue_comments_218793.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-31T10:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218793",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_218794.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> While this ticket makes the bug at #16934 go away, we still have the following bug:\n> \n> ```\n> sage: k1.<a> = GF(17^14, impl=\"pari_ffelt\")\n> sage: _ = a/2\n> sage: k2.<a> = GF(17^14, impl=\"pari_ffelt\")\n> sage: k1 is k2\n> False\n> ```\n\nThis was actually solved by #16934.",
    "created_at": "2014-10-31T10:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218794",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:11 jdemeyer]:
> While this ticket makes the bug at #16934 go away, we still have the following bug:
> 
> ```
> sage: k1.<a> = GF(17^14, impl="pari_ffelt")
> sage: _ = a/2
> sage: k2.<a> = GF(17^14, impl="pari_ffelt")
> sage: k1 is k2
> False
> ```

This was actually solved by #16934.



---

archive/issue_comments_218795.json:
```json
{
    "body": "And this conflicts with #16983.",
    "created_at": "2014-10-31T14:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218795",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

And this conflicts with #16983.



---

archive/issue_comments_218796.json:
```json
{
    "body": "Replying to [comment:14 jpflori]:\n> And this conflicts with #16983.\n\nThose conflicts should be resolved by the merge commit from comment:12, or am I missing something?  Ticket #17165 also seems to merge normally.",
    "created_at": "2014-10-31T15:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218796",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:14 jpflori]:
> And this conflicts with #16983.

Those conflicts should be resolved by the merge commit from comment:12, or am I missing something?  Ticket #17165 also seems to merge normally.



---

archive/issue_comments_218797.json:
```json
{
    "body": "I think #16983 isn't in any beta/rc/final release yet.\nThe merge is trivial though.\nI've just done it and everything is fine for me.\nI'd prefer you to do it though as I've done it in a branch with other (non-related so I hardly believe it was the reason for confusing git) stuff merged in.",
    "created_at": "2014-10-31T16:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218797",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think #16983 isn't in any beta/rc/final release yet.
The merge is trivial though.
I've just done it and everything is fine for me.
I'd prefer you to do it though as I've done it in a branch with other (non-related so I hardly believe it was the reason for confusing git) stuff merged in.



---

archive/issue_comments_218798.json:
```json
{
    "body": "Replying to [comment:16 jpflori]:\n> I think #16983 isn't in any beta/rc/final release yet.\n\nIt is in 6.4.rc0, see https://groups.google.com/forum/#!topic/sage-release/xgmJ3nAcUOY\n(that is the version I merged with)",
    "created_at": "2014-10-31T16:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218798",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:16 jpflori]:
> I think #16983 isn't in any beta/rc/final release yet.

It is in 6.4.rc0, see https://groups.google.com/forum/#!topic/sage-release/xgmJ3nAcUOY
(that is the version I merged with)



---

archive/issue_comments_218799.json:
```json
{
    "body": "Oh yes you're right.\nI just had a look at the empty \"merged in\" field.",
    "created_at": "2014-11-03T10:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218799",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Oh yes you're right.
I just had a look at the empty "merged in" field.



---

archive/issue_comments_218800.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-03T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218800",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_218801.json:
```json
{
    "body": "So I guess it is dark magic I used which confused git.",
    "created_at": "2014-11-03T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218801",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

So I guess it is dark magic I used which confused git.



---

archive/issue_comments_218802.json:
```json
{
    "body": "Replying to [comment:18 jpflori]:\n> Oh yes you're right.\n> I just had a look at the empty \"merged in\" field.\n\nFor some reason that field is not used anymore since the switch to Git.  I think that Volker advocates using `git log` or the release notes to find out when a ticket was merged (which I find unfortunate since those methods are less convenient than the \"merged in\" field).  Anyway, thanks for the review.",
    "created_at": "2014-11-03T14:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218802",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:18 jpflori]:
> Oh yes you're right.
> I just had a look at the empty "merged in" field.

For some reason that field is not used anymore since the switch to Git.  I think that Volker advocates using `git log` or the release notes to find out when a ticket was merged (which I find unfortunate since those methods are less convenient than the "merged in" field).  Anyway, thanks for the review.



---

archive/issue_comments_218803.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-07T16:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16618#issuecomment-218803",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_049300.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-11-07T16:15:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16618",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16618#event-49300"
}
```
