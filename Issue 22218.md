# Issue 22218: _facet_adjacency_matrix not working correctly for non-fulldimensional polyhedra

Issue created by migration from Trac.

Original creator: cpegel

Original creation time: 2017-02-26 22:48:07

CC:  jipilab moritz vdelecroix

Keywords: polyhedron facets

The method `_facet_adjacency_matrix` of the `Polyhedron` class produces a wrong matrix for polyhedra that are not of same dimension as their ambient space. For example, a triangle sitting in `ZZ^3` results in the adjacency matrix


```
[0 1 1 1]
[1 0 0 0]
[1 0 0 0]
[1 0 0 0]
```


The problem is that what is being checked is the ambient H-representation of some face being of length 2, which is interpreted as "2 facets are intersecting". This approach doesn't work for codimension not equal to 0.

I have attached a proposed patch that takes codimension into account.


---

Comment by jipilab created at 2017-03-10 11:21:21

Is this ready for review?


---

Comment by cpegel created at 2017-03-10 16:27:34

Replying to [comment:1 jipilab]:
> Is this ready for review?

Yes.


---

Comment by jipilab created at 2017-03-17 09:55:09

Changing status from new to needs_review.


---

Comment by jipilab created at 2017-03-31 08:43:59

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2017-03-31 08:43:59

Hi,

- You use `P` for the polyhedron. It should be `self` (otherwise no test are going to pass)
- By the same token, you improve the code because you are not computing the face lattice. Therefore the comment in the code should be removed and the description of the ticket (and the title) should be adapted.
- Is it certain that the equations always start the Hrepresentation? This should be a comment in the `set_adjacent` private function to explain why the indices are shifted.

I am not sure if getting rid of the equations is a good idea, because maybe one would like to use the matrix with the indices given by the H-representation. Perhaps there could be an optional parameter that decides this, and the default could be that the equations are not included.

A last thing, it would be more practical for reviewing and testing that you submit the patch using git.

Instruction can be found here:

http://doc.sagemath.org/html/en/developer/index.html#git-for-sage-development

Let me know if you have problems or question regarding the procedures.

Thanks for the patch.


---

Comment by jipilab created at 2017-03-31 08:44:28

Oh, and you should provide your full name in the "Author" field.

Thanks!


---

Comment by cpegel created at 2017-03-31 08:54:56

proposed patch


---

Attachment

Replying to [comment:4 jipilab]:
> - You use `P` for the polyhedron. It should be `self` (otherwise no test are going to pass)
Right, I forgot to change `P` to `self` since I was just using this as a script local replacement when testing, thanks.

> - By the same token, you improve the code because you are not computing the face lattice. Therefore the comment in the code should be removed and the description of the ticket (and the title) should be adapted.

Since the `faces` method of the `Polyhedron_base` class calls `self.face_lattice()`, this still computes the whole face lattice. So it isn't an improvement regarding this.

> - Is it certain that the equations always start the Hrepresentation? This should be a comment in the `set_adjacent` private function to explain why the indices are shifted.

I guess the best idea is to filter the Hrepresentation for inequalities, I'll try how this works out.

> I am not sure if getting rid of the equations is a good idea, because maybe one would like to use the matrix with the indices given by the H-representation. Perhaps there could be an optional parameter that decides this, and the default could be that the equations are not included.

I guess this is really the question of what `facet_adjacency_matrix` is expected to return. In my opinion: a matrix with numbers of rows/columns equal to the number of facets, in order as they appear in `Hrepresentation`. Sure it could have a parameter to get a matrix of size the same as the length of `Hrepresentation`, what would be useful values in the corresponding rows/columns?

> A last thing, it would be more practical for reviewing and testing that you submit the patch using git.
> 
> Instruction can be found here:
> 
> http://doc.sagemath.org/html/en/developer/index.html#git-for-sage-development
> 
> Let me know if you have problems or question regarding the procedures.

Alright, I'll look into it, thanks a lot.

> 
> Thanks for the patch.

Thanks for your careful review!


---

Comment by jipilab created at 2017-08-21 22:35:40

Changing keywords from "polyhedron facets" to "polyhedron facets, days88".


---

Comment by jipilab created at 2017-08-21 22:35:40

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2017-08-21 22:35:40

I added a git branch containing the changes in the patch file.
----
New commits:


---

Comment by vdelecroix created at 2017-08-22 08:54:51

doctest? There must be an example of what used to fail.


---

Comment by vdelecroix created at 2017-08-22 08:54:59

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-22 14:49:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-08-22 14:54:53

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2017-08-30 12:30:49

ping!


---

Comment by git created at 2018-02-26 15:01:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-26 20:31:43

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-02-26 20:31:43

ok


---

Comment by jipilab created at 2018-02-27 08:01:13

Cool! Merci!


---

Comment by vbraun created at 2018-03-04 23:29:09

Resolution: fixed
