# Issue 32825: GH Actions (docker): Run a job for "make build-local" first, cache image for job "make build"

Issue created by migration from https://trac.sagemath.org/ticket/33062

Original creator: mkoeppe

Original creation time: 2021-12-21 17:27:28

CC:  @tobiasdiez dimpase

Follow up from #32703, where this was implemented for macOS.

Here we implement it for the `docker`-based workflows.

References
- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching


---

Comment by mkoeppe created at 2022-02-07 00:18:06

Last 10 new commits:


---

Comment by git created at 2022-02-07 02:01:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-07 02:39:32

Obviously there is again a lot of cut+paste going on here, but I'm not sure yet whether this is best refactored using (1) scripts to be put in `.ci/`; (2) new top-level `Makefile` targets; (3) reusable workflows in the same repo; (4) reusable workflows from a different repo. So until then, copy+paste it is


---

Comment by git created at 2022-02-07 06:04:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-07 06:06:13

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-02-07 12:52:32

A lot of jobs are failing because there doesn't exist a corresponding `maximal` image. 

What is the distinction between the `docker` and `docker-optional` jobs?


---

Comment by mkoeppe created at 2022-02-07 16:34:25

Replying to [comment:14 gh-tobiasdiez]:
> What is the distinction between the `docker` and `docker-optional` jobs?

`docker-optional` also runs the stages that build optional and experimental packages.


---

Comment by mkoeppe created at 2022-02-07 16:39:26

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-07 16:42:32

Replying to [comment:14 gh-tobiasdiez]:
> A lot of jobs are failing because there doesn't exist a corresponding `maximal` image. 

Not sure if that's it but there are a number of new failures introduced by switching to `DOCKER_BUILDKIT=1`, for example https://github.com/mkoeppe/sage/runs/5087229478?check_suite_focus=true

```
 > [with-system-packages 130/204] RUN zypper --ignore-unknown install --no-confirm --auto-agree-with-licenses --no-recommends --details "pkgconfig(gf2x)" || echo "(ignoring error)":
------
failed to prepare d4bec9ys962tp15dnd39jkkya: max depth exceeded
```


This will require some changes in `build/bin/write-dockerfile.sh`


---

Comment by @tobiasdiez created at 2022-02-07 17:58:16

Replying to [comment:15 mkoeppe]:
> Replying to [comment:14 gh-tobiasdiez]:
> > What is the distinction between the `docker` and `docker-optional` jobs?
> 
> `docker-optional` also runs the stages that build optional and experimental packages.
> 

Okay, thanks! Would it then make sense to base the `docker-optional` on the image created in the `docker` job to speed up the build (i.e. as a "stage")?


---

Comment by mkoeppe created at 2022-02-07 18:24:02

It's currently using a different package configuration (`-maximal` instead of `-standard`)


---

Comment by @tobiasdiez created at 2022-02-07 21:45:32

Replying to [comment:19 mkoeppe]:
> It's currently using a different package configuration (`-maximal` instead of `-standard`)

But wasn't your idea with the stages, that the first stage should build all required images (i.e. minimal, standard, maximum) which could then be reused in different ways for the other stages?


---

Comment by mkoeppe created at 2022-02-07 22:34:49

Replying to [comment:20 gh-tobiasdiez]:
> wasn't your idea with the stages, that the first stage should build all required images (i.e. minimal, standard, maximum) which could then be reused in different ways for the other stages?

Yes, it is doing that. But it is only building optional packages on top of the `-maximal` configuration, not on top of the other configurations.


---

Comment by @tobiasdiez created at 2022-02-07 22:41:15

Okay, what confuses me is that it seems to not be part of the "stage" design in the sense that it's not using the stage-1 of the normal `docker` job.


---

Comment by mkoeppe created at 2022-02-07 22:46:42

It's using stage-1 of its own docker job because it needs "maximal", not "minimal"/"standard".


---

Comment by @tobiasdiez created at 2022-02-07 22:54:48

Ah okay, now I understand. And it is not possible to have one common "stage-1" that build all three variants?


---

Comment by mkoeppe created at 2022-02-07 23:24:59

GH Actions appears to be running on 8-bit technology: Matrix jobs that would create > 256 jobs are silently dropped from the workflow.


---

Comment by mkoeppe created at 2022-02-07 23:27:00

... and 6 stages * 3 packages factors * 46(?) system factors would exceed that.


---

Comment by @tobiasdiez created at 2022-02-07 23:40:25

Replying to [comment:26 mkoeppe]:
> ... and 6 stages * 3 packages factors * 46(?) system factors would exceed that.

Why 6 stages? What I meant is that you have one job creating all docker images, then build jobs on top of this. I feel like this design is also more flexible, since you can easily run certain follow up stages only on a subset of configs.


---

Comment by mkoeppe created at 2022-02-07 23:56:52

2 stages * 3 * 46 also exceeds 256.


---

Comment by mkoeppe created at 2022-02-08 00:46:44

In any case, the scope of the ticket is to change how it is build (= in 2 stages, to solve the 6-hour timeouts for some platforms).  I am keeping *what* is built/tested the same as before. One ticket, one change.


---

Comment by @tobiasdiez created at 2022-02-08 10:46:35

Replying to [comment:28 mkoeppe]:
> 2 stages * 3 * 46 also exceeds 256.

My point was that you shouldn't use the matrix for stages, so that you don't run into these constraints.
- Job "build": (min, standard, max) for each system (=3 * 46 < 256) - build docker image
- Job "test-basic": (min, standard) for each system - build sage, run tests
- Job "test-optional": max for each system - build sage with optional packages, run tests

This would also keep what is build and runs in stages.


---

Comment by mkoeppe created at 2022-02-08 18:47:56

Job "build" does not reliably fit into 6 hours.


---

Comment by @tobiasdiez created at 2022-02-08 19:05:50

Replying to [comment:31 mkoeppe]:
> Job "build" does not reliably fit into 6 hours.

You seem to have the same problem with the current setup as well (e.g. first stage of debian-bookworm fails due timeout). 

In this case, you can selectively add a second stage for these problematic systems using matrices as in https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#example-including-new-combinations


---

Comment by mkoeppe created at 2022-02-08 19:42:22

Another reason for the split into the 2 build stages is explained in the ticket description of #32703.


---

Comment by mkoeppe created at 2022-02-08 19:45:01

Replying to [comment:32 gh-tobiasdiez]:
> you can selectively add a second stage for these problematic systems using matrices

-1


---

Comment by @tobiasdiez created at 2022-02-08 20:11:08

Replying to [comment:33 mkoeppe]:
> Another reason for the split into the 2 build stages is explained in the ticket description of #32703.
> 

I don't see anything there that would be easier with matrix-stages over job-stages. In the contrary, the design I proposed above can easily be extended using additional jobs (that run on top of "build"). While your matrix-stage design would need an additional stage, which is not possible due to 3 stages * 2 configs * 46 systems > 256.


---

Comment by mkoeppe created at 2022-02-08 20:20:48

comment:31


---

Comment by mkoeppe created at 2022-02-08 20:28:05

Replying to [comment:32 gh-tobiasdiez]:
> Replying to [comment:31 mkoeppe]:
> > Job "build" does not reliably fit into 6 hours.
> 
> You seem to have the same problem with the current setup as well (e.g. first stage of debian-bookworm fails due timeout). 

No, that's likely only a sporadic failure.


---

Comment by @tobiasdiez created at 2022-02-08 23:24:13

Here is a version where I converted your first stage to a "prebuild" job. It runs exactly the same code (except if I made a mistake and missed some hidden environment variables). So the prebuild job timeouts iff if your stage 1 job would time out.

https://github.com/sagemath/sagetrac-mirror/actions/runs/1814856715
https://github.com/sagemath/sagetrac-mirror/blob/public/build/refactor-ci-runtests/.github/workflows/ci-docker.yml


---

Comment by mkoeppe created at 2022-02-09 21:01:31

OK, so to summarize, the revised plan of comment:30 would be:

 - Job "prebuild": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets-pre` images
 - Job "build": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets` images
 - Job "test-basic": (minimal, standard) for each system - build sage, run tests
 - Job "test-optional": (maximal) for each system - build sage with optional packages, run tests

This would work. Minor detail: After this change, prebuild and build would build the union of the platforms currently run for "standard" and for "maximal". That's a small change, but that would be fine with me.


---

Comment by mkoeppe created at 2022-02-09 21:02:23

In fact, the first two jobs should probably be named "targets-pre" and "targets"


---

Comment by @tobiasdiez created at 2022-02-10 15:47:14

Replying to [comment:39 mkoeppe]:
> OK, so to summarize, the revised plan of comment:30 would be:
> 
>  - Job "prebuild": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets-pre` images
>  - Job "build": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets` images
>  - Job "test-basic": (minimal, standard) for each system - build sage, run tests
>  - Job "test-optional": (maximal) for each system - build sage with optional packages, run tests
> 

Yes, that's what I had in mind. And if you extract the current workflow into an reusable workflow and replace the tox command by an input, then this should also be possible without any code duplication (except for the duplicate matrix).


---

Comment by @tobiasdiez created at 2022-02-10 15:48:39

Replying to [comment:40 mkoeppe]:
> In fact, the first two jobs should probably be named "targets-pre" and "targets" 

To be honest, I don't find "targets" a very illuminating name.


---

Comment by mkoeppe created at 2022-02-10 18:08:42

A "target" is what make makes


---

Comment by @tobiasdiez created at 2022-02-11 08:43:36

But why is this information important for the docker images and the ci steps? I find something like `with-system-packages` or `with-python-packages` more descriptive.


---

Comment by mkoeppe created at 2022-02-11 18:36:08

`with-system-packages` already exists and it's not that


---

Comment by mkoeppe created at 2022-02-11 18:45:56

Consistency matters. Can't invent a new name for the same thing at every turn.


---

Comment by git created at 2022-02-13 18:45:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-02-13 18:45:41

Rebased


---

Comment by mkoeppe created at 2022-02-13 19:37:08

Replying to [comment:41 gh-tobiasdiez]:
> Replying to [comment:39 mkoeppe]:
> > OK, so to summarize, the revised plan of comment:30 would be:
> > 
> >  - Job "prebuild": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets-pre` images
> >  - Job "build": (minimal, standard, maximal) for each system (=3 * 46 < 256) - build `-with-targets` images
> >  - Job "test-basic": (minimal, standard) for each system - build sage, run tests
> >  - Job "test-optional": (maximal) for each system - build sage with optional packages, run tests
> > 
> 
> Yes, that's what I had in mind. And if you extract the current workflow into an reusable workflow and replace the tox command by an input, then this should also be possible without any code duplication (except for the duplicate matrix).

No objections if you want to do this work. On the present ticket, I don't want to start with reusable workflows though. I have opened #33338 for such refactoring steps.


---

Comment by git created at 2022-02-13 19:43:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 01:01:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 01:02:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-02-14 04:21:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-14 04:24:52

Replying to [comment:37 mkoeppe]:
> Replying to [comment:32 gh-tobiasdiez]:
> > Replying to [comment:31 mkoeppe]:
> > > Job "build" does not reliably fit into 6 hours.
> > 
> > You seem to have the same problem with the current setup as well (e.g. first stage of debian-bookworm fails due timeout). 
> 
> No, that's likely only a sporadic failure.

Actually it was building too much, fixed now in bfe561f


---

Comment by git created at 2022-02-14 07:04:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 17:47:12

`opensuse-15.3-maximal`:

```
#135 [with-system-packages 130/204] RUN zypper --ignore-unknown install --no-confirm --auto-agree-with-licenses --no-recommends --details "pkgconfig(gf2x)" || echo "(ignoring error)"
#135 sha256:da2e30a5ebcf7a7f99e521987cff4345a05792735e3866c4f70a29402e19512e
#135 ERROR: failed to prepare 956694vunjg38oyu4pzr7kgxx: max depth exceeded
```

Here `build/bin/write-dockerfile.sh` uses too many `RUN` commands because `$EXISTS` is not defined


---

Comment by mkoeppe created at 2022-02-14 17:47:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-14 22:45:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 22:48:46

Also caching still does not seem to work reliably.

For example, https://github.com/mkoeppe/sage/runs/5178183571?check_suite_focus=true has pushed like `ghcr.io/mkoeppe/sage/sage-docker-ubuntu-focal-minimal-configured:9.5-81701-ge8de33c091`, and https://github.com/mkoeppe/sage/runs/5178187220?check_suite_focus=true is able to download it; but it proceeds to build everything from scratch, which leads to the 6h-timeout


---

Comment by @tobiasdiez created at 2022-02-15 12:22:03

Maybe use the github workflow run id as the docker tag?


---

Comment by git created at 2022-02-15 17:17:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-15 19:10:07

Replying to [comment:61 gh-tobiasdiez]:
> Maybe use the github workflow run id as the docker tag?
I think this was not the problem


---

Comment by mkoeppe created at 2022-02-16 19:14:45

Still broken - e.g. https://github.com/mkoeppe/sage/runs/5204591833?check_suite_focus=true


---

Comment by git created at 2022-07-28 04:23:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-07-28 06:42:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-28 23:23:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-28 23:41:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-29 10:27:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-01 06:22:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-01 06:33:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-01 06:42:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-01 06:45:41

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-08-03 04:08:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-08-03 05:44:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-03 06:12:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-09-19 16:06:21

Marking it as critical because it is a dependency of #34266


---

Comment by mkoeppe created at 2022-09-19 16:06:21

Changing priority from major to critical.


---

Comment by @dimpase created at 2022-09-21 15:13:57

Changing status from needs_review to positive_review.


---

Comment by @dimpase created at 2022-09-21 15:13:57

lgtm


---

Comment by mkoeppe created at 2022-09-21 15:19:58

Thanks!


---

Comment by vbraun created at 2022-09-25 16:34:31

Resolution: fixed
