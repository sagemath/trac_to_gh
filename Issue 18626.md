# Issue 18626: Subgroup doesn't work with number field unit group

Issue created by migration from Trac.

Original creator: katestange

Original creation time: 2015-07-07 22:10:43

CC:  katestange tscholl2

Keywords: unit group, number field, subgroup

I think we would like the following code to work:


```
N.<a> = NumberField(x^3+2)
G = N.unit_group()
g = G.random_element()
G.subgroup([g])
```


But at the moment the last line produces a runtime error

```
RuntimeError: Gap produced error output
Error, Variable: 'u1' must have a value
```


This is currently reproducible on the single cell sage server and sage cloud.  It does not seem to depend on the number field in question.

As far as I can tell, subgroup() is unable to recognise the input as elements of the group.


---

Comment by katestange created at 2015-07-07 22:21:07

Changing priority from minor to major.


---

Comment by katestange created at 2015-07-08 14:36:26

I asked for a workaround here, and there is some more information from other users there:  [http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/](http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/)


---

Comment by katestange created at 2015-07-08 14:37:03

Changing keywords from "unit group, number field, subgroup" to "unit group, number field, subgroup, gap".


---

Comment by fwclarke created at 2015-07-09 10:13:28

I note that the same problem arises with class groups, which are also built using `AbelianGroupWithValues`.  However in the following case, it _is_ possible to obtain a subgroup of a group with values:

```
sage: U = Zmod(30).unit_group()
sage: type(U)
<class 'sage.groups.abelian_gps.values.AbelianGroupWithValues_class_with_category'>
sage: U.subgroup([U.random_element()])
Multiplicative Abelian subgroup isomorphic to C2 generated by {f0*f1^2}
```

I have tried, but failed, to see why the other cases lead to `gap` errors.


---

Comment by tscholl2 created at 2020-06-05 02:24:30

I believe this is another small example, and it raises an exception in at least Sage 9.0.


```python
G = AbelianGroup([4,0])
G.subgroup(G.gens())
```


I printed out the gap commands which this runs in the `gap.eval(...)` lines:


```
G:= AbelianGroup([4]); gens := GeneratorsOfGroup(G)
f0 := gens[1]
gensH:=[f0, f1]
```


It seemed clear that the issue was likely the order check here:

https://github.com/sagemath/sage/blob/860e4dc9881966a36ef8808a0d1fae0c6b54f741/src/sage/groups/abelian_gps/abelian_group.py#L1549

Changing those lines to the following seem to fix it:


```python
Hgens0 = [x for x in Hgens if any(y in str(x) for y in Ggens0)]
Hgensf = [x for x in Hgens if not(x in Hgens0)]
```


This seemed to also make the code in the original post work, i.e.:


```python
H = AbelianGroup(5,[2])
H.subgroup([H.random_element()])
```


I have not tested this rigorously yet, and I have no idea if this is the "proper" way to test whether a generator has infinite order. I am also unsure if that is the thing which is being tested here.


---

Comment by tscholl2 created at 2020-06-12 14:02:13

Changing status from new to needs_review.


---

Comment by tscholl2 created at 2020-06-12 14:02:13

I modified the lines I mentioned in my previous comment, however I tried to avoid using string representations and instead looked at the order of each generator appearing in each element given as a generator for the subgroup.

It passed all tests for me when running `./sage -t src/sage/groups/*` and `./sage -t --long src/sage/groups/abelian_gps/*`.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by roed created at 2021-04-28 07:25:12

I deleted a couple lines to make pyflakes happy; set to positive review once tests pass.
----
New commits:


---

Comment by roed created at 2021-04-28 21:27:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-05-27 20:30:36

Resolution: fixed
