# Issue 28763: make libs/readline know where headers/libs are

Issue created by migration from https://trac.sagemath.org/ticket/29000

Original creator: dimpase

Original creation time: 2020-01-13 10:37:44

CC:  dimpase dcoudert isuruf mjo

To allow non-standard locations for `readline` (e.g. with MacOS Homebrew)
one should use `# distutils: include_dirs = ` etc in `sage/libs/readline.pxd` to make it look in non-standard locations.

`readline/spkg-configure.m4` should set up appropriate variables
to be filled in and exported in `src/bin/sage-env-config.in`; in turn
they should make it into `cython_aliases` in `sage/env.py`.


---

Comment by @mwageringel created at 2020-01-16 21:32:29

Also note that several packages seem to link against the macOS readline instead of the Homebrew one. In fact, the only one I am sure links against the Homebrew readline is rpy2. What would be needed to solve this? The Homebrew version provides a pkg-config file, in case that is useful.

I am hesitant to permanently install Homebrew's readline to `/usr/local` as this is against what is intended by Homebrew. In the case of readline though, I am not sure how much of a problem this really is.


---

Comment by dimpase created at 2020-01-16 22:52:39

GAP needs a "real" readline, not a MacOS's libedit.

IIRC, sagelib's readline also needs "real" readline.

I did try installing Homebrew's readline into /usr/local, it seems to cause no harm, and
allowed builds to work on MacOS 10.13.


---

Comment by @mwageringel created at 2020-01-17 18:07:54

Replying to [comment:2 dimpase]:
> GAP needs a "real" readline, not a MacOS's libedit.

This might explain why I currently see several persistent doctest timeouts with this setup. Giac seems to be affected, as well. I am a bit surprised the build does not fail with this incompatible readline (other than for `sage.libs.readline`).


---

Comment by mkoeppe created at 2020-03-21 00:08:11

Thanks for adding the link to the problem description.

What is happening here is that you are relying on an automake feature that our build system (unfortunately) does not have.

It is true that one can set variables by passing them to `configure`, and they will be respected during the `configure` run and remembered in `config.status`. However, in our build system they are not saved in any configure-generated output file:

```
$ ./configure LDFLAGS="-L/xyzzy1" CPPFLAGS="-I/xyzzy2" PKG_CONFIG_PATH="/xyzzy3"
$ grep xyzzy build/make/Makefile-auto build/make/Makefile src/Makefile src/bin/sage-env-config build/bin/sage-build-env-config build/pkgs/sage_conf/src/sage_conf.py build/pkgs/sage_conf/src/setup.cfg
```

... except in the automake-generated file `build/make/Makefile-auto`, which is not used at all in our build process.

```
build/make/Makefile-auto:CPPFLAGS =  -I/xyzzy2
build/make/Makefile-auto:LDFLAGS = -L/xyzzy1
build/make/Makefile-auto:PKG_CONFIG_PATH = /xyzzy3
```



---

Comment by @mwageringel created at 2020-03-21 18:36:57

Thank you for explaining this. This clears up a lot. I think I will avoid the keg-only packages for now.


---

Comment by mkoeppe created at 2020-04-02 23:35:59

Also PARI's `spkg-install.in` hardcodes readline to come from `SAGE_LOCAL`

```
bash ./Configure --prefix="$SAGE_LOCAL" \
    --with-readline="$SAGE_LOCAL" $SAGE_CONFIGURE_GMP \
    --with-runtime-perl="/usr/bin/env perl" \
    --kernel=gmp $PARI_CONFIGURE 
```

which is not correct when `readline/spkg-configure.m4` found a system readline.

On `local-homebrew-macos-standard` (#29417), this leads to:

```
Hi-Res Graphics: none
###
### Editline wrapper detected, building without readline support
###
### Building without GNU readline support
```



---

Comment by dimpase created at 2020-04-03 02:53:00

I believe these are missing for packages for which readline is not a dependency (but a feature). On the other hand, perhaps it can potentially pollute the compiling/linking calls.

Let's fix it...


---

Comment by mkoeppe created at 2020-04-15 14:34:58

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2020-04-25 01:19:24

Another case: 
- #29572 Fix perl_term_readline_gnu build error on conda-forge-macos-maximal


---

Comment by dimpase created at 2020-04-25 04:15:09

It appears this will need `AX_ABSOLUTE_HEADER`, as we use for GMP/MPIR - I don't see another way around. :-(


---

Comment by mkoeppe created at 2020-04-25 05:01:53

Then it has to be.


---

Comment by dimpase created at 2020-04-25 05:19:39

underlinking of libreadline needs to be tested in readline's spkg-configure. And the name of the library has to be found from `ac_cv_search_wresize` set by `AC_SEARCH_LIBS` in ncurses' spkg-configure, or the result of `pkg-config --libs ncurses` (more precisely, the autoconf equivalent of the latter).


---

Comment by isuruf created at 2020-04-25 06:18:45

Or we should make sure `CFLAGS` and `LDFLAGS` are respected by all the spkgs


---

Comment by mkoeppe created at 2020-04-26 03:49:20

How's this coming along?


---

Comment by dimpase created at 2020-04-26 06:28:44

hope to fix today (SG time)


---

Comment by mkoeppe created at 2020-04-27 23:37:51

Anything I can help?


---

Comment by dimpase created at 2020-04-28 00:42:57

feel free to take over - I won't have much time for it in the coming 48 hours.
The branch I pushed is only a start.
----
New commits:


---

Comment by mkoeppe created at 2020-04-28 04:28:16

Hm, not tonight


---

Comment by mkoeppe created at 2020-05-01 03:49:26

Changing priority from blocker to critical.


---

Comment by dimpase created at 2020-05-01 08:49:03

I think slackware problem (#29573) is a different one - it ships an underlinked readline (and does not provide .pc file for readline, to make everything harder than needed).


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by dimpase created at 2021-07-05 09:00:54

should we proceed with this - in view of recent readline changes?


---

Comment by mkoeppe created at 2021-07-05 17:24:38

The issue in the ticket description is indeed no longer relevant after #32073, so let's close this.

There are still issues with readline in other packages, as mentioned in #29000#comment:7 above, but it does not help to keep the ticket open.


---

Comment by mkoeppe created at 2021-07-05 17:24:38

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-07-05 18:04:57

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-07-05 18:04:57

OK


---

Comment by mkoeppe created at 2021-08-26 02:08:43

Resolution: invalid
