# Issue 28763: make libs/readline know where headers/libs are

archive/issues_028763.json:
```json
{
    "body": "CC:  @dimpase @dcoudert @isuruf @orlitzky\n\nTo allow non-standard locations for `readline` (e.g. with MacOS Homebrew)\none should use `# distutils: include_dirs = ` etc in `sage/libs/readline.pxd` to make it look in non-standard locations.\n\n`readline/spkg-configure.m4` should set up appropriate variables\nto be filled in and exported in `src/bin/sage-env-config.in`; in turn\nthey should make it into `cython_aliases` in `sage/env.py`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29000\n\n",
    "created_at": "2020-01-13T10:37:44Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "make libs/readline know where headers/libs are",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28763",
    "user": "https://github.com/dimpase"
}
```
CC:  @dimpase @dcoudert @isuruf @orlitzky

To allow non-standard locations for `readline` (e.g. with MacOS Homebrew)
one should use `# distutils: include_dirs = ` etc in `sage/libs/readline.pxd` to make it look in non-standard locations.

`readline/spkg-configure.m4` should set up appropriate variables
to be filled in and exported in `src/bin/sage-env-config.in`; in turn
they should make it into `cython_aliases` in `sage/env.py`.

Issue created by migration from https://trac.sagemath.org/ticket/29000





---

archive/issue_comments_405729.json:
```json
{
    "body": "Also note that several packages seem to link against the macOS readline instead of the Homebrew one. In fact, the only one I am sure links against the Homebrew readline is rpy2. What would be needed to solve this? The Homebrew version provides a pkg-config file, in case that is useful.\n\nI am hesitant to permanently install Homebrew's readline to `/usr/local` as this is against what is intended by Homebrew. In the case of readline though, I am not sure how much of a problem this really is.",
    "created_at": "2020-01-16T21:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405729",
    "user": "https://github.com/mwageringel"
}
```

Also note that several packages seem to link against the macOS readline instead of the Homebrew one. In fact, the only one I am sure links against the Homebrew readline is rpy2. What would be needed to solve this? The Homebrew version provides a pkg-config file, in case that is useful.

I am hesitant to permanently install Homebrew's readline to `/usr/local` as this is against what is intended by Homebrew. In the case of readline though, I am not sure how much of a problem this really is.



---

archive/issue_comments_405730.json:
```json
{
    "body": "GAP needs a \"real\" readline, not a MacOS's libedit.\n\nIIRC, sagelib's readline also needs \"real\" readline.\n\nI did try installing Homebrew's readline into /usr/local, it seems to cause no harm, and\nallowed builds to work on MacOS 10.13.",
    "created_at": "2020-01-16T22:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405730",
    "user": "https://github.com/dimpase"
}
```

GAP needs a "real" readline, not a MacOS's libedit.

IIRC, sagelib's readline also needs "real" readline.

I did try installing Homebrew's readline into /usr/local, it seems to cause no harm, and
allowed builds to work on MacOS 10.13.



---

archive/issue_comments_405731.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> GAP needs a \"real\" readline, not a MacOS's libedit.\n\nThis might explain why I currently see several persistent doctest timeouts with this setup. Giac seems to be affected, as well. I am a bit surprised the build does not fail with this incompatible readline (other than for `sage.libs.readline`).",
    "created_at": "2020-01-17T18:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405731",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:2 dimpase]:
> GAP needs a "real" readline, not a MacOS's libedit.

This might explain why I currently see several persistent doctest timeouts with this setup. Giac seems to be affected, as well. I am a bit surprised the build does not fail with this incompatible readline (other than for `sage.libs.readline`).



---

archive/issue_comments_405732.json:
```json
{
    "body": "Thanks for adding the link to the problem description.\n\nWhat is happening here is that you are relying on an automake feature that our build system (unfortunately) does not have.\n\nIt is true that one can set variables by passing them to `configure`, and they will be respected during the `configure` run and remembered in `config.status`. However, in our build system they are not saved in any configure-generated output file:\n\n```\n$ ./configure LDFLAGS=\"-L/xyzzy1\" CPPFLAGS=\"-I/xyzzy2\" PKG_CONFIG_PATH=\"/xyzzy3\"\n$ grep xyzzy build/make/Makefile-auto build/make/Makefile src/Makefile src/bin/sage-env-config build/bin/sage-build-env-config build/pkgs/sage_conf/src/sage_conf.py build/pkgs/sage_conf/src/setup.cfg\n```\n\n... except in the automake-generated file `build/make/Makefile-auto`, which is not used at all in our build process.\n\n```\nbuild/make/Makefile-auto:CPPFLAGS =  -I/xyzzy2\nbuild/make/Makefile-auto:LDFLAGS = -L/xyzzy1\nbuild/make/Makefile-auto:PKG_CONFIG_PATH = /xyzzy3\n```\n",
    "created_at": "2020-03-21T00:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405732",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for adding the link to the problem description.

What is happening here is that you are relying on an automake feature that our build system (unfortunately) does not have.

It is true that one can set variables by passing them to `configure`, and they will be respected during the `configure` run and remembered in `config.status`. However, in our build system they are not saved in any configure-generated output file:

```
$ ./configure LDFLAGS="-L/xyzzy1" CPPFLAGS="-I/xyzzy2" PKG_CONFIG_PATH="/xyzzy3"
$ grep xyzzy build/make/Makefile-auto build/make/Makefile src/Makefile src/bin/sage-env-config build/bin/sage-build-env-config build/pkgs/sage_conf/src/sage_conf.py build/pkgs/sage_conf/src/setup.cfg
```

... except in the automake-generated file `build/make/Makefile-auto`, which is not used at all in our build process.

```
build/make/Makefile-auto:CPPFLAGS =  -I/xyzzy2
build/make/Makefile-auto:LDFLAGS = -L/xyzzy1
build/make/Makefile-auto:PKG_CONFIG_PATH = /xyzzy3
```




---

archive/issue_comments_405733.json:
```json
{
    "body": "Thank you for explaining this. This clears up a lot. I think I will avoid the keg-only packages for now.",
    "created_at": "2020-03-21T18:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405733",
    "user": "https://github.com/mwageringel"
}
```

Thank you for explaining this. This clears up a lot. I think I will avoid the keg-only packages for now.



---

archive/issue_comments_405734.json:
```json
{
    "body": "Also PARI's `spkg-install.in` hardcodes readline to come from `SAGE_LOCAL`\n\n```\nbash ./Configure --prefix=\"$SAGE_LOCAL\" \\\n    --with-readline=\"$SAGE_LOCAL\" $SAGE_CONFIGURE_GMP \\\n    --with-runtime-perl=\"/usr/bin/env perl\" \\\n    --kernel=gmp $PARI_CONFIGURE \n```\n\nwhich is not correct when `readline/spkg-configure.m4` found a system readline.\n\nOn `local-homebrew-macos-standard` (#29417), this leads to:\n\n```\nHi-Res Graphics: none\n###\n### Editline wrapper detected, building without readline support\n###\n### Building without GNU readline support\n```\n",
    "created_at": "2020-04-02T23:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405734",
    "user": "https://github.com/mkoeppe"
}
```

Also PARI's `spkg-install.in` hardcodes readline to come from `SAGE_LOCAL`

```
bash ./Configure --prefix="$SAGE_LOCAL" \
    --with-readline="$SAGE_LOCAL" $SAGE_CONFIGURE_GMP \
    --with-runtime-perl="/usr/bin/env perl" \
    --kernel=gmp $PARI_CONFIGURE 
```

which is not correct when `readline/spkg-configure.m4` found a system readline.

On `local-homebrew-macos-standard` (#29417), this leads to:

```
Hi-Res Graphics: none
###
### Editline wrapper detected, building without readline support
###
### Building without GNU readline support
```




---

archive/issue_comments_405735.json:
```json
{
    "body": "I believe these are missing for packages for which readline is not a dependency (but a feature). On the other hand, perhaps it can potentially pollute the compiling/linking calls.\n\nLet's fix it...",
    "created_at": "2020-04-03T02:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405735",
    "user": "https://github.com/dimpase"
}
```

I believe these are missing for packages for which readline is not a dependency (but a feature). On the other hand, perhaps it can potentially pollute the compiling/linking calls.

Let's fix it...



---

archive/issue_comments_405736.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-04-15T14:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405736",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_405737.json:
```json
{
    "body": "Another case: \n- #29572 Fix perl_term_readline_gnu build error on conda-forge-macos-maximal",
    "created_at": "2020-04-25T01:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405737",
    "user": "https://github.com/mkoeppe"
}
```

Another case: 
- #29572 Fix perl_term_readline_gnu build error on conda-forge-macos-maximal



---

archive/issue_comments_405738.json:
```json
{
    "body": "It appears this will need `AX_ABSOLUTE_HEADER`, as we use for GMP/MPIR - I don't see another way around. :-(",
    "created_at": "2020-04-25T04:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405738",
    "user": "https://github.com/dimpase"
}
```

It appears this will need `AX_ABSOLUTE_HEADER`, as we use for GMP/MPIR - I don't see another way around. :-(



---

archive/issue_comments_405739.json:
```json
{
    "body": "Then it has to be.",
    "created_at": "2020-04-25T05:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405739",
    "user": "https://github.com/mkoeppe"
}
```

Then it has to be.



---

archive/issue_comments_405740.json:
```json
{
    "body": "underlinking of libreadline needs to be tested in readline's spkg-configure. And the name of the library has to be found from `ac_cv_search_wresize` set by `AC_SEARCH_LIBS` in ncurses' spkg-configure, or the result of `pkg-config --libs ncurses` (more precisely, the autoconf equivalent of the latter).",
    "created_at": "2020-04-25T05:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405740",
    "user": "https://github.com/dimpase"
}
```

underlinking of libreadline needs to be tested in readline's spkg-configure. And the name of the library has to be found from `ac_cv_search_wresize` set by `AC_SEARCH_LIBS` in ncurses' spkg-configure, or the result of `pkg-config --libs ncurses` (more precisely, the autoconf equivalent of the latter).



---

archive/issue_comments_405741.json:
```json
{
    "body": "Or we should make sure `CFLAGS` and `LDFLAGS` are respected by all the spkgs",
    "created_at": "2020-04-25T06:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405741",
    "user": "https://github.com/isuruf"
}
```

Or we should make sure `CFLAGS` and `LDFLAGS` are respected by all the spkgs



---

archive/issue_comments_405742.json:
```json
{
    "body": "How's this coming along?",
    "created_at": "2020-04-26T03:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405742",
    "user": "https://github.com/mkoeppe"
}
```

How's this coming along?



---

archive/issue_comments_405743.json:
```json
{
    "body": "hope to fix today (SG time)",
    "created_at": "2020-04-26T06:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405743",
    "user": "https://github.com/dimpase"
}
```

hope to fix today (SG time)



---

archive/issue_comments_405744.json:
```json
{
    "body": "Anything I can help?",
    "created_at": "2020-04-27T23:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405744",
    "user": "https://github.com/mkoeppe"
}
```

Anything I can help?



---

archive/issue_comments_405745.json:
```json
{
    "body": "feel free to take over - I won't have much time for it in the coming 48 hours.\nThe branch I pushed is only a start.\n----\nNew commits:",
    "created_at": "2020-04-28T00:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405745",
    "user": "https://github.com/dimpase"
}
```

feel free to take over - I won't have much time for it in the coming 48 hours.
The branch I pushed is only a start.
----
New commits:



---

archive/issue_comments_405746.json:
```json
{
    "body": "Hm, not tonight",
    "created_at": "2020-04-28T04:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405746",
    "user": "https://github.com/mkoeppe"
}
```

Hm, not tonight



---

archive/issue_comments_405747.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2020-05-01T03:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405747",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_405748.json:
```json
{
    "body": "I think slackware problem (#29573) is a different one - it ships an underlinked readline (and does not provide .pc file for readline, to make everything harder than needed).",
    "created_at": "2020-05-01T08:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405748",
    "user": "https://github.com/dimpase"
}
```

I think slackware problem (#29573) is a different one - it ships an underlinked readline (and does not provide .pc file for readline, to make everything harder than needed).



---

archive/issue_comments_405749.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405749",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_405750.json:
```json
{
    "body": "should we proceed with this - in view of recent readline changes?",
    "created_at": "2021-07-05T09:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405750",
    "user": "https://github.com/dimpase"
}
```

should we proceed with this - in view of recent readline changes?



---

archive/issue_comments_405751.json:
```json
{
    "body": "The issue in the ticket description is indeed no longer relevant after #32073, so let's close this.\n\nThere are still issues with readline in other packages, as mentioned in #29000#comment:7 above, but it does not help to keep the ticket open.",
    "created_at": "2021-07-05T17:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405751",
    "user": "https://github.com/mkoeppe"
}
```

The issue in the ticket description is indeed no longer relevant after #32073, so let's close this.

There are still issues with readline in other packages, as mentioned in #29000#comment:7 above, but it does not help to keep the ticket open.



---

archive/issue_comments_405752.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-05T17:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405752",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405753.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-05T18:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405753",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405754.json:
```json
{
    "body": "OK",
    "created_at": "2021-07-05T18:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405754",
    "user": "https://github.com/dimpase"
}
```

OK



---

archive/issue_comments_405755.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-08-26T02:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28763#issuecomment-405755",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid
