# Issue 13783: Combinatorial m-ary trees

Issue created by migration from https://trac.sagemath.org/ticket/13987

Original creator: VivianePons

Original creation time: 2013-01-22 16:46:59

Assignee: sage-combinat

CC:  hivert sage-combinat tscrim darij

Keywords: trees

Just as in #8703 we want to implement trees with a fixed number of subtrees (equivalent of binary trees but with m subtrees). Especially to use them in the context of the m-Tamari lattices. 

This ticket depends on #8703 as we use the implantation of RootedTrees


---

Comment by VivianePons created at 2013-01-22 17:15:08

Changing assignee from sage-combinat to VivianePons.


---

Comment by VivianePons created at 2013-11-07 17:46:48

New commits:


---

Comment by git created at 2014-05-11 07:51:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-09 14:31:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-08 07:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-11-25 16:29:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-01 09:48:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-03-01 09:49:24

I am going to set this to **needs_review**. I hope that somebody else is still interested.


---

Comment by chapoton created at 2017-03-01 09:49:24

Changing status from new to needs_review.


---

Comment by git created at 2017-03-10 17:07:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-03 20:27:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-04-04 19:06:12

ok, green bot at last. Now one can start looking at the code..


---

Comment by git created at 2017-06-02 07:47:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-25 07:06:11

Green bot, please review.


---

Comment by darij created at 2017-07-25 08:39:45

Are these trees plane?


---

Comment by chapoton created at 2017-07-25 08:42:16

yes, these are the rooted trees where every vertex has a list of m sons.


---

Comment by git created at 2017-11-21 04:08:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2017-11-21 04:09:12

Is my doc correct? (In particular, am I right in assuming that leaves can carry no labels?)


---

Comment by chapoton created at 2017-11-21 07:24:19

yes.

some remarks:

* you can see the trees using `%display unicode_art`

* there is a doctest still using binary trees

* maybe the import of BinaryTrees is not needed


---

Comment by git created at 2017-11-21 21:16:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2017-11-21 21:18:23

Thanks. I've fixed the doctest. I don't know why the import of BinaryTrees wouldn't be needed. A good point can be made for conversions between `MaryTree(2, ...)` and `BinaryTree(...)`, but this can wait for another ticket.

Now to review the rest of this...


---

Comment by darij created at 2017-11-21 21:20:46

Unicode Art doesn't seem to work:

```
sage: t = MAryTree(2, [[], []])
sage: t
[[., .], [., .]]
sage: %display unicode_art
sage: t
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-4-b7269fa25085> in <module>()
----> 1 t

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    244             self.start_displayhook()
    245             self.write_output_prompt()
--> 246             format_dict, md_dict = self.compute_format_data(result)
    247             self.update_user_ns(result)
    248             self.fill_exec_result(result)

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)
    148 
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     # This can be set to True by the write_output_prompt method in a subclass

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/repl/display/formatter.pyc in format(self, obj, include, exclude)
    200         """
    201         # First, use Sage rich output if there is any
--> 202         sage_format, sage_metadata = self.dm.displayhook(obj)
    203         assert PLAIN_TEXT in sage_format, 'plain text is always present'
    204         if not set(sage_format.keys()).issubset(self.default_mime()):

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in displayhook(self, obj)
    805             return
    806         self._backend.set_underscore_variable(obj)
--> 807         plain_text, rich_output = self._rich_output_formatter(obj, dict())
    808         return self._backend.displayhook(plain_text, rich_output)
    809 

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in _rich_output_formatter(self, obj, rich_repr_kwds)
    631         if rich_output is None:
    632             rich_output = self._preferred_text_formatter(
--> 633                 obj, plain_text=plain_text, **rich_repr_kwds)
    634         # promote output container types to backend-specific containers
    635         plain_text = self._promote_output(plain_text)

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in _preferred_text_formatter(self, obj, plain_text, **kwds)
    528             return out
    529         if want == 'unicode_art' and OutputUnicodeArt in supported:
--> 530             out = self._backend.unicode_art_formatter(obj, **kwds)
    531             if type(out) is not OutputUnicodeArt:
    532                 raise OutputTypeException('backend returned wrong output type, require UnicodeArt')

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.pyc in unicode_art_formatter(self, obj, **kwds)
    422             result = unicode_art(*obj, sep=' ')
    423         else:
--> 424             result = unicode_art(obj)
    425         from sage.repl.rich_output.output_basic import OutputUnicodeArt
    426         return OutputUnicodeArt(str(result))

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/typeset/unicode_art.pyc in unicode_art(*obj, **kwds)
    119         raise ValueError('unknown keyword arguments: {0}'.format(list(kwds)))
    120     if len(obj) == 1:
--> 121         return _unicode_art_factory.build(obj[0])
    122     if not isinstance(separator, UnicodeArt):
    123         separator = _unicode_art_factory.build(separator)

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/typeset/character_art_factory.pyc in build(self, obj)
    124                 return self.build_set(obj)
    125         elif isinstance(obj, SageObject):
--> 126             return self.build_from_magic_method(obj)
    127         else:
    128             return self.build_from_string(obj)

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/typeset/character_art_factory.pyc in build_from_magic_method(self, obj)
    156         """
    157         magic_method = getattr(obj, self.magic_method_name)
--> 158         return magic_method()
    159 
    160     def build_from_string(self, obj):

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/combinat/abstract_tree.pyc in _unicode_art_(self)
   1294 
   1295         # General case
-> 1296         l_repr = [subtree._unicode_art_() for subtree in self]
   1297         acc = l_repr.pop(0)
   1298         whitesep = acc._root

/home/dgrinber/sage-7.5.1/local/lib/python2.7/site-packages/sage/combinat/abstract_tree.pyc in _unicode_art_(self)
   1296         l_repr = [subtree._unicode_art_() for subtree in self]
   1297         acc = l_repr.pop(0)
-> 1298         whitesep = acc._root
   1299         lf_sep = u" " * whitesep + u"╭" + u"─" * (acc._l - acc._root)
   1300         ls_sep = u" " * whitesep + u"│" + u" " * (acc._l - acc._root)

AttributeError: 'UnicodeArt' object has no attribute '_root'
```


Not sure if this is much of an issue, though.


---

Comment by git created at 2017-11-22 04:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2017-11-22 04:30:15

(2) Not sure why this behavior:

```
sage: MAryTree(4, 4)
[., ., ., .]
sage: MAryTree(4, 3)
[., ., ., .]
sage: MAryTree(4, 2)
[., ., ., .]
sage: MAryTree(4, 1)
[., ., ., .]
```

What is the purpose of the numerical second parameter if it makes no difference?

(3) Is it intentional that `check` only checks the "outer layer", i.e., the list of the direct children of the root?


---

Comment by git created at 2017-11-22 05:58:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2017-11-22 05:58:53

I've reviewed the mathematics and documentation. Now we need someone to check the OOP, specifically the methods with the following names:

```
__classcall_private__
_auto_parent
__init__
__call__
_element_constructor_
_parent_for_
element_class
```

and someone to fix the issues in comment:29 and comment:31.


---

Comment by git created at 2017-11-22 09:03:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-11-22 09:04:32

I have fixed the ascii and unicode art.

Also enhanced the "an_element" method for labelled case.


---

Comment by chapoton created at 2017-11-22 09:42:32

> (3) Is it intentional that `check` only checks the "outer layer", i.e., the list of the direct children of the root?

This is exactly the existing behaviour in binary trees. So I guess we can keep that for the moment. The recursive check is handled when creating a tree, I think.

```
sage: from sage.combinat.abstract_tree import from_hexacode
sage: M = MAryTrees(3)
sage: from_hexacode('300200', M)
...
TypeError: This is not a 3-ary tree
```



---

Comment by tscrim created at 2017-11-22 10:27:25

Some comments:

- I think it would be good to do a `TestSuite` on something like `MAryTree(3, [])` as an extra security check in the `MAryTree.__init__`.
- Do we want this MRO: `class MAryTrees_all(DisjointUnionEnumeratedSets, MAryTrees)`? If it is the other way -- `class MAryTrees_all(MAryTrees, DisjointUnionEnumeratedSets)` -- then I think we can remove the `__call__`. Even without changing the order, do we need it to go up the `MAryTrees` path?
- Do we want to have 2-ary trees create the corresponding `BinaryTree*` class? This would mean we do not have to convert back and forth.
- Related, do we want to have `BinaryTree*` inherit from its corresponding `MAryTree*` class?
- The `LabelledMAryTrees.__call__` can be removed.
- Lowercase error messages: `"Invalid word"` and `"Wrong number of nodes"`.
- There is a non-standard `.. note::` block.
- We should also specify in the `MAryTree` class-level doc that m-ary trees are plane/ordered trees.

I can make these changes tomorrow (tonight I am feeling a little lazy `^^;;`).


---

Comment by git created at 2017-11-22 11:57:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-11-22 11:58:35

I did some of the simple suggested changes.

I would rather not have any inheritance between BinaryTrees and MAryTrees. Conversion is enough.


---

Comment by darij created at 2017-11-22 18:30:51

OK, what about point (2)?

And I'm fine with no inheritance; it's enough that the constructor is working.


---

Comment by tscrim created at 2017-11-22 22:30:06

Replying to [comment:40 chapoton]:
> I did some of the simple suggested changes.

Thank you.

> I would rather not have any inheritance between BinaryTrees and MAryTrees. Conversion is enough.

Why not? It doesn't make sense to me both mathematically and programmatically. I can understand you wanting to postpone it for a later ticket (although I think change it really quickly), but I don't understand the opposition to having inheritance (and the constructors returning the `BinaryTree*` object when `m = 2`). Am I missing something about the structures of these classes?


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by chapoton created at 2019-07-24 11:23:30

I have made a fresh new branch with a single commit, as the previous one was polluted by many merge commits.
----
New commits:


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by git created at 2020-07-15 06:54:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-16 13:45:13

What's the status of the review on this ticket?


---

Comment by @darijgr created at 2020-08-17 08:46:12

I don't remember more than is said in the comments above, and I'm not going to have time for this in the foreseeable time... sorry, not very useful I know.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by kdilks created at 2021-07-27 14:33:01

I'd like to try and help get this finished, though I'm not sure I'm qualified to be final judge and jury on the OOP/MRO aspects. At the very least, I can implement Travis's suggestion of removing ```LabelledMAryTrees.__call__``` , and try to reverse the order of inheritance for ```class MAryTrees_all(DisjointUnionEnumeratedSets, MAryTrees)``` and remove the ```__call__`` and make sure nothing breaks.

In terms of m=2, people seem fine with having conversion for now, and having inheritance be part of a later ticket to get this finished.

I can implement Travis's suggestion that the documentation being clearer about these being ordered/plane trees.

In terms of ```check``` only checking the outer layer, I'm pretty sure this should be fine, and it will recursively check the entire tree. But I can try and make a test case to be sure.

I'll make a thorough pass in the next day or two to test things out, check doc and examples for clarity to somebody that may not be as familiar with m-ary trees, and make sure the doc compiles properly. One thing that's more a note to self to fix later when I do this is that enumerated m-ary trees of a given size is still labeled as 'enumerated set of binary trees of a given size' in the code.

Also reminder to self to check (1) as part of comment:37.


---

Comment by kdilks created at 2021-07-29 02:35:25

In terms of ```class MAryTrees_all(DisjointUnionEnumeratedSets, MAryTrees)```versus ```class MAryTrees_all(MAryTrees, DisjointUnionEnumeratedSets)``` , the way it is now matches what is done in binary trees. 

I can't manage to track down exactly what's happening, but as the doc indicates, the ```__call__``` methods are necessary to make sure that empty input is treated as ```None``` instead of getting passed as ```0```. Maybe something inherited from ```OrderedTrees``` and their assumption that there are no empty trees (and thus ```OrderedTrees()() == OrderedTrees()([])```? Switching the MRO above did not resolve the issue. 

This fix/hack is also implemented in ```BinaryTrees```, though only for ```BinaryTrees_all```. So ```BinaryTrees()() == BinaryTrees()(None) == .```, but in ``BinaryTrees_size``, ```BinaryTrees(0)()``` gives an error about the int 0 not being callable, whereas ```BinaryTrees(0)(None) == ```.

I would be of the opinion that if the way things done here is the way they've been forever in ```BinaryTrees```, then they shouldn't be holding back this ticket from getting a positive review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
