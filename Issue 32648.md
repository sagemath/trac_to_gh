# Issue 32648: 9 internet doctests failing in tests/cmdling.py - AttributeError: can't set attribute

Issue created by migration from https://trac.sagemath.org/ticket/32885

Original creator: slabbe

Original creation time: 2021-11-16 15:15:38

On Ubuntu 18.04 with 9.5.beta6, the command

```
$ sage -t --optional=sage,internet src/sage/tests/cmdline.py
```

gives

```
Using --optional=internet,sage
Doctesting 1 file.
sage -t --random-seed=105243642370010920973837514024932877446 src/sage/tests/cmdline.py
 src/sage/interfaces/fricas.py**********************************************************************
File "src/sage/tests/cmdline.py", line 596, in sage.tests.cmdline.test_executable
Failed example:
    out.find("cython") >= 0  # optional - internet
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 598, in sage.tests.cmdline.test_executable
Failed example:
    err  # optional - internet
Expected:
    ''
Got:
    'Traceback (most recent call last):\n  File "/home/slabbe/GitBox/sage/src/bin/sage-list-packages", line 102, in <module>\n    pkg.installed_version = pkg.installed_version or \'not_installed\'\nAttributeError: can\'t set attribute\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 600, in sage.tests.cmdline.test_executable
Failed example:
    ret  # optional - internet
Expected:
    0
Got:
    1
**********************************************************************
File "src/sage/tests/cmdline.py", line 604, in sage.tests.cmdline.test_executable
Failed example:
    out.find("database_cremona_ellcurve") >= 0  # optional - internet
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 606, in sage.tests.cmdline.test_executable
Failed example:
    err  # optional - internet
Expected:
    ''
Got:
    '/home/slabbe/GitBox/sage/local/lib/python3.9/site-packages/sage/misc/package.py:117: UserWarning: failed to fetch the version of pkg=\'ore_algebra\' at https://pypi.org/pypi/ore_algebra/json\n  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, url))\nTraceback (most recent call last):\n  File "/home/slabbe/GitBox/sage/src/bin/sage-list-packages", line 102, in <module>\n    pkg.installed_version = pkg.installed_version or \'not_installed\'\nAttributeError: can\'t set attribute\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 608, in sage.tests.cmdline.test_executable
Failed example:
    ret  # optional - internet
Expected:
    0
Got:
    1
**********************************************************************
File "src/sage/tests/cmdline.py", line 612, in sage.tests.cmdline.test_executable
Failed example:
    out.find("valgrind") >= 0  # optional - internet
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 614, in sage.tests.cmdline.test_executable
Failed example:
    err  # optional - internet
Expected:
    ''
Got:
    'Traceback (most recent call last):\n  File "/home/slabbe/GitBox/sage/src/bin/sage-list-packages", line 102, in <module>\n    pkg.installed_version = pkg.installed_version or \'not_installed\'\nAttributeError: can\'t set attribute\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 616, in sage.tests.cmdline.test_executable
Failed example:
    ret  # optional - internet
Expected:
    0
Got:
    1
**********************************************************************
1 item had failures:
   9 of 219 in sage.tests.cmdline.test_executable
    [218 tests, 9 failures, 36.22 s]
----------------------------------------------------------------------
sage -t --random-seed=105243642370010920973837514024932877446 src/sage/tests/cmdline.py  # 9 doctests failed
----------------------------------------------------------------------
```



---

Comment by jhpalmieri created at 2021-11-16 21:17:48

Something like this?

```diff
diff --git a/src/bin/sage-list-packages b/src/bin/sage-list-packages
index 813b1c0d64..93e3438b11 100755
--- a/src/bin/sage-list-packages
+++ b/src/bin/sage-list-packages
@@ -99,8 +99,10 @@ L.sort(key=lambda pkg: pkg.name)
 
 # print (while getting rid of None in versions)
 for pkg in L:
-    pkg.installed_version = pkg.installed_version or 'not_installed'
-    pkg.remote_version = pkg.remote_version or '?'
-    print(format_string.format(**pkg._asdict()))
+    d = {}
+    d['name'] = pkg.name
+    d['installed_version'] = pkg.installed_version or 'not_installed'
+    d['remote_version'] = pkg.remote_version or '?'
+    print(format_string.format(**d))
 if WARN:
     print(WARN)
```



---

Comment by jhpalmieri created at 2021-11-16 21:21:50

Or

```diff
diff --git a/src/bin/sage-list-packages b/src/bin/sage-list-packages
index 813b1c0d64..16a6a4ab18 100755
--- a/src/bin/sage-list-packages
+++ b/src/bin/sage-list-packages
@@ -99,8 +99,8 @@ L.sort(key=lambda pkg: pkg.name)
 
 # print (while getting rid of None in versions)
 for pkg in L:
-    pkg.installed_version = pkg.installed_version or 'not_installed'
-    pkg.remote_version = pkg.remote_version or '?'
+    pkg = pkg._replace(installed_version = pkg.installed_version or 'not_installed',
+                       remote_version = pkg.remote_version or '?')
     print(format_string.format(**pkg._asdict()))
 if WARN:
     print(WARN)
```



---

Comment by jhpalmieri created at 2021-11-16 23:11:54

Regardless, I still get an error with `./sage -t --optional=sage,internet src/sage/tests/cmdline.py`:

```
sage -t --random-seed=49741205059645622454424668273577198155 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 606, in sage.tests.cmdline.test_executable
Failed example:
    err  # optional - internet
Expected:
    ''
Got:
    '/Users/palmieri/Desktop/Sage/git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/package.py:117: UserWarning: failed to fetch the version of pkg=\'ore_algebra\' at https://pypi.org/pypi/ore_algebra/json\n  warnings.warn("failed to fetch the version of pkg={!r} at {}".format(pkg, url))\n'
**********************************************************************
1 item had failures:
   1 of 219 in sage.tests.cmdline.test_executable
    [218 tests, 1 failure, 47.78 s]
```

The `ore_algebra` package looks like it's missing from pypi.


---

Comment by slabbe created at 2021-11-17 14:10:56

The `ore_algebra` issue is dealt at #31475


---

Comment by jhpalmieri created at 2021-11-17 19:50:14

Here's a branch; it also adds spaces in some deprecation messages (to print "the functions standard_packages, optional_packages, experimental_packages are deprecated" instead of "... experimental_packagesare deprecated").
----
New commits:


---

Comment by jhpalmieri created at 2021-11-17 19:50:14

Changing priority from major to critical.


---

Comment by jhpalmieri created at 2021-11-17 19:50:14

Changing status from new to needs_review.


---

Comment by slabbe created at 2021-11-17 20:12:12

It works on my side. I wait for the patchbot status to change the status to positive review.


---

Comment by slabbe created at 2021-11-18 11:25:10

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-11-18 16:55:35

Thanks!


---

Comment by vbraun created at 2021-12-05 11:15:39

Resolution: fixed
