# Issue 11141: Animated GIF plots should repaint bgcolor after each frame

archive/issues_011141.json:
```json
{
    "body": "Assignee: jason, was\n\nKeywords: plot, animate, imagemagick\n\nAs title. ImageMagick should be called with `-dispose Background`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11313\n\n",
    "created_at": "2011-05-08T11:51:05Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "title": "Animated GIF plots should repaint bgcolor after each frame",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11141",
    "user": "kini"
}
```
Assignee: jason, was

Keywords: plot, animate, imagemagick

As title. ImageMagick should be called with `-dispose Background`.

Issue created by migration from https://trac.sagemath.org/ticket/11313





---

archive/issue_comments_122004.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-05-08T11:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122004",
    "user": "kini"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_122005.json:
```json
{
    "body": "Any ideas on how to doctest this? Doesn't really seem possible, on first glance anyway...",
    "created_at": "2011-05-08T11:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122005",
    "user": "kini"
}
```

Any ideas on how to doctest this? Doesn't really seem possible, on first glance anyway...



---

archive/issue_comments_122006.json:
```json
{
    "body": "Does this slow anything down?  `animate` is already on the slow side...",
    "created_at": "2011-06-23T03:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122006",
    "user": "kcrisman"
}
```

Does this slow anything down?  `animate` is already on the slow side...



---

archive/issue_comments_122007.json:
```json
{
    "body": "This is a defect, not an enhancement, ticket, so I don't consider potential slowdown to be a problem with the patch. That aside, ImageMagick is written in C and is pretty fast. If `animate` is slow it's probably because Sage needs to create every frame separately before using ImageMagick to put them together. I doubt this patch introduces any slowdowns.\n\nTo elaborate on what makes this a defect: when you create an animation, Sage first creates a bunch of frames, then uses ImageMagick to make an animated GIF out of them. If the frames are not all the same size, then ImageMagick determines the minimum size for the final GIF in which it is possible to accommodate all the frames. The default behavior is to simply draw frame `n` over frame `n-1` without erasing frame `n-1`. When frame `n`'s image is smaller than frame `n-1`'s image, however, you get garbage in frame 'n' outside the borders of the original image used to create frame 'n'.",
    "created_at": "2011-06-23T05:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122007",
    "user": "kini"
}
```

This is a defect, not an enhancement, ticket, so I don't consider potential slowdown to be a problem with the patch. That aside, ImageMagick is written in C and is pretty fast. If `animate` is slow it's probably because Sage needs to create every frame separately before using ImageMagick to put them together. I doubt this patch introduces any slowdowns.

To elaborate on what makes this a defect: when you create an animation, Sage first creates a bunch of frames, then uses ImageMagick to make an animated GIF out of them. If the frames are not all the same size, then ImageMagick determines the minimum size for the final GIF in which it is possible to accommodate all the frames. The default behavior is to simply draw frame `n` over frame `n-1` without erasing frame `n-1`. When frame `n`'s image is smaller than frame `n-1`'s image, however, you get garbage in frame 'n' outside the borders of the original image used to create frame 'n'.



---

archive/issue_comments_122008.json:
```json
{
    "body": "Sorry about the spam...",
    "created_at": "2011-06-23T21:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122008",
    "user": "kini"
}
```

Sorry about the spam...



---

archive/issue_comments_122009.json:
```json
{
    "body": "Can you provide code which illustrates the problem (before the patch) and its solution (after)?",
    "created_at": "2011-07-23T17:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122009",
    "user": "jhpalmieri"
}
```

Can you provide code which illustrates the problem (before the patch) and its solution (after)?



---

archive/issue_comments_122010.json:
```json
{
    "body": "Hmm, I've lost track of the code which demonstrated this problem (the code was originally posted on a pastebin by a user on IRC in May). While I wait for a response to the message I sent that user, here's an image showing what animate() currently does with that code:\n\n![](http://i.imgur.com/ppmZ8.gif)",
    "created_at": "2011-07-24T23:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122010",
    "user": "kini"
}
```

Hmm, I've lost track of the code which demonstrated this problem (the code was originally posted on a pastebin by a user on IRC in May). While I wait for a response to the message I sent that user, here's an image showing what animate() currently does with that code:

![](http://i.imgur.com/ppmZ8.gif)



---

archive/issue_comments_122011.json:
```json
{
    "body": "Here we are:\n\n\n```python\nt = var('t')\n\ndef frame(theta):\n    r = 2\n    x = r*(t - sin(t))\n    y = r*(1 - cos(t))\n\n    plot = parametric_plot((x, y), (t,0,theta), rgbcolor=hue(0.6))\n    krug = circle((2*theta, r), r)\n    tocka = point((r*(theta - sin(theta)), r*(1 - cos(theta))), pointsize=30, color='red')\n    return plot+krug+tocka;\n\nanimacija = animate([frame(x) for x in srange(0.1, 5*pi, 0.1)])\n\nanimacija.show(delay=10, iterations=0)\n```\n\n\nCredit to user `v-v` on freenode. This produces the image shown above on Sage 4.7 (for example on sagenb.org). My local alpha2 (old, I know...) does something kind of alarming... I'll test with the latest dev version once I get it built.",
    "created_at": "2011-07-25T17:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122011",
    "user": "kini"
}
```

Here we are:


```python
t = var('t')

def frame(theta):
    r = 2
    x = r*(t - sin(t))
    y = r*(1 - cos(t))

    plot = parametric_plot((x, y), (t,0,theta), rgbcolor=hue(0.6))
    krug = circle((2*theta, r), r)
    tocka = point((r*(theta - sin(theta)), r*(1 - cos(theta))), pointsize=30, color='red')
    return plot+krug+tocka;

animacija = animate([frame(x) for x in srange(0.1, 5*pi, 0.1)])

animacija.show(delay=10, iterations=0)
```


Credit to user `v-v` on freenode. This produces the image shown above on Sage 4.7 (for example on sagenb.org). My local alpha2 (old, I know...) does something kind of alarming... I'll test with the latest dev version once I get it built.



---

archive/issue_comments_122012.json:
```json
{
    "body": "Minor point: the patch doesn't apply cleanly to Sage 4.7.1.rc0, but that's easy to fix.  More importantly, with Safari 5.1 on a Mac, the area which is no longer part of the picture displays as a black box.  On Firefox or Chrome, it's white (or maybe the default background color?), but it looks bad on Safari.  I don't know if this is a bug in how Safari displays animated gifs or if we can avoid it somehow.",
    "created_at": "2011-07-25T18:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122012",
    "user": "jhpalmieri"
}
```

Minor point: the patch doesn't apply cleanly to Sage 4.7.1.rc0, but that's easy to fix.  More importantly, with Safari 5.1 on a Mac, the area which is no longer part of the picture displays as a black box.  On Firefox or Chrome, it's white (or maybe the default background color?), but it looks bad on Safari.  I don't know if this is a bug in how Safari displays animated gifs or if we can avoid it somehow.



---

archive/issue_comments_122013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-07-25T18:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122013",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_122014.json:
```json
{
    "body": "The \"something kind of alarming\" appears to be caused by #11170 - the GIF blows up in filesize by a factor of 50 and the aspect ratio is destroyed. I'll cross-post to that ticket...\n\nAs for Safari, no idea. I'll look into it.",
    "created_at": "2011-08-04T07:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122014",
    "user": "kini"
}
```

The "something kind of alarming" appears to be caused by #11170 - the GIF blows up in filesize by a factor of 50 and the aspect ratio is destroyed. I'll cross-post to that ticket...

As for Safari, no idea. I'll look into it.



---

archive/issue_comments_122015.json:
```json
{
    "body": "I'm going to rebase this on #11650 / 4.8.alpha1 .\n\nRegarding Safari's behavior, I found [this](https://bugs.webkit.org/show_bug.cgi?id=15990), which links to some internal Apple bug tracker which I cannot access. Can we assume this is Safari's problem?",
    "created_at": "2011-11-18T05:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122015",
    "user": "kini"
}
```

I'm going to rebase this on #11650 / 4.8.alpha1 .

Regarding Safari's behavior, I found [this](https://bugs.webkit.org/show_bug.cgi?id=15990), which links to some internal Apple bug tracker which I cannot access. Can we assume this is Safari's problem?



---

archive/issue_comments_122016.json:
```json
{
    "body": "Now that #11650 is in, here's a rebase on sage 4.8.alpha6.\n\nHow the above GIF looks after the patch:\n\n![](http://i.imgur.com/DpjS2.gif)\n\nOn [the imgur page](http://imgur.com/DpjS2) you can see how the GIF's transparency and non-white backgrounds interact. Compare with [the old behavior](http://imgur.com/ppmZ8).",
    "created_at": "2012-01-13T16:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122016",
    "user": "kini"
}
```

Now that #11650 is in, here's a rebase on sage 4.8.alpha6.

How the above GIF looks after the patch:

![](http://i.imgur.com/DpjS2.gif)

On [the imgur page](http://imgur.com/DpjS2) you can see how the GIF's transparency and non-white backgrounds interact. Compare with [the old behavior](http://imgur.com/ppmZ8).



---

archive/issue_comments_122017.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-13T16:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122017",
    "user": "kini"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_122018.json:
```json
{
    "body": "Whoops, the \"before\" image is a bit different now in sage 4.8.alpha6 than it was when I posted [comment:9]. See the description for the updated GIF.",
    "created_at": "2012-01-13T16:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122018",
    "user": "kini"
}
```

Whoops, the "before" image is a bit different now in sage 4.8.alpha6 than it was when I posted [comment:9]. See the description for the updated GIF.



---

archive/issue_comments_122019.json:
```json
{
    "body": "This looks good to me.  By the way, where is this syntax for defining strings\n\n```python\ns = ('abc' 'def')\n```\n\ndocumented?",
    "created_at": "2012-01-13T22:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122019",
    "user": "jhpalmieri"
}
```

This looks good to me.  By the way, where is this syntax for defining strings

```python
s = ('abc' 'def')
```

documented?



---

archive/issue_comments_122020.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-13T22:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122020",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_122021.json:
```json
{
    "body": "[Here](http://docs.python.org/reference/lexical_analysis.html#string-literal-concatenation) is the relevant section of the Python docs. Actually,\n\n\n```python\ns = 'abc' 'def'\n```\n\n\nworks too, but the parentheses in the patch force a line continuation.\n\nThanks for the review!",
    "created_at": "2012-01-13T22:35:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122021",
    "user": "kini"
}
```

[Here](http://docs.python.org/reference/lexical_analysis.html#string-literal-concatenation) is the relevant section of the Python docs. Actually,


```python
s = 'abc' 'def'
```


works too, but the parentheses in the patch force a line continuation.

Thanks for the review!



---

archive/issue_comments_122022.json:
```json
{
    "body": "apply to $SAGE_ROOT/devel/sage",
    "created_at": "2012-01-16T20:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122022",
    "user": "jdemeyer"
}
```

apply to $SAGE_ROOT/devel/sage



---

archive/issue_comments_122023.json:
```json
{
    "body": "Attachment\n\nChanged commit message.",
    "created_at": "2012-01-16T20:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122023",
    "user": "jdemeyer"
}
```

Attachment

Changed commit message.



---

archive/issue_comments_122024.json:
```json
{
    "body": "Wait, what? So now we're *not* putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.",
    "created_at": "2012-01-17T05:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122024",
    "user": "kini"
}
```

Wait, what? So now we're *not* putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.



---

archive/issue_comments_122025.json:
```json
{
    "body": "Replying to [comment:19 kini]:\n> Wait, what? So now we're *not* putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.\n\nFunny how in the beginning when I was release manager, I had to convince everybody to put ticket numbers in the commit message and quite a few didn't do it (or worse: put the wrong ticket number).  Since sage-4.7, the ticket numbers are added automatically but it seems that now, more people than before are actually adding the ticket number.",
    "created_at": "2012-01-17T07:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122025",
    "user": "jdemeyer"
}
```

Replying to [comment:19 kini]:
> Wait, what? So now we're *not* putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.

Funny how in the beginning when I was release manager, I had to convince everybody to put ticket numbers in the commit message and quite a few didn't do it (or worse: put the wrong ticket number).  Since sage-4.7, the ticket numbers are added automatically but it seems that now, more people than before are actually adding the ticket number.



---

archive/issue_comments_122026.json:
```json
{
    "body": "Of course, the best way would be to have people make commits to the tree, and then close the ticket with a reference to the commit, rather than making the commit upon release, when the ticket has been closed already. But for that I guess we need to implement the github-based sage --push/pull workflow Robert Bradshaw suggested, or something similar.\n\nBy the way, why not just check whether the ticket number is already in the commit message and not add it again if so?",
    "created_at": "2012-01-17T10:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122026",
    "user": "kini"
}
```

Of course, the best way would be to have people make commits to the tree, and then close the ticket with a reference to the commit, rather than making the commit upon release, when the ticket has been closed already. But for that I guess we need to implement the github-based sage --push/pull workflow Robert Bradshaw suggested, or something similar.

By the way, why not just check whether the ticket number is already in the commit message and not add it again if so?



---

archive/issue_comments_122027.json:
```json
{
    "body": "Replying to [comment:21 kini]:\n> By the way, why not just check whether the ticket number is already in the commit message and not add it again if so?\n\nWhen this was discussed on sage-devel (please don't ask me to find the thread again), somebody suggested that having a uniform format\n\n```\nTrac #54321: change foo to bar\n```\n\ncould be useful for scripts.  I would find a version of \"hg blame\" with ticket numbers quite interesting.  If somebody would implement this, then the standard-format ticket numbers would certainly be useful.",
    "created_at": "2012-01-17T11:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122027",
    "user": "jdemeyer"
}
```

Replying to [comment:21 kini]:
> By the way, why not just check whether the ticket number is already in the commit message and not add it again if so?

When this was discussed on sage-devel (please don't ask me to find the thread again), somebody suggested that having a uniform format

```
Trac #54321: change foo to bar
```

could be useful for scripts.  I would find a version of "hg blame" with ticket numbers quite interesting.  If somebody would implement this, then the standard-format ticket numbers would certainly be useful.



---

archive/issue_comments_122028.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-18T08:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11141#issuecomment-122028",
    "user": "jdemeyer"
}
```

Resolution: fixed
