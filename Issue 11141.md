# Issue 11141: Animated GIF plots should repaint bgcolor after each frame

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2011-05-08 11:51:05

Assignee: jason, was

Keywords: plot, animate, imagemagick

As title. ImageMagick should be called with `-dispose Background`.


---

Comment by kini created at 2011-05-08 11:59:51

Changing status from new to needs_review.


---

Comment by kini created at 2011-05-08 11:59:51

Any ideas on how to doctest this? Doesn't really seem possible, on first glance anyway...


---

Comment by kcrisman created at 2011-06-23 03:40:15

Does this slow anything down?  `animate` is already on the slow side...


---

Comment by kini created at 2011-06-23 05:01:01

This is a defect, not an enhancement, ticket, so I don't consider potential slowdown to be a problem with the patch. That aside, ImageMagick is written in C and is pretty fast. If `animate` is slow it's probably because Sage needs to create every frame separately before using ImageMagick to put them together. I doubt this patch introduces any slowdowns.

To elaborate on what makes this a defect: when you create an animation, Sage first creates a bunch of frames, then uses ImageMagick to make an animated GIF out of them. If the frames are not all the same size, then ImageMagick determines the minimum size for the final GIF in which it is possible to accommodate all the frames. The default behavior is to simply draw frame `n` over frame `n-1` without erasing frame `n-1`. When frame `n`'s image is smaller than frame `n-1`'s image, however, you get garbage in frame 'n' outside the borders of the original image used to create frame 'n'.


---

Comment by kini created at 2011-06-23 21:59:41

Sorry about the spam...


---

Comment by jhpalmieri created at 2011-07-23 17:09:05

Can you provide code which illustrates the problem (before the patch) and its solution (after)?


---

Comment by kini created at 2011-07-24 23:59:33

Hmm, I've lost track of the code which demonstrated this problem (the code was originally posted on a pastebin by a user on IRC in May). While I wait for a response to the message I sent that user, here's an image showing what animate() currently does with that code:

![](http://i.imgur.com/ppmZ8.gif)


---

Comment by kini created at 2011-07-25 17:25:02

Here we are:


```python
t = var('t')

def frame(theta):
    r = 2
    x = r*(t - sin(t))
    y = r*(1 - cos(t))

    plot = parametric_plot((x, y), (t,0,theta), rgbcolor=hue(0.6))
    krug = circle((2*theta, r), r)
    tocka = point((r*(theta - sin(theta)), r*(1 - cos(theta))), pointsize=30, color='red')
    return plot+krug+tocka;

animacija = animate([frame(x) for x in srange(0.1, 5*pi, 0.1)])

animacija.show(delay=10, iterations=0)
```


Credit to user `v-v` on freenode. This produces the image shown above on Sage 4.7 (for example on sagenb.org). My local alpha2 (old, I know...) does something kind of alarming... I'll test with the latest dev version once I get it built.


---

Comment by jhpalmieri created at 2011-07-25 18:32:43

Minor point: the patch doesn't apply cleanly to Sage 4.7.1.rc0, but that's easy to fix.  More importantly, with Safari 5.1 on a Mac, the area which is no longer part of the picture displays as a black box.  On Firefox or Chrome, it's white (or maybe the default background color?), but it looks bad on Safari.  I don't know if this is a bug in how Safari displays animated gifs or if we can avoid it somehow.


---

Comment by jhpalmieri created at 2011-07-25 18:32:43

Changing status from needs_review to needs_work.


---

Comment by kini created at 2011-08-04 07:42:45

The "something kind of alarming" appears to be caused by #11170 - the GIF blows up in filesize by a factor of 50 and the aspect ratio is destroyed. I'll cross-post to that ticket...

As for Safari, no idea. I'll look into it.


---

Comment by kini created at 2011-11-18 05:43:45

I'm going to rebase this on #11650 / 4.8.alpha1 .

Regarding Safari's behavior, I found [this](https://bugs.webkit.org/show_bug.cgi?id=15990), which links to some internal Apple bug tracker which I cannot access. Can we assume this is Safari's problem?


---

Comment by kini created at 2012-01-13 16:40:26

Now that #11650 is in, here's a rebase on sage 4.8.alpha6.

How the above GIF looks after the patch:

![](http://i.imgur.com/DpjS2.gif)

On [the imgur page](http://imgur.com/DpjS2) you can see how the GIF's transparency and non-white backgrounds interact. Compare with [the old behavior](http://imgur.com/ppmZ8).


---

Comment by kini created at 2012-01-13 16:52:15

Changing status from needs_work to needs_review.


---

Comment by kini created at 2012-01-13 16:52:15

Whoops, the "before" image is a bit different now in sage 4.8.alpha6 than it was when I posted [comment:9]. See the description for the updated GIF.


---

Comment by jhpalmieri created at 2012-01-13 22:17:42

This looks good to me.  By the way, where is this syntax for defining strings

```python
s = ('abc' 'def')
```

documented?


---

Comment by jhpalmieri created at 2012-01-13 22:17:42

Changing status from needs_review to positive_review.


---

Comment by kini created at 2012-01-13 22:35:26

[Here](http://docs.python.org/reference/lexical_analysis.html#string-literal-concatenation) is the relevant section of the Python docs. Actually,


```python
s = 'abc' 'def'
```


works too, but the parentheses in the patch force a line continuation.

Thanks for the review!


---

Comment by jdemeyer created at 2012-01-16 20:26:22

apply to $SAGE_ROOT/devel/sage


---

Attachment

Changed commit message.


---

Comment by kini created at 2012-01-17 05:03:33

Wait, what? So now we're _not_ putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.


---

Comment by jdemeyer created at 2012-01-17 07:41:37

Replying to [comment:19 kini]:
> Wait, what? So now we're _not_ putting the trac ticket number in the commit message? Hmm, I didn't realize that. Thanks for the heads up.

Funny how in the beginning when I was release manager, I had to convince everybody to put ticket numbers in the commit message and quite a few didn't do it (or worse: put the wrong ticket number).  Since sage-4.7, the ticket numbers are added automatically but it seems that now, more people than before are actually adding the ticket number.


---

Comment by kini created at 2012-01-17 10:47:50

Of course, the best way would be to have people make commits to the tree, and then close the ticket with a reference to the commit, rather than making the commit upon release, when the ticket has been closed already. But for that I guess we need to implement the github-based sage --push/pull workflow Robert Bradshaw suggested, or something similar.

By the way, why not just check whether the ticket number is already in the commit message and not add it again if so?


---

Comment by jdemeyer created at 2012-01-17 11:05:41

Replying to [comment:21 kini]:
> By the way, why not just check whether the ticket number is already in the commit message and not add it again if so?

When this was discussed on sage-devel (please don't ask me to find the thread again), somebody suggested that having a uniform format

```
Trac #54321: change foo to bar
```

could be useful for scripts.  I would find a version of "hg blame" with ticket numbers quite interesting.  If somebody would implement this, then the standard-format ticket numbers would certainly be useful.


---

Comment by jdemeyer created at 2012-01-18 08:14:04

Resolution: fixed
