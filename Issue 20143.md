# Issue 20143: Patch to MPFR to get it building on Cygwin again

archive/issues_020143.json:
```json
{
    "body": "CC:  @tscrim gouezel jpflori @zimmermann6\n\nKeywords: windows cygwin\n\nThe attached adds a patch to mpfr required for it to build successfully on Cygwin (no other guarantees beyond that it builds).  I have tested that this resolves the problem.  The original discussion where this came up is here: https://groups.google.com/d/msg/sage-devel/c6mj0MxEovI/zl_7H7-fDgAJ\n\nI'm not sure if this has been reported upstream yet, but I will check.  The patch came from:\nhttps://github.com/Alexpux/MSYS2-packages/blob/master/mpfr/mpfr-3.1.4-1.src.patch\n\nIssue created by migration from https://trac.sagemath.org/ticket/20380\n\n",
    "created_at": "2016-04-07T11:03:55Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Patch to MPFR to get it building on Cygwin again",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20143",
    "user": "@embray"
}
```
CC:  @tscrim gouezel jpflori @zimmermann6

Keywords: windows cygwin

The attached adds a patch to mpfr required for it to build successfully on Cygwin (no other guarantees beyond that it builds).  I have tested that this resolves the problem.  The original discussion where this came up is here: https://groups.google.com/d/msg/sage-devel/c6mj0MxEovI/zl_7H7-fDgAJ

I'm not sure if this has been reported upstream yet, but I will check.  The patch came from:
https://github.com/Alexpux/MSYS2-packages/blob/master/mpfr/mpfr-3.1.4-1.src.patch

Issue created by migration from https://trac.sagemath.org/ticket/20380





---

archive/issue_comments_277500.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-07T12:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277500",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_277501.json:
```json
{
    "body": "Changing keywords from \"windows cygwin\" to \"windows cygwin days77\".",
    "created_at": "2016-04-07T17:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277501",
    "user": "@slel"
}
```

Changing keywords from "windows cygwin" to "windows cygwin days77".



---

archive/issue_comments_277502.json:
```json
{
    "body": "Please add your name in the Author field.",
    "created_at": "2016-04-07T18:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277502",
    "user": "@videlec"
}
```

Please add your name in the Author field.



---

archive/issue_comments_277503.json:
```json
{
    "body": "(should be your full name, I just changed it)",
    "created_at": "2016-04-07T19:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277503",
    "user": "@videlec"
}
```

(should be your full name, I just changed it)



---

archive/issue_comments_277504.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-08T13:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277504",
    "user": "gouezel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_277505.json:
```json
{
    "body": "Looks good to me. It would be nice if this were integrated in upstream directly.",
    "created_at": "2016-04-08T13:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277505",
    "user": "gouezel"
}
```

Looks good to me. It would be nice if this were integrated in upstream directly.



---

archive/issue_comments_277506.json:
```json
{
    "body": "`@`Paul: could you integrate this into MPFR?\nWe also have Andreas with us so we can talk to him.",
    "created_at": "2016-04-08T13:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277506",
    "user": "jpflori"
}
```

`@`Paul: could you integrate this into MPFR?
We also have Andreas with us so we can talk to him.



---

archive/issue_comments_277507.json:
```json
{
    "body": "I've applied the (slightly different) following patch upstream:\n\n```\n--- src/mpfr-impl.h     (revision 10254)\n+++ src/mpfr-impl.h     (working copy)\n@@ -209,18 +209,18 @@\n #endif\n \n /* Detect some possible inconsistencies under Unix. */\n-#if defined(__unix__)\n-# if defined(_WIN32)\n-#  error \"Both __unix__ and _WIN32 are defined\"\n-# endif\n-# if __GMP_LIBGMP_DLL\n-#  error \"__unix__ is defined and __GMP_LIBGMP_DLL is true\"\n-# endif\n-# if defined(MPFR_WIN_THREAD_SAFE_DLL)\n-#  error \"Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined\"\n-# endif\n+#if defined(__unix__) && defined(_WIN32)\n+# error \"Both __unix__ and _WIN32 are defined\"\n #endif\n\n+#if defined(__unix__) && __GMP_LIBGMP_DLL && !defined(__CYGWIN__)\n+# error \"__unix__ is defined and __GMP_LIBGMP_DLL is true\"\n+#endif\n+\n+#if defined(__unix__) && defined(MPFR_WIN_THREAD_SAFE_DLL)\n+# error \"Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined\"\n+#endif\n+\n #if defined(__MPFR_WITHIN_MPFR) || !defined(MPFR_WIN_THREAD_SAFE_DLL)\n extern MPFR_THREAD_ATTR mpfr_flags_t __gmpfr_flags;\n extern MPFR_THREAD_ATTR mpfr_exp_t   __gmpfr_emin;\n```\n\nPlease tell me if it works.\nPaul",
    "created_at": "2016-04-08T14:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277507",
    "user": "@zimmermann6"
}
```

I've applied the (slightly different) following patch upstream:

```
--- src/mpfr-impl.h     (revision 10254)
+++ src/mpfr-impl.h     (working copy)
@@ -209,18 +209,18 @@
 #endif
 
 /* Detect some possible inconsistencies under Unix. */
-#if defined(__unix__)
-# if defined(_WIN32)
-#  error "Both __unix__ and _WIN32 are defined"
-# endif
-# if __GMP_LIBGMP_DLL
-#  error "__unix__ is defined and __GMP_LIBGMP_DLL is true"
-# endif
-# if defined(MPFR_WIN_THREAD_SAFE_DLL)
-#  error "Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined"
-# endif
+#if defined(__unix__) && defined(_WIN32)
+# error "Both __unix__ and _WIN32 are defined"
 #endif

+#if defined(__unix__) && __GMP_LIBGMP_DLL && !defined(__CYGWIN__)
+# error "__unix__ is defined and __GMP_LIBGMP_DLL is true"
+#endif
+
+#if defined(__unix__) && defined(MPFR_WIN_THREAD_SAFE_DLL)
+# error "Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined"
+#endif
+
 #if defined(__MPFR_WITHIN_MPFR) || !defined(MPFR_WIN_THREAD_SAFE_DLL)
 extern MPFR_THREAD_ATTR mpfr_flags_t __gmpfr_flags;
 extern MPFR_THREAD_ATTR mpfr_exp_t   __gmpfr_emin;
```

Please tell me if it works.
Paul



---

archive/issue_comments_277508.json:
```json
{
    "body": "I'll revert the above patch upstream since we (the MPFR developers) are not sure this is the best way to solve the problem. We are looking to this problem.",
    "created_at": "2016-04-08T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277508",
    "user": "@zimmermann6"
}
```

I'll revert the above patch upstream since we (the MPFR developers) are not sure this is the best way to solve the problem. We are looking to this problem.



---

archive/issue_comments_277509.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-08T22:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277509",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_277510.json:
```json
{
    "body": "note that upstream we decided to remove completely the paragraph `Detect some possible inconsistencies under Unix`.\nPaul",
    "created_at": "2016-04-09T08:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277510",
    "user": "@zimmermann6"
}
```

note that upstream we decided to remove completely the paragraph `Detect some possible inconsistencies under Unix`.
Paul



---

archive/issue_comments_277511.json:
```json
{
    "body": "I'm a little confused as to the outcome of this.  zimmerma proposed a slight different patch above, but then suggested that it's no longer needed?\n\nWhy was this ticket closed? Even if the issue has been fixed (somehow--it's not clear) upstream that doesn't mean it's fixed in Sage. A patch is still needed for now in Sage in order for it to build on Cygwin.",
    "created_at": "2016-04-11T12:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277511",
    "user": "@embray"
}
```

I'm a little confused as to the outcome of this.  zimmerma proposed a slight different patch above, but then suggested that it's no longer needed?

Why was this ticket closed? Even if the issue has been fixed (somehow--it's not clear) upstream that doesn't mean it's fixed in Sage. A patch is still needed for now in Sage in order for it to build on Cygwin.



---

archive/issue_comments_277512.json:
```json
{
    "body": "What happened here is as follow:\n* this ticket proposed to integrate the Cygwin-folk patch, was positively reviewed and integrated to Sage git version (that's more or less what closed mean).\n* in the meantime Paul was CC'ed to be aware of the need of a patch to build on Cygwin and ended up with a different solution.\n\nSo I think the next steps would be:\n* check that upstream patch works well,\n* open a new ticket to replace the Cygwin patch we currently ship by the upstream patch.\n\nIt may have been cleaner to wait for upstream decision to positively review this ticket, but the situation we are in now is still better than before: MPFR builds on Cygwin (and should still after replacing our/Cygwin patch with the upstream one).",
    "created_at": "2016-04-11T12:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277512",
    "user": "jpflori"
}
```

What happened here is as follow:
* this ticket proposed to integrate the Cygwin-folk patch, was positively reviewed and integrated to Sage git version (that's more or less what closed mean).
* in the meantime Paul was CC'ed to be aware of the need of a patch to build on Cygwin and ended up with a different solution.

So I think the next steps would be:
* check that upstream patch works well,
* open a new ticket to replace the Cygwin patch we currently ship by the upstream patch.

It may have been cleaner to wait for upstream decision to positively review this ticket, but the situation we are in now is still better than before: MPFR builds on Cygwin (and should still after replacing our/Cygwin patch with the upstream one).



---

archive/issue_comments_277513.json:
```json
{
    "body": "jpflori,\n\nThanks for the overview.  What you wrote more or less matches my understanding, but where I was confused was that it wasn't obvious that my patch was merged into the main branch.  I guess that was was going on [here](http://trac.sagemath.org/ticket/20380#comment:12) where it reads \"Branch changed from u/embray/mpfr-cygwin-patch to 76cb01574b70f6df2cb2b427bb57272f7c4605c8\"?",
    "created_at": "2016-04-11T13:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277513",
    "user": "@embray"
}
```

jpflori,

Thanks for the overview.  What you wrote more or less matches my understanding, but where I was confused was that it wasn't obvious that my patch was merged into the main branch.  I guess that was was going on [here](http://trac.sagemath.org/ticket/20380#comment:12) where it reads "Branch changed from u/embray/mpfr-cygwin-patch to 76cb01574b70f6df2cb2b427bb57272f7c4605c8"?



---

archive/issue_comments_277514.json:
```json
{
    "body": "FWIW the upstream patch in question is here: https://gforge.inria.fr/scm/viewvc.php/mpfr/trunk/src/mpfr-impl.h?r1=10257&r2=10260\n\nIt looks like it should work since it ended up removing the problem code entirely.  But I will still test and open a new ticket.",
    "created_at": "2016-04-11T13:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277514",
    "user": "@embray"
}
```

FWIW the upstream patch in question is here: https://gforge.inria.fr/scm/viewvc.php/mpfr/trunk/src/mpfr-impl.h?r1=10257&r2=10260

It looks like it should work since it ended up removing the problem code entirely.  But I will still test and open a new ticket.



---

archive/issue_comments_277515.json:
```json
{
    "body": "Okay, so it looks like my original patch wasn't merged after all...",
    "created_at": "2016-04-11T14:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277515",
    "user": "@embray"
}
```

Okay, so it looks like my original patch wasn't merged after all...



---

archive/issue_comments_277516.json:
```json
{
    "body": "Followup in #20423",
    "created_at": "2016-04-11T14:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20143#issuecomment-277516",
    "user": "@embray"
}
```

Followup in #20423
