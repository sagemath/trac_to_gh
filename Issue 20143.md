# Issue 20143: Patch to MPFR to get it building on Cygwin again

Issue created by migration from https://trac.sagemath.org/ticket/20380

Original creator: embray

Original creation time: 2016-04-07 11:03:55

CC:  tscrim gouezel jpflori zimmerma

Keywords: windows cygwin

The attached adds a patch to mpfr required for it to build successfully on Cygwin (no other guarantees beyond that it builds).  I have tested that this resolves the problem.  The original discussion where this came up is here: https://groups.google.com/d/msg/sage-devel/c6mj0MxEovI/zl_7H7-fDgAJ

I'm not sure if this has been reported upstream yet, but I will check.  The patch came from:
https://github.com/Alexpux/MSYS2-packages/blob/master/mpfr/mpfr-3.1.4-1.src.patch


---

Comment by embray created at 2016-04-07 12:59:03

Changing status from new to needs_review.


---

Comment by slelievre created at 2016-04-07 17:33:00

Changing keywords from "windows cygwin" to "windows cygwin days77".


---

Comment by vdelecroix created at 2016-04-07 18:49:36

Please add your name in the Author field.


---

Comment by vdelecroix created at 2016-04-07 19:00:44

(should be your full name, I just changed it)


---

Comment by gouezel created at 2016-04-08 13:31:09

Changing status from needs_review to positive_review.


---

Comment by gouezel created at 2016-04-08 13:31:09

Looks good to me. It would be nice if this were integrated in upstream directly.


---

Comment by jpflori created at 2016-04-08 13:54:56

`@`Paul: could you integrate this into MPFR?
We also have Andreas with us so we can talk to him.


---

Comment by zimmerma created at 2016-04-08 14:15:11

I've applied the (slightly different) following patch upstream:

```
--- src/mpfr-impl.h     (revision 10254)
+++ src/mpfr-impl.h     (working copy)
@@ -209,18 +209,18 @@
 #endif
 
 /* Detect some possible inconsistencies under Unix. */
-#if defined(__unix__)
-# if defined(_WIN32)
-#  error "Both __unix__ and _WIN32 are defined"
-# endif
-# if __GMP_LIBGMP_DLL
-#  error "__unix__ is defined and __GMP_LIBGMP_DLL is true"
-# endif
-# if defined(MPFR_WIN_THREAD_SAFE_DLL)
-#  error "Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined"
-# endif
+#if defined(__unix__) && defined(_WIN32)
+# error "Both __unix__ and _WIN32 are defined"
 #endif

+#if defined(__unix__) && __GMP_LIBGMP_DLL && !defined(__CYGWIN__)
+# error "__unix__ is defined and __GMP_LIBGMP_DLL is true"
+#endif
+
+#if defined(__unix__) && defined(MPFR_WIN_THREAD_SAFE_DLL)
+# error "Both __unix__ and MPFR_WIN_THREAD_SAFE_DLL are defined"
+#endif
+
 #if defined(__MPFR_WITHIN_MPFR) || !defined(MPFR_WIN_THREAD_SAFE_DLL)
 extern MPFR_THREAD_ATTR mpfr_flags_t __gmpfr_flags;
 extern MPFR_THREAD_ATTR mpfr_exp_t   __gmpfr_emin;
```

Please tell me if it works.
Paul


---

Comment by zimmerma created at 2016-04-08 15:50:52

I'll revert the above patch upstream since we (the MPFR developers) are not sure this is the best way to solve the problem. We are looking to this problem.


---

Comment by vbraun created at 2016-04-08 22:40:16

Resolution: fixed


---

Comment by zimmerma created at 2016-04-09 08:30:43

note that upstream we decided to remove completely the paragraph `Detect some possible inconsistencies under Unix`.
Paul


---

Comment by embray created at 2016-04-11 12:18:59

I'm a little confused as to the outcome of this.  zimmerma proposed a slight different patch above, but then suggested that it's no longer needed?

Why was this ticket closed? Even if the issue has been fixed (somehow--it's not clear) upstream that doesn't mean it's fixed in Sage. A patch is still needed for now in Sage in order for it to build on Cygwin.


---

Comment by jpflori created at 2016-04-11 12:27:27

What happened here is as follow:
* this ticket proposed to integrate the Cygwin-folk patch, was positively reviewed and integrated to Sage git version (that's more or less what closed mean).
* in the meantime Paul was CC'ed to be aware of the need of a patch to build on Cygwin and ended up with a different solution.

So I think the next steps would be:
* check that upstream patch works well,
* open a new ticket to replace the Cygwin patch we currently ship by the upstream patch.

It may have been cleaner to wait for upstream decision to positively review this ticket, but the situation we are in now is still better than before: MPFR builds on Cygwin (and should still after replacing our/Cygwin patch with the upstream one).


---

Comment by embray created at 2016-04-11 13:03:13

jpflori,

Thanks for the overview.  What you wrote more or less matches my understanding, but where I was confused was that it wasn't obvious that my patch was merged into the main branch.  I guess that was was going on [here](http://trac.sagemath.org/ticket/20380#comment:12) where it reads "Branch changed from u/embray/mpfr-cygwin-patch to 76cb01574b70f6df2cb2b427bb57272f7c4605c8"?


---

Comment by embray created at 2016-04-11 13:06:08

FWIW the upstream patch in question is here: https://gforge.inria.fr/scm/viewvc.php/mpfr/trunk/src/mpfr-impl.h?r1=10257&r2=10260

It looks like it should work since it ended up removing the problem code entirely.  But I will still test and open a new ticket.


---

Comment by embray created at 2016-04-11 14:12:22

Okay, so it looks like my original patch wasn't merged after all...


---

Comment by embray created at 2016-04-11 14:26:21

Followup in #20423
