# Issue 28745: Use CombinatorialPolyhedron to obtain faces lattice of polyhedra

archive/issues_028745.json:
```json
{
    "body": "CC:  @jplab @laisrast\n\nKeywords: polyhedron, face lattice\n\nWe use `CombinatorialPolyhedron` to compute the face lattice of a polyhedron.\n\nAlong the way we implement `hasse_diagram` for `CombinatorialPolyhedron` and `Polyhedron_base`.\n\nInstead of caching `face_lattice`, we cache `hasse_diagram` now.\n\nThis is much slower, but removes a memory leak. As `hasse_diagram` is hardly used with #28646, this seems to be reasonable.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28982\n\n",
    "created_at": "2020-01-10T13:33:53Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Use CombinatorialPolyhedron to obtain faces lattice of polyhedra",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28745",
    "user": "@kliem"
}
```
CC:  @jplab @laisrast

Keywords: polyhedron, face lattice

We use `CombinatorialPolyhedron` to compute the face lattice of a polyhedron.

Along the way we implement `hasse_diagram` for `CombinatorialPolyhedron` and `Polyhedron_base`.

Instead of caching `face_lattice`, we cache `hasse_diagram` now.

This is much slower, but removes a memory leak. As `hasse_diagram` is hardly used with #28646, this seems to be reasonable.

Issue created by migration from https://trac.sagemath.org/ticket/28982





---

archive/issue_comments_405951.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-10T13:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405951",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405952.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-10T13:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405952",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405953.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-14T07:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405953",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405954.json:
```json
{
    "body": "I changed to face lattice not to be set up with linear extension anymore.\n----\nNew commits:",
    "created_at": "2020-02-12T14:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405954",
    "user": "@kliem"
}
```

I changed to face lattice not to be set up with linear extension anymore.
----
New commits:



---

archive/issue_comments_405955.json:
```json
{
    "body": "Few comments:\n\n\n```\n-        Test that face lattice give no memory leak::\n+        Test that computing the face lattice does not lead to a memory leak::\n```\n\n\n\n```\n-        Return the hasse diagram of ``self``.\n+        Return the hasse diagram of the face lattice of ``self``.\n```\n\n\nI will go more in depth soon.\n\nDoes this mean that we can remove the file `hasse_diagram.py`?",
    "created_at": "2020-02-14T11:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405955",
    "user": "@jplab"
}
```

Few comments:


```
-        Test that face lattice give no memory leak::
+        Test that computing the face lattice does not lead to a memory leak::
```



```
-        Return the hasse diagram of ``self``.
+        Return the hasse diagram of the face lattice of ``self``.
```


I will go more in depth soon.

Does this mean that we can remove the file `hasse_diagram.py`?



---

archive/issue_comments_405956.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-02-14T12:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405956",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_405957.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-14T12:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405957",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405958.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405958",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_405959.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-20T09:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405959",
    "user": "@jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405960.json:
```json
{
    "body": "Suggestions:\n\n\n```diff\n+        .. NOTE::\n-            The face lattice is not cached, as long as this would create a memory leak.\n+            The face lattice is not cached, as long as this creates a memory leak, see :trac:`28982`.\n```\n\n\nHasse is a lastname, so you can capitalize it within the documentation.\n\nCould the function below have more information? Like which order is meant to be simulated here? Inclusion or lex on indices of vertices, etc? Just one more sentence to specify might be nice?\n\n\n```diff\n+    def __lt__(self, other):\n+        r\"\"\"\n+        Compare faces of the same polyhedron.\n+\n+        EXAMPLES::\n+\n+            sage: P = polytopes.simplex()\n+            sage: C = CombinatorialPolyhedron(P)\n+            sage: F1 = C.face_by_face_lattice_index(0)\n+            sage: F2 = C.face_by_face_lattice_index(1)\n+            sage: F1 < F2\n+            True\n+        \"\"\"\n+        return hash(self) < hash(other)\n```\n\n\nIs there a reason why the hasse diagram of the combinatorial polyhedron is not cached?",
    "created_at": "2020-04-20T09:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405960",
    "user": "@jplab"
}
```

Suggestions:


```diff
+        .. NOTE::
-            The face lattice is not cached, as long as this would create a memory leak.
+            The face lattice is not cached, as long as this creates a memory leak, see :trac:`28982`.
```


Hasse is a lastname, so you can capitalize it within the documentation.

Could the function below have more information? Like which order is meant to be simulated here? Inclusion or lex on indices of vertices, etc? Just one more sentence to specify might be nice?


```diff
+    def __lt__(self, other):
+        r"""
+        Compare faces of the same polyhedron.
+
+        EXAMPLES::
+
+            sage: P = polytopes.simplex()
+            sage: C = CombinatorialPolyhedron(P)
+            sage: F1 = C.face_by_face_lattice_index(0)
+            sage: F2 = C.face_by_face_lattice_index(1)
+            sage: F1 < F2
+            True
+        """
+        return hash(self) < hash(other)
```


Is there a reason why the hasse diagram of the combinatorial polyhedron is not cached?



---

archive/issue_comments_405961.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-04-20T11:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405961",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_405962.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-20T11:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405962",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405963.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-20T14:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405963",
    "user": "@jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405964.json:
```json
{
    "body": "Great! Thanks for the quick changes. You forgot a capital \"H\" in the last commit. Apart from that it is good to go!\n\nonce you make this last typo change, you can set it to positive review on my behalf.",
    "created_at": "2020-04-20T14:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405964",
    "user": "@jplab"
}
```

Great! Thanks for the quick changes. You forgot a capital "H" in the last commit. Apart from that it is good to go!

once you make this last typo change, you can set it to positive review on my behalf.



---

archive/issue_comments_405965.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-20T14:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405965",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405966.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-04-20T14:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405966",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_405967.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-04-20T14:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405967",
    "user": "@kliem"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_405968.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2020-04-22T22:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405968",
    "user": "@vbraun"
}
```

Merge conflict



---

archive/issue_comments_405969.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-04-22T22:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405969",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_405970.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-24T05:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405970",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405971.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-04-24T05:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405971",
    "user": "@kliem"
}
```

Last 10 new commits:



---

archive/issue_comments_405972.json:
```json
{
    "body": "It doesn't seem to build... See patchbot.",
    "created_at": "2020-04-27T13:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405972",
    "user": "@jplab"
}
```

It doesn't seem to build... See patchbot.



---

archive/issue_comments_405973.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-27T13:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405973",
    "user": "@jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405974.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-27T13:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405974",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405975.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-04-27T13:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405975",
    "user": "@kliem"
}
```

Last 10 new commits:



---

archive/issue_comments_405976.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-11T13:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405976",
    "user": "@jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405977.json:
```json
{
    "body": "Looks good to me now.",
    "created_at": "2020-05-11T13:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405977",
    "user": "@jplab"
}
```

Looks good to me now.



---

archive/issue_comments_405978.json:
```json
{
    "body": "\n```\nsage -t --long --warn-long 36.4 src/sage/geometry/polyhedron/face.py\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 454, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation\nFailed example:\n    face = p.face_lattice()[5]\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[1]>\", line 1, in <module>\n        face = p.face_lattice()[Integer(5)]\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py\", line 5873, in face_lattice\n        return FiniteLatticePoset(self.hasse_diagram())\n      File \"sage/misc/cachefunc.pyx\", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)\n        self.cache = f(self._instance)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py\", line 5901, in hasse_diagram\n        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 21864, in relabel\n        complete_partial_function = complete_partial_function)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 21929, in relabel\n        raise NotImplementedError(\"Non injective relabeling\")\n    NotImplementedError: Non injective relabeling\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 455, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation\nFailed example:\n    face\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[2]>\", line 1, in <module>\n        face\n    NameError: name 'face' is not defined\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 457, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation\nFailed example:\n    face.ambient_Hrepresentation()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[3]>\", line 1, in <module>\n        face.ambient_Hrepresentation()\n    NameError: name 'face' is not defined\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 462, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation\nFailed example:\n    face.n_ambient_Hrepresentation()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[4]>\", line 1, in <module>\n        face.n_ambient_Hrepresentation()\n    NameError: name 'face' is not defined\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 481, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation\nFailed example:\n    face = p.face_lattice()[5]\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[1]>\", line 1, in <module>\n        face = p.face_lattice()[Integer(5)]\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py\", line 5873, in face_lattice\n        return FiniteLatticePoset(self.hasse_diagram())\n      File \"sage/misc/cachefunc.pyx\", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)\n        self.cache = f(self._instance)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py\", line 5901, in hasse_diagram\n        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 21864, in relabel\n        complete_partial_function = complete_partial_function)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 21929, in relabel\n        raise NotImplementedError(\"Non injective relabeling\")\n    NotImplementedError: Non injective relabeling\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 482, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation\nFailed example:\n    face\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[2]>\", line 1, in <module>\n        face\n    NameError: name 'face' is not defined\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 484, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation\nFailed example:\n    face.ambient_Vrepresentation()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[3]>\", line 1, in <module>\n        face.ambient_Vrepresentation()\n    NameError: name 'face' is not defined\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/face.py\", line 486, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation\nFailed example:\n    face.n_ambient_Vrepresentation()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 680, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1104, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[4]>\", line 1, in <module>\n        face.n_ambient_Vrepresentation()\n    NameError: name 'face' is not defined\n**********************************************************************\n2 items had failures:\n   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation\n   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation\n    [119 tests, 8 failures, 0.44 s]\n```\n",
    "created_at": "2020-05-21T17:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405978",
    "user": "@vbraun"
}
```


```
sage -t --long --warn-long 36.4 src/sage/geometry/polyhedron/face.py
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 454, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face = p.face_lattice()[5]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[1]>", line 1, in <module>
        face = p.face_lattice()[Integer(5)]
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5873, in face_lattice
        return FiniteLatticePoset(self.hasse_diagram())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)
        self.cache = f(self._instance)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5901, in hasse_diagram
        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21864, in relabel
        complete_partial_function = complete_partial_function)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21929, in relabel
        raise NotImplementedError("Non injective relabeling")
    NotImplementedError: Non injective relabeling
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 455, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[2]>", line 1, in <module>
        face
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 457, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face.ambient_Hrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[3]>", line 1, in <module>
        face.ambient_Hrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 462, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face.n_ambient_Hrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[4]>", line 1, in <module>
        face.n_ambient_Hrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 481, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face = p.face_lattice()[5]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[1]>", line 1, in <module>
        face = p.face_lattice()[Integer(5)]
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5873, in face_lattice
        return FiniteLatticePoset(self.hasse_diagram())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)
        self.cache = f(self._instance)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5901, in hasse_diagram
        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21864, in relabel
        complete_partial_function = complete_partial_function)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21929, in relabel
        raise NotImplementedError("Non injective relabeling")
    NotImplementedError: Non injective relabeling
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 482, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[2]>", line 1, in <module>
        face
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 484, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face.ambient_Vrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[3]>", line 1, in <module>
        face.ambient_Vrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 486, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face.n_ambient_Vrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[4]>", line 1, in <module>
        face.n_ambient_Vrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
2 items had failures:
   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
    [119 tests, 8 failures, 0.44 s]
```




---

archive/issue_comments_405979.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-05-21T17:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405979",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_405980.json:
```json
{
    "body": "I rebased on top of #29583 (as there is some merge conflict).\n\nI also fixed the error in #28894, which caused the doctest failure. Now this ticket works by itself and on top of #28894. At least the following tests pass on my machine with and without #28894:\n\n\n```\nsage -t --long -p 8 src/doc/en/thematic_tutorials/geometry\nsage -t --long -p 8 src/sage/geometry/polyhedron/\nsage -t --long -p 8 src/sage/plot/\n```\n\n----\nLast 10 new commits:",
    "created_at": "2020-05-25T08:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405980",
    "user": "@kliem"
}
```

I rebased on top of #29583 (as there is some merge conflict).

I also fixed the error in #28894, which caused the doctest failure. Now this ticket works by itself and on top of #28894. At least the following tests pass on my machine with and without #28894:


```
sage -t --long -p 8 src/doc/en/thematic_tutorials/geometry
sage -t --long -p 8 src/sage/geometry/polyhedron/
sage -t --long -p 8 src/sage/plot/
```

----
Last 10 new commits:



---

archive/issue_comments_405981.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-25T08:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405981",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405982.json:
```json
{
    "body": "Needs rebase (build fails).",
    "created_at": "2020-08-13T05:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405982",
    "user": "@kliem"
}
```

Needs rebase (build fails).



---

archive/issue_comments_405983.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-13T05:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405983",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405984.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-13T05:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405984",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_405985.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-13T05:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405985",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405986.json:
```json
{
    "body": "\n```\n+    if polyhedron.dimension() == 0:\n+        # In case of the 0-dimensional polyhedron,\n+        # there is a facets but no inequality.\n+        H_indices = tuple(range(n_equations))\n+\n```\n\nThe comment needs rewording",
    "created_at": "2020-08-27T04:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405986",
    "user": "@mkoeppe"
}
```


```
+    if polyhedron.dimension() == 0:
+        # In case of the 0-dimensional polyhedron,
+        # there is a facets but no inequality.
+        H_indices = tuple(range(n_equations))
+
```

The comment needs rewording



---

archive/issue_comments_405987.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-27T04:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405987",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405988.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-27T05:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405988",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405989.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-27T05:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405989",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_405990.json:
```json
{
    "body": "\n```\n+    def __lt__(self, other):\n+        r\"\"\"\n+        Compare faces of the same polyhedron.\n+\n+        This is a helper function.\n+        In order to construct a Hasse diagram (a digraph) with combinatorial faces,\n+        we must define some order relation that is compatible with the Hasse diagram.\n+\n+        Any order relation compatible with ordering by dimension is suitable.\n+        We us :meth:`__hash__` to define the relation.\n```\n\n\nI don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?",
    "created_at": "2020-08-30T19:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405990",
    "user": "@mkoeppe"
}
```


```
+    def __lt__(self, other):
+        r"""
+        Compare faces of the same polyhedron.
+
+        This is a helper function.
+        In order to construct a Hasse diagram (a digraph) with combinatorial faces,
+        we must define some order relation that is compatible with the Hasse diagram.
+
+        Any order relation compatible with ordering by dimension is suitable.
+        We us :meth:`__hash__` to define the relation.
```


I don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?



---

archive/issue_comments_405991.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-31T07:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405991",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405992.json:
```json
{
    "body": "Replying to [comment:31 mkoeppe]:\n> {{{\n> +    def __lt__(self, other):\n> +        r\"\"\"\n> +        Compare faces of the same polyhedron.\n> +\n> +        This is a helper function.\n> +        In order to construct a Hasse diagram (a digraph) with combinatorial faces,\n> +        we must define some order relation that is compatible with the Hasse diagram.\n> +\n> +        Any order relation compatible with ordering by dimension is suitable.\n> +        We us :meth:`__hash__` to define the relation.\n> }}}\n> \n> I don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?\n\nYou are right.\nI'm surprised it worked that way.\nThe hash function should be consistent now. And `__lt__` returns `None` if the faces are clearly incompatible.\nWhat's nice about this hash function, if I understand it correctly, is that it allows to store faces in sets etc.",
    "created_at": "2020-08-31T07:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405992",
    "user": "@kliem"
}
```

Replying to [comment:31 mkoeppe]:
> {{{
> +    def __lt__(self, other):
> +        r"""
> +        Compare faces of the same polyhedron.
> +
> +        This is a helper function.
> +        In order to construct a Hasse diagram (a digraph) with combinatorial faces,
> +        we must define some order relation that is compatible with the Hasse diagram.
> +
> +        Any order relation compatible with ordering by dimension is suitable.
> +        We us :meth:`__hash__` to define the relation.
> }}}
> 
> I don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?

You are right.
I'm surprised it worked that way.
The hash function should be consistent now. And `__lt__` returns `None` if the faces are clearly incompatible.
What's nice about this hash function, if I understand it correctly, is that it allows to store faces in sets etc.



---

archive/issue_comments_405993.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-31T13:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405993",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405994.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-08-31T13:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405994",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_405995.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-06T21:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28745#issuecomment-405995",
    "user": "@vbraun"
}
```

Resolution: fixed
