# Issue 28745: Use CombinatorialPolyhedron to obtain faces lattice of polyhedra

Issue created by migration from https://trac.sagemath.org/ticket/28982

Original creator: @kliem

Original creation time: 2020-01-10 13:33:53

CC:  jipilab @laisrast

Keywords: polyhedron, face lattice

We use `CombinatorialPolyhedron` to compute the face lattice of a polyhedron.

Along the way we implement `hasse_diagram` for `CombinatorialPolyhedron` and `Polyhedron_base`.

Instead of caching `face_lattice`, we cache `hasse_diagram` now.

This is much slower, but removes a memory leak. As `hasse_diagram` is hardly used with #28646, this seems to be reasonable.


---

Comment by git created at 2020-01-10 13:38:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-01-10 13:38:27

Changing status from new to needs_review.


---

Comment by git created at 2020-01-14 07:40:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-02-12 14:53:48

I changed to face lattice not to be set up with linear extension anymore.
----
New commits:


---

Comment by jipilab created at 2020-02-14 11:07:27

Few comments:


```
-        Test that face lattice give no memory leak::
+        Test that computing the face lattice does not lead to a memory leak::
```



```
-        Return the hasse diagram of ``self``.
+        Return the hasse diagram of the face lattice of ``self``.
```


I will go more in depth soon.

Does this mean that we can remove the file `hasse_diagram.py`?


---

Comment by @kliem created at 2020-02-14 12:10:24

New commits:


---

Comment by git created at 2020-02-14 12:17:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by jipilab created at 2020-04-20 09:43:55

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2020-04-20 09:43:55

Suggestions:


```diff
+        .. NOTE::
-            The face lattice is not cached, as long as this would create a memory leak.
+            The face lattice is not cached, as long as this creates a memory leak, see :trac:`28982`.
```


Hasse is a lastname, so you can capitalize it within the documentation.

Could the function below have more information? Like which order is meant to be simulated here? Inclusion or lex on indices of vertices, etc? Just one more sentence to specify might be nice?


```diff
+    def __lt__(self, other):
+        r"""
+        Compare faces of the same polyhedron.
+
+        EXAMPLES::
+
+            sage: P = polytopes.simplex()
+            sage: C = CombinatorialPolyhedron(P)
+            sage: F1 = C.face_by_face_lattice_index(0)
+            sage: F2 = C.face_by_face_lattice_index(1)
+            sage: F1 < F2
+            True
+        """
+        return hash(self) < hash(other)
```


Is there a reason why the hasse diagram of the combinatorial polyhedron is not cached?


---

Comment by @kliem created at 2020-04-20 11:17:38

New commits:


---

Comment by @kliem created at 2020-04-20 11:17:38

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2020-04-20 14:48:32

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2020-04-20 14:48:32

Great! Thanks for the quick changes. You forgot a capital "H" in the last commit. Apart from that it is good to go!

once you make this last typo change, you can set it to positive review on my behalf.


---

Comment by git created at 2020-04-20 14:50:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-20 14:50:44

Thank you.


---

Comment by @kliem created at 2020-04-20 14:50:44

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-04-22 22:42:08

Merge conflict


---

Comment by vbraun created at 2020-04-22 22:42:08

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2020-04-24 05:43:53

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-04-24 05:43:53

Last 10 new commits:


---

Comment by jipilab created at 2020-04-27 13:29:22

It doesn't seem to build... See patchbot.


---

Comment by jipilab created at 2020-04-27 13:29:22

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-04-27 13:42:05

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-04-27 13:42:05

Last 10 new commits:


---

Comment by jipilab created at 2020-05-11 13:24:43

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2020-05-11 13:24:43

Looks good to me now.


---

Comment by vbraun created at 2020-05-21 17:51:04


```
sage -t --long --warn-long 36.4 src/sage/geometry/polyhedron/face.py
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 454, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face = p.face_lattice()[5]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[1]>", line 1, in <module>
        face = p.face_lattice()[Integer(5)]
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5873, in face_lattice
        return FiniteLatticePoset(self.hasse_diagram())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)
        self.cache = f(self._instance)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5901, in hasse_diagram
        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21864, in relabel
        complete_partial_function = complete_partial_function)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21929, in relabel
        raise NotImplementedError("Non injective relabeling")
    NotImplementedError: Non injective relabeling
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 455, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[2]>", line 1, in <module>
        face
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 457, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face.ambient_Hrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[3]>", line 1, in <module>
        face.ambient_Hrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 462, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
Failed example:
    face.n_ambient_Hrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation[4]>", line 1, in <module>
        face.n_ambient_Hrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 481, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face = p.face_lattice()[5]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[1]>", line 1, in <module>
        face = p.face_lattice()[Integer(5)]
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5873, in face_lattice
        return FiniteLatticePoset(self.hasse_diagram())
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12712)
        self.cache = f(self._instance)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 5901, in hasse_diagram
        return D.relabel(index_to_polyhedron_face, inplace=False, immutable=True)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21864, in relabel
        complete_partial_function = complete_partial_function)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 21929, in relabel
        raise NotImplementedError("Non injective relabeling")
    NotImplementedError: Non injective relabeling
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 482, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[2]>", line 1, in <module>
        face
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 484, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face.ambient_Vrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[3]>", line 1, in <module>
        face.ambient_Vrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
File "src/sage/geometry/polyhedron/face.py", line 486, in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
Failed example:
    face.n_ambient_Vrepresentation()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation[4]>", line 1, in <module>
        face.n_ambient_Vrepresentation()
    NameError: name 'face' is not defined
**********************************************************************
2 items had failures:
   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Hrepresentation
   4 of   6 in sage.geometry.polyhedron.face.PolyhedronFace.n_ambient_Vrepresentation
    [119 tests, 8 failures, 0.44 s]
```



---

Comment by vbraun created at 2020-05-21 17:51:04

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2020-05-25 08:17:28

I rebased on top of #29583 (as there is some merge conflict).

I also fixed the error in #28894, which caused the doctest failure. Now this ticket works by itself and on top of #28894. At least the following tests pass on my machine with and without #28894:


```
sage -t --long -p 8 src/doc/en/thematic_tutorials/geometry
sage -t --long -p 8 src/sage/geometry/polyhedron/
sage -t --long -p 8 src/sage/plot/
```

----
Last 10 new commits:


---

Comment by @kliem created at 2020-05-25 08:17:41

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-08-13 05:18:02

Needs rebase (build fails).


---

Comment by @kliem created at 2020-08-13 05:18:02

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-08-13 05:43:22

New commits:


---

Comment by @kliem created at 2020-08-13 05:43:22

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-27 04:16:54


```
+    if polyhedron.dimension() == 0:
+        # In case of the 0-dimensional polyhedron,
+        # there is a facets but no inequality.
+        H_indices = tuple(range(n_equations))
+
```

The comment needs rewording


---

Comment by mkoeppe created at 2020-08-27 04:17:00

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-08-27 05:37:28

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-08-27 05:37:28

New commits:


---

Comment by mkoeppe created at 2020-08-30 19:58:12


```
+    def __lt__(self, other):
+        r"""
+        Compare faces of the same polyhedron.
+
+        This is a helper function.
+        In order to construct a Hasse diagram (a digraph) with combinatorial faces,
+        we must define some order relation that is compatible with the Hasse diagram.
+
+        Any order relation compatible with ordering by dimension is suitable.
+        We us :meth:`__hash__` to define the relation.
```


I don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?


---

Comment by git created at 2020-08-31 07:41:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-08-31 07:45:28

Replying to [comment:31 mkoeppe]:
> {{{
> +    def __lt__(self, other):
> +        r"""
> +        Compare faces of the same polyhedron.
> +
> +        This is a helper function.
> +        In order to construct a Hasse diagram (a digraph) with combinatorial faces,
> +        we must define some order relation that is compatible with the Hasse diagram.
> +
> +        Any order relation compatible with ordering by dimension is suitable.
> +        We us :meth:`__hash__` to define the relation.
> }}}
> 
> I don't fully understand what's happening in that hash function. If one uses the face iterator in non-dual mode, is the resulting order relation still correct?

You are right.
I'm surprised it worked that way.
The hash function should be consistent now. And `__lt__` returns `None` if the faces are clearly incompatible.
What's nice about this hash function, if I understand it correctly, is that it allows to store faces in sets etc.


---

Comment by mkoeppe created at 2020-08-31 13:34:55

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-08-31 13:35:24

Thank you.


---

Comment by vbraun created at 2020-09-06 21:51:47

Resolution: fixed
