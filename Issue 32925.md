# Issue 32925: installation of pycryprosat/cryptominisat is broken

Issue created by migration from https://trac.sagemath.org/ticket/33162

Original creator: dimpase

Original creation time: 2022-01-13 19:07:18

CC:  mkoeppe slelievre vbraun

pycryptosat is meant to be installed as a part of cryptominisat,
but it does not happen.

This is because it's installing the Python module in SAGE_ROOT/local/
From the log:


```
-- Found python interpreter, libs and header files
-- Building python interface
-- Python CFLAGS:  '-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g -ffile-prefix-map=/build/python3.9-RNBry6/python3.9-3.9.2=.  -fstack-protector-strong -Wformat -Werror=format-security  -g -fwrapv -O2   '
-- Python LDFLAGS: '-lcrypt -lpthread -ldl  -lutil -lm'
-- Python LINKFORSHARED flags: '-Xlinker -export-dynamic -Wl,-O1 -Wl,-Bsymbolic-functions'
-- Python module will be installed to : '/home/dimpase/work/sage/local'
-- Configuring done
```


See
 https://groups.google.com/d/msgid/sage-release/cc134257-34d8-4c26-8719-24a994dc42dan%40googlegroups.com


```
./sage --pip install pycryptosat
```

can be used as a workaround



---

Comment by dimpase created at 2022-01-13 19:12:03

in cmake [config of cryptominisat](https://github.com/msoos/cryptominisat/blob/master/python/CMakeLists.txt) on sees

```
if(DEFINED ENV{PYCRYPTOSAT_INSTALL_PATH})
    set(PY_INSTALL_PREFIX "--prefix=$ENV{PYCRYPTOSAT_INSTALL_PATH}")
elseif(DEFINED ENV{VIRTUAL_ENV})
    set(PY_INSTALL_PREFIX "")
else()
    set(PY_INSTALL_PREFIX "--prefix=${CMAKE_INSTALL_PREFIX}")
endif()
```


so one can explicitly set the path for the module. But to what value?


---

Comment by slelievre created at 2022-01-13 20:08:02

See also

- #25374: Upgrade cryptominisat to fix cryptominisat build on Cygwin


---

Comment by slelievre created at 2022-01-13 20:09:55

Changing keywords from "" to "cryptominisat".


---

Comment by mkoeppe created at 2022-01-13 20:20:23

In principle, it would be set to ${SAGE_VENV}. 
But it is not a correct solution, as explained in #25374#comment:39


---

Comment by dimpase created at 2022-01-13 20:40:18

Replying to [comment:4 mkoeppe]:
> In principle, it would be set to ${SAGE_VENV}. 
> But it is not a correct solution, as explained in #25374#comment:39

I don't see why it's not OK. Passing `PYCRYPTOSAT_INSTALL_PATH=$SAGE_VENV`
would make sure the python package installs in the correct venv, while the rest goes where it should.


---

Comment by mkoeppe created at 2022-01-13 20:42:46

Because of our installation records in SAGE_LOCAL/var/lib/sage/installed/ and SAGE_VENV/var/lib/sage/installed.


---

Comment by dimpase created at 2022-01-13 21:44:59

Replying to [comment:6 mkoeppe]:
> Because of our installation records in SAGE_LOCAL/var/lib/sage/installed/ and SAGE_VENV/var/lib/sage/installed.
> 

can we allow Python modules in SAGE_LOCAL, too? As a temporary fix, at least.


---

Comment by mkoeppe created at 2022-01-14 03:09:15

no, they won't be in the load path.


---

Comment by mkoeppe created at 2022-01-14 03:18:47

Solution is as I said in #25374#comment:48


---

Comment by dimpase created at 2022-01-14 10:21:37

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-01-14 10:21:37

here is an easier fix. 

Made it blocker, as this fixes an otherwise totally broken optional package.
----
New commits:


---

Comment by dimpase created at 2022-01-14 10:21:37

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2022-01-14 15:56:27

This is not enough because it will break when you switch to a different Python.


---

Comment by mkoeppe created at 2022-01-14 15:56:27

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2022-01-14 17:55:29

cryptominisat depends on
$(PYTHON), thus such a switch will trigger a rebuild.


---

Comment by mkoeppe created at 2022-01-14 17:57:16

Nope


---

Comment by dimpase created at 2022-01-14 18:01:19

then I don't understand what "switch" means.


---

Comment by mkoeppe created at 2022-01-14 18:05:16

When a system python is in use, `$(PYTHON)` is the path to `$(SAGE_VENV)/pyvenv.cfg`. This file is created on creation of the venv for the configured python and is never updated.

Switching between pythons = Re-running `configure`, with or without `--with-python=....`, which selects different system python versions.


---

Comment by dimpase created at 2022-01-14 18:08:59

and how does one trigger rebuild of a Pyhton package in such a case?


---

Comment by mkoeppe created at 2022-01-14 18:10:54

Installation records for Python packages are kept in $(SAGE_VENV)/var/lib/sage/installed.
Different Python version -> Different SAGE_VENV -> different installation records.


---

Comment by dimpase created at 2022-01-14 18:35:43

this does not answer my question.


---

Comment by mkoeppe created at 2022-01-14 18:46:01

Then I don't understand your question - what should trigger a rebuild of what?


---

Comment by dimpase created at 2022-01-14 19:04:54

how does using another Python in a configure run sets up rebuilt of python packages? Suppose you have 

```
./configure --with-python=foo
make
./configure --with-python=bar
make
```

What is triggering building Python packages for `bar` ?


---

Comment by mkoeppe created at 2022-01-14 19:10:58

If foo is python3.8 and bar is python3.9, 
then first, `SAGE_VENV=$SAGE_LOCAL/var/lib/sage/venv-python3.8`
and after reconfiguration, `SAGE_VENV=$SAGE_LOCAL/var/lib/sage/venv-python3.9`.

Installation records for Python packages are kept in `$SAGE_VENV/var/lib/sage/installed`.
After reconfiguration, no Python package will have installation records. So all Python packages are built.


---

Comment by mkoeppe created at 2022-01-14 19:28:20

I've added some explanation of this in https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages


---

Comment by dimpase created at 2022-01-14 19:37:35

can we set up a "dummy" Python package pycryptosat, a dependency of cryptominisat, which sole purpose is to trigger rebuild of cryptominisat ?


---

Comment by mkoeppe created at 2022-01-14 19:40:53

Why not just make it an ordinary package?


---

Comment by dimpase created at 2022-01-14 20:18:57

because I have no idea how to decouple pycryptosat from cryptominisat.

the former is generated on the fly from templates, by the latter.


---

Comment by mkoeppe created at 2022-01-14 20:29:18

There is not a separate Makefile target for just installing the Python package?
OK to build the C library twice; but we should avoid to install it twice.


---

Comment by dimpase created at 2022-01-14 20:51:56

makefiles generated by cmake are usually a mess.


---

Comment by dimpase created at 2022-01-14 21:01:37

I would be surprised if so built python module was linked correctly, against the already installed library, and not the one built by this 2nd round.

How about just renaming cryptominisat spkg to pycryptosat ?


---

Comment by mkoeppe created at 2022-01-14 21:06:19

Replying to [comment:28 dimpase]:
> I would be surprised if so built python module was linked correctly, against the already installed library, and not the one built by this 2nd round.

I don't see how it could fail. All the rpaths are set correctly by the build system.


---

Comment by mkoeppe created at 2022-01-14 21:07:26

Replying to [comment:28 dimpase]:
> How about just renaming cryptominisat spkg to pycryptosat ?

Fine with me; then you could add an `install-requires.txt`, which will ensure installation will go into SAGE_VENV.


---

Comment by dimpase created at 2022-01-14 21:23:08

imho using `sdh_pip_install` already makes sure it goes to SAGE_VENV, no?


---

Comment by mkoeppe created at 2022-01-14 22:07:50

The installation of the Python package yes, but not the library and not the installation record!


---

Comment by mkoeppe created at 2022-01-14 23:53:32

But the present branch is certainly an improvement, so let's consider it a hotfix for Sage 9.5


---

Comment by mkoeppe created at 2022-01-14 23:53:32

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2022-01-15 09:09:02

Replying to [comment:32 mkoeppe]:
> The installation of the Python package yes, but not the library and not the installation record!


the library still goes to SAGE_LOCAL.

Imho all the sdh_ - scripts correctly set installation records of Sage.


---

Comment by git created at 2022-01-15 14:28:42

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-01-15 14:28:42

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2022-01-15 14:30:21

Is this what you kept in mind? Turns out one just needs to run cmake to get pycryptosat set up, no need to build the library twice.


---

Comment by mkoeppe created at 2022-01-15 16:25:47

Replying to [comment:35 dimpase]:
> Imho all the sdh_ - scripts correctly set installation records of Sage. 

The installation records are set by `sage-spkg`, not by `sdh_...`.
One record for one package.


---

Comment by mkoeppe created at 2022-01-15 16:27:07

Replying to [comment:37 dimpase]:
> Is this what you kept in mind? Turns out one just needs to run cmake to get pycryptosat set up, no need to build the library twice.

Almost. Still need `build/pkgs/pycryptosat/install-requires.txt` so that the installation record goes into SAGE_VENV, not in SAGE_LOCAL


---

Comment by mkoeppe created at 2022-01-15 16:28:18

And `build/pkgs/pycryptosat/checksums.ini` should be a symlink, not a copy, of `cryptominisat`'s.
(Like it is done for `gcc`/`gfortran`)


---

Comment by mkoeppe created at 2022-01-15 16:29:39

Are the `pycryptosat` `distros` correct? Do the "cryptominisat" distro packages really install the Python bindings?


---

Comment by mkoeppe created at 2022-01-15 16:40:31

Also a good moment to add `upstream_url` in `checksums.ini`


---

Comment by mkoeppe created at 2022-01-15 16:44:51

Also note that the positively reviewed version of this ticket is already on Volker's branch, so best to reset to that and continue on a follow-up ticket


---

Comment by git created at 2022-01-15 17:13:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2022-01-15 17:14:08

ok, this is the old fix


---

Comment by dimpase created at 2022-01-15 17:14:08

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-01-15 17:16:52

followup on #33183


---

Comment by dimpase created at 2022-01-15 17:21:06

Replying to [comment:41 mkoeppe]:
> Are the `pycryptosat` `distros` correct? Do the "cryptominisat" distro packages really install the Python bindings?

I don't know - as spkg-configure is not yet there, it can be left as such for the time being.


---

Comment by vbraun created at 2022-01-15 18:58:37

Resolution: fixed


---

Comment by slabbe created at 2022-01-21 16:28:39

It seems something is missing (maybe a dependency) as it is now broken on my machine, see https://groups.google.com/g/sage-release/c/1YV0dNtEZz4/m/Tm7RSWINAgAJ

Is there a ticket for it already? I think I have seen a report of the failure earlier this week by someone else, I don't remember where.


---

Comment by dimpase created at 2022-01-21 21:56:01

missing python toolchain in deps of cryptominisat.

see #33183
