# Issue 34464: libgap: Fix GC crashes on aarch64

Issue created by migration from https://trac.sagemath.org/ticket/34701

Original creator: @collares

Original creation time: 2022-10-28 22:23:45

CC:  embray vdelecroix

A refactor in #27946 introduced "unprotected" (not surrounded by `GAP_Enter`/`GAP_Leave`) `GAP_ValueGlobalVariable` calls. Also, `capture_stdout`, introduced in the same refactor, returns a `char*` which is expected to survive past a `GAP_Enter`/`GAP_Leave` block, when it is converted to a `str`. I believe both scenarios might be GC hazards because I am seeing aarch64 crashes in NixOS infrastructure after updading to GAP 4.12.0, such as:

```
#0  0x0000fffff79740e8 in wait4 ()
#1  0x0000fffff5dc6b78 in print_enhanced_backtrace ()
#2  0x0000fffff5dc8190 in sigdie ()
#3  0x0000fffff5dcb1c0 in cysigs_signal_handler ()
#4  0x0000fffff7ffb7cc in __kernel_rt_sigreturn ()
#5  0x0000ffff99a0bf28 in ConvString ()
#6  0x0000000000000000 in ?? ()
#7  0x0000000000000000 in ?? ()
#8  0x0000000000000000 in ?? ()
#9  0x0000ffff99989930 in Pr ()
#10 0x0000ffff9998aa18 in CloseOutput ()
#11 0x0000ffff99884828 in capture_stdout () at /build/sage-src-9.7/pkgs/sagemath-standard/sage/libs/gap/element.pyx:154
...
```

I also see cases where `capture_stdout` throws errors such as `sage.libs.gap.util.GAPError: Error, Length: <list> must be a list (not the integer 255)` and then crashes. Both types of errors are fixed by this ticket.

Note that I am nesting `GAP_Enter`/`GAP_Leave` calls because I didn't remove the preexisting calls inside `capture_stdout`. That's because I wanted to avoid create a new footgun by removing the innermost calls (and I believe nested `GAP_Enter`/`GAP_Leave` calls are explicitly supported), but removing them should cause no problem.

This ticket's branch is based on #34391.


---

Comment by git created at 2022-10-29 00:20:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
