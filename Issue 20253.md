# Issue 20253: Hash error with multivariate Laurent polynomial rings

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2016-04-23 05:15:06

Assignee: tscrim

Keywords: hash, multivariate Laurent polynomials

We do not have equality implying equality of hashes for multivariate Laurent polynomial rings:

```
sage: R.<a,b> = LaurentPolynomialRing(ZZ)
sage: elt = (a + b) * (~a + ~b) - a*~b - ~a*b - 1
sage: elt == R.one()
True
sage: hash(elt) == hash(R.one())
False
```



---

Comment by roed created at 2016-04-23 06:20:38

The problem is that the hash function takes `elt._mon` into account: internally `elt` is represented as `ab/ab` while `R.one()` is represented as `1/1`.

```
sage: elt._fraction_pair()
(a*b, a*b)
sage: R.one()._fraction_pair()
(1, 1)
```

The problem is solved in this case by manually calling `_normalize()`:

```
sage: elt._normalize()
sage: elt._fraction_pair()
(1, 1)
sage: hash(elt) == hash(R.one())
True
```


Writing hash functions is hard....


---

Comment by tscrim created at 2016-04-23 15:52:19

Thanks. That indeed did solve the problem.

With branch:

```
sage: R.<a,b> = LaurentPolynomialRing(ZZ)
sage: p = (a + b + ~b + 1)^10
sage: %timeit hash(p)
10000 loops, best of 3: 170 µs per loop
```

(without the cython changes is ~180 µs)
vs old version:

```
sage: p = (a + b + ~b + 1)^10
sage: %timeit hash(p)
10000 loops, best of 3: 34.2 µs per loop
```

Note that `p` has 121 terms with an upper degree of 10 and a lower degree of -10. The fact that we only get ~6x slowdown here is acceptable to me. (There's likely more speed to be gained from doing more cythonization of the internal methods of the (Laurent) multivariate polynomials.)
----
New commits:


---

Comment by tscrim created at 2016-04-23 15:52:19

Changing status from new to needs_review.


---

Comment by git created at 2016-04-23 21:50:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2016-04-23 21:51:45

So there were issues with my cythonization. The easiest thing to do was to revert back to 792d3a0.


---

Comment by roed created at 2016-04-24 00:52:37

Changing status from needs_review to positive_review.


---

Comment by roed created at 2016-04-24 00:52:37

Yeah, this seems like a reasonable fix, though certainly more improvements could be made.


---

Comment by vbraun created at 2016-04-25 08:38:19

Resolution: fixed
