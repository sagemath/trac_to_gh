# Issue 30473: local-conda-forge-ubuntu-standard:

Issue created by migration from https://trac.sagemath.org/ticket/30710

Original creator: mkoeppe

Original creation time: 2020-10-03 20:11:31

CC:  dimpase isuruf

https://github.com/mkoeppe/sage/runs/1201631449

```
  building 'umfpack' extension
  /home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/bin/x86_64-conda-linux-gnu-cc -Wno-unused-result -Wsign-compare -DNDEBUG -fwrapv -O2 -Wall -Wstrict-prototypes -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/include -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/include -fPIC -I/usr/include -I/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/local/include -I/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/include/python3.8 -c src/C/umfpack.c -o build/temp.linux-x86_64-3.8/src/C/umfpack.o
  In file included from /home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/include/python3.8/Python.h:11:0,
                   from src/C/cvxopt.h:22,
                   from src/C/umfpack.c:22:
  /usr/include/limits.h:26:10: fatal error: bits/libc-header-start.h: No such file or directory
   #include <bits/libc-header-start.h>
            ^~~~~~~~~~~~~~~~~~~~~~~~~~
  compilation terminated.
  error: command '/home/runner/work/sage/sage/.tox/local-conda-forge-ubuntu-standard/conda/bin/x86_64-conda-linux-gnu-cc' failed with exit status 1
  Building wheel for cvxopt (setup.py): finished with status 'error'
  ERROR: Failed building wheel for cvxopt
  Running setup.py clean for cvxopt
```



---

Comment by isuruf created at 2020-10-03 20:23:44

Can you print the values of,
https://github.com/sagemath/sage/blob/master/build/pkgs/cvxopt/spkg-install.in#L20-L33


---

Comment by isuruf created at 2020-12-22 22:00:08

Issue is that somewhere, some code is adding `/usr/include` to include directories and that conflicts with conda's sysroot.


---

Comment by dimpase created at 2020-12-24 11:22:43

Replying to [comment:4 isuruf]:
> Issue is that somewhere, some code is adding `/usr/include` to include directories and that conflicts with conda's sysroot.

isn't this done by cvxopt's [`setup.py`](https://github.com/cvxopt/cvxopt/blob/master/setup.py) ?
Probably it needs a patch to special-case conda.
(Sage does a bit of [patching](https://github.com/sagemath/sage/blob/develop/build/pkgs/cvxopt/patches/libsuitesparse_path.patch) of this file.)


---

Comment by mkoeppe created at 2021-03-08 00:42:52

We can try if upgrading cvxopt (#31467) helps


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by chapoton created at 2022-01-29 08:58:50

bump to 9.6


---

Comment by mkoeppe created at 2022-08-03 22:52:00

Same after upgrade to cvxopt 1.3.0 in #34150 (https://github.com/mkoeppe/sage/runs/7646124113)


---

Comment by isuruf created at 2022-08-03 23:01:41

The lines at https://github.com/sagemath/sage/blob/master/build/pkgs/cvxopt/spkg-install.in#L68-L71
should be changed to

```
export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_LOCAL}/lib"
export CVXOPT_SUITESPARSE_INC_DIR="${SAGE_LOCAL}/include"
```

even when suitesparse is coming from the system, so that `setup.py` doesn't add its default `/usr/include`.


---

Comment by mkoeppe created at 2022-08-03 23:50:58

Yes, good idea. 

In #31584#comment:10, I wrote:

  We do not need to do this when we use system suitesparse, as we do not want to claim authority that our configure script's suitesparse-finding technique is better than the one in cvxopt's install script.

But as it turns out, our technique (= just relying on standard compiler/linker paths) is better.


---

Comment by mkoeppe created at 2022-08-03 23:53:44

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-03 23:53:44

New commits:


---

Comment by isuruf created at 2022-08-04 00:42:07

Why `export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_LOCAL}"` instead of `export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_LOCAL}/lib"`?


---

Comment by git created at 2022-08-04 01:50:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-04 01:51:23

Thanks. This made no sense. I've fixed the line below for GLPK, which made the same error. In the end it does not matter what we put there -- this directory is in the library search path anyway.


---

Comment by isuruf created at 2022-08-04 02:33:24

Looks good to me. Can you run the github actions for this?


---

Comment by mkoeppe created at 2022-08-05 01:10:37

This fixed it but it looks like it broke other platforms, including `ubuntu-jammy`

```
  gcc -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-Bsymbolic-functions -g -fwrapv -O2 -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -g -O2 build/temp.linux-x86_64-cpython-310/src/C/lapack.o -L/usr/lib/x86_64-linux-gnu/openblas-pthread/ -L/usr/lib/x86_64-linux-gnu -lopenblas -lopenblas -o build/lib.linux-x86_64-cpython-310/cvxopt/lapack.cpython-310-x86_64-linux-gnu.so
  building 'umfpack' extension
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -g -fstack-protector-strong -Wformat -Werror=format-security -g -fwrapv -O2 -g -O2 -fPIC -I/sage/local/include -I/sage/local/var/lib/sage/venv-python3.10/include -I/usr/include/python3.10 -c src/C/umfpack.c -o build/temp.linux-x86_64-cpython-310/src/C/umfpack.o
  src/C/umfpack.c:23:10: fatal error: umfpack.h: No such file or directory
     23 | #include "umfpack.h"
        |          ^~~~~~~~~~~
  compilation terminated.
```

https://github.com/mkoeppe/sage/runs/7682737008?check_suite_focus=true


---

Comment by mkoeppe created at 2022-08-05 01:10:44

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-08-05 02:08:23

Related: #31905
