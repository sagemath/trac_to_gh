# Issue 18410: Automatically update new-style optional packages

Issue created by migration from https://trac.sagemath.org/ticket/18647

Original creator: ncohen

Original creation time: 2015-06-09 14:33:19

CC:  vbraun jdemeyer jhpalmieri kcrisman

With this branch, new-style installed optional packages which have not been installed to their latest available version are automatically updated during 'make'.

Nathann


---

Comment by ncohen created at 2015-06-09 14:34:09

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-06-09 14:34:09

New commits:


---

Comment by jdemeyer created at 2015-06-09 14:39:52

I would much prefer to add `$(OPTIONAL_INSTALLED_PACKAGES)` to `all-sage` instead of adding a new step in the `all` make rule.


---

Comment by ncohen created at 2015-06-09 14:49:28

> I would much prefer to add `$(OPTIONAL_INSTALLED_PACKAGES)` to `all-sage` instead of adding a new step in the `all` make rule.

Then you must figure out which optional packages depend on which standard packages.

(it is not possible to add all standard packages as a dependency, as some 'optional' packages like python2 may also be standard in practice)


---

Comment by jdemeyer created at 2015-06-09 15:04:19

Replying to [comment:3 ncohen]:
> > I would much prefer to add `$(OPTIONAL_INSTALLED_PACKAGES)` to `all-sage` instead of adding a new step in the `all` make rule.
> 
> Then you must figure out which optional packages depend on which standard packages.

If the goal is to have more reliable optional packages, this needs to be done _anyway_. If some optional package depends on PARI and PARI gets rebuilt, then you really should rebuild the optional package too.


---

Comment by ncohen created at 2015-06-09 15:13:31

> If the goal is to have more reliable optional packages, this needs to be done _anyway_. If some optional package depends on PARI and PARI gets rebuilt, then you really should rebuild the optional package too.

Indeed, this is how it should have been implemented from the start. For you will agree that the problem already exists: if some optional package does not state its dependencies and if 'pari' (to take your example) is updated, the package is not re-built. At the moment, only gcc, scons, python2 and python3 state their dependencies.

Thus, and similarly to our recent debate on #18456, what you ask for is a very sensible bugfix for a pre-existing problem. You are welcome to address it -- and I will be glad to help -- but it is not a dependency of this ticket.

Nathann


---

Comment by ncohen created at 2015-06-09 15:16:48

By the way, fixing the dependencies can be done quite easily: by adding the necessary information in the build/<package/dependencies files you will get the result that you want. And we can merge the two rules together once we are sure that no dependency is missing.


---

Comment by jdemeyer created at 2015-06-09 15:23:04

Replying to [comment:5 ncohen]:
> Thus, and similarly to our recent debate on #18456, what you ask for is a very sensible bugfix for a pre-existing problem.
But setting up the right framework such that dependencies _can_ be considered is within the scope of this ticket.

Easy fix: set all dependencies of optional packages to `| $(STANDARD_PACKAGES)`, which in practice is the same as your current patch, but allows to write the correct dependencies later.


---

Comment by jdemeyer created at 2015-06-09 15:23:58

Replying to [comment:3 ncohen]:
> it is not possible to add all standard packages as a dependency, as some 'optional' packages like python2 may also be standard in practice
Since many standard packages depend on Python, adding a dependency on `$(STANDARD_PACKAGES)` indirectly adds a dependency on Python.


---

Comment by ncohen created at 2015-06-09 15:25:14

> Easy fix: set all dependencies of optional packages to `| $(STANDARD_PACKAGES)`, which in practice is the same as your current patch, but allows to write the correct dependencies later.

Dead right. Will be done in a second.


---

Comment by git created at 2015-06-09 15:34:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-09 15:35:19

Not `mpir` and `gmp`.


---

Comment by jdemeyer created at 2015-06-09 15:35:19

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-06-09 15:35:42

As a consequence: all optional packages have (and *MUST* have) a /dependencies file.

Should we check this somewhere?


---

Comment by git created at 2015-06-09 15:36:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-06-09 15:36:56

Right. Fixed. Cursed be those non-optional optional packages.


---

Comment by jdemeyer created at 2015-06-09 15:38:37

Replying to [comment:14 ncohen]:
> Right. Fixed. Cursed be those non-optional optional packages.
Well, I proposed a new category for these packages :-)

I also wonder if we can use

```
if [ -f $SAGE_SPKG_INST/$PKG_NAME-* ]
```

since that will not work if there is more than 1 matching file.


---

Comment by ncohen created at 2015-06-09 15:42:29

> Well, I proposed a new category for these packages :-)

Oh. The alternative guys?

> I also wonder if we can use
> {{{
> if [ -f $SAGE_SPKG_INST/$PKG_NAME-* ]
> }}}
> since that will not work if there is more than 1 matching file.

I think that's okay, for you made it quite clear that a version number must be split from the name by a '-'? I don't mind adding code that checks that somewhere if you think it necessary, but renaming the packages that do not respect this may take quite some time.

Nathann


---

Comment by jdemeyer created at 2015-06-09 17:05:04

Replying to [comment:16 ncohen]:
> I think that's okay

Right, I agree.


---

Comment by jdemeyer created at 2015-06-09 17:31:33

I don't think this works correctly for `gcc`. If `gcc` needs to be reinstalled, it should be added to `$(TOOLCHAIN)`. The problem is that installing `gcc` while installing a different package will eventually lead to trouble.


---

Comment by jdemeyer created at 2015-06-09 17:35:02

For `gcc`, we already have logic in `build/install` to decide whether it should be (re-)installed. You shouldn't interfere with that.


---

Comment by ncohen created at 2015-06-09 17:43:00

So I filter it out?


---

Comment by jdemeyer created at 2015-06-09 17:47:43

Replying to [comment:20 ncohen]:
> So I filter it out?
Or change the `type` to something else (if you don't want to add a new type, it must be `base`)


---

Comment by ncohen created at 2015-06-09 18:30:04

HMmmmmmmm... If I rename it to 'base' it will be automatically installed. I'll just filter it out. Can you tell me what exactly is wrong if we leave it as it is? It will only force an update if it has already been installed, and if the version changes. It looks harmless?...

Nathann


---

Comment by jdemeyer created at 2015-06-09 18:41:20

Replying to [comment:22 ncohen]:
> HMmmmmmmm... If I rename it to 'base' it will be automatically installed.
Why? Since when are we automatically installing `base` packages?

> Can you tell me what exactly is wrong if we leave it as it is? It will only force an update if it has already been installed, and if the version changes. It looks harmless?...
Read the last sentence of [comment:18]


---

Comment by ncohen created at 2015-06-09 19:01:56

> Why? Since when are we automatically installing `base` packages?

Well, not automtically.. There is a 'base' rule in the makefile, but the dependencies are set manually. Probably because of gcc actually.

> Read the last sentence of [comment:18]

Okay, so tha's because gcc is gcc. I'll filter it out.

Nathann


---

Comment by git created at 2015-06-09 19:07:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-06-09 19:07:42

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2015-06-09 20:30:24

I know you've done all of this work to create these files now, but if a package is optional and doesn't have a `dependencies` file, shouldn't we automatically set the dependencies to `| $(STANDARD_PACKAGES)`? That seems cleaner to me.


---

Comment by ncohen created at 2015-06-09 20:33:57

> I know you've done all of this work to create these files now, but if a package is optional and doesn't have a `dependencies` file, shouldn't we automatically set the dependencies to `| $(STANDARD_PACKAGES)`? That seems cleaner to me.

Well... There would be less things in the files for sure, but a new rule which is rather hard to figure out by yourself. Honestly I don't know... Jeroen?


---

Comment by ncohen created at 2015-06-09 20:36:39

If a guy notices that his package depends on another package and wants to add the dependency, suddenly he would have to create the file and add the implicit dependency `| $(STANDARD_PACKAGES)`.


---

Comment by ncohen created at 2015-06-09 20:38:50

Really I do not know. I don't mind implementing it if you are both convinced that it is a good idea, but really I don't know.


---

Comment by jdemeyer created at 2015-06-09 20:42:30

Replying to [comment:29 ncohen]:
> If a guy notices that his package depends on another package and wants to add the dependency, suddenly he would have to create the file and add the implicit dependency `| $(STANDARD_PACKAGES)`.
No, the dependency `| $(STANDARD_PACKAGES)` is not a real dependency, it's just because we are too lazy to add the correct dependencies.

So, I think John's proposal might be good (but be sure to keep the empty dependencies for `mpir` and `gmp`)


---

Comment by ncohen created at 2015-06-09 20:57:21

Okayokay, no problem then. I'll do that tomorrow morning (sorry guys, I really need to sleep `^^;`)


---

Comment by git created at 2015-06-10 08:29:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-06-10 08:29:28

Here it is. I rewrote history, so that one commit does not undo what the previous does.

Nathann


---

Comment by git created at 2015-06-10 09:36:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 09:39:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-10 09:50:46

Replace

```
[ "x$(cat $TYPE_FILE)" = "xoptional" ]
```

by

```
[ x`cat "$TYPE_FILE"` = xoptional ]
```

(the point is: you need to quote `$TYPE_FILE`)


---

Comment by jdemeyer created at 2015-06-10 09:51:44

And `"| \$(STANDARD_PACKAGES)"` can be `'| $(STANDARD_PACKAGES)'` (avoid ugly backslashes if you can)


---

Comment by git created at 2015-06-10 10:00:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-10 11:32:59

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-06-10 11:47:28

Excellent news! Thanks `;-)`


---

Comment by jdemeyer created at 2015-06-11 07:59:15

Replying to [comment:24 ncohen]:
> > Why? Since when are we automatically installing `base` packages?
> 
> Well, not automtically.. There is a 'base' rule in the makefile, but the dependencies are set manually.

Don't confuse the `base` make rule with `base` package(s) (maybe that's actually a good reason to rename the `base` packages to something else).


---

Comment by vbraun created at 2015-06-11 22:23:33

Resolution: fixed
