# Issue 10293: Slowness of pexpect interfaces on some machines

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2010-11-20 08:50:17

Assignee: was

CC:  alexanderdreyer wjp leif

Keywords: pexpect select performance Ubuntu

Originally reported at [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/d4b2ca2fe7ee0678):

Some machines suffer from a massive overhead in the following test.

```
def test(n):
    st = singular.cputime()
    ct = cputime()
    wt = walltime()
    for i in range(n):
        a = singular(i)
    print "Wall time:", walltime(wt)
    print "Total CPU:", cputime(ct)+singular.cputime(st)
```


On bsd.math, one gets something like

```
sage: test(1000)
Wall time: 0.261538028717
Total CPU: 0.331918 
```


On some other machines, one may get up to

```
sage: test(1000)
Wall time: 59.9999949932
Total CPU: 0.05 
```


The reports indicate that the overhead is bad on Debian and worst on Ubuntu; it seems to be independent of the CPU. So far, there is no other variety of Linux or Unix known that shows such a massive overhead.

Studying the interface code reveals that the overhead is caused by at least two calls to select.select, that are done when pexpect is waiting for the prompt:

 1. In `singular._synchronize()`
 2. If garbage collection occurs, it is waited for a prompt once for each variable that is to be deleted.
 3. When the actual code is sent to singular.

This is why the overhead of the Gap interface is only one third of the above: It does not use synchronization, and if a variable is to be deleted then simply it may be overwritten when creating the next Gap element. There must be ways to improve the Singular interface, so that one or two calls to select() can be avoided.

David Kirkby suggests to try and upgrade pexpect - Sage uses version 2.0, but the current pexpect is 2.3.

__I suggest that the Singular-specific problems and the pexpect upgrade are dealt with on different tickets, while this ticket focuses on the general problem of slow select() calls on some systems.__

The disadvantage of my suggestion is: What could we do to overcome a system-dependent performance problem? Would there be a way to work around select()? *Would it help to leave pexpect and use expect instead?*

I reported the problem to the pexpect developer, but there was no answer yet. Who knows, perhaps this ticket will eventually be a "wontfix", but we should at least try...


---

Comment by SimonKing created at 2010-11-20 09:20:57

This is related with #10295 and #10296.


---

Comment by SimonKing created at 2010-11-20 09:33:33

I forgot to mention a hint by Willem-Jan. He wrote on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/d4b2ca2fe7ee0678): 

----
Could you try to download, compile and run a small test program on a
problematic machine? It times how fast a pseudo-terminal responds, which might
be the problem judging by a few quick tests I ran.


```
wget http://www.usecode.org/misc/timeptmx.c
gcc -o timeptmx timeptmx.c
strace -o timeptmx.log -f -ttt ./timeptmx
grep aaa timeptmx.log
```


That should output something like this:


```
16095 1290175675.065705 write(3, "aaa", 3) = 3
16096 1290175675.065749 <... read resumed> "aaa", 256) = 3
```


The difference between these two timestamps seems to determine how fast pexpect
responds. In this case it's fast (1290175675.065705 to 1290175675.065749 is
only 44 microseconds), but I've seen 1.8ms on other machines with newer
kernels. 

----

I've seen even worse, namely 8ms on a Debian machine and 22ms on an Ubuntu machine.


---

Comment by mhansen created at 2010-11-20 18:17:35

This may also be relevant: http://groups.google.com/group/linux.kernel/browse_thread/thread/5a2b00e35b0864a7


---

Comment by SimonKing created at 2010-11-20 18:34:30

Replying to [comment:3 mhansen]:
> This may also be relevant: ...

Cool! Thank you!


---

Comment by AlexanderDreyer created at 2010-11-22 08:41:36

Changing assignee from was to AlexanderDreyer.


---

Comment by AlexanderDreyer created at 2010-11-24 00:33:46

Changing assignee from AlexanderDreyer to was.


---

Comment by AlexanderDreyer created at 2010-11-24 00:33:46

(Change in owner was not intended.)
