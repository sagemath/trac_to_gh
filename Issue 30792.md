# Issue 30792: Upgrade: cypari2 2.1.2

Issue created by migration from https://trac.sagemath.org/ticket/31029

Original creator: vdelecroix

Original creation time: 2020-12-08 09:55:52

CC:  dimpase mjo mkoeppe slelievre arojas fbissey vdelecroix thansen slabbe chapoton jhpalmieri

This is to upgrade cypari to 2.1.2 (which is compatible with pari 2.13 that is about to be upgraded too, see #30801)

- â€‹https://files.pythonhosted.org/packages/22/d9/4374baf5749257362f6d163096f9f5a3fa2a6f231edbe0d61c7bdf281d6e/cypari2-2.1.2.tar.gz


---

Comment by vdelecroix created at 2020-12-08 09:58:30

New commits:


---

Comment by vdelecroix created at 2020-12-08 09:58:30

Changing status from new to needs_review.


---

Comment by slelievre created at 2020-12-08 11:52:40

Pushed a tag to launch "GitHub Actions" CI:

- https://github.com/slel/sage/tree/ci-cypari2-31029
- https://github.com/slel/sage/actions?query=branch%3Aci-cypari2-31029


---

Comment by mkoeppe created at 2020-12-11 03:30:12

The builds on GH Actions look fine.

Someone else should look at the changes in the ticket -- I don't know anything about PARI.


---

Comment by mkoeppe created at 2020-12-11 03:30:22

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-27 19:27:39

Changing priority from major to critical.


---

Comment by jhpalmieri created at 2020-12-28 20:49:18

Unfortunately this does not fix my problem with OS X 10.15.7 and Python 3 installed via Homebrew:

```
  cypari2/gen.c:25980:70: error: too many arguments to function call, expected 3, have 4
    __pyx_v__ret = asympnum0(__pyx_v__expr, __pyx_v_k, __pyx_v__alpha, __pyx_v_precision);
                   ~~~~~~~~~                                           ^~~~~~~~~~~~~~~~~
  /usr/local/include/pari/paripriv.h:101:1: note: 'asympnum0' declared here
  GEN  asympnum0(GEN u, GEN alpha, long prec);
  ^
  cypari2/gen.c:30261:18: error: implicit declaration of function 'bnfcompress' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
    __pyx_v__ret = bnfcompress(__pyx_v__bnf);
                   ^
  cypari2/gen.c:30261:16: warning: incompatible integer to pointer conversion assigning to 'GEN' (aka 'long *') from 'int' [-Wint-conversion]
    __pyx_v__ret = bnfcompress(__pyx_v__bnf);
                 ^ ~~~~~~~~~~~~~~~~~~~~~~~~~
  cypari2/gen.c:84064:52: error: too few arguments to function call, expected 3, have 2
    __pyx_v__ret = lfuntwist(__pyx_v__L, __pyx_v__chi);
                   ~~~~~~~~~                         ^
  /usr/local/include/pari/paridecl.h:4164:1: note: 'lfuntwist' declared here
  GEN     lfuntwist(GEN ldata1, GEN ldata2, long bitprec);
  ^
  cypari2/gen.c:85034:70: error: too many arguments to function call, expected 3, have 4
    __pyx_v__ret = limitnum0(__pyx_v__expr, __pyx_v_k, __pyx_v__alpha, __pyx_v_precision);
                   ~~~~~~~~~                                           ^~~~~~~~~~~~~~~~~
  /usr/local/include/pari/paripriv.h:125:1: note: 'limitnum0' declared here
  GEN  limitnum0(GEN u, GEN alpha, long prec);
  ^
  cypari2/gen.c:108195:18: error: implicit declaration of function 'nfbasis_gp' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
    __pyx_v__ret = nfbasis_gp(__pyx_v__T);
                   ^
  cypari2/gen.c:108195:18: note: did you mean 'nfbasis'?
  /usr/local/include/pari/paridecl.h:2231:9: note: 'nfbasis' declared here
  GEN     nfbasis(GEN x, GEN *y);
          ^
  cypari2/gen.c:108195:16: warning: incompatible integer to pointer conversion assigning to 'GEN' (aka 'long *') from 'int' [-Wint-conversion]
    __pyx_v__ret = nfbasis_gp(__pyx_v__T);
                 ^ ~~~~~~~~~~~~~~~~~~~~~~
  cypari2/gen.c:119493:16: warning: incompatible pointer to integer conversion assigning to 'long' from 'GEN' (aka 'long *'); dereference with * [-Wint-conversion]
    __pyx_v__ret = permorder(__pyx_v__x);
                 ^ ~~~~~~~~~~~~~~~~~~~~~
                   *
  cypari2/gen.c:123101:18: error: implicit declaration of function 'isirreducible' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
    __pyx_v__ret = isirreducible(__pyx_v__pol);
                   ^
  cypari2/gen.c:123101:18: note: did you mean 'polisirreducible'?
  /usr/local/include/pari/paridecl.h:4812:9: note: 'polisirreducible' declared here
  long    polisirreducible(GEN x);
          ^
  cypari2/gen.c:131353:49: error: too few arguments to function call, expected 3, have 2
    __pyx_v__ret = qfbsolve(__pyx_v__Q, __pyx_v__p);
                   ~~~~~~~~                       ^
  /usr/local/include/pari/paridecl.h:1880:1: note: 'qfbsolve' declared here
  GEN     qfbsolve(GEN Q, GEN n, long flag);
  ^
  cypari2/gen.c:141271:69: error: too many arguments to function call, expected 3, have 4
    __pyx_v__ret = rnfkummer(__pyx_v__bnr, __pyx_v__subgp, __pyx_v_d, __pyx_v_precision);
                   ~~~~~~~~~                                          ^~~~~~~~~~~~~~~~~
  /usr/local/include/pari/paridecl.h:4110:1: note: 'rnfkummer' declared here
  GEN     rnfkummer(GEN bnr, GEN subgroup, long prec);
  ^
  cypari2/gen.c:153671:18: error: implicit declaration of function 'zetamult0' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
    __pyx_v__ret = zetamult0(__pyx_v__s, __pyx_v__T, __pyx_v_precision);
                   ^
  cypari2/gen.c:153671:18: note: did you mean 'zetamult'?
  /usr/local/include/pari/paridecl.h:5345:9: note: 'zetamult' declared here
  GEN     zetamult(GEN avec, long prec);
          ^
  cypari2/gen.c:153671:16: warning: incompatible integer to pointer conversion assigning to 'GEN' (aka 'long *') from 'int' [-Wint-conversion]
    __pyx_v__ret = zetamult0(__pyx_v__s, __pyx_v__T, __pyx_v_precision);
                 ^ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  4 warnings and 9 errors generated.
```



---

Comment by jhpalmieri created at 2020-12-28 21:24:03

Just for fun I removed all of my homebrew installations and reinstalled a subset of them (`brew install aspell autoconf automake boost ecm freetype gcc gd ghostscript glpk gmp gpatch gsl jpeg libmpc libpng libtiff libtool mpfi mpfr nauty openblas pari perl pkg-config ppl r suite-sparse yasm zeromq`). Same error.


---

Comment by mkoeppe created at 2020-12-29 05:21:30

And without `pari` from homebrew?


---

Comment by jhpalmieri created at 2020-12-29 06:42:58

With or without `pari` from homebrew, Sage builds its own `pari`, but if I do `brew uninstall pari`, then `cypari` builds successfully. Thank you, that's helpful. Can we prevent the build process from picking up the wrong `pari` somehow?


---

Comment by mkoeppe created at 2020-12-29 19:59:42

Replying to [comment:12 jhpalmieri]:
> With or without `pari` from homebrew, Sage builds its own `pari`, but if I do `brew uninstall pari`, then `cypari` builds successfully. Thank you, that's helpful. Can we prevent the build process from picking up the wrong `pari` somehow?

This is now #31132.


---

Comment by dimpase created at 2020-12-30 00:45:27

How about biting the bullet and adding the missing Pari parts (i.e. Pari packages) to Homebrew?


---

Comment by jhpalmieri created at 2020-12-30 00:57:59

Unless I'm misunderstanding, that might fix the symptom but not the actual problem. If we go that direction and we don't address the problem of /usr/local leaking into the build, then we have to detect whether all of the relevant pieces of pari are installed in homebrew or none of them are, and refuse to continue if the system is some intermediate state (like mine with `pari` installed but none of the as yet non-existent packages).


---

Comment by dimpase created at 2020-12-31 00:34:17

Replying to [comment:15 jhpalmieri]:
> Unless I'm misunderstanding, that might fix the symptom but not the actual problem. If we go that direction and we don't address the problem of /usr/local leaking into the build, then we have to detect whether all of the relevant pieces of pari are installed in homebrew or none of them are, and refuse to continue if the system is some intermediate state (like mine with `pari` installed but none of the as yet non-existent packages).

you're right, that's what can be done. (Realistically though, once it's in place, people would just install the whole bunch - one can also have a Sage-components formula to install as many deps as there are)


---

Comment by mkoeppe created at 2021-01-06 19:54:03

Contributing to homebrew packaging is beyond the scope of this ticket.

Still needs review


---

Comment by jhpalmieri created at 2021-01-08 00:17:49

Why remove the doctest

```
sage: b[0][0].precision()    # in words
```

?


---

Comment by vdelecroix created at 2021-01-08 09:05:22

Replying to [comment:18 jhpalmieri]:
> Why remove the doctest
> {{{
> sage: b[0][0].precision()    # in words
> }}}
> ?

https://github.com/sagemath/cypari2/commit/8bd7ca38462742a80829a71bb0ae4279c56ead97


---

Comment by jhpalmieri created at 2021-01-08 17:34:21

Great. Let's merge this.


---

Comment by jhpalmieri created at 2021-01-08 17:34:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-01-17 13:46:17

Resolution: fixed
