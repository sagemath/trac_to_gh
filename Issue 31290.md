# Issue 31290: spkg-configure.m4 for polymake

Issue created by migration from https://trac.sagemath.org/ticket/31527

Original creator: mkoeppe

Original creation time: 2021-03-20 04:55:42

CC:  vdelecroix jipilab @kliem paffenholz@opt.tu-darmstadt.de arojas dimpase mjo

Polymake is available on a number of systems (https://repology.org/project/polymake/versions) and also on Homebrew via a custom tap: https://polymake.org/doku.php/download/start#binary_releases

We add system package info and `spkg-configure.m4`


---

Comment by mkoeppe created at 2021-03-20 06:10:02

New commits:


---

Comment by mkoeppe created at 2021-03-20 06:35:33

With polymake from Andreas's tap, need to do `export PERL5LIB="/usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5/darwin-thread-multi-2level:/usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5"` (this is done in the `polymake` script but we use the callable library through jupymake)


---

Comment by git created at 2021-03-20 06:40:02

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-20 07:09:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-20 07:50:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-20 16:55:04

Replying to [comment:3 mkoeppe]:
> With polymake from Andreas's tap, need to do `export PERL5LIB="/usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5/darwin-thread-multi-2level:/usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5"` (this is done in the `polymake` script but we use the callable library through jupymake)

Setting this globally unfortunately breaks autotools (`aclocal`) from homebrew:

```
Usage: DynaLoader::dl_find_symbol(libhandle, symbolname) at /usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5/darwin-thread-multi-2level/XSLoader.pm line 89.
Compilation failed in require at /usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5/File/Path.pm line 6.
BEGIN failed--compilation aborted at /usr/local/Cellar/polymake/4.3_1/libexec/perl5/lib/perl5/File/Path.pm line 6.
Compilation failed in require at /usr/local/bin/aclocal line 33.
BEGIN failed--compilation aborted at /usr/local/bin/aclocal line 33.
```

Too bad that `polymake-config` does not advertise the necessary Perl library path...


---

Comment by git created at 2021-03-20 21:41:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2021-04-12 23:40:56

Saving the continuation:

JuPyMake/JuPyMake.cpp at master · sebasguts/JuPyMake
https://github.com/sebasguts/JuPyMake/blob/master/JuPyMake.cpp

jupyter-polymake/kernel.py at master · polymake/jupyter-polymake
https://github.com/polymake/jupyter-polymake/blob/master/jupyter_kernel_polymake/kernel.py

jupyter-kernel-polymake · PyPI
https://pypi.org/project/jupyter-kernel-polymake/

Failed to install on OSX Mojave Mac::SystemDirectory is not installed. · Issue #39 · sqitchers/homebrew-sqitch
https://github.com/sqitchers/homebrew-sqitch/issues/39

tokuhirom/plenv: Perl binary manager
https://github.com/tokuhirom/plenv

polymake Downloads [polymake wiki]
https://polymake.org/doku.php/download/start


---

Comment by mkoeppe created at 2021-04-12 23:41:20

Perlbrew
https://perlbrew.pl/

gugod/App-perlbrew: Manage perl installations in your $HOME
https://github.com/gugod/App-perlbrew

App::perlbrew - Manage perl installations in your $HOME - metacpan.org
https://metacpan.org/pod/App::perlbrew

polymake Downloads [polymake wiki]
https://polymake.org/doku.php/download/start#binary_releases

perl:mongodb package versions - Repology
https://repology.org/project/perl:mongodb/versions


---

Comment by git created at 2021-05-18 01:06:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-10-08 16:23:53

Replying to [comment:3 mkoeppe]:
> With polymake from Andreas's tap, need to do `export PERL5LIB="[...]"` (this is done in the `polymake` script but we use the callable library through jupymake)

Fixed in latest version of the homebrew formula according to https://github.com/polymake/polybundle/issues/19#issuecomment-938612849


---

Comment by git created at 2021-10-08 16:51:29

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-10-08 21:05:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-10-08 21:20:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-08 21:21:36

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-08 21:22:02

Tested successfully on homebrew


---

Comment by mkoeppe created at 2021-10-09 00:15:29

Testing with `tox -e docker-ubuntu-groovy-maximal`, where `configure` accepts system polymake 4.1-4build1, gives many doctest failures of the form:

```
      File "/sage/local/lib/python3.8/site-packages/sage/interfaces/polymake.py", line 2598, in _start
        InitializePolymake()          # Can only be called once
    JuPyMake.PolymakeError: polymake::Main - /usr/lib/polymake/shared is not a symlink
```

Indeed: 

```
ls -l /usr/lib/polymake/
total 12
-rw-r--r-- 1 root root 2024 Aug 17  2020 config.ninja
drwxr-xr-x 2 root root 4096 Oct  8 21:18 lib
drwxr-xr-x 3 root root 4096 Oct  8 21:18 perlx
```



---

Comment by mkoeppe created at 2021-10-09 00:17:51

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-10-09 00:17:51

... so clearly we need to extend `spkg-configure.m4` to test that libpolymake has not been debianized to death


---

Comment by git created at 2021-10-09 00:48:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-09 00:49:05

Now correctly rejects polymake on this system (`tox -e docker-ubuntu-groovy-maximal -- config.status`)


---

Comment by mkoeppe created at 2021-10-09 00:58:27

Same on `ubuntu-impish-maximal` (with system polymake 4.3)


---

Comment by mkoeppe created at 2021-10-09 01:36:30

On `fedora-34-maximal`:

```
configure:34443: checking whether libpolymake works
configure:34479: g++ -o conftest  -I/usr/include/polymake/external -I/usr/include/arb -I/usr/include/eigen3 -I/usr/include/gfanlib -I/usr/include/nauty -I/usr/include -I/usr/include -DPOLYMAKE_VERSION=404 -fPIC -pipe -O2 -flto=auto -ffat-lto-objects -fexceptions -g -grecord-gcc-switches -pipe -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wno-unused-local-typedefs -std=c++14 -ftemplate-depth-200 -fno-strict-aliasing -fopenmp -Wshadow -Wlogical-op -Wconversion -Wzero-as-null-pointer-constant -Wno-parentheses -Wno-error=unused-function -Wno-stringop-overflow -Wno-array-bounds -Wno-maybe-uninitialized -Wno-free-nonheap-object -DPOLYMAKE_WITH_FLINT -O2 -DPOLYMAKE_DEBUG=0   -Dlinux   -I/usr/include -lpolymake -Wl,-z,relro -Wl,--as-needed -lnormaliz -ldl -fuse-ld=gold -fopenmp -L/usr/lib64 -Wl,-E  conftest.cpp -lmpfi -lmpc -lm4rie -llrcalc -lnauty -lhomfly -liml -lgiac -lecm -lpari -lcurl -lcliquer -lcddgmp -lbz2 -lflint -lmpfr -lglpk -lgmp -lm  -lntl -lLfunction >&5
cc1plus: error: '-Wformat-security' ignored without '-Wformat' [-Werror=format-security]
cc1plus: some warnings being treated as errors
```



---

Comment by mkoeppe created at 2021-10-09 02:07:08

Same on `fedora-35-maximal`

So system polymake is rejected. This is correct because building jupymake would fail with the same error.


---

Comment by git created at 2021-10-09 02:39:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-09 02:49:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-09 03:13:42

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-12 09:46:32

needs a rebase


---

Comment by git created at 2021-10-12 17:08:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-10-12 20:04:12

gentoo's polymake is too old atm, it's 3.0_p2 there (and broken).


---

Comment by git created at 2021-10-12 21:02:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-19 22:11:25

Let's get this in please


---

Comment by dimpase created at 2021-10-20 10:44:36

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-10-20 10:44:36

fails to recognize polymake on Fedora 34 with polymake package installed, due to
`-Werror=format-security` in `g++` call from `./configure`.


```
configure:36908: checking for polymake-config >= 3.5
configure:36984: result: /usr/bin/polymake-config
configure:36989: checking whether libpolymake works
configure:37025: g++ -o conftest  -I/usr/include/polymake/external -I/usr/include/arb -I/usr/include/eigen3 -I/usr/include/gfanlib -I/usr/include/nauty -I/usr/include -I/usr/include -DPOLYMAKE_VERSION=404 -fPIC -pipe -O2 -flto=auto -ffat-lto-objects -fexceptions -g -grecord-gcc-switches -pipe -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wno-unused-local-typedefs -std=c++14 -ftemplate-depth-200 -fno-strict-aliasing -fopenmp -Wshadow -Wlogical-op -Wconversion -Wzero-as-null-pointer-constant -Wno-parentheses -Wno-error=unused-function -Wno-stringop-overflow -Wno-array-bounds -Wno-maybe-uninitialized -Wno-free-nonheap-object -DPOLYMAKE_WITH_FLINT -O2 -DPOLYMAKE_DEBUG=0   -Dlinux   -I/usr/include -lpolymake -Wl,-z,relro -Wl,--as-needed -lnormaliz -ldl -fuse-ld=gold -fopenmp -L/usr/lib64 -Wl,-E  conftest.cpp -lmpfi -lmpc -lm4rie -llrcalc -lnauty -lhomfly -liml -lgiac -lecm -lpari -lcurl -lcliquer -lcddgmp -lbz2 -lflint -lmpfr -lglpk -lgmp -lm  -lntl -lLfunction >&5
cc1plus: error: '-Wformat-security' ignored without '-Wformat' [-Werror=format-security]
cc1plus: some warnings being treated as errors
```


And `Werror` gets there from `polymake-config --cflags` call.

```
$ polymake-config --cflags
-DPOLYMAKE_VERSION=404 -fPIC -pipe -O2 -flto=auto -ffat-lto-objects -fexceptions -g -grecord-gcc-switches -pipe -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wno-unused-local-typedefs -std=c++14 -ftemplate-depth-200 -fno-strict-aliasing -fopenmp -Wshadow -Wlogical-op -Wconversion -Wzero-as-null-pointer-constant -Wno-parentheses -Wno-error=unused-function -Wno-stringop-overflow -Wno-array-bounds -Wno-maybe-uninitialized -Wno-free-nonheap-object -DPOLYMAKE_WITH_FLINT -O2 -DPOLYMAKE_DEBUG=0
```



---

Comment by dimpase created at 2021-10-20 13:52:59

If I clean up CPPFLAGS as follows

```diff
--- a/build/pkgs/polymake/spkg-configure.m4
+++ b/build/pkgs/polymake/spkg-configure.m4
@@ -20,6 +20,7 @@ SAGE_SPKG_CONFIGURE([polymake], [
            saved_LDFLAGS="$LDFLAGS"
            CXX="$($ac_cv_path_POLYMAKE_CONFIG --cc)"
            CPPFLAGS="$($ac_cv_path_POLYMAKE_CONFIG --includes) $($ac_cv_path_POLYMAKE_CONFIG --cflags) $CPPFLAGS"
+           CPPFLAGS=${CPPFLAGS//\-Werror=format\-security/}
            LDFLAGS="-lpolymake $($ac_cv_path_POLYMAKE_CONFIG --ldflags) $LDFLAGS"
            AC_RUN_IFELSE([AC_LANG_PROGRAM([[
                #include <polymake/Main.h>
```

 then I still get



```
configure:36989: checking whether libpolymake works
configure:37026: g++ -o conftest  -I/usr/include/polymake/external -I/usr/include/arb -I/usr/include/eigen3 -I/usr/include/gfanlib -I/usr/include/nauty -I/usr/include -I/usr/include -DPOLYMAKE_VERSION=404 -fPIC -pipe -O2 -flto=auto -ffat-lto-objects -fexceptions -g -grecord-gcc-switches -pipe  -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wno-unused-local-typedefs -std=c++14 -ftemplate-depth-200 -fno-strict-aliasing -fopenmp -Wshadow -Wlogical-op -Wconversion -Wzero-as-null-pointer-constant -Wno-parentheses -Wno-error=unused-function -Wno-stringop-overflow -Wno-array-bounds -Wno-maybe-uninitialized -Wno-free-nonheap-object -DPOLYMAKE_WITH_FLINT -O2 -DPOLYMAKE_DEBUG=0   -Dlinux   -I/usr/include -lpolymake -Wl,-z,relro -Wl,--as-needed -lnormaliz -ldl -fuse-ld=gold -fopenmp -L/usr/lib64 -Wl,-E  conftest.cpp -lmpfi -lmpc -lm4rie -llrcalc -lnauty -lhomfly -liml -lgiac -lecm -lpari -lcurl -lcliquer -lcddgmp -lbz2 -lflint -lmpfr -lglpk -lgmp -lm  -lntl -lLfunction >&5
configure:37026: $? = 0
configure:37026: ./conftest
Can't locate Polymake/Main.pm in @INC (you may need to install the Polymake::Main module) (@INC contains: /share/polymake/perllib /lib64/polymake/perlx/5.32.1/x86_64-linux-thread-multi /lib64/polymake/perlx/5.32.1 /lib64/polymake/perlx /users/dimpase/perl5/lib/perl5/x86_64-linux-thread-multi /users/dimpase/perl5/lib/perl5 /usr/local/lib64/perl5/5.32 /usr/local/share/perl5/5.32 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5) at /builddir/build/BUILD/polymake-4.4/lib/callable/src/perl/Main.cc line 146.
BEGIN failed--compilation aborted at /builddir/build/BUILD/polymake-4.4/lib/callable/src/perl/Main.cc line 146.
terminate called after throwing an instance of 'std::runtime_error'
  what():  could not initialize the perl interpreter
./configure: line 3495: 1808668 Aborted                 (core dumped) ./conftest$ac_exeext
configure:37026: $? = 134
configure: program exited with status 134
```



---

Comment by mkoeppe created at 2021-10-20 15:49:29

Replying to [comment:44 dimpase]:
> fails to recognize polymake on Fedora 34 with polymake package installed, due to
> `-Werror=format-security` in `g++` call from `./configure`.

Yes, see comment:33.


---

Comment by mkoeppe created at 2021-10-20 15:49:57

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-21 16:55:01

Changing component from packages: optional to build: configure.


---

Comment by dimpase created at 2021-10-21 17:36:46

Is there any Linux distro with working for the purposes of this ticket Polymake package?


---

Comment by mkoeppe created at 2021-10-21 17:42:49

I don't remember if I tested with `arch`, `opensuse`, or `nix`.


---

Comment by arojas created at 2021-10-21 20:36:23

Changing status from needs_review to positive_review.


---

Comment by arojas created at 2021-10-21 20:36:23

Works fine on Arch. Picks up system polymake, Jupymake spkg installs correctly and all tests pass in `interfaces.polymake`


---

Comment by mkoeppe created at 2021-10-21 20:45:50

Thanks!


---

Comment by @sheerluck created at 2021-10-21 21:03:58

Replying to [comment:50 dimpase]:
> Is there any Linux distro with working for the purposes of this ticket Polymake package?
>
Gentoo with https://github.com/gentoo/gentoo/pull/17925

```
sage -t --long --random-seed=0 src/sage/interfaces/polymake.py
    [54 tests, 0.63 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.7 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 0.6 seconds
Traceback (most recent call last):
  File "/usr/lib/python-exec/python3.10/sage-runtests", line 159, in <module>
    exit_code_pytest = pytest.main(pytest_options + args)
TypeError: can only concatenate list (not "Namespace") to list
```



---

Comment by mkoeppe created at 2021-10-21 23:14:04

Excellent!


---

Comment by dimpase created at 2021-10-22 08:57:25

The present branch appears to need `polymake` explictly listed in the list `--optional=`, if it's not installed. On arch I have:

```
$ ./sage -tp  src/sage/geometry/polyhedron/backend_polymake.py
Running doctests with ID 2021-10-22-08-52-35-89300609.
Git branch: wip
Using --optional=arch,argcomplete,build,dochtml,jupymake,pip,sage,sage.rings.real_double,sage_spkg
Doctesting 1 file using 4 threads.
sage -t --warn-long 105.2 --random-seed=111795974516996210666725135263478181348 src/sage/geometry/polyhedron/backend_polymake.py
    [9 tests, 0.52 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.6 seconds
    cpu time: 0.5 seconds
    cumulative wall time: 0.5 seconds
Pytest is not installed, skip checking tests that rely on it.
```

but

```
$ ./sage -tp --optional=arch,argcomplete,build,dochtml,pip,sage,sage.rings.real_double,sage_spkg,polymake src/sage/geometry/polyhedron/backend_polymake.py
Running doctests with ID 2021-10-22-08-52-45-3599c25d.
Git branch: wip
Using --optional=arch,argcomplete,build,dochtml,pip,polymake,sage,sage.rings.real_double,sage_spkg
Doctesting 1 file using 4 threads.
sage -t --warn-long 105.2 --random-seed=65107005796673777637867553513561507930 src/sage/geometry/polyhedron/backend_polymake.py
**********************************************************************
File "src/sage/geometry/polyhedron/backend_polymake.py", line 665, in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake.__setstate__
Failed example:
    print("Possible output"); P = polytopes.dodecahedron(backend='polymake')  # optional - polymake
Exception raised:
    Traceback (most recent call last):
      File "/home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/interface.py", line 732, in __init__
        self._name = parent._create(value, name=name)
      File "/home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/polymake.py", line 549, in _create
        self.set(name, value)
      File "/home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/polymake.py", line 638, in set
        self.eval(cmd)
      File "/home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/polymake.py", line 2712, in eval
        raise PolymakeError(error)
    sage.interfaces.polymake.PolymakeError: C++/perl Interface module compilation failed; most likely due to a type mismatch.
    Set the variable $Polymake::User::Verbose::cpp to a positive value and repeat for more details.


    During handling of the above exception, another exception occurred:
...
   TypeError: C++/perl Interface module compilation failed; most likely due to a type mismatch.
    Set the variable $Polymake::User::Verbose::cpp to a positive value and repeat for more details.

**********************************************************************
1 item had failures:
   1 of  21 in sage.geometry.polyhedron.backend_polymake.Polyhedron_polymake.__setstate__
    [106 tests, 1 failure, 13.32 s]
----------------------------------------------------------------------
sage -t --warn-long 105.2 --random-seed=65107005796673777637867553513561507930 src/sage/geometry/polyhedron/backend_polymake.py  # 1 doctest failed
```


there is a similar test failure in `src/sage/geometry/polyhedron/base.py`


---

Comment by dimpase created at 2021-10-22 09:00:43

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2021-10-22 09:00:43

We see that tests mentioned in comment:54 were not complete, as `polymake` was not in `--optional=` - if it were, we'd see many more tests (this is on Arch, again):

```
$ ./sage -tp --optional=arch,argcomplete,build,dochtml,pip,sage,sage.rings.real_double,sage_spkg,polymake src/sage/interfaces/polymake.py                 
Running doctests with ID 2021-10-22-08-58-24-8cc8a0d8.
Git branch: wip
Using --optional=arch,argcomplete,build,dochtml,pip,polymake,sage,sage.rings.real_double,sage_spkg
Doctesting 1 file using 4 threads.
sage -t --warn-long 105.2 --random-seed=106731483408083137921384584724619392983 src/sage/interfaces/polymake.py
    [253 tests, 5.28 s]
----------------------------------------------------------------------
All tests passed!
```



---

Comment by dimpase created at 2021-10-22 09:15:46

`jupymake` should be in `build/pkgs/polymake/dependencies`, as `polymake` tests fail if it's not installed.

As well, `spkg-configure.m4` perhaps needs to at least print a warning if system's polymake it selected, or, better, use some (missing?) mechanism to trigger installation of `jupymake` in this case.


---

Comment by @sheerluck created at 2021-10-22 11:24:21

Replying to [comment:57 dimpase]:
> we'd see many more tests (this is on Arch, again):
>     [253 tests, 5.28 s]
yes, with that long `--optional=` I see all 253 tests passed too (on Gentoo)


---

Comment by mkoeppe created at 2021-10-22 15:15:31

Replying to [comment:58 dimpase]:
> `jupymake` should be in `build/pkgs/polymake/dependencies`, as `polymake` tests fail if it's not installed.

No, this makes no sense. `jupymake` depends (at compile time) on `polymake`.


---

Comment by mkoeppe created at 2021-10-22 15:16:57

Replying to [comment:58 dimpase]:
>  use some (missing?) mechanism to trigger installation of `jupymake` in this case.

This is a valid wishlist item.


---

Comment by dimpase created at 2021-10-22 16:45:42

then tag jupymake-dependent tests as such.


---

Comment by mkoeppe created at 2021-10-22 17:14:26

The failure in comment:56, 

```
   TypeError: C++/perl Interface module compilation failed; most likely due to a type mismatch.
    Set the variable $Polymake::User::Verbose::cpp to a positive value and repeat for more details.
```

has got nothing to do with jupymake vs. the polymake pexpect interface.

Looks to me like a packaging bug in arch.


---

Comment by mkoeppe created at 2021-10-22 17:52:52

Replying to [comment:61 mkoeppe]:
> Replying to [comment:58 dimpase]:
> >  use some (missing?) mechanism to trigger installation of `jupymake` in this case.
> 
> This is a valid wishlist item.

I have opened #32741 for this.


---

Comment by mjo created at 2021-10-23 01:08:37

Replying to [comment:41 dimpase]:
> gentoo's polymake is too old atm, it's 3.0_p2 there (and broken).

I've just updated it to polymake-4.5. Send bug reports if it's still broken.


---

Comment by mkoeppe created at 2021-10-23 01:27:52

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-23 09:20:33

Replying to [comment:64 mkoeppe]:
> Replying to [comment:61 mkoeppe]:
> > Replying to [comment:58 dimpase]:
> > >  use some (missing?) mechanism to trigger installation of `jupymake` in this case.
> > 
> > This is a valid wishlist item.
> 
> I have opened #32741 for this.

I explained there to how to fix this in this particular case - with jupymake getting spkg-configure.m4


---

Comment by @sheerluck created at 2021-10-23 09:32:52

I hope #32741 is not preventing this ticket to get positive review. I mean all 253 tests passed on several systems.


---

Comment by dimpase created at 2021-10-23 09:35:30

well, the reason for not giving it a positive review are doctests failing due to accidentally not having jupymake installed, which is not forced now.


---

Comment by mkoeppe created at 2021-10-23 14:58:03

Dima, comment:63 -- since you tested on arch, could you please investigate the failure mode?  These doctests are NOT dependent on jupymake.


---

Comment by mkoeppe created at 2021-10-31 21:36:47

Let's move this forward please


---

Comment by dimpase created at 2021-10-31 21:59:47

Replying to [comment:65 mjo]:
> Replying to [comment:41 dimpase]:
> > gentoo's polymake is too old atm, it's 3.0_p2 there (and broken).
> 
> I've just updated it to polymake-4.5. Send bug reports if it's still broken.

```
# emerge --ask polymake

These are the packages that would be merged, in order:

Calculating dependencies -

!!! Problem resolving dependencies for sci-mathematics/polymake             ... done!

!!! The ebuild selected to satisfy "polymake" has unmet requirements.
- sci-mathematics/polymake-4.5::gentoo USE="cdd flint normaliz -bliss -libpolymake -lrs -nauty -ppl -singular"

  The following REQUIRED_USE flag constraints are unsatisfied:
    exactly-one-of ( bliss nauty )

```



---

Comment by dimpase created at 2021-10-31 22:06:29

Replying to [comment:71 mkoeppe]:
> Let's move this forward please
sorry, my arch lxc vm is gone (I guess I forgot to make it persistent?). Let me try "native" Gentoo instead.


---

Comment by mkoeppe created at 2021-10-31 22:11:28

Time to work on #29283 (tox.ini: Add test environments using LXC)


---

Comment by dimpase created at 2021-10-31 22:35:21

Replying to [comment:72 dimpase]:
> Replying to [comment:65 mjo]:
> > Replying to [comment:41 dimpase]:
> > > gentoo's polymake is too old atm, it's 3.0_p2 there (and broken).
> > 
> > I've just updated it to polymake-4.5. Send bug reports if it's still broken.


```
USE="cdd flint normaliz libpolymake lrs nauty ppl singular" emerge --ask polymake
```

doesn't work, there is a problem with `lrs` (and Sage installs `polymake` with `lrs`)
Apparently, it's known to Sage, as `spkg-install.in` has a comment:

```
# Since polymake v3.4, it does not find our lrs installation if we do not provide --with-lrs explicitly.
```


Once this is fixed in Gentoo (sorry, I don't grok its ebuilds), `distros/gentoo.txt` should be provided (with appropriate `[..]` options?).


---

Comment by mjo created at 2021-10-31 22:55:52

Replying to [comment:72 dimpase]:
> {{{
> 
>   The following REQUIRED_USE flag constraints are unsatisfied:
>     exactly-one-of ( bliss nauty )
> 
> }}}

You have to set `USE=bliss` or `USE=nauty`, but not both, to pick a backend for graph automorphism computations.


---

Comment by dimpase created at 2021-10-31 22:59:00

Replying to [comment:76 mjo]:
> Replying to [comment:72 dimpase]:
> > {{{
> > 
> >   The following REQUIRED_USE flag constraints are unsatisfied:
> >     exactly-one-of ( bliss nauty )
> > 
> > }}}
> 
> You have to set `USE=bliss` or `USE=nauty`, but not both, to pick a backend for graph automorphism computations.

sure, but the default `USE` flags shouldn't fail! As well, how about `lrs`?


---

Comment by mjo created at 2021-10-31 23:07:14

Replying to [comment:77 dimpase]:
> 
> sure, but the default `USE` flags shouldn't fail! As well, how about `lrs`?

They don't "fail," portage tells you to pick one because you have to pick one =P

If one is a significantly better choice than the other, we would normally enable that one by default, but I don't know enough about polymake to say that either is better.

What's wrong with lrs?


---

Comment by dimpase created at 2021-10-31 23:39:30


```
USE="cdd flint normaliz libpolymake lrs nauty ppl singular" emerge --ask polymake

These are the packages that would be merged, in order:

Calculating dependencies... done!
[ebuild   R    ] sci-mathematics/polymake-4.5  USE="lrs*" 

Would you like to merge these packages? [Yes/No] 

>>> Verifying ebuild manifests

>>> Emerging (1 of 1) sci-mathematics/polymake-4.5::gentoo
 * polymake-4.5-minimal.tar.bz2 BLAKE2B SHA512 size ;-) ...            [ ok ]
>>> Unpacking source...
>>> Unpacking polymake-4.5-minimal.tar.bz2 to /var/tmp/portage/sci-mathematics/polymake-4.5/work
>>> Source unpacked in /var/tmp/portage/sci-mathematics/polymake-4.5/work
>>> Preparing source in /var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5 ...
>>> Source prepared.
>>> Configuring source in /var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5 ...
checking C++ compiler ... ok (x86_64-pc-linux-gnu-g++ is GCC 8.3.1)
checking C++ library ... ok (GNU libstdc++ 20190518, C++ 201402)
determining architecture ... ok (x86_64)
determining compiler flags ... ok
   CFLAGS=-march=native -O3 -fomit-frame-pointer -pipe
   CXXFLAGS=-march=native -O3 -fomit-frame-pointer -pipe -std=c++14 -ftemplate-depth-200 -fno-strict-aliasing -fopenmp -Wshadow -Wlogical-op -Wconversion -Wzero-as-null-pointer-constant -Wno-parentheses -Wno-error=unused-function
   LDFLAGS=-Wl,-O1 -Wl,--as-needed -fuse-ld=gold -fopenmp
checking gmp installation ... ok
checking mpfr installation ... ok
checking boost installation ... ok
checking perl module XML::SAX ... ok
checking perl module Term::ReadKey ... ok
checking perl module Term::ReadLine ... ok
checking perl module JSON ... ok
checking shared perl library ... ok

Configuring bundled extensions:
bundled extension java ... disabled by command-line
bundled extension javaview ... disabled by command-line
bundled extension scip ... disabled by command-line
bundled extension soplex ... disabled by command-line
bundled extension bliss ... disabled by command-line
bundled extension cdd ... ok (0.94m @ /usr)
bundled extension flint ... ok (ok (2.7.1 @ /usr))
bundled extension libnormaliz ... ok (3.8.1 @ /usr)
bundled extension lrs ... failed

ERROR:
The bundled extension lrs was explicitly requested but failed to configure.
Please recheck your argument (--with-lrs=/usr) and build/bundled.log .
You can also disable it by specifying --without-lrs instead.
 * ERROR: sci-mathematics/polymake-4.5::gentoo failed (configure phase):
 *   (no error message)
 * 
 * Call stack:
 *     ebuild.sh, line 127:  Called src_configure
 *   environment, line 1598:  Called die
 * The specific snippet of code:
 *       ./configure --prefix="${EPREFIX}/usr" --libdir="${EPREFIX}/usr/$(get_libdir)" --libexecdir="${EPREFIX}/usr/$(get_libdir)/polymake" $(usev !libpolymake "--without-callable") --without-java --without-javaview --without-native --without-scip --without-soplex $(use_with bliss bliss "${EPREFIX}/usr") $(use_with cdd cdd "${EPREFIX}/usr") $(use_with flint flint "${EPREFIX}/usr") $(use_with lrs lrs "${EPREFIX}/usr") $(use_with nauty nauty "${EPREFIX}/usr") $(use_with normaliz libnormaliz "${EPREFIX}/usr") $(use_with ppl ppl "${EPREFIX}/usr") $(use_with singular singular "${EPREFIX}/usr") || die
 * 
 * If you need support, post the output of `emerge --info '=sci-mathematics/polymake-4.5::gentoo'`,
 * the complete build log and the output of `emerge -pqv '=sci-mathematics/polymake-4.5::gentoo'`.
 * The complete build log is located at '/var/tmp/portage/sci-mathematics/polymake-4.5/temp/build.log'.
 * The ebuild environment file is located at '/var/tmp/portage/sci-mathematics/polymake-4.5/temp/environment'.
 * Working directory: '/var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5'
 * S: '/var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5'

>>> Failed to emerge sci-mathematics/polymake-4.5, Log file:

>>>  '/var/tmp/portage/sci-mathematics/polymake-4.5/temp/build.log'

 * Messages for package sci-mathematics/polymake-4.5:

 * ERROR: sci-mathematics/polymake-4.5::gentoo failed (configure phase):
 *   (no error message)
 * 
 * Call stack:
 *     ebuild.sh, line 127:  Called src_configure
 *   environment, line 1598:  Called die
 * The specific snippet of code:
 *       ./configure --prefix="${EPREFIX}/usr" --libdir="${EPREFIX}/usr/$(get_libdir)" --libexecdir="${EPREFIX}/usr/$(get_libdir)/polymake" $(usev !libpolymake "--without-callable") --without-java --without-javaview --without-native --without-scip --without-soplex $(use_with bliss bliss "${EPREFIX}/usr") $(use_with cdd cdd "${EPREFIX}/usr") $(use_with flint flint "${EPREFIX}/usr") $(use_with lrs lrs "${EPREFIX}/usr") $(use_with nauty nauty "${EPREFIX}/usr") $(use_with normaliz libnormaliz "${EPREFIX}/usr") $(use_with ppl ppl "${EPREFIX}/usr") $(use_with singular singular "${EPREFIX}/usr") || die
 * 
 * If you need support, post the output of `emerge --info '=sci-mathematics/polymake-4.5::gentoo'`,
 * the complete build log and the output of `emerge -pqv '=sci-mathematics/polymake-4.5::gentoo'`.
 * The complete build log is located at '/var/tmp/portage/sci-mathematics/polymake-4.5/temp/build.log'.
 * The ebuild environment file is located at '/var/tmp/portage/sci-mathematics/polymake-4.5/temp/environment'.
 * Working directory: '/var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5'
 * S: '/var/tmp/portage/sci-mathematics/polymake-4.5/work/polymake-4.5'
hilbert /tmp # 

```


I guess one needs to do what's done in `spkg-install` to pass the `lrs` prefix more explicitly.


---

Comment by mjo created at 2021-11-01 00:07:36

> I guess one needs to do what's done in spkg-install to pass the lrs prefix more explicitly. 

You may need to upgrade to lrslib-071b or lrslib-071b-r1. Those versions (I added them to the tree along with polymake-4.5) fix a critical bug in v071. I don't know if v062 works because it doesn't even build anymore. Comically, we can't remove it though because it's "stable" and no one has stabilized v071b on x86 yet.


---

Comment by dimpase created at 2021-11-01 09:07:13

Replying to [comment:80 mjo]:
> > I guess one needs to do what's done in spkg-install to pass the lrs prefix more explicitly. 
> 
> You may need to upgrade to lrslib-071b or lrslib-071b-r1. Those versions (I added them to the tree along with polymake-4.5) fix a critical bug in v071. I don't know if v062 works because it doesn't even build anymore. Comically, we can't remove it though because it's "stable" and no one has stabilized v071b on x86 yet.

This does not take away the problem that polymake's configure fails, I cannot imagine it's due to lrs's version.


---

Comment by dimpase created at 2021-11-01 09:10:44

Oops, I take it back - lrslib-071b-r1 allows configure to pass.

I don't know whether Gentoo has such a flexibility in configurations, but ideally it should refuse to even start building with an old lrs version.


---

Comment by dimpase created at 2021-11-01 13:56:49

but I still have bad news, in Gentoo case in particular, but also
in general. Perl's MongoDB module is at EOL.

```
# emerge dev-perl/MongoDB
Calculating dependencies... done!

!!! All ebuilds that could satisfy "dev-perl/MongoDB" have been masked.
!!! One of the following masked packages is required to complete your request:
- dev-perl/MongoDB-1.8.0::gentoo (masked by: package.mask)
/usr/portage/profiles/package.mask:
# Sam James <sam@gentoo.org> (2021-10-25)
# Fails to build with glibc-2.30(!) and was abandoned upstream
# a few years ago. No reverse dependencies in tree.
# bug #728556. Removal on 2021-11-25.


For more information, see the MASKED PACKAGES section in the emerge
man page or refer to the Gentoo Handbook.
```

https://packages.gentoo.org/packages/dev-perl/MongoDB mentions version 2.2.2, and
https://metacpan.org/dist/MongoDB says

```
 Changes for version v2.2.2 - 2020-08-13

    !!! END OF LIFE NOTICE !!!
        As of August 13, 2020, the MongoDB Perl driver has reached end of life and is no longer supported by MongoDB.

```



---

Comment by dimpase created at 2021-11-01 14:01:52

Shouldn't `perl_cpan_polymake_prereq` (and other deps?) be in `SAGE_SPKG_DEPCHECK` for polymake?


---

Comment by @sheerluck created at 2021-11-01 14:32:58

MongoDB cannot deprive this ticket of positive review


---

Comment by dimpase created at 2021-11-01 14:35:58

We should check that `polymake` is working, not only `polymake-config`.
(As some Perl deps might be broken - e.g. I ran into

```
$ polymake
Welcome to polymake version 4.5
Copyright (c) 1997-2021
Ewgenij Gawrilow, Michael Joswig, and the polymake team
Technische Universität Berlin, Germany
https://polymake.org

This is free software licensed under GPL; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Loading applications now...polymake:  ERROR: "/usr/share/polymake/apps/common/perllib/PolyDB.pm", line 23: Can't locate MongoDB.pm in @INC (you may need to install the MongoDB module) (@INC contains: Polymake::Core::Application=ARRAY(0x5589c39eea50) /usr/share/polymake/perllib /usr/lib64/polymake/perlx/5.34.0/x86_64-linux-thread-multi /usr/lib64/polymake/perlx/5.34.0 /usr/lib64/polymake/perlx /etc/perl /usr/local/lib64/perl5/5.34/x86_64-linux-thread-multi /usr/local/lib64/perl5/5.34 /usr/lib64/perl5/vendor_perl/5.34/x86_64-linux-thread-multi /usr/lib64/perl5/vendor_perl/5.34 /usr/lib64/perl5/5.34/x86_64-linux-thread-multi /usr/lib64/perl5/5.34 /usr/lib64/perl5/5.32 /usr/lib64/perl5/vendor_perl/5.32 /usr/lib64/perl5/vendor_perl/5.30.3 /usr/lib64/perl5/vendor_perl/5.30.0)
```



---

Comment by dimpase created at 2021-11-01 14:38:47

I was able to install the missing perl module on Gentoo by doing as root

```
# emerge App-cpanminus
# cpanm MongoDB
```


this needs another ticket.


---

Comment by dimpase created at 2021-11-01 14:54:10

Please see #32808 for Perl MongoDB package/spkg issues.


---

Comment by dimpase created at 2021-11-01 14:55:49

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-01 15:51:56

See also #31830 (`perl_cpan_polymake_prereq`: Update install instructions).


---

Comment by mkoeppe created at 2021-11-01 15:56:28

Replying to [comment:84 dimpase]:
> Shouldn't `perl_cpan_polymake_prereq` (and other deps?) be in `SAGE_SPKG_DEPCHECK` for polymake?
`perl_cpan_polymake_prereq` does not make sense in `SAGE_SPKG_DEPCHECK` because it is a dummy script package -- we provide no spkg-install for it.

You can add `SAGE_SPKG_DEPCHECK` for `bliss`, `cddlib`, `lrslib`, `readline`, `ppl`, which bring shared libraries.


---

Comment by git created at 2021-11-01 17:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-01 17:02:54

Replying to [comment:86 dimpase]:
> We should check that `polymake` is working, not only `polymake-config`.
> (As some Perl deps might be broken [...])

I have instead added some initialization steps to the existing run test of the polymake library. Please try if it correctly rejects your broken installation


---

Comment by mkoeppe created at 2021-11-01 17:07:45

Replying to [comment:91 mkoeppe]:
> You can add `SAGE_SPKG_DEPCHECK` for `bliss`, `cddlib`, `lrslib`, `readline`, `ppl`, which bring shared libraries.
However, this would reject polymake on homebrew, which does not provide all of these libraries. So let's not do this -- unless someone is actually running into shared library conflicts.


---

Comment by mkoeppe created at 2021-11-01 17:08:10

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-01 19:07:29

Testing on arch using `EXTRA_CONFIGURE_ARGS="--disable-notebook" tox -e docker-archlinux-latest-maximal`.

There seems to be a packaging bug that breaks polymake when `TERM` is set to `dumb` (as we do in the (deprecated) polymake pexpect interface):

```
[root@ab9af06251dd sage]# TERM=dumb polymake
Welcome to polymake version 4.5
Copyright (c) 1997-2021
Ewgenij Gawrilow, Michael Joswig, and the polymake team
Technische Universität Berlin, Germany
https://polymake.org

This is free software licensed under GPL; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Loading applications now...Can't locate object method "new" via package "Term::ReadLine::Gnu" at /usr/share/polymake/perllib/Polymake/Core/Shell.pm line 30.
```



---

Comment by dimpase created at 2021-11-01 23:25:36

Replying to [comment:93 mkoeppe]:
> Replying to [comment:86 dimpase]:
> > We should check that `polymake` is working, not only `polymake-config`.
> > (As some Perl deps might be broken [...])
> 
> I have instead added some initialization steps to the existing run test of the polymake library. Please try if it correctly rejects your broken installation

it does, I get the same error as from `polymake` in terminal. I get

```
configure:39826: ./conftest
terminate called after throwing an instance of 'pm::perl::exception'
  what():  "/usr/share/polymake/apps/common/perllib/PolyDB.pm", line 23: Can't locate MongoDB.pm in @INC (you may need to install the MongoDB module)
...
```


However, I don't get why you need this extra hack, rather than the result of `perl_mongodb/spkg-configure.m4`, which could be added into `SAGE_SPKG_DEPCHECK`, and which duly reports

```
perl_mongodb-none:                           no suitable system package; optional
```

These perl module packages aren't so dummy after all.


---

Comment by dimpase created at 2021-11-01 23:28:31

Replying to [comment:91 mkoeppe]:
> Replying to [comment:84 dimpase]:
> > Shouldn't `perl_cpan_polymake_prereq` (and other deps?) be in `SAGE_SPKG_DEPCHECK` for polymake?
> `perl_cpan_polymake_prereq` does not make sense in `SAGE_SPKG_DEPCHECK` because it is a dummy script package -- we provide no spkg-install for it.

What do you mean it's `dummy` - it does the check for the needed modules!
See also comment:98.


---

Comment by mkoeppe created at 2021-11-02 00:08:04

"Dummy" means we have no `spkg-install` script; the package only exists for running the `spkg-configure.m4`.


---

Comment by mkoeppe created at 2021-11-02 00:10:10

The `perl_mongodb` package is not required. Only users who want to use PolyDB need it.
That's why I split it out from `perl_cpan_polymake_prereq` in #31840.


---

Comment by dimpase created at 2021-11-02 00:12:47

Replying to [comment:100 mkoeppe]:
> "Dummy" means we have no `spkg-install` script; the package only exists for running the `spkg-configure.m4`.

anyhow, these packages do useful tests on suitability of system `polymake`, as we have discovered here, why not add them to `SAGE_SPKG_DEPCHECK` ?


---

Comment by mkoeppe created at 2021-11-02 00:13:41

You are confused about `SAGE_SPKG_DEPCHECK`. This macro implements the logic "dependency library B is installed from SPKG ==> must install package A from SPKG too".


---

Comment by dimpase created at 2021-11-02 00:17:55

Replying to [comment:101 mkoeppe]:
> The `perl_mongodb` package is not required. Only users who want to use PolyDB need it.
> That's why I split it out from `perl_cpan_polymake_prereq` in #31840.
> 
I don't know what `PolyDB` is, it seems to be an integral part of polymake now.
(At least on Gentoo there seems to be no option to have polymake not dependent on it)


---

Comment by dimpase created at 2021-11-02 00:21:03

Replying to [comment:103 mkoeppe]:
> You are confused about `SAGE_SPKG_DEPCHECK`. This macro implements the logic "dependency library B is installed from SPKG ==> must install package A from SPKG too".

Note that X->Y <=> ¬Y->¬X (i.e. A from system needs B from system)


---

Comment by mkoeppe created at 2021-11-02 00:21:33

As I said, you are confused.


---

Comment by dimpase created at 2021-11-02 00:35:35

No, I wrote the macro `SAGE_SPKG_CONFIGURE`, in fact, and it's you who are confused. :-)
If I do

```diff
--- a/build/pkgs/polymake/spkg-configure.m4
+++ b/build/pkgs/polymake/spkg-configure.m4
@@ -1,6 +1,7 @@
 SAGE_SPKG_CONFIGURE([polymake], [
     dnl Need polymake >= 3.5 for "improve callable library compatibility with threads"
     m4_pushdef([POLYMAKE_VERSION_MIN], [3.5])
+SAGE_SPKG_DEPCHECK([perl_mongodb], [
     AC_CACHE_CHECK([for polymake-config >= ]POLYMAKE_VERSION_MIN, [ac_cv_path_POLYMAKE_CONFIG], [
         AC_PATH_PROGS_FEATURE_CHECK([POLYMAKE_CONFIG], [polymake-config], [
             polymake_config_version=$($ac_path_POLYMAKE_CONFIG --version 2>&1)
@@ -41,5 +42,6 @@ SAGE_SPKG_CONFIGURE([polymake], [
            LDFLAGS="$saved_LDFLAGS"
            AC_LANG_POP([C++])
           ])
+])
     m4_popdef([POLYMAKE_VERSION_MIN])
 ])
```

then I get

```
## --------------------------------------------------------- ##
## Checking whether SageMath should install SPKG polymake... ##
## --------------------------------------------------------- ##
configure:39701: checking whether any of perl_mongodb is installed as or will be installed as SPKG
configure:39706: result: yes; install polymake as well
configure:39897: no suitable system package found for SPKG polymake
```



---

Comment by dimpase created at 2021-11-02 00:36:56

Yes, I agree that `checking whether any of perl_mongodb is installed as or will be installed as SPKG` message is misleading, but, well...


---

Comment by mkoeppe created at 2021-11-02 00:37:09

But it's late night in Europe, and your change there implements the wrong logic.


---

Comment by dimpase created at 2021-11-02 00:41:38

Replying to [comment:109 mkoeppe]:
> But it's late night in Europe, and your change there implements the wrong logic.
> 
> 
it's not yet 1am here, and 
it's only wrong if `perl_mongodb` is optional for the latest polymake. Note that Gentoo builds polymake just fine, while there is no Perl MongoDB installed (and the result of the build is broken).


---

Comment by mkoeppe created at 2021-11-02 00:47:10

1. `perl_mongodb` *is* optional for polymake.

2. Whether system `perl_mongodb` is available or not, we can use system `polymake`.

3. Even if we add an installation script for `perl_mongodb`, installing it as an SPKG does NOT make it necessary to stop using the system polymake (which is what `SAGE_SPKG_DEPCHECK` implements).


---

Comment by mkoeppe created at 2021-11-02 01:40:24

Replying to [comment:98 dimpase]:
> Replying to [comment:93 mkoeppe]:
> > Replying to [comment:86 dimpase]:
> > > We should check that `polymake` is working, not only `polymake-config`.
> > > (As some Perl deps might be broken [...])
> > 
> > I have instead added some initialization steps to the existing run test of the polymake library. Please try if it correctly rejects your broken installation
> 
> it does, I get the same error as from `polymake` in terminal.

Good, then `spkg-configure.m4` (= the scope of this ticket) does its job correctly.

> However, I don't get why you need this extra hack

Not a hack, just a proper runtest for the polymake library.


---

Comment by @sheerluck created at 2021-11-02 06:11:06

I don't know how `Loading applications now...` works but I get

```
Application polytope currently uses following contributed and third-party software packages:
4ti2, bliss, cdd, flint, graphviz, libnormaliz, lrs, permlib, povray, ppl, qhull, singular, sketch, sympol, threejs, tikz, tosimplex
For more details:  show_credits;
polytope > 
```

so I guess I never touch PolyDB.pm somehow  (I use `dev-perl/MongoDB` for our docker images only)


---

Comment by @sheerluck created at 2021-11-02 06:27:26

I hope this ticket stays not about `perl_mongodb` in any way. Somehow it wasn't about `perl_mongodb` for Arch Linux users.


---

Comment by dimpase created at 2021-11-02 09:05:43

Replying to [comment:111 mkoeppe]:
> 1. `perl_mongodb` *is* optional for polymake.
> 
> 2. Whether system `perl_mongodb` is available or not, we can use system `polymake`.

except that we can't in some cases, see above.

> 
> 3. Even if we add an installation script for `perl_mongodb`, installing it as an SPKG does NOT make it necessary to stop using the system polymake (which is what `SAGE_SPKG_DEPCHECK` implements).

Hopefully this is not happening on my watch :-)

----------------

Anyhow it's good enough now.


---

Comment by dimpase created at 2021-11-02 09:05:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-02 17:40:11

Thanks.


---

Comment by vbraun created at 2021-11-07 09:36:25

Resolution: fixed
