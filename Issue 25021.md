# Issue 25021: Gurobi prints "Academic license - for non-commercial use only" and breaks lots of doctests

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2018-04-29 07:14:29

After installing Gurobi 8.0, `make ptestlong` gives:

```
----------------------------------------------------------------------
sage -t --long --warn-long 78.4 src/sage/graphs/generic_graph.py  # 79 doctests failed
sage -t --long --warn-long 78.4 src/sage/geometry/polyhedron/base.py  # 2 doctests failed
sage -t --long --warn-long 78.4 src/sage/geometry/cone.py  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/generators/smallgraphs.py  # 21 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/generators/families.py  # 4 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/graph.py  # 49 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/database.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/combinat/posets/posets.py  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/generators/basic.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/homology/simplicial_complex.py  # 6 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/orthogonal_arrays_build_recursive.py  # 11 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/graph_decompositions/vertex_separation.pyx  # 7 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/knots/link.py  # 9 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/orthogonal_arrays_find_recursive.pyx  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/bibd.py  # 5 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/graph_coloring.py  # 10 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/digraph.py  # 9 doctests failed
sage -t --long --warn-long 78.4 src/sage/matroids/matroid.pyx  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/numerical/mip.pyx  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/orthogonal_arrays.py  # 4 doctests failed
sage -t --long --warn-long 78.4 src/sage/schemes/toric/toric_subscheme.py  # 10 doctests failed
sage -t --long --warn-long 78.4 src/sage/schemes/toric/points.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/game_theory/normal_form_game.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/graphs/comparability.pyx  # 6 doctests failed
sage -t --long --warn-long 78.4 src/sage/combinat/designs/incidence_structures.py  # 5 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/optimize.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/combinat/integer_vector.py  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/bipartite_graph.py  # 2 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/generators/degree_sequence.py  # 2 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/generators/chessboard.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/cpython/wrapperdescr.pyx  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/matroids/graphic_matroid.py  # 7 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/backends/generic_backend.pyx  # 2 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/linear_functions.pyx  # 50 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/graph_decompositions/cutwidth.pyx  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/linear_tensor_element.pyx  # 9 doctests failed
sage -t --long --warn-long 78.4 src/doc/en/reference/sat/index.rst  # 1 doctest failed
sage -t --long --warn-long 78.4 src/doc/en/thematic_tutorials/linear_programming.rst  # 5 doctests failed
sage -t --long --warn-long 78.4 src/sage/graphs/hypergraph_generators.py  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/sat/solvers/sat_lp.py  # 7 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/backends/cvxopt_backend.pyx  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/graphs/convexity_properties.pyx  # 3 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/linear_tensor.py  # 12 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/backends/gurobi_backend.pyx  # 1 doctest failed
sage -t --long --warn-long 78.4 src/sage/numerical/linear_tensor_constraints.py  # 15 doctests failed
sage -t --long --warn-long 78.4 src/sage/numerical/knapsack.py  # 5 doctests failed
sage -t --long --warn-long 78.4 src/sage/sat/solvers/satsolver.pyx  # 1 doctest failed
----------------------------------------------------------------------
```


All of the failing tests looking like:

```
sage -t --long --warn-long 78.4 src/sage/sat/solvers/sat_lp.py
**********************************************************************
File "src/sage/sat/solvers/sat_lp.py", line 31, in sage.sat.solvers.sat_lp.SatLP.__init__
Failed example:
    S=SAT(solver="LP"); S
Expected:
    an ILP-based SAT Solver
Got:
    Academic license - for non-commercial use only
    an ILP-based SAT Solver
**********************************************************************
```


Or sometimes:


```
**********************************************************************
File "src/sage/schemes/toric/toric_subscheme.py", line 652, in sage.schemes.toric.toric_subscheme.AlgebraicScheme_subscheme_toric.is_nondegenerate
Failed example:
    Y.is_nondegenerate()
Expected:
    False
Got:
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    Academic license - for non-commercial use only
    False
**********************************************************************
```



---

Comment by slabbe created at 2018-04-29 07:21:39

This [post](https://groups.google.com/forum/#!topic/gurobi/T0VDf_Bqiso) on Gurobi list seems to propose a solution for silencing the output when using their Python interface, but it seems we use our own interface. So we need to find the solution.


---

Comment by slabbe created at 2018-04-29 08:15:36

The print occurs with 
[line 63](https://github.com/sagemath/sage/blob/master/src/sage/numerical/backends/gurobi_backend.pyx#L63) in the `__init__`:


```
        # Initializing the master Environment. This one is kept to be
        # deallocated on __dealloc__
        error = GRBloadenv(&self.env_master, NULL)
```


And `self.set_verbosity(0)` arrives too late some lines below. This goes beyond my knowledge: how to set the `GRB_INT_PAR_OUTPUTFLAG` or `OutputFlag` (see `gurubi_backend.pxd`) to 0 before the initialization of the master environment?


---

Comment by slabbe created at 2018-04-29 08:45:25

shorter is better


---

Comment by dcoudert created at 2018-05-05 08:27:41

I checked but it's also beyond my knowledge.


---

Comment by dcoudert created at 2018-05-05 09:29:52

I have a fix !

The solution is to use [GRBemptyenv](http://www.gurobi.com/documentation/8.0/refman/c_grbemptyenv.html) to get empty environment, then set verbose mode and finally start environment, instead of directly calling [GRBloadenv](http://www.gurobi.com/documentation/8.0/refman/c_grbloadenv.html). 
----
New commits:


---

Comment by dcoudert created at 2018-05-05 09:29:52

Changing status from new to needs_review.


---

Comment by slabbe created at 2018-05-06 07:50:23

Replying to [comment:5 dcoudert]:
> I have a fix !

Great!


---

Comment by slabbe created at 2018-05-06 08:20:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-14 17:35:15

Resolution: fixed
