# Issue 30534: Repair self-containedness of the wrapped spkg-install scripts for Python packages

archive/issues_030534.json:
```json
{
    "body": "CC:  @kliem @jhpalmieri\n\nFollow-up from #29500.\n\nWhen an spkg fails to install, Sage advises:\n\n```\n[pynormaliz-2.12] If you want to try to fix the problem yourself, *don't* just cd to\n[pynormaliz-2.12] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12 and type 'make' or whatever is appropriate.\n[pynormaliz-2.12] Instead, the following commands setup all environment variables\n[pynormaliz-2.12] correctly and load a subshell for you to debug the error:\n[pynormaliz-2.12]   (cd '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12' && '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/sage' --buildsh)\n```\n\n\nIn the shell set up with this command, one used to be able to just type `./spkg-install` to re-run the (wrapped) installation script.\n\n#29500 inadvertently broke this for Python packages because `sdh_pip_install` now depends on an additional environment variable that is set in `sage-spkg`: `SAGE_SPKG_WHEELS`. This leads to the following error:\n\n```\nSuccessfully installed PyNormaliz-2.12\nRemoved build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-kweqslvi'\nmkdir: : No such file or directory\n********************************************************************************\nError storing dist/PyNormaliz-2.12-cp37-cp37m-macosx_10_9_x86_64.whl\n********************************************************************************\n```\n\n\nWe fix it by setting this variable in the wrapped `spkg-install` scripts.\n\n\nCritical for 9.2 because this defect interferes with the debugging of spkg scripts.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30771\n\n",
    "created_at": "2020-10-15T04:26:33Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Repair self-containedness of the wrapped spkg-install scripts for Python packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30534",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kliem @jhpalmieri

Follow-up from #29500.

When an spkg fails to install, Sage advises:

```
[pynormaliz-2.12] If you want to try to fix the problem yourself, *don't* just cd to
[pynormaliz-2.12] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12 and type 'make' or whatever is appropriate.
[pynormaliz-2.12] Instead, the following commands setup all environment variables
[pynormaliz-2.12] correctly and load a subshell for you to debug the error:
[pynormaliz-2.12]   (cd '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12' && '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/sage' --buildsh)
```


In the shell set up with this command, one used to be able to just type `./spkg-install` to re-run the (wrapped) installation script.

#29500 inadvertently broke this for Python packages because `sdh_pip_install` now depends on an additional environment variable that is set in `sage-spkg`: `SAGE_SPKG_WHEELS`. This leads to the following error:

```
Successfully installed PyNormaliz-2.12
Removed build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-kweqslvi'
mkdir: : No such file or directory
********************************************************************************
Error storing dist/PyNormaliz-2.12-cp37-cp37m-macosx_10_9_x86_64.whl
********************************************************************************
```


We fix it by setting this variable in the wrapped `spkg-install` scripts.


Critical for 9.2 because this defect interferes with the debugging of spkg scripts.

Issue created by migration from https://trac.sagemath.org/ticket/30771





---

archive/issue_comments_435596.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435596",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_435597.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435597",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435598.json:
```json
{
    "body": "Can we get this into Sage 9.2 please?",
    "created_at": "2020-10-16T05:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435598",
    "user": "https://github.com/mkoeppe"
}
```

Can we get this into Sage 9.2 please?



---

archive/issue_comments_435599.json:
```json
{
    "body": "The change seems innocuous, but I'm not sure how to test it.",
    "created_at": "2020-10-16T18:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435599",
    "user": "https://github.com/jhpalmieri"
}
```

The change seems innocuous, but I'm not sure how to test it.



---

archive/issue_comments_435600.json:
```json
{
    "body": "Interrupt an installation of a Python package with `^C` (or provoke an error otherwise), then restart the installation as described in the ticket",
    "created_at": "2020-10-16T18:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435600",
    "user": "https://github.com/mkoeppe"
}
```

Interrupt an installation of a Python package with `^C` (or provoke an error otherwise), then restart the installation as described in the ticket



---

archive/issue_comments_435601.json:
```json
{
    "body": "Okay, it works for me. I'm not sure why you wouldn't just try `make PKG`, but I guess for some debugging people might want to run `spkg-install` directly. It doesn't strike me as critical, but whatever.",
    "created_at": "2020-10-16T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435601",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, it works for me. I'm not sure why you wouldn't just try `make PKG`, but I guess for some debugging people might want to run `spkg-install` directly. It doesn't strike me as critical, but whatever.



---

archive/issue_comments_435602.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-16T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435602",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435603.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-10-16T20:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435603",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_435604.json:
```json
{
    "body": "Replying to [comment:6 jhpalmieri]:\n> I'm not sure why you wouldn't just try `make PKG`\n\nThis unpacks the tarball another time. For debugging, it is useful to make changes to the unpackaged source tree.",
    "created_at": "2020-10-16T20:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435604",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 jhpalmieri]:
> I'm not sure why you wouldn't just try `make PKG`

This unpacks the tarball another time. For debugging, it is useful to make changes to the unpackaged source tree.



---

archive/issue_comments_435605.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-10-19T17:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435605",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_435606.json:
```json
{
    "body": "Better development experience can't be a blocker",
    "created_at": "2020-10-24T11:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435606",
    "user": "https://github.com/vbraun"
}
```

Better development experience can't be a blocker



---

archive/issue_comments_435607.json:
```json
{
    "body": "I don't think this is developers only. I hope that optional packages are also used by non-developers.\n\nFailure to install packages is unfortunately still common and could happen to anyone compiling sage from source. The standard debugging instruction as in the description of this ticket should work and I think such a tiny fix should go into the next master branch.",
    "created_at": "2020-10-24T12:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435607",
    "user": "https://github.com/kliem"
}
```

I don't think this is developers only. I hope that optional packages are also used by non-developers.

Failure to install packages is unfortunately still common and could happen to anyone compiling sage from source. The standard debugging instruction as in the description of this ticket should work and I think such a tiny fix should go into the next master branch.



---

archive/issue_comments_435608.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-01T00:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30534#issuecomment-435608",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_028040.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-01T00:42:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30534",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30534#event-28040"
}
```
