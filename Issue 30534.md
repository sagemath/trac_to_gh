# Issue 30534: Repair self-containedness of the wrapped spkg-install scripts for Python packages

Issue created by migration from https://trac.sagemath.org/ticket/30771

Original creator: mkoeppe

Original creation time: 2020-10-15 04:26:33

CC:  @kliem jhpalmieri

Follow-up from #29500.

When an spkg fails to install, Sage advises:

```
[pynormaliz-2.12] If you want to try to fix the problem yourself, *don't* just cd to
[pynormaliz-2.12] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12 and type 'make' or whatever is appropriate.
[pynormaliz-2.12] Instead, the following commands setup all environment variables
[pynormaliz-2.12] correctly and load a subshell for you to debug the error:
[pynormaliz-2.12]   (cd '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12' && '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/sage' --buildsh)
```


In the shell set up with this command, one used to be able to just type `./spkg-install` to re-run the (wrapped) installation script.

#29500 inadvertently broke this for Python packages because `sdh_pip_install` now depends on an additional environment variable that is set in `sage-spkg`: `SAGE_SPKG_WHEELS`. This leads to the following error:

```
Successfully installed PyNormaliz-2.12
Removed build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-kweqslvi'
mkdir: : No such file or directory
********************************************************************************
Error storing dist/PyNormaliz-2.12-cp37-cp37m-macosx_10_9_x86_64.whl
********************************************************************************
```


We fix it by setting this variable in the wrapped `spkg-install` scripts.


Critical for 9.2 because this defect interferes with the debugging of spkg scripts.


---

Comment by mkoeppe created at 2020-10-15 04:30:41

New commits:


---

Comment by mkoeppe created at 2020-10-15 04:30:41

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-10-16 05:24:16

Can we get this into Sage 9.2 please?


---

Comment by jhpalmieri created at 2020-10-16 18:29:03

The change seems innocuous, but I'm not sure how to test it.


---

Comment by mkoeppe created at 2020-10-16 18:35:35

Interrupt an installation of a Python package with `^C` (or provoke an error otherwise), then restart the installation as described in the ticket


---

Comment by jhpalmieri created at 2020-10-16 19:58:30

Okay, it works for me. I'm not sure why you wouldn't just try `make PKG`, but I guess for some debugging people might want to run `spkg-install` directly. It doesn't strike me as critical, but whatever.


---

Comment by jhpalmieri created at 2020-10-16 19:58:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-10-16 20:08:50

Thanks!


---

Comment by mkoeppe created at 2020-10-16 20:09:54

Replying to [comment:6 jhpalmieri]:
> I'm not sure why you wouldn't just try `make PKG`

This unpacks the tarball another time. For debugging, it is useful to make changes to the unpackaged source tree.


---

Comment by mkoeppe created at 2020-10-19 17:41:37

Changing priority from critical to blocker.


---

Comment by vbraun created at 2020-10-24 11:08:27

Changing priority from blocker to major.


---

Comment by vbraun created at 2020-10-24 11:08:27

Better development experience can't be a blocker


---

Comment by @kliem created at 2020-10-24 12:56:23

I don't think this is developers only. I hope that optional packages are also used by non-developers.

Failure to install packages is unfortunately still common and could happen to anyone compiling sage from source. The standard debugging instruction as in the description of this ticket should work and I think such a tiny fix should go into the next master branch.


---

Comment by vbraun created at 2020-11-01 00:42:35

Resolution: fixed
