# Issue 25553: Random failure in hyperelliptic_finite_field.py

archive/issues_025553.json:
```json
{
    "body": "CC:  @timokau roed\n\nKeywords: random_fail\n\nThis happens occasionally, is a somewhat recent regression:\n\n```\nsage -t --long src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\n**********************************************************************\nFile \"src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\", line 780, in sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points\nFailed example:\n    len(C.points())\nException raised:\n    Traceback (most recent call last):\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 573, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 983, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points[5]>\", line 1, in <module>\n        len(C.points())\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\", line 825, in points\n        self.__points = self._points_fast_sqrt() # this is fast using Zech logarithms\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\", line 675, in _points_fast_sqrt\n        points.append(self.point([x, v+sqrtD, one], check=True))\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/projective/projective_subscheme.py\", line 122, in point\n        return self.point_homset()(v, check=check)\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py\", line 279, in __call__\n        return Set_generic.__call__(self, *args, **kwds)\n      File \"sage/structure/parent.pyx\", line 922, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9761)\n        return mor._call_with_args(x, args, kwds)\n      File \"sage/structure/coerce_maps.pyx\", line 164, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5093)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 154, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4883)\n        return C._element_constructor(x, **kwds)\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py\", line 653, in _element_constructor_\n        return self.codomain()._point(self, v, **kwds)\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/projective/projective_point.py\", line 1474, in __init__\n        X.extended_codomain()._check_satisfies_equations(v)\n      File \"/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 973, in _check_satisfies_equations\n        raise TypeError(\"Coordinates %s do not define a point on %s\"%(coords,self))\n    TypeError: Coordinates [4*a + 9, 8*a + 5, 1] do not define a point on Hyperelliptic Curve over Finite Field in a of size 11^2 defined by y^2 + (x^2 + 2)*y = x^5 + x + 10\n**********************************************************************\n1 item had failures:\n   1 of  13 in sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points\n    [373 tests, 1 failure, 91.08 s]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25790\n\n",
    "created_at": "2018-07-06T18:21:30Z",
    "labels": [
        "elliptic curves",
        "major",
        "bug"
    ],
    "title": "Random failure in hyperelliptic_finite_field.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25553",
    "user": "vbraun"
}
```
CC:  @timokau roed

Keywords: random_fail

This happens occasionally, is a somewhat recent regression:

```
sage -t --long src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 780, in sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points
Failed example:
    len(C.points())
Exception raised:
    Traceback (most recent call last):
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points[5]>", line 1, in <module>
        len(C.points())
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 825, in points
        self.__points = self._points_fast_sqrt() # this is fast using Zech logarithms
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 675, in _points_fast_sqrt
        points.append(self.point([x, v+sqrtD, one], check=True))
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/projective/projective_subscheme.py", line 122, in point
        return self.point_homset()(v, check=check)
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py", line 279, in __call__
        return Set_generic.__call__(self, *args, **kwds)
      File "sage/structure/parent.pyx", line 922, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9761)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 164, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5093)
        raise
      File "sage/structure/coerce_maps.pyx", line 154, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4883)
        return C._element_constructor(x, **kwds)
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/homset.py", line 653, in _element_constructor_
        return self.codomain()._point(self, v, **kwds)
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/projective/projective_point.py", line 1474, in __init__
        X.extended_codomain()._check_satisfies_equations(v)
      File "/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 973, in _check_satisfies_equations
        raise TypeError("Coordinates %s do not define a point on %s"%(coords,self))
    TypeError: Coordinates [4*a + 9, 8*a + 5, 1] do not define a point on Hyperelliptic Curve over Finite Field in a of size 11^2 defined by y^2 + (x^2 + 2)*y = x^5 + x + 10
**********************************************************************
1 item had failures:
   1 of  13 in sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.points
    [373 tests, 1 failure, 91.08 s]
```


Issue created by migration from https://trac.sagemath.org/ticket/25790





---

archive/issue_comments_360251.json:
```json
{
    "body": "Shouldn't this be a blocker? Its a regression and one of the worst kind, a non-deterministic one.",
    "created_at": "2018-07-10T22:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360251",
    "user": "@timokau"
}
```

Shouldn't this be a blocker? Its a regression and one of the worst kind, a non-deterministic one.



---

archive/issue_comments_360252.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-07-11T21:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360252",
    "user": "jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_360253.json:
```json
{
    "body": "reminds me of #25379, where finite fields are also involved in a random failing doctest",
    "created_at": "2018-07-12T06:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360253",
    "user": "chapoton"
}
```

reminds me of #25379, where finite fields are also involved in a random failing doctest



---

archive/issue_comments_360254.json:
```json
{
    "body": "Unless a reviewed fix materializes real soon this will have to be postponed to the next version...",
    "created_at": "2018-07-16T22:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360254",
    "user": "vbraun"
}
```

Unless a reviewed fix materializes real soon this will have to be postponed to the next version...



---

archive/issue_comments_360255.json:
```json
{
    "body": "If we can't get this fixed for the release, shouldn't we mark the doctest as a known failure?",
    "created_at": "2018-07-28T12:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360255",
    "user": "@timokau"
}
```

If we can't get this fixed for the release, shouldn't we mark the doctest as a known failure?



---

archive/issue_comments_360256.json:
```json
{
    "body": "It isn't the only random failure that yields an error instead of the correct answer, e.g. #24747 is in the same category. At least it doesn't return an incorrect answer...",
    "created_at": "2018-07-29T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360256",
    "user": "vbraun"
}
```

It isn't the only random failure that yields an error instead of the correct answer, e.g. #24747 is in the same category. At least it doesn't return an incorrect answer...



---

archive/issue_comments_360257.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2018-07-29T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360257",
    "user": "vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_360258.json:
```json
{
    "body": "Then I think we should mark all of them as known failures before a release. Such failures decrease the value of the test suite. I'm currently running the whole `--long` test suite after every rebuild of sage for nix and block the release on any failure. If the test suite just randomly fails sometimes, I cannot do that.",
    "created_at": "2018-07-29T13:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360258",
    "user": "@timokau"
}
```

Then I think we should mark all of them as known failures before a release. Such failures decrease the value of the test suite. I'm currently running the whole `--long` test suite after every rebuild of sage for nix and block the release on any failure. If the test suite just randomly fails sometimes, I cannot do that.



---

archive/issue_comments_360259.json:
```json
{
    "body": "See #25968.",
    "created_at": "2018-07-29T13:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360259",
    "user": "@timokau"
}
```

See #25968.



---

archive/issue_comments_360260.json:
```json
{
    "body": "Is there a particular platform this occurs on ?  I feel like I've run this test over and over again and I can't get it to fail.",
    "created_at": "2018-09-24T12:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360260",
    "user": "embray"
}
```

Is there a particular platform this occurs on ?  I feel like I've run this test over and over again and I can't get it to fail.



---

archive/issue_comments_360261.json:
```json
{
    "body": "I haven't seen this in a while fwiw",
    "created_at": "2018-09-24T20:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360261",
    "user": "vbraun"
}
```

I haven't seen this in a while fwiw



---

archive/issue_comments_360262.json:
```json
{
    "body": "Me neither.",
    "created_at": "2018-09-27T21:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360262",
    "user": "@timokau"
}
```

Me neither.



---

archive/issue_comments_360263.json:
```json
{
    "body": "Per discussion in #25968, no one interested in this has been able to reproduce the bug in a while so maybe it's fixed itself.  Feel free to reopen this if it comes up again.",
    "created_at": "2018-10-08T09:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360263",
    "user": "embray"
}
```

Per discussion in #25968, no one interested in this has been able to reproduce the bug in a while so maybe it's fixed itself.  Feel free to reopen this if it comes up again.



---

archive/issue_comments_360264.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2018-10-08T09:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360264",
    "user": "embray"
}
```

Resolution: worksforme



---

archive/issue_comments_360265.json:
```json
{
    "body": "Resolution changed from worksforme to ",
    "created_at": "2020-01-31T23:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360265",
    "user": "vbraun"
}
```

Resolution changed from worksforme to 



---

archive/issue_comments_360266.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-01-31T23:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360266",
    "user": "vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_360267.json:
```json
{
    "body": "I'm seeing this a lot right now on the aims buildbot, but can't reproduce in isolation.",
    "created_at": "2020-01-31T23:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360267",
    "user": "vbraun"
}
```

I'm seeing this a lot right now on the aims buildbot, but can't reproduce in isolation.



---

archive/issue_comments_360268.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-01T10:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360268",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360269.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-01T14:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360269",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360270.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-01T17:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360270",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360271.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-01T23:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360271",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360272.json:
```json
{
    "body": "Note: in the failing example `x = 4*a + 9`, so `D(x) = 10*a` (the value that one has to take a square root of to find a point on the hyperelliptic curve) is not a square. For some reason `is_square()` erroneously returns True`",
    "created_at": "2020-02-01T23:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360272",
    "user": "vbraun"
}
```

Note: in the failing example `x = 4*a + 9`, so `D(x) = 10*a` (the value that one has to take a square root of to find a point on the hyperelliptic curve) is not a square. For some reason `is_square()` erroneously returns True`



---

archive/issue_comments_360273.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T08:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360273",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360274.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T08:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360274",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T12:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360275",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360276.json:
```json
{
    "body": "Actually the discriminant `D(x)` has the wrong value (and happens to be a square when it shouldn't). So it seems that evaluating a `Polynomial_ZZ_pEX` is flaky.",
    "created_at": "2020-02-02T12:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360276",
    "user": "vbraun"
}
```

Actually the discriminant `D(x)` has the wrong value (and happens to be a square when it shouldn't). So it seems that evaluating a `Polynomial_ZZ_pEX` is flaky.



---

archive/issue_comments_360277.json:
```json
{
    "body": "When the error happens D prints correctly as `x^5 + 3*x^4 + x^2 + x`, but evaluates wrong. Naively evaluating it with Sage-wrapped `FiniteField_givaroElement` gives the right answer.",
    "created_at": "2020-02-02T14:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360277",
    "user": "vbraun"
}
```

When the error happens D prints correctly as `x^5 + 3*x^4 + x^2 + x`, but evaluates wrong. Naively evaluating it with Sage-wrapped `FiniteField_givaroElement` gives the right answer.



---

archive/issue_comments_360278.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T15:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360278",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360279.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T19:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360279",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360280.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-02T23:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360280",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360281.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-05T21:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360281",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360282.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-06T22:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360282",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360283.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-08T00:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360283",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360284.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-09T13:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360284",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360285.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-09T14:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360285",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360286.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-09T14:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360286",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360287.json:
```json
{
    "body": "I've got the suspicion that this is a NTL context mismatch. The danger is that a !Python/Cython destructor is being called at inopportune times and changes the (global) NTL context. This can happen whenever Python objects are being allocated. Its more likely if there is memory pressure, which would explain why I'm seeing this on the buildbot but it disappers when tested in isolation.\n\nIn the attached branch I'm introducing `_assert_is_current_modulus()` methods to debug this better. \n\nIn particular, the constructors for the ntl wrappers like `ntl_ZZ_pE` are not entirely safe in that they occasionally change the context away from the context of the NTL object that is being wrapped. Since they are Python objects there is an unavoidable allocation, though they then restore the context in `__cinit__`. But then `__init__` tends to create auxiliary Python objects which can change the context again. There are two possible contracts here\n\n1. Instantiating NTL wrappers can change the context, and the user must restore the context before any further NTL calls that require a context\n\n2. Instantiating NTL wrappers shall not change the context, and any branch in the constructor that potentially causes a gc must be followed up with a context restore.\n\nSetting the NTL context should be quite cheap, so I'm in favor of the the safer option 2. Even though it might cause unneeded NTL context restores.",
    "created_at": "2020-02-09T15:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360287",
    "user": "vbraun"
}
```

I've got the suspicion that this is a NTL context mismatch. The danger is that a !Python/Cython destructor is being called at inopportune times and changes the (global) NTL context. This can happen whenever Python objects are being allocated. Its more likely if there is memory pressure, which would explain why I'm seeing this on the buildbot but it disappers when tested in isolation.

In the attached branch I'm introducing `_assert_is_current_modulus()` methods to debug this better. 

In particular, the constructors for the ntl wrappers like `ntl_ZZ_pE` are not entirely safe in that they occasionally change the context away from the context of the NTL object that is being wrapped. Since they are Python objects there is an unavoidable allocation, though they then restore the context in `__cinit__`. But then `__init__` tends to create auxiliary Python objects which can change the context again. There are two possible contracts here

1. Instantiating NTL wrappers can change the context, and the user must restore the context before any further NTL calls that require a context

2. Instantiating NTL wrappers shall not change the context, and any branch in the constructor that potentially causes a gc must be followed up with a context restore.

Setting the NTL context should be quite cheap, so I'm in favor of the the safer option 2. Even though it might cause unneeded NTL context restores.



---

archive/issue_comments_360288.json:
```json
{
    "body": "I've added extra logging to original random failure in `hyperelliptic_finite_field.py` and when it fails its because a call to `self._parent._modulus.ZZ_pE([7, 7])` returned the NTL `ZZ_pE` that prints as `[1 7]` instead of `[7 7]`.",
    "created_at": "2020-02-09T15:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360288",
    "user": "vbraun"
}
```

I've added extra logging to original random failure in `hyperelliptic_finite_field.py` and when it fails its because a call to `self._parent._modulus.ZZ_pE([7, 7])` returned the NTL `ZZ_pE` that prints as `[1 7]` instead of `[7 7]`.



---

archive/issue_comments_360289.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-09T17:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360289",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360290.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-09T21:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360290",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360291.json:
```json
{
    "body": "In the failing example the `[7, 7]` list actually contains `Integer_mod` elements, which ends up being converted to `ntl_ZZ_p` via conversion to string. This is the unsafe call \n\n```\n    ccreadstr(self.x, str(v))\n```\n\nin `ntl_ZZ_p.__init__()`. So what happens is:\n* we start with the correct NTL modulus\n* Calling `str(v)` ends up making Python allocations, which can cause gc to run and to change the NTL modulus\n* In that case `ccreadstr(self.x, ...)` interprets it as a number with the wrong modulus",
    "created_at": "2020-02-09T21:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360291",
    "user": "vbraun"
}
```

In the failing example the `[7, 7]` list actually contains `Integer_mod` elements, which ends up being converted to `ntl_ZZ_p` via conversion to string. This is the unsafe call 

```
    ccreadstr(self.x, str(v))
```

in `ntl_ZZ_p.__init__()`. So what happens is:
* we start with the correct NTL modulus
* Calling `str(v)` ends up making Python allocations, which can cause gc to run and to change the NTL modulus
* In that case `ccreadstr(self.x, ...)` interprets it as a number with the wrong modulus



---

archive/issue_comments_360292.json:
```json
{
    "body": "Replying to [comment:36 vbraun]:\n> 1. Instantiating NTL wrappers can change the context, and the user must restore the context before any further NTL calls that require a context\n\nActually, this is the only possibility. When `__init__` ends some temporary objects go out of scope and this can trigger a gc, changing the NTL context. So even if you had the correct NTL context at the last line of `__init__`, it can be different once you return to the calling site.",
    "created_at": "2020-02-09T23:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360292",
    "user": "vbraun"
}
```

Replying to [comment:36 vbraun]:
> 1. Instantiating NTL wrappers can change the context, and the user must restore the context before any further NTL calls that require a context

Actually, this is the only possibility. When `__init__` ends some temporary objects go out of scope and this can trigger a gc, changing the NTL context. So even if you had the correct NTL context at the last line of `__init__`, it can be different once you return to the calling site.



---

archive/issue_comments_360293.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-10T20:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360293",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360294.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-10T20:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360294",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360295.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-10T20:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360295",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360296.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-10T23:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360296",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360297.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-10T23:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360297",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_360298.json:
```json
{
    "body": "I can't reproduce it any more with the attached branch, looks like the gc hitting in the `ccreadstr(self.x, str(v))` was the main culprit.",
    "created_at": "2020-02-10T23:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360298",
    "user": "vbraun"
}
```

I can't reproduce it any more with the attached branch, looks like the gc hitting in the `ccreadstr(self.x, str(v))` was the main culprit.



---

archive/issue_comments_360299.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-02-10T23:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360299",
    "user": "vbraun"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_360300.json:
```json
{
    "body": "David, do you want to review this ticket?",
    "created_at": "2020-02-10T23:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360300",
    "user": "vbraun"
}
```

David, do you want to review this ticket?



---

archive/issue_comments_360301.json:
```json
{
    "body": "Yep, I'll take a look tonight.",
    "created_at": "2020-02-11T03:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360301",
    "user": "roed"
}
```

Yep, I'll take a look tonight.



---

archive/issue_comments_360302.json:
```json
{
    "body": "Did you manage to take a look? No pressure ;-) but I'd like to get the buildbot working and, while its an unlikely bug, when it strikes it can silently return wrong values...",
    "created_at": "2020-02-15T11:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360302",
    "user": "vbraun"
}
```

Did you manage to take a look? No pressure ;-) but I'd like to get the buildbot working and, while its an unlikely bug, when it strikes it can silently return wrong values...



---

archive/issue_comments_360303.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-17T04:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360303",
    "user": "roed"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_360304.json:
```json
{
    "body": "Looks good.  I ran tests locally.",
    "created_at": "2020-02-17T04:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360304",
    "user": "roed"
}
```

Looks good.  I ran tests locally.



---

archive/issue_comments_360305.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-19T23:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25553#issuecomment-360305",
    "user": "vbraun"
}
```

Resolution: fixed
