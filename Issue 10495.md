# Issue 10495: ModularSymbols_clear_cache() not clearing everything?

archive/issues_010495.json:
```json
{
    "body": "Assignee: craigcitro\n\nCC:  davidloeffler\n\nWhen I was doing some computations on modular forms, I noticed the following strange memory usage behaviour which. After the first two iterations it seems like there is a memory leak. But strangely enough it stops leaking at the third iteration.\n\n\n```\nsage: import gc\nsage: gc.collect()\n54\nsage: get_memory_usage()\n819.7578125\nsage: for i in xrange(10):\n....:     ModularSymbols(Gamma1(97),sign=1)\n....:     ModularSymbols_clear_cache()\n....:     gc.collect()\n....:     get_memory_usage()\n....:     \nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n0\n842.58984375\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n0\n860.08203125\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n876.63671875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n878.2421875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n878.76953125\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n880.2421875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n880.2421875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n880.2421875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n880.2421875\nModular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n37640\n880.2421875\n```\n\n\nIt would be nice to be able to create modular symbols without needing to restart sage to get all your memory back.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10548\n\n",
    "created_at": "2011-01-03T14:43:49Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "title": "ModularSymbols_clear_cache() not clearing everything?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10495",
    "user": "mderickx"
}
```
Assignee: craigcitro

CC:  davidloeffler

When I was doing some computations on modular forms, I noticed the following strange memory usage behaviour which. After the first two iterations it seems like there is a memory leak. But strangely enough it stops leaking at the third iteration.


```
sage: import gc
sage: gc.collect()
54
sage: get_memory_usage()
819.7578125
sage: for i in xrange(10):
....:     ModularSymbols(Gamma1(97),sign=1)
....:     ModularSymbols_clear_cache()
....:     gc.collect()
....:     get_memory_usage()
....:     
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
0
842.58984375
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
0
860.08203125
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
876.63671875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
878.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
878.76953125
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
```


It would be nice to be able to create modular symbols without needing to restart sage to get all your memory back.

Issue created by migration from https://trac.sagemath.org/ticket/10548





---

archive/issue_comments_109414.json:
```json
{
    "body": "Ps. you might want to use smaller numbers then 97 to test because ModularSymbols(Gamma1(97),sign=1) takes a while. It behaves the same, but with smaller memory usage for smaller numbers.",
    "created_at": "2011-01-03T14:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109414",
    "user": "mderickx"
}
```

Ps. you might want to use smaller numbers then 97 to test because ModularSymbols(Gamma1(97),sign=1) takes a while. It behaves the same, but with smaller memory usage for smaller numbers.



---

archive/issue_comments_109415.json:
```json
{
    "body": "According to heapy the aditional memory comes from;\n\ndict of sage.modular.modsym.manin_symbols.ManinSymbol\n\n\n\n```\nmderickx@mod:~$ sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: import gc\nsage: from guppy import hpy; hp=hpy()\nsage: M=ModularSymbols(Gamma1(97),sign=1)\nsage: get_memory_usage()\n848.1953125\nsage: M=[]\nsage: get_memory_usage()\n848.1953125\nsage: ModularSymbols_clear_cache()\nsage: get_memory_usage()\n848.1953125\nsage: hp.heap()\nPartition of a set of 445281 objects. Total size = 68518056 bytes.\n Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)\n     0 169534  38 28541776  42  28541776  42 str\n     1 125494  28 10674696  16  39216472  57 tuple\n     2   1624   0  3964480   6  43180952  63 dict of module\n     3  25817   6  3098040   5  46278992  68 types.CodeType\n     4  24634   6  2956080   4  49235072  72 function\n     5   2798   1  2949584   4  52184656  76 dict (no owner)\n     6   2660   1  2727392   4  54912048  80 dict of type\n     7   9408   2  2634240   4  57546288  84 dict of sage.modular.modsym.manin_symbols.ManinSymbol\n     8   2660   1  2388040   3  59934328  87 type\n     9   4293   1  1010536   1  60944864  89 list\n<895 more rows. Type e.g. '_.more' to view.>\nsage: \n```\n",
    "created_at": "2011-01-03T15:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109415",
    "user": "mderickx"
}
```

According to heapy the aditional memory comes from;

dict of sage.modular.modsym.manin_symbols.ManinSymbol



```
mderickx@mod:~$ sage
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: import gc
sage: from guppy import hpy; hp=hpy()
sage: M=ModularSymbols(Gamma1(97),sign=1)
sage: get_memory_usage()
848.1953125
sage: M=[]
sage: get_memory_usage()
848.1953125
sage: ModularSymbols_clear_cache()
sage: get_memory_usage()
848.1953125
sage: hp.heap()
Partition of a set of 445281 objects. Total size = 68518056 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0 169534  38 28541776  42  28541776  42 str
     1 125494  28 10674696  16  39216472  57 tuple
     2   1624   0  3964480   6  43180952  63 dict of module
     3  25817   6  3098040   5  46278992  68 types.CodeType
     4  24634   6  2956080   4  49235072  72 function
     5   2798   1  2949584   4  52184656  76 dict (no owner)
     6   2660   1  2727392   4  54912048  80 dict of type
     7   9408   2  2634240   4  57546288  84 dict of sage.modular.modsym.manin_symbols.ManinSymbol
     8   2660   1  2388040   3  59934328  87 type
     9   4293   1  1010536   1  60944864  89 list
<895 more rows. Type e.g. '_.more' to view.>
sage: 
```




---

archive/issue_comments_109416.json:
```json
{
    "body": "It's not an error of the ModularSymbols_clear_cache() function\n\n\n```\nsage: ModularSymbols(Gamma1(29),sign=1,use_cache=False)\nModular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field\nsage: None\nsage: gc.collect()\n54\nsage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\n[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]\n```\n",
    "created_at": "2011-01-07T22:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109416",
    "user": "mderickx"
}
```

It's not an error of the ModularSymbols_clear_cache() function


```
sage: ModularSymbols(Gamma1(29),sign=1,use_cache=False)
Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field
sage: None
sage: gc.collect()
54
sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]
```




---

archive/issue_comments_109417.json:
```json
{
    "body": "See the attached chain.png picture created with objgraph. There is a reference chain to the homset module. And the homeset module will not get destroyed so we have to find out where this chain comes from.",
    "created_at": "2011-01-08T00:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109417",
    "user": "mderickx"
}
```

See the attached chain.png picture created with objgraph. There is a reference chain to the homset module. And the homeset module will not get destroyed so we have to find out where this chain comes from.



---

archive/issue_comments_109418.json:
```json
{
    "body": "Might this be an instance of #715? Modular symbols spaces are Parents, so various maps in and out of them are probably getting cached by the coercion model machinery.",
    "created_at": "2011-01-20T13:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109418",
    "user": "davidloeffler"
}
```

Might this be an instance of #715? Modular symbols spaces are Parents, so various maps in and out of them are probably getting cached by the coercion model machinery.



---

archive/issue_comments_109419.json:
```json
{
    "body": "Attachment",
    "created_at": "2011-01-20T13:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109419",
    "user": "mderickx"
}
```

Attachment



---

archive/issue_comments_109420.json:
```json
{
    "body": "Sorry I failed in adding the mentioned chain.png before. It shows a reference chain explaining why ManinSymbol(37,35) is still in the memory. It seems that it has at least to do something with code in the homset module. I don't know enough details about the coercion and category framework and their interaction to say that it has something to do with 715. But the description of 715 really looks like it could be the cause.\n\nIf it is coercion, it might also be related to: #10570",
    "created_at": "2011-01-20T13:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109420",
    "user": "mderickx"
}
```

Sorry I failed in adding the mentioned chain.png before. It shows a reference chain explaining why ManinSymbol(37,35) is still in the memory. It seems that it has at least to do something with code in the homset module. I don't know enough details about the coercion and category framework and their interaction to say that it has something to do with 715. But the description of 715 really looks like it could be the cause.

If it is coercion, it might also be related to: #10570



---

archive/issue_comments_109421.json:
```json
{
    "body": "Having looked at #10570, I don't think that's the reason. #715 seems a much more likely culprit.",
    "created_at": "2011-01-20T15:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109421",
    "user": "davidloeffler"
}
```

Having looked at #10570, I don't think that's the reason. #715 seems a much more likely culprit.



---

archive/issue_comments_109422.json:
```json
{
    "body": "Here is some code run on sage 4.6.1 showing that it is really the coercion framework.\n\n\n```\nsage: import gc  \nsage: import objgraph\nsage: import inspect\nsage: m=ModularSymbols(Gamma1(29),use_cache=False)\nsage: m=[]\nsage: ModularSymbols_clear_cache()\nsage: gc.collect()\n54\nsage: a=[x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\nsage: l=objgraph.find_backref_chain(a[0],inspect.ismodule,max_depth=15,extra_ignore=[id(a)])\nsage: map(type,l)\n[<type 'module'>, <type 'dict'>, <type 'sage.structure.coerce.CoercionModel_cache_maps'>, <type 'list'>, <type 'tuple'>, <type 'traceback'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <class 'sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1_with_category'>]\n```\n",
    "created_at": "2011-03-21T21:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109422",
    "user": "mderickx"
}
```

Here is some code run on sage 4.6.1 showing that it is really the coercion framework.


```
sage: import gc  
sage: import objgraph
sage: import inspect
sage: m=ModularSymbols(Gamma1(29),use_cache=False)
sage: m=[]
sage: ModularSymbols_clear_cache()
sage: gc.collect()
54
sage: a=[x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
sage: l=objgraph.find_backref_chain(a[0],inspect.ismodule,max_depth=15,extra_ignore=[id(a)])
sage: map(type,l)
[<type 'module'>, <type 'dict'>, <type 'sage.structure.coerce.CoercionModel_cache_maps'>, <type 'list'>, <type 'tuple'>, <type 'traceback'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <class 'sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1_with_category'>]
```




---

archive/issue_comments_109423.json:
```json
{
    "body": "btw it goes wrong in the same way on 4.7.alpha1",
    "created_at": "2011-03-21T21:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109423",
    "user": "mderickx"
}
```

btw it goes wrong in the same way on 4.7.alpha1



---

archive/issue_comments_109424.json:
```json
{
    "body": "Changing assignee from craigcitro to robertwb.",
    "created_at": "2011-03-21T22:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109424",
    "user": "mderickx"
}
```

Changing assignee from craigcitro to robertwb.



---

archive/issue_comments_109425.json:
```json
{
    "body": "Changing component from modular forms to coercion.",
    "created_at": "2011-03-21T22:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109425",
    "user": "mderickx"
}
```

Changing component from modular forms to coercion.



---

archive/issue_comments_109426.json:
```json
{
    "body": "Attachment",
    "created_at": "2011-03-22T06:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109426",
    "user": "robertwb"
}
```

Attachment



---

archive/issue_comments_109427.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-22T06:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109427",
    "user": "robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_109428.json:
```json
{
    "body": "The attached patch fixes the issue described in the title, but does not fix #715.",
    "created_at": "2011-03-22T06:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109428",
    "user": "robertwb"
}
```

The attached patch fixes the issue described in the title, but does not fix #715.



---

archive/issue_comments_109429.json:
```json
{
    "body": "Attachment\n\nrebased against 4.7.alpha1",
    "created_at": "2011-03-23T18:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109429",
    "user": "mderickx"
}
```

Attachment

rebased against 4.7.alpha1



---

archive/issue_comments_109430.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2011-03-23T20:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109430",
    "user": "mderickx"
}
```

Looks good to me.



---

archive/issue_comments_109431.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-23T20:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109431",
    "user": "mderickx"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_109432.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-03-23T20:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109432",
    "user": "mderickx"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_109433.json:
```json
{
    "body": "Attachment",
    "created_at": "2011-03-23T20:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109433",
    "user": "mderickx"
}
```

Attachment



---

archive/issue_comments_109434.json:
```json
{
    "body": "Robert, (or someone else), can you review the doctest I added?",
    "created_at": "2011-03-23T20:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109434",
    "user": "mderickx"
}
```

Robert, (or someone else), can you review the doctest I added?



---

archive/issue_comments_109435.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-23T20:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109435",
    "user": "mderickx"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_109436.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-23T21:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109436",
    "user": "robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_109437.json:
```json
{
    "body": "The doctest looks good to me.",
    "created_at": "2011-03-23T21:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109437",
    "user": "robertwb"
}
```

The doctest looks good to me.



---

archive/issue_comments_109438.json:
```json
{
    "body": "Attachment\n\nnew doctest",
    "created_at": "2011-03-24T22:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109438",
    "user": "kini"
}
```

Attachment

new doctest



---

archive/issue_comments_109439.json:
```json
{
    "body": "I folded in the doctest from the current patch at #10570, also by Maarten.",
    "created_at": "2011-03-24T22:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109439",
    "user": "kini"
}
```

I folded in the doctest from the current patch at #10570, also by Maarten.



---

archive/issue_comments_109440.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-07T19:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10495#issuecomment-109440",
    "user": "jdemeyer"
}
```

Resolution: fixed
