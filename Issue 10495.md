# Issue 10495: ModularSymbols_clear_cache() not clearing everything?

Issue created by migration from https://trac.sagemath.org/ticket/10548

Original creator: mderickx

Original creation time: 2011-01-03 14:43:49

Assignee: craigcitro

CC:  davidloeffler

When I was doing some computations on modular forms, I noticed the following strange memory usage behaviour which. After the first two iterations it seems like there is a memory leak. But strangely enough it stops leaking at the third iteration.


```
sage: import gc
sage: gc.collect()
54
sage: get_memory_usage()
819.7578125
sage: for i in xrange(10):
....:     ModularSymbols(Gamma1(97),sign=1)
....:     ModularSymbols_clear_cache()
....:     gc.collect()
....:     get_memory_usage()
....:     
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
0
842.58984375
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
0
860.08203125
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
876.63671875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
878.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
878.76953125
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
37640
880.2421875
```


It would be nice to be able to create modular symbols without needing to restart sage to get all your memory back.


---

Comment by mderickx created at 2011-01-03 14:48:10

Ps. you might want to use smaller numbers then 97 to test because ModularSymbols(Gamma1(97),sign=1) takes a while. It behaves the same, but with smaller memory usage for smaller numbers.


---

Comment by mderickx created at 2011-01-03 15:07:35

According to heapy the aditional memory comes from;

dict of sage.modular.modsym.manin_symbols.ManinSymbol



```
mderickx@mod:~$ sage
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: import gc
sage: from guppy import hpy; hp=hpy()
sage: M=ModularSymbols(Gamma1(97),sign=1)
sage: get_memory_usage()
848.1953125
sage: M=[]
sage: get_memory_usage()
848.1953125
sage: ModularSymbols_clear_cache()
sage: get_memory_usage()
848.1953125
sage: hp.heap()
Partition of a set of 445281 objects. Total size = 68518056 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0 169534  38 28541776  42  28541776  42 str
     1 125494  28 10674696  16  39216472  57 tuple
     2   1624   0  3964480   6  43180952  63 dict of module
     3  25817   6  3098040   5  46278992  68 types.CodeType
     4  24634   6  2956080   4  49235072  72 function
     5   2798   1  2949584   4  52184656  76 dict (no owner)
     6   2660   1  2727392   4  54912048  80 dict of type
     7   9408   2  2634240   4  57546288  84 dict of sage.modular.modsym.manin_symbols.ManinSymbol
     8   2660   1  2388040   3  59934328  87 type
     9   4293   1  1010536   1  60944864  89 list
<895 more rows. Type e.g. '_.more' to view.>
sage: 
```



---

Comment by mderickx created at 2011-01-07 22:15:40

It's not an error of the ModularSymbols_clear_cache() function


```
sage: ModularSymbols(Gamma1(29),sign=1,use_cache=False)
Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field
sage: None
sage: gc.collect()
54
sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]
```



---

Comment by mderickx created at 2011-01-08 00:52:21

See the attached chain.png picture created with objgraph. There is a reference chain to the homset module. And the homeset module will not get destroyed so we have to find out where this chain comes from.


---

Comment by davidloeffler created at 2011-01-20 13:02:23

Might this be an instance of #715? Modular symbols spaces are Parents, so various maps in and out of them are probably getting cached by the coercion model machinery.


---

Attachment


---

Comment by mderickx created at 2011-01-20 13:20:37

Sorry I failed in adding the mentioned chain.png before. It shows a reference chain explaining why ManinSymbol(37,35) is still in the memory. It seems that it has at least to do something with code in the homset module. I don't know enough details about the coercion and category framework and their interaction to say that it has something to do with 715. But the description of 715 really looks like it could be the cause.

If it is coercion, it might also be related to: #10570


---

Comment by davidloeffler created at 2011-01-20 15:48:54

Having looked at #10570, I don't think that's the reason. #715 seems a much more likely culprit.


---

Comment by mderickx created at 2011-03-21 21:55:34

Here is some code run on sage 4.6.1 showing that it is really the coercion framework.


```
sage: import gc  
sage: import objgraph
sage: import inspect
sage: m=ModularSymbols(Gamma1(29),use_cache=False)
sage: m=[]
sage: ModularSymbols_clear_cache()
sage: gc.collect()
54
sage: a=[x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
sage: l=objgraph.find_backref_chain(a[0],inspect.ismodule,max_depth=15,extra_ignore=[id(a)])
sage: map(type,l)
[<type 'module'>, <type 'dict'>, <type 'sage.structure.coerce.CoercionModel_cache_maps'>, <type 'list'>, <type 'tuple'>, <type 'traceback'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <class 'sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1_with_category'>]
```



---

Comment by mderickx created at 2011-03-21 21:57:58

btw it goes wrong in the same way on 4.7.alpha1


---

Comment by mderickx created at 2011-03-21 22:22:41

Changing assignee from craigcitro to robertwb.


---

Comment by mderickx created at 2011-03-21 22:22:41

Changing component from modular forms to coercion.


---

Attachment


---

Comment by robertwb created at 2011-03-22 06:05:23

Changing status from new to needs_review.


---

Comment by robertwb created at 2011-03-22 06:05:23

The attached patch fixes the issue described in the title, but does not fix #715.


---

Attachment

rebased against 4.7.alpha1


---

Comment by mderickx created at 2011-03-23 20:09:15

Looks good to me.


---

Comment by mderickx created at 2011-03-23 20:09:15

Changing status from needs_review to positive_review.


---

Comment by mderickx created at 2011-03-23 20:30:02

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by mderickx created at 2011-03-23 20:31:52

Robert, (or someone else), can you review the doctest I added?


---

Comment by mderickx created at 2011-03-23 20:31:52

Changing status from needs_work to needs_review.


---

Comment by robertwb created at 2011-03-23 21:32:16

Changing status from needs_review to positive_review.


---

Comment by robertwb created at 2011-03-23 21:32:16

The doctest looks good to me.


---

Attachment

new doctest


---

Comment by kini created at 2011-03-24 22:53:02

I folded in the doctest from the current patch at #10570, also by Maarten.


---

Comment by jdemeyer created at 2011-04-07 19:56:57

Resolution: fixed
