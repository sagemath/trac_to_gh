# Issue 10232: Incomplete cython search path in setup.py

archive/issues_010232.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  robertwb jdemeyer\n\nThe `setup.py` for cython modules \n* does not record dependencies on C/C++ headers, \n* incorrectly assumes that all C/C++ headers end in '.h'.\nI think both are undesirable. In particular, C++ headers often do not end in '.h', for example STL-style headers tend to do away with file extensions altogether. But `setup.py` relies on this:\n\n```\n   if not found_include:\n       if path[-2:] != '.h':  # there are implicit headers from distutils, etc\n           raise IOError, \"could not find dependency %s included in %s.\"%(path, filename)\n```\n\nI also don't get what \"implicit headers from distutil\" are; The above if-clause really discards all C headers from the dependency list. \n\nI've modified `setup.py` to add all C/C++ headers to the dependencies and made sure that the relevant directories are searched for them. Patch is attached.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10233\n\n",
    "created_at": "2010-11-07T19:37:52Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7",
    "title": "Incomplete cython search path in setup.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10232",
    "user": "vbraun"
}
```
Assignee: GeorgSWeber

CC:  robertwb jdemeyer

The `setup.py` for cython modules 
* does not record dependencies on C/C++ headers, 
* incorrectly assumes that all C/C++ headers end in '.h'.
I think both are undesirable. In particular, C++ headers often do not end in '.h', for example STL-style headers tend to do away with file extensions altogether. But `setup.py` relies on this:

```
   if not found_include:
       if path[-2:] != '.h':  # there are implicit headers from distutils, etc
           raise IOError, "could not find dependency %s included in %s."%(path, filename)
```

I also don't get what "implicit headers from distutil" are; The above if-clause really discards all C headers from the dependency list. 

I've modified `setup.py` to add all C/C++ headers to the dependencies and made sure that the relevant directories are searched for them. Patch is attached.

Issue created by migration from https://trac.sagemath.org/ticket/10233





---

archive/issue_comments_104261.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-08T02:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104261",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_104262.json:
```json
{
    "body": "I can build (`sage -ba`) the sage-4.6 library successfully with the patch.",
    "created_at": "2010-11-08T02:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104262",
    "user": "vbraun"
}
```

I can build (`sage -ba`) the sage-4.6 library successfully with the patch.



---

archive/issue_comments_104263.json:
```json
{
    "body": "With sage-4.6.1.alpha0 + #10094 + #10214 + this patch + several other (hopefully unrelated) patches, I get\n\n```\nBuilding modified file sage/numerical/backends/generic_backend.pyx.\nTraceback (most recent call last):\n  File \"setup.py\", line 860, in <module>\n    queue = compile_command_list(ext_modules, deps)\n  File \"setup.py\", line 820, in compile_command_list\n    dep_file, dep_time = deps.newest_dep(f,m)\n  File \"setup.py\", line 727, in newest_dep\n    for f in self.all_deps(filename, ext_module):\n  File \"setup.py\", line 710, in all_deps\n    deps.update(self.all_deps(f, ext_module, path))\n  File \"setup.py\", line 708, in all_deps\n    for f in self.immediate_deps(filename, ext_module):\n  File \"setup.py\", line 690, in immediate_deps\n    self._deps[filename] = self.parse_deps(filename, ext_module)\n  File \"setup.py\", line 680, in parse_deps\n    raise IOError, \"could not find dependency %s included in %s.\"%(path, filename)\nIOError: could not find dependency float.h included in sage/numerical/backends/glpk_backend.pxd.\nsage: There was an error installing modified sage library code.\n```\n",
    "created_at": "2010-11-08T10:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104263",
    "user": "jdemeyer"
}
```

With sage-4.6.1.alpha0 + #10094 + #10214 + this patch + several other (hopefully unrelated) patches, I get

```
Building modified file sage/numerical/backends/generic_backend.pyx.
Traceback (most recent call last):
  File "setup.py", line 860, in <module>
    queue = compile_command_list(ext_modules, deps)
  File "setup.py", line 820, in compile_command_list
    dep_file, dep_time = deps.newest_dep(f,m)
  File "setup.py", line 727, in newest_dep
    for f in self.all_deps(filename, ext_module):
  File "setup.py", line 710, in all_deps
    deps.update(self.all_deps(f, ext_module, path))
  File "setup.py", line 708, in all_deps
    for f in self.immediate_deps(filename, ext_module):
  File "setup.py", line 690, in immediate_deps
    self._deps[filename] = self.parse_deps(filename, ext_module)
  File "setup.py", line 680, in parse_deps
    raise IOError, "could not find dependency %s included in %s."%(path, filename)
IOError: could not find dependency float.h included in sage/numerical/backends/glpk_backend.pxd.
sage: There was an error installing modified sage library code.
```




---

archive/issue_comments_104264.json:
```json
{
    "body": "I get the same error as above on sage-4.6.1.alpha0 with *only this patch* applied.",
    "created_at": "2010-11-08T10:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104264",
    "user": "jdemeyer"
}
```

I get the same error as above on sage-4.6.1.alpha0 with *only this patch* applied.



---

archive/issue_comments_104265.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-11-08T10:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104265",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_104266.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-08T15:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104266",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_104267.json:
```json
{
    "body": "The `glpk_backend.pyx` was apparently added between sage-4.6 and 4.6.1.alpha0. It uses the `float.h` header which gcc installs in the somewhat odd location `/usr/lib/gcc/x86_64-redhat-linux/4.5.1/include`. Though its perfectly legal for the C compiler to install system headers anywhere as long as it is in the default header search path.\n\nSince there is no good way to determine the header search path except for parsing the output of `cpp -v`, I'll change the dependency discovery to only raise errors for `*.{pyx,pxd,pxi}` files. I tested it with the glpk patch #10043 applied and it builds the sage library successfully.",
    "created_at": "2010-11-08T15:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104267",
    "user": "vbraun"
}
```

The `glpk_backend.pyx` was apparently added between sage-4.6 and 4.6.1.alpha0. It uses the `float.h` header which gcc installs in the somewhat odd location `/usr/lib/gcc/x86_64-redhat-linux/4.5.1/include`. Though its perfectly legal for the C compiler to install system headers anywhere as long as it is in the default header search path.

Since there is no good way to determine the header search path except for parsing the output of `cpp -v`, I'll change the dependency discovery to only raise errors for `*.{pyx,pxd,pxi}` files. I tested it with the glpk patch #10043 applied and it builds the sage library successfully.



---

archive/issue_comments_104268.json:
```json
{
    "body": "I am looking at this patch as part of getting your ppl work into sage-on-gentoo.\nOne question about this part of the patch:\n\n```\n+include_dirs = ['%s/include'%SAGE_LOCAL,\n+                '%s/include/csage'%SAGE_LOCAL,\n+                '%s/sage/sage/ext'%SAGE_DEVEL,\n+                '%s/sage/c_lib/include'%SAGE_DEVEL]\n```\n\nWhy do you add the last bit: %s/sage/c_lib/include'%SAGE_DEVEL, this\njust duplicate the content of '%s/include/csage'%SAGE_LOCAL which should be\nin place already. In any case one of the two is superfluous (and make my\nporting work harder).",
    "created_at": "2011-01-08T21:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104268",
    "user": "fbissey"
}
```

I am looking at this patch as part of getting your ppl work into sage-on-gentoo.
One question about this part of the patch:

```
+include_dirs = ['%s/include'%SAGE_LOCAL,
+                '%s/include/csage'%SAGE_LOCAL,
+                '%s/sage/sage/ext'%SAGE_DEVEL,
+                '%s/sage/c_lib/include'%SAGE_DEVEL]
```

Why do you add the last bit: %s/sage/c_lib/include'%SAGE_DEVEL, this
just duplicate the content of '%s/include/csage'%SAGE_LOCAL which should be
in place already. In any case one of the two is superfluous (and make my
porting work harder).



---

archive/issue_comments_104269.json:
```json
{
    "body": "Thanks, I didn't realize that this is just a symlink. So `%s/sage/c_lib/include'%SAGE_DEVEL` should not be added to `include_dirs`.",
    "created_at": "2011-01-08T22:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104269",
    "user": "vbraun"
}
```

Thanks, I didn't realize that this is just a symlink. So `%s/sage/c_lib/include'%SAGE_DEVEL` should not be added to `include_dirs`.



---

archive/issue_comments_104270.json:
```json
{
    "body": "I've updated the patch to remove the duplicated `'%s/sage/c_lib/include'%SAGE_DEVEL` and to get the actual gcc include directory.",
    "created_at": "2011-01-12T04:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104270",
    "user": "vbraun"
}
```

I've updated the patch to remove the duplicated `'%s/sage/c_lib/include'%SAGE_DEVEL` and to get the actual gcc include directory.



---

archive/issue_comments_104271.json:
```json
{
    "body": "Ok I will test this later along with ppl (and possibly the mpmath bump) but right now \nI am trying to finish off the OS X port of sage-on-gentoo (got two seriously sick\npackages over there: polybori and iml).",
    "created_at": "2011-01-12T09:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104271",
    "user": "fbissey"
}
```

Ok I will test this later along with ppl (and possibly the mpmath bump) but right now 
I am trying to finish off the OS X port of sage-on-gentoo (got two seriously sick
packages over there: polybori and iml).



---

archive/issue_comments_104272.json:
```json
{
    "body": "I've applied this to OS X 10.5, 10.6, and linux and had no problems after testing a variety of other tickets (including #10039, #9972, #9918).  I don't feel qualified to give this a final positive review but it seems fine to me.",
    "created_at": "2011-01-13T06:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104272",
    "user": "mhampton"
}
```

I've applied this to OS X 10.5, 10.6, and linux and had no problems after testing a variety of other tickets (including #10039, #9972, #9918).  I don't feel qualified to give this a final positive review but it seems fine to me.



---

archive/issue_comments_104273.json:
```json
{
    "body": "I am looking at this patch again. I am not sure about the last two lines in this section:\n\n```\nextra_include_dirs = ['%s/include/python2.6'%SAGE_LOCAL, \n                 # finally, standard C/C++ include dirs \n                 '/usr/local/include/',    \n                 '/usr/include'] \n```\n\nAre they really necessary? Shouldn't a standard compiler look into these by default. After all the \nother -I... arguments have been searched without success. Furthermore in a scenario where\nsomeone has installed their own compiler and want to use it rather the system, and have even installed\nthere own libraries compiled with it (like a prefix basically but it doesn't have to be that complete) that\nmeans system headers may be put before their own installed headers. It is not a very nice situation\nwhich may be hard to debug.\n\nOf course you could argue that it is not a likely scenario but it could happen. There may be more\npeople than we think that use their own compilers rather than the system one.",
    "created_at": "2011-01-20T22:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104273",
    "user": "fbissey"
}
```

I am looking at this patch again. I am not sure about the last two lines in this section:

```
extra_include_dirs = ['%s/include/python2.6'%SAGE_LOCAL, 
                 # finally, standard C/C++ include dirs 
                 '/usr/local/include/',    
                 '/usr/include'] 
```

Are they really necessary? Shouldn't a standard compiler look into these by default. After all the 
other -I... arguments have been searched without success. Furthermore in a scenario where
someone has installed their own compiler and want to use it rather the system, and have even installed
there own libraries compiled with it (like a prefix basically but it doesn't have to be that complete) that
means system headers may be put before their own installed headers. It is not a very nice situation
which may be hard to debug.

Of course you could argue that it is not a likely scenario but it could happen. There may be more
people than we think that use their own compilers rather than the system one.



---

archive/issue_comments_104274.json:
```json
{
    "body": "Note that `include_dirs` / `extra_include_dirs` are only the directories searched for dependencies. If the dependencies are newer than the cython source, the cython module is recompiled. But these directories are not passed on to the cython compilation. \n\nArguably `/usr/include` and friends is not necessary. Listing it here only means that if you upgrade the system compiler then the cython modules will be rebuilt. Although a rare occurrence, I think that this is how it should be.",
    "created_at": "2011-01-20T23:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104274",
    "user": "vbraun"
}
```

Note that `include_dirs` / `extra_include_dirs` are only the directories searched for dependencies. If the dependencies are newer than the cython source, the cython module is recompiled. But these directories are not passed on to the cython compilation. 

Arguably `/usr/include` and friends is not necessary. Listing it here only means that if you upgrade the system compiler then the cython modules will be rebuilt. Although a rare occurrence, I think that this is how it should be.



---

archive/issue_comments_104275.json:
```json
{
    "body": "I can see the sense in that. I may have an opportunity to see how everything pans out from a gentoo prefix on OS X,\nsince sage-on-gentoo runs there now for all intent and purposes.",
    "created_at": "2011-01-20T23:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104275",
    "user": "fbissey"
}
```

I can see the sense in that. I may have an opportunity to see how everything pans out from a gentoo prefix on OS X,
since sage-on-gentoo runs there now for all intent and purposes.



---

archive/issue_comments_104276.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-02-01T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104276",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_104277.json:
```json
{
    "body": "I have also tested on some platforms and I am satisfied with the patch itself\nafter careful examination. So I will take the responsibility of giving it a\npositive review.",
    "created_at": "2011-02-01T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104277",
    "user": "fbissey"
}
```

I have also tested on some platforms and I am satisfied with the patch itself
after careful examination. So I will take the responsibility of giving it a
positive review.



---

archive/issue_comments_104278.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-02-07T08:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104278",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_104279.json:
```json
{
    "body": "See #10751 for trouble caused by this patch.  Likely, this means that I will unmerge this patch in sage-4.6.2.rc0.",
    "created_at": "2011-02-11T10:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104279",
    "user": "jdemeyer"
}
```

See #10751 for trouble caused by this patch.  Likely, this means that I will unmerge this patch in sage-4.6.2.rc0.



---

archive/issue_comments_104280.json:
```json
{
    "body": "#10751 is a different bug. I'm currently rewriting the setup.py and found already a couple of bugs that prevented it from picking up all dependencies. In fact, I start to wonder why it worked at all for so long. Maybe people were running `sage -ba` instead of complaining? I know I did a couple of times... \n\nIn any case, if you unmerge this patch then you'll just add back in one more bug.",
    "created_at": "2011-02-11T11:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104280",
    "user": "vbraun"
}
```

#10751 is a different bug. I'm currently rewriting the setup.py and found already a couple of bugs that prevented it from picking up all dependencies. In fact, I start to wonder why it worked at all for so long. Maybe people were running `sage -ba` instead of complaining? I know I did a couple of times... 

In any case, if you unmerge this patch then you'll just add back in one more bug.



---

archive/issue_comments_104281.json:
```json
{
    "body": "In cases like this, I think the status-quo (not merging this patch) is better than merging a patch which is known to create at least one bug.",
    "created_at": "2011-02-11T14:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104281",
    "user": "jdemeyer"
}
```

In cases like this, I think the status-quo (not merging this patch) is better than merging a patch which is known to create at least one bug.



---

archive/issue_comments_104282.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2011-02-15T13:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104282",
    "user": "jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_104283.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2011-02-15T13:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104283",
    "user": "jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_104284.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2011-02-15T13:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104284",
    "user": "jdemeyer"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_104285.json:
```json
{
    "body": "Superseded by #10751, the patch in that ticket fixes Jeroen's issue.",
    "created_at": "2011-02-18T13:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104285",
    "user": "vbraun"
}
```

Superseded by #10751, the patch in that ticket fixes Jeroen's issue.



---

archive/issue_comments_104286.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2011-02-19T13:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104286",
    "user": "vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_104287.json:
```json
{
    "body": "I should have said: The patch in this ticket solves the ticket, but introduces another bug with is fixed in #10751. \n\nI'm setting this ticket back to positive review since it does fix the issue in this ticket and has been reviewed. All that is left is for somebody else to review #10751.",
    "created_at": "2011-02-19T13:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104287",
    "user": "vbraun"
}
```

I should have said: The patch in this ticket solves the ticket, but introduces another bug with is fixed in #10751. 

I'm setting this ticket back to positive review since it does fix the issue in this ticket and has been reviewed. All that is left is for somebody else to review #10751.



---

archive/issue_comments_104288.json:
```json
{
    "body": "Attachment [trac_10233_fix_cython_include_path.patch](tarball://root/attachments/some-uuid/ticket10233/trac_10233_fix_cython_include_path.patch) by vbraun created at 2011-02-19 13:49:56\n\nremoved unnecessary print statement",
    "created_at": "2011-02-19T13:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104288",
    "user": "vbraun"
}
```

Attachment [trac_10233_fix_cython_include_path.patch](tarball://root/attachments/some-uuid/ticket10233/trac_10233_fix_cython_include_path.patch) by vbraun created at 2011-02-19 13:49:56

removed unnecessary print statement



---

archive/issue_comments_104289.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-03-08T21:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10232#issuecomment-104289",
    "user": "jdemeyer"
}
```

Resolution: fixed
