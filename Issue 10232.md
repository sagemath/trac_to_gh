# Issue 10232: Incomplete cython search path in setup.py

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2010-11-07 19:37:52

Assignee: GeorgSWeber

CC:  robertwb jdemeyer

The `setup.py` for cython modules 
  * does not record dependencies on C/C++ headers, 
  * incorrectly assumes that all C/C++ headers end in '.h'.
I think both are undesirable. In particular, C++ headers often do not end in '.h', for example STL-style headers tend to do away with file extensions altogether. But `setup.py` relies on this:

```
   if not found_include:
       if path[-2:] != '.h':  # there are implicit headers from distutils, etc
           raise IOError, "could not find dependency %s included in %s."%(path, filename)
```

I also don't get what "implicit headers from distutil" are; The above if-clause really discards all C headers from the dependency list. 

I've modified `setup.py` to add all C/C++ headers to the dependencies and made sure that the relevant directories are searched for them. Patch is attached.


---

Comment by vbraun created at 2010-11-08 02:40:56

Changing status from new to needs_review.


---

Comment by vbraun created at 2010-11-08 02:40:56

I can build (`sage -ba`) the sage-4.6 library successfully with the patch.


---

Comment by jdemeyer created at 2010-11-08 10:28:06

With sage-4.6.1.alpha0 + #10094 + #10214 + this patch + several other (hopefully unrelated) patches, I get

```
Building modified file sage/numerical/backends/generic_backend.pyx.
Traceback (most recent call last):
  File "setup.py", line 860, in <module>
    queue = compile_command_list(ext_modules, deps)
  File "setup.py", line 820, in compile_command_list
    dep_file, dep_time = deps.newest_dep(f,m)
  File "setup.py", line 727, in newest_dep
    for f in self.all_deps(filename, ext_module):
  File "setup.py", line 710, in all_deps
    deps.update(self.all_deps(f, ext_module, path))
  File "setup.py", line 708, in all_deps
    for f in self.immediate_deps(filename, ext_module):
  File "setup.py", line 690, in immediate_deps
    self._deps[filename] = self.parse_deps(filename, ext_module)
  File "setup.py", line 680, in parse_deps
    raise IOError, "could not find dependency %s included in %s."%(path, filename)
IOError: could not find dependency float.h included in sage/numerical/backends/glpk_backend.pxd.
sage: There was an error installing modified sage library code.
```



---

Comment by jdemeyer created at 2010-11-08 10:50:46

I get the same error as above on sage-4.6.1.alpha0 with _only this patch_ applied.


---

Comment by jdemeyer created at 2010-11-08 10:50:46

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2010-11-08 15:33:48

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2010-11-08 15:33:48

The `glpk_backend.pyx` was apparently added between sage-4.6 and 4.6.1.alpha0. It uses the `float.h` header which gcc installs in the somewhat odd location `/usr/lib/gcc/x86_64-redhat-linux/4.5.1/include`. Though its perfectly legal for the C compiler to install system headers anywhere as long as it is in the default header search path.

Since there is no good way to determine the header search path except for parsing the output of `cpp -v`, I'll change the dependency discovery to only raise errors for `*.{pyx,pxd,pxi}` files. I tested it with the glpk patch #10043 applied and it builds the sage library successfully.


---

Comment by fbissey created at 2011-01-08 21:17:08

I am looking at this patch as part of getting your ppl work into sage-on-gentoo.
One question about this part of the patch:

```
+include_dirs = ['%s/include'%SAGE_LOCAL,
+                '%s/include/csage'%SAGE_LOCAL,
+                '%s/sage/sage/ext'%SAGE_DEVEL,
+                '%s/sage/c_lib/include'%SAGE_DEVEL]
```

Why do you add the last bit: %s/sage/c_lib/include'%SAGE_DEVEL, this
just duplicate the content of '%s/include/csage'%SAGE_LOCAL which should be
in place already. In any case one of the two is superfluous (and make my
porting work harder).


---

Comment by vbraun created at 2011-01-08 22:04:48

Thanks, I didn't realize that this is just a symlink. So `%s/sage/c_lib/include'%SAGE_DEVEL` should not be added to `include_dirs`.


---

Comment by vbraun created at 2011-01-12 04:02:37

I've updated the patch to remove the duplicated `'%s/sage/c_lib/include'%SAGE_DEVEL` and to get the actual gcc include directory.


---

Comment by fbissey created at 2011-01-12 09:44:34

Ok I will test this later along with ppl (and possibly the mpmath bump) but right now 
I am trying to finish off the OS X port of sage-on-gentoo (got two seriously sick
packages over there: polybori and iml).


---

Comment by mhampton created at 2011-01-13 06:50:56

I've applied this to OS X 10.5, 10.6, and linux and had no problems after testing a variety of other tickets (including #10039, #9972, #9918).  I don't feel qualified to give this a final positive review but it seems fine to me.


---

Comment by fbissey created at 2011-01-20 22:34:04

I am looking at this patch again. I am not sure about the last two lines in this section:

```
extra_include_dirs = ['%s/include/python2.6'%SAGE_LOCAL, 
                 # finally, standard C/C++ include dirs 
                 '/usr/local/include/',    
                 '/usr/include'] 
```

Are they really necessary? Shouldn't a standard compiler look into these by default. After all the 
other -I... arguments have been searched without success. Furthermore in a scenario where
someone has installed their own compiler and want to use it rather the system, and have even installed
there own libraries compiled with it (like a prefix basically but it doesn't have to be that complete) that
means system headers may be put before their own installed headers. It is not a very nice situation
which may be hard to debug.

Of course you could argue that it is not a likely scenario but it could happen. There may be more
people than we think that use their own compilers rather than the system one.


---

Comment by vbraun created at 2011-01-20 23:01:31

Note that `include_dirs` / `extra_include_dirs` are only the directories searched for dependencies. If the dependencies are newer than the cython source, the cython module is recompiled. But these directories are not passed on to the cython compilation. 

Arguably `/usr/include` and friends is not necessary. Listing it here only means that if you upgrade the system compiler then the cython modules will be rebuilt. Although a rare occurrence, I think that this is how it should be.


---

Comment by fbissey created at 2011-01-20 23:25:33

I can see the sense in that. I may have an opportunity to see how everything pans out from a gentoo prefix on OS X,
since sage-on-gentoo runs there now for all intent and purposes.


---

Comment by fbissey created at 2011-02-01 09:21:26

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2011-02-01 09:21:26

I have also tested on some platforms and I am satisfied with the patch itself
after careful examination. So I will take the responsibility of giving it a
positive review.


---

Comment by jdemeyer created at 2011-02-07 08:14:04

Resolution: fixed


---

Comment by jdemeyer created at 2011-02-11 10:52:59

See #10751 for trouble caused by this patch.  Likely, this means that I will unmerge this patch in sage-4.6.2.rc0.


---

Comment by vbraun created at 2011-02-11 11:09:53

#10751 is a different bug. I'm currently rewriting the setup.py and found already a couple of bugs that prevented it from picking up all dependencies. In fact, I start to wonder why it worked at all for so long. Maybe people were running `sage -ba` instead of complaining? I know I did a couple of times... 

In any case, if you unmerge this patch then you'll just add back in one more bug.


---

Comment by jdemeyer created at 2011-02-11 14:05:56

In cases like this, I think the status-quo (not merging this patch) is better than merging a patch which is known to create at least one bug.


---

Comment by jdemeyer created at 2011-02-15 13:51:42

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-02-15 13:51:42

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-02-15 13:51:55

Changing status from new to needs_work.


---

Comment by vbraun created at 2011-02-18 13:06:49

Superseded by #10751, the patch in that ticket fixes Jeroen's issue.


---

Comment by vbraun created at 2011-02-19 13:19:58

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2011-02-19 13:19:58

I should have said: The patch in this ticket solves the ticket, but introduces another bug with is fixed in #10751. 

I'm setting this ticket back to positive review since it does fix the issue in this ticket and has been reviewed. All that is left is for somebody else to review #10751.


---

Attachment

removed unnecessary print statement


---

Comment by jdemeyer created at 2011-03-08 21:45:51

Resolution: fixed
