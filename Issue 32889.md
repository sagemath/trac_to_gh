# Issue 32889: Incorrect result from trig_reduce()

Issue created by migration from https://trac.sagemath.org/ticket/33126

Original creator: @dreitzle

Original creation time: 2022-01-07 16:18:00

Keywords: trig_reduce

In the following example, trig_reduce produces a wrong result:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.9. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: var('x');
sage: testexp = cos(arccos(sqrt(x^2 + 1))/2)**5*sin(arccos(sqrt(x^2 + 1))/2)**3;
sage: testexp.trig_reduce()
-1/16*I*sqrt(x^2 + 1) - 1/16*I
```

There is an underlying problem in maxima, where trigreduce() throws an error, which i reported upstream: [#3896](https://sourceforge.net/p/maxima/bugs/3896/). I found many examples of expressions like this which maxima can't handle, but usually, the error is also visible in sage:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.9. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: var('x');
sage: testexp2 = cos(1/2*acos(x))^2*sin(1/2*acos(x))^2;
sage: testexp2.trig_reduce()
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/usr/lib/python3.9/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    731             try:
--> 732                 self._name = parent._create(value, name=name)
    733             except (TypeError, RuntimeError, ValueError) as x:

/usr/lib/python3.9/site-packages/sage/interfaces/maxima_lib.py in _create(self, value, name)
    598             else:
--> 599                 self.set(name, value)
    600         except RuntimeError as error:

/usr/lib/python3.9/site-packages/sage/interfaces/maxima_lib.py in set(self, var, value)
    506         cmd = '%s : %s$'%(var, value.rstrip(';'))
--> 507         self.eval(cmd)
    508 

/usr/lib/python3.9/site-packages/sage/interfaces/maxima_lib.py in _eval_line(self, line, locals, reformat, **kwds)
    452                 if statement:
--> 453                     maxima_eval("#$%s$" % statement)
    454         if not reformat:

/usr/lib/python3.9/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.EclObject.__call__ (/var/tmp/portage/sci-mathematics/sage-9.4-r2/work/sage-9.4/src-python3_9/build/cythonized/sage/libs/ecl.c:8709)()
    853         lispargs = EclObject(list(args))
--> 854         return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))
    855 

/usr/lib/python3.9/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_apply (/var/tmp/portage/sci-mathematics/sage-9.4-r2/work/sage-9.4/src-python3_9/build/cythonized/sage/libs/ecl.c:5991)()
    364     if error != NULL:
--> 365         raise RuntimeError("ECL says: {}".format(
    366             ecl_string_to_python(error)))

RuntimeError: ECL says: In function CAR, the value of the first argument is
  1
which is not of the expected type LIST

During handling of the above exception, another exception occurred:

TypeError                                 Traceback (most recent call last)
<ipython-input-3-396f7eedf21b> in <module>
----> 1 testexp2.trig_reduce()

/usr/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.reduce_trig (/var/tmp/portage/sci-mathematics/sage-9.4-r2/work/sage-9.4/src-python3_9/build/cythonized/sage/symbolic/expression.cpp:31251)()
   5096         else:
   5097             cmd = 'trigreduce(%s,%s)'%(M.name(),'_SAGE_VAR_'+str(var))
-> 5098         ans = P(cmd)
   5099         return self.parent()(ans)
   5100 

/usr/lib/python3.9/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    293 
    294         if isinstance(x, str):
--> 295             return cls(self, x, name=name)
    296         try:
    297             # Special methods do not and should not have an option to

/usr/lib/python3.9/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    732                 self._name = parent._create(value, name=name)
    733             except (TypeError, RuntimeError, ValueError) as x:
--> 734                 raise TypeError(x)
    735 
    736     def _latex_(self):

TypeError: ECL says: In function CAR, the value of the first argument is
  1
which is not of the expected type LIST
```

For the first expression above, maxima produces a similar error:

```
Maxima 5.45.1 https://maxima.sourceforge.io
using Lisp SBCL 1.4.9
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) trigreduce(cos(acos(sqrt(x^2 + 1))/2)^5*sin(acos(sqrt(x^2 + 1))/2)^3);

Maxima encountered a Lisp error:

 The value
   -1
 is not of type
   LIST

Automatically continuing.
To enable the Lisp debugger set *debugger-hook* to nil.
```

Sage however just shows a wrong result, which is worse.


---

Comment by chapoton created at 2022-01-07 19:21:15

one again a matter of domain:real versus domain:complex ?

```
maxima: domain:complex;
complex
maxima: trigreduce(cos(acos(sqrt(x^2 + 1))/2)^5*sin(acos(sqrt(x^2 + 1))/2)^3);
((-%i*sqrt(x^2+1))-%i)/16
```



---

Comment by @dreitzle created at 2022-01-07 19:43:48

Ah, you are right of course.
But the result

```
((-%i*sqrt(x^2+1))-%i)/16
```

is still incorrect. Should i create a maxima bug for this, since
it might be a different problem than those lisp errors although it
appears for the same kind of expressions?
