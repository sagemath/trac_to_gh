# Issue 15481: Implement the __init_extra__ protocol of categories for Cython classes.

archive/issues_015481.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/15718\n\n",
    "created_at": "2014-01-23T17:20:20Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Implement the __init_extra__ protocol of categories for Cython classes.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15481",
    "user": "https://github.com/nthiery"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/15718





---

archive/issue_comments_199743.json:
```json
{
    "body": "It would probably be rather easy:\n\nCurrently, we only look into the mro of the class; if the class is a Python class, then it is a subclass of the category's parent class (since the quest for `__init_extra__` takes place after category initialisation). But in the case of Cython class, we simply need to look explicitly into *both* the class' mro and the category's parent class' mro.\n\nIt would detect a lot of Cython classes in which the call to `Parent.__init__` happens too early for `__init_extra__` to work... But these would be exactly the classes that currently do not allow Python subclasses.",
    "created_at": "2014-01-23T18:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199743",
    "user": "https://github.com/simon-king-jena"
}
```

It would probably be rather easy:

Currently, we only look into the mro of the class; if the class is a Python class, then it is a subclass of the category's parent class (since the quest for `__init_extra__` takes place after category initialisation). But in the case of Cython class, we simply need to look explicitly into *both* the class' mro and the category's parent class' mro.

It would detect a lot of Cython classes in which the call to `Parent.__init__` happens too early for `__init_extra__` to work... But these would be exactly the classes that currently do not allow Python subclasses.



---

archive/issue_comments_199744.json:
```json
{
    "body": "Replying to [comment:1 SimonKing]:\n> It would probably be rather easy:\n> \n> Currently, we only look into the mro of the class; if the class is a Python class, then it is a subclass of the category's parent class (since the quest for `__init_extra__` takes place after category initialisation). But in the case of Cython class, we simply need to look explicitly into *both* the class' mro and the category's parent class' mro.\n\n\n+1!\n\nFor the record: this will require calling\nsage.misc.structure.getattr_from_other_class, to emulate the parent\nbeing an instance of the category's parent class.",
    "created_at": "2014-01-24T09:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199744",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:1 SimonKing]:
> It would probably be rather easy:
> 
> Currently, we only look into the mro of the class; if the class is a Python class, then it is a subclass of the category's parent class (since the quest for `__init_extra__` takes place after category initialisation). But in the case of Cython class, we simply need to look explicitly into *both* the class' mro and the category's parent class' mro.


+1!

For the record: this will require calling
sage.misc.structure.getattr_from_other_class, to emulate the parent
being an instance of the category's parent class.



---

archive/issue_comments_199745.json:
```json
{
    "body": "Replying to [comment:2 nthiery]:\n> For the record: this will require calling\n> sage.misc.structure.getattr_from_other_class, to emulate the parent\n> being an instance of the category's parent class.\n\n\nI disagree. If I recall correctly, we look up the *whole* class hierarchy and execute *all* `__init_extra__` methods that we can find. `getattr_from_other_class` would only return *one* `__init_extra__`, but we want all, and thus we need to go up both the Cython class' and the category's parent class' mro.",
    "created_at": "2014-01-24T10:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199745",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:2 nthiery]:
> For the record: this will require calling
> sage.misc.structure.getattr_from_other_class, to emulate the parent
> being an instance of the category's parent class.


I disagree. If I recall correctly, we look up the *whole* class hierarchy and execute *all* `__init_extra__` methods that we can find. `getattr_from_other_class` would only return *one* `__init_extra__`, but we want all, and thus we need to go up both the Cython class' and the category's parent class' mro.



---

archive/issue_comments_199746.json:
```json
{
    "body": "Replying to [comment:3 SimonKing]:\n> If I recall correctly, we look up the *whole* class hierarchy and execute *all* `__init_extra__` methods that we can find.\n\n\nYes!\n\nStill, some magic will be needed to bind each such method to the\nobject and call it (by default Python refuses to bind a method of a\nclass to a non-instance of that class); that's were\n`getattr_from_other_class` (or some subpiece thereof) will come into\nplay.",
    "created_at": "2014-01-24T10:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199746",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:3 SimonKing]:
> If I recall correctly, we look up the *whole* class hierarchy and execute *all* `__init_extra__` methods that we can find.


Yes!

Still, some magic will be needed to bind each such method to the
object and call it (by default Python refuses to bind a method of a
class to a non-instance of that class); that's were
`getattr_from_other_class` (or some subpiece thereof) will come into
play.



---

archive/issue_comments_199747.json:
```json
{
    "body": "Replying to [comment:4 nthiery]:\n> Still, some magic will be needed to bind each such method to the\n> object and call it (by default Python refuses to bind a method of a\n> class to a non-instance of that class); that's were\n> `getattr_from_other_class` (or some subpiece thereof) will come into\n> play.\n\n\nDo we need to bind it? We just want to *call* it.",
    "created_at": "2014-01-24T10:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199747",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:4 nthiery]:
> Still, some magic will be needed to bind each such method to the
> object and call it (by default Python refuses to bind a method of a
> class to a non-instance of that class); that's were
> `getattr_from_other_class` (or some subpiece thereof) will come into
> play.


Do we need to bind it? We just want to *call* it.



---

archive/issue_comments_199748.json:
```json
{
    "body": "Replying to [comment:5 SimonKing]:\n> Do we need to bind it? We just want to *call* it.\n\n\nSuch as:\n\n```\nsage: R.<x,y> = ZZ[]\nsage: C = Algebras(ZZ).parent_class\nsage: C.__init_extra__.__func__(R)\n```",
    "created_at": "2014-01-24T12:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199748",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 SimonKing]:
> Do we need to bind it? We just want to *call* it.


Such as:

```
sage: R.<x,y> = ZZ[]
sage: C = Algebras(ZZ).parent_class
sage: C.__init_extra__.__func__(R)
```



---

archive/issue_comments_199749.json:
```json
{
    "body": "I just tested: When one empties the coercion cache and the coerce_from_list, then calling `C.__init_extra__.__func__(R)` will fill it again, which is its purpose. So, it works without binding.",
    "created_at": "2014-01-24T12:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199749",
    "user": "https://github.com/simon-king-jena"
}
```

I just tested: When one empties the coercion cache and the coerce_from_list, then calling `C.__init_extra__.__func__(R)` will fill it again, which is its purpose. So, it works without binding.



---

archive/issue_comments_199750.json:
```json
{
    "body": "Replying to [comment:7 SimonKing]:\n> I just tested: When one empties the coercion cache and the coerce_from_list, then calling `C.__init_extra__.__func__(R)` will fill it again, which is its purpose. So, it works without binding.\n\n\nWell ... that works when `C.__init_extra__` is an unbound method that has a `__func__` attribute. Likely all unbound methods do, so you've probably dealt with the case that `__init_extra__` is an unbound method. But attributes aren't necessarily! I think only unbound methods bind when called as attributes on instances. Other objects just get called. But that's a case you should test for if you want this to be properly compatible with python's inheritance. Unbound methods aren't the only things that lead to callable attributes on instances.",
    "created_at": "2014-01-24T15:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199750",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:7 SimonKing]:
> I just tested: When one empties the coercion cache and the coerce_from_list, then calling `C.__init_extra__.__func__(R)` will fill it again, which is its purpose. So, it works without binding.


Well ... that works when `C.__init_extra__` is an unbound method that has a `__func__` attribute. Likely all unbound methods do, so you've probably dealt with the case that `__init_extra__` is an unbound method. But attributes aren't necessarily! I think only unbound methods bind when called as attributes on instances. Other objects just get called. But that's a case you should test for if you want this to be properly compatible with python's inheritance. Unbound methods aren't the only things that lead to callable attributes on instances.



---

archive/issue_comments_199751.json:
```json
{
    "body": "I guess it's fair enough to write in the specifications of the protocol that __init_extra__ shall be a method. And if some day we have a serious use case (which I kind of doubt), it will always be time to generalize the protocol.",
    "created_at": "2014-01-25T11:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199751",
    "user": "https://github.com/nthiery"
}
```

I guess it's fair enough to write in the specifications of the protocol that __init_extra__ shall be a method. And if some day we have a serious use case (which I kind of doubt), it will always be time to generalize the protocol.



---

archive/issue_comments_199752.json:
```json
{
    "body": "Replying to [comment:9 nthiery]:\n> I guess it's fair enough to write in the specifications of the protocol that __init_extra__ shall be a method.\n\n\nYou'll have to be careful how you formulate that: `cdef` classes can have methods too (some custom cython object of course) and their unbound versions specifically call themselves \"method\" and have no `__func__` attribute. They are callable, though, further suggesting one should probably check if the attribute is callable and if not, see if there is a __func__ attribute that is callable (or some safe permutation of this that performs better)\n\n> And if some day we have a serious use case (which I kind of doubt), it will always be time to generalize the protocol.\n\n\nFamous last words... I've seen many cases happen in sage where little design issues (which, at the time perpetrated seemed perfectly reasonable) lead to weird, unforseen and silent failures. The problem this ticket is trying to fix is one of them.",
    "created_at": "2014-01-25T19:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199752",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:9 nthiery]:
> I guess it's fair enough to write in the specifications of the protocol that __init_extra__ shall be a method.


You'll have to be careful how you formulate that: `cdef` classes can have methods too (some custom cython object of course) and their unbound versions specifically call themselves "method" and have no `__func__` attribute. They are callable, though, further suggesting one should probably check if the attribute is callable and if not, see if there is a __func__ attribute that is callable (or some safe permutation of this that performs better)

> And if some day we have a serious use case (which I kind of doubt), it will always be time to generalize the protocol.


Famous last words... I've seen many cases happen in sage where little design issues (which, at the time perpetrated seemed perfectly reasonable) lead to weird, unforseen and silent failures. The problem this ticket is trying to fix is one of them.



---

archive/issue_comments_199753.json:
```json
{
    "body": "Replying to [comment:10 nbruin]:\n> You'll have to be careful how you formulate that: `cdef` classes can have methods too (some custom cython object of course) and their unbound versions specifically call themselves \"method\" and have no `__func__` attribute.\n\n\nNote that the idea is to go up `self.__class__.mro()` on the one hand, and `self.category().parent_class.mro()`, on the other hand. The former is no problem, since self is an instance of its class and thus we don't need the `__func__` attribute. The latter is (currently, at least) no problem, since parent classes of categories are Python classes and thus have `__func__` on their methods. Or am I mistaken?",
    "created_at": "2014-01-25T21:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199753",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:10 nbruin]:
> You'll have to be careful how you formulate that: `cdef` classes can have methods too (some custom cython object of course) and their unbound versions specifically call themselves "method" and have no `__func__` attribute.


Note that the idea is to go up `self.__class__.mro()` on the one hand, and `self.category().parent_class.mro()`, on the other hand. The former is no problem, since self is an instance of its class and thus we don't need the `__func__` attribute. The latter is (currently, at least) no problem, since parent classes of categories are Python classes and thus have `__func__` on their methods. Or am I mistaken?



---

archive/issue_comments_199754.json:
```json
{
    "body": "Replying to [comment:11 SimonKing]:\n> Note that the idea is to go up `self.__class__.mro()` on the one hand, and `self.category().parent_class.mro()`, on the other hand. The former is no problem, since self is an instance of its class and thus we don't need the `__func__` attribute. The latter is (currently, at least) no problem, since parent classes of categories are Python classes and thus have `__func__` on their methods. Or am I mistaken?\n\nWell, anything can be assigned to attributes in principle, regardless of whether something is a python class or not. Should we ever migrate to Python 3 then there are no unbound instancemethods at all: they are just plain functions there.\n\nSo I'd say:\n* check if `__init_extra__.im_func` exists (this indicates an `instancemethod` object). If so, perhaps check if `__init_extra__.im_self` is None (unbound method). If it does, then call `im_func`.\n* otherwise, just call `__init_extra__`.\nIt's hardly more coding work and should be far more robust.",
    "created_at": "2014-01-26T04:56:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199754",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:11 SimonKing]:
> Note that the idea is to go up `self.__class__.mro()` on the one hand, and `self.category().parent_class.mro()`, on the other hand. The former is no problem, since self is an instance of its class and thus we don't need the `__func__` attribute. The latter is (currently, at least) no problem, since parent classes of categories are Python classes and thus have `__func__` on their methods. Or am I mistaken?

Well, anything can be assigned to attributes in principle, regardless of whether something is a python class or not. Should we ever migrate to Python 3 then there are no unbound instancemethods at all: they are just plain functions there.

So I'd say:
* check if `__init_extra__.im_func` exists (this indicates an `instancemethod` object). If so, perhaps check if `__init_extra__.im_self` is None (unbound method). If it does, then call `im_func`.
* otherwise, just call `__init_extra__`.
It's hardly more coding work and should be far more robust.



---

archive/issue_comments_199755.json:
```json
{
    "body": "Replying to [comment:12 nbruin]:\n> So I'd say:\n> * check if `__init_extra__.im_func` exists (this indicates an `instancemethod` object).\n\n\nor use inspect.ismethod.",
    "created_at": "2014-01-26T08:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199755",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:12 nbruin]:
> So I'd say:
> * check if `__init_extra__.im_func` exists (this indicates an `instancemethod` object).


or use inspect.ismethod.



---

archive/issue_events_046155.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46155"
}
```



---

archive/issue_events_046156.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46156"
}
```



---

archive/issue_events_046157.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46157"
}
```



---

archive/issue_events_046158.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46158"
}
```



---

archive/issue_events_046159.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46159"
}
```



---

archive/issue_comments_199756.json:
```json
{
    "body": "Ping to myself. I think the `__init_extra__` can be called similar to what I did in #18756/#18758.",
    "created_at": "2015-07-23T15:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199756",
    "user": "https://github.com/simon-king-jena"
}
```

Ping to myself. I think the `__init_extra__` can be called similar to what I did in #18756/#18758.



---

archive/issue_comments_199757.json:
```json
{
    "body": "Very strange. The following does not work, even in Python:\n\n```\n            sage: from sage.structure.element import RingElement\n            sage: class E(RingElement):\n            ....:     def __init__(self, P, n):\n            ....:         self.n = n\n            ....:         RingElement.__init__(self, P)\n            ....:     def _repr_(self):\n            ....:         return \"<{}>\".format(self.n)\n            ....:     def _mul_(self, other):\n            ....:         return self.parent()(self.n*other.n)\n            ....:     def _add_(self, other):\n            ....:         return self.parent()(self.n+other.n)\n            ....:     def _lmul_(self, other):\n            ....:         return self.parent()(self.n*other)\n            sage: class P(Parent):\n            ....:     Element = E\n            sage: p = P(base=ZZ, category=Algebras(ZZ))\n            sage: p.has_coerce_map_from(ZZ)\n            False\n```\nI found that `UnitalAlgebras.ParentMethods.__init_extra__` is called. However, it is claimed that the (absence of a) coerce map from ZZ has already been cached, which means that the clearly existing coercion via multiplication with `p.one()` is not registered.\n\nAt what point is a coercion from ZZ requested *before* calling `__init_extra__`?",
    "created_at": "2015-07-23T16:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199757",
    "user": "https://github.com/simon-king-jena"
}
```

Very strange. The following does not work, even in Python:

```
            sage: from sage.structure.element import RingElement
            sage: class E(RingElement):
            ....:     def __init__(self, P, n):
            ....:         self.n = n
            ....:         RingElement.__init__(self, P)
            ....:     def _repr_(self):
            ....:         return "<{}>".format(self.n)
            ....:     def _mul_(self, other):
            ....:         return self.parent()(self.n*other.n)
            ....:     def _add_(self, other):
            ....:         return self.parent()(self.n+other.n)
            ....:     def _lmul_(self, other):
            ....:         return self.parent()(self.n*other)
            sage: class P(Parent):
            ....:     Element = E
            sage: p = P(base=ZZ, category=Algebras(ZZ))
            sage: p.has_coerce_map_from(ZZ)
            False
```
I found that `UnitalAlgebras.ParentMethods.__init_extra__` is called. However, it is claimed that the (absence of a) coerce map from ZZ has already been cached, which means that the clearly existing coercion via multiplication with `p.one()` is not registered.

At what point is a coercion from ZZ requested *before* calling `__init_extra__`?



---

archive/issue_comments_199758.json:
```json
{
    "body": "Shoot! One needs to do\n\n```\n            ....:     def _lmul_(self, other):\n            ....:         return self.parent().element_class(self.parent(),self.n*other)\n```\nsince `self.parent()(something)` apparently tries to find a coercion from `something.parent()` to `self.parent()`.",
    "created_at": "2015-07-23T16:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199758",
    "user": "https://github.com/simon-king-jena"
}
```

Shoot! One needs to do

```
            ....:     def _lmul_(self, other):
            ....:         return self.parent().element_class(self.parent(),self.n*other)
```
since `self.parent()(something)` apparently tries to find a coercion from `something.parent()` to `self.parent()`.



---

archive/issue_comments_199759.json:
```json
{
    "body": "To make sage start, it was also needed to declare that `MPolynomialRing_libsingular` uses a custom coercion from the base ring. Oops, I just note that the new doctest doesn't pass. Sorry.\n\n---\nNew commits:",
    "created_at": "2015-07-23T16:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199759",
    "user": "https://github.com/simon-king-jena"
}
```

To make sage start, it was also needed to declare that `MPolynomialRing_libsingular` uses a custom coercion from the base ring. Oops, I just note that the new doctest doesn't pass. Sorry.

---
New commits:



---

archive/issue_comments_199760.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-23T16:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199760",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199761.json:
```json
{
    "body": "With the additional commit, tests in sage.structure.parent pass, and I hope they do elsewhere, too.",
    "created_at": "2015-07-23T16:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199761",
    "user": "https://github.com/simon-king-jena"
}
```

With the additional commit, tests in sage.structure.parent pass, and I hope they do elsewhere, too.



---

archive/issue_comments_199762.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-23T16:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199762",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_199763.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-07-24T09:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199763",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199764.json:
```json
{
    "body": "Oops:\n\n```\nsage -t src/sage/algebras/free_algebra.py  # Killed due to segmentation fault\nsage -t src/sage/algebras/letterplace/letterplace_ideal.pyx  # Killed due to segmentation fault\nsage -t src/sage/algebras/letterplace/free_algebra_element_letterplace.pyx  # Killed due to segmentation fault\nsage -t src/sage/algebras/letterplace/free_algebra_letterplace.pyx  # Killed due to segmentation fault\nsage -t src/sage/categories/pushout.py  # 5 doctests failed\nsage -t src/sage/categories/homset.py  # 4 doctests failed\nsage -t src/sage/rings/quotient_ring_element.py  # Killed due to segmentation fault\nsage -t src/sage/rings/ring.pyx  # Killed due to segmentation fault\nsage -t src/sage/rings/quotient_ring.py  # Killed due to segmentation fault\nsage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 35 doctests failed\nsage -t src/sage/rings/polynomial/polynomial_quotient_ring_element.py  # 6 doctests failed\n```\nSorry, I am currently unable to continue work on this. I suppose the solution is to either change the point at which `Parent.__init__` is called (since it tests whether `self.one()` works and multiplication works, it needs to be done rather late), or to indicate that there is a custom coercion that is better than the default coerce map (which is what I did in the case of multivariate polynomial rings).",
    "created_at": "2015-07-24T09:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199764",
    "user": "https://github.com/simon-king-jena"
}
```

Oops:

```
sage -t src/sage/algebras/free_algebra.py  # Killed due to segmentation fault
sage -t src/sage/algebras/letterplace/letterplace_ideal.pyx  # Killed due to segmentation fault
sage -t src/sage/algebras/letterplace/free_algebra_element_letterplace.pyx  # Killed due to segmentation fault
sage -t src/sage/algebras/letterplace/free_algebra_letterplace.pyx  # Killed due to segmentation fault
sage -t src/sage/categories/pushout.py  # 5 doctests failed
sage -t src/sage/categories/homset.py  # 4 doctests failed
sage -t src/sage/rings/quotient_ring_element.py  # Killed due to segmentation fault
sage -t src/sage/rings/ring.pyx  # Killed due to segmentation fault
sage -t src/sage/rings/quotient_ring.py  # Killed due to segmentation fault
sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 35 doctests failed
sage -t src/sage/rings/polynomial/polynomial_quotient_ring_element.py  # 6 doctests failed
```
Sorry, I am currently unable to continue work on this. I suppose the solution is to either change the point at which `Parent.__init__` is called (since it tests whether `self.one()` works and multiplication works, it needs to be done rather late), or to indicate that there is a custom coercion that is better than the default coerce map (which is what I did in the case of multivariate polynomial rings).



---

archive/issue_comments_199765.json:
```json
{
    "body": "I couldn't resist working on it.\n\nIn some cases, the problem is that a parent has not been given a base(ring), however it is initialised in the category of unital algebras, which means that it *has* a base(ring).\n\nShould we perhaps modify `CategoryObject.__init__`, which currently just defines `self._base` and then initialises the category? It could additionally define a base for the parent, if the given category has a base.",
    "created_at": "2015-07-24T14:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199765",
    "user": "https://github.com/simon-king-jena"
}
```

I couldn't resist working on it.

In some cases, the problem is that a parent has not been given a base(ring), however it is initialised in the category of unital algebras, which means that it *has* a base(ring).

Should we perhaps modify `CategoryObject.__init__`, which currently just defines `self._base` and then initialises the category? It could additionally define a base for the parent, if the given category has a base.



---

archive/issue_comments_199766.json:
```json
{
    "body": "Replying to [comment:25 SimonKing]:\n> Should we perhaps modify `CategoryObject.__init__`, which currently just defines `self._base` and then initialises the category? It could additionally define a base for the parent, if the given category has a base.\n\n\nIt looks like a good idea, but would break an awful lot of things. `:-(`.",
    "created_at": "2015-07-24T14:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199766",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:25 SimonKing]:
> Should we perhaps modify `CategoryObject.__init__`, which currently just defines `self._base` and then initialises the category? It could additionally define a base for the parent, if the given category has a base.


It looks like a good idea, but would break an awful lot of things. `:-(`.



---

archive/issue_comments_199767.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-24T15:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199767",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199768.json:
```json
{
    "body": "Now things should work.\n\nChanges:\n- For letterplace rings, one has to call the parent init later, so that the conversions that occur in `__init_extra__` work.\n- In pushout.py, there is one test where a class is defined as a subclass of a parent-class-with-category. By consequence, an instance of that class is not correctly category-initialised.\n- I just realise that I forgot some fixes for tests in homset.py. Here is problematic what I mentioned above: The base ring is not given, but the category has a base ring, and because of the missing base ring, `__init_extra__` fails. Fixing it now...",
    "created_at": "2015-07-24T15:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199768",
    "user": "https://github.com/simon-king-jena"
}
```

Now things should work.

Changes:
- For letterplace rings, one has to call the parent init later, so that the conversions that occur in `__init_extra__` work.
- In pushout.py, there is one test where a class is defined as a subclass of a parent-class-with-category. By consequence, an instance of that class is not correctly category-initialised.
- I just realise that I forgot some fixes for tests in homset.py. Here is problematic what I mentioned above: The base ring is not given, but the category has a base ring, and because of the missing base ring, `__init_extra__` fails. Fixing it now...



---

archive/issue_comments_199769.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-24T15:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199770.json:
```json
{
    "body": "Done! Now tests should pass (at least the previously failed tests should now be fixed...). Needs review!",
    "created_at": "2015-07-24T15:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199770",
    "user": "https://github.com/simon-king-jena"
}
```

Done! Now tests should pass (at least the previously failed tests should now be fixed...). Needs review!



---

archive/issue_comments_199771.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-07-24T15:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199771",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199772.json:
```json
{
    "body": "Replying to [comment:30 SimonKing]:\n> Now tests should pass\n\n\nThey do, on my machine at least.",
    "created_at": "2015-07-25T05:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199772",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:30 SimonKing]:
> Now tests should pass


They do, on my machine at least.



---

archive/issue_comments_199773.json:
```json
{
    "body": "Build fails.",
    "created_at": "2016-10-19T04:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199773",
    "user": "https://github.com/saraedum"
}
```

Build fails.



---

archive/issue_comments_199774.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-19T04:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199774",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199775.json:
```json
{
    "body": "The changes look fine to me. It can be set to positive review once the build errors are fixed.",
    "created_at": "2016-10-19T04:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199775",
    "user": "https://github.com/saraedum"
}
```

The changes look fine to me. It can be set to positive review once the build errors are fixed.



---

archive/issue_comments_199776.json:
```json
{
    "body": "It would be nice to have an explanation of what this branch does and which problem it solves.\n\nI would like to know why traversing the `mro()` this way is a reasonable solution. I don't know anything else in Python which does that. Why not use more standard Python idioms like `super()` calls?",
    "created_at": "2016-10-19T14:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199776",
    "user": "https://github.com/jdemeyer"
}
```

It would be nice to have an explanation of what this branch does and which problem it solves.

I would like to know why traversing the `mro()` this way is a reasonable solution. I don't know anything else in Python which does that. Why not use more standard Python idioms like `super()` calls?



---

archive/issue_comments_199777.json:
```json
{
    "body": "Also: since this code seems to involve categories, why is it in `Parent` and not `CategoryObject`?",
    "created_at": "2016-10-19T14:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199777",
    "user": "https://github.com/jdemeyer"
}
```

Also: since this code seems to involve categories, why is it in `Parent` and not `CategoryObject`?



---

archive/issue_events_046160.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-08T20:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46160"
}
```



---

archive/issue_events_046161.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-08T20:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46161"
}
```



---

archive/issue_comments_199778.json:
```json
{
    "body": "Rebased on 9.2.beta3\n\n---\nNew commits:",
    "created_at": "2020-07-08T20:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199778",
    "user": "https://github.com/mkoeppe"
}
```

Rebased on 9.2.beta3

---
New commits:



---

archive/issue_comments_199779.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2020-07-08T20:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199779",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_events_046162.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T17:11:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46162"
}
```



---

archive/issue_events_046163.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T17:11:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46163"
}
```



---

archive/issue_comments_199780.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199780",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_046164.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46164"
}
```



---

archive/issue_events_046165.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46165"
}
```



---

archive/issue_events_046166.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46166"
}
```



---

archive/issue_events_046167.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46167"
}
```



---

archive/issue_comments_199781.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199781",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_199782.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15481#issuecomment-199782",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_events_046168.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46168"
}
```



---

archive/issue_events_046169.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46169"
}
```



---

archive/issue_events_046170.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46170"
}
```



---

archive/issue_events_046171.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46171"
}
```



---

archive/issue_events_046172.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46172"
}
```



---

archive/issue_events_046173.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15481",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15481#event-46173"
}
```
