# Issue 29718: Reduction from dancing links instance to MILP instance

Issue created by migration from https://trac.sagemath.org/ticket/29955

Original creator: slabbe

Original creation time: 2020-06-24 13:04:55

CC:  slelievre

Following #29338, the proposed branch adds 2 new methods which allows what follows:


```
sage: from sage.combinat.matrices.dancing_links import dlx_solver
sage: rows = [[0,1,2], [3,4,5], [0,1], [2,3,4,5], [0], [1,2,3,4,5]]
sage: d = dlx_solver(rows)
sage: d.one_solution()
[1, 0]
sage: d.one_solution_using_milp_solver()
[0, 1]
sage: d.one_solution_using_milp_solver('Gurobi')
[2, 3]
sage: d.one_solution_using_milp_solver('CLPEX')
[2, 3]
etc.
```


This is based on the new method:

```
sage: p,x = d.to_milp_solver()
sage: p
Boolean Program (no objective, 6 variables, 6 constraints)
sage: x
MIPVariable of dimension 1 
```



---

Comment by slabbe created at 2020-06-24 13:06:36

Changing status from new to needs_review.


---

Comment by slabbe created at 2020-06-24 13:06:36

New commits:


---

Comment by git created at 2020-06-24 13:27:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saliola created at 2020-06-24 18:02:17

I found two issues with the doctests. I'll post them as two separate comments.

First, there is a doctest error (all the variables in the constraints are named `x_` instead of `x_0`, `x_1`, etc.).

```
Running doctests with ID 2020-06-24-13-55-51-1a738b74.
Git branch: u/slabbe/29955
Using --optional=build,cmake,cryptominisat,dochtml,glucose,pycosat,sage,sage_numerical_backends_gurobi
Doctesting 1 file.
sage -t --warn-long 44.8 dancing_links.pyx
**********************************************************************
File "dancing_links.pyx", line 1037, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.to_milp_solver
Failed example:
    p.show()
Expected:
    Maximization:
    <BLANKLINE>
    <BLANKLINE>
    Constraints:
      one 1 in 0-th column: 1.0 <= x_0 + x_1 <= 1.0
      one 1 in 1-th column: 1.0 <= x_0 + x_2 <= 1.0
      one 1 in 2-th column: 1.0 <= x_0 + x_1 <= 1.0
      one 1 in 3-th column: 1.0 <= x_3 <= 1.0
    Variables:
      x_0 is a boolean variable (min=0.0, max=1.0)
      x_1 is a boolean variable (min=0.0, max=1.0)
      x_2 is a boolean variable (min=0.0, max=1.0)
      x_3 is a boolean variable (min=0.0, max=1.0)
Got:
    Maximization:
    <BLANKLINE>
    <BLANKLINE>
    Constraints:
      one 1 in 0-th column: 1.0 <= x_ + x_ <= 1.0
      one 1 in 1-th column: 1.0 <= x_ + x_ <= 1.0
      one 1 in 2-th column: 1.0 <= x_ + x_ <= 1.0
      one 1 in 3-th column: 1.0 <= x_ <= 1.0
    Variables:
      x_ = x_0 is a boolean variable (min=0.0, max=1.0)
      x_ = x_1 is a boolean variable (min=0.0, max=1.0)
      x_ = x_2 is a boolean variable (min=0.0, max=1.0)
      x_ = x_3 is a boolean variable (min=0.0, max=1.0)
**********************************************************************
1 item had failures:
   1 of   8 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.to_milp_solver
    [250 tests, 1 failure, 3.73 s]
----------------------------------------------------------------------
sage -t --warn-long 44.8 dancing_links.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 3.8 seconds
    cpu time: 3.2 seconds
    cumulative wall time: 3.7 seconds
```



---

Comment by saliola created at 2020-06-24 18:07:36

Second, the answer I get from the following doctest does not agree with the answer specified in the doctest.

```
sage: from sage.combinat.matrices.dancing_links import dlx_solver
sage: rows = [[0,1,2], [0,2], [1], [3]]
sage: d = dlx_solver(rows)
sage: d.to_milp_solver("gurobi")
(Boolean Program (no objective, 4 variables, 4 constraints),
 MIPVariable of dimension 1)
```

The doctest says the above should be:

```
sage: d.to_milp_solver('gurobi')   # optional gurobi sage_numerical_backends_gurobi
Boolean Program (no objective, 4 variables, 4 constraints)
```

I'm not sure why this error is not caught by the doctest system.


---

Comment by saliola created at 2020-06-24 18:14:27

Replying to [comment:5 saliola]:
> I'm not sure why this error is not caught by the doctest system.

I just learned about the `--show-skipped` option for `sage -t`. Since `gurobi` is not a sage optional package, I had to specify it explicitly with the `---optional` command. If I run 

```
sage -t --optional=sage,gurobi,sage_numerical_backends_gurobi dancing_links.pyx
```

then I see two doctest failures.


---

Comment by saliola created at 2020-06-24 18:29:26

I made some changes to address the second doctest problem above and I've updated the branch. Hopefully I didn't mess up....
----
New commits:


---

Comment by saliola created at 2020-06-24 18:49:33

OK, it seems I was able to correctly create and set a public branch for this ticket. Any ideas on what to do for the doctest for `p.show()`?


---

Comment by slabbe created at 2020-06-24 19:14:55

Yes indeed, I wanted to write

```
sage: p,x = d.to_milp_solver(solver='Gurobi')
sage: p
Boolean Program (no objective, 6 variables, 6 constraints)
sage: x
MIPVariable of dimension 1 
```

...as you fixed it is okay as well.

On another machine running a more recent version of Sage, with the current public branch, I get:

```
$ sage -version
SageMath version 9.2.beta1, Release Date: 2020-06-13
$ sage -bt --optional=sage,optional,external --show-skipped src/sage/combinat/matrices/dancing_links.pyx
...
sage -t src/sage/combinat/matrices/dancing_links.pyx
    3 gurobi tests not run
    0 tests not run because we ran out of time
    [250 tests, 2.26 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
External software detected for doctesting: 
```


(The licence of my Gurobi licence just expired. I need to renew it.)

So the error with the `x_` in the `p.show()` is weird. Are you able to reproduce it on another machine?


---

Comment by saliola created at 2020-06-24 19:52:15

I was using sage version 9.1rc1 because that is what the branch switched too. I'll update to the develop version and test again.


---

Comment by saliola created at 2020-06-25 17:14:40

I figured out what is causing the error with the `x_` in the `p.show()` command. It is somehow caused by the `sage_numerical_backends_gurobi` optional package. The error is triggered as soon as this package is installed. I am not sure how to report this problem.


---

Comment by saliola created at 2020-06-25 17:33:17

Changing status from needs_review to positive_review.


---

Comment by saliola created at 2020-06-25 17:33:51

Thank you so much for this SÃ©bastien!


---

Comment by mkoeppe created at 2020-06-25 18:36:08

Replying to [comment:11 saliola]:
> I figured out what is causing the error with the `x_` in the `p.show()` command. It is somehow caused by the `sage_numerical_backends_gurobi` optional package. The error is triggered as soon as this package is installed. I am not sure how to report this problem.
Upstream is https://github.com/mkoeppe/sage-numerical-backends-gurobi


---

Comment by slabbe created at 2020-06-25 20:02:57

Thank you for your review Franco!


---

Comment by saliola created at 2020-06-25 20:04:04

Thank you. I created an issue upstream with an example that does not require this ticket; see https://github.com/mkoeppe/sage-numerical-backends-gurobi/issues/2


---

Comment by slabbe created at 2020-06-25 20:06:47

Replying to [comment:14 mkoeppe]:

I just created 
https://github.com/mkoeppe/sage-numerical-backends-gurobi/issues/3


---

Comment by slabbe created at 2020-06-25 20:07:23

oups, we did the same thing at the same time!


---

Comment by mkoeppe created at 2020-06-26 18:13:53

A quick comment. I think `to_milp_solver` should be renamed to `to_milp`. In terminology of `sage.numerical.mip`, "solver" would be an instance of a subclass of `GenericBackend`.


---

Comment by git created at 2020-06-28 19:32:17

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-06-28 19:32:17

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by slabbe created at 2020-06-28 19:33:54

I agree. I just did a commit. Hoping that Volker did not started to merge that ticket while it was on positive review status. Needs review.


---

Comment by mkoeppe created at 2020-06-28 20:56:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-08 19:33:21

Resolution: fixed
