# Issue 29108: replace bashisms in m4/sage_spkg_collect.m4 and m4/sage_spkg_enable.m4

Issue created by migration from https://trac.sagemath.org/ticket/29345

Original creator: mjo

Original creation time: 2020-03-15 22:50:28

CC:  dimpase mkoeppe embray vbraun

Autoconf scripts should be POSIX sh rather than bash, but there are a few bashisms in m4/sage_spkg_collect.m4 and m4/sage_spkg_enable.m4:

  * The quoted newlines `$'\n'`
  * The use of `VAR+=VALUE`

Some of these should be straightforward to fix. The format


```
SAGE_BUILT_PACKAGES+="    $SPKG_NAME \\"$'\n'
```


can be changed to


```
SAGE_BUILT_PACKAGES="$SAGE_BUILT_PACKAGES $SPKG_NAME"
```


since the newline is only used to make the `BUILT_PACKAGES` rule in the resulting Makefile look nice. Changing them to spaces doesn't change what the rule does. I'm not sure about


```
SAGE_PACKAGE_VERSIONS+="vers_$SPKG_NAME = $SPKG_VERSION"$'\n
```


and 


```
SAGE_PACKAGE_DEPENDENCIES+="deps_$SPKG_NAME = $DEPS"$'\n'
```


though, because those are inserted verbatim into the Makefile as rules, and the newlines probably matter.


---

Comment by mkoeppe created at 2020-03-15 22:56:19

I agree in general - do you actually run this with a CONFIG_SHELL other than bash? Is the other configure code clean?


---

Comment by mkoeppe created at 2020-03-15 22:58:59

This should probably be done on top of #29287, which touches the same file


---

Comment by mjo created at 2020-03-15 23:00:20

Things seem to run OK with dash if I comment out the part of configure.ac that forces bash. Of course I can't be sure that it _works_ until I have a suggestion for how to fix `SAGE_PACKAGE_VERSIONS` and `SAGE_PACKAGE_DEPENDENCIES`.


---

Comment by mkoeppe created at 2020-03-16 01:57:31

One way to address this is to make things a liitle more static (see #29114 - "Only ./bootstrap should glob build/pkgs"), also getting rid of GNU-make-isms and macrology in `build/make/Makefile`.

`bootstrap` already emits macro calls for many packages into `m4/sage_spkg_configures.m4`, of three types.
- m4_sinclude([build/pkgs/arb/spkg-configure.m4])
- SAGE_SPKG_CONFIGURE_ARB
- SAGE_SPKG_ENABLE([ninja_build], [optional])
Might as well emit another line for every package that creates whatever is needed in the Makefile.


---

Comment by mjo created at 2020-04-30 00:26:39

Changing status from new to needs_review.


---

Comment by mjo created at 2020-04-30 00:26:39

The printf stuff is going to make anyone reading the code think we're stupid, but it works and didn't involve changing much code. I just completed a full build using `/bin/dash` as my shell.


---

Comment by git created at 2020-04-30 00:34:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-30 01:42:17

Nice on first glance. I'll be happy to do a full review after 9.1 is out


---

Comment by dimpase created at 2020-04-30 06:04:00

it's a bit in vain, as there are bashisms or just "bash required" in several Sage packages.


---

Comment by dimpase created at 2020-04-30 06:05:24

regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something.


---

Comment by mjo created at 2020-04-30 12:11:15

Replying to [comment:9 dimpase]:
> it's a bit in vain, as there are bashisms or just "bash required" in several Sage packages.

Ultimately my goal is to not install any sage packages =)

I'll always need bash installed for other stuff, but ./configure is noticeably faster with dash. It may be a "micro-optimization" but half of what I do lately is re-run ./configure.


---

Comment by mjo created at 2020-04-30 12:14:11

Replying to [comment:10 dimpase]:
> regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something. 

The suggestion there is to print a newline and a space at the end of each line, and then remove the space afterwards. Since all of the lines in question are indented, what I did instead was switch to printing a newline and some spaces at the _beginning_ of each line -- that way the newline is still followed by spaces (and therefore doesn't get dropped), but the spaces aren't "extra" and don't need to be removed.


---

Comment by dimpase created at 2020-05-06 11:57:54

needs rebase.


---

Comment by git created at 2020-05-06 20:07:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2020-05-06 20:07:38

fixed, thanks


---

Comment by dimpase created at 2020-05-07 11:01:06

A interesting test (apart from using dash) would be to use ksh (on OpenBSD - trying this now for lolz) or zsh (the latter is the default on recent macOS, I am told).


---

Comment by mjo created at 2020-05-07 12:34:48

./configure fails with `/bin/sh -> /bin/zsh` at,


```
Checking whether SageMath should install SPKG mpir...
checking gmp.h usability... yes
checking gmp.h presence... yes
checking for gmp.h... yes
checking gmpxx.h usability... yes
checking gmpxx.h presence... yes
checking for gmpxx.h... yes
checking for library containing __gmpq_cmp_z... -lgmp
./configure:break:10258: not in while, until, select, or repeat loop
```


Since it was executed via /bin/sh, I think zsh is already in bourne-shell compatibility mode.


---

Comment by dimpase created at 2020-05-07 13:30:20

ksh also notices a stray break and prints a warning, no error.


---

Comment by dimpase created at 2020-05-08 08:09:19

with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.
The following (needs autotools isntalled, obviously) fixes this:

```diff
-cp "$SAGE_ROOT"/config/config.* .
+autoreconf -ivf
```



---

Comment by dimpase created at 2020-05-08 08:50:57

ditto (ksh/openbsd) - this is how givaro outputs its givaro.pc - which is of course broken this way

```
/------------------ givaro.pc ------------------------
prefix=/home/dima/sagetrac-mirror/local
exec_prefix=/home/dima/sagetrac-mirror/local
libdir=/home/dima/sagetrac-mirror/local/lib
includedir=/home/dima/sagetrac-mirror/local/include

Name: Givaro
Description: C++ library for arithmetic and algebraic computations
URL: https://casys.gricad-pages.univ-grenoble-alpes.fr/givaro
Version: 4.1.1
Requires:
Libs: -L/home/dima/sagetrac-mirror/local/lib -lgivaro  -lgmp -lgmpxx
Cflags: -I${prefix}/include  
\-------------------------------------------------------
```



---

Comment by mjo created at 2020-05-08 15:55:09

Replying to [comment:19 dimpase]:
> with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.
> The following (needs autotools isntalled, obviously) fixes this:
> {{{#!diff
> -cp "$SAGE_ROOT"/config/config.* .
> +autoreconf -ivf
> }}}

That commit mentions only `config.guess`, but it doesn't say what problem it was solving. Maybe copying `config.status` was unintentional.


---

Comment by git created at 2020-05-08 16:07:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-05-08 16:07:56

New commits fix the `break` statements and probably lrcalc.


---

Comment by dimpase created at 2020-05-10 10:22:42

The is also a bug in `build/pkgs/cvxopt/spkg-install.in`, in

```
# Stolen from Gentoo
pkg_libs() {
        pkg-config --libs-only-l $* | \
                sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | \
                tr ' ' '\n' | sort -u | sed -e "s:^-l\(.*\):\1:g" | \
                tr '\n' ';' | sed -e 's:;$::'
}
```

so that on ksh/openbsd I get `CVXOPT_BLAS_LIB="$(pkg_libs blas)"`
gets `;openblas` rather than `openblas`.
Note that 

```
(sage-buildsh) dima@sagemath:sagetrac-mirror$ pkg-config --libs-only-l blas
 -lopenblas
```

outputs a leading  space.

```
$ pkg-config --libs-only-l blas | sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | tr ' ' '\n'

-lopenblas
```

And so the latter outputs an extra blank line, leading to erroneous `;`.
It would suffice to remove the leading spaces from the output of `pkg-config`, say.


---

Comment by dimpase created at 2020-05-10 10:36:09

The following does the job to fix the latter

```diff
--- a/build/pkgs/cvxopt/spkg-install.in
+++ b/build/pkgs/cvxopt/spkg-install.in
@@ -2,7 +2,7 @@ cd src
 
 # Stolen from Gentoo
 pkg_libs() {
-       pkg-config --libs-only-l $* | \
+       pkg-config --libs-only-l $* | sed -e 's/^ *//g' | \
                sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | \
                tr ' ' '\n' | sort -u | sed -e "s:^-l\(.*\):\1:g" | \
                tr '\n' ';' | sed -e 's:;$::'
```



---

Comment by dimpase created at 2020-05-10 10:41:37

And here are already merged upstream fixes for comment:20 problem

https://github.com/linbox-team/givaro/pull/157

https://github.com/linbox-team/linbox/pull/255

https://github.com/linbox-team/fflas-ffpack/pull/308


---

Comment by mjo created at 2020-05-10 12:17:04

Lol that's like ten pipelines just to parse a space delimited list and replace `-l` with `;`. I think this does the same thing, and works with bash, dash, ksh, zsh, and posh:


```
# The BLAS_LIB and LAPACK_LIB variables (among others) in cvxopt's setup.py
# are passed in as colon-delimited strings. So, for example, if your blas
# lib flags are "-lblas -lcblas", then cvxopt wants "blas;cblas". The
# following function takes a package name, feeds it to pkg-config, and then
# converts it to the proper format.
cvxopt_libs() {
    CVXOPT_LIBS=""
    SKIP_LIBS="pthread m"
    for PKGCONFIG_LIB in $(pkg-config --libs-only-l "${1}"); do
	for SKIP_LIB in ${SKIP_LIBS}; do
	    if [ "${PKGCONFIG_LIB}" = "-l${SKIP_LIB}" ]; then
		# break out of the big loop if we're skipping this lib
		continue 2
	    fi
	done
	# replace leading "-l" with ";"
	CVXOPT_LIBS="${CVXOPT_LIBS};${PKGCONFIG_LIB#-l}"
    done
    # strip the leading ";" from ";foo;bar" before output
    echo "${CVXOPT_LIBS#;}"
}
```



---

Comment by dimpase created at 2020-05-10 12:35:02

care to add the latter to the branch?


---

Comment by mjo created at 2020-05-10 13:06:11

Yeah I will after I'm sure that it works. I'll probably also update the Gentoo ebuild. Some ad-hoc testing shows differences between the two, but it looks like they're all mistakes in the existing version; some things aren't handled correctly after `-lpthread` or `-lm` are removed, for example:


```
$ pkg-config --libs-only-l librsvg-2.0
-lrsvg-2 -lm -lgio-2.0 -lgdk_pixbuf-2.0 -lgobject-2.0 -lglib-2.0 -lcairo

# sage/gentoo version
$ ./orig.sh librsvg-2.0
cairo;gdk_pixbuf-2.0;glib-2.0;gobject-2.0;rsvg-2-lgio-2.0

# the new one
$ ./cvxopt_libs.sh librsvg-2.0
rsvg-2;gio-2.0;gdk_pixbuf-2.0;gobject-2.0;glib-2.0;cairo
```



---

Comment by dimpase created at 2020-05-12 09:06:08

I opened #29677 to track OpenBSD quirks.


---

Comment by mjo created at 2020-05-13 12:09:48

There are more issues with cvxopt in both Gentoo and Sage... for example, if you don't set one of the `*_LIB` variables, then it defaults to adding `/usr/lib` to your search path which will pick up the wrong libraries on most Gentoo systems (you want `/usr/lib64` instead). Passing in the empty string to override sort-of works, but not for the `*_INC_DIR` variables, meaning that we need special cases everywhere to do it right. I've opened an issue with cvxopt to see if they can make our lives easier by treating the empty string as "no extra libs/paths" rather than "one extra lib/path consisting of the empty string."


---

Comment by git created at 2020-05-13 21:49:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-05-13 21:51:37

The latest commit lets me build cvxopt against the suitesparse SPKG using ksh.

Now that I'm familiar, I have a feeling that some more work is going to be needed on the suitesparse spkg-configure.m4 ticket to keep cvxopt working if suitesparse comes from the system. The new function I added should help if that proves true.


---

Comment by dimpase created at 2020-05-15 09:03:03

Is this ready for review? Just checking.


---

Comment by git created at 2020-05-15 12:11:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2020-05-15 12:12:33

Replying to [comment:34 dimpase]:
> Is this ready for review? Just checking.

Yes, I've added one more commit with your pc-file patches for givaro, linbox, and fflas-ffpack. There are no more (known) problems with non-bash shells.


---

Comment by mkoeppe created at 2020-05-16 01:33:19

OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?


---

Comment by mjo created at 2020-05-16 13:06:18

Replying to [comment:37 mkoeppe]:
> OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?

Sure. I'm running a full build/ptestlong today to ensure that my new sympow package works with #29673. If you don't beat me to it, I'll rebase on Monday most likely.


---

Comment by git created at 2020-05-18 13:14:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-05-26 14:15:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2020-05-26 14:16:10

That last one is just a rebase onto the rebase in #29098.


---

Comment by dimpase created at 2020-05-28 22:03:58

oops, needs another rebase, over the beta0 that just came out.


---

Comment by git created at 2020-05-30 12:20:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2020-05-30 12:21:28

Done again.


---

Comment by dimpase created at 2020-06-04 00:44:55

lgtm


---

Comment by dimpase created at 2020-06-04 00:44:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-15 11:36:17

Changing priority from major to critical.


---

Comment by dimpase created at 2020-06-15 11:36:17

rebased over 9.2.beta1 - making this critical, as we're approaching a rebase hell state with this ticket not merged for 4 weeks.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-15 13:59:54

0e66a0a is already merged on Volker's branch.


---

Comment by vbraun created at 2020-06-21 22:37:08

Resolution: fixed


---

Comment by dimpase created at 2020-09-03 15:53:08

Replying to [comment:23 mjo]:
> New commits fix the `break` statements and probably lrcalc.
no, lrcalc on OpenBSD is still broken due to this `print` issue. Probably we really need to run a modern autoconf on it and replace the resulting scripts.
