# Issue 20086: Common TestSuite for MIP backends

archive/issues_020086.json:
```json
{
    "body": "CC:  @dimpase @nathanncohen @videlec @vbraun @nthiery\n\nKeywords: lp\n\nI think the backends should be tested using a common `TestSuite`. Right now each backend uses its own doctests, which have slightly diverged from each other, so there is nothing (other than the fact that they were the result of copy-paste from each other) that ensures consistency. (#20296 fixes several wrong doctests in `GenericBackend`, from which I tried to copy-paste, for example.)\n\nPointers on how to do this would be welcome.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20323\n\n",
    "created_at": "2016-03-30T16:35:03Z",
    "labels": [
        "numerical",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Common TestSuite for MIP backends",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20086",
    "user": "@mkoeppe"
}
```
CC:  @dimpase @nathanncohen @videlec @vbraun @nthiery

Keywords: lp

I think the backends should be tested using a common `TestSuite`. Right now each backend uses its own doctests, which have slightly diverged from each other, so there is nothing (other than the fact that they were the result of copy-paste from each other) that ensures consistency. (#20296 fixes several wrong doctests in `GenericBackend`, from which I tried to copy-paste, for example.)

Pointers on how to do this would be welcome.

Issue created by migration from https://trac.sagemath.org/ticket/20323





---

archive/issue_comments_276741.json:
```json
{
    "body": "within the existing framework it's easy to create a separate module, say, lp_backend_tests, and do such tests there.\nNot sure how to minimize the bloat, though, as each function should have doctests...\n\nNote that total consistency is hard to get, as each backend has its own ideas on how, say, to number and order constraints. E.g., IIRC, gurobi does automatic conversions of some particular kinds of constraints.",
    "created_at": "2016-03-31T16:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276741",
    "user": "@dimpase"
}
```

within the existing framework it's easy to create a separate module, say, lp_backend_tests, and do such tests there.
Not sure how to minimize the bloat, though, as each function should have doctests...

Note that total consistency is hard to get, as each backend has its own ideas on how, say, to number and order constraints. E.g., IIRC, gurobi does automatic conversions of some particular kinds of constraints.



---

archive/issue_comments_276742.json:
```json
{
    "body": "Not ready for review yet, but I'm hoping that perhaps someone familiar with the `TestSuite` mechanism could tell me whether I'm on the right track with this initial patch on this ticket.\n----\nNew commits:",
    "created_at": "2016-04-02T07:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276742",
    "user": "@mkoeppe"
}
```

Not ready for review yet, but I'm hoping that perhaps someone familiar with the `TestSuite` mechanism could tell me whether I'm on the right track with this initial patch on this ticket.
----
New commits:



---

archive/issue_comments_276743.json:
```json
{
    "body": "It looks like you are. Any method that starts with `_test` gets run by `TestSuite`. Although I am not really in favor of any test mutating the object in question.\n\nAlso, is there a reason why `GenericBackend` needs to inherit from `SageObject` (as opposed to just the Python `object`)? I am pretty sure this is strictly needed...",
    "created_at": "2016-04-02T14:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276743",
    "user": "@tscrim"
}
```

It looks like you are. Any method that starts with `_test` gets run by `TestSuite`. Although I am not really in favor of any test mutating the object in question.

Also, is there a reason why `GenericBackend` needs to inherit from `SageObject` (as opposed to just the Python `object`)? I am pretty sure this is strictly needed...



---

archive/issue_comments_276744.json:
```json
{
    "body": "Thanks for taking a look, Travis.\n\nReplying to [comment:4 tscrim]:\n> Also, is there a reason why `GenericBackend` needs to inherit from `SageObject` (as opposed to just the Python `object`)?\n\n`SageObject` provides some of the basic testing infrastructure, such as `._test_not_implemented_methods`.\nWell, there's also `sage.misc.sage_unittest.PythonObjectWithTests`, but I can't seem to `cimport` it to make it a base class of `GenericBackend`. So I guess I'll stick with `SageObject`.",
    "created_at": "2016-04-06T03:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276744",
    "user": "@mkoeppe"
}
```

Thanks for taking a look, Travis.

Replying to [comment:4 tscrim]:
> Also, is there a reason why `GenericBackend` needs to inherit from `SageObject` (as opposed to just the Python `object`)?

`SageObject` provides some of the basic testing infrastructure, such as `._test_not_implemented_methods`.
Well, there's also `sage.misc.sage_unittest.PythonObjectWithTests`, but I can't seem to `cimport` it to make it a base class of `GenericBackend`. So I guess I'll stick with `SageObject`.



---

archive/issue_comments_276745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T06:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276745",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2016-04-06T07:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276746",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_276747.json:
```json
{
    "body": "Branch is on top of various closed/reviewed LP tickets from #20302. Will rebase on top of next 'develop' later.",
    "created_at": "2016-04-06T07:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276747",
    "user": "@mkoeppe"
}
```

Branch is on top of various closed/reviewed LP tickets from #20302. Will rebase on top of next 'develop' later.



---

archive/issue_comments_276748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T07:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276748",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276749.json:
```json
{
    "body": "Hi Matthias!\n\nJust had a brief look at your TestSuite usage. This sounds very sensible indeed.\n\nInheriting from PythonObjectWithTests would indeed make sense; however since it's currently a plain Python class, one can't inherit from it in a Cython class. This could be fixed though.\n\nCheers,\n                                       Nicolas",
    "created_at": "2016-04-06T15:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276749",
    "user": "@nthiery"
}
```

Hi Matthias!

Just had a brief look at your TestSuite usage. This sounds very sensible indeed.

Inheriting from PythonObjectWithTests would indeed make sense; however since it's currently a plain Python class, one can't inherit from it in a Cython class. This could be fixed though.

Cheers,
                                       Nicolas



---

archive/issue_comments_276750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-08T17:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276750",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276751.json:
```json
{
    "body": "There are two types of `_test_...` methods, which are illustrated by the following examples:\n\n\n```\n    ## This test method is written as an instance method that works\n    ## even if variables and constraints have already been added to the backend.\n    ## The test makes changes to the backend.\n    def _test_add_linear_constraints(self, **options):\n        \"\"\"\n        Run tests on the method :meth:`.add_linear_constraints`.\n\n        TESTS:\n\n        Test, with an actual working backend, that the test works even if the problem\n        is not empty at the beginning::\n\n            sage: from sage.numerical.backends.generic_backend import get_solver\n            sage: p = get_solver(solver='GLPK')\n            sage: p.add_variables(2)\n            1\n            sage: p.add_linear_constraint([[0, 17], [1, 89]], None, 42)\n            sage: p._test_add_linear_constraints()\n        \"\"\"\n        tester = self._tester(**options)\n        nrows_before = self.nrows()\n        nrows_added = 5\n        self.add_linear_constraints(nrows_added, None, 2)\n        nrows_after = self.nrows()\n        # Test correct number of rows\n        tester.assertEqual(nrows_after, nrows_before+nrows_added, \"Added the wrong number of rows\")\n        # Test contents of the new rows are correct (sparse zero)\n        for i in range(nrows_before, nrows_after):\n            tester.assertEqual(self.row(i), ([], []))\n            tester.assertEqual(self.row_bounds(i), (None, 2.0))\n\n    ## Any test methods involving calls to 'solve' are set up as class methods,\n    ## which make a fresh instance of the backend.\n    @classmethod\n    def _test_solve(cls, tester=None, **options):\n        \"\"\"\n        Trivial test for the solve method.\n\n        TEST::\n\n            sage: from sage.numerical.backends.generic_backend import GenericBackend\n            sage: p = GenericBackend()\n            sage: p._test_solve()\n            Traceback (most recent call last):\n            ...\n            NotImplementedError: ...\n        \"\"\"\n        p = cls()                         # fresh instance of the backend\n        if tester is None:\n            tester = p._tester(**options)\n        # From doctest of GenericBackend.solve:\n        tester.assertIsNone(p.add_linear_constraints(5, 0, None))\n        tester.assertIsNone(p.add_col(range(5), range(5)))\n        tester.assertEqual(p.solve(), 0)\n        tester.assertIsNone(p.objective_coefficient(0,1))\n        from sage.numerical.mip import MIPSolverException\n        #with tester.assertRaisesRegexp(MIPSolverException, \"unbounded\") as cm:  ## --- too specific\n        with tester.assertRaises(MIPSolverException) as cm:   # unbounded\n            p.solve()\n```\n\n\nI've translated these from existing doctests (either from `GenericBackend` or some real backend) by hand. `_test_solve` already reveals another bug in the CVXOPT backend. \nThe plan is to use #20376 to semi-automatically add new `_test` methods.",
    "created_at": "2016-04-08T17:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276751",
    "user": "@mkoeppe"
}
```

There are two types of `_test_...` methods, which are illustrated by the following examples:


```
    ## This test method is written as an instance method that works
    ## even if variables and constraints have already been added to the backend.
    ## The test makes changes to the backend.
    def _test_add_linear_constraints(self, **options):
        """
        Run tests on the method :meth:`.add_linear_constraints`.

        TESTS:

        Test, with an actual working backend, that the test works even if the problem
        is not empty at the beginning::

            sage: from sage.numerical.backends.generic_backend import get_solver
            sage: p = get_solver(solver='GLPK')
            sage: p.add_variables(2)
            1
            sage: p.add_linear_constraint([[0, 17], [1, 89]], None, 42)
            sage: p._test_add_linear_constraints()
        """
        tester = self._tester(**options)
        nrows_before = self.nrows()
        nrows_added = 5
        self.add_linear_constraints(nrows_added, None, 2)
        nrows_after = self.nrows()
        # Test correct number of rows
        tester.assertEqual(nrows_after, nrows_before+nrows_added, "Added the wrong number of rows")
        # Test contents of the new rows are correct (sparse zero)
        for i in range(nrows_before, nrows_after):
            tester.assertEqual(self.row(i), ([], []))
            tester.assertEqual(self.row_bounds(i), (None, 2.0))

    ## Any test methods involving calls to 'solve' are set up as class methods,
    ## which make a fresh instance of the backend.
    @classmethod
    def _test_solve(cls, tester=None, **options):
        """
        Trivial test for the solve method.

        TEST::

            sage: from sage.numerical.backends.generic_backend import GenericBackend
            sage: p = GenericBackend()
            sage: p._test_solve()
            Traceback (most recent call last):
            ...
            NotImplementedError: ...
        """
        p = cls()                         # fresh instance of the backend
        if tester is None:
            tester = p._tester(**options)
        # From doctest of GenericBackend.solve:
        tester.assertIsNone(p.add_linear_constraints(5, 0, None))
        tester.assertIsNone(p.add_col(range(5), range(5)))
        tester.assertEqual(p.solve(), 0)
        tester.assertIsNone(p.objective_coefficient(0,1))
        from sage.numerical.mip import MIPSolverException
        #with tester.assertRaisesRegexp(MIPSolverException, "unbounded") as cm:  ## --- too specific
        with tester.assertRaises(MIPSolverException) as cm:   # unbounded
            p.solve()
```


I've translated these from existing doctests (either from `GenericBackend` or some real backend) by hand. `_test_solve` already reveals another bug in the CVXOPT backend. 
The plan is to use #20376 to semi-automatically add new `_test` methods.



---

archive/issue_comments_276752.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-08T17:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276752",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_276753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-08T17:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276753",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_276754.json:
```json
{
    "body": "Rebased on top of 7.2.beta3 + #20326.",
    "created_at": "2016-04-08T17:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276754",
    "user": "@mkoeppe"
}
```

Rebased on top of 7.2.beta3 + #20326.



---

archive/issue_comments_276755.json:
```json
{
    "body": "Needs review, especially regarding my use or abuse of the testing framework...",
    "created_at": "2016-04-08T17:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276755",
    "user": "@mkoeppe"
}
```

Needs review, especially regarding my use or abuse of the testing framework...



---

archive/issue_comments_276756.json:
```json
{
    "body": "You should not implement `_test_*` method that modifies the object. I am not sure there is any control in which order things are executed. It would be better in this case to not use the test suite. I would rather have a file tests.py that is only made of doctests.\n\nMoreover, it would make sense to also have comparison between different implementations. You can start with\n\n```\nsage: milps = []\nsage: milps.append(MixedIntegerLinearProgram(solver='cplex')  # optional - cplex\nsage: milps.append(MixedIntegerLinearProgram(solver='coin')    # optional - cbc\n```\n\nand then loop over the elements in milps.",
    "created_at": "2016-04-08T20:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276756",
    "user": "@videlec"
}
```

You should not implement `_test_*` method that modifies the object. I am not sure there is any control in which order things are executed. It would be better in this case to not use the test suite. I would rather have a file tests.py that is only made of doctests.

Moreover, it would make sense to also have comparison between different implementations. You can start with

```
sage: milps = []
sage: milps.append(MixedIntegerLinearProgram(solver='cplex')  # optional - cplex
sage: milps.append(MixedIntegerLinearProgram(solver='coin')    # optional - cbc
```

and then loop over the elements in milps.



---

archive/issue_comments_276757.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> You should not implement `_test_*` method that modifies the object. I am not sure there is any control in which order things are executed. \n\nAs I pointed out in the comment above `_test_add_linear_constraints` in comment 13, these instance methods are written in a way that the order does not matter.\n\nThe second example uses a class method and runs its tests on fresh instances, so it does not make modifications.\n\nIf it is policy that `_test` methods cannot modify the object, then I can rewrite all tests as class methods like in the second example.\n\nI would rather like to avoid using doctests (in fact I'm trying to replace the superficial, copy-paste-driven testing that is there now); and `TestSuite` seems like exactly the right thing to enforce the API of concrete implementations of an abstract class.",
    "created_at": "2016-04-08T21:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276757",
    "user": "@mkoeppe"
}
```

Replying to [comment:17 vdelecroix]:
> You should not implement `_test_*` method that modifies the object. I am not sure there is any control in which order things are executed. 

As I pointed out in the comment above `_test_add_linear_constraints` in comment 13, these instance methods are written in a way that the order does not matter.

The second example uses a class method and runs its tests on fresh instances, so it does not make modifications.

If it is policy that `_test` methods cannot modify the object, then I can rewrite all tests as class methods like in the second example.

I would rather like to avoid using doctests (in fact I'm trying to replace the superficial, copy-paste-driven testing that is there now); and `TestSuite` seems like exactly the right thing to enforce the API of concrete implementations of an abstract class.



---

archive/issue_comments_276758.json:
```json
{
    "body": "From taking a quick look at what you are testing, it looks more like you should have a separate file with test functions that takes a backend, creates an instance of it, and runs the basic tests, and then have a \"master\" function which takes the backend and feeds it to each of those functions (or some small variant of this). IMO, this is a better way to do the things that you want, and it means for each (new) backend, you only have to add a test to pass it to the \"master\" function. It also has a bit of a fringe benefit of consolidating the testing of the backends.\n\nIt is possible the user will want to run `TestSuite` on a particular instance, and will be quite surprised if the object has mutated. Another valid option would be to make a copy of the instance and do the mutations to that.",
    "created_at": "2016-04-09T07:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276758",
    "user": "@tscrim"
}
```

From taking a quick look at what you are testing, it looks more like you should have a separate file with test functions that takes a backend, creates an instance of it, and runs the basic tests, and then have a "master" function which takes the backend and feeds it to each of those functions (or some small variant of this). IMO, this is a better way to do the things that you want, and it means for each (new) backend, you only have to add a test to pass it to the "master" function. It also has a bit of a fringe benefit of consolidating the testing of the backends.

It is possible the user will want to run `TestSuite` on a particular instance, and will be quite surprised if the object has mutated. Another valid option would be to make a copy of the instance and do the mutations to that.



---

archive/issue_comments_276759.json:
```json
{
    "body": "Or maybe putting the _test_* methods on the backends, with each _test_method starting by creating a new instance.\n\nCheers,\n                                Nicolas",
    "created_at": "2016-04-09T20:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276759",
    "user": "@nthiery"
}
```

Or maybe putting the _test_* methods on the backends, with each _test_method starting by creating a new instance.

Cheers,
                                Nicolas



---

archive/issue_comments_276760.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-09T22:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276760",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276761.json:
```json
{
    "body": "Replying to [comment:20 nthiery]:\n> Or maybe putting the _test_* methods on the backends, with each _test_method starting by creating a new instance.\n\nThanks Nicolas, Vincent, and Travis for your comments. \n\nI agree, making changes to the object may be surprising to users who are in the habit of running the testsuite on objects.\n\nI have now converted the `_test_*` methods that were previously making changes into methods that create a new instance. \n(This is in line with what Nicolas suggests.)\n\nAll `_test_*` methods are now actually marked as classmethods, so these methods don't even get access to the instance, so they can't modify it. Here's an example.\n\n```\n    @classmethod\n    def _test_add_linear_constraints(cls, tester=None, **options):\n        \"\"\"\n        Run tests on the method :meth:`.add_linear_constraints`.\n\n        TEST::\n\n            sage: from sage.numerical.backends.generic_backend import GenericBackend\n            sage: p = GenericBackend()\n            sage: p._test_add_linear_constraints()\n            Traceback (most recent call last):\n            ...\n            NotImplementedError\n        \"\"\"\n        p = cls()                         # fresh instance of the backend\n        if tester is None:\n            tester = p._tester(**options)\n        nrows_before = p.nrows()\n        nrows_added = 5\n        p.add_linear_constraints(nrows_added, None, 2)\n        nrows_after = p.nrows()\n        # Test correct number of rows\n        tester.assertEqual(nrows_after, nrows_before+nrows_added, \"Added the wrong number of rows\")\n        # Test contents of the new rows are correct (sparse zero)\n        for i in range(nrows_before, nrows_after):\n            tester.assertEqual(p.row(i), ([], []))\n            tester.assertEqual(p.row_bounds(i), (None, 2.0))\n```\n\n\nSome of you suggested that the tests should be in a different file; but I don't see how that would help. I would rather like to keep them as close as possible to the definitions of the methods in `GenericBackend`; after all the point of the new tests is to tighten the definition of the API of the backends. \n\nThe nice thing about having these `_test_*` methods automatically inherited by all concrete backends is that they cannot just \"forget\" running the tests for them when it would be \"convenient\" to do so.",
    "created_at": "2016-04-09T22:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276761",
    "user": "@mkoeppe"
}
```

Replying to [comment:20 nthiery]:
> Or maybe putting the _test_* methods on the backends, with each _test_method starting by creating a new instance.

Thanks Nicolas, Vincent, and Travis for your comments. 

I agree, making changes to the object may be surprising to users who are in the habit of running the testsuite on objects.

I have now converted the `_test_*` methods that were previously making changes into methods that create a new instance. 
(This is in line with what Nicolas suggests.)

All `_test_*` methods are now actually marked as classmethods, so these methods don't even get access to the instance, so they can't modify it. Here's an example.

```
    @classmethod
    def _test_add_linear_constraints(cls, tester=None, **options):
        """
        Run tests on the method :meth:`.add_linear_constraints`.

        TEST::

            sage: from sage.numerical.backends.generic_backend import GenericBackend
            sage: p = GenericBackend()
            sage: p._test_add_linear_constraints()
            Traceback (most recent call last):
            ...
            NotImplementedError
        """
        p = cls()                         # fresh instance of the backend
        if tester is None:
            tester = p._tester(**options)
        nrows_before = p.nrows()
        nrows_added = 5
        p.add_linear_constraints(nrows_added, None, 2)
        nrows_after = p.nrows()
        # Test correct number of rows
        tester.assertEqual(nrows_after, nrows_before+nrows_added, "Added the wrong number of rows")
        # Test contents of the new rows are correct (sparse zero)
        for i in range(nrows_before, nrows_after):
            tester.assertEqual(p.row(i), ([], []))
            tester.assertEqual(p.row_bounds(i), (None, 2.0))
```


Some of you suggested that the tests should be in a different file; but I don't see how that would help. I would rather like to keep them as close as possible to the definitions of the methods in `GenericBackend`; after all the point of the new tests is to tighten the definition of the API of the backends. 

The nice thing about having these `_test_*` methods automatically inherited by all concrete backends is that they cannot just "forget" running the tests for them when it would be "convenient" to do so.



---

archive/issue_comments_276762.json:
```json
{
    "body": "Some remarks before looking once more at the code:\n\n- It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.\n\n- This approach does not allow to cross check the backends (?).",
    "created_at": "2016-04-09T22:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276762",
    "user": "@videlec"
}
```

Some remarks before looking once more at the code:

- It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.

- This approach does not allow to cross check the backends (?).



---

archive/issue_comments_276763.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-09T23:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276763",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276764.json:
```json
{
    "body": "Replying to [comment:23 vdelecroix]:\n> Some remarks before looking once more at the code:\n> \n> - It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.\n\nIf one wants to write such a test, one can just remove the `@`classmethod decorator. This makes indeed sense for the various getter methods.  As an example, I have just added the following test method:\n\n```\n    def _test_ncols_nonnegative(self, **options):\n        tester = self._tester(**options)\n        p = self\n        tester.assertGreaterEqual(self.ncols(), 0)\n```\n\n\n> - This approach does not allow to cross check the backends (?).\n\nThe idea is that all backends are checked against the same set of tests. (In contrast to the current doctests, in which each backend decides by copy-paste what is convenient to be tested.)\nI plan to distill a good set of tests by means of #20376 from the existing doctests of the various backends.",
    "created_at": "2016-04-09T23:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276764",
    "user": "@mkoeppe"
}
```

Replying to [comment:23 vdelecroix]:
> Some remarks before looking once more at the code:
> 
> - It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.

If one wants to write such a test, one can just remove the `@`classmethod decorator. This makes indeed sense for the various getter methods.  As an example, I have just added the following test method:

```
    def _test_ncols_nonnegative(self, **options):
        tester = self._tester(**options)
        p = self
        tester.assertGreaterEqual(self.ncols(), 0)
```


> - This approach does not allow to cross check the backends (?).

The idea is that all backends are checked against the same set of tests. (In contrast to the current doctests, in which each backend decides by copy-paste what is convenient to be tested.)
I plan to distill a good set of tests by means of #20376 from the existing doctests of the various backends.



---

archive/issue_comments_276765.json:
```json
{
    "body": "I forgot to remark, I wouldn't want to rely on `copy` so much at the moment, because the nontrivial copy methods of the backends are essentially untested (doctests there to please the patchbot), just like the rest of the API.",
    "created_at": "2016-04-09T23:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276765",
    "user": "@mkoeppe"
}
```

I forgot to remark, I wouldn't want to rely on `copy` so much at the moment, because the nontrivial copy methods of the backends are essentially untested (doctests there to please the patchbot), just like the rest of the API.



---

archive/issue_comments_276766.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-10T00:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276766",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276767.json:
```json
{
    "body": "Replying to [comment:23 vdelecroix]:\n> - It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.\n\nI think now I understand better what you meant. \nIndeed, at least some instance `_test` methods -- such as the `_test` methods for `copy` that I just wrote -- would benefit from being invoked for various examples.",
    "created_at": "2016-04-10T01:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276767",
    "user": "@mkoeppe"
}
```

Replying to [comment:23 vdelecroix]:
> - It would actually be interesting for the tests to have access to the objects. They are non trivially initialized (maximization vs minimization, constraints, etc). Using them as a base (with copy) each test suite would actually run different tests.

I think now I understand better what you meant. 
Indeed, at least some instance `_test` methods -- such as the `_test` methods for `copy` that I just wrote -- would benefit from being invoked for various examples.



---

archive/issue_comments_276768.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-10T01:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276768",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276769.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-10T07:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276769",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276770.json:
```json
{
    "body": "I recall asking how one deals with different backends producing different, albeit equivalent, outputs. E.g. some of them would even introduce extra variables for some constraints (see e.g. [here](http://trac.sagemath.org/ticket/13148#comment:2)). Some backends assign names to constraints automatically.",
    "created_at": "2016-04-11T09:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276770",
    "user": "@dimpase"
}
```

I recall asking how one deals with different backends producing different, albeit equivalent, outputs. E.g. some of them would even introduce extra variables for some constraints (see e.g. [here](http://trac.sagemath.org/ticket/13148#comment:2)). Some backends assign names to constraints automatically.



---

archive/issue_comments_276771.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-11T14:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276771",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_276772.json:
```json
{
    "body": "Note that currently the tests do not pass when `cbc` is installed, see the logs at http://patchbot.sagemath.org/log/20323/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-11%2008:33:06",
    "created_at": "2016-04-11T14:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276772",
    "user": "tmonteil"
}
```

Note that currently the tests do not pass when `cbc` is installed, see the logs at http://patchbot.sagemath.org/log/20323/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-11%2008:33:06



---

archive/issue_comments_276773.json:
```json
{
    "body": "this would also show errors just fine:\nhttp://patchbot.sagemath.org/log/20323/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-11%2008:33:06?short\n\nanyhow, it looks as if there are also errors not related to cbc. Wrong git branch?",
    "created_at": "2016-04-11T15:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276773",
    "user": "@dimpase"
}
```

this would also show errors just fine:
http://patchbot.sagemath.org/log/20323/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-11%2008:33:06?short

anyhow, it looks as if there are also errors not related to cbc. Wrong git branch?



---

archive/issue_comments_276774.json:
```json
{
    "body": "Replying to [comment:34 dimpase]:\n> Wrong git branch?\n\nApparently not, the indicated commit is f40980646e129eeb501a51fd06e99eb98d83a4f3",
    "created_at": "2016-04-11T15:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276774",
    "user": "tmonteil"
}
```

Replying to [comment:34 dimpase]:
> Wrong git branch?

Apparently not, the indicated commit is f40980646e129eeb501a51fd06e99eb98d83a4f3



---

archive/issue_comments_276775.json:
```json
{
    "body": "Yes, lots of tests fail!\nAnd I haven't even really started adding tests.\n\nIt's the whole point of writing this test suite.",
    "created_at": "2016-04-11T15:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276775",
    "user": "@mkoeppe"
}
```

Yes, lots of tests fail!
And I haven't even really started adding tests.

It's the whole point of writing this test suite.



---

archive/issue_comments_276776.json:
```json
{
    "body": "Replying to [comment:32 dimpase]:\n> I recall asking how one deals with different backends producing different, albeit equivalent, outputs. E.g. some of them would even introduce extra variables for some constraints (see e.g. [here](http://trac.sagemath.org/ticket/13148#comment:2)). Some backends assign names to constraints automatically.\n\nThanks for the pointer to that ticket. Yes, the tests need to be written in a way that they accommodate the solvers.",
    "created_at": "2016-04-11T15:46:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276776",
    "user": "@mkoeppe"
}
```

Replying to [comment:32 dimpase]:
> I recall asking how one deals with different backends producing different, albeit equivalent, outputs. E.g. some of them would even introduce extra variables for some constraints (see e.g. [here](http://trac.sagemath.org/ticket/13148#comment:2)). Some backends assign names to constraints automatically.

Thanks for the pointer to that ticket. Yes, the tests need to be written in a way that they accommodate the solvers.



---

archive/issue_comments_276777.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-11T19:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276777",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_276778.json:
```json
{
    "body": "I've split this ticket. Now the branch has only tests that pass; other tests will appear on #20424.\nReady for review.",
    "created_at": "2016-04-11T19:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276778",
    "user": "@mkoeppe"
}
```

I've split this ticket. Now the branch has only tests that pass; other tests will appear on #20424.
Ready for review.



---

archive/issue_comments_276779.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-11T19:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276779",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_276780.json:
```json
{
    "body": "please rebase over the latest beta. there is a small merge conflict:\n\n```\ndiff --cc src/sage/numerical/backends/generic_backend.pyx\nindex aef0cb0,d554470..0000000\n--- a/src/sage/numerical/backends/generic_backend.pyx\n+++ b/src/sage/numerical/backends/generic_backend.pyx\n@@@ -1330,9 -1408,7 +1414,13 @@@ cpdef GenericBackend get_solver(constra\n          sage: p.base_ring()\n          Real Double Field\n          sage: p = get_solver(base_ring=QQ); p\n++<<<<<<< HEAD\n +        <sage.numerical.backends.ppl_backend.PPLBackend object at ...>\n +        sage: p = get_solver(base_ring=ZZ); p\n +        <sage.numerical.backends.ppl_backend.PPLBackend object at ...>\n++=======\n+         <...sage.numerical.backends.ppl_backend.PPLBackend...>\n++>>>>>>> 22511250dd688bba5d98672fb89b0f779fd28e97\n          sage: p.base_ring()\n          Rational Field\n          sage: p = get_solver(base_ring=AA); p\n```\n",
    "created_at": "2016-04-13T19:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276780",
    "user": "@dimpase"
}
```

please rebase over the latest beta. there is a small merge conflict:

```
diff --cc src/sage/numerical/backends/generic_backend.pyx
index aef0cb0,d554470..0000000
--- a/src/sage/numerical/backends/generic_backend.pyx
+++ b/src/sage/numerical/backends/generic_backend.pyx
@@@ -1330,9 -1408,7 +1414,13 @@@ cpdef GenericBackend get_solver(constra
          sage: p.base_ring()
          Real Double Field
          sage: p = get_solver(base_ring=QQ); p
++<<<<<<< HEAD
 +        <sage.numerical.backends.ppl_backend.PPLBackend object at ...>
 +        sage: p = get_solver(base_ring=ZZ); p
 +        <sage.numerical.backends.ppl_backend.PPLBackend object at ...>
++=======
+         <...sage.numerical.backends.ppl_backend.PPLBackend...>
++>>>>>>> 22511250dd688bba5d98672fb89b0f779fd28e97
          sage: p.base_ring()
          Rational Field
          sage: p = get_solver(base_ring=AA); p
```




---

archive/issue_comments_276781.json:
```json
{
    "body": "****",
    "created_at": "2016-04-13T19:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276781",
    "user": "@dimpase"
}
```

****



---

archive/issue_comments_276782.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-13T19:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276782",
    "user": "@dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_276783.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2016-04-13T22:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276783",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_276784.json:
```json
{
    "body": "rebased on 7.2.beta4",
    "created_at": "2016-04-13T22:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276784",
    "user": "@mkoeppe"
}
```

rebased on 7.2.beta4



---

archive/issue_comments_276785.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-13T22:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276785",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_276786.json:
```json
{
    "body": "OK, good.",
    "created_at": "2016-04-14T06:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276786",
    "user": "@dimpase"
}
```

OK, good.



---

archive/issue_comments_276787.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-14T06:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276787",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_276788.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-15T07:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20086#issuecomment-276788",
    "user": "@vbraun"
}
```

Resolution: fixed
