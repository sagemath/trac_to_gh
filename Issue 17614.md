# Issue 17614: Nuke Cython cache when Cython version changes

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-02-25 07:43:09

CC:  robertwb

We already rebuild everything when the Cython version or options like 'debug' change, but because of Cython caching, that might not be sufficient. We should also delete all cache, such that everything is re-cythonized for sure.

This is needed to work-around [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842)


---

Comment by jdemeyer created at 2015-02-25 08:08:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-02-25 08:08:48

New commits:


---

Comment by vdelecroix created at 2015-02-25 08:23:30

Shouldn't it be

```
force = True
if os.path.exists(version_file):
    if open(version_file).read() == version_stamp:
        force = False
    else:
        # Nuke Cython cache since cycache doesn't use Cython version
        ...
```

It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.


---

Comment by jdemeyer created at 2015-02-25 08:30:49

Replying to [comment:3 vdelecroix]:
> It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.
Exactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.


---

Comment by vdelecroix created at 2015-02-25 08:38:10

Replying to [comment:4 jdemeyer]:
> Replying to [comment:3 vdelecroix]:
> > It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.
> Exactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.

What about somebody adding a new cython extension to Sage?


---

Comment by jdemeyer created at 2015-02-25 09:16:54

Replying to [comment:5 vdelecroix]:
> What about somebody adding a new cython extension to Sage?
That has nothing to do with this ticket.

This is about when the Cython version (for example, recently 0.21.1 -> 0.22) changes or when the compiler directives (in #17847 for example `embedsignature=True`, or `debug` or `profile`) change. In such cases, we really need to re-Cythonize everything. To avoid Cython using the cycache, we delete it.


---

Comment by vdelecroix created at 2015-02-26 07:57:02

Got it!

One last thing. Sage uses the global cython cache which seems to be located in `~/.cycache`. Which means that Sage shares its Cython cache with the native Cython. If you delete the cache, you also delete the non Sage part of the cache as well right?


---

Comment by jdemeyer created at 2015-02-26 08:40:42

Replying to [comment:7 vdelecroix]:
> If you delete the cache, you also delete the non Sage part of the cache as well right?
Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.


---

Comment by vdelecroix created at 2015-02-26 08:57:29

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > If you delete the cache, you also delete the non Sage part of the cache as well right?
> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.

One solution would be to change the default Sage Cython cache, let say `~/.sage/cycache/`. But I am not convinced by this solution.


---

Comment by vdelecroix created at 2015-03-14 22:20:50

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > If you delete the cache, you also delete the non Sage part of the cache as well right?
> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.

But you can be working on a much bigger project than Sage with much more Cython files. And then, it would be reasonable to not expect that Sage just delete your cache... Actually I even find weird that Sage ships its own cython and pollutes the native cython cache.


---

Comment by jdemeyer created at 2015-03-15 08:35:20

Replying to [comment:10 vdelecroix]:
> But you can be working on a much bigger project than Sage with much more Cython files.
Like I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.

Of the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.

(by the way: "a much bigger project than Sage with much more Cython files", does that even exist?)


---

Comment by vdelecroix created at 2015-03-15 08:48:42

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 vdelecroix]:
> > But you can be working on a much bigger project than Sage with much more Cython files.
> Like I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.
> 
> Of the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.

Indeed, that would be the solution. Did Cython acknowledge the bug? Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?

> (by the way: "a much bigger project than Sage with much more Cython files", does that even exist?)

Not on my computer ;-)


---

Comment by jdemeyer created at 2015-03-15 10:43:50

Replying to [comment:12 vdelecroix]:
> Indeed, that would be the solution. Did Cython acknowledge the bug?
No.

> Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?
No, I didn't do that. I also don't think it should be done. I certainly wouldn't like it if everybody started spamming `sage-devel` with bug reports.

Robert: what do you think?


---

Comment by jdemeyer created at 2015-03-21 12:18:22

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-21 13:02:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-03-21 13:03:07

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-03-22 10:44:40

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-03-22 10:44:40

This solution is more convincing!


---

Comment by vbraun created at 2015-03-24 10:48:35

Resolution: fixed


---

Comment by embray created at 2016-05-25 12:56:26

Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.

If Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?


---

Comment by jdemeyer created at 2016-05-25 19:29:46

Replying to [comment:21 embray]:
> Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.

IMHO, that's a `git` bug that it changes timestamps unneeded.

> If Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?
You could try to hook into the Cython fingerprinting code and use that, but I don't know how easy that would be. And you would need to fix http://trac.cython.org/ticket/842


---

Comment by embray created at 2016-05-26 08:26:52

I don't think it's really a bug, though one could call it a lack of a feature that it doesn't support preserving timestamps.
