# Issue 17614: Nuke Cython cache when Cython version changes

archive/issues_017614.json:
```json
{
    "body": "CC:  @robertwb\n\nWe already rebuild everything when the Cython version or options like 'debug' change, but because of Cython caching, that might not be sufficient. We should also delete all cache, such that everything is re-cythonized for sure.\n\nThis is needed to work-around [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842)\n\nIssue created by migration from https://trac.sagemath.org/ticket/17851\n\n",
    "created_at": "2015-02-25T07:43:09Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Nuke Cython cache when Cython version changes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17614",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @robertwb

We already rebuild everything when the Cython version or options like 'debug' change, but because of Cython caching, that might not be sufficient. We should also delete all cache, such that everything is re-cythonized for sure.

This is needed to work-around [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842)

Issue created by migration from https://trac.sagemath.org/ticket/17851





---

archive/issue_comments_235017.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-25T08:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235017",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_235018.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-25T08:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235018",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_235019.json:
```json
{
    "body": "Shouldn't it be\n\n```\nforce = True\nif os.path.exists(version_file):\n    if open(version_file).read() == version_stamp:\n        force = False\n    else:\n        # Nuke Cython cache since cycache doesn't use Cython version\n        ...\n```\nIt seems to me that you are deleting all the cache as soon as the `version_file` does not exists.",
    "created_at": "2015-02-25T08:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235019",
    "user": "https://github.com/videlec"
}
```

Shouldn't it be

```
force = True
if os.path.exists(version_file):
    if open(version_file).read() == version_stamp:
        force = False
    else:
        # Nuke Cython cache since cycache doesn't use Cython version
        ...
```
It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.



---

archive/issue_comments_235020.json:
```json
{
    "body": "Replying to [comment:3 vdelecroix]:\n> It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.\nExactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.",
    "created_at": "2015-02-25T08:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235020",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 vdelecroix]:
> It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.
Exactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.



---

archive/issue_comments_235021.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Replying to [comment:3 vdelecroix]:\n> > It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.\n\n> Exactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.\n\nWhat about somebody adding a new cython extension to Sage?",
    "created_at": "2015-02-25T08:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235021",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:4 jdemeyer]:
> Replying to [comment:3 vdelecroix]:
> > It seems to me that you are deleting all the cache as soon as the `version_file` does not exists.

> Exactly. A non-existing file is treated like an empty file. It doesn't matter much anyway, the file will exist unless somebody is installing Sage for the first time.

What about somebody adding a new cython extension to Sage?



---

archive/issue_comments_235022.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> What about somebody adding a new cython extension to Sage?\n\nThat has nothing to do with this ticket.\n\nThis is about when the Cython version (for example, recently 0.21.1 -> 0.22) changes or when the compiler directives (in #17847 for example `embedsignature=True`, or `debug` or `profile`) change. In such cases, we really need to re-Cythonize everything. To avoid Cython using the cycache, we delete it.",
    "created_at": "2015-02-25T09:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235022",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 vdelecroix]:
> What about somebody adding a new cython extension to Sage?

That has nothing to do with this ticket.

This is about when the Cython version (for example, recently 0.21.1 -> 0.22) changes or when the compiler directives (in #17847 for example `embedsignature=True`, or `debug` or `profile`) change. In such cases, we really need to re-Cythonize everything. To avoid Cython using the cycache, we delete it.



---

archive/issue_comments_235023.json:
```json
{
    "body": "Got it!\n\nOne last thing. Sage uses the global cython cache which seems to be located in `~/.cycache`. Which means that Sage shares its Cython cache with the native Cython. If you delete the cache, you also delete the non Sage part of the cache as well right?",
    "created_at": "2015-02-26T07:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235023",
    "user": "https://github.com/videlec"
}
```

Got it!

One last thing. Sage uses the global cython cache which seems to be located in `~/.cycache`. Which means that Sage shares its Cython cache with the native Cython. If you delete the cache, you also delete the non Sage part of the cache as well right?



---

archive/issue_comments_235024.json:
```json
{
    "body": "Replying to [comment:7 vdelecroix]:\n> If you delete the cache, you also delete the non Sage part of the cache as well right?\n\nYes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.",
    "created_at": "2015-02-26T08:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235024",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 vdelecroix]:
> If you delete the cache, you also delete the non Sage part of the cache as well right?

Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.



---

archive/issue_comments_235025.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 vdelecroix]:\n> > If you delete the cache, you also delete the non Sage part of the cache as well right?\n\n> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.\n\nOne solution would be to change the default Sage Cython cache, let say `~/.sage/cycache/`. But I am not convinced by this solution.",
    "created_at": "2015-02-26T08:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235025",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > If you delete the cache, you also delete the non Sage part of the cache as well right?

> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.

One solution would be to change the default Sage Cython cache, let say `~/.sage/cycache/`. But I am not convinced by this solution.



---

archive/issue_comments_235026.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 vdelecroix]:\n> > If you delete the cache, you also delete the non Sage part of the cache as well right?\n\n> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.\n\nBut you can be working on a much bigger project than Sage with much more Cython files. And then, it would be reasonable to not expect that Sage just delete your cache... Actually I even find weird that Sage ships its own cython and pollutes the native cython cache.",
    "created_at": "2015-03-14T22:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235026",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > If you delete the cache, you also delete the non Sage part of the cache as well right?

> Yes, but there is nothing we can do about that. Since it's just a cache, I don't think that's a big issue.

But you can be working on a much bigger project than Sage with much more Cython files. And then, it would be reasonable to not expect that Sage just delete your cache... Actually I even find weird that Sage ships its own cython and pollutes the native cython cache.



---

archive/issue_comments_235027.json:
```json
{
    "body": "Replying to [comment:10 vdelecroix]:\n> But you can be working on a much bigger project than Sage with much more Cython files.\n\nLike I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.\n\nOf the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.\n\n(by the way: \"a much bigger project than Sage with much more Cython files\", does that even exist?)",
    "created_at": "2015-03-15T08:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235027",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 vdelecroix]:
> But you can be working on a much bigger project than Sage with much more Cython files.

Like I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.

Of the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.

(by the way: "a much bigger project than Sage with much more Cython files", does that even exist?)



---

archive/issue_comments_235028.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> Replying to [comment:10 vdelecroix]:\n> > But you can be working on a much bigger project than Sage with much more Cython files.\n\n> Like I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.\n> \n> Of the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.\n\n\nIndeed, that would be the solution. Did Cython acknowledge the bug? Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?\n\n> (by the way: \"a much bigger project than Sage with much more Cython files\", does that even exist?)\n\n\nNot on my computer ;-)",
    "created_at": "2015-03-15T08:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235028",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 vdelecroix]:
> > But you can be working on a much bigger project than Sage with much more Cython files.

> Like I said, losing the cache is just a minor inconvenience... Having Sage not compile because Cython takes the wrong files from the cache is a much bigger problem.
> 
> Of the course the ideal solution would be if somebody fixed [http://trac.cython.org/ticket/842](http://trac.cython.org/ticket/842), but I'm not able to do that.


Indeed, that would be the solution. Did Cython acknowledge the bug? Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?

> (by the way: "a much bigger project than Sage with much more Cython files", does that even exist?)


Not on my computer ;-)



---

archive/issue_comments_235029.json:
```json
{
    "body": "Replying to [comment:12 vdelecroix]:\n> Indeed, that would be the solution. Did Cython acknowledge the bug?\n\nNo.\n\n> Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?\n\nNo, I didn't do that. I also don't think it should be done. I certainly wouldn't like it if everybody started spamming `sage-devel` with bug reports.\n\nRobert: what do you think?",
    "created_at": "2015-03-15T10:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235029",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 vdelecroix]:
> Indeed, that would be the solution. Did Cython acknowledge the bug?

No.

> Did you post a message on either [cython-users](https://groups.google.com/forum/#!forum/cython-users) or [cython-devel](https://mail.python.org/mailman/listinfo/cython-devel)?

No, I didn't do that. I also don't think it should be done. I certainly wouldn't like it if everybody started spamming `sage-devel` with bug reports.

Robert: what do you think?



---

archive/issue_comments_235030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-21T12:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235030",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_235031.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-21T13:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_235032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-21T13:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235032",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_235033.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-22T10:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235033",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_235034.json:
```json
{
    "body": "This solution is more convincing!",
    "created_at": "2015-03-22T10:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235034",
    "user": "https://github.com/videlec"
}
```

This solution is more convincing!



---

archive/issue_comments_235035.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-24T10:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235035",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050906.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-24T10:48:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17614#event-50906"
}
```



---

archive/issue_comments_235036.json:
```json
{
    "body": "Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.\n\nIf Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?",
    "created_at": "2016-05-25T12:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235036",
    "user": "https://github.com/embray"
}
```

Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.

If Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?



---

archive/issue_comments_235037.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n> Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.\n\n\nIMHO, that's a `git` bug that it changes timestamps unneeded.\n\n> If Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?\n\nYou could try to hook into the Cython fingerprinting code and use that, but I don't know how easy that would be. And you would need to fix http://trac.cython.org/ticket/842",
    "created_at": "2016-05-25T19:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235037",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 embray]:
> Any word on this?  I just changed branches in order to make one little change, then changed back to my previous branch and now have to recompile 350 Cython modules that haven't changed except for their timestamps.


IMHO, that's a `git` bug that it changes timestamps unneeded.

> If Cython's built in caching is a no-go, what about a simple mechanism for storing the hashes of Cython modules when they're compiled, so that Cython modules can always be compared to the hash of at least the last version that was compiled?

You could try to hook into the Cython fingerprinting code and use that, but I don't know how easy that would be. And you would need to fix http://trac.cython.org/ticket/842



---

archive/issue_comments_235038.json:
```json
{
    "body": "I don't think it's really a bug, though one could call it a lack of a feature that it doesn't support preserving timestamps.",
    "created_at": "2016-05-26T08:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17614#issuecomment-235038",
    "user": "https://github.com/embray"
}
```

I don't think it's really a bug, though one could call it a lack of a feature that it doesn't support preserving timestamps.
