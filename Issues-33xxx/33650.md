# Issue 33650: Set JUPYTER_DATA_DIR etc. during docbuild

archive/issues_033413.json:
```json
{
    "assignees": [],
    "body": "After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.\nThis can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)\n\nWe fix it by setting `JUPYTER_DATA_DIR` and `JUPYTER_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n\nSee https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files\n\nCC:  @kwankyu @dimpase @collares\n\nComponent: **documentation**\n\nAuthor: **Matthias Koeppe**\n\nBranch: **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**\n\nReviewer: **Kwankyu Lee**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33650_\n\n",
    "closed_at": "2022-04-10T13:13:05Z",
    "created_at": "2022-04-06T04:36:28Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Set JUPYTER_DATA_DIR etc. during docbuild",
    "type": "issue",
    "updated_at": "2022-05-04T16:56:49Z",
    "url": "https://github.com/sagemath/sage/issues/33650",
    "user": "https://github.com/mkoeppe"
}
```
After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.
This can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)

We fix it by setting `JUPYTER_DATA_DIR` and `JUPYTER_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.

See https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files

CC:  @kwankyu @dimpase @collares

Component: **documentation**

Author: **Matthias Koeppe**

Branch: **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**

Reviewer: **Kwankyu Lee**

_Issue created by migration from https://trac.sagemath.org/ticket/33650_





---

archive/issue_events_458601.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-06T04:36:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458601"
}
```



---

archive/issue_events_458602.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-06T04:36:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458602"
}
```



---

archive/issue_events_458603.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-06T04:36:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458603"
}
```



---

archive/issue_events_458604.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-06T04:36:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458604"
}
```



---

archive/issue_comments_543607.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,3 +3,4 @@\n \n We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n \n+See https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files\n``````\n",
    "created_at": "2022-04-06T04:37:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543607",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,3 +3,4 @@
 
 We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.
 
+See https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files
``````




---

archive/issue_comments_543608.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis could be done, for example, in `build/pkgs/sagemath_doc_html/spkg-install`",
    "created_at": "2022-04-06T04:56:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543608",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

This could be done, for example, in `build/pkgs/sagemath_doc_html/spkg-install`



---

archive/issue_comments_543609.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\n> We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n\nDima had the same issue with `./sage -n`. So we should not focus on the docbuild.",
    "created_at": "2022-04-06T04:57:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543609",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:3" align="right">comment:3</div>

> We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.

Dima had the same issue with `./sage -n`. So we should not focus on the docbuild.



---

archive/issue_comments_543610.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWell, `sage -n` is for running Jupyter, so I'd think it's correct to use the user's configuration - so it's the user's problem if their personal configuration in `~/.jupyter` is overriding our kernel.\n\nBut for the build process we should do better.",
    "created_at": "2022-04-06T05:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543610",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Well, `sage -n` is for running Jupyter, so I'd think it's correct to use the user's configuration - so it's the user's problem if their personal configuration in `~/.jupyter` is overriding our kernel.

But for the build process we should do better.



---

archive/issue_comments_543611.json:
```json
{
    "body": "Branch: **[u/mkoeppe/set_jupyter_config_dir_during_docbuild](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/set_jupyter_config_dir_during_docbuild)**",
    "created_at": "2022-04-06T05:10:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543611",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/set_jupyter_config_dir_during_docbuild](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/set_jupyter_config_dir_during_docbuild)**



---

archive/issue_comments_543612.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2022-04-06T05:10:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543612",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_543613.json:
```json
{
    "body": "Commit: **[`b397afc`](https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b)**",
    "created_at": "2022-04-06T05:10:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543613",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`b397afc`](https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b)**



---

archive/issue_comments_543614.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b\"><code>b397afc</code></a></td><td><code>build/bin/sage-site (--docbuild): Poison JUPYTER_CONFIG_DIR, JUPYTER_CONFIG_PATH</code></td></tr></table>\n",
    "created_at": "2022-04-06T05:10:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543614",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b"><code>b397afc</code></a></td><td><code>build/bin/sage-site (--docbuild): Poison JUPYTER_CONFIG_DIR, JUPYTER_CONFIG_PATH</code></td></tr></table>




---

archive/issue_events_458605.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-06T05:10:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458605"
}
```



---

archive/issue_comments_543615.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIn addition, I suppose in `sage -n` we could warn the user if `jupyter kernelspec list` reveals that our kernels are shadowed by user configuration.",
    "created_at": "2022-04-06T05:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543615",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

In addition, I suppose in `sage -n` we could warn the user if `jupyter kernelspec list` reveals that our kernels are shadowed by user configuration.



---

archive/issue_comments_543616.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI've opened #33651 for this.",
    "created_at": "2022-04-06T05:17:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543616",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

I've opened #33651 for this.



---

archive/issue_comments_543617.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-After #33507, jupyter gets invoked during the docbuild.\n+After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.\n This can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)\n \n We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n``````\n",
    "created_at": "2022-04-06T05:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543617",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-After #33507, jupyter gets invoked during the docbuild.
+After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.
 This can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)
 
 We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.
``````




---

archive/issue_comments_543618.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nWhy not `unset VAR` instead of pointing jupyter to non-existing directory or path?",
    "created_at": "2022-04-06T05:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543618",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:10" align="right">comment:10</div>

Why not `unset VAR` instead of pointing jupyter to non-existing directory or path?



---

archive/issue_comments_543619.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWhen unset, it uses the default directories, which can contain the bad user configuration.",
    "created_at": "2022-04-06T07:09:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543619",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

When unset, it uses the default directories, which can contain the bad user configuration.



---

archive/issue_comments_543620.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@mkoeppe](#comment%3A11):\n> When unset, it uses the default directories, which can contain the bad user configuration.\n\nI see.\n\nThen it looks good to me. Now I am simulating the failing situation to see that the branch works as expected. \n\nMeanwhile let me note that #33320 (which supersedes #33507) circumvents this bug since it does not run jupyter to build the live doc.",
    "created_at": "2022-04-06T08:16:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543620",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@mkoeppe](#comment%3A11):
> When unset, it uses the default directories, which can contain the bad user configuration.

I see.

Then it looks good to me. Now I am simulating the failing situation to see that the branch works as expected. 

Meanwhile let me note that #33320 (which supersedes #33507) circumvents this bug since it does not run jupyter to build the live doc.



---

archive/issue_comments_543621.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn `/Users/kwankyu/GitHub/sage-dev`:\n\nAfter \n\n```\n(sage-sh) kwankyu@Hera:sage-dev$ ipython kernel install --name \"sagemath\" --user\nInstalled kernelspec sagemath in /Users/kwankyu/Library/Jupyter/kernels/sagemath\n(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list\nAvailable kernels:\n  sagemath        /Users/kwankyu/Library/Jupyter/kernels/sagemath\n  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3\n```\n\n`make` fails even with the branch.\n\nAfter\n\n```\n(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec remove sagemath\nKernel specs to remove:\n  sagemath            \t/Users/kwankyu/Library/Jupyter/kernels/sagemath\nRemove 1 kernel specs [y/N]: y\n[RemoveKernelSpec] Removed /Users/kwankyu/Library/Jupyter/kernels/sagemath\n(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list\nAvailable kernels:\n  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3\n  sagemath        /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/sagemath\n```\n`make` does not fail.",
    "created_at": "2022-04-06T09:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543621",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:13" align="right">comment:13</div>

In `/Users/kwankyu/GitHub/sage-dev`:

After 

```
(sage-sh) kwankyu@Hera:sage-dev$ ipython kernel install --name "sagemath" --user
Installed kernelspec sagemath in /Users/kwankyu/Library/Jupyter/kernels/sagemath
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list
Available kernels:
  sagemath        /Users/kwankyu/Library/Jupyter/kernels/sagemath
  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3
```

`make` fails even with the branch.

After

```
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec remove sagemath
Kernel specs to remove:
  sagemath            	/Users/kwankyu/Library/Jupyter/kernels/sagemath
Remove 1 kernel specs [y/N]: y
[RemoveKernelSpec] Removed /Users/kwankyu/Library/Jupyter/kernels/sagemath
(sage-sh) kwankyu@Hera:sage-dev$ jupyter kernelspec list
Available kernels:
  python3         /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/python3
  sagemath        /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.10.3/share/jupyter/kernels/sagemath
```
`make` does not fail.



---

archive/issue_comments_543622.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThis\n\n```\nexport JUPYTER_DATA_DIR=/doesnotexist  \n```\nworked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel. Fortunately that directory does not exist either, in my case. \n\nA safe solution would be to add the real path to our kernel at the front...",
    "created_at": "2022-04-06T09:30:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543622",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:14" align="right">comment:14</div>

This

```
export JUPYTER_DATA_DIR=/doesnotexist  
```
worked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel. Fortunately that directory does not exist either, in my case. 

A safe solution would be to add the real path to our kernel at the front...



---

archive/issue_comments_543623.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@kwankyu](#comment%3A14):\n> A safe solution would be to add the real path to our kernel at the front...\n\nThus \n\n```\nexport JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, \"share\", \"jupyter\")???\n```\n\nThis is rather cumbersome though...",
    "created_at": "2022-04-06T09:47:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543623",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@kwankyu](#comment%3A14):
> A safe solution would be to add the real path to our kernel at the front...

Thus 

```
export JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, "share", "jupyter")???
```

This is rather cumbersome though...



---

archive/issue_comments_543624.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nPerhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.",
    "created_at": "2022-04-06T09:52:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543624",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:16" align="right">comment:16</div>

Perhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.



---

archive/issue_comments_543625.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@dimpase](#comment%3A16):\n> Perhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.\n\n+1",
    "created_at": "2022-04-06T11:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543625",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@dimpase](#comment%3A16):
> Perhaps we should do versioning of Jupyter kernels, so that we can specify the right one to use by name only.

+1



---

archive/issue_comments_543626.json:
```json
{
    "body": "Changed commit from **[`b397afc`](https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b)** to **[`ecd6c78`](https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48)**",
    "created_at": "2022-04-06T13:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543626",
    "user": "https://github.com/kwankyu"
}
```

Changed commit from **[`b397afc`](https://github.com/sagemath/sagetrac-mirror/commit/b397afc9f82750926782fdfd5c0ff15f3106131b)** to **[`ecd6c78`](https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48)**



---

archive/issue_comments_543627.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48\"><code>ecd6c78</code></a></td><td><code>Use versioned kernel name</code></td></tr></table>\n",
    "created_at": "2022-04-06T13:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543627",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:18"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48"><code>ecd6c78</code></a></td><td><code>Use versioned kernel name</code></td></tr></table>




---

archive/issue_comments_543628.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/set_jupyter_config_dir_during_docbuild](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/set_jupyter_config_dir_during_docbuild)** to **[public/33650](https://github.com/sagemath/sagetrac-mirror/tree/public/33650)**",
    "created_at": "2022-04-06T13:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543628",
    "user": "https://github.com/kwankyu"
}
```

Changed branch from **[u/mkoeppe/set_jupyter_config_dir_during_docbuild](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/set_jupyter_config_dir_during_docbuild)** to **[public/33650](https://github.com/sagemath/sagetrac-mirror/tree/public/33650)**



---

archive/issue_comments_543629.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nVersioned kernel works well.",
    "created_at": "2022-04-06T13:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543629",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:19" align="right">comment:19</div>

Versioned kernel works well.



---

archive/issue_comments_543630.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54\"><code>5d9e862</code></a></td><td><code>Fix a doctest failure</code></td></tr></table>\n",
    "created_at": "2022-04-06T13:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543630",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54"><code>5d9e862</code></a></td><td><code>Fix a doctest failure</code></td></tr></table>




---

archive/issue_comments_543631.json:
```json
{
    "body": "Changed commit from **[`ecd6c78`](https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48)** to **[`5d9e862`](https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54)**",
    "created_at": "2022-04-06T13:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543631",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ecd6c78`](https://github.com/sagemath/sagetrac-mirror/commit/ecd6c7876f9c7bda5025c23f2cf5890e03881b48)** to **[`5d9e862`](https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54)**



---

archive/issue_comments_543632.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThis is not getting better with versioning because it does not distinguish kernels from different installations of Sage.",
    "created_at": "2022-04-06T17:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543632",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">comment:21</div>

This is not getting better with versioning because it does not distinguish kernels from different installations of Sage.



---

archive/issue_comments_543633.json:
```json
{
    "body": "Changed commit from **[`5d9e862`](https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54)** to **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**",
    "created_at": "2022-04-06T17:25:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543633",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5d9e862`](https://github.com/sagemath/sagetrac-mirror/commit/5d9e8622a2a38ce0d1989f22c4fb13d1c123ac54)** to **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**



---

archive/issue_comments_543634.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301\"><code>614822c</code></a></td><td><code>build/bin/sage-site (--docbuild): Also poison JUPYTER_DATA_DIR, JUPYTER_PATH</code></td></tr></table>\n",
    "created_at": "2022-04-06T17:25:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543634",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301"><code>614822c</code></a></td><td><code>build/bin/sage-site (--docbuild): Also poison JUPYTER_DATA_DIR, JUPYTER_PATH</code></td></tr></table>




---

archive/issue_comments_543635.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@kwankyu](#comment%3A15):\n> Replying to [@kwankyu](#comment%3A14):\n> \n> ```\n> export JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, \"share\", \"jupyter\")???\n> ```\n\nI don't think it's necessary to set it to the location of our jupyter installation because that is always active.",
    "created_at": "2022-04-06T17:29:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543635",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@kwankyu](#comment%3A15):
> Replying to [@kwankyu](#comment%3A14):
> 
> ```
> export JUPYTER_DATA_DIR=???os.path.join(SAGE_VENV, "share", "jupyter")???
> ```

I don't think it's necessary to set it to the location of our jupyter installation because that is always active.



---

archive/issue_comments_543636.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@kwankyu](#comment%3A14):\n> This\n> \n> ```\n> export JUPYTER_DATA_DIR=/doesnotexist  \n> ```\n> worked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.\n\nWhere would that directory be coming from?",
    "created_at": "2022-04-06T17:31:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543636",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@kwankyu](#comment%3A14):
> This
> 
> ```
> export JUPYTER_DATA_DIR=/doesnotexist  
> ```
> worked. But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.

Where would that directory be coming from?



---

archive/issue_comments_543637.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@mkoeppe](#comment%3A24):\n> But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.\n> \n> Where would that directory be coming from?\n\nI don't know... I don't have it anymore since I deleted the `.sage` directory for experiments. It didn't have kernel definitions in it, and didn't cause a problem.",
    "created_at": "2022-04-06T21:06:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543637",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@mkoeppe](#comment%3A24):
> But as I see it, this is still not a safe solution. It does prevent from using default directories, but still `.sage/local/etc/jupyter` shadows our kernel.
> 
> Where would that directory be coming from?

I don't know... I don't have it anymore since I deleted the `.sage` directory for experiments. It didn't have kernel definitions in it, and didn't cause a problem.



---

archive/issue_comments_543638.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI confirm that the current branch works well. I am positive.",
    "created_at": "2022-04-06T22:21:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543638",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:26" align="right">comment:26</div>

I confirm that the current branch works well. I am positive.



---

archive/issue_comments_543639.json:
```json
{
    "body": "Reviewer: **Kwankyu Lee, ...**",
    "created_at": "2022-04-06T22:21:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543639",
    "user": "https://github.com/kwankyu"
}
```

Reviewer: **Kwankyu Lee, ...**



---

archive/issue_comments_543640.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.\n This can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)\n \n-We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n+We fix it by setting `JUPYTER_DATA_DIR` and `JUPYTER_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.\n \n See https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files\n``````\n",
    "created_at": "2022-04-07T00:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543640",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 After #33507, the jupyter kernel `sagemath` gets invoked during the docbuild.
 This can lead to a new class of errors as seen in [#33507 comment:75](https://github.com/sagemath/sage/issues/33507#comment:75) and [#33507 comment:86](https://github.com/sagemath/sage/issues/33507#comment:86)
 
-We fix it by setting `JUPYTER_CONFIG_DIR` and `JUPYTER_CONFIG_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.
+We fix it by setting `JUPYTER_DATA_DIR` and `JUPYTER_PATH` during the docbuild so that a random broken user configuration of Jupyter in `~/.jupyter` does not break the docbuild.
 
 See https://docs.jupyter.org/en/latest/use/jupyter-directories.html#configuration-files
``````




---

archive/issue_events_458606.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T03:17:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "title_is": "Set JUPYTER_DATA_DIR etc. during docbuild",
    "title_was": "Set JUPYTER_CONFIG_DIR during docbuild",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458606"
}
```



---

archive/issue_events_458607.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2022-04-07T13:58:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458607"
}
```



---

archive/issue_events_458608.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2022-04-07T13:58:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458608"
}
```



---

archive/issue_comments_543641.json:
```json
{
    "body": "Changed reviewer from **Kwankyu Lee, ...** to **Kwankyu Lee**",
    "created_at": "2022-04-07T13:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543641",
    "user": "https://github.com/kwankyu"
}
```

Changed reviewer from **Kwankyu Lee, ...** to **Kwankyu Lee**



---

archive/issue_comments_543642.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThank you!",
    "created_at": "2022-04-07T17:35:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543642",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

Thank you!



---

archive/issue_events_458609.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-10T13:13:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458609"
}
```



---

archive/issue_events_458610.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "365d2b1957bed8fa4f4e8c96fde3e281fb56f8b3",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-04-10T13:13:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33650#event-458610"
}
```



---

archive/issue_comments_543643.json:
```json
{
    "body": "Changed branch from **[public/33650](https://github.com/sagemath/sagetrac-mirror/tree/public/33650)** to **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**",
    "created_at": "2022-04-10T13:13:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543643",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/33650](https://github.com/sagemath/sagetrac-mirror/tree/public/33650)** to **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)**



---

archive/issue_comments_543644.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nOn NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](../wiki/SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.",
    "created_at": "2022-05-04T08:32:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543644",
    "user": "https://github.com/collares"
}
```

<div id="comment:32" align="right">comment:32</div>

On NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](../wiki/SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.



---

archive/issue_comments_543645.json:
```json
{
    "body": "Changed commit from **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)** to none",
    "created_at": "2022-05-04T08:32:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543645",
    "user": "https://github.com/collares"
}
```

Changed commit from **[`614822c`](https://github.com/sagemath/sagetrac-mirror/commit/614822cd932ed09c807c53d0665c9d1d5a536301)** to none



---

archive/issue_comments_543646.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@collares](#comment%3A32):\n> On NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](../wiki/SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.\n\nFor the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.\nhttps://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.6-makefile_and_parallel.patch\n\nI think we are at a point where ditching `./sage --docbuild` in favor of what I am currently doing in vanilla sage is not only possible but probably inevitable in the short term.",
    "created_at": "2022-05-04T09:48:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543646",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@collares](#comment%3A32):
> On NixOS we build documentation as part of the build, and `JUPYTER_PATH` must be set appropriately so `jupyter-sphinx` can find the [SageMath](../wiki/SageMath) kernel during docbuilding. Is this supported? The fact that `--docbuild` is handled by `sage-site` makes me think I am doing the wrong thing by using it outside Sage-the-distribution, but `make doc-html` also uses `--docbuild` internally. I am temporarily hacking around this by calling `sage-python -m sage_docbuild` directly.

For the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.
https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.6-makefile_and_parallel.patch

I think we are at a point where ditching `./sage --docbuild` in favor of what I am currently doing in vanilla sage is not only possible but probably inevitable in the short term.



---

archive/issue_comments_543647.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@collares](#comment%3A32):\n> The fact that `--docbuild` is handled by `sage-site`\n\nI propose to move it back to `src/bin/sage` in #33795",
    "created_at": "2022-05-04T16:52:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543647",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@collares](#comment%3A32):
> The fact that `--docbuild` is handled by `sage-site`

I propose to move it back to `src/bin/sage` in #33795



---

archive/issue_comments_543648.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@kiwifb](#comment%3A33):\n> For the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.\n\n+1, that's the way.",
    "created_at": "2022-05-04T16:56:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33650#issuecomment-543648",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@kiwifb](#comment%3A33):
> For the record in sage-on-gentoo where I split sage_setup, sage, sage_docbuild and sage-doc in 9.5 and beyond I patch the makefile for build the documentation. But it also relies on sage to be already installed and in place on the system.

+1, that's the way.
