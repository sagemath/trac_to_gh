# Issue 33248: Fix timeout in feature test for Mathematica

archive/issues_033011.json:
```json
{
    "body": "Doctesting `src/sage/features/interfaces.py`\nfails for me with a timeout.\n\n```\nsage: from sage.features.interfaces import Mathematica\nsage: Mathematica().is_present()\n```\n\nIn this ticket we mark the example\n`# not tested` to skip it in doctests.\n\nCC:  @slel\n\nKeywords: features, mathematica, timeout\n\nBranch/Commit: 868109b83081d48e0279148334c3b8ab9467e873\n\nReviewer: Matthias Koeppe\n\nAuthor: Samuel Leli\u00e8vre\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33248\n\n",
    "closed_at": "2022-02-13T10:16:36Z",
    "created_at": "2022-01-30T15:08:40Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Fix timeout in feature test for Mathematica",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33248",
    "user": "https://github.com/slel"
}
```
Doctesting `src/sage/features/interfaces.py`
fails for me with a timeout.

```
sage: from sage.features.interfaces import Mathematica
sage: Mathematica().is_present()
```

In this ticket we mark the example
`# not tested` to skip it in doctests.

CC:  @slel

Keywords: features, mathematica, timeout

Branch/Commit: 868109b83081d48e0279148334c3b8ab9467e873

Reviewer: Matthias Koeppe

Author: Samuel Lelièvre

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33248





---

archive/issue_comments_663321.json:
```json
{
    "body": "<a id='comment:1'></a>\nSet milestone to sage-9.6 after Sage 9.5 release.",
    "created_at": "2022-01-30T15:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663321",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>
Set milestone to sage-9.6 after Sage 9.5 release.



---

archive/issue_events_087802.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-01-30T15:44:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33248#event-87802"
}
```



---

archive/issue_comments_663322.json:
```json
{
    "body": "<a id='comment:2'></a>\nCould we give up on `Mathematica().is_present()`\nafter say a minute?\n\nMaybe using one of the answers to:\n\n- [Stack Overflow question 492519: Timeout on a function call](https://stackoverflow.com/q/492519)",
    "created_at": "2022-01-30T17:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663322",
    "user": "https://github.com/slel"
}
```

<a id='comment:2'></a>
Could we give up on `Mathematica().is_present()`
after say a minute?

Maybe using one of the answers to:

- [Stack Overflow question 492519: Timeout on a function call](https://stackoverflow.com/q/492519)



---

archive/issue_comments_663323.json:
```json
{
    "body": "<a id='comment:3'></a>\nDo you know at which line it gets stuck in what is below ?\n\n```python\n    def _is_present(self):\n        \"\"\"\n        TESTS::\n\n            sage: from sage.features.interfaces import InterfaceFeature\n            sage: from sage.interfaces.sage0 import Sage\n            sage: f = InterfaceFeature(\"sage0\", \"sage.interfaces.sage0\")\n            sage: f.is_present()\n            FeatureTestResult('sage0', True)\n        \"\"\"\n        result = self.module.is_present()\n        if not result:\n            return result\n        m = importlib.import_module(self.module.name)\n        try:\n            interface = getattr(m, self.name)\n        except Exception as exception:\n            return FeatureTestResult(self, False,\n                                     reason=f\"Interface {self.name} cannot be imported: {exception}\")\n        try:\n            interface('2+3')\n            return FeatureTestResult(self, True)\n        except Exception as exception:\n            return FeatureTestResult(self, False,\n                                     reason=f\"Interface {interface} is not functional: {exception}\")\n\n```",
    "created_at": "2022-01-30T19:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663323",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:3'></a>
Do you know at which line it gets stuck in what is below ?

```python
    def _is_present(self):
        """
        TESTS::

            sage: from sage.features.interfaces import InterfaceFeature
            sage: from sage.interfaces.sage0 import Sage
            sage: f = InterfaceFeature("sage0", "sage.interfaces.sage0")
            sage: f.is_present()
            FeatureTestResult('sage0', True)
        """
        result = self.module.is_present()
        if not result:
            return result
        m = importlib.import_module(self.module.name)
        try:
            interface = getattr(m, self.name)
        except Exception as exception:
            return FeatureTestResult(self, False,
                                     reason=f"Interface {self.name} cannot be imported: {exception}")
        try:
            interface('2+3')
            return FeatureTestResult(self, True)
        except Exception as exception:
            return FeatureTestResult(self, False,
                                     reason=f"Interface {interface} is not functional: {exception}")

```



---

archive/issue_comments_663324.json:
```json
{
    "body": "<a id='comment:4'></a>\nI think this doctest should be marked `# not tested`",
    "created_at": "2022-01-30T19:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663324",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
I think this doctest should be marked `# not tested`



---

archive/issue_comments_663325.json:
```json
{
    "body": "<a id='comment:5'></a>\nMathematica is installed on that machine\nbut requires a password or token to start.\n\nRunning `math` in a shell session goes:\n\n```\n$ math\nMathematica 12.1.1 Kernel for Linux x86 (64-bit)\nCopyright 1988-2020 Wolfram Research, Inc.\n\nMathematica 12.1.1 Kernel cannot find a valid password.\n\nFor automatic Web Activation enter your activation key\n(enter return to skip Web Activation):\n```\n\nThis is likely what makes the feature detection hang.",
    "created_at": "2022-01-31T09:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663325",
    "user": "https://github.com/slel"
}
```

<a id='comment:5'></a>
Mathematica is installed on that machine
but requires a password or token to start.

Running `math` in a shell session goes:

```
$ math
Mathematica 12.1.1 Kernel for Linux x86 (64-bit)
Copyright 1988-2020 Wolfram Research, Inc.

Mathematica 12.1.1 Kernel cannot find a valid password.

For automatic Web Activation enter your activation key
(enter return to skip Web Activation):
```

This is likely what makes the feature detection hang.



---

archive/issue_comments_663326.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663326",
    "user": "https://github.com/slel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_663327.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [mkoeppe](#comment%3A4):\n> I think this doctest should be marked `# not tested`\n\n\nHere is a branch doing that.\n\n---\nNew commits:\n|                                                                                                                                          |                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[868109b](https://git.sagemath.org/sage.git/commit?id=868109b83081d48e0279148334c3b8ab9467e873)|`33248: Skip Mathematica feature detection doctest`|",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663327",
    "user": "https://github.com/slel"
}
```

<a id='comment:6'></a>
Replying to [mkoeppe](#comment%3A4):
> I think this doctest should be marked `# not tested`


Here is a branch doing that.

---
New commits:
|                                                                                                                                          |                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[868109b](https://git.sagemath.org/sage.git/commit?id=868109b83081d48e0279148334c3b8ab9467e873)|`33248: Skip Mathematica feature detection doctest`|



---

archive/issue_comments_663328.json:
```json
{
    "body": "Changing keywords from \"features, mathematica\" to \"features, mathematica, timeout\".",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663328",
    "user": "https://github.com/slel"
}
```

Changing keywords from "features, mathematica" to "features, mathematica, timeout".



---

archive/issue_comments_663329.json:
```json
{
    "body": "Changing commit from \"\" to \"868109b83081d48e0279148334c3b8ab9467e873\"",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663329",
    "user": "https://github.com/slel"
}
```

Changing commit from "" to "868109b83081d48e0279148334c3b8ab9467e873"



---

archive/issue_comments_663330.json:
```json
{
    "body": "Changing branch from \"\" to \"u/slelievre/33248\"",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663330",
    "user": "https://github.com/slel"
}
```

Changing branch from "" to "u/slelievre/33248"



---

archive/issue_comments_663331.json:
```json
{
    "body": "Changing author from \"\" to \"Samuel Leli\u00e8vre\"",
    "created_at": "2022-01-31T10:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663331",
    "user": "https://github.com/slel"
}
```

Changing author from "" to "Samuel Lelièvre"



---

archive/issue_comments_663332.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,3 +6,5 @@\n sage: Mathematica().is_present()\n ```\n \n+In this ticket we mark the example\n+`# not tested` to skip it in doctests.\n``````\n",
    "created_at": "2022-01-31T10:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663332",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,3 +6,5 @@
 sage: Mathematica().is_present()
 ```
 
+In this ticket we mark the example
+`# not tested` to skip it in doctests.
``````




---

archive/issue_comments_663333.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-31T18:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663333",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_663334.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-01-31T18:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663334",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_663335.json:
```json
{
    "body": "Changing branch from \"u/slelievre/33248\" to \"868109b83081d48e0279148334c3b8ab9467e873\"",
    "created_at": "2022-02-13T10:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663335",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/slelievre/33248" to "868109b83081d48e0279148334c3b8ab9467e873"



---

archive/issue_events_087803.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-13T10:16:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33248#event-87803"
}
```



---

archive/issue_comments_663336.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-13T10:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33248#issuecomment-663336",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
