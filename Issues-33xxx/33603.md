# Issue 33603: Fix Conic doctests

archive/issues_033366.json:
```json
{
    "body": "The following optional Magma doctest fails:\n\n```\nFile \"src/sage/schemes/plane_conics/con_field.py\", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point\nFailed example:\n    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma\nExpected:\n    False\nGot:\n    True\n```\nThis is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:\n\n```\nsage: P.<a> = QuadraticField(2)                                                 \nsage: C = Conic(P,[1,1,1])                                                      \nsage: C.has_rational_point()                                                    \nTrue\nsage: C.has_rational_point(point=True)                                          \n(False, None)\nsage: C.has_rational_point()                                                    \nTrue\nsage: C.has_rational_point(obstruction=True)                                    \n(True, None)\nsage: C.has_rational_point(point=True, obstruction=True)                        \n(False,\n Ring morphism:\n   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?\n   To:   Algebraic Real Field\n   Defn: a |--> -1.414213562373095?)\nsage: C.has_rational_point()                                                    \nFalse\n```\n\nMoreover, the documentation incorrectly claims (see #31892)\n* that the inverse maps of conic parametrization are incorrect and\n* that the `is_one`method is a good way to check this.\n\n\nCC:  @kliem @JohnCremona @fchapoton @tscrim\n\nKeywords: conic, magma\n\nBranch/Commit: 8f129473f53ea0b38c1618e823745523bd6e975c\n\nReviewer: Travis Scrimshaw\n\nAuthor: Marco Streng\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33603\n\n",
    "closed_at": "2022-04-02T10:52:35Z",
    "created_at": "2022-03-30T14:50:31Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Fix Conic doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33603",
    "user": "https://github.com/mstreng"
}
```
The following optional Magma doctest fails:

```
File "src/sage/schemes/plane_conics/con_field.py", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point
Failed example:
    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma
Expected:
    False
Got:
    True
```
This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:

```
sage: P.<a> = QuadraticField(2)                                                 
sage: C = Conic(P,[1,1,1])                                                      
sage: C.has_rational_point()                                                    
True
sage: C.has_rational_point(point=True)                                          
(False, None)
sage: C.has_rational_point()                                                    
True
sage: C.has_rational_point(obstruction=True)                                    
(True, None)
sage: C.has_rational_point(point=True, obstruction=True)                        
(False,
 Ring morphism:
   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?
   To:   Algebraic Real Field
   Defn: a |--> -1.414213562373095?)
sage: C.has_rational_point()                                                    
False
```

Moreover, the documentation incorrectly claims (see #31892)
* that the inverse maps of conic parametrization are incorrect and
* that the `is_one`method is a good way to check this.


CC:  @kliem @JohnCremona @fchapoton @tscrim

Keywords: conic, magma

Branch/Commit: 8f129473f53ea0b38c1618e823745523bd6e975c

Reviewer: Travis Scrimshaw

Author: Marco Streng

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33603





---

archive/issue_comments_507468.json:
```json
{
    "body": "Changing keywords from \"\" to \"conic, magma\".",
    "created_at": "2022-03-30T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507468",
    "user": "https://github.com/mstreng"
}
```

Changing keywords from "" to "conic, magma".



---

archive/issue_comments_507469.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2022-03-30T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507469",
    "user": "https://github.com/mstreng"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_507470.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to geometry.",
    "created_at": "2022-03-30T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507470",
    "user": "https://github.com/mstreng"
}
```

Changing component from PLEASE CHANGE to geometry.



---

archive/issue_comments_507471.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,19 @@\n+The following optional Magma doctest fails:\n+\n+```\n+File \"src/sage/schemes/plane_conics/con_field.py\", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point\n+Failed example:\n+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma\n+Expected:\n+    False\n+Got:\n+    True\n+```\n+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`.\n+\n+Moreover, the documentation incorrectly claims (see [trac:31892])\n+* that the inverse maps of conic parametrization are incorrect and\n+* that the `is_one`method is a good way to check this.\n \n \n Comment: 1\n``````\n",
    "created_at": "2022-03-30T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507471",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,19 @@
+The following optional Magma doctest fails:
+
+```
+File "src/sage/schemes/plane_conics/con_field.py", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point
+Failed example:
+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma
+Expected:
+    False
+Got:
+    True
+```
+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`.
+
+Moreover, the documentation incorrectly claims (see [trac:31892])
+* that the inverse maps of conic parametrization are incorrect and
+* that the `is_one`method is a good way to check this.
 
 
 Comment: 1
``````




---

archive/issue_comments_507472.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2022-03-30T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507472",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_507473.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,40 @@\n+The following optional Magma doctest fails:\n+\n+```\n+File \"src/sage/schemes/plane_conics/con_field.py\", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point\n+Failed example:\n+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma\n+Expected:\n+    False\n+Got:\n+    True\n+```\n+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:\n+\n+```\n+sage: P.<a> = QuadraticField(2)                                                 \n+sage: C = Conic(P,[1,1,1])                                                      \n+sage: C.has_rational_point()                                                    \n+True\n+sage: C.has_rational_point(point=True)                                          \n+(False, None)\n+sage: C.has_rational_point()                                                    \n+True\n+sage: C.has_rational_point(obstruction=True)                                    \n+(True, None)\n+sage: C.has_rational_point(point=True, obstruction=True)                        \n+(False,\n+ Ring morphism:\n+   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?\n+   To:   Algebraic Real Field\n+   Defn: a |--> -1.414213562373095?)\n+sage: C.has_rational_point()                                                    \n+False\n+```\n+\n+Moreover, the documentation incorrectly claims (see [trac:31892])\n+* that the inverse maps of conic parametrization are incorrect and\n+* that the `is_one`method is a good way to check this.\n \n \n Comment: 1\n``````\n",
    "created_at": "2022-03-30T15:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507473",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,40 @@
+The following optional Magma doctest fails:
+
+```
+File "src/sage/schemes/plane_conics/con_field.py", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point
+Failed example:
+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma
+Expected:
+    False
+Got:
+    True
+```
+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:
+
+```
+sage: P.<a> = QuadraticField(2)                                                 
+sage: C = Conic(P,[1,1,1])                                                      
+sage: C.has_rational_point()                                                    
+True
+sage: C.has_rational_point(point=True)                                          
+(False, None)
+sage: C.has_rational_point()                                                    
+True
+sage: C.has_rational_point(obstruction=True)                                    
+(True, None)
+sage: C.has_rational_point(point=True, obstruction=True)                        
+(False,
+ Ring morphism:
+   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?
+   To:   Algebraic Real Field
+   Defn: a |--> -1.414213562373095?)
+sage: C.has_rational_point()                                                    
+False
+```
+
+Moreover, the documentation incorrectly claims (see [trac:31892])
+* that the inverse maps of conic parametrization are incorrect and
+* that the `is_one`method is a good way to check this.
 
 
 Comment: 1
``````




---

archive/issue_comments_507474.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-30T16:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507474",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_507475.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,40 @@\n+The following optional Magma doctest fails:\n+\n+```\n+File \"src/sage/schemes/plane_conics/con_field.py\", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point\n+Failed example:\n+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma\n+Expected:\n+    False\n+Got:\n+    True\n+```\n+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:\n+\n+```\n+sage: P.<a> = QuadraticField(2)                                                 \n+sage: C = Conic(P,[1,1,1])                                                      \n+sage: C.has_rational_point()                                                    \n+True\n+sage: C.has_rational_point(point=True)                                          \n+(False, None)\n+sage: C.has_rational_point()                                                    \n+True\n+sage: C.has_rational_point(obstruction=True)                                    \n+(True, None)\n+sage: C.has_rational_point(point=True, obstruction=True)                        \n+(False,\n+ Ring morphism:\n+   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?\n+   To:   Algebraic Real Field\n+   Defn: a |--> -1.414213562373095?)\n+sage: C.has_rational_point()                                                    \n+False\n+```\n+\n+Moreover, the documentation incorrectly claims (see #31892)\n+* that the inverse maps of conic parametrization are incorrect and\n+* that the `is_one`method is a good way to check this.\n \n \n Comment: 1\n``````\n",
    "created_at": "2022-03-30T16:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507475",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,40 @@
+The following optional Magma doctest fails:
+
+```
+File "src/sage/schemes/plane_conics/con_field.py", line 1073, in sage.schemes.plane_conics.con_field.ProjectiveConic_field.rational_point
+Failed example:
+    Conic([L.gen(), 30, -21]).has_rational_point(algorithm='magma') # optional - magma
+Expected:
+    False
+Got:
+    True
+```
+This is due to the following bug in Conics over number fields: if the cache of a conic is empty and the user asks whether a rational point exists without asking for the point itself, then `has_rational_point` always returns `True`. Here is a non-Magma example documenting this bug:
+
+```
+sage: P.<a> = QuadraticField(2)                                                 
+sage: C = Conic(P,[1,1,1])                                                      
+sage: C.has_rational_point()                                                    
+True
+sage: C.has_rational_point(point=True)                                          
+(False, None)
+sage: C.has_rational_point()                                                    
+True
+sage: C.has_rational_point(obstruction=True)                                    
+(True, None)
+sage: C.has_rational_point(point=True, obstruction=True)                        
+(False,
+ Ring morphism:
+   From: Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?
+   To:   Algebraic Real Field
+   Defn: a |--> -1.414213562373095?)
+sage: C.has_rational_point()                                                    
+False
+```
+
+Moreover, the documentation incorrectly claims (see #31892)
+* that the inverse maps of conic parametrization are incorrect and
+* that the `is_one`method is a good way to check this.
 
 
 Comment: 1
``````




---

archive/issue_comments_507476.json:
```json
{
    "body": "<a id='comment:6'></a>Apparently the cache bug was introduced in #28900.",
    "created_at": "2022-03-31T06:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507476",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:6'></a>Apparently the cache bug was introduced in #28900.



---

archive/issue_comments_507477.json:
```json
{
    "body": "<a id='comment:7'></a>I guess this comes from `_finite_obstructions` and `_infinite_obstructions` being `None`, which carries a different meaning. Could you add a comment saying something like, \"These values might be `None`, so we explicitly check against a list\"? Otherwise if doctests pass (I am assuming this is ready for review; if so, please set it to needs review), then positive review.",
    "created_at": "2022-03-31T06:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507477",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>I guess this comes from `_finite_obstructions` and `_infinite_obstructions` being `None`, which carries a different meaning. Could you add a comment saying something like, "These values might be `None`, so we explicitly check against a list"? Otherwise if doctests pass (I am assuming this is ready for review; if so, please set it to needs review), then positive review.



---

archive/issue_comments_507478.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T07:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507478",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_507479.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-31T07:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507479",
    "user": "https://github.com/mstreng"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_507480.json:
```json
{
    "body": "<a id='comment:9'></a>All (long) non-optional tests passed. All Magma tests in `src/sage/schemes/plane_conics` passed. And then I added the comment that Travis asked for.",
    "created_at": "2022-03-31T07:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507480",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:9'></a>All (long) non-optional tests passed. All Magma tests in `src/sage/schemes/plane_conics` passed. And then I added the comment that Travis asked for.



---

archive/issue_comments_507481.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you. LGTM.",
    "created_at": "2022-03-31T08:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507481",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Thank you. LGTM.



---

archive/issue_comments_507482.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-31T08:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507482",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_088407.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:52:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33603#event-88407"
}
```



---

archive/issue_comments_507483.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33603#issuecomment-507483",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
