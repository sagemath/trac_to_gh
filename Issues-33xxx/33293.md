# Issue 33293: checking doctest output is too slow

archive/issues_033056.json:
```json
{
    "body": "This ticket fixes a performance problem when checking large output of doctests, and rewrites some of these tests to avoid large output in the first place.\n\nThe computation in this doctest takes a few seconds, but checking the output takes the doctest framework more than 4 minutes. There is no warning about this taking a long time.\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: R(a)  # long time (7s on sage.math, 2013)\n2*x^99998 + ... + x\n```\nIt would be easy to rewrite the last line to make it fast, but ideally\n\n- parsing the doctest output should be faster\n- long time warnings should take into account the time it takes to check the output in order to make it easier to find slow doctests like this one\n\n\nAfter deleting this doctest:\n\n```\nsage -t --long --warn-long 30.0 --random-seed=127464012278616651004415010266788953280 src/sage/rings/polynomial/polynomial_zmod_flint.pyx\n    [140 tests, 0.26 s]\n```\nBefore:\n\n```\nsage -t --long --warn-long 30.0 --random-seed=47006518779514815594404376050243712990 src/sage/rings/polynomial/polynomial_zmod_flint.pyx\n    [143 tests, 267.67 s]\n```\n\n\nDepends on #33142\n\n**Branch:** [c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)\n\n**Reviewer:** Markus Wageringel, Samuel Leli\u00e8vre\n\n**Author:** Michael Orlitzky\n\nIssue created by migration from https://trac.sagemath.org/ticket/33293\n\n",
    "closed_at": "2022-02-20T13:27:33Z",
    "created_at": "2022-02-05T14:38:03Z",
    "labels": [
        "component: doctest framework",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "title": "checking doctest output is too slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/33293",
    "user": "https://github.com/mwageringel"
}
```
This ticket fixes a performance problem when checking large output of doctests, and rewrites some of these tests to avoid large output in the first place.

The computation in this doctest takes a few seconds, but checking the output takes the doctest framework more than 4 minutes. There is no warning about this taking a long time.

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: R(a)  # long time (7s on sage.math, 2013)
2*x^99998 + ... + x
```
It would be easy to rewrite the last line to make it fast, but ideally

- parsing the doctest output should be faster
- long time warnings should take into account the time it takes to check the output in order to make it easier to find slow doctests like this one


After deleting this doctest:

```
sage -t --long --warn-long 30.0 --random-seed=127464012278616651004415010266788953280 src/sage/rings/polynomial/polynomial_zmod_flint.pyx
    [140 tests, 0.26 s]
```
Before:

```
sage -t --long --warn-long 30.0 --random-seed=47006518779514815594404376050243712990 src/sage/rings/polynomial/polynomial_zmod_flint.pyx
    [143 tests, 267.67 s]
```


Depends on #33142

**Branch:** [c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)

**Reviewer:** Markus Wageringel, Samuel Lelièvre

**Author:** Michael Orlitzky

Issue created by migration from https://trac.sagemath.org/ticket/33293





---

archive/issue_comments_540656.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt would be interesting to know whether it has always been this slow or whether this is a recent change.",
    "created_at": "2022-02-05T14:39:38Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540656",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:1'></a>
It would be interesting to know whether it has always been this slow or whether this is a recent change.



---

archive/issue_comments_540657.json:
```json
{
    "body": "**Branch:** [u/mjo/ticket/33293](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/33293)",
    "created_at": "2022-02-06T02:29:23Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540657",
    "user": "https://github.com/orlitzky"
}
```

**Branch:** [u/mjo/ticket/33293](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/33293)



---

archive/issue_comments_540658.json:
```json
{
    "body": "**Author:** Michael Orlitzky",
    "created_at": "2022-02-06T02:29:23Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540658",
    "user": "https://github.com/orlitzky"
}
```

**Author:** Michael Orlitzky



---

archive/issue_comments_540659.json:
```json
{
    "body": "**Commit:** [fe33d64353f35c8ec63245fe88c7db5f9217c1b9](https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9)",
    "created_at": "2022-02-06T02:29:23Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540659",
    "user": "https://github.com/orlitzky"
}
```

**Commit:** [fe33d64353f35c8ec63245fe88c7db5f9217c1b9](https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9)



---

archive/issue_comments_540660.json:
```json
{
    "body": "<a id='comment:2'></a>\nI found and fixed the problem (see the commit message). I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though. And of course, for this one test, it would be better to check the two terms of this polynomial that we actually care about rather than using a regex on its enormous string representation.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9\">fe33d64</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr></table>\n",
    "created_at": "2022-02-06T02:29:23Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540660",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:2'></a>
I found and fixed the problem (see the commit message). I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though. And of course, for this one test, it would be better to check the two terms of this polynomial that we actually care about rather than using a regex on its enormous string representation.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9">fe33d64</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr></table>




---

archive/issue_comments_540661.json:
```json
{
    "body": "**Changing commit** from \"[fe33d64353f35c8ec63245fe88c7db5f9217c1b9](https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9)\" to \"[e94d85c94aae5586b07ea5f07f697e6b4dc8466c](https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c)\".",
    "created_at": "2022-02-06T02:37:04Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[fe33d64353f35c8ec63245fe88c7db5f9217c1b9](https://github.com/sagemath/sagetrac-mirror/commit/fe33d64353f35c8ec63245fe88c7db5f9217c1b9)" to "[e94d85c94aae5586b07ea5f07f697e6b4dc8466c](https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c)".



---

archive/issue_comments_540662.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c\">e94d85c</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr></table>\n",
    "created_at": "2022-02-06T02:37:04Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c">e94d85c</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr></table>




---

archive/issue_comments_540663.json:
```json
{
    "body": "<a id='comment:4'></a>\nThank you. I think we should also change this regular expression:\n\n```diff\n-ld_warning_regex = re.compile(r'.*dylib.*was built for newer macOS version.*than being linked.*')\n+ld_warning_regex = re.compile(r'^.*dylib.*was built for newer macOS version.*than being linked.*')\n```\n\nIt is used with `re.sub()` which looks for all occurrences of the pattern in a string, so using `.*` at the front leads to accidentally quadratic runtime.\n\nMeanwhile, I have only found two more doctests that were slowed down a lot due to the same problem\n\n```\nFile \"src/sage/rings/integer.pyx\", line 6667, in sage.rings.integer.Integer.inverse_mod\n    c = a.inverse_mod(a*a)   # long time\nFile \"src/sage/schemes/elliptic_curves/isogeny_small_degree.py\", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2\n    Psi2(71)  # long time (1 second)\n```\nwhich took about 77 and 190 seconds.\n\n\nReplying to [mjo](#comment%3A2):\n> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.\n\n\nShould this be a new ticket or done here? I can create a branch for that.",
    "created_at": "2022-02-06T12:39:08Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540663",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:4'></a>
Thank you. I think we should also change this regular expression:

```diff
-ld_warning_regex = re.compile(r'.*dylib.*was built for newer macOS version.*than being linked.*')
+ld_warning_regex = re.compile(r'^.*dylib.*was built for newer macOS version.*than being linked.*')
```

It is used with `re.sub()` which looks for all occurrences of the pattern in a string, so using `.*` at the front leads to accidentally quadratic runtime.

Meanwhile, I have only found two more doctests that were slowed down a lot due to the same problem

```
File "src/sage/rings/integer.pyx", line 6667, in sage.rings.integer.Integer.inverse_mod
    c = a.inverse_mod(a*a)   # long time
File "src/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2
    Psi2(71)  # long time (1 second)
```
which took about 77 and 190 seconds.


Replying to [mjo](#comment%3A2):
> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.


Should this be a new ticket or done here? I can create a branch for that.



---

archive/issue_events_298432.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2022-02-06T12:39:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298432"
}
```



---

archive/issue_comments_540664.json:
```json
{
    "body": "<a id='comment:5'></a>\nwill conflict with #33142",
    "created_at": "2022-02-06T13:30:28Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540664",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
will conflict with #33142



---

archive/issue_comments_540665.json:
```json
{
    "body": "**Dependencies:** #33142",
    "created_at": "2022-02-06T13:45:59Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540665",
    "user": "https://github.com/orlitzky"
}
```

**Dependencies:** #33142



---

archive/issue_comments_540666.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a9cd12fad15b5f084af0b85a68f38a29e5911a5a\">a9cd12f</a></td><td><code>remove doctest handling of long L suffix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6bd688ef6a92a267136c8f59b0ca0cc1d4b673d4\">6bd688e</a></td><td><code>fixing the few failing doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/028d3e4c6ea4318eff1419e7e4152ab0f1103751\">028d3e4</a></td><td><code>Merge branch 'u/chapoton/33142' in 9.5</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5b309aac974be15cd4344889b4487c7dff149b40\">5b309aa</a></td><td><code>more fixes about obsolete L suffix for long</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6c4a27e0b047e81de8ebdac0d0fed8c281fcc604\">6c4a27e</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9213bad00df3110b711e7629d650d6438fa55132\">9213bad</a></td><td><code>Trac #33293: output only the checked terms in a polynomial doctest.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3a07b28e43e388258891990c2e158cd2e5907e3\">d3a07b2</a></td><td><code>Trac #33293: anchor the ld_warning_regex in sage.doctest.parsing.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c\">0047c4d</a></td><td><code>Trac #33293: output only checked terms in an elliptic curve test.</code></td></tr></table>\n",
    "created_at": "2022-02-06T13:52:07Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a9cd12fad15b5f084af0b85a68f38a29e5911a5a">a9cd12f</a></td><td><code>remove doctest handling of long L suffix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6bd688ef6a92a267136c8f59b0ca0cc1d4b673d4">6bd688e</a></td><td><code>fixing the few failing doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/028d3e4c6ea4318eff1419e7e4152ab0f1103751">028d3e4</a></td><td><code>Merge branch 'u/chapoton/33142' in 9.5</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5b309aac974be15cd4344889b4487c7dff149b40">5b309aa</a></td><td><code>more fixes about obsolete L suffix for long</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6c4a27e0b047e81de8ebdac0d0fed8c281fcc604">6c4a27e</a></td><td><code>Trac #33293: don't run slow output replacements unconditionally.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9213bad00df3110b711e7629d650d6438fa55132">9213bad</a></td><td><code>Trac #33293: output only the checked terms in a polynomial doctest.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3a07b28e43e388258891990c2e158cd2e5907e3">d3a07b2</a></td><td><code>Trac #33293: anchor the ld_warning_regex in sage.doctest.parsing.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c">0047c4d</a></td><td><code>Trac #33293: output only checked terms in an elliptic curve test.</code></td></tr></table>




---

archive/issue_comments_540667.json:
```json
{
    "body": "**Changing commit** from \"[e94d85c94aae5586b07ea5f07f697e6b4dc8466c](https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c)\" to \"[0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c](https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c)\".",
    "created_at": "2022-02-06T13:52:07Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[e94d85c94aae5586b07ea5f07f697e6b4dc8466c](https://github.com/sagemath/sagetrac-mirror/commit/e94d85c94aae5586b07ea5f07f697e6b4dc8466c)" to "[0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c](https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c)".



---

archive/issue_comments_540668.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [gh-mwageringel](#comment%3A4):\n> \n> Should this be a new ticket or done here? I can create a branch for that.\n\n\nEither way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.\n\nThe timing information is currently obtained in `forker.py` within the `compile_and_execute()` method:\n\n```python\ntimer = Timer().start()\ntry:\n    compiled = compiler(example)\n    timer.start()    # reset timer                                                                                                                                   \n    exec(compiled, globs)\n    finally:\n        timer.stop().annotate(example)\n```\n\nThat's used in `_run()`, and we check the output after `compile_and_execute()` has been run and the timing information already obtained.\n\nThe cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.",
    "created_at": "2022-02-06T14:05:08Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540668",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:8'></a>
Replying to [gh-mwageringel](#comment%3A4):
> 
> Should this be a new ticket or done here? I can create a branch for that.


Either way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.

The timing information is currently obtained in `forker.py` within the `compile_and_execute()` method:

```python
timer = Timer().start()
try:
    compiled = compiler(example)
    timer.start()    # reset timer                                                                                                                                   
    exec(compiled, globs)
    finally:
        timer.stop().annotate(example)
```

That's used in `_run()`, and we check the output after `compile_and_execute()` has been run and the timing information already obtained.

The cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.



---

archive/issue_comments_540669.json:
```json
{
    "body": "**Reviewer:** Markus Wageringel",
    "created_at": "2022-02-06T17:51:55Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540669",
    "user": "https://github.com/mwageringel"
}
```

**Reviewer:** Markus Wageringel



---

archive/issue_events_298433.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2022-02-06T17:51:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298433"
}
```



---

archive/issue_comments_540670.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [mjo](#comment%3A8):\n> Replying to [gh-mwageringel](#comment%3A4):\n> > \n> > Should this be a new ticket or done here? I can create a branch for that.\n\n> \n> Either way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.\n\n\nOk, I will open a new ticket then to avoid unnecessary conflicts, as the current branch seems already good to me.\n\n> The cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.\n\n\nThe first option would allow to make the warning message more informative, as we can report which part of the test is slow. My approach would have been to measure the wall time from before the test is run until after the check is done. Then the difference with the wall time from the timer in `compile_and_execute` should give the overall overhead of checking the output and also compiling the test etc. This would conflict with #32981 though, I think.\n\nIf we add a separate timer just for the output checking, should it measure cpu time rather than wall time?",
    "created_at": "2022-02-06T17:51:55Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540670",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>
Replying to [mjo](#comment%3A8):
> Replying to [gh-mwageringel](#comment%3A4):
> > 
> > Should this be a new ticket or done here? I can create a branch for that.

> 
> Either way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.


Ok, I will open a new ticket then to avoid unnecessary conflicts, as the current branch seems already good to me.

> The cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.


The first option would allow to make the warning message more informative, as we can report which part of the test is slow. My approach would have been to measure the wall time from before the test is run until after the check is done. Then the difference with the wall time from the timer in `compile_and_execute` should give the overall overhead of checking the output and also compiling the test etc. This would conflict with #32981 though, I think.

If we add a separate timer just for the output checking, should it measure cpu time rather than wall time?



---

archive/issue_comments_540671.json:
```json
{
    "body": "<a id='comment:10'></a>\nDoes the modified doctest still need to be marked long?\n\nEven checking all the coefficients does not take all that long.\n\n```\nsage: %time a = ZZ['x'](range(100000))\nCPU times: user 15 ms, sys: 2.45 ms, total: 17.4 ms\nWall time: 18 ms\nsage: %time R = Integers(3)['x']\nCPU times: user 13.6 ms, sys: 3.9 ms, total: 17.5 ms\nWall time: 18.5 ms\nsage: %time p = R(a)\nCPU times: user 59.4 ms, sys: 4.54 ms, total: 64 ms\nWall time: 64.5 ms\nsage: %time p.list() == [0, 1, 2] * 33333\nCPU times: user 275 ms, sys: 5.17 ms, total: 281 ms\nWall time: 283 ms\nTrue\n```",
    "created_at": "2022-02-06T17:56:24Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540671",
    "user": "https://github.com/slel"
}
```

<a id='comment:10'></a>
Does the modified doctest still need to be marked long?

Even checking all the coefficients does not take all that long.

```
sage: %time a = ZZ['x'](range(100000))
CPU times: user 15 ms, sys: 2.45 ms, total: 17.4 ms
Wall time: 18 ms
sage: %time R = Integers(3)['x']
CPU times: user 13.6 ms, sys: 3.9 ms, total: 17.5 ms
Wall time: 18.5 ms
sage: %time p = R(a)
CPU times: user 59.4 ms, sys: 4.54 ms, total: 64 ms
Wall time: 64.5 ms
sage: %time p.list() == [0, 1, 2] * 33333
CPU times: user 275 ms, sys: 5.17 ms, total: 281 ms
Wall time: 283 ms
True
```



---

archive/issue_comments_540672.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00\">0b065fe</a></td><td><code>Trac #33293: remove \"# long time\" from a now-quick test.</code></td></tr></table>\n",
    "created_at": "2022-02-06T18:08:01Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540672",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00">0b065fe</a></td><td><code>Trac #33293: remove "# long time" from a now-quick test.</code></td></tr></table>




---

archive/issue_comments_540673.json:
```json
{
    "body": "**Changing commit** from \"[0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c](https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c)\" to \"[0b065fe593ca9a86fa414d04b84684d4a4ca8b00](https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00)\".",
    "created_at": "2022-02-06T18:08:01Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540673",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c](https://github.com/sagemath/sagetrac-mirror/commit/0047c4d6cb4fabd27dcf1ba6de5114fcdb74835c)" to "[0b065fe593ca9a86fa414d04b84684d4a4ca8b00](https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00)".



---

archive/issue_comments_540674.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [slelievre](#comment%3A10):\n> Does the modified doctest still need to be marked long?\n> \n> Even checking all the coefficients does not take all that long.\n\n\nRight, good catch.",
    "created_at": "2022-02-06T18:09:11Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540674",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>
Replying to [slelievre](#comment%3A10):
> Does the modified doctest still need to be marked long?
> 
> Even checking all the coefficients does not take all that long.


Right, good catch.



---

archive/issue_comments_540675.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [gh-mwageringel](#comment%3A9):\n> \n> If we add a separate timer just for the output checking, should it measure cpu time rather than wall time?\n\n\nFor now, I would say yes. CPU time still isn't perfect because it depends on your CPU, optimization flags, and so on. But wall time is just completely crazy. (I don't know if our implementation does this, but using wall time in general risks e.g. getting outrageous answers twice a year at 2am due to daylight savings time).\n\nIn #33022 we'll replace CPU time with the amount of time that it takes to perform some computation. That should minimize the difference due to CPU type and compiler flags.",
    "created_at": "2022-02-06T18:15:06Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540675",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>
Replying to [gh-mwageringel](#comment%3A9):
> 
> If we add a separate timer just for the output checking, should it measure cpu time rather than wall time?


For now, I would say yes. CPU time still isn't perfect because it depends on your CPU, optimization flags, and so on. But wall time is just completely crazy. (I don't know if our implementation does this, but using wall time in general risks e.g. getting outrageous answers twice a year at 2am due to daylight savings time).

In #33022 we'll replace CPU time with the amount of time that it takes to perform some computation. That should minimize the difference due to CPU type and compiler flags.



---

archive/issue_comments_540676.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe test in `schemes/elliptic_curves/isogeny_small_degree.py`\nalso became fast:\n\n```\nsage: %time from sage.schemes.elliptic_curves.isogeny_small_degree import Psi2\nCPU times: user 18.4 ms, sys: 4.92 ms, total: 23.3 ms\nWall time: 24.7 ms\nsage: %time Psi2(11)\nCPU times: user 109 ms, sys: 30.7 ms, total: 140 ms\nWall time: 240 ms\nx^5 - 55*x^4*u + 994*x^3*u^2 - 8774*x^2*u^3 + 41453*x*u^4 - 928945/11*u^5 + 33*x^4 + 276*x^3*u - 7794*x^2*u^2 + 4452*x*u^3 + 1319331/11*u^4 + 216*x^3*v - 4536*x^2*u*v + 31752*x*u^2*v - 842616/11*u^3*v + 162*x^3 + 38718*x^2*u - 610578*x*u^2 + 33434694/11*u^3 - 4536*x^2*v + 73872*x*u*v - 2745576/11*u^2*v - 16470*x^2 + 580068*x*u - 67821354/11*u^2 - 185976*x*v + 14143896/11*u*v + 7533*x - 20437029/11*u - 12389112/11*v + 19964151/11\nsage: %time p = Psi2(71)\nCPU times: user 578 ms, sys: 8.28 ms, total: 586 ms\nWall time: 595 ms\nsage: %time (x,u,v) = p.variables()\nCPU times: user 374 \u00b5s, sys: 33 \u00b5s, total: 407 \u00b5s\nWall time: 409 \u00b5s\nsage: %time p.coefficient({x: 0, u: 210, v: 0})\nCPU times: user 171 \u00b5s, sys: 28 \u00b5s, total: 199 \u00b5s\nWall time: 203 \u00b5s\n-2209380711722505179506258739515288584116147237393815266468076436521/71\nsage: %time p.coefficient({x: 0, u: 0, v: 0})\nCPU times: user 128 \u00b5s, sys: 0 ns, total: 128 \u00b5s\nWall time: 131 \u00b5s\n-14790739586438315394567393301990769678157425619440464678252277649/71\n```",
    "created_at": "2022-02-06T19:02:18Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540676",
    "user": "https://github.com/slel"
}
```

<a id='comment:14'></a>
The test in `schemes/elliptic_curves/isogeny_small_degree.py`
also became fast:

```
sage: %time from sage.schemes.elliptic_curves.isogeny_small_degree import Psi2
CPU times: user 18.4 ms, sys: 4.92 ms, total: 23.3 ms
Wall time: 24.7 ms
sage: %time Psi2(11)
CPU times: user 109 ms, sys: 30.7 ms, total: 140 ms
Wall time: 240 ms
x^5 - 55*x^4*u + 994*x^3*u^2 - 8774*x^2*u^3 + 41453*x*u^4 - 928945/11*u^5 + 33*x^4 + 276*x^3*u - 7794*x^2*u^2 + 4452*x*u^3 + 1319331/11*u^4 + 216*x^3*v - 4536*x^2*u*v + 31752*x*u^2*v - 842616/11*u^3*v + 162*x^3 + 38718*x^2*u - 610578*x*u^2 + 33434694/11*u^3 - 4536*x^2*v + 73872*x*u*v - 2745576/11*u^2*v - 16470*x^2 + 580068*x*u - 67821354/11*u^2 - 185976*x*v + 14143896/11*u*v + 7533*x - 20437029/11*u - 12389112/11*v + 19964151/11
sage: %time p = Psi2(71)
CPU times: user 578 ms, sys: 8.28 ms, total: 586 ms
Wall time: 595 ms
sage: %time (x,u,v) = p.variables()
CPU times: user 374 µs, sys: 33 µs, total: 407 µs
Wall time: 409 µs
sage: %time p.coefficient({x: 0, u: 210, v: 0})
CPU times: user 171 µs, sys: 28 µs, total: 199 µs
Wall time: 203 µs
-2209380711722505179506258739515288584116147237393815266468076436521/71
sage: %time p.coefficient({x: 0, u: 0, v: 0})
CPU times: user 128 µs, sys: 0 ns, total: 128 µs
Wall time: 131 µs
-14790739586438315394567393301990769678157425619440464678252277649/71
```



---

archive/issue_comments_540677.json:
```json
{
    "body": "<a id='comment:15'></a>\nThe reworked `rings/polynomial/polynomial_zmod_flint.pyx`\ndoctest lost some information.\n\nThis would contain all the same information.\n\n```\nsage: d, v = p.degree(), p.valuation()\nsage: d, v\n(99998, 1)\nsage: p[d], p[v]\n(2, 1)\n```",
    "created_at": "2022-02-06T19:02:25Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540677",
    "user": "https://github.com/slel"
}
```

<a id='comment:15'></a>
The reworked `rings/polynomial/polynomial_zmod_flint.pyx`
doctest lost some information.

This would contain all the same information.

```
sage: d, v = p.degree(), p.valuation()
sage: d, v
(99998, 1)
sage: p[d], p[v]
(2, 1)
```



---

archive/issue_comments_540678.json:
```json
{
    "body": "<a id='comment:16'></a>\nWith `p` from the `polynomial_zmod_flint.pyx` doctest,\nhere is something slow:\n\n```\nsage: %time str(p) == str(p)\nCPU times: user 7.71 s, sys: 309 ms, total: 8.02 s\nWall time: 8.04 s\nTrue\n```",
    "created_at": "2022-02-06T19:04:04Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540678",
    "user": "https://github.com/slel"
}
```

<a id='comment:16'></a>
With `p` from the `polynomial_zmod_flint.pyx` doctest,
here is something slow:

```
sage: %time str(p) == str(p)
CPU times: user 7.71 s, sys: 309 ms, total: 8.02 s
Wall time: 8.04 s
True
```



---

archive/issue_comments_540679.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404\">c1a0613</a></td><td><code>Trac #33293: add back some information to a polynomial_zmod_flint doctest.</code></td></tr></table>\n",
    "created_at": "2022-02-06T20:56:37Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540679",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404">c1a0613</a></td><td><code>Trac #33293: add back some information to a polynomial_zmod_flint doctest.</code></td></tr></table>




---

archive/issue_comments_540680.json:
```json
{
    "body": "**Changing commit** from \"[0b065fe593ca9a86fa414d04b84684d4a4ca8b00](https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00)\" to \"[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)\".",
    "created_at": "2022-02-06T20:56:37Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540680",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0b065fe593ca9a86fa414d04b84684d4a4ca8b00](https://github.com/sagemath/sagetrac-mirror/commit/0b065fe593ca9a86fa414d04b84684d4a4ca8b00)" to "[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)".



---

archive/issue_events_298434.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2022-02-14T21:10:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298434"
}
```



---

archive/issue_events_298435.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2022-02-14T21:10:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298435"
}
```



---

archive/issue_comments_540681.json:
```json
{
    "body": "**Changing reviewer** from \"Markus Wageringel\" to \"Markus Wageringel, Samuel Leli\u00e8vre\".",
    "created_at": "2022-02-14T21:10:38Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540681",
    "user": "https://github.com/mwageringel"
}
```

**Changing reviewer** from "Markus Wageringel" to "Markus Wageringel, Samuel Lelièvre".



---

archive/issue_comments_540682.json:
```json
{
    "body": "<a id='comment:18'></a>\nAll the suggestions have been implemented, so I think we can move forward with this. Please revert this, Samuel, in case you have further concerns.\n\nI do not understand what is wrong with the patchbot though, but the tests have passed already with the previous beta.",
    "created_at": "2022-02-14T21:10:38Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540682",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:18'></a>
All the suggestions have been implemented, so I think we can move forward with this. Please revert this, Samuel, in case you have further concerns.

I do not understand what is wrong with the patchbot though, but the tests have passed already with the previous beta.



---

archive/issue_comments_540683.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+This ticket fixes a performance problem when checking large output of doctests, and rewrites some of these tests to avoid large output in the first place.\n+\n The computation in this doctest takes a few seconds, but checking the output takes the doctest framework more than 4 minutes. There is no warning about this taking a long time.\n \n ```\n``````\n",
    "created_at": "2022-02-14T21:11:40Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540683",
    "user": "https://github.com/mwageringel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+This ticket fixes a performance problem when checking large output of doctests, and rewrites some of these tests to avoid large output in the first place.
+
 The computation in this doctest takes a few seconds, but checking the output takes the doctest framework more than 4 minutes. There is no warning about this taking a long time.
 
 ```
``````




---

archive/issue_comments_540684.json:
```json
{
    "body": "<a id='comment:20'></a>\nNo further concerns, [comment:14](#comment%3A14) was maybe a bit hasty.\n\nThe `psi2` doctest might in fact still qualify for the\n`# long time` marker.\n\nFr\u00e9d\u00e9ric, do you understand the \"doctest continuation\"\npatchbot plugin reports?",
    "created_at": "2022-02-15T00:16:55Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540684",
    "user": "https://github.com/slel"
}
```

<a id='comment:20'></a>
No further concerns, [comment:14](#comment%3A14) was maybe a bit hasty.

The `psi2` doctest might in fact still qualify for the
`# long time` marker.

Frédéric, do you understand the "doctest continuation"
patchbot plugin reports?



---

archive/issue_comments_540685.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [slelievre](#comment%3A20):\n> Fr\u00e9d\u00e9ric, do you understand the \"doctest continuation\"\n> patchbot plugin reports?\n\n\nThe continuation plugin is about checking the `....:` syntax of continuation lines. The plugin failure seems to be a false positive.\n\nThough, at the time of my previous comment, the bot was stuck in status \"pending\" which is what I did not understand. The bot had already moved on to other tickets. Only after telling it to retry this ticket, it actually ran the tests \u2013 and the previous \"pending\" report was replaced by the new report.",
    "created_at": "2022-02-15T07:32:16Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540685",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:21'></a>
Replying to [slelievre](#comment%3A20):
> Frédéric, do you understand the "doctest continuation"
> patchbot plugin reports?


The continuation plugin is about checking the `....:` syntax of continuation lines. The plugin failure seems to be a false positive.

Though, at the time of my previous comment, the bot was stuck in status "pending" which is what I did not understand. The bot had already moved on to other tickets. Only after telling it to retry this ticket, it actually ran the tests – and the previous "pending" report was replaced by the new report.



---

archive/issue_comments_540686.json:
```json
{
    "body": "**Changing branch** from \"[u/mjo/ticket/33293](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/33293)\" to \"[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)\".",
    "created_at": "2022-02-20T13:27:33Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540686",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mjo/ticket/33293](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/33293)" to "[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)".



---

archive/issue_events_298436.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-20T13:27:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298436"
}
```



---

archive/issue_events_298437.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "694cf6915f3d13c640942a5b7012b6f32070cf3d",
    "created_at": "2022-02-20T13:27:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33293#event-298437"
}
```



---

archive/issue_comments_540687.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [mjo](#comment%3A2):\n> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.\n\n\nI have opened #33411 for this.",
    "created_at": "2022-02-23T20:02:33Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540687",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:23'></a>
Replying to [mjo](#comment%3A2):
> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.


I have opened #33411 for this.



---

archive/issue_comments_540688.json:
```json
{
    "body": "**Changing commit** from \"[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)\" to \"\".",
    "created_at": "2022-02-23T20:02:33Z",
    "issue": "https://github.com/sagemath/sage/issues/33293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33293#issuecomment-540688",
    "user": "https://github.com/mwageringel"
}
```

**Changing commit** from "[c1a0613a7950896ce5e057bdd0c29bb0b4792404](https://github.com/sagemath/sagetrac-mirror/commit/c1a0613a7950896ce5e057bdd0c29bb0b4792404)" to "".
