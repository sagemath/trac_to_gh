# Issue 33588: warnings to ignore are not ignored when a doctest is tagged with # tol

archive/issues_033351.json:
```json
{
    "body": "## The symptom\n\nOn Ubuntu 18.04, with `SageMath version 9.6.beta6, Release Date: 2022-03-27`, with the GLPK available on the system `$ glpsol -v` returning `GLPSOL: GLPK LP/MIP Solver, v4.65`, we observe doctest failures of the following kind:\n\n```\nFailed example:\n    lp.solve() # tol 1e-8   # optional - sage.rings.number_field\nExpected:\n    1.3090169943749475\nGot:\n    Long-step dual simplex will be used\n    1.3090169943749472\n```\n\nFailures always consists of doctests tagged with some numerical tolerence `# tol`. It seems the fix proposed in #29317 to ignore sentence `Long-step dual simplex will be used` printed by GLPK does not work for doctests tagged with `# tol`.\n\n\nThe complete list of failures consist of the following 4 files:\n\n```\nsage -tp --long src/sage/geometry/polyhedron/base.py src/sage/numerical/backends/glpk_backend.pyx src/sage/numerical/mip.pyx src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py\n```\ngives\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/geometry/polyhedron/base.py  # 1 doctest failed\nsage -t --long src/sage/numerical/backends/glpk_backend.pyx  # 4 doctests failed\nsage -t --long src/sage/numerical/mip.pyx  # 8 doctests failed\nsage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\n## Isolation of the problem\n\nThe problem was understood in comment:7. The warnings are not ignored by `check_output` method when tolerance tags are given. The following example illustrate the issue, the last line should be True:\n\n```\nsage: from sage.doctest.parsing import SageOutputChecker, SageDocTestParser\nsage: import doctest\nsage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS\nsage: DTP = SageDocTestParser(('sage','magma','guava'))\nsage: OC = SageOutputChecker()\nsage: example = \"sage: 1.3090169943749475 # tol 1e-8\\n1.3090169943749475\"\nsage: ex = DTP.parse(example)[1]\nsage: ex.sage_source\n'1.3090169943749475 # tol 1e-8\\n'\nsage: ex.want\n'1.3090169943749475\\n'\nsage: OC.check_output(ex.want, '1.3090169943749475', optflag)\nTrue\nsage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)\nFalse\nsage: OC.check_output(ex.want, 'Long-step dual simplex will be used\\n1.3090169943749475', optflag)\nFalse\n```\n\n## The problem with the current code\n\nIt can be checked inside of the `check_output` method at [line 925 and below](https://gitlab.com/sagemath/sage/-/blob/develop/src/sage/doctest/parsing.py#L925) that when a tolerance is given a result True or False is returned before any fixup is performed to remove eventual `Long-step dual simplex will be used` to the output.\n\nMore precisely, at line 934, we return False because everything other than float numbers are not equal. This `return False` is done too early. Because we want to do eventual fix ups before returning False.\n\n## The solution\n\nThe solution is not to return False at line 934 when the non-float part is not equal. In fact it is better to first check that all floats intervals intersect (currently done at line 942) and return False if not all intervals intersect.\n\nThen, we can continue with checking the remaining non-floats parts as it is done by default when no tolerance is given instead of returning False.\n\n## Further improvements\n\nWe create a independent method `do_fixup` which does the removal of eventual warnings as a last resort solution before returning False.\n\nTo ease the review, we keep the list `_repr_fixups` for now in the header of the module and leave its integration within `do_fixup` method for the follow-up ticket #33680.\n\nCC:  @kiwifb\n\nReviewer: John Palmieri\n\nAuthor: S\u00e9bastien Labb\u00e9\n\nBranch: 2afb47293d0fb63f017d3e9acb6035166dfc92aa\n\nCommit: 2afb47293d0fb63f017d3e9acb6035166dfc92aa\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33588\n\n",
    "closed_at": "2022-04-24T06:31:07Z",
    "created_at": "2022-03-29T12:54:42Z",
    "labels": [
        "component: numerical",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "warnings to ignore are not ignored when a doctest is tagged with # tol",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33588",
    "user": "https://github.com/seblabbe"
}
```
## The symptom

On Ubuntu 18.04, with `SageMath version 9.6.beta6, Release Date: 2022-03-27`, with the GLPK available on the system `$ glpsol -v` returning `GLPSOL: GLPK LP/MIP Solver, v4.65`, we observe doctest failures of the following kind:

```
Failed example:
    lp.solve() # tol 1e-8   # optional - sage.rings.number_field
Expected:
    1.3090169943749475
Got:
    Long-step dual simplex will be used
    1.3090169943749472
```

Failures always consists of doctests tagged with some numerical tolerence `# tol`. It seems the fix proposed in #29317 to ignore sentence `Long-step dual simplex will be used` printed by GLPK does not work for doctests tagged with `# tol`.


The complete list of failures consist of the following 4 files:

```
sage -tp --long src/sage/geometry/polyhedron/base.py src/sage/numerical/backends/glpk_backend.pyx src/sage/numerical/mip.pyx src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py
```
gives

```
----------------------------------------------------------------------
sage -t --long src/sage/geometry/polyhedron/base.py  # 1 doctest failed
sage -t --long src/sage/numerical/backends/glpk_backend.pyx  # 4 doctests failed
sage -t --long src/sage/numerical/mip.pyx  # 8 doctests failed
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py  # 2 doctests failed
----------------------------------------------------------------------
```

## Isolation of the problem

The problem was understood in comment:7. The warnings are not ignored by `check_output` method when tolerance tags are given. The following example illustrate the issue, the last line should be True:

```
sage: from sage.doctest.parsing import SageOutputChecker, SageDocTestParser
sage: import doctest
sage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS
sage: DTP = SageDocTestParser(('sage','magma','guava'))
sage: OC = SageOutputChecker()
sage: example = "sage: 1.3090169943749475 # tol 1e-8\n1.3090169943749475"
sage: ex = DTP.parse(example)[1]
sage: ex.sage_source
'1.3090169943749475 # tol 1e-8\n'
sage: ex.want
'1.3090169943749475\n'
sage: OC.check_output(ex.want, '1.3090169943749475', optflag)
True
sage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)
False
sage: OC.check_output(ex.want, 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
False
```

## The problem with the current code

It can be checked inside of the `check_output` method at [line 925 and below](https://gitlab.com/sagemath/sage/-/blob/develop/src/sage/doctest/parsing.py#L925) that when a tolerance is given a result True or False is returned before any fixup is performed to remove eventual `Long-step dual simplex will be used` to the output.

More precisely, at line 934, we return False because everything other than float numbers are not equal. This `return False` is done too early. Because we want to do eventual fix ups before returning False.

## The solution

The solution is not to return False at line 934 when the non-float part is not equal. In fact it is better to first check that all floats intervals intersect (currently done at line 942) and return False if not all intervals intersect.

Then, we can continue with checking the remaining non-floats parts as it is done by default when no tolerance is given instead of returning False.

## Further improvements

We create a independent method `do_fixup` which does the removal of eventual warnings as a last resort solution before returning False.

To ease the review, we keep the list `_repr_fixups` for now in the header of the module and leave its integration within `do_fixup` method for the follow-up ticket #33680.

CC:  @kiwifb

Reviewer: John Palmieri

Author: Sébastien Labbé

Branch: 2afb47293d0fb63f017d3e9acb6035166dfc92aa

Commit: 2afb47293d0fb63f017d3e9acb6035166dfc92aa

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33588





---

archive/issue_comments_474232.json:
```json
{
    "body": "<a id='comment:2'></a>\n```\nDoctesting 4 files.\nsage -t --long --random-seed=19 geometry/polyhedron/base.py\n    28 latte_int tests not run\n    0 tests not run because we ran out of time\n    [320 tests, 31.72 s]\nsage -t --long --random-seed=19 numerical/backends/glpk_backend.pyx\n    0 tests not run because we ran out of time\n    [592 tests, 4.18 s]\nsage -t --long --random-seed=19 numerical/mip.pyx\n    8 cplex tests not run\n    3 gurobi tests not run\n    7 not tested tests not run\n    0 tests not run because we ran out of time\n    [713 tests, 1.60 s]\nsage -t --long --random-seed=19 tests/books/computational-mathematics-with-sagemath/lp_doctest.py\n    0 tests not run because we ran out of time\n    [68 tests, 0.04 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 39.3 seconds\n    cpu time: 20.1 seconds\n    cumulative wall time: 37.5 seconds\n```\nbut that is `9.6.beta6` + #31962",
    "created_at": "2022-03-29T17:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474232",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:2'></a>
```
Doctesting 4 files.
sage -t --long --random-seed=19 geometry/polyhedron/base.py
    28 latte_int tests not run
    0 tests not run because we ran out of time
    [320 tests, 31.72 s]
sage -t --long --random-seed=19 numerical/backends/glpk_backend.pyx
    0 tests not run because we ran out of time
    [592 tests, 4.18 s]
sage -t --long --random-seed=19 numerical/mip.pyx
    8 cplex tests not run
    3 gurobi tests not run
    7 not tested tests not run
    0 tests not run because we ran out of time
    [713 tests, 1.60 s]
sage -t --long --random-seed=19 tests/books/computational-mathematics-with-sagemath/lp_doctest.py
    0 tests not run because we ran out of time
    [68 tests, 0.04 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 39.3 seconds
    cpu time: 20.1 seconds
    cumulative wall time: 37.5 seconds
```
but that is `9.6.beta6` + #31962



---

archive/issue_comments_474233.json:
```json
{
    "body": "<a id='comment:3'></a>See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.",
    "created_at": "2022-03-29T22:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474233",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.



---

archive/issue_comments_474234.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 jhpalmieri]:\n> See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.\n\n\nYes, it is the glpk from the system:\n\n```\n$ grep glpk config.log\n## Checking whether SageMath should install SPKG glpk... ##\nconfigure:12313: checking glpk.h usability\nconfigure:12313: checking glpk.h presence\nconfigure:12313: checking for glpk.h\nconfigure:12352: g++ -std=gnu++11 -o conftest    conftest.cpp -lglpk  -lgmp -lm  >&5\nconfigure:12369: result: -lglpk\nconfigure:12374: result: yes. Use system's glpk\nconfigure:12395: will use system package and not install SPKG glpk\nconfigure:12434: result: using glpk from the system\n```\n\nThis one:\n\n```\n$ glpsol -v\nGLPSOL: GLPK LP/MIP Solver, v4.65\n```",
    "created_at": "2022-03-31T09:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474234",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:5'></a>Replying to [comment:3 jhpalmieri]:
> See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.


Yes, it is the glpk from the system:

```
$ grep glpk config.log
## Checking whether SageMath should install SPKG glpk... ##
configure:12313: checking glpk.h usability
configure:12313: checking glpk.h presence
configure:12313: checking for glpk.h
configure:12352: g++ -std=gnu++11 -o conftest    conftest.cpp -lglpk  -lgmp -lm  >&5
configure:12369: result: -lglpk
configure:12374: result: yes. Use system's glpk
configure:12395: will use system package and not install SPKG glpk
configure:12434: result: using glpk from the system
```

This one:

```
$ glpsol -v
GLPSOL: GLPK LP/MIP Solver, v4.65
```



---

archive/issue_comments_474235.json:
```json
{
    "body": "<a id='comment:6'></a>As I said, I wonder why the fix from #29317 is not catching this. From `sage.doctest.parsing`:\n\n```\n# Version 4.65 of glpk prints the warning \"Long-step dual simplex will\n# be used\" frequently. When Sage uses a system installation of glpk\n# which has not been patched, we need to ignore that message.\n# See :trac:`29317`.\nglpk_simplex_warning_regex = re.compile(r'(Long-step dual simplex will be used)')\n```\nand then later on, that regular expression should be filtered out.",
    "created_at": "2022-03-31T16:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474235",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>As I said, I wonder why the fix from #29317 is not catching this. From `sage.doctest.parsing`:

```
# Version 4.65 of glpk prints the warning "Long-step dual simplex will
# be used" frequently. When Sage uses a system installation of glpk
# which has not been patched, we need to ignore that message.
# See :trac:`29317`.
glpk_simplex_warning_regex = re.compile(r'(Long-step dual simplex will be used)')
```
and then later on, that regular expression should be filtered out.



---

archive/issue_comments_474236.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 jhpalmieri]:\n> As I said, I wonder why the fix from #29317 is not catching this.\n\n\nI got it. It is because the `# tol 1e-8` is dealt in the `check_output` method before the glpk regex get replaced.\n\nThe following behavior is fine:\n\n```\nsage: import doctest\nsage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS\nsage: from sage.doctest.parsing import SageOutputChecker\nsage: OC = SageOutputChecker()\nsage: OC.check_output('1.3090169943749475','1.3090169943749475',optflag)\nTrue\nsage: OC.check_output('1.3090169943749475','ANYTHING1.3090169943749475',optflag)\nFalse\nsage: OC.check_output('1.3090169943749475','Long-step dual simplex will be used\\n1.3090169943749475',optflag)\nTrue\n```\n\nThe following is ok as well:\n\n```\nsage: from sage.doctest.parsing import SageOutputChecker, SageDocTestParser\nsage: import doctest\nsage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS\nsage: DTP = SageDocTestParser(('sage','magma','guava'))\nsage: OC = SageOutputChecker()\nsage: example = \"sage: 1.3090169943749475\\n1.3090169943749475\"\nsage: ex = DTP.parse(example)[1]\nsage: ex.want\n'1.3090169943749475\\n'\nsage: OC.check_output(ex.want, '1.3090169943749475', optflag)\nTrue\nsage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)\nFalse\nsage: OC.check_output(ex.want, 'Long-step dual simplex will be used\\n1.3090169943749475', optflag)\nTrue\n```\n\nThe following illustrates the bug (the last line should be True):\n\n```\nsage: example = \"sage: 1.3090169943749475 # tol 1e-8\\n1.3090169943749475\"\nsage: ex = DTP.parse(example)[1]\nsage: ex.sage_source\n'1.3090169943749475 # tol 1e-8\\n'\nsage: ex.want\n'1.3090169943749475\\n'\nsage: OC.check_output(ex.want, '1.3090169943749475', optflag)\nTrue\nsage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)\nFalse\nsage: OC.check_output(ex.want, 'Long-step dual simplex will be used\\n1.3090169943749475', optflag)\nFalse\n```\n\nObserve that turning `ex.want` back to a string fixes it because I think the return is made in the `if isinstance(want, MarkedOutput):` block within the `check_output` method:\n\n```\nsage: type(ex.want)\n<class 'sage.doctest.parsing.MarkedOutput'>\nsage: sage: OC.check_output(str(ex.want), 'Long-step dual simplex will be used\\n1.3090169943749475', optflag)\nTrue\n```",
    "created_at": "2022-04-01T15:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474236",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:7'></a>Replying to [comment:6 jhpalmieri]:
> As I said, I wonder why the fix from #29317 is not catching this.


I got it. It is because the `# tol 1e-8` is dealt in the `check_output` method before the glpk regex get replaced.

The following behavior is fine:

```
sage: import doctest
sage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS
sage: from sage.doctest.parsing import SageOutputChecker
sage: OC = SageOutputChecker()
sage: OC.check_output('1.3090169943749475','1.3090169943749475',optflag)
True
sage: OC.check_output('1.3090169943749475','ANYTHING1.3090169943749475',optflag)
False
sage: OC.check_output('1.3090169943749475','Long-step dual simplex will be used\n1.3090169943749475',optflag)
True
```

The following is ok as well:

```
sage: from sage.doctest.parsing import SageOutputChecker, SageDocTestParser
sage: import doctest
sage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS
sage: DTP = SageDocTestParser(('sage','magma','guava'))
sage: OC = SageOutputChecker()
sage: example = "sage: 1.3090169943749475\n1.3090169943749475"
sage: ex = DTP.parse(example)[1]
sage: ex.want
'1.3090169943749475\n'
sage: OC.check_output(ex.want, '1.3090169943749475', optflag)
True
sage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)
False
sage: OC.check_output(ex.want, 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
True
```

The following illustrates the bug (the last line should be True):

```
sage: example = "sage: 1.3090169943749475 # tol 1e-8\n1.3090169943749475"
sage: ex = DTP.parse(example)[1]
sage: ex.sage_source
'1.3090169943749475 # tol 1e-8\n'
sage: ex.want
'1.3090169943749475\n'
sage: OC.check_output(ex.want, '1.3090169943749475', optflag)
True
sage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)
False
sage: OC.check_output(ex.want, 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
False
```

Observe that turning `ex.want` back to a string fixes it because I think the return is made in the `if isinstance(want, MarkedOutput):` block within the `check_output` method:

```
sage: type(ex.want)
<class 'sage.doctest.parsing.MarkedOutput'>
sage: sage: OC.check_output(str(ex.want), 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
True
```



---

archive/issue_comments_474237.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-04-03T18:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474237",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_474238.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-07T15:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474238",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474239.json:
```json
{
    "body": "<a id='comment:9'></a>I found a way to fix the issue.\n\n---\nNew commits:",
    "created_at": "2022-04-07T15:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474239",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:9'></a>I found a way to fix the issue.

---
New commits:



---

archive/issue_comments_474240.json:
```json
{
    "body": "<a id='comment:10'></a>The code as it is now works and fixes the issue in the description of this ticket. Doing so, I added a new method `try_fixup` which helps understand what is happening. The way it is written follows how the code was written before. But here are few things that I dislike and that could be improved if reviewers agree:\n\n- parameter `want` is not changed by `try_fixup`, only `got`, so why should `fixup` take `want` as input?\n- the list `_repr_fixups` is defined in the header of the module but it is used only in the `try_fixup` method. I think it would make sense to remove it from the header and move it down inside the `try_fixup` method. It would make the `try_fixup` method more usable. More precisely, when somethings goes wrong for instance while debugging #33588, it is practical to add few `print` statements to see what is happening but it is quite painful to add a print statement inside of the lambda functions defined in the `_repr_fixups` at the top of the module.\n- Since `_repr_fixups` is defined completely out of context in the top module it comes with 8 lines of documentation painfully explaining what it is. These lines would just disappear by defining them in context inside of the `try_fixup` method.\n\n```python\n# Collection of fixups applied in the SageOutputChecker.  Each element in this\n# this list a pair of functions applied to the actual test output ('g' for\n# \"got\") and the expected test output ('w' for \"wanted\").  The first function\n# should be a simple fast test on the expected and/or actual output to                 \n# determine if a fixup should be applied.  The second function is the actual\n# fixup, which is applied if the test function passes.  In most fixups only one\n# of the expected or received outputs are normalized, depending on the\n# application.                            \n_repr_fixups = [                                                          \n    (lambda g, w: \"Long-step\" in g,         \n     lambda g, w: (glpk_simplex_warning_regex.sub('', g), w)),\n                                  \n    (lambda g, w: \"dylib\" in g,                             \n     lambda g, w: (ld_warning_regex.sub('', g), w)),             \n                                                                    \n    (lambda g, w: \"pie being ignored\" in g,                              \n     lambda g, w: (ld_pie_warning_regex.sub('', g), w))                                          \n]    \n```\n\nIf reviewers agree with me, I will do one more commit improving that.",
    "created_at": "2022-04-07T15:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474240",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:10'></a>The code as it is now works and fixes the issue in the description of this ticket. Doing so, I added a new method `try_fixup` which helps understand what is happening. The way it is written follows how the code was written before. But here are few things that I dislike and that could be improved if reviewers agree:

- parameter `want` is not changed by `try_fixup`, only `got`, so why should `fixup` take `want` as input?
- the list `_repr_fixups` is defined in the header of the module but it is used only in the `try_fixup` method. I think it would make sense to remove it from the header and move it down inside the `try_fixup` method. It would make the `try_fixup` method more usable. More precisely, when somethings goes wrong for instance while debugging #33588, it is practical to add few `print` statements to see what is happening but it is quite painful to add a print statement inside of the lambda functions defined in the `_repr_fixups` at the top of the module.
- Since `_repr_fixups` is defined completely out of context in the top module it comes with 8 lines of documentation painfully explaining what it is. These lines would just disappear by defining them in context inside of the `try_fixup` method.

```python
# Collection of fixups applied in the SageOutputChecker.  Each element in this
# this list a pair of functions applied to the actual test output ('g' for
# "got") and the expected test output ('w' for "wanted").  The first function
# should be a simple fast test on the expected and/or actual output to                 
# determine if a fixup should be applied.  The second function is the actual
# fixup, which is applied if the test function passes.  In most fixups only one
# of the expected or received outputs are normalized, depending on the
# application.                            
_repr_fixups = [                                                          
    (lambda g, w: "Long-step" in g,         
     lambda g, w: (glpk_simplex_warning_regex.sub('', g), w)),
                                  
    (lambda g, w: "dylib" in g,                             
     lambda g, w: (ld_warning_regex.sub('', g), w)),             
                                                                    
    (lambda g, w: "pie being ignored" in g,                              
     lambda g, w: (ld_pie_warning_regex.sub('', g), w))                                          
]    
```

If reviewers agree with me, I will do one more commit improving that.



---

archive/issue_comments_474241.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2022-04-07T15:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474241",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_474242.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-07T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474243.json:
```json
{
    "body": "<a id='comment:13'></a>I just added a commit which is unrelated to the question asked in comment:10.",
    "created_at": "2022-04-07T15:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474243",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:13'></a>I just added a commit which is unrelated to the question asked in comment:10.



---

archive/issue_comments_474244.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-07T16:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474244",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474245.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-04-07T16:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474245",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_474246.json:
```json
{
    "body": "<a id='comment:15'></a>While having my head on this part of the code, I decide to answer my comment:10 by YES and I did the latest commit.\n\nNeeds review!",
    "created_at": "2022-04-07T16:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474246",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:15'></a>While having my head on this part of the code, I decide to answer my comment:10 by YES and I did the latest commit.

Needs review!



---

archive/issue_comments_474247.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-07T16:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_474248.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-07T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474248",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_474249.json:
```json
{
    "body": "<a id='comment:18'></a>Did 2 small changes on the last commit. Now done. Needs review.",
    "created_at": "2022-04-07T16:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474249",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:18'></a>Did 2 small changes on the last commit. Now done. Needs review.



---

archive/issue_comments_474250.json:
```json
{
    "body": "<a id='comment:19'></a>I don't have time to review this right now, but I agree with your decisions regarding comment:10.",
    "created_at": "2022-04-07T17:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474250",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>I don't have time to review this right now, but I agree with your decisions regarding comment:10.



---

archive/issue_comments_474251.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-08T08:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474251",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474252.json:
```json
{
    "body": "<a id='comment:22'></a>I renamed `try_fixup` to `do_fixup` because the following line looks better like this, the same verb is used:\n\n```\ndid_fixup, want, got = self.do_fixup(want, got)\n```",
    "created_at": "2022-04-08T08:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474252",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:22'></a>I renamed `try_fixup` to `do_fixup` because the following line looks better like this, the same verb is used:

```
did_fixup, want, got = self.do_fixup(want, got)
```



---

archive/issue_comments_474253.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-11T07:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474253",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474254.json:
```json
{
    "body": "<a id='comment:25'></a>I added a commit to fix one patchbot warning:\n\n```\n========== blocks ==========\ngit checkout patchbot/ticket_merged\ninside file:  b/src/sage/doctest/parsing.py\n@@ -923,41 +919,111 @@ class SageOutputChecker(doctest.OutputChecker):\n+        OUTPUT\nwrong syntax for blocks (INPUT, OUTPUT, EXAMPLES, NOTE, etc) inserted on 1 non-empty lines\nblocks -- 0 seconds\n========== end blocks ==========\n```",
    "created_at": "2022-04-11T07:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474254",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:25'></a>I added a commit to fix one patchbot warning:

```
========== blocks ==========
git checkout patchbot/ticket_merged
inside file:  b/src/sage/doctest/parsing.py
@@ -923,41 +919,111 @@ class SageOutputChecker(doctest.OutputChecker):
+        OUTPUT
wrong syntax for blocks (INPUT, OUTPUT, EXAMPLES, NOTE, etc) inserted on 1 non-empty lines
blocks -- 0 seconds
========== end blocks ==========
```



---

archive/issue_comments_474255.json:
```json
{
    "body": "<a id='comment:26'></a>Please do not remove `_repr_fixups` and the comments before.\n\nEDIT: Just make that an empty list\n\nSomebody else may need that again at some point.",
    "created_at": "2022-04-11T09:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474255",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:26'></a>Please do not remove `_repr_fixups` and the comments before.

EDIT: Just make that an empty list

Somebody else may need that again at some point.



---

archive/issue_comments_474256.json:
```json
{
    "body": "<a id='comment:27'></a>ah, I see, this is more complicated than what I thought. No time to look at that now.",
    "created_at": "2022-04-11T09:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474256",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:27'></a>ah, I see, this is more complicated than what I thought. No time to look at that now.



---

archive/issue_comments_474257.json:
```json
{
    "body": "<a id='comment:28'></a>It is not so complicated in the end, but it is true that it may look complicated.\n\nLet me update the description of the ticket to better explain the problem and the solution.",
    "created_at": "2022-04-11T10:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474257",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:28'></a>It is not so complicated in the end, but it is true that it may look complicated.

Let me update the description of the ticket to better explain the problem and the solution.



---

archive/issue_comments_474258.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-11T12:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474258",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_474259.json:
```json
{
    "body": "<a id='comment:30'></a>I removed the commit deleting the `_repr_fixups` as it can be done in a later ticket which will simplify the review of the current ticket.",
    "created_at": "2022-04-11T12:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474259",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:30'></a>I removed the commit deleting the `_repr_fixups` as it can be done in a later ticket which will simplify the review of the current ticket.



---

archive/issue_comments_474260.json:
```json
{
    "body": "<a id='comment:31'></a>Updated description.",
    "created_at": "2022-04-11T13:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474260",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:31'></a>Updated description.



---

archive/issue_comments_474261.json:
```json
{
    "body": "<a id='comment:32'></a>Further description improvements.",
    "created_at": "2022-04-11T13:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474261",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:32'></a>Further description improvements.



---

archive/issue_comments_474262.json:
```json
{
    "body": "<a id='comment:33'></a>Needs review.",
    "created_at": "2022-04-11T13:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474262",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:33'></a>Needs review.



---

archive/issue_comments_474263.json:
```json
{
    "body": "<a id='comment:37'></a>Touching the `_repr_fixups` list is now in a follow-up ticket #33680.",
    "created_at": "2022-04-11T13:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474263",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:37'></a>Touching the `_repr_fixups` list is now in a follow-up ticket #33680.



---

archive/issue_comments_474264.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-04-18T10:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474264",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_474265.json:
```json
{
    "body": "<a id='comment:40'></a>one patchbot currently says:\n\n```\n[sagemath_doc_html-none] Error building the documentation.\n[sagemath_doc_html-none] Traceback (most recent call last):\n...\n[sagemath_doc_html-none] OSError: /home/debian/sage/local/var/lib/sage/\nvenv-python3.9/lib/python3.9/site-packages/sage/doctest/parsing.py:\ndocstring of sage.doctest.parsing.SageOutputChecker.check_output:118: \nWARNING: Block quote ends without a blank line; unexpected unindent.\n[sagemath_doc_html-none]\n```",
    "created_at": "2022-04-18T10:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474265",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:40'></a>one patchbot currently says:

```
[sagemath_doc_html-none] Error building the documentation.
[sagemath_doc_html-none] Traceback (most recent call last):
...
[sagemath_doc_html-none] OSError: /home/debian/sage/local/var/lib/sage/
venv-python3.9/lib/python3.9/site-packages/sage/doctest/parsing.py:
docstring of sage.doctest.parsing.SageOutputChecker.check_output:118: 
WARNING: Block quote ends without a blank line; unexpected unindent.
[sagemath_doc_html-none]
```



---

archive/issue_comments_474266.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-18T11:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474266",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_474267.json:
```json
{
    "body": "<a id='comment:42'></a>The documentation failure was due to a docstring defined with `\"\"\"...\"\"\"` as opposed to `r\"\"\"...\"\"\"`. I added a commit to fix that.\n\nNow rebased on 9.6.rc0.\n\nAlso squashed the commit changing name `try_fixup` to `do_fixup` to simplify the review.",
    "created_at": "2022-04-18T11:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474267",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:42'></a>The documentation failure was due to a docstring defined with `"""..."""` as opposed to `r"""..."""`. I added a commit to fix that.

Now rebased on 9.6.rc0.

Also squashed the commit changing name `try_fixup` to `do_fixup` to simplify the review.



---

archive/issue_comments_474268.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-04-18T11:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474268",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_474269.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-20T17:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474269",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474270.json:
```json
{
    "body": "<a id='comment:44'></a>This looks good to me.",
    "created_at": "2022-04-20T17:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474270",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>This looks good to me.



---

archive/issue_comments_474271.json:
```json
{
    "body": "<a id='comment:45'></a>Thank you John!",
    "created_at": "2022-04-20T18:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474271",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:45'></a>Thank you John!



---

archive/issue_comments_474272.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2022-04-21T07:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474272",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_474273.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-24T06:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33588#issuecomment-474273",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088380.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-24T06:31:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33588",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33588#event-88380"
}
```
