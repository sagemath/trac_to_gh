# Issue 33129: src/sage/plot/plot.py: random doctest failure

archive/issues_032892.json:
```json
{
    "body": "\n```\nsage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py\n**********************************************************************\nFile \"src/sage/plot/plot.py\", line 1782, in sage.plot.plot.plot\nFailed example:\n    plot(f, (x, -3.5, 3.5), detect_poles='show', exclude=[-3..3], ymin=-5, ymax=5)\nExpected:\n    Graphics object consisting of 12 graphics primitives\nGot:\n    Graphics object consisting of 13 graphics primitives\n**********************************************************************\n1 item had failures:\n   1 of 154 in sage.plot.plot.plot\n    [461 tests, 1 failure, 60.91 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nLooks similar to #29954.\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/33129\n\n",
    "created_at": "2022-01-07T19:44:44Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "src/sage/plot/plot.py: random doctest failure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33129",
    "user": "https://github.com/tornaria"
}
```

```
sage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py
**********************************************************************
File "src/sage/plot/plot.py", line 1782, in sage.plot.plot.plot
Failed example:
    plot(f, (x, -3.5, 3.5), detect_poles='show', exclude=[-3..3], ymin=-5, ymax=5)
Expected:
    Graphics object consisting of 12 graphics primitives
Got:
    Graphics object consisting of 13 graphics primitives
**********************************************************************
1 item had failures:
   1 of 154 in sage.plot.plot.plot
    [461 tests, 1 failure, 60.91 s]
----------------------------------------------------------------------
sage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py  # 1 doctest failed
----------------------------------------------------------------------
```

Looks similar to #29954.

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/33129





---

archive/issue_comments_660852.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe problem seems to be that the plot routine occasionally decides there is a pole at `x = 0`, so it fills the gap in the graph with a vertical dashed gray line. This is hard to see because the extra line is on top of the y-axis.  To see the effect more easily, you can run the following code:\n\n```\nwhile True:\n    f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)\n    P = plot(f(x - 1), (x, -2.5, 4.5), detect_poles='show',\n                exclude=[-2..4], ymin=-5, ymax=5)\n    if \"13\" in str(P):\n        bad_plot = P\n        break\nshow(bad_plot)\n```\nIf your experience is the same as mine, the graph will include a vertical dashed line from `(1, -2/3)` to `(1, 2/3)`.  (I didn't do any statistics, but the bad plot seems to happen once every few hundred tries.)\n\nSo this doesn't seem to be the same problem as #29954. Instead, it seems we need to make `detect_poles` smarter.",
    "created_at": "2022-01-08T04:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33129#issuecomment-660852",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>
The problem seems to be that the plot routine occasionally decides there is a pole at `x = 0`, so it fills the gap in the graph with a vertical dashed gray line. This is hard to see because the extra line is on top of the y-axis.  To see the effect more easily, you can run the following code:

```
while True:
    f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)
    P = plot(f(x - 1), (x, -2.5, 4.5), detect_poles='show',
                exclude=[-2..4], ymin=-5, ymax=5)
    if "13" in str(P):
        bad_plot = P
        break
show(bad_plot)
```
If your experience is the same as mine, the graph will include a vertical dashed line from `(1, -2/3)` to `(1, 2/3)`.  (I didn't do any statistics, but the bad plot seems to happen once every few hundred tries.)

So this doesn't seem to be the same problem as #29954. Instead, it seems we need to make `detect_poles` smarter.



---

archive/issue_events_098470.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-01-29T08:58:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33129#event-98470"
}
```



---

archive/issue_comments_660853.json:
```json
{
    "body": "<a id='comment:2'></a>\nbump to 9.6",
    "created_at": "2022-01-29T08:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33129#issuecomment-660853",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
bump to 9.6



---

archive/issue_comments_660854.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [gh-DaveWitteMorris](#comment%3A1):\n> Instead, it seems we need to make `detect_poles` smarter.\n\n\nI agree. The routine for detecting poles computes the slope between consecutive plot points. In this example, the slope at the discontinuity is just very close to the threshold value, so sometimes a pole is detected there (I am a bit surprised this is not deterministic).\n\nA simple attempt would be to increase the threshold a bit. Also, the detection determines the slope only in absolute terms, not relatively \u2013 probably it would be good to consider the y-range as well. For example, scaling your example by 10 always replicates the problem:\n\n```\nsage: f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)\nsage: plot(10*f(x - 1), (x, -2.5, 4.5), detect_poles='show', exclude=[-2..4], ymin=-50, ymax=50)\nLaunched png viewer for Graphics object consisting of 13 graphics primitives\n```",
    "created_at": "2022-02-03T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33129#issuecomment-660854",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:3'></a>
Replying to [gh-DaveWitteMorris](#comment%3A1):
> Instead, it seems we need to make `detect_poles` smarter.


I agree. The routine for detecting poles computes the slope between consecutive plot points. In this example, the slope at the discontinuity is just very close to the threshold value, so sometimes a pole is detected there (I am a bit surprised this is not deterministic).

A simple attempt would be to increase the threshold a bit. Also, the detection determines the slope only in absolute terms, not relatively â€“ probably it would be good to consider the y-range as well. For example, scaling your example by 10 always replicates the problem:

```
sage: f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)
sage: plot(10*f(x - 1), (x, -2.5, 4.5), detect_poles='show', exclude=[-2..4], ymin=-50, ymax=50)
Launched png viewer for Graphics object consisting of 13 graphics primitives
```



---

archive/issue_events_098471.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33129#event-98471"
}
```



---

archive/issue_events_098472.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33129#event-98472"
}
```



---

archive/issue_events_098473.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33129#event-98473"
}
```



---

archive/issue_events_098474.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33129",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33129#event-98474"
}
```
