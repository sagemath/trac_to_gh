# Issue 33129: src/sage/plot/plot.py: random doctest failure

archive/issues_032892.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py\n**********************************************************************\nFile \"src/sage/plot/plot.py\", line 1782, in sage.plot.plot.plot\nFailed example:\n    plot(f, (x, -3.5, 3.5), detect_poles='show', exclude=[-3..3], ymin=-5, ymax=5)\nExpected:\n    Graphics object consisting of 12 graphics primitives\nGot:\n    Graphics object consisting of 13 graphics primitives\n**********************************************************************\n1 item had failures:\n   1 of 154 in sage.plot.plot.plot\n    [461 tests, 1 failure, 60.91 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nLooks similar to #29954.\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33129_\n\n",
    "created_at": "2022-01-07T19:44:44Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "src/sage/plot/plot.py: random doctest failure",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/33129",
    "user": "https://github.com/tornaria"
}
```

```
sage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py
**********************************************************************
File "src/sage/plot/plot.py", line 1782, in sage.plot.plot.plot
Failed example:
    plot(f, (x, -3.5, 3.5), detect_poles='show', exclude=[-3..3], ymin=-5, ymax=5)
Expected:
    Graphics object consisting of 12 graphics primitives
Got:
    Graphics object consisting of 13 graphics primitives
**********************************************************************
1 item had failures:
   1 of 154 in sage.plot.plot.plot
    [461 tests, 1 failure, 60.91 s]
----------------------------------------------------------------------
sage -t --long --random-seed=314121851792717929490963296099377352180 src/sage/plot/plot.py  # 1 doctest failed
----------------------------------------------------------------------
```

Looks similar to #29954.

_Issue created by migration from https://trac.sagemath.org/ticket/33129_





---

archive/issue_events_437544.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T19:44:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437544"
}
```



---

archive/issue_events_437545.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T19:44:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437545"
}
```



---

archive/issue_events_437546.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T19:44:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437546"
}
```



---

archive/issue_events_437547.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T19:44:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437547"
}
```



---

archive/issue_comments_538347.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nThe problem seems to be that the plot routine occasionally decides there is a pole at `x = 0`, so it fills the gap in the graph with a vertical dashed gray line. This is hard to see because the extra line is on top of the y-axis.  To see the effect more easily, you can run the following code:\n\n```\nwhile True:\n    f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)\n    P = plot(f(x - 1), (x, -2.5, 4.5), detect_poles='show',\n                exclude=[-2..4], ymin=-5, ymax=5)\n    if \"13\" in str(P):\n        bad_plot = P\n        break\nshow(bad_plot)\n```\nIf your experience is the same as mine, the graph will include a vertical dashed line from `(1, -2/3)` to `(1, 2/3)`.  (I didn't do any statistics, but the bad plot seems to happen once every few hundred tries.)\n\nSo this doesn't seem to be the same problem as #29954. Instead, it seems we need to make `detect_poles` smarter.",
    "created_at": "2022-01-08T04:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33129#issuecomment-538347",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'>Comment 1:</a>
The problem seems to be that the plot routine occasionally decides there is a pole at `x = 0`, so it fills the gap in the graph with a vertical dashed gray line. This is hard to see because the extra line is on top of the y-axis.  To see the effect more easily, you can run the following code:

```
while True:
    f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)
    P = plot(f(x - 1), (x, -2.5, 4.5), detect_poles='show',
                exclude=[-2..4], ymin=-5, ymax=5)
    if "13" in str(P):
        bad_plot = P
        break
show(bad_plot)
```
If your experience is the same as mine, the graph will include a vertical dashed line from `(1, -2/3)` to `(1, 2/3)`.  (I didn't do any statistics, but the bad plot seems to happen once every few hundred tries.)

So this doesn't seem to be the same problem as #29954. Instead, it seems we need to make `detect_poles` smarter.



---

archive/issue_events_437548.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-01-29T08:58:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437548"
}
```



---

archive/issue_events_437549.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-01-29T08:58:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437549"
}
```



---

archive/issue_comments_538348.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nbump to 9.6",
    "created_at": "2022-01-29T08:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33129#issuecomment-538348",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'>Comment 2:</a>
bump to 9.6



---

archive/issue_comments_538349.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [@DaveWitteMorris](#comment%3A1):\n> Instead, it seems we need to make `detect_poles` smarter.\n\nI agree. The routine for detecting poles computes the slope between consecutive plot points. In this example, the slope at the discontinuity is just very close to the threshold value, so sometimes a pole is detected there (I am a bit surprised this is not deterministic).\n\nA simple attempt would be to increase the threshold a bit. Also, the detection determines the slope only in absolute terms, not relatively \u2013 probably it would be good to consider the y-range as well. For example, scaling your example by 10 always replicates the problem:\n\n```\nsage: f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)\nsage: plot(10*f(x - 1), (x, -2.5, 4.5), detect_poles='show', exclude=[-2..4], ymin=-50, ymax=50)\nLaunched png viewer for Graphics object consisting of 13 graphics primitives\n```",
    "created_at": "2022-02-03T21:36:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33129#issuecomment-538349",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [@DaveWitteMorris](#comment%3A1):
> Instead, it seems we need to make `detect_poles` smarter.

I agree. The routine for detecting poles computes the slope between consecutive plot points. In this example, the slope at the discontinuity is just very close to the threshold value, so sometimes a pole is detected there (I am a bit surprised this is not deterministic).

A simple attempt would be to increase the threshold a bit. Also, the detection determines the slope only in absolute terms, not relatively â€“ probably it would be good to consider the y-range as well. For example, scaling your example by 10 always replicates the problem:

```
sage: f(x) = (floor(x)+0.5) / (1-(x-0.5)^2)
sage: plot(10*f(x - 1), (x, -2.5, 4.5), detect_poles='show', exclude=[-2..4], ymin=-50, ymax=50)
Launched png viewer for Graphics object consisting of 13 graphics primitives
```



---

archive/issue_events_437550.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437550"
}
```



---

archive/issue_events_437551.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437551"
}
```



---

archive/issue_events_437552.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437552"
}
```



---

archive/issue_events_437553.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33129",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33129#event-437553"
}
```
