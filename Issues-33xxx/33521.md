# Issue 33521: doctesting with pytest fails on system install of sage

archive/issues_033284.json:
```json
{
    "body": "pytest assumes the directory containing the code to be tested is writable. This is not currently the case on sage-on-distro were most of the time testing is done after installing on the system.\n\nHere is a typical result\n\n```\n============================= test session starts ==============================\nplatform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\nrootdir: /usr\nplugins: hypothesis-6.38.0\ncollected 0 items\n\n=============================== warnings summary ===============================\n../../usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433\n  /usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/nodeids\n    config.cache.set(\"cache/nodeids\", sorted(self.cached_nodeids))\n\n../../usr/lib/python3.10/site-packages/_pytest/stepwise.py:52\n  /usr/lib/python3.10/site-packages/_pytest/stepwise.py:52: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/stepwise\n    session.config.cache.set(STEPWISE_CACHE_DIR, [])\n\n-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n```\npytest can be started with some option to change the location of the cache directory `-o cache_dir=...`. pytest is currently called from `sage-runtest` and this is where we may want to apply any changes.\n\nCC:  @tobiasdiez @orlitzky @dimpase\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Matthias Koeppe\n\nBranch: 84d3d9e5ca7b6d15355743f94c6c917359136998\n\nCommit: 84d3d9e5ca7b6d15355743f94c6c917359136998\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33521\n\n",
    "closed_at": "2022-04-21T21:07:25Z",
    "created_at": "2022-03-17T19:45:10Z",
    "labels": [
        "component: distribution",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "doctesting with pytest fails on system install of sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33521",
    "user": "https://github.com/kiwifb"
}
```
pytest assumes the directory containing the code to be tested is writable. This is not currently the case on sage-on-distro were most of the time testing is done after installing on the system.

Here is a typical result

```
============================= test session starts ==============================
platform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /usr
plugins: hypothesis-6.38.0
collected 0 items

=============================== warnings summary ===============================
../../usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433
  /usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/nodeids
    config.cache.set("cache/nodeids", sorted(self.cached_nodeids))

../../usr/lib/python3.10/site-packages/_pytest/stepwise.py:52
  /usr/lib/python3.10/site-packages/_pytest/stepwise.py:52: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/stepwise
    session.config.cache.set(STEPWISE_CACHE_DIR, [])

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
```
pytest can be started with some option to change the location of the cache directory `-o cache_dir=...`. pytest is currently called from `sage-runtest` and this is where we may want to apply any changes.

CC:  @tobiasdiez @orlitzky @dimpase

Reviewer: Fran√ßois Bissey

Author: Matthias Koeppe

Branch: 84d3d9e5ca7b6d15355743f94c6c917359136998

Commit: 84d3d9e5ca7b6d15355743f94c6c917359136998

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33521





---

archive/issue_comments_473259.json:
```json
{
    "body": "<a id='comment:1'></a>I have tried inserting the right option in `sage-runtest` with variation of \n\n```\n    try:\n        exit_code_pytest = 0\n        import pytest\n        pytest_options = [\"-o cache_dir=/tmp\", \"--import-mode\", \"importlib\"]\n        if args.verbose:\n            pytest_options.append(\"-v\")\n        exit_code_pytest = pytest.main(pytest_options + args.filenames)\n        if exit_code_pytest == 5:\n            # Exit code 5 means there were no test files, pass in this case\n            exit_code_pytest = 0\n```\nwithout success. Suggestions welcome.",
    "created_at": "2022-03-17T19:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473259",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>I have tried inserting the right option in `sage-runtest` with variation of 

```
    try:
        exit_code_pytest = 0
        import pytest
        pytest_options = ["-o cache_dir=/tmp", "--import-mode", "importlib"]
        if args.verbose:
            pytest_options.append("-v")
        exit_code_pytest = pytest.main(pytest_options + args.filenames)
        if exit_code_pytest == 5:
            # Exit code 5 means there were no test files, pass in this case
            exit_code_pytest = 0
```
without success. Suggestions welcome.



---

archive/issue_comments_473260.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-03-19T17:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473260",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_473261.json:
```json
{
    "body": "<a id='comment:4'></a>I think if we include #33531 it can join the list of less urgent stuff to fix about `pytest`.",
    "created_at": "2022-03-19T20:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473261",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>I think if we include #33531 it can join the list of less urgent stuff to fix about `pytest`.



---

archive/issue_comments_473262.json:
```json
{
    "body": "<a id='comment:5'></a>I just realised it may make more sense to just disable `pytest` for `sage -t --installed`. Running `pytest` relies on the presence of `src/conftest.py` which is not installed (not sure it would make sense to install it). So, a system install of sage would run `pytest` without fixtures and ignore list - unless you manually point to a copy.",
    "created_at": "2022-03-22T21:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473262",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>I just realised it may make more sense to just disable `pytest` for `sage -t --installed`. Running `pytest` relies on the presence of `src/conftest.py` which is not installed (not sure it would make sense to install it). So, a system install of sage would run `pytest` without fixtures and ignore list - unless you manually point to a copy.



---

archive/issue_comments_473263.json:
```json
{
    "body": "<a id='comment:6'></a>I'm not sure about the exact use case of `--installed` but if you completely disable pytest in this situation then users no longer run the existing pytests (like the ones for the symplectic form).",
    "created_at": "2022-03-22T22:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473263",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:6'></a>I'm not sure about the exact use case of `--installed` but if you completely disable pytest in this situation then users no longer run the existing pytests (like the ones for the symplectic form).



---

archive/issue_comments_473264.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:1 fbissey]:\n> I have tried inserting the right option in `sage-runtest` with variation of \n> \n> ```\n>     try:\n>         exit_code_pytest = 0\n>         import pytest\n>         pytest_options = [\"-o cache_dir=/tmp\", \"--import-mode\", \"importlib\"]\n>         if args.verbose:\n>             pytest_options.append(\"-v\")\n>         exit_code_pytest = pytest.main(pytest_options + args.filenames)\n>         if exit_code_pytest == 5:\n>             # Exit code 5 means there were no test files, pass in this case\n>             exit_code_pytest = 0\n> ```\n> without success. Suggestions welcome.\n\n\n\nCan you please try running pytest with `--rootdir SAGE_SRC` and/or `-c SAGE_SRC/tox.ini`.",
    "created_at": "2022-03-22T22:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473264",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>Replying to [comment:1 fbissey]:
> I have tried inserting the right option in `sage-runtest` with variation of 
> 
> ```
>     try:
>         exit_code_pytest = 0
>         import pytest
>         pytest_options = ["-o cache_dir=/tmp", "--import-mode", "importlib"]
>         if args.verbose:
>             pytest_options.append("-v")
>         exit_code_pytest = pytest.main(pytest_options + args.filenames)
>         if exit_code_pytest == 5:
>             # Exit code 5 means there were no test files, pass in this case
>             exit_code_pytest = 0
> ```
> without success. Suggestions welcome.



Can you please try running pytest with `--rootdir SAGE_SRC` and/or `-c SAGE_SRC/tox.ini`.



---

archive/issue_comments_473265.json:
```json
{
    "body": "<a id='comment:8'></a>`--installed` is for running against a sage install as opposed to running on the source. pytest default on running on source. As for your latest suggestion, in the normal use case for this ticket, `SAGE_SRC` is usually pointing to `SAGE_LIB` and `tox.ini` may not be available.",
    "created_at": "2022-03-22T22:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473265",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>`--installed` is for running against a sage install as opposed to running on the source. pytest default on running on source. As for your latest suggestion, in the normal use case for this ticket, `SAGE_SRC` is usually pointing to `SAGE_LIB` and `tox.ini` may not be available.



---

archive/issue_comments_473266.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:5 fbissey]:\n> I just realised it may make more sense to just disable `pytest` for `sage -t --installed`. Running `pytest` relies on the presence of `src/conftest.py` which is not installed (not sure it would make sense to install it). So, a system install of sage would run `pytest` without fixtures and ignore list - unless you manually point to a copy.\n\n\nYes, I agree",
    "created_at": "2022-03-22T22:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473266",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:5 fbissey]:
> I just realised it may make more sense to just disable `pytest` for `sage -t --installed`. Running `pytest` relies on the presence of `src/conftest.py` which is not installed (not sure it would make sense to install it). So, a system install of sage would run `pytest` without fixtures and ignore list - unless you manually point to a copy.


Yes, I agree



---

archive/issue_comments_473267.json:
```json
{
    "body": "<a id='comment:10'></a>Setting #31924 as a dependency because it modifies `src/bin/sage-runtests` in the same place that needs modifying here.",
    "created_at": "2022-03-23T00:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473267",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Setting #31924 as a dependency because it modifies `src/bin/sage-runtests` in the same place that needs modifying here.



---

archive/issue_comments_473268.json:
```json
{
    "body": "<a id='comment:11'></a>Need to get on with that ticket. Not sure how long it will take me to get to it, I am trying to diagnose flaky RAM on my main dev machine. Compilations breaking in random places is a good signal of issue.",
    "created_at": "2022-03-23T01:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473268",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>Need to get on with that ticket. Not sure how long it will take me to get to it, I am trying to diagnose flaky RAM on my main dev machine. Compilations breaking in random places is a good signal of issue.



---

archive/issue_comments_473269.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:8 fbissey]:\n> `--installed` is for running against a sage install as opposed to running on the source. pytest default on running on source. As for your latest suggestion, in the normal use case for this ticket, `SAGE_SRC` is usually pointing to `SAGE_LIB` and `tox.ini` may not be available.\n\n\nThanks for the explanation. Pytest is able to test everything that can be imported using importlib, so testing the existing sage install should be possible as well. However, the \"normal\" setup would be to run pytest on the source code of the tests but use the installed version of the package (this is for example how pytest works in the context of tox environments).\n\nMaybe its worth a try to distribute/install the tox.ini file as well, or export the pytest config to `pytest.ini` or `pyproject.toml` and distribute that?\n\n\nI cannot judge if it would be okay to skip pytest for `--installed`. That probably depends on the context when `--installed` is used. You definitely skip the existing pytests in that case. (Admittedly, this is not a huge lost atm).",
    "created_at": "2022-03-24T16:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473269",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:12'></a>Replying to [comment:8 fbissey]:
> `--installed` is for running against a sage install as opposed to running on the source. pytest default on running on source. As for your latest suggestion, in the normal use case for this ticket, `SAGE_SRC` is usually pointing to `SAGE_LIB` and `tox.ini` may not be available.


Thanks for the explanation. Pytest is able to test everything that can be imported using importlib, so testing the existing sage install should be possible as well. However, the "normal" setup would be to run pytest on the source code of the tests but use the installed version of the package (this is for example how pytest works in the context of tox environments).

Maybe its worth a try to distribute/install the tox.ini file as well, or export the pytest config to `pytest.ini` or `pyproject.toml` and distribute that?


I cannot judge if it would be okay to skip pytest for `--installed`. That probably depends on the context when `--installed` is used. You definitely skip the existing pytests in that case. (Admittedly, this is not a huge lost atm).



---

archive/issue_comments_473270.json:
```json
{
    "body": "<a id='comment:13'></a>There are two major use cases for `--installed`: In downstream distributions and for testing modularized distribution packages. For the latter, an example is #32601. In this context, there is no problem with providing the pytest configuration, as the source is available.",
    "created_at": "2022-03-24T16:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>There are two major use cases for `--installed`: In downstream distributions and for testing modularized distribution packages. For the latter, an example is #32601. In this context, there is no problem with providing the pytest configuration, as the source is available.



---

archive/issue_comments_473271.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-25T18:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473271",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_473272.json:
```json
{
    "body": "<a id='comment:16'></a>Here's an attempt at a solution following comment:5\n\n---\nNew commits:",
    "created_at": "2022-03-25T18:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473272",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Here's an attempt at a solution following comment:5

---
New commits:



---

archive/issue_comments_473273.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-04-12T02:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473273",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_473274.json:
```json
{
    "body": "<a id='comment:19'></a>I have been busy the last couple of weeks and completely forgotten about this ticket. I will try to do a proper review later today.",
    "created_at": "2022-04-12T20:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473274",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>I have been busy the last couple of weeks and completely forgotten about this ticket. I will try to do a proper review later today.



---

archive/issue_comments_473275.json:
```json
{
    "body": "<a id='comment:20'></a>It works as expected for me in sage-on-gentoo. pytest are not run on system install lacking the right configuration files anymore.",
    "created_at": "2022-04-12T23:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473275",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:20'></a>It works as expected for me in sage-on-gentoo. pytest are not run on system install lacking the right configuration files anymore.



---

archive/issue_comments_473276.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-12T23:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473276",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473277.json:
```json
{
    "body": "<a id='comment:21'></a>Thank you!",
    "created_at": "2022-04-13T01:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473277",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Thank you!



---

archive/issue_comments_473278.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2022-04-19T21:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473278",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_473279.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-21T21:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33521#issuecomment-473279",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088266.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-21T21:07:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33521",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33521#event-88266"
}
```
