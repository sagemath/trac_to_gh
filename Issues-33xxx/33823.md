# Issue 33823: sage -t --optional='sage,!FEATURE'

archive/issues_033586.json:
```json
{
    "assignees": [],
    "body": "`sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.\n\nUseful for checking sequences of `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):\n\n```\n./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  \n```\n\n\nAlso, `sage -t --optional='sage,optional,!FEATURE'` will remove it from the list of optional features supplied by the package list and disable auto-detection. \n\nFor example, when the optional SPKG `bliss` is installed, `--optional='sage,optional'` would expand to a list including `bliss`. By using `--optional='sage,optional,!bliss'`, it can be removed.\n\n\n\nCC:  @kwankyu @orlitzky @kiwifb @seblabbe\n\nBranch: **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**\n\nReviewer: **Sebastian Oehms**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **refactoring**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33823_\n\n",
    "closed_at": "2022-06-12T23:08:44Z",
    "created_at": "2022-05-08T23:39:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/refactoring",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage -t --optional='sage,!FEATURE'",
    "type": "issue",
    "updated_at": "2022-07-15T07:10:05Z",
    "url": "https://github.com/sagemath/sage/issues/33823",
    "user": "https://github.com/mkoeppe"
}
```
`sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.

Useful for checking sequences of `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):

```
./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  
```


Also, `sage -t --optional='sage,optional,!FEATURE'` will remove it from the list of optional features supplied by the package list and disable auto-detection. 

For example, when the optional SPKG `bliss` is installed, `--optional='sage,optional'` would expand to a list including `bliss`. By using `--optional='sage,optional,!bliss'`, it can be removed.



CC:  @kwankyu @orlitzky @kiwifb @seblabbe

Branch: **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**

Reviewer: **Sebastian Oehms**

Author: **Matthias Koeppe**

Component: **refactoring**

_Issue created by migration from https://trac.sagemath.org/ticket/33823_





---

archive/issue_events_463951.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-08T23:39:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463951"
}
```



---

archive/issue_events_463952.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-08T23:39:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/refactoring",
    "label_color": "696969",
    "label_name": "refactoring",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463952"
}
```



---

archive/issue_events_463953.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-08T23:39:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463953"
}
```



---

archive/issue_events_463954.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-08T23:39:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463954"
}
```



---

archive/issue_events_463955.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T00:12:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "title_is": "sage -t --optional='sage,!FEATURE'",
    "title_was": "sage -t --optional=sage,!FEATURE",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463955"
}
```



---

archive/issue_comments_546965.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n This will disable autodetection of `FEATURE`.\n \n-Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029).\n+Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):\n \n+```\n+./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  \n+```\n+\n``````\n",
    "created_at": "2022-05-09T00:20:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546965",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,8 @@
 This will disable autodetection of `FEATURE`.
 
-Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029).
+Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):
 
+```
+./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  
+```
+
``````




---

archive/issue_comments_546966.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2022-05-09T00:20:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546966",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_546967.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage__t___optional__sage__feature_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t___optional__sage__feature_)**",
    "created_at": "2022-05-09T00:21:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546967",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage__t___optional__sage__feature_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t___optional__sage__feature_)**



---

archive/issue_events_463956.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T00:22:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463956"
}
```



---

archive/issue_comments_546968.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563\">8000320</a></td><td><code>sage -t: Handle --optional=!FEATURE</code></td></tr></table>\n",
    "created_at": "2022-05-09T00:22:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546968",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563">8000320</a></td><td><code>sage -t: Handle --optional=!FEATURE</code></td></tr></table>




---

archive/issue_comments_546969.json:
```json
{
    "body": "Commit: **[`8000320`](https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563)**",
    "created_at": "2022-05-09T00:22:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546969",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`8000320`](https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563)**



---

archive/issue_comments_546970.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This will disable autodetection of `FEATURE`.\n+`sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.\n \n Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):\n \n@@ -6,3 +6,9 @@\n ./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  \n ```\n \n+\n+Also, `sage -t --optional='sage,optional,!FEATURE'` will remove it from the list of optional features supplied by the package list and disable auto-detection. \n+\n+For example, when the optional SPKG `bliss` is installed, `--optional='sage,optional'` would expand to a list including `bliss`. By using `--optional='sage,optional,!bliss'`, it can be removed.\n+\n+\n``````\n",
    "created_at": "2022-05-09T00:30:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546970",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This will disable autodetection of `FEATURE`.
+`sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.
 
 Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):
 
@@ -6,3 +6,9 @@
 ./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  
 ```
 
+
+Also, `sage -t --optional='sage,optional,!FEATURE'` will remove it from the list of optional features supplied by the package list and disable auto-detection. 
+
+For example, when the optional SPKG `bliss` is installed, `--optional='sage,optional'` would expand to a list including `bliss`. By using `--optional='sage,optional,!bliss'`, it can be removed.
+
+
``````




---

archive/issue_comments_546971.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403\">d0a52ed</a></td><td><code>src/bin/sage-runtests: Update documentation of --optional</code></td></tr></table>\n",
    "created_at": "2022-05-09T00:38:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546971",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403">d0a52ed</a></td><td><code>src/bin/sage-runtests: Update documentation of --optional</code></td></tr></table>




---

archive/issue_comments_546972.json:
```json
{
    "body": "Changed commit from **[`8000320`](https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563)** to **[`d0a52ed`](https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403)**",
    "created_at": "2022-05-09T00:38:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546972",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8000320`](https://github.com/sagemath/sagetrac-mirror/commit/800032050b15c7b743635b7c08892375f7f5c563)** to **[`d0a52ed`](https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403)**



---

archive/issue_comments_546973.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHow about respecting `--disable-bliss` instead?",
    "created_at": "2022-05-09T19:16:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546973",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:8" align="right">comment:8</div>

How about respecting `--disable-bliss` instead?



---

archive/issue_comments_546974.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nWe don't have a mechanism for that, and it does not help for the main use case of this ticket - disabling standard features such as `sage.misc.cython` when doctesting.",
    "created_at": "2022-05-09T20:15:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546974",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

We don't have a mechanism for that, and it does not help for the main use case of this ticket - disabling standard features such as `sage.misc.cython` when doctesting.



---

archive/issue_comments_546975.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nYes, you are giving yourself some tools to be able to isolate what you are testing more. Which is interesting in and of itself. But if we completely migrate to pytest (let's be honest that will/would take years), will that feature survive the migration? Does pytest support such disabling?",
    "created_at": "2022-05-09T20:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546975",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:10" align="right">comment:10</div>

Yes, you are giving yourself some tools to be able to isolate what you are testing more. Which is interesting in and of itself. But if we completely migrate to pytest (let's be honest that will/would take years), will that feature survive the migration? Does pytest support such disabling?



---

archive/issue_comments_546976.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@mkoeppe](#comment:9):\n> We don't have a mechanism for that\n\nIt worked for years until you added runtime detection that overrides it. Now you want to add a third layer of complexity without fixing the previous two.\n\nI posted one possible solution recently on the mailing list and another ticket. Another (inevitable, eventually) option is to add a `./configure` script to whatever modularized component of sage requires bliss, and to copy `AC_ARG_ENABLE([bliss])` there. Then the \"feature\" that detects it from the other components becomes simply e.g. `import sage.whatever.BLISS`. There is already precedent for having setup.py run `sh ./configure` to keep that component pip-installable.",
    "created_at": "2022-05-09T20:45:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546976",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@mkoeppe](#comment:9):
> We don't have a mechanism for that

It worked for years until you added runtime detection that overrides it. Now you want to add a third layer of complexity without fixing the previous two.

I posted one possible solution recently on the mailing list and another ticket. Another (inevitable, eventually) option is to add a `./configure` script to whatever modularized component of sage requires bliss, and to copy `AC_ARG_ENABLE([bliss])` there. Then the "feature" that detects it from the other components becomes simply e.g. `import sage.whatever.BLISS`. There is already precedent for having setup.py run `sh ./configure` to keep that component pip-installable.



---

archive/issue_comments_546977.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@orlitzky](#comment:11):\n> Replying to [@mkoeppe](#comment:9):\n> > We don't have a mechanism for that\n\n> \n> It worked for years until you added runtime detection that overrides it.\n\nSage has never had a mechanism to disable the use of optional features by the Sage library. \n\nThe only thing that has changed is what the doctester tests. The present ticket gives you the tool that you need if you have problems with an optional package in your distribution packaging.",
    "created_at": "2022-05-09T20:54:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546977",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@orlitzky](#comment:11):
> Replying to [@mkoeppe](#comment:9):
> > We don't have a mechanism for that

> 
> It worked for years until you added runtime detection that overrides it.

Sage has never had a mechanism to disable the use of optional features by the Sage library. 

The only thing that has changed is what the doctester tests. The present ticket gives you the tool that you need if you have problems with an optional package in your distribution packaging.



---

archive/issue_comments_546978.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nLet's keep the ticket focused. It is not meant as an invitation to continue your musings from sage-devel",
    "created_at": "2022-05-09T20:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546978",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Let's keep the ticket focused. It is not meant as an invitation to continue your musings from sage-devel



---

archive/issue_comments_546979.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@kiwifb](#comment:10):\n> Yes, you are giving yourself some tools to be able to isolate what you are testing more. Which is interesting in and of itself. But if we completely migrate to pytest (let's be honest that will/would take years), will that feature survive the migration? Does pytest support such disabling?\n\nConditionalizing tests on the presence of features is a key idea of the modularization, and we'll make it work with pytest too. Skipping tests based on predicates is a standard feature of all test frameworks. \n\n#33546 implements the Sage doctest discovery in pytest. It continues to use code from `sage.doctest`, so I see no issue in making `# optional` annotations work, but I don't know the details.",
    "created_at": "2022-05-09T21:10:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546979",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@kiwifb](#comment:10):
> Yes, you are giving yourself some tools to be able to isolate what you are testing more. Which is interesting in and of itself. But if we completely migrate to pytest (let's be honest that will/would take years), will that feature survive the migration? Does pytest support such disabling?

Conditionalizing tests on the presence of features is a key idea of the modularization, and we'll make it work with pytest too. Skipping tests based on predicates is a standard feature of all test frameworks. 

#33546 implements the Sage doctest discovery in pytest. It continues to use code from `sage.doctest`, so I see no issue in making `# optional` annotations work, but I don't know the details.



---

archive/issue_comments_546980.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n `sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.\n \n-Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):\n+Useful for checking sequences of `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):\n \n ```\n ./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  \n``````\n",
    "created_at": "2022-05-09T21:40:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546980",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 `sage -t --optional='sage,!FEATURE'` will disable autodetection of `FEATURE`.
 
-Useful for checking `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):
+Useful for checking sequences of `# optional - FEATURE` annotations in particular when `FEATURE` is standard in Sage, for example `sage.misc.cython` (#33029):
 
 ```
 ./sage -t --optional='sage,!sage.misc.cython' src/sage/misc/inherit_comparison.pyx  
``````




---

archive/issue_comments_546981.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI think it's a good idea to have a negation possibility here. Maybe the following needs a clarification in the help-string:\n\nIn a positive list of features you don't need to type `'` and maybe a lot of people use it in this way. But if you want to exclude a feature using this new functionality you must type them or use `\\!` instead of `!`. \n\n\nBTW: If you have installed some optional feature `xyz` on your system and forgot a `# optional - xyz` or `xyz.is_present()` somewhere in your change of code then this new doctest option will not bring this to your attention. That was what I hoped when I've first seen this ticket. Do you know, how this can be achieved without uninstalling the package?\n\n\nFurther: I really don't know the intention of the log-message `Features detected for doctesting`. My observation is that this messages shows nothing even though optional tests were performed. At least this is irritating. Example:\n\n\n```\nUsing --optional=!database_knotinfo,sage\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --random-seed=71318033978106427613212696911118388467 src/sage/knots/knotinfo.py\n    [323 tests, 5.51 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 5.6 seconds\n    cpu time: 5.5 seconds\n    cumulative wall time: 5.5 seconds\nFeatures detected for doctesting:\n```\n\nTogether with 30 optional doctests, the log-message shows the same result:\n\n```\nUsing --optional=database_knotinfo,sage\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --random-seed=32074844050499063835156990883996507444 src/sage/knots/knotinfo.py\n    [353 tests, 7.94 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 8.1 seconds\n    cpu time: 7.9 seconds\n    cumulative wall time: 7.9 seconds\nFeatures detected for doctesting:\n```\n\nThis seems to be due to:\n\n```sage\nsage: from sage.doctest.external import AvailableSoftware\nsage: S = AvailableSoftware()\nsage: S._indices['database_knotinfo']\n10\nsage: S._seen[10]\n0\n```\n\nBut this can be changed by performing a `__contains__` test:\n\n```sage\nsage: 'database_knotinfo' in S\nTrue\nsage: S._seen[10]\n1\n```\n\nSo it looks as if such a test is missing somewhere.",
    "created_at": "2022-06-01T16:58:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546981",
    "user": "https://github.com/soehms"
}
```

<div id="comment:17" align="right">comment:17</div>

I think it's a good idea to have a negation possibility here. Maybe the following needs a clarification in the help-string:

In a positive list of features you don't need to type `'` and maybe a lot of people use it in this way. But if you want to exclude a feature using this new functionality you must type them or use `\!` instead of `!`. 


BTW: If you have installed some optional feature `xyz` on your system and forgot a `# optional - xyz` or `xyz.is_present()` somewhere in your change of code then this new doctest option will not bring this to your attention. That was what I hoped when I've first seen this ticket. Do you know, how this can be achieved without uninstalling the package?


Further: I really don't know the intention of the log-message `Features detected for doctesting`. My observation is that this messages shows nothing even though optional tests were performed. At least this is irritating. Example:


```
Using --optional=!database_knotinfo,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --random-seed=71318033978106427613212696911118388467 src/sage/knots/knotinfo.py
    [323 tests, 5.51 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 5.6 seconds
    cpu time: 5.5 seconds
    cumulative wall time: 5.5 seconds
Features detected for doctesting:
```

Together with 30 optional doctests, the log-message shows the same result:

```
Using --optional=database_knotinfo,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --random-seed=32074844050499063835156990883996507444 src/sage/knots/knotinfo.py
    [353 tests, 7.94 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 8.1 seconds
    cpu time: 7.9 seconds
    cumulative wall time: 7.9 seconds
Features detected for doctesting:
```

This seems to be due to:

```sage
sage: from sage.doctest.external import AvailableSoftware
sage: S = AvailableSoftware()
sage: S._indices['database_knotinfo']
10
sage: S._seen[10]
0
```

But this can be changed by performing a `__contains__` test:

```sage
sage: 'database_knotinfo' in S
True
sage: S._seen[10]
1
```

So it looks as if such a test is missing somewhere.



---

archive/issue_comments_546982.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b1ce8d6cb361701b388e3c2c3be7e1c831ee85ff\">b1ce8d6</a></td><td><code>sage -t: Handle --optional=!FEATURE</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a670ae8ac34dff7c29f84744463a1c4aeb6892d4\">a670ae8</a></td><td><code>src/bin/sage-runtests: Update documentation of --optional</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93\">ba86146</a></td><td><code>src/bin/sage-runtests --help: Say that ! needs to be quoted</code></td></tr></table>\n",
    "created_at": "2022-06-05T18:23:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546982",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b1ce8d6cb361701b388e3c2c3be7e1c831ee85ff">b1ce8d6</a></td><td><code>sage -t: Handle --optional=!FEATURE</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a670ae8ac34dff7c29f84744463a1c4aeb6892d4">a670ae8</a></td><td><code>src/bin/sage-runtests: Update documentation of --optional</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93">ba86146</a></td><td><code>src/bin/sage-runtests --help: Say that ! needs to be quoted</code></td></tr></table>




---

archive/issue_comments_546983.json:
```json
{
    "body": "Changed commit from **[`d0a52ed`](https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403)** to **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**",
    "created_at": "2022-06-05T18:23:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546983",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d0a52ed`](https://github.com/sagemath/sagetrac-mirror/commit/d0a52ed409ed07ae060c305f7481ab41479d3403)** to **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**



---

archive/issue_comments_546984.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThe line `Features detected for doctesting:` only reports the dynamically detected features, a subset of what is listed as `Features to be detected:`.\nThe statically known ones (from `--optional`) are not reported there.\n\nThis works as designed, but if you have a suggestion how it should be changed, we can change it.",
    "created_at": "2022-06-05T18:39:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546984",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

The line `Features detected for doctesting:` only reports the dynamically detected features, a subset of what is listed as `Features to be detected:`.
The statically known ones (from `--optional`) are not reported there.

This works as designed, but if you have a suggestion how it should be changed, we can change it.



---

archive/issue_comments_546985.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@soehms](#comment:17):\n> If you have installed some optional feature `xyz` on your system and forgot a `# optional - xyz` or `xyz.is_present()` somewhere in your change of code then this new doctest option will not bring this to your attention. That was what I hoped when I've first seen this ticket. Do you know, how this can be achieved without uninstalling the package?\n\nThe doctests marked `# optional - xyz` *are* disabled using `--optional=\"!xyz\"` -- as your test above with `--optional=!database_knotinfo,sage` verified.\n\nThere is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket.",
    "created_at": "2022-06-05T18:47:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546985",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@soehms](#comment:17):
> If you have installed some optional feature `xyz` on your system and forgot a `# optional - xyz` or `xyz.is_present()` somewhere in your change of code then this new doctest option will not bring this to your attention. That was what I hoped when I've first seen this ticket. Do you know, how this can be achieved without uninstalling the package?

The doctests marked `# optional - xyz` *are* disabled using `--optional="!xyz"` -- as your test above with `--optional=!database_knotinfo,sage` verified.

There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket.



---

archive/issue_comments_546986.json:
```json
{
    "body": "Reviewer: **Sebastian Oehms**",
    "created_at": "2022-06-08T06:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546986",
    "user": "https://github.com/soehms"
}
```

Reviewer: **Sebastian Oehms**



---

archive/issue_comments_546987.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@mkoeppe](#comment:20):\n\n> The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.\n\nI'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?\n\n> This works as designed, but if you have a suggestion how it should be changed, we can change it.\n\nIt's difficult to make a suggestion before I've completely understood the intention. According to the given phrase I assumed it would correspond to the *Features to be detected*. So, at least in order to resolve that irritation it would be enough to change the phrase into `Dynamically detected features ...` (whatever this means).\n\n> Replying to [@soehms](#comment:17):\n> There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. \n\nPerhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? I think that could be realized via a boolean `_hidden` in class `Feature`, which default is `False` and would be switched to `True` in case of this option.",
    "created_at": "2022-06-08T06:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546987",
    "user": "https://github.com/soehms"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@mkoeppe](#comment:20):

> The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.

I'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?

> This works as designed, but if you have a suggestion how it should be changed, we can change it.

It's difficult to make a suggestion before I've completely understood the intention. According to the given phrase I assumed it would correspond to the *Features to be detected*. So, at least in order to resolve that irritation it would be enough to change the phrase into `Dynamically detected features ...` (whatever this means).

> Replying to [@soehms](#comment:17):
> There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. 

Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? I think that could be realized via a boolean `_hidden` in class `Feature`, which default is `False` and would be switched to `True` in case of this option.



---

archive/issue_events_463957.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-06-08T06:42:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463957"
}
```



---

archive/issue_events_463958.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-06-08T06:42:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463958"
}
```



---

archive/issue_comments_546988.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@soehms](#comment:21):\n> Replying to [@mkoeppe](#comment:20):\n> \n> > The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.\n\n> \n> I'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?\n\nSorry for using undefined terminology. \n\nWhen you use `sage -t --optional=sage,FEATURE`, then FEATURE is \"statically known\".\n\nWhen you use `sage -t --optional=sage,optional` and SPKG is the name of a normal package that is installed, then SPKG is \"statically known\".\n\nOther features, by default those enumerated by `sage.features.all.all_features` except for those enumerated by `sage.doctest.external.external_software`, are subject to detection the first time that their name appears as an `# optional - FEATURE` annotation. (This is done by `sage.doctest.parsing.SageDocTestParser`.)",
    "created_at": "2022-06-08T07:00:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546988",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@soehms](#comment:21):
> Replying to [@mkoeppe](#comment:20):
> 
> > The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.

> 
> I'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?

Sorry for using undefined terminology. 

When you use `sage -t --optional=sage,FEATURE`, then FEATURE is "statically known".

When you use `sage -t --optional=sage,optional` and SPKG is the name of a normal package that is installed, then SPKG is "statically known".

Other features, by default those enumerated by `sage.features.all.all_features` except for those enumerated by `sage.doctest.external.external_software`, are subject to detection the first time that their name appears as an `# optional - FEATURE` annotation. (This is done by `sage.doctest.parsing.SageDocTestParser`.)



---

archive/issue_comments_546989.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@mkoeppe](#comment:22):\n> Replying to [@soehms](#comment:21):\n> > Replying to [@mkoeppe](#comment:20):\n> > \n> > > The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.\n\n> > \n> > I'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?\n\n> \n> Sorry for using undefined terminology. \n> \n> When you use `sage -t --optional=sage,FEATURE`, then FEATURE is \"statically known\".\n> \n> When you use `sage -t --optional=sage,optional` and SPKG is the name of a normal package that is installed, then SPKG is \"statically known\".\n> \n> Other features, by default those enumerated by `sage.features.all.all_features` except for those enumerated by `sage.doctest.external.external_software`, are subject to detection the first time that their name appears as an `# optional - FEATURE` annotation. (This is done by `sage.doctest.parsing.SageDocTestParser`.)\n\nThanks for the explanation (I missed the fact that `issuperset` does the job)!",
    "created_at": "2022-06-08T16:45:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546989",
    "user": "https://github.com/soehms"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@mkoeppe](#comment:22):
> Replying to [@soehms](#comment:21):
> > Replying to [@mkoeppe](#comment:20):
> > 
> > > The line Features detected for doctesting: only reports the dynamically detected features, a subset of what is listed as Features to be detected:. The statically known ones (from --optional) are not reported there.

> > 
> > I'm wondering what *dynamically* means here? From the code I displayed in my previous comment it appears that a feature is dynamically detected if it is tested to be contained in `available_software`. Where is that supposed to happen?

> 
> Sorry for using undefined terminology. 
> 
> When you use `sage -t --optional=sage,FEATURE`, then FEATURE is "statically known".
> 
> When you use `sage -t --optional=sage,optional` and SPKG is the name of a normal package that is installed, then SPKG is "statically known".
> 
> Other features, by default those enumerated by `sage.features.all.all_features` except for those enumerated by `sage.doctest.external.external_software`, are subject to detection the first time that their name appears as an `# optional - FEATURE` annotation. (This is done by `sage.doctest.parsing.SageDocTestParser`.)

Thanks for the explanation (I missed the fact that `issuperset` does the job)!



---

archive/issue_comments_546990.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@soehms](#comment:21):\n> > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. \n\n> \n> Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? \n\nYes, I think something like this could make sense if there's a strong enough use case for it. It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. \n\nThanks for reviewing!",
    "created_at": "2022-06-08T17:53:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546990",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@soehms](#comment:21):
> > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. 

> 
> Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? 

Yes, I think something like this could make sense if there's a strong enough use case for it. It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. 

Thanks for reviewing!



---

archive/issue_comments_546991.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@mkoeppe](#comment:24):\n> Replying to [@soehms](#comment:21):\n> > > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. \n\n> > \n> > Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? \n\n> \n> Yes, I think something like this could make sense if there's a strong enough use case for it.\n\nThe use case I'm thinking of is the following: If you have installed an optional package `xyz` and run a test on your changes, say\n\n```\nsage -t src/sage/....py\n```\n\nthen it might happen that you get `All tests passed!` here. But after\n\n```\nmake xyz-clean\n```\n\nthe same invocation of `sage -t` could find failures. Probably we will get more situations like that as modularization goes ahead. Surely, the patchbots will detect these. But it will be more convenient if you can detect these failures easily on your own system. I don't know how difficult it would be to fake the absence of an optional package in general. But in all cases where the `Features` functionality is used consequently, it should be doable.\n\n\n\n> It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. \n\nOf course! After my vacation (that is in a couple of weeks) I will try to figure out how this could be done.",
    "created_at": "2022-06-10T16:10:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546991",
    "user": "https://github.com/soehms"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@mkoeppe](#comment:24):
> Replying to [@soehms](#comment:21):
> > > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. 

> > 
> > Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? 

> 
> Yes, I think something like this could make sense if there's a strong enough use case for it.

The use case I'm thinking of is the following: If you have installed an optional package `xyz` and run a test on your changes, say

```
sage -t src/sage/....py
```

then it might happen that you get `All tests passed!` here. But after

```
make xyz-clean
```

the same invocation of `sage -t` could find failures. Probably we will get more situations like that as modularization goes ahead. Surely, the patchbots will detect these. But it will be more convenient if you can detect these failures easily on your own system. I don't know how difficult it would be to fake the absence of an optional package in general. But in all cases where the `Features` functionality is used consequently, it should be doable.



> It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. 

Of course! After my vacation (that is in a couple of weeks) I will try to figure out how this could be done.



---

archive/issue_comments_546992.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage__t___optional__sage__feature_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t___optional__sage__feature_)** to **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**",
    "created_at": "2022-06-12T23:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546992",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage__t___optional__sage__feature_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t___optional__sage__feature_)** to **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)**



---

archive/issue_events_463959.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-06-12T23:08:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463959"
}
```



---

archive/issue_events_463960.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4cc978b96c2354fb3c920d8777bd61b38d6aecae",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-06-12T23:08:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33823#event-463960"
}
```



---

archive/issue_comments_546993.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThanks for this ticket. It will be quite useful for example to test that `sage -t` works even when let's say there is no latex on the machine (which is the case for the computer on which Volker makes tests before merging tickets).",
    "created_at": "2022-06-24T08:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546993",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:27" align="right">comment:27</div>

Thanks for this ticket. It will be quite useful for example to test that `sage -t` works even when let's say there is no latex on the machine (which is the case for the computer on which Volker makes tests before merging tickets).



---

archive/issue_comments_546994.json:
```json
{
    "body": "Changed commit from **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)** to none",
    "created_at": "2022-06-24T08:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546994",
    "user": "https://github.com/seblabbe"
}
```

Changed commit from **[`ba86146`](https://github.com/sagemath/sagetrac-mirror/commit/ba86146e5a5e3308026aac49d87d2716a80c6a93)** to none



---

archive/issue_comments_546995.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@soehms](#comment:25):\n> Replying to [@mkoeppe](#comment:24):\n> > Replying to [@soehms](#comment:21):\n> > > > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. \n\n> > > \n> > > Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? \n\n> > \n> > Yes, I think something like this could make sense if there's a strong enough use case for it.\n\n> \n> The use case I'm thinking of is the following: If you have installed an optional package `xyz` and run a test on your changes, say\n> \n> ```\n> sage -t src/sage/....py\n> ```\n> \n> then it might happen that you get `All tests passed!` here. But after\n> \n> ```\n> make xyz-clean\n> ```\n> \n> the same invocation of `sage -t` could find failures. Probably we will get more situations like that as modularization goes ahead. Surely, the patchbots will detect these. But it will be more convenient if you can detect these failures easily on your own system. I don't know how difficult it would be to fake the absence of an optional package in general. But in all cases where the `Features` functionality is used consequently, it should be doable.\n> \n> \n> \n> > It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. \n\n> \n> Of course! After my vacation (that is in a couple of weeks) I will try to figure out how this could be done.\n\nsee #34185!",
    "created_at": "2022-07-15T07:10:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33823#issuecomment-546995",
    "user": "https://github.com/soehms"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@soehms](#comment:25):
> Replying to [@mkoeppe](#comment:24):
> > Replying to [@soehms](#comment:21):
> > > > There is no mechanism to disable the actual feature in the Sage runtime. What `xyz.is_present()` does is not affected by the present ticket. 

> > > 
> > > Perhaps I have in mind a new option `sage -t --hide=FEATURES` which would imply `--optional='!FEATURE1,!FEATURE2,..'`. Is there something against having such an additional option? 

> > 
> > Yes, I think something like this could make sense if there's a strong enough use case for it.

> 
> The use case I'm thinking of is the following: If you have installed an optional package `xyz` and run a test on your changes, say
> 
> ```
> sage -t src/sage/....py
> ```
> 
> then it might happen that you get `All tests passed!` here. But after
> 
> ```
> make xyz-clean
> ```
> 
> the same invocation of `sage -t` could find failures. Probably we will get more situations like that as modularization goes ahead. Surely, the patchbots will detect these. But it will be more convenient if you can detect these failures easily on your own system. I don't know how difficult it would be to fake the absence of an optional package in general. But in all cases where the `Features` functionality is used consequently, it should be doable.
> 
> 
> 
> > It would probably be best to provide this mechanism also for non-doctest situations. So this would be a separate ticket. 

> 
> Of course! After my vacation (that is in a couple of weeks) I will try to figure out how this could be done.

see #34185!
