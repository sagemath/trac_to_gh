# Issue 33100: is_positive_definite returns wrong results

archive/issues_032863.json:
```json
{
    "body": "CC:  @orlitzky\n\nFor some double dense matrices that are not positive definite, Sage incorrectly claims that they are:\n\n    {{{\n    sage: A = matrix(CDF, [This is the Trac macro *1+I* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1+I-macro))\n    sage: A.is_positive_definite()  # should be False\n    True\n    sage: A.is_positive_semidefinite()  # correct\n    False\n    }}}\n\nClearly, `A` is not even Hermitian. The implementation relies on testing whether a Cholesky decomposition exists or not, but `.cholesky()` gives an incorrect result for this matrix\n\n    {{{\n    sage: A.cholesky()\n    [1.0]\n    }}}\n\nwhile for most other matrices this would raise an error.\n\nThe [SciPy documentation](https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.cholesky.html) is not entirely clear about this, but it seems that SciPy assumes that the matrix is already Hermitian positive-definite and thus only considers half the matrix (see [SciPy issues 2116](https://github.com/scipy/scipy/issues/2116#issuecomment-990487066) and [15012](https://github.com/scipy/scipy/issues/15012)).\n\nThis ticket adds a check whether the matrix is Hermitian before computing the Cholesky decomposition, which resolves the problem. The default algorithm for `is_hermitian` is changed from \"orthonormal\" to \"naive\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/33100\n\n",
    "closed_at": "2022-02-21T21:56:25Z",
    "created_at": "2021-12-31T16:05:36Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "is_positive_definite returns wrong results",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33100",
    "user": "https://github.com/mwageringel"
}
```
CC:  @orlitzky

For some double dense matrices that are not positive definite, Sage incorrectly claims that they are:

    {{{
    sage: A = matrix(CDF, [This is the Trac macro *1+I* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1+I-macro))
    sage: A.is_positive_definite()  # should be False
    True
    sage: A.is_positive_semidefinite()  # correct
    False
    }}}

Clearly, `A` is not even Hermitian. The implementation relies on testing whether a Cholesky decomposition exists or not, but `.cholesky()` gives an incorrect result for this matrix

    {{{
    sage: A.cholesky()
    [1.0]
    }}}

while for most other matrices this would raise an error.

The [SciPy documentation](https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.cholesky.html) is not entirely clear about this, but it seems that SciPy assumes that the matrix is already Hermitian positive-definite and thus only considers half the matrix (see [SciPy issues 2116](https://github.com/scipy/scipy/issues/2116#issuecomment-990487066) and [15012](https://github.com/scipy/scipy/issues/15012)).

This ticket adds a check whether the matrix is Hermitian before computing the Cholesky decomposition, which resolves the problem. The default algorithm for `is_hermitian` is changed from "orthonormal" to "naive".

Issue created by migration from https://trac.sagemath.org/ticket/33100





---

archive/issue_comments_468033.json:
```json
{
    "body": "This also fails for larger matrices, such as these linear combinations of positive definite matrices (for many seeds):\n\n```\nsage: set_random_seed(0)\nsage: random_pd_matrix = lambda n: (B := matrix.random(CDF, n)) * B.H\nsage: r = 2  # 2 or larger\nsage: n = 3  # 1 or larger\nsage: As = [random_pd_matrix(n) for j in range(r)]\nsage: C = random_pd_matrix(r)\nsage: A = sum(sum(C[i,j] for i in range(r)) * As[j] for j in range(r))\nsage: A.is_positive_definite()  # should usually be False\nTrue\nsage: A.is_positive_semidefinite()  # correct, but pd would imply psd\nFalse\nsage: A.is_hermitian(tol=1e-6)  # correct, but pd would imply Hermitian\nFalse\n```",
    "created_at": "2021-12-31T16:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468033",
    "user": "https://github.com/mwageringel"
}
```

This also fails for larger matrices, such as these linear combinations of positive definite matrices (for many seeds):

```
sage: set_random_seed(0)
sage: random_pd_matrix = lambda n: (B := matrix.random(CDF, n)) * B.H
sage: r = 2  # 2 or larger
sage: n = 3  # 1 or larger
sage: As = [random_pd_matrix(n) for j in range(r)]
sage: C = random_pd_matrix(r)
sage: A = sum(sum(C[i,j] for i in range(r)) * As[j] for j in range(r))
sage: A.is_positive_definite()  # should usually be False
True
sage: A.is_positive_semidefinite()  # correct, but pd would imply psd
False
sage: A.is_hermitian(tol=1e-6)  # correct, but pd would imply Hermitian
False
```



---

archive/issue_comments_468034.json:
```json
{
    "body": "My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works. There are two small problems though.\n\nFirst, the generic `cholesky()` doesn't work on the trivial matrix, breaking one doctest (#33107). This is an easy fix.\n\nSecond, the subclass implementation of `is_hermitian()` used by the superclass's `is_cholesky()` doesn't work out-of-the box. For example,\n\n```\nsage: M = matrix(RDF,[[ 1,  1,    1,     1,     1],                 \n....:                 [ 1,  5,   31,   121,   341],                 \n....:                 [ 1, 31,  341,  1555,  4681],                 \n....:                 [ 1,121, 1555,  7381, 22621],                 \n....:                 [ 1,341, 4681, 22621, 69905]])\nM.is_hermitian(algorithm='orthonormal') # the default\nFalse\n```\n\nwhile\n\n```\nsage: M.is_hermitian(algorithm='orthonormal', tol=1e-10)\nTrue\n```\n\nor\n\n```\nsage: M.is_hermitian(algorithm='naive')\nTrue\n```\n\nWe'd have to either tweak the default tolerance there, or again maybe just delete the subclass method. The \"naive\" algorithm now defers to a superclass implementation where the default tolerance works.",
    "created_at": "2022-01-02T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468034",
    "user": "https://github.com/orlitzky"
}
```

My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works. There are two small problems though.

First, the generic `cholesky()` doesn't work on the trivial matrix, breaking one doctest (#33107). This is an easy fix.

Second, the subclass implementation of `is_hermitian()` used by the superclass's `is_cholesky()` doesn't work out-of-the box. For example,

```
sage: M = matrix(RDF,[[ 1,  1,    1,     1,     1],                 
....:                 [ 1,  5,   31,   121,   341],                 
....:                 [ 1, 31,  341,  1555,  4681],                 
....:                 [ 1,121, 1555,  7381, 22621],                 
....:                 [ 1,341, 4681, 22621, 69905]])
M.is_hermitian(algorithm='orthonormal') # the default
False
```

while

```
sage: M.is_hermitian(algorithm='orthonormal', tol=1e-10)
True
```

or

```
sage: M.is_hermitian(algorithm='naive')
True
```

We'd have to either tweak the default tolerance there, or again maybe just delete the subclass method. The "naive" algorithm now defers to a superclass implementation where the default tolerance works.



---

archive/issue_comments_468035.json:
```json
{
    "body": "Rather than remove the subclass `is_hermitian()`, I've only switched its default to the \"naive\" algorithm. (But note that I don't think it's any more naive than \"orthonormal\"). Afterwards, eliminating `cholesky()` and `is_positive_definite()` from the subclass allows the superclass methods to return the correct result.\n\n---\nNew commits:",
    "created_at": "2022-01-03T16:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468035",
    "user": "https://github.com/orlitzky"
}
```

Rather than remove the subclass `is_hermitian()`, I've only switched its default to the "naive" algorithm. (But note that I don't think it's any more naive than "orthonormal"). Afterwards, eliminating `cholesky()` and `is_positive_definite()` from the subclass allows the superclass methods to return the correct result.

---
New commits:



---

archive/issue_comments_468036.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-03T16:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468036",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468037.json:
```json
{
    "body": "I agree with using the \"naive\" algorithm here and do not see why it would be more naive/less appropriate than the \"orthonormal\" one. For the orthonormal algorithm, no tolerance would be large enough to work for all such matrices that are Hermitian in an exact sense, when considered entrywise. Scipy 1.8.0 will also have a function [scipy.linalg.ishermitian](https://scipy.github.io/devdocs/reference/generated/scipy.linalg.ishermitian.html) which works like the naive algorithm, i.e. entrywise.\n\nReplying to [comment:2 mjo]:\n> My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works.\n\n\nI am a bit hesitant to replace a Scipy implementation by a pure Sage implementation. Upstream has confirmed [here](https://github.com/scipy/scipy/issues/2116#issuecomment-1003690573) that `scipy.linalg.cholesky` essentially first constructs a Hermitian matrix by only considering the given triangular information of the matrix, ignoring the other half. So if we first check whether the matrix is Hermitian in `.cholesky()`, we will obtain a valid Cholesky decomposition.\n\nThis would make `is_positive_definite` work as intended by the implementation. Though, it would in most cases produce the same result as `is_positive_semidefinite`, as a Cholesky decomposition can exist for semidefinite matrices, but for matrices that are actually singular this can easily fail. Is there an intended difference between these methods? Perhaps debatable, but from a usage point of view I would expect something like\n- `is_positive_definite` = all eigenvalues strictly positive (or `> tolerance`)\n- `is_positive_semidefinite` = all eigenvalues `> -tolerance`\n(implemented in a numerically sane way).",
    "created_at": "2022-01-03T16:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468037",
    "user": "https://github.com/mwageringel"
}
```

I agree with using the "naive" algorithm here and do not see why it would be more naive/less appropriate than the "orthonormal" one. For the orthonormal algorithm, no tolerance would be large enough to work for all such matrices that are Hermitian in an exact sense, when considered entrywise. Scipy 1.8.0 will also have a function [scipy.linalg.ishermitian](https://scipy.github.io/devdocs/reference/generated/scipy.linalg.ishermitian.html) which works like the naive algorithm, i.e. entrywise.

Replying to [comment:2 mjo]:
> My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works.


I am a bit hesitant to replace a Scipy implementation by a pure Sage implementation. Upstream has confirmed [here](https://github.com/scipy/scipy/issues/2116#issuecomment-1003690573) that `scipy.linalg.cholesky` essentially first constructs a Hermitian matrix by only considering the given triangular information of the matrix, ignoring the other half. So if we first check whether the matrix is Hermitian in `.cholesky()`, we will obtain a valid Cholesky decomposition.

This would make `is_positive_definite` work as intended by the implementation. Though, it would in most cases produce the same result as `is_positive_semidefinite`, as a Cholesky decomposition can exist for semidefinite matrices, but for matrices that are actually singular this can easily fail. Is there an intended difference between these methods? Perhaps debatable, but from a usage point of view I would expect something like
- `is_positive_definite` = all eigenvalues strictly positive (or `> tolerance`)
- `is_positive_semidefinite` = all eigenvalues `> -tolerance`
(implemented in a numerically sane way).



---

archive/issue_comments_468038.json:
```json
{
    "body": "Replying to [comment:4 gh-mwageringel]:\n> I agree with using the \"naive\" algorithm here and do not see why it would be more naive/less appropriate than the \"orthonormal\" one. For the orthonormal algorithm, no tolerance would be large enough to work for all such matrices that are Hermitian in an exact sense, when considered entrywise. Scipy 1.8.0 will also have a function [scipy.linalg.ishermitian](https://scipy.github.io/devdocs/reference/generated/scipy.linalg.ishermitian.html) which works like the naive algorithm, i.e. entrywise.\n> \n> Replying to [comment:2 mjo]:\n> > My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works.\n\n> \n> I am a bit hesitant to replace a Scipy implementation by a pure Sage implementation. Upstream has confirmed [here](https://github.com/scipy/scipy/issues/2116#issuecomment-1003690573) that `scipy.linalg.cholesky` essentially first constructs a Hermitian matrix by only considering the given triangular information of the matrix, ignoring the other half. So if we first check whether the matrix is Hermitian in `.cholesky()`, we will obtain a valid Cholesky decomposition.\n\n\nYeah, the subclass should be doing that anyway, since the superclass does it. (Users shouldn't see different qualitative behaviors from a method when you change the underlying representation of the matrix's entries.) I haven't checked but scipy is almost certainly faster even though I did my best to make it fast in sage. On the other hand, it's nice not to have copy & pasted the entire method's documentation.\n\n> This would make `is_positive_definite` work as intended by the implementation. Though, it would in most cases produce the same result as `is_positive_semidefinite`, as a Cholesky decomposition can exist for semidefinite matrices, but for matrices that are actually singular this can easily fail. Is there an intended difference between these methods? Perhaps debatable, but from a usage point of view I would expect something like\n> - `is_positive_definite` = all eigenvalues strictly positive (or `> tolerance`)\n> - `is_positive_semidefinite` = all eigenvalues `> -tolerance`\n> (implemented in a numerically sane way).\n\n\nThe superclass `cholesky()` and `is_*definite()` methods support both exact and inexact rings in a numerically stable way (caveat: `is_hermitian()` itself is not yet reliable, that's #33053) via `block_ldlt()`. For inexact rings, positive-definite and positive-semidefinite are indeed basically the same up to machine precision, but the tests use `> 0` and `>= 0`.",
    "created_at": "2022-01-03T17:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468038",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:4 gh-mwageringel]:
> I agree with using the "naive" algorithm here and do not see why it would be more naive/less appropriate than the "orthonormal" one. For the orthonormal algorithm, no tolerance would be large enough to work for all such matrices that are Hermitian in an exact sense, when considered entrywise. Scipy 1.8.0 will also have a function [scipy.linalg.ishermitian](https://scipy.github.io/devdocs/reference/generated/scipy.linalg.ishermitian.html) which works like the naive algorithm, i.e. entrywise.
> 
> Replying to [comment:2 mjo]:
> > My first thought was that we should be able to delete `cholesky()` and `is_positive_definite()` in the subclass to obtain something possibly slower, but that actually works.

> 
> I am a bit hesitant to replace a Scipy implementation by a pure Sage implementation. Upstream has confirmed [here](https://github.com/scipy/scipy/issues/2116#issuecomment-1003690573) that `scipy.linalg.cholesky` essentially first constructs a Hermitian matrix by only considering the given triangular information of the matrix, ignoring the other half. So if we first check whether the matrix is Hermitian in `.cholesky()`, we will obtain a valid Cholesky decomposition.


Yeah, the subclass should be doing that anyway, since the superclass does it. (Users shouldn't see different qualitative behaviors from a method when you change the underlying representation of the matrix's entries.) I haven't checked but scipy is almost certainly faster even though I did my best to make it fast in sage. On the other hand, it's nice not to have copy & pasted the entire method's documentation.

> This would make `is_positive_definite` work as intended by the implementation. Though, it would in most cases produce the same result as `is_positive_semidefinite`, as a Cholesky decomposition can exist for semidefinite matrices, but for matrices that are actually singular this can easily fail. Is there an intended difference between these methods? Perhaps debatable, but from a usage point of view I would expect something like
> - `is_positive_definite` = all eigenvalues strictly positive (or `> tolerance`)
> - `is_positive_semidefinite` = all eigenvalues `> -tolerance`
> (implemented in a numerically sane way).


The superclass `cholesky()` and `is_*definite()` methods support both exact and inexact rings in a numerically stable way (caveat: `is_hermitian()` itself is not yet reliable, that's #33053) via `block_ldlt()`. For inexact rings, positive-definite and positive-semidefinite are indeed basically the same up to machine precision, but the tests use `> 0` and `>= 0`.



---

archive/issue_comments_468039.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> I haven't checked but scipy is almost certainly faster even though I did my best to make it fast in sage. On the other hand, it's nice not to have copy & pasted the entire method's documentation.\n\n\nUnless you strongly prefer otherwise, I tend towards staying with using Scipy for the Cholesky decomposition.\n\n> The superclass `cholesky()` and `is_*definite()` methods support both exact and inexact rings in a numerically stable way (caveat: `is_hermitian()` itself is not yet reliable, that's #33053) via `block_ldlt()`. For inexact rings, positive-definite and positive-semidefinite are indeed basically the same up to machine precision, but the tests use `> 0` and `>= 0`.\n\n\nOk, dropping `is_positive_definite` from the subclass sounds good to me then, as then the `is_*definite` methods are at least based on the same implementation (as numerically the distinction between these methods is not so relevant).",
    "created_at": "2022-01-03T18:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468039",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:5 mjo]:
> I haven't checked but scipy is almost certainly faster even though I did my best to make it fast in sage. On the other hand, it's nice not to have copy & pasted the entire method's documentation.


Unless you strongly prefer otherwise, I tend towards staying with using Scipy for the Cholesky decomposition.

> The superclass `cholesky()` and `is_*definite()` methods support both exact and inexact rings in a numerically stable way (caveat: `is_hermitian()` itself is not yet reliable, that's #33053) via `block_ldlt()`. For inexact rings, positive-definite and positive-semidefinite are indeed basically the same up to machine precision, but the tests use `> 0` and `>= 0`.


Ok, dropping `is_positive_definite` from the subclass sounds good to me then, as then the `is_*definite` methods are at least based on the same implementation (as numerically the distinction between these methods is not so relevant).



---

archive/issue_comments_468040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-03T19:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468040",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468041.json:
```json
{
    "body": "I left `is_positive_definite()` alone because `cholesky()` and `is_positive_definite()` cache one another in the subclass. Using the superclass for `is_positive_definite()` would cache a `block_ldlt()` factorization, but then it would not be used for `cholesky()`.",
    "created_at": "2022-01-03T19:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468041",
    "user": "https://github.com/orlitzky"
}
```

I left `is_positive_definite()` alone because `cholesky()` and `is_positive_definite()` cache one another in the subclass. Using the superclass for `is_positive_definite()` would cache a `block_ldlt()` factorization, but then it would not be used for `cholesky()`.



---

archive/issue_comments_468042.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-04T11:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468042",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468043.json:
```json
{
    "body": "Ok, this looks good to me then. Thank you for implementing this.",
    "created_at": "2022-01-04T11:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468043",
    "user": "https://github.com/mwageringel"
}
```

Ok, this looks good to me then. Thank you for implementing this.



---

archive/issue_comments_468044.json:
```json
{
    "body": "Merge failure on top of:\n\n429528ecd0 Trac #20343: Adding sage/plot/tikzpicture.py\n\nd3f74f63be Trac #33085: adjust dochtml label so doctests pass when html doc is not built/installed\n\nd70747d13f Trac #33094: update URLs in SPKG.rst for ECL\n\n03f57e6ad1 Trac #32922: Change parameter name\n\n1057236215 Trac #30999: expose method hyperbolicity in graphs\n\n9b4a9198e2 Trac #33035: random doctest failure in src/sage/tests/book_stein_ent.py\n\nfee8e65057 Trac #32264: Convenience syntax for quaternion ideals\n\nc2bcc90ea8 Trac #31005: Add traceback information to exceptions during docbuild\n\n3f697607e8 Trac #33159: wrong result solving equation system with symbolic matrix\n\nbf9673f1a5 Trac #33158: kRegularSequence: minimization wrong\n\n01ff471e9f Trac #33157: Issue with SR \u2192 [RC]BF conversion\n\n379c88d769 Trac #33154: random doctest failure in sage.plot.matrix_plot\n\n9fa34b02a7 Trac #33151: sage-conf_pypi does not build wheelhouse\n\nffe0b98c81 Trac #33148: fix doctest in quantum_group_gap\n\n0bf6a86003 Trac #33107: Generic cholesky() fails on the trivial matrix\n\n3b02b82340 Trac #33103: gitpod integration using Docker images from portability testing workflow\n\naf5c4c48ad Trac #33098: Add more void packages to distros/void.txt\n\n9b61187847 Trac #33096: src/tox.ini (relint): Exclude editor temp files etc.\n\n217156c781 Trac #33064: sage_docbuild: fails when cache cannot be saved\n\nc2097f4654 Trac #33039: Random doctest failure in continued_fraction_gosper\n\n53781ca1e5 Trac #33015: Random failure in number_field_element.pyx\n\n0ecfd27027 Trac #33005: Add feature for pdftocairo\n\n961f91527a Trac #32970: fix parent of 0th Bernoulli polynomial\n\n527fbc473d Trac #32877: Remove superfluous set_random_seed() calls\n\nd3aec55fe5 Trac #32873: sage.features, sage_setup: Replace use of distutils.errors by setuptools\n\n3154d1d97d Trac #32856: Get rid of \"# optional - build\"\n\nd87eeb3e7f Trac #30362: Add symplectic structures\n\n030af8db7e Trac #29865: Modularization of sagelib: Break out separate packages sagemath-objects, sagemath-categories\n\n1fed3d635c Trac #33189: Make tests pass with arb 2.22\n\n1ea6801ffb Trac #33131: Installation manual: Add decision tree, remove mention of Sage-mirror-hosted binary distributions\n\n209b71330d Trac #33101: lrslib: fix doctest in game_theory/parser.py\n\n73aa4f3e4d Trac #33077: pari-jupyter: Reinstate\n\n180b9ee2fb Trac #30933: GH Actions: Repair upload of docker images to docker.pkg.github.com\n\ne67e1ee810 Trac #8450: intermediate complex expression in real functions make many plot functions fail\n\nd03870b5f2 Trac #33206: PDF documentation links in Documentation from Jupyter notebook are broken\n\n8ea92d580a Updated [SageMath](SageMath) version to 9.5.rc3\n\n\n\nmerge was not clean: conflicts in src/sage/matrix/matrix_double_dense.pyx",
    "created_at": "2022-01-23T23:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468044",
    "user": "https://github.com/mkoeppe"
}
```

Merge failure on top of:

429528ecd0 Trac #20343: Adding sage/plot/tikzpicture.py

d3f74f63be Trac #33085: adjust dochtml label so doctests pass when html doc is not built/installed

d70747d13f Trac #33094: update URLs in SPKG.rst for ECL

03f57e6ad1 Trac #32922: Change parameter name

1057236215 Trac #30999: expose method hyperbolicity in graphs

9b4a9198e2 Trac #33035: random doctest failure in src/sage/tests/book_stein_ent.py

fee8e65057 Trac #32264: Convenience syntax for quaternion ideals

c2bcc90ea8 Trac #31005: Add traceback information to exceptions during docbuild

3f697607e8 Trac #33159: wrong result solving equation system with symbolic matrix

bf9673f1a5 Trac #33158: kRegularSequence: minimization wrong

01ff471e9f Trac #33157: Issue with SR â†’ [RC]BF conversion

379c88d769 Trac #33154: random doctest failure in sage.plot.matrix_plot

9fa34b02a7 Trac #33151: sage-conf_pypi does not build wheelhouse

ffe0b98c81 Trac #33148: fix doctest in quantum_group_gap

0bf6a86003 Trac #33107: Generic cholesky() fails on the trivial matrix

3b02b82340 Trac #33103: gitpod integration using Docker images from portability testing workflow

af5c4c48ad Trac #33098: Add more void packages to distros/void.txt

9b61187847 Trac #33096: src/tox.ini (relint): Exclude editor temp files etc.

217156c781 Trac #33064: sage_docbuild: fails when cache cannot be saved

c2097f4654 Trac #33039: Random doctest failure in continued_fraction_gosper

53781ca1e5 Trac #33015: Random failure in number_field_element.pyx

0ecfd27027 Trac #33005: Add feature for pdftocairo

961f91527a Trac #32970: fix parent of 0th Bernoulli polynomial

527fbc473d Trac #32877: Remove superfluous set_random_seed() calls

d3aec55fe5 Trac #32873: sage.features, sage_setup: Replace use of distutils.errors by setuptools

3154d1d97d Trac #32856: Get rid of "# optional - build"

d87eeb3e7f Trac #30362: Add symplectic structures

030af8db7e Trac #29865: Modularization of sagelib: Break out separate packages sagemath-objects, sagemath-categories

1fed3d635c Trac #33189: Make tests pass with arb 2.22

1ea6801ffb Trac #33131: Installation manual: Add decision tree, remove mention of Sage-mirror-hosted binary distributions

209b71330d Trac #33101: lrslib: fix doctest in game_theory/parser.py

73aa4f3e4d Trac #33077: pari-jupyter: Reinstate

180b9ee2fb Trac #30933: GH Actions: Repair upload of docker images to docker.pkg.github.com

e67e1ee810 Trac #8450: intermediate complex expression in real functions make many plot functions fail

d03870b5f2 Trac #33206: PDF documentation links in Documentation from Jupyter notebook are broken

8ea92d580a Updated [SageMath](SageMath) version to 9.5.rc3



merge was not clean: conflicts in src/sage/matrix/matrix_double_dense.pyx



---

archive/issue_comments_468045.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-01-23T23:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468045",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_468046.json:
```json
{
    "body": "(brought to you by https://github.com/sagemath/git-trac-command/pull/57)",
    "created_at": "2022-01-23T23:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468046",
    "user": "https://github.com/mkoeppe"
}
```

(brought to you by https://github.com/sagemath/git-trac-command/pull/57)



---

archive/issue_comments_468047.json:
```json
{
    "body": "For some reason, I did not receive an email notification for comment 11. Also, this does not seem so useful without knowing which of the three dozen tickets causes a merge conflict, so I have to wait for the new beta anyway. It would be more helpful if the CI identifies merge conflicts between positively reviewed tickets, so that one can resolve conflicts before it even gets any attention by the release manager.",
    "created_at": "2022-01-24T18:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468047",
    "user": "https://github.com/mwageringel"
}
```

For some reason, I did not receive an email notification for comment 11. Also, this does not seem so useful without knowing which of the three dozen tickets causes a merge conflict, so I have to wait for the new beta anyway. It would be more helpful if the CI identifies merge conflicts between positively reviewed tickets, so that one can resolve conflicts before it even gets any attention by the release manager.



---

archive/issue_comments_468048.json:
```json
{
    "body": "Thanks for the input! Yes, this can certainly be refined.",
    "created_at": "2022-01-24T18:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468048",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for the input! Yes, this can certainly be refined.



---

archive/issue_events_087460.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-01-30T15:44:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33100#event-87460"
}
```



---

archive/issue_comments_468049.json:
```json
{
    "body": "Set milestone to sage-9.6 after Sage 9.5 release.",
    "created_at": "2022-01-30T15:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468049",
    "user": "https://github.com/slel"
}
```

Set milestone to sage-9.6 after Sage 9.5 release.



---

archive/issue_comments_468050.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-31T13:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468051.json:
```json
{
    "body": "```diff\n-                # avoid abs() which is missing for finite fields.\n-                if d > tolerance or -d > tolerance:\n+                # abs() support is spotty\n+                if (d*d.conjugate()).sqrt() > tolerance:\n```\nI am not completely sure about theses changes. Square roots do not always exist in the same field, such as cyclotomic fields for which `sqrt` returns a result in `SR`. Granted, this probably did not work before either, as comparisons are broken in number fields (#20028).\n\nFor finite fields, the [documentation](https://github.com/sagemath/sage/blob/226937dfa9b8b335e873c3c65a796ae1b0924ff2/src/sage/rings/finite_rings/element_givaro.pyx#L1314-L1316) advises against relying on comparisons as well. Though, technically they should work in our case, i.e. if the integer representation of a finite field element is compared to a tolerance of 0.\n\nIt might be better to explicitly check whether `d` is equal to zero when the tolerance is zero.",
    "created_at": "2022-02-06T19:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468051",
    "user": "https://github.com/mwageringel"
}
```

```diff
-                # avoid abs() which is missing for finite fields.
-                if d > tolerance or -d > tolerance:
+                # abs() support is spotty
+                if (d*d.conjugate()).sqrt() > tolerance:
```
I am not completely sure about theses changes. Square roots do not always exist in the same field, such as cyclotomic fields for which `sqrt` returns a result in `SR`. Granted, this probably did not work before either, as comparisons are broken in number fields (#20028).

For finite fields, the [documentation](https://github.com/sagemath/sage/blob/226937dfa9b8b335e873c3c65a796ae1b0924ff2/src/sage/rings/finite_rings/element_givaro.pyx#L1314-L1316) advises against relying on comparisons as well. Though, technically they should work in our case, i.e. if the integer representation of a finite field element is compared to a tolerance of 0.

It might be better to explicitly check whether `d` is equal to zero when the tolerance is zero.



---

archive/issue_comments_468052.json:
```json
{
    "body": "Replying to [comment:17 gh-mwageringel]:\n> I am not completely sure about theses changes. Square roots do not always exist in the same field, such as cyclotomic fields for which `sqrt` returns a result in `SR`. Granted, this probably did not work before either, as comparisons are broken in number fields (#20028).\n\n\nThis lurking doubt is what kept me from setting it back to needs_review right away. A priori we could square both sides to avoid roots, but I still have some questions. For the moment, a lot of this stuff is broken in corner cases anyway, so I don't feel too bad about making incremental but imperfect improvements so long as they don't hurt any existing use cases.\n\nBut for finite fields I think you're right, and I vaguely remember coming to the same conclusion. If the fields are exact, the tolerance should be zero unless you override it, and it's only by accident that the comparison works but it does work. If a tolerance is given, though, I'm not even sure what the user could expect to happen.",
    "created_at": "2022-02-06T21:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468052",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:17 gh-mwageringel]:
> I am not completely sure about theses changes. Square roots do not always exist in the same field, such as cyclotomic fields for which `sqrt` returns a result in `SR`. Granted, this probably did not work before either, as comparisons are broken in number fields (#20028).


This lurking doubt is what kept me from setting it back to needs_review right away. A priori we could square both sides to avoid roots, but I still have some questions. For the moment, a lot of this stuff is broken in corner cases anyway, so I don't feel too bad about making incremental but imperfect improvements so long as they don't hurt any existing use cases.

But for finite fields I think you're right, and I vaguely remember coming to the same conclusion. If the fields are exact, the tolerance should be zero unless you override it, and it's only by accident that the comparison works but it does work. If a tolerance is given, though, I'm not even sure what the user could expect to happen.



---

archive/issue_comments_468053.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-12T13:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468054.json:
```json
{
    "body": "Let's see what patchbot says about this one...",
    "created_at": "2022-02-12T13:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468054",
    "user": "https://github.com/orlitzky"
}
```

Let's see what patchbot says about this one...



---

archive/issue_comments_468055.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-12T13:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468055",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_468056.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-14T21:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468056",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_468057.json:
```json
{
    "body": "There is a merge failure, but otherwise this looks good to me, as long as the tests pass.",
    "created_at": "2022-02-14T21:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468057",
    "user": "https://github.com/mwageringel"
}
```

There is a merge failure, but otherwise this looks good to me, as long as the tests pass.



---

archive/issue_comments_468058.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-15T23:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468058",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468059.json:
```json
{
    "body": "It rebased cleanly, I think I maybe it wanted me to drop the commits from #33107.",
    "created_at": "2022-02-15T23:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468059",
    "user": "https://github.com/orlitzky"
}
```

It rebased cleanly, I think I maybe it wanted me to drop the commits from #33107.



---

archive/issue_comments_468060.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-15T23:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468060",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_468061.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-17T09:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468061",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468062.json:
```json
{
    "body": "Thanks.",
    "created_at": "2022-02-17T09:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468062",
    "user": "https://github.com/mwageringel"
}
```

Thanks.



---

archive/issue_comments_468063.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-21T21:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33100#issuecomment-468063",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087461.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-21T21:56:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33100",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33100#event-87461"
}
```
