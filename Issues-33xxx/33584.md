# Issue 33584: Adapt Mathics interface to SymPy upgrade from 1.8 to 1.10 (resp.1.9)

archive/issues_033347.json:
```json
{
    "body": "Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:\n\n```sage\nsage: slist = [[1, 2], 3., 4 + I]\nsage: mlist = mathics(slist)\nsage: mlist.sage()\nTraceback (most recent call last):\n...\nNotImplementedError: conversion to SageMath is not implemented\n```\n\nHere we implement a fix of that.\n\n\nKeywords: Mathics inteface SymPy\n\nBranch/Commit: 430210987d14901f3ab33d83aff3bf704fad3502\n\nReviewer: Matthias Koeppe\n\nAuthor: Sebastian Oehms\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33584\n\n",
    "closed_at": "2022-04-02T10:53:28Z",
    "created_at": "2022-03-28T16:14:41Z",
    "labels": [
        "component: interfaces",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Adapt Mathics interface to SymPy upgrade from 1.8 to 1.10 (resp.1.9)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33584",
    "user": "https://github.com/soehms"
}
```
Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:

```sage
sage: slist = [[1, 2], 3., 4 + I]
sage: mlist = mathics(slist)
sage: mlist.sage()
Traceback (most recent call last):
...
NotImplementedError: conversion to SageMath is not implemented
```

Here we implement a fix of that.


Keywords: Mathics inteface SymPy

Branch/Commit: 430210987d14901f3ab33d83aff3bf704fad3502

Reviewer: Matthias Koeppe

Author: Sebastian Oehms

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33584





---

archive/issue_comments_507064.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:\n \n-\\`\\`\\`\n+\\`\\`\\`sage\n sage: slist = [[1, 2], 3., 4 + I]\n sage: mlist = mathics(slist)\n sage: mlist.sage()\n@@ -11,6 +11,7 @@\n \n Here we implement a fix of that.\n \n+\n Comment: 1\n \n Priority: major\n```\n",
    "created_at": "2022-03-28T16:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507064",
    "user": "https://github.com/soehms"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:
 
-\`\`\`
+\`\`\`sage
 sage: slist = [[1, 2], 3., 4 + I]
 sage: mlist = mathics(slist)
 sage: mlist.sage()
@@ -11,6 +11,7 @@
 
 Here we implement a fix of that.
 
+
 Comment: 1
 
 Priority: major
```




---

archive/issue_comments_507065.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-28T16:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507065",
    "user": "https://github.com/soehms"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_507066.json:
```json
{
    "body": "<a id='comment:2'></a>No additional tests needed, since they are already there!",
    "created_at": "2022-03-28T16:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507066",
    "user": "https://github.com/soehms"
}
```

<a id='comment:2'></a>No additional tests needed, since they are already there!



---

archive/issue_comments_507067.json:
```json
{
    "body": "<a id='comment:3'></a>LGTM",
    "created_at": "2022-03-28T16:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507067",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>LGTM



---

archive/issue_comments_507068.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-28T16:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507068",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_507069.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-03-28T16:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507069",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_507070.json:
```json
{
    "body": "<a id='comment:4'></a>Thanks!",
    "created_at": "2022-03-28T20:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507070",
    "user": "https://github.com/soehms"
}
```

<a id='comment:4'></a>Thanks!



---

archive/issue_comments_507071.json:
```json
{
    "body": "<a id='comment:5'></a>I use this patch\n\n```diff\n--- a/sage/interfaces/sympy.py\n+++ b/sage/interfaces/sympy.py\n@@ -259,6 +259,12 @@\n         return SR.var(str(self))\n \n \n+def _sympysage_mathics_expression(self):\n+    from sage.interfaces.mathics import reduce_load\n+    return [reduce_load(x)._sage_()\n+            for x in self.expr.to_python()]\n+\n+\n def _sympysage_Subs(self):\n     \"\"\"\n     EXAMPLES::\n@@ -302,7 +308,7 @@\n \n         else:\n             # the function defined in sympy is not known in sage\n-            raise AttributeError\n+            raise AttributeError(fname)\n     return func\n \n # the convoluted class structure with metaclasses and stuff sympy uses\n@@ -941,6 +947,8 @@\n     from sympy.polys.rootoftools import CRootOf\n     from sympy.series.order import Order\n     from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix\n+    from mathics.core.convert import SympyExpression\n+    SympyExpression._sage_ = _sympysage_mathics_expression\n \n     Float._sage_ = _sympysage_float\n     Integer._sage_ = _sympysage_integer\n```\nbut I am not saying that it's correct so I couldn't show it to anybody",
    "created_at": "2022-03-28T22:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507071",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:5'></a>I use this patch

```diff
--- a/sage/interfaces/sympy.py
+++ b/sage/interfaces/sympy.py
@@ -259,6 +259,12 @@
         return SR.var(str(self))
 
 
+def _sympysage_mathics_expression(self):
+    from sage.interfaces.mathics import reduce_load
+    return [reduce_load(x)._sage_()
+            for x in self.expr.to_python()]
+
+
 def _sympysage_Subs(self):
     """
     EXAMPLES::
@@ -302,7 +308,7 @@
 
         else:
             # the function defined in sympy is not known in sage
-            raise AttributeError
+            raise AttributeError(fname)
     return func
 
 # the convoluted class structure with metaclasses and stuff sympy uses
@@ -941,6 +947,8 @@
     from sympy.polys.rootoftools import CRootOf
     from sympy.series.order import Order
     from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
+    from mathics.core.convert import SympyExpression
+    SympyExpression._sage_ = _sympysage_mathics_expression
 
     Float._sage_ = _sympysage_float
     Integer._sage_ = _sympysage_integer
```
but I am not saying that it's correct so I couldn't show it to anybody



---

archive/issue_comments_507072.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 gh-sheerluck]:\n> I use this patch\n> \n> ```diff\n> --- a/sage/interfaces/sympy.py\n> +++ b/sage/interfaces/sympy.py\n> @@ -259,6 +259,12 @@\n>          return SR.var(str(self))\n>  \n>  \n> +def _sympysage_mathics_expression(self):\n> +    from sage.interfaces.mathics import reduce_load\n> +    return [reduce_load(x)._sage_()\n> +            for x in self.expr.to_python()]\n> +\n> +\n>  def _sympysage_Subs(self):\n>      \"\"\"\n>      EXAMPLES::\n> @@ -302,7 +308,7 @@\n>  \n>          else:\n>              # the function defined in sympy is not known in sage\n> -            raise AttributeError\n> +            raise AttributeError(fname)\n>      return func\n>  \n>  # the convoluted class structure with metaclasses and stuff sympy uses\n> @@ -941,6 +947,8 @@\n>      from sympy.polys.rootoftools import CRootOf\n>      from sympy.series.order import Order\n>      from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix\n> +    from mathics.core.convert import SympyExpression\n> +    SympyExpression._sage_ = _sympysage_mathics_expression\n>  \n>      Float._sage_ = _sympysage_float\n>      Integer._sage_ = _sympysage_integer\n> ```\n> but I am not saying that it's correct so I couldn't show it to anybody\n\n\n\nI agree that this fixes the issue, as well. Probably you know better about Mathics than I do, but it seems to be more restrictive, since it converts each instance of SympyExpression to a list. Furthermore, the import statement may fail, since Mathics is an optional package. Thus, it has to be checked that the feature is present.\n\nAnyway, you are welcome to contribute to the code. But I would prefer to do that on a separate ticket, to have the issue fixed, as soon as possible.",
    "created_at": "2022-03-29T15:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507072",
    "user": "https://github.com/soehms"
}
```

<a id='comment:6'></a>Replying to [comment:5 gh-sheerluck]:
> I use this patch
> 
> ```diff
> --- a/sage/interfaces/sympy.py
> +++ b/sage/interfaces/sympy.py
> @@ -259,6 +259,12 @@
>          return SR.var(str(self))
>  
>  
> +def _sympysage_mathics_expression(self):
> +    from sage.interfaces.mathics import reduce_load
> +    return [reduce_load(x)._sage_()
> +            for x in self.expr.to_python()]
> +
> +
>  def _sympysage_Subs(self):
>      """
>      EXAMPLES::
> @@ -302,7 +308,7 @@
>  
>          else:
>              # the function defined in sympy is not known in sage
> -            raise AttributeError
> +            raise AttributeError(fname)
>      return func
>  
>  # the convoluted class structure with metaclasses and stuff sympy uses
> @@ -941,6 +947,8 @@
>      from sympy.polys.rootoftools import CRootOf
>      from sympy.series.order import Order
>      from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
> +    from mathics.core.convert import SympyExpression
> +    SympyExpression._sage_ = _sympysage_mathics_expression
>  
>      Float._sage_ = _sympysage_float
>      Integer._sage_ = _sympysage_integer
> ```
> but I am not saying that it's correct so I couldn't show it to anybody



I agree that this fixes the issue, as well. Probably you know better about Mathics than I do, but it seems to be more restrictive, since it converts each instance of SympyExpression to a list. Furthermore, the import statement may fail, since Mathics is an optional package. Thus, it has to be checked that the feature is present.

Anyway, you are welcome to contribute to the code. But I would prefer to do that on a separate ticket, to have the issue fixed, as soon as possible.



---

archive/issue_comments_507073.json:
```json
{
    "body": "<a id='comment:7'></a>I agree that my patch is a dirty hack :)\n\nI agree that proper work with SympyExpression should be on on a separate ticket.\n\nI agree that this ticket should be merged ASAP.",
    "created_at": "2022-03-29T15:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507073",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:7'></a>I agree that my patch is a dirty hack :)

I agree that proper work with SympyExpression should be on on a separate ticket.

I agree that this ticket should be merged ASAP.



---

archive/issue_events_088372.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:53:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33584#event-88372"
}
```



---

archive/issue_comments_507074.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33584#issuecomment-507074",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
