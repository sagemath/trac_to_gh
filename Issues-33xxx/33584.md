# Issue 33584: Adapt Mathics interface to SymPy upgrade from 1.8 to 1.10 (resp.1.9)

archive/issues_033347.json:
```json
{
    "assignees": [],
    "body": "Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:\n\n```sage\nsage: slist = [[1, 2], 3., 4 + I]\nsage: mlist = mathics(slist)\nsage: mlist.sage()\nTraceback (most recent call last):\n...\nNotImplementedError: conversion to SageMath is not implemented\n```\n\nHere we implement a fix of that.\n\n\nKeywords: **Mathics inteface SymPy**\n\nBranch/Commit: **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **Sebastian Oehms**\n\nComponent: **interfaces**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33584_\n\n",
    "closed_at": "2022-04-02T10:53:28Z",
    "created_at": "2022-03-28T16:14:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Adapt Mathics interface to SymPy upgrade from 1.8 to 1.10 (resp.1.9)",
    "type": "issue",
    "updated_at": "2022-04-02T10:53:28Z",
    "url": "https://github.com/sagemath/sage/issues/33584",
    "user": "https://github.com/soehms"
}
```
Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:

```sage
sage: slist = [[1, 2], 3., 4 + I]
sage: mlist = mathics(slist)
sage: mlist.sage()
Traceback (most recent call last):
...
NotImplementedError: conversion to SageMath is not implemented
```

Here we implement a fix of that.


Keywords: **Mathics inteface SymPy**

Branch/Commit: **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**

Reviewer: **Matthias Koeppe**

Author: **Sebastian Oehms**

Component: **interfaces**

_Issue created by migration from https://trac.sagemath.org/ticket/33584_





---

archive/issue_events_461168.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-28T16:14:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461168"
}
```



---

archive/issue_events_461169.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-28T16:14:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461169"
}
```



---

archive/issue_events_461170.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-28T16:14:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461170"
}
```



---

archive/issue_events_461171.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-28T16:14:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461171"
}
```



---

archive/issue_comments_542648.json:
```json
{
    "body": "Branch: **[u/soehms/mathics_sympy_upgr_33584](https://github.com/sagemath/sagetrac-mirror/tree/u/soehms/mathics_sympy_upgr_33584)**",
    "created_at": "2022-03-28T16:26:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542648",
    "user": "https://github.com/soehms"
}
```

Branch: **[u/soehms/mathics_sympy_upgr_33584](https://github.com/sagemath/sagetrac-mirror/tree/u/soehms/mathics_sympy_upgr_33584)**



---

archive/issue_comments_542649.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:\n \n-```\n+```sage\n sage: slist = [[1, 2], 3., 4 + I]\n sage: mlist = mathics(slist)\n sage: mlist.sage()\n``````\n",
    "created_at": "2022-03-28T16:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542649",
    "user": "https://github.com/soehms"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:
 
-```
+```sage
 sage: slist = [[1, 2], 3., 4 + I]
 sage: mlist = mathics(slist)
 sage: mlist.sage()
``````




---

archive/issue_events_461172.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-28T16:28:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461172"
}
```



---

archive/issue_comments_542650.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNo additional tests needed, since they are already there!",
    "created_at": "2022-03-28T16:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542650",
    "user": "https://github.com/soehms"
}
```

<div id="comment:2" align="right">comment:2</div>

No additional tests needed, since they are already there!



---

archive/issue_comments_542651.json:
```json
{
    "body": "Commit: **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**",
    "created_at": "2022-03-28T16:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542651",
    "user": "https://github.com/soehms"
}
```

Commit: **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**



---

archive/issue_comments_542652.json:
```json
{
    "body": "Author: **Sebastian Oehms**",
    "created_at": "2022-03-28T16:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542652",
    "user": "https://github.com/soehms"
}
```

Author: **Sebastian Oehms**



---

archive/issue_comments_542653.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2022-03-28T16:45:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542653",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_542654.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nLGTM",
    "created_at": "2022-03-28T16:45:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542654",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

LGTM



---

archive/issue_events_461173.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-28T16:45:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461173"
}
```



---

archive/issue_events_461174.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-28T16:45:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461174"
}
```



---

archive/issue_events_461175.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-28T16:45:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461175"
}
```



---

archive/issue_events_461176.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-28T16:45:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461176"
}
```



---

archive/issue_comments_542655.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThanks!",
    "created_at": "2022-03-28T20:35:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542655",
    "user": "https://github.com/soehms"
}
```

<div id="comment:4" align="right">comment:4</div>

Thanks!



---

archive/issue_comments_542656.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI use this patch\n\n```diff\n--- a/sage/interfaces/sympy.py\n+++ b/sage/interfaces/sympy.py\n@@ -259,6 +259,12 @@\n         return SR.var(str(self))\n \n \n+def _sympysage_mathics_expression(self):\n+    from sage.interfaces.mathics import reduce_load\n+    return [reduce_load(x)._sage_()\n+            for x in self.expr.to_python()]\n+\n+\n def _sympysage_Subs(self):\n     \"\"\"\n     EXAMPLES::\n@@ -302,7 +308,7 @@\n \n         else:\n             # the function defined in sympy is not known in sage\n-            raise AttributeError\n+            raise AttributeError(fname)\n     return func\n \n # the convoluted class structure with metaclasses and stuff sympy uses\n@@ -941,6 +947,8 @@\n     from sympy.polys.rootoftools import CRootOf\n     from sympy.series.order import Order\n     from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix\n+    from mathics.core.convert import SympyExpression\n+    SympyExpression._sage_ = _sympysage_mathics_expression\n \n     Float._sage_ = _sympysage_float\n     Integer._sage_ = _sympysage_integer\n```\nbut I am not saying that it's correct so I couldn't show it to anybody",
    "created_at": "2022-03-28T22:16:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542656",
    "user": "https://github.com/sheerluck"
}
```

<div id="comment:5" align="right">comment:5</div>

I use this patch

```diff
--- a/sage/interfaces/sympy.py
+++ b/sage/interfaces/sympy.py
@@ -259,6 +259,12 @@
         return SR.var(str(self))
 
 
+def _sympysage_mathics_expression(self):
+    from sage.interfaces.mathics import reduce_load
+    return [reduce_load(x)._sage_()
+            for x in self.expr.to_python()]
+
+
 def _sympysage_Subs(self):
     """
     EXAMPLES::
@@ -302,7 +308,7 @@
 
         else:
             # the function defined in sympy is not known in sage
-            raise AttributeError
+            raise AttributeError(fname)
     return func
 
 # the convoluted class structure with metaclasses and stuff sympy uses
@@ -941,6 +947,8 @@
     from sympy.polys.rootoftools import CRootOf
     from sympy.series.order import Order
     from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
+    from mathics.core.convert import SympyExpression
+    SympyExpression._sage_ = _sympysage_mathics_expression
 
     Float._sage_ = _sympysage_float
     Integer._sage_ = _sympysage_integer
```
but I am not saying that it's correct so I couldn't show it to anybody



---

archive/issue_comments_542657.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@sheerluck](#comment:5):\n> I use this patch\n> \n> ```diff\n> --- a/sage/interfaces/sympy.py\n> +++ b/sage/interfaces/sympy.py\n> @@ -259,6 +259,12 @@\n>          return SR.var(str(self))\n>  \n>  \n> +def _sympysage_mathics_expression(self):\n> +    from sage.interfaces.mathics import reduce_load\n> +    return [reduce_load(x)._sage_()\n> +            for x in self.expr.to_python()]\n> +\n> +\n>  def _sympysage_Subs(self):\n>      \"\"\"\n>      EXAMPLES::\n> @@ -302,7 +308,7 @@\n>  \n>          else:\n>              # the function defined in sympy is not known in sage\n> -            raise AttributeError\n> +            raise AttributeError(fname)\n>      return func\n>  \n>  # the convoluted class structure with metaclasses and stuff sympy uses\n> @@ -941,6 +947,8 @@\n>      from sympy.polys.rootoftools import CRootOf\n>      from sympy.series.order import Order\n>      from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix\n> +    from mathics.core.convert import SympyExpression\n> +    SympyExpression._sage_ = _sympysage_mathics_expression\n>  \n>      Float._sage_ = _sympysage_float\n>      Integer._sage_ = _sympysage_integer\n> ```\n> but I am not saying that it's correct so I couldn't show it to anybody\n\n\nI agree that this fixes the issue, as well. Probably you know better about Mathics than I do, but it seems to be more restrictive, since it converts each instance of SympyExpression to a list. Furthermore, the import statement may fail, since Mathics is an optional package. Thus, it has to be checked that the feature is present.\n\nAnyway, you are welcome to contribute to the code. But I would prefer to do that on a separate ticket, to have the issue fixed, as soon as possible.",
    "created_at": "2022-03-29T15:20:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542657",
    "user": "https://github.com/soehms"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@sheerluck](#comment:5):
> I use this patch
> 
> ```diff
> --- a/sage/interfaces/sympy.py
> +++ b/sage/interfaces/sympy.py
> @@ -259,6 +259,12 @@
>          return SR.var(str(self))
>  
>  
> +def _sympysage_mathics_expression(self):
> +    from sage.interfaces.mathics import reduce_load
> +    return [reduce_load(x)._sage_()
> +            for x in self.expr.to_python()]
> +
> +
>  def _sympysage_Subs(self):
>      """
>      EXAMPLES::
> @@ -302,7 +308,7 @@
>  
>          else:
>              # the function defined in sympy is not known in sage
> -            raise AttributeError
> +            raise AttributeError(fname)
>      return func
>  
>  # the convoluted class structure with metaclasses and stuff sympy uses
> @@ -941,6 +947,8 @@
>      from sympy.polys.rootoftools import CRootOf
>      from sympy.series.order import Order
>      from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
> +    from mathics.core.convert import SympyExpression
> +    SympyExpression._sage_ = _sympysage_mathics_expression
>  
>      Float._sage_ = _sympysage_float
>      Integer._sage_ = _sympysage_integer
> ```
> but I am not saying that it's correct so I couldn't show it to anybody


I agree that this fixes the issue, as well. Probably you know better about Mathics than I do, but it seems to be more restrictive, since it converts each instance of SympyExpression to a list. Furthermore, the import statement may fail, since Mathics is an optional package. Thus, it has to be checked that the feature is present.

Anyway, you are welcome to contribute to the code. But I would prefer to do that on a separate ticket, to have the issue fixed, as soon as possible.



---

archive/issue_comments_542658.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI agree that my patch is a dirty hack :)\n\nI agree that proper work with SympyExpression should be on on a separate ticket.\n\nI agree that this ticket should be merged ASAP.",
    "created_at": "2022-03-29T15:44:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542658",
    "user": "https://github.com/sheerluck"
}
```

<div id="comment:7" align="right">comment:7</div>

I agree that my patch is a dirty hack :)

I agree that proper work with SympyExpression should be on on a separate ticket.

I agree that this ticket should be merged ASAP.



---

archive/issue_events_461177.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:53:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461177"
}
```



---

archive/issue_events_461178.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "afa0d9633b2405fad4abf9e22993aef93680ddf9",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-04-02T10:53:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33584#event-461178"
}
```



---

archive/issue_comments_542659.json:
```json
{
    "body": "Changed branch from **[u/soehms/mathics_sympy_upgr_33584](https://github.com/sagemath/sagetrac-mirror/tree/u/soehms/mathics_sympy_upgr_33584)** to **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**",
    "created_at": "2022-04-02T10:53:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33584#issuecomment-542659",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/soehms/mathics_sympy_upgr_33584](https://github.com/sagemath/sagetrac-mirror/tree/u/soehms/mathics_sympy_upgr_33584)** to **[4302109](https://github.com/sagemath/sagetrac-mirror/commit/430210987d14901f3ab33d83aff3bf704fad3502)**
