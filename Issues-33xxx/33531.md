# Issue 33531: pytest in sage is broken, please make it really optional

archive/issues_033294.json:
```json
{
    "assignees": [],
    "body": "- pytest support was introduced in #31003 and merged on the basis that it was a no-op\n- Later in #31103 some code was added at the end of `src/bin/sage-runtests` to run pytest (see [719e442](https://github.com/sagemath/sagetrac-mirror/commit/719e442e5d3a3eaadab28bc835b68d46a4a2d12d))\n- This code is broken in many ways, some that have been fixed (#32892) and some that have not (#31924, also [#31924 comment:23](https://github.com/sagemath/sage/issues/31924#comment:23))\n- The bug in #31924 is a PITA and the only way to avoid it is to patch out the code that runs pytest in `sage-runtests\n- Result is: if pytest is not installed, we get an annoying warning that induces to install it, but if pytest is installed then doctesting is broken (as in we get scary warnings at the end and a non-zero exit code, on top of a 3s overhead)\n\n```\n$ time sage -t src/sage/all.py ; echo $?\nRunning doctests with ID 2022-03-19-12-07-01-0e558614.\nUsing --optional=build,pip,sage,sage_spkg,void\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --warn-long 60.2 --random-seed=67815784290108767013007019285883868229 src/sage/all.py\n    [13 tests, 0.75 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.8 seconds\n    cpu time: 0.7 seconds\n    cumulative wall time: 0.7 seconds\nFeatures detected for doctesting: \n============================================================================ test session starts =============================================================================\nplatform linux -- Python 3.10.3, pytest-6.2.5, py-1.10.0, pluggy-0.13.1\nrootdir: /opt/sage/sage-git/develop/src, configfile: tox.ini\nplugins: anyio-3.5.0, xonsh-0.11.0\ncollected 0 items / 1 error                                                                                                                                                  \n\n=================================================================================== ERRORS ===================================================================================\n________________________________________________________________________ ERROR collecting sage/all.py ________________________________________________________________________\nsrc/sage/all.py:315: in <module>\n    sage.misc.lazy_import.finish_startup()\nsage/misc/lazy_import.pyx:87: in sage.misc.lazy_import.finish_startup (build/cythonized/sage/misc/lazy_import.c:1995)\n    ???\nsage/misc/lazy_import.pyx:103: in sage.misc.lazy_import.finish_startup (build/cythonized/sage/misc/lazy_import.c:1929)\n    ???\nE   AssertionError: finish_startup() must be called exactly once\n========================================================================== short test summary info ===========================================================================\nERROR src/sage/all.py - AssertionError: finish_startup() must be called exactly once\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n============================================================================== 1 error in 0.34s ==============================================================================\n\nreal\t0m6.917s\nuser\t0m6.496s\nsys\t0m0.486s\n2\n```\n\nExpected behaviour (this is what happens when pytest is patched out in `sage-runtests`):\n\n```\n$ time sage -t src/sage/all.py ; echo $?\nRunning doctests with ID 2022-03-19-12-07-20-a46d44e6.\nUsing --optional=build,pip,sage,sage_spkg,void\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --warn-long 60.2 --random-seed=339422732397923267068138499972932430419 src/sage/all.py\n    [13 tests, 0.75 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.8 seconds\n    cpu time: 0.8 seconds\n    cumulative wall time: 0.8 seconds\nFeatures detected for doctesting: \n\nreal\t0m4.115s\nuser\t0m3.783s\nsys\t0m0.323s\n0\n```\n\n\nMy proposal:\n- add a feature flag \"pytest\" and make running pytest conditional to that\n- do NOT add pytest to the default flags until all issues are fixed and it is known to work ok (at the very least #31924 should be fixed)\n\nIn fact pytest should only run when there's some file `*_test.py` in the list of files, and only in those files. I think DC already traversed the filesystem in search of files, so instead of having pytest traverse the filesystem again, just filter the list of files that DC obtained for `*_test.py` and run pytest just on those and only if there's some.\n\nEven if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest (just add `--optional=sage` or whatever else one wants to test, leaving out `pytest`)\n\nDepends on #31924\n\nCC:  @tobiasdiez @mkoeppe\n\nReviewer: **Gonzalo Tornar\u00eda**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33531_\n\n",
    "closed_at": "2022-05-03T00:55:33Z",
    "created_at": "2022-03-19T15:20:21Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "pytest in sage is broken, please make it really optional",
    "type": "issue",
    "updated_at": "2022-05-03T00:55:33Z",
    "url": "https://github.com/sagemath/sage/issues/33531",
    "user": "https://github.com/tornaria"
}
```
- pytest support was introduced in #31003 and merged on the basis that it was a no-op
- Later in #31103 some code was added at the end of `src/bin/sage-runtests` to run pytest (see [719e442](https://github.com/sagemath/sagetrac-mirror/commit/719e442e5d3a3eaadab28bc835b68d46a4a2d12d))
- This code is broken in many ways, some that have been fixed (#32892) and some that have not (#31924, also [#31924 comment:23](https://github.com/sagemath/sage/issues/31924#comment:23))
- The bug in #31924 is a PITA and the only way to avoid it is to patch out the code that runs pytest in `sage-runtests
- Result is: if pytest is not installed, we get an annoying warning that induces to install it, but if pytest is installed then doctesting is broken (as in we get scary warnings at the end and a non-zero exit code, on top of a 3s overhead)

```
$ time sage -t src/sage/all.py ; echo $?
Running doctests with ID 2022-03-19-12-07-01-0e558614.
Using --optional=build,pip,sage,sage_spkg,void
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --warn-long 60.2 --random-seed=67815784290108767013007019285883868229 src/sage/all.py
    [13 tests, 0.75 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
Features detected for doctesting: 
============================================================================ test session starts =============================================================================
platform linux -- Python 3.10.3, pytest-6.2.5, py-1.10.0, pluggy-0.13.1
rootdir: /opt/sage/sage-git/develop/src, configfile: tox.ini
plugins: anyio-3.5.0, xonsh-0.11.0
collected 0 items / 1 error                                                                                                                                                  

=================================================================================== ERRORS ===================================================================================
________________________________________________________________________ ERROR collecting sage/all.py ________________________________________________________________________
src/sage/all.py:315: in <module>
    sage.misc.lazy_import.finish_startup()
sage/misc/lazy_import.pyx:87: in sage.misc.lazy_import.finish_startup (build/cythonized/sage/misc/lazy_import.c:1995)
    ???
sage/misc/lazy_import.pyx:103: in sage.misc.lazy_import.finish_startup (build/cythonized/sage/misc/lazy_import.c:1929)
    ???
E   AssertionError: finish_startup() must be called exactly once
========================================================================== short test summary info ===========================================================================
ERROR src/sage/all.py - AssertionError: finish_startup() must be called exactly once
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================== 1 error in 0.34s ==============================================================================

real	0m6.917s
user	0m6.496s
sys	0m0.486s
2
```

Expected behaviour (this is what happens when pytest is patched out in `sage-runtests`):

```
$ time sage -t src/sage/all.py ; echo $?
Running doctests with ID 2022-03-19-12-07-20-a46d44e6.
Using --optional=build,pip,sage,sage_spkg,void
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --warn-long 60.2 --random-seed=339422732397923267068138499972932430419 src/sage/all.py
    [13 tests, 0.75 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.8 seconds
    cumulative wall time: 0.8 seconds
Features detected for doctesting: 

real	0m4.115s
user	0m3.783s
sys	0m0.323s
0
```


My proposal:
- add a feature flag "pytest" and make running pytest conditional to that
- do NOT add pytest to the default flags until all issues are fixed and it is known to work ok (at the very least #31924 should be fixed)

In fact pytest should only run when there's some file `*_test.py` in the list of files, and only in those files. I think DC already traversed the filesystem in search of files, so instead of having pytest traverse the filesystem again, just filter the list of files that DC obtained for `*_test.py` and run pytest just on those and only if there's some.

Even if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest (just add `--optional=sage` or whatever else one wants to test, leaving out `pytest`)

Depends on #31924

CC:  @tobiasdiez @mkoeppe

Reviewer: **Gonzalo Tornaría**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/33531_





---

archive/issue_events_462707.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-19T15:20:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462707"
}
```



---

archive/issue_events_462708.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-19T15:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462708"
}
```



---

archive/issue_events_462709.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-19T15:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462709"
}
```



---

archive/issue_events_462710.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-19T15:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462710"
}
```



---

archive/issue_comments_541569.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThis is what I have in mind (warning, this patch ignores whitespace to make it human-readable so it won't apply):\n\n```diff\n     DC = DocTestController(args, args.filenames)\n     err = DC.run()\n \n+    if \"pytest\" in DC.options.optional:\n         try:\n             exit_code_pytest = 0\n             import pytest\n@@ -163,5 +164,5 @@ if __name__ == \"__main__\":\n \n         if err == 0:\n             sys.exit(exit_code_pytest)\n-    else:\n+\n     sys.exit(err)\n```\n\n\nA proper patch (with whitespace changes) is:\n\n```diff\n--- a/src/bin/sage-runtests\n+++ b/src/bin/sage-runtests\n@@ -147,21 +147,22 @@ if __name__ == \"__main__\":\n     DC = DocTestController(args, args.filenames)\n     err = DC.run()\n \n-    try:\n-        exit_code_pytest = 0\n-        import pytest\n-        pytest_options = [\"--import-mode\", \"importlib\"]\n-        if args.verbose:\n-            pytest_options.append(\"-v\")\n-        exit_code_pytest = pytest.main(pytest_options + args.filenames)\n-        if exit_code_pytest == 5:\n-            # Exit code 5 means there were no test files, pass in this case\n+    if \"pytest\" in DC.options.optional:\n+        try:\n             exit_code_pytest = 0\n-\n-    except ModuleNotFoundError:\n-        print(\"Pytest is not installed, skip checking tests that rely on it.\")\n-\n-    if err == 0:\n-        sys.exit(exit_code_pytest)\n-    else:\n-        sys.exit(err)\n+            import pytest\n+            pytest_options = [\"--import-mode\", \"importlib\"]\n+            if args.verbose:\n+                pytest_options.append(\"-v\")\n+            exit_code_pytest = pytest.main(pytest_options + args.filenames)\n+            if exit_code_pytest == 5:\n+                # Exit code 5 means there were no test files, pass in this case\n+                exit_code_pytest = 0\n+\n+        except ModuleNotFoundError:\n+            print(\"Pytest is not installed, skip checking tests that rely on it.\")\n+\n+        if err == 0:\n+            sys.exit(exit_code_pytest)\n+\n+    sys.exit(err)\n```",
    "created_at": "2022-03-19T15:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541569",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:1" align="right">comment:1</div>

This is what I have in mind (warning, this patch ignores whitespace to make it human-readable so it won't apply):

```diff
     DC = DocTestController(args, args.filenames)
     err = DC.run()
 
+    if "pytest" in DC.options.optional:
         try:
             exit_code_pytest = 0
             import pytest
@@ -163,5 +164,5 @@ if __name__ == "__main__":
 
         if err == 0:
             sys.exit(exit_code_pytest)
-    else:
+
     sys.exit(err)
```


A proper patch (with whitespace changes) is:

```diff
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@ -147,21 +147,22 @@ if __name__ == "__main__":
     DC = DocTestController(args, args.filenames)
     err = DC.run()
 
-    try:
-        exit_code_pytest = 0
-        import pytest
-        pytest_options = ["--import-mode", "importlib"]
-        if args.verbose:
-            pytest_options.append("-v")
-        exit_code_pytest = pytest.main(pytest_options + args.filenames)
-        if exit_code_pytest == 5:
-            # Exit code 5 means there were no test files, pass in this case
+    if "pytest" in DC.options.optional:
+        try:
             exit_code_pytest = 0
-
-    except ModuleNotFoundError:
-        print("Pytest is not installed, skip checking tests that rely on it.")
-
-    if err == 0:
-        sys.exit(exit_code_pytest)
-    else:
-        sys.exit(err)
+            import pytest
+            pytest_options = ["--import-mode", "importlib"]
+            if args.verbose:
+                pytest_options.append("-v")
+            exit_code_pytest = pytest.main(pytest_options + args.filenames)
+            if exit_code_pytest == 5:
+                # Exit code 5 means there were no test files, pass in this case
+                exit_code_pytest = 0
+
+        except ModuleNotFoundError:
+            print("Pytest is not installed, skip checking tests that rely on it.")
+
+        if err == 0:
+            sys.exit(exit_code_pytest)
+
+    sys.exit(err)
```



---

archive/issue_comments_541570.json:
```json
{
    "body": "Branch: **[u/tornaria/pytest-optional](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/pytest-optional)**",
    "created_at": "2022-03-19T18:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541570",
    "user": "https://github.com/tornaria"
}
```

Branch: **[u/tornaria/pytest-optional](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/pytest-optional)**



---

archive/issue_comments_541571.json:
```json
{
    "body": "Commit: **[`f5608aa`](https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e)**",
    "created_at": "2022-03-19T18:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541571",
    "user": "https://github.com/tornaria"
}
```

Commit: **[`f5608aa`](https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e)**



---

archive/issue_comments_541572.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAnd here's the commit, ready for review.\n\nOnce pytest is working reliably, `\"pytest\"` can be added to the list of default features in `_get_optional_defaults()` so it's run by default. In any case using e.g. `--optional=sage` will skip running pytest.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e\"><code>f5608aa</code></a></td><td><code>trac #33531: don't run pytest by default</code></td></tr></table>\n",
    "created_at": "2022-03-19T18:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541572",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:2" align="right">comment:2</div>

And here's the commit, ready for review.

Once pytest is working reliably, `"pytest"` can be added to the list of default features in `_get_optional_defaults()` so it's run by default. In any case using e.g. `--optional=sage` will skip running pytest.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e"><code>f5608aa</code></a></td><td><code>trac #33531: don't run pytest by default</code></td></tr></table>




---

archive/issue_comments_541573.json:
```json
{
    "body": "Author: **Gonzalo Tornar\u00eda**",
    "created_at": "2022-03-19T18:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541573",
    "user": "https://github.com/tornaria"
}
```

Author: **Gonzalo Tornaría**



---

archive/issue_events_462711.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-19T18:31:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462711"
}
```



---

archive/issue_comments_541574.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis looks like a good fix",
    "created_at": "2022-03-19T18:46:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541574",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

This looks like a good fix



---

archive/issue_comments_541575.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nCurrently pytest is an optional package, so you have to install it manually and only in that case the tests are run. Why do you think an additional switch is necessary?\n\n> Even if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest\n\nThe long term goal is to use pytest also for run the doctests (completely removing sage's custom doctest runner). So I don't like to introduce switches that differentiate between doctests and \"pytests\".\n\nThe error that occurs while testing the all module should be fixed with #30748 (ready for review for months).",
    "created_at": "2022-03-20T12:43:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541575",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:4" align="right">comment:4</div>

Currently pytest is an optional package, so you have to install it manually and only in that case the tests are run. Why do you think an additional switch is necessary?

> Even if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest

The long term goal is to use pytest also for run the doctests (completely removing sage's custom doctest runner). So I don't like to introduce switches that differentiate between doctests and "pytests".

The error that occurs while testing the all module should be fixed with #30748 (ready for review for months).



---

archive/issue_comments_541576.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n#30748 does not describe itself as fixing a bug.",
    "created_at": "2022-03-20T15:33:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541576",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

#30748 does not describe itself as fixing a bug.



---

archive/issue_comments_541577.json:
```json
{
    "body": "Dependencies: **#32975**",
    "created_at": "2022-03-20T21:27:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541577",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#32975**



---

archive/issue_comments_541578.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@tobiasdiez](#comment:4):\n> Currently pytest is an optional package, so you have to install it manually and only in that case the tests are run. Why do you think an additional switch is necessary?\n\nMaybe pytest is installed because it's needed for another purpose. In my case, sage uses system python packages and pytest was installed in the system for whatever reason. I don't even remember, but it's kind of surprising (and annoying) that doctesting breaks because of that.\n\nMy proposal is to make the choice to run pytest explicit rather than implicit because one just happens to have pytest installed, at least while you are developing it.\n\n> > Even if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest\n\n> \n> The long term goal is to use pytest also for run the doctests (completely removing sage's custom doctest runner). So I don't like to introduce switches that differentiate between doctests and \"pytests\".\n\nIf/when that happens, this will be easy to re evaluate.\n\n> The error that occurs while testing the all module should be fixed with #30748 (ready for review for months).\n\nThat's just one random example. Doctesting  any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.\n\nReplying to [@mkoeppe](#comment:6):\n> Dependencies set to #32975\n\nIt looks to me independent. That ticket doesn't seem to touch the logic in sage-runtests.",
    "created_at": "2022-03-20T22:42:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541578",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@tobiasdiez](#comment:4):
> Currently pytest is an optional package, so you have to install it manually and only in that case the tests are run. Why do you think an additional switch is necessary?

Maybe pytest is installed because it's needed for another purpose. In my case, sage uses system python packages and pytest was installed in the system for whatever reason. I don't even remember, but it's kind of surprising (and annoying) that doctesting breaks because of that.

My proposal is to make the choice to run pytest explicit rather than implicit because one just happens to have pytest installed, at least while you are developing it.

> > Even if/after pytest integration is fixed, there are advantages to place it behind a feature flag so there's an easy way to run doctests skipping pytest

> 
> The long term goal is to use pytest also for run the doctests (completely removing sage's custom doctest runner). So I don't like to introduce switches that differentiate between doctests and "pytests".

If/when that happens, this will be easy to re evaluate.

> The error that occurs while testing the all module should be fixed with #30748 (ready for review for months).

That's just one random example. Doctesting  any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.

Replying to [@mkoeppe](#comment:6):
> Dependencies set to #32975

It looks to me independent. That ticket doesn't seem to touch the logic in sage-runtests.



---

archive/issue_comments_541579.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI can see that it's annoying that some things are not working perfectly. On the other hand, I think its also important to get experience with pytest and find these little issues that popup in different settings. Thus, I'm not a big fan of hiding pytest behind two switches.\n\n> Doctesting any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.\n\nYes, pytest is always run on these files (if you use `-t`). But normally it's a no-op. There are two things that can potentially go wrong:\n- the import of these modules is not working (that is what happened with `sage.all`)\n- pytest finds test methods that are actually no pytests (that is what happens with `tests.commandline`)\n\nThe first issue should be fixed anyway because one would encounter the same issues when using sage as a library (which is pushed by the modularization effort). And the second issue should be fixed with #31924.\n\n\nCurrently, pytest is invoked as part of some github actions runs and this should also be kept to not lower the test coverage. So one would need to pass the `pytest` switch there as well. Moreover, I think the documentation needs to be adapted, too.",
    "created_at": "2022-03-21T10:07:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541579",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:8" align="right">comment:8</div>

I can see that it's annoying that some things are not working perfectly. On the other hand, I think its also important to get experience with pytest and find these little issues that popup in different settings. Thus, I'm not a big fan of hiding pytest behind two switches.

> Doctesting any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.

Yes, pytest is always run on these files (if you use `-t`). But normally it's a no-op. There are two things that can potentially go wrong:
- the import of these modules is not working (that is what happened with `sage.all`)
- pytest finds test methods that are actually no pytests (that is what happens with `tests.commandline`)

The first issue should be fixed anyway because one would encounter the same issues when using sage as a library (which is pushed by the modularization effort). And the second issue should be fixed with #31924.


Currently, pytest is invoked as part of some github actions runs and this should also be kept to not lower the test coverage. So one would need to pass the `pytest` switch there as well. Moreover, I think the documentation needs to be adapted, too.



---

archive/issue_comments_541580.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'll add an amusing failure I have now linked to pytest in sage-on-gentoo to the list of issues to fix. I hope #31924 will cover it. I have noticed the following doctest failure on and off\n\n```\nsage -t --long --random-seed=22919418159437026337026400262276501942 /usr/lib/python3.10/site-packages/sage/tests/cmdline.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/tests/cmdline.py\", line 308, in sage.tests.cmdline.test_executable\nFailed example:\n    ret\nExpected:\n    0\nGot:\n    4\n```\nThis only happens if pytest is available and found. To put things into perspective this is the code section tested with all you need to know to reproduce the behavior\n\n```\n    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create\n    a file and preparse it::\n\n        sage: s = \"# -*- coding: utf-8 -*-\\n'''This is a test file.\\nAnd I am its doctest'''\\ndef my_add(a):\\n    '''\\n    Add 2 to a.\\n\\n        EXAMPLES::\\n\\n            sage: my_add(2)\\n            4\\n        '''\\n    return a + 2\\n\"\n        sage: script = os.path.join(tmp_dir(), 'my_script.sage')\n        sage: script_py = script + '.py'\n        sage: F = open(script, 'w')\n        sage: _ = F.write(s)\n        sage: F.close()\n        sage: (out, err, ret) = test_executable([\"sage\", \"--preparse\", script])\n        sage: ret\n        0\n        sage: os.path.isfile(script_py)\n        True\n\n    Now test my_script.sage and the preparsed version my_script.sage.py::\n\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", script])\n        sage: ret\n        0\n```\nWhy is it happening? Well I manually ran the above line with the temporary script\n\n```\n$ sage -t /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2022-03-21-14-28-37-40dde3a2.\nUsing --optional=pip,sage\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --random-seed=330965964155200917833729525818621666531 /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage\n    [1 test, 0.00 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.0 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\nFeatures detected for doctesting: \n=================================================================== test session starts ===================================================================\nplatform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\nrootdir: /home/fbissey\nplugins: hypothesis-6.38.0\ncollected 0 items                                                                                                                                         \n\n================================================================== no tests ran in 0.00s ==================================================================\nERROR: not found: /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage\n(no name '/home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage' in any of [])\n```\nThe doctest test doctesting and it ends up with a classic #31924 kind of failure.",
    "created_at": "2022-03-21T22:22:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541580",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:9" align="right">comment:9</div>

I'll add an amusing failure I have now linked to pytest in sage-on-gentoo to the list of issues to fix. I hope #31924 will cover it. I have noticed the following doctest failure on and off

```
sage -t --long --random-seed=22919418159437026337026400262276501942 /usr/lib/python3.10/site-packages/sage/tests/cmdline.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/tests/cmdline.py", line 308, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
```
This only happens if pytest is available and found. To put things into perspective this is the code section tested with all you need to know to reproduce the behavior

```
    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create
    a file and preparse it::

        sage: s = "# -*- coding: utf-8 -*-\n'''This is a test file.\nAnd I am its doctest'''\ndef my_add(a):\n    '''\n    Add 2 to a.\n\n        EXAMPLES::\n\n            sage: my_add(2)\n            4\n        '''\n    return a + 2\n"
        sage: script = os.path.join(tmp_dir(), 'my_script.sage')
        sage: script_py = script + '.py'
        sage: F = open(script, 'w')
        sage: _ = F.write(s)
        sage: F.close()
        sage: (out, err, ret) = test_executable(["sage", "--preparse", script])
        sage: ret
        0
        sage: os.path.isfile(script_py)
        True

    Now test my_script.sage and the preparsed version my_script.sage.py::

        sage: (out, err, ret) = test_executable(["sage", "-t", script])
        sage: ret
        0
```
Why is it happening? Well I manually ran the above line with the temporary script

```
$ sage -t /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage
too many failed tests, not using stored timings
Running doctests with ID 2022-03-21-14-28-37-40dde3a2.
Using --optional=pip,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --random-seed=330965964155200917833729525818621666531 /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage
    [1 test, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting: 
=================================================================== test session starts ===================================================================
platform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /home/fbissey
plugins: hypothesis-6.38.0
collected 0 items                                                                                                                                         

================================================================== no tests ran in 0.00s ==================================================================
ERROR: not found: /home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage
(no name '/home/fbissey/.sage/temp/tarazed/1679924/dir_v9uzl0t4/my_script.sage' in any of [])
```
The doctest test doctesting and it ends up with a classic #31924 kind of failure.



---

archive/issue_comments_541581.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@tobiasdiez](#comment:8):\n> I can see that it's annoying that some things are not working perfectly. On the other hand, I think its also important to get experience with pytest and find these little issues that popup in different settings. \n\nBut these are not \"little issues\", they actually break `sage -t` unless I patch out the code that runs pytest at the end of `sage-runtests`. Worse: this will go unnoticed if one works in a box where pytest is not installed, only to break when working in a box where pytest happens to be installed.\n\nIt's absolutely crucial that one can pass individual files to `sage -t`. When one asks it to doctest a file that is NOT using pytest, it should NOT call pytest at all.\n\n> Thus, I'm not a big fan of hiding pytest behind two switches.\n\nAll I'm asking is for ONE switch to run pytest. I suggested that it defaults to OFF while all the \"little issues\" are ironed out, and that it could default to ON later.\n\n> > Doctesting any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.\n\n> \n> Yes, pytest is always run on these files (if you use `-t`). But normally it's a no-op. There are two things that can potentially go wrong:\n> - the import of these modules is not working (that is what happened with `sage.all`)\n> - pytest finds test methods that are actually no pytests (that is what happens with `tests.commandline`)\n> \n> The first issue should be fixed anyway because one would encounter the same issues when using sage as a library (which is pushed by the modularization effort). And the second issue should be fixed with #31924.\n\nAlso:\na. running pytest on a file with no pytests adds a completely unnecessary 3s overhead.\nb. running pytest on a directory scans the whole tree again, but DC has already scanned the tree.\nc. e.g. doctesting sage.doctest.test ranges between \"broken\" and \"takes 2x time\" when pytest is installed.\n\nIf the current standing is that `*_test.py` files go through pytest, the rest of files go through DC, can't you get the list of files from DC, filter out the ones ending in `_test.py` and just pass those to pytest?\n\n> Currently, pytest is invoked as part of some github actions runs and this should also be kept to not lower the test coverage. So one would need to pass the `pytest` switch there as well. Moreover, I think the documentation needs to be adapted, too.\n\nThat sounds a good idea, those github actions need to be aware of pytest anyway (as in: install optional package pytest, etc) so you may as well turn the \"pytest switch\" on while it defaults to off. This gives you the opportunity and freedom to develop pytest integration without fear of breaking standard doctesting. I'd say it's better not move tests from the sage doctest framework to pytest framework until everything is working, pytest is a standard packages, and the \"pytest switch\" defaults to on.",
    "created_at": "2022-03-21T22:58:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541581",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@tobiasdiez](#comment:8):
> I can see that it's annoying that some things are not working perfectly. On the other hand, I think its also important to get experience with pytest and find these little issues that popup in different settings. 

But these are not "little issues", they actually break `sage -t` unless I patch out the code that runs pytest at the end of `sage-runtests`. Worse: this will go unnoticed if one works in a box where pytest is not installed, only to break when working in a box where pytest happens to be installed.

It's absolutely crucial that one can pass individual files to `sage -t`. When one asks it to doctest a file that is NOT using pytest, it should NOT call pytest at all.

> Thus, I'm not a big fan of hiding pytest behind two switches.

All I'm asking is for ONE switch to run pytest. I suggested that it defaults to OFF while all the "little issues" are ironed out, and that it could default to ON later.

> > Doctesting any files is broken, since the logic in sage-runtests will always call pytest with all given arguments rather than only the files that need to be run by pytest.

> 
> Yes, pytest is always run on these files (if you use `-t`). But normally it's a no-op. There are two things that can potentially go wrong:
> - the import of these modules is not working (that is what happened with `sage.all`)
> - pytest finds test methods that are actually no pytests (that is what happens with `tests.commandline`)
> 
> The first issue should be fixed anyway because one would encounter the same issues when using sage as a library (which is pushed by the modularization effort). And the second issue should be fixed with #31924.

Also:
a. running pytest on a file with no pytests adds a completely unnecessary 3s overhead.
b. running pytest on a directory scans the whole tree again, but DC has already scanned the tree.
c. e.g. doctesting sage.doctest.test ranges between "broken" and "takes 2x time" when pytest is installed.

If the current standing is that `*_test.py` files go through pytest, the rest of files go through DC, can't you get the list of files from DC, filter out the ones ending in `_test.py` and just pass those to pytest?

> Currently, pytest is invoked as part of some github actions runs and this should also be kept to not lower the test coverage. So one would need to pass the `pytest` switch there as well. Moreover, I think the documentation needs to be adapted, too.

That sounds a good idea, those github actions need to be aware of pytest anyway (as in: install optional package pytest, etc) so you may as well turn the "pytest switch" on while it defaults to off. This gives you the opportunity and freedom to develop pytest integration without fear of breaking standard doctesting. I'd say it's better not move tests from the sage doctest framework to pytest framework until everything is working, pytest is a standard packages, and the "pytest switch" defaults to on.



---

archive/issue_comments_541582.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI have a fix in #31924, please review",
    "created_at": "2022-03-21T23:42:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541582",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

I have a fix in #31924, please review



---

archive/issue_comments_541583.json:
```json
{
    "body": "Changed dependencies from **#32975** to **#31924**",
    "created_at": "2022-03-22T16:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541583",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32975** to **#31924**



---

archive/issue_comments_541584.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI believe #31924 makes this unnecessary.",
    "created_at": "2022-03-22T16:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541584",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

I believe #31924 makes this unnecessary.



---

archive/issue_events_462712.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:35:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462712"
}
```



---

archive/issue_events_462713.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:35:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462713"
}
```



---

archive/issue_events_462714.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:35:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "c6c6c6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462714"
}
```



---

archive/issue_comments_541585.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIs there still brokenness, or can we close this ticket?",
    "created_at": "2022-05-01T01:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541585",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Is there still brokenness, or can we close this ticket?



---

archive/issue_comments_541586.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI'm running with undef `SAGE_ROOT` which makes `SAGE_SRC=SAGE_LIB` (normally the python site-packages).\n\nAfter #33521, this means pytest is never run, so the issue is gone \ud83d\udc4d\ufe0f.\n\nOTOH, if I actually set `SAGE_SRC` to point to the actual sage source, pytest breaks with the following error:\n\n```\npluggy._manager.PluginValidationError: Plugin '/home/tornaria/src/sage/sage-git/src/conftest.py' for hook 'pytest_collect_file'\nhookimpl definition: pytest_collect_file(file_path: 'Path', parent: 'pytest.File') -> 'pytest.Collector | None'\nArgument(s) {'file_path'} are declared in the hookimpl but can not be found in the hookspec\n```\nThis may be because pytest is too old in void linux (6.2.5, instead of 7.x).\n\nIf I comment out the definition of `pytest_collect_file` in `src/conftest.py` then it works with an exception I document below.\n\nHowever, I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).\n\n---\n\nOut of all the files `*_test.py` in sage source tree (9 files), the only one that fails to pytest is `sage/structure/sage_object_test.py` which gives me the following error:\n\n```\n=================================================================================== ERRORS ===================================================================================\n____________________________________________________________ ERROR collecting sage/structure/sage_object_test.py _____________________________________________________________\nImportError while importing test module '/home/tornaria/src/sage/sage-git/src/sage/structure/sage_object_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/structure/sage_object_test.py:3: in <module>\n    from .sage_object import SageObject\nE   ImportError: attempted relative import with no known parent package\n========================================================================== short test summary info ===========================================================================\n```\nThis goes away if I change the import to be absolute (`sage.structure.sage_object`), but then no items are collected from this file, I'm not sure that's expected.",
    "created_at": "2022-05-01T20:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541586",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:14" align="right">comment:14</div>

I'm running with undef `SAGE_ROOT` which makes `SAGE_SRC=SAGE_LIB` (normally the python site-packages).

After #33521, this means pytest is never run, so the issue is gone 👍️.

OTOH, if I actually set `SAGE_SRC` to point to the actual sage source, pytest breaks with the following error:

```
pluggy._manager.PluginValidationError: Plugin '/home/tornaria/src/sage/sage-git/src/conftest.py' for hook 'pytest_collect_file'
hookimpl definition: pytest_collect_file(file_path: 'Path', parent: 'pytest.File') -> 'pytest.Collector | None'
Argument(s) {'file_path'} are declared in the hookimpl but can not be found in the hookspec
```
This may be because pytest is too old in void linux (6.2.5, instead of 7.x).

If I comment out the definition of `pytest_collect_file` in `src/conftest.py` then it works with an exception I document below.

However, I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).

---

Out of all the files `*_test.py` in sage source tree (9 files), the only one that fails to pytest is `sage/structure/sage_object_test.py` which gives me the following error:

```
=================================================================================== ERRORS ===================================================================================
____________________________________________________________ ERROR collecting sage/structure/sage_object_test.py _____________________________________________________________
ImportError while importing test module '/home/tornaria/src/sage/sage-git/src/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/structure/sage_object_test.py:3: in <module>
    from .sage_object import SageObject
E   ImportError: attempted relative import with no known parent package
========================================================================== short test summary info ===========================================================================
```
This goes away if I change the import to be absolute (`sage.structure.sage_object`), but then no items are collected from this file, I'm not sure that's expected.



---

archive/issue_comments_541587.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI have added a comment to #33546 and opened #33783.\n\nMaybe Tobias could comment on the pytest version needed?",
    "created_at": "2022-05-01T20:31:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541587",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

I have added a comment to #33546 and opened #33783.

Maybe Tobias could comment on the pytest version needed?



---

archive/issue_comments_541588.json:
```json
{
    "body": "Changed author from **Gonzalo Tornar\u00eda** to none",
    "created_at": "2022-05-02T22:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541588",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Gonzalo Tornaría** to none



---

archive/issue_comments_541589.json:
```json
{
    "body": "Reviewer: **Gonzalo Tornar\u00eda**",
    "created_at": "2022-05-02T22:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541589",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Gonzalo Tornaría**



---

archive/issue_events_462715.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-02T22:59:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462715"
}
```



---

archive/issue_events_462716.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-02T22:59:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462716"
}
```



---

archive/issue_comments_541590.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI take \ud83d\udc4d\ufe0f as positive review",
    "created_at": "2022-05-02T22:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541590",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

I take 👍️ as positive review



---

archive/issue_comments_541591.json:
```json
{
    "body": "Changed branch from **[u/tornaria/pytest-optional](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/pytest-optional)** to none",
    "created_at": "2022-05-03T00:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541591",
    "user": "https://github.com/tornaria"
}
```

Changed branch from **[u/tornaria/pytest-optional](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/pytest-optional)** to none



---

archive/issue_comments_541592.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mkoeppe](#comment:16):\n> I take \ud83d\udc4d\ufe0f as positive review\n\nRather, that we can close this ticket since #33521 made the issue go away, there's nothing left to merge here, and you picked up the other issues in new tickets (thanks).\n\nI don't think I can actually close the ticket though. Can you?",
    "created_at": "2022-05-03T00:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541592",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mkoeppe](#comment:16):
> I take 👍️ as positive review

Rather, that we can close this ticket since #33521 made the issue go away, there's nothing left to merge here, and you picked up the other issues in new tickets (thanks).

I don't think I can actually close the ticket though. Can you?



---

archive/issue_comments_541593.json:
```json
{
    "body": "Changed commit from **[`f5608aa`](https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e)** to none",
    "created_at": "2022-05-03T00:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541593",
    "user": "https://github.com/tornaria"
}
```

Changed commit from **[`f5608aa`](https://github.com/sagemath/sagetrac-mirror/commit/f5608aa1a29a5384b43869eb1f07e6457410f95e)** to none



---

archive/issue_comments_541594.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tornaria](#comment:17):\n> Replying to [@mkoeppe](#comment:16):\n> > I take \ud83d\udc4d\ufe0f as positive review\n\n> \n> Rather, that we can close this ticket since #33521 made the issue go away,\n\nYes, that's what positive review with the milestone \"sage-duplicate/invalid/wontfix\" indicates. It's not really necessary to remove the branch; it won't be accidentally merged.",
    "created_at": "2022-05-03T00:55:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33531#issuecomment-541594",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tornaria](#comment:17):
> Replying to [@mkoeppe](#comment:16):
> > I take 👍️ as positive review

> 
> Rather, that we can close this ticket since #33521 made the issue go away,

Yes, that's what positive review with the milestone "sage-duplicate/invalid/wontfix" indicates. It's not really necessary to remove the branch; it won't be accidentally merged.



---

archive/issue_events_462717.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T00:55:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462717"
}
```



---

archive/issue_events_462718.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T00:55:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33531",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33531#event-462718"
}
```
