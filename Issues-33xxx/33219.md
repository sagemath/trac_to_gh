# Issue 33219: defining back ffmpeg as an external feature (which are not doctested by default)

archive/issues_032982.json:
```json
{
    "body": "CC:  @mkoeppe @seblabbe @orlitzky\n\nOn the kucalc buildbot (debian 9 x86_64):\n\n```\n[...]\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 700 ##\n0\nsage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],\n               xmin=0, xmax=2*pi, figsize=[2,1]) ## line 787 ##\nsage: a.show()       # optional -- ImageMagick ## line 789 ##\nsage: a.show(iterations=3)    # optional -- ImageMagick ## line 794 ##\nsage: a.show(delay=50)        # optional -- ImageMagick ## line 798 ##\nsage: a.show(format=\"ogg\")         # optional -- ffmpeg ## line 802 ##\nsage: a.show(format=\"webm\")        # optional -- ffmpeg ## line 803 ##\nsage: a.show(format=\"mp4\")         # optional -- ffmpeg ## line 804 ##\n------------------------------------------------------------------------\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6c28)[0x7fdba3db8c28]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6e08)[0x7fdba3db8e08]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x91fa)[0x7fdba3dbb1fa]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fdbabeed390]\n/lib/x86_64-linux-gnu/libpthread.so.0(waitpid+0x6b)[0x7fdbabeecf7b]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x1ccd19)[0x7fdbac2c5d19]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0xe57e1)[0x7fdbac1de7e1]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7fdbac16a9ee]\n/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x67a88)[0x7fdbac160a88]\n[...]\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/plot/animate.py  # Timed out\n----------------------------------------------------------------------\n\n``` \n\nIssue created by migration from https://trac.sagemath.org/ticket/33219\n\n",
    "closed_at": "2022-01-29T17:34:33Z",
    "created_at": "2022-01-22T17:32:15Z",
    "labels": [
        "component: packages: optional",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "defining back ffmpeg as an external feature (which are not doctested by default)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33219",
    "user": "https://github.com/vbraun"
}
```
CC:  @mkoeppe @seblabbe @orlitzky

On the kucalc buildbot (debian 9 x86_64):

```
[...]
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 700 ##
0
sage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],
               xmin=0, xmax=2*pi, figsize=[2,1]) ## line 787 ##
sage: a.show()       # optional -- ImageMagick ## line 789 ##
sage: a.show(iterations=3)    # optional -- ImageMagick ## line 794 ##
sage: a.show(delay=50)        # optional -- ImageMagick ## line 798 ##
sage: a.show(format="ogg")         # optional -- ffmpeg ## line 802 ##
sage: a.show(format="webm")        # optional -- ffmpeg ## line 803 ##
sage: a.show(format="mp4")         # optional -- ffmpeg ## line 804 ##
------------------------------------------------------------------------
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6c28)[0x7fdba3db8c28]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6e08)[0x7fdba3db8e08]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x91fa)[0x7fdba3dbb1fa]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fdbabeed390]
/lib/x86_64-linux-gnu/libpthread.so.0(waitpid+0x6b)[0x7fdbabeecf7b]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x1ccd19)[0x7fdbac2c5d19]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0xe57e1)[0x7fdbac1de7e1]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7fdbac16a9ee]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x67a88)[0x7fdbac160a88]
[...]
**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/plot/animate.py  # Timed out
----------------------------------------------------------------------

``` 

Issue created by migration from https://trac.sagemath.org/ticket/33219





---

archive/issue_comments_469776.json:
```json
{
    "body": "We know. The timeout is a separate issue (#33045). Please try S\u00e9bastien's branch there.\n\nFeature checks at runtime won't easily be able to detect a process that hangs. It's Yet Another fundamental problem with runtime checks.",
    "created_at": "2022-01-22T17:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469776",
    "user": "https://github.com/orlitzky"
}
```

We know. The timeout is a separate issue (#33045). Please try SÃ©bastien's branch there.

Feature checks at runtime won't easily be able to detect a process that hangs. It's Yet Another fundamental problem with runtime checks.



---

archive/issue_events_087743.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2022-01-22T17:42:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33219#event-87743"
}
```



---

archive/issue_comments_469777.json:
```json
{
    "body": "If trying to use this feature can hang, then we should probably declare this feature as unsafe again by adding it back to `external_features`, https://github.com/sagemath/sage/blob/develop/src/sage/doctest/external.py#L336",
    "created_at": "2022-01-22T17:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469777",
    "user": "https://github.com/mkoeppe"
}
```

If trying to use this feature can hang, then we should probably declare this feature as unsafe again by adding it back to `external_features`, https://github.com/sagemath/sage/blob/develop/src/sage/doctest/external.py#L336



---

archive/issue_events_087744.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2022-01-25T15:02:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33219#event-87744"
}
```



---

archive/issue_events_087745.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2022-01-25T15:02:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33219#event-87745"
}
```



---

archive/issue_comments_469778.json:
```json
{
    "body": "Since #32174, we are automatically testing \"safe\" external features including `ffmpeg`. It turns out that those doctests are broken (hang, doctests time out) on machines I don't have access to including the buildbots on which Volker tests tickets.\n\nI have been testing those optional tests and others on my machine for some time now and reporting on sage-release, but indeed, not on a big variety of machines. Therefore, those optional doctests are not guarrenty to work on all machines.\n\nThere are two solutions to this:\n\n- put back `ffmpeg` to the list of optional doctests that we never test (as it was before #32174)\n- try to fix the issue, this is #33045\n\nThe current branch implements the former. Needs review!\n\n#33045 can be dealt with later once we find a way to test that it fixes the issue on a buildbot.\n\n---\nNew commits:",
    "created_at": "2022-01-25T15:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469778",
    "user": "https://github.com/seblabbe"
}
```

Since #32174, we are automatically testing "safe" external features including `ffmpeg`. It turns out that those doctests are broken (hang, doctests time out) on machines I don't have access to including the buildbots on which Volker tests tickets.

I have been testing those optional tests and others on my machine for some time now and reporting on sage-release, but indeed, not on a big variety of machines. Therefore, those optional doctests are not guarrenty to work on all machines.

There are two solutions to this:

- put back `ffmpeg` to the list of optional doctests that we never test (as it was before #32174)
- try to fix the issue, this is #33045

The current branch implements the former. Needs review!

#33045 can be dealt with later once we find a way to test that it fixes the issue on a buildbot.

---
New commits:



---

archive/issue_comments_469779.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-25T15:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469779",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469780.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2022-01-25T15:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469780",
    "user": "https://github.com/seblabbe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_469781.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-25T19:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469781",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469782.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-01-27T22:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469782",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_469783.json:
```json
{
    "body": "```\nsage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py\n**********************************************************************\nFile \"src/sage/doctest/external.py\", line 381, in sage.doctest.external.AvailableSoftware\nFailed example:\n    external_software\nExpected:\n    ['cplex',\n     'gurobi',\n     'internet',\n     'latex',\n     'latex_package_tkz_graph',\n     'lualatex',\n     'macaulay2',\n     'magma',\n     'maple',\n     'mathematica',\n     'matlab',\n     'octave',\n     'pdflatex',\n     'scilab',\n     'xelatex']\nGot:\n    ['cplex',\n     'ffmpeg',\n     'gurobi',\n     'internet',\n     'latex',\n     'latex_package_tkz_graph',\n     'lualatex',\n     'macaulay2',\n     'magma',\n     'maple',\n     'mathematica',\n     'matlab',\n     'octave',\n     'pdflatex',\n     'scilab',\n     'xelatex']\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.doctest.external.AvailableSoftware\n    [39 tests, 1 failure, 0.02 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2022-01-27T22:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469783",
    "user": "https://github.com/vbraun"
}
```

```
sage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py
**********************************************************************
File "src/sage/doctest/external.py", line 381, in sage.doctest.external.AvailableSoftware
Failed example:
    external_software
Expected:
    ['cplex',
     'gurobi',
     'internet',
     'latex',
     'latex_package_tkz_graph',
     'lualatex',
     'macaulay2',
     'magma',
     'maple',
     'mathematica',
     'matlab',
     'octave',
     'pdflatex',
     'scilab',
     'xelatex']
Got:
    ['cplex',
     'ffmpeg',
     'gurobi',
     'internet',
     'latex',
     'latex_package_tkz_graph',
     'lualatex',
     'macaulay2',
     'magma',
     'maple',
     'mathematica',
     'matlab',
     'octave',
     'pdflatex',
     'scilab',
     'xelatex']
**********************************************************************
1 item had failures:
   1 of   3 in sage.doctest.external.AvailableSoftware
    [39 tests, 1 failure, 0.02 s]
----------------------------------------------------------------------
sage -t --long --warn-long 50.8 --random-seed=123 src/sage/doctest/external.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_469784.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-01-27T22:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469784",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_469785.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-01-27T22:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469785",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_events_087746.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-29T17:34:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33219#event-87746"
}
```



---

archive/issue_comments_469786.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-29T17:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33219",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33219#issuecomment-469786",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
