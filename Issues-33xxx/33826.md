# Issue 33826: pytest - fix scope in which doctests are run

archive/issues_033589.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\n(from #33546)\n\nWhen running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\nUPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)\n\n\nCC:  @tobiasdiez\n\nComponent: **doctest framework**\n\nAuthor: **Dima Pasechnik, Tobias Diez**\n\nBranch/Commit: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action) @ [`92bbf1d`](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33826_\n\n",
    "created_at": "2022-05-09T17:36:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "pytest - fix scope in which doctests are run",
    "type": "issue",
    "updated_at": "2022-12-09T21:24:35Z",
    "url": "https://github.com/sagemath/sage/issues/33826",
    "user": "https://github.com/mkoeppe"
}
```
<div id="comment:0"></div>

(from #33546)

When running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```

UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)


CC:  @tobiasdiez

Component: **doctest framework**

Author: **Dima Pasechnik, Tobias Diez**

Branch/Commit: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action) @ [`92bbf1d`](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**

_Issue created by migration from https://trac.sagemath.org/ticket/33826_





---

archive/issue_events_460612.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460612"
}
```



---

archive/issue_events_460613.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "0000b0",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460613"
}
```



---

archive/issue_events_460614.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460614"
}
```



---

archive/issue_events_460615.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460615"
}
```



---

archive/issue_comments_546860.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4290b111c4e89b03fbd01d4b6478ec41d5c4b142\"><code>4290b11</code></a></td><td><code>Add pytest-xdist package</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62\"><code>7df807e</code></a></td><td><code>Run pytest on github to see failing tests</code></td></tr></table>\n",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546860",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4290b111c4e89b03fbd01d4b6478ec41d5c4b142"><code>4290b11</code></a></td><td><code>Add pytest-xdist package</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62"><code>7df807e</code></a></td><td><code>Run pytest on github to see failing tests</code></td></tr></table>




---

archive/issue_comments_546861.json:
```json
{
    "body": "Branch: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action)**",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546861",
    "user": "https://github.com/tobiasdiez"
}
```

Branch: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action)**



---

archive/issue_events_460616.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-14T09:58:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "title_is": "Metaticket: pytest - fix scope in which doctests are run",
    "title_was": "pytest: Fix scope in which doctests are run",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460616"
}
```



---

archive/issue_comments_546862.json:
```json
{
    "body": "Commit: **[`7df807e`](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)**",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546862",
    "user": "https://github.com/tobiasdiez"
}
```

Commit: **[`7df807e`](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)**



---

archive/issue_comments_546863.json:
```json
{
    "body": "Dependencies: **#33825**",
    "created_at": "2022-05-14T09:58:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546863",
    "user": "https://github.com/tobiasdiez"
}
```

Dependencies: **#33825**



---

archive/issue_comments_546864.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e\"><code>d3fdd95</code></a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8\"><code>58e11d7</code></a></td><td><code>Fix checker and namespace injection</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686\"><code>ff4056b</code></a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3\"><code>e62c29b</code></a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a\"><code>3ee9815</code></a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221\"><code>f863428</code></a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144\"><code>428a18c</code></a></td><td><code>Remove nonexisting paths from config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25\"><code>cc19e92</code></a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb11eb9493e15ffb4c4e9c8c4ad13da69ffde9dd\"><code>bb11eb9</code></a></td><td><code>Merge remote-tracking branch 'origin/public/tests/pytest_doctests' into public/build/pytest-github-action</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c\"><code>5f78a38</code></a></td><td><code>Fix command</code></td></tr></table>\n",
    "created_at": "2022-05-15T09:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546864",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e"><code>d3fdd95</code></a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8"><code>58e11d7</code></a></td><td><code>Fix checker and namespace injection</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686"><code>ff4056b</code></a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3"><code>e62c29b</code></a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a"><code>3ee9815</code></a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221"><code>f863428</code></a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144"><code>428a18c</code></a></td><td><code>Remove nonexisting paths from config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25"><code>cc19e92</code></a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb11eb9493e15ffb4c4e9c8c4ad13da69ffde9dd"><code>bb11eb9</code></a></td><td><code>Merge remote-tracking branch 'origin/public/tests/pytest_doctests' into public/build/pytest-github-action</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c"><code>5f78a38</code></a></td><td><code>Fix command</code></td></tr></table>




---

archive/issue_comments_546865.json:
```json
{
    "body": "Changed commit from **[`7df807e`](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)** to **[`5f78a38`](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)**",
    "created_at": "2022-05-15T09:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546865",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7df807e`](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)** to **[`5f78a38`](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)**



---

archive/issue_comments_546866.json:
```json
{
    "body": "Changed dependencies from **#33825** to **#33825, #33546**",
    "created_at": "2022-05-15T09:21:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546866",
    "user": "https://github.com/tobiasdiez"
}
```

Changed dependencies from **#33825** to **#33825, #33546**



---

archive/issue_comments_546867.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad\"><code>9aa5a42</code></a></td><td><code>Run in serial</code></td></tr></table>\n",
    "created_at": "2022-05-16T10:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546867",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad"><code>9aa5a42</code></a></td><td><code>Run in serial</code></td></tr></table>




---

archive/issue_comments_546868.json:
```json
{
    "body": "Changed commit from **[`5f78a38`](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)** to **[`9aa5a42`](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)**",
    "created_at": "2022-05-16T10:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546868",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5f78a38`](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)** to **[`9aa5a42`](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)**



---

archive/issue_events_460617.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460617"
}
```



---

archive/issue_events_460618.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460618"
}
```



---

archive/issue_comments_546869.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nthe issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n\nTrying to disable this via\n\n```diff\n--- a/src/tox.ini\n+++ b/src/tox.ini\n@@ -232,7 +232,7 @@ exclude =\n [pytest]\n python_files = *_test.py\n norecursedirs = local prefix venv build pkgs .git src/doc src/bin\n-addopts = --import-mode importlib\n+addopts = --import-mode importlib -p no:warnings\n doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS\n \n [coverage:run]\n\n```\ngives a bit more info:\n\n```\n...\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure\n__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________\n748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.\n749         If the list ``restrictions`` contains only one item, this\n750         item can be passed as such, i.e. writing ``x > y`` instead\n751         of the single element list ``[x > y]``.\n752 \n753         EXAMPLES::\n754 \n755             sage: M = Manifold(2, 'M', field='complex', structure='topological')\n756             sage: X.<x,y> = M.chart()\n757             sage: X.add_restrictions(abs(x) > 1)\nExpected:\n    doctest:warning...\n    DeprecationWarning: Chart.add_restrictions is deprecated; provide the\n    restrictions at the time of creating the chart\n    See https://trac.sagemath.org/32102 for details.\nGot nothing\n\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure\n------------------------------------------ Captured stderr call -------------------------------------------\n<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart\nSee https://trac.sagemath.org/32102 for details.\n  X.add_restrictions(abs(x) > Integer(1))\n...\n```\n\nNote `Captured stderr call` - this does not arise with the unchanged `tox.ini`.\n\nPerhaps the problem is in the way warning level is set in `deprecation()`, I don't know.",
    "created_at": "2022-12-07T11:29:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546869",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

the issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html

Trying to disable this via

```diff
--- a/src/tox.ini
+++ b/src/tox.ini
@@ -232,7 +232,7 @@ exclude =
 [pytest]
 python_files = *_test.py
 norecursedirs = local prefix venv build pkgs .git src/doc src/bin
-addopts = --import-mode importlib
+addopts = --import-mode importlib -p no:warnings
 doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS
 
 [coverage:run]

```
gives a bit more info:

```
...
/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure
__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________
748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.
749         If the list ``restrictions`` contains only one item, this
750         item can be passed as such, i.e. writing ``x > y`` instead
751         of the single element list ``[x > y]``.
752 
753         EXAMPLES::
754 
755             sage: M = Manifold(2, 'M', field='complex', structure='topological')
756             sage: X.<x,y> = M.chart()
757             sage: X.add_restrictions(abs(x) > 1)
Expected:
    doctest:warning...
    DeprecationWarning: Chart.add_restrictions is deprecated; provide the
    restrictions at the time of creating the chart
    See https://trac.sagemath.org/32102 for details.
Got nothing

/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure
------------------------------------------ Captured stderr call -------------------------------------------
<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart
See https://trac.sagemath.org/32102 for details.
  X.add_restrictions(abs(x) > Integer(1))
...
```

Note `Captured stderr call` - this does not arise with the unchanged `tox.ini`.

Perhaps the problem is in the way warning level is set in `deprecation()`, I don't know.



---

archive/issue_comments_546870.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nWith vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.\nNote that Sage does it too, but in a trickier way.\n\n```python\n# c.py\nimport warnings\ndowarn = warnings.showwarning\ndef showwarn(message, category, filename, lineno, file=None, line=None):\n    import sys\n    dowarn(message, category, filename, lineno, sys.stdout, line)\n\nwarnings.showwarning = showwarn # use stdout instead of stderr\n\n\nclass tst:\n    \"\"\"\n    >>> len(tst.__subclasses__()) >= 0\n    True\n    >>> import warnings\n    >>> warnings.warn(\"foo\")\n    <doctest ...: UserWarning: foo\n      warnings.warn(\"foo\")\n    \"\"\"\n    pass\n```\n\nat least the above works:\n\n```\n$ pytest --doctest-modules -p no:warnings c.py\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0\nrootdir: /tmp\ncollected 1 item                                                                                         \n\nc.py .                                                                                             [100%]\n\n=========================================== 1 passed in 0.03s ============================================\n```\n\nIt's still not clear how to fix Sage's pytesting: I tried a similar hack with\nshowwarning in `src/sage/doctest/forker.py`, with the one in [comment:7](#comment%3A7), to no avail...",
    "created_at": "2022-12-07T14:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546870",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

With vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.
Note that Sage does it too, but in a trickier way.

```python
# c.py
import warnings
dowarn = warnings.showwarning
def showwarn(message, category, filename, lineno, file=None, line=None):
    import sys
    dowarn(message, category, filename, lineno, sys.stdout, line)

warnings.showwarning = showwarn # use stdout instead of stderr


class tst:
    """
    >>> len(tst.__subclasses__()) >= 0
    True
    >>> import warnings
    >>> warnings.warn("foo")
    <doctest ...: UserWarning: foo
      warnings.warn("foo")
    """
    pass
```

at least the above works:

```
$ pytest --doctest-modules -p no:warnings c.py
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0
rootdir: /tmp
collected 1 item                                                                                         

c.py .                                                                                             [100%]

=========================================== 1 passed in 0.03s ============================================
```

It's still not clear how to fix Sage's pytesting: I tried a similar hack with
showwarning in `src/sage/doctest/forker.py`, with the one in [comment:7](#comment%3A7), to no avail...



---

archive/issue_comments_546871.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.",
    "created_at": "2022-12-07T16:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546871",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">comment:9</div>

I've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.



---

archive/issue_comments_546872.json:
```json
{
    "body": "Changed commit from **[`9aa5a42`](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)** to **[`92bbf1d`](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**",
    "created_at": "2022-12-07T22:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546872",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9aa5a42`](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)** to **[`92bbf1d`](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**



---

archive/issue_comments_546873.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/497d67aa5776df5c14d37e91ca0528778070ad0f\"><code>497d67a</code></a></td><td><code>Run pytest on github to see failing tests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d9211e1d4b8e8101a90a2f0c501ec82152ee42be\"><code>d9211e1</code></a></td><td><code>Fix command</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d474c3a1b9fa906a3939e049927c930e7faa7180\"><code>d474c3a</code></a></td><td><code>Run in serial</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134\"><code>92bbf1d</code></a></td><td><code>allow pytest to process deprecations in docstrings</code></td></tr></table>\n",
    "created_at": "2022-12-07T22:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546873",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/497d67aa5776df5c14d37e91ca0528778070ad0f"><code>497d67a</code></a></td><td><code>Run pytest on github to see failing tests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d9211e1d4b8e8101a90a2f0c501ec82152ee42be"><code>d9211e1</code></a></td><td><code>Fix command</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d474c3a1b9fa906a3939e049927c930e7faa7180"><code>d474c3a</code></a></td><td><code>Run in serial</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134"><code>92bbf1d</code></a></td><td><code>allow pytest to process deprecations in docstrings</code></td></tr></table>




---

archive/issue_comments_546874.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,4 +9,5 @@\n src/sage/manifolds/chart.py\n ```\n \n+UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)\n \n``````\n",
    "created_at": "2022-12-07T22:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546874",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,4 +9,5 @@
 src/sage/manifolds/chart.py
 ```
 
+UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)
 
``````




---

archive/issue_comments_546875.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nRebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.",
    "created_at": "2022-12-07T22:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546875",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

Rebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.



---

archive/issue_comments_546876.json:
```json
{
    "body": "Changed dependencies from **#33825, #33546** to none",
    "created_at": "2022-12-07T22:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546876",
    "user": "https://github.com/dimpase"
}
```

Changed dependencies from **#33825, #33546** to none



---

archive/issue_comments_546877.json:
```json
{
    "body": "Author: **Dima Pasechnik, ...**",
    "created_at": "2022-12-07T23:25:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546877",
    "user": "https://github.com/dimpase"
}
```

Author: **Dima Pasechnik, ...**



---

archive/issue_comments_546878.json:
```json
{
    "body": "Changed author from **Dima Pasechnik, ...** to **Dima Pasechnik, Tobias Diez**",
    "created_at": "2022-12-07T23:34:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546878",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Dima Pasechnik, ...** to **Dima Pasechnik, Tobias Diez**



---

archive/issue_events_460619.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-07T23:34:25Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "title_is": "pytest - fix scope in which doctests are run",
    "title_was": "Metaticket: pytest - fix scope in which doctests are run",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-460619"
}
```



---

archive/issue_comments_546879.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nhttps://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\nsays \"collected 0 items / 1 skipped\"",
    "created_at": "2022-12-07T23:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546879",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
says "collected 0 items / 1 skipped"



---

archive/issue_comments_546880.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A16):\n> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\n> says \"collected 0 items / 1 skipped\"\n\nnot caused by the latest commit: without it, or with it, the same problem:\n\n```\n=========================================== test session starts ===========================================\nplatform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0\nrootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items / 1 error                                                                               \n\n================================================= ERRORS ==================================================\n______________________________________ ERROR collecting test session ______________________________________\n/usr/lib64/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:972: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:986: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:680: in _load_unlocked\n    ???\n<frozen importlib._bootstrap_external>:850: in exec_module\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\nechelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>\n    raise IOError(\nE   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.\n========================================= short test summary info =========================================\nERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n============================================ 1 error in 5.96s =============================================\n```",
    "created_at": "2022-12-08T00:03:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546880",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [Matthias Köppe](#comment%3A16):
> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
> says "collected 0 items / 1 skipped"

not caused by the latest commit: without it, or with it, the same problem:

```
=========================================== test session starts ===========================================
platform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0
rootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items / 1 error                                                                               

================================================= ERRORS ==================================================
______________________________________ ERROR collecting test session ______________________________________
/usr/lib64/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:972: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:986: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:680: in _load_unlocked
    ???
<frozen importlib._bootstrap_external>:850: in exec_module
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
echelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>
    raise IOError(
E   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.
========================================= short test summary info =========================================
ERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================ 1 error in 5.96s =============================================
```



---

archive/issue_comments_546881.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nGoogle finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html\nto install matplotlib.\n\nindeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...",
    "created_at": "2022-12-08T00:27:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546881",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:18" align="right">comment:18</div>

Google finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html
to install matplotlib.

indeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...



---

archive/issue_comments_546882.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWhy do we even try to run tests of matplotlib? Can they be suppressed?",
    "created_at": "2022-12-08T00:40:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546882",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">comment:19</div>

Why do we even try to run tests of matplotlib? Can they be suppressed?



---

archive/issue_comments_546883.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [Dima Pasechnik](#comment%3A19):\n> Why do we even try to run tests of matplotlib?\n\nIt's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there",
    "created_at": "2022-12-08T00:47:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546883",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [Dima Pasechnik](#comment%3A19):
> Why do we even try to run tests of matplotlib?

It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there



---

archive/issue_comments_546884.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A20):\n> Replying to [Dima Pasechnik](#comment%3A19):\n> > Why do we even try to run tests of matplotlib?\n> \n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nwell, it's late here, and\n\nhttps://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile\n\nis quite a long read...",
    "created_at": "2022-12-08T01:17:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546884",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [Matthias Köppe](#comment%3A20):
> Replying to [Dima Pasechnik](#comment%3A19):
> > Why do we even try to run tests of matplotlib?
> 
> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

well, it's late here, and

https://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile

is quite a long read...



---

archive/issue_comments_546885.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A20):\n> Replying to [Dima Pasechnik](#comment%3A19):\n> > Why do we even try to run tests of matplotlib?\n> \n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nsome kind of trouble while discovering namespace packages to test. \n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items                                                                                        \n\n========================================= no tests ran in 0.01s ==========================================\nERROR: module or package not found: sage.misc (missing __init__.py?)\n```\n\nbut\n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 32 items / 1 skipped                                                                           \n\nsage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]\nsage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]\nsage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]\nsage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]\nsage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]\n...\n```\n\nthere is quite a bit on this in pytest github:\nhttps://github.com/pytest-dev/pytest/pull/1597\nclosing\nhttps://github.com/pytest-dev/pytest/issues/1567",
    "created_at": "2022-12-08T09:38:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546885",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [Matthias Köppe](#comment%3A20):
> Replying to [Dima Pasechnik](#comment%3A19):
> > Why do we even try to run tests of matplotlib?
> 
> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

some kind of trouble while discovering namespace packages to test. 

```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items                                                                                        

========================================= no tests ran in 0.01s ==========================================
ERROR: module or package not found: sage.misc (missing __init__.py?)
```

but

```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 32 items / 1 skipped                                                                           

sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]
sage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]
sage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]
sage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]
sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]
...
```

there is quite a bit on this in pytest github:
https://github.com/pytest-dev/pytest/pull/1597
closing
https://github.com/pytest-dev/pytest/issues/1567



---

archive/issue_comments_546886.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nAlso note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.\n`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:\n\n```\npytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)\ndoctest:warning\n...\n```\nbut `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird\n\n```\n================================================= ERRORS =================================================\n_____________________________________ ERROR at setup of test_pickle ______________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531\n  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):\nE       fixture 'p' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531\n__________________________________ ERROR at setup of test_add_commutes ___________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162\n  @random_testing\n  def test_add_commutes(trials, verbose=False):\nE       fixture 'trials' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162\n...\n```",
    "created_at": "2022-12-08T10:24:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546886",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">comment:23</div>

Also note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.
`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:

```
pytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)
doctest:warning
...
```
but `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird

```
================================================= ERRORS =================================================
_____________________________________ ERROR at setup of test_pickle ______________________________________
file /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531
  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):
E       fixture 'p' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531
__________________________________ ERROR at setup of test_add_commutes ___________________________________
file /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162
  @random_testing
  def test_add_commutes(trials, verbose=False):
E       fixture 'trials' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162
...
```



---

archive/issue_comments_546887.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAnd bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :\n\n```\nPytest is unaware of pep420, nobody fixed that so far\n```",
    "created_at": "2022-12-08T10:26:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546887",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

And bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :

```
Pytest is unaware of pep420, nobody fixed that so far
```



---

archive/issue_comments_546888.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nIndeed, this is very bad.",
    "created_at": "2022-12-08T17:24:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546888",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

Indeed, this is very bad.



---

archive/issue_comments_546889.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThe problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n\nIn Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n\nSo a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nFor upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.",
    "created_at": "2022-12-08T17:37:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546889",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.

In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)

So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

For upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.



---

archive/issue_comments_546890.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A26):\n> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n> \n> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n> \n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nplease see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.\n\nOn https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.",
    "created_at": "2022-12-09T14:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546890",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [Matthias Köppe](#comment%3A26):
> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.
> 
> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)
> 
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

please see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.

On https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.



---

archive/issue_comments_546891.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nBy the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.",
    "created_at": "2022-12-09T17:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546891",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

By the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.



---

archive/issue_comments_546892.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A26):\n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nA more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)",
    "created_at": "2022-12-09T17:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546892",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [Matthias Köppe](#comment%3A26):
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

A more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)



---

archive/issue_comments_546893.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nAnyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?",
    "created_at": "2022-12-09T21:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546893",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

Anyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?



---

archive/issue_comments_546894.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nYes, I think so",
    "created_at": "2022-12-09T21:24:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-546894",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

Yes, I think so
