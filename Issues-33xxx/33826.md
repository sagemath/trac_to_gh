# Issue 33826: pytest - fix scope in which doctests are run

archive/issues_033589.json:
```json
{
    "assignees": [],
    "body": "(from #33546)\n\nWhen running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\nUPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)\n\n\nCC:  @tobiasdiez\n\nBranch/Commit: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action) @ [92bbf1d](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**\n\nAuthor: **Dima Pasechnik, Tobias Diez**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33826_\n\n",
    "created_at": "2022-05-09T17:36:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "pytest - fix scope in which doctests are run",
    "type": "issue",
    "updated_at": "2022-12-09T21:24:35Z",
    "url": "https://github.com/sagemath/sage/issues/33826",
    "user": "https://github.com/mkoeppe"
}
```
(from #33546)

When running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```

UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)


CC:  @tobiasdiez

Branch/Commit: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action) @ [92bbf1d](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**

Author: **Dima Pasechnik, Tobias Diez**

_Issue created by migration from https://trac.sagemath.org/ticket/33826_





---

archive/issue_events_445660.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445660"
}
```



---

archive/issue_events_445661.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445661"
}
```



---

archive/issue_events_445662.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445662"
}
```



---

archive/issue_events_445663.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:36:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445663"
}
```



---

archive/issue_comments_549995.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4290b111c4e89b03fbd01d4b6478ec41d5c4b142\">4290b11</a></td><td><code>Add pytest-xdist package</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62\">7df807e</a></td><td><code>Run pytest on github to see failing tests</code></td></tr></table>\n",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-549995",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4290b111c4e89b03fbd01d4b6478ec41d5c4b142">4290b11</a></td><td><code>Add pytest-xdist package</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62">7df807e</a></td><td><code>Run pytest on github to see failing tests</code></td></tr></table>




---

archive/issue_comments_549996.json:
```json
{
    "body": "Branch: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action)**",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-549996",
    "user": "https://github.com/tobiasdiez"
}
```

Branch: **[public/build/pytest-github-action](https://github.com/sagemath/sagetrac-mirror/tree/public/build/pytest-github-action)**



---

archive/issue_events_445664.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-14T09:58:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "title_is": "Metaticket: pytest - fix scope in which doctests are run",
    "title_was": "pytest: Fix scope in which doctests are run",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445664"
}
```



---

archive/issue_comments_549997.json:
```json
{
    "body": "Commit: **[7df807e](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)**",
    "created_at": "2022-05-14T09:58:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-549997",
    "user": "https://github.com/tobiasdiez"
}
```

Commit: **[7df807e](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)**



---

archive/issue_comments_549998.json:
```json
{
    "body": "Dependencies: **#33825**",
    "created_at": "2022-05-14T09:58:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-549998",
    "user": "https://github.com/tobiasdiez"
}
```

Dependencies: **#33825**



---

archive/issue_comments_549999.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e\">d3fdd95</a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8\">58e11d7</a></td><td><code>Fix checker and namespace injection</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686\">ff4056b</a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3\">e62c29b</a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a\">3ee9815</a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221\">f863428</a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144\">428a18c</a></td><td><code>Remove nonexisting paths from config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25\">cc19e92</a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb11eb9493e15ffb4c4e9c8c4ad13da69ffde9dd\">bb11eb9</a></td><td><code>Merge remote-tracking branch 'origin/public/tests/pytest_doctests' into public/build/pytest-github-action</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c\">5f78a38</a></td><td><code>Fix command</code></td></tr></table>\n",
    "created_at": "2022-05-15T09:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-549999",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:3'>Comment 3:</a>
Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e">d3fdd95</a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8">58e11d7</a></td><td><code>Fix checker and namespace injection</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686">ff4056b</a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3">e62c29b</a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a">3ee9815</a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221">f863428</a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144">428a18c</a></td><td><code>Remove nonexisting paths from config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25">cc19e92</a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb11eb9493e15ffb4c4e9c8c4ad13da69ffde9dd">bb11eb9</a></td><td><code>Merge remote-tracking branch 'origin/public/tests/pytest_doctests' into public/build/pytest-github-action</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c">5f78a38</a></td><td><code>Fix command</code></td></tr></table>




---

archive/issue_comments_550000.json:
```json
{
    "body": "Changed commit from **[7df807e](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)** to **[5f78a38](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)**",
    "created_at": "2022-05-15T09:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550000",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[7df807e](https://github.com/sagemath/sagetrac-mirror/commit/7df807ee2f29fc37693b10bc4117901cdd0aad62)** to **[5f78a38](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)**



---

archive/issue_comments_550001.json:
```json
{
    "body": "Changed dependencies from **#33825** to **#33825, #33546**",
    "created_at": "2022-05-15T09:21:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550001",
    "user": "https://github.com/tobiasdiez"
}
```

Changed dependencies from **#33825** to **#33825, #33546**



---

archive/issue_comments_550002.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad\">9aa5a42</a></td><td><code>Run in serial</code></td></tr></table>\n",
    "created_at": "2022-05-16T10:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550002",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:5'>Comment 5:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad">9aa5a42</a></td><td><code>Run in serial</code></td></tr></table>




---

archive/issue_comments_550003.json:
```json
{
    "body": "Changed commit from **[5f78a38](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)** to **[9aa5a42](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)**",
    "created_at": "2022-05-16T10:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550003",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5f78a38](https://github.com/sagemath/sagetrac-mirror/commit/5f78a38708f450d7ab24049548ce4f694569a48c)** to **[9aa5a42](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)**



---

archive/issue_events_445665.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445665"
}
```



---

archive/issue_events_445666.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445666"
}
```



---

archive/issue_comments_550004.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nthe issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n\nTrying to disable this via\n\n```diff\n--- a/src/tox.ini\n+++ b/src/tox.ini\n@@ -232,7 +232,7 @@ exclude =\n [pytest]\n python_files = *_test.py\n norecursedirs = local prefix venv build pkgs .git src/doc src/bin\n-addopts = --import-mode importlib\n+addopts = --import-mode importlib -p no:warnings\n doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS\n \n [coverage:run]\n\n```\ngives a bit more info:\n\n```\n...\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure\n__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________\n748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.\n749         If the list ``restrictions`` contains only one item, this\n750         item can be passed as such, i.e. writing ``x > y`` instead\n751         of the single element list ``[x > y]``.\n752 \n753         EXAMPLES::\n754 \n755             sage: M = Manifold(2, 'M', field='complex', structure='topological')\n756             sage: X.<x,y> = M.chart()\n757             sage: X.add_restrictions(abs(x) > 1)\nExpected:\n    doctest:warning...\n    DeprecationWarning: Chart.add_restrictions is deprecated; provide the\n    restrictions at the time of creating the chart\n    See https://trac.sagemath.org/32102 for details.\nGot nothing\n\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure\n------------------------------------------ Captured stderr call -------------------------------------------\n<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart\nSee https://trac.sagemath.org/32102 for details.\n  X.add_restrictions(abs(x) > Integer(1))\n...\n```\n\nNote `Captured stderr call` - this does not arise with the unchanged `tox.ini`.\n\nPerhaps the problem is in the way warning level is set in `deprecation()`, I don't know.",
    "created_at": "2022-12-07T11:29:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550004",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'>Comment 7:</a>
the issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html

Trying to disable this via

```diff
--- a/src/tox.ini
+++ b/src/tox.ini
@@ -232,7 +232,7 @@ exclude =
 [pytest]
 python_files = *_test.py
 norecursedirs = local prefix venv build pkgs .git src/doc src/bin
-addopts = --import-mode importlib
+addopts = --import-mode importlib -p no:warnings
 doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS
 
 [coverage:run]

```
gives a bit more info:

```
...
/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure
__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________
748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.
749         If the list ``restrictions`` contains only one item, this
750         item can be passed as such, i.e. writing ``x > y`` instead
751         of the single element list ``[x > y]``.
752 
753         EXAMPLES::
754 
755             sage: M = Manifold(2, 'M', field='complex', structure='topological')
756             sage: X.<x,y> = M.chart()
757             sage: X.add_restrictions(abs(x) > 1)
Expected:
    doctest:warning...
    DeprecationWarning: Chart.add_restrictions is deprecated; provide the
    restrictions at the time of creating the chart
    See https://trac.sagemath.org/32102 for details.
Got nothing

/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure
------------------------------------------ Captured stderr call -------------------------------------------
<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart
See https://trac.sagemath.org/32102 for details.
  X.add_restrictions(abs(x) > Integer(1))
...
```

Note `Captured stderr call` - this does not arise with the unchanged `tox.ini`.

Perhaps the problem is in the way warning level is set in `deprecation()`, I don't know.



---

archive/issue_comments_550005.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nWith vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.\nNote that Sage does it too, but in a trickier way.\n\n```python\n# c.py\nimport warnings\ndowarn = warnings.showwarning\ndef showwarn(message, category, filename, lineno, file=None, line=None):\n    import sys\n    dowarn(message, category, filename, lineno, sys.stdout, line)\n\nwarnings.showwarning = showwarn # use stdout instead of stderr\n\n\nclass tst:\n    \"\"\"\n    >>> len(tst.__subclasses__()) >= 0\n    True\n    >>> import warnings\n    >>> warnings.warn(\"foo\")\n    <doctest ...: UserWarning: foo\n      warnings.warn(\"foo\")\n    \"\"\"\n    pass\n```\n\nat least the above works:\n\n```\n$ pytest --doctest-modules -p no:warnings c.py\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0\nrootdir: /tmp\ncollected 1 item                                                                                         \n\nc.py .                                                                                             [100%]\n\n=========================================== 1 passed in 0.03s ============================================\n```\n\nIt's still not clear how to fix Sage's pytesting: I tried a similar hack with\nshowwarning in `src/sage/doctest/forker.py`, with the one in [comment:7](#comment%3A7), to no avail...",
    "created_at": "2022-12-07T14:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550005",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'>Comment 8:</a>
With vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.
Note that Sage does it too, but in a trickier way.

```python
# c.py
import warnings
dowarn = warnings.showwarning
def showwarn(message, category, filename, lineno, file=None, line=None):
    import sys
    dowarn(message, category, filename, lineno, sys.stdout, line)

warnings.showwarning = showwarn # use stdout instead of stderr


class tst:
    """
    >>> len(tst.__subclasses__()) >= 0
    True
    >>> import warnings
    >>> warnings.warn("foo")
    <doctest ...: UserWarning: foo
      warnings.warn("foo")
    """
    pass
```

at least the above works:

```
$ pytest --doctest-modules -p no:warnings c.py
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0
rootdir: /tmp
collected 1 item                                                                                         

c.py .                                                                                             [100%]

=========================================== 1 passed in 0.03s ============================================
```

It's still not clear how to fix Sage's pytesting: I tried a similar hack with
showwarning in `src/sage/doctest/forker.py`, with the one in [comment:7](#comment%3A7), to no avail...



---

archive/issue_comments_550006.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nI've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.",
    "created_at": "2022-12-07T16:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550006",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'>Comment 9:</a>
I've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.



---

archive/issue_comments_550007.json:
```json
{
    "body": "Changed commit from **[9aa5a42](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)** to **[92bbf1d](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**",
    "created_at": "2022-12-07T22:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550007",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9aa5a42](https://github.com/sagemath/sagetrac-mirror/commit/9aa5a424c80c4b7d09ea46dc15474dc27df4d7ad)** to **[92bbf1d](https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134)**



---

archive/issue_comments_550008.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/497d67aa5776df5c14d37e91ca0528778070ad0f\">497d67a</a></td><td><code>Run pytest on github to see failing tests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d9211e1d4b8e8101a90a2f0c501ec82152ee42be\">d9211e1</a></td><td><code>Fix command</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d474c3a1b9fa906a3939e049927c930e7faa7180\">d474c3a</a></td><td><code>Run in serial</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134\">92bbf1d</a></td><td><code>allow pytest to process deprecations in docstrings</code></td></tr></table>\n",
    "created_at": "2022-12-07T22:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550008",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'>Comment 10:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/497d67aa5776df5c14d37e91ca0528778070ad0f">497d67a</a></td><td><code>Run pytest on github to see failing tests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d9211e1d4b8e8101a90a2f0c501ec82152ee42be">d9211e1</a></td><td><code>Fix command</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d474c3a1b9fa906a3939e049927c930e7faa7180">d474c3a</a></td><td><code>Run in serial</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/92bbf1d28ed757f46de58cb0033f134500148134">92bbf1d</a></td><td><code>allow pytest to process deprecations in docstrings</code></td></tr></table>




---

archive/issue_comments_550009.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,4 +9,5 @@\n src/sage/manifolds/chart.py\n ```\n \n+UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)\n \n``````\n",
    "created_at": "2022-12-07T22:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550009",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,4 +9,5 @@
 src/sage/manifolds/chart.py
 ```
 
+UPDATE - deprecation warnings are OK, thanks to `92bbf1d` in [comment:10](#comment%3A10)
 
``````




---

archive/issue_comments_550010.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nRebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.",
    "created_at": "2022-12-07T22:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550010",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'>Comment 11:</a>
Rebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.



---

archive/issue_comments_550011.json:
```json
{
    "body": "Changed dependencies from **#33825, #33546** to none",
    "created_at": "2022-12-07T22:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550011",
    "user": "https://github.com/dimpase"
}
```

Changed dependencies from **#33825, #33546** to none



---

archive/issue_comments_550012.json:
```json
{
    "body": "Author: **Dima Pasechnik, ...**",
    "created_at": "2022-12-07T23:25:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550012",
    "user": "https://github.com/dimpase"
}
```

Author: **Dima Pasechnik, ...**



---

archive/issue_comments_550013.json:
```json
{
    "body": "Changed author from **Dima Pasechnik, ...** to **Dima Pasechnik, Tobias Diez**",
    "created_at": "2022-12-07T23:34:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550013",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Dima Pasechnik, ...** to **Dima Pasechnik, Tobias Diez**



---

archive/issue_events_445667.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-07T23:34:25Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "title_is": "pytest - fix scope in which doctests are run",
    "title_was": "Metaticket: pytest - fix scope in which doctests are run",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33826#event-445667"
}
```



---

archive/issue_comments_550014.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nhttps://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\nsays \"collected 0 items / 1 skipped\"",
    "created_at": "2022-12-07T23:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550014",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'>Comment 16:</a>
https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
says "collected 0 items / 1 skipped"



---

archive/issue_comments_550015.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [Matthias K\u00f6ppe](#comment%3A16):\n> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\n> says \"collected 0 items / 1 skipped\"\n\nnot caused by the latest commit: without it, or with it, the same problem:\n\n```\n=========================================== test session starts ===========================================\nplatform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0\nrootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items / 1 error                                                                               \n\n================================================= ERRORS ==================================================\n______________________________________ ERROR collecting test session ______________________________________\n/usr/lib64/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:972: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:986: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:680: in _load_unlocked\n    ???\n<frozen importlib._bootstrap_external>:850: in exec_module\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\nechelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>\n    raise IOError(\nE   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.\n========================================= short test summary info =========================================\nERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n============================================ 1 error in 5.96s =============================================\n```",
    "created_at": "2022-12-08T00:03:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550015",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [Matthias Köppe](#comment%3A16):
> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
> says "collected 0 items / 1 skipped"

not caused by the latest commit: without it, or with it, the same problem:

```
=========================================== test session starts ===========================================
platform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0
rootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items / 1 error                                                                               

================================================= ERRORS ==================================================
______________________________________ ERROR collecting test session ______________________________________
/usr/lib64/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:972: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:986: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:680: in _load_unlocked
    ???
<frozen importlib._bootstrap_external>:850: in exec_module
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
echelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>
    raise IOError(
E   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.
========================================= short test summary info =========================================
ERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================ 1 error in 5.96s =============================================
```



---

archive/issue_comments_550016.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nGoogle finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html\nto install matplotlib.\n\nindeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...",
    "created_at": "2022-12-08T00:27:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550016",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'>Comment 18:</a>
Google finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html
to install matplotlib.

indeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...



---

archive/issue_comments_550017.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nWhy do we even try to run tests of matplotlib? Can they be suppressed?",
    "created_at": "2022-12-08T00:40:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550017",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'>Comment 19:</a>
Why do we even try to run tests of matplotlib? Can they be suppressed?



---

archive/issue_comments_550018.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [Dima Pasechnik](#comment%3A19):\n> Why do we even try to run tests of matplotlib?\n\nIt's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there",
    "created_at": "2022-12-08T00:47:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550018",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [Dima Pasechnik](#comment%3A19):
> Why do we even try to run tests of matplotlib?

It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there



---

archive/issue_comments_550019.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [Matthias K\u00f6ppe](#comment%3A20):\n> Replying to [Dima Pasechnik](#comment%3A19):\n> > Why do we even try to run tests of matplotlib?\n\n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nwell, it's late here, and\n\nhttps://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile\n\nis quite a long read...",
    "created_at": "2022-12-08T01:17:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550019",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [Matthias Köppe](#comment%3A20):
> Replying to [Dima Pasechnik](#comment%3A19):
> > Why do we even try to run tests of matplotlib?

> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

well, it's late here, and

https://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile

is quite a long read...



---

archive/issue_comments_550020.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [Matthias K\u00f6ppe](#comment%3A20):\n> Replying to [Dima Pasechnik](#comment%3A19):\n> > Why do we even try to run tests of matplotlib?\n\n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nsome kind of trouble while discovering namespace packages to test. \n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items                                                                                        \n\n========================================= no tests ran in 0.01s ==========================================\nERROR: module or package not found: sage.misc (missing __init__.py?)\n```\n\nbut\n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 32 items / 1 skipped                                                                           \n\nsage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]\nsage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]\nsage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]\nsage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]\nsage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]\n...\n```\n\nthere is quite a bit on this in pytest github:\nhttps://github.com/pytest-dev/pytest/pull/1597\nclosing\nhttps://github.com/pytest-dev/pytest/issues/1567",
    "created_at": "2022-12-08T09:38:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550020",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [Matthias Köppe](#comment%3A20):
> Replying to [Dima Pasechnik](#comment%3A19):
> > Why do we even try to run tests of matplotlib?

> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

some kind of trouble while discovering namespace packages to test. 

```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items                                                                                        

========================================= no tests ran in 0.01s ==========================================
ERROR: module or package not found: sage.misc (missing __init__.py?)
```

but

```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 32 items / 1 skipped                                                                           

sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]
sage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]
sage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]
sage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]
sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]
...
```

there is quite a bit on this in pytest github:
https://github.com/pytest-dev/pytest/pull/1597
closing
https://github.com/pytest-dev/pytest/issues/1567



---

archive/issue_comments_550021.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nAlso note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.\n`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:\n\n```\npytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)\ndoctest:warning\n...\n```\nbut `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird\n\n```\n================================================= ERRORS =================================================\n_____________________________________ ERROR at setup of test_pickle ______________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531\n  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):\nE       fixture 'p' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531\n__________________________________ ERROR at setup of test_add_commutes ___________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162\n  @random_testing\n  def test_add_commutes(trials, verbose=False):\nE       fixture 'trials' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162\n...\n```",
    "created_at": "2022-12-08T10:24:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550021",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'>Comment 23:</a>
Also note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.
`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:

```
pytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)
doctest:warning
...
```
but `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird

```
================================================= ERRORS =================================================
_____________________________________ ERROR at setup of test_pickle ______________________________________
file /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531
  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):
E       fixture 'p' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531
__________________________________ ERROR at setup of test_add_commutes ___________________________________
file /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162
  @random_testing
  def test_add_commutes(trials, verbose=False):
E       fixture 'trials' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162
...
```



---

archive/issue_comments_550022.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nAnd bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :\n\n```\nPytest is unaware of pep420, nobody fixed that so far\n```",
    "created_at": "2022-12-08T10:26:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550022",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'>Comment 24:</a>
And bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :

```
Pytest is unaware of pep420, nobody fixed that so far
```



---

archive/issue_comments_550023.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nIndeed, this is very bad.",
    "created_at": "2022-12-08T17:24:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550023",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'>Comment 25:</a>
Indeed, this is very bad.



---

archive/issue_comments_550024.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nThe problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n\nIn Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n\nSo a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nFor upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.",
    "created_at": "2022-12-08T17:37:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550024",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'>Comment 26:</a>
The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.

In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)

So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

For upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.



---

archive/issue_comments_550025.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nReplying to [Matthias K\u00f6ppe](#comment%3A26):\n> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n> \n> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n> \n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nplease see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.\n\nOn https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.",
    "created_at": "2022-12-09T14:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550025",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'>Comment 27:</a>
Replying to [Matthias Köppe](#comment%3A26):
> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.
> 
> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)
> 
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

please see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.

On https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.



---

archive/issue_comments_550026.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nBy the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.",
    "created_at": "2022-12-09T17:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550026",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'>Comment 28:</a>
By the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.



---

archive/issue_comments_550027.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [Matthias K\u00f6ppe](#comment%3A26):\n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nA more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)",
    "created_at": "2022-12-09T17:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550027",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [Matthias Köppe](#comment%3A26):
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

A more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)



---

archive/issue_comments_550028.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nAnyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?",
    "created_at": "2022-12-09T21:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550028",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'>Comment 30:</a>
Anyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?



---

archive/issue_comments_550029.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nYes, I think so",
    "created_at": "2022-12-09T21:24:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33826#issuecomment-550029",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>Comment 31:</a>
Yes, I think so
