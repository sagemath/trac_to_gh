# Issue 33597: Wrong computation of Hilbert polynomials

archive/issues_033360.json:
```json
{
    "body": "\n```\nsage: R.<X, Y, Z> = QQ[]\nsage: I = R.ideal([X^2*Y^3, X*Z])\nsage: I.hilbert_polynomial()\n-t - 5\n```\nThe Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. The correct answer is ` t + 5 `, which is what one gets with the ` algorithm='singular' ` option.\n\nInspecting the code, it looks like the denominator of the Hilbert series is getting normalised wrongly in some cases.\n\nBranch/Commit: 98f118dc6595400d0c4667b006f426616e35ee91\n\nReviewer: Kwankyu Lee, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton, Kwankyu Lee\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33597\n\n",
    "closed_at": "2022-10-11T09:14:48Z",
    "created_at": "2022-03-30T07:37:42Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Wrong computation of Hilbert polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33597",
    "user": "https://github.com/loefflerd"
}
```

```
sage: R.<X, Y, Z> = QQ[]
sage: I = R.ideal([X^2*Y^3, X*Z])
sage: I.hilbert_polynomial()
-t - 5
```
The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. The correct answer is ` t + 5 `, which is what one gets with the ` algorithm='singular' ` option.

Inspecting the code, it looks like the denominator of the Hilbert series is getting normalised wrongly in some cases.

Branch/Commit: 98f118dc6595400d0c4667b006f426616e35ee91

Reviewer: Kwankyu Lee, Frédéric Chapoton

Author: Frédéric Chapoton, Kwankyu Lee

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33597





---

archive/issue_comments_669878.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n sage: I.hilbert_polynomial()\n -t - 5\n ```\n-The Hilbert polynomial is, by definition, a positive integer for all sufficiently large integers t, so this computation can't possibly be right. \n+The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. \n \n Inspecting the code suggests that the algorithm is silently assuming all the generators to be homogenous of degree 1. Fortunately there is an independent implementation `hilbert_polynomial(algorithm='singular')` which gives the right answer.\n \n``````\n",
    "created_at": "2022-03-30T07:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669878",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,7 @@
 sage: I.hilbert_polynomial()
 -t - 5
 ```
-The Hilbert polynomial is, by definition, a positive integer for all sufficiently large integers t, so this computation can't possibly be right. 
+The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. 
 
 Inspecting the code suggests that the algorithm is silently assuming all the generators to be homogenous of degree 1. Fortunately there is an independent implementation `hilbert_polynomial(algorithm='singular')` which gives the right answer.
 
``````




---

archive/issue_comments_669879.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,8 +5,6 @@\n sage: I.hilbert_polynomial()\n -t - 5\n ```\n-The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. \n+The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. The correct answer is ` t + 5 `, which is what one gets with the ` algorithm='singular' ` option.\n \n-Inspecting the code suggests that the algorithm is silently assuming all the generators to be homogenous of degree 1. Fortunately there is an independent implementation `hilbert_polynomial(algorithm='singular')` which gives the right answer.\n-\n-I am rather suspicious about the correctness of the \"hilbert_series\" method as well, which also seems to assume the generators have degree 1.\n+Inspecting the code, it looks like the denominator of the Hilbert series is getting normalised wrongly in some cases.\n``````\n",
    "created_at": "2022-03-30T08:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669879",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,8 +5,6 @@
 sage: I.hilbert_polynomial()
 -t - 5
 ```
-The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. 
+The Hilbert polynomial, by definition, has to take non-negative integer values at all sufficiently large integers t, so this computation can't possibly be right. The correct answer is ` t + 5 `, which is what one gets with the ` algorithm='singular' ` option.
 
-Inspecting the code suggests that the algorithm is silently assuming all the generators to be homogenous of degree 1. Fortunately there is an independent implementation `hilbert_polynomial(algorithm='singular')` which gives the right answer.
-
-I am rather suspicious about the correctness of the "hilbert_series" method as well, which also seems to assume the generators have degree 1.
+Inspecting the code, it looks like the denominator of the Hilbert series is getting normalised wrongly in some cases.
``````




---

archive/issue_events_088394.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33597#event-88394"
}
```



---

archive/issue_events_088395.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33597#event-88395"
}
```



---

archive/issue_events_088396.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33597#event-88396"
}
```



---

archive/issue_comments_669880.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/33597\"",
    "created_at": "2022-09-28T12:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669880",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/33597"



---

archive/issue_comments_669881.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-28T12:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669881",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_669882.json:
```json
{
    "body": "Changing author from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2022-09-28T12:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669882",
    "user": "https://github.com/fchapoton"
}
```

Changing author from "" to "Frédéric Chapoton"



---

archive/issue_comments_669883.json:
```json
{
    "body": "<a id='comment:5'></a>\nNew commits:\n|                                                                                                                                          |                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|\n|[51cb095](https://git.sagemath.org/sage.git/commit?id=51cb095bbe891fbaafd5b6aa26a795cd31abb366)|`fixes in Hilbert polynomial`|",
    "created_at": "2022-09-28T12:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669883",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
New commits:
|                                                                                                                                          |                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|
|[51cb095](https://git.sagemath.org/sage.git/commit?id=51cb095bbe891fbaafd5b6aa26a795cd31abb366)|`fixes in Hilbert polynomial`|



---

archive/issue_comments_669884.json:
```json
{
    "body": "Changing commit from \"\" to \"51cb095bbe891fbaafd5b6aa26a795cd31abb366\"",
    "created_at": "2022-09-28T12:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669884",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "51cb095bbe891fbaafd5b6aa26a795cd31abb366"



---

archive/issue_comments_669885.json:
```json
{
    "body": "<a id='comment:6'></a>\nbot is morally green, so please review",
    "created_at": "2022-09-28T14:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669885",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
bot is morally green, so please review



---

archive/issue_comments_669886.json:
```json
{
    "body": "Changing branch from \"u/chapoton/33597\" to \"u/klee/33597\"",
    "created_at": "2022-09-30T04:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669886",
    "user": "https://github.com/kwankyu"
}
```

Changing branch from "u/chapoton/33597" to "u/klee/33597"



---

archive/issue_comments_669887.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Kwankyu Lee\"",
    "created_at": "2022-09-30T04:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669887",
    "user": "https://github.com/kwankyu"
}
```

Changing reviewer from "" to "Kwankyu Lee"



---

archive/issue_comments_669888.json:
```json
{
    "body": "<a id='comment:8'></a>\nSorry for hijacking this ticket. I made a few modifications to the patch so that\n\n(1) we do not assume `denom[0]` can be only `-1`.\n\n(2) the code is a bit more efficient.\n\nBefore your patch\n\n```\nsage: R.<X, Y, Z> = QQ[]\nsage: I = R.ideal([X^2*Y^3, X*Z])\nsage: I.hilbert_polynomial() \nsage: I.hilbert_polynomial()\n-t - 5\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 409 \u03bcs per loop\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 416 \u03bcs per loop\n```\nAfter your patch\n\n```\nsage: R.<X, Y, Z> = QQ[]\nsage: I = R.ideal([X^2*Y^3, X*Z])\nsage: I.hilbert_polynomial()\nt + 5\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 299 \u03bcs per loop\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 298 \u03bcs per loop\n```\nAfter my modifications\n\n```\nsage: R.<X, Y, Z> = QQ[]\nsage: I = R.ideal([X^2*Y^3, X*Z])\nsage: I.hilbert_polynomial()\nt + 5\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 230 \u03bcs per loop\nsage: timeit('I.hilbert_polynomial()')\n625 loops, best of 3: 235 \u03bcs per loop\n```\n\nI am positive to the patch.",
    "created_at": "2022-09-30T04:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669888",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:8'></a>
Sorry for hijacking this ticket. I made a few modifications to the patch so that

(1) we do not assume `denom[0]` can be only `-1`.

(2) the code is a bit more efficient.

Before your patch

```
sage: R.<X, Y, Z> = QQ[]
sage: I = R.ideal([X^2*Y^3, X*Z])
sage: I.hilbert_polynomial() 
sage: I.hilbert_polynomial()
-t - 5
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 409 μs per loop
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 416 μs per loop
```
After your patch

```
sage: R.<X, Y, Z> = QQ[]
sage: I = R.ideal([X^2*Y^3, X*Z])
sage: I.hilbert_polynomial()
t + 5
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 299 μs per loop
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 298 μs per loop
```
After my modifications

```
sage: R.<X, Y, Z> = QQ[]
sage: I = R.ideal([X^2*Y^3, X*Z])
sage: I.hilbert_polynomial()
t + 5
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 230 μs per loop
sage: timeit('I.hilbert_polynomial()')
625 loops, best of 3: 235 μs per loop
```

I am positive to the patch.



---

archive/issue_comments_669889.json:
```json
{
    "body": "Changing commit from \"51cb095bbe891fbaafd5b6aa26a795cd31abb366\" to \"b8630ace295ff5b33fe4dd40e15ebeee9bd74263\"",
    "created_at": "2022-09-30T04:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669889",
    "user": "https://github.com/kwankyu"
}
```

Changing commit from "51cb095bbe891fbaafd5b6aa26a795cd31abb366" to "b8630ace295ff5b33fe4dd40e15ebeee9bd74263"



---

archive/issue_comments_669890.json:
```json
{
    "body": "Changing commit from \"b8630ace295ff5b33fe4dd40e15ebeee9bd74263\" to \"98f118dc6595400d0c4667b006f426616e35ee91\"",
    "created_at": "2022-09-30T04:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b8630ace295ff5b33fe4dd40e15ebeee9bd74263" to "98f118dc6595400d0c4667b006f426616e35ee91"



---

archive/issue_comments_669891.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------|\n|[98f118d](https://git.sagemath.org/sage.git/commit/?id=98f118dc6595400d0c4667b006f426616e35ee91)|`Minor edits`|",
    "created_at": "2022-09-30T04:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669891",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |             |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------|
|[98f118d](https://git.sagemath.org/sage.git/commit/?id=98f118dc6595400d0c4667b006f426616e35ee91)|`Minor edits`|



---

archive/issue_comments_669892.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-30T08:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669892",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_669893.json:
```json
{
    "body": "<a id='comment:10'></a>\nok, good to go, thanks",
    "created_at": "2022-09-30T08:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669893",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>
ok, good to go, thanks



---

archive/issue_comments_669894.json:
```json
{
    "body": "Changing reviewer from \"Kwankyu Lee\" to \"Kwankyu Lee, Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2022-09-30T08:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669894",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "Kwankyu Lee" to "Kwankyu Lee, Frédéric Chapoton"



---

archive/issue_comments_669895.json:
```json
{
    "body": "Changing author from \"Fr\u00e9d\u00e9ric Chapoton\" to \"Fr\u00e9d\u00e9ric Chapoton, Kwankyu Lee\"",
    "created_at": "2022-09-30T08:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669895",
    "user": "https://github.com/fchapoton"
}
```

Changing author from "Frédéric Chapoton" to "Frédéric Chapoton, Kwankyu Lee"



---

archive/issue_comments_669896.json:
```json
{
    "body": "<a id='comment:11'></a>\nThank you!",
    "created_at": "2022-09-30T22:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669896",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:11'></a>
Thank you!



---

archive/issue_events_088397.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-10-11T09:14:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33597#event-88397"
}
```



---

archive/issue_comments_669897.json:
```json
{
    "body": "Changing branch from \"u/klee/33597\" to \"98f118dc6595400d0c4667b006f426616e35ee91\"",
    "created_at": "2022-10-11T09:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669897",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/klee/33597" to "98f118dc6595400d0c4667b006f426616e35ee91"



---

archive/issue_comments_669898.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-10-11T09:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33597#issuecomment-669898",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
