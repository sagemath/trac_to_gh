# Issue 33228: implement elliptic-curve point addition for general rings

archive/issues_032991.json:
```json
{
    "body": "Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch implements point arithmetic for `EllipticCurvePoint`, while also keeping the specialized (faster) implementation for fields. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).\n\nAnother implication of this is that we can remove part of the \"temporary\" hack for elliptic-curve points over \u2124/n that was introduced in #1975.\n\nCC:  @JohnCremona @roed314 @edgarcosta @alexjbest\n\nAuthor: Lorenz Panny\n\nBranch: public/generalize_elliptic_curve_point_addition_to_rings\n\nStatus: needs_work\n\nDependencies: #34417, #34463\n\nCommit: 940f8a20c63609f6a2c74fe8ba7e76801f6a2022\n\nIssue created by migration from https://trac.sagemath.org/ticket/33228\n\n",
    "created_at": "2022-01-25T05:42:03Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "implement elliptic-curve point addition for general rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33228",
    "user": "https://github.com/yyyyx4"
}
```
Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch implements point arithmetic for `EllipticCurvePoint`, while also keeping the specialized (faster) implementation for fields. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).

Another implication of this is that we can remove part of the "temporary" hack for elliptic-curve points over ℤ/n that was introduced in #1975.

CC:  @JohnCremona @roed314 @edgarcosta @alexjbest

Author: Lorenz Panny

Branch: public/generalize_elliptic_curve_point_addition_to_rings

Status: needs_work

Dependencies: #34417, #34463

Commit: 940f8a20c63609f6a2c74fe8ba7e76801f6a2022

Issue created by migration from https://trac.sagemath.org/ticket/33228





---

archive/issue_comments_663000.json:
```json
{
    "body": "<a id='comment:1'></a>some failing doctests, see patchbot report",
    "created_at": "2022-01-25T19:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663000",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>some failing doctests, see patchbot report



---

archive/issue_comments_663001.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-26T05:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663001",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_663002.json:
```json
{
    "body": "Changing commit from \"4d67190918a8e1304b32643d9c8d261b815f11cf\" to \"915b72585a0973528a11f65c741df19f189138e8\"",
    "created_at": "2022-01-26T05:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4d67190918a8e1304b32643d9c8d261b815f11cf" to "915b72585a0973528a11f65c741df19f189138e8"



---

archive/issue_comments_663003.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-27T03:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663003",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_663004.json:
```json
{
    "body": "<a id='comment:4'></a>Elliptic gurus, please say your word on these changes!",
    "created_at": "2022-02-02T20:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663004",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>Elliptic gurus, please say your word on these changes!



---

archive/issue_comments_663005.json:
```json
{
    "body": "<a id='comment:5'></a>This is interesting -- as well as being the author of the \"temporary hack\", I also came across this issue when trying to implement Schoof's algorithm from basics wih a student.  I'll take a look.",
    "created_at": "2022-02-02T20:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663005",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:5'></a>This is interesting -- as well as being the author of the "temporary hack", I also came across this issue when trying to implement Schoof's algorithm from basics wih a student.  I'll take a look.



---

archive/issue_comments_663006.json:
```json
{
    "body": "<a id='comment:7'></a>In case you are interested, Alex Best corrected some typos Bosma\u2013Lenstra paper formulas for addition law for elliptic curves over a general ring, see Appendix A of https://open.bu.edu/bitstream/handle/2144/43150/Best_bu_0017E_16371.pdf\n\nI bet he must have them implemented somewhere...",
    "created_at": "2022-02-02T21:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663006",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:7'></a>In case you are interested, Alex Best corrected some typos Bosma–Lenstra paper formulas for addition law for elliptic curves over a general ring, see Appendix A of https://open.bu.edu/bitstream/handle/2144/43150/Best_bu_0017E_16371.pdf

I bet he must have them implemented somewhere...



---

archive/issue_comments_663007.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 edgarcosta]:\n> In case you are interested, Alex Best corrected some typos Bosma\u2013Lenstra paper formulas for addition law for elliptic curves over a general ring, see Appendix A of https://open.bu.edu/bitstream/handle/2144/43150/Best_bu_0017E_16371.pdf\n\n\nInteresting, thanks! Generalizing the formulas to not fail when non-units are encountered was a next step on my list (and the original motivation to move `+` up in the class hierarchy). I'll try this out as soon as I find time.\n\nReplying to [comment:5 cremona]:\n> This is interesting -- as well as being the author of the \"temporary hack\", I also came across this issue when trying to implement Schoof's algorithm from basics wih a student.  I'll take a look.\n\n\nSadly, this change alone does not yet allow implementing a straightforward Schoof (e.g., because the current addition formulas attempt to divide by zero divisors rather frequently in that context). But we'll get there! :-)",
    "created_at": "2022-02-03T04:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663007",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:8'></a>Replying to [comment:7 edgarcosta]:
> In case you are interested, Alex Best corrected some typos Bosma–Lenstra paper formulas for addition law for elliptic curves over a general ring, see Appendix A of https://open.bu.edu/bitstream/handle/2144/43150/Best_bu_0017E_16371.pdf


Interesting, thanks! Generalizing the formulas to not fail when non-units are encountered was a next step on my list (and the original motivation to move `+` up in the class hierarchy). I'll try this out as soon as I find time.

Replying to [comment:5 cremona]:
> This is interesting -- as well as being the author of the "temporary hack", I also came across this issue when trying to implement Schoof's algorithm from basics wih a student.  I'll take a look.


Sadly, this change alone does not yet allow implementing a straightforward Schoof (e.g., because the current addition formulas attempt to divide by zero divisors rather frequently in that context). But we'll get there! :-)



---

archive/issue_comments_663008.json:
```json
{
    "body": "<a id='comment:9'></a>I reealise that it may be annoying to make comments about chunks of code which were just copied over but I would change the lines\n\n```\n        x1, y1 = self[0], self[1]\n        x2, y2 = right[0], right[1]\n        if x1 == x2 and y1 == -y2 - a1*x2 - a3:\n```\nto\n\n```\n        x1, y1, _ = self\n        x2, y2, _ = right\n        if x1 == x2 and y1 != y2:\n```\nwhere the first two are just python while the 3rd is simpler and mathematically equivalent.\n\nHowever, are you sure that the z-coordinate will always be 1 for nonzero points over non-fields?  I will keep reading...",
    "created_at": "2022-02-03T10:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663008",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>I reealise that it may be annoying to make comments about chunks of code which were just copied over but I would change the lines

```
        x1, y1 = self[0], self[1]
        x2, y2 = right[0], right[1]
        if x1 == x2 and y1 == -y2 - a1*x2 - a3:
```
to

```
        x1, y1, _ = self
        x2, y2, _ = right
        if x1 == x2 and y1 != y2:
```
where the first two are just python while the 3rd is simpler and mathematically equivalent.

However, are you sure that the z-coordinate will always be 1 for nonzero points over non-fields?  I will keep reading...



---

archive/issue_comments_663009.json:
```json
{
    "body": "<a id='comment:10'></a>Another simplification:  after the preceding check, if x1==x2 then also y1==y2 (unless you do not want me to assume that quadratics over non-fields have no more than 2 roots, in which case my previous suggestion may not be valid either):\n\n```\n    if x1==x2:\n       num = 3*x1*x1 + 2*a2*x1 + a4 - a1*y1\n       den = 2*y1 + a1*x1 + a3\n    else:\n       num = y1-y2\n       den = x1-x2\n   try:\n      m = num/den\n   except ZeroDivisionError:\n              R = E.base_ring()\n              if R.is_finite():\n                  N = R.characteristic()\n                  N1 = N.gcd(Integer(den))\n                  N2 = N//N1\n                  raise ZeroDivisionError(\"Inverse of %s does not exist (characteristic = %s = %s*%s)\" % (den, N, N1, N2))\n              else:\n                   raise ZeroDivisionError(\"Inverse of %s does not exist\" % (den))\n```\n\nApart from these (which I know don't have much to do with your chenges) I think this looks good.  Can you add at least one test to show that what used to work (over Z/NZ say) still does, and also something which used not to work but now does?",
    "created_at": "2022-02-03T10:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663009",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>Another simplification:  after the preceding check, if x1==x2 then also y1==y2 (unless you do not want me to assume that quadratics over non-fields have no more than 2 roots, in which case my previous suggestion may not be valid either):

```
    if x1==x2:
       num = 3*x1*x1 + 2*a2*x1 + a4 - a1*y1
       den = 2*y1 + a1*x1 + a3
    else:
       num = y1-y2
       den = x1-x2
   try:
      m = num/den
   except ZeroDivisionError:
              R = E.base_ring()
              if R.is_finite():
                  N = R.characteristic()
                  N1 = N.gcd(Integer(den))
                  N2 = N//N1
                  raise ZeroDivisionError("Inverse of %s does not exist (characteristic = %s = %s*%s)" % (den, N, N1, N2))
              else:
                   raise ZeroDivisionError("Inverse of %s does not exist" % (den))
```

Apart from these (which I know don't have much to do with your chenges) I think this looks good.  Can you add at least one test to show that what used to work (over Z/NZ say) still does, and also something which used not to work but now does?



---

archive/issue_comments_663010.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-13T01:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663010",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_087761.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33228#event-87761"
}
```



---

archive/issue_comments_663011.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663011",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_087762.json:
```json
{
    "actor": "https://github.com/yyyyx4",
    "created_at": "2022-08-24T09:24:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33228#event-87762"
}
```



---

archive/issue_events_087763.json:
```json
{
    "actor": "https://github.com/yyyyx4",
    "created_at": "2022-08-24T09:24:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33228#event-87763"
}
```



---

archive/issue_comments_663012.json:
```json
{
    "body": "Changing commit from \"915b72585a0973528a11f65c741df19f189138e8\" to \"2b4509e26049d07efadb6706c0c064253f6ce8dc\"",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663012",
    "user": "https://github.com/yyyyx4"
}
```

Changing commit from "915b72585a0973528a11f65c741df19f189138e8" to "2b4509e26049d07efadb6706c0c064253f6ce8dc"



---

archive/issue_comments_663013.json:
```json
{
    "body": "<a id='comment:13'></a>I've included Alex' version of the Bosma-Lenstra formulas to compute point additions over fairly general rings. One thing I'm not quite sure about is how to combine the results of the two formulas in case neither gives a valid projective point \u2014 in the current code, this is done by brute-forcing random linear combinations, but there must be a more algebraic way. (It's fairly straightforward for B\u00e9zout rings.)\n\n---\nNew commits:",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663013",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:13'></a>I've included Alex' version of the Bosma-Lenstra formulas to compute point additions over fairly general rings. One thing I'm not quite sure about is how to combine the results of the two formulas in case neither gives a valid projective point — in the current code, this is done by brute-forcing random linear combinations, but there must be a more algebraic way. (It's fairly straightforward for Bézout rings.)

---
New commits:



---

archive/issue_comments_663014.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch moves it up to `EllipticCurvePoint`. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).\n+Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch implements point arithmetic for `EllipticCurvePoint`, while also keeping the specialized (faster) implementation for fields. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).\n \n Another implication of this is that we can remove part of the \"temporary\" hack for elliptic-curve points over \u2124/n that was introduced in #1975.\n \n``````\n",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663014",
    "user": "https://github.com/yyyyx4"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch moves it up to `EllipticCurvePoint`. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).
+Currently, point addition for elliptic curves is only defined in `EllipticCurvePoint_field` and its children. This patch implements point arithmetic for `EllipticCurvePoint`, while also keeping the specialized (faster) implementation for fields. This is useful for symbolic computations, such as the ones that show up in a basic version of Schoof's algorithm (where we compute in a polynomial ring modulo the ideal generated by a division polynomial and the curve equation).
 
 Another implication of this is that we can remove part of the "temporary" hack for elliptic-curve points over ℤ/n that was introduced in #1975.
 
``````




---

archive/issue_comments_663015.json:
```json
{
    "body": "Changing branch from \"public/move_elliptic_curve_point_addition_to_parent\" to \"public/generalize_elliptic_curve_point_addition_to_rings\"",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663015",
    "user": "https://github.com/yyyyx4"
}
```

Changing branch from "public/move_elliptic_curve_point_addition_to_parent" to "public/generalize_elliptic_curve_point_addition_to_rings"



---

archive/issue_comments_663016.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#34417\"",
    "created_at": "2022-08-24T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663016",
    "user": "https://github.com/yyyyx4"
}
```

Changing dependencies from "" to "#34417"



---

archive/issue_comments_663017.json:
```json
{
    "body": "<a id='comment:14'></a>Looks pretty good to me.  Here are some questions/suggestions.\n\n* Are there other cases where we can use simpler formulas?  For example, over a Euclidean domain you could use the field-formula and then clear denominators.  And over Z/N you could try to use the field-formula and only fall back on the more general one when you hit a zero divisor.  I haven't done any profiling, but the general formula looks pretty slow, so this change will probably slow down any toy ECM implementations out there.\n* Relatedly, I'm not sure exactly how to handle deprecation warnings for this change.  Making arithmetic work when it didn't before is great, but this is one of the few cases where people may be relying on having a `ZeroDivisionError` rather than getting an actual point out.  I know that my ECM demos would break with this change.  Perhaps one way forward would be to print a deprecation warning whenever someone does arithmetic on an elliptic curve over Z/N with a pointer to this ticket so that at least they understand what has changed when their code just runs forever (as it might if they just do things until catching a `ZeroDivisionError`).\n\nI'll also give John Cremona a chance to take a look at this, since he was commenting on an earlier version.",
    "created_at": "2022-08-24T17:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663017",
    "user": "https://github.com/roed314"
}
```

<a id='comment:14'></a>Looks pretty good to me.  Here are some questions/suggestions.

* Are there other cases where we can use simpler formulas?  For example, over a Euclidean domain you could use the field-formula and then clear denominators.  And over Z/N you could try to use the field-formula and only fall back on the more general one when you hit a zero divisor.  I haven't done any profiling, but the general formula looks pretty slow, so this change will probably slow down any toy ECM implementations out there.
* Relatedly, I'm not sure exactly how to handle deprecation warnings for this change.  Making arithmetic work when it didn't before is great, but this is one of the few cases where people may be relying on having a `ZeroDivisionError` rather than getting an actual point out.  I know that my ECM demos would break with this change.  Perhaps one way forward would be to print a deprecation warning whenever someone does arithmetic on an elliptic curve over Z/N with a pointer to this ticket so that at least they understand what has changed when their code just runs forever (as it might if they just do things until catching a `ZeroDivisionError`).

I'll also give John Cremona a chance to take a look at this, since he was commenting on an earlier version.



---

archive/issue_comments_663018.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks for your comments.\n\n- Indeed, some quick experiments suggest a \u224810\u00d7 slowdown. Perhaps we should try to adapt the standard formulas to quotients of Euclidean domains? This would cover both of your examples, and more.\n\n- Getting the `ZeroDivisionError` back should be achievable by explicitly constructing an `EllipticCurvePoint_field(E, ...)` rather than using `E.point(...)`. The standard `ZeroDivisionError` error message is slightly less well-adjusted to the ECM use case, but it does contain the relevant non-unit so you can still easily factor the modulus from the exception string. Is this what we should recommend to users in a warning?",
    "created_at": "2022-08-25T04:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663018",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:15'></a>Thanks for your comments.

- Indeed, some quick experiments suggest a ≈10× slowdown. Perhaps we should try to adapt the standard formulas to quotients of Euclidean domains? This would cover both of your examples, and more.

- Getting the `ZeroDivisionError` back should be achievable by explicitly constructing an `EllipticCurvePoint_field(E, ...)` rather than using `E.point(...)`. The standard `ZeroDivisionError` error message is slightly less well-adjusted to the ECM use case, but it does contain the relevant non-unit so you can still easily factor the modulus from the exception string. Is this what we should recommend to users in a warning?



---

archive/issue_comments_663019.json:
```json
{
    "body": "<a id='comment:16'></a>Since I was asked, I'll comment.  Two points:\n\n1. I myself have no need to ever try to define elliptic curves over general rings.  The reason I put in the hack which pretended that elliptic curves over `\\ZZ/N` were elliptic curves over fields, was to enable a simple-minded ECM to work for teaching purposes, making sure that the error message produced, when zero-divisors were encountered, displayed the nontrivial factor of `N`.  And I did this after a complaint by Ken Ribet (eminent mathematician and AMS President 2017-2018) that the Sage code he used to teach exactly this to undergraduates at Berkeley no longer worked.  It's a very good thing to have such people promoting Sage.\n\n\nI think it could work to have some parameter to the elliptic curve constructor like `assume_base_ring_is_field`, which by default is `False`, but which could be set to `True` for this precise purpose -- with some doctests to show exactly how this could be used for such a simple ECM implementation.  In (just about) all other situations, the default would do the mathematically correct thing.\n\n2.  Secondly, it is **unacceptable** to have a 10* slowdown for point operations over fields!  The vast majority of point operations would be over fields.  Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?",
    "created_at": "2022-08-25T08:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663019",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:16'></a>Since I was asked, I'll comment.  Two points:

1. I myself have no need to ever try to define elliptic curves over general rings.  The reason I put in the hack which pretended that elliptic curves over `\ZZ/N` were elliptic curves over fields, was to enable a simple-minded ECM to work for teaching purposes, making sure that the error message produced, when zero-divisors were encountered, displayed the nontrivial factor of `N`.  And I did this after a complaint by Ken Ribet (eminent mathematician and AMS President 2017-2018) that the Sage code he used to teach exactly this to undergraduates at Berkeley no longer worked.  It's a very good thing to have such people promoting Sage.


I think it could work to have some parameter to the elliptic curve constructor like `assume_base_ring_is_field`, which by default is `False`, but which could be set to `True` for this precise purpose -- with some doctests to show exactly how this could be used for such a simple ECM implementation.  In (just about) all other situations, the default would do the mathematically correct thing.

2.  Secondly, it is **unacceptable** to have a 10* slowdown for point operations over fields!  The vast majority of point operations would be over fields.  Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?



---

archive/issue_comments_663020.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 cremona]:\n> Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?\n\n\nOf course; the patch does it like this already. The 10\u00d7 difference is between the field-specific formulas and the general formulas, not between before and after. The only case which is now slower (but more correct!) than before is `\u2124/n` for composite `n`.",
    "created_at": "2022-08-25T11:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663020",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:17'></a>Replying to [comment:16 cremona]:
> Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?


Of course; the patch does it like this already. The 10× difference is between the field-specific formulas and the general formulas, not between before and after. The only case which is now slower (but more correct!) than before is `ℤ/n` for composite `n`.



---

archive/issue_comments_663021.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 lorenz]:\n> Replying to [comment:16 cremona]:\n> > Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?\n\n> \n> Of course; the patch does it like this already. The 10\u00d7 difference is between the field-specific formulas and the general formulas, not between before and after. The only case which is now slower (but more correct!) than before is `\u2124/n` for composite `n`.\n\n\nThanks for clarifying (and I know that I could also have looked at the code, but it is good to have this stated explicitly on the ticket).\n\nThis deals with my second point, at least!",
    "created_at": "2022-08-25T11:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663021",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:18'></a>Replying to [comment:17 lorenz]:
> Replying to [comment:16 cremona]:
> > Surely the thing to do would be to put in the generic stuff introduced here for `EllipticCurvePoint`, while keeping the old field-only code (or whatever is fastest over fields) for the class `EllipticCurvePoint_field`?

> 
> Of course; the patch does it like this already. The 10× difference is between the field-specific formulas and the general formulas, not between before and after. The only case which is now slower (but more correct!) than before is `ℤ/n` for composite `n`.


Thanks for clarifying (and I know that I could also have looked at the code, but it is good to have this stated explicitly on the ticket).

This deals with my second point, at least!



---

archive/issue_comments_663022.json:
```json
{
    "body": "<a id='comment:19'></a>Two plugin issues:\n\n* There's a pyflakes error: `src/sage/schemes/elliptic_curves/ell_generic.py:56:1 'sage.rings.abc' imported but unused`\n* The `add` function in `addition_formulas_ring.py` needs doctests.\n\nThere's also a doctest failure:\n\n```\nFile \"src/sage/schemes/elliptic_curves/ell_point.py\", line 214, in sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint._add_\nFailed example:\n    for d in N.divisors():\n        if d > 1:\n            assert R.change_ring(Zmod(d)) == P.change_ring(Zmod(d)) + Q.change_ring(Zmod(d))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/sage-patchbot/sage/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/sage-patchbot/sage/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint._add_[14]>\", line 3, in <module>\n        assert R.change_ring(Zmod(d)) == P.change_ring(Zmod(d)) + Q.change_ring(Zmod(d))\n      File \"/home/sage-patchbot/sage/src/sage/schemes/generic/morphism.py\", line 1977, in change_ring\n        return S.point(Q, check=check)\n      File \"/home/sage-patchbot/sage/src/sage/schemes/projective/projective_subscheme.py\", line 122, in point\n        return self._point(self.point_homset(), v, check=check)\n      File \"/home/sage-patchbot/sage/src/sage/schemes/projective/projective_point.py\", line 203, in __init__\n        X.extended_codomain()._check_satisfies_equations(v)\n      File \"/home/sage-patchbot/sage/src/sage/schemes/generic/algebraic_scheme.py\", line 984, in _check_satisfies_equations\n        raise TypeError(\"Coordinates %s do not define a point on %s\"%(coords,self))\n    TypeError: Coordinates [60, 58, 13] do not define a point on Elliptic Curve defined by y^2 + 40*x*y + 12*y = x^3 + 57*x^2 + 76*x + 55 over Ring of integers modulo 87\n```",
    "created_at": "2022-08-29T17:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663022",
    "user": "https://github.com/roed314"
}
```

<a id='comment:19'></a>Two plugin issues:

* There's a pyflakes error: `src/sage/schemes/elliptic_curves/ell_generic.py:56:1 'sage.rings.abc' imported but unused`
* The `add` function in `addition_formulas_ring.py` needs doctests.

There's also a doctest failure:

```
File "src/sage/schemes/elliptic_curves/ell_point.py", line 214, in sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint._add_
Failed example:
    for d in N.divisors():
        if d > 1:
            assert R.change_ring(Zmod(d)) == P.change_ring(Zmod(d)) + Q.change_ring(Zmod(d))
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint._add_[14]>", line 3, in <module>
        assert R.change_ring(Zmod(d)) == P.change_ring(Zmod(d)) + Q.change_ring(Zmod(d))
      File "/home/sage-patchbot/sage/src/sage/schemes/generic/morphism.py", line 1977, in change_ring
        return S.point(Q, check=check)
      File "/home/sage-patchbot/sage/src/sage/schemes/projective/projective_subscheme.py", line 122, in point
        return self._point(self.point_homset(), v, check=check)
      File "/home/sage-patchbot/sage/src/sage/schemes/projective/projective_point.py", line 203, in __init__
        X.extended_codomain()._check_satisfies_equations(v)
      File "/home/sage-patchbot/sage/src/sage/schemes/generic/algebraic_scheme.py", line 984, in _check_satisfies_equations
        raise TypeError("Coordinates %s do not define a point on %s"%(coords,self))
    TypeError: Coordinates [60, 58, 13] do not define a point on Elliptic Curve defined by y^2 + 40*x*y + 12*y = x^3 + 57*x^2 + 76*x + 55 over Ring of integers modulo 87
```



---

archive/issue_comments_663023.json:
```json
{
    "body": "<a id='comment:20'></a>Adapting the standard formulas to quotients of Euclidean domains seems reasonable.",
    "created_at": "2022-08-29T17:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663023",
    "user": "https://github.com/roed314"
}
```

<a id='comment:20'></a>Adapting the standard formulas to quotients of Euclidean domains seems reasonable.



---

archive/issue_comments_663024.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-09-13T09:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_663025.json:
```json
{
    "body": "Changing commit from \"2b4509e26049d07efadb6706c0c064253f6ce8dc\" to \"940f8a20c63609f6a2c74fe8ba7e76801f6a2022\"",
    "created_at": "2022-09-13T09:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663025",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2b4509e26049d07efadb6706c0c064253f6ce8dc" to "940f8a20c63609f6a2c74fe8ba7e76801f6a2022"



---

archive/issue_comments_663026.json:
```json
{
    "body": "<a id='comment:22'></a>I had a shot at adapting the standard formulas to quotients of Euclidean domains.\n\nPerformance comparison for a single point addition modulo `2^127-1`:\n\n```\nfield-specific code:  625 loops, best of 3: 21.8 \u03bcs per loop\nEuclidean quotients:  625 loops, best of 3: 37.8 \u03bcs per loop\ngeneric formulas:     625 loops, best of 3: 123 \u03bcs per loop\n```\n\nI think we don't need to add another hack to the `EllipticCurve` constructor for this because `Zmod` already has one that does the trick:\n\n```sage\nsage: R = Zmod(13 * 17, is_field=True)\nsage: E = EllipticCurve(R, [1,0])\nsage: P = E.lift_x(4)\nsage: 123*P\nTraceback (most recent call last):\n...\nZeroDivisionError: inverse of Mod(34, 221) does not exist\n```\n\nReplying to [comment:19 David Roe]:\n> There's also a doctest failure:\n> \n> \n> ```\n>     TypeError: Coordinates [60, 58, 13] do not define a point on Elliptic Curve defined by y^2 + 40*x*y + 12*y = x^3 + 57*x^2 + 76*x + 55 over Ring of integers modulo 87\n> ```\n\n\nThat's #34417.",
    "created_at": "2022-09-13T10:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663026",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:22'></a>I had a shot at adapting the standard formulas to quotients of Euclidean domains.

Performance comparison for a single point addition modulo `2^127-1`:

```
field-specific code:  625 loops, best of 3: 21.8 μs per loop
Euclidean quotients:  625 loops, best of 3: 37.8 μs per loop
generic formulas:     625 loops, best of 3: 123 μs per loop
```

I think we don't need to add another hack to the `EllipticCurve` constructor for this because `Zmod` already has one that does the trick:

```sage
sage: R = Zmod(13 * 17, is_field=True)
sage: E = EllipticCurve(R, [1,0])
sage: P = E.lift_x(4)
sage: 123*P
Traceback (most recent call last):
...
ZeroDivisionError: inverse of Mod(34, 221) does not exist
```

Replying to [comment:19 David Roe]:
> There's also a doctest failure:
> 
> 
> ```
>     TypeError: Coordinates [60, 58, 13] do not define a point on Elliptic Curve defined by y^2 + 40*x*y + 12*y = x^3 + 57*x^2 + 76*x + 55 over Ring of integers modulo 87
> ```


That's #34417.



---

archive/issue_comments_663027.json:
```json
{
    "body": "Changing dependencies from \"#34417\" to \"#34417, #34463\"",
    "created_at": "2022-09-13T10:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663027",
    "user": "https://github.com/yyyyx4"
}
```

Changing dependencies from "#34417" to "#34417, #34463"



---

archive/issue_comments_663028.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 Lorenz Panny]:\n> I think we don't need to add another hack to the `EllipticCurve` constructor for this because `Zmod` already has one that does the trick:\n> \n> \n> ```sage\n> sage: R = Zmod(13 * 17, is_field=True)\n> sage: E = EllipticCurve(R, [1,0])\n> sage: P = E.lift_x(4)\n> sage: 123*P\n> Traceback (most recent call last):\n> ...\n> ZeroDivisionError: inverse of Mod(34, 221) does not exist\n> ```\n\n\n\nThat's nice, however:\n\n```sage\nsage: E = EllipticCurve(Zmod(35, is_field=True), [5,1])\nsage: E.base_field()\n...\nAttributeError: 'EllipticCurve_generic_with_category' object has no attribute 'base_field'\n```\nin fact\n\n```sage\nsage: parent(E)\n<class 'sage.schemes.elliptic_curves.ell_generic.EllipticCurve_generic_with_category'>\n```\nso it would still need \"the hack\" (broken as of 9.6 and fixed in #34681).\nCompare to\n\n```sage\nsage: parent(EllipticCurve(Zmod(7, is_field=True), [5,1]))\n<class 'sage.schemes.elliptic_curves.ell_finite_field.EllipticCurve_finite_field_with_category'>\n```\n\nActually:\n\n```sage\nsage: Zmod(35, is_field=True).is_field()\nFalse\n```\nso, what's the effect of `is_field=True`?",
    "created_at": "2022-10-21T13:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663028",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:23'></a>Replying to [comment:22 Lorenz Panny]:
> I think we don't need to add another hack to the `EllipticCurve` constructor for this because `Zmod` already has one that does the trick:
> 
> 
> ```sage
> sage: R = Zmod(13 * 17, is_field=True)
> sage: E = EllipticCurve(R, [1,0])
> sage: P = E.lift_x(4)
> sage: 123*P
> Traceback (most recent call last):
> ...
> ZeroDivisionError: inverse of Mod(34, 221) does not exist
> ```



That's nice, however:

```sage
sage: E = EllipticCurve(Zmod(35, is_field=True), [5,1])
sage: E.base_field()
...
AttributeError: 'EllipticCurve_generic_with_category' object has no attribute 'base_field'
```
in fact

```sage
sage: parent(E)
<class 'sage.schemes.elliptic_curves.ell_generic.EllipticCurve_generic_with_category'>
```
so it would still need "the hack" (broken as of 9.6 and fixed in #34681).
Compare to

```sage
sage: parent(EllipticCurve(Zmod(7, is_field=True), [5,1]))
<class 'sage.schemes.elliptic_curves.ell_finite_field.EllipticCurve_finite_field_with_category'>
```

Actually:

```sage
sage: Zmod(35, is_field=True).is_field()
False
```
so, what's the effect of `is_field=True`?



---

archive/issue_comments_663029.json:
```json
{
    "body": "<a id='comment:24'></a>Also, this is potentially dangerous:\n\n```sage\nsage: Zmod(35, is_field=True) is Zmod(35, is_field=False)\nTrue\n```\n\nThis means the example above works after clearing the cache:\n\n```sage\nsage: Zmod._cache.clear()\nsage: E = EllipticCurve(Zmod(35, is_field=True), [5,1])\nsage: E.base_field()\nRing of integers modulo 35\n```\n\nBut then one might get a scary error message\n\n```sage\nsage: Zmod(35).is_field(proof=True)\n...\nValueError: THIS SAGE SESSION MIGHT BE SERIOUSLY COMPROMISED!\nThe order 35 is not prime, but this ring has been put\ninto the category of fields. This may already have consequences\nin other parts of Sage. Either it was a mistake of the user,\nor a probabilistic primality test has failed.\nIn the latter case, please inform the developers.\n```",
    "created_at": "2022-10-21T13:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663029",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:24'></a>Also, this is potentially dangerous:

```sage
sage: Zmod(35, is_field=True) is Zmod(35, is_field=False)
True
```

This means the example above works after clearing the cache:

```sage
sage: Zmod._cache.clear()
sage: E = EllipticCurve(Zmod(35, is_field=True), [5,1])
sage: E.base_field()
Ring of integers modulo 35
```

But then one might get a scary error message

```sage
sage: Zmod(35).is_field(proof=True)
...
ValueError: THIS SAGE SESSION MIGHT BE SERIOUSLY COMPROMISED!
The order 35 is not prime, but this ring has been put
into the category of fields. This may already have consequences
in other parts of Sage. Either it was a mistake of the user,
or a probabilistic primality test has failed.
In the latter case, please inform the developers.
```



---

archive/issue_comments_663030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-11-29T02:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33228#issuecomment-663030",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to needs_work.
