# Issue 33064: sage_docbuild: fails when cache cannot be saved

archive/issues_032827.json:
```json
{
    "assignees": [],
    "body": "When doctesting `src/sage_docbuild/__init__.py` on a read-only location we get a failure which ultimately boils down to:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.5.beta8, Release Date: 2021-12-12               \u2502\n\u2502 Using Python 3.10.1. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: from sage_docbuild import DocBuilder, setup_parser, ReferenceSubBuilder\nsage: DocBuilder._options = setup_parser().parse_args([])\nsage: import sage_docbuild.sphinxbuild\nsage: def raiseBaseException():\n....:     raise BaseException(\"abort pool operation\")\n....: \nsage: original_runsphinx, sage_docbuild.sphinxbuild.runsphinx = sage_docbuild.sphinxbuild.runsphinx, raiseBaseException\nsage: ReferenceSubBuilder(\"docname\", \"en\")._wrapper(\"html\")\n---------------------------------------------------------------------------\nPermissionError                           Traceback (most recent call last)\n<ipython-input-11-7faec88fcc76> in <module>\n----> 1 ReferenceSubBuilder(\"docname\", \"en\")._wrapper(\"html\")\n\n/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/__init__.py in _wrapper(self, build_type, *args, **kwds)\n    797         cache['option_inherited'] = self._options.inherited\n    798         cache['option_underscore'] = self._options.underscore\n--> 799         self.save_cache()\n    800 \n    801         # After \"sage -clone\", refresh the reST file mtimes in\n\n/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/__init__.py in save_cache(self)\n    857         \"\"\"\n    858         cache = self.get_cache()\n--> 859         with open(self.cache_filename(), 'wb') as file:\n    860             pickle.dump(cache, file)\n    861         logger.debug(\"Saved the reference cache: %s\", self.cache_filename())\n\nPermissionError: [Errno 13] Permission denied: '/usr/lib/sage-9.5.beta8/local/share/doc/sage/doctrees/en/docname/reference.pickle'\n```\n\nThis is due to a `save_cache()` method trying to save into that file; I believe it would be harmless to ignore this permission error (if the cache is not saved, it will have to be regenerated, so what).\n\n\nCC:  @jhpalmieri\n\nBranch/Commit: **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Gonzalo Tornar\u00eda**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33064_\n\n",
    "closed_at": "2022-02-12T22:05:10Z",
    "created_at": "2021-12-21T19:57:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage_docbuild: fails when cache cannot be saved",
    "type": "issue",
    "updated_at": "2022-02-12T22:05:10Z",
    "url": "https://github.com/sagemath/sage/issues/33064",
    "user": "https://github.com/tornaria"
}
```
When doctesting `src/sage_docbuild/__init__.py` on a read-only location we get a failure which ultimately boils down to:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta8, Release Date: 2021-12-12               │
│ Using Python 3.10.1. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: from sage_docbuild import DocBuilder, setup_parser, ReferenceSubBuilder
sage: DocBuilder._options = setup_parser().parse_args([])
sage: import sage_docbuild.sphinxbuild
sage: def raiseBaseException():
....:     raise BaseException("abort pool operation")
....: 
sage: original_runsphinx, sage_docbuild.sphinxbuild.runsphinx = sage_docbuild.sphinxbuild.runsphinx, raiseBaseException
sage: ReferenceSubBuilder("docname", "en")._wrapper("html")
---------------------------------------------------------------------------
PermissionError                           Traceback (most recent call last)
<ipython-input-11-7faec88fcc76> in <module>
----> 1 ReferenceSubBuilder("docname", "en")._wrapper("html")

/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/__init__.py in _wrapper(self, build_type, *args, **kwds)
    797         cache['option_inherited'] = self._options.inherited
    798         cache['option_underscore'] = self._options.underscore
--> 799         self.save_cache()
    800 
    801         # After "sage -clone", refresh the reST file mtimes in

/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/__init__.py in save_cache(self)
    857         """
    858         cache = self.get_cache()
--> 859         with open(self.cache_filename(), 'wb') as file:
    860             pickle.dump(cache, file)
    861         logger.debug("Saved the reference cache: %s", self.cache_filename())

PermissionError: [Errno 13] Permission denied: '/usr/lib/sage-9.5.beta8/local/share/doc/sage/doctrees/en/docname/reference.pickle'
```

This is due to a `save_cache()` method trying to save into that file; I believe it would be harmless to ignore this permission error (if the cache is not saved, it will have to be regenerated, so what).


CC:  @jhpalmieri

Branch/Commit: **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**

Reviewer: **John Palmieri**

Author: **Gonzalo Tornaría**

_Issue created by migration from https://trac.sagemath.org/ticket/33064_





---

archive/issue_events_422290.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2021-12-21T19:57:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422290"
}
```



---

archive/issue_events_422291.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2021-12-21T19:57:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422291"
}
```



---

archive/issue_events_422292.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2021-12-21T19:57:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422292"
}
```



---

archive/issue_events_422293.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2021-12-21T19:57:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422293"
}
```



---

archive/issue_comments_536901.json:
```json
{
    "body": "Branch: **[u/tornaria/sage_docbuild-save_cache](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage_docbuild-save_cache)**",
    "created_at": "2021-12-21T19:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536901",
    "user": "https://github.com/tornaria"
}
```

Branch: **[u/tornaria/sage_docbuild-save_cache](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage_docbuild-save_cache)**



---

archive/issue_comments_536902.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e\">f767cf1</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>\n",
    "created_at": "2021-12-21T19:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536902",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e">f767cf1</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>




---

archive/issue_events_422294.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2021-12-21T19:59:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422294"
}
```



---

archive/issue_comments_536903.json:
```json
{
    "body": "Commit: **[f767cf1](https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e)**",
    "created_at": "2021-12-21T19:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536903",
    "user": "https://github.com/tornaria"
}
```

Commit: **[f767cf1](https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e)**



---

archive/issue_comments_536904.json:
```json
{
    "body": "Author: **Gonzalo Tornar\u00eda**",
    "created_at": "2021-12-21T19:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536904",
    "user": "https://github.com/tornaria"
}
```

Author: **Gonzalo Tornaría**



---

archive/issue_comments_536905.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nA related but independent issue is that several methods whose main purpose is to return a path (e.g. `DocBuilder._output_dir`) also attempt to create the directory even if it won't be used. This issue I can fix by including the required empty directories (although some like `.../doc/sage/*/en/docname` are just an artifact of running doctests).\n\nI wonder if it would make sense to ignore `PermissionError` in those calls to `sage_makedirs()`.",
    "created_at": "2021-12-21T20:04:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536905",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:2'>Comment 2:</a>
A related but independent issue is that several methods whose main purpose is to return a path (e.g. `DocBuilder._output_dir`) also attempt to create the directory even if it won't be used. This issue I can fix by including the required empty directories (although some like `.../doc/sage/*/en/docname` are just an artifact of running doctests).

I wonder if it would make sense to ignore `PermissionError` in those calls to `sage_makedirs()`.



---

archive/issue_comments_536906.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [@tornaria](#comment%3A2):\n> I wonder if it would make sense to ignore `PermissionError` in those calls to `sage_makedirs()`.\n\nOr else maybe tag these doctests with `# optional - dochtml`",
    "created_at": "2021-12-21T20:08:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536906",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [@tornaria](#comment%3A2):
> I wonder if it would make sense to ignore `PermissionError` in those calls to `sage_makedirs()`.

Or else maybe tag these doctests with `# optional - dochtml`



---

archive/issue_comments_536907.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nI'd say these tests should probably not write into the production environment...",
    "created_at": "2021-12-21T20:39:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536907",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'>Comment 4:</a>
I'd say these tests should probably not write into the production environment...



---

archive/issue_comments_536908.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@mkoeppe](#comment%3A4):\n> I'd say these tests should probably not write into the production environment...\n\nRunning tests on a read-write directory creates all of this:\n\n```\n$ find local/share/doc/sage\nlocal/share/doc/sage\nlocal/share/doc/sage/html\nlocal/share/doc/sage/html/en\nlocal/share/doc/sage/html/en/tutorial\nlocal/share/doc/sage/html/en/docname\nlocal/share/doc/sage/html/en/reference\nlocal/share/doc/sage/doctrees\nlocal/share/doc/sage/doctrees/en\nlocal/share/doc/sage/doctrees/en/tutorial\nlocal/share/doc/sage/doctrees/en/docname\nlocal/share/doc/sage/doctrees/en/docname/reference.pickle\n```\nFailure to write `reference.pickle` is no longer a failure after the patch in this ticket. If any of the directories doesn't exist and cannot be created, we get a failure.\n\nAlso created on a test run are: `local/lib/sage-current-location.txt` and `logs/pkgs/sqlite.log`.",
    "created_at": "2021-12-23T19:27:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536908",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@mkoeppe](#comment%3A4):
> I'd say these tests should probably not write into the production environment...

Running tests on a read-write directory creates all of this:

```
$ find local/share/doc/sage
local/share/doc/sage
local/share/doc/sage/html
local/share/doc/sage/html/en
local/share/doc/sage/html/en/tutorial
local/share/doc/sage/html/en/docname
local/share/doc/sage/html/en/reference
local/share/doc/sage/doctrees
local/share/doc/sage/doctrees/en
local/share/doc/sage/doctrees/en/tutorial
local/share/doc/sage/doctrees/en/docname
local/share/doc/sage/doctrees/en/docname/reference.pickle
```
Failure to write `reference.pickle` is no longer a failure after the patch in this ticket. If any of the directories doesn't exist and cannot be created, we get a failure.

Also created on a test run are: `local/lib/sage-current-location.txt` and `logs/pkgs/sqlite.log`.



---

archive/issue_comments_536909.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nSee #22062 for `sqlite.log`.",
    "created_at": "2021-12-24T03:40:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536909",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'>Comment 7:</a>
See #22062 for `sqlite.log`.



---

archive/issue_comments_536910.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3\">a8973f2</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>\n",
    "created_at": "2021-12-26T21:26:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536910",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'>Comment 8:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3">a8973f2</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>




---

archive/issue_comments_536911.json:
```json
{
    "body": "Changed commit from **[f767cf1](https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e)** to **[a8973f2](https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3)**",
    "created_at": "2021-12-26T21:26:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536911",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f767cf1](https://github.com/sagemath/sagetrac-mirror/commit/f767cf1eadfd8ab540a31c5c5ef09d56df09b90e)** to **[a8973f2](https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3)**



---

archive/issue_comments_536912.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nFollowup on #33085 for the task that doctests pass when html documentation is not built/installed.",
    "created_at": "2021-12-26T22:12:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536912",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:9'>Comment 9:</a>
Followup on #33085 for the task that doctests pass when html documentation is not built/installed.



---

archive/issue_comments_536913.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nThe change makes sense to me, but I don't understand the situation in which this will arise. I made the directory `local/share/doc/sage` unwritable and ran doctests. I got failures, but none appeared to come from `save_cache`. I think I'm missing something.",
    "created_at": "2022-01-06T01:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536913",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'>Comment 10:</a>
The change makes sense to me, but I don't understand the situation in which this will arise. I made the directory `local/share/doc/sage` unwritable and ran doctests. I got failures, but none appeared to come from `save_cache`. I think I'm missing something.



---

archive/issue_comments_536914.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nReplying to [@jhpalmieri](#comment%3A10):\n> The change makes sense to me, but I don't understand the situation in which this will arise. I made the directory `local/share/doc/sage` unwritable and ran doctests. I got failures, but none appeared to come from `save_cache`. I think I'm missing something.\n\nMake sure the directory `local/share/doc/sage/doctrees/en/docname/` exists, otherwise there will be a failure when calling some `_output_dir()` method from `self.cache_filename()`.\n\nThis seems to be a cache of filenames or something... that is computed (or retrieved if cache file present) by `self.get_cache()` and then saved back to `local/share/doc/sage/doctrees/en/docname/reference.pickle` by the call to `pickle.dump()`.\n\nFor me I think what triggered this is: I build and doctest sagemath before packaging (in that check I have write permission). The package gets installed in a live system at `/usr/lib/sagemath...` where I don't have write permission. The `reference.pickle` file mentioned above was left over from the build doctest. Running the sequence in the description of the ticket (which reproduces part of a doctest) gives the failure, possibly given that the `reference.pickle` file exists.\n\nNote that I'm building with `make build` so documentation is not built at this stage. I'm aiming for doctests to pass 100% at build time (rw tree) and also pass 100% when installed (ro tree).",
    "created_at": "2022-01-06T01:44:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536914",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:11'>Comment 11:</a>
Replying to [@jhpalmieri](#comment%3A10):
> The change makes sense to me, but I don't understand the situation in which this will arise. I made the directory `local/share/doc/sage` unwritable and ran doctests. I got failures, but none appeared to come from `save_cache`. I think I'm missing something.

Make sure the directory `local/share/doc/sage/doctrees/en/docname/` exists, otherwise there will be a failure when calling some `_output_dir()` method from `self.cache_filename()`.

This seems to be a cache of filenames or something... that is computed (or retrieved if cache file present) by `self.get_cache()` and then saved back to `local/share/doc/sage/doctrees/en/docname/reference.pickle` by the call to `pickle.dump()`.

For me I think what triggered this is: I build and doctest sagemath before packaging (in that check I have write permission). The package gets installed in a live system at `/usr/lib/sagemath...` where I don't have write permission. The `reference.pickle` file mentioned above was left over from the build doctest. Running the sequence in the description of the ticket (which reproduces part of a doctest) gives the failure, possibly given that the `reference.pickle` file exists.

Note that I'm building with `make build` so documentation is not built at this stage. I'm aiming for doctests to pass 100% at build time (rw tree) and also pass 100% when installed (ro tree).



---

archive/issue_comments_536915.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2022-01-07T04:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536915",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_422295.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-01-07T04:41:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422295"
}
```



---

archive/issue_events_422296.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-01-07T04:41:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422296"
}
```



---

archive/issue_comments_536916.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nI still can't reproduce this, but as I said, the change makes sense.",
    "created_at": "2022-01-07T04:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536916",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'>Comment 12:</a>
I still can't reproduce this, but as I said, the change makes sense.



---

archive/issue_events_422297.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-01-09T20:26:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422297"
}
```



---

archive/issue_events_422298.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-01-09T20:26:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422298"
}
```



---

archive/issue_comments_536917.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4\">e89193f</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>\n",
    "created_at": "2022-01-09T20:26:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536917",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:13'>Comment 13:</a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4">e89193f</a></td><td><code>sage_docbuild: do not fail when cache cannot be saved</code></td></tr></table>




---

archive/issue_comments_536918.json:
```json
{
    "body": "Changed commit from **[a8973f2](https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3)** to **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**",
    "created_at": "2022-01-09T20:26:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536918",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a8973f2](https://github.com/sagemath/sagetrac-mirror/commit/a8973f2440f2f51a29cefb6973d5e12a3b2386b3)** to **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**



---

archive/issue_events_422299.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-09T20:27:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422299"
}
```



---

archive/issue_events_422300.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-09T20:27:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422300"
}
```



---

archive/issue_comments_536919.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nRebased to 9.5.rc0 without change.",
    "created_at": "2022-01-09T20:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536919",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:14'>Comment 14:</a>
Rebased to 9.5.rc0 without change.



---

archive/issue_comments_536920.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nThat doesn't fix anything for me in terms of doctests failure after install in a read only location.\n\n```\nsage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 108, in sage_docbuild.builder_helper\nFailed example:\n    try:  # optional - sagemath_doc_html\n        build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n    except Exception as E:\n        \"Non-exception during docbuild: abort pool operation\" in str(E)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 206, in sage_docbuild.DocBuilder._doctrees_dir\nFailed example:\n    b._doctrees_dir()             # optional - sagemath_doc_html\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.DocBuilder._doctrees_dir[2]>\", line 1, in <module>\n        b._doctrees_dir()             # optional - sagemath_doc_html\n      File \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 210, in _doctrees_dir\n        sage_makedirs(d)\n      File \"/usr/lib/python3.10/site-packages/sage/misc/misc.py\", line 90, in sage_makedirs\n        os.makedirs(dirname)\n      File \"/usr/lib/python3.10/os.py\", line 215, in makedirs\n        makedirs(head, exist_ok=exist_ok)\n      File \"/usr/lib/python3.10/os.py\", line 215, in makedirs\n        makedirs(head, exist_ok=exist_ok)\n      File \"/usr/lib/python3.10/os.py\", line 225, in makedirs\n        mkdir(name, mode)\n    PermissionError: [Errno 13] Permission denied: '/usr/share/doc/sage-doc-9999/doctrees'\n**********************************************************************\n```\nBoth fail because they try to create `/usr/share/doc/sage-doc-9999/doctrees` which I don't install because it has no use at runtime. If someone show me a use for it (aside from passing doctests) at runtime, I'd include it in sage-on-gentoo installation.",
    "created_at": "2022-01-11T20:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536920",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'>Comment 15:</a>
That doesn't fix anything for me in terms of doctests failure after install in a read only location.

```
sage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 108, in sage_docbuild.builder_helper
Failed example:
    try:  # optional - sagemath_doc_html
        build_many(build_ref_doc, [("docname", "en", "html", {})])
    except Exception as E:
        "Non-exception during docbuild: abort pool operation" in str(E)
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 206, in sage_docbuild.DocBuilder._doctrees_dir
Failed example:
    b._doctrees_dir()             # optional - sagemath_doc_html
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.DocBuilder._doctrees_dir[2]>", line 1, in <module>
        b._doctrees_dir()             # optional - sagemath_doc_html
      File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 210, in _doctrees_dir
        sage_makedirs(d)
      File "/usr/lib/python3.10/site-packages/sage/misc/misc.py", line 90, in sage_makedirs
        os.makedirs(dirname)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 225, in makedirs
        mkdir(name, mode)
    PermissionError: [Errno 13] Permission denied: '/usr/share/doc/sage-doc-9999/doctrees'
**********************************************************************
```
Both fail because they try to create `/usr/share/doc/sage-doc-9999/doctrees` which I don't install because it has no use at runtime. If someone show me a use for it (aside from passing doctests) at runtime, I'd include it in sage-on-gentoo installation.



---

archive/issue_comments_536921.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nDoes #33085 help? The fix on this ticket was for a very specific problem.",
    "created_at": "2022-01-11T22:58:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536921",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'>Comment 16:</a>
Does #33085 help? The fix on this ticket was for a very specific problem.



---

archive/issue_comments_536922.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@jhpalmieri](#comment%3A16):\n> Does #33085 help? The fix on this ticket was for a very specific problem.\n\nNo, I have both included. The label `sagemath_doc_html` triggers doctesting when html documentation can be found, which is my case. The real issue is that vanilla sage build the documentation in place and that lead people to think that build artifacts like `doctrees` are part of a normal install when they aren't. The only place in sage outside of sage_docbuild that refers to `doctrees` is in `sage/misc/sphinxify.py` and I am not completely sure it should not be relocated.",
    "created_at": "2022-01-11T23:05:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536922",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@jhpalmieri](#comment%3A16):
> Does #33085 help? The fix on this ticket was for a very specific problem.

No, I have both included. The label `sagemath_doc_html` triggers doctesting when html documentation can be found, which is my case. The real issue is that vanilla sage build the documentation in place and that lead people to think that build artifacts like `doctrees` are part of a normal install when they aren't. The only place in sage outside of sage_docbuild that refers to `doctrees` is in `sage/misc/sphinxify.py` and I am not completely sure it should not be relocated.



---

archive/issue_comments_536923.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\n+1 on investigating whether `sage/misc/sphinxify.py` really depends on the doctrees",
    "created_at": "2022-01-11T23:08:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536923",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>Comment 18:</a>
+1 on investigating whether `sage/misc/sphinxify.py` really depends on the doctrees



---

archive/issue_comments_536924.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@mkoeppe](#comment%3A18):\n> +1 on investigating whether `sage/misc/sphinxify.py` really depends on the doctrees\n\nShort answer: no\n\nLong answer: a \"doctrees\" folder is passed to the sphinx app, but it is a temporary one. The relevant lines in `sphinxify.py` are\n\n```\n    srcdir = mkdtemp()\n...\n    doctreedir = os.path.join(srcdir, 'doctrees')\n...\n    sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,\n                        confoverrides, None, None, True)\n```\nSo, a temporary \"doctrees\" folder is used by sphinxify and it has no relationship with what is normally in `$SAGE_LOCAL/share/doc/sage/doctrees`.\n\nGrepping sage's source for \"doctrees\" returned a false positive in that case.",
    "created_at": "2022-01-12T01:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536924",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@mkoeppe](#comment%3A18):
> +1 on investigating whether `sage/misc/sphinxify.py` really depends on the doctrees

Short answer: no

Long answer: a "doctrees" folder is passed to the sphinx app, but it is a temporary one. The relevant lines in `sphinxify.py` are

```
    srcdir = mkdtemp()
...
    doctreedir = os.path.join(srcdir, 'doctrees')
...
    sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,
                        confoverrides, None, None, True)
```
So, a temporary "doctrees" folder is used by sphinxify and it has no relationship with what is normally in `$SAGE_LOCAL/share/doc/sage/doctrees`.

Grepping sage's source for "doctrees" returned a false positive in that case.



---

archive/issue_comments_536925.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nThanks! I've added this to #29868.",
    "created_at": "2022-01-12T02:55:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536925",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'>Comment 20:</a>
Thanks! I've added this to #29868.



---

archive/issue_events_422301.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-28T23:03:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422301"
}
```



---

archive/issue_events_422302.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-28T23:03:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422302"
}
```



---

archive/issue_comments_536926.json:
```json
{
    "body": "Changed branch from **[u/tornaria/sage_docbuild-save_cache](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage_docbuild-save_cache)** to **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**",
    "created_at": "2022-02-12T22:05:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33064#issuecomment-536926",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tornaria/sage_docbuild-save_cache](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage_docbuild-save_cache)** to **[e89193f](https://github.com/sagemath/sagetrac-mirror/commit/e89193f4f32246ad9ded6d37f1f2f12a589a81f4)**



---

archive/issue_events_422303.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-12T22:05:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422303"
}
```



---

archive/issue_events_422304.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "18ba1d8cdd264f03a43865d3753dd0fc3c9155c1",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-02-12T22:05:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33064",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33064#event-422304"
}
```
