# Issue 33164: fix & refactor caching in EllipticCurve_generic.division_polynomial()

archive/issues_032927.json:
```json
{
    "body": "This was discovered while digging for the underlying reason behind #33156:\n\n```\nsage: E = EllipticCurve('11a3')\nsage: R.<X> = QQ[]\nsage: S.<Y> = R.quotient(X^2)\nsage: E.division_polynomial(5, x=Y)\n-5*Y\nsage: E.division_polynomial(5, x=X)\n-5*Y\n```\nThe problem is that `Y == X`, which makes the method return an incorrect result from its cache.\n\nIn this patch, we streamline caching in three major ways:\n- Only cache the *generic* division polynomials, rather than evaluations at all inputs. (Currently all input-output pairs are stored, and this is both a source of errors\u2009\u2014\u2009as above\u2009\u2014\u2009and a source of memory leaks.)\n- Share the caches of `.division_polynomial_0()` and `.division_polynomial()`. This makes later calls to `.division_polynomial()` (with `x==None`) faster and faster as the cache is populated with more intermediate nodes appearing in the recursive formula for division polynomials.\n- In a similar vein, we make opportunistic use of already computed division polynomials, for instance when evaluating at base-field elements (and the degree is small enough for this to be beneficial), or when computing another division polynomial with a different two-torsion multiplicity.\n\n\nCC:  @defeo @JohnCremona\n\nBranch/Commit: 0aaec679ce3bb4e43b96d140baa7fbd540cbff56\n\nReviewer: Travis Scrimshaw\n\nAuthor: Lorenz Panny\n\nDependencies: #33165\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33164\n\n",
    "closed_at": "2022-03-12T15:11:11Z",
    "created_at": "2022-01-14T03:09:05Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "fix & refactor caching in EllipticCurve_generic.division_polynomial()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33164",
    "user": "https://github.com/yyyyx4"
}
```
This was discovered while digging for the underlying reason behind #33156:

```
sage: E = EllipticCurve('11a3')
sage: R.<X> = QQ[]
sage: S.<Y> = R.quotient(X^2)
sage: E.division_polynomial(5, x=Y)
-5*Y
sage: E.division_polynomial(5, x=X)
-5*Y
```
The problem is that `Y == X`, which makes the method return an incorrect result from its cache.

In this patch, we streamline caching in three major ways:
- Only cache the *generic* division polynomials, rather than evaluations at all inputs. (Currently all input-output pairs are stored, and this is both a source of errors — as above — and a source of memory leaks.)
- Share the caches of `.division_polynomial_0()` and `.division_polynomial()`. This makes later calls to `.division_polynomial()` (with `x==None`) faster and faster as the cache is populated with more intermediate nodes appearing in the recursive formula for division polynomials.
- In a similar vein, we make opportunistic use of already computed division polynomials, for instance when evaluating at base-field elements (and the degree is small enough for this to be beneficial), or when computing another division polynomial with a different two-torsion multiplicity.


CC:  @defeo @JohnCremona

Branch/Commit: 0aaec679ce3bb4e43b96d140baa7fbd540cbff56

Reviewer: Travis Scrimshaw

Author: Lorenz Panny

Dependencies: #33165

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33164





---

archive/issue_comments_661735.json:
```json
{
    "body": "Changing author from \"\" to \"Lorenz Panny\"",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661735",
    "user": "https://github.com/yyyyx4"
}
```

Changing author from "" to "Lorenz Panny"



---

archive/issue_comments_661736.json:
```json
{
    "body": "Changing branch from \"\" to \"public/33164\"",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661736",
    "user": "https://github.com/yyyyx4"
}
```

Changing branch from "" to "public/33164"



---

archive/issue_comments_661737.json:
```json
{
    "body": "Changing commit from \"\" to \"f114657662a6f56bd7ee3f474fee7d09c741a13a\"",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661737",
    "user": "https://github.com/yyyyx4"
}
```

Changing commit from "" to "f114657662a6f56bd7ee3f474fee7d09c741a13a"



---

archive/issue_comments_661738.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,8 +9,13 @@\n sage: E.division_polynomial(5, x=X)\n -5*Y\n ```\n+The problem is that `Y == X`, which makes the method return an incorrect result from its cache.\n \n-To fix it, we should probably include `x.parent()` in the cache key.\n+In this patch, we streamline caching in three major ways:\n+- Only cache the *generic* division polynomials, rather than evaluations at all inputs. (Currently all input-output pairs are stored, and this is both a source of errors\u2009\u2014\u2009as above\u2009\u2014\u2009and a source of memory leaks.)\n+- Share the caches of `.division_polynomial_0()` and `.division_polynomial()`. This makes later calls to `.division_polynomial()` (with `x==None`) faster and faster as the cache is populated with more intermediate nodes appearing in the recursive formula for division polynomials.\n+- In a similar vein, we make opportunistic use of already computed division polynomials, for instance when evaluating at base-field elements (and the degree is small enough for this to be beneficial), or when computing another division polynomial with a different two-torsion multiplicity.\n+\n \n Priority: minor\n \n``````\n",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661738",
    "user": "https://github.com/yyyyx4"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,8 +9,13 @@
 sage: E.division_polynomial(5, x=X)
 -5*Y
 ```
+The problem is that `Y == X`, which makes the method return an incorrect result from its cache.
 
-To fix it, we should probably include `x.parent()` in the cache key.
+In this patch, we streamline caching in three major ways:
+- Only cache the *generic* division polynomials, rather than evaluations at all inputs. (Currently all input-output pairs are stored, and this is both a source of errors — as above — and a source of memory leaks.)
+- Share the caches of `.division_polynomial_0()` and `.division_polynomial()`. This makes later calls to `.division_polynomial()` (with `x==None`) faster and faster as the cache is populated with more intermediate nodes appearing in the recursive formula for division polynomials.
+- In a similar vein, we make opportunistic use of already computed division polynomials, for instance when evaluating at base-field elements (and the degree is small enough for this to be beneficial), or when computing another division polynomial with a different two-torsion multiplicity.
+
 
 Priority: minor
 
``````




---

archive/issue_comments_661739.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661739",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_661740.json:
```json
{
    "body": "Changing dependencies from \"\" to \"public/33165\"",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661740",
    "user": "https://github.com/yyyyx4"
}
```

Changing dependencies from "" to "public/33165"



---

archive/issue_comments_661741.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2022-01-17T06:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661741",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_661742.json:
```json
{
    "body": "<a id='comment:2'></a>The changes in `Polynomial.__call__` are from the dependency.",
    "created_at": "2022-01-17T06:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661742",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:2'></a>The changes in `Polynomial.__call__` are from the dependency.



---

archive/issue_comments_661743.json:
```json
{
    "body": "Changing dependencies from \"public/33165\" to \"#33165\"",
    "created_at": "2022-01-17T06:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661743",
    "user": "https://github.com/yyyyx4"
}
```

Changing dependencies from "public/33165" to "#33165"



---

archive/issue_comments_661744.json:
```json
{
    "body": "Changing commit from \"f114657662a6f56bd7ee3f474fee7d09c741a13a\" to \"ad9a380b8070127d00b701d1593066e605115932\"",
    "created_at": "2022-02-18T03:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f114657662a6f56bd7ee3f474fee7d09c741a13a" to "ad9a380b8070127d00b701d1593066e605115932"



---

archive/issue_comments_661745.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-18T03:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661745",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661746.json:
```json
{
    "body": "Changing commit from \"ad9a380b8070127d00b701d1593066e605115932\" to \"950b07d2a3945f60d8519118901fe44d31aeca3a\"",
    "created_at": "2022-02-21T07:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ad9a380b8070127d00b701d1593066e605115932" to "950b07d2a3945f60d8519118901fe44d31aeca3a"



---

archive/issue_comments_661747.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-21T07:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661748.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-21T07:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661749.json:
```json
{
    "body": "Changing commit from \"950b07d2a3945f60d8519118901fe44d31aeca3a\" to \"2feafab33e2ff8ee2c7c3b2276d5069edd9b2624\"",
    "created_at": "2022-02-21T07:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "950b07d2a3945f60d8519118901fe44d31aeca3a" to "2feafab33e2ff8ee2c7c3b2276d5069edd9b2624"



---

archive/issue_comments_661750.json:
```json
{
    "body": "<a id='comment:7'></a>As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.\n\nFor the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.",
    "created_at": "2022-02-27T10:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661750",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.

For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.



---

archive/issue_comments_661751.json:
```json
{
    "body": "<a id='comment:8'></a>Thank you for looking at this.\n\nReplying to [comment:7 tscrim]:\n> As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.\n\n\nDoesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?\n\nReplying to [comment:7 tscrim]:\n> For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.\n\n\nSo, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?",
    "created_at": "2022-03-01T08:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661751",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:8'></a>Thank you for looking at this.

Replying to [comment:7 tscrim]:
> As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.


Doesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?

Replying to [comment:7 tscrim]:
> For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.


So, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?



---

archive/issue_comments_661752.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 lorenz]:\n> Thank you for looking at this.\n> \n> Replying to [comment:7 tscrim]:\n> > As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.\n\n> \n> Doesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?\n\n\nYes, sorry, I missed that commit.\n\n> Replying to [comment:7 tscrim]:\n> > For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.\n\n> \n> So, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?\n\n\nYes, that is correct. At least, I could see a few situations where this could be useful for just a few simple lines of code.",
    "created_at": "2022-03-01T08:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661752",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Replying to [comment:8 lorenz]:
> Thank you for looking at this.
> 
> Replying to [comment:7 tscrim]:
> > As I mentioned on #33165, `is_gen()` is not a catchall for things constructed more generally. So a more comprehensive test should be done if that fails for `polynomial_is_variable()`.

> 
> Doesn't commit `ad9a380b80` (added after you pointed out the issue in #33165) take care of this?


Yes, sorry, I missed that commit.

> Replying to [comment:7 tscrim]:
> > For the caching in the `x is not None` case, it might be better to have an option to compute in the generic cache and then specialize the parameter (say, you are using just a monomial input). This could be useful to reduce the cache size and possibly use already cached results (including if you vary the input). I don't think this will add a lot of complexity to the code, but it gives the user more control over the cache and computation.

> 
> So, if I understand this correctly, you'd like a keyword argument to override the (existing) `evaluate` flag?


Yes, that is correct. At least, I could see a few situations where this could be useful for just a few simple lines of code.



---

archive/issue_comments_661753.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T12:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661754.json:
```json
{
    "body": "Changing commit from \"2feafab33e2ff8ee2c7c3b2276d5069edd9b2624\" to \"99b2ddc19f9959e93ad9eb7e8125f1140e105d71\"",
    "created_at": "2022-03-01T12:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661754",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2feafab33e2ff8ee2c7c3b2276d5069edd9b2624" to "99b2ddc19f9959e93ad9eb7e8125f1140e105d71"



---

archive/issue_comments_661755.json:
```json
{
    "body": "Changing commit from \"99b2ddc19f9959e93ad9eb7e8125f1140e105d71\" to \"1bd0f0c3f3a2fc74aba8d68a8293f700c67fd0d0\"",
    "created_at": "2022-03-01T12:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "99b2ddc19f9959e93ad9eb7e8125f1140e105d71" to "1bd0f0c3f3a2fc74aba8d68a8293f700c67fd0d0"



---

archive/issue_comments_661756.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T12:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661757.json:
```json
{
    "body": "<a id='comment:12'></a>Alright, added an optional argument to override the default.",
    "created_at": "2022-03-01T12:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661757",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:12'></a>Alright, added an optional argument to override the default.



---

archive/issue_comments_661758.json:
```json
{
    "body": "<a id='comment:13'></a>Thank you. One last little detail. In `division_polynomial()`, have the docstring bullet points have the indentation as\n\n```\n- ``arg`` -- short description\n\n  A long description in a separate paragraph.\n\n- ``more`` -- another argument\n\n  Another long description paragraph.\n```\nRight now, your subsequent paragraphs are also indented, which may not be the desired effect.",
    "created_at": "2022-03-02T00:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661758",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Thank you. One last little detail. In `division_polynomial()`, have the docstring bullet points have the indentation as

```
- ``arg`` -- short description

  A long description in a separate paragraph.

- ``more`` -- another argument

  Another long description paragraph.
```
Right now, your subsequent paragraphs are also indented, which may not be the desired effect.



---

archive/issue_comments_661759.json:
```json
{
    "body": "<a id='comment:14'></a>Also one pyflakes thing:\n\n```\nsrc/sage/schemes/elliptic_curves/ell_generic.py:62:1 'sage.misc.cachefunc.cached_function' imported but unused\n```\n\nHere's two more optional things:\n\nActually, it might make sense to `cpdef bint polynomial_is_variable()` with a (top-level) `cimport MPolynomial` (you don't need to worry about cyclic imports since it has a header file). Although this is a definite micro-optimization that might not be so useful.\n\nI might also change this\n\n```diff\n-        return x.is_gen() \\\n-                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one())\n+        return (x.is_gen()\n+                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one()))\n```",
    "created_at": "2022-03-02T00:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661759",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Also one pyflakes thing:

```
src/sage/schemes/elliptic_curves/ell_generic.py:62:1 'sage.misc.cachefunc.cached_function' imported but unused
```

Here's two more optional things:

Actually, it might make sense to `cpdef bint polynomial_is_variable()` with a (top-level) `cimport MPolynomial` (you don't need to worry about cyclic imports since it has a header file). Although this is a definite micro-optimization that might not be so useful.

I might also change this

```diff
-        return x.is_gen() \
-                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one())
+        return (x.is_gen()
+                or (x.degree() == 1 and x[0].is_zero() and x[1].is_one()))
```



---

archive/issue_comments_661760.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T03:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661760",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661761.json:
```json
{
    "body": "Changing commit from \"1bd0f0c3f3a2fc74aba8d68a8293f700c67fd0d0\" to \"b96b7d4c6f2c359fc365d16b3f5872caa2b9c4f1\"",
    "created_at": "2022-03-02T03:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1bd0f0c3f3a2fc74aba8d68a8293f700c67fd0d0" to "b96b7d4c6f2c359fc365d16b3f5872caa2b9c4f1"



---

archive/issue_comments_661762.json:
```json
{
    "body": "<a id='comment:16'></a>Thanks, all done.",
    "created_at": "2022-03-02T03:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661762",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:16'></a>Thanks, all done.



---

archive/issue_comments_661763.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2022-03-02T03:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661763",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_661764.json:
```json
{
    "body": "<a id='comment:17'></a>Thank you. Green bot => positive review.",
    "created_at": "2022-03-02T03:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661764",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Thank you. Green bot => positive review.



---

archive/issue_comments_661765.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-02T07:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661765",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_661766.json:
```json
{
    "body": "<a id='comment:19'></a>Thank you!",
    "created_at": "2022-03-02T07:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661766",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:19'></a>Thank you!



---

archive/issue_comments_661767.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-03T23:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661767",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_661768.json:
```json
{
    "body": "<a id='comment:20'></a>Merge failure on top of:\n\nc7adc6cc57 Trac #33112: some speedups in AdditiveAbelianGroupWrapper.discrete_log()\n\n8230df5b38 Trac #32770: Expose and access `tachyon` command line flags\n\n135c8e5bb1 Trac #31426: Apply flat shading when plotting 3d polyhedra with Three.js\n\n32e26f275f Trac #24536: find_local_maximum/minimum() fails with expressions containing complex numbers\n\nc0b15ffde0 Trac #33450: Improve vs code config\n\na76af34b81 Trac #33312: WeierstrassIsomorphism.degree() returns a Python int\n\n8368718592 Trac #33094: update URLs in SPKG.rst for ECL\n\n4f76f139db Trac #32922: Change parameter name\n\n44b5d43de7 Trac #32384: make some AdditiveAbelianGroupWrapper methods visible\n\n232f88fe88 Trac #32251: Fix doctest in the \"Y pentamino\" example from Donald Knuth\n\n6adf64eec4 Trac #30999: expose method hyperbolicity in graphs\n\n14e3e755d2 Trac #25787: Remove documentation configuration from micro_release\n\n87d5c62133 Trac #33414: Remove sage-open\n\nc254f33235 Trac #33413: Remove sage-native-execute\n\n6dcb3dc676 Trac #33412: Remove sage-update-src\n\naeb3fb2594 Trac #33411: include time for checking doctest output in '--warn-long'\n\nb20aeb7ee9 Trac #33322: Several ImageMagick tests need \"long time\"\n\ndb459d4eb3 Trac #33318: speed up is_prime() for very small integers\n\n0df0bad12f Trac #33308: Remove expired deprecations that use lazy_import(MODULE, \"*\")\n\n7c9535ef80 Trac #33292: mark invlex ordering as global\n\ne6d8672713 Trac #33286: Put topology in the reference manual\n\n6e45b9e469 Trac #33270: Difference between a formula and an image in Contour Plots\n\n895ded3c44 Trac #33224: PARI-backed LaurentSeries truncates exact polynomials to default precision\n\needa513423 Trac #33434: Fix pyflake in sage.graphs.graph\n\nf45550a9d3 Trac #33424: pep8 for function field maps\n\n9553cc37d8 Trac #33319: polynomial rings should not attempt to use Singular in characteristic >= 2^31\n\n13d038fd9f Trac #33147: use PARI's ellmul() for elliptic curves over finite fields\n\n0c85ad2f59 Trac #33433: Correct order of parameters in min_spanning_tree\n\n8e935af159 Trac #33421: Add elliptic_curves dependency to sagemath_doc_html\n\n111bcfa1f7 Trac #33216: reduce precision for .formal() in EllipticCurveIsogeny.dual()\n\n195cf6ab4d Trac #33215: WeierstrassIsomorphism should coerce its inputs to a common parent\n\ndf9c2612a6 Trac #33210: Fix Cython warnings in sage.rings.polynomial.polynomial_modn_dense_ntl\n\nac61ea8b62 Trac #33208: Remove unused code from sage/rings/padics/pow_computer_ext.pyx\n\nbc069a7cb2 Trac #33193: Fix Cython incompatible redefinition warnings in padics\n\n8a21049265 Trac #33186: Fix \"referenced before assignment\" warnings in padics\n\n490fdfded3 Trac #33055: conda-forge: Fix build of python3 spkg\n\nbeedaabc7e Trac #32997: docker image fails to build on tigerlake\n\n28f2f9a48b Trac #32786: opportunistic caching of elliptic-curve and point orders\n\n1ac2b995a4 Trac #12419: factorization of 0 in GF(p)[x,y] fails\n\n9349a36d34 Trac #33429: some cleanup in toric schemes\n\ndf9d1d77aa Trac #33427: numerical noise in effective_resistance involving RDF\n\nc6f2af1800 Trac #33425: adjust error messages in combinat/words\n\n449c7f1d66 Trac #33423: Cancel the linter\n\nb30c72fe86 Trac #33420: fix E111 (indentation) in quadratic_forms\n\ncc8a39082b Trac #33419: fix E111 (indentation) in manifolds, stats, finance\n\n6410a7cd86 Trac #33415: fix the linter\n\nec318c0d08 Trac #33410: Polyhedron_base.volume(engine='lrs', measure='induced')\n\nb6fecc7464 Trac #33399: Bug in ExpressionNice with composite variables\n\n6779f414bf Trac #33363: (Too) long doctest in sage/matrix/matrix_integer_dense.pyx\n\n9e90afaba0 Trac #29215: valuation error\n\n2a16069f4c Trac #29114: Only ./bootstrap should glob build/pkgs\n\n062a90c9d1 Trac #33403: Polyhedron._test_product, _test_dilation: Skip tests if test prereqs cannot be imported\n\ncc4ffb3fa1 Trac #33402: sage.geometry.polyhedron: More # optional\n\n9333fa5dc3 Trac #33395: document using Wolfram Engine (a.k.a. wolframscript) with Sage\n\nf346730807 Trac #33394: correct docs for running notebook on a specific port\n\n1e8ba0aac4 Updated [SageMath](SageMath) version to 9.6.beta3\n\n\n\nmerge was not clean: conflicts in src/sage/schemes/elliptic_curves/ell_generic.py",
    "created_at": "2022-03-03T23:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661768",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>Merge failure on top of:

c7adc6cc57 Trac #33112: some speedups in AdditiveAbelianGroupWrapper.discrete_log()

8230df5b38 Trac #32770: Expose and access `tachyon` command line flags

135c8e5bb1 Trac #31426: Apply flat shading when plotting 3d polyhedra with Three.js

32e26f275f Trac #24536: find_local_maximum/minimum() fails with expressions containing complex numbers

c0b15ffde0 Trac #33450: Improve vs code config

a76af34b81 Trac #33312: WeierstrassIsomorphism.degree() returns a Python int

8368718592 Trac #33094: update URLs in SPKG.rst for ECL

4f76f139db Trac #32922: Change parameter name

44b5d43de7 Trac #32384: make some AdditiveAbelianGroupWrapper methods visible

232f88fe88 Trac #32251: Fix doctest in the "Y pentamino" example from Donald Knuth

6adf64eec4 Trac #30999: expose method hyperbolicity in graphs

14e3e755d2 Trac #25787: Remove documentation configuration from micro_release

87d5c62133 Trac #33414: Remove sage-open

c254f33235 Trac #33413: Remove sage-native-execute

6dcb3dc676 Trac #33412: Remove sage-update-src

aeb3fb2594 Trac #33411: include time for checking doctest output in '--warn-long'

b20aeb7ee9 Trac #33322: Several ImageMagick tests need "long time"

db459d4eb3 Trac #33318: speed up is_prime() for very small integers

0df0bad12f Trac #33308: Remove expired deprecations that use lazy_import(MODULE, "*")

7c9535ef80 Trac #33292: mark invlex ordering as global

e6d8672713 Trac #33286: Put topology in the reference manual

6e45b9e469 Trac #33270: Difference between a formula and an image in Contour Plots

895ded3c44 Trac #33224: PARI-backed LaurentSeries truncates exact polynomials to default precision

eeda513423 Trac #33434: Fix pyflake in sage.graphs.graph

f45550a9d3 Trac #33424: pep8 for function field maps

9553cc37d8 Trac #33319: polynomial rings should not attempt to use Singular in characteristic >= 2^31

13d038fd9f Trac #33147: use PARI's ellmul() for elliptic curves over finite fields

0c85ad2f59 Trac #33433: Correct order of parameters in min_spanning_tree

8e935af159 Trac #33421: Add elliptic_curves dependency to sagemath_doc_html

111bcfa1f7 Trac #33216: reduce precision for .formal() in EllipticCurveIsogeny.dual()

195cf6ab4d Trac #33215: WeierstrassIsomorphism should coerce its inputs to a common parent

df9c2612a6 Trac #33210: Fix Cython warnings in sage.rings.polynomial.polynomial_modn_dense_ntl

ac61ea8b62 Trac #33208: Remove unused code from sage/rings/padics/pow_computer_ext.pyx

bc069a7cb2 Trac #33193: Fix Cython incompatible redefinition warnings in padics

8a21049265 Trac #33186: Fix "referenced before assignment" warnings in padics

490fdfded3 Trac #33055: conda-forge: Fix build of python3 spkg

beedaabc7e Trac #32997: docker image fails to build on tigerlake

28f2f9a48b Trac #32786: opportunistic caching of elliptic-curve and point orders

1ac2b995a4 Trac #12419: factorization of 0 in GF(p)[x,y] fails

9349a36d34 Trac #33429: some cleanup in toric schemes

df9d1d77aa Trac #33427: numerical noise in effective_resistance involving RDF

c6f2af1800 Trac #33425: adjust error messages in combinat/words

449c7f1d66 Trac #33423: Cancel the linter

b30c72fe86 Trac #33420: fix E111 (indentation) in quadratic_forms

cc8a39082b Trac #33419: fix E111 (indentation) in manifolds, stats, finance

6410a7cd86 Trac #33415: fix the linter

ec318c0d08 Trac #33410: Polyhedron_base.volume(engine='lrs', measure='induced')

b6fecc7464 Trac #33399: Bug in ExpressionNice with composite variables

6779f414bf Trac #33363: (Too) long doctest in sage/matrix/matrix_integer_dense.pyx

9e90afaba0 Trac #29215: valuation error

2a16069f4c Trac #29114: Only ./bootstrap should glob build/pkgs

062a90c9d1 Trac #33403: Polyhedron._test_product, _test_dilation: Skip tests if test prereqs cannot be imported

cc4ffb3fa1 Trac #33402: sage.geometry.polyhedron: More # optional

9333fa5dc3 Trac #33395: document using Wolfram Engine (a.k.a. wolframscript) with Sage

f346730807 Trac #33394: correct docs for running notebook on a specific port

1e8ba0aac4 Updated [SageMath](SageMath) version to 9.6.beta3



merge was not clean: conflicts in src/sage/schemes/elliptic_curves/ell_generic.py



---

archive/issue_comments_661769.json:
```json
{
    "body": "Changing commit from \"b96b7d4c6f2c359fc365d16b3f5872caa2b9c4f1\" to \"0aaec679ce3bb4e43b96d140baa7fbd540cbff56\"",
    "created_at": "2022-03-08T14:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b96b7d4c6f2c359fc365d16b3f5872caa2b9c4f1" to "0aaec679ce3bb4e43b96d140baa7fbd540cbff56"



---

archive/issue_comments_661770.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-08T14:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661770",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_661771.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-03-08T14:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661771",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_661772.json:
```json
{
    "body": "<a id='comment:22'></a>Trivial merge.",
    "created_at": "2022-03-08T14:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661772",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:22'></a>Trivial merge.



---

archive/issue_comments_661773.json:
```json
{
    "body": "Changing branch from \"public/33164\" to \"0aaec679ce3bb4e43b96d140baa7fbd540cbff56\"",
    "created_at": "2022-03-12T15:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661773",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/33164" to "0aaec679ce3bb4e43b96d140baa7fbd540cbff56"



---

archive/issue_comments_661774.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-12T15:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33164#issuecomment-661774",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087619.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-12T15:11:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33164",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33164#event-87619"
}
```
