# Issue 33907: interfaces/expect.py random test failure

archive/issues_033670.json:
```json
{
    "body": "I've been getting this very frequently when running tests under heavy CPU load. This happens on Sage 9.5 too.\n\n```\nsage -t --long --random-seed=233407191301051614325254530123917684827 /nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py\n**********************************************************************\nFile \"/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py\", line 920, in sage.interfaces.expect.Expect._eval_line\nFailed example:\n    singular.interrupt()\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py\", line 926, in sage.interfaces.expect.Expect._eval_line\nFailed example:\n    singular('2+3')\nExpected:\n    Singular crashed -- automatically restarting.\n    5\nGot:\n    5\n```\n\nCC:  @slel @fchapoton @jdemeyer @dimpase @tscrim\n\nReviewer: Matthias Koeppe\n\nAuthor: Gonzalo Tornar\u00eda\n\nBranch: u/tornaria/33907\n\nStatus: positive_review\n\nCommit: 6f5c1c2fc8bcfb5e6555716d05ce70511795ffa1\n\nIssue created by migration from https://trac.sagemath.org/ticket/33907\n\n",
    "created_at": "2022-05-25T22:48:52Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "interfaces/expect.py random test failure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33907",
    "user": "https://github.com/collares"
}
```
I've been getting this very frequently when running tests under heavy CPU load. This happens on Sage 9.5 too.

```
sage -t --long --random-seed=233407191301051614325254530123917684827 /nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py
**********************************************************************
File "/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py", line 920, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular.interrupt()
Expected:
    True
Got:
    False
**********************************************************************
File "/nix/store/fmcggxb3m1xvlsdqmi045p87xml9paca-sage-src-9.6/src/sage/interfaces/expect.py", line 926, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular('2+3')
Expected:
    Singular crashed -- automatically restarting.
    5
Got:
    5
```

CC:  @slel @fchapoton @jdemeyer @dimpase @tscrim

Reviewer: Matthias Koeppe

Author: Gonzalo Tornar√≠a

Branch: u/tornaria/33907

Status: positive_review

Commit: 6f5c1c2fc8bcfb5e6555716d05ce70511795ffa1

Issue created by migration from https://trac.sagemath.org/ticket/33907





---

archive/issue_events_088910.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33907#event-88910"
}
```



---

archive/issue_comments_478621.json:
```json
{
    "body": "<a id='comment:3'></a>I've just got the exact same issue when building/doctesting the sagemath void package on github actions. Happened with x86_64 and i686 (but not with x86_64-musl).\n\nNot copying the log since it is identical.\n\nEdit: in case it is relevant, we use singular 4.3.1p2 from system.",
    "created_at": "2022-12-14T16:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478621",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:3'></a>I've just got the exact same issue when building/doctesting the sagemath void package on github actions. Happened with x86_64 and i686 (but not with x86_64-musl).

Not copying the log since it is identical.

Edit: in case it is relevant, we use singular 4.3.1p2 from system.



---

archive/issue_comments_478622.json:
```json
{
    "body": "<a id='comment:4'></a>Cf https://github.com/void-linux/void-packages/pull/41085#issuecomment-1351712588",
    "created_at": "2022-12-14T16:16:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478622",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:4'></a>Cf https://github.com/void-linux/void-packages/pull/41085#issuecomment-1351712588



---

archive/issue_comments_478623.json:
```json
{
    "body": "<a id='comment:5'></a>Here's a way to reproduce it:\n\n```\nsage: for i in range(1_000_000):\n....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)\n....:     if not singular.interrupt(tries=1, timeout=1e-6):\n....:         print(f\"FAIL in step {i} \")\n....:         break\n....:     _ = singular('2+3')\n....: \n^[[A''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nSingular crashed -- automatically restarting.\n''\nFAIL in step 7 \n```\n\nThe \"Singular crashed\" output is expected.\n\nAs reported, this fails more if there is a heavy load, and I think using `tries=1` and `timeout=1e-6` also helps it. For the heavy load, right now I am running `sage -tp 8 --all --long` (8 core / 8 thread box)",
    "created_at": "2022-12-14T16:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478623",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>Here's a way to reproduce it:

```
sage: for i in range(1_000_000):
....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)
....:     if not singular.interrupt(tries=1, timeout=1e-6):
....:         print(f"FAIL in step {i} ")
....:         break
....:     _ = singular('2+3')
....: 
^[[A''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
Singular crashed -- automatically restarting.
''
FAIL in step 7 
```

The "Singular crashed" output is expected.

As reported, this fails more if there is a heavy load, and I think using `tries=1` and `timeout=1e-6` also helps it. For the heavy load, right now I am running `sage -tp 8 --all --long` (8 core / 8 thread box)



---

archive/issue_comments_478624.json:
```json
{
    "body": "<a id='comment:6'></a>A comment before the doctest says:\n\n```\n        For reasons which are currently not understood, the ``interrupt``\n        test usually returns immediately, but sometimes it takes a very\n        long time on the same system. ::\n```\nI guess \"takes a very long time\" sometimes is more than the default `timeout=2.0` seconds repeated more than the default `tries=5` times in a row.",
    "created_at": "2022-12-14T16:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478624",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:6'></a>A comment before the doctest says:

```
        For reasons which are currently not understood, the ``interrupt``
        test usually returns immediately, but sometimes it takes a very
        long time on the same system. ::
```
I guess "takes a very long time" sometimes is more than the default `timeout=2.0` seconds repeated more than the default `tries=5` times in a row.



---

archive/issue_comments_478625.json:
```json
{
    "body": "<a id='comment:7'></a>Not really: I tried the same with `tries=1` and `timeout=100` and still under heavy load. Eventually, the loop got stuck for 100 seconds and then failed. So I guess the correct statement is \"for unknown reasons sometimes the interrupt is missed and the thing only finishes because of the timeout\". Which means increasing `timeout` won't solve the issue.\n\nIn fact, `tries` doesn't help either in the sense that if the first attempt gets stuck then the remaining tries will also get stuck. Indeed, when I run several times the code below which uses `tries=5` and `timeout=3`, it always finishes in < 1ms except when it fails it takes ~ 15 seconds. It never succeeds in the second or later tries.\n\n```\nsage: for i in range(1_000_000):\n....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)\n....:     t = time.clock_gettime(time.CLOCK_MONOTONIC)\n....:     if not singular.interrupt(tries=5, timeout=3):\n....:         t = time.clock_gettime(time.CLOCK_MONOTONIC) - t\n....:         print(f\"FAIL in step {i} after {t} seconds \")\n....:         break\n....:     t = time.clock_gettime(time.CLOCK_MONOTONIC) - t\n....:     print(f\"DONE in {t} seconds\")\n....:     _ = singular('2+3')\n```",
    "created_at": "2022-12-14T16:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478625",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:7'></a>Not really: I tried the same with `tries=1` and `timeout=100` and still under heavy load. Eventually, the loop got stuck for 100 seconds and then failed. So I guess the correct statement is "for unknown reasons sometimes the interrupt is missed and the thing only finishes because of the timeout". Which means increasing `timeout` won't solve the issue.

In fact, `tries` doesn't help either in the sense that if the first attempt gets stuck then the remaining tries will also get stuck. Indeed, when I run several times the code below which uses `tries=5` and `timeout=3`, it always finishes in < 1ms except when it fails it takes ~ 15 seconds. It never succeeds in the second or later tries.

```
sage: for i in range(1_000_000):
....:     singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False)
....:     t = time.clock_gettime(time.CLOCK_MONOTONIC)
....:     if not singular.interrupt(tries=5, timeout=3):
....:         t = time.clock_gettime(time.CLOCK_MONOTONIC) - t
....:         print(f"FAIL in step {i} after {t} seconds ")
....:         break
....:     t = time.clock_gettime(time.CLOCK_MONOTONIC) - t
....:     print(f"DONE in {t} seconds")
....:     _ = singular('2+3')
```



---

archive/issue_comments_478626.json:
```json
{
    "body": "<a id='comment:8'></a>I think this might be caused by #31846.",
    "created_at": "2022-12-15T15:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478626",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:8'></a>I think this might be caused by #31846.



---

archive/issue_comments_478627.json:
```json
{
    "body": "<a id='comment:9'></a>New commits:",
    "created_at": "2022-12-16T18:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478627",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:9'></a>New commits:



---

archive/issue_comments_478628.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-16T18:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478628",
    "user": "https://github.com/tornaria"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_478629.json:
```json
{
    "body": "<a id='comment:10'></a>This essentially reverts 85f65bf and a10d19d from trac #31846.\nIt turns out this was originaly written for #30945, but that issue was\nfixed by upgrading cysignals.\n    \nSingular really needs a custom `_send_interrupt()` method, because the\ndefault one will quit singular. Moreover, this handles two quirks of\nsingular:\n    \n- a small delay before sending `chr(3)` works around a bug in singular.\n- sometimes one needs to send `;` a few times after interrupt to get\n  back a prompt.\n    \nThe original author of the custom `_send_interrupt()` is Jeroen Demeyer\nin commit 17d23e9 (trac #10476). I changed the timeout for a smaller\none, and rewrote the doctest to call `interrupt()` explicitly instead of\nusing `alarm()` which introduces more noise.",
    "created_at": "2022-12-16T18:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478629",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:10'></a>This essentially reverts 85f65bf and a10d19d from trac #31846.
It turns out this was originaly written for #30945, but that issue was
fixed by upgrading cysignals.
    
Singular really needs a custom `_send_interrupt()` method, because the
default one will quit singular. Moreover, this handles two quirks of
singular:
    
- a small delay before sending `chr(3)` works around a bug in singular.
- sometimes one needs to send `;` a few times after interrupt to get
  back a prompt.
    
The original author of the custom `_send_interrupt()` is Jeroen Demeyer
in commit 17d23e9 (trac #10476). I changed the timeout for a smaller
one, and rewrote the doctest to call `interrupt()` explicitly instead of
using `alarm()` which introduces more noise.



---

archive/issue_comments_478630.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-16T22:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478630",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_478631.json:
```json
{
    "body": "<a id='comment:11'></a>LGTM.",
    "created_at": "2022-12-16T22:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33907#issuecomment-478631",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>LGTM.
