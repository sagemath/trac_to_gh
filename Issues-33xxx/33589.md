# Issue 33589: Gitpod: track remote trac branch

archive/issues_033352.json:
```json
{
    "body": "CC:  @mkoeppe\n\nCurrently, gitpod tracks the branch on github as the remote. Thus, one might accidentally changes to github instead of trac. With this ticket, the remote is changed to trac. \n\nIssue created by migration from https://trac.sagemath.org/ticket/33589\n\n",
    "closed_at": "2022-04-03T11:13:40Z",
    "created_at": "2022-03-29T13:59:54Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Gitpod: track remote trac branch",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33589",
    "user": "https://github.com/tobiasdiez"
}
```
CC:  @mkoeppe

Currently, gitpod tracks the branch on github as the remote. Thus, one might accidentally changes to github instead of trac. With this ticket, the remote is changed to trac. 

Issue created by migration from https://trac.sagemath.org/ticket/33589





---

archive/issue_comments_474274.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-29T13:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474274",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474275.json:
```json
{
    "body": "I think `git remote set-url --push origin git`@`trac.sagemath.org:sage.git` would also be good to add",
    "created_at": "2022-03-29T19:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474275",
    "user": "https://github.com/mkoeppe"
}
```

I think `git remote set-url --push origin git`@`trac.sagemath.org:sage.git` would also be good to add



---

archive/issue_comments_474276.json:
```json
{
    "body": "Not sure if that's really a good idea. The git manual contains\n\n>Note that the push URL and the fetch URL, even though they can be set differently, must still refer to the same place. What you pushed to the push URL should be what you would see if you immediately fetched from the fetch URL. If you are trying to fetch from one place (e.g. your upstream) and push to another (e.g. your publishing repository), use two separate remotes.\n\n\n\nYour idea was to prevent accidental commits to github, right? Would it be possible to restrict write access for the trac mirror repo to only allow the sync-hook to have write access?",
    "created_at": "2022-03-29T19:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474276",
    "user": "https://github.com/tobiasdiez"
}
```

Not sure if that's really a good idea. The git manual contains

>Note that the push URL and the fetch URL, even though they can be set differently, must still refer to the same place. What you pushed to the push URL should be what you would see if you immediately fetched from the fetch URL. If you are trying to fetch from one place (e.g. your upstream) and push to another (e.g. your publishing repository), use two separate remotes.



Your idea was to prevent accidental commits to github, right? Would it be possible to restrict write access for the trac mirror repo to only allow the sync-hook to have write access?



---

archive/issue_comments_474277.json:
```json
{
    "body": "It's already documented as standard procedure in `src/doc/en/developer/manual_git.rst`",
    "created_at": "2022-03-29T19:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474277",
    "user": "https://github.com/mkoeppe"
}
```

It's already documented as standard procedure in `src/doc/en/developer/manual_git.rst`



---

archive/issue_comments_474278.json:
```json
{
    "body": "Where exactly? I can only find `git remote set-url --push trac git`@`trac.sagemath.org:sage.git` at https://doc.sagemath.org/html/en/developer/manual_git.html",
    "created_at": "2022-03-29T19:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474278",
    "user": "https://github.com/tobiasdiez"
}
```

Where exactly? I can only find `git remote set-url --push trac git`@`trac.sagemath.org:sage.git` at https://doc.sagemath.org/html/en/developer/manual_git.html



---

archive/issue_comments_474279.json:
```json
{
    "body": "Yes, that's the one.",
    "created_at": "2022-03-31T15:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474279",
    "user": "https://github.com/mkoeppe"
}
```

Yes, that's the one.



---

archive/issue_comments_474280.json:
```json
{
    "body": "This is already included in the gitpod config:\n\n```\n      git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)\n      git remote set-url --push trac git@trac.sagemath.org:sage.git\n      git fetch trac\n      git branch -u trac/$(git branch --show-current)\n```",
    "created_at": "2022-03-31T15:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474280",
    "user": "https://github.com/tobiasdiez"
}
```

This is already included in the gitpod config:

```
      git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)
      git remote set-url --push trac git@trac.sagemath.org:sage.git
      git fetch trac
      git branch -u trac/$(git branch --show-current)
```



---

archive/issue_comments_474281.json:
```json
{
    "body": "No, the first line is setting the wrong URL for fetching.",
    "created_at": "2022-03-31T15:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474281",
    "user": "https://github.com/mkoeppe"
}
```

No, the first line is setting the wrong URL for fetching.



---

archive/issue_comments_474282.json:
```json
{
    "body": "I took this from the docs: https://doc.sagemath.org/html/en/developer/manual_git.html#the-trac-server\n\n```\ngit remote add trac git@trac.sagemath.org:sage.git -t master\n```\nWhat is then the correct url?",
    "created_at": "2022-03-31T15:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474282",
    "user": "https://github.com/tobiasdiez"
}
```

I took this from the docs: https://doc.sagemath.org/html/en/developer/manual_git.html#the-trac-server

```
git remote add trac git@trac.sagemath.org:sage.git -t master
```
What is then the correct url?



---

archive/issue_comments_474283.json:
```json
{
    "body": "Further up in the same section.",
    "created_at": "2022-03-31T15:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474283",
    "user": "https://github.com/mkoeppe"
}
```

Further up in the same section.



---

archive/issue_comments_474284.json:
```json
{
    "body": "```\ngit remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master\n```\nDoes not work well. If you then push something to trac, VS still notifies you that there are changes between your local and remote branch. The reason is that VS invokes `git fetch` directly after pushing, but then the sync hook has not yet been executed so it still fetches the old branch on github.",
    "created_at": "2022-03-31T15:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474284",
    "user": "https://github.com/tobiasdiez"
}
```

```
git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master
```
Does not work well. If you then push something to trac, VS still notifies you that there are changes between your local and remote branch. The reason is that VS invokes `git fetch` directly after pushing, but then the sync hook has not yet been executed so it still fetches the old branch on github.



---

archive/issue_comments_474285.json:
```json
{
    "body": "OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.",
    "created_at": "2022-03-31T15:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474285",
    "user": "https://github.com/mkoeppe"
}
```

OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.



---

archive/issue_comments_474286.json:
```json
{
    "body": "We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.",
    "created_at": "2022-03-31T16:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474286",
    "user": "https://github.com/mkoeppe"
}
```

We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.



---

archive/issue_comments_474287.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.\n\n\nThe point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.",
    "created_at": "2022-03-31T16:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474287",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:12 mkoeppe]:
> OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.


The point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.



---

archive/issue_comments_474288.json:
```json
{
    "body": "Replying to [comment:13 mkoeppe]:\n> We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.\n\n\nWhat's the reason for this config in the first place? It is also against the git recommendations that I've cited above.",
    "created_at": "2022-03-31T16:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474288",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:13 mkoeppe]:
> We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.


What's the reason for this config in the first place? It is also against the git recommendations that I've cited above.



---

archive/issue_comments_474289.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> What's the reason for this config in the first place? It is also against the git recommendations that I've cited above.\n\n\nThat's what read-only mirrors are for - they scale better than 1 read/write server.\n\nI don't think that recommendation that you found in the doc is intended to rule out mirrors.",
    "created_at": "2022-03-31T16:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474289",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> What's the reason for this config in the first place? It is also against the git recommendations that I've cited above.


That's what read-only mirrors are for - they scale better than 1 read/write server.

I don't think that recommendation that you found in the doc is intended to rule out mirrors.



---

archive/issue_comments_474290.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> Replying to [comment:12 mkoeppe]:\n> > OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.\n  \n> \n> The point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.\n\n\nI think we shouldn't force users to do the SSH key thing if all they want to do is fetch from trac.",
    "created_at": "2022-03-31T16:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474290",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> Replying to [comment:12 mkoeppe]:
> > OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.
  
> 
> The point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.


I think we shouldn't force users to do the SSH key thing if all they want to do is fetch from trac.



---

archive/issue_comments_474291.json:
```json
{
    "body": "Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?\nBy the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too",
    "created_at": "2022-03-31T16:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474291",
    "user": "https://github.com/mkoeppe"
}
```

Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?
By the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too



---

archive/issue_comments_474292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T16:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474293.json:
```json
{
    "body": "Replying to [comment:18 mkoeppe]:\n> Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?\n> By the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too\n\n\nGood suggestion, thanks. I've implemented that now.",
    "created_at": "2022-03-31T16:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474293",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:18 mkoeppe]:
> Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?
> By the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too


Good suggestion, thanks. I've implemented that now.



---

archive/issue_comments_474294.json:
```json
{
    "body": "That should be \"-n \"${PRIVATE_SSH_KEY}\"`",
    "created_at": "2022-03-31T16:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474294",
    "user": "https://github.com/mkoeppe"
}
```

That should be "-n "${PRIVATE_SSH_KEY}"`



---

archive/issue_comments_474295.json:
```json
{
    "body": "Yes...",
    "created_at": "2022-03-31T16:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474295",
    "user": "https://github.com/tobiasdiez"
}
```

Yes...



---

archive/issue_comments_474296.json:
```json
{
    "body": "And everyone needs the `trac` remote. \nWhen `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.",
    "created_at": "2022-03-31T16:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474296",
    "user": "https://github.com/mkoeppe"
}
```

And everyone needs the `trac` remote. 
When `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.



---

archive/issue_comments_474297.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T16:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474298.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> And everyone needs the `trac` remote. \n> When `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.\n\n\nBut this is `origin` already, so where is the point of adding trac as the same alias?",
    "created_at": "2022-03-31T16:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474298",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:23 mkoeppe]:
> And everyone needs the `trac` remote. 
> When `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.


But this is `origin` already, so where is the point of adding trac as the same alias?



---

archive/issue_comments_474299.json:
```json
{
    "body": "`trac` is the name used in the developer's guide; and it is also the hardcoded name of the remote that is used in git-trac-command.",
    "created_at": "2022-03-31T16:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474299",
    "user": "https://github.com/mkoeppe"
}
```

`trac` is the name used in the developer's guide; and it is also the hardcoded name of the remote that is used in git-trac-command.



---

archive/issue_comments_474300.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T16:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474300",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474301.json:
```json
{
    "body": "```\n+      else\n+        # Fallback to sagemath mirror\n+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop\n+      fi\n+\n```\nbut only for fetch, not for push!",
    "created_at": "2022-03-31T16:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474301",
    "user": "https://github.com/mkoeppe"
}
```

```
+      else
+        # Fallback to sagemath mirror
+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop
+      fi
+
```
but only for fetch, not for push!



---

archive/issue_comments_474302.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T16:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474302",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474303.json:
```json
{
    "body": "This line should probably be run in both cases\n\n```\n+        git remote set-url --push origin pushing-only-via-trac\n```",
    "created_at": "2022-03-31T17:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474303",
    "user": "https://github.com/mkoeppe"
}
```

This line should probably be run in both cases

```
+        git remote set-url --push origin pushing-only-via-trac
```



---

archive/issue_comments_474304.json:
```json
{
    "body": "Also comment:12, comment:13",
    "created_at": "2022-03-31T17:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474304",
    "user": "https://github.com/mkoeppe"
}
```

Also comment:12, comment:13



---

archive/issue_comments_474305.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T17:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474305",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474306.json:
```json
{
    "body": "Replying to [comment:30 mkoeppe]:\n> This line should probably be run in both cases\n> \n> ```\n> +        git remote set-url --push origin pushing-only-via-trac\n> ```\n\n\nDone.",
    "created_at": "2022-03-31T17:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474306",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:30 mkoeppe]:
> This line should probably be run in both cases
> 
> ```
> +        git remote set-url --push origin pushing-only-via-trac
> ```


Done.



---

archive/issue_comments_474307.json:
```json
{
    "body": "Replying to [comment:31 mkoeppe]:\n> Also comment:12, comment:13\n\n\nI think comment:12 is obsolete now (or I misunderstand it), and comment:13 is not in the scope of this ticket.",
    "created_at": "2022-03-31T17:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474307",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:31 mkoeppe]:
> Also comment:12, comment:13


I think comment:12 is obsolete now (or I misunderstand it), and comment:13 is not in the scope of this ticket.



---

archive/issue_comments_474308.json:
```json
{
    "body": "comment:12 - when the user sets up the key the first time (https://620901c077fb7caa9f914f33--sagemath-tobias.netlify.app/developer/workspace.html#section-gitpod), the user needs to change the remote - this needs to be added to the instructions",
    "created_at": "2022-03-31T17:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474308",
    "user": "https://github.com/mkoeppe"
}
```

comment:12 - when the user sets up the key the first time (https://620901c077fb7caa9f914f33--sagemath-tobias.netlify.app/developer/workspace.html#section-gitpod), the user needs to change the remote - this needs to be added to the instructions



---

archive/issue_comments_474309.json:
```json
{
    "body": "```\n+        git remote remove trac # might still exists from a previous run/prebuild\n```\ndoes this not give an error if the remote is not there?",
    "created_at": "2022-03-31T17:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474309",
    "user": "https://github.com/mkoeppe"
}
```

```
+        git remote remove trac # might still exists from a previous run/prebuild
```
does this not give an error if the remote is not there?



---

archive/issue_comments_474310.json:
```json
{
    "body": "Replying to [comment:36 mkoeppe]:\n> {{{\n> +        git remote remove trac # might still exists from a previous run/prebuild\n> }}}\n> does this not give an error if the remote is not there?\n\n\nYes, it prints an error (during the prebuild) but the script keeps executing.",
    "created_at": "2022-03-31T18:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474310",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:36 mkoeppe]:
> {{{
> +        git remote remove trac # might still exists from a previous run/prebuild
> }}}
> does this not give an error if the remote is not there?


Yes, it prints an error (during the prebuild) but the script keeps executing.



---

archive/issue_comments_474311.json:
```json
{
    "body": "You can silence it by appending `2> /dev/null`",
    "created_at": "2022-03-31T18:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474311",
    "user": "https://github.com/mkoeppe"
}
```

You can silence it by appending `2> /dev/null`



---

archive/issue_comments_474312.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-31T18:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474313.json:
```json
{
    "body": "I've added comment:13 to #33088",
    "created_at": "2022-03-31T18:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474313",
    "user": "https://github.com/mkoeppe"
}
```

I've added comment:13 to #33088



---

archive/issue_comments_474314.json:
```json
{
    "body": "```\n+ 4. Close this Gitpod workspace.\n```\nOK, that's a good solution too",
    "created_at": "2022-03-31T18:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474314",
    "user": "https://github.com/mkoeppe"
}
```

```
+ 4. Close this Gitpod workspace.
```
OK, that's a good solution too



---

archive/issue_comments_474315.json:
```json
{
    "body": "I think all of these steps:\n\n```\n+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n```\nand\n\n```\n+        git remote set-url --push trac git@trac.sagemath.org:sage.git\n+        git fetch trac\n+        git branch -u trac/$(git branch --show-current)\n```\nshould be unconditional",
    "created_at": "2022-03-31T20:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474315",
    "user": "https://github.com/mkoeppe"
}
```

I think all of these steps:

```
+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
```
and

```
+        git remote set-url --push trac git@trac.sagemath.org:sage.git
+        git fetch trac
+        git branch -u trac/$(git branch --show-current)
```
should be unconditional



---

archive/issue_comments_474316.json:
```json
{
    "body": "Replying to [comment:42 mkoeppe]:\n> I think all of these steps:\n> \n> ```\n> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n> ```\n\n\nDuring the prebuild there is never a ssh key set, so the trac remote is always either unset or set to the github mirror.\n\n> and\n> \n> ```\n> +        git remote set-url --push trac git@trac.sagemath.org:sage.git\n> +        git fetch trac\n> +        git branch -u trac/$(git branch --show-current)\n> ```\n> should be unconditional\n\n\nFetching trac doesn't work without ssh keys (at least for me).",
    "created_at": "2022-03-31T21:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474316",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:42 mkoeppe]:
> I think all of these steps:
> 
> ```
> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
> ```


During the prebuild there is never a ssh key set, so the trac remote is always either unset or set to the github mirror.

> and
> 
> ```
> +        git remote set-url --push trac git@trac.sagemath.org:sage.git
> +        git fetch trac
> +        git branch -u trac/$(git branch --show-current)
> ```
> should be unconditional


Fetching trac doesn't work without ssh keys (at least for me).



---

archive/issue_comments_474317.json:
```json
{
    "body": "Replying to [comment:43 gh-tobiasdiez]:\n> Fetching trac doesn't work without ssh keys (at least for me).\n\n\nIt doesn't if the remote is ssh, which is why we have changed that.",
    "created_at": "2022-03-31T22:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474317",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:43 gh-tobiasdiez]:
> Fetching trac doesn't work without ssh keys (at least for me).


It doesn't if the remote is ssh, which is why we have changed that.



---

archive/issue_comments_474318.json:
```json
{
    "body": "I don't get what you want.\n\n```\n+        git remote set-url --push trac git@trac.sagemath.org:sage.git\n```\nis in conflict with\n\n```\n+        git remote set-url --push trac pushing-needs-ssh-key\n```\nSince the ssh setup is more involved for gitpod, its better in my opinion to explicitly tell the user that something is off so he might look this up in the docs.\n\nPs: can we please migrate to github/gitlab; their server are beefy enough to don't need a special mirror setup ;-)",
    "created_at": "2022-03-31T23:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474318",
    "user": "https://github.com/tobiasdiez"
}
```

I don't get what you want.

```
+        git remote set-url --push trac git@trac.sagemath.org:sage.git
```
is in conflict with

```
+        git remote set-url --push trac pushing-needs-ssh-key
```
Since the ssh setup is more involved for gitpod, its better in my opinion to explicitly tell the user that something is off so he might look this up in the docs.

Ps: can we please migrate to github/gitlab; their server are beefy enough to don't need a special mirror setup ;-)



---

archive/issue_comments_474319.json:
```json
{
    "body": "I mean like this (untested).\n\n```\ndiff --git a/.gitpod.yml b/.gitpod.yml\nindex 7c6800ab8f..8244bafae9 100644\n--- a/.gitpod.yml\n+++ b/.gitpod.yml\n@@ -36,7 +36,9 @@ image:\n tasks:\n   - name: Setup\n     before: |\n+      git remote set-url --push origin pushing-only-via-trac\n       # Setup trac as remote\n+      git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n       ## In order to push to trac, generate a new key with `ssh-keygen -f tempkey` and save the private key to gitpod `gp env PRIVATE_SSH_KEY=\"$(<tempkey)\"` (or by following https://www.gitpod.io/docs/environment-variables#using-the-account-settings)\n       ## then follow https://doc.sagemath.org/html/en/developer/trac.html#linking-your-public-key-to-your-trac-account to register the public key with trac.\n       ## Afterwards, create a new gitpod workspace.\n@@ -50,18 +52,15 @@ tasks:\n         ssh-keyscan -H trac.sagemath.org >> ~/.ssh/known_hosts\n \n         # Setup trac repo\n-        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n         git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)\n         git remote set-url --push trac git@trac.sagemath.org:sage.git\n-        git fetch trac\n-        git branch -u trac/$(git branch --show-current)\n-        git remote set-url --push origin pushing-only-via-trac\n       else\n         # Fallback to sagemath mirror\n-        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop\n+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop -t $(git branch --show-current)\n         git remote set-url --push trac pushing-needs-ssh-key\n-        git remote set-url --push origin pushing-only-via-trac\n       fi\n+      git fetch trac\n+      git branch -u trac/$(git branch --show-current)\n       \n       ## No need for pyenv\n       pyenv shell --unset 2> /dev/null\n```",
    "created_at": "2022-03-31T23:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474319",
    "user": "https://github.com/mkoeppe"
}
```

I mean like this (untested).

```
diff --git a/.gitpod.yml b/.gitpod.yml
index 7c6800ab8f..8244bafae9 100644
--- a/.gitpod.yml
+++ b/.gitpod.yml
@@ -36,7 +36,9 @@ image:
 tasks:
   - name: Setup
     before: |
+      git remote set-url --push origin pushing-only-via-trac
       # Setup trac as remote
+      git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
       ## In order to push to trac, generate a new key with `ssh-keygen -f tempkey` and save the private key to gitpod `gp env PRIVATE_SSH_KEY="$(<tempkey)"` (or by following https://www.gitpod.io/docs/environment-variables#using-the-account-settings)
       ## then follow https://doc.sagemath.org/html/en/developer/trac.html#linking-your-public-key-to-your-trac-account to register the public key with trac.
       ## Afterwards, create a new gitpod workspace.
@@ -50,18 +52,15 @@ tasks:
         ssh-keyscan -H trac.sagemath.org >> ~/.ssh/known_hosts
 
         # Setup trac repo
-        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
         git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)
         git remote set-url --push trac git@trac.sagemath.org:sage.git
-        git fetch trac
-        git branch -u trac/$(git branch --show-current)
-        git remote set-url --push origin pushing-only-via-trac
       else
         # Fallback to sagemath mirror
-        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop
+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop -t $(git branch --show-current)
         git remote set-url --push trac pushing-needs-ssh-key
-        git remote set-url --push origin pushing-only-via-trac
       fi
+      git fetch trac
+      git branch -u trac/$(git branch --show-current)
       
       ## No need for pyenv
       pyenv shell --unset 2> /dev/null
```



---

archive/issue_comments_474320.json:
```json
{
    "body": "That would work, I guess. But I fail to see the point of setting the upstream to \"trac\" even if you don't have the ssh keys configured. Why change the gitpod default? \n\nI would like to leave the whole trac remote business as minimal as possible.",
    "created_at": "2022-04-01T00:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474320",
    "user": "https://github.com/tobiasdiez"
}
```

That would work, I guess. But I fail to see the point of setting the upstream to "trac" even if you don't have the ssh keys configured. Why change the gitpod default? 

I would like to leave the whole trac remote business as minimal as possible.



---

archive/issue_comments_474321.json:
```json
{
    "body": "Replying to [comment:47 gh-tobiasdiez]:\n> That would work, I guess. But I fail to see the point of setting the upstream to \"trac\" even if you don't have the ssh keys configured. \n\n\nBecause it means that there are fewer differences between \"without ssh key\" and \"with ssh key\", which reduces the complexity in explaining it to developers?",
    "created_at": "2022-04-01T00:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474321",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:47 gh-tobiasdiez]:
> That would work, I guess. But I fail to see the point of setting the upstream to "trac" even if you don't have the ssh keys configured. 


Because it means that there are fewer differences between "without ssh key" and "with ssh key", which reduces the complexity in explaining it to developers?



---

archive/issue_comments_474322.json:
```json
{
    "body": "If you cannot push anything, then you don't need to worry about trac at all. Everything you need is in \"origin\". The remove trac is only added because of the limitations of git-trac you mentioned above.",
    "created_at": "2022-04-01T00:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474322",
    "user": "https://github.com/tobiasdiez"
}
```

If you cannot push anything, then you don't need to worry about trac at all. Everything you need is in "origin". The remove trac is only added because of the limitations of git-trac you mentioned above.



---

archive/issue_comments_474323.json:
```json
{
    "body": "OK, I think this makes sense",
    "created_at": "2022-04-01T00:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474323",
    "user": "https://github.com/mkoeppe"
}
```

OK, I think this makes sense



---

archive/issue_comments_474324.json:
```json
{
    "body": "Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the \"else\" branch only when `origin` is in the `sagemath` organization.",
    "created_at": "2022-04-01T00:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474324",
    "user": "https://github.com/mkoeppe"
}
```

Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the "else" branch only when `origin` is in the `sagemath` organization.



---

archive/issue_comments_474325.json:
```json
{
    "body": "And I'd still prefer to move the line\n\n```\n+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n```\nto the very beginning so that it runs in both cases - it's easier to understand that it is correct",
    "created_at": "2022-04-01T00:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474325",
    "user": "https://github.com/mkoeppe"
}
```

And I'd still prefer to move the line

```
+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
```
to the very beginning so that it runs in both cases - it's easier to understand that it is correct



---

archive/issue_comments_474326.json:
```json
{
    "body": "Replying to [comment:51 mkoeppe]:\n> Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the \"else\" branch only when `origin` is in the `sagemath` organization.\n\n\nDo you know how/with which credentials the sync hook pushes to the github mirror? Maybe its easy to setup a branch protection rule that would prevent any pushes to the mirror (except for the syncs).",
    "created_at": "2022-04-01T00:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474326",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:51 mkoeppe]:
> Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the "else" branch only when `origin` is in the `sagemath` organization.


Do you know how/with which credentials the sync hook pushes to the github mirror? Maybe its easy to setup a branch protection rule that would prevent any pushes to the mirror (except for the syncs).



---

archive/issue_comments_474327.json:
```json
{
    "body": "No idea, sorry",
    "created_at": "2022-04-01T05:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474327",
    "user": "https://github.com/mkoeppe"
}
```

No idea, sorry



---

archive/issue_comments_474328.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-01T14:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474328",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474329.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-01T14:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474329",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474330.json:
```json
{
    "body": "According to \n\n```\ncurl -H \"Accept: application/vnd.github.v3+json\" https://api.github.com/networks/sagemath/sagetrac-mirror/events?per_page=100 | ConvertFrom-Json | where { $_.type -eq \"PushEvent\" } | Select actor\n```\nit is always `sageb0t`. I've now added a branch protection rule, see https://groups.google.com/g/sage-devel/c/Z1rx_uP7LtY. Thus the special handling of origin is no longer needed.",
    "created_at": "2022-04-01T14:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474330",
    "user": "https://github.com/tobiasdiez"
}
```

According to 

```
curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/networks/sagemath/sagetrac-mirror/events?per_page=100 | ConvertFrom-Json | where { $_.type -eq "PushEvent" } | Select actor
```
it is always `sageb0t`. I've now added a branch protection rule, see https://groups.google.com/g/sage-devel/c/Z1rx_uP7LtY. Thus the special handling of origin is no longer needed.



---

archive/issue_comments_474331.json:
```json
{
    "body": "Replying to [comment:52 mkoeppe]:\n> And I'd still prefer to move the line\n> \n> ```\n> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild\n> ```\n> to the very beginning so that it runs in both cases - it's easier to understand that it is correct\n\n\nI agree.",
    "created_at": "2022-04-01T14:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474331",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:52 mkoeppe]:
> And I'd still prefer to move the line
> 
> ```
> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
> ```
> to the very beginning so that it runs in both cases - it's easier to understand that it is correct


I agree.



---

archive/issue_comments_474332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-01T14:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474333.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-01T15:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474333",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474334.json:
```json
{
    "body": "Thanks for the review and the many helpful suggestions!",
    "created_at": "2022-04-01T16:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474334",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the review and the many helpful suggestions!



---

archive/issue_comments_474335.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-03T11:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-474335",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088381.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-03T11:13:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33589#event-88381"
}
```
