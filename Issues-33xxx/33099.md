# Issue 33099: Build Docker images on GH Actions

archive/issues_032862.json:
```json
{
    "body": "As suggested in https://groups.google.com/g/sage-devel/c/jIwovtSXtdw/m/2HR5RraTCwAJ, we set up a GH Actions workflow for building Docker images, replacing the GitLab workflow.\n\nThis ticket is focused on replicating the features of the GitLab workflow, in particular the incremental build and the distinction of `sagemath` and `sagemath-dev` builds.\n\nSee also:\n- #29536 Make docker images from tox/GitHub CI workflow, regular Sage Docker images, and gitpod interoperable\n\n\nCC:  @saraedum @koffie @dimpase @tobiasdiez\n\nBranch: [u/mkoeppe/build_docker_images_on_gh_actions](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build_docker_images_on_gh_actions)\n\nCommit: [a4f05e2bd25edcef9987ef581e9c3dc363fef12a](https://github.com/sagemath/sagetrac-mirror/commit/a4f05e2bd25edcef9987ef581e9c3dc363fef12a)\n\nAuthor: Matthias Koeppe, ...\n\nStatus: new\n\nDependencies: #29784\n\nIssue created by migration from https://trac.sagemath.org/ticket/33099\n\n",
    "created_at": "2021-12-30T18:18:45Z",
    "labels": [
        "component: docker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-pending",
    "title": "Build Docker images on GH Actions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33099",
    "user": "https://github.com/mkoeppe"
}
```
As suggested in https://groups.google.com/g/sage-devel/c/jIwovtSXtdw/m/2HR5RraTCwAJ, we set up a GH Actions workflow for building Docker images, replacing the GitLab workflow.

This ticket is focused on replicating the features of the GitLab workflow, in particular the incremental build and the distinction of `sagemath` and `sagemath-dev` builds.

See also:
- #29536 Make docker images from tox/GitHub CI workflow, regular Sage Docker images, and gitpod interoperable


CC:  @saraedum @koffie @dimpase @tobiasdiez

Branch: [u/mkoeppe/build_docker_images_on_gh_actions](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build_docker_images_on_gh_actions)

Commit: [a4f05e2bd25edcef9987ef581e9c3dc363fef12a](https://github.com/sagemath/sagetrac-mirror/commit/a4f05e2bd25edcef9987ef581e9c3dc363fef12a)

Author: Matthias Koeppe, ...

Status: new

Dependencies: #29784

Issue created by migration from https://trac.sagemath.org/ticket/33099





---

archive/issue_comments_660044.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#29784\"",
    "created_at": "2021-12-30T18:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660044",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#29784"



---

archive/issue_comments_660045.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/build_docker_images_on_gh_actions\"",
    "created_at": "2021-12-30T18:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660045",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/build_docker_images_on_gh_actions"



---

archive/issue_comments_660046.json:
```json
{
    "body": "Changing commit from \"\" to \"5e0ae74bb0d1467a0ba16242df22c8eb95da6a02\"",
    "created_at": "2021-12-30T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660046",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "5e0ae74bb0d1467a0ba16242df22c8eb95da6a02"



---

archive/issue_comments_660047.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|\n|[5e0ae74](https://github.com/sagemath/sagetrac-mirror/commit/5e0ae74bb0d1467a0ba16242df22c8eb95da6a02)|`.github/workflows/docker.yml: New`|",
    "created_at": "2021-12-30T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
|[5e0ae74](https://github.com/sagemath/sagetrac-mirror/commit/5e0ae74bb0d1467a0ba16242df22c8eb95da6a02)|`.github/workflows/docker.yml: New`|



---

archive/issue_comments_660048.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis gets me to: \n\n```\nStep 30/50 : RUN git fetch \"$HOME/sage-context\" HEAD     && if [ -e docker/.commit ]; then           git reset `cat docker/.commit`           || ( echo \"Could not find commit `cat docker/.commit` in your local Git history. Please merge in the latest built develop branch to fix this: git fetch trac && git merge `cat docker/.commit`.\" && exit 1 )        else           echo \"You are building from $ARTIFACT_BASE which has no docker/.commit file. That's a bug unless you are building from source-clean or something similar.\"           && git reset FETCH_HEAD           && git checkout -f FETCH_HEAD;        fi     && git merge --ff-only FETCH_HEAD     && git log -1 --format=%H > docker/.commit     && rm -rf .git\n ---> Running in f1263c0d1624\nwarning: reject HEAD because shallow roots are not allowed to be updated\nfatal: Could not parse object 'fbca269f627bf6a8bc6f0a611ed7e26260ebc994'.\n```\n(https://github.com/mkoeppe/sage/runs/4669053076?check_suite_focus=true)\n\nHelp welcome",
    "created_at": "2021-12-30T18:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660048",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
This gets me to: 

```
Step 30/50 : RUN git fetch "$HOME/sage-context" HEAD     && if [ -e docker/.commit ]; then           git reset `cat docker/.commit`           || ( echo "Could not find commit `cat docker/.commit` in your local Git history. Please merge in the latest built develop branch to fix this: git fetch trac && git merge `cat docker/.commit`." && exit 1 )        else           echo "You are building from $ARTIFACT_BASE which has no docker/.commit file. That's a bug unless you are building from source-clean or something similar."           && git reset FETCH_HEAD           && git checkout -f FETCH_HEAD;        fi     && git merge --ff-only FETCH_HEAD     && git log -1 --format=%H > docker/.commit     && rm -rf .git
 ---> Running in f1263c0d1624
warning: reject HEAD because shallow roots are not allowed to be updated
fatal: Could not parse object 'fbca269f627bf6a8bc6f0a611ed7e26260ebc994'.
```
(https://github.com/mkoeppe/sage/runs/4669053076?check_suite_focus=true)

Help welcome



---

archive/issue_comments_660049.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe, ...\"",
    "created_at": "2021-12-30T18:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660049",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe, ..."



---

archive/issue_comments_660050.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe problem is clearly [this fetch](https://github.com/sagemath/sage/blob/c5af19568ca95680a9f58511b6e1920e1438737a/docker/Dockerfile#L130). The fetch occurs between ( `$HOME/sage-context` and `SAGE_ROOT=/home/sage/sage` ) come from. `SAGE_ROOT` is the sage repo that was previously build (i.e. the $ARTIFACT_BASE which I'm guessing is sagemath/sagemath-dev:develop at this point). And the code of the github branch that triggered this action should be in `$HOME/sage-context` if I am not mistaken. Either of these repositories is shallow (and I am not 100% sure which one, but I am guessing `$HOME/sage-context`) and the rest of this is written with that in mind.\n\nBefore attempting to fetch from `sage-context` we should first test whether it is shallow by setting that repo as our WORKDIR and do \n\n```\ngit rev-parse --is-shallow-repository\n```\n\nIf I am correct this should evaluate to True. If so we should unshallow it. My preferred way would be to make sure that we get an unshallow repo by using by passing the correct arguments to the `actions/checkout`@`v2` command, however I don't know whether that is possible. Otherwise we should unshallow the relevant repository first by fetching all of the history using:\n\n```\ngit fetch --unshallow\n```\n\nThis unshallowing will of course only work if the shallow clone has a remote configured that is not shallow, so if unshallowing fails we should probably first set the remote of the `sage-context` to something sensible (I guess preferrably the github mirror since we are on github anyway).\n\nHope this helps.\n\np.s. this entire `source-from-context` target in the Dockerfile feels super hacky, and I am wondering whether build times can be kept down to something reasonable with other means.",
    "created_at": "2021-12-30T22:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660050",
    "user": "https://github.com/koffie"
}
```

<a id='comment:5'></a>
The problem is clearly [this fetch](https://github.com/sagemath/sage/blob/c5af19568ca95680a9f58511b6e1920e1438737a/docker/Dockerfile#L130). The fetch occurs between ( `$HOME/sage-context` and `SAGE_ROOT=/home/sage/sage` ) come from. `SAGE_ROOT` is the sage repo that was previously build (i.e. the $ARTIFACT_BASE which I'm guessing is sagemath/sagemath-dev:develop at this point). And the code of the github branch that triggered this action should be in `$HOME/sage-context` if I am not mistaken. Either of these repositories is shallow (and I am not 100% sure which one, but I am guessing `$HOME/sage-context`) and the rest of this is written with that in mind.

Before attempting to fetch from `sage-context` we should first test whether it is shallow by setting that repo as our WORKDIR and do 

```
git rev-parse --is-shallow-repository
```

If I am correct this should evaluate to True. If so we should unshallow it. My preferred way would be to make sure that we get an unshallow repo by using by passing the correct arguments to the `actions/checkout`@`v2` command, however I don't know whether that is possible. Otherwise we should unshallow the relevant repository first by fetching all of the history using:

```
git fetch --unshallow
```

This unshallowing will of course only work if the shallow clone has a remote configured that is not shallow, so if unshallowing fails we should probably first set the remote of the `sage-context` to something sensible (I guess preferrably the github mirror since we are on github anyway).

Hope this helps.

p.s. this entire `source-from-context` target in the Dockerfile feels super hacky, and I am wondering whether build times can be kept down to something reasonable with other means.



---

archive/issue_comments_660051.json:
```json
{
    "body": "<a id='comment:6'></a>\nThanks. I'm trying if setting the `fetch-depth` parameter helps in https://github.com/mkoeppe/sage/runs/4670244759?check_suite_focus=true",
    "created_at": "2021-12-30T22:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660051",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Thanks. I'm trying if setting the `fetch-depth` parameter helps in https://github.com/mkoeppe/sage/runs/4670244759?check_suite_focus=true



---

archive/issue_comments_660052.json:
```json
{
    "body": "Changing commit from \"5e0ae74bb0d1467a0ba16242df22c8eb95da6a02\" to \"cd9ec81a81aa04705cc9d7d9afe85a5e6277b541\"",
    "created_at": "2021-12-30T22:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5e0ae74bb0d1467a0ba16242df22c8eb95da6a02" to "cd9ec81a81aa04705cc9d7d9afe85a5e6277b541"



---

archive/issue_comments_660053.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[cd9ec81](https://github.com/sagemath/sagetrac-mirror/commit/cd9ec81a81aa04705cc9d7d9afe85a5e6277b541)|`.github/workflows/docker.yml: Set fetch-depth`|",
    "created_at": "2021-12-30T22:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[cd9ec81](https://github.com/sagemath/sagetrac-mirror/commit/cd9ec81a81aa04705cc9d7d9afe85a5e6277b541)|`.github/workflows/docker.yml: Set fetch-depth`|



---

archive/issue_comments_660054.json:
```json
{
    "body": "<a id='comment:8'></a>\nOk, if the value of 5000 is not enough then 2147483647 = 2<sup>31</sup> - 1 is the largest value that git can still handle.",
    "created_at": "2021-12-30T22:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660054",
    "user": "https://github.com/koffie"
}
```

<a id='comment:8'></a>
Ok, if the value of 5000 is not enough then 2147483647 = 2<sup>31</sup> - 1 is the largest value that git can still handle.



---

archive/issue_comments_660055.json:
```json
{
    "body": "<a id='comment:9'></a>\nThe error is cleared but it looks like it is building the version that comes with the latest published `sagemath-dev` image (some 9.3.beta)",
    "created_at": "2021-12-30T23:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660055",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
The error is cleared but it looks like it is building the version that comes with the latest published `sagemath-dev` image (some 9.3.beta)



---

archive/issue_comments_660056.json:
```json
{
    "body": "<a id='comment:10'></a>\nI'm thinking that this is to be expected because according to: https://hub.docker.com/r/sagemath/sagemath-dev/tags?page=1\n\nJulian (saraedum) only pushed sage 9.4 to the `latest` and the `9.4` tags and not the `develop` tag when he manually updated the docker images while our gitlab CI was broken. I think this is not a problem caused by the CI code, but should be fixable by pushing the correct build to docker hub once manually to bootstrap the entire process.",
    "created_at": "2021-12-30T23:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660056",
    "user": "https://github.com/koffie"
}
```

<a id='comment:10'></a>
I'm thinking that this is to be expected because according to: https://hub.docker.com/r/sagemath/sagemath-dev/tags?page=1

Julian (saraedum) only pushed sage 9.4 to the `latest` and the `9.4` tags and not the `develop` tag when he manually updated the docker images while our gitlab CI was broken. I think this is not a problem caused by the CI code, but should be fixable by pushing the correct build to docker hub once manually to bootstrap the entire process.



---

archive/issue_comments_660057.json:
```json
{
    "body": "<a id='comment:11'></a>\nWell that's the correct base but it should surely be building the current sources!",
    "created_at": "2021-12-30T23:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660057",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Well that's the correct base but it should surely be building the current sources!



---

archive/issue_comments_660058.json:
```json
{
    "body": "Changing commit from \"cd9ec81a81aa04705cc9d7d9afe85a5e6277b541\" to \"931926d1a3c501642c4ebbd8b8ce71de6b5008dd\"",
    "created_at": "2021-12-30T23:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660058",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cd9ec81a81aa04705cc9d7d9afe85a5e6277b541" to "931926d1a3c501642c4ebbd8b8ce71de6b5008dd"



---

archive/issue_comments_660059.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[931926d](https://github.com/sagemath/sagetrac-mirror/commit/931926d1a3c501642c4ebbd8b8ce71de6b5008dd)|`.github/workflows/docker.yml: Also set CI_COMMIT_SHA`|",
    "created_at": "2021-12-30T23:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660059",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[931926d](https://github.com/sagemath/sagetrac-mirror/commit/931926d1a3c501642c4ebbd8b8ce71de6b5008dd)|`.github/workflows/docker.yml: Also set CI_COMMIT_SHA`|



---

archive/issue_comments_660060.json:
```json
{
    "body": "<a id='comment:13'></a>\nThis whole patching business does not work:\n\n```\nStep 32/50 : RUN if git status --porcelain | read CHANGES; then         git -c user.name=docker-build -c user.email=docker-build@sage.invalid stash -u         && git stash show -p > \"$HOME\"/sage-context.patch;     else         touch \"$HOME\"/sage-context.patch;     fi\n ---> Running in 5a7e47032090\nRemoving intermediate container 5a7e47032090\n ---> ac803f77917f\nStep 33/50 : WORKDIR $SAGE_ROOT\n ---> Running in e5f79bbb0c52\nRemoving intermediate container e5f79bbb0c52\n ---> f51686240290\nStep 34/50 : RUN patch -p1 --verbose < \"$HOME\"/sage-context.patch\n ---> Running in 8973a252aee1\nHmm...  I can't seem to find a patch in there anywhere.\n```",
    "created_at": "2021-12-31T00:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660060",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
This whole patching business does not work:

```
Step 32/50 : RUN if git status --porcelain | read CHANGES; then         git -c user.name=docker-build -c user.email=docker-build@sage.invalid stash -u         && git stash show -p > "$HOME"/sage-context.patch;     else         touch "$HOME"/sage-context.patch;     fi
 ---> Running in 5a7e47032090
Removing intermediate container 5a7e47032090
 ---> ac803f77917f
Step 33/50 : WORKDIR $SAGE_ROOT
 ---> Running in e5f79bbb0c52
Removing intermediate container e5f79bbb0c52
 ---> f51686240290
Step 34/50 : RUN patch -p1 --verbose < "$HOME"/sage-context.patch
 ---> Running in 8973a252aee1
Hmm...  I can't seem to find a patch in there anywhere.
```



---

archive/issue_comments_660061.json:
```json
{
    "body": "Changing commit from \"931926d1a3c501642c4ebbd8b8ce71de6b5008dd\" to \"86eca94de9857fe23e74d06243cce8633f7b6c25\"",
    "created_at": "2021-12-31T00:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660061",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "931926d1a3c501642c4ebbd8b8ce71de6b5008dd" to "86eca94de9857fe23e74d06243cce8633f7b6c25"



---

archive/issue_comments_660062.json:
```json
{
    "body": "<a id='comment:14'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[86eca94](https://github.com/sagemath/sagetrac-mirror/commit/86eca94de9857fe23e74d06243cce8633f7b6c25)|`docker/Dockerfile: Use patch --verbose`|",
    "created_at": "2021-12-31T00:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660062",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[86eca94](https://github.com/sagemath/sagetrac-mirror/commit/86eca94de9857fe23e74d06243cce8633f7b6c25)|`docker/Dockerfile: Use patch --verbose`|



---

archive/issue_comments_660063.json:
```json
{
    "body": "Changing commit from \"86eca94de9857fe23e74d06243cce8633f7b6c25\" to \"be139ca97f43b139b2af88f7b387033574cacc9e\"",
    "created_at": "2021-12-31T00:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "86eca94de9857fe23e74d06243cce8633f7b6c25" to "be139ca97f43b139b2af88f7b387033574cacc9e"



---

archive/issue_comments_660064.json:
```json
{
    "body": "<a id='comment:15'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[be139ca](https://github.com/sagemath/sagetrac-mirror/commit/be139ca97f43b139b2af88f7b387033574cacc9e)|`.github/workflows/docker.yml: Try with fetch-depth=0`|",
    "created_at": "2021-12-31T00:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[be139ca](https://github.com/sagemath/sagetrac-mirror/commit/be139ca97f43b139b2af88f7b387033574cacc9e)|`.github/workflows/docker.yml: Try with fetch-depth=0`|



---

archive/issue_comments_660065.json:
```json
{
    "body": "<a id='comment:16'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|\n|[ab0c87d](https://github.com/sagemath/sagetrac-mirror/commit/ab0c87d9cbc54268c7fe198ed9dc742cad7fea0f)|`docker/Dockerfile: Use V=0 with make`|\n|[58d3b53](https://github.com/sagemath/sagetrac-mirror/commit/58d3b536d1fdfe2e589b37658baca21262883640)|`docker/Dockerfile: Install gettext for bootstrap`|\n|[4f03c06](https://github.com/sagemath/sagetrac-mirror/commit/4f03c06d41fc524a19ce80ce950c6963c57b2af4)|`docker/Dockerfile: Use DEBIAN_FRONTEND=noninteractive with apt-get install`|",
    "created_at": "2021-12-31T01:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660065",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
|[ab0c87d](https://github.com/sagemath/sagetrac-mirror/commit/ab0c87d9cbc54268c7fe198ed9dc742cad7fea0f)|`docker/Dockerfile: Use V=0 with make`|
|[58d3b53](https://github.com/sagemath/sagetrac-mirror/commit/58d3b536d1fdfe2e589b37658baca21262883640)|`docker/Dockerfile: Install gettext for bootstrap`|
|[4f03c06](https://github.com/sagemath/sagetrac-mirror/commit/4f03c06d41fc524a19ce80ce950c6963c57b2af4)|`docker/Dockerfile: Use DEBIAN_FRONTEND=noninteractive with apt-get install`|



---

archive/issue_comments_660066.json:
```json
{
    "body": "Changing commit from \"be139ca97f43b139b2af88f7b387033574cacc9e\" to \"4f03c06d41fc524a19ce80ce950c6963c57b2af4\"",
    "created_at": "2021-12-31T01:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "be139ca97f43b139b2af88f7b387033574cacc9e" to "4f03c06d41fc524a19ce80ce950c6963c57b2af4"



---

archive/issue_comments_660067.json:
```json
{
    "body": "<a id='comment:17'></a>\nOK, with `fetch-depth=0` it seems to be working\n\n```\nStep 30/50 : RUN git fetch \"$HOME/sage-context\" HEAD     && if [ -e docker/.commit ]; then           git reset `cat docker/.commit`           || ( echo \"Could not find commit `cat docker/.commit` in your local Git history. Please merge in the latest built develop branch to fix this: git fetch trac && git merge `cat docker/.commit`.\" && exit 1 )        else           echo \"You are building from $ARTIFACT_BASE which has no docker/.commit file. That's a bug unless you are building from source-clean or something similar.\"           && git reset FETCH_HEAD           && git checkout -f FETCH_HEAD;        fi     && git merge --ff-only FETCH_HEAD     && git log -1 --format=%H > docker/.commit     && rm -rf .git\n ---> Running in 8fdb2d75b70f\nFrom /home/sage/sage-context\n * branch                  HEAD       -> FETCH_HEAD\n\nIt took 2.59 seconds to enumerate unstaged changes after reset.  You can\nuse '--quiet' to avoid this.  Set the config setting reset.quiet to true\nto make this the default.\nUpdating fbca269f62..4f03c06d41\nFast-forward\n .github/workflows/ci-cygwin-minimal.yml            |    48 +-\n .github/workflows/ci-cygwin-standard.yml           |    48 +-\n .github/workflows/docker.yml                       |    39 +\n .github/workflows/extract-sage-local.sh            |     4 +-\n .github/workflows/lint.yml                         |    16 +-\n ...\n```",
    "created_at": "2021-12-31T01:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660067",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
OK, with `fetch-depth=0` it seems to be working

```
Step 30/50 : RUN git fetch "$HOME/sage-context" HEAD     && if [ -e docker/.commit ]; then           git reset `cat docker/.commit`           || ( echo "Could not find commit `cat docker/.commit` in your local Git history. Please merge in the latest built develop branch to fix this: git fetch trac && git merge `cat docker/.commit`." && exit 1 )        else           echo "You are building from $ARTIFACT_BASE which has no docker/.commit file. That's a bug unless you are building from source-clean or something similar."           && git reset FETCH_HEAD           && git checkout -f FETCH_HEAD;        fi     && git merge --ff-only FETCH_HEAD     && git log -1 --format=%H > docker/.commit     && rm -rf .git
 ---> Running in 8fdb2d75b70f
From /home/sage/sage-context
 * branch                  HEAD       -> FETCH_HEAD

It took 2.59 seconds to enumerate unstaged changes after reset.  You can
use '--quiet' to avoid this.  Set the config setting reset.quiet to true
to make this the default.
Updating fbca269f62..4f03c06d41
Fast-forward
 .github/workflows/ci-cygwin-minimal.yml            |    48 +-
 .github/workflows/ci-cygwin-standard.yml           |    48 +-
 .github/workflows/docker.yml                       |    39 +
 .github/workflows/extract-sage-local.sh            |     4 +-
 .github/workflows/lint.yml                         |    16 +-
 ...
```



---

archive/issue_comments_660068.json:
```json
{
    "body": "<a id='comment:18'></a>\nAnd now I'm running into what this warning warns about:\n\n```\n# Warning: If you set ARTIFACT_BASE to something else than source-clean, the   #\n# build is not going to use the build-time-dependencies target but rely on     #\n# whatever tools are installed in ARTIFACT_BASE.                               #\n```",
    "created_at": "2021-12-31T02:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660068",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
And now I'm running into what this warning warns about:

```
# Warning: If you set ARTIFACT_BASE to something else than source-clean, the   #
# build is not going to use the build-time-dependencies target but rely on     #
# whatever tools are installed in ARTIFACT_BASE.                               #
```



---

archive/issue_comments_660069.json:
```json
{
    "body": "<a id='comment:19'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[d1db07e](https://github.com/sagemath/sagetrac-mirror/commit/d1db07ebd20789773742bdf1b0369264a6f028f1)|`docker/Dockerfile (make-build): Make sure build deps are present`|\n|[a4f05e2](https://github.com/sagemath/sagetrac-mirror/commit/a4f05e2bd25edcef9987ef581e9c3dc363fef12a)|`.github/workflows/docker.yml: Add deployment step`|",
    "created_at": "2021-12-31T04:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[d1db07e](https://github.com/sagemath/sagetrac-mirror/commit/d1db07ebd20789773742bdf1b0369264a6f028f1)|`docker/Dockerfile (make-build): Make sure build deps are present`|
|[a4f05e2](https://github.com/sagemath/sagetrac-mirror/commit/a4f05e2bd25edcef9987ef581e9c3dc363fef12a)|`.github/workflows/docker.yml: Add deployment step`|



---

archive/issue_comments_660070.json:
```json
{
    "body": "Changing commit from \"4f03c06d41fc524a19ce80ce950c6963c57b2af4\" to \"a4f05e2bd25edcef9987ef581e9c3dc363fef12a\"",
    "created_at": "2021-12-31T04:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660070",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4f03c06d41fc524a19ce80ce950c6963c57b2af4" to "a4f05e2bd25edcef9987ef581e9c3dc363fef12a"



---

archive/issue_comments_660071.json:
```json
{
    "body": "<a id='comment:20'></a>\nWhy is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. \n\nI would also suggest to use the docker action to build and publish the image: https://github.com/marketplace/actions/build-and-push-docker-images",
    "created_at": "2021-12-31T12:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660071",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:20'></a>
Why is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. 

I would also suggest to use the docker action to build and publish the image: https://github.com/marketplace/actions/build-and-push-docker-images



---

archive/issue_comments_660072.json:
```json
{
    "body": "<a id='comment:21'></a>\nI heard from Julian that right now the docker build process takes 8 hours on his computer due to #32998 . I am all for simplifying the docker file so that it fits within the github actions CI timeout. \n\n\nThe max timeout for a single job on github actions is 6 hours so if #32998 is fixed this should be possible. If that is not enough, we could have multiple jobs for different parts of the build process split up according to different docker targets, pushing the different stages separately to dockerhub.\n\nAlso right now the Dockerfile installs almost no system packages iirc, so it could also be sped up by using more of those instead of building everything ourselves.",
    "created_at": "2021-12-31T13:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660072",
    "user": "https://github.com/koffie"
}
```

<a id='comment:21'></a>
I heard from Julian that right now the docker build process takes 8 hours on his computer due to #32998 . I am all for simplifying the docker file so that it fits within the github actions CI timeout. 


The max timeout for a single job on github actions is 6 hours so if #32998 is fixed this should be possible. If that is not enough, we could have multiple jobs for different parts of the build process split up according to different docker targets, pushing the different stages separately to dockerhub.

Also right now the Dockerfile installs almost no system packages iirc, so it could also be sped up by using more of those instead of building everything ourselves.



---

archive/issue_comments_660073.json:
```json
{
    "body": "<a id='comment:22'></a>\nwhat is the point here of using fewer system packages than possible?",
    "created_at": "2021-12-31T15:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660073",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
what is the point here of using fewer system packages than possible?



---

archive/issue_comments_660074.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [dimpase](#comment%3A22):\n> what is the point here of using fewer system packages than possible?\n\n\nThe only thing I know of why, is cause of this discussion #32998#comment:5 , which you are probably also aware of.\n\nPersonally I don't care how many system packages we use, and only care about efficient and maintainable docker file. So I am all in favor of using more system packages, especially if that makes it easier to fix this issue. \n\nSadly enough I don't have time myself to work on this right now aside from leaving some comments that are hopefully useful.",
    "created_at": "2021-12-31T15:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660074",
    "user": "https://github.com/koffie"
}
```

<a id='comment:23'></a>
Replying to [dimpase](#comment%3A22):
> what is the point here of using fewer system packages than possible?


The only thing I know of why, is cause of this discussion #32998#comment:5 , which you are probably also aware of.

Personally I don't care how many system packages we use, and only care about efficient and maintainable docker file. So I am all in favor of using more system packages, especially if that makes it easier to fix this issue. 

Sadly enough I don't have time myself to work on this right now aside from leaving some comments that are hopefully useful.



---

archive/issue_comments_660075.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [gh-tobiasdiez](#comment%3A20):\n> Why is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. \n\n\nTo my understanding, this is designed for providing very fast incremental builds so that all branches on trac can be tested with it.\n\nOf course for just building the Docker images for release tags, a much simpler workflow would do the job.",
    "created_at": "2021-12-31T18:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660075",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Replying to [gh-tobiasdiez](#comment%3A20):
> Why is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. 


To my understanding, this is designed for providing very fast incremental builds so that all branches on trac can be tested with it.

Of course for just building the Docker images for release tags, a much simpler workflow would do the job.



---

archive/issue_comments_660076.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [mderickx](#comment%3A21):\n> The max timeout for a single job on github actions is 6 hours so if #32998 is fixed this should be possible. \n\n\nYes, we know that of course from our existing portability CI on GH Actions. `ubuntu-focal-minimal` (https://github.com/sagemath/sage/runs/4497390653?check_suite_focus=true) is around 6 hours and sometimes times out, but with system packages installed, `ubuntu-focal-standard` (https://github.com/sagemath/sage/runs/4497390666?check_suite_focus=true) finishes within 3.5 hours.",
    "created_at": "2021-12-31T18:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660076",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Replying to [mderickx](#comment%3A21):
> The max timeout for a single job on github actions is 6 hours so if #32998 is fixed this should be possible. 


Yes, we know that of course from our existing portability CI on GH Actions. `ubuntu-focal-minimal` (https://github.com/sagemath/sage/runs/4497390653?check_suite_focus=true) is around 6 hours and sometimes times out, but with system packages installed, `ubuntu-focal-standard` (https://github.com/sagemath/sage/runs/4497390666?check_suite_focus=true) finishes within 3.5 hours.



---

archive/issue_comments_660077.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,7 @@\n As suggested in https://groups.google.com/g/sage-devel/c/jIwovtSXtdw/m/2HR5RraTCwAJ, we set up a GH Actions workflow for building Docker images, replacing the GitLab workflow.\n \n+This ticket is focused on replicating the features of the GitLab workflow, in particular the incremental build and the distinction of `sagemath` and `sagemath-dev` builds.\n+\n+See also:\n+- #29536 Make docker images from tox/GitHub CI workflow, regular Sage Docker images, and gitpod interoperable\n+\n``````\n",
    "created_at": "2021-12-31T19:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660077",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,7 @@
 As suggested in https://groups.google.com/g/sage-devel/c/jIwovtSXtdw/m/2HR5RraTCwAJ, we set up a GH Actions workflow for building Docker images, replacing the GitLab workflow.
 
+This ticket is focused on replicating the features of the GitLab workflow, in particular the incremental build and the distinction of `sagemath` and `sagemath-dev` builds.
+
+See also:
+- #29536 Make docker images from tox/GitHub CI workflow, regular Sage Docker images, and gitpod interoperable
+
``````




---

archive/issue_comments_660078.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [mkoeppe](#comment%3A24):\n> Replying to [gh-tobiasdiez](#comment%3A20):\n> > Why is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. \n\n> \n> To my understanding, this is designed for providing very fast incremental builds so that all branches on trac can be tested with it.\n> \n> Of course for just building the Docker images for release tags, a much simpler workflow would do the job.\n\n\nWhile I'm very much in favor of having a github action that runs on all branches, I'm not sure if docker is the right technology for it. Especially in view of the recent progress in the build script it should be easier to reuse partial build outputs from the develop branch also for other branches. For example, one could cache `sage-local` using the built-in github action cache (with hashing the package directory to invalidate the cache once the packages change). I think this is easier to maintain than the ingenious but somewhat hacky git-diff code in the docker build.",
    "created_at": "2022-01-01T12:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660078",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:27'></a>
Replying to [mkoeppe](#comment%3A24):
> Replying to [gh-tobiasdiez](#comment%3A20):
> > Why is this whole patching business needed in the first place? Installing relevant system packages + compiling all other packages + building sage should be below the github action timelimit, so a fresh build without caching upon every push to develop should work. 

> 
> To my understanding, this is designed for providing very fast incremental builds so that all branches on trac can be tested with it.
> 
> Of course for just building the Docker images for release tags, a much simpler workflow would do the job.


While I'm very much in favor of having a github action that runs on all branches, I'm not sure if docker is the right technology for it. Especially in view of the recent progress in the build script it should be easier to reuse partial build outputs from the develop branch also for other branches. For example, one could cache `sage-local` using the built-in github action cache (with hashing the package directory to invalidate the cache once the packages change). I think this is easier to maintain than the ingenious but somewhat hacky git-diff code in the docker build.



---

archive/issue_comments_660079.json:
```json
{
    "body": "<a id='comment:28'></a>\nWell, if the workflow does not use docker, then it does not create Docker images, which are what you need in #32749.",
    "created_at": "2022-01-01T17:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660079",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
Well, if the workflow does not use docker, then it does not create Docker images, which are what you need in #32749.



---

archive/issue_comments_660080.json:
```json
{
    "body": "<a id='comment:29'></a>\nAs the original author of these Dockerfile hacks\u2026\n\nIf we can retain the possibility to create a docker image for every branch that could be quite beneficial at it would allow people to play with code changes in a review on binder instead of having to rebuild locally. However, we never integrated a button for this in trac, even though all the other infrastructure for it exists.\n\nI am not sure if this is enough of a reason to repair these hacks. It's more important to have working docker images again than to have a feature that nobody is using anyway.",
    "created_at": "2022-01-03T03:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33099#issuecomment-660080",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:29'></a>
As the original author of these Dockerfile hacks…

If we can retain the possibility to create a docker image for every branch that could be quite beneficial at it would allow people to play with code changes in a review on binder instead of having to rebuild locally. However, we never integrated a button for this in trac, even though all the other infrastructure for it exists.

I am not sure if this is enough of a reason to repair these hacks. It's more important to have working docker images again than to have a feature that nobody is using anyway.



---

archive/issue_events_098380.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-05T01:01:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33099",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33099#event-98380"
}
```
