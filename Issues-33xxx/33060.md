# Issue 33060: pytest: Declare dependencies

archive/issues_032823.json:
```json
{
    "body": "... to avoid races as seen in \nhttps://github.com/mkoeppe/sage/runs/4590618592?check_suite_focus=true\n\n```\n  [pytest] error installing, exit status 1. End of log file:\n  [pytest]   Collecting pytest\n  [pytest]     Downloading pytest-6.2.5-py3-none-any.whl (280 kB)\n  [pytest]   Collecting toml\n  [pytest]     Downloading toml-0.10.2-py2.py3-none-any.whl (16 kB)\n  [pytest]   Collecting pluggy<2.0,>=0.12\n  [pytest]     Downloading pluggy-1.0.0-py2.py3-none-any.whl (13 kB)\n  [pytest]   Collecting packaging\n  [pytest]     Downloading packaging-21.3-py3-none-any.whl (40 kB)\n  [pytest]   Collecting attrs>=19.2.0\n  [pytest]     Downloading attrs-21.2.0-py2.py3-none-any.whl (53 kB)\n  [pytest]   Collecting py>=1.8.2\n  [pytest]     Downloading py-1.11.0-py2.py3-none-any.whl (98 kB)\n  [pytest]   Collecting iniconfig\n  [pytest]     Downloading iniconfig-1.1.1-py2.py3-none-any.whl (5.0 kB)\n  [pytest]   Collecting pyparsing!=3.0.5,>=2.0.2\n  [pytest]     Downloading pyparsing-3.0.6-py3-none-any.whl (97 kB)\n  [pytest]   Installing collected packages: iniconfig, toml, pyparsing, py, pluggy, attrs, packaging, pytest\n  [pytest]   ERROR: Could not install packages due to an OSError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/INSTALLERzxvc5w2o.tmp'\n  [pytest]   \n```\n\nAlso likely these failures\n\n```\n  [alabaster-0.7.12]     FileNotFoundError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/METADATA'\n  [alabaster-0.7.12]     Preparing metadata (setup.py): finished with status 'error'\n  [alabaster-0.7.12]   WARNING: Discarding file:///sage/local/var/lib/sage/venv-python3.9.9/var/tmp/sage/build/alabaster-0.7.12/src. Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\n  [alabaster-0.7.12]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\n```\nare caused by the same race condition.\nhttps://github.com/mkoeppe/sage/runs/4611408679?check_suite_focus=true\n\n\nCC:  @dimpase @orlitzky\n\nBranch/Commit: 36e3a195832acbd559067ccd74e418bf56ab30fd\n\nReviewer: Michael Orlitzky\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33060\n\n",
    "closed_at": "2021-12-28T21:15:46Z",
    "created_at": "2021-12-21T16:18:20Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "pytest: Declare dependencies",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33060",
    "user": "https://github.com/mkoeppe"
}
```
... to avoid races as seen in 
https://github.com/mkoeppe/sage/runs/4590618592?check_suite_focus=true

```
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   Collecting pytest
  [pytest]     Downloading pytest-6.2.5-py3-none-any.whl (280 kB)
  [pytest]   Collecting toml
  [pytest]     Downloading toml-0.10.2-py2.py3-none-any.whl (16 kB)
  [pytest]   Collecting pluggy<2.0,>=0.12
  [pytest]     Downloading pluggy-1.0.0-py2.py3-none-any.whl (13 kB)
  [pytest]   Collecting packaging
  [pytest]     Downloading packaging-21.3-py3-none-any.whl (40 kB)
  [pytest]   Collecting attrs>=19.2.0
  [pytest]     Downloading attrs-21.2.0-py2.py3-none-any.whl (53 kB)
  [pytest]   Collecting py>=1.8.2
  [pytest]     Downloading py-1.11.0-py2.py3-none-any.whl (98 kB)
  [pytest]   Collecting iniconfig
  [pytest]     Downloading iniconfig-1.1.1-py2.py3-none-any.whl (5.0 kB)
  [pytest]   Collecting pyparsing!=3.0.5,>=2.0.2
  [pytest]     Downloading pyparsing-3.0.6-py3-none-any.whl (97 kB)
  [pytest]   Installing collected packages: iniconfig, toml, pyparsing, py, pluggy, attrs, packaging, pytest
  [pytest]   ERROR: Could not install packages due to an OSError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/INSTALLERzxvc5w2o.tmp'
  [pytest]   
```

Also likely these failures

```
  [alabaster-0.7.12]     FileNotFoundError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/METADATA'
  [alabaster-0.7.12]     Preparing metadata (setup.py): finished with status 'error'
  [alabaster-0.7.12]   WARNING: Discarding file:///sage/local/var/lib/sage/venv-python3.9.9/var/tmp/sage/build/alabaster-0.7.12/src. Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
  [alabaster-0.7.12]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
```
are caused by the same race condition.
https://github.com/mkoeppe/sage/runs/4611408679?check_suite_focus=true


CC:  @dimpase @orlitzky

Branch/Commit: 36e3a195832acbd559067ccd74e418bf56ab30fd

Reviewer: Michael Orlitzky

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33060





---

archive/issue_comments_658983.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/pytest__declare_dependencies\"",
    "created_at": "2021-12-21T16:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658983",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/pytest__declare_dependencies"



---

archive/issue_comments_658984.json:
```json
{
    "body": "Changing commit from \"\" to \"76f003ee33c9bc15a281df06cc7e39c4a0d23d9d\"",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658984",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "76f003ee33c9bc15a281df06cc7e39c4a0d23d9d"



---

archive/issue_comments_658985.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658985",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_658986.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658986",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_658987.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658987",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_658988.json:
```json
{
    "body": "<a id='comment:3'></a>Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?\n\nIf so, do we have to worry about importlib-metadata with python-3.7?",
    "created_at": "2021-12-21T16:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658988",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:3'></a>Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?

If so, do we have to worry about importlib-metadata with python-3.7?



---

archive/issue_comments_658989.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T17:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_658990.json:
```json
{
    "body": "Changing commit from \"76f003ee33c9bc15a281df06cc7e39c4a0d23d9d\" to \"36e3a195832acbd559067ccd74e418bf56ab30fd\"",
    "created_at": "2021-12-21T17:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658990",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "76f003ee33c9bc15a281df06cc7e39c4a0d23d9d" to "36e3a195832acbd559067ccd74e418bf56ab30fd"



---

archive/issue_comments_658991.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 mjo]:\n> Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?\n\n\nRather, because these are the only ones that we can control via this mechanism.\n\nIf there is another SPKG installed via `requirements.txt` that has common dependencies with `pytest`, there could still be a race.\n\n> If so, do we have to worry about importlib-metadata with python-3.7?\n\n\nThanks for catching this, I've added it.",
    "created_at": "2021-12-21T17:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658991",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Replying to [comment:3 mjo]:
> Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?


Rather, because these are the only ones that we can control via this mechanism.

If there is another SPKG installed via `requirements.txt` that has common dependencies with `pytest`, there could still be a race.

> If so, do we have to worry about importlib-metadata with python-3.7?


Thanks for catching this, I've added it.



---

archive/issue_comments_658992.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Michael Orlitzky\"",
    "created_at": "2021-12-21T17:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658992",
    "user": "https://github.com/orlitzky"
}
```

Changing reviewer from "" to "Michael Orlitzky"



---

archive/issue_comments_658993.json:
```json
{
    "body": "<a id='comment:6'></a>Ok, LGTM.",
    "created_at": "2021-12-21T17:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658993",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>Ok, LGTM.



---

archive/issue_comments_658994.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-21T17:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658994",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_658995.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks!",
    "created_at": "2021-12-21T17:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658995",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Thanks!



---

archive/issue_comments_658996.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -24,6 +24,18 @@\n   [pytest]   \n ```\n \n+Also likely these failures\n+\n+```\n+  [alabaster-0.7.12]     FileNotFoundError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/METADATA'\n+  [alabaster-0.7.12]     Preparing metadata (setup.py): finished with status 'error'\n+  [alabaster-0.7.12]   WARNING: Discarding file:///sage/local/var/lib/sage/venv-python3.9.9/var/tmp/sage/build/alabaster-0.7.12/src. Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\n+  [alabaster-0.7.12]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\n+```\n+are caused by the same race condition.\n+https://github.com/mkoeppe/sage/runs/4611408679?check_suite_focus=true\n+\n+\n Comment: 1\n \n Priority: critical\n``````\n",
    "created_at": "2021-12-23T00:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658996",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -24,6 +24,18 @@
   [pytest]   
 ```
 
+Also likely these failures
+
+```
+  [alabaster-0.7.12]     FileNotFoundError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/METADATA'
+  [alabaster-0.7.12]     Preparing metadata (setup.py): finished with status 'error'
+  [alabaster-0.7.12]   WARNING: Discarding file:///sage/local/var/lib/sage/venv-python3.9.9/var/tmp/sage/build/alabaster-0.7.12/src. Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
+  [alabaster-0.7.12]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
+```
+are caused by the same race condition.
+https://github.com/mkoeppe/sage/runs/4611408679?check_suite_focus=true
+
+
 Comment: 1
 
 Priority: critical
``````




---

archive/issue_comments_658997.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-12-23T00:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658997",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_events_087355.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-28T21:15:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33060#event-87355"
}
```



---

archive/issue_comments_658998.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-28T21:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658998",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_658999.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/pytest__declare_dependencies\" to \"36e3a195832acbd559067ccd74e418bf56ab30fd\"",
    "created_at": "2021-12-28T21:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33060#issuecomment-658999",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/pytest__declare_dependencies" to "36e3a195832acbd559067ccd74e418bf56ab30fd"
