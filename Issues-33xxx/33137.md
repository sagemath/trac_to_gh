# Issue 33137: sage.env.sage_include_directories: Don't use distutils and SAGE_LIB

archive/issues_032900.json:
```json
{
    "body": "From #33135.\n\n- `src/sage/env.py` uses `distutils.sysconfig.get_python_inc()` which is deprecated, it has no replacement in sysconfig.\n\n Suggestion from fbissey: \"we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value.\" #33135#comment:7\n\nWe also remove the use of `SAGE_LIB` in preparation of namespace packages.\n\nThis is the last use of `distutils` in the Sage library, except for uses in `src/sage/features/__init__.py` and `src/sage/misc/cython.py`, which are merely fallbacks when `setuptools` is not present.\n\n Comment from arojas: \"I don't see any code in sagelib or cython that would emit this. Is this still needed at all?\"\n\nFollow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.\n\nPart of \n- Meta-ticket #31295: Replace imports from deprecated `distutils`\n- Meta-ticket #33037: Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables\n\n\nCC:  @antonio-rojas @dimpase\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton, Matthias Koeppe\n\nBranch: public/ticket-33137\n\nStatus: needs_review\n\nDependencies: #32873\n\nCommit: e2688ef47fac633e5f5a299106e807e23f942d28\n\nIssue created by migration from https://trac.sagemath.org/ticket/33137\n\n",
    "created_at": "2022-01-09T22:37:24Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage.env.sage_include_directories: Don't use distutils and SAGE_LIB",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33137",
    "user": "https://github.com/tornaria"
}
```
From #33135.

- `src/sage/env.py` uses `distutils.sysconfig.get_python_inc()` which is deprecated, it has no replacement in sysconfig.

 Suggestion from fbissey: "we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value." #33135#comment:7

We also remove the use of `SAGE_LIB` in preparation of namespace packages.

This is the last use of `distutils` in the Sage library, except for uses in `src/sage/features/__init__.py` and `src/sage/misc/cython.py`, which are merely fallbacks when `setuptools` is not present.

 Comment from arojas: "I don't see any code in sagelib or cython that would emit this. Is this still needed at all?"

Follow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.

Part of 
- Meta-ticket #31295: Replace imports from deprecated `distutils`
- Meta-ticket #33037: Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables


CC:  @antonio-rojas @dimpase

Author: Frédéric Chapoton, Matthias Koeppe

Branch: public/ticket-33137

Status: needs_review

Dependencies: #32873

Commit: e2688ef47fac633e5f5a299106e807e23f942d28

Issue created by migration from https://trac.sagemath.org/ticket/33137





---

archive/issue_comments_501106.json:
```json
{
    "body": "<a id='comment:1'></a>`get_config_var` as the other advantage to be usable from python 3.8 and 3.9. So we could use it now.\n\n```\nfbissey@tarazed ~ $ python3.9\nPython 3.9.9 (main, Dec  1 2021, 10:05:37) \n[GCC 11.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import distutils.sysconfig\n>>> distutils.sysconfig.get_python_inc()\n'/usr/include/python3.9'\n>>> import sysconfig\n>>> sysconfig.get_config_var('INCLUDEPY')\n'/usr/include/python3.9'\n>>> \nfbissey@tarazed ~ $ python3.8\nPython 3.8.12 (default, Nov  4 2021, 22:08:42) \n[GCC 11.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sysconfig\n>>> sysconfig.get_config_var('INCLUDEPY')\n'/usr/include/python3.8'\n>>> \n```",
    "created_at": "2022-01-09T23:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501106",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>`get_config_var` as the other advantage to be usable from python 3.8 and 3.9. So we could use it now.

```
fbissey@tarazed ~ $ python3.9
Python 3.9.9 (main, Dec  1 2021, 10:05:37) 
[GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import distutils.sysconfig
>>> distutils.sysconfig.get_python_inc()
'/usr/include/python3.9'
>>> import sysconfig
>>> sysconfig.get_config_var('INCLUDEPY')
'/usr/include/python3.9'
>>> 
fbissey@tarazed ~ $ python3.8
Python 3.8.12 (default, Nov  4 2021, 22:08:42) 
[GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import sysconfig
>>> sysconfig.get_config_var('INCLUDEPY')
'/usr/include/python3.8'
>>> 
```



---

archive/issue_comments_501107.json:
```json
{
    "body": "<a id='comment:2'></a>une tentative. \n\n---\nNew commits:",
    "created_at": "2022-01-10T20:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501107",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>une tentative. 

---
New commits:



---

archive/issue_comments_501108.json:
```json
{
    "body": "<a id='comment:3'></a>I'd have done the first part last night [exactly that code] but I couldn't push to trac. Turns out my ssh key is now too old and needs replacing :)",
    "created_at": "2022-01-10T20:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501108",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:3'></a>I'd have done the first part last night [exactly that code] but I couldn't push to trac. Turns out my ssh key is now too old and needs replacing :)



---

archive/issue_comments_501109.json:
```json
{
    "body": "<a id='comment:4'></a>Salut,\n\npour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError",
    "created_at": "2022-01-10T21:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501109",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>Salut,

pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError



---

archive/issue_comments_501110.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 chapoton]:\n> Salut,\n> \n> pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError\n\n\nToi, tu vas encore te faire taper sur les doigts parce que tu parle Fran\u00e7ais sur un syst\u00e8me o\u00f9 l'Anglais est la \"lingua Franca\" (je sais, c'est bizarre d'\u00e9crire \u00e7a).\n\nOtherwise, I am not too fussed about removing that block. I cannot see a test showing what it is supposed to catch and how. Antonio says it is a dead code path and there is clearly no proof otherwise anywhere.",
    "created_at": "2022-01-10T21:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501110",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>Replying to [comment:4 chapoton]:
> Salut,
> 
> pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError


Toi, tu vas encore te faire taper sur les doigts parce que tu parle Français sur un système où l'Anglais est la "lingua Franca" (je sais, c'est bizarre d'écrire ça).

Otherwise, I am not too fussed about removing that block. I cannot see a test showing what it is supposed to catch and how. Antonio says it is a dead code path and there is clearly no proof otherwise anywhere.



---

archive/issue_comments_501111.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -10,6 +10,9 @@\n \n Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.\n \n+\n+Part of Meta-ticket #31295: Replace imports from deprecated distutils\n+\n Comment: 1\n \n Summary: Don't use distutils in sage\n```\n",
    "created_at": "2022-01-10T22:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501111",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -10,6 +10,9 @@
 
 Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.
 
+
+Part of Meta-ticket #31295: Replace imports from deprecated distutils
+
 Comment: 1
 
 Summary: Don't use distutils in sage
```




---

archive/issue_comments_501112.json:
```json
{
    "body": "<a id='comment:8'></a>apparemment le changement dans features est en conflit avec #32873",
    "created_at": "2022-01-11T11:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501112",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>apparemment le changement dans features est en conflit avec #32873



---

archive/issue_comments_501113.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-11T11:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501113",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_501114.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 chapoton]:\n> apparemment le changement dans features est en conflit avec #32873\n\n\nYes and I positively reviewed that ticket. I thought we were dealing with something different. In another ticket of mine about doctest failures on distro, Matthias pointed me out to three tickets - one of which I reviewed, again. It seems to me there are far too many tickets of that kind not included in 9.5.rc0. It is hard to figure out what is already on trac.",
    "created_at": "2022-01-11T18:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501114",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>Replying to [comment:8 chapoton]:
> apparemment le changement dans features est en conflit avec #32873


Yes and I positively reviewed that ticket. I thought we were dealing with something different. In another ticket of mine about doctest failures on distro, Matthias pointed me out to three tickets - one of which I reviewed, again. It seems to me there are far too many tickets of that kind not included in 9.5.rc0. It is hard to figure out what is already on trac.



---

archive/issue_events_087559.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T04:32:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33137#event-87559"
}
```



---

archive/issue_comments_501115.json:
```json
{
    "body": "<a id='comment:12'></a>From `tornaria` #33473#comment:22:\n  indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n  {{{\n        # Put the Python \"system\" include dir at the end, so that\n        # any local include dirs take precedence.\n  }}}",
    "created_at": "2022-07-02T22:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501115",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>From `tornaria` #33473#comment:22:
  indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:
  {{{
        # Put the Python "system" include dir at the end, so that
        # any local include dirs take precedence.
  }}}



---

archive/issue_comments_501116.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-02T22:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501116",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_501117.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+From #33135.\n+\n+- \\`src/sage/env.py\\` uses \\`distutils.sysconfig.get_python_inc()\\` which is deprecated, it has no replacement in sysconfig.\n+\n+ Suggestion from fbissey: \"we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value.\" #33135#comment:7\n+\n+This is the last use of \\`distutils\\` in the Sage library, except for uses in \\`src/sage/features/__init__.py\\` and \\`src/sage/misc/cython.py\\`, which are merely fallbacks when \\`setuptools\\` is not present.\n+\n+ Comment from arojas: \"I don't see any code in sagelib or cython that would emit this. Is this still needed at all?\"\n+\n+Follow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.\n+\n+Part of \n+- Meta-ticket #31295: Replace imports from deprecated \\`distutils\\`\n+- Meta-ticket #33037: Remove use of \\`SAGE_LIB\\` and \\`SAGE_EXTCODE\\` variables\n \n \n Comment: 1\n```\n",
    "created_at": "2022-07-02T22:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501117",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,18 @@
+From #33135.
+
+- \`src/sage/env.py\` uses \`distutils.sysconfig.get_python_inc()\` which is deprecated, it has no replacement in sysconfig.
+
+ Suggestion from fbissey: "we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value." #33135#comment:7
+
+This is the last use of \`distutils\` in the Sage library, except for uses in \`src/sage/features/__init__.py\` and \`src/sage/misc/cython.py\`, which are merely fallbacks when \`setuptools\` is not present.
+
+ Comment from arojas: "I don't see any code in sagelib or cython that would emit this. Is this still needed at all?"
+
+Follow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.
+
+Part of 
+- Meta-ticket #31295: Replace imports from deprecated \`distutils\`
+- Meta-ticket #33037: Remove use of \`SAGE_LIB\` and \`SAGE_EXTCODE\` variables
 
 
 Comment: 1
```




---

archive/issue_comments_501118.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-02T23:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501118",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_501119.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:12 mkoeppe]:\n> From `tornaria` #33473#comment:22:\n>   indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n>   {{{\n>         # Put the Python \"system\" include dir at the end, so that\n>         # any local include dirs take precedence.\n>   }}}\n\n\nNevertheless, I have put `sysconfig.get_config_var('INCLUDEPY')` back in: `sage.misc.cython.cython` appends some directories to the result of `sage_include_directories()`, so let's not provoke some subtle changes in the order of looking up libraries when users use the runtime Cython.",
    "created_at": "2022-07-02T23:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501119",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>Replying to [comment:12 mkoeppe]:
> From `tornaria` #33473#comment:22:
>   indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:
>   {{{
>         # Put the Python "system" include dir at the end, so that
>         # any local include dirs take precedence.
>   }}}


Nevertheless, I have put `sysconfig.get_config_var('INCLUDEPY')` back in: `sage.misc.cython.cython` appends some directories to the result of `sage_include_directories()`, so let's not provoke some subtle changes in the order of looking up libraries when users use the runtime Cython.



---

archive/issue_comments_501120.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-02T23:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501120",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_501121.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,20 @@\n+From #33135.\n+\n+- \\`src/sage/env.py\\` uses \\`distutils.sysconfig.get_python_inc()\\` which is deprecated, it has no replacement in sysconfig.\n+\n+ Suggestion from fbissey: \"we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value.\" #33135#comment:7\n+\n+We also remove the use of \\`SAGE_LIB\\` in preparation of namespace packages.\n+\n+This is the last use of \\`distutils\\` in the Sage library, except for uses in \\`src/sage/features/__init__.py\\` and \\`src/sage/misc/cython.py\\`, which are merely fallbacks when \\`setuptools\\` is not present.\n+\n+ Comment from arojas: \"I don't see any code in sagelib or cython that would emit this. Is this still needed at all?\"\n+\n+Follow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.\n+\n+Part of \n+- Meta-ticket #31295: Replace imports from deprecated \\`distutils\\`\n+- Meta-ticket #33037: Remove use of \\`SAGE_LIB\\` and \\`SAGE_EXTCODE\\` variables\n \n \n Comment: 1\n```\n",
    "created_at": "2022-07-02T23:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501121",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,20 @@
+From #33135.
+
+- \`src/sage/env.py\` uses \`distutils.sysconfig.get_python_inc()\` which is deprecated, it has no replacement in sysconfig.
+
+ Suggestion from fbissey: "we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value." #33135#comment:7
+
+We also remove the use of \`SAGE_LIB\` in preparation of namespace packages.
+
+This is the last use of \`distutils\` in the Sage library, except for uses in \`src/sage/features/__init__.py\` and \`src/sage/misc/cython.py\`, which are merely fallbacks when \`setuptools\` is not present.
+
+ Comment from arojas: "I don't see any code in sagelib or cython that would emit this. Is this still needed at all?"
+
+Follow-up: Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.
+
+Part of 
+- Meta-ticket #31295: Replace imports from deprecated \`distutils\`
+- Meta-ticket #33037: Remove use of \`SAGE_LIB\` and \`SAGE_EXTCODE\` variables
 
 
 Comment: 1
```




---

archive/issue_events_087560.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33137#event-87560"
}
```



---

archive/issue_events_087561.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33137#event-87561"
}
```



---

archive/issue_comments_501122.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-09-26T00:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33137#issuecomment-501122",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
