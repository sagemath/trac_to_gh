# Issue 33147: use PARI's ellmul() for elliptic curves over finite fields

archive/issues_032910.json:
```json
{
    "body": "Currently, Sage uses the generic action of `ZZ` on additive groups to compute scalar multiplications for elliptic curves. This is significantly slower than PARI's specialized `ellmul()` function:\n\n```\nsage: E = EllipticCurve(GF(65537), [1,2,3,4,5])\nsage: P = E.random_point()\nsage: %timeit 12345*P\n241 \u00b5s \u00b1 3.31 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit pari.ellmul(E,P,12345)\n47.4 \u00b5s \u00b1 645 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\nThis patch adds the use of `ellmul()` for elliptic curves over finite fields. The speedup is very significant for all sizes I've tried (between ~10 and ~1000 bits), ranging from 4\u00d7 to 8\u00d7.\n\nDiff without the dependency:\n  https://git.sagemath.org/sage.git/commit/?id=e92d1cc3a8f13dc9d30fb8756a2f7fdac3695b9e\nThe dependency is by no means essential, but it was convenient since #32786 already adds the `_acted_upon_` method.\n\nCC:  @videlec\n\nReviewer: Travis Scrimshaw\n\nAuthor: Lorenz Panny\n\nBranch: 895fe2369eb3d3bbee7b1ec890736e85414bd82b\n\nDependencies: #32786\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33147\n\n",
    "closed_at": "2022-03-09T23:38:11Z",
    "created_at": "2022-01-11T05:40:23Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "use PARI's ellmul() for elliptic curves over finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33147",
    "user": "https://github.com/yyyyx4"
}
```
Currently, Sage uses the generic action of `ZZ` on additive groups to compute scalar multiplications for elliptic curves. This is significantly slower than PARI's specialized `ellmul()` function:

```
sage: E = EllipticCurve(GF(65537), [1,2,3,4,5])
sage: P = E.random_point()
sage: %timeit 12345*P
241 µs ± 3.31 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit pari.ellmul(E,P,12345)
47.4 µs ± 645 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```

This patch adds the use of `ellmul()` for elliptic curves over finite fields. The speedup is very significant for all sizes I've tried (between ~10 and ~1000 bits), ranging from 4× to 8×.

Diff without the dependency:
  https://git.sagemath.org/sage.git/commit/?id=e92d1cc3a8f13dc9d30fb8756a2f7fdac3695b9e
The dependency is by no means essential, but it was convenient since #32786 already adds the `_acted_upon_` method.

CC:  @videlec

Reviewer: Travis Scrimshaw

Author: Lorenz Panny

Branch: 895fe2369eb3d3bbee7b1ec890736e85414bd82b

Dependencies: #32786

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33147





---

archive/issue_comments_468852.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-11T05:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468852",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468853.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-18T08:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468853",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468854.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-21T06:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468854",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468855.json:
```json
{
    "body": "<a id='comment:5'></a>\n```diff\n-               Finite Fields*. Inventiones math. 2, 134-144, 1966.\n+               Finite Fields*. Inventiones Math. 2, 134-144, 1966.\n```\n\nI am not sure how good it is to rely on upstream caching here:\n\n```\n        card = getattr(E, \"_order\", None)  # get cached order of the curve\n        self._order = Integer(E.pari_curve().ellorder(self, card))\n        if card is None:\n            # ellcard() is essentially free at this point because\n            # the curve order was cached by PARI during ellorder().\n            E._order = Integer(E.pari_curve().ellcard())\n        return self._order\n```\nWould it be simple to just used the result to set the cache yourself?\n\nIt might be better to first check for the attribute here\n\n```\nif isinstance(R, FiniteField) and self.__base_ring.is_subring(R) and hasattr(self, '_order'):\n```\nas I believe the `hasattr` check should be faster (and fail more often). Although this is a very mild suggestion since I don't know what to expect from this code usage in the wild.",
    "created_at": "2022-02-22T05:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468855",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
```diff
-               Finite Fields*. Inventiones math. 2, 134-144, 1966.
+               Finite Fields*. Inventiones Math. 2, 134-144, 1966.
```

I am not sure how good it is to rely on upstream caching here:

```
        card = getattr(E, "_order", None)  # get cached order of the curve
        self._order = Integer(E.pari_curve().ellorder(self, card))
        if card is None:
            # ellcard() is essentially free at this point because
            # the curve order was cached by PARI during ellorder().
            E._order = Integer(E.pari_curve().ellcard())
        return self._order
```
Would it be simple to just used the result to set the cache yourself?

It might be better to first check for the attribute here

```
if isinstance(R, FiniteField) and self.__base_ring.is_subring(R) and hasattr(self, '_order'):
```
as I believe the `hasattr` check should be faster (and fail more often). Although this is a very mild suggestion since I don't know what to expect from this code usage in the wild.



---

archive/issue_comments_468856.json:
```json
{
    "body": "<a id='comment:6'></a>It seems all of these comments are for #32786, did you mean to post them there?",
    "created_at": "2022-02-23T04:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468856",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:6'></a>It seems all of these comments are for #32786, did you mean to post them there?



---

archive/issue_comments_468857.json:
```json
{
    "body": "<a id='comment:7'></a>The middle comment is only applicable for here, but the others are indeed really about the changes in #32786. You can take care of them either there or here, whichever you prefer.",
    "created_at": "2022-02-23T05:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468857",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>The middle comment is only applicable for here, but the others are indeed really about the changes in #32786. You can take care of them either there or here, whichever you prefer.



---

archive/issue_comments_468858.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-24T05:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468858",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468859.json:
```json
{
    "body": "<a id='comment:9'></a>Okay, done. Thank you.",
    "created_at": "2022-02-24T05:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468859",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:9'></a>Okay, done. Thank you.



---

archive/issue_comments_468860.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you. LGTM.",
    "created_at": "2022-02-24T05:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468860",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Thank you. LGTM.



---

archive/issue_comments_468861.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-24T05:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468861",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468862.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-03T22:19:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468862",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087579.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-03T22:19:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33147#event-87579"
}
```



---

archive/issue_comments_468863.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2022-03-07T23:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468863",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_087580.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-07T23:39:10Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33147#event-87580"
}
```



---

archive/issue_comments_468864.json:
```json
{
    "body": "<a id='comment:12'></a>On the OSX buildbot:\n\n```\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 773, in sage.structure.coerce_actions.IntegerMulAction._act_\nFailed example:\n    alarm(0.5); (2^(10^7)) * P\nExpected:\n    Traceback (most recent call last):\n    ...\n    AlarmInterrupt\nGot:\n    (0 : 1 : 0)\n**********************************************************************\n1 item had failures:\n   1 of  15 in sage.structure.coerce_actions.IntegerMulAction._act_\n    [150 tests, 1 failure, 0.55 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 81.8 --random-seed=0 src/sage/structure/coerce_actions.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2022-03-07T23:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468864",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>On the OSX buildbot:

```
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 773, in sage.structure.coerce_actions.IntegerMulAction._act_
Failed example:
    alarm(0.5); (2^(10^7)) * P
Expected:
    Traceback (most recent call last):
    ...
    AlarmInterrupt
Got:
    (0 : 1 : 0)
**********************************************************************
1 item had failures:
   1 of  15 in sage.structure.coerce_actions.IntegerMulAction._act_
    [150 tests, 1 failure, 0.55 s]
----------------------------------------------------------------------
sage -t --long --warn-long 81.8 --random-seed=0 src/sage/structure/coerce_actions.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_468865.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2022-03-07T23:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468865",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_468866.json:
```json
{
    "body": "<a id='comment:13'></a>It is now too fast for that doctest on that machine. I am not sure what the best thing to do is. Probably decrease the alarm length?",
    "created_at": "2022-03-08T00:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468866",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>It is now too fast for that doctest on that machine. I am not sure what the best thing to do is. Probably decrease the alarm length?



---

archive/issue_comments_468867.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-08T02:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468868.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-08T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468868",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468869.json:
```json
{
    "body": "<a id='comment:15'></a>Probably, indeed. Let's try this one.\n\n(Amazingly, I had already adjusted the same doctest to take 10\u00d7 longer in the first commit here, and it still fails!)",
    "created_at": "2022-03-08T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468869",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:15'></a>Probably, indeed. Let's try this one.

(Amazingly, I had already adjusted the same doctest to take 10× longer in the first commit here, and it still fails!)



---

archive/issue_comments_468870.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-08T03:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468870",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468871.json:
```json
{
    "body": "<a id='comment:16'></a>Let\u2019s give it a go.",
    "created_at": "2022-03-08T03:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468871",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Let’s give it a go.



---

archive/issue_comments_468872.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-09T23:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468872",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087581.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33147#event-87581"
}
```



---

archive/issue_comments_468873.json:
```json
{
    "body": "<a id='comment:18'></a>Thats not really an acceptable solution, cross fingers and hope that that there is no machine that is faster than 5x of what you have? You need at least a couple of orders of magnitude of safety if you want to test something like that. See also:\n\nhttps://groups.google.com/g/sage-release/c/dkP267r52Y8/m/CoVwCH3aAQAJ",
    "created_at": "2022-03-13T14:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468873",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Thats not really an acceptable solution, cross fingers and hope that that there is no machine that is faster than 5x of what you have? You need at least a couple of orders of magnitude of safety if you want to test something like that. See also:

https://groups.google.com/g/sage-release/c/dkP267r52Y8/m/CoVwCH3aAQAJ



---

archive/issue_comments_468874.json:
```json
{
    "body": "<a id='comment:19'></a>Follow-up at #33496.",
    "created_at": "2022-03-13T17:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33147#issuecomment-468874",
    "user": "https://github.com/slel"
}
```

<a id='comment:19'></a>Follow-up at #33496.
