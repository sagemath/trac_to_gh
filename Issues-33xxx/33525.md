# Issue 33525: modernize coercion in monsky_washnitzer.py

archive/issues_033288.json:
```json
{
    "body": "to help for #33497\n\nCC:  @videlec @tscrim\n\nBranch/Commit: [70362ae12de4ef74cd44f89c0863e2fecc804997](https://github.com/sagemath/sagetrac-mirror/commit/70362ae12de4ef74cd44f89c0863e2fecc804997)\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33525\n\n",
    "closed_at": "2022-03-27T15:43:34Z",
    "created_at": "2022-03-18T15:25:02Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "modernize coercion in monsky_washnitzer.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33525",
    "user": "https://github.com/fchapoton"
}
```
to help for #33497

CC:  @videlec @tscrim

Branch/Commit: [70362ae12de4ef74cd44f89c0863e2fecc804997](https://github.com/sagemath/sagetrac-mirror/commit/70362ae12de4ef74cd44f89c0863e2fecc804997)

Reviewer: Travis Scrimshaw

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33525





---

archive/issue_comments_668087.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-18T15:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668087",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_668088.json:
```json
{
    "body": "Changing commit from \"c808d4786b0d46135300c41c59973355b33649a8\" to \"5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6\"",
    "created_at": "2022-03-18T15:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668088",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c808d4786b0d46135300c41c59973355b33649a8" to "5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6"



---

archive/issue_comments_668089.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------|\n|[5abbdf2](https://github.com/sagemath/sagetrac-mirror/commit/5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6)|`adding doc`|",
    "created_at": "2022-03-18T15:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668089",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |            |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------|
|[5abbdf2](https://github.com/sagemath/sagetrac-mirror/commit/5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6)|`adding doc`|



---

archive/issue_comments_668090.json:
```json
{
    "body": "<a id='comment:3'></a>\nthere remains one little failing doctest..",
    "created_at": "2022-03-18T15:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668090",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
there remains one little failing doctest..



---

archive/issue_comments_668091.json:
```json
{
    "body": "<a id='comment:4'></a>\nThat doctest will not pass in the current implementation (and I am not sure it should) as `B = Z[\u2018t\u2019]` and `R._poly_ring == Z[\u2018T\u2019]`, where `Z = Integers(125)` and we do not allow coercion between polynomial rings with different variable names IIRC. I don\u2019t see an equivalent doctest in the old code. Why should this doctest work? I would have expected it to be from `Z`.\n\nSome comments for possible optimizations for general modernization (feel free to push them to a followup ticket, which I can do):\n\n- In `_mul_`, it will never be the case that the first check is true by the coercion framework. I also believe the `todo` with the recast is also a no-op and can be removed once the cast is done in the parent.\n- If a matrix is hard-coded and then an inverse taken, why don\u2019t we just hard-code the inverse?\n- `__repr__` to `_repr_` in the parent.\n- `gens()` should return a tuple and it can be cached. Although, IIRC, this is taken care of automatically if `gen()` is implemented instead. (It\u2019s better to use `zero()` and `one()` there as well.)\n- Why not make `create_element()` an alias of `_element_constructor_()`?\n- ``@`cached_method` the `one()`.\n- I know I would appreciate having those long output lines broken over multiple lines, but that is very cosmetic.\n- Cythonize the element.\n- Use `_poly_ring` instead of `poly_ring()` in the element `__init__` check.\n- I don\u2019 think we need the Python2 compatibility `__nonzero__ = __bool__` alias.\n- Indentation levels on various `INPUT:` bullet points.",
    "created_at": "2022-03-18T23:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668091",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
That doctest will not pass in the current implementation (and I am not sure it should) as `B = Z[‘t’]` and `R._poly_ring == Z[‘T’]`, where `Z = Integers(125)` and we do not allow coercion between polynomial rings with different variable names IIRC. I don’t see an equivalent doctest in the old code. Why should this doctest work? I would have expected it to be from `Z`.

Some comments for possible optimizations for general modernization (feel free to push them to a followup ticket, which I can do):

- In `_mul_`, it will never be the case that the first check is true by the coercion framework. I also believe the `todo` with the recast is also a no-op and can be removed once the cast is done in the parent.
- If a matrix is hard-coded and then an inverse taken, why don’t we just hard-code the inverse?
- `__repr__` to `_repr_` in the parent.
- `gens()` should return a tuple and it can be cached. Although, IIRC, this is taken care of automatically if `gen()` is implemented instead. (It’s better to use `zero()` and `one()` there as well.)
- Why not make `create_element()` an alias of `_element_constructor_()`?
- ``@`cached_method` the `one()`.
- I know I would appreciate having those long output lines broken over multiple lines, but that is very cosmetic.
- Cythonize the element.
- Use `_poly_ring` instead of `poly_ring()` in the element `__init__` check.
- I don’ think we need the Python2 compatibility `__nonzero__ = __bool__` alias.
- Indentation levels on various `INPUT:` bullet points.



---

archive/issue_comments_668092.json:
```json
{
    "body": "Changing commit from \"5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6\" to \"c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce\"",
    "created_at": "2022-03-19T07:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5abbdf230cefa8242c7b129fc4e5c7fba0bdcab6" to "c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce"



---

archive/issue_comments_668093.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|\n|[c2c5114](https://github.com/sagemath/sagetrac-mirror/commit/c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce)|`various changes in monsky after reviewer's suggestions`|",
    "created_at": "2022-03-19T07:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|[c2c5114](https://github.com/sagemath/sagetrac-mirror/commit/c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce)|`various changes in monsky after reviewer's suggestions`|



---

archive/issue_comments_668094.json:
```json
{
    "body": "<a id='comment:6'></a>\nConcerning the coercion test, it seems strange to me that the variable \"T\" is hardcoded.\n\nAbout your suggestions, I did what I could. Maybe one can keep the rest for another ticket.",
    "created_at": "2022-03-19T08:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668094",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
Concerning the coercion test, it seems strange to me that the variable "T" is hardcoded.

About your suggestions, I did what I could. Maybe one can keep the rest for another ticket.



---

archive/issue_comments_668095.json:
```json
{
    "body": "Changing commit from \"c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce\" to \"cbf7db677c0d4b244422d1664c00d6fe29d4674a\"",
    "created_at": "2022-03-19T08:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668095",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c2c5114d4d588ea00c9f0ff75f823e2f7b7913ce" to "cbf7db677c0d4b244422d1664c00d6fe29d4674a"



---

archive/issue_comments_668096.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------|\n|[cbf7db6](https://github.com/sagemath/sagetrac-mirror/commit/cbf7db677c0d4b244422d1664c00d6fe29d4674a)|`one little detail`|",
    "created_at": "2022-03-19T08:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668096",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------|
|[cbf7db6](https://github.com/sagemath/sagetrac-mirror/commit/cbf7db677c0d4b244422d1664c00d6fe29d4674a)|`one little detail`|



---

archive/issue_comments_668097.json:
```json
{
    "body": "<a id='comment:8'></a>\nThank you.\n\nHaving the variable `T` being hard coded is mildly strange, but that variable is unrelated to the variable for the univariate polynomial that defines the quotient. In the examples, it gets changed from `t` to `x`. Perhaps then the thing to do is to check that either it coerces into the base ring (of `_poly_ring`) or it is a univariate polynomial ring that whose base ring coerces into the base ring?",
    "created_at": "2022-03-19T08:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668097",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
Thank you.

Having the variable `T` being hard coded is mildly strange, but that variable is unrelated to the variable for the univariate polynomial that defines the quotient. In the examples, it gets changed from `t` to `x`. Perhaps then the thing to do is to check that either it coerces into the base ring (of `_poly_ring`) or it is a univariate polynomial ring that whose base ring coerces into the base ring?



---

archive/issue_comments_668098.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------|\n|[6cae3da](https://github.com/sagemath/sagetrac-mirror/commit/6cae3dafa7746c3647e70c65658bac3438a864cb)|`fix doctests`|",
    "created_at": "2022-03-19T09:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668098",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |              |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------|
|[6cae3da](https://github.com/sagemath/sagetrac-mirror/commit/6cae3dafa7746c3647e70c65658bac3438a864cb)|`fix doctests`|



---

archive/issue_comments_668099.json:
```json
{
    "body": "Changing commit from \"cbf7db677c0d4b244422d1664c00d6fe29d4674a\" to \"6cae3dafa7746c3647e70c65658bac3438a864cb\"",
    "created_at": "2022-03-19T09:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668099",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cbf7db677c0d4b244422d1664c00d6fe29d4674a" to "6cae3dafa7746c3647e70c65658bac3438a864cb"



---

archive/issue_comments_668100.json:
```json
{
    "body": "Changing commit from \"6cae3dafa7746c3647e70c65658bac3438a864cb\" to \"70362ae12de4ef74cd44f89c0863e2fecc804997\"",
    "created_at": "2022-03-19T10:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6cae3dafa7746c3647e70c65658bac3438a864cb" to "70362ae12de4ef74cd44f89c0863e2fecc804997"



---

archive/issue_comments_668101.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------|\n|[70362ae](https://github.com/sagemath/sagetrac-mirror/commit/70362ae12de4ef74cd44f89c0863e2fecc804997)|`details in doc`|",
    "created_at": "2022-03-19T10:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------|
|[70362ae](https://github.com/sagemath/sagetrac-mirror/commit/70362ae12de4ef74cd44f89c0863e2fecc804997)|`details in doc`|



---

archive/issue_comments_668102.json:
```json
{
    "body": "<a id='comment:11'></a>\nso we have a green bot. Good enough ?",
    "created_at": "2022-03-19T12:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668102",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>
so we have a green bot. Good enough ?



---

archive/issue_comments_668103.json:
```json
{
    "body": "<a id='comment:12'></a>\nYes, thank you.",
    "created_at": "2022-03-19T14:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668103",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
Yes, thank you.



---

archive/issue_comments_668104.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-19T14:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668104",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_668105.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2022-03-19T14:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668105",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_668106.json:
```json
{
    "body": "Changing branch from \"public/monsky_coercion\" to \"70362ae12de4ef74cd44f89c0863e2fecc804997\"",
    "created_at": "2022-03-27T15:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668106",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/monsky_coercion" to "70362ae12de4ef74cd44f89c0863e2fecc804997"



---

archive/issue_events_099314.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-27T15:43:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33525#event-99314"
}
```



---

archive/issue_comments_668107.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-27T15:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33525",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33525#issuecomment-668107",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
