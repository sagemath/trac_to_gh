# Issue 33127: Fix warning about missing sage-site when SAGE_ROOT is removed after installation

archive/issues_032890.json:
```json
{
    "body": "If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n\nThis fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n\n```\n**********************************************************************\nFile \"/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py\", line 170, in sage.tests.cmdline.test_executable\nFailed example:\n    err  \nExpected:\n    ''   \nGot:\n    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n**********************************************************************\n```\n\n\nCC:  @jhpalmieri\n\nBranch/Commit: 702b7795295d96f3601a129f0729f4006a55740a\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33127\n\n",
    "closed_at": "2022-02-21T21:56:23Z",
    "created_at": "2022-01-07T17:13:54Z",
    "labels": [
        "component: distribution",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Fix warning about missing sage-site when SAGE_ROOT is removed after installation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33127",
    "user": "https://github.com/tornaria"
}
```
If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.

This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:

```
**********************************************************************
File "/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py", line 170, in sage.tests.cmdline.test_executable
Failed example:
    err  
Expected:
    ''   
Got:
    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
**********************************************************************
```


CC:  @jhpalmieri

Branch/Commit: 702b7795295d96f3601a129f0729f4006a55740a

Reviewer: John Palmieri

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33127





---

archive/issue_comments_500904.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2022-01-07T17:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500904",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_500905.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-07T17:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500905",
    "user": "https://github.com/tornaria"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_500906.json:
```json
{
    "body": "<a id='comment:2'></a>I think you should just unset `SAGE_ROOT` in your distro build.",
    "created_at": "2022-01-07T18:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500906",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>I think you should just unset `SAGE_ROOT` in your distro build.



---

archive/issue_comments_500907.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 mkoeppe]:\n> I think you should just unset `SAGE_ROOT` in your distro build.\n\n\nI'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).\n\nI don't see an easy way to unset it.",
    "created_at": "2022-01-07T19:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500907",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:3'></a>Replying to [comment:2 mkoeppe]:
> I think you should just unset `SAGE_ROOT` in your distro build.


I'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).

I don't see an easy way to unset it.



---

archive/issue_comments_500908.json:
```json
{
    "body": "<a id='comment:4'></a>In distribution packaging, the `SAGE_ROOT/sage` script should not be used.\n\nThe installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.",
    "created_at": "2022-01-07T19:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500908",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>In distribution packaging, the `SAGE_ROOT/sage` script should not be used.

The installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.



---

archive/issue_comments_500909.json:
```json
{
    "body": "<a id='comment:5'></a>Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?\n\nIn any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\nI have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).",
    "created_at": "2022-01-07T19:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500909",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?

In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

I have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).



---

archive/issue_comments_500910.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 tornaria]:\n> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?\n\n\nYes",
    "created_at": "2022-01-07T19:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500910",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:5 tornaria]:
> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?


Yes



---

archive/issue_comments_500911.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 tornaria]:\n> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\n\nYes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.",
    "created_at": "2022-01-07T19:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500911",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Replying to [comment:5 tornaria]:
> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?


Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.



---

archive/issue_comments_500912.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:\n> Replying to [comment:5 tornaria]:\n> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\n> \n> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.\n\n\nMy first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.\n\nOTOH, where would I place the src? Isn't it necessary for `??` to work?",
    "created_at": "2022-01-07T19:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500912",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:
> Replying to [comment:5 tornaria]:
> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

> 
> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.


My first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.

OTOH, where would I place the src? Isn't it necessary for `??` to work?



---

archive/issue_comments_500913.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 tornaria]:\n> My first try was using `--prefix` and installing only `SAGE_LOCAL`.\n\n\nYes, that's how it's done.\n\n> However, binaries are not installed \n\n\n??",
    "created_at": "2022-01-07T19:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500913",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:8 tornaria]:
> My first try was using `--prefix` and installing only `SAGE_LOCAL`.


Yes, that's how it's done.

> However, binaries are not installed 


??



---

archive/issue_comments_500914.json:
```json
{
    "body": "<a id='comment:10'></a>You don't need to install `src`.",
    "created_at": "2022-01-07T19:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500914",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>You don't need to install `src`.



---

archive/issue_comments_500915.json:
```json
{
    "body": "<a id='comment:11'></a>One more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\nRegarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have\n\n```\n$ ls -l /usr/lib/sage-9.5.beta9/local/bin/\ntotal 2224\n-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac\n-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap\n-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin\n-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol\n```",
    "created_at": "2022-01-07T19:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500915",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:11'></a>One more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Regarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have

```
$ ls -l /usr/lib/sage-9.5.beta9/local/bin/
total 2224
-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac
-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap
-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin
-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol
```



---

archive/issue_comments_500916.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 tornaria]:\n> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\n\nYes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.\n\nThis is implied by using `--prefix`.\n\n(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)",
    "created_at": "2022-01-07T19:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500916",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Replying to [comment:11 tornaria]:
> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?


Yes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.

This is implied by using `--prefix`.

(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)



---

archive/issue_comments_500917.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:8 tornaria]:\n> Isn't it necessary for `??` to work?\n\n\n`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.\nhttps://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182\n\nThis makes `??` work for `.py` files (but not `.pyx` files)",
    "created_at": "2022-01-07T20:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500917",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Replying to [comment:8 tornaria]:
> Isn't it necessary for `??` to work?


`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.
https://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182

This makes `??` work for `.py` files (but not `.pyx` files)



---

archive/issue_comments_500918.json:
```json
{
    "body": "<a id='comment:14'></a>Instead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n\n(as found by `git grep '[[].*SAGE_ROOT'`)\n\nThis would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.",
    "created_at": "2022-01-07T22:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500918",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 

(as found by `git grep '[[].*SAGE_ROOT'`)

This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.



---

archive/issue_comments_500919.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:\n> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> \n> (as found by `git grep '[[].*SAGE_ROOT'`)\n> \n> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.\n> \n\n\nThat could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\n\nOTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.\n\nSo far I know two places where I have to patch:\n- `SAGE_LOCAL/bin/sage-env-config`\n- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\nThere's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.",
    "created_at": "2022-01-08T00:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500919",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:
> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> 
> (as found by `git grep '[[].*SAGE_ROOT'`)
> 
> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.
> 


That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?


OTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.

So far I know two places where I have to patch:
- `SAGE_LOCAL/bin/sage-env-config`
- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.



---

archive/issue_comments_500920.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 tornaria]:\n> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.\n\n\nThat's right, it isn't.",
    "created_at": "2022-01-08T00:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500920",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Replying to [comment:15 tornaria]:
> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.


That's right, it isn't.



---

archive/issue_comments_500921.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 tornaria]:\n> So far I know two places where I have to patch:\n> - `SAGE_LOCAL/bin/sage-env-config`\n> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\n\nYes, these are the only 2 installed configuration files.",
    "created_at": "2022-01-08T00:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500921",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:15 tornaria]:
> So far I know two places where I have to patch:
> - `SAGE_LOCAL/bin/sage-env-config`
> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`


Yes, these are the only 2 installed configuration files.



---

archive/issue_comments_500922.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:15 tornaria]:\n> Replying to [comment:14 mkoeppe]:\n> > `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> > \n\n> That could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\nRight, that's shorter",
    "created_at": "2022-01-08T00:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500922",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>Replying to [comment:15 tornaria]:
> Replying to [comment:14 mkoeppe]:
> > `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> > 

> That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?

Right, that's shorter



---

archive/issue_comments_500923.json:
```json
{
    "body": "<a id='comment:19'></a>Hi there,\n\nI can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.",
    "created_at": "2022-01-08T20:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500923",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>Hi there,

I can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.



---

archive/issue_events_087525.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-12T17:35:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33127#event-87525"
}
```



---

archive/issue_comments_500924.json:
```json
{
    "body": "<a id='comment:21'></a>I just found this ticket, I think it's related to a problem I see as well.\nI'm building Sage 9.5 from source, also using `--prefix ...`.\nIt works fine, so, OK. But, each time it starts up:\n\n```\n/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory\nWarning: overwriting SAGE_ROOT environment variable:\nOld SAGE_ROOT=/home/sage/sage\nNew SAGE_ROOT=\n```\n\nIn particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.",
    "created_at": "2022-02-09T12:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500924",
    "user": "https://github.com/haraldschilly"
}
```

<a id='comment:21'></a>I just found this ticket, I think it's related to a problem I see as well.
I'm building Sage 9.5 from source, also using `--prefix ...`.
It works fine, so, OK. But, each time it starts up:

```
/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory
Warning: overwriting SAGE_ROOT environment variable:
Old SAGE_ROOT=/home/sage/sage
New SAGE_ROOT=
```

In particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.



---

archive/issue_comments_500925.json:
```json
{
    "body": "<a id='comment:22'></a>I think we can reuse this ticket to do what is discussed in comment:18",
    "created_at": "2022-02-09T18:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500925",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>I think we can reuse this ticket to do what is discussed in comment:18



---

archive/issue_comments_500926.json:
```json
{
    "body": "<a id='comment:24'></a>New commits:",
    "created_at": "2022-02-10T02:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500926",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>New commits:



---

archive/issue_comments_500927.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:\n+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n+\n+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n \n ```\n **********************************************************************\n@@ -11,7 +13,7 @@\n     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n **********************************************************************\n ```\n-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2022-02-10T02:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500927",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:
+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.
+
+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:
 
 ```
 **********************************************************************
@@ -11,7 +13,7 @@
     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
 **********************************************************************
 ```
-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_500928.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-10T02:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500928",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500929.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-10T02:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500929",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_500930.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-13T17:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500930",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_500931.json:
```json
{
    "body": "<a id='comment:29'></a>In the line \n\n```\nif [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n```\nshould at least the last `-n` be changed to `-d`? And/or later in\n\n```\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\nfi\n```\nI guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?\n\nI'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).",
    "created_at": "2022-02-14T06:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500931",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:29'></a>In the line 

```
if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
```
should at least the last `-n` be changed to `-d`? And/or later in

```
if [ -n "$NEW_SAGE_ROOT" ]; then
    export SAGE_ROOT="$NEW_SAGE_ROOT"
fi
```
I guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?

I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).



---

archive/issue_comments_500932.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 jhpalmieri]:\n> In the line \n> \n> ```\n> if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n> ```\n> should at least the last `-n` be changed to `-d`? \n\n\nNo, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory",
    "created_at": "2022-02-16T19:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500932",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>Replying to [comment:29 jhpalmieri]:
> In the line 
> 
> ```
> if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
> ```
> should at least the last `-n` be changed to `-d`? 


No, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory



---

archive/issue_comments_500933.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:29 jhpalmieri]:\n> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).\n\n\nGood point, I'll change this. Also some of the comments in between are outdated",
    "created_at": "2022-02-16T19:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500933",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>Replying to [comment:29 jhpalmieri]:
> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).


Good point, I'll change this. Also some of the comments in between are outdated



---

archive/issue_comments_500934.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-16T19:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500934",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500935.json:
```json
{
    "body": "<a id='comment:33'></a>I built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:\n\n```\n././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory\n```\nIn fact I get the same error just running `./bin/sage`.\n\nLine 122 is\n\n```\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n```\nIn the test a few lines earlier\n\n```\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\n```\nshould this be `-d`?",
    "created_at": "2022-02-16T23:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500935",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'></a>I built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:

```
././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory
```
In fact I get the same error just running `./bin/sage`.

Line 122 is

```
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`
```
In the test a few lines earlier

```
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
```
should this be `-d`?



---

archive/issue_comments_500936.json:
```json
{
    "body": "<a id='comment:34'></a>I'm confused about the whole situation. The entire block\n\n```\n# New value for SAGE_ROOT: either SAGE_ROOT (if given)\n# or a guessed value based on pwd.\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\nelif [ -f sage -a -d build ]; then\n    NEW_SAGE_ROOT=\".\"\nelif [ -f ../../sage -a -d ../../build ]; then\n    NEW_SAGE_ROOT=\"../..\"\nfi\n\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n\n    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT\n    if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n        echo >&2 \"Warning: overwriting SAGE_ROOT environment variable:\"\n        echo >&2 \"Old SAGE_ROOT=$SAGE_ROOT\"\n        echo >&2 \"New SAGE_ROOT=$NEW_SAGE_ROOT\"\n        export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\n    fi\nfi\n```\nseems completely useless if `SAGE_ROOT` is no longer there.",
    "created_at": "2022-02-16T23:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500936",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>I'm confused about the whole situation. The entire block

```
# New value for SAGE_ROOT: either SAGE_ROOT (if given)
# or a guessed value based on pwd.
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
elif [ -f sage -a -d build ]; then
    NEW_SAGE_ROOT="."
elif [ -f ../../sage -a -d ../../build ]; then
    NEW_SAGE_ROOT="../.."
fi

if [ -n "$NEW_SAGE_ROOT" ]; then
    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`

    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT
    if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
        echo >&2 "Warning: overwriting SAGE_ROOT environment variable:"
        echo >&2 "Old SAGE_ROOT=$SAGE_ROOT"
        echo >&2 "New SAGE_ROOT=$NEW_SAGE_ROOT"
        export SAGE_ROOT="$NEW_SAGE_ROOT"
    fi
fi
```
seems completely useless if `SAGE_ROOT` is no longer there.



---

archive/issue_comments_500937.json:
```json
{
    "body": "<a id='comment:35'></a>Toward the end, at least we want to do `export SAGE_ROOT=\"$NEW_SAGE_ROOT\"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.",
    "created_at": "2022-02-16T23:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500937",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:35'></a>Toward the end, at least we want to do `export SAGE_ROOT="$NEW_SAGE_ROOT"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.



---

archive/issue_comments_500938.json:
```json
{
    "body": "<a id='comment:36'></a>Yes, it's quite likely that this old code can be much simplified, I'll take a look",
    "created_at": "2022-02-17T02:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500938",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Yes, it's quite likely that this old code can be much simplified, I'll take a look



---

archive/issue_comments_500939.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T06:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500939",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500940.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T06:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500940",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500941.json:
```json
{
    "body": "<a id='comment:39'></a>The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:\n\n- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`\n- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`\n- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0",
    "created_at": "2022-02-17T06:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500941",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:

- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`
- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`
- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0



---

archive/issue_comments_500942.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T06:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500942",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500943.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:39 mkoeppe]:\n> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. \n\n\nI don't think we need to support this, so I have removed this code.",
    "created_at": "2022-02-17T06:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500943",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Replying to [comment:39 mkoeppe]:
> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. 


I don't think we need to support this, so I have removed this code.



---

archive/issue_comments_500944.json:
```json
{
    "body": "<a id='comment:42'></a>This doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with\n\n```\n[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory\n```\nNote `build/make/build/pkgs`.",
    "created_at": "2022-02-17T17:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500944",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:42'></a>This doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with

```
[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory
```
Note `build/make/build/pkgs`.



---

archive/issue_comments_500945.json:
```json
{
    "body": "<a id='comment:43'></a>Thanks for testing!",
    "created_at": "2022-02-17T17:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500945",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>Thanks for testing!



---

archive/issue_comments_500946.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T17:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500947.json:
```json
{
    "body": "<a id='comment:45'></a>Now it might actually work",
    "created_at": "2022-02-17T17:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500947",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Now it might actually work



---

archive/issue_comments_500948.json:
```json
{
    "body": "<a id='comment:46'></a>Sage builds now, but I am still struggling with other aspects.\n\n- `./configure --prefix=PREFIX`\n- `make build`\n- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`\n- `cd PREFIX`\n- Then `./bin/sage` worked!\n- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:\n\n```\nTraceback (most recent call last):\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location\", line 102, in <module>\n    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):\n  File \"/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py\", line 101, in samefile\n    s2 = os.stat(f2)\nFileNotFoundError: [Errno 2] No such file or directory: ''\n```\n(The path for `sage-location` is `PREFIX/bin/sage-location`.)",
    "created_at": "2022-02-17T19:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500948",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:46'></a>Sage builds now, but I am still struggling with other aspects.

- `./configure --prefix=PREFIX`
- `make build`
- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`
- `cd PREFIX`
- Then `./bin/sage` worked!
- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:

```
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location", line 102, in <module>
    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
  File "/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py", line 101, in samefile
    s2 = os.stat(f2)
FileNotFoundError: [Errno 2] No such file or directory: ''
```
(The path for `sage-location` is `PREFIX/bin/sage-location`.)



---

archive/issue_comments_500949.json:
```json
{
    "body": "<a id='comment:47'></a>If I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get\n\n```\nERROR:  The Sage installation tree has moved\n\nfrom /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X\n  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1\n\nThis is not supported, and Sage will not work...\n```",
    "created_at": "2022-02-17T19:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500949",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:47'></a>If I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get

```
ERROR:  The Sage installation tree has moved

from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X
  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1

This is not supported, and Sage will not work...
```



---

archive/issue_comments_500950.json:
```json
{
    "body": "<a id='comment:48'></a>OK, so this is a great opportunity to get rid of `sage-location` altogether",
    "created_at": "2022-02-17T19:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500950",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>OK, so this is a great opportunity to get rid of `sage-location` altogether



---

archive/issue_comments_500951.json:
```json
{
    "body": "<a id='comment:49'></a>... but this will best be done on top of #30649, which touches some of the `sage-location`-using code",
    "created_at": "2022-02-17T19:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500951",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>... but this will best be done on top of #30649, which touches some of the `sage-location`-using code



---

archive/issue_comments_500952.json:
```json
{
    "body": "<a id='comment:50'></a>Well, #30649 has this as a dependency, so what order do we want to make these changes?",
    "created_at": "2022-02-17T19:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500952",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'></a>Well, #30649 has this as a dependency, so what order do we want to make these changes?



---

archive/issue_comments_500953.json:
```json
{
    "body": "<a id='comment:51'></a>I've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version",
    "created_at": "2022-02-17T19:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500953",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:51'></a>I've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version



---

archive/issue_comments_500954.json:
```json
{
    "body": "<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-17T19:53:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500954",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_500955.json:
```json
{
    "body": "<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T20:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500955",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_500956.json:
```json
{
    "body": "<a id='comment:54'></a>This version may be worth testing",
    "created_at": "2022-02-17T20:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500956",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'></a>This version may be worth testing



---

archive/issue_comments_500957.json:
```json
{
    "body": "<a id='comment:55'></a>Same symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:\n\n```\nFileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'\n```\n(That is, `FileNotFoundError: ... old SAGE_ROOT`.)",
    "created_at": "2022-02-17T22:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500957",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:55'></a>Same symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:

```
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'
```
(That is, `FileNotFoundError: ... old SAGE_ROOT`.)



---

archive/issue_comments_500958.json:
```json
{
    "body": "<a id='comment:56'></a>Does this work without this ticket?",
    "created_at": "2022-02-17T23:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500958",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>Does this work without this ticket?



---

archive/issue_comments_500959.json:
```json
{
    "body": "<a id='comment:57'></a>Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?",
    "created_at": "2022-02-17T23:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500959",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:57'></a>Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?



---

archive/issue_comments_500960.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:57 jhpalmieri]:\n> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?\n\n\nI can confirm essentially the same problem without this ticket.",
    "created_at": "2022-02-18T00:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500960",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:58'></a>Replying to [comment:57 jhpalmieri]:
> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?


I can confirm essentially the same problem without this ticket.



---

archive/issue_comments_500961.json:
```json
{
    "body": "<a id='comment:59'></a>Thanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371",
    "created_at": "2022-02-18T00:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500961",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:59'></a>Thanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371



---

archive/issue_comments_500962.json:
```json
{
    "body": "<a id='comment:60'></a>I agree that it's not clear what exactly to test here",
    "created_at": "2022-02-18T00:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500962",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'></a>I agree that it's not clear what exactly to test here



---

archive/issue_comments_500963.json:
```json
{
    "body": "<a id='comment:61'></a>The changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.",
    "created_at": "2022-02-19T04:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500963",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:61'></a>The changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.



---

archive/issue_comments_500964.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-19T04:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500964",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_500965.json:
```json
{
    "body": "<a id='comment:62'></a>Thank you!",
    "created_at": "2022-02-19T05:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500965",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'></a>Thank you!



---

archive/issue_events_087526.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-21T21:56:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33127#event-87526"
}
```



---

archive/issue_comments_500966.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-21T21:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33127#issuecomment-500966",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
