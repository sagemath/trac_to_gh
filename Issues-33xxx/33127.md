# Issue 33127: Fix warning about missing sage-site when SAGE_ROOT is removed after installation

archive/issues_032890.json:
```json
{
    "assignees": [],
    "body": "If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n\nThis fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n\n```\n**********************************************************************\nFile \"/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py\", line 170, in sage.tests.cmdline.test_executable\nFailed example:\n    err  \nExpected:\n    ''   \nGot:\n    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n**********************************************************************\n```\n\n\nCC:  @jhpalmieri\n\nBranch/Commit: **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **distribution**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33127_\n\n",
    "closed_at": "2022-02-21T21:56:23Z",
    "created_at": "2022-01-07T17:13:54Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20distribution",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix warning about missing sage-site when SAGE_ROOT is removed after installation",
    "type": "issue",
    "updated_at": "2022-02-21T21:56:23Z",
    "url": "https://github.com/sagemath/sage/issues/33127",
    "user": "https://github.com/tornaria"
}
```
If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.

This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:

```
**********************************************************************
File "/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py", line 170, in sage.tests.cmdline.test_executable
Failed example:
    err  
Expected:
    ''   
Got:
    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
**********************************************************************
```


CC:  @jhpalmieri

Branch/Commit: **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**

Reviewer: **John Palmieri**

Author: **Matthias Koeppe**

Component: **distribution**

_Issue created by migration from https://trac.sagemath.org/ticket/33127_





---

archive/issue_events_458016.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458016"
}
```



---

archive/issue_events_458017.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20distribution",
    "label_color": "000080",
    "label_name": "c: distribution",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458017"
}
```



---

archive/issue_events_458018.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458018"
}
```



---

archive/issue_events_458019.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458019"
}
```



---

archive/issue_comments_535137.json:
```json
{
    "body": "Branch: **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535137",
    "user": "https://github.com/tornaria"
}
```

Branch: **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)**



---

archive/issue_comments_535138.json:
```json
{
    "body": "Author: **Gonzalo Tornar\u00eda**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535138",
    "user": "https://github.com/tornaria"
}
```

Author: **Gonzalo Tornaría**



---

archive/issue_comments_535139.json:
```json
{
    "body": "Commit: **[`424de09`](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535139",
    "user": "https://github.com/tornaria"
}
```

Commit: **[`424de09`](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)**



---

archive/issue_comments_535140.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234\"><code>424de09</code></a></td><td><code>sage-site: exec only if it is executable</code></td></tr></table>\n",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535140",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234"><code>424de09</code></a></td><td><code>sage-site: exec only if it is executable</code></td></tr></table>




---

archive/issue_events_458020.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:14:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458020"
}
```



---

archive/issue_comments_535141.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI think you should just unset `SAGE_ROOT` in your distro build.",
    "created_at": "2022-01-07T18:45:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535141",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

I think you should just unset `SAGE_ROOT` in your distro build.



---

archive/issue_comments_535142.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@mkoeppe](#comment:2):\n> I think you should just unset `SAGE_ROOT` in your distro build.\n\nI'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).\n\nI don't see an easy way to unset it.",
    "created_at": "2022-01-07T19:07:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535142",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@mkoeppe](#comment:2):
> I think you should just unset `SAGE_ROOT` in your distro build.

I'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).

I don't see an easy way to unset it.



---

archive/issue_comments_535143.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIn distribution packaging, the `SAGE_ROOT/sage` script should not be used.\n\nThe installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.",
    "created_at": "2022-01-07T19:11:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535143",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

In distribution packaging, the `SAGE_ROOT/sage` script should not be used.

The installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.



---

archive/issue_comments_535144.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nHmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?\n\nIn any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\nI have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).",
    "created_at": "2022-01-07T19:26:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535144",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:5" align="right">comment:5</div>

Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?

In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

I have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).



---

archive/issue_comments_535145.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@tornaria](#comment:5):\n> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?\n\nYes",
    "created_at": "2022-01-07T19:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535145",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@tornaria](#comment:5):
> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?

Yes



---

archive/issue_comments_535146.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@tornaria](#comment:5):\n> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\nYes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.",
    "created_at": "2022-01-07T19:28:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535146",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@tornaria](#comment:5):
> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.



---

archive/issue_comments_535147.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@mkoeppe](#comment:7):\n> Replying to [@tornaria](#comment:5):\n> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\n> \n> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.\n\nMy first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.\n\nOTOH, where would I place the src? Isn't it necessary for `??` to work?",
    "created_at": "2022-01-07T19:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535147",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@mkoeppe](#comment:7):
> Replying to [@tornaria](#comment:5):
> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

> 
> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.

My first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.

OTOH, where would I place the src? Isn't it necessary for `??` to work?



---

archive/issue_comments_535148.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@tornaria](#comment:8):\n> My first try was using `--prefix` and installing only `SAGE_LOCAL`.\n\nYes, that's how it's done.\n\n> However, binaries are not installed \n\n??",
    "created_at": "2022-01-07T19:53:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535148",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@tornaria](#comment:8):
> My first try was using `--prefix` and installing only `SAGE_LOCAL`.

Yes, that's how it's done.

> However, binaries are not installed 

??



---

archive/issue_comments_535149.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nYou don't need to install `src`.",
    "created_at": "2022-01-07T19:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535149",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">comment:10</div>

You don't need to install `src`.



---

archive/issue_comments_535150.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOne more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\nRegarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have\n\n```\n$ ls -l /usr/lib/sage-9.5.beta9/local/bin/\ntotal 2224\n-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac\n-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap\n-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin\n-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol\n```",
    "created_at": "2022-01-07T19:55:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535150",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:11" align="right">comment:11</div>

One more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Regarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have

```
$ ls -l /usr/lib/sage-9.5.beta9/local/bin/
total 2224
-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac
-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap
-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin
-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol
```



---

archive/issue_comments_535151.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@tornaria](#comment:11):\n> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\nYes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.\n\nThis is implied by using `--prefix`.\n\n(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)",
    "created_at": "2022-01-07T19:57:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535151",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@tornaria](#comment:11):
> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Yes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.

This is implied by using `--prefix`.

(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)



---

archive/issue_comments_535152.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@tornaria](#comment:8):\n> Isn't it necessary for `??` to work?\n\n`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.\nhttps://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182\n\nThis makes `??` work for `.py` files (but not `.pyx` files)",
    "created_at": "2022-01-07T20:27:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535152",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@tornaria](#comment:8):
> Isn't it necessary for `??` to work?

`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.
https://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182

This makes `??` work for `.py` files (but not `.pyx` files)



---

archive/issue_comments_535153.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nInstead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n\n(as found by `git grep '[[].*SAGE_ROOT'`)\n\nThis would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.",
    "created_at": "2022-01-07T22:59:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535153",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 

(as found by `git grep '[[].*SAGE_ROOT'`)

This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.



---

archive/issue_comments_535154.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@mkoeppe](#comment:14):\n> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> \n> (as found by `git grep '[[].*SAGE_ROOT'`)\n> \n> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.\n> \n\nThat could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\n\nOTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.\n\nSo far I know two places where I have to patch:\n- `SAGE_LOCAL/bin/sage-env-config`\n- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\nThere's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.",
    "created_at": "2022-01-08T00:02:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535154",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@mkoeppe](#comment:14):
> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> 
> (as found by `git grep '[[].*SAGE_ROOT'`)
> 
> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.
> 

That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?


OTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.

So far I know two places where I have to patch:
- `SAGE_LOCAL/bin/sage-env-config`
- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.



---

archive/issue_comments_535155.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@tornaria](#comment:15):\n> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.\n\nThat's right, it isn't.",
    "created_at": "2022-01-08T00:04:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535155",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@tornaria](#comment:15):
> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.

That's right, it isn't.



---

archive/issue_comments_535156.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tornaria](#comment:15):\n> So far I know two places where I have to patch:\n> - `SAGE_LOCAL/bin/sage-env-config`\n> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\nYes, these are the only 2 installed configuration files.",
    "created_at": "2022-01-08T00:05:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535156",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tornaria](#comment:15):
> So far I know two places where I have to patch:
> - `SAGE_LOCAL/bin/sage-env-config`
> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

Yes, these are the only 2 installed configuration files.



---

archive/issue_comments_535157.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tornaria](#comment:15):\n> Replying to [@mkoeppe](#comment:14):\n> > `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> > \n\n> That could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\nRight, that's shorter",
    "created_at": "2022-01-08T00:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535157",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tornaria](#comment:15):
> Replying to [@mkoeppe](#comment:14):
> > `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> > 

> That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?

Right, that's shorter



---

archive/issue_comments_535158.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nHi there,\n\nI can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.",
    "created_at": "2022-01-08T20:13:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535158",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:19" align="right">comment:19</div>

Hi there,

I can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.



---

archive/issue_events_458021.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-12T17:35:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458021"
}
```



---

archive/issue_events_458022.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-12T17:35:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458022"
}
```



---

archive/issue_comments_535159.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI just found this ticket, I think it's related to a problem I see as well.\nI'm building Sage 9.5 from source, also using `--prefix ...`.\nIt works fine, so, OK. But, each time it starts up:\n\n```\n/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory\nWarning: overwriting SAGE_ROOT environment variable:\nOld SAGE_ROOT=/home/sage/sage\nNew SAGE_ROOT=\n```\n\nIn particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.",
    "created_at": "2022-02-09T12:47:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535159",
    "user": "https://github.com/haraldschilly"
}
```

<div id="comment:21" align="right">comment:21</div>

I just found this ticket, I think it's related to a problem I see as well.
I'm building Sage 9.5 from source, also using `--prefix ...`.
It works fine, so, OK. But, each time it starts up:

```
/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory
Warning: overwriting SAGE_ROOT environment variable:
Old SAGE_ROOT=/home/sage/sage
New SAGE_ROOT=
```

In particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.



---

archive/issue_comments_535160.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI think we can reuse this ticket to do what is discussed in [comment:18](#comment:18)",
    "created_at": "2022-02-09T18:08:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535160",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

I think we can reuse this ticket to do what is discussed in [comment:18](#comment:18)



---

archive/issue_comments_535161.json:
```json
{
    "body": "Changed branch from **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)** to **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)**",
    "created_at": "2022-02-10T01:58:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535161",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)** to **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)**



---

archive/issue_events_458023.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-10T02:02:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "title_is": "Fix warning about missing sage-site when SAGE_ROOT is removed after installation",
    "title_was": "Warning about missing sage-site when installing without `build` dir",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458023"
}
```



---

archive/issue_comments_535162.json:
```json
{
    "body": "Changed commit from **[`424de09`](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)** to **[`87af7f4`](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)**",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535162",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`424de09`](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)** to **[`87af7f4`](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)**



---

archive/issue_comments_535163.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991\"><code>87af7f4</code></a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535163",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991"><code>87af7f4</code></a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr></table>




---

archive/issue_comments_535164.json:
```json
{
    "body": "Changed author from **Gonzalo Tornar\u00eda** to **Matthias Koeppe**",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535164",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Gonzalo Tornaría** to **Matthias Koeppe**



---

archive/issue_comments_535165.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:\n+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n+\n+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n \n ```\n **********************************************************************\n@@ -11,4 +13,4 @@\n     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n **********************************************************************\n ```\n-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.\n+\n``````\n",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535165",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:
+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.
+
+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:
 
 ```
 **********************************************************************
@@ -11,4 +13,4 @@
     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
 **********************************************************************
 ```
-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.
+
``````




---

archive/issue_comments_535166.json:
```json
{
    "body": "Changed commit from **[`87af7f4`](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)** to **[`5064185`](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)**",
    "created_at": "2022-02-10T02:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535166",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`87af7f4`](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)** to **[`5064185`](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)**



---

archive/issue_comments_535167.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba\"><code>5064185</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535167",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba"><code>5064185</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_535168.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b\"><code>9b66374</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535168",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b"><code>9b66374</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_535169.json:
```json
{
    "body": "Changed commit from **[`5064185`](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)** to **[`9b66374`](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)**",
    "created_at": "2022-02-10T02:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535169",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5064185`](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)** to **[`9b66374`](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)**



---

archive/issue_comments_535170.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ac9f30225dacc7c443527a6c1b6aa7ad0526c3a7\"><code>ac9f302</code></a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e\"><code>5ee6fba</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-13T17:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535170",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ac9f30225dacc7c443527a6c1b6aa7ad0526c3a7"><code>ac9f302</code></a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e"><code>5ee6fba</code></a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_535171.json:
```json
{
    "body": "Changed commit from **[`9b66374`](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)** to **[`5ee6fba`](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)**",
    "created_at": "2022-02-13T17:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535171",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9b66374`](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)** to **[`5ee6fba`](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)**



---

archive/issue_comments_535172.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nIn the line \n\n```\nif [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n```\nshould at least the last `-n` be changed to `-d`? And/or later in\n\n```\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\nfi\n```\nI guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?\n\nI'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).",
    "created_at": "2022-02-14T06:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535172",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

In the line 

```
if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
```
should at least the last `-n` be changed to `-d`? And/or later in

```
if [ -n "$NEW_SAGE_ROOT" ]; then
    export SAGE_ROOT="$NEW_SAGE_ROOT"
fi
```
I guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?

I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).



---

archive/issue_comments_535173.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jhpalmieri](#comment:29):\n> In the line \n> \n> ```\n> if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n> ```\n> should at least the last `-n` be changed to `-d`? \n\nNo, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory",
    "created_at": "2022-02-16T19:27:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535173",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jhpalmieri](#comment:29):
> In the line 
> 
> ```
> if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
> ```
> should at least the last `-n` be changed to `-d`? 

No, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory



---

archive/issue_comments_535174.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@jhpalmieri](#comment:29):\n> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).\n\nGood point, I'll change this. Also some of the comments in between are outdated",
    "created_at": "2022-02-16T19:29:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535174",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@jhpalmieri](#comment:29):
> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).

Good point, I'll change this. Also some of the comments in between are outdated



---

archive/issue_comments_535175.json:
```json
{
    "body": "<div id=\"comment:32\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/33d3d1ccc0a5abe156b506dd77b8bd4d2f46ed4e\"><code>33d3d1c</code></a></td><td><code>src/bin/sage-env: Merge code that sets SAGE_ROOT</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02\"><code>fdada1c</code></a></td><td><code>src/bin/sage-env: Update comments on SAGE_ENV_SOURCED</code></td></tr></table>\n",
    "created_at": "2022-02-16T19:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535175",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:32"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/33d3d1ccc0a5abe156b506dd77b8bd4d2f46ed4e"><code>33d3d1c</code></a></td><td><code>src/bin/sage-env: Merge code that sets SAGE_ROOT</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02"><code>fdada1c</code></a></td><td><code>src/bin/sage-env: Update comments on SAGE_ENV_SOURCED</code></td></tr></table>




---

archive/issue_comments_535176.json:
```json
{
    "body": "Changed commit from **[`5ee6fba`](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)** to **[`fdada1c`](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)**",
    "created_at": "2022-02-16T19:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535176",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5ee6fba`](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)** to **[`fdada1c`](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)**



---

archive/issue_comments_535177.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:\n\n```\n././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory\n```\nIn fact I get the same error just running `./bin/sage`.\n\nLine 122 is\n\n```\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n```\nIn the test a few lines earlier\n\n```\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\n```\nshould this be `-d`?",
    "created_at": "2022-02-16T23:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535177",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

I built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:

```
././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory
```
In fact I get the same error just running `./bin/sage`.

Line 122 is

```
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`
```
In the test a few lines earlier

```
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
```
should this be `-d`?



---

archive/issue_comments_535178.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI'm confused about the whole situation. The entire block\n\n```\n# New value for SAGE_ROOT: either SAGE_ROOT (if given)\n# or a guessed value based on pwd.\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\nelif [ -f sage -a -d build ]; then\n    NEW_SAGE_ROOT=\".\"\nelif [ -f ../../sage -a -d ../../build ]; then\n    NEW_SAGE_ROOT=\"../..\"\nfi\n\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n\n    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT\n    if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n        echo >&2 \"Warning: overwriting SAGE_ROOT environment variable:\"\n        echo >&2 \"Old SAGE_ROOT=$SAGE_ROOT\"\n        echo >&2 \"New SAGE_ROOT=$NEW_SAGE_ROOT\"\n        export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\n    fi\nfi\n```\nseems completely useless if `SAGE_ROOT` is no longer there.",
    "created_at": "2022-02-16T23:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535178",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:34" align="right">comment:34</div>

I'm confused about the whole situation. The entire block

```
# New value for SAGE_ROOT: either SAGE_ROOT (if given)
# or a guessed value based on pwd.
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
elif [ -f sage -a -d build ]; then
    NEW_SAGE_ROOT="."
elif [ -f ../../sage -a -d ../../build ]; then
    NEW_SAGE_ROOT="../.."
fi

if [ -n "$NEW_SAGE_ROOT" ]; then
    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`

    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT
    if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
        echo >&2 "Warning: overwriting SAGE_ROOT environment variable:"
        echo >&2 "Old SAGE_ROOT=$SAGE_ROOT"
        echo >&2 "New SAGE_ROOT=$NEW_SAGE_ROOT"
        export SAGE_ROOT="$NEW_SAGE_ROOT"
    fi
fi
```
seems completely useless if `SAGE_ROOT` is no longer there.



---

archive/issue_comments_535179.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nToward the end, at least we want to do `export SAGE_ROOT=\"$NEW_SAGE_ROOT\"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.",
    "created_at": "2022-02-16T23:06:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535179",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:35" align="right">comment:35</div>

Toward the end, at least we want to do `export SAGE_ROOT="$NEW_SAGE_ROOT"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.



---

archive/issue_comments_535180.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nYes, it's quite likely that this old code can be much simplified, I'll take a look",
    "created_at": "2022-02-17T02:28:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535180",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

Yes, it's quite likely that this old code can be much simplified, I'll take a look



---

archive/issue_comments_535181.json:
```json
{
    "body": "<div id=\"comment:37\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5\"><code>7828a79</code></a></td><td><code>src/bin/sage-env: Fixup: Move setting of SAGE_ROOT out of the inner-most if-block</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535181",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:37"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5"><code>7828a79</code></a></td><td><code>src/bin/sage-env: Fixup: Move setting of SAGE_ROOT out of the inner-most if-block</code></td></tr></table>




---

archive/issue_comments_535182.json:
```json
{
    "body": "Changed commit from **[`fdada1c`](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)** to **[`7828a79`](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)**",
    "created_at": "2022-02-17T06:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535182",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fdada1c`](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)** to **[`7828a79`](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)**



---

archive/issue_comments_535183.json:
```json
{
    "body": "<div id=\"comment:38\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d\"><code>2bd0742</code></a></td><td><code>src/bin/sage-env: Suppress error message from probing for NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:28:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535183",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d"><code>2bd0742</code></a></td><td><code>src/bin/sage-env: Suppress error message from probing for NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_535184.json:
```json
{
    "body": "Changed commit from **[`7828a79`](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)** to **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**",
    "created_at": "2022-02-17T06:28:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535184",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7828a79`](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)** to **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**



---

archive/issue_comments_535185.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nThe whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:\n\n- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`\n- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`\n- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0",
    "created_at": "2022-02-17T06:47:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535185",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">comment:39</div>

The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:

- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`
- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`
- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0



---

archive/issue_comments_535186.json:
```json
{
    "body": "Changed commit from **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[`5606f7c`](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)**",
    "created_at": "2022-02-17T06:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[`5606f7c`](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)**



---

archive/issue_comments_535187.json:
```json
{
    "body": "<div id=\"comment:40\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75\"><code>5606f7c</code></a></td><td><code>src/bin/sage-env: Do not try to guess SAGE_ROOT based on the presence of 'sage' and 'build'</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535187",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:40"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75"><code>5606f7c</code></a></td><td><code>src/bin/sage-env: Do not try to guess SAGE_ROOT based on the presence of 'sage' and 'build'</code></td></tr></table>




---

archive/issue_comments_535188.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@mkoeppe](#comment:39):\n> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. \n\nI don't think we need to support this, so I have removed this code.",
    "created_at": "2022-02-17T06:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535188",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@mkoeppe](#comment:39):
> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. 

I don't think we need to support this, so I have removed this code.



---

archive/issue_comments_535189.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nThis doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with\n\n```\n[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory\n```\nNote `build/make/build/pkgs`.",
    "created_at": "2022-02-17T17:01:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535189",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:42" align="right">comment:42</div>

This doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with

```
[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory
```
Note `build/make/build/pkgs`.



---

archive/issue_comments_535190.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nThanks for testing!",
    "created_at": "2022-02-17T17:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535190",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:43" align="right">comment:43</div>

Thanks for testing!



---

archive/issue_comments_535191.json:
```json
{
    "body": "Changed commit from **[`5606f7c`](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)** to **[`b0264c7`](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)**",
    "created_at": "2022-02-17T17:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535191",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5606f7c`](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)** to **[`b0264c7`](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)**



---

archive/issue_comments_535192.json:
```json
{
    "body": "<div id=\"comment:44\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976\"><code>b0264c7</code></a></td><td><code>src/bin/sage-env: Remove last trace of NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-17T17:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535192",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:44"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976"><code>b0264c7</code></a></td><td><code>src/bin/sage-env: Remove last trace of NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_535193.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nNow it might actually work",
    "created_at": "2022-02-17T17:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535193",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:45" align="right">comment:45</div>

Now it might actually work



---

archive/issue_comments_535194.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nSage builds now, but I am still struggling with other aspects.\n\n- `./configure --prefix=PREFIX`\n- `make build`\n- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`\n- `cd PREFIX`\n- Then `./bin/sage` worked!\n- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:\n\n```\nTraceback (most recent call last):\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location\", line 102, in <module>\n    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):\n  File \"/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py\", line 101, in samefile\n    s2 = os.stat(f2)\nFileNotFoundError: [Errno 2] No such file or directory: ''\n```\n(The path for `sage-location` is `PREFIX/bin/sage-location`.)",
    "created_at": "2022-02-17T19:18:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535194",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:46" align="right">comment:46</div>

Sage builds now, but I am still struggling with other aspects.

- `./configure --prefix=PREFIX`
- `make build`
- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`
- `cd PREFIX`
- Then `./bin/sage` worked!
- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:

```
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location", line 102, in <module>
    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
  File "/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py", line 101, in samefile
    s2 = os.stat(f2)
FileNotFoundError: [Errno 2] No such file or directory: ''
```
(The path for `sage-location` is `PREFIX/bin/sage-location`.)



---

archive/issue_comments_535195.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nIf I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get\n\n```\nERROR:  The Sage installation tree has moved\n\nfrom /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X\n  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1\n\nThis is not supported, and Sage will not work...\n```",
    "created_at": "2022-02-17T19:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535195",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:47" align="right">comment:47</div>

If I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get

```
ERROR:  The Sage installation tree has moved

from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X
  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1

This is not supported, and Sage will not work...
```



---

archive/issue_comments_535196.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nOK, so this is a great opportunity to get rid of `sage-location` altogether",
    "created_at": "2022-02-17T19:27:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535196",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:48" align="right">comment:48</div>

OK, so this is a great opportunity to get rid of `sage-location` altogether



---

archive/issue_comments_535197.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\n... but this will best be done on top of #30649, which touches some of the `sage-location`-using code",
    "created_at": "2022-02-17T19:40:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535197",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:49" align="right">comment:49</div>

... but this will best be done on top of #30649, which touches some of the `sage-location`-using code



---

archive/issue_comments_535198.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nWell, #30649 has this as a dependency, so what order do we want to make these changes?",
    "created_at": "2022-02-17T19:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535198",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:50" align="right">comment:50</div>

Well, #30649 has this as a dependency, so what order do we want to make these changes?



---

archive/issue_comments_535199.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nI've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version",
    "created_at": "2022-02-17T19:52:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535199",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:51" align="right">comment:51</div>

I've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version



---

archive/issue_comments_535200.json:
```json
{
    "body": "Changed commit from **[`b0264c7`](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)** to **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**",
    "created_at": "2022-02-17T19:53:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535200",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b0264c7`](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)** to **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**



---

archive/issue_comments_535201.json:
```json
{
    "body": "<div id=\"comment:52\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-17T19:53:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535201",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:52"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_535202.json:
```json
{
    "body": "Changed commit from **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**",
    "created_at": "2022-02-17T20:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535202",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2bd0742`](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**



---

archive/issue_comments_535203.json:
```json
{
    "body": "<div id=\"comment:53\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a\"><code>702b779</code></a></td><td><code>src/bin/sage-env: Do not set SAGE_ROOT to empty; sage-location does not like it</code></td></tr></table>\n",
    "created_at": "2022-02-17T20:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535203",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:53"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a"><code>702b779</code></a></td><td><code>src/bin/sage-env: Do not set SAGE_ROOT to empty; sage-location does not like it</code></td></tr></table>




---

archive/issue_comments_535204.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nThis version may be worth testing",
    "created_at": "2022-02-17T20:06:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535204",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:54" align="right">comment:54</div>

This version may be worth testing



---

archive/issue_comments_535205.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nSame symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:\n\n```\nFileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'\n```\n(That is, `FileNotFoundError: ... old SAGE_ROOT`.)",
    "created_at": "2022-02-17T22:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535205",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:55" align="right">comment:55</div>

Same symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:

```
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'
```
(That is, `FileNotFoundError: ... old SAGE_ROOT`.)



---

archive/issue_comments_535206.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nDoes this work without this ticket?",
    "created_at": "2022-02-17T23:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535206",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:56" align="right">comment:56</div>

Does this work without this ticket?



---

archive/issue_comments_535207.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nDon't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?",
    "created_at": "2022-02-17T23:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535207",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:57" align="right">comment:57</div>

Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?



---

archive/issue_comments_535208.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nReplying to [@jhpalmieri](#comment:57):\n> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?\n\nI can confirm essentially the same problem without this ticket.",
    "created_at": "2022-02-18T00:12:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535208",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:58" align="right">comment:58</div>

Replying to [@jhpalmieri](#comment:57):
> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?

I can confirm essentially the same problem without this ticket.



---

archive/issue_comments_535209.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nThanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371",
    "created_at": "2022-02-18T00:14:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535209",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:59" align="right">comment:59</div>

Thanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371



---

archive/issue_comments_535210.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nI agree that it's not clear what exactly to test here",
    "created_at": "2022-02-18T00:15:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535210",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:60" align="right">comment:60</div>

I agree that it's not clear what exactly to test here



---

archive/issue_comments_535211.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nThe changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.",
    "created_at": "2022-02-19T04:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535211",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:61" align="right">comment:61</div>

The changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.



---

archive/issue_comments_535212.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2022-02-19T04:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535212",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_458024.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-02-19T04:08:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458024"
}
```



---

archive/issue_events_458025.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-02-19T04:08:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458025"
}
```



---

archive/issue_comments_535213.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nThank you!",
    "created_at": "2022-02-19T05:46:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535213",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:62" align="right">comment:62</div>

Thank you!



---

archive/issue_events_458026.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-21T21:56:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458026"
}
```



---

archive/issue_events_458027.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d08b099239d9dcb2147a4771b77bc54fc6075b1d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-02-21T21:56:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-458027"
}
```



---

archive/issue_comments_535214.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)** to **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**",
    "created_at": "2022-02-21T21:56:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-535214",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)** to **[`702b779`](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**
