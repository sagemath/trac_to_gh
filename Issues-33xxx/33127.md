# Issue 33127: Fix warning about missing sage-site when SAGE_ROOT is removed after installation

archive/issues_032890.json:
```json
{
    "assignees": [],
    "body": "If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n\nThis fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n\n```\n**********************************************************************\nFile \"/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py\", line 170, in sage.tests.cmdline.test_executable\nFailed example:\n    err  \nExpected:\n    ''   \nGot:\n    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n**********************************************************************\n```\n\n\nCC:  @jhpalmieri\n\nBranch/Commit: **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33127_\n\n",
    "closed_at": "2022-02-21T21:56:23Z",
    "created_at": "2022-01-07T17:13:54Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20distribution",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix warning about missing sage-site when SAGE_ROOT is removed after installation",
    "type": "issue",
    "updated_at": "2022-02-21T21:56:23Z",
    "url": "https://github.com/sagemath/sage/issues/33127",
    "user": "https://github.com/tornaria"
}
```
If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.

This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:

```
**********************************************************************
File "/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py", line 170, in sage.tests.cmdline.test_executable
Failed example:
    err  
Expected:
    ''   
Got:
    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
**********************************************************************
```


CC:  @jhpalmieri

Branch/Commit: **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**

Reviewer: **John Palmieri**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/33127_





---

archive/issue_events_437514.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437514"
}
```



---

archive/issue_events_437515.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20distribution",
    "label_color": "000080",
    "label_name": "component: distribution",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437515"
}
```



---

archive/issue_events_437516.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437516"
}
```



---

archive/issue_events_437517.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:13:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437517"
}
```



---

archive/issue_comments_538259.json:
```json
{
    "body": "Branch: **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538259",
    "user": "https://github.com/tornaria"
}
```

Branch: **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)**



---

archive/issue_comments_538260.json:
```json
{
    "body": "Author: **Gonzalo Tornar\u00eda**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538260",
    "user": "https://github.com/tornaria"
}
```

Author: **Gonzalo Tornaría**



---

archive/issue_comments_538261.json:
```json
{
    "body": "Commit: **[424de09](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)**",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538261",
    "user": "https://github.com/tornaria"
}
```

Commit: **[424de09](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)**



---

archive/issue_comments_538262.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234\">424de09</a></td><td><code>sage-site: exec only if it is executable</code></td></tr></table>\n",
    "created_at": "2022-01-07T17:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538262",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234">424de09</a></td><td><code>sage-site: exec only if it is executable</code></td></tr></table>




---

archive/issue_events_437518.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-01-07T17:14:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437518"
}
```



---

archive/issue_comments_538263.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI think you should just unset `SAGE_ROOT` in your distro build.",
    "created_at": "2022-01-07T18:45:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538263",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'>Comment 2:</a>
I think you should just unset `SAGE_ROOT` in your distro build.



---

archive/issue_comments_538264.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [@mkoeppe](#comment%3A2):\n> I think you should just unset `SAGE_ROOT` in your distro build.\n\nI'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).\n\nI don't see an easy way to unset it.",
    "created_at": "2022-01-07T19:07:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538264",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [@mkoeppe](#comment%3A2):
> I think you should just unset `SAGE_ROOT` in your distro build.

I'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).

I don't see an easy way to unset it.



---

archive/issue_comments_538265.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIn distribution packaging, the `SAGE_ROOT/sage` script should not be used.\n\nThe installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.",
    "created_at": "2022-01-07T19:11:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538265",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'>Comment 4:</a>
In distribution packaging, the `SAGE_ROOT/sage` script should not be used.

The installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.



---

archive/issue_comments_538266.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nHmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?\n\nIn any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\nI have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).",
    "created_at": "2022-01-07T19:26:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538266",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'>Comment 5:</a>
Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?

In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

I have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).



---

archive/issue_comments_538267.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@tornaria](#comment%3A5):\n> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?\n\nYes",
    "created_at": "2022-01-07T19:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538267",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@tornaria](#comment%3A5):
> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?

Yes



---

archive/issue_comments_538268.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nReplying to [@tornaria](#comment%3A5):\n> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\nYes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.",
    "created_at": "2022-01-07T19:28:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538268",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>Comment 7:</a>
Replying to [@tornaria](#comment%3A5):
> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.



---

archive/issue_comments_538269.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@mkoeppe](#comment%3A7):\n> Replying to [@tornaria](#comment%3A5):\n> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?\n\n> \n> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.\n\nMy first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.\n\nOTOH, where would I place the src? Isn't it necessary for `??` to work?",
    "created_at": "2022-01-07T19:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538269",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@mkoeppe](#comment%3A7):
> Replying to [@tornaria](#comment%3A5):
> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

> 
> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.

My first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.

OTOH, where would I place the src? Isn't it necessary for `??` to work?



---

archive/issue_comments_538270.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [@tornaria](#comment%3A8):\n> My first try was using `--prefix` and installing only `SAGE_LOCAL`.\n\nYes, that's how it's done.\n\n> However, binaries are not installed \n\n??",
    "created_at": "2022-01-07T19:53:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [@tornaria](#comment%3A8):
> My first try was using `--prefix` and installing only `SAGE_LOCAL`.

Yes, that's how it's done.

> However, binaries are not installed 

??



---

archive/issue_comments_538271.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nYou don't need to install `src`.",
    "created_at": "2022-01-07T19:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538271",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'>Comment 10:</a>
You don't need to install `src`.



---

archive/issue_comments_538272.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nOne more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\nRegarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have\n\n```\n$ ls -l /usr/lib/sage-9.5.beta9/local/bin/\ntotal 2224\n-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac\n-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap\n-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin\n-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol\n```",
    "created_at": "2022-01-07T19:55:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538272",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:11'>Comment 11:</a>
One more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Regarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have

```
$ ls -l /usr/lib/sage-9.5.beta9/local/bin/
total 2224
-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac
-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap
-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin
-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol
```



---

archive/issue_comments_538273.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@tornaria](#comment%3A11):\n> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?\n\nYes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.\n\nThis is implied by using `--prefix`.\n\n(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)",
    "created_at": "2022-01-07T19:57:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@tornaria](#comment%3A11):
> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Yes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.

This is implied by using `--prefix`.

(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)



---

archive/issue_comments_538274.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@tornaria](#comment%3A8):\n> Isn't it necessary for `??` to work?\n\n`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.\nhttps://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182\n\nThis makes `??` work for `.py` files (but not `.pyx` files)",
    "created_at": "2022-01-07T20:27:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538274",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@tornaria](#comment%3A8):
> Isn't it necessary for `??` to work?

`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.
https://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182

This makes `??` work for `.py` files (but not `.pyx` files)



---

archive/issue_comments_538275.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nInstead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n\n(as found by `git grep '[[].*SAGE_ROOT'`)\n\nThis would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.",
    "created_at": "2022-01-07T22:59:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538275",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'>Comment 14:</a>
Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 

(as found by `git grep '[[].*SAGE_ROOT'`)

This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.



---

archive/issue_comments_538276.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@mkoeppe](#comment%3A14):\n> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n \"$SAGE_ROOT\" ]` to `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> \n> (as found by `git grep '[[].*SAGE_ROOT'`)\n> \n> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.\n> \n\nThat could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\n\nOTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.\n\nSo far I know two places where I have to patch:\n- `SAGE_LOCAL/bin/sage-env-config`\n- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\nThere's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.",
    "created_at": "2022-01-08T00:02:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538276",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@mkoeppe](#comment%3A14):
> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> 
> (as found by `git grep '[[].*SAGE_ROOT'`)
> 
> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.
> 

That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?


OTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.

So far I know two places where I have to patch:
- `SAGE_LOCAL/bin/sage-env-config`
- `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.



---

archive/issue_comments_538277.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nReplying to [@tornaria](#comment%3A15):\n> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.\n\nThat's right, it isn't.",
    "created_at": "2022-01-08T00:04:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538277",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'>Comment 16:</a>
Replying to [@tornaria](#comment%3A15):
> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.

That's right, it isn't.



---

archive/issue_comments_538278.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@tornaria](#comment%3A15):\n> So far I know two places where I have to patch:\n> - `SAGE_LOCAL/bin/sage-env-config`\n> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`\n\nYes, these are the only 2 installed configuration files.",
    "created_at": "2022-01-08T00:05:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538278",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@tornaria](#comment%3A15):
> So far I know two places where I have to patch:
> - `SAGE_LOCAL/bin/sage-env-config`
> - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

Yes, these are the only 2 installed configuration files.



---

archive/issue_comments_538279.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@tornaria](#comment%3A15):\n> Replying to [@mkoeppe](#comment%3A14):\n> > `[ -n \"$SAGE_ROOT\" -a -d \"$SAGE_ROOT\" ]`. \n> > \n\n> That could work... isn't `[ -d \"$SAGE_ROOT\" ]` equivalent?\n\nRight, that's shorter",
    "created_at": "2022-01-08T00:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538279",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@tornaria](#comment%3A15):
> Replying to [@mkoeppe](#comment%3A14):
> > `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> > 

> That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?

Right, that's shorter



---

archive/issue_comments_538280.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nHi there,\n\nI can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.",
    "created_at": "2022-01-08T20:13:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538280",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'>Comment 19:</a>
Hi there,

I can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.



---

archive/issue_events_437519.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-12T17:35:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437519"
}
```



---

archive/issue_events_437520.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-12T17:35:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437520"
}
```



---

archive/issue_comments_538281.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nI just found this ticket, I think it's related to a problem I see as well.\nI'm building Sage 9.5 from source, also using `--prefix ...`.\nIt works fine, so, OK. But, each time it starts up:\n\n```\n/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory\nWarning: overwriting SAGE_ROOT environment variable:\nOld SAGE_ROOT=/home/sage/sage\nNew SAGE_ROOT=\n```\n\nIn particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.",
    "created_at": "2022-02-09T12:47:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538281",
    "user": "https://github.com/haraldschilly"
}
```

<a id='comment:21'>Comment 21:</a>
I just found this ticket, I think it's related to a problem I see as well.
I'm building Sage 9.5 from source, also using `--prefix ...`.
It works fine, so, OK. But, each time it starts up:

```
/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory
Warning: overwriting SAGE_ROOT environment variable:
Old SAGE_ROOT=/home/sage/sage
New SAGE_ROOT=
```

In particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.



---

archive/issue_comments_538282.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nI think we can reuse this ticket to do what is discussed in [comment:18](#comment%3A18)",
    "created_at": "2022-02-09T18:08:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538282",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'>Comment 22:</a>
I think we can reuse this ticket to do what is discussed in [comment:18](#comment%3A18)



---

archive/issue_comments_538283.json:
```json
{
    "body": "Changed branch from **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)** to **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)**",
    "created_at": "2022-02-10T01:58:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538283",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/tornaria/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/sage-site)** to **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)**



---

archive/issue_events_437521.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-10T02:02:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "title_is": "Fix warning about missing sage-site when SAGE_ROOT is removed after installation",
    "title_was": "Warning about missing sage-site when installing without `build` dir",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437521"
}
```



---

archive/issue_comments_538284.json:
```json
{
    "body": "Changed commit from **[424de09](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)** to **[87af7f4](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)**",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538284",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[424de09](https://github.com/sagemath/sagetrac-mirror/commit/424de0923cb3d44d010e3e2f9bd7bc75d5c30234)** to **[87af7f4](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)**



---

archive/issue_comments_538285.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991\">87af7f4</a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538285",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'>Comment 24:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991">87af7f4</a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr></table>




---

archive/issue_comments_538286.json:
```json
{
    "body": "Changed author from **Gonzalo Tornar\u00eda** to **Matthias Koeppe**",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538286",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Gonzalo Tornaría** to **Matthias Koeppe**



---

archive/issue_comments_538287.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:\n+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.\n+\n+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:\n \n ```\n **********************************************************************\n@@ -11,4 +13,4 @@\n     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\\n'\n **********************************************************************\n ```\n-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.\n+\n``````\n",
    "created_at": "2022-02-10T02:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538287",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:
+If users remove the source tree (`SAGE_ROOT`) after installing Sage into a prefix (`SAGE_LOCAL`), we treat this the same as if `SAGE_ROOT` is empty.
+
+This fixes warnings such as in doctests in `src/sage/tests/cmdline.py`:
 
 ```
 **********************************************************************
@@ -11,4 +13,4 @@
     '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
 **********************************************************************
 ```
-Proposed solution: test that `sage-site` exists and is executable before trying to exec it.
+
``````




---

archive/issue_comments_538288.json:
```json
{
    "body": "Changed commit from **[87af7f4](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)** to **[5064185](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)**",
    "created_at": "2022-02-10T02:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538288",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[87af7f4](https://github.com/sagemath/sagetrac-mirror/commit/87af7f4fd5e41260e56ff45e4a7da2e2201d7991)** to **[5064185](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)**



---

archive/issue_comments_538289.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba\">5064185</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538289",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:25'>Comment 25:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba">5064185</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_538290.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b\">9b66374</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-10T02:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538290",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:26'>Comment 26:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b">9b66374</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_538291.json:
```json
{
    "body": "Changed commit from **[5064185](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)** to **[9b66374](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)**",
    "created_at": "2022-02-10T02:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538291",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5064185](https://github.com/sagemath/sagetrac-mirror/commit/50641855831909c36a75c33641eee1e4aeddeeba)** to **[9b66374](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)**



---

archive/issue_comments_538292.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ac9f30225dacc7c443527a6c1b6aa7ad0526c3a7\">ac9f302</a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e\">5ee6fba</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-13T17:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538292",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:27'>Comment 27:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ac9f30225dacc7c443527a6c1b6aa7ad0526c3a7">ac9f302</a></td><td><code>src/bin/sage, src/bin/sage-env: Treat SAGE_ROOT = nonexisting directory like SAGE_ROOT unset</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e">5ee6fba</a></td><td><code>src/bin/sage-env: Suppress warning 'overwriting SAGE_ROOT' for empty NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_538293.json:
```json
{
    "body": "Changed commit from **[9b66374](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)** to **[5ee6fba](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)**",
    "created_at": "2022-02-13T17:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538293",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9b66374](https://github.com/sagemath/sagetrac-mirror/commit/9b663748bdfba27b3a31fe9f908acfaa393e347b)** to **[5ee6fba](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)**



---

archive/issue_comments_538294.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nIn the line \n\n```\nif [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n```\nshould at least the last `-n` be changed to `-d`? And/or later in\n\n```\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\nfi\n```\nI guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?\n\nI'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).",
    "created_at": "2022-02-14T06:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538294",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:29'>Comment 29:</a>
In the line 

```
if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
```
should at least the last `-n` be changed to `-d`? And/or later in

```
if [ -n "$NEW_SAGE_ROOT" ]; then
    export SAGE_ROOT="$NEW_SAGE_ROOT"
fi
```
I guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?

I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).



---

archive/issue_comments_538295.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nReplying to [@jhpalmieri](#comment%3A29):\n> In the line \n> \n> ```\n> if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n> ```\n> should at least the last `-n` be changed to `-d`? \n\nNo, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory",
    "created_at": "2022-02-16T19:27:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538295",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'>Comment 30:</a>
Replying to [@jhpalmieri](#comment%3A29):
> In the line 
> 
> ```
> if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
> ```
> should at least the last `-n` be changed to `-d`? 

No, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory



---

archive/issue_comments_538296.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nReplying to [@jhpalmieri](#comment%3A29):\n> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `\"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\"`, etc.).\n\nGood point, I'll change this. Also some of the comments in between are outdated",
    "created_at": "2022-02-16T19:29:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538296",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>Comment 31:</a>
Replying to [@jhpalmieri](#comment%3A29):
> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).

Good point, I'll change this. Also some of the comments in between are outdated



---

archive/issue_comments_538297.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/33d3d1ccc0a5abe156b506dd77b8bd4d2f46ed4e\">33d3d1c</a></td><td><code>src/bin/sage-env: Merge code that sets SAGE_ROOT</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02\">fdada1c</a></td><td><code>src/bin/sage-env: Update comments on SAGE_ENV_SOURCED</code></td></tr></table>\n",
    "created_at": "2022-02-16T19:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538297",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:32'>Comment 32:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/33d3d1ccc0a5abe156b506dd77b8bd4d2f46ed4e">33d3d1c</a></td><td><code>src/bin/sage-env: Merge code that sets SAGE_ROOT</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02">fdada1c</a></td><td><code>src/bin/sage-env: Update comments on SAGE_ENV_SOURCED</code></td></tr></table>




---

archive/issue_comments_538298.json:
```json
{
    "body": "Changed commit from **[5ee6fba](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)** to **[fdada1c](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)**",
    "created_at": "2022-02-16T19:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538298",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5ee6fba](https://github.com/sagemath/sagetrac-mirror/commit/5ee6fba4ab5ead77a3905656e028064206afce3e)** to **[fdada1c](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)**



---

archive/issue_comments_538299.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nI built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:\n\n```\n././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory\n```\nIn fact I get the same error just running `./bin/sage`.\n\nLine 122 is\n\n```\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n```\nIn the test a few lines earlier\n\n```\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\n```\nshould this be `-d`?",
    "created_at": "2022-02-16T23:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538299",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'>Comment 33:</a>
I built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:

```
././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory
```
In fact I get the same error just running `./bin/sage`.

Line 122 is

```
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`
```
In the test a few lines earlier

```
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
```
should this be `-d`?



---

archive/issue_comments_538300.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nI'm confused about the whole situation. The entire block\n\n```\n# New value for SAGE_ROOT: either SAGE_ROOT (if given)\n# or a guessed value based on pwd.\nif [ -n \"$SAGE_ROOT\" ]; then\n    NEW_SAGE_ROOT=\"$SAGE_ROOT\"\nelif [ -f sage -a -d build ]; then\n    NEW_SAGE_ROOT=\".\"\nelif [ -f ../../sage -a -d ../../build ]; then\n    NEW_SAGE_ROOT=\"../..\"\nfi\n\nif [ -n \"$NEW_SAGE_ROOT\" ]; then\n    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.\n    NEW_SAGE_ROOT=`cd \"$NEW_SAGE_ROOT\" && pwd -P`\n\n    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT\n    if [ \"$SAGE_ROOT\" != \"$NEW_SAGE_ROOT\" -a -n \"$SAGE_ROOT\" -a -n \"$NEW_SAGE_ROOT\" ]; then\n        echo >&2 \"Warning: overwriting SAGE_ROOT environment variable:\"\n        echo >&2 \"Old SAGE_ROOT=$SAGE_ROOT\"\n        echo >&2 \"New SAGE_ROOT=$NEW_SAGE_ROOT\"\n        export SAGE_ROOT=\"$NEW_SAGE_ROOT\"\n    fi\nfi\n```\nseems completely useless if `SAGE_ROOT` is no longer there.",
    "created_at": "2022-02-16T23:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538300",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'>Comment 34:</a>
I'm confused about the whole situation. The entire block

```
# New value for SAGE_ROOT: either SAGE_ROOT (if given)
# or a guessed value based on pwd.
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
elif [ -f sage -a -d build ]; then
    NEW_SAGE_ROOT="."
elif [ -f ../../sage -a -d ../../build ]; then
    NEW_SAGE_ROOT="../.."
fi

if [ -n "$NEW_SAGE_ROOT" ]; then
    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`

    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT
    if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
        echo >&2 "Warning: overwriting SAGE_ROOT environment variable:"
        echo >&2 "Old SAGE_ROOT=$SAGE_ROOT"
        echo >&2 "New SAGE_ROOT=$NEW_SAGE_ROOT"
        export SAGE_ROOT="$NEW_SAGE_ROOT"
    fi
fi
```
seems completely useless if `SAGE_ROOT` is no longer there.



---

archive/issue_comments_538301.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nToward the end, at least we want to do `export SAGE_ROOT=\"$NEW_SAGE_ROOT\"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.",
    "created_at": "2022-02-16T23:06:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538301",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:35'>Comment 35:</a>
Toward the end, at least we want to do `export SAGE_ROOT="$NEW_SAGE_ROOT"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.



---

archive/issue_comments_538302.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nYes, it's quite likely that this old code can be much simplified, I'll take a look",
    "created_at": "2022-02-17T02:28:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538302",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'>Comment 36:</a>
Yes, it's quite likely that this old code can be much simplified, I'll take a look



---

archive/issue_comments_538303.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5\">7828a79</a></td><td><code>src/bin/sage-env: Fixup: Move setting of SAGE_ROOT out of the inner-most if-block</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538303",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:37'>Comment 37:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5">7828a79</a></td><td><code>src/bin/sage-env: Fixup: Move setting of SAGE_ROOT out of the inner-most if-block</code></td></tr></table>




---

archive/issue_comments_538304.json:
```json
{
    "body": "Changed commit from **[fdada1c](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)** to **[7828a79](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)**",
    "created_at": "2022-02-17T06:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538304",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[fdada1c](https://github.com/sagemath/sagetrac-mirror/commit/fdada1c6b0eef8a857fc9f652f59ec1b86ce5c02)** to **[7828a79](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)**



---

archive/issue_comments_538305.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d\">2bd0742</a></td><td><code>src/bin/sage-env: Suppress error message from probing for NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:28:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538305",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:38'>Comment 38:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d">2bd0742</a></td><td><code>src/bin/sage-env: Suppress error message from probing for NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_538306.json:
```json
{
    "body": "Changed commit from **[7828a79](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)** to **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**",
    "created_at": "2022-02-17T06:28:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538306",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[7828a79](https://github.com/sagemath/sagetrac-mirror/commit/7828a7919cc7735d6bb2cbe03196f008f0c33ad5)** to **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**



---

archive/issue_comments_538307.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nThe whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:\n\n- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`\n- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`\n- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0",
    "created_at": "2022-02-17T06:47:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538307",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'>Comment 39:</a>
The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:

- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`
- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`
- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0



---

archive/issue_comments_538308.json:
```json
{
    "body": "Changed commit from **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[5606f7c](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)**",
    "created_at": "2022-02-17T06:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538308",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[5606f7c](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)**



---

archive/issue_comments_538309.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75\">5606f7c</a></td><td><code>src/bin/sage-env: Do not try to guess SAGE_ROOT based on the presence of 'sage' and 'build'</code></td></tr></table>\n",
    "created_at": "2022-02-17T06:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538309",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:40'>Comment 40:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75">5606f7c</a></td><td><code>src/bin/sage-env: Do not try to guess SAGE_ROOT based on the presence of 'sage' and 'build'</code></td></tr></table>




---

archive/issue_comments_538310.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nReplying to [@mkoeppe](#comment%3A39):\n> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. \n\nI don't think we need to support this, so I have removed this code.",
    "created_at": "2022-02-17T06:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538310",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'>Comment 41:</a>
Replying to [@mkoeppe](#comment%3A39):
> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. 

I don't think we need to support this, so I have removed this code.



---

archive/issue_comments_538311.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nThis doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with\n\n```\n[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory\n```\nNote `build/make/build/pkgs`.",
    "created_at": "2022-02-17T17:01:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538311",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:42'>Comment 42:</a>
This doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with

```
[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory
```
Note `build/make/build/pkgs`.



---

archive/issue_comments_538312.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nThanks for testing!",
    "created_at": "2022-02-17T17:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538312",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'>Comment 43:</a>
Thanks for testing!



---

archive/issue_comments_538313.json:
```json
{
    "body": "Changed commit from **[5606f7c](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)** to **[b0264c7](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)**",
    "created_at": "2022-02-17T17:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538313",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5606f7c](https://github.com/sagemath/sagetrac-mirror/commit/5606f7c4a13df3f02f08f3ea4b07bd14f563bb75)** to **[b0264c7](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)**



---

archive/issue_comments_538314.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976\">b0264c7</a></td><td><code>src/bin/sage-env: Remove last trace of NEW_SAGE_ROOT</code></td></tr></table>\n",
    "created_at": "2022-02-17T17:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538314",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:44'>Comment 44:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976">b0264c7</a></td><td><code>src/bin/sage-env: Remove last trace of NEW_SAGE_ROOT</code></td></tr></table>




---

archive/issue_comments_538315.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\nNow it might actually work",
    "created_at": "2022-02-17T17:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538315",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'>Comment 45:</a>
Now it might actually work



---

archive/issue_comments_538316.json:
```json
{
    "body": "<a id='comment:46'>Comment 46:</a>\nSage builds now, but I am still struggling with other aspects.\n\n- `./configure --prefix=PREFIX`\n- `make build`\n- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`\n- `cd PREFIX`\n- Then `./bin/sage` worked!\n- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:\n\n```\nTraceback (most recent call last):\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location\", line 102, in <module>\n    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):\n  File \"/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py\", line 101, in samefile\n    s2 = os.stat(f2)\nFileNotFoundError: [Errno 2] No such file or directory: ''\n```\n(The path for `sage-location` is `PREFIX/bin/sage-location`.)",
    "created_at": "2022-02-17T19:18:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538316",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:46'>Comment 46:</a>
Sage builds now, but I am still struggling with other aspects.

- `./configure --prefix=PREFIX`
- `make build`
- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`
- `cd PREFIX`
- Then `./bin/sage` worked!
- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:

```
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location", line 102, in <module>
    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
  File "/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py", line 101, in samefile
    s2 = os.stat(f2)
FileNotFoundError: [Errno 2] No such file or directory: ''
```
(The path for `sage-location` is `PREFIX/bin/sage-location`.)



---

archive/issue_comments_538317.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\nIf I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get\n\n```\nERROR:  The Sage installation tree has moved\n\nfrom /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X\n  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1\n\nThis is not supported, and Sage will not work...\n```",
    "created_at": "2022-02-17T19:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538317",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:47'>Comment 47:</a>
If I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get

```
ERROR:  The Sage installation tree has moved

from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X
  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1

This is not supported, and Sage will not work...
```



---

archive/issue_comments_538318.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\nOK, so this is a great opportunity to get rid of `sage-location` altogether",
    "created_at": "2022-02-17T19:27:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538318",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'>Comment 48:</a>
OK, so this is a great opportunity to get rid of `sage-location` altogether



---

archive/issue_comments_538319.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\n... but this will best be done on top of #30649, which touches some of the `sage-location`-using code",
    "created_at": "2022-02-17T19:40:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538319",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'>Comment 49:</a>
... but this will best be done on top of #30649, which touches some of the `sage-location`-using code



---

archive/issue_comments_538320.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nWell, #30649 has this as a dependency, so what order do we want to make these changes?",
    "created_at": "2022-02-17T19:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538320",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'>Comment 50:</a>
Well, #30649 has this as a dependency, so what order do we want to make these changes?



---

archive/issue_comments_538321.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nI've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version",
    "created_at": "2022-02-17T19:52:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538321",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:51'>Comment 51:</a>
I've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version



---

archive/issue_comments_538322.json:
```json
{
    "body": "Changed commit from **[b0264c7](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)** to **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**",
    "created_at": "2022-02-17T19:53:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538322",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b0264c7](https://github.com/sagemath/sagetrac-mirror/commit/b0264c7459f81cf1e86a1c1f157e00632219c976)** to **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)**



---

archive/issue_comments_538323.json:
```json
{
    "body": "<a id='comment:52'>Comment 52:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-17T19:53:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538323",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:52'>Comment 52:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_538324.json:
```json
{
    "body": "Changed commit from **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**",
    "created_at": "2022-02-17T20:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538324",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2bd0742](https://github.com/sagemath/sagetrac-mirror/commit/2bd07420e5d0775fbfa98e8460be918ceffbc06d)** to **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**



---

archive/issue_comments_538325.json:
```json
{
    "body": "<a id='comment:53'>Comment 53:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a\">702b779</a></td><td><code>src/bin/sage-env: Do not set SAGE_ROOT to empty; sage-location does not like it</code></td></tr></table>\n",
    "created_at": "2022-02-17T20:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538325",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:53'>Comment 53:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a">702b779</a></td><td><code>src/bin/sage-env: Do not set SAGE_ROOT to empty; sage-location does not like it</code></td></tr></table>




---

archive/issue_comments_538326.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nThis version may be worth testing",
    "created_at": "2022-02-17T20:06:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538326",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'>Comment 54:</a>
This version may be worth testing



---

archive/issue_comments_538327.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nSame symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:\n\n```\nFileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'\n```\n(That is, `FileNotFoundError: ... old SAGE_ROOT`.)",
    "created_at": "2022-02-17T22:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538327",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:55'>Comment 55:</a>
Same symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:

```
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'
```
(That is, `FileNotFoundError: ... old SAGE_ROOT`.)



---

archive/issue_comments_538328.json:
```json
{
    "body": "<a id='comment:56'>Comment 56:</a>\nDoes this work without this ticket?",
    "created_at": "2022-02-17T23:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538328",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'>Comment 56:</a>
Does this work without this ticket?



---

archive/issue_comments_538329.json:
```json
{
    "body": "<a id='comment:57'>Comment 57:</a>\nDon't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?",
    "created_at": "2022-02-17T23:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538329",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:57'>Comment 57:</a>
Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?



---

archive/issue_comments_538330.json:
```json
{
    "body": "<a id='comment:58'>Comment 58:</a>\nReplying to [@jhpalmieri](#comment%3A57):\n> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?\n\nI can confirm essentially the same problem without this ticket.",
    "created_at": "2022-02-18T00:12:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538330",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:58'>Comment 58:</a>
Replying to [@jhpalmieri](#comment%3A57):
> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?

I can confirm essentially the same problem without this ticket.



---

archive/issue_comments_538331.json:
```json
{
    "body": "<a id='comment:59'>Comment 59:</a>\nThanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371",
    "created_at": "2022-02-18T00:14:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538331",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:59'>Comment 59:</a>
Thanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371



---

archive/issue_comments_538332.json:
```json
{
    "body": "<a id='comment:60'>Comment 60:</a>\nI agree that it's not clear what exactly to test here",
    "created_at": "2022-02-18T00:15:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538332",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'>Comment 60:</a>
I agree that it's not clear what exactly to test here



---

archive/issue_comments_538333.json:
```json
{
    "body": "<a id='comment:61'>Comment 61:</a>\nThe changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.",
    "created_at": "2022-02-19T04:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538333",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:61'>Comment 61:</a>
The changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.



---

archive/issue_comments_538334.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2022-02-19T04:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538334",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_437522.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-02-19T04:08:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437522"
}
```



---

archive/issue_events_437523.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-02-19T04:08:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437523"
}
```



---

archive/issue_comments_538335.json:
```json
{
    "body": "<a id='comment:62'>Comment 62:</a>\nThank you!",
    "created_at": "2022-02-19T05:46:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538335",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'>Comment 62:</a>
Thank you!



---

archive/issue_events_437524.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-21T21:56:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437524"
}
```



---

archive/issue_events_437525.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d08b099239d9dcb2147a4771b77bc54fc6075b1d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-02-21T21:56:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33127#event-437525"
}
```



---

archive/issue_comments_538336.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)** to **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**",
    "created_at": "2022-02-21T21:56:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33127#issuecomment-538336",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage-site](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage-site)** to **[702b779](https://github.com/sagemath/sagetrac-mirror/commit/702b7795295d96f3601a129f0729f4006a55740a)**
