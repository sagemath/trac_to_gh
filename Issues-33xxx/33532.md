# Issue 33532: Doctest failure when SAGE_LIB doesn't match `.../site-packages`

archive/issues_033295.json:
```json
{
    "body": "After #33473, the doctest for the function `sage.env.sage_include_directories()` will fail when `SAGE_LIB` doesn't include `site-packages`.\n\nThis happens in editable installs (`./configure --enable-editable`):\n\n```\n$ ./sage -t src/sage/env.py\nsage -t --random-seed=48380190928639724450052674778554752620 src/sage/env.py\n**********************************************************************\nFile \"src/sage/env.py\", line 359, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nExpected:\n    ['.../site-packages',\n     '.../site-packages/numpy/core/include',\n     '.../include/python...']\nGot:\n    ['/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src',\n     '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include',\n     '/usr/local/opt/python@3.10/Frameworks/Python.framework/Versions/3.10/include/python3.10']\n```\n\nLikewise in the nonstandard configuration of running sagelib without installing, from `pkgs/sagemath-standard/build`:\n\n```\n$ export PATH=$PWD/pkgs/sagemath-standard/build/scripts-3.10:$PATH\n$ export PYTHONPATH=$PWD/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10\n$ sage -t src/sage/env.py \n...\n**********************************************************************\nFile \"src/sage/env.py\", line 359, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nExpected:\n    ['.../site-packages',\n     '.../site-packages/numpy/core/include',\n     '.../include/python...']\nGot:\n    ['/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10',\n     '/usr/lib/python3.10/site-packages/numpy/core/include',\n     '/usr/include/python3.10']\n**********************************************************************\n...\n```\n\nBranch/Commit: 0463009b9f0a5975d9e471546ae3c5931aa6aeff\n\nReviewer: Matthias Koeppe\n\nAuthor: Gonzalo Tornar\u00eda\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33532\n\n",
    "closed_at": "2022-03-21T23:34:49Z",
    "created_at": "2022-03-19T19:44:16Z",
    "labels": [
        "component: doctest framework",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Doctest failure when SAGE_LIB doesn't match `.../site-packages`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33532",
    "user": "https://github.com/tornaria"
}
```
After #33473, the doctest for the function `sage.env.sage_include_directories()` will fail when `SAGE_LIB` doesn't include `site-packages`.

This happens in editable installs (`./configure --enable-editable`):

```
$ ./sage -t src/sage/env.py
sage -t --random-seed=48380190928639724450052674778554752620 src/sage/env.py
**********************************************************************
File "src/sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../site-packages',
     '.../site-packages/numpy/core/include',
     '.../include/python...']
Got:
    ['/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src',
     '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include',
     '/usr/local/opt/python@3.10/Frameworks/Python.framework/Versions/3.10/include/python3.10']
```

Likewise in the nonstandard configuration of running sagelib without installing, from `pkgs/sagemath-standard/build`:

```
$ export PATH=$PWD/pkgs/sagemath-standard/build/scripts-3.10:$PATH
$ export PYTHONPATH=$PWD/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10
$ sage -t src/sage/env.py 
...
**********************************************************************
File "src/sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../site-packages',
     '.../site-packages/numpy/core/include',
     '.../include/python...']
Got:
    ['/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10',
     '/usr/lib/python3.10/site-packages/numpy/core/include',
     '/usr/include/python3.10']
**********************************************************************
...
```

Branch/Commit: 0463009b9f0a5975d9e471546ae3c5931aa6aeff

Reviewer: Matthias Koeppe

Author: Gonzalo Tornar√≠a

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33532





---

archive/issue_comments_473456.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-19T19:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473456",
    "user": "https://github.com/tornaria"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_473457.json:
```json
{
    "body": "<a id='comment:1'></a>I changed the doctest for\n\n```\n        sage: import sage.env\n        sage: sage.env.sage_include_directories()\n        ['...',\n         '.../numpy/core/include',\n         '.../include/python...']\n```\nremoving `site-packages` from both the first and second entry. I'm not sure python always uses `site-packages` so it's better to be safe. What's being tested here is that the numpy include location comes before the python include location. The first entry is the sage lib directory (either SAGE_SRC or SAGE_LIB) so we don't really know anything about it.\n\n---\nNew commits:",
    "created_at": "2022-03-19T19:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473457",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'></a>I changed the doctest for

```
        sage: import sage.env
        sage: sage.env.sage_include_directories()
        ['...',
         '.../numpy/core/include',
         '.../include/python...']
```
removing `site-packages` from both the first and second entry. I'm not sure python always uses `site-packages` so it's better to be safe. What's being tested here is that the numpy include location comes before the python include location. The first entry is the sage lib directory (either SAGE_SRC or SAGE_LIB) so we don't really know anything about it.

---
New commits:



---

archive/issue_comments_473458.json:
```json
{
    "body": "<a id='comment:2'></a>I'm not sure if this should be a supported configuration",
    "created_at": "2022-03-19T19:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473458",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>I'm not sure if this should be a supported configuration



---

archive/issue_comments_473459.json:
```json
{
    "body": "<a id='comment:3'></a>this doctest failure appears in our \"build and test\" box above here and in every ticket",
    "created_at": "2022-03-19T20:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473459",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>this doctest failure appears in our "build and test" box above here and in every ticket



---

archive/issue_comments_473460.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:2 mkoeppe]:\n> I'm not sure if this should be a supported configuration\n\n\nWhy not? It works like a charm. I build sagelib from a git repo, and run from there. No longer do I waste my time with spkgs (everything needed is installed in my system).\n\nThis is also how I build sagemath in void linux so that doctest runs at build time (and also CI on github whenever I push an update).\n\nMaybe I should learn how to run sagelib \"in place\" so that I don't need to rebuild when editing *.py files -- that would be even better. Still the path won't have `site-packages` so the current issue will still happen. For the distro build, using a clean directory for build (and testing the build) seems more robust.\n\nHere's my shell script, in case someone else finds it useful, I call it `sagelib` and place it in the root of the git checkout:\n\n{{{#! /bin/sh\n\nset -e\n\nsage_build() {\n    # bootstrap sagelib\n    ( cd build/pkgs/sagelib && \\\n        PATH=../../bin:$PATH \\\n        ./bootstrap )\n\n    ( cd pkgs/sagemath-standard &&\n        PYTHONPATH=../sage-setup \\\n        SAGE_NUM_THREADS=0 \\\n        python setup.py build )\n\n    SAGE_SCRIPTS=$(cd pkgs/sagemath-standard/build/scripts* && pwd)\n    SAGE_LIB=$(cd pkgs/sagemath-standard/build/lib* && pwd)\n\n    # remove sage-venv-config since it clobbers PATH\n    rm $SAGE_SCRIPTS/sage-venv-config\n\n    # override pytest as if not installed\n    echo \"raise ModuleNotFoundError\" > $SAGE_LIB/pytest.py\n\n    # create sage_conf.py\n    sed '1,/^exit/d' \"$0\" > $SAGE_LIB/sage_conf.py\n}\n\nif [ \"$1\" = \"build\" ]; then\n    sage_build\n    exit\nfi\n\nexport PATH=$(cd pkgs/sagemath-standard/build/scripts* && pwd):$PATH\nexport PYTHONPATH=$(cd pkgs/sagemath-standard/build/lib* && pwd)\n\nsage \"$@\"\n\nexit $?\n# configuration for sage on void linux\nCONWAY_POLYNOMIALS_DATA_DIR = \"/usr/share/sagemath/conway_polynomials\"\nGRAPHS_DATA_DIR = \"/usr/share/sagemath/graphs\"\nELLCURVE_DATA_DIR = \"/usr/share/sagemath/ellcurves\"\nPOLYTOPE_DATA_DIR = \"/usr/share/sagemath/reflexive_polytopes\"\nCOMBINATORIAL_DESIGN_DATA_DIR = \"/usr/share/sagemath/combinatorial_designs\"\nCREMONA_MINI_DATA_DIR = \"/usr/share/sagemath/cremona\"\nCREMONA_LARGE_DATA_DIR = \"/usr/share/sagemath/cremona\"\nGAP_SO = \"libgap.so.0\"\n```\n\nJust run `./sagelib build` to build, and `./sagelib` to run sage. I can successfully run `./sagelib -t --long --all` with this on a clean checkout of `9.6.beta5` except for the current issue and a few more minor doctest failures (mostly deprecation warnings due to newer python packages).\n\nWith a primed ccache and 36 cores building this from scratch takes less time than running `./configure` once.",
    "created_at": "2022-03-19T21:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473460",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:4'></a>Replying to [comment:2 mkoeppe]:
> I'm not sure if this should be a supported configuration


Why not? It works like a charm. I build sagelib from a git repo, and run from there. No longer do I waste my time with spkgs (everything needed is installed in my system).

This is also how I build sagemath in void linux so that doctest runs at build time (and also CI on github whenever I push an update).

Maybe I should learn how to run sagelib "in place" so that I don't need to rebuild when editing *.py files -- that would be even better. Still the path won't have `site-packages` so the current issue will still happen. For the distro build, using a clean directory for build (and testing the build) seems more robust.

Here's my shell script, in case someone else finds it useful, I call it `sagelib` and place it in the root of the git checkout:

{{{#! /bin/sh

set -e

sage_build() {
    # bootstrap sagelib
    ( cd build/pkgs/sagelib && \
        PATH=../../bin:$PATH \
        ./bootstrap )

    ( cd pkgs/sagemath-standard &&
        PYTHONPATH=../sage-setup \
        SAGE_NUM_THREADS=0 \
        python setup.py build )

    SAGE_SCRIPTS=$(cd pkgs/sagemath-standard/build/scripts* && pwd)
    SAGE_LIB=$(cd pkgs/sagemath-standard/build/lib* && pwd)

    # remove sage-venv-config since it clobbers PATH
    rm $SAGE_SCRIPTS/sage-venv-config

    # override pytest as if not installed
    echo "raise ModuleNotFoundError" > $SAGE_LIB/pytest.py

    # create sage_conf.py
    sed '1,/^exit/d' "$0" > $SAGE_LIB/sage_conf.py
}

if [ "$1" = "build" ]; then
    sage_build
    exit
fi

export PATH=$(cd pkgs/sagemath-standard/build/scripts* && pwd):$PATH
export PYTHONPATH=$(cd pkgs/sagemath-standard/build/lib* && pwd)

sage "$@"

exit $?
# configuration for sage on void linux
CONWAY_POLYNOMIALS_DATA_DIR = "/usr/share/sagemath/conway_polynomials"
GRAPHS_DATA_DIR = "/usr/share/sagemath/graphs"
ELLCURVE_DATA_DIR = "/usr/share/sagemath/ellcurves"
POLYTOPE_DATA_DIR = "/usr/share/sagemath/reflexive_polytopes"
COMBINATORIAL_DESIGN_DATA_DIR = "/usr/share/sagemath/combinatorial_designs"
CREMONA_MINI_DATA_DIR = "/usr/share/sagemath/cremona"
CREMONA_LARGE_DATA_DIR = "/usr/share/sagemath/cremona"
GAP_SO = "libgap.so.0"
```

Just run `./sagelib build` to build, and `./sagelib` to run sage. I can successfully run `./sagelib -t --long --all` with this on a clean checkout of `9.6.beta5` except for the current issue and a few more minor doctest failures (mostly deprecation warnings due to newer python packages).

With a primed ccache and 36 cores building this from scratch takes less time than running `./configure` once.



---

archive/issue_comments_473461.json:
```json
{
    "body": "<a id='comment:5'></a>Your static configuration of these variables (\"configuration for sage on void linux \") is exactly what I had in mind when I recommended that downstream packagers provide their own version of `sage_conf.py`, \nwhich would make these settings persistent instead of relying on a script that sets environment variables.\n\nSee also #33295 (Refactor `sage_conf`)",
    "created_at": "2022-03-19T21:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473461",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Your static configuration of these variables ("configuration for sage on void linux ") is exactly what I had in mind when I recommended that downstream packagers provide their own version of `sage_conf.py`, 
which would make these settings persistent instead of relying on a script that sets environment variables.

See also #33295 (Refactor `sage_conf`)



---

archive/issue_comments_473462.json:
```json
{
    "body": "<a id='comment:8'></a>This failure also happens in editable installs. Thanks for catching this (we don't test this automatically yet - #31413)",
    "created_at": "2022-03-19T22:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473462",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>This failure also happens in editable installs. Thanks for catching this (we don't test this automatically yet - #31413)



---

archive/issue_comments_473463.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-19T22:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473463",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473464.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:5 mkoeppe]:\n> Your static configuration of these variables (\"configuration for sage on void linux \") is exactly what I had in mind when I recommended that downstream packagers provide their own version of `sage_conf.py`, \n> which would make these settings persistent instead of relying on a script that sets environment variables.\n\n\nBefore today I was appending all of that to `sage/env.py`, and you already recommended to me that I should provide a `sage_conf` package, and that's also what `pkgs/sage-conf/README.rst` kind of suggest. But I completely misunderstood you: I thought it was a chore to have to build a separate package `sage_conf` using what's in `pkgs/sage-conf`. It wasn't until today that I realized it was a simple matter of writing all that stuff to `sage_conf.py`!!! If that's what you meant, it may be a good idea to give it as a suggestion/example.\n\nThanks for the quick review.",
    "created_at": "2022-03-19T23:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473464",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:10'></a>Replying to [comment:5 mkoeppe]:
> Your static configuration of these variables ("configuration for sage on void linux ") is exactly what I had in mind when I recommended that downstream packagers provide their own version of `sage_conf.py`, 
> which would make these settings persistent instead of relying on a script that sets environment variables.


Before today I was appending all of that to `sage/env.py`, and you already recommended to me that I should provide a `sage_conf` package, and that's also what `pkgs/sage-conf/README.rst` kind of suggest. But I completely misunderstood you: I thought it was a chore to have to build a separate package `sage_conf` using what's in `pkgs/sage-conf`. It wasn't until today that I realized it was a simple matter of writing all that stuff to `sage_conf.py`!!! If that's what you meant, it may be a good idea to give it as a suggestion/example.

Thanks for the quick review.



---

archive/issue_comments_473465.json:
```json
{
    "body": "<a id='comment:11'></a>Yes, and with #33295 it will become even simpler",
    "created_at": "2022-03-19T23:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473465",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Yes, and with #33295 it will become even simpler



---

archive/issue_comments_473466.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-21T23:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33532#issuecomment-473466",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088282.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-21T23:34:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33532",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33532#event-88282"
}
```
