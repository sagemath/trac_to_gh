# Issue 33640: sage fails to factor some easy expressions

archive/issues_033403.json:
```json
{
    "body": "As reported on [sage-devel](https://groups.google.com/g/sage-devel/c/Ca661TP_3Ug/m/f2lZtUXLAwAJ), sage fails to factor expressions that expand to something very easy, such as `x^2` or `0`. Instead, it returns the original expression.\n\n```\nsage: ((x + 1)^2 - 2*x - 1).factor()  # bad (should be x^2)\n(x + 1)^2 - 2*x - 1\nsage: ((x + 1)^2 - x^2 - 2*x - 1).factor()  # bad (should be 0)\n(x + 1)^2 - x^2 - 2*x - 1\nsage: ((x + 2)^2 - 2*x - 3).factor()  # good\n(x + 1)^2\n```\n\n**Keywords:** factor, polynomial\n\n**Branch/Commit:** [b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)\n\n**Reviewer:** David Lowry-Duda\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\nIssue created by migration from https://trac.sagemath.org/ticket/33640\n\n",
    "closed_at": "2022-09-20T20:23:05Z",
    "created_at": "2022-04-03T21:37:20Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage fails to factor some easy expressions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33640",
    "user": "https://github.com/DaveWitteMorris"
}
```
As reported on [sage-devel](https://groups.google.com/g/sage-devel/c/Ca661TP_3Ug/m/f2lZtUXLAwAJ), sage fails to factor expressions that expand to something very easy, such as `x^2` or `0`. Instead, it returns the original expression.

```
sage: ((x + 1)^2 - 2*x - 1).factor()  # bad (should be x^2)
(x + 1)^2 - 2*x - 1
sage: ((x + 1)^2 - x^2 - 2*x - 1).factor()  # bad (should be 0)
(x + 1)^2 - x^2 - 2*x - 1
sage: ((x + 2)^2 - 2*x - 3).factor()  # good
(x + 1)^2
```

**Keywords:** factor, polynomial

**Branch/Commit:** [b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)

**Reviewer:** David Lowry-Duda

**Author:** Frédéric Chapoton

Issue created by migration from https://trac.sagemath.org/ticket/33640





---

archive/issue_comments_640181.json:
```json
{
    "body": "<a id='comment:1'></a>\nHere is a tentative diagnosis from a quick look at the code. It seems that sagemath expands the expression into a polynomial (a linear combination of powers of `x`) before trying to factor it.  If the expansion has only a single term (a constant times a power of `x`), then nothing needs to be done, since this expansion is already factored. Sagemath erroneously thinks nothing needed to be done from the beginning, and returns the original expression, instead of the expanded expression.",
    "created_at": "2022-04-03T21:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640181",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>
Here is a tentative diagnosis from a quick look at the code. It seems that sagemath expands the expression into a polynomial (a linear combination of powers of `x`) before trying to factor it.  If the expansion has only a single term (a constant times a power of `x`), then nothing needs to be done, since this expansion is already factored. Sagemath erroneously thinks nothing needed to be done from the beginning, and returns the original expression, instead of the expanded expression.



---

archive/issue_comments_640182.json:
```json
{
    "body": "<a id='comment:2'></a>\nMaybe a silly question, but I notice that `symbolic.expression.Expression.factor()` says \"If you are factoring a polynomial with rational coefficients (and dontfactor is empty) the factorization is done using Singular\ninstead of Maxima, so the following is very fast instead of dreadfully slow\".\nI'm just wondering, if it concerns a polynomial, why not using `Polynomial` instead?\n\n```\nsage: P\nMultivariate Polynomial Ring in x, y, z over Rational Field\nsage: p\n0\nsage: p = (x-y)^2*(y-z)*(z-x) + (y-z)^2*(z-x)*(x-y) + (z-x)^2*(x-y)*(y-z)\nsage: P.<x,y,z>=QQ[]\nsage: p = (x-y)^2*(y-z)*(z-x) + (y-z)^2*(z-x)*(x-y) + (z-x)^2*(x-y)*(y-z)\nsage: p\n0\nsage: q = (x + 1)^2 - 2*x - 1\nsage: q\nx^2\nsage: r = (x + 1)^2 - x^2 - 2*x - 1\nsage: r\n0\nsage: s = (x + 2)^2 - 2*x - 3\nsage: s\nx^2 + 2*x + 1\nsage: s.factor()\n(x + 1)^2\n```",
    "created_at": "2022-04-06T01:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640182",
    "user": "https://github.com/yuan-zhou"
}
```

<a id='comment:2'></a>
Maybe a silly question, but I notice that `symbolic.expression.Expression.factor()` says "If you are factoring a polynomial with rational coefficients (and dontfactor is empty) the factorization is done using Singular
instead of Maxima, so the following is very fast instead of dreadfully slow".
I'm just wondering, if it concerns a polynomial, why not using `Polynomial` instead?

```
sage: P
Multivariate Polynomial Ring in x, y, z over Rational Field
sage: p
0
sage: p = (x-y)^2*(y-z)*(z-x) + (y-z)^2*(z-x)*(x-y) + (z-x)^2*(x-y)*(y-z)
sage: P.<x,y,z>=QQ[]
sage: p = (x-y)^2*(y-z)*(z-x) + (y-z)^2*(z-x)*(x-y) + (z-x)^2*(x-y)*(y-z)
sage: p
0
sage: q = (x + 1)^2 - 2*x - 1
sage: q
x^2
sage: r = (x + 1)^2 - x^2 - 2*x - 1
sage: r
0
sage: s = (x + 2)^2 - 2*x - 3
sage: s
x^2 + 2*x + 1
sage: s.factor()
(x + 1)^2
```



---

archive/issue_comments_640183.json:
```json
{
    "body": "<a id='comment:3'></a>\n[message deleted]",
    "created_at": "2022-04-06T01:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640183",
    "user": "https://github.com/yuan-zhou"
}
```

<a id='comment:3'></a>
[message deleted]



---

archive/issue_comments_640184.json:
```json
{
    "body": "<a id='comment:4'></a>\nSee also #32613",
    "created_at": "2022-04-06T01:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640184",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
See also #32613



---

archive/issue_comments_640185.json:
```json
{
    "body": "**Branch:** [public/ticket/33640](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/33640)",
    "created_at": "2022-06-20T14:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640185",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [public/ticket/33640](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/33640)



---

archive/issue_comments_640186.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2022-06-20T14:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640186",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_640187.json:
```json
{
    "body": "<a id='comment:5'></a>\nlet us see if this little change breaks nothing\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852\">80b2e68</a></td><td><code>factorisation of symbolic polynomials</code></td></tr></table>\n",
    "created_at": "2022-06-20T14:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640187",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
let us see if this little change breaks nothing

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852">80b2e68</a></td><td><code>factorisation of symbolic polynomials</code></td></tr></table>




---

archive/issue_comments_640188.json:
```json
{
    "body": "**Commit:** [80b2e688c5a6cad698fc50ea02355bda77e7c852](https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852)",
    "created_at": "2022-06-20T14:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640188",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [80b2e688c5a6cad698fc50ea02355bda77e7c852](https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852)



---

archive/issue_comments_640189.json:
```json
{
    "body": "**Changing commit** from \"[80b2e688c5a6cad698fc50ea02355bda77e7c852](https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852)\" to \"[b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)\".",
    "created_at": "2022-06-22T08:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[80b2e688c5a6cad698fc50ea02355bda77e7c852](https://github.com/sagemath/sagetrac-mirror/commit/80b2e688c5a6cad698fc50ea02355bda77e7c852)" to "[b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)".



---

archive/issue_comments_640190.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51\">b41c93f</a></td><td><code>adding doctest for 33640</code></td></tr></table>\n",
    "created_at": "2022-06-22T08:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51">b41c93f</a></td><td><code>adding doctest for 33640</code></td></tr></table>




---

archive/issue_comments_640191.json:
```json
{
    "body": "<a id='comment:7'></a>\napparently, this works. I have added a doctest. It may have consequences on the speed, altough this is not clear.",
    "created_at": "2022-06-22T08:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640191",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
apparently, this works. I have added a doctest. It may have consequences on the speed, altough this is not clear.



---

archive/issue_comments_640192.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis works. I spent a while trying to determine if there was a good reason the function to return false if ginac determines that the numerator and denominator are \"trivial\" (as was morally done before), but I really can't find one.\n\nI note that the boolean result of the changed function is also used in gamma_normalization, but this change seems to work well with that too.",
    "created_at": "2022-07-21T18:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640192",
    "user": "https://github.com/davidlowryduda"
}
```

<a id='comment:8'></a>
This works. I spent a while trying to determine if there was a good reason the function to return false if ginac determines that the numerator and denominator are "trivial" (as was morally done before), but I really can't find one.

I note that the boolean result of the changed function is also used in gamma_normalization, but this change seems to work well with that too.



---

archive/issue_comments_640193.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-07-21T18:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640193",
    "user": "https://github.com/davidlowryduda"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_640194.json:
```json
{
    "body": "**Reviewer:** David Lowry-Duda",
    "created_at": "2022-07-21T18:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640194",
    "user": "https://github.com/davidlowryduda"
}
```

**Reviewer:** David Lowry-Duda



---

archive/issue_comments_640195.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think the point of checking the boolean value is that if a polynomial is irreducible, then it should be returned unchanged, instead of expanded. However, this doesn't seem to work:\n\n```\nsage: ((x + 1)^100 + 2).factor()\nx^100 + 100*x^99 + 4950*x^98 + 161700*x^97 + 3921225*x^96 + <lots more terms>\n```\nIt would be better to return `(x + 1)^100 + 2`. If the user wants to expand this expression, they can apply `expand`.",
    "created_at": "2022-07-21T18:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640195",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:9'></a>
I think the point of checking the boolean value is that if a polynomial is irreducible, then it should be returned unchanged, instead of expanded. However, this doesn't seem to work:

```
sage: ((x + 1)^100 + 2).factor()
x^100 + 100*x^99 + 4950*x^98 + 161700*x^97 + 3921225*x^96 + <lots more terms>
```
It would be better to return `(x + 1)^100 + 2`. If the user wants to expand this expression, they can apply `expand`.



---

archive/issue_comments_640196.json:
```json
{
    "body": "<a id='comment:10'></a>\nauthor name",
    "created_at": "2022-07-21T19:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640196",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
author name



---

archive/issue_comments_640197.json:
```json
{
    "body": "<a id='comment:11'></a>\nMerge failure on top of:\n\n381771d188 Trac #33636: replace loadable_module_extension() by importlib.machinery.EXTENSION_SUFFIXES\n\n4c0f8481d2 Trac #33002: Method tikz of polyhedron class can now return an object of type TikzPicture\n\nc744d7c09c Trac #29097: build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall\n\n8312ee1e90 Trac #33530: Upgrade ipython to 8.x\n\n067a66c7e9 Trac #33428: prompt_toolkit 3.0.25+ breaks Ctrl-C\n\n79ed9e5ddb Trac #33160: update Singular to 4.3.1\n\n4cc4817aeb Trac #32088: gfan testsuite hangs on 32bit\n\n10247d5f2a Trac #31049: \"setup.py develop\" rewrites the installed sage-version.sh as if it is a Python script\n\n7f7149489c Updated [SageMath](SageMath) version to 9.7.beta6\n\n\n\nauthor '' does not look right",
    "created_at": "2022-07-24T22:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640197",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
Merge failure on top of:

381771d188 Trac #33636: replace loadable_module_extension() by importlib.machinery.EXTENSION_SUFFIXES

4c0f8481d2 Trac #33002: Method tikz of polyhedron class can now return an object of type TikzPicture

c744d7c09c Trac #29097: build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall

8312ee1e90 Trac #33530: Upgrade ipython to 8.x

067a66c7e9 Trac #33428: prompt_toolkit 3.0.25+ breaks Ctrl-C

79ed9e5ddb Trac #33160: update Singular to 4.3.1

4cc4817aeb Trac #32088: gfan testsuite hangs on 32bit

10247d5f2a Trac #31049: "setup.py develop" rewrites the installed sage-version.sh as if it is a Python script

7f7149489c Updated [SageMath](SageMath) version to 9.7.beta6



author '' does not look right



---

archive/issue_comments_640198.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2022-07-24T22:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640198",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_640199.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2022-08-08T12:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640199",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_640200.json:
```json
{
    "body": "**Author:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2022-08-08T12:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640200",
    "user": "https://github.com/fchapoton"
}
```

**Author:** Frédéric Chapoton



---

archive/issue_comments_640201.json:
```json
{
    "body": "<a id='comment:13'></a>\nso, please give us again a positive review !",
    "created_at": "2022-09-01T06:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640201",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>
so, please give us again a positive review !



---

archive/issue_comments_640202.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-09-02T16:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640202",
    "user": "https://github.com/davidlowryduda"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_640203.json:
```json
{
    "body": "<a id='comment:14'></a>\nI'm marking this as positive again. I don't know about the merge failure Volker mentioned, but if I recall correctly that is a separate issue. If I'm wrong, please let me know.",
    "created_at": "2022-09-02T16:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640203",
    "user": "https://github.com/davidlowryduda"
}
```

<a id='comment:14'></a>
I'm marking this as positive again. I don't know about the merge failure Volker mentioned, but if I recall correctly that is a separate issue. If I'm wrong, please let me know.



---

archive/issue_events_099918.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-09-16T12:08:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33640#event-99918"
}
```



---

archive/issue_comments_640204.json:
```json
{
    "body": "**Changing branch** from \"[public/ticket/33640](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/33640)\" to \"[b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)\".",
    "created_at": "2022-09-20T20:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33640#issuecomment-640204",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/ticket/33640](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/33640)" to "[b41c93f6e7d42c69684bcbaad3cbc0e822f76e51](https://github.com/sagemath/sagetrac-mirror/commit/b41c93f6e7d42c69684bcbaad3cbc0e822f76e51)".



---

archive/issue_events_099919.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-09-20T20:23:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33640",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33640#event-99919"
}
```
