# Issue 33027: zombie maxima process -  if invoked from a script

archive/issues_032790.json:
```json
{
    "body": "invoking `maxima` in a Sage script leads to a zombie process. E.g.\nrun the following in terminal\n\n```\necho \"t=maxima('2+2')\" > /tmp/foo.sage && ./sage /tmp/foo.sage\n```\nand observe zombie `maxima` process after this terminates.\nDon't forget to \n\n```\nkillall maxima\n```\nnow and then.\n\n\nA slightly shorter\n\n```\necho \"t=maxima('2+2')\" | ./sage\n```\ndoes not lead to a zombie - in fact, it prints on exit:\n\n```\nsage: sage: Exiting Sage (CPU time 0m0.08s, Wall time 0m0.67s).\nExiting Maxima with PID 2318 running <SAGEROOT>/local/bin/maxima -p <SAGEROOT>/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp\n```\n\nThis was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.\n\nUsing `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.\n\n---\n\nApparently, this only happens with ecl installed in Sage rather than with system-wide ecl.\n\n\n\n**CC:**  @nbruin @vbraun @mkoeppe @spaghettisalat\n\n**Branch/Commit:** [abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)\n\n**Reviewer:** Michael Orlitzky\n\n**Author:** Dima Pasechnik\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33027\n\n",
    "closed_at": "2022-02-13T10:17:53Z",
    "created_at": "2021-12-15T13:52:36Z",
    "labels": [
        "component: interfaces",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "zombie maxima process -  if invoked from a script",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33027",
    "user": "https://github.com/dimpase"
}
```
invoking `maxima` in a Sage script leads to a zombie process. E.g.
run the following in terminal

```
echo "t=maxima('2+2')" > /tmp/foo.sage && ./sage /tmp/foo.sage
```
and observe zombie `maxima` process after this terminates.
Don't forget to 

```
killall maxima
```
now and then.


A slightly shorter

```
echo "t=maxima('2+2')" | ./sage
```
does not lead to a zombie - in fact, it prints on exit:

```
sage: sage: Exiting Sage (CPU time 0m0.08s, Wall time 0m0.67s).
Exiting Maxima with PID 2318 running <SAGEROOT>/local/bin/maxima -p <SAGEROOT>/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp
```

This was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.

Using `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.

---

Apparently, this only happens with ecl installed in Sage rather than with system-wide ecl.



**CC:**  @nbruin @vbraun @mkoeppe @spaghettisalat

**Branch/Commit:** [abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)

**Reviewer:** Michael Orlitzky

**Author:** Dima Pasechnik

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/33027





---

archive/issue_comments_658482.json:
```json
{
    "body": "<a id='comment:1'></a>\nMoving this to critical, as it seems to efficiently kill the patchbots.",
    "created_at": "2021-12-15T15:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658482",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>
Moving this to critical, as it seems to efficiently kill the patchbots.



---

archive/issue_comments_658483.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis might be related to #32167.",
    "created_at": "2022-01-21T10:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658483",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:3'></a>
This might be related to #32167.



---

archive/issue_comments_658484.json:
```json
{
    "body": "<a id='comment:4'></a>\nI think it was observed without fricas installed, too.",
    "created_at": "2022-01-21T10:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658484",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
I think it was observed without fricas installed, too.



---

archive/issue_comments_658485.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,6 +5,13 @@\n echo \"t=maxima('2+2')\" > /tmp/foo.sage && ./sage /tmp/foo.sage\n ```\n and observe zombie `maxima` process after this terminates.\n+Don't forget to \n+\n+```\n+killall maxima\n+```\n+now and then.\n+\n \n A slightly shorter\n \n``````\n",
    "created_at": "2022-01-21T10:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658485",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,6 +5,13 @@
 echo "t=maxima('2+2')" > /tmp/foo.sage && ./sage /tmp/foo.sage
 ```
 and observe zombie `maxima` process after this terminates.
+Don't forget to 
+
+```
+killall maxima
+```
+now and then.
+
 
 A slightly shorter
 
``````




---

archive/issue_comments_658486.json:
```json
{
    "body": "<a id='comment:6'></a>\nI've noticed that one gets\n`.sage/maxima/binary/5_45_0/ecl/21_2_1/` created in DOTSAGE. (no matter with the reproducer, or the non-reproducer `echo \"t=maxima('2+2')\" | ./sage`",
    "created_at": "2022-01-21T11:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658486",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
I've noticed that one gets
`.sage/maxima/binary/5_45_0/ecl/21_2_1/` created in DOTSAGE. (no matter with the reproducer, or the non-reproducer `echo "t=maxima('2+2')" | ./sage`



---

archive/issue_comments_658487.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -27,3 +27,5 @@\n \n This was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.\n \n+Using `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.\n+\n``````\n",
    "created_at": "2022-01-21T11:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658487",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -27,3 +27,5 @@
 
 This was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.
 
+Using `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.
+
``````




---

archive/issue_comments_658488.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis effectively kills the patchbots, thus a blocker, IMHO.\nhttps://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com",
    "created_at": "2022-01-21T11:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658488",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
This effectively kills the patchbots, thus a blocker, IMHO.
https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com



---

archive/issue_events_098172.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33027#event-98172"
}
```



---

archive/issue_comments_658489.json:
```json
{
    "body": "<a id='comment:8'></a>\nwhat I meant to say is that it might be a similar underlying problem.",
    "created_at": "2022-01-21T11:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658489",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'></a>
what I meant to say is that it might be a similar underlying problem.



---

archive/issue_comments_658490.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [dimpase](#comment%3A7):\n> This effectively kills the patchbots, thus a blocker, IMHO.\n> https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com\n\n\nApparently a ticket introduced in 9.5beta8 https://groups.google.com/g/sage-release/c/vo_m79EHAVc/m/mMlNPz5sBAAJ introduced this problem. My patchbot worked fine until then and I got contacted by the IT on December 13th (it is a virtual machine and I'm guessing this also affected other people).",
    "created_at": "2022-01-21T11:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658490",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>
Replying to [dimpase](#comment%3A7):
> This effectively kills the patchbots, thus a blocker, IMHO.
> https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com


Apparently a ticket introduced in 9.5beta8 https://groups.google.com/g/sage-release/c/vo_m79EHAVc/m/mMlNPz5sBAAJ introduced this problem. My patchbot worked fine until then and I got contacted by the IT on December 13th (it is a virtual machine and I'm guessing this also affected other people).



---

archive/issue_comments_658491.json:
```json
{
    "body": "<a id='comment:10'></a>\n1. Never execute code from a predictable filename under `/tmp` =)\n2. FWIW, I can't reproduce this on rc2.",
    "created_at": "2022-01-21T12:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658491",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:10'></a>
1. Never execute code from a predictable filename under `/tmp` =)
2. FWIW, I can't reproduce this on rc2.



---

archive/issue_comments_658492.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [mjo](#comment%3A10):\n> 1. Never execute code from a predictable filename under `/tmp` =)\n> 2. FWIW, I can't reproduce this on rc2.\n\n\nPerhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.",
    "created_at": "2022-01-21T13:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658492",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
Replying to [mjo](#comment%3A10):
> 1. Never execute code from a predictable filename under `/tmp` =)
> 2. FWIW, I can't reproduce this on rc2.


Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.



---

archive/issue_comments_658493.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [dimpase](#comment%3A11):\n> Replying to [mjo](#comment%3A10):\n> > 1. Never execute code from a predictable filename under `/tmp` =)\n> > 2. FWIW, I can't reproduce this on rc2.\n  \n> \n> Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.\n\n\nNo, my config.log states, `already installed as an SPKG`.",
    "created_at": "2022-01-21T14:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658493",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'></a>
Replying to [dimpase](#comment%3A11):
> Replying to [mjo](#comment%3A10):
> > 1. Never execute code from a predictable filename under `/tmp` =)
> > 2. FWIW, I can't reproduce this on rc2.
  
> 
> Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.


No, my config.log states, `already installed as an SPKG`.



---

archive/attachments_021572.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "config.log",
    "asset_url": "tarball://root/attachments/some-uuid/ticket33027/config.log",
    "created_at": "2022-01-21T14:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.log",
    "user": "https://github.com/kliem"
}
```



---

archive/issue_comments_658494.json:
```json
{
    "body": "A config.log of some debian buster with this problem",
    "created_at": "2022-01-21T14:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658494",
    "user": "https://github.com/kliem"
}
```

A config.log of some debian buster with this problem



---

archive/issue_comments_658495.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [gh-kliem](#comment%3A12):\n> Replying to [dimpase](#comment%3A11):\n> > Replying to [mjo](#comment%3A10):\n> > > 1. Never execute code from a predictable filename under `/tmp` =)\n> > > 2. FWIW, I can't reproduce this on rc2.\n  \n> > \n> > Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.\n\n> \n> No, my config.log states, `already installed as an SPKG`.\n\n\nI meant that a system ecl is the reason that Michael cannot reproduce this.",
    "created_at": "2022-01-21T14:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658495",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>
Replying to [gh-kliem](#comment%3A12):
> Replying to [dimpase](#comment%3A11):
> > Replying to [mjo](#comment%3A10):
> > > 1. Never execute code from a predictable filename under `/tmp` =)
> > > 2. FWIW, I can't reproduce this on rc2.
  
> > 
> > Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.

> 
> No, my config.log states, `already installed as an SPKG`.


I meant that a system ecl is the reason that Michael cannot reproduce this.



---

archive/issue_comments_658496.json:
```json
{
    "body": "<a id='comment:14'></a>\nAh yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.",
    "created_at": "2022-01-21T14:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658496",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>
Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.



---

archive/issue_comments_658497.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [gh-kliem](#comment%3A14):\n> Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n\n\nYes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.",
    "created_at": "2022-01-21T17:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658497",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>
Replying to [gh-kliem](#comment%3A14):
> Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.


Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.



---

archive/issue_comments_658498.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -29,3 +29,8 @@\n \n Using `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.\n \n+---\n+\n+Apparently, this only happens with ecl installed in Sage rather than with system-wide ecl.\n+\n+\n``````\n",
    "created_at": "2022-01-21T17:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658498",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -29,3 +29,8 @@
 
 Using `maxima_calculus()` (the library interface) rather than `maxima()` (pexpect interface) does not lead to zombies.
 
+---
+
+Apparently, this only happens with ecl installed in Sage rather than with system-wide ecl.
+
+
``````




---

archive/issue_comments_658499.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [dimpase](#comment%3A15):\n> Replying to [gh-kliem](#comment%3A14):\n> > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n\n> \n> Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.\n\n\nMaybe delete that `write_error.patch` that the SPKG applies, and try again?",
    "created_at": "2022-01-21T18:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658499",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:18'></a>
Replying to [dimpase](#comment%3A15):
> Replying to [gh-kliem](#comment%3A14):
> > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.

> 
> Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.


Maybe delete that `write_error.patch` that the SPKG applies, and try again?



---

archive/issue_comments_658500.json:
```json
{
    "body": "<a id='comment:19'></a>\nThe other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.",
    "created_at": "2022-01-21T18:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658500",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:19'></a>
The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.



---

archive/issue_comments_658501.json:
```json
{
    "body": "<a id='comment:20'></a>\nCould you check whether using spkg ecl / system ecl also makes the difference for #32167?",
    "created_at": "2022-01-21T18:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658501",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:20'></a>
Could you check whether using spkg ecl / system ecl also makes the difference for #32167?



---

archive/issue_comments_658502.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [mjo](#comment%3A18):\n> Replying to [dimpase](#comment%3A15):\n> > Replying to [gh-kliem](#comment%3A14):\n> > > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n\n> > \n> > Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.\n\n> \n> Maybe delete that `write_error.patch` that the SPKG applies, and try again?\n\npatch or no patch, the same picture.",
    "created_at": "2022-01-21T18:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658502",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
Replying to [mjo](#comment%3A18):
> Replying to [dimpase](#comment%3A15):
> > Replying to [gh-kliem](#comment%3A14):
> > > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.

> > 
> > Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.

> 
> Maybe delete that `write_error.patch` that the SPKG applies, and try again?

patch or no patch, the same picture.



---

archive/issue_comments_658503.json:
```json
{
    "body": "<a id='comment:22'></a>\naccoring to[comment:9](#comment%3A9), something happened in 9.5.beta8, which caused this. Time for `git bisect` I suppose...",
    "created_at": "2022-01-21T18:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658503",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
accoring to[comment:9](#comment%3A9), something happened in 9.5.beta8, which caused this. Time for `git bisect` I suppose...



---

archive/issue_comments_658504.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [mjo](#comment%3A19):\n> The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.\n\n\nThis was the correct guess.\nIf I remove `--disable-threads` then no zombies pop up.\n\nCan this also be done on macOS?",
    "created_at": "2022-01-21T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658504",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
Replying to [mjo](#comment%3A19):
> The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.


This was the correct guess.
If I remove `--disable-threads` then no zombies pop up.

Can this also be done on macOS?



---

archive/issue_comments_658505.json:
```json
{
    "body": "<a id='comment:24'></a>\nposting a branch in a moment",
    "created_at": "2022-01-21T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658505",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
posting a branch in a moment



---

archive/issue_comments_658506.json:
```json
{
    "body": "**Author:** Dima Pasechnik",
    "created_at": "2022-01-21T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658506",
    "user": "https://github.com/dimpase"
}
```

**Author:** Dima Pasechnik



---

archive/issue_comments_658507.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2022-01-21T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658507",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_658508.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2022-01-21T21:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658508",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_658509.json:
```json
{
    "body": "**Commit:** [abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658509",
    "user": "https://github.com/dimpase"
}
```

**Commit:** [abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)



---

archive/issue_comments_658510.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658510",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_658511.json:
```json
{
    "body": "**Branch:** [u/dimpase/packages/ecl/nozombies](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/ecl/nozombies)",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658511",
    "user": "https://github.com/dimpase"
}
```

**Branch:** [u/dimpase/packages/ecl/nozombies](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/ecl/nozombies)



---

archive/issue_comments_658512.json:
```json
{
    "body": "<a id='comment:26'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882\">abafddc</a></td><td><code>disable-threads led to zombies</code></td></tr></table>\n",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658512",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882">abafddc</a></td><td><code>disable-threads led to zombies</code></td></tr></table>




---

archive/issue_comments_658513.json:
```json
{
    "body": "<a id='comment:27'></a>\nOn OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.",
    "created_at": "2022-01-22T02:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658513",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.



---

archive/issue_comments_658514.json:
```json
{
    "body": "<a id='comment:28'></a>\nIs there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.",
    "created_at": "2022-01-22T02:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658514",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>
Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.



---

archive/issue_comments_658515.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [jhpalmieri](#comment%3A27):\n> On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.\n\n\nmacOS is sufficiently different from Linux, I'm not surprised. I noticed that Homebrew builds ecl with threads enabled, so the change proposed here should be fine on macOS too.\n\nNot sure about cygwin though.",
    "created_at": "2022-01-22T11:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658515",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
Replying to [jhpalmieri](#comment%3A27):
> On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.


macOS is sufficiently different from Linux, I'm not surprised. I noticed that Homebrew builds ecl with threads enabled, so the change proposed here should be fine on macOS too.

Not sure about cygwin though.



---

archive/issue_comments_658516.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [jhpalmieri](#comment%3A28):\n> Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.\n\n\nI even tried reverting it, to no avail.\nPerhaps the behaviour was always there, it's just a test introduced in beta8 that led to these zombie processes?",
    "created_at": "2022-01-22T11:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658516",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>
Replying to [jhpalmieri](#comment%3A28):
> Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.


I even tried reverting it, to no avail.
Perhaps the behaviour was always there, it's just a test introduced in beta8 that led to these zombie processes?



---

archive/issue_comments_658517.json:
```json
{
    "body": "<a id='comment:31'></a>\nI am fairly certain that this is a race condition and enabling threads will not help in general.\n\nAttaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on. The following script\n\n```\nimport atexit\natexit.register(lambda : maxima.quit())\nt=maxima('2+2')\n```\n\nworks fine and leaves no maxima zombies.\n\nI don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.",
    "created_at": "2022-01-22T14:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658517",
    "user": "https://github.com/spaghettisalat"
}
```

<a id='comment:31'></a>
I am fairly certain that this is a race condition and enabling threads will not help in general.

Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on. The following script

```
import atexit
atexit.register(lambda : maxima.quit())
t=maxima('2+2')
```

works fine and leaves no maxima zombies.

I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.



---

archive/issue_comments_658518.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [gh-spaghettisalat](#comment%3A31):\n> I am fairly certain that this is a race condition and enabling threads will not help in general.\n> \n> Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on.\n\n\nSounds related to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634?\n\nThe fact that it works with threads enabled could be due to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/129. If that's the case then indeed we shouldn't rely on it.\n\nThe following script\n> \n> ```\n> import atexit\n> atexit.register(lambda : maxima.quit())\n> t=maxima('2+2')\n> ```\n> \n> works fine and leaves no maxima zombies.\n> \n> I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.\n\n\nThe pexpect interface has been deprecated forever, so it's not unlikely. And I don't think adding a `quit()` hook could hurt in any case.",
    "created_at": "2022-01-22T15:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658518",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:32'></a>
Replying to [gh-spaghettisalat](#comment%3A31):
> I am fairly certain that this is a race condition and enabling threads will not help in general.
> 
> Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on.


Sounds related to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634?

The fact that it works with threads enabled could be due to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/129. If that's the case then indeed we shouldn't rely on it.

The following script
> 
> ```
> import atexit
> atexit.register(lambda : maxima.quit())
> t=maxima('2+2')
> ```
> 
> works fine and leaves no maxima zombies.
> 
> I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.


The pexpect interface has been deprecated forever, so it's not unlikely. And I don't think adding a `quit()` hook could hurt in any case.



---

archive/issue_comments_658519.json:
```json
{
    "body": "<a id='comment:33'></a>\nThe patchbots will use the develop branch so there is little to be gained and a lot to potentially screw up by pushing the proposed patch into 9.5",
    "created_at": "2022-01-22T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658519",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>
The patchbots will use the develop branch so there is little to be gained and a lot to potentially screw up by pushing the proposed patch into 9.5



---

archive/issue_events_098173.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33027#event-98173"
}
```



---

archive/issue_comments_658520.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [mjo](#comment%3A32):\n> The pexpect interface has been deprecated forever\n\n\nNo, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.",
    "created_at": "2022-01-22T17:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658520",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
Replying to [mjo](#comment%3A32):
> The pexpect interface has been deprecated forever


No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.



---

archive/issue_comments_658521.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [mkoeppe](#comment%3A34):\n> Replying to [mjo](#comment%3A32):\n> > The pexpect interface has been deprecated forever\n\n> \n> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.\n\n\nI agree that the pexpect interface is not deprecated, but I don't think it's the only interface that's meant to be user-facing. In fact, I expect (no pun intended) that most uses for maxima in sage *are* through the internal one, because the integration with symbolics makes it easier to get the things in/out. For instance `SR(x)._maxima_()` gets you an object through the `maxima_lib` interface.\n\nThe pexpect interface is convenient if you want multiple sessions (managed through different processes) and if you want \"vanilla\" maxima: the maxima_lib one has some tweaks and configurations motivated by its use for SR.",
    "created_at": "2022-01-22T18:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658521",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:35'></a>
Replying to [mkoeppe](#comment%3A34):
> Replying to [mjo](#comment%3A32):
> > The pexpect interface has been deprecated forever

> 
> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.


I agree that the pexpect interface is not deprecated, but I don't think it's the only interface that's meant to be user-facing. In fact, I expect (no pun intended) that most uses for maxima in sage *are* through the internal one, because the integration with symbolics makes it easier to get the things in/out. For instance `SR(x)._maxima_()` gets you an object through the `maxima_lib` interface.

The pexpect interface is convenient if you want multiple sessions (managed through different processes) and if you want "vanilla" maxima: the maxima_lib one has some tweaks and configurations motivated by its use for SR.



---

archive/issue_comments_658522.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [mkoeppe](#comment%3A34):\n> Replying to [mjo](#comment%3A32):\n> > The pexpect interface has been deprecated forever\n\n> \n> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.\n\n\nSemantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be. There are several tickets open to replace pexpect calls and documentation with the library interface. You yourself started to make `maxima()` use the library in #30097.",
    "created_at": "2022-01-22T18:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658522",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'></a>
Replying to [mkoeppe](#comment%3A34):
> Replying to [mjo](#comment%3A32):
> > The pexpect interface has been deprecated forever

> 
> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.


Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be. There are several tickets open to replace pexpect calls and documentation with the library interface. You yourself started to make `maxima()` use the library in #30097.



---

archive/issue_comments_658523.json:
```json
{
    "body": "<a id='comment:37'></a>\nYes, that's correct, #30097 would be a solution.",
    "created_at": "2022-01-22T18:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658523",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>
Yes, that's correct, #30097 would be a solution.



---

archive/issue_comments_658524.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [mjo](#comment%3A36):\n> Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be.\n\n\nThat would depend. The pexpect interface could in principle work with, say, maxima on SBCL, which probably would run faster than on ECL. So jobs with maxima that aren't particularly I/O-bound need not be faster through maxima_lib.\n\nStability: sure. pexpect inferfaces have shown to be quite fragile; particular with LISP, which tends to have I/O that isn't particularly compatible with C-type I/O (character devices may be driver really one-character-at-a-time).",
    "created_at": "2022-01-22T19:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658524",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:38'></a>
Replying to [mjo](#comment%3A36):
> Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be.


That would depend. The pexpect interface could in principle work with, say, maxima on SBCL, which probably would run faster than on ECL. So jobs with maxima that aren't particularly I/O-bound need not be faster through maxima_lib.

Stability: sure. pexpect inferfaces have shown to be quite fragile; particular with LISP, which tends to have I/O that isn't particularly compatible with C-type I/O (character devices may be driver really one-character-at-a-time).



---

archive/issue_comments_658525.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [mjo](#comment%3A32):\n> And I don't think adding a `quit()` hook could hurt in any case.\n\n\nit's there, no?\n\n```\nsage: maxima._quit_string()\n'quit();'\n```",
    "created_at": "2022-01-22T20:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658525",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>
Replying to [mjo](#comment%3A32):
> And I don't think adding a `quit()` hook could hurt in any case.


it's there, no?

```
sage: maxima._quit_string()
'quit();'
```



---

archive/issue_comments_658526.json:
```json
{
    "body": "<a id='comment:40'></a>\nI think I am noticing zombie processes also with the gap3 (optional) interface.",
    "created_at": "2022-01-22T21:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658526",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:40'></a>
I think I am noticing zombie processes also with the gap3 (optional) interface.



---

archive/issue_comments_658527.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [dimpase](#comment%3A39):\n> Replying to [mjo](#comment%3A32):\n> > And I don't think adding a `quit()` hook could hurt in any case.\n\n> \n> it's there, no?\n> \n> ```\n> sage: maxima._quit_string()\n> 'quit();'\n> ```\n> \n\n\nBut when is that string sent to the running maxima process? I meant something like[comment:31](#comment%3A31).\n\nI see now that there's a function called `quit_sage()` in `src/sage/all.py`,\n\n```python\ndef quit_sage(verbose=True):\n    \"\"\"                                                                                                                                                                      \n    If you use Sage in library mode, you should call this function                                                                                                           \n    when your application quits.                                                                                                                                             \n                                                                                                                                                                             \n    It makes sure any child processes are also killed, etc.                                                                                                                  \n    \"\"\"\n    ...\n    from sage.interfaces.quit import expect_quitall\n    expect_quitall(verbose=verbose)\n    ...\n```\n\nwhich kills all running pexpect processes. And apparently you are supposed to call this function yourself. So, I guess we can blame sagetex for not calling `quit_sage()` at the end of the scripts it generates? =)",
    "created_at": "2022-01-22T22:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658527",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:41'></a>
Replying to [dimpase](#comment%3A39):
> Replying to [mjo](#comment%3A32):
> > And I don't think adding a `quit()` hook could hurt in any case.

> 
> it's there, no?
> 
> ```
> sage: maxima._quit_string()
> 'quit();'
> ```
> 


But when is that string sent to the running maxima process? I meant something like[comment:31](#comment%3A31).

I see now that there's a function called `quit_sage()` in `src/sage/all.py`,

```python
def quit_sage(verbose=True):
    """                                                                                                                                                                      
    If you use Sage in library mode, you should call this function                                                                                                           
    when your application quits.                                                                                                                                             
                                                                                                                                                                             
    It makes sure any child processes are also killed, etc.                                                                                                                  
    """
    ...
    from sage.interfaces.quit import expect_quitall
    expect_quitall(verbose=verbose)
    ...
```

which kills all running pexpect processes. And apparently you are supposed to call this function yourself. So, I guess we can blame sagetex for not calling `quit_sage()` at the end of the scripts it generates? =)



---

archive/issue_comments_658528.json:
```json
{
    "body": "<a id='comment:42'></a>\nshouldn't EOF in a .sage script trigger `quit_sage()`?",
    "created_at": "2022-01-22T22:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658528",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>
shouldn't EOF in a .sage script trigger `quit_sage()`?



---

archive/issue_comments_658529.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [dimpase](#comment%3A42):\n> shouldn't EOF in a .sage script trigger `quit_sage()`?\n\n\nYes, obviously. (Or something like that). I only use sage as a library, and I just learned about that function 20 minutes ago. It's outrageous to expect the user to manually clean up after the library.\n\nHowever I think an atexit hook is a cleaner approach, at least for pexpect processes. They all support `quit()`, and could register their own atexit hook upon being initialized. It won't help with crashes or when killed by a signal, but then, neither does calling `quit_sage()` at EOF.",
    "created_at": "2022-01-22T23:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658529",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:43'></a>
Replying to [dimpase](#comment%3A42):
> shouldn't EOF in a .sage script trigger `quit_sage()`?


Yes, obviously. (Or something like that). I only use sage as a library, and I just learned about that function 20 minutes ago. It's outrageous to expect the user to manually clean up after the library.

However I think an atexit hook is a cleaner approach, at least for pexpect processes. They all support `quit()`, and could register their own atexit hook upon being initialized. It won't help with crashes or when killed by a signal, but then, neither does calling `quit_sage()` at EOF.



---

archive/issue_comments_658530.json:
```json
{
    "body": "<a id='comment:44'></a>\nI'm going to experiment with a cleanup hook for symmetrica on another ticket. Our interface to that library has `start()` and `end()` functions that are supposed to be called manually. The `start()` function gets called when you import `sage.libs.symmetrica.all`, but `end()` never does unless you call `quit_sage()`. So I'm going to have `start()` register a hook that calls `end()`, and remove the corresponding bits from `quit_sage()`. The body of `quit_sage()` isn't very long so we may be able to obsolete it rather quickly.",
    "created_at": "2022-01-22T23:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658530",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:44'></a>
I'm going to experiment with a cleanup hook for symmetrica on another ticket. Our interface to that library has `start()` and `end()` functions that are supposed to be called manually. The `start()` function gets called when you import `sage.libs.symmetrica.all`, but `end()` never does unless you call `quit_sage()`. So I'm going to have `start()` register a hook that calls `end()`, and remove the corresponding bits from `quit_sage()`. The body of `quit_sage()` isn't very long so we may be able to obsolete it rather quickly.



---

archive/issue_comments_658531.json:
```json
{
    "body": "<a id='comment:45'></a>\nI posted a branch on #8784 that eliminates `quit_sage()` and puts all of the cleanup chores (including the termination of pexpect processes) into atexit hooks.\n\nIt's a more-invasive change, but the right thing to do if it doesn't cause any subtle new bugs.",
    "created_at": "2022-01-25T22:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658531",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:45'></a>
I posted a branch on #8784 that eliminates `quit_sage()` and puts all of the cleanup chores (including the termination of pexpect processes) into atexit hooks.

It's a more-invasive change, but the right thing to do if it doesn't cause any subtle new bugs.



---

archive/issue_comments_658532.json:
```json
{
    "body": "**Reviewer:** Michael Orlitzky",
    "created_at": "2022-01-26T12:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658532",
    "user": "https://github.com/orlitzky"
}
```

**Reviewer:** Michael Orlitzky



---

archive/issue_comments_658533.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-01-26T12:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658533",
    "user": "https://github.com/orlitzky"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_658534.json:
```json
{
    "body": "<a id='comment:46'></a>\nLet's take the easy route for the 9.5 release and worry about `quit_sage()` afterwards.",
    "created_at": "2022-01-26T12:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658534",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:46'></a>
Let's take the easy route for the 9.5 release and worry about `quit_sage()` afterwards.



---

archive/issue_comments_658535.json:
```json
{
    "body": "<a id='comment:47'></a>\nSetting milestone to 9.6 now that 9.5 is out.",
    "created_at": "2022-01-30T15:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658535",
    "user": "https://github.com/slel"
}
```

<a id='comment:47'></a>
Setting milestone to 9.6 now that 9.5 is out.



---

archive/issue_events_098174.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-01-30T15:39:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33027#event-98174"
}
```



---

archive/issue_comments_658536.json:
```json
{
    "body": "<a id='comment:48'></a>\nWith this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. \n\n```\nsage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_abstract.py\", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands\nFailed example:\n    sorted(maxima._commands(verbose=False))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>\", line 1, in <module>\n        sorted(maxima._commands(verbose=False))\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in _commands\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in <listcomp>\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 296, in completions\n        cmd_list = self._eval_line('apropos(\"%s\")'%s, error_check=False)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 814, in `_eval_`line\n        self._expect_expr(self._display_prompt)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 731, in `_expect_`expr\n        i = self._expect.expect(expr)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 343, in expect\n        return self.expect_list(compiled_pattern_list,\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n        return exp.expect_loop(timeout)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 179, in expect_loop\n        return self.eof(e)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 122, in eof\n        raise exc\n    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.\n    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp\n    command: /home/release/Sage/local/bin/maxima\n    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']\n    buffer (last 100 chars): b''\n    before (last 100 chars): ''\n    after: <class 'pexpect.exceptions.EOF'>\n    match: None\n    match_index: None\n    exitstatus: None\n    flag_eof: True\n    pid: 1795009\n    child_fd: 20\n    closed: False\n    timeout: None\n    delimiter: <class 'pexpect.exceptions.EOF'>\n    logfile: None\n    logfile_read: None\n    logfile_send: None\n    maxread: 4194304\n    ignorecase: False\n    searchwindowsize: None\n    delaybeforesend: None\n    delayafterclose: 0.1\n    delayafterterminate: 0.1\n    searcher: searcher_re:\n        0: re.compile(b'<sage-display>')\n**********************************************************************\n```\nAlways disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.\n\n```\n./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx\n\n```",
    "created_at": "2022-01-30T20:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658536",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:48'></a>
With this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. 

```
sage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py
**********************************************************************
File "src/sage/interfaces/maxima_abstract.py", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands
Failed example:
    sorted(maxima._commands(verbose=False))
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>", line 1, in <module>
        sorted(maxima._commands(verbose=False))
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in _commands
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in <listcomp>
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 296, in completions
        cmd_list = self._eval_line('apropos("%s")'%s, error_check=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 814, in `_eval_`line
        self._expect_expr(self._display_prompt)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 731, in `_expect_`expr
        i = self._expect.expect(expr)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 343, in expect
        return self.expect_list(compiled_pattern_list,
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 372, in expect_list
        return exp.expect_loop(timeout)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 179, in expect_loop
        return self.eof(e)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 122, in eof
        raise exc
    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.
    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp
    command: /home/release/Sage/local/bin/maxima
    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']
    buffer (last 100 chars): b''
    before (last 100 chars): ''
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: None
    flag_eof: True
    pid: 1795009
    child_fd: 20
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile(b'<sage-display>')
**********************************************************************
```
Always disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.

```
./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx

```



---

archive/issue_comments_658537.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2022-01-30T20:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658537",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_658538.json:
```json
{
    "body": "<a id='comment:49'></a>\nActually seems to be due to #32986",
    "created_at": "2022-01-30T23:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658538",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:49'></a>
Actually seems to be due to #32986



---

archive/issue_comments_658539.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2022-01-31T13:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658539",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_658540.json:
```json
{
    "body": "<a id='comment:51'></a>\nI have just been hit by this problem on the patchbot as well. For me, running ptestlong now leaves about 47 maxima processes running at around 130% cpu usage on average, as well as two ecl and several fricas processes.\n\nWith the current branch, the problem seems to go away.",
    "created_at": "2022-02-07T22:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658540",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:51'></a>
I have just been hit by this problem on the patchbot as well. For me, running ptestlong now leaves about 47 maxima processes running at around 130% cpu usage on average, as well as two ecl and several fricas processes.

With the current branch, the problem seems to go away.



---

archive/issue_comments_658541.json:
```json
{
    "body": "<a id='comment:52'></a>\nfeel free to give it positive review, again...",
    "created_at": "2022-02-07T22:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658541",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'></a>
feel free to give it positive review, again...



---

archive/issue_comments_658542.json:
```json
{
    "body": "<a id='comment:53'></a>\nLonger term we will probably want threads enabled anyway (the upstream and most distros default), even if #8784 goes in, so.",
    "created_at": "2022-02-08T01:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658542",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:53'></a>
Longer term we will probably want threads enabled anyway (the upstream and most distros default), even if #8784 goes in, so.



---

archive/issue_comments_658543.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-02-08T01:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658543",
    "user": "https://github.com/orlitzky"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_658544.json:
```json
{
    "body": "<a id='comment:54'></a>\nAt first, I thought the branch would disable threads, but actually it is the other way around. If threads had been disabled before, I am surprised the zombie processes use more than 100% cpu.",
    "created_at": "2022-02-08T08:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658544",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:54'></a>
At first, I thought the branch would disable threads, but actually it is the other way around. If threads had been disabled before, I am surprised the zombie processes use more than 100% cpu.



---

archive/issue_comments_658545.json:
```json
{
    "body": "<a id='comment:55'></a>\nThe patch resulted from an observation that a system-wide `ecl` with threads enabled does not produce zombie processes. Probably `sage-cleaner` works better on them.",
    "created_at": "2022-02-08T09:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658545",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'></a>
The patch resulted from an observation that a system-wide `ecl` with threads enabled does not produce zombie processes. Probably `sage-cleaner` works better on them.



---

archive/issue_comments_658546.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2022-02-13T10:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658546",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_comments_658547.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/packages/ecl/nozombies](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/ecl/nozombies)\" to \"[abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)\".",
    "created_at": "2022-02-13T10:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33027#issuecomment-658547",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/dimpase/packages/ecl/nozombies](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/ecl/nozombies)" to "[abafddc33ff85ad50eb67c6532984985a856e882](https://github.com/sagemath/sagetrac-mirror/commit/abafddc33ff85ad50eb67c6532984985a856e882)".



---

archive/issue_events_098175.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-13T10:17:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33027",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33027#event-98175"
}
```
