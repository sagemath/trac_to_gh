# Issue 33473: numpy incompatibility when using system python and numpy 1.22 is installed in the system

archive/issues_033236.json:
```json
{
    "assignees": [],
    "body": "This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n\nNOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n\n\nThe symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n\n```\nsage: import sage.rings.polynomial.real_roots\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject\n```\n\nBackground:\n- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n- building sagelib needs to know location of include files:\n  - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n  - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n- my system numpy (1.22) has its own headers installed in `/usr/lib/python3.10/site-packages/numpy/core/include` but there's also a symlink `/usr/include/python3.10/numpy -> ../../lib/python3.10/site-packages/numpy/core/include/numpy`.\n- in the CC command line the python include location (in the system) is before the numpy include location (in the venv)\n- since the system python contains the system numpy, all numpy headers will be included from system and not from the venv, triggering the incompatibility.\n\nNOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)\n\nThe solution should be changing the order of the include locations so that the numpy location comes before the python location.\n\n \n\n\n\n\n\n\n\nCC:  @vbraun\n\nBranch: **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **Gonzalo Tornar\u00eda**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33473_\n\n",
    "closed_at": "2022-03-09T23:38:40Z",
    "created_at": "2022-03-07T01:45:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "numpy incompatibility when using system python and numpy 1.22 is installed in the system",
    "type": "issue",
    "updated_at": "2022-07-02T22:31:30Z",
    "url": "https://github.com/sagemath/sage/issues/33473",
    "user": "https://github.com/tornaria"
}
```
This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.

NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.


The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:

```
sage: import sage.rings.polynomial.real_roots
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject
```

Background:
- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
- building sagelib needs to know location of include files:
  - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
  - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
- my system numpy (1.22) has its own headers installed in `/usr/lib/python3.10/site-packages/numpy/core/include` but there's also a symlink `/usr/include/python3.10/numpy -> ../../lib/python3.10/site-packages/numpy/core/include/numpy`.
- in the CC command line the python include location (in the system) is before the numpy include location (in the venv)
- since the system python contains the system numpy, all numpy headers will be included from system and not from the venv, triggering the incompatibility.

NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)

The solution should be changing the order of the include locations so that the numpy location comes before the python location.

 







CC:  @vbraun

Branch: **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**

Reviewer: **Matthias Koeppe**

Author: **Gonzalo Tornaría**

_Issue created by migration from https://trac.sagemath.org/ticket/33473_





---

archive/issue_events_441548.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-07T01:45:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441548"
}
```



---

archive/issue_events_441549.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-07T01:45:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441549"
}
```



---

archive/issue_events_441550.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-07T01:45:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441550"
}
```



---

archive/issue_comments_543802.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nIt seems scipy may also be affected by this:\n\n```\n$ grep -l 'usr.*numpy.*\\.h' logs/pkgs/*\nlogs/pkgs/sagelib-9.6.beta3.log\nlogs/pkgs/scipy-1.7.3.log\n```\nIndeed\n\n```\n$ grep 'usr.*numpy.*\\.h' logs/pkgs/scipy-1.7.3.log \n  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,\n                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,\n  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning \"Using deprecated NumPy API, disable it with \" \"#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION\" [-Wcpp]\n  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,\n                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,\n                   from /usr/include/python3.10/numpy/arrayobject.h:5,\n  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning \"Using deprecated NumPy API, disable it with \" \"#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION\" [-Wcpp]\n```\nwe see that scipy also uses some incorrect headers (the warning is unrelated).",
    "created_at": "2022-03-07T01:45:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543802",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:1" align="right">Comment 1</div>

It seems scipy may also be affected by this:

```
$ grep -l 'usr.*numpy.*\.h' logs/pkgs/*
logs/pkgs/sagelib-9.6.beta3.log
logs/pkgs/scipy-1.7.3.log
```
Indeed

```
$ grep 'usr.*numpy.*\.h' logs/pkgs/scipy-1.7.3.log 
  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,
                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,
  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning "Using deprecated NumPy API, disable it with " "#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-Wcpp]
  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,
                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,
                   from /usr/include/python3.10/numpy/arrayobject.h:5,
  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning "Using deprecated NumPy API, disable it with " "#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-Wcpp]
```
we see that scipy also uses some incorrect headers (the warning is unrelated).



---

archive/issue_comments_543803.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nFor sagelib, the includes are determined by\n\n```\nsage: sage.env.sage_include_directories()\n['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',\n '/usr/include/python3.10',\n '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']\n```\n\nI think modifying this function so that the numpy include location comes before the system python include location should fix the issue.\n\nAs for scipy, it seems the issue happens in module `scipy.spatial` as in:\n\n```\nsage: import scipy.spatial\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject\n```",
    "created_at": "2022-03-07T02:13:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543803",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:2" align="right">Comment 2</div>

For sagelib, the includes are determined by

```
sage: sage.env.sage_include_directories()
['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',
 '/usr/include/python3.10',
 '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']
```

I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.

As for scipy, it seems the issue happens in module `scipy.spatial` as in:

```
sage: import scipy.spatial
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject
```



---

archive/issue_comments_543804.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nWhat does `python3.10 -m sysconfig | grep 'C.*FLAGS'` show?",
    "created_at": "2022-03-07T02:14:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543804",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">Comment 3</div>

What does `python3.10 -m sysconfig | grep 'C.*FLAGS'` show?



---

archive/issue_comments_543805.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nReplying to [@tornaria](#comment%3A2):\n> For sagelib, the includes are determined by\n> \n> ```\n> sage: sage.env.sage_include_directories()\n> ['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',\n>  '/usr/include/python3.10',\n>  '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']\n> ```\n> \n> I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.\n\nYes, this sounds like a good fix",
    "created_at": "2022-03-07T02:16:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543805",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">Comment 4</div>

Replying to [@tornaria](#comment%3A2):
> For sagelib, the includes are determined by
> 
> ```
> sage: sage.env.sage_include_directories()
> ['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',
>  '/usr/include/python3.10',
>  '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']
> ```
> 
> I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.

Yes, this sounds like a good fix



---

archive/issue_comments_543806.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nHere's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536\">f50e4cb</a></td><td><code>numpy: prefer venv headers before system headers</code></td></tr></table>\n",
    "created_at": "2022-03-07T02:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543806",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:5" align="right">Comment 5</div>

Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536">f50e4cb</a></td><td><code>numpy: prefer venv headers before system headers</code></td></tr></table>




---

archive/issue_comments_543807.json:
```json
{
    "body": "Commit: **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**",
    "created_at": "2022-03-07T02:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543807",
    "user": "https://github.com/tornaria"
}
```

Commit: **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**



---

archive/issue_comments_543808.json:
```json
{
    "body": "Branch: **[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)**",
    "created_at": "2022-03-07T02:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543808",
    "user": "https://github.com/tornaria"
}
```

Branch: **[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)**



---

archive/issue_events_441551.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-07T02:25:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441551"
}
```



---

archive/issue_events_441552.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T17:24:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441552"
}
```



---

archive/issue_comments_543809.json:
```json
{
    "body": "Author: **Gonzalo Tornar\u00eda**",
    "created_at": "2022-03-07T18:19:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543809",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Gonzalo Tornaría**



---

archive/issue_comments_543810.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n``````\n",
    "created_at": "2022-03-07T18:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543810",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
``````




---

archive/issue_comments_543811.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-07T18:24:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543811",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543812.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nI've updated the description - Sage uses numpy 1.21, not 1.19",
    "created_at": "2022-03-07T18:24:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543812",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">Comment 10</div>

I've updated the description - Sage uses numpy 1.21, not 1.19



---

archive/issue_comments_543813.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2022-03-07T18:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543813",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_543814.json:
```json
{
    "body": "Replying to [ticket:33473 tornaria]:\n> NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)\n\nArguably, this is a distribution bug. But we definitely have to work around it, given that it is widespread in Debian. Right now it is not acute because no released version of Debian/Ubuntu ships numpy 1.22.x. But it will become a bigger problem when we upgrade to numpy 1.22 and then we face the issue on all versions of Debian/Ubuntu.",
    "created_at": "2022-03-07T18:35:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543814",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33473 tornaria]:
> NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)

Arguably, this is a distribution bug. But we definitely have to work around it, given that it is widespread in Debian. Right now it is not acute because no released version of Debian/Ubuntu ships numpy 1.22.x. But it will become a bigger problem when we upgrade to numpy 1.22 and then we face the issue on all versions of Debian/Ubuntu.



---

archive/issue_comments_543815.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nReplying to [@tornaria](#comment%3A5):\n> Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.\n\nI don't think anyone is in the mood for making bugfix releases. But it looks like we might be ready for 9.6",
    "created_at": "2022-03-07T18:52:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543815",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">Comment 13</div>

Replying to [@tornaria](#comment%3A5):
> Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.

I don't think anyone is in the mood for making bugfix releases. But it looks like we might be ready for 9.6



---

archive/issue_events_441553.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T19:26:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441553"
}
```



---

archive/issue_events_441554.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T19:26:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441554"
}
```



---

archive/issue_comments_543816.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nThanks.\n\nI've reported this as a possible bug in the `numpy` package in void linux (https://github.com/void-linux/void-packages/issues/36062), to try to get an opinion on the distro side.\n\nWe could try to get the scipy patch upstreamed.\n\nBTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.",
    "created_at": "2022-03-09T16:58:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543816",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:15" align="right">Comment 15</div>

Thanks.

I've reported this as a possible bug in the `numpy` package in void linux (https://github.com/void-linux/void-packages/issues/36062), to try to get an opinion on the distro side.

We could try to get the scipy patch upstreamed.

BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.



---

archive/issue_comments_543817.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-09T16:58:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543817",
    "user": "https://github.com/tornaria"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543818.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-09T17:19:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543818",
    "user": "https://github.com/tornaria"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543819.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nI reverted the description by accident. Indeed sage 9.5 uses numpy 1.21 and the binary incompatibility arises in the upgrade to 1.22.",
    "created_at": "2022-03-09T17:19:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543819",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:16" align="right">Comment 16</div>

I reverted the description by accident. Indeed sage 9.5 uses numpy 1.21 and the binary incompatibility arises in the upgrade to 1.22.



---

archive/issue_comments_543820.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nReplying to [@tornaria](#comment%3A15):\n> We could try to get the scipy patch upstreamed.\n\n+1",
    "created_at": "2022-03-09T17:30:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543820",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">Comment 17</div>

Replying to [@tornaria](#comment%3A15):
> We could try to get the scipy patch upstreamed.

+1



---

archive/issue_comments_543821.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nReplying to [@tornaria](#comment%3A15):\n> BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.\n\nIs it even needed or does `setuptools` already put this include on the command line?",
    "created_at": "2022-03-09T17:31:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543821",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">Comment 18</div>

Replying to [@tornaria](#comment%3A15):
> BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.

Is it even needed or does `setuptools` already put this include on the command line?



---

archive/issue_comments_543822.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nReplying to [@mkoeppe](#comment%3A18):\n> Replying to [@tornaria](#comment%3A15):\n> > BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.\n\n> \n> Is it even needed or does `setuptools` already put this include on the command line?\n\nNo idea. If so, then why is `sage.env.sage_include_directories()` using `distutils.sysconfig.get_python_inc` at all?\n\nCan we just\n\n```\n--- a/src/sage/env.py\n+++ b/src/sage/env.py\n@@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):\n \n     TOP = SAGE_SRC if use_sources else SAGE_LIB\n \n-    dirs = [TOP,\n-            distutils.sysconfig.get_python_inc()]\n+    dirs = [TOP]\n     try:\n         import numpy\n         dirs.insert(1, numpy.get_include())\n```\n?",
    "created_at": "2022-03-09T17:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543822",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:19" align="right">Comment 19</div>

Replying to [@mkoeppe](#comment%3A18):
> Replying to [@tornaria](#comment%3A15):
> > BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.

> 
> Is it even needed or does `setuptools` already put this include on the command line?

No idea. If so, then why is `sage.env.sage_include_directories()` using `distutils.sysconfig.get_python_inc` at all?

Can we just

```
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):
 
     TOP = SAGE_SRC if use_sources else SAGE_LIB
 
-    dirs = [TOP,
-            distutils.sysconfig.get_python_inc()]
+    dirs = [TOP]
     try:
         import numpy
         dirs.insert(1, numpy.get_include())
```
?



---

archive/issue_comments_543823.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nworth a try",
    "created_at": "2022-03-09T18:05:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543823",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">Comment 20</div>

worth a try



---

archive/issue_comments_543824.json:
```json
{
    "body": "Changed branch from **[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)** to **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**",
    "created_at": "2022-03-09T23:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543824",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)** to **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)**



---

archive/issue_events_441555.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441555"
}
```



---

archive/issue_events_441556.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "eb21746961e131abb2ede78e8c4e1fbd497cb801",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-03-09T23:38:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-441556"
}
```



---

archive/issue_comments_543825.json:
```json
{
    "body": "Changed commit from **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)** to none",
    "created_at": "2022-03-10T16:44:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543825",
    "user": "https://github.com/tornaria"
}
```

Changed commit from **[f50e4cb](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)** to none



---

archive/issue_comments_543826.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nFor the record:\n- numpy maintainer in void linux acknowledged this as a package bug and it's already fixed (https://github.com/void-linux/void-packages/issues/36062)\n- debian already had a bug for this filed in october 2021, maintainer is not sure this is a bug, I've added an explanation of how this is expected to break sage 9.5 at some point (atm debian unstable has numpy-1.21, but 1.22 is already in experimental and that's the cue to break sage 9.5) https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=998084#17\n- indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n\n```\n        # Put the Python \"system\" include dir at the end, so that\n        # any local include dirs take precedence.\n```",
    "created_at": "2022-03-10T16:44:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543826",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:22" align="right">Comment 22</div>

For the record:
- numpy maintainer in void linux acknowledged this as a package bug and it's already fixed (https://github.com/void-linux/void-packages/issues/36062)
- debian already had a bug for this filed in october 2021, maintainer is not sure this is a bug, I've added an explanation of how this is expected to break sage 9.5 at some point (atm debian unstable has numpy-1.21, but 1.22 is already in experimental and that's the cue to break sage 9.5) https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=998084#17
- indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:

```
        # Put the Python "system" include dir at the end, so that
        # any local include dirs take precedence.
```



---

archive/issue_comments_543827.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nThis now fails on the github action:\n\n```\nsage -t --random-seed=174296915894383156674390339433925467897 sage/env.py\n**********************************************************************\nFile \"sage/env.py\", line 359, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nExpected:\n    ['.../site-packages',\n     '.../site-packages/numpy/core/include',\n     '.../include/python...']\nGot:\n    ['/__w/sagetrac-mirror/sagetrac-mirror/src',\n     '/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/numpy/core/include',\n     '/usr/include/python3.8']\n```\nSee https://github.com/sagemath/sage/runs/5522519846",
    "created_at": "2022-03-22T22:17:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543827",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:23" align="right">Comment 23</div>

This now fails on the github action:

```
sage -t --random-seed=174296915894383156674390339433925467897 sage/env.py
**********************************************************************
File "sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../site-packages',
     '.../site-packages/numpy/core/include',
     '.../include/python...']
Got:
    ['/__w/sagetrac-mirror/sagetrac-mirror/src',
     '/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/numpy/core/include',
     '/usr/include/python3.8']
```
See https://github.com/sagemath/sage/runs/5522519846



---

archive/issue_comments_543828.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nAlready fixed in #33532",
    "created_at": "2022-03-22T22:56:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543828",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">Comment 24</div>

Already fixed in #33532



---

archive/issue_comments_543829.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nReplying to [@mkoeppe](#comment%3A24):\n> Already fixed in #33532\n\nAh good!",
    "created_at": "2022-03-22T22:58:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543829",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:25" align="right">Comment 25</div>

Replying to [@mkoeppe](#comment%3A24):
> Already fixed in #33532

Ah good!



---

archive/issue_comments_543830.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nReplying to [@tornaria](#comment%3A19):\n> Can we just\n> \n> ```\n> --- a/src/sage/env.py\n> +++ b/src/sage/env.py\n> @@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):\n>  \n>      TOP = SAGE_SRC if use_sources else SAGE_LIB\n>  \n> -    dirs = [TOP,\n> -            distutils.sysconfig.get_python_inc()]\n> +    dirs = [TOP]\n>      try:\n>          import numpy\n>          dirs.insert(1, numpy.get_include())\n> ```\n> ?\n\nLet's do this in #33137",
    "created_at": "2022-07-02T22:31:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543830",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">Comment 26</div>

Replying to [@tornaria](#comment%3A19):
> Can we just
> 
> ```
> --- a/src/sage/env.py
> +++ b/src/sage/env.py
> @@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):
>  
>      TOP = SAGE_SRC if use_sources else SAGE_LIB
>  
> -    dirs = [TOP,
> -            distutils.sysconfig.get_python_inc()]
> +    dirs = [TOP]
>      try:
>          import numpy
>          dirs.insert(1, numpy.get_include())
> ```
> ?

Let's do this in #33137
