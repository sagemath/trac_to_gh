# Issue 33473: numpy incompatibility when using system python and numpy 1.22 is installed in the system

archive/issues_033236.json:
```json
{
    "body": "This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n\nNOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n\n\nThe symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n\n```\nsage: import sage.rings.polynomial.real_roots\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject\n```\n\nBackground:\n- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n- building sagelib needs to know location of include files:\n  - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n  - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n- my system numpy (1.22) has its own headers installed in `/usr/lib/python3.10/site-packages/numpy/core/include` but there's also a symlink `/usr/include/python3.10/numpy -> ../../lib/python3.10/site-packages/numpy/core/include/numpy`.\n- in the CC command line the python include location (in the system) is before the numpy include location (in the venv)\n- since the system python contains the system numpy, all numpy headers will be included from system and not from the venv, triggering the incompatibility.\n\nNOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)\n\nThe solution should be changing the order of the include locations so that the numpy location comes before the python location.\n\n \n\n\n\n\n\n\n\n**CC:**  @vbraun\n\n**Branch:** [f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)\n\n**Reviewer:** Matthias Koeppe\n\n**Author:** Gonzalo Tornar\u00eda\n\nIssue created by migration from https://trac.sagemath.org/ticket/33473\n\n",
    "closed_at": "2022-03-09T23:38:40Z",
    "created_at": "2022-03-07T01:45:45Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "title": "numpy incompatibility when using system python and numpy 1.22 is installed in the system",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/33473",
    "user": "https://github.com/tornaria"
}
```
This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.

NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.


The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:

```
sage: import sage.rings.polynomial.real_roots
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject
```

Background:
- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
- building sagelib needs to know location of include files:
  - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
  - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
- my system numpy (1.22) has its own headers installed in `/usr/lib/python3.10/site-packages/numpy/core/include` but there's also a symlink `/usr/include/python3.10/numpy -> ../../lib/python3.10/site-packages/numpy/core/include/numpy`.
- in the CC command line the python include location (in the system) is before the numpy include location (in the venv)
- since the system python contains the system numpy, all numpy headers will be included from system and not from the venv, triggering the incompatibility.

NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)

The solution should be changing the order of the include locations so that the numpy location comes before the python location.

 







**CC:**  @vbraun

**Branch:** [f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)

**Reviewer:** Matthias Koeppe

**Author:** Gonzalo Tornar√≠a

Issue created by migration from https://trac.sagemath.org/ticket/33473





---

archive/issue_comments_543299.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt seems scipy may also be affected by this:\n\n```\n$ grep -l 'usr.*numpy.*\\.h' logs/pkgs/*\nlogs/pkgs/sagelib-9.6.beta3.log\nlogs/pkgs/scipy-1.7.3.log\n```\nIndeed\n\n```\n$ grep 'usr.*numpy.*\\.h' logs/pkgs/scipy-1.7.3.log \n  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,\n                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,\n  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning \"Using deprecated NumPy API, disable it with \" \"#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION\" [-Wcpp]\n  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,\n                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,\n                   from /usr/include/python3.10/numpy/arrayobject.h:5,\n  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning \"Using deprecated NumPy API, disable it with \" \"#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION\" [-Wcpp]\n```\nwe see that scipy also uses some incorrect headers (the warning is unrelated).",
    "created_at": "2022-03-07T01:45:59Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543299",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'></a>
It seems scipy may also be affected by this:

```
$ grep -l 'usr.*numpy.*\.h' logs/pkgs/*
logs/pkgs/sagelib-9.6.beta3.log
logs/pkgs/scipy-1.7.3.log
```
Indeed

```
$ grep 'usr.*numpy.*\.h' logs/pkgs/scipy-1.7.3.log 
  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,
                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,
  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning "Using deprecated NumPy API, disable it with " "#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-Wcpp]
  In file included from /usr/include/python3.10/numpy/ndarraytypes.h:1960,
                   from /usr/include/python3.10/numpy/ndarrayobject.h:12,
                   from /usr/include/python3.10/numpy/arrayobject.h:5,
  /usr/include/python3.10/numpy/npy_1_7_deprecated_api.h:17:2: warning: #warning "Using deprecated NumPy API, disable it with " "#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-Wcpp]
```
we see that scipy also uses some incorrect headers (the warning is unrelated).



---

archive/issue_comments_543300.json:
```json
{
    "body": "<a id='comment:2'></a>\nFor sagelib, the includes are determined by\n\n```\nsage: sage.env.sage_include_directories()\n['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',\n '/usr/include/python3.10',\n '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']\n```\n\nI think modifying this function so that the numpy include location comes before the system python include location should fix the issue.\n\nAs for scipy, it seems the issue happens in module `scipy.spatial` as in:\n\n```\nsage: import scipy.spatial\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject\n```",
    "created_at": "2022-03-07T02:13:04Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543300",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:2'></a>
For sagelib, the includes are determined by

```
sage: sage.env.sage_include_directories()
['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',
 '/usr/include/python3.10',
 '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']
```

I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.

As for scipy, it seems the issue happens in module `scipy.spatial` as in:

```
sage: import scipy.spatial
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: numpy.ndarray size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject
```



---

archive/issue_comments_543301.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhat does `python3.10 -m sysconfig | grep 'C.*FLAGS'` show?",
    "created_at": "2022-03-07T02:14:07Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543301",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
What does `python3.10 -m sysconfig | grep 'C.*FLAGS'` show?



---

archive/issue_comments_543302.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [tornaria](#comment%3A2):\n> For sagelib, the includes are determined by\n> \n> ```\n> sage: sage.env.sage_include_directories()\n> ['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',\n>  '/usr/include/python3.10',\n>  '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']\n> ```\n> \n> I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.\n\n\nYes, this sounds like a good fix",
    "created_at": "2022-03-07T02:16:26Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543302",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Replying to [tornaria](#comment%3A2):
> For sagelib, the includes are determined by
> 
> ```
> sage: sage.env.sage_include_directories()
> ['/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages',
>  '/usr/include/python3.10',
>  '/home/tornaria/src/sage/sage-9.6.beta3/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include']
> ```
> 
> I think modifying this function so that the numpy include location comes before the system python include location should fix the issue.


Yes, this sounds like a good fix



---

archive/issue_comments_543303.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536\">f50e4cb</a></td><td><code>numpy: prefer venv headers before system headers</code></td></tr></table>\n",
    "created_at": "2022-03-07T02:25:05Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543303",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>
Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536">f50e4cb</a></td><td><code>numpy: prefer venv headers before system headers</code></td></tr></table>




---

archive/issue_comments_543304.json:
```json
{
    "body": "**Commit:** [f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)",
    "created_at": "2022-03-07T02:25:05Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543304",
    "user": "https://github.com/tornaria"
}
```

**Commit:** [f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)



---

archive/issue_comments_543305.json:
```json
{
    "body": "**Branch:** [u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)",
    "created_at": "2022-03-07T02:25:05Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543305",
    "user": "https://github.com/tornaria"
}
```

**Branch:** [u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)



---

archive/issue_events_299647.json:
```json
{
    "actor": "https://github.com/tornaria",
    "created_at": "2022-03-07T02:25:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299647"
}
```



---

archive/issue_events_299648.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T17:24:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "component: build",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299648"
}
```



---

archive/issue_comments_543306.json:
```json
{
    "body": "**Author:** Gonzalo Tornar\u00eda",
    "created_at": "2022-03-07T18:19:26Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543306",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Gonzalo Tornar√≠a



---

archive/issue_comments_543307.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n``````\n",
    "created_at": "2022-03-07T18:24:18Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543307",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
``````




---

archive/issue_comments_543308.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-07T18:24:42Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543308",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543309.json:
```json
{
    "body": "<a id='comment:10'></a>\nI've updated the description - Sage uses numpy 1.21, not 1.19",
    "created_at": "2022-03-07T18:24:58Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543309",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
I've updated the description - Sage uses numpy 1.21, not 1.19



---

archive/issue_comments_543310.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2022-03-07T18:28:42Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543310",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_comments_543311.json:
```json
{
    "body": "Replying to [ticket:33473 tornaria]:\n> NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)\n\n\nArguably, this is a distribution bug. But we definitely have to work around it, given that it is widespread in Debian. Right now it is not acute because no released version of Debian/Ubuntu ships numpy 1.22.x. But it will become a bigger problem when we upgrade to numpy 1.22 and then we face the issue on all versions of Debian/Ubuntu.",
    "created_at": "2022-03-07T18:35:10Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543311",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33473 tornaria]:
> NOTE: the symlink `/usr/include/python3.10/numpy` is not shipped by numpy itself, but it seems some distros add it. I'm using void linux, which has it, but at least debian also has it (see https://packages.debian.org/bullseye/amd64/python3-numpy/filelist)


Arguably, this is a distribution bug. But we definitely have to work around it, given that it is widespread in Debian. Right now it is not acute because no released version of Debian/Ubuntu ships numpy 1.22.x. But it will become a bigger problem when we upgrade to numpy 1.22 and then we face the issue on all versions of Debian/Ubuntu.



---

archive/issue_comments_543312.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tornaria](#comment%3A5):\n> Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.\n\n\nI don't think anyone is in the mood for making bugfix releases. But it looks like we might be ready for 9.6",
    "created_at": "2022-03-07T18:52:55Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543312",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
Replying to [tornaria](#comment%3A5):
> Here's an attempt to a solution. I based it on 9.5 and I wonder if this justifies an eventual 9.5.1.


I don't think anyone is in the mood for making bugfix releases. But it looks like we might be ready for 9.6



---

archive/issue_events_299649.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T19:26:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299649"
}
```



---

archive/issue_events_299650.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-07T19:26:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299650"
}
```



---

archive/issue_comments_543313.json:
```json
{
    "body": "<a id='comment:15'></a>\nThanks.\n\nI've reported this as a possible bug in the `numpy` package in void linux (https://github.com/void-linux/void-packages/issues/36062), to try to get an opinion on the distro side.\n\nWe could try to get the scipy patch upstreamed.\n\nBTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.",
    "created_at": "2022-03-09T16:58:16Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543313",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:15'></a>
Thanks.

I've reported this as a possible bug in the `numpy` package in void linux (https://github.com/void-linux/void-packages/issues/36062), to try to get an opinion on the distro side.

We could try to get the scipy patch upstreamed.

BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.



---

archive/issue_comments_543314.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-09T16:58:16Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543314",
    "user": "https://github.com/tornaria"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543315.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.\n \n-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.\n \n \n The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:\n@@ -14,7 +14,7 @@\n ```\n \n Background:\n-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)\n+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)\n - building sagelib needs to know location of include files:\n   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`\n   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`\n``````\n",
    "created_at": "2022-03-09T17:19:40Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543315",
    "user": "https://github.com/tornaria"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This retroactively affects sage-9.5, meaning sage-9.5 used to build ok in my system but now that system numpy has been upgraded to 1.22 it breaks. This is using the standard tarball, unpatched, as long as system python is used and numpy 1.22 happens to be installed in the system when sage is build.
 
-NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.19) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
+NOTE: this is NOT trying to use system numpy. Sage builds and installs its own numpy (1.21) but headers for the system numpy (1.22) get incorrectly mixed up when building sagelib.
 
 
 The symptom is that any sage module that uses `cimport numpy` will fail to load, making sage almost unusable, e.g.:
@@ -14,7 +14,7 @@
 ```
 
 Background:
-- numpy 1.19 and numpy 1.22 are ABI incompatible (ndarray changed size)
+- numpy 1.21 and numpy 1.22 are ABI incompatible (ndarray changed size)
 - building sagelib needs to know location of include files:
   - for python: since I'm using system python, this is a system include dir, here `/usr/include/python3.10`
   - for numpy: since numpy is bundled with sage, this is a dir in the venv, here `/home/tornaria/src/sage/sage-9.5/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/numpy/core/include`
``````




---

archive/issue_comments_543316.json:
```json
{
    "body": "<a id='comment:16'></a>\nI reverted the description by accident. Indeed sage 9.5 uses numpy 1.21 and the binary incompatibility arises in the upgrade to 1.22.",
    "created_at": "2022-03-09T17:19:40Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543316",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:16'></a>
I reverted the description by accident. Indeed sage 9.5 uses numpy 1.21 and the binary incompatibility arises in the upgrade to 1.22.



---

archive/issue_comments_543317.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [tornaria](#comment%3A15):\n> We could try to get the scipy patch upstreamed.\n\n\n+1",
    "created_at": "2022-03-09T17:30:13Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543317",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
Replying to [tornaria](#comment%3A15):
> We could try to get the scipy patch upstreamed.


+1



---

archive/issue_comments_543318.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [tornaria](#comment%3A15):\n> BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.\n\n\nIs it even needed or does `setuptools` already put this include on the command line?",
    "created_at": "2022-03-09T17:31:15Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543318",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Replying to [tornaria](#comment%3A15):
> BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.


Is it even needed or does `setuptools` already put this include on the command line?



---

archive/issue_comments_543319.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mkoeppe](#comment%3A18):\n> Replying to [tornaria](#comment%3A15):\n> > BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var(\"INCLUDEPY\")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.\n\n> \n> Is it even needed or does `setuptools` already put this include on the command line?\n\n\nNo idea. If so, then why is `sage.env.sage_include_directories()` using `distutils.sysconfig.get_python_inc` at all?\n\nCan we just\n\n```\n--- a/src/sage/env.py\n+++ b/src/sage/env.py\n@@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):\n \n     TOP = SAGE_SRC if use_sources else SAGE_LIB\n \n-    dirs = [TOP,\n-            distutils.sysconfig.get_python_inc()]\n+    dirs = [TOP]\n     try:\n         import numpy\n         dirs.insert(1, numpy.get_include())\n```\n?",
    "created_at": "2022-03-09T17:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543319",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:19'></a>
Replying to [mkoeppe](#comment%3A18):
> Replying to [tornaria](#comment%3A15):
> > BTW, I think eventually `distutils.sysconfig.get_python_inc()` should be changed to `sysconfig.get_config_var("INCLUDEPY")` since `distutils` is deprecated but `sysconfig` doesn't have a function `get_python_inc()`.

> 
> Is it even needed or does `setuptools` already put this include on the command line?


No idea. If so, then why is `sage.env.sage_include_directories()` using `distutils.sysconfig.get_python_inc` at all?

Can we just

```
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):
 
     TOP = SAGE_SRC if use_sources else SAGE_LIB
 
-    dirs = [TOP,
-            distutils.sysconfig.get_python_inc()]
+    dirs = [TOP]
     try:
         import numpy
         dirs.insert(1, numpy.get_include())
```
?



---

archive/issue_comments_543320.json:
```json
{
    "body": "<a id='comment:20'></a>\nworth a try",
    "created_at": "2022-03-09T18:05:05Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543320",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
worth a try



---

archive/issue_comments_543321.json:
```json
{
    "body": "**Changing branch** from \"[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)\" to \"[f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)\".",
    "created_at": "2022-03-09T23:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543321",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/tornaria/33473-numpy-includes](https://github.com/sagemath/sagetrac-mirror/tree/u/tornaria/33473-numpy-includes)" to "[f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)".



---

archive/issue_events_299651.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299651"
}
```



---

archive/issue_events_299652.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33473#event-299652"
}
```



---

archive/issue_comments_543322.json:
```json
{
    "body": "**Changing commit** from \"[f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)\" to \"\".",
    "created_at": "2022-03-10T16:44:51Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543322",
    "user": "https://github.com/tornaria"
}
```

**Changing commit** from "[f50e4cbb5f2e84854881a46e865b3bd3550f4536](https://github.com/sagemath/sagetrac-mirror/commit/f50e4cbb5f2e84854881a46e865b3bd3550f4536)" to "".



---

archive/issue_comments_543323.json:
```json
{
    "body": "<a id='comment:22'></a>\nFor the record:\n- numpy maintainer in void linux acknowledged this as a package bug and it's already fixed (https://github.com/void-linux/void-packages/issues/36062)\n- debian already had a bug for this filed in october 2021, maintainer is not sure this is a bug, I've added an explanation of how this is expected to break sage 9.5 at some point (atm debian unstable has numpy-1.21, but 1.22 is already in experimental and that's the cue to break sage 9.5) https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=998084#17\n- indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n\n```\n        # Put the Python \"system\" include dir at the end, so that\n        # any local include dirs take precedence.\n```",
    "created_at": "2022-03-10T16:44:51Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543323",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:22'></a>
For the record:
- numpy maintainer in void linux acknowledged this as a package bug and it's already fixed (https://github.com/void-linux/void-packages/issues/36062)
- debian already had a bug for this filed in october 2021, maintainer is not sure this is a bug, I've added an explanation of how this is expected to break sage 9.5 at some point (atm debian unstable has numpy-1.21, but 1.22 is already in experimental and that's the cue to break sage 9.5) https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=998084#17
- indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:

```
        # Put the Python "system" include dir at the end, so that
        # any local include dirs take precedence.
```



---

archive/issue_comments_543324.json:
```json
{
    "body": "<a id='comment:23'></a>\nThis now fails on the github action:\n\n```\nsage -t --random-seed=174296915894383156674390339433925467897 sage/env.py\n**********************************************************************\nFile \"sage/env.py\", line 359, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nExpected:\n    ['.../site-packages',\n     '.../site-packages/numpy/core/include',\n     '.../include/python...']\nGot:\n    ['/__w/sagetrac-mirror/sagetrac-mirror/src',\n     '/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/numpy/core/include',\n     '/usr/include/python3.8']\n```\nSee https://github.com/sagemath/sage/runs/5522519846",
    "created_at": "2022-03-22T22:17:47Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543324",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:23'></a>
This now fails on the github action:

```
sage -t --random-seed=174296915894383156674390339433925467897 sage/env.py
**********************************************************************
File "sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../site-packages',
     '.../site-packages/numpy/core/include',
     '.../include/python...']
Got:
    ['/__w/sagetrac-mirror/sagetrac-mirror/src',
     '/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/numpy/core/include',
     '/usr/include/python3.8']
```
See https://github.com/sagemath/sage/runs/5522519846



---

archive/issue_comments_543325.json:
```json
{
    "body": "<a id='comment:24'></a>\nAlready fixed in #33532",
    "created_at": "2022-03-22T22:56:52Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543325",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Already fixed in #33532



---

archive/issue_comments_543326.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [mkoeppe](#comment%3A24):\n> Already fixed in #33532\n\n\nAh good!",
    "created_at": "2022-03-22T22:58:41Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543326",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:25'></a>
Replying to [mkoeppe](#comment%3A24):
> Already fixed in #33532


Ah good!



---

archive/issue_comments_543327.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [tornaria](#comment%3A19):\n> Can we just\n> \n> ```\n> --- a/src/sage/env.py\n> +++ b/src/sage/env.py\n> @@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):\n>  \n>      TOP = SAGE_SRC if use_sources else SAGE_LIB\n>  \n> -    dirs = [TOP,\n> -            distutils.sysconfig.get_python_inc()]\n> +    dirs = [TOP]\n>      try:\n>          import numpy\n>          dirs.insert(1, numpy.get_include())\n> ```\n> ?\n\n\nLet's do this in #33137",
    "created_at": "2022-07-02T22:31:30Z",
    "issue": "https://github.com/sagemath/sage/issues/33473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33473#issuecomment-543327",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
Replying to [tornaria](#comment%3A19):
> Can we just
> 
> ```
> --- a/src/sage/env.py
> +++ b/src/sage/env.py
> @@ -377,8 +377,7 @@ def sage_include_directories(use_sources=False):
>  
>      TOP = SAGE_SRC if use_sources else SAGE_LIB
>  
> -    dirs = [TOP,
> -            distutils.sysconfig.get_python_inc()]
> +    dirs = [TOP]
>      try:
>          import numpy
>          dirs.insert(1, numpy.get_include())
> ```
> ?


Let's do this in #33137
