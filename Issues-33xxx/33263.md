# Issue 33263: Add github action running on each push

archive/issues_033026.json:
```json
{
    "body": "Add a github action that runs on each push. Since it uses the most recent docker image as the base, the runtime is relatively short with about 2h. The idea is to get quick feedback on PRs without the need to wait until the patchbot picks it up. After this ticket is merged, we can add a badge in the ticket similar to the linter workflow.\n\nExample run: https://github.com/sagemath/sagetrac-mirror/actions/workflows/build.yml\n(it works but one doctest and the pytests are failing; I think there are already tickets for these issues)\n\nCC:  @mkoeppe @fchapoton\n\nBranch/Commit: 63298162ccec5c390018231b036a9dc5dd107e55\n\nReviewer: Matthias Koeppe\n\nAuthor: Tobias Diez\n\nDependencies: #33103\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33263\n\n",
    "closed_at": "2022-02-16T23:57:16Z",
    "created_at": "2022-01-31T20:24:42Z",
    "labels": [
        "component: build",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Add github action running on each push",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33263",
    "user": "https://github.com/tobiasdiez"
}
```
Add a github action that runs on each push. Since it uses the most recent docker image as the base, the runtime is relatively short with about 2h. The idea is to get quick feedback on PRs without the need to wait until the patchbot picks it up. After this ticket is merged, we can add a badge in the ticket similar to the linter workflow.

Example run: https://github.com/sagemath/sagetrac-mirror/actions/workflows/build.yml
(it works but one doctest and the pytests are failing; I think there are already tickets for these issues)

CC:  @mkoeppe @fchapoton

Branch/Commit: 63298162ccec5c390018231b036a9dc5dd107e55

Reviewer: Matthias Koeppe

Author: Tobias Diez

Dependencies: #33103

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33263





---

archive/issue_comments_470341.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-31T20:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470341",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470342.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-31T20:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470342",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470343.json:
```json
{
    "body": "<a id='comment:3'></a>Why not just `configure --prefix=/sage/local`?",
    "created_at": "2022-01-31T22:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470343",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Why not just `configure --prefix=/sage/local`?



---

archive/issue_comments_470344.json:
```json
{
    "body": "<a id='comment:4'></a>Which jobs does it cancel?",
    "created_at": "2022-01-31T22:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470344",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Which jobs does it cancel?



---

archive/issue_comments_470345.json:
```json
{
    "body": "<a id='comment:5'></a>You may want to use #33233",
    "created_at": "2022-01-31T22:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470345",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>You may want to use #33233



---

archive/issue_comments_470346.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 mkoeppe]:\n> Which jobs does it cancel?\n\nAlso perhaps the new built-in `concurrency` stuff can be used? https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency",
    "created_at": "2022-01-31T22:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470346",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:4 mkoeppe]:
> Which jobs does it cancel?

Also perhaps the new built-in `concurrency` stuff can be used? https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency



---

archive/issue_comments_470347.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-01T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470347",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470348.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-01T13:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470349.json:
```json
{
    "body": "<a id='comment:9'></a>Thanks for the feedback. I've now used `--prefix` and `concurrency` (to cancel previous runs of the same workflow for the same branch).",
    "created_at": "2022-02-01T13:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470349",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:9'></a>Thanks for the feedback. I've now used `--prefix` and `concurrency` (to cancel previous runs of the same workflow for the same branch).



---

archive/issue_comments_470350.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:5 mkoeppe]:\n> You may want to use #33233\n\n\nThe idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is \"always green\".",
    "created_at": "2022-02-01T13:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470350",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:10'></a>Replying to [comment:5 mkoeppe]:
> You may want to use #33233


The idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is "always green".



---

archive/issue_comments_470351.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:3 mkoeppe]:\n> Why not just `configure --prefix=/sage/local`?\n\n\nBut now it seems to rebuild all python packages instead of using them from the docker image as before. Is this a bug in prefix or did I use it wrong?",
    "created_at": "2022-02-01T13:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470351",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>Replying to [comment:3 mkoeppe]:
> Why not just `configure --prefix=/sage/local`?


But now it seems to rebuild all python packages instead of using them from the docker image as before. Is this a bug in prefix or did I use it wrong?



---

archive/issue_comments_470352.json:
```json
{
    "body": "<a id='comment:13'></a>Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`",
    "created_at": "2022-02-01T15:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470352",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`



---

archive/issue_comments_470353.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:10 gh-tobiasdiez]:\n> Replying to [comment:5 mkoeppe]:\n> > You may want to use #33233\n\n> \n> The idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is \"always green\".\n\n\nThe patchbot makes the same optimistic assumption, which is why it's broken so often...",
    "created_at": "2022-02-01T15:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470353",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Replying to [comment:10 gh-tobiasdiez]:
> Replying to [comment:5 mkoeppe]:
> > You may want to use #33233

> 
> The idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is "always green".


The patchbot makes the same optimistic assumption, which is why it's broken so often...



---

archive/issue_comments_470354.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-01T15:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470355.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:13 mkoeppe]:\n> Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`\n\n\nThanks, that worked well!",
    "created_at": "2022-02-01T16:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470355",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:16'></a>Replying to [comment:13 mkoeppe]:
> Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`


Thanks, that worked well!



---

archive/issue_comments_470356.json:
```json
{
    "body": "<a id='comment:17'></a>Another idea, for a much faster build, would be to just work out of `/sage`, merging the current commit.",
    "created_at": "2022-02-01T20:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470356",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Another idea, for a much faster build, would be to just work out of `/sage`, merging the current commit.



---

archive/issue_comments_470357.json:
```json
{
    "body": "<a id='comment:18'></a>I think with a bit more than 1.5h runtime, it is already reasonably fast. The actual build also only takes about 35mins, the rest is spent on the tests. Further optimization in my opinion will be a trade-off between time savings and reduced reliability, because you then have to think about invalidation of the cythonize cache etc. The point of this ticket is to pursue a different approach than the patchbot and really start from a clean state. I would propose to first gain experience with this, before we implement more fancy caching mechanisms (and in this case I would also prefer github actions builtin cache mechanism).",
    "created_at": "2022-02-02T09:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470357",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>I think with a bit more than 1.5h runtime, it is already reasonably fast. The actual build also only takes about 35mins, the rest is spent on the tests. Further optimization in my opinion will be a trade-off between time savings and reduced reliability, because you then have to think about invalidation of the cythonize cache etc. The point of this ticket is to pursue a different approach than the patchbot and really start from a clean state. I would propose to first gain experience with this, before we implement more fancy caching mechanisms (and in this case I would also prefer github actions builtin cache mechanism).



---

archive/issue_comments_470358.json:
```json
{
    "body": "<a id='comment:19'></a>Sure, sounds good.",
    "created_at": "2022-02-02T18:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470358",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Sure, sounds good.



---

archive/issue_comments_470359.json:
```json
{
    "body": "<a id='comment:20'></a>However I think it should only be run for branches on tickets set to `needs_review`. \nAfter making `git-trac` available (see #33222), you can use something like `git trac search --branch u/mkoeppe/upgrade_giac_to_1_7_0`\nand `git trac print 33263 | grep '^Status: needs_review'` for this",
    "created_at": "2022-02-02T18:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470359",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>However I think it should only be run for branches on tickets set to `needs_review`. 
After making `git-trac` available (see #33222), you can use something like `git trac search --branch u/mkoeppe/upgrade_giac_to_1_7_0`
and `git trac print 33263 | grep '^Status: needs_review'` for this



---

archive/issue_comments_470360.json:
```json
{
    "body": "<a id='comment:21'></a>Hm... no, people set \"needs_review\" after a push, not before",
    "created_at": "2022-02-02T18:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470360",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Hm... no, people set "needs_review" after a push, not before



---

archive/issue_comments_470361.json:
```json
{
    "body": "<a id='comment:22'></a>OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag",
    "created_at": "2022-02-02T18:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470361",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag



---

archive/issue_comments_470362.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-03T10:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470363.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-03T10:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470363",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470364.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 mkoeppe]:\n> OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag\n\n\nThanks for the review. It now uses `dev` and I set the ticket to positive review now (please intervene if I misunderstood you).",
    "created_at": "2022-02-03T10:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470364",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:24'></a>Replying to [comment:22 mkoeppe]:
> OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag


Thanks for the review. It now uses `dev` and I set the ticket to positive review now (please intervene if I misunderstood you).



---

archive/issue_comments_470365.json:
```json
{
    "body": "<a id='comment:25'></a>Increasing priority as the badge is already added to the trac ticket (so that I don't have to login in the VM and change the config multiple times).",
    "created_at": "2022-02-14T20:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470365",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:25'></a>Increasing priority as the badge is already added to the trac ticket (so that I don't have to login in the VM and change the config multiple times).



---

archive/issue_comments_470366.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-02-14T20:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470366",
    "user": "https://github.com/tobiasdiez"
}
```

Changing priority from major to critical.



---

archive/issue_comments_470367.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-16T23:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33263#issuecomment-470367",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087832.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-16T23:57:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33263",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33263#event-87832"
}
```
