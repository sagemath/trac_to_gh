# Issue 33398: Upgrade SymPy to 1.10 and update doctests

archive/issues_033161.json:
```json
{
    "body": "CC:  @egourgoulhon @oscarbenjamin\n\nSymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.\n\n\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n\nSome doctests needs updating.\n\nFrom https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n**********************************************************************\nFile \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\nFailed example:\n    a, cond\nExpected:\n    (-oo, True)\nGot:\n    (0, True)\n**********************************************************************\n```\nThis appears to be a deliberate change in sympy. We update the doctest.\n\n\nSome doctests need updating because of changes to expression canonicalization in sympy:\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n**********************************************************************\nFile \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\nFailed example:\n    Phi.coord_functions(c_UV, c_xyz)\nExpected:\n    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)\n     on the Chart (M, (U, V))\nGot:\n    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n```\nWe update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33398\n\n",
    "closed_at": "2022-03-09T23:38:35Z",
    "created_at": "2022-02-21T20:29:22Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Upgrade SymPy to 1.10 and update doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33398",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @egourgoulhon @oscarbenjamin

SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.

​https://github.com/sympy/sympy/wiki/release-notes-for-1.10

Some doctests needs updating.

From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
**********************************************************************
File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
Failed example:
    a, cond
Expected:
    (-oo, True)
Got:
    (0, True)
**********************************************************************
```
This appears to be a deliberate change in sympy. We update the doctest.


Some doctests need updating because of changes to expression canonicalization in sympy:

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
**********************************************************************
File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
Failed example:
    Phi.coord_functions(c_UV, c_xyz)
Expected:
    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
     on the Chart (M, (U, V))
Got:
    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
```
We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.


Issue created by migration from https://trac.sagemath.org/ticket/33398





---

archive/issue_comments_471857.json:
```json
{
    "body": "```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py\n**********************************************************************\nFile \"src/sage/symbolic/expression_conversions.py\", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative\nFailed example:\n    df_sympy == f_sympy.diff(x, 2, y, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>\", line 1, in <module>\n        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py\", line 3533, in diff\n        return _derivative_dispatch(self, *symbols, **assumptions)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1920, in _derivative_dispatch\n        return Derivative(expr, *variables, **kwargs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1345, in __new__\n        raise ValueError(filldedent('''\n    ValueError: \n    Can't calculate derivative wrt 2.\n**********************************************************************\n```\n\nFor this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144",
    "created_at": "2022-02-21T21:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471857",
    "user": "https://github.com/mkoeppe"
}
```

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
        return _derivative_dispatch(self, *symbols, **assumptions)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
        return Derivative(expr, *variables, **kwargs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
        raise ValueError(filldedent('''
    ValueError: 
    Can't calculate derivative wrt 2.
**********************************************************************
```

For this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144



---

archive/issue_comments_471858.json:
```json
{
    "body": "A few more that are only seen with `sage -t --long`:\n\n```\nsage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 334, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    f.display()  # long time\nExpected:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 343, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 348, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 357, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\nGot:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\n**********************************************************************\n1 item had failures:\n   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField\n    [1059 tests, 4 failures, 716.84 s]\n```",
    "created_at": "2022-02-21T22:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471858",
    "user": "https://github.com/mkoeppe"
}
```

A few more that are only seen with `sage -t --long`:

```
sage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 334, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    f.display()  # long time
Expected:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 343, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 348, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 357, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): V → ℝ
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
Got:
    t(a,b): V → ℝ
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
**********************************************************************
1 item had failures:
   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField
    [1059 tests, 4 failures, 716.84 s]
```



---

archive/issue_comments_471859.json:
```json
{
    "body": "Thanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.",
    "created_at": "2022-02-22T10:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471859",
    "user": "https://github.com/egourgoulhon"
}
```

Thanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.



---

archive/issue_comments_471860.json:
```json
{
    "body": "Replying to [comment:1 mkoeppe]:\n> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144\n\n\nFixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166",
    "created_at": "2022-02-25T22:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471860",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:1 mkoeppe]:
> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144


Fixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166



---

archive/issue_comments_471861.json:
```json
{
    "body": "Replying to [comment:3 egourgoulhon]:\n> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? \n\n\nYes, I think so",
    "created_at": "2022-02-25T22:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471861",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 egourgoulhon]:
> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? 


Yes, I think so



---

archive/issue_comments_471862.json:
```json
{
    "body": "Replying to [ticket:33398 mkoeppe]:\n> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n> \n> ```\n> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n> **********************************************************************\n> File \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\n> Failed example:\n>     a, cond\n> Expected:\n>     (-oo, True)\n> Got:\n>     (0, True)\n> **********************************************************************\n\n\nThis change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.",
    "created_at": "2022-02-25T23:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471862",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33398 mkoeppe]:
> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
> 
> ```
> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
> **********************************************************************
> File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
> Failed example:
>     a, cond
> Expected:
>     (-oo, True)
> Got:
>     (0, True)
> **********************************************************************


This change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.



---

archive/issue_comments_471863.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-03-04T23:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471863",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_471864.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-05T00:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471864",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-06T17:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471866.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-03-06T17:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471866",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_471867.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-06T17:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471867",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471868.json:
```json
{
    "body": "LGTM. Thanks!",
    "created_at": "2022-03-06T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471868",
    "user": "https://github.com/egourgoulhon"
}
```

LGTM. Thanks!



---

archive/issue_comments_471869.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-06T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471869",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471870.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-09T23:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-471870",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088083.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33398#event-88083"
}
```
