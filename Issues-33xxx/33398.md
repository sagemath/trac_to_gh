# Issue 33398: Upgrade SymPy to 1.10 and update doctests

archive/issues_033161.json:
```json
{
    "assignees": [],
    "body": "SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.\n\n\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n\nSome doctests needs updating.\n\nFrom https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n**********************************************************************\nFile \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\nFailed example:\n    a, cond\nExpected:\n    (-oo, True)\nGot:\n    (0, True)\n**********************************************************************\n```\nThis appears to be a deliberate change in sympy. We update the doctest.\n\n\nSome doctests need updating because of changes to expression canonicalization in sympy:\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n**********************************************************************\nFile \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\nFailed example:\n    Phi.coord_functions(c_UV, c_xyz)\nExpected:\n    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)\n     on the Chart (M, (U, V))\nGot:\n    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n```\nWe update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.\n\n\nCC:  @egourgoulhon @oscarbenjamin\n\nBranch/Commit: **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**\n\nReviewer: **Eric Gourgoulhon**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **symbolics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33398_\n\n",
    "closed_at": "2022-03-09T23:38:35Z",
    "created_at": "2022-02-21T20:29:22Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Upgrade SymPy to 1.10 and update doctests",
    "type": "issue",
    "updated_at": "2022-03-09T23:38:35Z",
    "url": "https://github.com/sagemath/sage/issues/33398",
    "user": "https://github.com/mkoeppe"
}
```
SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.

​https://github.com/sympy/sympy/wiki/release-notes-for-1.10

Some doctests needs updating.

From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
**********************************************************************
File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
Failed example:
    a, cond
Expected:
    (-oo, True)
Got:
    (0, True)
**********************************************************************
```
This appears to be a deliberate change in sympy. We update the doctest.


Some doctests need updating because of changes to expression canonicalization in sympy:

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
**********************************************************************
File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
Failed example:
    Phi.coord_functions(c_UV, c_xyz)
Expected:
    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
     on the Chart (M, (U, V))
Got:
    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
```
We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.


CC:  @egourgoulhon @oscarbenjamin

Branch/Commit: **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**

Reviewer: **Eric Gourgoulhon**

Author: **Matthias Koeppe**

Component: **symbolics**

_Issue created by migration from https://trac.sagemath.org/ticket/33398_





---

archive/issue_events_459034.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-21T20:29:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459034"
}
```



---

archive/issue_events_459035.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-21T20:29:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459035"
}
```



---

archive/issue_events_459036.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-21T20:29:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459036"
}
```



---

archive/issue_events_459037.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-02-21T20:29:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459037"
}
```



---

archive/issue_comments_539763.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py\n**********************************************************************\nFile \"src/sage/symbolic/expression_conversions.py\", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative\nFailed example:\n    df_sympy == f_sympy.diff(x, 2, y, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>\", line 1, in <module>\n        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py\", line 3533, in diff\n        return _derivative_dispatch(self, *symbols, **assumptions)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1920, in _derivative_dispatch\n        return Derivative(expr, *variables, **kwargs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1345, in __new__\n        raise ValueError(filldedent('''\n    ValueError: \n    Can't calculate derivative wrt 2.\n**********************************************************************\n```\n\nFor this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144",
    "created_at": "2022-02-21T21:00:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539763",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>


```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
        return _derivative_dispatch(self, *symbols, **assumptions)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
        return Derivative(expr, *variables, **kwargs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
        raise ValueError(filldedent('''
    ValueError: 
    Can't calculate derivative wrt 2.
**********************************************************************
```

For this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144



---

archive/issue_comments_539764.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nA few more that are only seen with `sage -t --long`:\n\n```\nsage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 334, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    f.display()  # long time\nExpected:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 343, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 348, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 357, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\nGot:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\n**********************************************************************\n1 item had failures:\n   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField\n    [1059 tests, 4 failures, 716.84 s]\n```",
    "created_at": "2022-02-21T22:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539764",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

A few more that are only seen with `sage -t --long`:

```
sage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 334, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    f.display()  # long time
Expected:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 343, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 348, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 357, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): V → ℝ
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
Got:
    t(a,b): V → ℝ
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
**********************************************************************
1 item had failures:
   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField
    [1059 tests, 4 failures, 716.84 s]
```



---

archive/issue_comments_539765.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.",
    "created_at": "2022-02-22T10:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539765",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:3" align="right">comment:3</div>

Thanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.



---

archive/issue_comments_539766.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@mkoeppe](#comment:1):\n> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144\n\nFixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166",
    "created_at": "2022-02-25T22:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539766",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@mkoeppe](#comment:1):
> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144

Fixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166



---

archive/issue_comments_539767.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@egourgoulhon](#comment:3):\n> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? \n\nYes, I think so",
    "created_at": "2022-02-25T22:19:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539767",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@egourgoulhon](#comment:3):
> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? 

Yes, I think so



---

archive/issue_comments_539768.json:
```json
{
    "body": "Replying to [ticket:33398 mkoeppe]:\n> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n> \n> ```\n> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n> **********************************************************************\n> File \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\n> Failed example:\n>     a, cond\n> Expected:\n>     (-oo, True)\n> Got:\n>     (0, True)\n> **********************************************************************\n> ```\n\nThis change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.",
    "created_at": "2022-02-25T23:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539768",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33398 mkoeppe]:
> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
> 
> ```
> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
> **********************************************************************
> File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
> Failed example:
>     a, cond
> Expected:
>     (-oo, True)
> Got:
>     (0, True)
> **********************************************************************
> ```

This change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.



---

archive/issue_comments_539769.json:
```json
{
    "body": "Branch: **[u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10)**",
    "created_at": "2022-03-04T23:18:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539769",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10)**



---

archive/issue_comments_539770.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cd666052228835a79cd317fcf9663d48c51b3fa1\">cd66605</a></td><td><code>build/pkgs/sympy: Update to 1.10rc3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e\">c49eff3</a></td><td><code>src/sage/calculus/calculus.py: Update laplace doctest for sympy 1.10</code></td></tr></table>\n",
    "created_at": "2022-03-04T23:18:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539770",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cd666052228835a79cd317fcf9663d48c51b3fa1">cd66605</a></td><td><code>build/pkgs/sympy: Update to 1.10rc3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e">c49eff3</a></td><td><code>src/sage/calculus/calculus.py: Update laplace doctest for sympy 1.10</code></td></tr></table>




---

archive/issue_comments_539771.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2022-03-04T23:18:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539771",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_539772.json:
```json
{
    "body": "Commit: **[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)**",
    "created_at": "2022-03-04T23:18:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539772",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)**



---

archive/issue_comments_539773.json:
```json
{
    "body": "Changed commit from **[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)** to **[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)**",
    "created_at": "2022-03-05T00:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539773",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)** to **[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)**



---

archive/issue_comments_539774.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04\">609dd9d</a></td><td><code>sage.manifolds: Update doctests for SymPy 1.10</code></td></tr></table>\n",
    "created_at": "2022-03-05T00:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539774",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04">609dd9d</a></td><td><code>sage.manifolds: Update doctests for SymPy 1.10</code></td></tr></table>




---

archive/issue_events_459038.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:18:30Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "title_is": "Upgrade SymPy to 1.10 and update doctests",
    "title_was": "Update doctests for compatibility with SymPy 1.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459038"
}
```



---

archive/issue_comments_539775.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.\n+\n+Some doctests needs updating.\n+\n+\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n+\n From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n \n ```\n``````\n",
    "created_at": "2022-03-05T00:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539775",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
+SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.
+
+Some doctests needs updating.
+
+​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
+
 From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
 
 ```
``````




---

archive/issue_comments_539776.json:
```json
{
    "body": "Changed commit from **[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)** to **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**",
    "created_at": "2022-03-06T17:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539776",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)** to **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**



---

archive/issue_comments_539777.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27\">6b7c3a2</a></td><td><code>build/pkgs/sympy: Update to 1.10</code></td></tr></table>\n",
    "created_at": "2022-03-06T17:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539777",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27">6b7c3a2</a></td><td><code>build/pkgs/sympy: Update to 1.10</code></td></tr></table>




---

archive/issue_events_459039.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-06T17:42:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459039"
}
```



---

archive/issue_events_459040.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-06T17:42:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459040"
}
```



---

archive/issue_events_459041.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-06T17:42:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459041"
}
```



---

archive/issue_comments_539778.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n-SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.\n+SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.\n+\n+\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n \n Some doctests needs updating.\n-\n-\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n \n From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n \n@@ -17,7 +17,13 @@\n Got:\n     (0, True)\n **********************************************************************\n+```\n+This appears to be a deliberate change in sympy. We update the doctest.\n \n+\n+Some doctests need updating because of changes to expression canonicalization in sympy:\n+\n+```\n sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n **********************************************************************\n File \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\n@@ -28,59 +34,6 @@\n      on the Chart (M, (U, V))\n Got:\n     Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n+```\n+We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.\n \n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/differentiable/diff_form.py\n-**********************************************************************\n-File \"src/sage/manifolds/differentiable/diff_form.py\", line 268, in sage.manifolds.differentiable.diff_form.DiffForm\n-Failed example:\n-    s.display(eU)\n-Expected:\n-    a\u2227b = -x*(2*x*y + 1) dx\u2227dy\n-Got:\n-    a\u2227b = x*(-2*x*y - 1) dx\u2227dy\n-**********************************************************************\n-File \"src/sage/manifolds/differentiable/diff_form.py\", line 277, in sage.manifolds.differentiable.diff_form.DiffForm\n-Failed example:\n-    s.display(eU)\n-Expected:\n-    f*a = -y*(x**2 + 2*x*y + y**2) dx + x*(x**2 + 2*x*y + y**2) dy\n-Got:\n-    f*a = y*(-x**2 - 2*x*y - y**2) dx + x*(x**2 + 2*x*y + y**2) dy\n-**********************************************************************\n-\n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n-**********************************************************************\n-File \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\n-Failed example:\n-    Phi.coord_functions(c_UV, c_xyz)\n-Expected:\n-    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)\n-     on the Chart (M, (U, V))\n-Got:\n-    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n-**********************************************************************\n-\n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py\n-**********************************************************************\n-File \"src/sage/symbolic/expression_conversions.py\", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative\n-Failed example:\n-    df_sympy == f_sympy.diff(x, 2, y, 1)\n-Exception raised:\n-    Traceback (most recent call last):\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n-        self.compile_and_execute(example, compiler, test.globs)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n-        exec(compiled, globs)\n-      File \"<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>\", line 1, in <module>\n-        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py\", line 3533, in diff\n-        return _derivative_dispatch(self, *symbols, **assumptions)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1920, in _derivative_dispatch\n-        return Derivative(expr, *variables, **kwargs)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1345, in __new__\n-        raise ValueError(filldedent('''\n-    ValueError: \n-    Can't calculate derivative wrt 2.\n-**********************************************************************\n-```\n-\n``````\n",
    "created_at": "2022-03-06T17:47:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539778",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
-SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.
+SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.
+
+​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
 
 Some doctests needs updating.
-
-​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
 
 From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
 
@@ -17,7 +17,13 @@
 Got:
     (0, True)
 **********************************************************************
+```
+This appears to be a deliberate change in sympy. We update the doctest.
 
+
+Some doctests need updating because of changes to expression canonicalization in sympy:
+
+```
 sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
 **********************************************************************
 File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
@@ -28,59 +34,6 @@
      on the Chart (M, (U, V))
 Got:
     Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
+```
+We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.
 
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/differentiable/diff_form.py
-**********************************************************************
-File "src/sage/manifolds/differentiable/diff_form.py", line 268, in sage.manifolds.differentiable.diff_form.DiffForm
-Failed example:
-    s.display(eU)
-Expected:
-    a∧b = -x*(2*x*y + 1) dx∧dy
-Got:
-    a∧b = x*(-2*x*y - 1) dx∧dy
-**********************************************************************
-File "src/sage/manifolds/differentiable/diff_form.py", line 277, in sage.manifolds.differentiable.diff_form.DiffForm
-Failed example:
-    s.display(eU)
-Expected:
-    f*a = -y*(x**2 + 2*x*y + y**2) dx + x*(x**2 + 2*x*y + y**2) dy
-Got:
-    f*a = y*(-x**2 - 2*x*y - y**2) dx + x*(x**2 + 2*x*y + y**2) dy
-**********************************************************************
-
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
-**********************************************************************
-File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
-Failed example:
-    Phi.coord_functions(c_UV, c_xyz)
-Expected:
-    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
-     on the Chart (M, (U, V))
-Got:
-    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
-**********************************************************************
-
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
-**********************************************************************
-File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
-Failed example:
-    df_sympy == f_sympy.diff(x, 2, y, 1)
-Exception raised:
-    Traceback (most recent call last):
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
-        self.compile_and_execute(example, compiler, test.globs)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
-        exec(compiled, globs)
-      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
-        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
-        return _derivative_dispatch(self, *symbols, **assumptions)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
-        return Derivative(expr, *variables, **kwargs)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
-        raise ValueError(filldedent('''
-    ValueError: 
-    Can't calculate derivative wrt 2.
-**********************************************************************
-```
-
``````




---

archive/issue_comments_539779.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2022-03-06T17:48:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539779",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_539780.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nLGTM. Thanks!",
    "created_at": "2022-03-06T21:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539780",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:17" align="right">comment:17</div>

LGTM. Thanks!



---

archive/issue_events_459042.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2022-03-06T21:08:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459042"
}
```



---

archive/issue_events_459043.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2022-03-06T21:08:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459043"
}
```



---

archive/issue_comments_539781.json:
```json
{
    "body": "Reviewer: **Eric Gourgoulhon**",
    "created_at": "2022-03-06T21:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539781",
    "user": "https://github.com/egourgoulhon"
}
```

Reviewer: **Eric Gourgoulhon**



---

archive/issue_comments_539782.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10)** to **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**",
    "created_at": "2022-03-09T23:38:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33398#issuecomment-539782",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10)** to **[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)**



---

archive/issue_events_459044.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459044"
}
```



---

archive/issue_events_459045.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "6e05da68105a1b070a6cb771797de9432b5e71bd",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-03-09T23:38:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33398",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33398#event-459045"
}
```
