# Issue 33398: Upgrade SymPy to 1.10 and update doctests

archive/issues_033161.json:
```json
{
    "body": "SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.\n\n\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n\nSome doctests needs updating.\n\nFrom https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n**********************************************************************\nFile \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\nFailed example:\n    a, cond\nExpected:\n    (-oo, True)\nGot:\n    (0, True)\n**********************************************************************\n```\nThis appears to be a deliberate change in sympy. We update the doctest.\n\n\nSome doctests need updating because of changes to expression canonicalization in sympy:\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n**********************************************************************\nFile \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\nFailed example:\n    Phi.coord_functions(c_UV, c_xyz)\nExpected:\n    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)\n     on the Chart (M, (U, V))\nGot:\n    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n```\nWe update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.\n\n\nCC:  @egourgoulhon @oscarbenjamin\n\nBranch/Commit: 6b7c3a28656180e42163dc10f7b4a571b93e5f27\n\nReviewer: Eric Gourgoulhon\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33398\n\n",
    "closed_at": "2022-03-09T23:38:35Z",
    "created_at": "2022-02-21T20:29:22Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Upgrade SymPy to 1.10 and update doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33398",
    "user": "https://github.com/mkoeppe"
}
```
SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.

​https://github.com/sympy/sympy/wiki/release-notes-for-1.10

Some doctests needs updating.

From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
**********************************************************************
File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
Failed example:
    a, cond
Expected:
    (-oo, True)
Got:
    (0, True)
**********************************************************************
```
This appears to be a deliberate change in sympy. We update the doctest.


Some doctests need updating because of changes to expression canonicalization in sympy:

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
**********************************************************************
File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
Failed example:
    Phi.coord_functions(c_UV, c_xyz)
Expected:
    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
     on the Chart (M, (U, V))
Got:
    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
```
We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.


CC:  @egourgoulhon @oscarbenjamin

Branch/Commit: 6b7c3a28656180e42163dc10f7b4a571b93e5f27

Reviewer: Eric Gourgoulhon

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33398





---

archive/issue_comments_657745.json:
```json
{
    "body": "<a id='comment:1'></a>\n\n```\nsage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py\n**********************************************************************\nFile \"src/sage/symbolic/expression_conversions.py\", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative\nFailed example:\n    df_sympy == f_sympy.diff(x, 2, y, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>\", line 1, in <module>\n        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py\", line 3533, in diff\n        return _derivative_dispatch(self, *symbols, **assumptions)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1920, in _derivative_dispatch\n        return Derivative(expr, *variables, **kwargs)\n      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1345, in __new__\n        raise ValueError(filldedent('''\n    ValueError: \n    Can't calculate derivative wrt 2.\n**********************************************************************\n```\n\nFor this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144",
    "created_at": "2022-02-21T21:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657745",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>

```
sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
        return _derivative_dispatch(self, *symbols, **assumptions)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
        return Derivative(expr, *variables, **kwargs)
      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
        raise ValueError(filldedent('''
    ValueError: 
    Can't calculate derivative wrt 2.
**********************************************************************
```

For this failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144



---

archive/issue_comments_657746.json:
```json
{
    "body": "<a id='comment:2'></a>\nA few more that are only seen with `sage -t --long`:\n\n```\nsage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 334, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    f.display()  # long time\nExpected:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): S^2 \u2192 \u211d\n    on U: (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on V: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 343, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): U \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n    on W: (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 348, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\nGot:\n    t(a,b): W \u2192 \u211d\n       (x, y) \u21a6 -2*x*y - 3*x - y**2\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/tensorfield.py\", line 357, in sage.manifolds.differentiable.tensorfield.TensorField\nFailed example:\n    s.display()  # long time\nExpected:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\nGot:\n    t(a,b): V \u2192 \u211d\n       (u, v) \u21a6 (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)\n    on W: (x, y) \u21a6 -2*x*y - 3*x - y**2\n**********************************************************************\n1 item had failures:\n   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField\n    [1059 tests, 4 failures, 716.84 s]\n```",
    "created_at": "2022-02-21T22:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657746",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
A few more that are only seen with `sage -t --long`:

```
sage -t --long --random-seed=247003911346858216390278955506857279024 src/sage/manifolds/differentiable/tensorfield.py
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 334, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    f.display()  # long time
Expected:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): S^2 → ℝ
    on U: (x, y) ↦ -2*x*y - 3*x - y**2
    on V: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 343, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): U → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
    on W: (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 348, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
Got:
    t(a,b): W → ℝ
       (x, y) ↦ -2*x*y - 3*x - y**2
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
**********************************************************************
File "src/sage/manifolds/differentiable/tensorfield.py", line 357, in sage.manifolds.differentiable.tensorfield.TensorField
Failed example:
    s.display()  # long time
Expected:
    t(a,b): V → ℝ
       (u, v) ↦ -(3*u**3 + 3*u*v**2 + 2*u*v + v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
Got:
    t(a,b): V → ℝ
       (u, v) ↦ (-3*u**3 - 3*u*v**2 - 2*u*v - v**2)/(u**4 + 2*u**2*v**2 + v**4)
    on W: (x, y) ↦ -2*x*y - 3*x - y**2
**********************************************************************
1 item had failures:
   4 of  82 in sage.manifolds.differentiable.tensorfield.TensorField
    [1059 tests, 4 failures, 716.84 s]
```



---

archive/issue_comments_657747.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.",
    "created_at": "2022-02-22T10:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657747",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:3'></a>
Thanks for the report. What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? Otherwise, there will be doctest failures with SymPy 1.9 --- the current version in Sage.



---

archive/issue_comments_657748.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [mkoeppe](#comment%3A1):\n> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144\n\n\nFixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166",
    "created_at": "2022-02-25T22:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657748",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Replying to [mkoeppe](#comment%3A1):
> For the failure in `src/sage/symbolic/expression_conversions.py`, I have opened https://github.com/sympy/sympy/issues/23144


Fixed now in master and the 1.10 branch by https://github.com/sympy/sympy/pull/23162, https://github.com/sympy/sympy/pull/23166



---

archive/issue_comments_657749.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [egourgoulhon](#comment%3A3):\n> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? \n\n\nYes, I think so",
    "created_at": "2022-02-25T22:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657749",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Replying to [egourgoulhon](#comment%3A3):
> What should be the action here? Shall we wait for the release of SymPy 1.10 and its integration as a Sage standard package? 


Yes, I think so



---

archive/issue_comments_657750.json:
```json
{
    "body": "Replying to [ticket:33398 mkoeppe]:\n> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n> \n> ```\n> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py\n> **********************************************************************\n> File \"src/sage/calculus/calculus.py\", line 1642, in sage.calculus.calculus.laplace\n> Failed example:\n>     a, cond\n> Expected:\n>     (-oo, True)\n> Got:\n>     (0, True)\n> **********************************************************************\n\n\nThis change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.",
    "created_at": "2022-02-25T23:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657750",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33398 mkoeppe]:
> From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
> 
> ```
> sage -t --random-seed=141799432516026950115879763089480345171 src/sage/calculus/calculus.py
> **********************************************************************
> File "src/sage/calculus/calculus.py", line 1642, in sage.calculus.calculus.laplace
> Failed example:
>     a, cond
> Expected:
>     (-oo, True)
> Got:
>     (0, True)
> **********************************************************************


This change to `laplace_transform` seems to be a deliberate change in sympy, not a regression.



---

archive/issue_comments_657751.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10\"",
    "created_at": "2022-03-04T23:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657751",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10"



---

archive/issue_comments_657752.json:
```json
{
    "body": "<a id='comment:9'></a>\nNew commits:\n|                                                                                                                                          |                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|\n|[cd66605](https://github.com/sagemath/sagetrac-mirror/commit/cd666052228835a79cd317fcf9663d48c51b3fa1)|`build/pkgs/sympy: Update to 1.10rc3`|\n|[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)|`src/sage/calculus/calculus.py: Update laplace doctest for sympy 1.10`|",
    "created_at": "2022-03-04T23:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657752",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
New commits:
|                                                                                                                                          |                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|
|[cd66605](https://github.com/sagemath/sagetrac-mirror/commit/cd666052228835a79cd317fcf9663d48c51b3fa1)|`build/pkgs/sympy: Update to 1.10rc3`|
|[c49eff3](https://github.com/sagemath/sagetrac-mirror/commit/c49eff347454ac7f07e5918470b20e97b8f2357e)|`src/sage/calculus/calculus.py: Update laplace doctest for sympy 1.10`|



---

archive/issue_comments_657753.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-03-04T23:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657753",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_657754.json:
```json
{
    "body": "Changing commit from \"\" to \"c49eff347454ac7f07e5918470b20e97b8f2357e\"",
    "created_at": "2022-03-04T23:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657754",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "c49eff347454ac7f07e5918470b20e97b8f2357e"



---

archive/issue_comments_657755.json:
```json
{
    "body": "Changing commit from \"c49eff347454ac7f07e5918470b20e97b8f2357e\" to \"609dd9deaeaa6380ab2f0d50276d911233c00a04\"",
    "created_at": "2022-03-05T00:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c49eff347454ac7f07e5918470b20e97b8f2357e" to "609dd9deaeaa6380ab2f0d50276d911233c00a04"



---

archive/issue_comments_657756.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)|`sage.manifolds: Update doctests for SymPy 1.10`|",
    "created_at": "2022-03-05T00:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[609dd9d](https://github.com/sagemath/sagetrac-mirror/commit/609dd9deaeaa6380ab2f0d50276d911233c00a04)|`sage.manifolds: Update doctests for SymPy 1.10`|



---

archive/issue_events_107015.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "rename": {
        "from": "Update doctests for compatibility with SymPy 1.10",
        "to": "Upgrade SymPy to 1.10 and update doctests"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33398#event-107015"
}
```



---

archive/issue_comments_657757.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.\n+\n+Some doctests needs updating.\n+\n+\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n+\n From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n \n ```\n``````\n",
    "created_at": "2022-03-05T00:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657757",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
+SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.
+
+Some doctests needs updating.
+
+​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
+
 From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
 
 ```
``````




---

archive/issue_comments_657758.json:
```json
{
    "body": "Changing commit from \"609dd9deaeaa6380ab2f0d50276d911233c00a04\" to \"6b7c3a28656180e42163dc10f7b4a571b93e5f27\"",
    "created_at": "2022-03-06T17:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657758",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "609dd9deaeaa6380ab2f0d50276d911233c00a04" to "6b7c3a28656180e42163dc10f7b4a571b93e5f27"



---

archive/issue_comments_657759.json:
```json
{
    "body": "<a id='comment:13'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)|`build/pkgs/sympy: Update to 1.10`|",
    "created_at": "2022-03-06T17:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[6b7c3a2](https://github.com/sagemath/sagetrac-mirror/commit/6b7c3a28656180e42163dc10f7b4a571b93e5f27)|`build/pkgs/sympy: Update to 1.10`|



---

archive/issue_comments_657760.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-06T17:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657760",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_657761.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n-SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.\n+SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.\n+\n+\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n \n Some doctests needs updating.\n-\n-\u200bhttps://github.com/sympy/sympy/wiki/release-notes-for-1.10\n \n From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true\n \n@@ -17,7 +17,13 @@\n Got:\n     (0, True)\n **********************************************************************\n+```\n+This appears to be a deliberate change in sympy. We update the doctest.\n \n+\n+Some doctests need updating because of changes to expression canonicalization in sympy:\n+\n+```\n sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n **********************************************************************\n File \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\n@@ -28,59 +34,6 @@\n      on the Chart (M, (U, V))\n Got:\n     Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n+```\n+We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.\n \n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/differentiable/diff_form.py\n-**********************************************************************\n-File \"src/sage/manifolds/differentiable/diff_form.py\", line 268, in sage.manifolds.differentiable.diff_form.DiffForm\n-Failed example:\n-    s.display(eU)\n-Expected:\n-    a\u2227b = -x*(2*x*y + 1) dx\u2227dy\n-Got:\n-    a\u2227b = x*(-2*x*y - 1) dx\u2227dy\n-**********************************************************************\n-File \"src/sage/manifolds/differentiable/diff_form.py\", line 277, in sage.manifolds.differentiable.diff_form.DiffForm\n-Failed example:\n-    s.display(eU)\n-Expected:\n-    f*a = -y*(x**2 + 2*x*y + y**2) dx + x*(x**2 + 2*x*y + y**2) dy\n-Got:\n-    f*a = y*(-x**2 - 2*x*y - y**2) dx + x*(x**2 + 2*x*y + y**2) dy\n-**********************************************************************\n-\n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py\n-**********************************************************************\n-File \"src/sage/manifolds/continuous_map.py\", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions\n-Failed example:\n-    Phi.coord_functions(c_UV, c_xyz)\n-Expected:\n-    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)\n-     on the Chart (M, (U, V))\n-Got:\n-    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))\n-**********************************************************************\n-\n-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py\n-**********************************************************************\n-File \"src/sage/symbolic/expression_conversions.py\", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative\n-Failed example:\n-    df_sympy == f_sympy.diff(x, 2, y, 1)\n-Exception raised:\n-    Traceback (most recent call last):\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n-        self.compile_and_execute(example, compiler, test.globs)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n-        exec(compiled, globs)\n-      File \"<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>\", line 1, in <module>\n-        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py\", line 3533, in diff\n-        return _derivative_dispatch(self, *symbols, **assumptions)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1920, in _derivative_dispatch\n-        return Derivative(expr, *variables, **kwargs)\n-      File \"/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py\", line 1345, in __new__\n-        raise ValueError(filldedent('''\n-    ValueError: \n-    Can't calculate derivative wrt 2.\n-**********************************************************************\n-```\n-\n``````\n",
    "created_at": "2022-03-06T17:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657761",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
-SymPy 1.10 is in the release candidate stage; it still supports Python 3.7.
+SymPy 1.10 was released on 2022-03-06. It still supports Python 3.7, as needed for Sage 9.6.
+
+​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
 
 Some doctests needs updating.
-
-​https://github.com/sympy/sympy/wiki/release-notes-for-1.10
 
 From https://github.com/sympy/sympy/runs/5276327276?check_suite_focus=true
 
@@ -17,7 +17,13 @@
 Got:
     (0, True)
 **********************************************************************
+```
+This appears to be a deliberate change in sympy. We update the doctest.
 
+
+Some doctests need updating because of changes to expression canonicalization in sympy:
+
+```
 sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
 **********************************************************************
 File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
@@ -28,59 +34,6 @@
      on the Chart (M, (U, V))
 Got:
     Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
+```
+We update these doctests. They will fail now with older versions of sympy. However, we do not adjust the version bounds in `build/pkgs/sympy/install-requires.txt`.
 
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/differentiable/diff_form.py
-**********************************************************************
-File "src/sage/manifolds/differentiable/diff_form.py", line 268, in sage.manifolds.differentiable.diff_form.DiffForm
-Failed example:
-    s.display(eU)
-Expected:
-    a∧b = -x*(2*x*y + 1) dx∧dy
-Got:
-    a∧b = x*(-2*x*y - 1) dx∧dy
-**********************************************************************
-File "src/sage/manifolds/differentiable/diff_form.py", line 277, in sage.manifolds.differentiable.diff_form.DiffForm
-Failed example:
-    s.display(eU)
-Expected:
-    f*a = -y*(x**2 + 2*x*y + y**2) dx + x*(x**2 + 2*x*y + y**2) dy
-Got:
-    f*a = y*(-x**2 - 2*x*y - y**2) dx + x*(x**2 + 2*x*y + y**2) dy
-**********************************************************************
-
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/manifolds/continuous_map.py
-**********************************************************************
-File "src/sage/manifolds/continuous_map.py", line 1359, in sage.manifolds.continuous_map.ContinuousMap.coord_functions
-Failed example:
-    Phi.coord_functions(c_UV, c_xyz)
-Expected:
-    Coordinate functions (-U**2/4 + V**2/4, -(U + V)/(U - V), V)
-     on the Chart (M, (U, V))
-Got:
-    Coordinate functions (-U**2/4 + V**2/4, (-U - V)/(U - V), V) on the Chart (M, (U, V))
-**********************************************************************
-
-sage -t --random-seed=141799432516026950115879763089480345171 src/sage/symbolic/expression_conversions.py
-**********************************************************************
-File "src/sage/symbolic/expression_conversions.py", line 870, in sage.symbolic.expression_conversions.SympyConverter.derivative
-Failed example:
-    df_sympy == f_sympy.diff(x, 2, y, 1)
-Exception raised:
-    Traceback (most recent call last):
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
-        self.compile_and_execute(example, compiler, test.globs)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
-        exec(compiled, globs)
-      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
-        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/expr.py", line 3533, in diff
-        return _derivative_dispatch(self, *symbols, **assumptions)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1920, in _derivative_dispatch
-        return Derivative(expr, *variables, **kwargs)
-      File "/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sympy/core/function.py", line 1345, in __new__
-        raise ValueError(filldedent('''
-    ValueError: 
-    Can't calculate derivative wrt 2.
-**********************************************************************
-```
-
``````




---

archive/issue_comments_657762.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2022-03-06T17:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657762",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_657763.json:
```json
{
    "body": "<a id='comment:17'></a>\nLGTM. Thanks!",
    "created_at": "2022-03-06T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657763",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>
LGTM. Thanks!



---

archive/issue_comments_657764.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-06T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657764",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_657765.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Eric Gourgoulhon\"",
    "created_at": "2022-03-06T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657765",
    "user": "https://github.com/egourgoulhon"
}
```

Changing reviewer from "" to "Eric Gourgoulhon"



---

archive/issue_comments_657766.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10\" to \"6b7c3a28656180e42163dc10f7b4a571b93e5f27\"",
    "created_at": "2022-03-09T23:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657766",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/update_doctests_for_compatibility_with_sympy_1_10" to "6b7c3a28656180e42163dc10f7b4a571b93e5f27"



---

archive/issue_comments_657767.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-09T23:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33398#issuecomment-657767",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_107016.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-09T23:38:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33398",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33398#event-107016"
}
```
