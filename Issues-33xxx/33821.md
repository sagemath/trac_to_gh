# Issue 33821: Remove use of SAGE_LIB in sage.misc

archive/issues_033584.json:
```json
{
    "body": "We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).\n\nWe change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that \n- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty\n- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)\n\npart of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)\n\nCC:  @kiwifb @antonio-rojas @tornaria\n\nBranch/Commit: 748d9fbe54bda2b9529053d261ba12ba168f6a81\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Matthias Koeppe\n\nDependencies: #33793\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33821\n\n",
    "closed_at": "2022-07-03T22:06:02Z",
    "created_at": "2022-05-08T03:39:41Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Remove use of SAGE_LIB in sage.misc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33821",
    "user": "https://github.com/mkoeppe"
}
```
We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).

We change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that 
- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty
- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)

part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)

CC:  @kiwifb @antonio-rojas @tornaria

Branch/Commit: 748d9fbe54bda2b9529053d261ba12ba168f6a81

Reviewer: Fran√ßois Bissey

Author: Matthias Koeppe

Dependencies: #33793

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33821





---

archive/issue_comments_666181.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#33793\"",
    "created_at": "2022-05-08T03:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666181",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#33793"



---

archive/issue_comments_666182.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/remove_use_of_sage_lib_in_sage_misc\"",
    "created_at": "2022-05-08T04:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666182",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/remove_use_of_sage_lib_in_sage_misc"



---

archive/issue_comments_666183.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[8cacd5e](https://github.com/sagemath/sagetrac-mirror/commit/8cacd5ef926218eebe5cd1e0f5d7ab3282bba200)|`src/sage/misc/sageinspect.py: Remove import of SAGE_LIB`|\n|[c8a5bdf](https://github.com/sagemath/sagetrac-mirror/commit/c8a5bdfdaf4bc348c9d6d1319b8b6784f7593ff7)|`src/sage/misc/lazy_import.pyx: Import lazy_import_cache only when needed`|\n|[cce5385](https://github.com/sagemath/sagetrac-mirror/commit/cce53854c9fd93a4134ff31169585ce534dd5859)|`src/sage/sets/set_from_iterator.py: Remove use of SAGE_LIB`|",
    "created_at": "2022-05-08T04:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[8cacd5e](https://github.com/sagemath/sagetrac-mirror/commit/8cacd5ef926218eebe5cd1e0f5d7ab3282bba200)|`src/sage/misc/sageinspect.py: Remove import of SAGE_LIB`|
|[c8a5bdf](https://github.com/sagemath/sagetrac-mirror/commit/c8a5bdfdaf4bc348c9d6d1319b8b6784f7593ff7)|`src/sage/misc/lazy_import.pyx: Import lazy_import_cache only when needed`|
|[cce5385](https://github.com/sagemath/sagetrac-mirror/commit/cce53854c9fd93a4134ff31169585ce534dd5859)|`src/sage/sets/set_from_iterator.py: Remove use of SAGE_LIB`|



---

archive/issue_comments_666184.json:
```json
{
    "body": "Changing commit from \"\" to \"cce53854c9fd93a4134ff31169585ce534dd5859\"",
    "created_at": "2022-05-08T04:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "cce53854c9fd93a4134ff31169585ce534dd5859"



---

archive/issue_comments_666185.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-05-08T04:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666185",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_666186.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-08T04:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666186",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_666187.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+part of Meta-ticket #33037\n``````\n",
    "created_at": "2022-05-08T04:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666187",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+part of Meta-ticket #33037
``````




---

archive/issue_comments_666188.json:
```json
{
    "body": "Changing commit from \"cce53854c9fd93a4134ff31169585ce534dd5859\" to \"b39cf31719c3e62ee35d1ba3fe72852d86551a91\"",
    "created_at": "2022-05-08T18:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666188",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cce53854c9fd93a4134ff31169585ce534dd5859" to "b39cf31719c3e62ee35d1ba3fe72852d86551a91"



---

archive/issue_comments_666189.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[b39cf31](https://github.com/sagemath/sagetrac-mirror/commit/b39cf31719c3e62ee35d1ba3fe72852d86551a91)|`src/sage/misc/lazy_import.pyx: Update doctest`|",
    "created_at": "2022-05-08T18:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[b39cf31](https://github.com/sagemath/sagetrac-mirror/commit/b39cf31719c3e62ee35d1ba3fe72852d86551a91)|`src/sage/misc/lazy_import.pyx: Update doctest`|



---

archive/issue_comments_666190.json:
```json
{
    "body": "<a id='comment:6'></a>\nThe failure in \"Build&Test\" is in `sage -t --random-seed=54174803604868423169944467131116599504 sage/parallel/map_reduce.py `, unrelated.",
    "created_at": "2022-05-09T17:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666190",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
The failure in "Build&Test" is in `sage -t --random-seed=54174803604868423169944467131116599504 sage/parallel/map_reduce.py `, unrelated.



---

archive/issue_comments_666191.json:
```json
{
    "body": "Changing commit from \"b39cf31719c3e62ee35d1ba3fe72852d86551a91\" to \"897e103a6c78e98aa1ce809a166cb9e90cd580c7\"",
    "created_at": "2022-05-10T05:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b39cf31719c3e62ee35d1ba3fe72852d86551a91" to "897e103a6c78e98aa1ce809a166cb9e90cd580c7"



---

archive/issue_comments_666192.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------|\n|[b004ca9](https://github.com/sagemath/sagetrac-mirror/commit/b004ca9dea6f95d0705b9521b1e6195d2e10f1a7)|`src/sage/misc/cachefunc.pyx: Do not fail if sage.env cannot be imported`|\n|[897e103](https://github.com/sagemath/sagetrac-mirror/commit/897e103a6c78e98aa1ce809a166cb9e90cd580c7)|`src/sage/sets/set_from_iterator.py: Do not fail if sage.env cannot be imported`|",
    "created_at": "2022-05-10T05:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666192",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------|
|[b004ca9](https://github.com/sagemath/sagetrac-mirror/commit/b004ca9dea6f95d0705b9521b1e6195d2e10f1a7)|`src/sage/misc/cachefunc.pyx: Do not fail if sage.env cannot be imported`|
|[897e103](https://github.com/sagemath/sagetrac-mirror/commit/897e103a6c78e98aa1ce809a166cb9e90cd580c7)|`src/sage/sets/set_from_iterator.py: Do not fail if sage.env cannot be imported`|



---

archive/issue_comments_666193.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-part of Meta-ticket #33037\n+part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)\n``````\n",
    "created_at": "2022-05-12T01:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666193",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-part of Meta-ticket #33037
+part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)
``````




---

archive/issue_comments_666194.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n+We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).\n+\n+We change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that \n+- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty\n+- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)\n+\n part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)\n``````\n",
    "created_at": "2022-05-12T01:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666194",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,7 @@
+We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).
+
+We change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that 
+- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty
+- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)
+
 part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)
``````




---

archive/issue_comments_666195.json:
```json
{
    "body": "<a id='comment:11'></a>\nYou have a repeated block\n\n```\n+                def directories():\n+                    try:\n+                        from sage.env import SAGE_SRC\n+                    except ImportError:\n+                        pass\n+                    else:\n+                        if SAGE_SRC:\n+                            yield normpath(os.path.join(SAGE_SRC, 'sage'))\n+                    import sage\n+                    yield from sage.__path__\n+\n+                for directory in directories():\n+                    if commonprefix([filename, directory]) == directory:\n+                        filename = os.path.join('sage', relpath(filename, directory))\n+                        break\n```\nIf it ends up being useful in more than two files, should it be factored somewhere?",
    "created_at": "2022-06-12T21:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666195",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>
You have a repeated block

```
+                def directories():
+                    try:
+                        from sage.env import SAGE_SRC
+                    except ImportError:
+                        pass
+                    else:
+                        if SAGE_SRC:
+                            yield normpath(os.path.join(SAGE_SRC, 'sage'))
+                    import sage
+                    yield from sage.__path__
+
+                for directory in directories():
+                    if commonprefix([filename, directory]) == directory:
+                        filename = os.path.join('sage', relpath(filename, directory))
+                        break
```
If it ends up being useful in more than two files, should it be factored somewhere?



---

archive/issue_comments_666196.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------|\n|[53154b3](https://github.com/sagemath/sagetrac-mirror/commit/53154b38bc26e9dbf054c1dc26c6dbcd0402c95d)|`Merge tag '9.7.beta3' into t/33821/remove_use_of_sage_lib_in_sage_misc`|\n|[748d9fb](https://github.com/sagemath/sagetrac-mirror/commit/748d9fbe54bda2b9529053d261ba12ba168f6a81)|`sage.misc.sageinspect.sage_getfile_relative: New, use it in sage.misc.cachefunc, sage.sets.set_from_iterator.Decorator`|",
    "created_at": "2022-06-25T22:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------|
|[53154b3](https://github.com/sagemath/sagetrac-mirror/commit/53154b38bc26e9dbf054c1dc26c6dbcd0402c95d)|`Merge tag '9.7.beta3' into t/33821/remove_use_of_sage_lib_in_sage_misc`|
|[748d9fb](https://github.com/sagemath/sagetrac-mirror/commit/748d9fbe54bda2b9529053d261ba12ba168f6a81)|`sage.misc.sageinspect.sage_getfile_relative: New, use it in sage.misc.cachefunc, sage.sets.set_from_iterator.Decorator`|



---

archive/issue_comments_666197.json:
```json
{
    "body": "Changing commit from \"897e103a6c78e98aa1ce809a166cb9e90cd580c7\" to \"748d9fbe54bda2b9529053d261ba12ba168f6a81\"",
    "created_at": "2022-06-25T22:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "897e103a6c78e98aa1ce809a166cb9e90cd580c7" to "748d9fbe54bda2b9529053d261ba12ba168f6a81"



---

archive/issue_comments_666198.json:
```json
{
    "body": "<a id='comment:13'></a>\nGood suggestion, done now",
    "created_at": "2022-06-25T22:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666198",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
Good suggestion, done now



---

archive/issue_comments_666199.json:
```json
{
    "body": "<a id='comment:14'></a>\nLGTM, let's ship it.",
    "created_at": "2022-06-25T23:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666199",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
LGTM, let's ship it.



---

archive/issue_comments_666200.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-06-25T23:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666200",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_666201.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fran\u00e7ois Bissey\"",
    "created_at": "2022-06-25T23:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666201",
    "user": "https://github.com/kiwifb"
}
```

Changing reviewer from "" to "Fran√ßois Bissey"



---

archive/issue_comments_666202.json:
```json
{
    "body": "<a id='comment:15'></a>\nThanks!",
    "created_at": "2022-06-25T23:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666202",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Thanks!



---

archive/issue_comments_666203.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-03T22:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666203",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_107863.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-07-03T22:06:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33821#event-107863"
}
```



---

archive/issue_comments_666204.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/remove_use_of_sage_lib_in_sage_misc\" to \"748d9fbe54bda2b9529053d261ba12ba168f6a81\"",
    "created_at": "2022-07-03T22:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-666204",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/remove_use_of_sage_lib_in_sage_misc" to "748d9fbe54bda2b9529053d261ba12ba168f6a81"
