# Issue 33821: Remove use of SAGE_LIB in sage.misc

archive/issues_033584.json:
```json
{
    "body": "We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).\n\nWe change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that \n- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty\n- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)\n\npart of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)\n\nCC:  @kiwifb @antonio-rojas @tornaria\n\nBranch/Commit: 748d9fbe54bda2b9529053d261ba12ba168f6a81\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Matthias Koeppe\n\nDependencies: #33793\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33821\n\n",
    "closed_at": "2022-07-03T22:06:02Z",
    "created_at": "2022-05-08T03:39:41Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Remove use of SAGE_LIB in sage.misc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33821",
    "user": "https://github.com/mkoeppe"
}
```
We delay importing `lazy_import_cache` until a lazy star import is done (which the Sage library never does).

We change two copies of essentially the same code that tries to use `SAGE_SRC` and `SAGE_LIB` to turn a source filename to a qualified package name so that 
- it does not fail when `sage.env.SAGE_SRC` cannot be imported or is empty
- it replaces the use of `SAGE_LIB` by using `sage.__path__` (to handle namespace packages correctly)

part of Meta-ticket #33037 (Remove use of `SAGE_LIB` and `SAGE_EXTCODE` variables)

CC:  @kiwifb @antonio-rojas @tornaria

Branch/Commit: 748d9fbe54bda2b9529053d261ba12ba168f6a81

Reviewer: Fran√ßois Bissey

Author: Matthias Koeppe

Dependencies: #33793

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33821





---

archive/issue_comments_477432.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-08T04:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477432",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477433.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-08T04:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477433",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_477434.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-08T18:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477434",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477435.json:
```json
{
    "body": "<a id='comment:6'></a>The failure in \"Build&Test\" is in `sage -t --random-seed=54174803604868423169944467131116599504 sage/parallel/map_reduce.py `, unrelated.",
    "created_at": "2022-05-09T17:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477435",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>The failure in "Build&Test" is in `sage -t --random-seed=54174803604868423169944467131116599504 sage/parallel/map_reduce.py `, unrelated.



---

archive/issue_comments_477436.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-10T05:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477436",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477437.json:
```json
{
    "body": "<a id='comment:11'></a>You have a repeated block\n\n```\n+                def directories():\n+                    try:\n+                        from sage.env import SAGE_SRC\n+                    except ImportError:\n+                        pass\n+                    else:\n+                        if SAGE_SRC:\n+                            yield normpath(os.path.join(SAGE_SRC, 'sage'))\n+                    import sage\n+                    yield from sage.__path__\n+\n+                for directory in directories():\n+                    if commonprefix([filename, directory]) == directory:\n+                        filename = os.path.join('sage', relpath(filename, directory))\n+                        break\n```\nIf it ends up being useful in more than two files, should it be factored somewhere?",
    "created_at": "2022-06-12T21:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477437",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>You have a repeated block

```
+                def directories():
+                    try:
+                        from sage.env import SAGE_SRC
+                    except ImportError:
+                        pass
+                    else:
+                        if SAGE_SRC:
+                            yield normpath(os.path.join(SAGE_SRC, 'sage'))
+                    import sage
+                    yield from sage.__path__
+
+                for directory in directories():
+                    if commonprefix([filename, directory]) == directory:
+                        filename = os.path.join('sage', relpath(filename, directory))
+                        break
```
If it ends up being useful in more than two files, should it be factored somewhere?



---

archive/issue_comments_477438.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-25T22:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477438",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477439.json:
```json
{
    "body": "<a id='comment:13'></a>Good suggestion, done now",
    "created_at": "2022-06-25T22:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477439",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Good suggestion, done now



---

archive/issue_comments_477440.json:
```json
{
    "body": "<a id='comment:14'></a>LGTM, let's ship it.",
    "created_at": "2022-06-25T23:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477440",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>LGTM, let's ship it.



---

archive/issue_comments_477441.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-06-25T23:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477441",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_477442.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks!",
    "created_at": "2022-06-25T23:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477442",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Thanks!



---

archive/issue_comments_477443.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-03T22:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33821#issuecomment-477443",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088808.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-07-03T22:06:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33821",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33821#event-88808"
}
```
