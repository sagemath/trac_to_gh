# Issue 33422: Bug in equivalence_decomposition of inductive valuation

archive/issues_033185.json:
```json
{
    "body": "The following application of sage.rings.valuation.inductive_valuation.py's method `equivalence_decomposition` produces an assertion error, see [https://github.com/MCLF/mclf/issues/109](https://github.com/MCLF/mclf/issues/109).\n\n```\nsage: R.<x> = QQ[]\nsage: v_7 = QQ.valuation(7)\nsage: v0 = GaussValuation(R, v_7)\nsage: v1 = v0.augmentation(x, 3/2)\nsage: v2 = v1.augmentation(x^2-686, 7/2)\nsage: f = x^4 - 8001504*x^2 - 592815428352\nsage: v2.equivalence_decomposition(f)\n```\n\nThe error comes from the assertion \n\n```\nassert self.is_equivalent(ret.prod(), f)\n```\nwhere the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.\n\nThe problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. \n\nIn this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.\n\nCC:  @saraedum swewers\n\nKeywords: valuation, maclane\n\nBranch/Commit: d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35\n\nReviewer: Julian R\u00fcth\n\nAuthor: Ole Ossen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33422\n\n",
    "closed_at": "2022-04-02T10:52:27Z",
    "created_at": "2022-02-27T20:22:24Z",
    "labels": [
        "component: commutative algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Bug in equivalence_decomposition of inductive valuation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33422",
    "user": "https://github.com/oossen"
}
```
The following application of sage.rings.valuation.inductive_valuation.py's method `equivalence_decomposition` produces an assertion error, see [https://github.com/MCLF/mclf/issues/109](https://github.com/MCLF/mclf/issues/109).

```
sage: R.<x> = QQ[]
sage: v_7 = QQ.valuation(7)
sage: v0 = GaussValuation(R, v_7)
sage: v1 = v0.augmentation(x, 3/2)
sage: v2 = v1.augmentation(x^2-686, 7/2)
sage: f = x^4 - 8001504*x^2 - 592815428352
sage: v2.equivalence_decomposition(f)
```

The error comes from the assertion 

```
assert self.is_equivalent(ret.prod(), f)
```
where the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.

The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 

In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.

CC:  @saraedum swewers

Keywords: valuation, maclane

Branch/Commit: d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35

Reviewer: Julian Rüth

Author: Ole Ossen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33422





---

archive/issue_comments_666378.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n ```\n where the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.\n \n-The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in lift_to_key. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. \n+The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. \n \n In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.\n \n``````\n",
    "created_at": "2022-02-27T20:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666378",
    "user": "https://github.com/oossen"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 ```
 where the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.
 
-The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in lift_to_key. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 
+The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 
 
 In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.
 
``````




---

archive/issue_comments_666379.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-oossen/bug_in_equivalence_decomposition_of_inductive_valuation\"",
    "created_at": "2022-03-06T11:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666379",
    "user": "https://github.com/oossen"
}
```

Changing branch from "" to "u/gh-oossen/bug_in_equivalence_decomposition_of_inductive_valuation"



---

archive/issue_comments_666380.json:
```json
{
    "body": "<a id='comment:4'></a>\nExplanation of the change:\n\nThe method described in `lift_to_key` lifts an irreducible factor of the reduction and then essentially multiplies it with the polynomial called \\phi_k<sup>{\\tau\\sharp}</sup> by MacLane. `equivalence_decomposition` just wants to keep track of this change in unit by multiplying with an element of appropriate valuation, but that's not the right choice in general. Instead we can just multiply with the right power of the reciprocal \\phi_k<sup>{\\tau\\flat}</sup> (which has its own method in Sage, `_Q_reciprocal`).\n\n---\nNew commits:\n|                                                                                                                                          |                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[d3a77f5](https://git.sagemath.org/sage.git/commit?id=d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35)|`Fix, and additional doctest for bug in equivalence decomposition`|",
    "created_at": "2022-03-06T11:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666380",
    "user": "https://github.com/oossen"
}
```

<a id='comment:4'></a>
Explanation of the change:

The method described in `lift_to_key` lifts an irreducible factor of the reduction and then essentially multiplies it with the polynomial called \phi_k<sup>{\tau\sharp}</sup> by MacLane. `equivalence_decomposition` just wants to keep track of this change in unit by multiplying with an element of appropriate valuation, but that's not the right choice in general. Instead we can just multiply with the right power of the reciprocal \phi_k<sup>{\tau\flat}</sup> (which has its own method in Sage, `_Q_reciprocal`).

---
New commits:
|                                                                                                                                          |                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[d3a77f5](https://git.sagemath.org/sage.git/commit?id=d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35)|`Fix, and additional doctest for bug in equivalence decomposition`|



---

archive/issue_comments_666381.json:
```json
{
    "body": "Changing commit from \"\" to \"d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35\"",
    "created_at": "2022-03-06T11:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666381",
    "user": "https://github.com/oossen"
}
```

Changing commit from "" to "d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35"



---

archive/issue_comments_666382.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-06T11:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666382",
    "user": "https://github.com/oossen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_666383.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-13T20:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666383",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_666384.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Julian R\u00fcth\"",
    "created_at": "2022-03-13T20:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666384",
    "user": "https://github.com/saraedum"
}
```

Changing reviewer from "" to "Julian Rüth"



---

archive/issue_comments_666385.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,5 +20,3 @@\n The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. \n \n In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.\n-\n-I have a fix for it and will implement it in a branch asap.\n``````\n",
    "created_at": "2022-03-13T20:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666385",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,5 +20,3 @@
 The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in `lift_to_key`. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 
 
 In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.
-
-I have a fix for it and will implement it in a branch asap.
``````




---

archive/issue_events_088121.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:52:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33422#event-88121"
}
```



---

archive/issue_comments_666386.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666386",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_666387.json:
```json
{
    "body": "Changing branch from \"u/gh-oossen/bug_in_equivalence_decomposition_of_inductive_valuation\" to \"d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35\"",
    "created_at": "2022-04-02T10:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33422#issuecomment-666387",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-oossen/bug_in_equivalence_decomposition_of_inductive_valuation" to "d3a77f59c8c0b8b9ab99cc8a42fc4eea43b95b35"
