# Issue 33125: 'make -n TARGET' is broken

archive/issues_032888.json:
```json
{
    "assignees": [],
    "body": "`make -n sagelib` should only print, not run, commands.\n\nLikewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting \"Nothing to do\".\n\nBroken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n\nThat `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.\n\nDepends on #33130\n\nCC:  @orlitzky\n\nBranch: **[u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33125_\n\n",
    "created_at": "2022-01-06T21:58:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "'make -n TARGET' is broken",
    "type": "issue",
    "updated_at": "2023-01-07T21:39:40Z",
    "url": "https://github.com/sagemath/sage/issues/33125",
    "user": "https://github.com/mkoeppe"
}
```
`make -n sagelib` should only print, not run, commands.

Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting "Nothing to do".

Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.

That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.

Depends on #33130

CC:  @orlitzky

Branch: **[u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)**

_Issue created by migration from https://trac.sagemath.org/ticket/33125_





---

archive/issue_events_423114.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T21:58:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423114"
}
```



---

archive/issue_events_423115.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T21:58:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423115"
}
```



---

archive/issue_events_423116.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T21:58:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423116"
}
```



---

archive/issue_events_423117.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T21:58:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423117"
}
```



---

archive/issue_comments_538245.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n \n``````\n",
    "created_at": "2022-01-06T22:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538245",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
 
``````




---

archive/issue_events_423118.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T22:30:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423118"
}
```



---

archive/issue_events_423119.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T22:30:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423119"
}
```



---

archive/issue_comments_538246.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n \n``````\n",
    "created_at": "2022-01-06T22:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538246",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
 
``````




---

archive/issue_comments_538247.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting \"Nothing to do\".\n \n+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n+\n+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.\n``````\n",
    "created_at": "2022-01-06T22:36:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538247",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting "Nothing to do".
 
+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.
+
+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.
``````




---

archive/issue_events_423120.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T22:36:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423120"
}
```



---

archive/issue_events_423121.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-06T22:36:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423121"
}
```



---

archive/issue_comments_538248.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,4 +4,4 @@\n \n Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n \n-That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.\n+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.\n``````\n",
    "created_at": "2022-01-07T04:17:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538248",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,4 +4,4 @@
 
 Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.
 
-That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.
+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.
``````




---

archive/issue_comments_538249.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nA solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile",
    "created_at": "2022-01-07T20:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538249",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'>Comment 5:</a>
A solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile



---

archive/issue_comments_538250.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIsn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?\n\nFor example, this fixes `make -n sagelib` for me:\n\n```patch\ndiff --git a/Makefile b/Makefile\nindex 444e4f9e4a..9505152830 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -37,7 +37,7 @@ sageruntime: base-toolchain\n \t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n \t$(MAKE) build/make/Makefile --stop\n \t+build/bin/sage-logger \\\n-\t\t\"cd build/make && ./install '$@'\" logs/install.log\n+\t\t\"cd build/make && MAKE=\\\"$(MAKE)\\\" MAKEFLAGS=\\\"$(MAKEFLAGS)\\\" ./install '$@'\" logs/install.log\n \n # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;\n # except for build/make/Makefile-auto, which is unused by the build system\n```",
    "created_at": "2022-01-07T22:47:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538250",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'>Comment 6:</a>
Isn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?

For example, this fixes `make -n sagelib` for me:

```patch
diff --git a/Makefile b/Makefile
index 444e4f9e4a..9505152830 100644
--- a/Makefile
+++ b/Makefile
@@ -37,7 +37,7 @@ sageruntime: base-toolchain
 	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
 	$(MAKE) build/make/Makefile --stop
 	+build/bin/sage-logger \
-		"cd build/make && ./install '$@'" logs/install.log
+		"cd build/make && MAKE=\"$(MAKE)\" MAKEFLAGS=\"$(MAKEFLAGS)\" ./install '$@'" logs/install.log
 
 # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;
 # except for build/make/Makefile-auto, which is unused by the build system
```



---

archive/issue_comments_538251.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nDid you test this on top of #32759?",
    "created_at": "2022-01-07T22:49:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538251",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>Comment 7:</a>
Did you test this on top of #32759?



---

archive/issue_comments_538252.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nNo, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.",
    "created_at": "2022-01-07T22:50:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538252",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'>Comment 8:</a>
No, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.



---

archive/issue_comments_538253.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [@mkoeppe](#comment%3A7):\n> Did you test this on top of #32759?\n\nNo, but the problem with `make -n sagelib` already exists in beta9.",
    "created_at": "2022-01-07T23:04:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538253",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [@mkoeppe](#comment%3A7):
> Did you test this on top of #32759?

No, but the problem with `make -n sagelib` already exists in beta9.



---

archive/issue_events_423122.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423122"
}
```



---

archive/issue_events_423123.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423123"
}
```



---

archive/issue_events_423124.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423124"
}
```



---

archive/issue_events_423125.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423125"
}
```



---

archive/issue_comments_538254.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nOK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.\n\nBut there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.\n\nLet's address the broader problem in Sage 9.6.",
    "created_at": "2022-01-08T06:51:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538254",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'>Comment 10:</a>
OK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.

But there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.

Let's address the broader problem in Sage 9.6.



---

archive/issue_comments_538255.json:
```json
{
    "body": "Changed dependencies from **#32759** to **#33130**",
    "created_at": "2022-01-08T06:51:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538255",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32759** to **#33130**



---

archive/issue_comments_538256.json:
```json
{
    "body": "Branch: **[u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)**",
    "created_at": "2022-01-09T18:15:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33125#issuecomment-538256",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)**



---

archive/issue_events_423126.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423126"
}
```



---

archive/issue_events_423127.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423127"
}
```



---

archive/issue_events_423128.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423128"
}
```



---

archive/issue_events_423129.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423129"
}
```



---

archive/issue_events_423130.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-07T21:39:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423130"
}
```



---

archive/issue_events_423131.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-07T21:39:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33125",
    "milestone_number": null,
    "milestone_title": "sage-9.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33125#event-423131"
}
```
