# Issue 33125: 'make -n TARGET' is broken

archive/issues_032888.json:
```json
{
    "body": "`make -n sagelib` should only print, not run, commands.\n\nLikewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting \"Nothing to do\".\n\nBroken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n\nThat `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.\n\n**CC:**  @orlitzky\n\n**Branch:** [u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)\n\n**Status:** new\n\n**Dependencies:** #33130\n\nIssue created by migration from https://trac.sagemath.org/ticket/33125\n\n",
    "created_at": "2022-01-06T21:58:01Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "'make -n TARGET' is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33125",
    "user": "https://github.com/mkoeppe"
}
```
`make -n sagelib` should only print, not run, commands.

Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting "Nothing to do".

Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.

That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.

**CC:**  @orlitzky

**Branch:** [u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)

**Status:** new

**Dependencies:** #33130

Issue created by migration from https://trac.sagemath.org/ticket/33125





---

archive/issue_comments_660744.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n \n``````\n",
    "created_at": "2022-01-06T22:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660744",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
 
``````




---

archive/issue_events_098450.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98450"
}
```



---

archive/issue_comments_660745.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n \n``````\n",
    "created_at": "2022-01-06T22:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660745",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken by #29013/#32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
 
``````




---

archive/issue_comments_660746.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n `make -n sagelib` should only print, not run, commands.\n \n-Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n+Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting \"Nothing to do\".\n \n+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n+\n+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.\n``````\n",
    "created_at": "2022-01-06T22:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660746",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
 `make -n sagelib` should only print, not run, commands.
 
-Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules
+Likewise `make -q sagelib` should not run commands. As this is used in `build/make/install` with output suppressed, this sometimes leads to `sage -b` silently doing the rebuild and then reporting "Nothing to do".
 
+Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.
+
+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.
``````




---

archive/issue_events_098451.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98451"
}
```



---

archive/issue_events_098452.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98452"
}
```



---

archive/issue_comments_660747.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,4 @@\n \n Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.\n \n-That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.\n+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.\n``````\n",
    "created_at": "2022-01-07T04:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660747",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,4 @@
 
 Broken for normal packages already in Sage 9.0; broken for script packages by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules for script packages.
 
-That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, -q`, `-t` handling.
+That `+` appears there is motivated by intended jobserver behavior; but unfortunately it also influences `-n`, `-q`, `-t` handling.
``````




---

archive/issue_comments_660748.json:
```json
{
    "body": "<a id='comment:5'></a>\nA solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile",
    "created_at": "2022-01-07T20:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660748",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
A solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile



---

archive/issue_comments_660749.json:
```json
{
    "body": "<a id='comment:6'></a>\nIsn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?\n\nFor example, this fixes `make -n sagelib` for me:\n\n```patch\ndiff --git a/Makefile b/Makefile\nindex 444e4f9e4a..9505152830 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -37,7 +37,7 @@ sageruntime: base-toolchain\n \t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n \t$(MAKE) build/make/Makefile --stop\n \t+build/bin/sage-logger \\\n-\t\t\"cd build/make && ./install '$@'\" logs/install.log\n+\t\t\"cd build/make && MAKE=\\\"$(MAKE)\\\" MAKEFLAGS=\\\"$(MAKEFLAGS)\\\" ./install '$@'\" logs/install.log\n \n # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;\n # except for build/make/Makefile-auto, which is unused by the build system\n```",
    "created_at": "2022-01-07T22:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660749",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>
Isn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?

For example, this fixes `make -n sagelib` for me:

```patch
diff --git a/Makefile b/Makefile
index 444e4f9e4a..9505152830 100644
--- a/Makefile
+++ b/Makefile
@@ -37,7 +37,7 @@ sageruntime: base-toolchain
 	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
 	$(MAKE) build/make/Makefile --stop
 	+build/bin/sage-logger \
-		"cd build/make && ./install '$@'" logs/install.log
+		"cd build/make && MAKE=\"$(MAKE)\" MAKEFLAGS=\"$(MAKEFLAGS)\" ./install '$@'" logs/install.log
 
 # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;
 # except for build/make/Makefile-auto, which is unused by the build system
```



---

archive/issue_comments_660750.json:
```json
{
    "body": "<a id='comment:7'></a>\nDid you test this on top of #32759?",
    "created_at": "2022-01-07T22:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660750",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Did you test this on top of #32759?



---

archive/issue_comments_660751.json:
```json
{
    "body": "<a id='comment:8'></a>\nNo, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.",
    "created_at": "2022-01-07T22:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660751",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
No, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.



---

archive/issue_comments_660752.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [mkoeppe](#comment%3A7):\n> Did you test this on top of #32759?\n\n\nNo, but the problem with `make -n sagelib` already exists in beta9.",
    "created_at": "2022-01-07T23:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660752",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'></a>
Replying to [mkoeppe](#comment%3A7):
> Did you test this on top of #32759?


No, but the problem with `make -n sagelib` already exists in beta9.



---

archive/issue_comments_660753.json:
```json
{
    "body": "**Changing dependencies** from \"#32759\" to \"#33130\".",
    "created_at": "2022-01-08T06:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660753",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#32759" to "#33130".



---

archive/issue_comments_660754.json:
```json
{
    "body": "<a id='comment:10'></a>\nOK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.\n\nBut there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.\n\nLet's address the broader problem in Sage 9.6.",
    "created_at": "2022-01-08T06:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660754",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
OK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.

But there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.

Let's address the broader problem in Sage 9.6.



---

archive/issue_events_098453.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98453"
}
```



---

archive/issue_events_098454.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98454"
}
```



---

archive/issue_comments_660755.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)",
    "created_at": "2022-01-09T18:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33125#issuecomment-660755",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/_make__n_target__is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make__n_target__is_broken)



---

archive/issue_events_098455.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98455"
}
```



---

archive/issue_events_098456.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98456"
}
```



---

archive/issue_events_098457.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98457"
}
```



---

archive/issue_events_098458.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33125",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33125#event-98458"
}
```
