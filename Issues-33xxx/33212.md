# Issue 33212: Karatsuba multiplication of matrices:  failed test

archive/issues_032975.json:
```json
{
    "body": "This is for [SageMath](SageMath) version 9.5.rc3 built on two M1 Macs, one with macOS 11.6.2 (Big Sur) and the other with macOS 12.1 (Monterey).\n\nOne test in\n\n```\nsrc/sage/matrix/matrix_gf2e_dense.pyx\n```\nseems to fail consistently, namely\n\n```\nsage: K.<a> = GF(2^n)\nsage: A = random_matrix(K, 50, 50)\nsage: B = random_matrix(K, 50, 50)\nsage: A._multiply_karatsuba(B) == A._multiply_classical(B)\n```\nas soon as `n > 2`.\nIn fact, `A` and `B` appear to be completely different.\n\nI do not know how to deal with this, but I am available to test.\n\n\n**CC:**  @malb\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/33212\n\n",
    "created_at": "2022-01-21T20:20:04Z",
    "labels": [
        "component: linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Karatsuba multiplication of matrices:  failed test",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33212",
    "user": "https://github.com/GMS103"
}
```
This is for [SageMath](SageMath) version 9.5.rc3 built on two M1 Macs, one with macOS 11.6.2 (Big Sur) and the other with macOS 12.1 (Monterey).

One test in

```
src/sage/matrix/matrix_gf2e_dense.pyx
```
seems to fail consistently, namely

```
sage: K.<a> = GF(2^n)
sage: A = random_matrix(K, 50, 50)
sage: B = random_matrix(K, 50, 50)
sage: A._multiply_karatsuba(B) == A._multiply_classical(B)
```
as soon as `n > 2`.
In fact, `A` and `B` appear to be completely different.

I do not know how to deal with this, but I am available to test.


**CC:**  @malb

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/33212





---

archive/issue_comments_662468.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This is for [SageMath](SageMath) version 9.5.rc3 built on an M1 Mac with macOS 12.1 (Monterey).\n+This is for [SageMath](SageMath) version 9.5.rc3 built on two M1 Macs, one with macOS 11.6.2 (Big Sur) and the other with macOS 12.1 (Monterey).\n \n One test in\n \n``````\n",
    "created_at": "2022-01-21T21:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662468",
    "user": "https://github.com/GMS103"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This is for [SageMath](SageMath) version 9.5.rc3 built on an M1 Mac with macOS 12.1 (Monterey).
+This is for [SageMath](SageMath) version 9.5.rc3 built on two M1 Macs, one with macOS 11.6.2 (Big Sur) and the other with macOS 12.1 (Monterey).
 
 One test in
 
``````




---

archive/issue_comments_662469.json:
```json
{
    "body": "<a id='comment:3'></a>\nWorks on my x64 Linux. I assume the underlying reason is that M4RIE relies on some undefined behaviour that works \"as expected\" on x86-ish architectures? Can you compile M4RIE with all warnings on and then run the tests? Maybe it's already triggered there?",
    "created_at": "2022-01-22T11:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662469",
    "user": "https://github.com/malb"
}
```

<a id='comment:3'></a>
Works on my x64 Linux. I assume the underlying reason is that M4RIE relies on some undefined behaviour that works "as expected" on x86-ish architectures? Can you compile M4RIE with all warnings on and then run the tests? Maybe it's already triggered there?



---

archive/issue_comments_662470.json:
```json
{
    "body": "<a id='comment:4'></a>\nI have been able to compile M4RI and M4RIE (the former is needed for the latter).\n\nHowever, all checks fail for M4RIE.\n\nSee\n\nhttps://bitbucket.org/malb/m4ri/issues/83/trying-to-compile-on-apple-m1\n\nand\n\nhttps://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1\n\nHTH",
    "created_at": "2022-01-22T21:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662470",
    "user": "https://github.com/GMS103"
}
```

<a id='comment:4'></a>
I have been able to compile M4RI and M4RIE (the former is needed for the latter).

However, all checks fail for M4RIE.

See

https://bitbucket.org/malb/m4ri/issues/83/trying-to-compile-on-apple-m1

and

https://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1

HTH



---

archive/issue_comments_662471.json:
```json
{
    "body": "<a id='comment:5'></a>\nSo it seems to be an issue with M4RIE but not sure how to debug this. I've asked on sage-devel if others can reproduce it (I assume the answer is \"yes\", but still).",
    "created_at": "2022-01-24T19:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662471",
    "user": "https://github.com/malb"
}
```

<a id='comment:5'></a>
So it seems to be an issue with M4RIE but not sure how to debug this. I've asked on sage-devel if others can reproduce it (I assume the answer is "yes", but still).



---

archive/issue_comments_662472.json:
```json
{
    "body": "<a id='comment:6'></a>\nM4RIE works correctly on an Apple Silicon M1 Mac under macOS 12.3 (Monterey) with Xcode 13.3 (see https://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1):  the test in this ticket succeeds.\n\nThe bad news is that Xcode 13.3 is not available for macOS 11.6.5 (Monterey), the last available version being Xcode 13.2.1, which fails as indicated above.",
    "created_at": "2022-03-20T22:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662472",
    "user": "https://github.com/GMS103"
}
```

<a id='comment:6'></a>
M4RIE works correctly on an Apple Silicon M1 Mac under macOS 12.3 (Monterey) with Xcode 13.3 (see https://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1):  the test in this ticket succeeds.

The bad news is that Xcode 13.3 is not available for macOS 11.6.5 (Monterey), the last available version being Xcode 13.2.1, which fails as indicated above.



---

archive/issue_comments_662473.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks for tracking this down. We can compile with a lower optimisation level on those machines with a buggy compiler?",
    "created_at": "2022-03-26T10:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662473",
    "user": "https://github.com/malb"
}
```

<a id='comment:7'></a>
Thanks for tracking this down. We can compile with a lower optimisation level on those machines with a buggy compiler?



---

archive/issue_comments_662474.json:
```json
{
    "body": "<a id='comment:8'></a>\nIt should be possible, but I do not know how to do it when making [SageMath](SageMath).",
    "created_at": "2022-03-26T11:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33212#issuecomment-662474",
    "user": "https://github.com/GMS103"
}
```

<a id='comment:8'></a>
It should be possible, but I do not know how to do it when making [SageMath](SageMath).



---

archive/issue_events_098704.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33212#event-98704"
}
```



---

archive/issue_events_098705.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33212#event-98705"
}
```



---

archive/issue_events_098706.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33212",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33212#event-98706"
}
```
