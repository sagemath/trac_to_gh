# Issue 33256: buffer.py: make files readonly only when possible

archive/issues_033019.json:
```json
{
    "body": "After #31306 we have doctest failure on sage-on-distros because files have been moved out of `SAGE_EXTCODE`. In `sage/repl/rich_output/buffer.py` files are made readonly with `chmod` so they are immutable during the process. Unfortunately `chmod` fails when trying to act on system installed files as a regular user. There is a safety for files in `SAGE_EXTCODE`, this is a useless complication and should be replaced by a `try` block.\n\nCC:  @mkoeppe\n\nBranch/Commit: 2c3a14406a4c45ad5cf60bbf46a07d58bbbaeb18\n\nReviewer: Antonio Rojas\n\nAuthor: Fran\u00e7ois Bissey\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33256\n\n",
    "closed_at": "2022-02-16T23:57:25Z",
    "created_at": "2022-01-31T09:17:17Z",
    "labels": [
        "component: distribution",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "buffer.py: make files readonly only when possible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33256",
    "user": "https://github.com/kiwifb"
}
```
After #31306 we have doctest failure on sage-on-distros because files have been moved out of `SAGE_EXTCODE`. In `sage/repl/rich_output/buffer.py` files are made readonly with `chmod` so they are immutable during the process. Unfortunately `chmod` fails when trying to act on system installed files as a regular user. There is a safety for files in `SAGE_EXTCODE`, this is a useless complication and should be replaced by a `try` block.

CC:  @mkoeppe

Branch/Commit: 2c3a14406a4c45ad5cf60bbf46a07d58bbbaeb18

Reviewer: Antonio Rojas

Author: Fran√ßois Bissey

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33256





---

archive/issue_comments_502810.json:
```json
{
    "body": "<a id='comment:1'></a>While we may want to avoid error on file that are not changeable by the user, just a `try` doesn't reproduce the original intent\n\n```\n        if filename.startswith(os.path.abspath(SAGE_EXTCODE)):\n            # Do not change permissions on the sample rich output\n            # files, as it will cause trouble when upgrading Sage\n```\nShould the original block be preserved but with `SAGE_SRC` instead of `SAGE_EXTCODE`?",
    "created_at": "2022-01-31T09:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502810",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>While we may want to avoid error on file that are not changeable by the user, just a `try` doesn't reproduce the original intent

```
        if filename.startswith(os.path.abspath(SAGE_EXTCODE)):
            # Do not change permissions on the sample rich output
            # files, as it will cause trouble when upgrading Sage
```
Should the original block be preserved but with `SAGE_SRC` instead of `SAGE_EXTCODE`?



---

archive/issue_comments_502811.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2022-01-31T09:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502811",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_502812.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2022-01-31T09:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502812",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_502813.json:
```json
{
    "body": "<a id='comment:4'></a>I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.",
    "created_at": "2022-01-31T18:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502813",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.



---

archive/issue_comments_502814.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 mkoeppe]:\n> I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.\n\n\nThat's what I thought and why I switched the test to check for `SAGE_SRC` (it works as expected here). \n\nWhat about the other part of the branch which basically is about not failing if you cannot change the permissions outside of the source tree? The code wants to make sure the file that it is dealing with cannot be modified by changing its permission, but will fail when it cannot do so - in which case you probably cannot modify the file already.",
    "created_at": "2022-01-31T18:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502814",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>Replying to [comment:4 mkoeppe]:
> I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.


That's what I thought and why I switched the test to check for `SAGE_SRC` (it works as expected here). 

What about the other part of the branch which basically is about not failing if you cannot change the permissions outside of the source tree? The code wants to make sure the file that it is dealing with cannot be modified by changing its permission, but will fail when it cannot do so - in which case you probably cannot modify the file already.



---

archive/issue_comments_502815.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-01-31T19:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502815",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_502816.json:
```json
{
    "body": "<a id='comment:7'></a>Works fine here (also testing on installed package)",
    "created_at": "2022-02-06T22:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502816",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:7'></a>Works fine here (also testing on installed package)



---

archive/issue_comments_502817.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-06T22:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502817",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_502818.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks!",
    "created_at": "2022-02-06T23:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502818",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>Thanks!



---

archive/issue_events_087820.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-16T23:57:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33256#event-87820"
}
```



---

archive/issue_comments_502819.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-16T23:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33256",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33256#issuecomment-502819",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
