# Issue 33836: Bug in Lie algebra's chevalley_eilenberg_complex method

archive/issues_033599.json:
```json
{
    "body": "As pointed out in [this sage_devel thread](https://groups.google.com/g/sage-devel/c/geYKS4uXd5o/m/558F4-VrBQAJ), the Lie algebra method `chevalley_eilenberg_complex()` raises an exception in the following example:\n\n```\nsage: g = lie_algebras.sl(QQ,2)\nsage: E,F,H = g.basis()\nsage: n = g.subalgebra([F,H])\nsage: n.chevalley_eilenberg_complex()\nException raised by child process with pid=15420:\nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 1943, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10414)\n    return cache[k]\nKeyError: (None, False, True)\n\nDuring handling of the above exception, another exception occurred:\n    <snip>\n~/development/sage94/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/homology/chain_complex.py in <genexpr>(.0)\n    259             base_ring = ZZ\n    260         else:\n--> 261             bases = tuple(x.base_ring() for x in data_dict.values())\n    262             base_ring = coercion_model.common_parent(*bases)\n    263 \n\nAttributeError: 'str' object has no attribute 'base_ring'\n```\n\nCC:  @tscrim @fchapoton\n\nKeywords: Lie algebra\n\nReviewer: Sebastian Oehms\n\nAuthor: Travis Scrimshaw\n\nBranch: 8526fe9aa9a112c1a2286754f850c742a15e64af\n\nCommit: 8526fe9aa9a112c1a2286754f850c742a15e64af\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33836\n\n",
    "closed_at": "2022-08-06T07:44:11Z",
    "created_at": "2022-05-10T22:43:14Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Bug in Lie algebra's chevalley_eilenberg_complex method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33836",
    "user": "https://github.com/DaveWitteMorris"
}
```
As pointed out in [this sage_devel thread](https://groups.google.com/g/sage-devel/c/geYKS4uXd5o/m/558F4-VrBQAJ), the Lie algebra method `chevalley_eilenberg_complex()` raises an exception in the following example:

```
sage: g = lie_algebras.sl(QQ,2)
sage: E,F,H = g.basis()
sage: n = g.subalgebra([F,H])
sage: n.chevalley_eilenberg_complex()
Exception raised by child process with pid=15420:
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1943, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10414)
    return cache[k]
KeyError: (None, False, True)

During handling of the above exception, another exception occurred:
    <snip>
~/development/sage94/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/homology/chain_complex.py in <genexpr>(.0)
    259             base_ring = ZZ
    260         else:
--> 261             bases = tuple(x.base_ring() for x in data_dict.values())
    262             base_ring = coercion_model.common_parent(*bases)
    263 

AttributeError: 'str' object has no attribute 'base_ring'
```

CC:  @tscrim @fchapoton

Keywords: Lie algebra

Reviewer: Sebastian Oehms

Author: Travis Scrimshaw

Branch: 8526fe9aa9a112c1a2286754f850c742a15e64af

Commit: 8526fe9aa9a112c1a2286754f850c742a15e64af

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33836





---

archive/issue_comments_477662.json:
```json
{
    "body": "<a id='comment:1'></a>The `KeyError` does not seem to be a bug, because it arises in a `try` block (where the code is checking whether the desired value is available in the cache). The `AttributeError` is raised in the corresponding `except` block, and seems to reveal a genuine problem: at the time of this exception, `data_dict` is equal to `{1: [0 0], 2: 'NO DATA'}`.",
    "created_at": "2022-05-10T22:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477662",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>The `KeyError` does not seem to be a bug, because it arises in a `try` block (where the code is checking whether the desired value is available in the cache). The `AttributeError` is raised in the corresponding `except` block, and seems to reveal a genuine problem: at the time of this exception, `data_dict` is equal to `{1: [0 0], 2: 'NO DATA'}`.



---

archive/issue_comments_477663.json:
```json
{
    "body": "Changing keywords from \"lie algebra\" to \"Lie algebra\".",
    "created_at": "2022-05-10T22:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477663",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing keywords from "lie algebra" to "Lie algebra".



---

archive/issue_comments_477664.json:
```json
{
    "body": "<a id='comment:2'></a>Thanks for the summary. I will try to look at this next month; right now I am traveling and then I will be moving universities. If someone else is able to fix it, I can likely do a quick review. However, I likely won\u2019t have time to debug it for now.",
    "created_at": "2022-05-15T03:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477664",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>Thanks for the summary. I will try to look at this next month; right now I am traveling and then I will be moving universities. If someone else is able to fix it, I can likely do a quick review. However, I likely wonâ€™t have time to debug it for now.



---

archive/issue_comments_477665.json:
```json
{
    "body": "<a id='comment:3'></a>I have a little bit of time and I found the source of the bug: the `to_vector()` returns a vector based on the ambient space:\n\n```\nsage: n.an_element()\nh1\nsage: _.to_vector()\n(0, 1, 0)\n```\nWe don't want to change this as the (linear algebraic) model for this is a subspace of a vector space:\n\n```\nsage: _.parent()\nVector space of degree 3 and dimension 2 over Rational Field\nUser basis matrix:\n[0 1 0]\n[0 0 1]\n```\nSo we just need to remove an assumption that the length of the vector equals the dimension of the vector space.",
    "created_at": "2022-05-15T22:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477665",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>I have a little bit of time and I found the source of the bug: the `to_vector()` returns a vector based on the ambient space:

```
sage: n.an_element()
h1
sage: _.to_vector()
(0, 1, 0)
```
We don't want to change this as the (linear algebraic) model for this is a subspace of a vector space:

```
sage: _.parent()
Vector space of degree 3 and dimension 2 over Rational Field
User basis matrix:
[0 1 0]
[0 0 1]
```
So we just need to remove an assumption that the length of the vector equals the dimension of the vector space.



---

archive/issue_comments_477666.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-15T23:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477666",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_477667.json:
```json
{
    "body": "<a id='comment:4'></a>Okay, here is a fix that converts the vector to something of the correct length when working with a submodule. Timings (run with 1 core for more expressive timings):\n\n```\nsage: g = lie_algebras.sl(QQ,2)  # 3 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 16 ms, sys: 12 ms, total: 28 ms\nWall time: 68.4 ms\nsage: g = lie_algebras.sp(QQ,4)  # 10 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 24 ms, sys: 56 ms, total: 80 ms\nWall time: 612 ms\nChain complex with at most 11 nonzero terms over Rational Field\nsage: g = lie_algebras.sl(QQ,4)  # 15 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 35 s, sys: 188 ms, total: 35.1 s\nWall time: 1min 12s\n```\nversus before\n\n```\nsage: g = lie_algebras.sl(QQ,2)  # 3 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 16 ms, sys: 12 ms, total: 28 ms\nWall time: 67.2 ms\nsage: g = lie_algebras.sp(QQ,4)  # 10 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 36 ms, sys: 48 ms, total: 84 ms\nWall time: 577 ms\nsage: g = lie_algebras.sl(QQ,4)  # 15 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 31.8 s, sys: 124 ms, total: 31.9 s\nWall time: 1min 6s\n```\nSo there is some slowdown likely between 5-10%, but it can't be helped because the code needs to work.\n\n---\nNew commits:",
    "created_at": "2022-05-15T23:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477667",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Okay, here is a fix that converts the vector to something of the correct length when working with a submodule. Timings (run with 1 core for more expressive timings):

```
sage: g = lie_algebras.sl(QQ,2)  # 3 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 16 ms, sys: 12 ms, total: 28 ms
Wall time: 68.4 ms
sage: g = lie_algebras.sp(QQ,4)  # 10 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 24 ms, sys: 56 ms, total: 80 ms
Wall time: 612 ms
Chain complex with at most 11 nonzero terms over Rational Field
sage: g = lie_algebras.sl(QQ,4)  # 15 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 35 s, sys: 188 ms, total: 35.1 s
Wall time: 1min 12s
```
versus before

```
sage: g = lie_algebras.sl(QQ,2)  # 3 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 16 ms, sys: 12 ms, total: 28 ms
Wall time: 67.2 ms
sage: g = lie_algebras.sp(QQ,4)  # 10 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 36 ms, sys: 48 ms, total: 84 ms
Wall time: 577 ms
sage: g = lie_algebras.sl(QQ,4)  # 15 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 31.8 s, sys: 124 ms, total: 31.9 s
Wall time: 1min 6s
```
So there is some slowdown likely between 5-10%, but it can't be helped because the code needs to work.

---
New commits:



---

archive/issue_comments_477668.json:
```json
{
    "body": "<a id='comment:5'></a>See also #34006 for a related issue.",
    "created_at": "2022-06-17T02:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477668",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>See also #34006 for a related issue.



---

archive/issue_comments_477669.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-11T02:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477669",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477670.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:4 tscrim]:\n> So there is some slowdown likely between 5-10%,\n\n\nI'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:\n\nWith the ticket:\n\n```sage\nsage: g = lie_algebras.sl(QQ,2)  # 3 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 0 ns, sys: 18.4 ms, total: 18.4 ms\nWall time: 44.5 ms\nChain complex with at most 4 nonzero terms over Rational Field\nsage: g = lie_algebras.sp(QQ,4)  # 10 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 50.5 ms, sys: 30.1 ms, total: 80.6 ms\nWall time: 443 ms\nChain complex with at most 11 nonzero terms over Rational Field\nsage: g = lie_algebras.sl(QQ,4)  # 15 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 13.6 s, sys: 88 ms, total: 13.7 s\nWall time: 28.7 s\nChain complex with at most 16 nonzero terms over Rational Field\n```\n\n\nWithout the ticket:\n\n```sage\nsage: g = lie_algebras.sl(QQ,2)  # 3 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 11.1 ms, sys: 11.3 ms, total: 22.4 ms\nWall time: 52.8 ms\nChain complex with at most 4 nonzero terms over Rational Field\nsage: g = lie_algebras.sp(QQ,4)  # 10 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 58.4 ms, sys: 20.6 ms, total: 79 ms\nWall time: 435 ms\nChain complex with at most 11 nonzero terms over Rational Field\nsage: g = lie_algebras.sl(QQ,4)  # 15 dim\nsage: %time g.chevalley_eilenberg_complex(ncpus=1)\nCPU times: user 13.8 s, sys: 7.25 ms, total: 13.9 s\nWall time: 29 s\nChain complex with at most 16 nonzero terms over Rational Field\n```\n\nAnyway, you should add a test showing that the issue is fixed.",
    "created_at": "2022-07-26T13:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477670",
    "user": "https://github.com/soehms"
}
```

<a id='comment:7'></a>Replying to [comment:4 tscrim]:
> So there is some slowdown likely between 5-10%,


I'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:

With the ticket:

```sage
sage: g = lie_algebras.sl(QQ,2)  # 3 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 0 ns, sys: 18.4 ms, total: 18.4 ms
Wall time: 44.5 ms
Chain complex with at most 4 nonzero terms over Rational Field
sage: g = lie_algebras.sp(QQ,4)  # 10 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 50.5 ms, sys: 30.1 ms, total: 80.6 ms
Wall time: 443 ms
Chain complex with at most 11 nonzero terms over Rational Field
sage: g = lie_algebras.sl(QQ,4)  # 15 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 13.6 s, sys: 88 ms, total: 13.7 s
Wall time: 28.7 s
Chain complex with at most 16 nonzero terms over Rational Field
```


Without the ticket:

```sage
sage: g = lie_algebras.sl(QQ,2)  # 3 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 11.1 ms, sys: 11.3 ms, total: 22.4 ms
Wall time: 52.8 ms
Chain complex with at most 4 nonzero terms over Rational Field
sage: g = lie_algebras.sp(QQ,4)  # 10 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 58.4 ms, sys: 20.6 ms, total: 79 ms
Wall time: 435 ms
Chain complex with at most 11 nonzero terms over Rational Field
sage: g = lie_algebras.sl(QQ,4)  # 15 dim
sage: %time g.chevalley_eilenberg_complex(ncpus=1)
CPU times: user 13.8 s, sys: 7.25 ms, total: 13.9 s
Wall time: 29 s
Chain complex with at most 16 nonzero terms over Rational Field
```

Anyway, you should add a test showing that the issue is fixed.



---

archive/issue_comments_477671.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-02T01:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477671",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477672.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 soehms]:\n> Replying to [comment:4 tscrim]:\n> > So there is some slowdown likely between 5-10%,\n\n> \n> I'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:\n\n\nHmm...interesting. Well, either way, a bug has been fixed.\n\n> Anyway, you should add a test showing that the issue is fixed.\n\n\nDone. I also made one other small tweak for speed.",
    "created_at": "2022-08-02T01:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477672",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Replying to [comment:7 soehms]:
> Replying to [comment:4 tscrim]:
> > So there is some slowdown likely between 5-10%,

> 
> I'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:


Hmm...interesting. Well, either way, a bug has been fixed.

> Anyway, you should add a test showing that the issue is fixed.


Done. I also made one other small tweak for speed.



---

archive/issue_comments_477673.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 tscrim]:\n> Replying to [comment:7 soehms]:\n> > Replying to [comment:4 tscrim]:\n> > > So there is some slowdown likely between 5-10%,\n\n> > \n> > I'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:\n\n> \n> Hmm...interesting. Well, either way, a bug has been fixed.\n> \n> > Anyway, you should add a test showing that the issue is fixed.\n\n> \n> Done. I also made one other small tweak for speed.\n\n\nLGTM! Once there is a green patchbot we can set positive review-",
    "created_at": "2022-08-02T14:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477673",
    "user": "https://github.com/soehms"
}
```

<a id='comment:10'></a>Replying to [comment:9 tscrim]:
> Replying to [comment:7 soehms]:
> > Replying to [comment:4 tscrim]:
> > > So there is some slowdown likely between 5-10%,

> > 
> > I'm wondering about that! There is only one `if` condition on a `boolean` in addition (of course in a long `for` loop). Maybe this 5-10% have been caused by some external influences. I repeated your test (on an i7 CPU running under WSL). The first and the last example were even slower without the ticket:

> 
> Hmm...interesting. Well, either way, a bug has been fixed.
> 
> > Anyway, you should add a test showing that the issue is fixed.

> 
> Done. I also made one other small tweak for speed.


LGTM! Once there is a green patchbot we can set positive review-



---

archive/issue_comments_477674.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-04T06:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477674",
    "user": "https://github.com/soehms"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_477675.json:
```json
{
    "body": "<a id='comment:11'></a>> Once there is a green patchbot we can set positive review\n\n\nNow, there is just one failure in the current patchbot log-file which is obviously unrelated to the ticket.",
    "created_at": "2022-08-04T06:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477675",
    "user": "https://github.com/soehms"
}
```

<a id='comment:11'></a>> Once there is a green patchbot we can set positive review


Now, there is just one failure in the current patchbot log-file which is obviously unrelated to the ticket.



---

archive/issue_comments_477676.json:
```json
{
    "body": "<a id='comment:12'></a>Thank you.",
    "created_at": "2022-08-04T08:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477676",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Thank you.



---

archive/issue_events_088825.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-06T07:44:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33836#event-88825"
}
```



---

archive/issue_comments_477677.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-06T07:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33836#issuecomment-477677",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
