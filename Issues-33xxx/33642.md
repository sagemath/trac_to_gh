# Issue 33642: Update build/pkgs/matplotlib/install-requires.txt and distros/conda.txt

archive/issues_033405.json:
```json
{
    "body": "(from #33491#comment:6)\n\n(from #33331): Failures with conda install:\n\n- matplotlib distutils classes\n\n```\n/usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/matplotlib/__init__.py:169: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n      if LooseVersion(module.__version__) < minver:\n    /usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/setuptools/_distutils/version.py:351: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n      other = LooseVersion(other)\n```\nShould be fixed by https://github.com/matplotlib/matplotlib/pull/21073, which is in included in matplotlib 3.5.1 (but for some reason conda installs only 3.3.2, to be investigated)\n\n- matplotlib colormaps\n\n```\n     sage.repl.rich_output.display_manager.RichReprWarning: Exception in _rich_repr_ while displaying object: cannot import name 'colormaps' from 'matplotlib' (/usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/matplotlib/__init__.py)\n```\nProbably introduced by #33491.\n\n\nCC:  davidlowry @tobiasdiez @mwageringel @tscrim @dimpase @isuruf\n\nReviewer: Dima Pasechnik, Tobias Diez\n\nAuthor: Matthias Koeppe\n\nBranch: aafa2d779e8e505464eab666d9d89b93dc02651f\n\nCommit: aafa2d779e8e505464eab666d9d89b93dc02651f\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33642\n\n",
    "closed_at": "2022-04-10T13:12:52Z",
    "created_at": "2022-04-04T19:18:27Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Update build/pkgs/matplotlib/install-requires.txt and distros/conda.txt",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33642",
    "user": "https://github.com/mkoeppe"
}
```
(from #33491#comment:6)

(from #33331): Failures with conda install:

- matplotlib distutils classes

```
/usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/matplotlib/__init__.py:169: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
      if LooseVersion(module.__version__) < minver:
    /usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/setuptools/_distutils/version.py:351: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
      other = LooseVersion(other)
```
Should be fixed by https://github.com/matplotlib/matplotlib/pull/21073, which is in included in matplotlib 3.5.1 (but for some reason conda installs only 3.3.2, to be investigated)

- matplotlib colormaps

```
     sage.repl.rich_output.display_manager.RichReprWarning: Exception in _rich_repr_ while displaying object: cannot import name 'colormaps' from 'matplotlib' (/usr/share/miniconda/envs/sage-build/lib/python3.8/site-packages/matplotlib/__init__.py)
```
Probably introduced by #33491.


CC:  davidlowry @tobiasdiez @mwageringel @tscrim @dimpase @isuruf

Reviewer: Dima Pasechnik, Tobias Diez

Author: Matthias Koeppe

Branch: aafa2d779e8e505464eab666d9d89b93dc02651f

Commit: aafa2d779e8e505464eab666d9d89b93dc02651f

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33642





---

archive/issue_comments_474990.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-04T20:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474990",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474991.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2022-04-04T20:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474991",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_474992.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-04T20:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474993.json:
```json
{
    "body": "<a id='comment:6'></a>The conda distribution file probably needs to be changed as well. However, requiring `matplotlib >=3.5.1` with python < 3.10 doesn't seem to work with conda, or at least in my initial tests the python version always got upgraded as well (might be easy to fix, but I don't have the time right now to look closer at this).",
    "created_at": "2022-04-05T17:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474993",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:6'></a>The conda distribution file probably needs to be changed as well. However, requiring `matplotlib >=3.5.1` with python < 3.10 doesn't seem to work with conda, or at least in my initial tests the python version always got upgraded as well (might be easy to fix, but I don't have the time right now to look closer at this).



---

archive/issue_comments_474994.json:
```json
{
    "body": "<a id='comment:7'></a>For now with conda, the updated install-requires will ensure that the upgraded package is installed with pip until conda packaging is updated",
    "created_at": "2022-04-05T17:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474994",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>For now with conda, the updated install-requires will ensure that the upgraded package is installed with pip until conda packaging is updated



---

archive/issue_comments_474995.json:
```json
{
    "body": "<a id='comment:8'></a>Let's get this in please.",
    "created_at": "2022-04-06T17:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474995",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Let's get this in please.



---

archive/issue_comments_474996.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-06T22:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474996",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474997.json:
```json
{
    "body": "<a id='comment:9'></a>lgtm - just a version bump",
    "created_at": "2022-04-06T22:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474997",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>lgtm - just a version bump



---

archive/issue_comments_474998.json:
```json
{
    "body": "<a id='comment:10'></a>Thanks!",
    "created_at": "2022-04-06T23:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474998",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Thanks!



---

archive/issue_comments_474999.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-04-07T15:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-474999",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_475000.json:
```json
{
    "body": "<a id='comment:11'></a>This is not really fixing the version conda picks. Conda still uses v3.3.2 on linux, see https://github.com/sagemath/sagetrac-mirror/runs/5871183030?check_suite_focus=true\n\nSo there should at least be a proper version requirement for conda, so that the environment file correctly setups up the conda environment.",
    "created_at": "2022-04-07T15:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475000",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>This is not really fixing the version conda picks. Conda still uses v3.3.2 on linux, see https://github.com/sagemath/sagetrac-mirror/runs/5871183030?check_suite_focus=true

So there should at least be a proper version requirement for conda, so that the environment file correctly setups up the conda environment.



---

archive/issue_comments_475001.json:
```json
{
    "body": "<a id='comment:12'></a>Didn't you say in comment:6 that setting the version with conda does not work with python 3.10?",
    "created_at": "2022-04-07T18:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475001",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Didn't you say in comment:6 that setting the version with conda does not work with python 3.10?



---

archive/issue_comments_475002.json:
```json
{
    "body": "<a id='comment:13'></a>In the log of this run, pip correctly upgrades matplotlib:\n\n```\n2022-04-07T15:34:47.1650744Z   Attempting uninstall: matplotlib\n2022-04-07T15:34:47.1663600Z     Found existing installation: matplotlib 3.3.2\n2022-04-07T15:34:47.2697535Z     Uninstalling matplotlib-3.3.2:\n...\n2022-04-07T15:34:47.4717483Z       Successfully uninstalled matplotlib-3.3.2\n2022-04-07T15:34:48.6427961Z \n...\n2022-04-07T15:56:41.3898229Z     Installed /home/runner/work/sagetrac-mirror/sagetrac-mirror/src\n2022-04-07T15:56:42.1172970Z Successfully installed fonttools-4.31.2 iniconfig-1.1.1 matplotlib-3.5.1 ptyprocess-0.5.1 pytest-7.1.1 rpy2-3.3.6 sagemath-standard-9.6b7 sphinx-4.4.0\n```",
    "created_at": "2022-04-07T18:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475002",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>In the log of this run, pip correctly upgrades matplotlib:

```
2022-04-07T15:34:47.1650744Z   Attempting uninstall: matplotlib
2022-04-07T15:34:47.1663600Z     Found existing installation: matplotlib 3.3.2
2022-04-07T15:34:47.2697535Z     Uninstalling matplotlib-3.3.2:
...
2022-04-07T15:34:47.4717483Z       Successfully uninstalled matplotlib-3.3.2
2022-04-07T15:34:48.6427961Z 
...
2022-04-07T15:56:41.3898229Z     Installed /home/runner/work/sagetrac-mirror/sagetrac-mirror/src
2022-04-07T15:56:42.1172970Z Successfully installed fonttools-4.31.2 iniconfig-1.1.1 matplotlib-3.5.1 ptyprocess-0.5.1 pytest-7.1.1 rpy2-3.3.6 sagemath-standard-9.6b7 sphinx-4.4.0
```



---

archive/issue_comments_475003.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-04-07T18:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475003",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_475004.json:
```json
{
    "body": "<a id='comment:15'></a>Can you give some small reproducer for this? When I install sage=9.5 conda package I always get matplotlib 3.5.1 regardless of the python version",
    "created_at": "2022-04-07T18:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475004",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:15'></a>Can you give some small reproducer for this? When I install sage=9.5 conda package I always get matplotlib 3.5.1 regardless of the python version



---

archive/issue_comments_475005.json:
```json
{
    "body": "<a id='comment:16'></a>Nvm, I can reproduce",
    "created_at": "2022-04-07T18:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475005",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:16'></a>Nvm, I can reproduce



---

archive/issue_comments_475006.json:
```json
{
    "body": "<a id='comment:17'></a>Not sure exactly why this happens.\nA workaround is to have `matplotlib>=3.5.1` in `build/pkgs/matploitlib/distros/conda.txt`",
    "created_at": "2022-04-07T18:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475006",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:17'></a>Not sure exactly why this happens.
A workaround is to have `matplotlib>=3.5.1` in `build/pkgs/matploitlib/distros/conda.txt`



---

archive/issue_comments_475007.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:13 mkoeppe]:\n> In the log of this run, pip correctly upgrades matplotlib:\n> \n> ```\n> 2022-04-07T15:34:47.1650744Z   Attempting uninstall: matplotlib\n> 2022-04-07T15:34:47.1663600Z     Found existing installation: matplotlib 3.3.2\n> 2022-04-07T15:34:47.2697535Z     Uninstalling matplotlib-3.3.2:\n> ...\n> 2022-04-07T15:34:47.4717483Z       Successfully uninstalled matplotlib-3.3.2\n> 2022-04-07T15:34:48.6427961Z \n> ...\n> 2022-04-07T15:56:41.3898229Z     Installed /home/runner/work/sagetrac-mirror/sagetrac-mirror/src\n> 2022-04-07T15:56:42.1172970Z Successfully installed fonttools-4.31.2 iniconfig-1.1.1 matplotlib-3.5.1 ptyprocess-0.5.1 pytest-7.1.1 rpy2-3.3.6 sagemath-standard-9.6b7 sphinx-4.4.0\n> ```\n> \n\n\nBut we want to use conda for managing the environment, otherwise wouldn't need to list the python packages as dependencies (since they would be installed by pip as well otherwise). So please add the version constraint that isuruf mentions above. Thanks",
    "created_at": "2022-04-07T20:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475007",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>Replying to [comment:13 mkoeppe]:
> In the log of this run, pip correctly upgrades matplotlib:
> 
> ```
> 2022-04-07T15:34:47.1650744Z   Attempting uninstall: matplotlib
> 2022-04-07T15:34:47.1663600Z     Found existing installation: matplotlib 3.3.2
> 2022-04-07T15:34:47.2697535Z     Uninstalling matplotlib-3.3.2:
> ...
> 2022-04-07T15:34:47.4717483Z       Successfully uninstalled matplotlib-3.3.2
> 2022-04-07T15:34:48.6427961Z 
> ...
> 2022-04-07T15:56:41.3898229Z     Installed /home/runner/work/sagetrac-mirror/sagetrac-mirror/src
> 2022-04-07T15:56:42.1172970Z Successfully installed fonttools-4.31.2 iniconfig-1.1.1 matplotlib-3.5.1 ptyprocess-0.5.1 pytest-7.1.1 rpy2-3.3.6 sagemath-standard-9.6b7 sphinx-4.4.0
> ```
> 


But we want to use conda for managing the environment, otherwise wouldn't need to list the python packages as dependencies (since they would be installed by pip as well otherwise). So please add the version constraint that isuruf mentions above. Thanks



---

archive/issue_comments_475008.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-04-07T20:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475008",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_475009.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-07T20:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475009",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_475010.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-04-07T20:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475010",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_475011.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 gh-tobiasdiez]:\n> But we want to use conda for managing the environment\n\n\nThis is what we *prefer*, but it does work correctly to install dependencies with pip. Anyway, here it is.",
    "created_at": "2022-04-07T20:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475011",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Replying to [comment:18 gh-tobiasdiez]:
> But we want to use conda for managing the environment


This is what we *prefer*, but it does work correctly to install dependencies with pip. Anyway, here it is.



---

archive/issue_comments_475012.json:
```json
{
    "body": "<a id='comment:23'></a>ok",
    "created_at": "2022-04-07T21:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475012",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>ok



---

archive/issue_comments_475013.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-07T21:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475013",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_475014.json:
```json
{
    "body": "<a id='comment:24'></a>Thanks! Looks good to me and seems to work well: https://github.com/sagemath/sagetrac-mirror/runs/5876791740?check_suite_focus=true\n\nBy the way, there are more conda-installed packages that are later replaced by pip: ptyprocess, iniconfig, sphinx, pytest, rpy2. I'll add them to #33331.",
    "created_at": "2022-04-07T22:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475014",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:24'></a>Thanks! Looks good to me and seems to work well: https://github.com/sagemath/sagetrac-mirror/runs/5876791740?check_suite_focus=true

By the way, there are more conda-installed packages that are later replaced by pip: ptyprocess, iniconfig, sphinx, pytest, rpy2. I'll add them to #33331.



---

archive/issue_comments_475015.json:
```json
{
    "body": "<a id='comment:25'></a>Thanks for resolving this problem.",
    "created_at": "2022-04-08T08:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475015",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:25'></a>Thanks for resolving this problem.



---

archive/issue_comments_475016.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-10T13:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33642#issuecomment-475016",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088474.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-10T13:12:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33642",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33642#event-88474"
}
```
