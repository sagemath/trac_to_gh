# Issue 33331: Meta-ticket: improve conda setup

archive/issues_033094.json:
```json
{
    "body": "- #33330: `primecountpy` is not installed in the conda env because it is not listed in `environment.yml`\n- #33056: giac installed via conda is not usable and leads to many doctest failures\n- #33358: fix for downgrades in `src/environment-optional.yml`\n- #30845: Fix the conda-for-Sage-developers installation method, add GH Actions workflow\n- Updated https://wiki.sagemath.org/Conda to match #30845\n  - use `configure --prefix=$CONDA_PREFIX`\n  - use `configure --with-system-...=force`\n  - use conda for all python dependencies instead of relying on `pip -r requirements.txt`\n- #33426 Migrate documentation from wiki https://wiki.sagemath.org/Conda to developer and installation docs\n- #33642 Update `build/pkgs/matplotlib/install-requires.txt`\n- #33088 More updates for installation and developer guides\n- #33613 Pip package git_trac_command, add pip packages to conda environments\n- On WSL, `gc` and thus `ecl` are not found, as discussed at ticket:30845#comment:152\n- Make sure conda installs only python packages that are satisfying the version constraints specified in `install_requires`. Notably, ptyprocess, iniconfig, sphinx, pytest, rpy2 are currently reinstalled by pip. Also add `--no-dependencies` to `pip install` in the conda ci workflow.\n\nFix remaining tests that fail:\n- sage distutils classes\n\n```\nFile \"src/sage/interfaces/sage0.py\", line 208, in sage.interfaces.sage0.Sage.cputime\nFailed example:\n    sage0.cputime()     # random output\nException raised:\n    Traceback (most recent call last):\n      File \"/home/runner/work/sage/sage/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/runner/work/sage/sage/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.sage0.Sage.cputime[0]>\", line 1, in <module>\n        sage0.cputime()     # random output\n      File \"/home/runner/work/sage/sage/src/sage/interfaces/sage0.py\", line 219, in cputime\n        return float(s)\n    ValueError: could not convert string to float: 'iniconda/envs/sage-build/lib/python3.8/site-packages/setuptools/_distutils/version.py:351: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\\n  other = LooseVersion(other)\\n1.60718'\n```\n\n- #34298: threejs path\n\n```\n File \"src/sage/repl/ipython_kernel/install.py\", line 127, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs\nFailed example:\n    os.path.isdir(threejs)\nExpected:\n    True\nGot:\n    False\n```\n\nCC:  @isuruf @dimpase @saraedum @mkoeppe @slel\n\nIssue created by migration from https://trac.sagemath.org/ticket/33331\n\n",
    "created_at": "2022-02-13T13:57:32Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: improve conda setup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33331",
    "user": "https://github.com/tobiasdiez"
}
```
- #33330: `primecountpy` is not installed in the conda env because it is not listed in `environment.yml`
- #33056: giac installed via conda is not usable and leads to many doctest failures
- #33358: fix for downgrades in `src/environment-optional.yml`
- #30845: Fix the conda-for-Sage-developers installation method, add GH Actions workflow
- Updated https://wiki.sagemath.org/Conda to match #30845
  - use `configure --prefix=$CONDA_PREFIX`
  - use `configure --with-system-...=force`
  - use conda for all python dependencies instead of relying on `pip -r requirements.txt`
- #33426 Migrate documentation from wiki https://wiki.sagemath.org/Conda to developer and installation docs
- #33642 Update `build/pkgs/matplotlib/install-requires.txt`
- #33088 More updates for installation and developer guides
- #33613 Pip package git_trac_command, add pip packages to conda environments
- On WSL, `gc` and thus `ecl` are not found, as discussed at ticket:30845#comment:152
- Make sure conda installs only python packages that are satisfying the version constraints specified in `install_requires`. Notably, ptyprocess, iniconfig, sphinx, pytest, rpy2 are currently reinstalled by pip. Also add `--no-dependencies` to `pip install` in the conda ci workflow.

Fix remaining tests that fail:
- sage distutils classes

```
File "src/sage/interfaces/sage0.py", line 208, in sage.interfaces.sage0.Sage.cputime
Failed example:
    sage0.cputime()     # random output
Exception raised:
    Traceback (most recent call last):
      File "/home/runner/work/sage/sage/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/runner/work/sage/sage/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.sage0.Sage.cputime[0]>", line 1, in <module>
        sage0.cputime()     # random output
      File "/home/runner/work/sage/sage/src/sage/interfaces/sage0.py", line 219, in cputime
        return float(s)
    ValueError: could not convert string to float: 'iniconda/envs/sage-build/lib/python3.8/site-packages/setuptools/_distutils/version.py:351: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n  other = LooseVersion(other)\n1.60718'
```

- #34298: threejs path

```
 File "src/sage/repl/ipython_kernel/install.py", line 127, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs
Failed example:
    os.path.isdir(threejs)
Expected:
    True
Got:
    False
```

CC:  @isuruf @dimpase @saraedum @mkoeppe @slel

Issue created by migration from https://trac.sagemath.org/ticket/33331





---

archive/issue_comments_471234.json:
```json
{
    "body": "<a id='comment:4'></a>> The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files \n\n\n`@`gh-tobiasdiez, is this fixed by #33358 too?",
    "created_at": "2022-02-17T01:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471234",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:4'></a>> The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 


`@`gh-tobiasdiez, is this fixed by #33358 too?



---

archive/issue_comments_471235.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 isuruf]:\n> > The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files \n\n> \n> `@`gh-tobiasdiez, is this fixed by #33358 too?\n\n\nNope, still present. See e.g. output of https://pipelines.actions.githubusercontent.com/wUvxDab7ZCURYAl3HeSwsAoJVAdvXg6u4iTbsP5NChUqrJ4TKs/_apis/pipelines/1/runs/9243/signedlogcontent/3?urlExpires=2022-02-17T12%3A02%3A43.1351322Z&urlSigningMethod=HMACV1&urlSignature=ildfTJhaQ2KGVywf69MDFQSVOl7GTONDSdIOurIphKI%3D\n\nConda is installing rpy2 v3.4.5, while sagelib install requires specify <3.4,>=3.3. Thus pip will download an older version. I think it should be enough to specify the same upper constraint (for the few python packages that have one) in the distros/conda.txt.",
    "created_at": "2022-02-17T12:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471235",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:5'></a>Replying to [comment:4 isuruf]:
> > The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 

> 
> `@`gh-tobiasdiez, is this fixed by #33358 too?


Nope, still present. See e.g. output of https://pipelines.actions.githubusercontent.com/wUvxDab7ZCURYAl3HeSwsAoJVAdvXg6u4iTbsP5NChUqrJ4TKs/_apis/pipelines/1/runs/9243/signedlogcontent/3?urlExpires=2022-02-17T12%3A02%3A43.1351322Z&urlSigningMethod=HMACV1&urlSignature=ildfTJhaQ2KGVywf69MDFQSVOl7GTONDSdIOurIphKI%3D

Conda is installing rpy2 v3.4.5, while sagelib install requires specify <3.4,>=3.3. Thus pip will download an older version. I think it should be enough to specify the same upper constraint (for the few python packages that have one) in the distros/conda.txt.



---

archive/issue_comments_471236.json:
```json
{
    "body": "<a id='comment:12'></a>in \u200bhttps://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?",
    "created_at": "2022-03-21T09:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471236",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?



---

archive/issue_comments_471237.json:
```json
{
    "body": "<a id='comment:13'></a>I think after running `mamba init` you can\nalways use `mamba` instead of `conda`.",
    "created_at": "2022-03-21T10:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471237",
    "user": "https://github.com/slel"
}
```

<a id='comment:13'></a>I think after running `mamba init` you can
always use `mamba` instead of `conda`.



---

archive/issue_comments_471238.json:
```json
{
    "body": "<a id='comment:14'></a>I followed the \"Conda for Sage developers\"\nsection of the Conda page on the Sage wiki.\n\nI noticed it downgrades the openssl version from 3.0.0 to 1.1.1l.\nCan that be fixed?",
    "created_at": "2022-03-21T10:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471238",
    "user": "https://github.com/slel"
}
```

<a id='comment:14'></a>I followed the "Conda for Sage developers"
section of the Conda page on the Sage wiki.

I noticed it downgrades the openssl version from 3.0.0 to 1.1.1l.
Can that be fixed?



---

archive/issue_comments_471239.json:
```json
{
    "body": "<a id='comment:15'></a>Using `src/environment-optional.yml`\ndowngrades a few more packages:\n\n- `boost-cpp` from 1.77.0 to 1.74.0\n- `cmake` from 3.22.3 to 3.21.3\n- `ncurses`from 6.3 to 6.2\n- `python` from 3.10.2 to 3.8.12\n- `singular` from 4.2.1.p3 to 4.2.0.p3\n- `sqlite` from 3.37.1 to 3.37.0",
    "created_at": "2022-03-21T10:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471239",
    "user": "https://github.com/slel"
}
```

<a id='comment:15'></a>Using `src/environment-optional.yml`
downgrades a few more packages:

- `boost-cpp` from 1.77.0 to 1.74.0
- `cmake` from 3.22.3 to 3.21.3
- `ncurses`from 6.3 to 6.2
- `python` from 3.10.2 to 3.8.12
- `singular` from 4.2.1.p3 to 4.2.0.p3
- `sqlite` from 3.37.1 to 3.37.0



---

archive/issue_comments_471240.json:
```json
{
    "body": "<a id='comment:16'></a>Did you use the branch of #30845?",
    "created_at": "2022-03-21T11:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471240",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Did you use the branch of #30845?



---

archive/issue_comments_471241.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:12 dimpase]:\n> in \u200bhttps://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?\n\n\nThey can, but I'm not sure if it would be an improvement to this documentation.\nI have added a comment to the step \"conda install mamba\", please take a look",
    "created_at": "2022-03-21T11:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471241",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:12 dimpase]:
> in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?


They can, but I'm not sure if it would be an improvement to this documentation.
I have added a comment to the step "conda install mamba", please take a look



---

archive/issue_comments_471242.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:16 mkoeppe]:\n> Did you use the branch of #30845?\n\n\nOops, I had not used that branch.\nUsing it, only `openssl` gets downgraded,\n\n- whether using `src/environment.yml`\n- or using  `src/environment-optional.yml`\n\nThis is on macOS 11.6.5 Big Sur.",
    "created_at": "2022-03-22T00:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33331#issuecomment-471242",
    "user": "https://github.com/slel"
}
```

<a id='comment:19'></a>Replying to [comment:16 mkoeppe]:
> Did you use the branch of #30845?


Oops, I had not used that branch.
Using it, only `openssl` gets downgraded,

- whether using `src/environment.yml`
- or using  `src/environment-optional.yml`

This is on macOS 11.6.5 Big Sur.



---

archive/issue_events_087957.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33331#event-87957"
}
```



---

archive/issue_events_087958.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33331#event-87958"
}
```



---

archive/issue_events_087959.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33331",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33331#event-87959"
}
```
