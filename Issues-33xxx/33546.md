# Issue 33546: Use pytest to run doctests

archive/issues_033309.json:
```json
{
    "assignees": [],
    "body": "As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.\n\nTo test, run `./sage --pytest src/sage/manifolds/`. This results in \n\n```\n48 failed, 1416 passed, 7 warnings\n```\nWith many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\nWe also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n\nFollow-ups:\n- #33826 Fix these issues\n- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n\n\nDepends on #33572\n\n**CC:**  @tobiasdiez @tornaria\n\n**Branch:** [cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)\n\n**Reviewer:** Matthias Koeppe\n\n**Author:** Tobias Diez\n\nIssue created by migration from https://trac.sagemath.org/ticket/33546\n\n",
    "closed_at": "2022-05-20T22:27:13Z",
    "created_at": "2022-03-21T23:56:29Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use pytest to run doctests",
    "type": "issue",
    "updated_at": "2022-12-07T10:13:58Z",
    "url": "https://github.com/sagemath/sage/issues/33546",
    "user": "https://github.com/mkoeppe"
}
```
As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.

To test, run `./sage --pytest src/sage/manifolds/`. This results in 

```
48 failed, 1416 passed, 7 warnings
```
With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```

We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.

Follow-ups:
- #33826 Fix these issues
- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython


Depends on #33572

**CC:**  @tobiasdiez @tornaria

**Branch:** [cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)

**Reviewer:** Matthias Koeppe

**Author:** Tobias Diez

Issue created by migration from https://trac.sagemath.org/ticket/33546





---

archive/issue_events_405934.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405934"
}
```



---

archive/issue_events_405935.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "08517b",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405935"
}
```



---

archive/issue_events_405936.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405936"
}
```



---

archive/issue_events_405937.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:58:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "rename": {
        "from": "Replace Sage doctest discovery by using pytest_collect_file",
        "to": "Replace custom Sage doctest discovery by pytest (using pytest_collect_file)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405937"
}
```



---

archive/issue_comments_544484.json:
```json
{
    "body": "**Dependencies:** #33549",
    "created_at": "2022-03-22T16:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544484",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #33549



---

archive/issue_comments_544485.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,3 +2,4 @@\n \n In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n \n+For cython files: https://github.com/lgpage/pytest-cython\n``````\n",
    "created_at": "2022-03-25T12:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544485",
    "user": "https://github.com/tobiasdiez"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,3 +2,4 @@
 
 In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.
 
+For cython files: https://github.com/lgpage/pytest-cython
``````




---

archive/issue_comments_544486.json:
```json
{
    "body": "**Changing dependencies** from \"#33549\" to \"\".",
    "created_at": "2022-03-27T13:49:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544486",
    "user": "https://github.com/tobiasdiez"
}
```

**Changing dependencies** from "#33549" to "".



---

archive/issue_comments_544487.json:
```json
{
    "body": "**Branch:** [public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)",
    "created_at": "2022-03-27T13:49:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544487",
    "user": "https://github.com/tobiasdiez"
}
```

**Branch:** [public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)



---

archive/issue_comments_544488.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c\">f67476f</a></td><td><code>Add some test and prelimary code</code></td></tr></table>\n",
    "created_at": "2022-03-27T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544488",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c">f67476f</a></td><td><code>Add some test and prelimary code</code></td></tr></table>




---

archive/issue_comments_544489.json:
```json
{
    "body": "**Commit:** [f67476f065a2ef7c4b03fcad486ace6e08d9230c](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)",
    "created_at": "2022-03-27T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544489",
    "user": "https://github.com/sagetrac-git"
}
```

**Commit:** [f67476f065a2ef7c4b03fcad486ace6e08d9230c](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)



---

archive/issue_comments_544490.json:
```json
{
    "body": "**Dependencies:** #33572",
    "created_at": "2022-03-29T16:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544490",
    "user": "https://github.com/tobiasdiez"
}
```

**Dependencies:** #33572



---

archive/issue_comments_544491.json:
```json
{
    "body": "<a id='comment:7'></a>\nIn principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.\n\nAny idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?",
    "created_at": "2022-03-29T16:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544491",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>
In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.

Any idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?



---

archive/issue_comments_544492.json:
```json
{
    "body": "**Changing commit** from \"[f67476f065a2ef7c4b03fcad486ace6e08d9230c](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)\" to \"[538ead395132b0fde5b9e4ee0738c1883610e82f](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)\".",
    "created_at": "2022-03-29T16:28:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544492",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[f67476f065a2ef7c4b03fcad486ace6e08d9230c](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)" to "[538ead395132b0fde5b9e4ee0738c1883610e82f](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)".



---

archive/issue_comments_544493.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55\">9385501</a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7\">abbb61f</a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548\">9bb72ea</a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a\">2c16704</a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db\">30642ba</a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f80556745230bb13562c7501f5c736a35ba48b44\">f805567</a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f\">538ead3</a></td><td><code>First working prototype</code></td></tr></table>\n",
    "created_at": "2022-03-29T16:28:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544493",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55">9385501</a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7">abbb61f</a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548">9bb72ea</a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a">2c16704</a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db">30642ba</a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f80556745230bb13562c7501f5c736a35ba48b44">f805567</a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f">538ead3</a></td><td><code>First working prototype</code></td></tr></table>




---

archive/issue_comments_544494.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,19 @@\n-As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1)\n+As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.\n \n-In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n \n-For cython files: https://github.com/lgpage/pytest-cython\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+Follow-ups:\n+- Fix these issues\n+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n``````\n",
    "created_at": "2022-04-05T19:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544494",
    "user": "https://github.com/tobiasdiez"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,19 @@
-As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1)
+As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.
 
-In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
 
-For cython files: https://github.com/lgpage/pytest-cython
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+Follow-ups:
+- Fix these issues
+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
``````




---

archive/issue_events_405938.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T19:44:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405938"
}
```



---

archive/issue_comments_544495.json:
```json
{
    "body": "<a id='comment:9'></a>\nThere are still a few issues, but as a first version it should be good to go.",
    "created_at": "2022-04-05T19:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544495",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:9'></a>
There are still a few issues, but as a first version it should be good to go.



---

archive/issue_events_405939.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T19:44:34Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "rename": {
        "from": "Replace custom Sage doctest discovery by pytest (using pytest_collect_file)",
        "to": "Use pytest to run doctests"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405939"
}
```



---

archive/issue_comments_544496.json:
```json
{
    "body": "**Changing commit** from \"[538ead395132b0fde5b9e4ee0738c1883610e82f](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)\" to \"[58e11d707764c4e7c85bf1c5beb8bf257c0318d8](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)\".",
    "created_at": "2022-04-05T19:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544496",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[538ead395132b0fde5b9e4ee0738c1883610e82f](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)" to "[58e11d707764c4e7c85bf1c5beb8bf257c0318d8](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)".



---

archive/issue_comments_544497.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65\">d881a5a</a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107\">1242e1f</a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b\">0d9225d</a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de\">05bc58f</a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591\">8825079</a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e6bc871ab72e1f1fd11caf14baeeea9466feaa1\">5e6bc87</a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d36adf4084c117fbb3da87232c74ba6b155d0307\">d36adf4</a></td><td><code>Fix import of sage.all in tests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/813a5416f05702eecfe5fd1b54f3ae379ca1981a\">813a541</a></td><td><code>Add vs code config to debug pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e\">d3fdd95</a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8\">58e11d7</a></td><td><code>Fix checker and namespace injection</code></td></tr></table>\n",
    "created_at": "2022-04-05T19:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544497",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65">d881a5a</a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107">1242e1f</a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b">0d9225d</a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de">05bc58f</a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591">8825079</a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e6bc871ab72e1f1fd11caf14baeeea9466feaa1">5e6bc87</a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d36adf4084c117fbb3da87232c74ba6b155d0307">d36adf4</a></td><td><code>Fix import of sage.all in tests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/813a5416f05702eecfe5fd1b54f3ae379ca1981a">813a541</a></td><td><code>Add vs code config to debug pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e">d3fdd95</a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8">58e11d7</a></td><td><code>Fix checker and namespace injection</code></td></tr></table>




---

archive/issue_comments_544498.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -17,3 +17,7 @@\n Follow-ups:\n - Fix these issues\n - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n+\n+---\n+\n+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n``````\n",
    "created_at": "2022-04-05T19:47:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544498",
    "user": "https://github.com/tobiasdiez"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -17,3 +17,7 @@
 Follow-ups:
 - Fix these issues
 - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
+
+---
+
+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
``````




---

archive/issue_comments_544499.json:
```json
{
    "body": "Replying to [ticket:33546 mkoeppe]:\n> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\nWould it be possible to add a doctest for that?",
    "created_at": "2022-04-05T21:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544499",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33546 mkoeppe]:
> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

Would it be possible to add a doctest for that?



---

archive/issue_comments_544500.json:
```json
{
    "body": "<a id='comment:13'></a>\nA concern from #33531?cnum_edit=14#comment:14:\n\n  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).",
    "created_at": "2022-05-01T20:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544500",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
A concern from #33531?cnum_edit=14#comment:14:

  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).



---

archive/issue_comments_544501.json:
```json
{
    "body": "<a id='comment:14'></a>\nThere are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).",
    "created_at": "2022-05-02T19:17:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544501",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:14'></a>
There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).



---

archive/issue_comments_544502.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@tobiasdiez](#comment%3A9):\n> There are still a few issues, but as a first version it should be good to go.\n\nI haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?",
    "created_at": "2022-05-02T21:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544502",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Replying to [@tobiasdiez](#comment%3A9):
> There are still a few issues, but as a first version it should be good to go.

I haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?



---

archive/issue_comments_544503.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@tobiasdiez](#comment%3A14):\n> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\nParallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nNon-rethorical question: what is the advantage of pytest over the current sage doctest framework?",
    "created_at": "2022-05-02T22:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544503",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:16'></a>
Replying to [@tobiasdiez](#comment%3A14):
> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?



---

archive/issue_comments_544504.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [@tornaria](#comment%3A16):\n> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\nMy own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?",
    "created_at": "2022-05-02T23:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544504",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>
Replying to [@tornaria](#comment%3A16):
> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?



---

archive/issue_comments_544505.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [@tornaria](#comment%3A16):\n> Replying to [@tobiasdiez](#comment%3A14):\n> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\n> \n> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nIf I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). \n\nAnyway, both packages are ordinary pip installable packages.",
    "created_at": "2022-05-04T09:54:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544505",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>
Replying to [@tornaria](#comment%3A16):
> Replying to [@tobiasdiez](#comment%3A14):
> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

> 
> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

If I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). 

Anyway, both packages are ordinary pip installable packages.



---

archive/issue_comments_544506.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@kiwifb](#comment%3A17):\n> Replying to [@tornaria](#comment%3A16):\n> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\n> \n> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?\n\nCannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).",
    "created_at": "2022-05-04T10:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544506",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:19'></a>
Replying to [@kiwifb](#comment%3A17):
> Replying to [@tornaria](#comment%3A16):
> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

> 
> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?

Cannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).



---

archive/issue_comments_544507.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@tobiasdiez](#comment%3A18):\n> Replying to [@tornaria](#comment%3A16):\n> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]\n\n> If I'm not mistaken that only runs the tests in multiple independent workers\n\nThat's right.\n\n> But as far as I'm aware there are no extensive tests of sage with concurrency\n\nYes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.\n\n> multiple threads sharing the same state (i.e. pytest-parallel). \n\nLooks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.",
    "created_at": "2022-05-04T16:39:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544507",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Replying to [@tobiasdiez](#comment%3A18):
> Replying to [@tornaria](#comment%3A16):
> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]

> If I'm not mistaken that only runs the tests in multiple independent workers

That's right.

> But as far as I'm aware there are no extensive tests of sage with concurrency

Yes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.

> multiple threads sharing the same state (i.e. pytest-parallel). 

Looks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.



---

archive/issue_comments_544508.json:
```json
{
    "body": "**Author:** Tobias Diez",
    "created_at": "2022-05-04T17:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544508",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Tobias Diez



---

archive/issue_events_405940.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-04T17:24:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405940"
}
```



---

archive/issue_events_405941.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-04T17:24:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405941"
}
```



---

archive/issue_comments_544509.json:
```json
{
    "body": "<a id='comment:21'></a>\ncomment:15",
    "created_at": "2022-05-04T17:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544509",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
comment:15



---

archive/issue_comments_544510.json:
```json
{
    "body": "<a id='comment:22'></a>\nWhat issues did you encounter?",
    "created_at": "2022-05-05T22:39:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544510",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:22'></a>
What issues did you encounter?



---

archive/issue_comments_544511.json:
```json
{
    "body": "<a id='comment:23'></a>\npytest now runs doctests, and you say that there will be failures.\n\nBut `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n\nCorrect?",
    "created_at": "2022-05-05T22:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544511",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
pytest now runs doctests, and you say that there will be failures.

But `sage -t` also runs pytest, so now there will be failures in `sage -t`.

Correct?



---

archive/issue_comments_544512.json:
```json
{
    "body": "**Changing commit** from \"[58e11d707764c4e7c85bf1c5beb8bf257c0318d8](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)\" to \"[f863428150c03430bbc072d7386f3c8dd9a64221](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)\".",
    "created_at": "2022-05-06T22:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544512",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[58e11d707764c4e7c85bf1c5beb8bf257c0318d8](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)" to "[f863428150c03430bbc072d7386f3c8dd9a64221](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)".



---

archive/issue_comments_544513.json:
```json
{
    "body": "<a id='comment:24'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686\">ff4056b</a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3\">e62c29b</a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a\">3ee9815</a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221\">f863428</a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr></table>\n",
    "created_at": "2022-05-06T22:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544513",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:24'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686">ff4056b</a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3">e62c29b</a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a">3ee9815</a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221">f863428</a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr></table>




---

archive/issue_comments_544514.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [@mkoeppe](#comment%3A12):\n> Replying to [ticket:33546 mkoeppe]:\n> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\n> \n> Would it be possible to add a doctest for that?\n\nAdded a pytest for it.",
    "created_at": "2022-05-06T22:33:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544514",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:25'></a>
Replying to [@mkoeppe](#comment%3A12):
> Replying to [ticket:33546 mkoeppe]:
> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

> 
> Would it be possible to add a doctest for that?

Added a pytest for it.



---

archive/issue_comments_544515.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [@mkoeppe](#comment%3A23):\n> pytest now runs doctests, and you say that there will be failures.\n> \n> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n> \n> Correct?\n\nThe idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!",
    "created_at": "2022-05-06T22:36:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544515",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:26'></a>
Replying to [@mkoeppe](#comment%3A23):
> pytest now runs doctests, and you say that there will be failures.
> 
> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.
> 
> Correct?

The idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!



---

archive/issue_events_405942.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-06T22:36:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405942"
}
```



---

archive/issue_events_405943.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-06T22:36:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405943"
}
```



---

archive/issue_comments_544516.json:
```json
{
    "body": "<a id='comment:27'></a>\n\n```\n[pytest]\n python_files = *_test.py\n+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n```\n`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist",
    "created_at": "2022-05-06T23:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544516",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>

```
[pytest]
 python_files = *_test.py
+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
```
`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist



---

archive/issue_comments_544517.json:
```json
{
    "body": "<a id='comment:28'></a>\nAlso could you update the ticket description please?",
    "created_at": "2022-05-06T23:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544517",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
Also could you update the ticket description please?



---

archive/issue_comments_544518.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,10 +14,9 @@\n src/sage/manifolds/chart.py\n ```\n \n+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n+\n Follow-ups:\n - Fix these issues\n - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n----\n-\n-Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n``````\n",
    "created_at": "2022-05-08T08:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544518",
    "user": "https://github.com/tobiasdiez"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,10 +14,9 @@
 src/sage/manifolds/chart.py
 ```
 
+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
+
 Follow-ups:
 - Fix these issues
 - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
----
-
-Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
``````




---

archive/issue_comments_544519.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144\">428a18c</a></td><td><code>Remove nonexisting paths from config</code></td></tr></table>\n",
    "created_at": "2022-05-08T08:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544519",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144">428a18c</a></td><td><code>Remove nonexisting paths from config</code></td></tr></table>




---

archive/issue_comments_544520.json:
```json
{
    "body": "**Changing commit** from \"[f863428150c03430bbc072d7386f3c8dd9a64221](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)\" to \"[428a18ca7d8cd9d2423aa2f66dbd069a906ac144](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)\".",
    "created_at": "2022-05-08T08:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544520",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[f863428150c03430bbc072d7386f3c8dd9a64221](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)" to "[428a18ca7d8cd9d2423aa2f66dbd069a906ac144](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)".



---

archive/issue_comments_544521.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [@mkoeppe](#comment%3A27):\n> \n> ```\n> [pytest]\n>  python_files = *_test.py\n> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n> ```\n> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist\n\nYou are right. Not sure why I've added them in the first place, but I've removed them now.",
    "created_at": "2022-05-08T08:53:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544521",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:31'></a>
Replying to [@mkoeppe](#comment%3A27):
> 
> ```
> [pytest]
>  python_files = *_test.py
> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
> ```
> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist

You are right. Not sure why I've added them in the first place, but I've removed them now.



---

archive/issue_comments_544522.json:
```json
{
    "body": "<a id='comment:32'></a>\nIn a build without `--enable-editable`:\n\n```\n./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests\n=================================================================================================== test session starts ====================================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini\ncollected 0 items / 2 errors                                                                                                                                                                                               \n\n========================================================================================================== ERRORS ==========================================================================================================\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nsrc/conftest.py:93: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call\n    result: Optional[TResult] = func()\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>\n    call = CallInfo.from_call(lambda: list(collector.collect()), \"collect\")\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n================================================================================================= short test summary info ==================================================================================================\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================== 2 errors in 1.16s =====================================================================================================\n```",
    "created_at": "2022-05-08T20:29:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544522",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
In a build without `--enable-editable`:

```
./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests
=================================================================================================== test session starts ====================================================================================================
platform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini
collected 0 items / 2 errors                                                                                                                                                                                               

========================================================================================================== ERRORS ==========================================================================================================
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
src/conftest.py:93: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call
    result: Optional[TResult] = func()
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>
    call = CallInfo.from_call(lambda: list(collector.collect()), "collect")
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
================================================================================================= short test summary info ==================================================================================================
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================== 2 errors in 1.16s =====================================================================================================
```



---

archive/issue_comments_544523.json:
```json
{
    "body": "<a id='comment:33'></a>\nI cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). \n\nThe strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.",
    "created_at": "2022-05-08T21:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544523",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:33'></a>
I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). 

The strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.



---

archive/issue_comments_544524.json:
```json
{
    "body": "<a id='comment:34'></a>\nYou can just reconfigure without --enable-editable and rebuild to test",
    "created_at": "2022-05-08T21:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544524",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
You can just reconfigure without --enable-editable and rebuild to test



---

archive/issue_comments_544525.json:
```json
{
    "body": "<a id='comment:35'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25\">cc19e92</a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr></table>\n",
    "created_at": "2022-05-09T12:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544525",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:35'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25">cc19e92</a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr></table>




---

archive/issue_comments_544526.json:
```json
{
    "body": "**Changing commit** from \"[428a18ca7d8cd9d2423aa2f66dbd069a906ac144](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)\" to \"[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)\".",
    "created_at": "2022-05-09T12:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544526",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[428a18ca7d8cd9d2423aa2f66dbd069a906ac144](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)" to "[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)".



---

archive/issue_comments_544527.json:
```json
{
    "body": "<a id='comment:36'></a>\nShould work now.",
    "created_at": "2022-05-09T12:36:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544527",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:36'></a>
Should work now.



---

archive/issue_events_405944.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:30:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405944"
}
```



---

archive/issue_events_405945.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:30:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405945"
}
```



---

archive/issue_comments_544528.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2022-05-09T17:30:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544528",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_comments_544529.json:
```json
{
    "body": "<a id='comment:38'></a>\nI've opened tickets for the follow-ups.",
    "created_at": "2022-05-09T17:38:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544529",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>
I've opened tickets for the follow-ups.



---

archive/issue_comments_544530.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -17,6 +17,7 @@\n We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n \n Follow-ups:\n-- Fix these issues\n-- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n+- #33826 Fix these issues\n+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n``````\n",
    "created_at": "2022-05-09T17:38:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544530",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -17,6 +17,7 @@
 We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
 
 Follow-ups:
-- Fix these issues
-- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
+- #33826 Fix these issues
+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
``````




---

archive/issue_comments_544531.json:
```json
{
    "body": "<a id='comment:39'></a>\nTwo times thanks!",
    "created_at": "2022-05-09T20:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544531",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:39'></a>
Two times thanks!



---

archive/issue_events_405946.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-05-20T22:27:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405946"
}
```



---

archive/issue_events_405947.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2b8d71370eae2219e977ecda71580b933a2c55c6",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-05-20T22:27:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-405947"
}
```



---

archive/issue_comments_544532.json:
```json
{
    "body": "**Changing branch** from \"[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)\" to \"[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)\".",
    "created_at": "2022-05-20T22:27:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544532",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)" to "[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)".



---

archive/issue_comments_544533.json:
```json
{
    "body": "<a id='comment:41'></a>\nsee #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.",
    "created_at": "2022-12-07T10:00:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544533",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>
see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.



---

archive/issue_comments_544534.json:
```json
{
    "body": "**Changing commit** from \"[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)\" to \"\".",
    "created_at": "2022-12-07T10:00:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544534",
    "user": "https://github.com/dimpase"
}
```

**Changing commit** from "[cc19e927a49efbd31d693b2f70bad48203ea8a25](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)" to "".



---

archive/issue_comments_544535.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [Dima Pasechnik](#comment%3A41):\n>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.\n\nOpened a followup ticket #34829 to deal with this.",
    "created_at": "2022-12-07T10:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-544535",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>
Replying to [Dima Pasechnik](#comment%3A41):
>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.

Opened a followup ticket #34829 to deal with this.
