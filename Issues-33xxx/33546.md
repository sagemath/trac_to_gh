# Issue 33546: Use pytest to run doctests

archive/issues_033309.json:
```json
{
    "body": "As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.\n\nTo test, run `./sage --pytest src/sage/manifolds/`. This results in \n\n```\n48 failed, 1416 passed, 7 warnings\n```\nWith many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\nWe also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n\nFollow-ups:\n- #33826 Fix these issues\n- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n\n\nCC:  @tobiasdiez @tornaria\n\nReviewer: Matthias Koeppe\n\nAuthor: Tobias Diez\n\nBranch: cc19e927a49efbd31d693b2f70bad48203ea8a25\n\nDependencies: #33572\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/33546\n\n",
    "closed_at": "2022-05-20T22:27:13Z",
    "created_at": "2022-03-21T23:56:29Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Use pytest to run doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33546",
    "user": "https://github.com/mkoeppe"
}
```
As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.

To test, run `./sage --pytest src/sage/manifolds/`. This results in 

```
48 failed, 1416 passed, 7 warnings
```
With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```

We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.

Follow-ups:
- #33826 Fix these issues
- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython


CC:  @tobiasdiez @tornaria

Reviewer: Matthias Koeppe

Author: Tobias Diez

Branch: cc19e927a49efbd31d693b2f70bad48203ea8a25

Dependencies: #33572

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/33546





---

archive/issue_comments_668721.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#33549\"",
    "created_at": "2022-03-22T16:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668721",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#33549"



---

archive/issue_comments_668722.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n As suggested in #33232#comment:1\n \n In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n+\n+For cython files: https://github.com/lgpage/pytest-cython\n \n Comment: 1\n \n``````\n",
    "created_at": "2022-03-25T12:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668722",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 As suggested in #33232#comment:1
 
 In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.
+
+For cython files: https://github.com/lgpage/pytest-cython
 
 Comment: 1
 
``````




---

archive/issue_comments_668723.json:
```json
{
    "body": "Changing dependencies from \"#33549\" to \"\"",
    "created_at": "2022-03-27T13:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668723",
    "user": "https://github.com/tobiasdiez"
}
```

Changing dependencies from "#33549" to ""



---

archive/issue_comments_668724.json:
```json
{
    "body": "Changing branch from \"\" to \"public/tests/pytest_doctests\"",
    "created_at": "2022-03-27T13:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668724",
    "user": "https://github.com/tobiasdiez"
}
```

Changing branch from "" to "public/tests/pytest_doctests"



---

archive/issue_comments_668725.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-27T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668725",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_668726.json:
```json
{
    "body": "Changing commit from \"\" to \"f67476f065a2ef7c4b03fcad486ace6e08d9230c\"",
    "created_at": "2022-03-27T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668726",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "f67476f065a2ef7c4b03fcad486ace6e08d9230c"



---

archive/issue_comments_668727.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#33572\"",
    "created_at": "2022-03-29T16:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668727",
    "user": "https://github.com/tobiasdiez"
}
```

Changing dependencies from "" to "#33572"



---

archive/issue_comments_668728.json:
```json
{
    "body": "<a id='comment:7'></a>In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.\n\nAny idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?",
    "created_at": "2022-03-29T16:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668728",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.

Any idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?



---

archive/issue_comments_668729.json:
```json
{
    "body": "Changing commit from \"f67476f065a2ef7c4b03fcad486ace6e08d9230c\" to \"538ead395132b0fde5b9e4ee0738c1883610e82f\"",
    "created_at": "2022-03-29T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668729",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f67476f065a2ef7c4b03fcad486ace6e08d9230c" to "538ead395132b0fde5b9e4ee0738c1883610e82f"



---

archive/issue_comments_668730.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-29T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_668731.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.\n \n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n+\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+Follow-ups:\n+- Fix these issues\n+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n Comment: 1\n \n``````\n",
    "created_at": "2022-04-05T19:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668731",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,22 @@
+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.
 
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
+
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+Follow-ups:
+- Fix these issues
+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
 Comment: 1
 
``````




---

archive/issue_comments_668732.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-05T19:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668732",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_668733.json:
```json
{
    "body": "<a id='comment:9'></a>There are still a few issues, but as a first version it should be good to go.",
    "created_at": "2022-04-05T19:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668733",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:9'></a>There are still a few issues, but as a first version it should be good to go.



---

archive/issue_comments_668734.json:
```json
{
    "body": "Changing commit from \"538ead395132b0fde5b9e4ee0738c1883610e82f\" to \"58e11d707764c4e7c85bf1c5beb8bf257c0318d8\"",
    "created_at": "2022-04-05T19:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "538ead395132b0fde5b9e4ee0738c1883610e82f" to "58e11d707764c4e7c85bf1c5beb8bf257c0318d8"



---

archive/issue_comments_668735.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-04-05T19:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_668736.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,26 @@\n+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.\n \n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n+\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+Follow-ups:\n+- Fix these issues\n+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n+\n+---\n+\n+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n \n Comment: 1\n \n``````\n",
    "created_at": "2022-04-05T19:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668736",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,26 @@
+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.
 
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
+
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+Follow-ups:
+- Fix these issues
+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
+
+---
+
+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
 
 Comment: 1
 
``````




---

archive/issue_comments_668737.json:
```json
{
    "body": "Replying to [ticket:33546 mkoeppe]:\n> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\n\nWould it be possible to add a doctest for that?",
    "created_at": "2022-04-05T21:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668737",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33546 mkoeppe]:
> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.


Would it be possible to add a doctest for that?



---

archive/issue_comments_668738.json:
```json
{
    "body": "<a id='comment:13'></a>A concern from #33531?cnum_edit=14#comment:14:\n\n  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).",
    "created_at": "2022-05-01T20:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668738",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>A concern from #33531?cnum_edit=14#comment:14:

  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).



---

archive/issue_comments_668739.json:
```json
{
    "body": "<a id='comment:14'></a>There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).",
    "created_at": "2022-05-02T19:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668739",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:14'></a>There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).



---

archive/issue_comments_668740.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:9 gh-tobiasdiez]:\n> There are still a few issues, but as a first version it should be good to go.\n\n\nI haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?",
    "created_at": "2022-05-02T21:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668740",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Replying to [comment:9 gh-tobiasdiez]:
> There are still a few issues, but as a first version it should be good to go.


I haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?



---

archive/issue_comments_668741.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 gh-tobiasdiez]:\n> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\n\nParallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nNon-rethorical question: what is the advantage of pytest over the current sage doctest framework?",
    "created_at": "2022-05-02T22:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668741",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:16'></a>Replying to [comment:14 gh-tobiasdiez]:
> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 


Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?



---

archive/issue_comments_668742.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 tornaria]:\n> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\n\nMy own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?",
    "created_at": "2022-05-02T23:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668742",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>Replying to [comment:16 tornaria]:
> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?


My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?



---

archive/issue_comments_668743.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 tornaria]:\n> Replying to [comment:14 gh-tobiasdiez]:\n> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\n> \n> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\n\nIf I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). \n\nAnyway, both packages are ordinary pip installable packages.",
    "created_at": "2022-05-04T09:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668743",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>Replying to [comment:16 tornaria]:
> Replying to [comment:14 gh-tobiasdiez]:
> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

> 
> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).


If I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). 

Anyway, both packages are ordinary pip installable packages.



---

archive/issue_comments_668744.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 fbissey]:\n> Replying to [comment:16 tornaria]:\n> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\n> \n> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?\n\n\nCannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).",
    "created_at": "2022-05-04T10:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668744",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:19'></a>Replying to [comment:17 fbissey]:
> Replying to [comment:16 tornaria]:
> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

> 
> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?


Cannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).



---

archive/issue_comments_668745.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 gh-tobiasdiez]:\n> Replying to [comment:16 tornaria]:\n> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]\n\n\n> If I'm not mistaken that only runs the tests in multiple independent workers\n\n\nThat's right.\n\n> But as far as I'm aware there are no extensive tests of sage with concurrency\n\n\nYes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.\n\n> multiple threads sharing the same state (i.e. pytest-parallel). \n\n\nLooks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.",
    "created_at": "2022-05-04T16:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668745",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Replying to [comment:18 gh-tobiasdiez]:
> Replying to [comment:16 tornaria]:
> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]


> If I'm not mistaken that only runs the tests in multiple independent workers


That's right.

> But as far as I'm aware there are no extensive tests of sage with concurrency


Yes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.

> multiple threads sharing the same state (i.e. pytest-parallel). 


Looks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.



---

archive/issue_comments_668746.json:
```json
{
    "body": "Changing author from \"\" to \"Tobias Diez\"",
    "created_at": "2022-05-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668746",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Tobias Diez"



---

archive/issue_comments_668747.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2022-05-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668747",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_668748.json:
```json
{
    "body": "<a id='comment:21'></a>comment:15",
    "created_at": "2022-05-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668748",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>comment:15



---

archive/issue_comments_668749.json:
```json
{
    "body": "<a id='comment:22'></a>What issues did you encounter?",
    "created_at": "2022-05-05T22:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668749",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:22'></a>What issues did you encounter?



---

archive/issue_comments_668750.json:
```json
{
    "body": "<a id='comment:23'></a>pytest now runs doctests, and you say that there will be failures.\n\nBut `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n\nCorrect?",
    "created_at": "2022-05-05T22:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668750",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>pytest now runs doctests, and you say that there will be failures.

But `sage -t` also runs pytest, so now there will be failures in `sage -t`.

Correct?



---

archive/issue_comments_668751.json:
```json
{
    "body": "Changing commit from \"58e11d707764c4e7c85bf1c5beb8bf257c0318d8\" to \"f863428150c03430bbc072d7386f3c8dd9a64221\"",
    "created_at": "2022-05-06T22:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "58e11d707764c4e7c85bf1c5beb8bf257c0318d8" to "f863428150c03430bbc072d7386f3c8dd9a64221"



---

archive/issue_comments_668752.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-06T22:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668752",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_668753.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:12 mkoeppe]:\n> Replying to [ticket:33546 mkoeppe]:\n> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\n> \n> Would it be possible to add a doctest for that?\n\n\nAdded a pytest for it.",
    "created_at": "2022-05-06T22:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668753",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:25'></a>Replying to [comment:12 mkoeppe]:
> Replying to [ticket:33546 mkoeppe]:
> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

> 
> Would it be possible to add a doctest for that?


Added a pytest for it.



---

archive/issue_comments_668754.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:23 mkoeppe]:\n> pytest now runs doctests, and you say that there will be failures.\n> \n> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n> \n> Correct?\n\n\nThe idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!",
    "created_at": "2022-05-06T22:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668754",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:26'></a>Replying to [comment:23 mkoeppe]:
> pytest now runs doctests, and you say that there will be failures.
> 
> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.
> 
> Correct?


The idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!



---

archive/issue_comments_668755.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-05-06T22:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668755",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_668756.json:
```json
{
    "body": "<a id='comment:27'></a>\n```\n[pytest]\n python_files = *_test.py\n+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n```\n`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist",
    "created_at": "2022-05-06T23:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668756",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
```
[pytest]
 python_files = *_test.py
+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
```
`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist



---

archive/issue_comments_668757.json:
```json
{
    "body": "<a id='comment:28'></a>Also could you update the ticket description please?",
    "created_at": "2022-05-06T23:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668757",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>Also could you update the ticket description please?



---

archive/issue_comments_668758.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,24 @@\n+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.\n+\n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n+\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n+\n+Follow-ups:\n+- Fix these issues\n+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n \n Comment: 1\n``````\n",
    "created_at": "2022-05-08T08:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668758",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,24 @@
+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.
+
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
+
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
+
+Follow-ups:
+- Fix these issues
+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
 
 Comment: 1
``````




---

archive/issue_comments_668759.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-08T08:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_668760.json:
```json
{
    "body": "Changing commit from \"f863428150c03430bbc072d7386f3c8dd9a64221\" to \"428a18ca7d8cd9d2423aa2f66dbd069a906ac144\"",
    "created_at": "2022-05-08T08:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668760",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f863428150c03430bbc072d7386f3c8dd9a64221" to "428a18ca7d8cd9d2423aa2f66dbd069a906ac144"



---

archive/issue_comments_668761.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:27 mkoeppe]:\n> {{{\n> [pytest]\n>  python_files = *_test.py\n> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n> }}}\n> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist\n\n\nYou are right. Not sure why I've added them in the first place, but I've removed them now.",
    "created_at": "2022-05-08T08:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668761",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:31'></a>Replying to [comment:27 mkoeppe]:
> {{{
> [pytest]
>  python_files = *_test.py
> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
> }}}
> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist


You are right. Not sure why I've added them in the first place, but I've removed them now.



---

archive/issue_comments_668762.json:
```json
{
    "body": "<a id='comment:32'></a>In a build without `--enable-editable`:\n\n```\n./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests\n=================================================================================================== test session starts ====================================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini\ncollected 0 items / 2 errors                                                                                                                                                                                               \n\n========================================================================================================== ERRORS ==========================================================================================================\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nsrc/conftest.py:93: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call\n    result: Optional[TResult] = func()\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>\n    call = CallInfo.from_call(lambda: list(collector.collect()), \"collect\")\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n================================================================================================= short test summary info ==================================================================================================\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================== 2 errors in 1.16s =====================================================================================================\n```",
    "created_at": "2022-05-08T20:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668762",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>In a build without `--enable-editable`:

```
./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests
=================================================================================================== test session starts ====================================================================================================
platform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini
collected 0 items / 2 errors                                                                                                                                                                                               

========================================================================================================== ERRORS ==========================================================================================================
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
src/conftest.py:93: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call
    result: Optional[TResult] = func()
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>
    call = CallInfo.from_call(lambda: list(collector.collect()), "collect")
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
================================================================================================= short test summary info ==================================================================================================
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================== 2 errors in 1.16s =====================================================================================================
```



---

archive/issue_comments_668763.json:
```json
{
    "body": "<a id='comment:33'></a>I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). \n\nThe strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.",
    "created_at": "2022-05-08T21:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668763",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:33'></a>I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). 

The strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.



---

archive/issue_comments_668764.json:
```json
{
    "body": "<a id='comment:34'></a>You can just reconfigure without --enable-editable and rebuild to test",
    "created_at": "2022-05-08T21:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668764",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>You can just reconfigure without --enable-editable and rebuild to test



---

archive/issue_comments_668765.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-09T12:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668765",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_668766.json:
```json
{
    "body": "Changing commit from \"428a18ca7d8cd9d2423aa2f66dbd069a906ac144\" to \"cc19e927a49efbd31d693b2f70bad48203ea8a25\"",
    "created_at": "2022-05-09T12:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "428a18ca7d8cd9d2423aa2f66dbd069a906ac144" to "cc19e927a49efbd31d693b2f70bad48203ea8a25"



---

archive/issue_comments_668767.json:
```json
{
    "body": "<a id='comment:36'></a>Should work now.",
    "created_at": "2022-05-09T12:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668767",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:36'></a>Should work now.



---

archive/issue_comments_668768.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-05-09T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668768",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_668769.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-05-09T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668769",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_668770.json:
```json
{
    "body": "<a id='comment:38'></a>I've opened tickets for the follow-ups.",
    "created_at": "2022-05-09T17:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668770",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>I've opened tickets for the follow-ups.



---

archive/issue_comments_668771.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.\n+\n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n+\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n+\n+Follow-ups:\n+- #33826 Fix these issues\n+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n \n Comment: 1\n``````\n",
    "created_at": "2022-05-09T17:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668771",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,25 @@
+As suggested in #33232#comment:1, `./sage --pytest` now uses pytest to discover and run doctests.
+
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
+
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
+
+Follow-ups:
+- #33826 Fix these issues
+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
 
 Comment: 1
``````




---

archive/issue_comments_668772.json:
```json
{
    "body": "<a id='comment:39'></a>Two times thanks!",
    "created_at": "2022-05-09T20:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668772",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:39'></a>Two times thanks!



---

archive/issue_events_088303.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-05-20T22:27:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33546#event-88303"
}
```



---

archive/issue_comments_668773.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-05-20T22:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668773",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_668774.json:
```json
{
    "body": "Changing branch from \"public/tests/pytest_doctests\" to \"cc19e927a49efbd31d693b2f70bad48203ea8a25\"",
    "created_at": "2022-05-20T22:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668774",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/tests/pytest_doctests" to "cc19e927a49efbd31d693b2f70bad48203ea8a25"



---

archive/issue_comments_668775.json:
```json
{
    "body": "<a id='comment:41'></a>see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.",
    "created_at": "2022-12-07T10:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668775",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.



---

archive/issue_comments_668776.json:
```json
{
    "body": "Changing commit from \"cc19e927a49efbd31d693b2f70bad48203ea8a25\" to \"\"",
    "created_at": "2022-12-07T10:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668776",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "cc19e927a49efbd31d693b2f70bad48203ea8a25" to ""



---

archive/issue_comments_668777.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 Dima Pasechnik]:\n>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.\n\n\nOpened a followup ticket #34829 to deal with this.",
    "created_at": "2022-12-07T10:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33546#issuecomment-668777",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>Replying to [comment:41 Dima Pasechnik]:
>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.


Opened a followup ticket #34829 to deal with this.
