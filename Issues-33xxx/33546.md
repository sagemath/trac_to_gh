# Issue 33546: Use pytest to run doctests

archive/issues_033309.json:
```json
{
    "assignees": [],
    "body": "As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.\n\nTo test, run `./sage --pytest src/sage/manifolds/`. This results in \n\n```\n48 failed, 1416 passed, 7 warnings\n```\nWith many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\nWe also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n\nFollow-ups:\n- #33826 Fix these issues\n- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n\n\nDepends on #33572\n\nCC:  @tobiasdiez @tornaria\n\nBranch: **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **Tobias Diez**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33546_\n\n",
    "closed_at": "2022-05-20T22:27:13Z",
    "created_at": "2022-03-21T23:56:29Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use pytest to run doctests",
    "type": "issue",
    "updated_at": "2022-12-07T10:13:58Z",
    "url": "https://github.com/sagemath/sage/issues/33546",
    "user": "https://github.com/mkoeppe"
}
```
As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.

To test, run `./sage --pytest src/sage/manifolds/`. This results in 

```
48 failed, 1416 passed, 7 warnings
```
With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```

We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.

Follow-ups:
- #33826 Fix these issues
- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython


Depends on #33572

CC:  @tobiasdiez @tornaria

Branch: **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**

Reviewer: **Matthias Koeppe**

Author: **Tobias Diez**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/33546_





---

archive/issue_events_457327.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457327"
}
```



---

archive/issue_events_457328.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "0000b0",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457328"
}
```



---

archive/issue_events_457329.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457329"
}
```



---

archive/issue_events_457330.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:56:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457330"
}
```



---

archive/issue_events_457331.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:58:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "title_is": "Replace custom Sage doctest discovery by pytest (using pytest_collect_file)",
    "title_was": "Replace Sage doctest discovery by using pytest_collect_file",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457331"
}
```



---

archive/issue_comments_541828.json:
```json
{
    "body": "Dependencies: **#33549**",
    "created_at": "2022-03-22T16:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541828",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#33549**



---

archive/issue_comments_541829.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,3 +2,4 @@\n \n In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n \n+For cython files: https://github.com/lgpage/pytest-cython\n``````\n",
    "created_at": "2022-03-25T12:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541829",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,3 +2,4 @@
 
 In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.
 
+For cython files: https://github.com/lgpage/pytest-cython
``````




---

archive/issue_comments_541830.json:
```json
{
    "body": "Changed dependencies from **#33549** to none",
    "created_at": "2022-03-27T13:49:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541830",
    "user": "https://github.com/tobiasdiez"
}
```

Changed dependencies from **#33549** to none



---

archive/issue_comments_541831.json:
```json
{
    "body": "Branch: **[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)**",
    "created_at": "2022-03-27T13:49:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541831",
    "user": "https://github.com/tobiasdiez"
}
```

Branch: **[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)**



---

archive/issue_comments_541832.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c\"><code>f67476f</code></a></td><td><code>Add some test and prelimary code</code></td></tr></table>\n",
    "created_at": "2022-03-27T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541832",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c"><code>f67476f</code></a></td><td><code>Add some test and prelimary code</code></td></tr></table>




---

archive/issue_comments_541833.json:
```json
{
    "body": "Commit: **[`f67476f`](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)**",
    "created_at": "2022-03-27T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541833",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`f67476f`](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)**



---

archive/issue_comments_541834.json:
```json
{
    "body": "Dependencies: **#33572**",
    "created_at": "2022-03-29T16:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541834",
    "user": "https://github.com/tobiasdiez"
}
```

Dependencies: **#33572**



---

archive/issue_comments_541835.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIn principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.\n\nAny idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?",
    "created_at": "2022-03-29T16:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541835",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:7" align="right">comment:7</div>

In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.

Any idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?



---

archive/issue_comments_541836.json:
```json
{
    "body": "Changed commit from **[`f67476f`](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)** to **[`538ead3`](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)**",
    "created_at": "2022-03-29T16:28:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541836",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f67476f`](https://github.com/sagemath/sagetrac-mirror/commit/f67476f065a2ef7c4b03fcad486ace6e08d9230c)** to **[`538ead3`](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)**



---

archive/issue_comments_541837.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55\"><code>9385501</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7\"><code>abbb61f</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548\"><code>9bb72ea</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a\"><code>2c16704</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db\"><code>30642ba</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f80556745230bb13562c7501f5c736a35ba48b44\"><code>f805567</code></a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f\"><code>538ead3</code></a></td><td><code>First working prototype</code></td></tr></table>\n",
    "created_at": "2022-03-29T16:28:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541837",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55"><code>9385501</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7"><code>abbb61f</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548"><code>9bb72ea</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a"><code>2c16704</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db"><code>30642ba</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f80556745230bb13562c7501f5c736a35ba48b44"><code>f805567</code></a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f"><code>538ead3</code></a></td><td><code>First working prototype</code></td></tr></table>




---

archive/issue_comments_541838.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,19 @@\n-As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1)\n+As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.\n \n-In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n+To test, run `./sage --pytest src/sage/manifolds/`. This results in \n \n-For cython files: https://github.com/lgpage/pytest-cython\n+```\n+48 failed, 1416 passed, 7 warnings\n+```\n+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\n+To see examples of these failures, run pytest on\n+\n+```\n+src/sage/manifolds/differentiable/examples/sphere.py\n+src/sage/manifolds/utilities.py\n+src/sage/manifolds/chart.py\n+```\n+\n+Follow-ups:\n+- Fix these issues\n+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n``````\n",
    "created_at": "2022-04-05T19:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541838",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,19 @@
-As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1)
+As suggested in [#33232 comment:1](https://github.com/sagemath/sage/issues/33232#comment:1), `./sage --pytest` now uses pytest to discover and run doctests.
 
-In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.
+To test, run `./sage --pytest src/sage/manifolds/`. This results in 
 
-For cython files: https://github.com/lgpage/pytest-cython
+```
+48 failed, 1416 passed, 7 warnings
+```
+With many of the failed tests being due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
+To see examples of these failures, run pytest on
+
+```
+src/sage/manifolds/differentiable/examples/sphere.py
+src/sage/manifolds/utilities.py
+src/sage/manifolds/chart.py
+```
+
+Follow-ups:
+- Fix these issues
+- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
``````




---

archive/issue_events_457332.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T19:44:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457332"
}
```



---

archive/issue_comments_541839.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThere are still a few issues, but as a first version it should be good to go.",
    "created_at": "2022-04-05T19:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541839",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:9" align="right">comment:9</div>

There are still a few issues, but as a first version it should be good to go.



---

archive/issue_events_457333.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T19:44:34Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "title_is": "Use pytest to run doctests",
    "title_was": "Replace custom Sage doctest discovery by pytest (using pytest_collect_file)",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457333"
}
```



---

archive/issue_comments_541840.json:
```json
{
    "body": "Changed commit from **[`538ead3`](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)** to **[`58e11d7`](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)**",
    "created_at": "2022-04-05T19:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541840",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`538ead3`](https://github.com/sagemath/sagetrac-mirror/commit/538ead395132b0fde5b9e4ee0738c1883610e82f)** to **[`58e11d7`](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)**



---

archive/issue_comments_541841.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65\"><code>d881a5a</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107\"><code>1242e1f</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b\"><code>0d9225d</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de\"><code>05bc58f</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591\"><code>8825079</code></a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e6bc871ab72e1f1fd11caf14baeeea9466feaa1\"><code>5e6bc87</code></a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d36adf4084c117fbb3da87232c74ba6b155d0307\"><code>d36adf4</code></a></td><td><code>Fix import of sage.all in tests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/813a5416f05702eecfe5fd1b54f3ae379ca1981a\"><code>813a541</code></a></td><td><code>Add vs code config to debug pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e\"><code>d3fdd95</code></a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8\"><code>58e11d7</code></a></td><td><code>Fix checker and namespace injection</code></td></tr></table>\n",
    "created_at": "2022-04-05T19:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541841",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65"><code>d881a5a</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107"><code>1242e1f</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b"><code>0d9225d</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de"><code>05bc58f</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591"><code>8825079</code></a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e6bc871ab72e1f1fd11caf14baeeea9466feaa1"><code>5e6bc87</code></a></td><td><code>Merge remote-tracking branch 'origin/u/mkoeppe/sage__pytest' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d36adf4084c117fbb3da87232c74ba6b155d0307"><code>d36adf4</code></a></td><td><code>Fix import of sage.all in tests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/813a5416f05702eecfe5fd1b54f3ae379ca1981a"><code>813a541</code></a></td><td><code>Add vs code config to debug pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3fdd951e5c37ebdac17f8d1fbc86ed8f36dff7e"><code>d3fdd95</code></a></td><td><code>Cleanup vscode config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8"><code>58e11d7</code></a></td><td><code>Fix checker and namespace injection</code></td></tr></table>




---

archive/issue_comments_541842.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,3 +17,7 @@\n Follow-ups:\n - Fix these issues\n - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n+\n+---\n+\n+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n``````\n",
    "created_at": "2022-04-05T19:47:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541842",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,3 +17,7 @@
 Follow-ups:
 - Fix these issues
 - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
+
+---
+
+Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
``````




---

archive/issue_comments_541843.json:
```json
{
    "body": "Replying to [ticket:33546 mkoeppe]:\n> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\nWould it be possible to add a doctest for that?",
    "created_at": "2022-04-05T21:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541843",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:33546 mkoeppe]:
> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

Would it be possible to add a doctest for that?



---

archive/issue_comments_541844.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nA concern from #33531?cnum_edit=14#comment:14:\n\n  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).",
    "created_at": "2022-05-01T20:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541844",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

A concern from #33531?cnum_edit=14#comment:14:

  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).



---

archive/issue_comments_541845.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThere are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).",
    "created_at": "2022-05-02T19:17:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541845",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:14" align="right">comment:14</div>

There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).



---

archive/issue_comments_541846.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@tobiasdiez](#comment%3A9):\n> There are still a few issues, but as a first version it should be good to go.\n\nI haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?",
    "created_at": "2022-05-02T21:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541846",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@tobiasdiez](#comment%3A9):
> There are still a few issues, but as a first version it should be good to go.

I haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?



---

archive/issue_comments_541847.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@tobiasdiez](#comment%3A14):\n> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\nParallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nNon-rethorical question: what is the advantage of pytest over the current sage doctest framework?",
    "created_at": "2022-05-02T22:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541847",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@tobiasdiez](#comment%3A14):
> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?



---

archive/issue_comments_541848.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tornaria](#comment%3A16):\n> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\nMy own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?",
    "created_at": "2022-05-02T23:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541848",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tornaria](#comment%3A16):
> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?



---

archive/issue_comments_541849.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tornaria](#comment%3A16):\n> Replying to [@tobiasdiez](#comment%3A14):\n> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\n> \n> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nIf I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). \n\nAnyway, both packages are ordinary pip installable packages.",
    "created_at": "2022-05-04T09:54:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541849",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tornaria](#comment%3A16):
> Replying to [@tobiasdiez](#comment%3A14):
> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

> 
> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

If I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). 

Anyway, both packages are ordinary pip installable packages.



---

archive/issue_comments_541850.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@kiwifb](#comment%3A17):\n> Replying to [@tornaria](#comment%3A16):\n> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\n> \n> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?\n\nCannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).",
    "created_at": "2022-05-04T10:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541850",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@kiwifb](#comment%3A17):
> Replying to [@tornaria](#comment%3A16):
> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

> 
> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?

Cannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).



---

archive/issue_comments_541851.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@tobiasdiez](#comment%3A18):\n> Replying to [@tornaria](#comment%3A16):\n> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]\n\n> If I'm not mistaken that only runs the tests in multiple independent workers\n\nThat's right.\n\n> But as far as I'm aware there are no extensive tests of sage with concurrency\n\nYes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.\n\n> multiple threads sharing the same state (i.e. pytest-parallel). \n\nLooks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.",
    "created_at": "2022-05-04T16:39:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541851",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@tobiasdiez](#comment%3A18):
> Replying to [@tornaria](#comment%3A16):
> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]

> If I'm not mistaken that only runs the tests in multiple independent workers

That's right.

> But as far as I'm aware there are no extensive tests of sage with concurrency

Yes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.

> multiple threads sharing the same state (i.e. pytest-parallel). 

Looks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.



---

archive/issue_comments_541852.json:
```json
{
    "body": "Author: **Tobias Diez**",
    "created_at": "2022-05-04T17:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541852",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Tobias Diez**



---

archive/issue_events_457334.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-04T17:24:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457334"
}
```



---

archive/issue_events_457335.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-04T17:24:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457335"
}
```



---

archive/issue_comments_541853.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\ncomment:15",
    "created_at": "2022-05-04T17:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541853",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">comment:21</div>

comment:15



---

archive/issue_comments_541854.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nWhat issues did you encounter?",
    "created_at": "2022-05-05T22:39:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541854",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:22" align="right">comment:22</div>

What issues did you encounter?



---

archive/issue_comments_541855.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\npytest now runs doctests, and you say that there will be failures.\n\nBut `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n\nCorrect?",
    "created_at": "2022-05-05T22:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541855",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

pytest now runs doctests, and you say that there will be failures.

But `sage -t` also runs pytest, so now there will be failures in `sage -t`.

Correct?



---

archive/issue_comments_541856.json:
```json
{
    "body": "Changed commit from **[`58e11d7`](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)** to **[`f863428`](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)**",
    "created_at": "2022-05-06T22:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541856",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`58e11d7`](https://github.com/sagemath/sagetrac-mirror/commit/58e11d707764c4e7c85bf1c5beb8bf257c0318d8)** to **[`f863428`](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)**



---

archive/issue_comments_541857.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686\"><code>ff4056b</code></a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3\"><code>e62c29b</code></a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a\"><code>3ee9815</code></a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221\"><code>f863428</code></a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr></table>\n",
    "created_at": "2022-05-06T22:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541857",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:24"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff4056befc38459ff992a7ecb4a4de0fd5f26686"><code>ff4056b</code></a></td><td><code>Merge branch 'develop' into public/tests/pytest_doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e62c29b48b8fb6e23a597cc12584fe1a209092d3"><code>e62c29b</code></a></td><td><code>Cleanup imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ee9815f55793429d2ea444a5b823ed18b006d6a"><code>3ee9815</code></a></td><td><code>Add test that pytest correctly fails on example</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221"><code>f863428</code></a></td><td><code>Only run doctests in pytest when doctest-modules is specified</code></td></tr></table>




---

archive/issue_comments_541858.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@mkoeppe](#comment%3A12):\n> Replying to [ticket:33546 mkoeppe]:\n> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\n> \n> Would it be possible to add a doctest for that?\n\nAdded a pytest for it.",
    "created_at": "2022-05-06T22:33:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541858",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@mkoeppe](#comment%3A12):
> Replying to [ticket:33546 mkoeppe]:
> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

> 
> Would it be possible to add a doctest for that?

Added a pytest for it.



---

archive/issue_comments_541859.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@mkoeppe](#comment%3A23):\n> pytest now runs doctests, and you say that there will be failures.\n> \n> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n> \n> Correct?\n\nThe idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!",
    "created_at": "2022-05-06T22:36:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541859",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@mkoeppe](#comment%3A23):
> pytest now runs doctests, and you say that there will be failures.
> 
> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.
> 
> Correct?

The idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!



---

archive/issue_events_457336.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-06T22:36:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457336"
}
```



---

archive/issue_events_457337.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-06T22:36:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457337"
}
```



---

archive/issue_comments_541860.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\n\n```\n[pytest]\n python_files = *_test.py\n+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n```\n`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist",
    "created_at": "2022-05-06T23:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541860",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>


```
[pytest]
 python_files = *_test.py
+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
```
`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist



---

archive/issue_comments_541861.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nAlso could you update the ticket description please?",
    "created_at": "2022-05-06T23:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541861",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

Also could you update the ticket description please?



---

archive/issue_comments_541862.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,10 +14,9 @@\n src/sage/manifolds/chart.py\n ```\n \n+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n+\n Follow-ups:\n - Fix these issues\n - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n----\n-\n-Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n``````\n",
    "created_at": "2022-05-08T08:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541862",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,10 +14,9 @@
 src/sage/manifolds/chart.py
 ```
 
+We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
+
 Follow-ups:
 - Fix these issues
 - Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
----
-
-Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
``````




---

archive/issue_comments_541863.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144\"><code>428a18c</code></a></td><td><code>Remove nonexisting paths from config</code></td></tr></table>\n",
    "created_at": "2022-05-08T08:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541863",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144"><code>428a18c</code></a></td><td><code>Remove nonexisting paths from config</code></td></tr></table>




---

archive/issue_comments_541864.json:
```json
{
    "body": "Changed commit from **[`f863428`](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)** to **[`428a18c`](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)**",
    "created_at": "2022-05-08T08:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541864",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f863428`](https://github.com/sagemath/sagetrac-mirror/commit/f863428150c03430bbc072d7386f3c8dd9a64221)** to **[`428a18c`](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)**



---

archive/issue_comments_541865.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@mkoeppe](#comment%3A27):\n> \n> ```\n> [pytest]\n>  python_files = *_test.py\n> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n> ```\n> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist\n\nYou are right. Not sure why I've added them in the first place, but I've removed them now.",
    "created_at": "2022-05-08T08:53:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541865",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@mkoeppe](#comment%3A27):
> 
> ```
> [pytest]
>  python_files = *_test.py
> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
> ```
> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist

You are right. Not sure why I've added them in the first place, but I've removed them now.



---

archive/issue_comments_541866.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nIn a build without `--enable-editable`:\n\n```\n./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests\n=================================================================================================== test session starts ====================================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini\ncollected 0 items / 2 errors                                                                                                                                                                                               \n\n========================================================================================================== ERRORS ==========================================================================================================\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nsrc/conftest.py:93: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call\n    result: Optional[TResult] = func()\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>\n    call = CallInfo.from_call(lambda: list(collector.collect()), \"collect\")\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n================================================================================================= short test summary info ==================================================================================================\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================== 2 errors in 1.16s =====================================================================================================\n```",
    "created_at": "2022-05-08T20:29:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541866",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

In a build without `--enable-editable`:

```
./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests
=================================================================================================== test session starts ====================================================================================================
platform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini
collected 0 items / 2 errors                                                                                                                                                                                               

========================================================================================================== ERRORS ==========================================================================================================
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
src/conftest.py:93: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call
    result: Optional[TResult] = func()
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>
    call = CallInfo.from_call(lambda: list(collector.collect()), "collect")
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
================================================================================================= short test summary info ==================================================================================================
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================== 2 errors in 1.16s =====================================================================================================
```



---

archive/issue_comments_541867.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). \n\nThe strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.",
    "created_at": "2022-05-08T21:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541867",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:33" align="right">comment:33</div>

I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). 

The strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.



---

archive/issue_comments_541868.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nYou can just reconfigure without --enable-editable and rebuild to test",
    "created_at": "2022-05-08T21:28:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541868",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

You can just reconfigure without --enable-editable and rebuild to test



---

archive/issue_comments_541869.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25\"><code>cc19e92</code></a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr></table>\n",
    "created_at": "2022-05-09T12:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541869",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25"><code>cc19e92</code></a></td><td><code>Specify importlib as import mode to be consistent</code></td></tr></table>




---

archive/issue_comments_541870.json:
```json
{
    "body": "Changed commit from **[`428a18c`](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)** to **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**",
    "created_at": "2022-05-09T12:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541870",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`428a18c`](https://github.com/sagemath/sagetrac-mirror/commit/428a18ca7d8cd9d2423aa2f66dbd069a906ac144)** to **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**



---

archive/issue_comments_541871.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nShould work now.",
    "created_at": "2022-05-09T12:36:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541871",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:36" align="right">comment:36</div>

Should work now.



---

archive/issue_events_457338.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:30:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457338"
}
```



---

archive/issue_events_457339.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-09T17:30:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457339"
}
```



---

archive/issue_comments_541872.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2022-05-09T17:30:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541872",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_541873.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI've opened tickets for the follow-ups.",
    "created_at": "2022-05-09T17:38:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541873",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

I've opened tickets for the follow-ups.



---

archive/issue_comments_541874.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,6 +17,7 @@\n We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.\n \n Follow-ups:\n-- Fix these issues\n-- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n+- #33826 Fix these issues\n+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel\n+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython\n \n``````\n",
    "created_at": "2022-05-09T17:38:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541874",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,6 +17,7 @@
 We also add tests that verify that `sage --pytest` (and `sage -t`) correctly complain about failing doctests.
 
 Follow-ups:
-- Fix these issues
-- Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
+- #33826 Fix these issues
+- #33825 Use `pytest-parallel` or `pytest-xdist` to run pytest in parallel
+- #33827 Also run doctests defined in cython files using https://github.com/lgpage/pytest-cython
 
``````




---

archive/issue_comments_541875.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nTwo times thanks!",
    "created_at": "2022-05-09T20:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541875",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:39" align="right">comment:39</div>

Two times thanks!



---

archive/issue_events_457340.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-05-20T22:27:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457340"
}
```



---

archive/issue_events_457341.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2b8d71370eae2219e977ecda71580b933a2c55c6",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-05-20T22:27:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33546#event-457341"
}
```



---

archive/issue_comments_541876.json:
```json
{
    "body": "Changed branch from **[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)** to **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**",
    "created_at": "2022-05-20T22:27:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541876",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/tests/pytest_doctests](https://github.com/sagemath/sagetrac-mirror/tree/public/tests/pytest_doctests)** to **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)**



---

archive/issue_comments_541877.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nsee #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.",
    "created_at": "2022-12-07T10:00:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541877",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.



---

archive/issue_comments_541878.json:
```json
{
    "body": "Changed commit from **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)** to none",
    "created_at": "2022-12-07T10:00:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541878",
    "user": "https://github.com/dimpase"
}
```

Changed commit from **[`cc19e92`](https://github.com/sagemath/sagetrac-mirror/commit/cc19e927a49efbd31d693b2f70bad48203ea8a25)** to none



---

archive/issue_comments_541879.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [Dima Pasechnik](#comment%3A41):\n>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.\n\nOpened a followup ticket #34829 to deal with this.",
    "created_at": "2022-12-07T10:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33546#issuecomment-541879",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [Dima Pasechnik](#comment%3A41):
>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.

Opened a followup ticket #34829 to deal with this.
