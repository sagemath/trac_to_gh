# Issue 23035: OpenBLAS - alterations for TARGET

Issue created by migration from https://trac.sagemath.org/ticket/23272

Original creator: aram.dermenjian

Original creation time: 2017-06-18 18:17:08

CC:  jpflori vbraun jdemeyer moritz

Keywords: openblas

On purchasing a new laptop, I attempted to MAKE sage as I normally have and ran into the following error:



```

Error building Sage. 

The following package(s) may have failed to build (not necessarily during this run of 'make all'):

* package: openblas-0.2.19.p0 
  log file: /sage/sage/logs/pkgs/openblas-0.2.19.p0.log
  build directory: /sage/sage/local/var/tmp/sage/build/openblas-0.2.19.p0
```


The error seemed to be really coming from:


```
                                               ^
make[3]: *** [getarch_2nd] Error 1
Makefile:123: *** OpenBLAS: Detecting CPU failed. Please set TARGET explicitly, e.g. make TARGET=your_cpu_target. Please read README for the detail..  Stop.
make[3]: Leaving directory '/sage/sage/local/var/tmp/sage/build/openblas-0.2.19.p0/src'
Error building OpenBLAS
```



It turned out that this error has been seen multiple times in Sage:
https://groups.google.com/forum/#!topic/sage-devel/zQsZsivts0I
https://groups.google.com/forum/#!topic/sage-release/3QJoAgg9bgo

etc.

I noticed that updating the config (as mentioned in the threads above) accurately solved the problem, but I wanted to try and fix the problem head on rather than just temporarily solve it. With that in mind, I conversed with the OpenBLAS people:
https://github.com/xianyi/OpenBLAS/issues/1204
and they suggested I update the cpu file for the build, which I have included.

Additionally, I wanted to fix this problem for future users and thus I wanted to add a fail-safe for the code so that if this error happens again, then we automatically try the TARGET=ATOM method. But, I want to create this with the caveat that a user can change the method.

Something to note: There is no planned update to OpenBLAS as the project lead has disappeared apparently:
https://github.com/xianyi/OpenBLAS/issues/1118

Before finalizing these changes, we should note a few things, but as I've not worked that long with sage I don't know how to address them. In essence:

 - Are the changes I made appropriate for the make?
 - I'm adding documentation on this as there is no documentation.
 - There was questions on why we have "p0" at the end of our version? I assume this is from the patch, but I don't know. 
 - The programmer suggested we change the " top level option to use -lblas (debian/ubuntu) -lopenblas (suse/fedora/epel)". I don't know what that means in regards to us, but figured someone might be able to answer this question and maybe we can ensure this is happening.

If there are any questions feel free to ask, and if you believe this is not necessarily or if something else is better practice, let me know. I've never done a bash alteration so not sure what the details for that.


---

Comment by aram.dermenjian created at 2017-06-18 18:37:26

New commits:


---

Comment by aram.dermenjian created at 2017-06-18 18:37:26

Changing type from defect to enhancement.


---

Comment by aram.dermenjian created at 2017-06-18 18:38:37

Changing status from new to needs_review.


---

Comment by aram.dermenjian created at 2017-06-18 18:38:37

I'm setting the status to needs review mainly to get people's attention. I assume there will be things that need to be changed.


---

Comment by nthiery created at 2017-06-22 21:14:40

We discussed a bit. In the long run, we would like OpenBlas to provide a short mantra
to configure itself with "use Atom by default if target unavailable".

For now, I wondered about separating somewhat more the configuration part from the compilation, by adding a new dependency in OpenBlas makefile like:

```
    is_architecture_available:
         <here the logic from the beginning of the `libs` dependency
```


and then, in spkg-install / spkg-check do first a call to

```
    make is_architecture_available
```

do the additional logic if needed, and then just call make as usual.

Just throwing ideas in the air; not sure this is the right thing to do.

Insights anyone?


---

Comment by jdemeyer created at 2017-06-30 14:07:57

I don't really like that we are just guessing `ATOM` as a fall-back when the build failed. I would prefer to just let the failed build be failed (possibly with an error message suggesting `OPENBLAS_CONFIGURE="TARGET=ATOM"` or something).

Also, if you add a patch, you should bump the version number of openblas (from `0.2.19` to `0.2.19.p0`).


---

Comment by git created at 2017-07-14 11:24:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aram.dermenjian created at 2017-07-14 11:29:01

New commits:


---

Comment by aram.dermenjian created at 2017-07-14 11:32:55

So the reason we are just guessing "ATOM" is because that was the recommended fall-back by the openblas team. (You can see the conversation I had in the link I posted)

THe problem with just letting the build fail is that as new computers come out with new CPUs these CPUs will not be included in the openblas config which tests against CPU. In other words all future computers will start having problems when new CPUs get introduced. Since OpenBLAS doesn't update regularly, we can't rely on us to "remember" every time a new CPU gets released.

The point of this ticket is to upgrade the openblas script through a patch so that new CPUs that have been added in the last year will now properly be able to get a target. Additionally, it will protect us for future CPUs by defaulting to ATOM until we get an update to OpenBLAS.

Note that the version is already `0.2.19.p0` so I've let it as is.


---

Comment by vbraun created at 2017-07-22 15:40:19

Typo: OpenBAS -> OpenBLAS

I agree that it would be best if OpenBLAS would just default to something sensible if it can't detect the CPU. But, unless thats implemented, we should just try a second time with TARGET=ATOM. I'd prefer if we just unconditionally try that a second time and not rely on the spelling of the logged error message, or the location of the log file.

OpenBLAS 0.2.20 should be released really soon now...


---

Comment by vbraun created at 2017-07-22 15:41:33

PS: the patchlevel should be increased 0.2.19.p0 -> 0.2.19.p1 to trigger recompilation.


---

Comment by fbissey created at 2017-07-24 04:31:22

I just received a notice that openblas 0.2.20 has been released

```
Version 0.2.20

24-Jul-2017



common:

        * Improved CMake support

        * Fixed several thread race and locking bugs

        * Fixed default LAPACK optimization level

        * Updated LAPACK to 3.7.0

        * Added ReLAPACK (https://github.com/HPAC/ReLAPACK, make BUILD_RELAPACK=1)



POWER:

        * Optimizations for Power9

        * Fixed several Power8 assembly bugs

....
x86_64:

        * Detect Intel Bay Trail and Apollo Lake

        * Detect Intel Sky Lake and Kaby Lake

        * Detect Intel Knights Landing

        * Detect AMD A8, A10, A12 and Ryzen

        * Support 64bit builds with Visual Studio

        * Fix building with Intel and PGI compilers

        * Fix building with MINGW and TDM-GCC

        * Fix cmake builds for Haswell and related cpus

        * Fix building for Sandybridge with CLANG 3.9

* Add support for the FLANG compiler

....
```

While some of the improvements in this ticket should be kept, I think it would be best if it became an upgrade ticket.


---

Comment by fbissey created at 2017-07-24 05:27:24

Upgrading should also get rid of us of all the current patches except for `openblas-0.2.19-SMP_conditional.patch` (because the PR for it is still sitting on my HD - real life happened and it got forgotten).


---

Comment by dimpase created at 2017-07-24 11:21:45

alive and kicking: https://github.com/xianyi/OpenBLAS/commits/develop


---

Comment by embray created at 2017-07-31 11:44:40


```
if grep -q "Detecting CPU failed. Please set TARGET explicitly" "${SAGE_ROOT}/logs/pkgs/openblas-$(<${SAGE_ROOT}/build/pkgs/openblas/package-version.txt).log"; then
```


This isn't going to work for a number reasons; for one the log files are usually appended to so this will be true for builds that failed but then later succeeded if the log files were not deleted first.

Better to explicitly tee the configure command to a separate log file and grep that.


---

Comment by git created at 2017-08-10 14:18:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aram.dermenjian created at 2017-08-10 14:21:56

So in this update I've gone ahead and updated the version and removed the unnecessary patches (keeping the one mentioned by fbissey). I've not worked with packages before so I don't know how I'm supposed to actually get the package itself onto the servers? I personally added it directly into my personal upstream, but not sure if that is a viable solution?

I've also removed the documentation test and instead went with a TARGET test like I had done before. I've gone to my old method of just retrying with "TARGET=ATOM" as was also suggested by vbraun.


---

Comment by dimpase created at 2017-08-17 09:21:04

Where is the updated tarball (the one with

```
+sha1=a186074145a24823e82c65672dad1cd1ca6fe89c
+md5=48637eb29f5b492b91459175dcc574b1
+cksum=607023019
```

How does one get it?
Please provide a link.


---

Comment by dimpase created at 2017-08-17 09:22:18

Once the ticket is positively reviewed and merged, a copy of the tarball will be put on sagemath mirrors by the release manager.


---

Comment by dimpase created at 2017-08-17 09:32:34

OK, I gather it's the official openblas release tarball (md5sum is right). I've modified the ticket description accordingly.


---

Comment by isuruf created at 2017-08-17 21:12:46

You might want to wait till 0.2.21. See https://github.com/xianyi/OpenBLAS/issues/1258#issuecomment-320223121


---

Comment by fbissey created at 2017-08-20 23:09:06

Release seems to be tardy. Possibly because they were moving to a 0.3.0 release. We could adopt https://github.com/xianyi/OpenBLAS/commit/63cfa32691680505e6b9daf0997755178ddd3144 instead.


---

Comment by aram.dermenjian created at 2017-08-23 01:41:15

`@`dimpase Yes, that was the correct one.

`@`isuruf `@`fbissey Thanks for the update. I think we might want to consider their release 0.2.21 branch (https://github.com/xianyi/OpenBLAS/tree/release-0.2.21) as it seems to include exactly the patches that are needed to fix the issue that is discussed in Issue 1258 of OpenBLAS (https://github.com/xianyi/OpenBLAS/issues/1258#issuecomment-320223121). I'm going to respond on the issue thread they have there. We'll see if they have any updates. I don't think they are waiting for 0.3.0 release as that issue was created after they had started talking about 0.3.0. So I don't believe that to be the case.


---

Comment by git created at 2017-09-01 19:00:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aram.dermenjian created at 2017-09-01 19:03:01

Ok, so according to the authors, v0.2.21 is likely not going to be coming out soon and that the only change is one patch which was added to master. Instead of rezipping everything, I've decided to just add this patch into our patches directory and upload that directly.

Everything is working on my end and this ticket is now ready for review.


---

Comment by git created at 2017-09-01 19:03:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2017-09-28 12:20:43

I think this needs updating for openblas-0.2.19-cygwin.patch


---

Comment by aram.dermenjian created at 2017-09-28 13:10:06

I had removed all of the patches except for one. If the cygwin patch is required I can re-add it in.


---

Comment by vbraun created at 2017-09-28 13:16:45

It was recently added; please merge in the latest beta


---

Comment by aram.dermenjian created at 2017-09-28 19:10:48

`@`vbraun I don't know what you mean by the latest beta. Can you be a little more specific? (Do you have a link? I can try mergeing it in and making sure it works. Alternatively, if you've already access to the beta on your machine you can try integrating it and then I can pull and test it on mine as well?)


---

Comment by vbraun created at 2017-09-29 06:54:10

I just mean the latest develop branch, e.g. on trac: `git remote update trac && git merge trac/develop`


---

Comment by git created at 2017-10-04 17:27:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aram.dermenjian created at 2017-10-04 17:31:28

I kept having problems merging in the cygwin patch (kept failing on my build for some reason) I fixed it and have merged again with the latest develop. It should be ready for testing now.


---

Comment by moritz created at 2017-10-12 20:04:30

I don't have much time to look into the ticket, but just wanted to confirm, that it worked for me.

sage 8.1.beta7 didn't compile on a debian box with a kaby lake i7-7500U CPU, because of the 'missing target' openblas error. 

After loading this patch it worked like a charm (All tests passed). I guess it is useful to have a fix even after the problem for my specific cpu will be fixed upstream; there always will be newer cpus...


---

Comment by moritz created at 2017-10-17 17:44:24

In sage 8.1.beta8, I simply compiled with
`export OPENBLAS_CONFIGURE="TARGET=HASWELL"`
(with a kabylake CPU..) seems to work.


---

Comment by vbraun created at 2017-11-06 21:12:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-11-08 19:23:45

On two 32-bit buildbots:

```
**********************************************************************
File "src/sage/numerical/sdp.pyx", line 100, in sage.numerical.sdp
Failed example:
    p.dual_variable(1)  # rel tol 1e-03
Expected:
    [ 85555.0 -85555.0]
    [-85555.0  85555.0]
Got:
    [ 85463.87196917446 -85463.87196914306]
    [-85463.87196914306  85463.87196917432]
Tolerance exceeded in 4 of 4:
    85555.0 vs 85463.87196917446, tolerance 1e-03 > 1e-03
    -85555.0 vs -85463.87196914306, tolerance 1e-03 > 1e-03
    -85555.0 vs -85463.87196914306, tolerance 1e-03 > 1e-03
    85555.0 vs 85463.87196917432, tolerance 1e-03 > 1e-03
**********************************************************************
1 item had failures:
   1 of  41 in sage.numerical.sdp
    [283 tests, 1 failure, 0.75 s]
----------------------------------------------------------------------
sage -t --long src/sage/numerical/sdp.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2017-11-08 19:23:53

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2017-11-08 22:10:18

OK, I'll increase the tolerance to 2e-03 there.


---

Comment by dimpase created at 2017-11-08 22:12:57

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2017-11-08 22:12:57

New commits:


---

Comment by andy created at 2017-11-13 01:07:13

This fixed the build under error I was having on Ubuntu 17.10. The /proc/cpuinfo identifies the CPU as:

Intel(R) Core(TM) i7-7500U CPU `@` 2.70GHz


---

Comment by vbraun created at 2017-11-15 01:24:30

Resolution: fixed


---

Comment by slelievre created at 2017-11-18 22:38:33

(Minor fix to ticket description formatting.)
