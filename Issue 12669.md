# Issue 12669: update M4RIE to newest upstream release

archive/issues_012669.json:
```json
{
    "body": "Assignee: tbd\n\nas the title says.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12841\n\n",
    "created_at": "2012-04-13T19:41:10Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.3",
    "title": "update M4RIE to newest upstream release",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12669",
    "user": "https://github.com/malb"
}
```
Assignee: tbd

as the title says.

Issue created by migration from https://trac.sagemath.org/ticket/12841





---

archive/issue_comments_151015.json:
```json
{
    "body": "Attachment [trac_12841_m4rie_new_version.patch](tarball://root/attachments/some-uuid/ticket12841/trac_12841_m4rie_new_version.patch) by @malb created at 2012-04-13 19:50:35",
    "created_at": "2012-04-13T19:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151015",
    "user": "https://github.com/malb"
}
```

Attachment [trac_12841_m4rie_new_version.patch](tarball://root/attachments/some-uuid/ticket12841/trac_12841_m4rie_new_version.patch) by @malb created at 2012-04-13 19:50:35



---

archive/issue_comments_151016.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-13T23:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151016",
    "user": "https://github.com/malb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_151017.json:
```json
{
    "body": "Note that the SPKG is based on #12821",
    "created_at": "2012-04-13T23:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151017",
    "user": "https://github.com/malb"
}
```

Note that the SPKG is based on #12821



---

archive/issue_comments_151018.json:
```json
{
    "body": "I get an error with SAGE_CHECK on\n\n\n\n```\nFAIL: test_ple\n===================\n5 of 5 tests failed\n===================\nmake[4]: *** [check-TESTS] Error 1\nmake[4]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\nmake[3]: *** [check-am] Error 2\nmake[3]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\nmake[2]: *** [check-recursive] Error 1\nmake[2]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\n```\n\n\nThis is on Ubuntu 12.04 (32 bit) on vmware in Windows 7. \ngcc version 4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu4) \n\nI got this with the previous package as well. \n\nadam",
    "created_at": "2012-04-14T04:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151018",
    "user": "https://github.com/maxthemouse"
}
```

I get an error with SAGE_CHECK on



```
FAIL: test_ple
===================
5 of 5 tests failed
===================
make[4]: *** [check-TESTS] Error 1
make[4]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
make[3]: *** [check-am] Error 2
make[3]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
make[2]: *** [check-recursive] Error 1
make[2]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
```


This is on Ubuntu 12.04 (32 bit) on vmware in Windows 7. 
gcc version 4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu4) 

I got this with the previous package as well. 

adam



---

archive/issue_comments_151019.json:
```json
{
    "body": "Replying to [comment:6 awebb]:\n> I get an error with SAGE_CHECK on\n> \n> \n> {{{\n> FAIL: test_ple\n> ===================\n> 5 of 5 tests failed\n> ===================\n> make[4]: *** [check-TESTS] Error 1\n> make[4]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\n> make[3]: *** [check-am] Error 2\n> make[3]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\n> make[2]: *** [check-recursive] Error 1\n> make[2]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'\n> }}}\n> \n> This is on Ubuntu 12.04 (32 bit) on vmware in Windows 7. \n> gcc version 4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu4) \n> \n> I got this with the previous package as well. \n> \n> adam\n\nHi, unfortunately, that error message doesn't say much more than that there were errors. \n\n* The log should contain more detailed information, can you post this?\n* Also, by previous package you mean version 20111004?",
    "created_at": "2012-04-14T10:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151019",
    "user": "https://github.com/malb"
}
```

Replying to [comment:6 awebb]:
> I get an error with SAGE_CHECK on
> 
> 
> {{{
> FAIL: test_ple
> ===================
> 5 of 5 tests failed
> ===================
> make[4]: *** [check-TESTS] Error 1
> make[4]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
> make[3]: *** [check-am] Error 2
> make[3]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
> make[2]: *** [check-recursive] Error 1
> make[2]: Leaving directory `/home/math/sage/spkg/build/libm4rie-20120415/src'
> }}}
> 
> This is on Ubuntu 12.04 (32 bit) on vmware in Windows 7. 
> gcc version 4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu4) 
> 
> I got this with the previous package as well. 
> 
> adam

Hi, unfortunately, that error message doesn't say much more than that there were errors. 

* The log should contain more detailed information, can you post this?
* Also, by previous package you mean version 20111004?



---

archive/issue_comments_151020.json:
```json
{
    "body": "Do I just use the spkg above or do I need to apply the patch as well?\n\nI have tried with libm4rie-20111004.p2.spkg and libm4rie-20111004.p3.spkg and got the same error. The log doesn't have any details at all. The error occurs during the make  check-TESTS portion of the build. It just lists off a pile of tests and ends each section with things like  FAIL: test_trsm. The odd part is that there are no fail messages anywhere else.\n\nThe home directories are not yet present on sage.math.washinton.edu but once they are I will upload the log file.",
    "created_at": "2012-04-14T17:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151020",
    "user": "https://github.com/maxthemouse"
}
```

Do I just use the spkg above or do I need to apply the patch as well?

I have tried with libm4rie-20111004.p2.spkg and libm4rie-20111004.p3.spkg and got the same error. The log doesn't have any details at all. The error occurs during the make  check-TESTS portion of the build. It just lists off a pile of tests and ends each section with things like  FAIL: test_trsm. The odd part is that there are no fail messages anywhere else.

The home directories are not yet present on sage.math.washinton.edu but once they are I will upload the log file.



---

archive/issue_comments_151021.json:
```json
{
    "body": "I fixed the issue in https://bitbucket.org/malb/m4rie/changeset/81d352a8aade and replaced the SPKG with a version with this fix applied.",
    "created_at": "2012-04-14T20:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151021",
    "user": "https://github.com/malb"
}
```

I fixed the issue in https://bitbucket.org/malb/m4rie/changeset/81d352a8aade and replaced the SPKG with a version with this fix applied.



---

archive/issue_comments_151022.json:
```json
{
    "body": "I tried again and got the same result. The log is at [http://sage.math.washington.edu/home/awebb/libm4rie-20120415.log](http://sage.math.washington.edu/home/awebb/libm4rie-20120415.log). I see anything useful in the log however.",
    "created_at": "2012-04-14T21:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151022",
    "user": "https://github.com/maxthemouse"
}
```

I tried again and got the same result. The log is at [http://sage.math.washington.edu/home/awebb/libm4rie-20120415.log](http://sage.math.washington.edu/home/awebb/libm4rie-20120415.log). I see anything useful in the log however.



---

archive/issue_comments_151023.json:
```json
{
    "body": "correction: I Don't see anything in the log that is useful. A.",
    "created_at": "2012-04-14T21:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151023",
    "user": "https://github.com/maxthemouse"
}
```

correction: I Don't see anything in the log that is useful. A.



---

archive/issue_comments_151024.json:
```json
{
    "body": "Argh, that's because I uploaded the wrong file again. I fixed it and replaced the file.",
    "created_at": "2012-04-14T21:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151024",
    "user": "https://github.com/malb"
}
```

Argh, that's because I uploaded the wrong file again. I fixed it and replaced the file.



---

archive/issue_comments_151025.json:
```json
{
    "body": "It looks like it worked. At least it built. I now have a ppl problem but that might have already been reported.",
    "created_at": "2012-04-14T23:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151025",
    "user": "https://github.com/maxthemouse"
}
```

It looks like it worked. At least it built. I now have a ppl problem but that might have already been reported.



---

archive/issue_comments_151026.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-15T13:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151026",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_151027.json:
```json
{
    "body": "The new spkg wants to run `autoheader`.  This probably means that upstream should run `autoreconf` before shipping their sources.\n\n```\nMaking install in .\nmake[1]: Entering directory `/usr/local/src/sage-5.0.beta13/spkg/build/libm4rie-20120415/src'\n(CDPATH=\"${ZSH_VERSION+.}:\" && cd . && /bin/sh /usr/local/src/sage-5.0.beta13/spkg/build/libm4rie-20120415/src/missing --run autoheader)\nrm -f src/stamp-h1\ntouch src/config.h.in\n```\n",
    "created_at": "2012-04-15T13:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151027",
    "user": "https://github.com/jdemeyer"
}
```

The new spkg wants to run `autoheader`.  This probably means that upstream should run `autoreconf` before shipping their sources.

```
Making install in .
make[1]: Entering directory `/usr/local/src/sage-5.0.beta13/spkg/build/libm4rie-20120415/src'
(CDPATH="${ZSH_VERSION+.}:" && cd . && /bin/sh /usr/local/src/sage-5.0.beta13/spkg/build/libm4rie-20120415/src/missing --run autoheader)
rm -f src/stamp-h1
touch src/config.h.in
```




---

archive/issue_comments_151028.json:
```json
{
    "body": "This is exactly the same problem which I already fixed once in #12501.",
    "created_at": "2012-04-15T13:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151028",
    "user": "https://github.com/jdemeyer"
}
```

This is exactly the same problem which I already fixed once in #12501.



---

archive/issue_comments_151029.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> The new spkg wants to run `autoheader`.  This probably means that upstream should run `autoreconf` before shipping their sources.\n\nUpstream does that: https://bitbucket.org/malb/m4ri-scripts/src/tip/release.py#cl-35 but I added a touch configure afterwards. I also touched configure in the SPKG linked above.",
    "created_at": "2012-04-15T14:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151029",
    "user": "https://github.com/malb"
}
```

Replying to [comment:14 jdemeyer]:
> The new spkg wants to run `autoheader`.  This probably means that upstream should run `autoreconf` before shipping their sources.

Upstream does that: https://bitbucket.org/malb/m4ri-scripts/src/tip/release.py#cl-35 but I added a touch configure afterwards. I also touched configure in the SPKG linked above.



---

archive/issue_comments_151030.json:
```json
{
    "body": "Are you sure you updated the spkg correctly?  I still get exactly the same problem as I reported before.",
    "created_at": "2012-04-17T22:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151030",
    "user": "https://github.com/jdemeyer"
}
```

Are you sure you updated the spkg correctly?  I still get exactly the same problem as I reported before.



---

archive/issue_comments_151031.json:
```json
{
    "body": "On which box does this happen, I get on sage.math:\n\n\n```\n./sage-5.0.beta13-m4rie/sage -f ~/spkgs/libm4rie-20120415.spkg \nCalling sage-spkg on '/home/malb/spkgs/libm4rie-20120415.spkg'\nlibm4rie-20120415\n====================================================\nExtracting package /home/malb/spkgs/libm4rie-20120415.spkg\n-rw-r--r-- 1 malb malb 401369 2012-04-15 07:03 /home/malb/spkgs/libm4rie-20120415.spkg\nFinished extraction\n****************************************************\nHost system:\nLinux sage.math.washington.edu 2.6.24-28-server #1 SMP Fri Feb 11 18:08:32 UTC 2011 x86_64 GNU/Linux\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/scratch/malb/sage-5.0.beta13-m4rie/local/bin/../libexec/gcc/x86_64-unknown-linux-gnu/4.6.3/lto-wrapper\nTarget: x86_64-unknown-linux-gnu\nConfigured with: ../src/configure --prefix=/scratch/malb/sage-5.0.beta13/local --with-local-prefix=/scratch/malb/sage-5.0.beta13/local --with-gmp=/scratch/malb/sage-5.0.beta13/local --with-mpfr=/scratch/malb/sage-5.0.beta13/local --with-mpc=/scratch/malb/sage-5.0.beta13/local --with-system-zlib --disable-multilib  \nThread model: posix\ngcc version 4.6.3 (GCC) \n****************************************************\nchecking build system type... x86_64-unknown-linux-gnu\n```\n",
    "created_at": "2012-04-18T10:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151031",
    "user": "https://github.com/malb"
}
```

On which box does this happen, I get on sage.math:


```
./sage-5.0.beta13-m4rie/sage -f ~/spkgs/libm4rie-20120415.spkg 
Calling sage-spkg on '/home/malb/spkgs/libm4rie-20120415.spkg'
libm4rie-20120415
====================================================
Extracting package /home/malb/spkgs/libm4rie-20120415.spkg
-rw-r--r-- 1 malb malb 401369 2012-04-15 07:03 /home/malb/spkgs/libm4rie-20120415.spkg
Finished extraction
****************************************************
Host system:
Linux sage.math.washington.edu 2.6.24-28-server #1 SMP Fri Feb 11 18:08:32 UTC 2011 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/scratch/malb/sage-5.0.beta13-m4rie/local/bin/../libexec/gcc/x86_64-unknown-linux-gnu/4.6.3/lto-wrapper
Target: x86_64-unknown-linux-gnu
Configured with: ../src/configure --prefix=/scratch/malb/sage-5.0.beta13/local --with-local-prefix=/scratch/malb/sage-5.0.beta13/local --with-gmp=/scratch/malb/sage-5.0.beta13/local --with-mpfr=/scratch/malb/sage-5.0.beta13/local --with-mpc=/scratch/malb/sage-5.0.beta13/local --with-system-zlib --disable-multilib  
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************
checking build system type... x86_64-unknown-linux-gnu
```




---

archive/issue_comments_151032.json:
```json
{
    "body": "This was on boxen.math.  Anyway, the relevant file which should be touched is `config.h.in` (not `configure`)",
    "created_at": "2012-04-18T11:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151032",
    "user": "https://github.com/jdemeyer"
}
```

This was on boxen.math.  Anyway, the relevant file which should be touched is `config.h.in` (not `configure`)



---

archive/issue_comments_151033.json:
```json
{
    "body": "I've updated the SPKG accordingly and my release script (for future releases)",
    "created_at": "2012-04-18T11:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151033",
    "user": "https://github.com/malb"
}
```

I've updated the SPKG accordingly and my release script (for future releases)



---

archive/issue_comments_151034.json:
```json
{
    "body": "Replying to [comment:20 malb]:\n> I've updated the SPKG accordingly and my release script (for future releases)\n\nDoes that mean the ticket needs review? Or still needs work?",
    "created_at": "2012-05-03T15:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151034",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:20 malb]:
> I've updated the SPKG accordingly and my release script (for future releases)

Does that mean the ticket needs review? Or still needs work?



---

archive/issue_comments_151035.json:
```json
{
    "body": "Thanks, it needs review",
    "created_at": "2012-05-03T16:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151035",
    "user": "https://github.com/malb"
}
```

Thanks, it needs review



---

archive/issue_comments_151036.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-03T16:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151036",
    "user": "https://github.com/malb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_151037.json:
```json
{
    "body": "The ticket description mentions bug fixes. What are they?",
    "created_at": "2012-05-03T16:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151037",
    "user": "https://github.com/simon-king-jena"
}
```

The ticket description mentions bug fixes. What are they?



---

archive/issue_comments_151038.json:
```json
{
    "body": "The bugfixes mainly concern the testsuite: https://bitbucket.org/malb/m4rie/changesets\n\n* !81d352a8aade reserve enough pointers for finite fields in testsuite\n* !8245cd046d86 removed a bit of dead code scan-build reported\n* !b81b9649e2d1 use unsigned ints for degrees everywhere\n* !ad8e309640e3 make sure the canary does not set bits which are expected to be zero (e.g. in lockup tables)\n* !f6f4b011dbe3 fixed a memleak\n* !dfacf106f205 bitmasks should be unsigned\n* !a3087ea586d7 fixed memleak in test_smallops\n* !02f7dfe20ff5 replaced nonstandard __STRING(x) with #x\n* !9d23a80fa589 remove -lntl, it's not needed\n* !f104847ecea0 using less temporary memory for Karatsuba for GF(2^4)\n* !bd90f880f4a8 saving memory in karatsuba multiplication\n* !548023a54d9e use rpath for test_* to make sure the right version of the library is used\n* !559610e11d7e unified strassen cutoff",
    "created_at": "2012-05-03T17:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151038",
    "user": "https://github.com/malb"
}
```

The bugfixes mainly concern the testsuite: https://bitbucket.org/malb/m4rie/changesets

* !81d352a8aade reserve enough pointers for finite fields in testsuite
* !8245cd046d86 removed a bit of dead code scan-build reported
* !b81b9649e2d1 use unsigned ints for degrees everywhere
* !ad8e309640e3 make sure the canary does not set bits which are expected to be zero (e.g. in lockup tables)
* !f6f4b011dbe3 fixed a memleak
* !dfacf106f205 bitmasks should be unsigned
* !a3087ea586d7 fixed memleak in test_smallops
* !02f7dfe20ff5 replaced nonstandard __STRING(x) with #x
* !9d23a80fa589 remove -lntl, it's not needed
* !f104847ecea0 using less temporary memory for Karatsuba for GF(2^4)
* !bd90f880f4a8 saving memory in karatsuba multiplication
* !548023a54d9e use rpath for test_* to make sure the right version of the library is used
* !559610e11d7e unified strassen cutoff



---

archive/issue_comments_151039.json:
```json
{
    "body": "Replying to [comment:24 malb]:\n> The bugfixes mainly concern the testsuite:\n\nI didn't install the package with SAGE_CHECK=yes, but I guess I should... Anyway, the Sage test suite (make ptestlong) works.\n\nI tried to verify your claim that it became faster for exponents between 4 and 8. I tested 6. First, in vanilla sage-5.0.rc0:\n\n```\nsage: K.<z> = GF(2^6)\nsage: %time A = random_matrix(K,10000,10000)\nCPU times: user 1.63 s, sys: 0.06 s, total: 1.70 s\nWall time: 1.70 s\nsage: %time B = random_matrix(K,10000,10000)\nCPU times: user 1.53 s, sys: 0.04 s, total: 1.58 s\nWall time: 1.58 s\nsage: %time (A*B).rank()\nCPU times: user 85.03 s, sys: 0.12 s, total: 85.15 s\nWall time: 85.40 s\n10000\n```\n\nWith the new spkgs in sage-5.0.beta13:\n\n```\nsage: K.<z> = GF(2^6)\nsage: %time A = random_matrix(K,10000,10000)\nCPU times: user 1.77 s, sys: 0.07 s, total: 1.84 s\nWall time: 1.85 s\nsage: %time B = random_matrix(K,10000,10000)\nCPU times: user 1.76 s, sys: 0.03 s, total: 1.79 s\nWall time: 1.80 s\nsage: %time (A*B).rank()\nCPU times: user 37.38 s, sys: 0.23 s, total: 37.61 s\nWall time: 37.74 s\n10000\n```\n\n\nNow, that *is* faster for the \"real\" computation, but roughly 10% slower for random matrix creation. Is that a random result within the margin of error?",
    "created_at": "2012-05-03T19:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151039",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:24 malb]:
> The bugfixes mainly concern the testsuite:

I didn't install the package with SAGE_CHECK=yes, but I guess I should... Anyway, the Sage test suite (make ptestlong) works.

I tried to verify your claim that it became faster for exponents between 4 and 8. I tested 6. First, in vanilla sage-5.0.rc0:

```
sage: K.<z> = GF(2^6)
sage: %time A = random_matrix(K,10000,10000)
CPU times: user 1.63 s, sys: 0.06 s, total: 1.70 s
Wall time: 1.70 s
sage: %time B = random_matrix(K,10000,10000)
CPU times: user 1.53 s, sys: 0.04 s, total: 1.58 s
Wall time: 1.58 s
sage: %time (A*B).rank()
CPU times: user 85.03 s, sys: 0.12 s, total: 85.15 s
Wall time: 85.40 s
10000
```

With the new spkgs in sage-5.0.beta13:

```
sage: K.<z> = GF(2^6)
sage: %time A = random_matrix(K,10000,10000)
CPU times: user 1.77 s, sys: 0.07 s, total: 1.84 s
Wall time: 1.85 s
sage: %time B = random_matrix(K,10000,10000)
CPU times: user 1.76 s, sys: 0.03 s, total: 1.79 s
Wall time: 1.80 s
sage: %time (A*B).rank()
CPU times: user 37.38 s, sys: 0.23 s, total: 37.61 s
Wall time: 37.74 s
10000
```


Now, that *is* faster for the "real" computation, but roughly 10% slower for random matrix creation. Is that a random result within the margin of error?



---

archive/issue_comments_151040.json:
```json
{
    "body": "Replying to [comment:25 SimonKing]:\n> Replying to [comment:24 malb]:\n> > The bugfixes mainly concern the testsuite:\n> \n> I didn't install the package with SAGE_CHECK=yes, but I guess I should... \n\nI did, and the self-tests pass.",
    "created_at": "2012-05-03T19:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151040",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:25 SimonKing]:
> Replying to [comment:24 malb]:
> > The bugfixes mainly concern the testsuite:
> 
> I didn't install the package with SAGE_CHECK=yes, but I guess I should... 

I did, and the self-tests pass.



---

archive/issue_comments_151041.json:
```json
{
    "body": "Replying to [comment:25 SimonKing]:\n> Now, that *is* faster for the \"real\" computation, but roughly 10% slower for random matrix creation. Is that a random result within the margin of error?\n\nI don't recall that anything changed in random matrix creation, so I'd assume it's down to margin of error.",
    "created_at": "2012-05-03T20:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151041",
    "user": "https://github.com/malb"
}
```

Replying to [comment:25 SimonKing]:
> Now, that *is* faster for the "real" computation, but roughly 10% slower for random matrix creation. Is that a random result within the margin of error?

I don't recall that anything changed in random matrix creation, so I'd assume it's down to margin of error.



---

archive/issue_comments_151042.json:
```json
{
    "body": "I get\n\n```\nking@mpc622:/mnt/local/king/SAGE/stable/sage-5.0.beta13/spkg/optional/libm4rie-20120415$ hg status\nM spkg-install\nking@mpc622:/mnt/local/king/SAGE/stable/sage-5.0.beta13/spkg/optional/libm4rie-20120415$ hg diff\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -26,7 +26,7 @@\n CPPFLAGS=\"$INCLUDES\"\n \n if [ \"x$SAGE_DEBUG\" = \"xyes\" ]; then\n-   CFLAGS=\"-O0 $CFLAGS\"\n+   CFLAGS=\"$CFLAGS -O0\"\n    ENABLE_DEBUG=\"--enable-debug\"\n else\n    CFLAGS=\"-O2 $CFLAGS\"\n```\n\n\nSo, please update the package by checking in the changes!\n\nApart from that, self tests and make ptestlong pass, and we see some speed-up. I only tested on one platform, though. Jeroen, can you confirm that the problem you mentioned is fixed?",
    "created_at": "2012-05-04T11:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151042",
    "user": "https://github.com/simon-king-jena"
}
```

I get

```
king@mpc622:/mnt/local/king/SAGE/stable/sage-5.0.beta13/spkg/optional/libm4rie-20120415$ hg status
M spkg-install
king@mpc622:/mnt/local/king/SAGE/stable/sage-5.0.beta13/spkg/optional/libm4rie-20120415$ hg diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -26,7 +26,7 @@
 CPPFLAGS="$INCLUDES"
 
 if [ "x$SAGE_DEBUG" = "xyes" ]; then
-   CFLAGS="-O0 $CFLAGS"
+   CFLAGS="$CFLAGS -O0"
    ENABLE_DEBUG="--enable-debug"
 else
    CFLAGS="-O2 $CFLAGS"
```


So, please update the package by checking in the changes!

Apart from that, self tests and make ptestlong pass, and we see some speed-up. I only tested on one platform, though. Jeroen, can you confirm that the problem you mentioned is fixed?



---

archive/issue_comments_151043.json:
```json
{
    "body": "Whoops, yeah, I left those uncommitted because there was a bit of discussion whether we should have this or not, i.e., should SAGE_DEBUG overwrite the optimisation level you specify in in CFLAGS. I'm inclined that it shouldn't so I will revert this change.",
    "created_at": "2012-05-04T16:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151043",
    "user": "https://github.com/malb"
}
```

Whoops, yeah, I left those uncommitted because there was a bit of discussion whether we should have this or not, i.e., should SAGE_DEBUG overwrite the optimisation level you specify in in CFLAGS. I'm inclined that it shouldn't so I will revert this change.



---

archive/issue_comments_151044.json:
```json
{
    "body": "Hi, I updated the SPKG accordingly.",
    "created_at": "2012-05-05T15:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151044",
    "user": "https://github.com/malb"
}
```

Hi, I updated the SPKG accordingly.



---

archive/issue_comments_151045.json:
```json
{
    "body": "Replying to [comment:28 SimonKing]:\n> Apart from that, self tests and make ptestlong pass, and we see some speed-up. I only tested on one platform, though. Jeroen, can you confirm that the problem you mentioned is fixed?\nYes, it does.\n\nI also agree with leaving the `-O0` as it is.",
    "created_at": "2012-05-07T06:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151045",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 SimonKing]:
> Apart from that, self tests and make ptestlong pass, and we see some speed-up. I only tested on one platform, though. Jeroen, can you confirm that the problem you mentioned is fixed?
Yes, it does.

I also agree with leaving the `-O0` as it is.



---

archive/issue_comments_151046.json:
```json
{
    "body": "I looked at it with #12840 and looks good to me. Lets get this boat off the ground ;-)",
    "created_at": "2012-06-18T10:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151046",
    "user": "https://github.com/vbraun"
}
```

I looked at it with #12840 and looks good to me. Lets get this boat off the ground ;-)



---

archive/issue_comments_151047.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-18T10:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151047",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_151048.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-06-21T14:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151048",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_151049.json:
```json
{
    "body": "I tried to compile this on mark (sparc solaris) and it dies at \n\n```\ng++ -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include   -I/include -I/include   -MT test_trsm-test_trsm.o -MD -MP -MF .deps/test_trsm-test_trsm.Tpo -c -o test_trsm-test_trsm.o `test -f 'tests/test_trsm.cc' || echo './'`tests/test_trsm.cc\nmv -f .deps/test_trsm-test_trsm.Tpo .deps/test_trsm-test_trsm.Po\n/bin/bash ./libtool --tag=CXX   --mode=link g++    -I/include   -I/include -I/include   -Wl,-rpath,.libs/ -L/home/vbraun/opt/mark/sage-5.1.beta3/local/lib -o test_trsm test_trsm-test_trsm.o -L/lib -lm4ri -lm4rie -lgivaro -lgmpxx -lgmp -lm -lstdc++ \nlibtool: link: g++ -I/include -I/include -I/include -Wl,-rpath -Wl,.libs/ -o .libs/test_trsm test_trsm-test_trsm.o  -L/home/vbraun/opt/mark/sage-5.1.beta3/local/lib -L/lib /home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src/.libs/libm4rie.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libm4ri.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libpng12.so -lz /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgivaro.so -L/home/vbraun/opt/mark/sage-5.1.beta3/local//lib /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgmpxx.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgmp.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libstdc++.so -lm -Wl,-R -Wl,/home/vbraun/opt/mark/sage-5.1.beta3/local/lib\nld: fatal: option -dn and -P are incompatible\nld: fatal: Flags processing errors\ncollect2: ld returned 1 exit status\nmake[2]: *** [test_trsm] Error 1\nmake[2]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'\nmake[1]: *** [check-am] Error 2\nmake[1]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'\nmake: *** [check-recursive] Error 1\n```\n\nOnly more sophisticated linkers understand `-rpath`, its better to use `-R`. Though you shouldn't have to manually set rpaths in `libm4rie-20120613/src/bench/Makefile.am` at all, the whole autotools/libtools machinery should do that for you.",
    "created_at": "2012-06-21T14:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151049",
    "user": "https://github.com/vbraun"
}
```

I tried to compile this on mark (sparc solaris) and it dies at 

```
g++ -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include   -I/include -I/include   -MT test_trsm-test_trsm.o -MD -MP -MF .deps/test_trsm-test_trsm.Tpo -c -o test_trsm-test_trsm.o `test -f 'tests/test_trsm.cc' || echo './'`tests/test_trsm.cc
mv -f .deps/test_trsm-test_trsm.Tpo .deps/test_trsm-test_trsm.Po
/bin/bash ./libtool --tag=CXX   --mode=link g++    -I/include   -I/include -I/include   -Wl,-rpath,.libs/ -L/home/vbraun/opt/mark/sage-5.1.beta3/local/lib -o test_trsm test_trsm-test_trsm.o -L/lib -lm4ri -lm4rie -lgivaro -lgmpxx -lgmp -lm -lstdc++ 
libtool: link: g++ -I/include -I/include -I/include -Wl,-rpath -Wl,.libs/ -o .libs/test_trsm test_trsm-test_trsm.o  -L/home/vbraun/opt/mark/sage-5.1.beta3/local/lib -L/lib /home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src/.libs/libm4rie.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libm4ri.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libpng12.so -lz /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgivaro.so -L/home/vbraun/opt/mark/sage-5.1.beta3/local//lib /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgmpxx.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libgmp.so /home/vbraun/opt/mark/sage-5.1.beta3/local/lib/libstdc++.so -lm -Wl,-R -Wl,/home/vbraun/opt/mark/sage-5.1.beta3/local/lib
ld: fatal: option -dn and -P are incompatible
ld: fatal: Flags processing errors
collect2: ld returned 1 exit status
make[2]: *** [test_trsm] Error 1
make[2]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'
make[1]: *** [check-am] Error 2
make[1]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'
make: *** [check-recursive] Error 1
```

Only more sophisticated linkers understand `-rpath`, its better to use `-R`. Though you shouldn't have to manually set rpaths in `libm4rie-20120613/src/bench/Makefile.am` at all, the whole autotools/libtools machinery should do that for you.



---

archive/issue_comments_151050.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-06-21T15:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151050",
    "user": "https://github.com/malb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_151051.json:
```json
{
    "body": "Okay, I dropped it from Makefile.am and replaced the SPKG at the same address.\n\n(It is still used in my benchmarking code of M4RIE but that isn't built by Sage.)",
    "created_at": "2012-06-21T15:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151051",
    "user": "https://github.com/malb"
}
```

Okay, I dropped it from Makefile.am and replaced the SPKG at the same address.

(It is still used in my benchmarking code of M4RIE but that isn't built by Sage.)



---

archive/issue_comments_151052.json:
```json
{
    "body": "Still dying on mark/skynet, though now at a different place:\n\n```\n/bin/bash ./libtool  --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include  -O2 -fPIC -Wall -pedantic -g  -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c -o gf2e.lo `test -f 'src/gf2e.c' || echo './'`src/gf2e.c\nlibtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c src/gf2e.c  -fPIC -DPIC -o .libs/gf2e.o\nlibtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c src/gf2e.c -o gf2e.o >/dev/null 2>&1\nmv -f .deps/gf2e.Tpo .deps/gf2e.Plo\n/bin/bash ./libtool  --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include  -O2 -fPIC -Wall -pedantic -g  -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT mzed.lo -MD -MP -MF .deps/mzed.Tpo -c -o mzed.lo `test -f 'src/mzed.c' || echo './'`src/mzed.c\nlibtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT mzed.lo -MD -MP -MF .deps/mzed.Tpo -c src/mzed.c  -fPIC -DPIC -o .libs/mzed.o\nIn file included from src/mzed.c:23:0:\nsrc/mzed.h:50:24: fatal error: m4rie/gf2e.h: No such file or directory\ncompilation terminated.\nmake[1]: *** [mzed.lo] Error 1\nmake[1]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'\nmake: *** [all-recursive] Error 1\nError building libm4rie\n```\n",
    "created_at": "2012-06-21T15:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151052",
    "user": "https://github.com/vbraun"
}
```

Still dying on mark/skynet, though now at a different place:

```
/bin/bash ./libtool  --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include  -O2 -fPIC -Wall -pedantic -g  -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c -o gf2e.lo `test -f 'src/gf2e.c' || echo './'`src/gf2e.c
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c src/gf2e.c  -fPIC -DPIC -o .libs/gf2e.o
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT gf2e.lo -MD -MP -MF .deps/gf2e.Tpo -c src/gf2e.c -o gf2e.o >/dev/null 2>&1
mv -f .deps/gf2e.Tpo .deps/gf2e.Plo
/bin/bash ./libtool  --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src   -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include    -I/include  -O2 -fPIC -Wall -pedantic -g  -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT mzed.lo -MD -MP -MF .deps/mzed.Tpo -c -o mzed.lo `test -f 'src/mzed.c' || echo './'`src/mzed.c
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I./src -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -I/include -O2 -fPIC -Wall -pedantic -g -I/home/vbraun/opt/mark/sage-5.1.beta3/local/include -MT mzed.lo -MD -MP -MF .deps/mzed.Tpo -c src/mzed.c  -fPIC -DPIC -o .libs/mzed.o
In file included from src/mzed.c:23:0:
src/mzed.h:50:24: fatal error: m4rie/gf2e.h: No such file or directory
compilation terminated.
make[1]: *** [mzed.lo] Error 1
make[1]: Leaving directory `/home/vbraun/opt/mark/sage-5.1.beta3/spkg/build/libm4rie-20120613/src'
make: *** [all-recursive] Error 1
Error building libm4rie
```




---

archive/issue_comments_151053.json:
```json
{
    "body": "Updated spkg builds on mark/skynet. Now doctesting...",
    "created_at": "2012-06-21T18:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151053",
    "user": "https://github.com/vbraun"
}
```

Updated spkg builds on mark/skynet. Now doctesting...



---

archive/issue_comments_151054.json:
```json
{
    "body": "I keep getting bus errors (aka segfaults) on mark/skynet with pickling of `matrix_modn_dense_double` matrices. The `_pickle` method uses `mod_int` and not `celement`, I'm totally confused about that. Note that on mark/skynet:\n\n```\nsage: cython('def f():\\n    return (sizeof(double), sizeof(unsigned long))\\n')\nsage: f()\n(8, 4)\n```\n\nThis might not be the fault of your patch, but its hard to un-apply the spkgs.",
    "created_at": "2012-06-21T19:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151054",
    "user": "https://github.com/vbraun"
}
```

I keep getting bus errors (aka segfaults) on mark/skynet with pickling of `matrix_modn_dense_double` matrices. The `_pickle` method uses `mod_int` and not `celement`, I'm totally confused about that. Note that on mark/skynet:

```
sage: cython('def f():\n    return (sizeof(double), sizeof(unsigned long))\n')
sage: f()
(8, 4)
```

This might not be the fault of your patch, but its hard to un-apply the spkgs.



---

archive/issue_comments_151055.json:
```json
{
    "body": "The release buildbot shows these bus errors, too:\n\nhttp://build.sagemath.org/sage/builders/Skynet%20mark%20%28SunOS%205.10-32%29/builds/181/steps/shell_7/logs/stdio",
    "created_at": "2012-06-21T19:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151055",
    "user": "https://github.com/vbraun"
}
```

The release buildbot shows these bus errors, too:

http://build.sagemath.org/sage/builders/Skynet%20mark%20%28SunOS%205.10-32%29/builds/181/steps/shell_7/logs/stdio



---

archive/issue_comments_151056.json:
```json
{
    "body": "This is with only M4RI/M4RIE applied, not the LinBox update, right?\n\nThe elements in `Matrix_modn_double` should fit into a `mod_int` since they are < 2<sup>23</sup>. Hence, we simply used the same pickling format as the old `Matrix_modn_dense`.",
    "created_at": "2012-06-21T19:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151056",
    "user": "https://github.com/malb"
}
```

This is with only M4RI/M4RIE applied, not the LinBox update, right?

The elements in `Matrix_modn_double` should fit into a `mod_int` since they are < 2<sup>23</sup>. Hence, we simply used the same pickling format as the old `Matrix_modn_dense`.



---

archive/issue_comments_151057.json:
```json
{
    "body": "Yes, just with M4RI/M4RIE. The buildbot failure I linked to is even without the M4RI/M4RIE update.",
    "created_at": "2012-06-21T19:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151057",
    "user": "https://github.com/vbraun"
}
```

Yes, just with M4RI/M4RIE. The buildbot failure I linked to is even without the M4RI/M4RIE update.



---

archive/issue_comments_151058.json:
```json
{
    "body": "From http://docs.oracle.com/cd/E19957-01/806-3568/ncg_math.html about the double bit format:\n\nIn the SPARC architecture, the higher address 32-bit word contains the least significant 32 bits of the fraction, while in the x86 architecture the lower address 32-bit word contains the least significant 32 bits of the fraction.",
    "created_at": "2012-06-21T19:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151058",
    "user": "https://github.com/vbraun"
}
```

From http://docs.oracle.com/cd/E19957-01/806-3568/ncg_math.html about the double bit format:

In the SPARC architecture, the higher address 32-bit word contains the least significant 32 bits of the fraction, while in the x86 architecture the lower address 32-bit word contains the least significant 32 bits of the fraction.



---

archive/issue_comments_151059.json:
```json
{
    "body": "But we're doing a cast, shouldn't that take care of it?",
    "created_at": "2012-06-21T20:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151059",
    "user": "https://github.com/malb"
}
```

But we're doing a cast, shouldn't that take care of it?



---

archive/issue_comments_151060.json:
```json
{
    "body": "Replying to [comment:44 malb]:\n> But we're doing a cast, shouldn't that take care of it?\nWhat lines of code are you talking about?  The problem might be alignment, i.e. doubles should be aligned on a multiple of 8 bytes.",
    "created_at": "2012-06-21T20:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151060",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:44 malb]:
> But we're doing a cast, shouldn't that take care of it?
What lines of code are you talking about?  The problem might be alignment, i.e. doubles should be aligned on a multiple of 8 bytes.



---

archive/issue_comments_151061.json:
```json
{
    "body": "I mean this:\n\nhttp://hg.sagemath.org/sage-main/file/01e0779db321/sage/matrix/matrix_modn_dense_template.pxi#l650\n\nBut perhaps we should wait until we've run this through a gdb before we speculate which lines fail? :)",
    "created_at": "2012-06-21T20:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151061",
    "user": "https://github.com/malb"
}
```

I mean this:

http://hg.sagemath.org/sage-main/file/01e0779db321/sage/matrix/matrix_modn_dense_template.pxi#l650

But perhaps we should wait until we've run this through a gdb before we speculate which lines fail? :)



---

archive/issue_comments_151062.json:
```json
{
    "body": "What are the `mod_int` and `celement` types and where do `double`s come in?",
    "created_at": "2012-06-21T20:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151062",
    "user": "https://github.com/jdemeyer"
}
```

What are the `mod_int` and `celement` types and where do `double`s come in?



---

archive/issue_comments_151063.json:
```json
{
    "body": "gdb isn't installed on mark. the only debugger is mdb and I have no idea how to use it.\nBut the bus error is at the i=j=0 assignment (using print) in _pickle.\n\nI thought \nmod_int = long int and celement = double (in matrix_modn_dense_double)\n\nThe cast to mod_int is working correctly, though.",
    "created_at": "2012-06-21T20:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151063",
    "user": "https://github.com/vbraun"
}
```

gdb isn't installed on mark. the only debugger is mdb and I have no idea how to use it.
But the bus error is at the i=j=0 assignment (using print) in _pickle.

I thought 
mod_int = long int and celement = double (in matrix_modn_dense_double)

The cast to mod_int is working correctly, though.



---

archive/issue_comments_151064.json:
```json
{
    "body": "For the record, matrix_modn_dense_template.pxi with some extra prints:\n\n```\n        else:\n            print 'word_size != sizeof(char)', word_size, <int><char*>s\n            um = <mod_int*><char *>s\n            for i in range(self._nrows):\n                row_self = self._matrix[i]\n                row_um = &um[i*self._ncols]\n                for j in range(self._ncols):\n                    print i, j, row_self[j], <mod_int>row_self[j], self._ncols, self._nrows, <int>row_um\n                    row_um[j] = <mod_int>row_self[j]\n                    print \"crash\"\n```\n\nyields\n\n```\nsage: random_matrix(ZZ.quo(123456), 10,10)._pickle()\nword_size != sizeof(char) 8 68071796\n0 0 60348.0 60348 10 10 68071796\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n\n/home/vbraun/opt/mark/sage-5.1.beta3/devel/sage-main/<ipython console> in <module>()\n\n/home/vbraun/opt/mark/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/matrix/matrix_modn_dense_double.so in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6537)()\n\nRuntimeError: Bus error\n```\n",
    "created_at": "2012-06-21T20:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151064",
    "user": "https://github.com/vbraun"
}
```

For the record, matrix_modn_dense_template.pxi with some extra prints:

```
        else:
            print 'word_size != sizeof(char)', word_size, <int><char*>s
            um = <mod_int*><char *>s
            for i in range(self._nrows):
                row_self = self._matrix[i]
                row_um = &um[i*self._ncols]
                for j in range(self._ncols):
                    print i, j, row_self[j], <mod_int>row_self[j], self._ncols, self._nrows, <int>row_um
                    row_um[j] = <mod_int>row_self[j]
                    print "crash"
```

yields

```
sage: random_matrix(ZZ.quo(123456), 10,10)._pickle()
word_size != sizeof(char) 8 68071796
0 0 60348.0 60348 10 10 68071796
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)

/home/vbraun/opt/mark/sage-5.1.beta3/devel/sage-main/<ipython console> in <module>()

/home/vbraun/opt/mark/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/matrix/matrix_modn_dense_double.so in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6537)()

RuntimeError: Bus error
```




---

archive/issue_comments_151065.json:
```json
{
    "body": "Jeroen was right, its an alignment thing. The output of `PyString_FromStringAndSize` is 4 but not 8-byte aligned. By faking it\n\n```\n            um = <mod_int*>((<char *>s)+4)\n```\n\nI avoided the crash.",
    "created_at": "2012-06-21T20:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151065",
    "user": "https://github.com/vbraun"
}
```

Jeroen was right, its an alignment thing. The output of `PyString_FromStringAndSize` is 4 but not 8-byte aligned. By faking it

```
            um = <mod_int*>((<char *>s)+4)
```

I avoided the crash.



---

archive/issue_comments_151066.json:
```json
{
    "body": "But it seems it's not double alignment? By the time it hits unaligned memory it's already a `mod_int == long`.",
    "created_at": "2012-06-21T21:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151066",
    "user": "https://github.com/malb"
}
```

But it seems it's not double alignment? By the time it hits unaligned memory it's already a `mod_int == long`.



---

archive/issue_comments_151067.json:
```json
{
    "body": "But note that `wordsize` == `sizeof(mod_int)` == 8 according to Volker's `print` statement.",
    "created_at": "2012-06-22T06:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151067",
    "user": "https://github.com/jdemeyer"
}
```

But note that `wordsize` == `sizeof(mod_int)` == 8 according to Volker's `print` statement.



---

archive/issue_comments_151068.json:
```json
{
    "body": "The problem is that `sage/ext/multi_modular.h` defines\n\n```\n#define mod_int uint_fast64_t\n```\n\n\nSo, `mod_int` is actually `uint_fast64_t`.",
    "created_at": "2012-06-22T07:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151068",
    "user": "https://github.com/jdemeyer"
}
```

The problem is that `sage/ext/multi_modular.h` defines

```
#define mod_int uint_fast64_t
```


So, `mod_int` is actually `uint_fast64_t`.



---

archive/issue_comments_151069.json:
```json
{
    "body": "The file `sage/ext/multi_modular.h` seems to be used by LinBox.  But `matrix_modn_double_*` has a conflicting definition of `mod_int`.  It is supposed to be the same or did you both use the same name for a type accidentally?",
    "created_at": "2012-06-22T07:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151069",
    "user": "https://github.com/jdemeyer"
}
```

The file `sage/ext/multi_modular.h` seems to be used by LinBox.  But `matrix_modn_double_*` has a conflicting definition of `mod_int`.  It is supposed to be the same or did you both use the same name for a type accidentally?



---

archive/issue_comments_151070.json:
```json
{
    "body": "Note that the conflicting types might not even a problem, as Cython doesn't really care much about types.  The definition\n\n```\nctypedef unsigned long mod_int\n```\n\nmostly just makes Cython aware that `mod_int` is some (integer?) type, the actual type doesn't really matter as far as I know.",
    "created_at": "2012-06-22T07:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151070",
    "user": "https://github.com/jdemeyer"
}
```

Note that the conflicting types might not even a problem, as Cython doesn't really care much about types.  The definition

```
ctypedef unsigned long mod_int
```

mostly just makes Cython aware that `mod_int` is some (integer?) type, the actual type doesn't really matter as far as I know.



---

archive/issue_comments_151071.json:
```json
{
    "body": "Replying to [comment:55 jdemeyer]:\n> The file `sage/ext/multi_modular.h` seems to be used by LinBox.  But `matrix_modn_double_*` has a conflicting definition of `mod_int`.  It is supposed to be the same or did you both use the same name for a type accidentally?\n\nFWIW: I made a similar experience on Solaris with my MeatAxe wrapper (and, if I remember correctly, the same problem has shown up a while ago when trying to use Singular options in !libSingular). Namely, MeatAxe uses a function mulmat (or matmul? Doesn't matter...), but apparently a function of the same name is defined in some other spkg as well. And apparently the Solaris linker was confusing the two mulmats, even though they belong to totally different packages! In particular, MeatAxe does not link against the other package.\n\nThe simple solution was to rename MeatAxe's mulmat into _mulmat.\nSo, renaming mod_int into something else would be worth a try.",
    "created_at": "2012-06-22T07:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151071",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:55 jdemeyer]:
> The file `sage/ext/multi_modular.h` seems to be used by LinBox.  But `matrix_modn_double_*` has a conflicting definition of `mod_int`.  It is supposed to be the same or did you both use the same name for a type accidentally?

FWIW: I made a similar experience on Solaris with my MeatAxe wrapper (and, if I remember correctly, the same problem has shown up a while ago when trying to use Singular options in !libSingular). Namely, MeatAxe uses a function mulmat (or matmul? Doesn't matter...), but apparently a function of the same name is defined in some other spkg as well. And apparently the Solaris linker was confusing the two mulmats, even though they belong to totally different packages! In particular, MeatAxe does not link against the other package.

The simple solution was to rename MeatAxe's mulmat into _mulmat.
So, renaming mod_int into something else would be worth a try.



---

archive/issue_comments_151072.json:
```json
{
    "body": "Perhaps 64-bit integers need to be 8-byte aligned as well? Also, I guess \n\n  {{{\n  ctypedef unsigned long mod_int\n  }}}\n\nshould be replaced by the correct typedef, to make it less confusing. In any case, I opened a new ticket at #13151 since this is not M4RIE releated.",
    "created_at": "2012-06-22T09:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151072",
    "user": "https://github.com/malb"
}
```

Perhaps 64-bit integers need to be 8-byte aligned as well? Also, I guess 

  {{{
  ctypedef unsigned long mod_int
  }}}

should be replaced by the correct typedef, to make it less confusing. In any case, I opened a new ticket at #13151 since this is not M4RIE releated.



---

archive/issue_comments_151073.json:
```json
{
    "body": "The cast is defined at compile-time, not at link-time. To summarize, the problem really is that malloc on Solaris only returns 32-bit aligned memory. \n\nSimon: There is only a single flat namespace on Linux and Solaris, so if any shared library imports conflicting symbols then its just luck to get the right one.",
    "created_at": "2012-06-22T10:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151073",
    "user": "https://github.com/vbraun"
}
```

The cast is defined at compile-time, not at link-time. To summarize, the problem really is that malloc on Solaris only returns 32-bit aligned memory. 

Simon: There is only a single flat namespace on Linux and Solaris, so if any shared library imports conflicting symbols then its just luck to get the right one.



---

archive/issue_comments_151074.json:
```json
{
    "body": "Other doctests pass, so lets give this a go.",
    "created_at": "2012-06-22T11:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151074",
    "user": "https://github.com/vbraun"
}
```

Other doctests pass, so lets give this a go.



---

archive/issue_comments_151075.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-22T11:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151075",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_151076.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-01T12:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12669#issuecomment-151076",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
