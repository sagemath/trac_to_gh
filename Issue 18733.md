# Issue 18733: always simplify log(a^m,a) to m for any m coercible to Integer

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-07-30 06:51:22

From https://groups.google.com/forum/?hl=en#!topic/sage-devel/hwm-7V8S3hE

```
sage: log(int(8),2)
log(8)/log(2)
sage: log(8,int(2))
log(8)/log(2)
sage: log(8,2)
3
```



---

Comment by rws created at 2015-07-30 07:42:03

New commits:


---

Comment by rws created at 2015-07-30 07:42:03

Changing status from new to needs_review.


---

Comment by git created at 2015-07-30 07:56:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2015-07-30 08:21:50

Changing status from needs_review to needs_info.


---

Comment by dkrenn created at 2015-07-30 08:21:50

Before this patch

```
sage: %timeit log(QQ(8),2)
The slowest run took 5.08 times longer than the fastest. This could mean that an intermediate result is being cached 
10000 loops, best of 3: 39.4 µs per loop
sage: %timeit log(QQ(8),3)
10000 loops, best of 3: 38.1 µs per loop
sage: %timeit log(ZZ(8),3)
10000 loops, best of 3: 32.8 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 14.52 times longer than the fastest. This could mean that an intermediate result is being cached 
1000000 loops, best of 3: 1.12 µs per loop
```

After

```
sage: %timeit log(QQ(8),3)
The slowest run took 37.28 times longer than the fastest. This could mean that an intermediate result is being cached 
10000 loops, best of 3: 48.8 µs per loop
sage: %timeit log(QQ(8),2)
The slowest run took 8.69 times longer than the fastest. This could mean that an intermediate result is being cached 
100000 loops, best of 3: 5.43 µs per loop
sage: %timeit log(ZZ(8),3)
10000 loops, best of 3: 48.4 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 8.80 times longer than the fastest. This could mean that an intermediate result is being cached 
100000 loops, best of 3: 5.34 µs per loop
```


I've repeated (differently) it due to the caching-warnings. Before

```
sage: timeit('log(QQ(8),3)', number=1, repeat=1)
1 loops, best of 1: 191 µs per loop
sage: timeit('log(QQ(8),2)', number=1, repeat=1)
1 loops, best of 1: 150 µs per loop
sage: timeit('log(ZZ(8),3)', number=1, repeat=1)
1 loops, best of 1: 125 µs per loop
sage: timeit('log(ZZ(8),2)', number=1, repeat=1)
1 loops, best of 1: 24.1 µs per loop
```

After

```
sage: timeit('log(QQ(8),3)', number=1, repeat=1)
1 loops, best of 1: 1.93 ms per loop
sage: timeit('log(QQ(8),2)', number=1, repeat=1)
1 loops, best of 1: 45.1 µs per loop
sage: timeit('log(ZZ(8),3)', number=1, repeat=1)
1 loops, best of 1: 158 µs per loop
sage: timeit('log(ZZ(8),2)', number=1, repeat=1)
1 loops, best of 1: 45.1 µs per loop
```


In particular `log(QQ(8),3)` becomes much slower (and only `log(QQ(8),2)` gains speed).


---

Comment by dkrenn created at 2015-07-30 08:26:25


```
sage: log(QQ(8),2).parent()
Integer Ring
```

which is a different behavior compared to the common/similar arithmetic operations (e.g. `(QQ(2)^ZZ(1)).parent()` is `Rational Field` and not `Integer Ring`) and I would expect that the logarithm of a rational is again a rational (if possible) or something where QQ coerces into (but not out of something which coerces into QQ).


---

Comment by rws created at 2015-07-30 08:56:21

Is this a one-time comment, or do you plan to review to the end?


---

Comment by dkrenn created at 2015-07-30 09:18:13

Replying to [comment:8 rws]:
> Is this a one-time comment, or do you plan to review to the end?

Does this make a difference on how to react to my comment? ;) ....or more seriously: I am not sure if I feel qualified enough to review a change in the `log`-function. I just saw the discussion on sage-devel and looked into the ticket and decided to give some comments.


---

Comment by rws created at 2016-08-30 15:03:56

The code at hand unconditionally tries to coerce the arguments into ZZ,QQ instead of checking the type first. Apart from the speed issue it also would benefit from moving completely into GiNaC: atm some cases are intercepted unnecessarily in `Function_log.__call__` which itself awkwardly calls Pynac.


---

Comment by rws created at 2016-08-30 15:03:56

Changing status from needs_info to needs_work.


---

Comment by leif created at 2016-08-30 15:28:29

I guess some of the speed regression is due to the at least partially redundant checking whether `arg == base**v`, and of course now _in addition_ computing the valuation first in case the latter does _not_ hold.  (At least it seemed to when I looked at it yesterday...)

Not sure how much the probably superfluous coercion contributes.


---

Comment by rws created at 2016-09-07 08:15:23

New branch depends on Pynac git master.
----
New commits:


---

Comment by rws created at 2016-09-07 08:32:27

Timings with this branch. Before:

```
sage: %timeit log(QQ(8),2)
The slowest run took 10.96 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 40.1 µs per loop
sage: %timeit log(QQ(8),2)
10000 loops, best of 3: 40.2 µs per loop
sage: %timeit log(QQ(8),3)
10000 loops, best of 3: 40.5 µs per loop
sage: %timeit log(ZZ(8),3)
10000 loops, best of 3: 34.4 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 19.11 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 886 ns per loop
```

After:

```
sage: %timeit log(QQ(8),2)
The slowest run took 15.53 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 26.7 µs per loop
sage: %timeit log(QQ(8),3)
The slowest run took 10.80 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 26.8 µs per loop
sage: %timeit log(ZZ(8),3)
10000 loops, best of 3: 30.2 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 17.37 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 686 ns per loop
```

The single run measurements vary so much from run to run that I refrain from giving them here. The After values of `timeit('log(QQ(8),3)', number=1, repeat=1)` are however in the same range as the Before values (as well as the others).


---

Comment by rws created at 2016-10-02 14:45:04

New commits:


---

Comment by rws created at 2016-10-02 14:47:26

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-10-25 06:08:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-04-13 07:53:57

Completed coverage.
----
New commits:


---

Comment by git created at 2017-08-24 13:30:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-20 20:08:01

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-10-20 20:08:01

does not apply


---

Comment by git created at 2017-10-21 05:57:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-21 05:57:59

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-23 23:26:55

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-10-23 23:26:55

Needs another rebase over beta9.


---

Comment by git created at 2017-10-24 06:21:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-24 06:22:09

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-24 15:29:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-24 15:35:45

Fixes were added, cruft removed, and it all squashed.
----
New commits:


---

Comment by tscrim created at 2017-10-25 14:58:45

LGTM. Timings on my laptop with branch:

```
sage: %timeit log(QQ(8),2)
The slowest run took 29.31 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.57 µs per loop
sage: %timeit log(QQ(8),3)
The slowest run took 4.03 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 35.5 µs per loop
sage: %timeit log(ZZ(8),3)
10000 loops, best of 3: 33 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 16.93 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 887 ns per loop
```

vs. with `develop`:

```
sage: %timeit log(QQ(8),2)
The slowest run took 14987.26 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.6 µs per loop
sage: %timeit log(QQ(8),3)
10000 loops, best of 3: 43.2 µs per loop
sage: %timeit log(ZZ(8),3)
The slowest run took 4.42 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 38.9 µs per loop
sage: %timeit log(ZZ(8),2)
The slowest run took 14.23 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.06 µs per loop
```



---

Comment by tscrim created at 2017-10-25 14:58:45

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-10-26 06:25:14

Thanks.


---

Comment by vbraun created at 2017-10-29 10:32:17

Resolution: fixed
