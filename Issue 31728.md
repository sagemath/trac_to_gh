# Issue 31728: Improve the handling of temporary symbolic variables in sage

Issue created by migration from https://trac.sagemath.org/ticket/31965

Original creator: @spaghettisalat

Original creation time: 2021-06-12 13:13:14

CC:  slelievre egourgoulhon

At various places in sagemath, temporary symbolic variables are used. The names of these variables are chosen in an ad-hoc manner and can often clash with user-defined names. For example, the following gives mathematically wrong answers, because `t0` is used internally as a temporary variable in the conversion from and to maxima.


```
sage: var('x t0')
(x, t0)
sage: function('f')
f
sage: diff(f(x,t0),x).subs({x:x-t0,t0:x+t0}).simplify_full()
-D[1](f)(t0, t0 + x) + 2*D[1](f)(t0, -t0 + 2*x) + D[0](f)(-t0 + x, t0 + x) - D[1](f)(-t0 + x, t0 + x)
```


This ticket fixes these issues by creating fresh variables with unique names where appropriate and otherwise using variables named `_symbol...` which are less likely to clash with user-defined variables. We now also warn if a user tries to define variables which may lead to clashes. 

Furthermore, some instances of calls to `sage.calculus.var.var` which unnecessarily polluted the global namespace have been replaced by `sage.symbolic.ring.SR.var`.


---

Comment by slelievre created at 2021-06-12 13:33:59

Changing keywords from "" to "SR.var".


---

Comment by slelievre created at 2021-06-12 13:33:59

Please set to "needs review" if ready for review.


---

Comment by @spaghettisalat created at 2021-06-12 13:37:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-19 02:48:46

In this change:

```
+                if name.startswith('symbol') and name[6:].isdigit():
+                    import warnings
+                    warnings.warn(f'The name "{name}" may clash with names used internally in sagemath. It is recommended to choose a different name for your variable.')
```

Shouldn't it be warning about names starting with `_symbol`?


---

Comment by git created at 2021-06-19 13:51:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @spaghettisalat created at 2021-06-19 13:53:36

> Shouldn't it be warning about names starting with `_symbol`? 

Yes, I forgot that. We should obviously also warn for those cases. I have pushed a new commit which fixes this.


---

Comment by mkoeppe created at 2021-06-19 18:35:16

Where are the names starting with `symbol` coming from?


---

Comment by @spaghettisalat created at 2021-06-19 18:40:46

Replying to [comment:8 mkoeppe]:
> Where are the names starting with `symbol` coming from?

From ginac. This is what you get if you call `SR.symbol()` without any arguments or the new `SR.temp_var` function introduced in this ticket.


---

Comment by mkoeppe created at 2021-06-19 18:55:58

Thanks - would you mind adding this information as comments to the code?


---

Comment by mkoeppe created at 2021-06-19 18:57:52

I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names


---

Comment by git created at 2021-06-20 12:18:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @spaghettisalat created at 2021-06-20 12:20:42

Replying to [comment:11 mkoeppe]:
> I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names

I don't think this is a problem. These variables don't enter the global namespace, so unless someone is manually extracting them from `SR.symbols` it is not possible to put assumptions on these variables.


---

Comment by mkoeppe created at 2021-06-20 14:19:42

OK, makes sense


---

Comment by mkoeppe created at 2021-06-23 01:38:47

`@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.


---

Comment by mkoeppe created at 2021-06-23 01:38:47

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2021-06-23 03:51:47

Replying to [comment:15 mkoeppe]:
> `@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.

With the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as "use fresh names every time" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.


---

Comment by @spaghettisalat created at 2021-06-23 12:04:46

Replying to [comment:16 nbruin]:
> Replying to [comment:15 mkoeppe]:
> > `@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.
> 
> With the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as "use fresh names every time" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.

That's not quite correct. Some of the variables (those created with SR.temp_var) are freshly created each time and not reused. However, SR.cleanup_var takes care of removing those from SR.symbols and forgetting any assumptions about them, so that they can be garbage collected.


---

Comment by vbraun created at 2021-06-29 18:03:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-29 18:03:26

Merge conflict


---

Comment by mkoeppe created at 2021-06-29 21:31:07

the conflict appears to be with #31923.


---

Comment by git created at 2021-06-29 21:32:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-29 21:32:22

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-29 21:33:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-01 20:44:54

Resolution: fixed
