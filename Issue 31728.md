# Issue 31728: Improve the handling of temporary symbolic variables in sage

archive/issues_031728.json:
```json
{
    "body": "CC:  @slel @egourgoulhon\n\nAt various places in sagemath, temporary symbolic variables are used. The names of these variables are chosen in an ad-hoc manner and can often clash with user-defined names. For example, the following gives mathematically wrong answers, because `t0` is used internally as a temporary variable in the conversion from and to maxima.\n\n\n```\nsage: var('x t0')\n(x, t0)\nsage: function('f')\nf\nsage: diff(f(x,t0),x).subs({x:x-t0,t0:x+t0}).simplify_full()\n-D[1](f)(t0, t0 + x) + 2*D[1](f)(t0, -t0 + 2*x) + D[0](f)(-t0 + x, t0 + x) - D[1](f)(-t0 + x, t0 + x)\n```\n\n\nThis ticket fixes these issues by creating fresh variables with unique names where appropriate and otherwise using variables named `_symbol...` which are less likely to clash with user-defined variables. We now also warn if a user tries to define variables which may lead to clashes. \n\nFurthermore, some instances of calls to `sage.calculus.var.var` which unnecessarily polluted the global namespace have been replaced by `sage.symbolic.ring.SR.var`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31965\n\n",
    "created_at": "2021-06-12T13:13:14Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Improve the handling of temporary symbolic variables in sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31728",
    "user": "@spaghettisalat"
}
```
CC:  @slel @egourgoulhon

At various places in sagemath, temporary symbolic variables are used. The names of these variables are chosen in an ad-hoc manner and can often clash with user-defined names. For example, the following gives mathematically wrong answers, because `t0` is used internally as a temporary variable in the conversion from and to maxima.


```
sage: var('x t0')
(x, t0)
sage: function('f')
f
sage: diff(f(x,t0),x).subs({x:x-t0,t0:x+t0}).simplify_full()
-D[1](f)(t0, t0 + x) + 2*D[1](f)(t0, -t0 + 2*x) + D[0](f)(-t0 + x, t0 + x) - D[1](f)(-t0 + x, t0 + x)
```


This ticket fixes these issues by creating fresh variables with unique names where appropriate and otherwise using variables named `_symbol...` which are less likely to clash with user-defined variables. We now also warn if a user tries to define variables which may lead to clashes. 

Furthermore, some instances of calls to `sage.calculus.var.var` which unnecessarily polluted the global namespace have been replaced by `sage.symbolic.ring.SR.var`.

Issue created by migration from https://trac.sagemath.org/ticket/31965





---

archive/issue_comments_453384.json:
```json
{
    "body": "Changing keywords from \"\" to \"SR.var\".",
    "created_at": "2021-06-12T13:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453384",
    "user": "@slel"
}
```

Changing keywords from "" to "SR.var".



---

archive/issue_comments_453385.json:
```json
{
    "body": "Please set to \"needs review\" if ready for review.",
    "created_at": "2021-06-12T13:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453385",
    "user": "@slel"
}
```

Please set to "needs review" if ready for review.



---

archive/issue_comments_453386.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-12T13:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453386",
    "user": "@spaghettisalat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453387.json:
```json
{
    "body": "In this change:\n\n```\n+                if name.startswith('symbol') and name[6:].isdigit():\n+                    import warnings\n+                    warnings.warn(f'The name \"{name}\" may clash with names used internally in sagemath. It is recommended to choose a different name for your variable.')\n```\n\nShouldn't it be warning about names starting with `_symbol`?",
    "created_at": "2021-06-19T02:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453387",
    "user": "@mkoeppe"
}
```

In this change:

```
+                if name.startswith('symbol') and name[6:].isdigit():
+                    import warnings
+                    warnings.warn(f'The name "{name}" may clash with names used internally in sagemath. It is recommended to choose a different name for your variable.')
```

Shouldn't it be warning about names starting with `_symbol`?



---

archive/issue_comments_453388.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-19T13:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453388",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453389.json:
```json
{
    "body": "> Shouldn't it be warning about names starting with `_symbol`? \n\nYes, I forgot that. We should obviously also warn for those cases. I have pushed a new commit which fixes this.",
    "created_at": "2021-06-19T13:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453389",
    "user": "@spaghettisalat"
}
```

> Shouldn't it be warning about names starting with `_symbol`? 

Yes, I forgot that. We should obviously also warn for those cases. I have pushed a new commit which fixes this.



---

archive/issue_comments_453390.json:
```json
{
    "body": "Where are the names starting with `symbol` coming from?",
    "created_at": "2021-06-19T18:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453390",
    "user": "@mkoeppe"
}
```

Where are the names starting with `symbol` coming from?



---

archive/issue_comments_453391.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Where are the names starting with `symbol` coming from?\n\nFrom ginac. This is what you get if you call `SR.symbol()` without any arguments or the new `SR.temp_var` function introduced in this ticket.",
    "created_at": "2021-06-19T18:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453391",
    "user": "@spaghettisalat"
}
```

Replying to [comment:8 mkoeppe]:
> Where are the names starting with `symbol` coming from?

From ginac. This is what you get if you call `SR.symbol()` without any arguments or the new `SR.temp_var` function introduced in this ticket.



---

archive/issue_comments_453392.json:
```json
{
    "body": "Thanks - would you mind adding this information as comments to the code?",
    "created_at": "2021-06-19T18:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453392",
    "user": "@mkoeppe"
}
```

Thanks - would you mind adding this information as comments to the code?



---

archive/issue_comments_453393.json:
```json
{
    "body": "I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names",
    "created_at": "2021-06-19T18:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453393",
    "user": "@mkoeppe"
}
```

I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names



---

archive/issue_comments_453394.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-20T12:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453394",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453395.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names\n\nI don't think this is a problem. These variables don't enter the global namespace, so unless someone is manually extracting them from `SR.symbols` it is not possible to put assumptions on these variables.",
    "created_at": "2021-06-20T12:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453395",
    "user": "@spaghettisalat"
}
```

Replying to [comment:11 mkoeppe]:
> I guess warnings would also be in order if a user tries to put assumptions on `_symbol...` names

I don't think this is a problem. These variables don't enter the global namespace, so unless someone is manually extracting them from `SR.symbols` it is not possible to put assumptions on these variables.



---

archive/issue_comments_453396.json:
```json
{
    "body": "OK, makes sense",
    "created_at": "2021-06-20T14:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453396",
    "user": "@mkoeppe"
}
```

OK, makes sense



---

archive/issue_comments_453397.json:
```json
{
    "body": "`@`nbruin not sure if the boldface comment in the ticket description is intended to be a \"needs work\" item, but this ticket looks like an improvement to me.",
    "created_at": "2021-06-23T01:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453397",
    "user": "@mkoeppe"
}
```

`@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.



---

archive/issue_comments_453398.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-23T01:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453398",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453399.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> `@`nbruin not sure if the boldface comment in the ticket description is intended to be a \"needs work\" item, but this ticket looks like an improvement to me.\n\nWith the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as \"use fresh names every time\" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.",
    "created_at": "2021-06-23T03:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453399",
    "user": "@nbruin"
}
```

Replying to [comment:15 mkoeppe]:
> `@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.

With the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as "use fresh names every time" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.



---

archive/issue_comments_453400.json:
```json
{
    "body": "Replying to [comment:16 nbruin]:\n> Replying to [comment:15 mkoeppe]:\n> > `@`nbruin not sure if the boldface comment in the ticket description is intended to be a \"needs work\" item, but this ticket looks like an improvement to me.\n> \n> With the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as \"use fresh names every time\" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.\n\nThat's not quite correct. Some of the variables (those created with SR.temp_var) are freshly created each time and not reused. However, SR.cleanup_var takes care of removing those from SR.symbols and forgetting any assumptions about them, so that they can be garbage collected.",
    "created_at": "2021-06-23T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453400",
    "user": "@spaghettisalat"
}
```

Replying to [comment:16 nbruin]:
> Replying to [comment:15 mkoeppe]:
> > `@`nbruin not sure if the boldface comment in the ticket description is intended to be a "needs work" item, but this ticket looks like an improvement to me.
> 
> With the current fix on the ticket there is no problem, since there is still a fixed set of variable names that gets reused; just with more convoluted name. It's just that the formulation of the ticket can be read as "use fresh names every time" and that would be a memory leak. That's why I added the clarification to the ticket description and not in a comment on the ticket. So: yes, positive is fine with me.

That's not quite correct. Some of the variables (those created with SR.temp_var) are freshly created each time and not reused. However, SR.cleanup_var takes care of removing those from SR.symbols and forgetting any assumptions about them, so that they can be garbage collected.



---

archive/issue_comments_453401.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-06-29T18:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453401",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_453402.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2021-06-29T18:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453402",
    "user": "@vbraun"
}
```

Merge conflict



---

archive/issue_comments_453403.json:
```json
{
    "body": "the conflict appears to be with #31923.",
    "created_at": "2021-06-29T21:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453403",
    "user": "@mkoeppe"
}
```

the conflict appears to be with #31923.



---

archive/issue_comments_453404.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-29T21:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453404",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453405.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-29T21:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453405",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453406.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-29T21:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453406",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453407.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-01T20:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31728#issuecomment-453407",
    "user": "@vbraun"
}
```

Resolution: fixed
