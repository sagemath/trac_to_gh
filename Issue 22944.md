# Issue 22944: Incorrect implementation of Hasse-Witt matrix for Hyperelliptic Curves

Issue created by migration from Trac.

Original creator: dbisogno

Original creation time: 2017-06-08 16:56:32

Keywords: sd86.5

Currently there are two errors in in the method `HyperellipticCurve._Hasse_Witt_cached()`. 

The first: the function `frob_mat` does not actually apply frobenius to the matrix entries, the current codes follow (comment not be myself)
 {{{
def frob_mat(Coeffs, k):
      a = p ** k
      mat = []
      Coeffs_pow = [c ** a for c in Coeffs]  # not used ??
      for i in range(1, g + 1):
           H = [(Coeffs[j]) for j in range((p*i-1), (p*i - g-1), -1)]
           mat.append(H)
     return matrix(Fq, mat)
}}}

The fix is that in the for loop we should have:
 `H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]`.

The second mistake relates to an error in the literature used in the implementation (see the attached file). Summary, the matrices are multiplied in the reverse order.


Example:
See the attached file for details but the sage code to reproduce the error follows.

```
sage: K.<z>=PolynomialRing(GF(5))
sage: L.<a>=GF(5).extension(z^3+3*z+3,'a')
sage: H.<x> = L[]
sage: E=HyperellipticCurve(x^5+x^4+a^92*x^3+a^18*x^2+a^56*x,0)
sage: E.p_rank()
1
```


Running the correct code

```
M, Coeffs, g, Fq, p, E = E._Cartier_matrix_cached()

#This compute the action of p^kth Frobenius  on list of coefficients
def frob_mat(Coeffs, k):
    a = p ** k
    mat = []
    Coeffs_pow = [c ** a for c in Coeffs]  # not used ??
    for i in range(1, g + 1):
        H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]
        mat.append(H)
    return matrix(Fq, mat)

#Computes all the different possible action of frobenius on matrix M and stores in list Mall
Mall = [M] + [frob_mat(Coeffs, k) for k in range(1, g)]
Mall = list(reversed(Mall))
#initial N=I, so we can go through Mall and multiply all matrices with I and
#get the Hasse-Witt matrix.
N = identity_matrix(Fq, g)
for l in Mall:
    N = N * l
rank(N)
}}
Yields 0 as the correct p-rank.


---

Comment by git created at 2017-06-08 17:04:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-08 18:03:23

Hello,

You do not need to wrap with list here:

```
+        Mall = list(reversed(Mall))
```

because you only want to iterate over that.

And you should add a doctest to show that you have fixed something.


---

Comment by git created at 2017-06-08 18:32:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dbisogno created at 2017-06-09 00:32:09

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-06-09 16:12:01

I just made some small cosmetic changes to the doc of the method. If you agree with my changes, you can set the ticket to "positive review".
----
New commits:


---

Comment by git created at 2017-06-09 16:12:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dbisogno created at 2017-06-09 17:22:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-12 18:01:51

Resolution: fixed
