# Issue 28712: sage.plot.plot3d.shapes2.Line does not accept Sage numbers any more

archive/issues_028712.json:
```json
{
    "body": "In Sage 9.0:\n\n```\nsage: from sage.plot.plot3d.shapes2 import Line\nsage: X = Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])\nsage: X\n/home/dimpase/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py:592: RichReprWarning: Exception in _rich_repr_ while displaying object: Object of type Integer is not JSON serializable\n  RichReprWarning,\nGraphics3d Object\n```\n\nAnd `X.show()` fails (see https://groups.google.com/d/msg/sage-devel/3AnA7jlQcwA/E-mzznvHBgAJ)\n\nHowever, it still works in Sage 8.9.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28949\n\n",
    "created_at": "2020-01-03T14:23:13Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage.plot.plot3d.shapes2.Line does not accept Sage numbers any more",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28712",
    "user": "https://github.com/dimpase"
}
```
In Sage 9.0:

```
sage: from sage.plot.plot3d.shapes2 import Line
sage: X = Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])
sage: X
/home/dimpase/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py:592: RichReprWarning: Exception in _rich_repr_ while displaying object: Object of type Integer is not JSON serializable
  RichReprWarning,
Graphics3d Object
```

And `X.show()` fails (see https://groups.google.com/d/msg/sage-devel/3AnA7jlQcwA/E-mzznvHBgAJ)

However, it still works in Sage 8.9.

Issue created by migration from https://trac.sagemath.org/ticket/28949





---

archive/issue_comments_405081.json:
```json
{
    "body": "I guess these are meant to be constructed via the function `line` or `line3d`, instead of initializing the `Line` class directly:\n\n```\nsage: X = line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])\nsage: X\nLaunched html viewer for Graphics3d Object\n```\n\nAs far as I know, this pattern applies to many graphics objects in Sage, such as those returned by the plot functions.",
    "created_at": "2020-01-03T14:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405081",
    "user": "https://github.com/mwageringel"
}
```

I guess these are meant to be constructed via the function `line` or `line3d`, instead of initializing the `Line` class directly:

```
sage: X = line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])
sage: X
Launched html viewer for Graphics3d Object
```

As far as I know, this pattern applies to many graphics objects in Sage, such as those returned by the plot functions.



---

archive/issue_comments_405082.json:
```json
{
    "body": "Well, the documentation of `Line` shows `Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])` as if it should work. So something needs to be done at least there.",
    "created_at": "2020-01-03T16:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405082",
    "user": "https://github.com/dimpase"
}
```

Well, the documentation of `Line` shows `Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])` as if it should work. So something needs to be done at least there.



---

archive/issue_comments_405083.json:
```json
{
    "body": "This came up also in #27592.\n\nMy suggestion there (on which there hasn't been any action, or even a ticket) is that `SageObject`s should get a `_json_` method, which returns a JSON serialization of that object, if possible.  We then need to add a custom [JSONEncoder](https://docs.python.org/3.7/library/json.html#json.JSONEncoder) which can handle objects with a `_json_` method where possible.\n\nUnfortunately there is no way to extend the standard `json` module to support new types without directly using a custom `JSONEncoder`, which means any code in Sage that outputs JSON needs to use our custom encoder.  This is not such a problem--it just needs to be documented properly, e.g. that to JSON-encode Sage objects one needs to use `sage.json` or whatever instead of the plain `json` module.\n\nThere has been action lately on python-dev surrounding making it easier to do custom JSON serialization/deserialization but I haven't followed it lately.  I don't think there's even a PEP yet.",
    "created_at": "2020-01-06T14:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405083",
    "user": "https://github.com/embray"
}
```

This came up also in #27592.

My suggestion there (on which there hasn't been any action, or even a ticket) is that `SageObject`s should get a `_json_` method, which returns a JSON serialization of that object, if possible.  We then need to add a custom [JSONEncoder](https://docs.python.org/3.7/library/json.html#json.JSONEncoder) which can handle objects with a `_json_` method where possible.

Unfortunately there is no way to extend the standard `json` module to support new types without directly using a custom `JSONEncoder`, which means any code in Sage that outputs JSON needs to use our custom encoder.  This is not such a problem--it just needs to be documented properly, e.g. that to JSON-encode Sage objects one needs to use `sage.json` or whatever instead of the plain `json` module.

There has been action lately on python-dev surrounding making it easier to do custom JSON serialization/deserialization but I haven't followed it lately.  I don't think there's even a PEP yet.



---

archive/issue_comments_405084.json:
```json
{
    "body": "Hello! If you'll forgive my intrusion into this ticket, the changes I've made in #29227 seem to have unintentionally fixed the example code from the description and linked sage-devel post here. I ran into similar problems with Integer, Rational, and symbolic expression not being JSON serializable when running my branch through the examples in the plot3d reference manual. \n\nRather than creating a custom `JSONEncoder` and trying to enumerate and convert every possible type I might encounter, I opted to just convert values to Python's int/float/string as I placed them into the plot's new `threejs_repr` (that eventually goes through the `json` module). That way, I don't need to care what those values actually *are*, only what the three.js template expects them to be. As long as those types define the appropriate `__int__`, `__float__`, or `__str__` methods, they should work.\n\nProbably not the ideal solution, as it requires future maintainers to know about and remember to perform those conversions, but it solved the immediate issues. I really like the idea of a `_json_` method for serialization to avoid the need for these manual conversions.\n\nBest regards!",
    "created_at": "2020-03-21T21:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405084",
    "user": "https://github.com/jcamp0x2a"
}
```

Hello! If you'll forgive my intrusion into this ticket, the changes I've made in #29227 seem to have unintentionally fixed the example code from the description and linked sage-devel post here. I ran into similar problems with Integer, Rational, and symbolic expression not being JSON serializable when running my branch through the examples in the plot3d reference manual. 

Rather than creating a custom `JSONEncoder` and trying to enumerate and convert every possible type I might encounter, I opted to just convert values to Python's int/float/string as I placed them into the plot's new `threejs_repr` (that eventually goes through the `json` module). That way, I don't need to care what those values actually *are*, only what the three.js template expects them to be. As long as those types define the appropriate `__int__`, `__float__`, or `__str__` methods, they should work.

Probably not the ideal solution, as it requires future maintainers to know about and remember to perform those conversions, but it solved the immediate issues. I really like the idea of a `_json_` method for serialization to avoid the need for these manual conversions.

Best regards!



---

archive/issue_events_073324.json:
```json
{
    "actor": "https://github.com/paulmasson",
    "created_at": "2020-03-22T21:48:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28712#event-73324"
}
```



---

archive/issue_comments_405085.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-22T21:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405085",
    "user": "https://github.com/paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405086.json:
```json
{
    "body": "I can verify that this issue is fixed by #29227. Way to go, Joshua!",
    "created_at": "2020-03-22T21:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405086",
    "user": "https://github.com/paulmasson"
}
```

I can verify that this issue is fixed by #29227. Way to go, Joshua!



---

archive/issue_comments_405087.json:
```json
{
    "body": "Changing keywords from \"\" to \"threejs\".",
    "created_at": "2020-03-22T21:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405087",
    "user": "https://github.com/paulmasson"
}
```

Changing keywords from "" to "threejs".



---

archive/issue_comments_405088.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-29T16:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405088",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_073325.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-03-30T19:53:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28712#event-73325"
}
```



---

archive/issue_comments_405089.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-03-30T19:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405089",
    "user": "https://github.com/fchapoton"
}
```

Resolution: invalid



---

archive/issue_comments_405090.json:
```json
{
    "body": "Resolution changed from invalid to duplicate",
    "created_at": "2020-03-30T19:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28712#issuecomment-405090",
    "user": "https://github.com/fchapoton"
}
```

Resolution changed from invalid to duplicate
