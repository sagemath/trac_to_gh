# Issue 28712: sage.plot.plot3d.shapes2.Line does not accept Sage numbers any more

Issue created by migration from https://trac.sagemath.org/ticket/28949

Original creator: dimpase

Original creation time: 2020-01-03 14:23:13

In Sage 9.0:

```
sage: from sage.plot.plot3d.shapes2 import Line
sage: X = Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])
sage: X
/home/dimpase/sage/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py:592: RichReprWarning: Exception in _rich_repr_ while displaying object: Object of type Integer is not JSON serializable
  RichReprWarning,
Graphics3d Object
```

And `X.show()` fails (see https://groups.google.com/d/msg/sage-devel/3AnA7jlQcwA/E-mzznvHBgAJ)

However, it still works in Sage 8.9.


---

Comment by @mwageringel created at 2020-01-03 14:50:49

I guess these are meant to be constructed via the function `line` or `line3d`, instead of initializing the `Line` class directly:

```
sage: X = line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])
sage: X
Launched html viewer for Graphics3d Object
```

As far as I know, this pattern applies to many graphics objects in Sage, such as those returned by the plot functions.


---

Comment by dimpase created at 2020-01-03 16:03:56

Well, the documentation of `Line` shows `Line([(-1, 0, 0), (0, 0, 0), (1, 0, 0)])` as if it should work. So something needs to be done at least there.


---

Comment by embray created at 2020-01-06 14:19:02

This came up also in #27592.

My suggestion there (on which there hasn't been any action, or even a ticket) is that `SageObject`s should get a `_json_` method, which returns a JSON serialization of that object, if possible.  We then need to add a custom [JSONEncoder](https://docs.python.org/3.7/library/json.html#json.JSONEncoder) which can handle objects with a `_json_` method where possible.

Unfortunately there is no way to extend the standard `json` module to support new types without directly using a custom `JSONEncoder`, which means any code in Sage that outputs JSON needs to use our custom encoder.  This is not such a problem--it just needs to be documented properly, e.g. that to JSON-encode Sage objects one needs to use `sage.json` or whatever instead of the plain `json` module.

There has been action lately on python-dev surrounding making it easier to do custom JSON serialization/deserialization but I haven't followed it lately.  I don't think there's even a PEP yet.


---

Comment by @jcamp0x2a created at 2020-03-21 21:25:23

Hello! If you'll forgive my intrusion into this ticket, the changes I've made in #29227 seem to have unintentionally fixed the example code from the description and linked sage-devel post here. I ran into similar problems with Integer, Rational, and symbolic expression not being JSON serializable when running my branch through the examples in the plot3d reference manual. 

Rather than creating a custom `JSONEncoder` and trying to enumerate and convert every possible type I might encounter, I opted to just convert values to Python's int/float/string as I placed them into the plot's new `threejs_repr` (that eventually goes through the `json` module). That way, I don't need to care what those values actually _are_, only what the three.js template expects them to be. As long as those types define the appropriate `__int__`, `__float__`, or `__str__` methods, they should work.

Probably not the ideal solution, as it requires future maintainers to know about and remember to perform those conversions, but it solved the immediate issues. I really like the idea of a `_json_` method for serialization to avoid the need for these manual conversions.

Best regards!


---

Comment by paulmasson created at 2020-03-22 21:48:12

Changing status from new to needs_review.


---

Comment by paulmasson created at 2020-03-22 21:48:12

I can verify that this issue is fixed by #29227. Way to go, Joshua!


---

Comment by paulmasson created at 2020-03-22 21:49:20

Changing keywords from "" to "threejs".


---

Comment by paulmasson created at 2020-03-29 16:51:53

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-03-30 19:53:53

Resolution: invalid


---

Comment by chapoton created at 2020-03-30 19:54:06

Resolution changed from invalid to duplicate
