# Issue 26639: parallel functions swallow alarm interruptions

Issue created by migration from https://trac.sagemath.org/ticket/26876

Original creator: slabbe

Original creation time: 2018-12-11 10:49:36

Import alarm, sleep and parallel and construct a function to be run in parallel:

```python
sage: from signal import alarm
sage: from time import sleep
sage: @parallel
....: def f(a):
....:     sleep(1)
....:     return factor(a)
....: 
```


If the function `f` is called normally, it behaves well with alarm interruptions:

```python
sage: try:
....:     alarm(1)
....:     map(f, range(10))
....: except AlarmInterrupt:
....:     print 'alarm'
....: else:
....:     print 'else'
....:     
0
alarm
```


But If the function `f` is called in parallel, then it ignores the alarm interruption and just continue its execution:


```python
sage: try:
....:     alarm(1)
....:     L = list(f(range(1,10)))
....: except AlarmInterrupt:
....:     print 'alarm'
....: else:
....:     print 'else'
....:     
0
else
```


Of course, as a result, the computation for input 1 was stopped (thus NO DATA) and the other computations were not stopped:

```python
sage: L
[(((1,), {}), 'NO DATA (timed out)'),
 (((2,), {}), 2),
 (((3,), {}), 3),
 (((4,), {}), 2^2),
 (((5,), {}), 5),
 (((6,), {}), 2 * 3),
 (((7,), {}), 7),
 (((8,), {}), 2^3),
 (((9,), {}), 3^2)]
```

I consider this as a bug. I believe that the parallel `f` function should not swallow the `alarm` interruptions so that the above example print "alarm" and not "else".


---

Comment by jdemeyer created at 2018-12-11 15:37:10

The problem is that the ``@`parallel` decorator uses alarms internally to implement the timeout functionality. So basically your alarm is overridden by ``@`parallel`.


---

Comment by slabbe created at 2018-12-13 08:21:32


```
sage: @parallel?
```

says:

```
      * "timeout" -- number of seconds until each subprocess is
        killed (only supported by 'fork'; zero means not at all)
```

Would it be possible when `timeout=zero` that alarm exceptions are not catched since when `timeout=0` no alarm are set?


---

Comment by slabbe created at 2018-12-13 08:22:11

Changing keywords from "" to "thursdaysbdx".


---

Comment by @timokau created at 2019-06-18 19:02:16

I have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.


---

Comment by jdemeyer created at 2019-06-19 05:36:07

Replying to [comment:4 gh-timokau]:
> I have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.

Can you elaborate?


---

Comment by @timokau created at 2019-06-19 17:38:31

Our buildservers have randomly ran into this failure 3 times while building (and testing) sage. Two times was on sage 8.7 (in our unstable channel), once on 8.6 (latest stable). Here's a log for 8.7:

http://sprunge.us/mYh7ju


---

Comment by jdemeyer created at 2019-06-19 18:00:02

Why do you think that those buildserver failures are because of this ticket? It seems to me that you're hitting a different unrelated bug.


---

Comment by @timokau created at 2019-06-20 12:01:07

I just jumped to the conclusion, because the error is so similar. Looking at it in more detail though, you're probably right. May just be the server under load hitting the 10 second timeout (having a timeout in unit tests seems like an antipattern to me anyways).
