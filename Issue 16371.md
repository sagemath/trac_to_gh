# Issue 16371: Immediate fix for animations in notebook

archive/issues_016371.json:
```json
{
    "body": "CC:  @kcrisman @jhpalmieri @gagern\n\nKeywords: notebook, animate\n\nThe following example, taken from the documentation of the animate module, produces no visible output in the notebook:\n\n\n```\nsage: sines = [plot(c*sin(x), (-2*pi,2*pi), color=Color(c,0,0), ymin=-1,ymax=1) for c in sxrange(0,1,.2)]\nsage: a = animate(sines)\nsage: a.show()\n```\n\n\nThis is a regression introduced by #12827.  See discussion at #16533.\n\nA good fix for this is in progress as part of a larger effort to unify and expand animation functionality.  This ticket simply restores the functionality in the meantime.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16608\n\n",
    "created_at": "2014-07-03T13:46:32Z",
    "labels": [
        "component: notebook",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Immediate fix for animations in notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16371",
    "user": "https://github.com/nilesjohnson"
}
```
CC:  @kcrisman @jhpalmieri @gagern

Keywords: notebook, animate

The following example, taken from the documentation of the animate module, produces no visible output in the notebook:


```
sage: sines = [plot(c*sin(x), (-2*pi,2*pi), color=Color(c,0,0), ymin=-1,ymax=1) for c in sxrange(0,1,.2)]
sage: a = animate(sines)
sage: a.show()
```


This is a regression introduced by #12827.  See discussion at #16533.

A good fix for this is in progress as part of a larger effort to unify and expand animation functionality.  This ticket simply restores the functionality in the meantime.

Issue created by migration from https://trac.sagemath.org/ticket/16608





---

archive/issue_comments_214621.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-07-03T13:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214621",
    "user": "https://github.com/nilesjohnson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_214622.json:
```json
{
    "body": "See discussion at [#16533:24](http://trac.sagemath.org/ticket/16533#comment:24) and below.\n\nI've run all long doctests successfully.",
    "created_at": "2014-07-03T13:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214622",
    "user": "https://github.com/nilesjohnson"
}
```

See discussion at [#16533:24](http://trac.sagemath.org/ticket/16533#comment:24) and below.

I've run all long doctests successfully.



---

archive/issue_comments_214623.json:
```json
{
    "body": "gagern says there:\n> So if someone decides that my branch isn't going to make it to the next release, then I'm giving your small change a positive review. \nThe change is minimal indeed.  I can't check myself whether this works but certainly the code should make it work.\n> I've run all long doctests successfully.\nDid you run them with optional tests enabled? ;-)",
    "created_at": "2014-07-03T15:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214623",
    "user": "https://github.com/kcrisman"
}
```

gagern says there:
> So if someone decides that my branch isn't going to make it to the next release, then I'm giving your small change a positive review. 
The change is minimal indeed.  I can't check myself whether this works but certainly the code should make it work.
> I've run all long doctests successfully.
Did you run them with optional tests enabled? ;-)



---

archive/issue_comments_214624.json:
```json
{
    "body": "Replying to [comment:2 kcrisman]:\n\n> > I've run all long doctests successfully.\n> Did you run them with optional tests enabled? ;-)\n\nha ha; no, I forgot.  Now\n\n\n```\nsage -tp --long --optional=sage,ImageMagick,convert src/sage/plot\n```\n\n\npasses all tests.  Of course, none of them test embedded mode anyway!",
    "created_at": "2014-07-03T16:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214624",
    "user": "https://github.com/nilesjohnson"
}
```

Replying to [comment:2 kcrisman]:

> > I've run all long doctests successfully.
> Did you run them with optional tests enabled? ;-)

ha ha; no, I forgot.  Now


```
sage -tp --long --optional=sage,ImageMagick,convert src/sage/plot
```


passes all tests.  Of course, none of them test embedded mode anyway!



---

archive/issue_comments_214625.json:
```json
{
    "body": "Note that users who want to use FFmpeg to generate their GIF will have to pass an explicit name to the `ffmpeg` method, since in your code `show` does not support a `use_ffmpeg` argument and `save` does not make a suitable choice of file name. Not sure this is worth fixing, though.",
    "created_at": "2014-07-03T18:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214625",
    "user": "https://github.com/gagern"
}
```

Note that users who want to use FFmpeg to generate their GIF will have to pass an explicit name to the `ffmpeg` method, since in your code `show` does not support a `use_ffmpeg` argument and `save` does not make a suitable choice of file name. Not sure this is worth fixing, though.



---

archive/issue_comments_214626.json:
```json
{
    "body": "Replying to [comment:4 gagern]:\n> Note that users who want to use FFmpeg to generate their GIF will have to pass an explicit name to the `ffmpeg` method, since in your code `show` does not support a `use_ffmpeg` argument and `save` does not make a suitable choice of file name. Not sure this is worth fixing, though.\n\nFor this ticket, let's focus only on fixing regressions from previous functionality.  Did those things work before #12827?  With the current branch, all of the following work in the notebook:\n\n\n```\nc = animate([circle((i,i), 1-1/(i+1)^2, hue=i/5) for i in srange(0,2,0.2)],xmin=0,ymin=0,xmax=2,ymax=2,figsize=[2,2])\nc.show()\n\n[shows the gif]\n```\n\n\n\n```\nc.save(show_path=True)\n\n[saves and returns path '/Users/njohnson/.sage/temp/n15158/65775/tmp_zk_bPS.gif']\n```\n\n\n\n```\nc.save(show_path=True,use_ffmpeg=True)\n\n[saves and returns path '/Users/njohnson/.sage/temp/n15158/65775/tmp_x8eYhm.gif']\n```\n\n\n\n```\nc.save('test.mpg',show_path=True,use_ffmpeg=True)\n\n[saves and returns path '/private/var/folders/vm/9s3hrqs50jgfjhdl20yl9yjnfj74f3/T/tmpJY9m2M/test.mpg'\n```\n\n\nThe animations exist at the indicated locations in the indicated formats, and ffmpeg is used when requested.\n\nExamples from the reference manual involving `implicit_plot3d` and Tachyon also work as expected.",
    "created_at": "2014-07-03T19:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214626",
    "user": "https://github.com/nilesjohnson"
}
```

Replying to [comment:4 gagern]:
> Note that users who want to use FFmpeg to generate their GIF will have to pass an explicit name to the `ffmpeg` method, since in your code `show` does not support a `use_ffmpeg` argument and `save` does not make a suitable choice of file name. Not sure this is worth fixing, though.

For this ticket, let's focus only on fixing regressions from previous functionality.  Did those things work before #12827?  With the current branch, all of the following work in the notebook:


```
c = animate([circle((i,i), 1-1/(i+1)^2, hue=i/5) for i in srange(0,2,0.2)],xmin=0,ymin=0,xmax=2,ymax=2,figsize=[2,2])
c.show()

[shows the gif]
```



```
c.save(show_path=True)

[saves and returns path '/Users/njohnson/.sage/temp/n15158/65775/tmp_zk_bPS.gif']
```



```
c.save(show_path=True,use_ffmpeg=True)

[saves and returns path '/Users/njohnson/.sage/temp/n15158/65775/tmp_x8eYhm.gif']
```



```
c.save('test.mpg',show_path=True,use_ffmpeg=True)

[saves and returns path '/private/var/folders/vm/9s3hrqs50jgfjhdl20yl9yjnfj74f3/T/tmpJY9m2M/test.mpg'
```


The animations exist at the indicated locations in the indicated formats, and ffmpeg is used when requested.

Examples from the reference manual involving `implicit_plot3d` and Tachyon also work as expected.



---

archive/issue_comments_214627.json:
```json
{
    "body": "Replying to [comment:5 niles]:\n> For this ticket, let's focus only on fixing regressions from previous functionality.  Did those things work before #12827?\n\nThe way I read [the diff](http://git.sagemath.org/sage.git/commit/?id=ff74c22272169319ebc4c134fe19147c7251f1d5), it should have worked, since both these methods called `graphics_filename`. The documentation also indicates as much, e.g. the docstring for `gif()` writes:\n\n\n```\n        If ``savefile`` is not specified: in notebook mode, display the\n        animation; otherwise, save it to a default file name.\n\n        EXAMPLES::\n\n            sage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],\n            ....:                xmin=0, xmax=2*pi, figsize=[2,1])\n            sage: dir = tmp_dir()\n            sage: a.gif()              # not tested\n```\n\n\nThis \u201cdisplay the animation\u201d part of the promise is still broken in your fix, and the `a.gif()` call doesn't have a lot of effect since it saves the file in some temporary directory without telling anyone its location.\n\nI must confess that my own changes from #16533 won't fix this either. Only with #16573 did I change the documentation in a way which is not backwards-compatible but at least restores a match between documentation and behavior.\n\nAn alternative to your fix would be getting #15515 ready and the replacing *all* occurrences of `tmp_filename` with `graphics_filename`. That should restore old behavior in all relevant cases.\n\nOf course, we could also merge your fix and then build all subsequent modifications on that. After all, your fix is better than no fix at all, and it looks like I might have to rebase most of my animation-related changes anyway.",
    "created_at": "2014-07-03T22:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214627",
    "user": "https://github.com/gagern"
}
```

Replying to [comment:5 niles]:
> For this ticket, let's focus only on fixing regressions from previous functionality.  Did those things work before #12827?

The way I read [the diff](http://git.sagemath.org/sage.git/commit/?id=ff74c22272169319ebc4c134fe19147c7251f1d5), it should have worked, since both these methods called `graphics_filename`. The documentation also indicates as much, e.g. the docstring for `gif()` writes:


```
        If ``savefile`` is not specified: in notebook mode, display the
        animation; otherwise, save it to a default file name.

        EXAMPLES::

            sage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],
            ....:                xmin=0, xmax=2*pi, figsize=[2,1])
            sage: dir = tmp_dir()
            sage: a.gif()              # not tested
```


This “display the animation” part of the promise is still broken in your fix, and the `a.gif()` call doesn't have a lot of effect since it saves the file in some temporary directory without telling anyone its location.

I must confess that my own changes from #16533 won't fix this either. Only with #16573 did I change the documentation in a way which is not backwards-compatible but at least restores a match between documentation and behavior.

An alternative to your fix would be getting #15515 ready and the replacing *all* occurrences of `tmp_filename` with `graphics_filename`. That should restore old behavior in all relevant cases.

Of course, we could also merge your fix and then build all subsequent modifications on that. After all, your fix is better than no fix at all, and it looks like I might have to rebase most of my animation-related changes anyway.



---

archive/issue_comments_214628.json:
```json
{
    "body": "> Of course, we could also merge your fix and then build all subsequent modifications on that. After all, your fix is better than no fix at all, and it looks like I might have to rebase most of my animation-related changes anyway.\nMartin, if the fix solves your problem and you agree with tests then let's get this in.  I can only test simple animations, I don't have ffmpeg installed, but it does appear to work correctly and as I said the code seems right.  I'm not a big fan of making things rebase, as I find it very tedious, but this is high enough priority that we should just fix it.\n> This \u201cdisplay the animation\u201d part of the promise is still broken in your fix\nTrue.  Maybe just as a hack, one could always add `show_path=True` for `EMBEDDED_MODE`... that might end up annoying.  Maybe just when `if not savefile and EMBEDDED_MODE` one could make `savefile=graphics_filename(ext='.gif')` ?  Would that work?  Too hackish?\n\nAlso, Niles, you can actually test things with embedded mode... maybe we should add that.  \n\nBut we should do it soon!",
    "created_at": "2014-07-09T03:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214628",
    "user": "https://github.com/kcrisman"
}
```

> Of course, we could also merge your fix and then build all subsequent modifications on that. After all, your fix is better than no fix at all, and it looks like I might have to rebase most of my animation-related changes anyway.
Martin, if the fix solves your problem and you agree with tests then let's get this in.  I can only test simple animations, I don't have ffmpeg installed, but it does appear to work correctly and as I said the code seems right.  I'm not a big fan of making things rebase, as I find it very tedious, but this is high enough priority that we should just fix it.
> This “display the animation” part of the promise is still broken in your fix
True.  Maybe just as a hack, one could always add `show_path=True` for `EMBEDDED_MODE`... that might end up annoying.  Maybe just when `if not savefile and EMBEDDED_MODE` one could make `savefile=graphics_filename(ext='.gif')` ?  Would that work?  Too hackish?

Also, Niles, you can actually test things with embedded mode... maybe we should add that.  

But we should do it soon!



---

archive/issue_comments_214629.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n\n> Also, Niles, you can actually test things with embedded mode... maybe we should add that.  \n> \n> But we should do it soon!\n\nI agree, but unfortunately I am traveling this week and probably also unavailable for the next two weeks.  I think this is borderline but just over the threshold for a positive review, but I'll leave that up to you.  I think the options are:\n\n* Positive review as is\n\n* Get someone else to add changes, make more robust\n\n* Downgrade from blocker\n\nI know this isn't a great situation, but I just can't do more at the moment.",
    "created_at": "2014-07-09T22:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214629",
    "user": "https://github.com/nilesjohnson"
}
```

Replying to [comment:7 kcrisman]:

> Also, Niles, you can actually test things with embedded mode... maybe we should add that.  
> 
> But we should do it soon!

I agree, but unfortunately I am traveling this week and probably also unavailable for the next two weeks.  I think this is borderline but just over the threshold for a positive review, but I'll leave that up to you.  I think the options are:

* Positive review as is

* Get someone else to add changes, make more robust

* Downgrade from blocker

I know this isn't a great situation, but I just can't do more at the moment.



---

archive/issue_comments_214630.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-07-10T00:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214630",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_214631.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n> Martin, if the fix solves your problem and you agree with tests then let's get this in.\n\nFine. Let's get this over with, and I'll have a look at rebases and proper fixes after that.\n\n> > This \u201cdisplay the animation\u201d part of the promise is still broken in your fix\n> True.  Maybe just as a hack, one could always add `show_path=True` for `EMBEDDED_MODE`... that might end up annoying.  Maybe just when `if not savefile and EMBEDDED_MODE` one could make `savefile=graphics_filename(ext='.gif')` ?  Would that work?  Too hackish?\n\nToo hackish. Properly fixing this isn't that much harder. It would mean doing the distinction between embedded mode and non-embedded mode for *every* occurrence of `tmp_filename`. Which is a lot of code duplication unless you move that distinction *into* `graphics_filename`, which is what #15515 is about. Maybe I can review that one soon, too, but don't hold your breath on me since I've an important appointment coming up.\n\n> Also, Niles, you can actually test things with embedded mode... maybe we should add that.  \n\nDo you mean test suite? Can we run tests inside the notebook server somehow? And see where things end up, what html gets generated and so on? Or am I completely missing the point of what you meant?\n\nIn any case, changing tests at this point is probably a bad idea. Should be a separate issue.",
    "created_at": "2014-07-10T00:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214631",
    "user": "https://github.com/gagern"
}
```

Replying to [comment:7 kcrisman]:
> Martin, if the fix solves your problem and you agree with tests then let's get this in.

Fine. Let's get this over with, and I'll have a look at rebases and proper fixes after that.

> > This “display the animation” part of the promise is still broken in your fix
> True.  Maybe just as a hack, one could always add `show_path=True` for `EMBEDDED_MODE`... that might end up annoying.  Maybe just when `if not savefile and EMBEDDED_MODE` one could make `savefile=graphics_filename(ext='.gif')` ?  Would that work?  Too hackish?

Too hackish. Properly fixing this isn't that much harder. It would mean doing the distinction between embedded mode and non-embedded mode for *every* occurrence of `tmp_filename`. Which is a lot of code duplication unless you move that distinction *into* `graphics_filename`, which is what #15515 is about. Maybe I can review that one soon, too, but don't hold your breath on me since I've an important appointment coming up.

> Also, Niles, you can actually test things with embedded mode... maybe we should add that.  

Do you mean test suite? Can we run tests inside the notebook server somehow? And see where things end up, what html gets generated and so on? Or am I completely missing the point of what you meant?

In any case, changing tests at this point is probably a bad idea. Should be a separate issue.



---

archive/issue_comments_214632.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-07-11T04:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214632",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048719.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-11T04:19:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16371#event-48719"
}
```



---

archive/issue_comments_214633.json:
```json
{
    "body": "I just implemented a proper fix including `gif` and `ffmpeg` in #16645. Does one of you want to review that? Niles perhaps?",
    "created_at": "2014-07-11T08:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16371#issuecomment-214633",
    "user": "https://github.com/gagern"
}
```

I just implemented a proper fix including `gif` and `ffmpeg` in #16645. Does one of you want to review that? Niles perhaps?
