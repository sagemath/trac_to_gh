# Issue 13421: matrix_plot and title don't mix well (yet)

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2012-10-19 12:21:24

Assignee: jason, was

See [this ask.sagemath.org question](http://ask.sagemath.org/question/1888/put-title-on-matrix_plot), where elcojon gives this example.

```
piclabels = ('width [px]','height [px]')
import scipy 
data = scipy.lena()
matrix_plot(data,axes_labels=piclabels, title='Lena image')
```

[This is the Trac macro *Image* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#Image-macro)

This is fallout from the great _new_ functionality in #10512.


---

Comment by kcrisman created at 2012-10-19 12:21:39

What happens currently - bad


---

Attachment


---

Comment by ppurka created at 2012-10-19 12:34:26

Unless I am mistaken, this has to be a bug in matplotlib. We don't touch title positions when there is a frame.


---

Comment by kcrisman created at 2012-10-19 12:43:18

That's my point; we _do_ touch them when we have axes but no frames, so that there isn't an overlap (see the discussion at #10512.  So maybe we should do so here as well.  Perhaps those are both bugs in mpl, in which case maybe it should be reported upstream, but I don't have enough mpl-fu to figure out a native mpl version of this problem quickly.  I think it's us, because in the code for

```
sage: sage.plot.matrix_plot.MatrixPlot._render_on_subplot??
<skip stuff>
image=subplot.imshow(self.xy_data_array, **opts)
<skip irrelevant stuff>
subplot.xaxis.tick_top()
```

we presumably add the title before the ticks and labels.  So it's already placed the title early.  Maybe we should do all opts except title, and then do the title at the end in this particular rendering method?  I'll try that quick.


---

Comment by kcrisman created at 2012-10-19 12:44:30

Scratch that last comment, 

```
            opts = dict(cmap=cmap, interpolation='nearest', aspect='equal',
                      norm=norm, vmin=options['vmin'], vmax=options['vmax'],
                      origin=origin,zorder=options.get('zorder',None))
```

so I'll have to look a little more at where the title enters.


---

Comment by kcrisman created at 2012-10-19 12:52:56

Indeed, the following fixes the problem (though probably introduces others!)

```diff
diff --git a/sage/plot/graphics.py b/sage/plot/graphics.py
--- a/sage/plot/graphics.py
+++ b/sage/plot/graphics.py
`@``@` -2460,11 +2460,8 `@``@`
         # free limits autoscale
         #subplot.autoscale_view(tight=True)
         if title is not None:
-            if (frame) or (axes_labels is None):
-                subplot.set_title(title, fontsize=fontsize)
-            else: # frame is false axes is not None, and neither is axes_labels
-                # Then, the title is moved up to avoid overlap with axes labels
-                subplot.set_title(title, fontsize=fontsize, position=(0.5,1.05))
+            # Then, the title is moved up to avoid overlap with axes labels
+            subplot.set_title(title, fontsize=fontsize, position=(0.5,1.05))
```



---

Comment by ppurka created at 2012-10-19 12:56:15

It's a bug in mpl. It shouldn't be our job to move title positions around. The bug is because of `tick_top()` that is used.

```
sage: from matplotlib.figure import Figure
sage: figure = Figure()
sage: subplot = figure.add_subplot(111)
sage: import numpy as np
sage: M = np.identity(50)
sage: subplot.imshow(M)
<matplotlib.image.AxesImage object at 0x8bc0650>
sage: subplot.xaxis.tick_top()   # <--------- this introduces the bug
sage: subplot.set_title('a title')
<matplotlib.text.Text object at 0x8c54610>
sage: from matplotlib.backends.backend_agg import FigureCanvasAgg
sage: figure.set_canvas(FigureCanvasAgg(figure))
sage: figure.savefig('/tmp/a.png')
sage: !feh /tmp/a.png
```


EDIT: the problem with shifting title positions by ourselves is that the title will be quite a bit off vertically in normal plots. Definitely not what we desire.


---

Comment by kcrisman created at 2012-10-19 13:05:36

Gotcha.  I was still trying to figure out exactly how to create what you got up there...

Right, I figured that uniformly shifting the title was bad, but I was wondering if we could special-case this for now somehow while still reporting the problem. Can you report this upstream?


---

Comment by ppurka created at 2012-10-19 13:18:38

OK. This is now reported upstream at [1415](https://github.com/matplotlib/matplotlib/issues/1415).


---

Comment by ppurka created at 2012-10-19 15:31:24

I will try and see sometime if something can be hacked up in Sage. Maybe give users the extra control over where to put the plot title? Then it will have the added benefit of us not having to remember to remove our hack once mpl fixes it in their end. Something like `title_pos=(x_factor, y_factor)` can be used. Example would be

```
plot(x, title='such is life', title_pos=(0.4, 0.2))
```



---

Comment by kcrisman created at 2012-10-19 16:25:06

That seems reasonable, as long as it's automatic for matrix plots which have `origin='upper'`.  We'd need very good documentation about what the `title_pos` argument means, though, since I think it's different (relative to the figure as a 1 by 1 object) than other places where things can get set, like `text()`, where `axis_coords` is not the default.


---

Comment by ppurka created at 2012-10-20 17:23:53

Added patches, which must be applied in the specified order.
1. [attachment:trac_13625-new_option_title_pos.patch]
2. [attachment:trac_13625-add_title_pos_to_matrix_plot.patch]


---

Comment by ppurka created at 2012-10-20 17:23:53

Changing status from new to needs_review.


---

Comment by kcrisman created at 2012-10-21 00:56:14

Brief glance looks good; I'm not in a position to try plots and run tests but the concept looks right for exposing this.  I would point out that we only need the extra `title_pos` in `matrix_plot` when `origin='upper'`; it looks fine when the ticks are labeled on the bottom.  You might want to experiment a little with those.


---

Comment by ppurka created at 2012-10-21 01:51:54

Thanks. I forgot about the `origin` keyword. You did mention this before.


---

Comment by ppurka created at 2012-10-21 01:53:09

patchbot apply trac_13625-new_option_title_pos.patch trac_13625-add_title_pos_to_matrix_plot.patch


---

Comment by kcrisman created at 2012-10-21 02:11:42

Okay. Doctest the fixed matrix plots, with and without the keywords.  People should be able to try out the difference in the live documentation.


---

Comment by kcrisman created at 2012-10-21 02:11:42

Changing status from needs_review to needs_work.


---

Comment by ppurka created at 2012-10-21 02:41:56

hopefully fixed now.


---

Comment by ppurka created at 2012-10-21 02:41:56

Changing status from needs_work to needs_review.


---

Comment by ppurka created at 2012-10-21 02:44:22

oops. sorry. Forgot about one thing.


---

Comment by ppurka created at 2012-10-21 02:46:30

Apply to `devel/sage`


---

Attachment

Ok. This is fixed now. The problem with the patch was that custom `title_pos` was being overridden with `title_pos=(0.5,1.05)`. I forgot to take care of this case when I removed this keyword from ``@`options()`.


---

Comment by ppurka created at 2012-10-28 17:01:18

patchbot failing all doctests... me tearing hair...

patchbot apply trac_13625-new_option_title_pos.patch trac_13625-add_title_pos_to_matrix_plot.patch


---

Comment by kcrisman created at 2012-12-02 03:23:37

Okay, looks good overall, I can do all kinds of goofy things!  I like these patches, sorry for the delay.

I do think we need a little better error catching.

```
sage: plot(sin, -4, 4, title='Plot sin(x)', title_pos=.05)
<snip>
   2482         if title is not None:
   2483             if title_pos is not None:
-> 2484                 if len(title_pos) != 2:
   2485                     raise ValueError("`title_pos` must be a list or tuple "
   2486                                      "of two real numbers.")

TypeError: object of type 'sage.rings.real_mpfr.RealLiteral' has no len()
```

A subtle difference, but this should also tell the user that `title_pos` must be the right format.


---

Comment by ppurka created at 2012-12-02 04:05:08

Thanks for the review! I hadn't thought of this case. Fixed now.

Patchbot: apply trac_13625-new_option_title_pos.patch trac_13625-add_title_pos_to_matrix_plot.patch


---

Comment by kcrisman created at 2012-12-02 04:24:21

Should ``title_pos`` have back ticks in the error message?

I won't be able to get to this until next week, so no rush on the answer to that.  I also have to run tests, though I don't expect any surprises.


---

Comment by ppurka created at 2012-12-02 08:57:13

Not sure why i used those backticks. Fixed now.


---

Attachment


---

Comment by kcrisman created at 2012-12-03 22:12:22

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2012-12-03 22:12:22

There was also an extra space that made the LaTeX of the Cartesian product look wrong in the built doc.  Otherwise, looks great, passes tests!

Patchbot, apply trac_13625-new_option_title_pos.patch and trac_13625-add_title_pos_to_matrix_plot-reviewed.patch


---

Comment by ppurka created at 2012-12-04 03:51:06

Oops. I didn't see that you have already fixed it! sorry. Thanks for the review. :)

Patchbot apply trac_13625-new_option_title_pos.patch and trac_13625-add_title_pos_to_matrix_plot-reviewed.patch


---

Comment by ppurka created at 2012-12-04 03:52:09

Apply to `devel/sage`


---

Attachment

reverted my change. sorry for the mess.

Patchbot apply trac_13625-new_option_title_pos.patch trac_13625-add_title_pos_to_matrix_plot-reviewed.patch


---

Comment by jdemeyer created at 2012-12-21 09:32:45

Resolution: fixed


---

Comment by kcrisman created at 2018-04-03 21:30:49

Just as FYI, https://github.com/matplotlib/matplotlib/issues/1415 might affect this.


---

Comment by ppurka created at 2018-04-07 07:00:06

Yes, may need to revisit the workaround done here.
