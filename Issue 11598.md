# Issue 11598: Add ability to detect CM number fields and take complex conjugate of their elements

Issue created by migration from https://trac.sagemath.org/ticket/11770

Original creator: robharron

Original creation time: 2011-09-01 13:52:29

Assignee: tba

Keywords: CM field

This ticket adds a function to the NumberField class that checks if self is a CM field, and adds a function to the NumberFieldElement class giving the ability to compute the complex conjugate of an element in a totally real or CM field.


---

Comment by robharron created at 2011-09-01 14:02:11

Changing status from new to needs_review.


---

Comment by fwclarke created at 2011-09-27 18:16:27

This is a useful enhancement which seems to work well.  I have one suggestion for improving the code and a few minor niggles.

It seems to me that rather than computing the conjugate of elements of a CM field by doing a separate calculation for each element, it would be better to define the conjugation automorphism of the field.  The following draft code seems to do the job:


```
    def conjugation(self):
        """
        Returns the conjugation automorphism for a CM field.
        """
        if self.is_absolute(): 
            K = self
        else:
            K = self.absolute_field('z')
        phi = [phi for F, phi, _ in K.subfields(K.degree()/2) if F.is_totally_real()][0]
        K_rel = K.relativize(phi, 'z')
        z0 = K_rel.gen()
        z0_conj = -z0 - K_rel.defining_polynomial()[1]
        z0_conj_abs = K_rel.structure()[0](z0_conj)
        if self.is_absolute(): 
            return End(self)([z0_conj_abs])
        else:
            return End(self)(K.hom([K.structure()[0](z0_conj_abs)]))
```

The above draft is, of course, lacking
 * doctests,
 * caching,
 * checking that `self` is  indeed a CM field, and 
 * dealing with the special cases of totally real, quadratic and  cyclotomic fields.  

If `conjugation` is defined, `conjugate` could be defined as:


```
    def conjugate(self):
        return self.parent().conjugation()(self)
```

A number of other, minor things:

In the docstring for `is_CM`


```
       The following is a non-cyclotomic CM field.
       
       ::
           
           sage: M.<a> = NumberField(x^4 - x^3 + x^2 - x + 1)
```

the wording is a bit misleading since `M` is (isomorphic to) a cyclotomic field.

The lines

```
           sage: P.<y> = PolynomialRing(E_0)
           sage: E.<b> = E_0.extension(P(y^2 + 1)) 
```

can be more simply written as

```
           sage: E.<b> = E_0.extension(x^2 + 1) 
```

Similarly for the `K.<j>` example in `conjugate`

In the code for `is_CM`, the lines

```
        try:
            return self.__is_CM
        except:
            pass
```

ought to be

```
        try:
            return self.__is_CM
        except Attribute_Error:
            pass
```

see  [Developer's Guide](http://www.sagemath.org/doc/developer/coding_in_python.html#exceptions).


---

Comment by fwclarke created at 2011-09-27 18:16:27

Changing status from needs_review to needs_work.


---

Comment by robharron created at 2012-08-19 01:32:02

Changing status from needs_work to needs_review.


---

Comment by robharron created at 2012-08-19 01:32:02

Thanks to Francis Clarke for the review and comments. It's a great idea to have the complex conjugation map, so I've set it up that way. Also new is that I added a function is_CM_extension to the relative number field case, as well as a function maximal_totally_real_subfield to the number field class.


---

Comment by robharron created at 2012-08-19 04:53:59

Version 2.1 of the patch fixes a problem in complex_conjugation where a number field was relativized with variable name 'a' (which raises an error when self has variable name 'a' as well). Oops! I didn't realize this would be a problem.


---

Comment by fwclarke created at 2012-08-24 14:44:21

Changing status from needs_review to needs_work.


---

Comment by fwclarke created at 2012-08-24 14:44:21

The problem with naming relativized extensions is, of course, a (minor) bug in `relativize`.  But it is probably best left for now.

The code looks good, and doctests pass.  

One or two little things (all except the first are really questions of style):

* The line break in lines 1933-34 of `number_field.py` introduces unwanted space (scroll across to see it):

```
sage:  NumberField(x^3 - 2, 'a').complex_conjugation()
Traceback (most recent call last)
...
ValueError: Complex conjugation is only well-defined for fields contained in CM                fields.
```


* At line 2038

```
        self.__max_tot_real_sub = self.subfield(zeta + zeta**(-1))
```

 is simpler, and quicker except in small cases.

* Lines 2052 to 2055 could more simply be replaced by

```
        for i in d.divisors()[1:]: 
```


* I personally find doctests such as

```
sage: Q.<a> = NumberField(x - 1)
sage: Q.is_CM() 
False 
sage: K.<i> = NumberField(x^2 + 1) 
sage: K.is_CM() 
True 
sage: L.<zeta20> = CyclotomicField(20) 
sage: L.is_CM() 
True 
```

 more readable as

```
sage: NumberField(x - 1, a).is_CM() 
False 
sage: NumberField(x^2 + 1, i).is_CM() 
True 
sage: CyclotomicField(20).is_CM() 
True 
```



---

Comment by robharron created at 2012-08-24 17:38:00

I fixed the first two issues as suggested (for the second issue, I used that because that's how conjugate *currently* computes its answer for cyclotomic fields, but you're right taking the inverse is *significantly* quicker for large N). For the third issue, I've amended the code (what I had done was quite silly...) to use the list of divisors sorted in reverse order. For the final issue, I actually find it more readable the way I did it. To each their own I guess!


---

Comment by robharron created at 2012-08-24 17:38:00

Changing status from needs_work to needs_review.


---

Comment by fwclarke created at 2012-08-24 19:21:39

Changing status from needs_review to positive_review.


---

Comment by fwclarke created at 2012-08-24 19:21:39

In great shape.  Positive review.


---

Attachment

Changed use of multiplicative_order in complex_conjugation as well!


---

Comment by robharron created at 2012-08-24 22:08:05

Oops! There was another use of zeta.multiplicative_order() in the complex_conjugation() function. I have now changed that in version 2.3. I don't know how to change this back to needs_review...


---

Comment by fwclarke created at 2012-08-25 10:29:02

Replying to [comment:9 robharron]:
> Oops! There was another use of zeta.multiplicative_order() in the complex_conjugation() function. I have now changed that in version 2.3. I don't know how to change this back to needs_review...

Yes, I should have spotted this.  The positive review can, of course, stay (I think the way to "needs review" is via "needs work").  But I've altered the description to refer to version 2.3.


---

Comment by robharron created at 2012-08-30 17:23:34

The patchbot appears to be attempting to apply not only v2.3 of the patch, but also the original patch from a year ago. Is there something that needs to be done about this?


---

Comment by fwclarke created at 2012-09-02 17:48:21

I've tried simplifying the directive in the description to put it in exactly the form specified in http://wiki.sagemath.org/buildbot  Perhaps this will work, but I worry about the statement there that "[a]ny subsequently added patches will be (semi-intelligently) appended to the list."


---

Comment by robharron created at 2012-09-02 18:12:44

apply trac_11770_CM_field_functionality_v2.3.patch


---

Comment by kini created at 2012-09-02 21:10:21

It didn't seem to work, for some reason...

Apply trac_11770_CM_field_functionality_v2.3.patch


---

Comment by kini created at 2012-09-02 21:10:48

OK, it's still not working. I'll try deleting the first patch and see if that fixes it.


---

Comment by kini created at 2012-09-02 21:11:37

That seems to have done it. Now to wait for a patchbot to see it :)


---

Comment by robharron created at 2012-09-03 05:32:51

Replying to [comment:16 kini]:
> That seems to have done it. Now to wait for a patchbot to see it :)

Looks like that fixed it! Thanks!


---

Comment by jdemeyer created at 2012-09-03 12:52:20

Resolution: fixed


---

Comment by jdemeyer created at 2012-09-21 09:20:53

My additional patch [attachment:11770_long_time.patch] needs review (just mention the review in the comments, don't change the status).


---

Comment by fwclarke created at 2012-09-24 12:46:10

Replying to [comment:19 jdemeyer]:
> My additional patch [attachment:11770_long_time.patch] needs review

I don't think this does the job.  The second example

```
        sage: d = a^253 
        sage: (d+d.conjugate()).is_real_positive() 
```

 will take just as long if the first one isn't executed.  It's only quicker after the first because conjugation has been cached.

But computation of the conjugation automorphism can be greatly speeded up by a minor change.  What's taking the time is the following step:

```
sage: %timeit K.hom([a^-1])
5 loops, best of 3: 29 s per loop
```

But checking can be turned off, since we know that this does define an automorphism.  Thus

```
sage: %timeit K.hom([a^-1], check=False)
125 loops, best of 3: 3.28 ms per loop
```

Several speed-ups of this kind occur in the patch to #10843 (still waiting a review).

So I conclude that the long-time patch is unnecessary, but that a minor change should be made in the new line 1926 of the definition of complex_conjugation.

 > (just mention the review in the comments, don't change the status).

I haven't changed the status, but I believe that "needs work" is where it should be.


---

Comment by jdemeyer created at 2012-09-24 18:31:38

Replying to [comment:23 fwclarke]:
> So I conclude that the long-time patch is unnecessary, but that a minor change should be made in the new line 1926 of the definition of complex_conjugation.
Could you make that change, since you obviously understand what's going on in this patch.


---

Comment by fwclarke created at 2012-09-25 10:51:52

Apply after trac_11770_CM_field_functionality_v2.3.patch


---

Attachment

Replying to [comment:24 jdemeyer]:
> Could you make that change, since you obviously understand what's going on in this patch.
New patch, to be applied after the main one, speeds things up considerably.


---

Comment by jdemeyer created at 2012-09-26 07:34:19

Re-opening this but with the intention of merging it back.


---

Comment by jdemeyer created at 2012-09-26 07:34:19

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-09-26 07:34:19

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-09-26 07:34:25

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-09-26 07:34:35

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-09-28 07:47:09

Resolution: fixed
