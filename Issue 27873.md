# Issue 27873: Bug in Hilbert series computation

archive/issues_027873.json:
```json
{
    "body": "Keywords: Hilbert polynomial\n\nAs reported on [sage devel](https://groups.google.com/forum/#!topic/sage-devel/_ThtY26ITmI), there appear to be errors in the current default algorithm for the computation of Hilbert series/polynomials:\n\n\n```\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial()\n....: \n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\n<ipython-input-1-8603fe52d058> in <module>()\n      1 P = PolynomialRing(QQ, names=('x', 'y', 'z',)); (x, y, z,) = P._first_ngens(3)\n      2 I = Ideal([x**Integer(3), x*y**Integer(2), y**Integer(4), x**Integer(2)*y*z, y**Integer(3)*z, x**Integer(2)*z**Integer(2), x*y*z**Integer(2), x*z**Integer(3)])\n----> 3 I.hilbert_polynomial()\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)\n    295         if not R.base_ring().is_field():\n    296             raise ValueError(\"Coefficient ring must be a field for function '%s'.\"%(self.f.__name__))\n--> 297         return self.f(self._instance, *args, **kwds)\n    298 \n    299 require_field = RequireField\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in hilbert_polynomial(self, algorithm)\n   2516             out = sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1))\n   2517                       for n,c in enumerate(second_hilbert)) + t.parent().zero()\n-> 2518             assert out.leading_coefficient() >= 0\n   2519             return out\n   2520         elif algorithm == 'singular':\n\nAssertionError: \n```\n\nSingular can solve this example.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28110\n\n",
    "created_at": "2019-07-03T20:08:58Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Bug in Hilbert series computation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27873",
    "user": "https://github.com/simon-king-jena"
}
```
Keywords: Hilbert polynomial

As reported on [sage devel](https://groups.google.com/forum/#!topic/sage-devel/_ThtY26ITmI), there appear to be errors in the current default algorithm for the computation of Hilbert series/polynomials:


```
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial()
....: 
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-1-8603fe52d058> in <module>()
      1 P = PolynomialRing(QQ, names=('x', 'y', 'z',)); (x, y, z,) = P._first_ngens(3)
      2 I = Ideal([x**Integer(3), x*y**Integer(2), y**Integer(4), x**Integer(2)*y*z, y**Integer(3)*z, x**Integer(2)*z**Integer(2), x*y*z**Integer(2), x*z**Integer(3)])
----> 3 I.hilbert_polynomial()

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)
    295         if not R.base_ring().is_field():
    296             raise ValueError("Coefficient ring must be a field for function '%s'."%(self.f.__name__))
--> 297         return self.f(self._instance, *args, **kwds)
    298 
    299 require_field = RequireField

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in hilbert_polynomial(self, algorithm)
   2516             out = sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1))
   2517                       for n,c in enumerate(second_hilbert)) + t.parent().zero()
-> 2518             assert out.leading_coefficient() >= 0
   2519             return out
   2520         elif algorithm == 'singular':

AssertionError: 
```

Singular can solve this example.

Issue created by migration from https://trac.sagemath.org/ticket/28110





---

archive/issue_comments_393248.json:
```json
{
    "body": "After removing the assertion, I get\n\n```\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial(algorithm='singular')\n....: \n3\nsage: P.<x,y,z> = PolynomialRing(QQ)\n....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])\n....: I.hilbert_polynomial()\n....: \n-3\n```\n\nSo, for a reason that I do not understand yet, there is a negative count.",
    "created_at": "2019-07-03T20:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393248",
    "user": "https://github.com/simon-king-jena"
}
```

After removing the assertion, I get

```
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial(algorithm='singular')
....: 
3
sage: P.<x,y,z> = PolynomialRing(QQ)
....: I = Ideal([x^3, x*y^2, y^4, x^2*y*z, y^3*z, x^2*z^2, x*y*z^2, x*z^3])
....: I.hilbert_polynomial()
....: 
-3
```

So, for a reason that I do not understand yet, there is a negative count.



---

archive/issue_comments_393249.json:
```json
{
    "body": "I think thats just because our numerator of the hilbert series is not normalized to be monic:\n\n```\nsage: P.ideal(x^2, x*y^2, y^2, z*x).hilbert_series()\n(t^3 - 2*t - 1)/(t - 1)\nsage: P.ideal(x^2, x*y^2, y^2).hilbert_series()\n(t^2 + 2*t + 1)/(-t + 1)\n```\n",
    "created_at": "2019-07-03T22:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393249",
    "user": "https://github.com/vbraun"
}
```

I think thats just because our numerator of the hilbert series is not normalized to be monic:

```
sage: P.ideal(x^2, x*y^2, y^2, z*x).hilbert_series()
(t^3 - 2*t - 1)/(t - 1)
sage: P.ideal(x^2, x*y^2, y^2).hilbert_series()
(t^2 + 2*t + 1)/(-t + 1)
```




---

archive/issue_comments_393250.json:
```json
{
    "body": "I made an attempt at fixing this. If I understand correctly, the Sage algorithm for computing the Hilbert polynomial is working by expanding out the Hilbert series. Past the term of index the Hilbert regularity, the expression for the coefficients becomes the Hilbert polynomial. It seems the line managing the combinatorics of this expansion\n\n`sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1)) for n,c in enumerate(second_hilbert))`\n\nis assuming the denominator of the series is of the form `(1 - t)^s`. I've added a check to ensure this is the case, scaling if needed. Note this issue was only a problem when the denominator of the series had odd degree.\n----\nNew commits:",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393250",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

I made an attempt at fixing this. If I understand correctly, the Sage algorithm for computing the Hilbert polynomial is working by expanding out the Hilbert series. Past the term of index the Hilbert regularity, the expression for the coefficients becomes the Hilbert polynomial. It seems the line managing the combinatorics of this expansion

`sum(c / denom * prod(s - 1 - n - nu + t for nu in range(s-1)) for n,c in enumerate(second_hilbert))`

is assuming the denominator of the series is of the form `(1 - t)^s`. I've added a check to ensure this is the case, scaling if needed. Note this issue was only a problem when the denominator of the series had odd degree.
----
New commits:



---

archive/issue_comments_393251.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-01T13:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393251",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_393252.json:
```json
{
    "body": "no space after `:trac:`",
    "created_at": "2019-08-01T15:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393252",
    "user": "https://github.com/fchapoton"
}
```

no space after `:trac:`



---

archive/issue_comments_393253.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-01T22:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393253",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393254.json:
```json
{
    "body": "ok, then",
    "created_at": "2019-08-02T07:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393254",
    "user": "https://github.com/fchapoton"
}
```

ok, then



---

archive/issue_comments_393255.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-02T07:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393255",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393256.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-04T07:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27873#issuecomment-393256",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069734.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-04T07:25:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27873",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27873#event-69734"
}
```
