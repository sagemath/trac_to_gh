# Issue 24142: Matplotlib on Python 2 bugs out when there are non-ASCII characters in user's home directory

Issue created by migration from https://trac.sagemath.org/ticket/24379

Original creator: embray

Original creation time: 2017-12-15 10:20:06

CC:  slelievre epalezzato

The `matplotlib/__init__.py` module contains `from __future__ import unicode_literals` which is often inadvisable, as it can run afoul of some of Python's own unicode bugs.

In particular at one point it calls `os.path.expanduser('~')`, where because of `unicode_literals` this becomes `os.path.expanduser(u'~')`.  This does not take care to decode the results of `os.environ['HOME']` (assuming it is ASCII), and ends up concatenating a unicode string with a non-unicode string, which means trying to first decoded the non-unicode string with the default (ASCII) encoding.

This is a bug in matplotlib but it affects Sage users, particularly on Windows where non-ASCII usernames are more common (may also affect OSX users): https://ask.sagemath.org/question/40131/sagemath-80-using-windows-installer


---

Comment by fbissey created at 2017-12-15 18:03:33

It looks like it is still present in the latest release (2.1.0), for which I have been working on an upgrade at #23696.

```
from __future__ import (absolute_import, division, print_function,
                        unicode_literals)
```



---

Comment by epalezzato created at 2018-06-29 14:12:21

This should be solved by upgrading to matplotlib 2.2.2 which has the upstream fix.


---

Comment by epalezzato created at 2018-06-29 14:12:21

Changing keywords from "" to "matplotlib, days94".


---

Comment by fbissey created at 2018-10-31 00:48:42

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-10-31 00:48:42

This is arguably fixed by #25702 (upgrade to MPL 2.2.2 with the fix).


---

Comment by embray created at 2018-10-31 12:07:09

Yep; IIRC this was fixed, thanks for the triaging.


---

Comment by embray created at 2018-10-31 12:07:09

Resolution: worksforme
