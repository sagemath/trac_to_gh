# Issue 22479: Faster Posets.SetPartitions()

Issue created by migration from Trac.

Original creator: jmantysalo

Original creation time: 2017-03-30 11:56:40

CC:  tscrim

I tried


```
n = 5

%timeit
L1 = Posets.SetPartitions(n)

%timeit
S = SetPartitions(n)
L = []
for s in S:
    L += [(s, b) for b in s.coarsenings()]
L2 = LatticePoset( ([], L) )

L1 == L2
```


and got


```
CPU time: 7.16 s,  Wall time: 7.16 s
CPU time: 1.45 s,  Wall time: 1.45 s
True
```



---

Comment by jmantysalo created at 2017-03-30 17:19:35

New commits:


---

Comment by jmantysalo created at 2017-03-30 17:19:35

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-03-30 17:53:49

Wouldn't it be better to explicitly build the cover relations by:

```sage
sage: def covers(x):
....:     SP = x.parent()
....:     for i,s in enumerate(x):
....:         for j in range(i+1, len(x)):
....:             L = list(x)
....:             L[i] = s.union(x[j])
....:             L.pop(j)
....:             yield SP(L)
....:             
sage: list(covers(x))
[{{1, 2, 5}, {3, 4}}, {{1, 3, 4}, {2, 5}}, {{1}, {2, 3, 4, 5}}]
```

That way you can use the `cover_relations=True` arg to `LatticePoset`.


---

Comment by git created at 2017-03-30 19:45:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-30 19:48:37

Replying to [comment:3 tscrim]:

> Wouldn't it be better to explicitly build the cover relations - -

Of course, but I was too lazy for that. `:=)`. Thanks. After this


```
sage: timeit("L = Posets.SetPartitions(4)")
5 loops, best of 3: 66.7 ms per loop
sage: timeit("L = Posets.SetPartitions(5)")
5 loops, best of 3: 304 ms per loop
```



---

Comment by tscrim created at 2017-03-30 19:54:00

You could just do

```
L = LatticePoset({x: list(covers(x)) for x in S}, cover_relations=True)
```

as this avoids extra processing on the poset (specifically the call to `transitive_reduction_acyclic`) and the extra conversion call. You can also replace `SP` by `S` in the internal function (and delete `SP = x.parent()`).


---

Comment by git created at 2017-03-31 04:15:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-31 04:16:31

As you wish. This does not make so big difference anymore:


```
sage: timeit("L = Posets.SetPartitions(4)")
5 loops, best of 3: 64 ms per loop
sage: timeit("L = Posets.SetPartitions(5)")
5 loops, best of 3: 298 ms per loop
```



---

Comment by tscrim created at 2017-03-31 14:19:18

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-03-31 14:19:18

But it does help a little bit. Thanks.


---

Comment by jmantysalo created at 2017-04-01 05:36:01

FYI: I went through other simple examples on the poset catalog, and found no other slow examples; that is, all other posets and lattices of size at least 100 were created in less than a second in our server.


---

Comment by vbraun created at 2017-04-05 19:37:41

Resolution: fixed
