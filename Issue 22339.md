# Issue 22339: Timeout when database_gap is installed

Issue created by migration from https://trac.sagemath.org/ticket/22576

Original creator: vdelecroix

Original creation time: 2017-03-10 15:44:41

CC:  embray slelievre

Keywords: bug, doctest, days84

The test suite of `src/sage/groups/perm_gps/permgroup_named.py` takes an infinite amount of time when the package `database_gap` is installed. Namely, the responsible doctest is

```
(line 1924):    TestSuite(TransitiveGroups()).run()
```

And it is blocked because of

```
sage: T = TransitiveGroups()
sage: T(T.an_element())     # hangs
```



---

Comment by SimonKing created at 2017-03-10 16:10:30

`T.an_element()` works. What doesn't work is creating an element of T from an element of T.

The traceback after <Ctrl-c> pointed me to these lines:

```
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py in _element_constructor_facade(self, el)
    575             return el
    576 
--> 577         for P in self._family:
    578             try:
    579                 return P(el)
```

sage: T._family
Lazy family (<lambda>(i))_{i in Non negative integers}
}}}

It is an infinite family - of course it hangs.

Obvious solution: First check whether the parent of the given element belongs to the family.  But alas, the element of T has no reasonable parent at all. I get the following rather strange sequence of lines:

```
sage: t = T.an_element()
sage: t.parent() in T._family
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-14-7530d2cfb513> in <module>()
----> 1 t.parent() in T._family

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__contains__ (/home/king/Sage/git/sage/src/build/cythonized/sage/structure/parent.c:10458)()
   1140             False
   1141         """
-> 1142         P = parent(x)
   1143         if P is self or P == self:
   1144             return True

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/structure/element.pxd in sage.structure.element.parent (/home/king/Sage/git/sage/src/build/cythonized/sage/structure/parent.c:28336)()
     71         return type(x)
     72     else:
---> 73         return p()
     74 
     75 

TypeError: descriptor 'parent' of 'sage.structure.sage_object.SageObject' object needs an argument
sage: t
Transitive group number 1 of degree 0
sage: t.parent()
<class 'sage.groups.perm_gps.permgroup_named.TransitiveGroup_with_category'>
```


No idea how to fix that, though.


---

Comment by dimpase created at 2017-03-10 16:54:08

I don't know what exactly `family` means in this context, and perhaps I talk nonsense, but shouldn't iteration through such things be handled by an `iterator` (and `yield`)?


---

Comment by tscrim created at 2017-03-11 03:01:04

So this comes from #22382, where we actually are now doing some validity checks. So when the family of sets in the union is infinite, we get the hanging behavior when an element is not in the set. We can reverse this behavior for this case, but that is a somewhat separate issue as in this case, the actual parent of the element in question is broken.


---

Comment by vdelecroix created at 2017-03-11 09:00:34

New commits:


---

Comment by git created at 2017-03-11 09:01:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-03-11 09:03:17

After disabling two tests I am able to run the doctests. However, `database_gap` seems to be broken (at least on my computer)

```
$ sage -f database_gap
$ sage -c "PrimitiveGroups(12).cardinality()"
verbose 0 (2474: permgroup_named.py, cardinality) Warning: PrimitiveGroups requires the GAP database package. Please install it with ``sage -i database_gap``.
```



---

Comment by dimpase created at 2017-03-11 09:18:13

this is caused by a stale GAP workspace. Do

```
sage -c "gap_reset_workspace()"
```


I suppose this will be fixed good and proper in #22570.


---

Comment by vdelecroix created at 2017-03-11 09:20:22

Indeed

```
$ sage -t --long --optional=sage,database_gap permgroup_named.py 
too few successful tests, not using stored timings
Running doctests with ID 2017-03-11-10-19-11-a1e57781.
Git branch: develop
Using --optional=database_gap,sage
Doctesting 1 file.
sage -t --long permgroup_named.py
    [445 tests, 3.90 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.0 seconds
    cpu time: 3.2 seconds
    cumulative wall time: 3.9 seconds
```



---

Comment by vdelecroix created at 2017-03-11 09:20:22

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-03-11 09:25:05

Don't we have `# known bug` tag for such broken doctests?


---

Comment by git created at 2017-03-11 09:28:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-03-11 09:28:27

We do


---

Comment by dimpase created at 2017-03-11 09:36:40

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-03-11 09:41:50

Thanks! I will reactivate `database_gap` on my patchbot as soon as it is merged.


---

Comment by jdemeyer created at 2017-03-11 12:58:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-03-11 12:58:35

I think the proper way to deal with `# known bug` is to open a new ticket to add `# known bug` and keep this ticket open for the real issue.


---

Comment by jdemeyer created at 2017-03-11 13:01:03

Besides, I'm not really following. Do I understand you correctly that the proper fix is simply to run `gap_reset_workspace()` whenever `database_gap` is installed? So it's unrelated to #22382 after all?


---

Comment by vdelecroix created at 2017-03-11 15:46:39

Replying to [comment:15 jdemeyer]:
> I think the proper way to deal with `# known bug` is to open a new ticket to add `# known bug` and keep this ticket open for the real issue.

#22583


---

Comment by vdelecroix created at 2017-03-11 15:47:49

Replying to [comment:16 jdemeyer]:
> Besides, I'm not really following. Do I understand you correctly that the proper fix is simply to run `gap_reset_workspace()` whenever `database_gap` is installed? So it's unrelated to #22382 after all?

You are not really understanding. This bug of this ticket is disjoint from the `gap_reset_workspace()` which has to do with [comment:7].


---

Comment by vdelecroix created at 2017-03-11 15:48:04

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2017-03-11 15:49:58

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2017-03-11 15:49:58

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-03-11 15:50:24

Replying to [comment:17 vdelecroix]:
> Replying to [comment:15 jdemeyer]:
> > I think the proper way to deal with `# known bug` is to open a new ticket to add `# known bug` and keep this ticket open for the real issue.
> 
> #22583

Better do it the other way around because all the discussion is happening here.


---

Comment by jdemeyer created at 2017-03-11 15:54:27

Replying to [comment:18 vdelecroix]:
> You are not really understanding.

Well, the comments were not clear either. It was not obvious to me that the "this" from [comment:8] was referring not the bug on this ticket.


---

Comment by dimpase created at 2017-03-12 22:21:27

OK, so we need to deal with `sage -c "gap_reset_workspace()"` issue. As Jeroen rightly says on #22570, this cannot be done by `spkg-install`, as it updates user-specific
stuff in `~/.sage/gap/`. 

What else can be done? I only see an option of `sage` checking
on startup whether  `sage -c "gap_reset_workspace()"` must be run.
Can we get away with only triggering it if a new Sage package was installed?
(otherwise this looks like a time-consuming check).

Docs on how to install GAP packages manually should also
indicate the need to run `sage -c "gap_reset_workspace()"` after
a GAP package is installed or removed.


---

Comment by slelievre created at 2019-07-01 01:48:50

Is this still a bug after `database_gap` has been merged partly into the `gap` and partly into the `gap_packages`  packages?


---

Comment by slelievre created at 2021-07-06 13:38:49

Replying to [comment:27 slelievre]:
> Is this still a bug after `database_gap` has been merged partly
> into the `gap` and partly into the `gap_packages` packages?

Answering my own question: yes, the following still hangs:

```
sage: T = TransitiveGroups()
sage: t = T.an_element()
sage: T(t)
```



---

Comment by slelievre created at 2021-07-06 13:38:49

Changing component from packages: optional to packages: standard.


---

Comment by tscrim created at 2021-07-07 01:35:27

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-07-07 01:35:27

Here is a fix. The issue is that `TransitiveGroups` claims to be a `Parent`, but it is not as it doesn't have proper elements. I just hacked around that by directly implementing a `__call__`. It has nothing to do with the GAP package.
----
New commits:


---

Comment by tscrim created at 2021-07-07 01:35:27

Changing component from packages: standard to group theory.


---

Comment by dimpase created at 2021-07-07 08:48:53

LGTM, thanks!


---

Comment by dimpase created at 2021-07-07 08:48:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-18 22:53:47

Resolution: fixed
