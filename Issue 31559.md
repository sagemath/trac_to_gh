# Issue 31559: Make maxima(<string>) output parseable

Issue created by migration from https://trac.sagemath.org/ticket/31796

Original creator: charpent

Original creation time: 2021-05-08 14:09:02

CC:  chapoton nbruin slelievre @spaghettisalat

Keywords: maxima symbolics

(See also this `sage-devel` [post](https://groups.google.com/g/sage-devel/c/U_WGbYG2zOE/m/gO3tZyVEAwAJ).)

Currently, all whitespace is stripped off `maxima(x)` and `maxima_calculus(x)` where `x` is a string. The same goes for Maxima code defined via the interfaces. To illustrate :


```
r1=maxima_calculus('foo: a and (b or c)')
r2=maxima_calculus('untree(x) := append([part(x, 0)], maplist(lambda([u], if atom(u) then u else untree(u)), x))')
r3=maxima_calculus('untree(foo)')
(r1, r2, r3)
```

outputs :

```
r1=maxima_calculus('foo: a and (b or c)')
r2=maxima_calculus('untree(x) := append([part(x, 0)], maplist(lambda([u], if atom(u) then u else untree(u)), x))')
r3=maxima_calculus('untree(foo)')
(r1, r2, r3)
```


This also deminstrates that the Maxima interpretation of the first instruction is correct ; it is its output which is ill-interpreted by Sage...

In order to maintain the `print(eval(read(x))==x` equality, it is desirable to keep spaces at least around boolean operators.


---

Comment by nbruin created at 2021-05-08 17:54:58

It actually looks like whitespace has been stripped right from the start from output in the maxima interface:
https://github.com/sagemath/sage/blob/e76b97fedaaec412fb4cce98bc55eb3d0ba2697f/src/sage/interfaces/maxima.py#L562
(the blame of that line goes back to original commits)

If I recall correctly, there were problems with maxima inserting spaces at unpredictable places every now and again; even in the middle of identifiers! The original commits would have been for maxima on CLISP rather than on ECL (although I recall the whitespace problem occurring on ECL (too?)). It could be that with the different iterations of "expect" -- and almost certainly in maxima_lib -- this isn't a problem anymore, but it means you'll have to test a *lot* in order to make really sure that a very old problem doesn't inadvertently comes back.

Also note that maxima_lib and maxima each have their own `_eval_line_` which does the stripping, so to keep the two interfaces in step, you'd want to change it in both.


---

Comment by charpent created at 2021-05-08 21:51:50

Replying to [comment:1 nbruin]:
> It actually looks like whitespace has been stripped right from the start from output in the maxima interface:
> https://github.com/sagemath/sage/blob/e76b97fedaaec412fb4cce98bc55eb3d0ba2697f/src/sage/interfaces/maxima.py#L562
> (the blame of that line goes back to original commits)
> 
> If I recall correctly, there were problems with maxima inserting spaces at unpredictable places every now and again;

This still happens, at least for MaximaElement pieces. To be explored in a followup ticket (but I'm afraid that this one is in Maxima's territory...). I've installed a workaround for this in `assumptions.py`

> even in the middle of identifiers!

This I didn't see (yet).

> The original commits would have been for maxima on CLISP rather than on ECL (although I recall the whitespace problem occurring on ECL (too?)). It could be that with the different iterations of "expect" -- and almost certainly in maxima_lib -- this isn't a problem anymore, but it means you'll have to test a *lot* in order to make really sure that a very old problem doesn't inadvertently comes back.

Advice gladly accepted for filing and solving a followup ticket, or to better test the proposed solution.

For the latter : what would you think of generating random SR expressions, translate them to Maxima strings, and check back-and-forth translations ? ISTR that such a random expression generator exists somewhere in Sage but, for the life of me, I'm unable to recall //where// I saw this...

> Also note that maxima_lib and maxima each have their own `_eval_line_` which does the stripping,

In different ways ==> two different fixes. No possible code sharing here without //major// restructuration.


> so to keep the two interfaces in step, you'd want to change it in both.

Done. You're welcome to review my branch, which passes `ptestlong` with exactly the same errors as `develop` at `9.3.rc5` (and therefore `needs_review`). And delivers parseable output for Maxima strings containing logical operators. Yay !
----
New commits:


---

Comment by charpent created at 2021-05-08 21:51:50

Changing status from new to needs_review.


---

Comment by charpent created at 2021-05-08 22:02:01

Note : `Lint` complains concern exclusively `trailing whitespace` (a couple occurrences in my patch) and `multiple statements on one line` (none in my patch).

Should I try and fix all these occurrences (at least as a public service) ? Or should this be a separate ticket ?


---

Comment by slelievre created at 2021-05-08 22:36:12

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2021-05-08 22:36:12

There seems to be a copy-paste mistake in the German
and Japanese `tour_algebra.rst`, with the `de2` block
replaced by the adapted `de1` block rather than by the
adapted `de2` block.


---

Comment by slelievre created at 2021-05-08 22:38:35

Please fill in author name so patchbots run.


---

Comment by git created at 2021-05-09 02:16:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2021-05-09 02:17:25

Replying to [comment:5 slelievre]:
> There seems to be a copy-paste mistake in the German
> and Japanese `tour_algebra.rst`, with the `de2` block
> replaced by the adapted `de1` block rather than by the
> adapted `de2` block.

Right. Damn...  Fixed.


---

Comment by charpent created at 2021-05-09 02:19:12

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2021-05-09 02:19:12

Replying to [comment:6 slelievre]:
> Please fill in author name so patchbots run.

Done. Thank you !


---

Comment by slelievre created at 2021-05-11 13:53:08

The patchbot's pyflakes plugin complains:


```
- src/sage/interfaces/maxima.py:498:1
  'sage.env.DOT_SAGE' imported but unused

- src/sage/interfaces/maxima.py:498:1
  'sage.env.SAGE_LOCAL' imported but unused

- src/sage/interfaces/maxima_abstract.py:997:9
  local variable 'a' is assigned to but never used

- src/sage/symbolic/expression_conversions.py:21:1
  'sage.symbolic.constants.I' imported but unused

- src/sage/symbolic/expression_conversions.py:1112:13
  redefinition of unused 'I' from line 21
```

Not sure what to make of those, especially the first two.

Someone with an expert opinion on those please chime in.


---

Comment by charpent created at 2021-05-11 16:40:15

Replying to [comment:11 slelievre]:
> The patchbot's pyflakes plugin complains:
> 
> {{{
> - src/sage/interfaces/maxima.py:498:1
>   'sage.env.DOT_SAGE' imported but unused
> 
> - src/sage/interfaces/maxima.py:498:1
>   'sage.env.SAGE_LOCAL' imported but unused


Indeed : neither `DOT_SAGE` nor `SAGE_LOCAL` appear anywhere in this file but on line 487, where they are imported from `sage.env`.

Residues of code past ?
 
>{{{
> - src/sage/interfaces/maxima_abstract.py:997:9
>   local variable 'a' is assigned to but never used}}}
> }}}
This one is right, but seems harmless. Was in the original code.

> {{{
> - src/sage/symbolic/expression_conversions.py:21:1
>   'sage.symbolic.constants.I' imported but unused
> 
> - src/sage/symbolic/expression_conversions.py:1112:13
>   redefinition of unused 'I' from line 21
> }}}
This one is hard to check. After hunting all capital `I` in the file :
* In live code, I find an import of I in `AlgebraicConverter.arithmetic`, line 1112 (as announced by `pyflakes`). 
* All the other uses are in examples/tests.

Past code residues, again ?

> Not sure what to make of those, especially the first two.
> 
> Someone with an expert opinion on those please chime in.

I'm interested, too.

But I can also make a new commit including the changes suggested by `pyflakes` (as well as deleting the "trailing whitespace" `relint` complains about so insistently, but not the semicolon uses `pycodestyle` hates...).

Advice ?


---

Comment by slelievre created at 2021-05-11 17:00:50

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-05-11 17:00:50

Let us get this in; pyflakes and relint
can be worked on in a follow-up ticket.


---

Comment by vbraun created at 2021-06-12 11:31:14

The ticket tests fine, but once you remove the `$DOT_SAGE/maxima_commandlist_cache.sobj` then tests fail with (this took quite a long time to track down):

```
sage -t --long --random-seed=0 src/sage/symbolic/maxima_wrapper.py
**********************************************************************
File "src/sage/symbolic/maxima_wrapper.py", line 81, in sage.symbolic.maxima_wrapper.MaximaWrapper.__getattr__
Failed example:
    s.completions('u.airy_',globals())
Expected:
    ['u.airy_ai', 'u.airy_bi', 'u.airy_dai', 'u.airy_dbi']
Got:
    ['u.airy_ai', 'u.airy_bi', 'u.airy_dbi']
**********************************************************************
1 item had failures:
   1 of   7 in sage.symbolic.maxima_wrapper.MaximaWrapper.__getattr__
    [30 tests, 1 failure, 1.40 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/maxima_wrapper.py  # 1 doctest failed
----------------------------------------------------------------------
```

How about we just version it as `maxima_commandlist_cache_v2.sobj`


---

Comment by vbraun created at 2021-06-12 11:31:25

Changing status from positive_review to needs_work.


---

Comment by nbruin created at 2021-06-12 17:28:15

How does versioning the command list help for this? It looks to be that there's a parsing problem that leads to `airy_dai` not being discovered as a valid function in maxima. Shouldn't the fix consist of fixing the parsing? I don't think we are shipping maxima_commandlist_cache, so sage should be able to build the cache reliable and correctly by itself.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-08-14 20:09:21

rebased on 9.4.rc2
----
New commits:


---

Comment by git created at 2021-08-14 20:19:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-08-14 20:58:46

`rm ~/.sage/maxima_commandlist_cache.sobj && ./sage -t --long --random-seed=0 src/sage/symbolic/maxima_wrapper.py` gives a different failure here:

```
File "src/sage/symbolic/maxima_wrapper.py", line 62, in sage.symbolic.maxima_wrapper.MaximaWrapper.__init__
Failed example:
    s.completions('u.elliptic_',globals())
Expected:
    ['u.elliptic_e', 'u.elliptic_ec', 'u.elliptic_eu', 'u.elliptic_f', 'u.elliptic_kc', 'u.elliptic_pi']
Got:
    ['u.elliptic_ec',
     'u.elliptic_eu',
     'u.elliptic_f',
     'u.elliptic_kc',
     'u.elliptic_pi']
```



---

Comment by git created at 2021-08-14 21:10:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-14 21:10:40

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-11-12 10:55:20

patchbot reports some trivial failing doctests in it tutorial


---

Comment by chapoton created at 2021-11-12 10:55:30

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-11-19 14:05:21

I have fixed the doctests in italian documentation
----
New commits:


---

Comment by chapoton created at 2021-11-19 14:05:21

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-11-20 07:04:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-11-24 07:54:21

ok, looks good. Patchbot is morally green.

I vote for positive review. Any confirmation from other reviewers or authors ?


---

Comment by charpent created at 2021-11-24 08:42:22

Replying to [comment:30 chapoton]:
> ok, looks good. Patchbot is morally green.

What means "morally" green ???

> I vote for positive review. Any confirmation from other reviewers or authors ?

Running `ptestlong` once more (just in case : this particular patch has already proven not-so-easy to integrate). Stay tuned...


---

Comment by charpent created at 2021-11-24 11:44:59

Replying to [comment:31 charpent]:
> Replying to [comment:30 chapoton]:
> > ok, looks good. Patchbot is morally green.
> 
> What means "morally" green ???
> 
> > I vote for positive review. Any confirmation from other reviewers or authors ?
> 
> Running `ptestlong` once more (just in case : this particular patch has already proven not-so-easy to integrate). Stay tuned...

On Debian testing running on core i7 + 16 GB RAM, running `ptestlong` on this patch added on top of 9.5.beta7 gives no new failure.

==> `positive_review` is OK for me. I set it, but feel free to unset if necessary.


---

Comment by charpent created at 2021-11-24 11:44:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-05 11:14:58

Resolution: fixed
