# Issue 32985: GH Actions: Create daily integration branch

Issue created by migration from https://trac.sagemath.org/ticket/33222

Original creator: mkoeppe

Original creation time: 2022-01-23 19:59:36

CC:  vbraun dimpase

We create a GH Actions workflow, run daily on `sagetrac-mirror` (
https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule):

1. Start from current release tag, use the corresponding Docker image on gchr.io from a stable platform such as `ubuntu-focal-standard` 

2. Pick mergeable Trac tickets from the current milestone, order by priority/deps

3.  Merge one by one and push to branch "$RELEASE_TAG+integration-$DATE", if it passes doctests + doc-pdf.
  - Report failures as comment / status change on the Trac ticket.


---

Comment by mkoeppe created at 2022-01-23 20:05:16

Volker, would you be willing to share your existing scripts that probably already implement something like step 2 above? It does not have to be pretty.


---

Comment by vbraun created at 2022-01-23 20:16:14

Scripts are part of https://github.com/sagemath/git-trac-command:

```
$ git releasemgr merge-all -h
usage: git-releasemgr merge-all [-h] [--limit LIMIT]

optional arguments:
  -h, --help     show this help message and exit
  --limit LIMIT  Merge this many tickets
```



---

Comment by mkoeppe created at 2022-01-23 20:25:45

Thanks for the pointer


---

Comment by git created at 2022-01-25 17:38:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-26 20:08:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-27 05:21:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-27 06:27:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-27 17:15:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-28 05:36:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-28 18:34:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-28 20:56:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-29 01:09:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-29 22:14:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-29 22:15:16

https://github.com/mkoeppe/sage/runs/4993397402?check_suite_focus=true

```
#5 importing cache manifest from docker.pkg.github.com/mkoeppe/sage/sage-docker-ubuntu-focal-recommended-with-targets
#5 sha256:c3f8749b6884f89e52d82a7beb83dd3938671c5e8c91d13592abcfa40146f0ad
#5 ERROR: unexpected status code [manifests latest]: 401 Unauthorized
```

This may be the same as https://github.com/docker/buildx/issues/780


---

Comment by git created at 2022-01-29 22:28:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-30 02:44:52

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-30 07:44:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-30 17:18:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-30 17:18:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-30 18:07:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-30 21:59:55

Changing status from new to needs_review.


---

Comment by git created at 2022-01-31 00:57:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-31 06:25:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-31 18:04:31

With ptestlong it exceeds the 6 hours, so I'll have to split out another job


---

Comment by mkoeppe created at 2022-01-31 18:04:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-01 00:48:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-01 16:13:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-02 19:24:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-03 17:46:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-04 04:45:01

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-04 22:55:44

Uff that's quite complicated. Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?

Instead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job). Makes things easier and I assume github also takes care of the permission handling.

Also the `integration` job is currently timing out, and if I read the logs correctly then it is actually not merging the tickets for the new milestone (but tries to merge tickets for the already finished milestone 9.5): `No tickets for milestone sage-9.5 are ready to be merged`.

Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around, like the "free space" or "login to ghcr" parts (which shouldn't be necessary in the final `integration` job because that's only reading, right?).


---

Comment by mkoeppe created at 2022-02-04 23:23:32

Replying to [comment:59 gh-tobiasdiez]:
> Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around

Refactoring will not happen in this ticket


---

Comment by mkoeppe created at 2022-02-04 23:31:23

Replying to [comment:59 gh-tobiasdiez]:
> Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?

I need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.

> Instead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job).

I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.


---

Comment by mkoeppe created at 2022-02-04 23:33:43

Replying to [comment:59 gh-tobiasdiez]:
> Also the `integration` job is currently timing out

Yes, there's still something going wrong with the caching, so it's rebuilding something that it should have taken from the previous job


---

Comment by mkoeppe created at 2022-02-04 23:33:43

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-04 23:35:01

Replying to [comment:59 gh-tobiasdiez]:
> "login to ghcr" parts [...] shouldn't be necessary in the final `integration` job because that's only reading, right?

Actually one does need to login even just for reading packages.


---

Comment by mkoeppe created at 2022-02-04 23:36:35

(And the last step does push something - the image with the included repository.)


---

Comment by @tobiasdiez created at 2022-02-04 23:45:32

Replying to [comment:60 mkoeppe]:
> Replying to [comment:59 gh-tobiasdiez]:
> > Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around
> 
> Refactoring will not happen in this ticket

I didn't meant you should refactor the existing workflows. But if you want to reuse some steps in the newly created workflow than they should be extracted to a new action (instead of copy&paste them). Refactoring the other workflows to use this new action can be done later.
(You wouldn't also let python code pass that copy&pastes some methods around, right?)


---

Comment by @tobiasdiez created at 2022-02-04 23:47:21

Replying to [comment:61 mkoeppe]:
> Replying to [comment:59 gh-tobiasdiez]:
> > Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?
> 
> I need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.

If it's so important, why not add it as a new target to the existing CI?


---

Comment by @tobiasdiez created at 2022-02-04 23:57:51

Replying to [comment:61 mkoeppe]:
> I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> 

Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like). Also you can just execute the github workflow locally using `act` if you like.

Also, are you aware that there are special actions for the login and publish, which make the whole process way easier (and we don't need to maintain them)? https://docs.github.com/en/actions/publishing-packages/publishing-docker-images#publishing-images-to-github-packages


---

Comment by mkoeppe created at 2022-02-04 23:59:06

Replying to [comment:66 gh-tobiasdiez]:
> Replying to [comment:61 mkoeppe]:
> > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> 
> If it's so important, why not add it as a new target to the existing CI?

Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!

Can't change everything at the same time.


---

Comment by mkoeppe created at 2022-02-05 00:01:04

Replying to [comment:67 gh-tobiasdiez]:
> Replying to [comment:61 mkoeppe]:
> > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> 
> Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).

The build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.

> Also you can just execute the github workflow locally using `act` if you like.

I don't like


---

Comment by mkoeppe created at 2022-02-05 00:05:53

Replying to [comment:67 gh-tobiasdiez]:
> Also, are you aware that there are special actions for the login and publish

Yes, but they don't help much. The login action could replace these 5 lines:

```
            TOKEN="${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}"
            if [ -z "$TOKEN" ]; then
              TOKEN="${{ secrets.GITHUB_TOKEN }}"
            fi
            if echo "$TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
```

And the other one is not useful


---

Comment by @tobiasdiez created at 2022-02-05 00:06:28

Replying to [comment:68 mkoeppe]:
> Replying to [comment:66 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> > 
> > If it's so important, why not add it as a new target to the existing CI?
> 
> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!
> 
> Can't change everything at the same time.

Okay, makes sense. Thanks for the explanation.


---

Comment by @tobiasdiez created at 2022-02-05 00:09:23

Replying to [comment:69 mkoeppe]:
> Replying to [comment:67 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> > 
> > Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).
> 
> The build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.

But the push happens before the final "Build & test integration head", so it neither contains the test results nor the build, or I'm missing something?


---

Comment by mkoeppe created at 2022-02-05 00:15:39

Yes, that's true as it is in the current branch - but that final step can be extended to also build; just not done yet


---

Comment by @tobiasdiez created at 2022-02-05 00:17:16

Replying to [comment:70 mkoeppe]:
> Replying to [comment:67 gh-tobiasdiez]:
> > Also, are you aware that there are special actions for the login and publish
> 
> Yes, but they don't help much. The login action could replace these 5 lines:
> {{{
>             TOKEN="${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}"
>             if [ -z "$TOKEN" ]; then
>               TOKEN="${{ secrets.GITHUB_TOKEN }}"
>             fi
>             if echo "$TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
> }}}

Yes, the `docker/login-action` is not doing much more: https://github.com/docker/login-action/blob/17f28ab24d0d2832d5ff23a1409bbfc373ebcb96/src/docker.ts#L30-L50 Except a bit of proper error handling and logging you out again. Anyway, why not reuse something official so that you don't have to worry about it?


---

Comment by mkoeppe created at 2022-02-05 00:24:20

Because of the lines that follow `if`.


---

Comment by @tobiasdiez created at 2022-02-05 00:26:52

I guess it's getting late here for me, but your messages get more and more cryptic. There are a lot of ifs here...


---

Comment by mkoeppe created at 2022-02-05 00:54:55

Sorry, I meant the last `if` but it also applies to the first `if` ;)


---

Comment by dimpase created at 2022-02-05 04:57:44

Replying to [comment:69 mkoeppe]:

> > Also you can just execute the github workflow locally using `act` if you like.

wow, I never knew about `act` (guess it's https://github.com/nektos/act)

It should be in our developer manual.


---

Comment by @tobiasdiez created at 2022-02-05 08:48:26

Replying to [comment:78 dimpase]:
> Replying to [comment:69 mkoeppe]:
> 
> > > Also you can just execute the github workflow locally using `act` if you like.
> 
> wow, I never knew about `act` (guess it's https://github.com/nektos/act)
> 

Yes, that's the one (should have directly provided a link, sry). It's quite powerful and usually works really well. Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.


---

Comment by @tobiasdiez created at 2022-02-05 08:51:15

Replying to [comment:77 mkoeppe]:
> Sorry, I meant the last `if` but it also applies to the first `if` ;)

Even after sleep I don't understand your comment. The second if doesn't do anything in my opinion since the Github token is always there and we need to login to ghcr as you said earlier.
For the first if, this should be `password = ${{ secrets.DOCKER_PKG_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}` with the docker/login-action


---

Comment by @tobiasdiez created at 2022-02-05 09:02:04

Replying to [comment:68 mkoeppe]:
> Replying to [comment:66 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> > 
> > If it's so important, why not add it as a new target to the existing CI?
> 
> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future.


Thinking about this again: would it be an idea to run the integration workflow as follows:
- use the docker image build during the ci for the develop branch
- merge all new tickets
- re-build sage, including the packages that are needed for `doc-pdf`
- run tests (using the ci artifact as baseline)
- build docs

Not sure how long the last step takes, but step 4 should finish in 30-60 mins (depending on how much packages are touched in the to-be-merged tickets) and step 5 about 1h. So this should all fit very nicely in one workflow. So the main advantage would be that you don't have to rebuild all packages from scratch during the integration workflow.

This is under the assumption that the packages needed for the pdf build of the documentation don't influence the tests, because otherwise the test-baseline could be wrong (but is probably still good enough).


---

Comment by vbraun created at 2022-02-05 15:07:26

Just FYI, I'm planning on adding a CI step that runs for each ticket at #33294. Sufficiently different from this ticket that both have merits, just a heads up.


---

Comment by mkoeppe created at 2022-02-05 16:00:35

Replying to [comment:79 gh-tobiasdiez]:
> Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.

With a lot of patience!


---

Comment by mkoeppe created at 2022-02-05 19:19:28

Replying to [comment:81 gh-tobiasdiez]:
> - re-build sage, including the packages that are needed for `doc-pdf`

these are system packages, not sage packages


---

Comment by mkoeppe created at 2022-02-05 19:25:00

Replying to [comment:68 mkoeppe]:
> changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. 

Preparation for that is now in #33296


---

Comment by @tobiasdiez created at 2022-02-17 16:12:42

Mainly to better understand the process behind the scenes, why is an additional "integration" branch necessary? Can one not simply push to "develop" (in case there are no errors)? I guess this comes down to the question "what does the release manager has to do in the background that demands a manual merge into the develop branch".
