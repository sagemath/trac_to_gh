# Issue 32985: GH Actions: Create daily integration branch

archive/issues_032985.json:
```json
{
    "body": "CC:  @vbraun @dimpase\n\nWe create a GH Actions workflow, run daily on `sagetrac-mirror` (\nhttps://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule):\n\n1. Start from current release tag, use the corresponding Docker image on gchr.io from a stable platform such as `ubuntu-focal-standard` \n\n2. Pick mergeable Trac tickets from the current milestone, order by priority/deps\n\n3.  Merge one by one and push to branch \"$RELEASE_TAG+integration-$DATE\", if it passes doctests + doc-pdf.\n   - Report failures as comment / status change on the Trac ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33222\n\n",
    "created_at": "2022-01-23T19:59:36Z",
    "labels": [
        "distribution",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "GH Actions: Create daily integration branch",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32985",
    "user": "@mkoeppe"
}
```
CC:  @vbraun @dimpase

We create a GH Actions workflow, run daily on `sagetrac-mirror` (
https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule):

1. Start from current release tag, use the corresponding Docker image on gchr.io from a stable platform such as `ubuntu-focal-standard` 

2. Pick mergeable Trac tickets from the current milestone, order by priority/deps

3.  Merge one by one and push to branch "$RELEASE_TAG+integration-$DATE", if it passes doctests + doc-pdf.
   - Report failures as comment / status change on the Trac ticket.

Issue created by migration from https://trac.sagemath.org/ticket/33222





---

archive/issue_comments_470397.json:
```json
{
    "body": "Volker, would you be willing to share your existing scripts that probably already implement something like step 2 above? It does not have to be pretty.",
    "created_at": "2022-01-23T20:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470397",
    "user": "@mkoeppe"
}
```

Volker, would you be willing to share your existing scripts that probably already implement something like step 2 above? It does not have to be pretty.



---

archive/issue_comments_470398.json:
```json
{
    "body": "Scripts are part of https://github.com/sagemath/git-trac-command:\n\n```\n$ git releasemgr merge-all -h\nusage: git-releasemgr merge-all [-h] [--limit LIMIT]\n\noptional arguments:\n  -h, --help     show this help message and exit\n  --limit LIMIT  Merge this many tickets\n```\n",
    "created_at": "2022-01-23T20:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470398",
    "user": "@vbraun"
}
```

Scripts are part of https://github.com/sagemath/git-trac-command:

```
$ git releasemgr merge-all -h
usage: git-releasemgr merge-all [-h] [--limit LIMIT]

optional arguments:
  -h, --help     show this help message and exit
  --limit LIMIT  Merge this many tickets
```




---

archive/issue_comments_470399.json:
```json
{
    "body": "Thanks for the pointer",
    "created_at": "2022-01-23T20:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470399",
    "user": "@mkoeppe"
}
```

Thanks for the pointer



---

archive/issue_comments_470400.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-25T17:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470400",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_470401.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-26T20:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470401",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_470402.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-27T05:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470402",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470403.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-27T06:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470403",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470404.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-27T17:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470404",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470405.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-28T05:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470405",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470406.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-28T18:34:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470406",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470407.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-28T20:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470407",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470408.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-29T01:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470408",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470409.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-29T22:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470409",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470410.json:
```json
{
    "body": "https://github.com/mkoeppe/sage/runs/4993397402?check_suite_focus=true\n\n```\n#5 importing cache manifest from docker.pkg.github.com/mkoeppe/sage/sage-docker-ubuntu-focal-recommended-with-targets\n#5 sha256:c3f8749b6884f89e52d82a7beb83dd3938671c5e8c91d13592abcfa40146f0ad\n#5 ERROR: unexpected status code [manifests latest]: 401 Unauthorized\n```\n\nThis may be the same as https://github.com/docker/buildx/issues/780",
    "created_at": "2022-01-29T22:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470410",
    "user": "@mkoeppe"
}
```

https://github.com/mkoeppe/sage/runs/4993397402?check_suite_focus=true

```
#5 importing cache manifest from docker.pkg.github.com/mkoeppe/sage/sage-docker-ubuntu-focal-recommended-with-targets
#5 sha256:c3f8749b6884f89e52d82a7beb83dd3938671c5e8c91d13592abcfa40146f0ad
#5 ERROR: unexpected status code [manifests latest]: 401 Unauthorized
```

This may be the same as https://github.com/docker/buildx/issues/780



---

archive/issue_comments_470411.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-29T22:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470411",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470412.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-01-30T02:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470412",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_470413.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-30T07:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470413",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470414.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-30T17:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470414",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470415.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-30T17:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470415",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470416.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-30T18:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470416",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470417.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-30T21:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470417",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470418.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-31T00:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470418",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-31T06:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470419",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470420.json:
```json
{
    "body": "With ptestlong it exceeds the 6 hours, so I'll have to split out another job",
    "created_at": "2022-01-31T18:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470420",
    "user": "@mkoeppe"
}
```

With ptestlong it exceeds the 6 hours, so I'll have to split out another job



---

archive/issue_comments_470421.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-31T18:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470421",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470422.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-01T00:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470422",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470423.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-01T16:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470423",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470424.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-02T19:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470424",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470425.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-03T17:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470425",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470426.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-04T04:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470426",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470427.json:
```json
{
    "body": "Uff that's quite complicated. Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?\n\nInstead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job). Makes things easier and I assume github also takes care of the permission handling.\n\nAlso the `integration` job is currently timing out, and if I read the logs correctly then it is actually not merging the tickets for the new milestone (but tries to merge tickets for the already finished milestone 9.5): `No tickets for milestone sage-9.5 are ready to be merged`.\n\nFinally a general remark: please use the new reusable actions instead of copy&pasting stuff around, like the \"free space\" or \"login to ghcr\" parts (which shouldn't be necessary in the final `integration` job because that's only reading, right?).",
    "created_at": "2022-02-04T22:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470427",
    "user": "@tobiasdiez"
}
```

Uff that's quite complicated. Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?

Instead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job). Makes things easier and I assume github also takes care of the permission handling.

Also the `integration` job is currently timing out, and if I read the logs correctly then it is actually not merging the tickets for the new milestone (but tries to merge tickets for the already finished milestone 9.5): `No tickets for milestone sage-9.5 are ready to be merged`.

Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around, like the "free space" or "login to ghcr" parts (which shouldn't be necessary in the final `integration` job because that's only reading, right?).



---

archive/issue_comments_470428.json:
```json
{
    "body": "Replying to [comment:59 gh-tobiasdiez]:\n> Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around\n\nRefactoring will not happen in this ticket",
    "created_at": "2022-02-04T23:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470428",
    "user": "@mkoeppe"
}
```

Replying to [comment:59 gh-tobiasdiez]:
> Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around

Refactoring will not happen in this ticket



---

archive/issue_comments_470429.json:
```json
{
    "body": "Replying to [comment:59 gh-tobiasdiez]:\n> Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?\n\nI need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.\n\n> Instead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job).\n\nI am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.",
    "created_at": "2022-02-04T23:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470429",
    "user": "@mkoeppe"
}
```

Replying to [comment:59 gh-tobiasdiez]:
> Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?

I need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.

> Instead of manually handling the docker pull (using cli commands) I would propose to use the `container` tag for the workflow (or job).

I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.



---

archive/issue_comments_470430.json:
```json
{
    "body": "Replying to [comment:59 gh-tobiasdiez]:\n> Also the `integration` job is currently timing out\n\nYes, there's still something going wrong with the caching, so it's rebuilding something that it should have taken from the previous job",
    "created_at": "2022-02-04T23:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470430",
    "user": "@mkoeppe"
}
```

Replying to [comment:59 gh-tobiasdiez]:
> Also the `integration` job is currently timing out

Yes, there's still something going wrong with the caching, so it's rebuilding something that it should have taken from the previous job



---

archive/issue_comments_470431.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-04T23:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470431",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470432.json:
```json
{
    "body": "Replying to [comment:59 gh-tobiasdiez]:\n> \"login to ghcr\" parts [...] shouldn't be necessary in the final `integration` job because that's only reading, right?\n\nActually one does need to login even just for reading packages.",
    "created_at": "2022-02-04T23:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470432",
    "user": "@mkoeppe"
}
```

Replying to [comment:59 gh-tobiasdiez]:
> "login to ghcr" parts [...] shouldn't be necessary in the final `integration` job because that's only reading, right?

Actually one does need to login even just for reading packages.



---

archive/issue_comments_470433.json:
```json
{
    "body": "(And the last step does push something - the image with the included repository.)",
    "created_at": "2022-02-04T23:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470433",
    "user": "@mkoeppe"
}
```

(And the last step does push something - the image with the included repository.)



---

archive/issue_comments_470434.json:
```json
{
    "body": "Replying to [comment:60 mkoeppe]:\n> Replying to [comment:59 gh-tobiasdiez]:\n> > Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around\n> \n> Refactoring will not happen in this ticket\n\nI didn't meant you should refactor the existing workflows. But if you want to reuse some steps in the newly created workflow than they should be extracted to a new action (instead of copy&paste them). Refactoring the other workflows to use this new action can be done later.\n(You wouldn't also let python code pass that copy&pastes some methods around, right?)",
    "created_at": "2022-02-04T23:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470434",
    "user": "@tobiasdiez"
}
```

Replying to [comment:60 mkoeppe]:
> Replying to [comment:59 gh-tobiasdiez]:
> > Finally a general remark: please use the new reusable actions instead of copy&pasting stuff around
> 
> Refactoring will not happen in this ticket

I didn't meant you should refactor the existing workflows. But if you want to reuse some steps in the newly created workflow than they should be extracted to a new action (instead of copy&paste them). Refactoring the other workflows to use this new action can be done later.
(You wouldn't also let python code pass that copy&pastes some methods around, right?)



---

archive/issue_comments_470435.json:
```json
{
    "body": "Replying to [comment:61 mkoeppe]:\n> Replying to [comment:59 gh-tobiasdiez]:\n> > Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?\n> \n> I need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.\n\nIf it's so important, why not add it as a new target to the existing CI?",
    "created_at": "2022-02-04T23:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470435",
    "user": "@tobiasdiez"
}
```

Replying to [comment:61 mkoeppe]:
> Replying to [comment:59 gh-tobiasdiez]:
> > Why do you first need to create a new baseline image for the integration tests and not reuse the docker image build during the latest push to the develop branch?
> 
> I need an image with more packages, which is not built by the CI. This is to run `make doc-pdf`, an essential step that currently no CI is testing.

If it's so important, why not add it as a new target to the existing CI?



---

archive/issue_comments_470436.json:
```json
{
    "body": "Replying to [comment:61 mkoeppe]:\n> I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.\n> \n\nCan you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like). Also you can just execute the github workflow locally using `act` if you like.\n\nAlso, are you aware that there are special actions for the login and publish, which make the whole process way easier (and we don't need to maintain them)? https://docs.github.com/en/actions/publishing-packages/publishing-docker-images#publishing-images-to-github-packages",
    "created_at": "2022-02-04T23:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470436",
    "user": "@tobiasdiez"
}
```

Replying to [comment:61 mkoeppe]:
> I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> 

Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like). Also you can just execute the github workflow locally using `act` if you like.

Also, are you aware that there are special actions for the login and publish, which make the whole process way easier (and we don't need to maintain them)? https://docs.github.com/en/actions/publishing-packages/publishing-docker-images#publishing-images-to-github-packages



---

archive/issue_comments_470437.json:
```json
{
    "body": "Replying to [comment:66 gh-tobiasdiez]:\n> Replying to [comment:61 mkoeppe]:\n> > This is to run `make doc-pdf`, an essential step that currently no CI is testing.\n> \n> If it's so important, why not add it as a new target to the existing CI?\n\nYes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!\n\nCan't change everything at the same time.",
    "created_at": "2022-02-04T23:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470437",
    "user": "@mkoeppe"
}
```

Replying to [comment:66 gh-tobiasdiez]:
> Replying to [comment:61 mkoeppe]:
> > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> 
> If it's so important, why not add it as a new target to the existing CI?

Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!

Can't change everything at the same time.



---

archive/issue_comments_470438.json:
```json
{
    "body": "Replying to [comment:67 gh-tobiasdiez]:\n> Replying to [comment:61 mkoeppe]:\n> > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.\n> \n> Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).\n\nThe build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.\n\n> Also you can just execute the github workflow locally using `act` if you like.\n\nI don't like",
    "created_at": "2022-02-05T00:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470438",
    "user": "@mkoeppe"
}
```

Replying to [comment:67 gh-tobiasdiez]:
> Replying to [comment:61 mkoeppe]:
> > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> 
> Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).

The build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.

> Also you can just execute the github workflow locally using `act` if you like.

I don't like



---

archive/issue_comments_470439.json:
```json
{
    "body": "Replying to [comment:67 gh-tobiasdiez]:\n> Also, are you aware that there are special actions for the login and publish\n\nYes, but they don't help much. The login action could replace these 5 lines:\n\n```\n            TOKEN=\"${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}\"\n            if [ -z \"$TOKEN\" ]; then\n              TOKEN=\"${{ secrets.GITHUB_TOKEN }}\"\n            fi\n            if echo \"$TOKEN\" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then\n```\n\nAnd the other one is not useful",
    "created_at": "2022-02-05T00:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470439",
    "user": "@mkoeppe"
}
```

Replying to [comment:67 gh-tobiasdiez]:
> Also, are you aware that there are special actions for the login and publish

Yes, but they don't help much. The login action could replace these 5 lines:

```
            TOKEN="${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}"
            if [ -z "$TOKEN" ]; then
              TOKEN="${{ secrets.GITHUB_TOKEN }}"
            fi
            if echo "$TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
```

And the other one is not useful



---

archive/issue_comments_470440.json:
```json
{
    "body": "Replying to [comment:68 mkoeppe]:\n> Replying to [comment:66 gh-tobiasdiez]:\n> > Replying to [comment:61 mkoeppe]:\n> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.\n> > \n> > If it's so important, why not add it as a new target to the existing CI?\n> \n> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!\n> \n> Can't change everything at the same time.\n\nOkay, makes sense. Thanks for the explanation.",
    "created_at": "2022-02-05T00:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470440",
    "user": "@tobiasdiez"
}
```

Replying to [comment:68 mkoeppe]:
> Replying to [comment:66 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> > 
> > If it's so important, why not add it as a new target to the existing CI?
> 
> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. But this will need #33062 (split the workflow, with caching of Docker layers). That's exactly what the changes to tox.ini here on the ticket are implementing!
> 
> Can't change everything at the same time.

Okay, makes sense. Thanks for the explanation.



---

archive/issue_comments_470441.json:
```json
{
    "body": "Replying to [comment:69 mkoeppe]:\n> Replying to [comment:67 gh-tobiasdiez]:\n> > Replying to [comment:61 mkoeppe]:\n> > > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.\n> > \n> > Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).\n> \n> The build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.\n\nBut the push happens before the final \"Build & test integration head\", so it neither contains the test results nor the build, or I'm missing something?",
    "created_at": "2022-02-05T00:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470441",
    "user": "@tobiasdiez"
}
```

Replying to [comment:69 mkoeppe]:
> Replying to [comment:67 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > I am deliberately setting this up as an image build, not just a container run, because I want to create a Docker image that can be pulled for local inspection.
> > 
> > Can you expand on why this should be helpful, i.e. where are the advantages over just checking out the branch in your local git (and maybe running it in the baseline-integration docker image if you like).
> 
> The build & test can take long. If it is prebuilt on GH Actions and I can download it for inspection, that's a benefit.

But the push happens before the final "Build & test integration head", so it neither contains the test results nor the build, or I'm missing something?



---

archive/issue_comments_470442.json:
```json
{
    "body": "Yes, that's true as it is in the current branch - but that final step can be extended to also build; just not done yet",
    "created_at": "2022-02-05T00:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470442",
    "user": "@mkoeppe"
}
```

Yes, that's true as it is in the current branch - but that final step can be extended to also build; just not done yet



---

archive/issue_comments_470443.json:
```json
{
    "body": "Replying to [comment:70 mkoeppe]:\n> Replying to [comment:67 gh-tobiasdiez]:\n> > Also, are you aware that there are special actions for the login and publish\n> \n> Yes, but they don't help much. The login action could replace these 5 lines:\n> {{{\n>             TOKEN=\"${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}\"\n>             if [ -z \"$TOKEN\" ]; then\n>               TOKEN=\"${{ secrets.GITHUB_TOKEN }}\"\n>             fi\n>             if echo \"$TOKEN\" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then\n> }}}\n\nYes, the `docker/login-action` is not doing much more: https://github.com/docker/login-action/blob/17f28ab24d0d2832d5ff23a1409bbfc373ebcb96/src/docker.ts#L30-L50 Except a bit of proper error handling and logging you out again. Anyway, why not reuse something official so that you don't have to worry about it?",
    "created_at": "2022-02-05T00:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470443",
    "user": "@tobiasdiez"
}
```

Replying to [comment:70 mkoeppe]:
> Replying to [comment:67 gh-tobiasdiez]:
> > Also, are you aware that there are special actions for the login and publish
> 
> Yes, but they don't help much. The login action could replace these 5 lines:
> {{{
>             TOKEN="${{ secrets.DOCKER_PKG_GITHUB_TOKEN }}"
>             if [ -z "$TOKEN" ]; then
>               TOKEN="${{ secrets.GITHUB_TOKEN }}"
>             fi
>             if echo "$TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
> }}}

Yes, the `docker/login-action` is not doing much more: https://github.com/docker/login-action/blob/17f28ab24d0d2832d5ff23a1409bbfc373ebcb96/src/docker.ts#L30-L50 Except a bit of proper error handling and logging you out again. Anyway, why not reuse something official so that you don't have to worry about it?



---

archive/issue_comments_470444.json:
```json
{
    "body": "Because of the lines that follow `if`.",
    "created_at": "2022-02-05T00:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470444",
    "user": "@mkoeppe"
}
```

Because of the lines that follow `if`.



---

archive/issue_comments_470445.json:
```json
{
    "body": "I guess it's getting late here for me, but your messages get more and more cryptic. There are a lot of ifs here...",
    "created_at": "2022-02-05T00:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470445",
    "user": "@tobiasdiez"
}
```

I guess it's getting late here for me, but your messages get more and more cryptic. There are a lot of ifs here...



---

archive/issue_comments_470446.json:
```json
{
    "body": "Sorry, I meant the last `if` but it also applies to the first `if` ;)",
    "created_at": "2022-02-05T00:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470446",
    "user": "@mkoeppe"
}
```

Sorry, I meant the last `if` but it also applies to the first `if` ;)



---

archive/issue_comments_470447.json:
```json
{
    "body": "Replying to [comment:69 mkoeppe]:\n\n> > Also you can just execute the github workflow locally using `act` if you like.\n\nwow, I never knew about `act` (guess it's https://github.com/nektos/act)\n\nIt should be in our developer manual.",
    "created_at": "2022-02-05T04:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470447",
    "user": "@dimpase"
}
```

Replying to [comment:69 mkoeppe]:

> > Also you can just execute the github workflow locally using `act` if you like.

wow, I never knew about `act` (guess it's https://github.com/nektos/act)

It should be in our developer manual.



---

archive/issue_comments_470448.json:
```json
{
    "body": "Replying to [comment:78 dimpase]:\n> Replying to [comment:69 mkoeppe]:\n> \n> > > Also you can just execute the github workflow locally using `act` if you like.\n> \n> wow, I never knew about `act` (guess it's https://github.com/nektos/act)\n> \n\nYes, that's the one (should have directly provided a link, sry). It's quite powerful and usually works really well. Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.",
    "created_at": "2022-02-05T08:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470448",
    "user": "@tobiasdiez"
}
```

Replying to [comment:78 dimpase]:
> Replying to [comment:69 mkoeppe]:
> 
> > > Also you can just execute the github workflow locally using `act` if you like.
> 
> wow, I never knew about `act` (guess it's https://github.com/nektos/act)
> 

Yes, that's the one (should have directly provided a link, sry). It's quite powerful and usually works really well. Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.



---

archive/issue_comments_470449.json:
```json
{
    "body": "Replying to [comment:77 mkoeppe]:\n> Sorry, I meant the last `if` but it also applies to the first `if` ;)\n\nEven after sleep I don't understand your comment. The second if doesn't do anything in my opinion since the Github token is always there and we need to login to ghcr as you said earlier.\nFor the first if, this should be `password = ${{ secrets.DOCKER_PKG_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}` with the docker/login-action",
    "created_at": "2022-02-05T08:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470449",
    "user": "@tobiasdiez"
}
```

Replying to [comment:77 mkoeppe]:
> Sorry, I meant the last `if` but it also applies to the first `if` ;)

Even after sleep I don't understand your comment. The second if doesn't do anything in my opinion since the Github token is always there and we need to login to ghcr as you said earlier.
For the first if, this should be `password = ${{ secrets.DOCKER_PKG_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}` with the docker/login-action



---

archive/issue_comments_470450.json:
```json
{
    "body": "Replying to [comment:68 mkoeppe]:\n> Replying to [comment:66 gh-tobiasdiez]:\n> > Replying to [comment:61 mkoeppe]:\n> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.\n> > \n> > If it's so important, why not add it as a new target to the existing CI?\n> \n> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future.\n\n\nThinking about this again: would it be an idea to run the integration workflow as follows:\n- use the docker image build during the ci for the develop branch\n- merge all new tickets\n- re-build sage, including the packages that are needed for `doc-pdf`\n- run tests (using the ci artifact as baseline)\n- build docs\n\nNot sure how long the last step takes, but step 4 should finish in 30-60 mins (depending on how much packages are touched in the to-be-merged tickets) and step 5 about 1h. So this should all fit very nicely in one workflow. So the main advantage would be that you don't have to rebuild all packages from scratch during the integration workflow.\n\nThis is under the assumption that the packages needed for the pdf build of the documentation don't influence the tests, because otherwise the test-baseline could be wrong (but is probably still good enough).",
    "created_at": "2022-02-05T09:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470450",
    "user": "@tobiasdiez"
}
```

Replying to [comment:68 mkoeppe]:
> Replying to [comment:66 gh-tobiasdiez]:
> > Replying to [comment:61 mkoeppe]:
> > > This is to run `make doc-pdf`, an essential step that currently no CI is testing.
> > 
> > If it's so important, why not add it as a new target to the existing CI?
> 
> Yes, changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future.


Thinking about this again: would it be an idea to run the integration workflow as follows:
- use the docker image build during the ci for the develop branch
- merge all new tickets
- re-build sage, including the packages that are needed for `doc-pdf`
- run tests (using the ci artifact as baseline)
- build docs

Not sure how long the last step takes, but step 4 should finish in 30-60 mins (depending on how much packages are touched in the to-be-merged tickets) and step 5 about 1h. So this should all fit very nicely in one workflow. So the main advantage would be that you don't have to rebuild all packages from scratch during the integration workflow.

This is under the assumption that the packages needed for the pdf build of the documentation don't influence the tests, because otherwise the test-baseline could be wrong (but is probably still good enough).



---

archive/issue_comments_470451.json:
```json
{
    "body": "Just FYI, I'm planning on adding a CI step that runs for each ticket at #33294. Sufficiently different from this ticket that both have merits, just a heads up.",
    "created_at": "2022-02-05T15:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470451",
    "user": "@vbraun"
}
```

Just FYI, I'm planning on adding a CI step that runs for each ticket at #33294. Sufficiently different from this ticket that both have merits, just a heads up.



---

archive/issue_comments_470452.json:
```json
{
    "body": "Replying to [comment:79 gh-tobiasdiez]:\n> Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.\n\nWith a lot of patience!",
    "created_at": "2022-02-05T16:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470452",
    "user": "@mkoeppe"
}
```

Replying to [comment:79 gh-tobiasdiez]:
> Don't know how Matthias can work on the github workflows without quickly checking locally if everything goes well.

With a lot of patience!



---

archive/issue_comments_470453.json:
```json
{
    "body": "Replying to [comment:81 gh-tobiasdiez]:\n> - re-build sage, including the packages that are needed for `doc-pdf`\n\nthese are system packages, not sage packages",
    "created_at": "2022-02-05T19:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470453",
    "user": "@mkoeppe"
}
```

Replying to [comment:81 gh-tobiasdiez]:
> - re-build sage, including the packages that are needed for `doc-pdf`

these are system packages, not sage packages



---

archive/issue_comments_470454.json:
```json
{
    "body": "Replying to [comment:68 mkoeppe]:\n> changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. \n\nPreparation for that is now in #33296",
    "created_at": "2022-02-05T19:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470454",
    "user": "@mkoeppe"
}
```

Replying to [comment:68 mkoeppe]:
> changing the existing CI to build the `-recommended` instead of `-standard` workflow may be something that we want to do at some point in the future. 

Preparation for that is now in #33296



---

archive/issue_comments_470455.json:
```json
{
    "body": "Mainly to better understand the process behind the scenes, why is an additional \"integration\" branch necessary? Can one not simply push to \"develop\" (in case there are no errors)? I guess this comes down to the question \"what does the release manager has to do in the background that demands a manual merge into the develop branch\".",
    "created_at": "2022-02-17T16:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32985#issuecomment-470455",
    "user": "@tobiasdiez"
}
```

Mainly to better understand the process behind the scenes, why is an additional "integration" branch necessary? Can one not simply push to "develop" (in case there are no errors)? I guess this comes down to the question "what does the release manager has to do in the background that demands a manual merge into the develop branch".
