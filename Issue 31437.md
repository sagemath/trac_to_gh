# Issue 31437: Make open subsets of immersed/embedded submanifolds immersed/embedded submanifolds

Issue created by migration from https://trac.sagemath.org/ticket/31674

Original creator: mkoeppe

Original creation time: 2021-04-15 17:00:38

CC:  @mjungmath egourgoulhon tscrim

This would be convenient for example for #31660.

To implement this, perhaps the method `open_subset`, already now duplicated between `TopologicalManifold` and `DifferentiableManifold` could be refactored through a new method `open_subset_class`.


---

Comment by @mjungmath created at 2021-04-15 19:14:26

Why not simply overwriting `open_subset` in `TopologicalSubmanifold` etc.?


---

Comment by mkoeppe created at 2021-04-15 20:11:43

It would lead to at least 3 more copies of the same code


---

Comment by mkoeppe created at 2021-04-15 20:34:14

Here's the first copy
----
New commits:


---

Comment by git created at 2021-04-15 20:40:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-15 20:54:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-15 21:21:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-04-15 21:25:24

Replying to [ticket:31674 mkoeppe]:
> 
> To implement this, perhaps the method `open_subset`, already now duplicated between `TopologicalManifold` and `DifferentiableManifold` could be refactored through a new method `open_subset_class`.
>
It sounds indeed a good idea to refactor the common code in the two (now three) `open_subset` methods! 

Note that the comment 

```# update vector frames and change of frames
```

in `DifferentiableManifold.open_subset` means that vector frames that are not coordinate frames could be inherited from those on the ambient manifold. I've put the marker `#!#` to indicate that this is not implemented yet. For example:

```

sage: M = Manifold(2, 'M')                                                                                              
sage: X.<x,y> = M.chart()                                                                                               
sage: e0 = M.vector_field(1, 1)                                                                                          
sage: e1 = M.vector_field(1, -2)                                                                                         
sage: e = M.vector_frame('e', (e0, e1))                                                                                   
sage: M.frames()                                                                                                        
[Coordinate frame (M, (d/dx,d/dy)), Vector frame (M, (e_0,e_1))]
sage: U = M.open_subset('U', coord_def={X: x>0})                                                                        
sage: U.frames()                                                                                                        
[Coordinate frame (U, (d/dx,d/dy))]
```

The vector frame `e` is thus not transmitted to `U`. Of course, this can be achieved at any moment by the method `restrict`: 

```
sage: e.restrict(U)                                                                                                     
Vector frame (U, (e_0,e_1))
sage: U.frames()                                                                                                        
[Coordinate frame (U, (d/dx,d/dy)), Vector frame (U, (e_0,e_1))]
```

----
New commits:


---

Comment by mkoeppe created at 2021-04-15 21:28:13

Replying to [comment:9 egourgoulhon]:
> Replying to [ticket:31674 mkoeppe]:
> Note that the comment 
> {{{
> #!# update vector frames and change of frames
> }}}
> in `DifferentiableManifold.open_subset` means that vector frames that are not coordinate frames could be inherited from those on the ambient manifold. I've put the marker `#!#` to indicate that this is not implemented yet. 

Yes, I have faithfully copied these TODO markers. Should this be implemented on this ticket?


---

Comment by egourgoulhon created at 2021-04-15 21:33:51

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 egourgoulhon]:
> > Replying to [ticket:31674 mkoeppe]:
> > Note that the comment 
> > {{{
> > #!# update vector frames and change of frames
> > }}}
> > in `DifferentiableManifold.open_subset` means that vector frames that are not coordinate frames could be inherited from those on the ambient manifold. I've put the marker `#!#` to indicate that this is not implemented yet. 
> 
> Yes, I have faithfully copied these TODO markers. Should this be implemented on this ticket?
> 
Maybe. I leave it to you. Actually, I don't remember why this was not implemented in the first version of the `open_subset` method.


---

Comment by mkoeppe created at 2021-04-15 21:47:29

I'll leave this for another ticket then.

I will do the refactoring using a new method `_init_open_subset`


---

Comment by git created at 2021-04-15 21:58:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-15 21:58:58

Here's the proposed refactoring.


---

Comment by mkoeppe created at 2021-04-15 21:59:09

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2021-04-16 10:18:35

LGTM.

Could you please fix the coverage issues? (no docstest in the two methods `_init_open_subset`)


---

Comment by git created at 2021-04-16 15:42:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-16 15:42:43

First of several docstrings, more to come


---

Comment by mkoeppe created at 2021-04-16 16:18:24

A question: Should this method rather be invoked by the `__init__` method of the subset whenever `base_manifold` is passed?


---

Comment by egourgoulhon created at 2021-04-16 16:45:42

Replying to [comment:19 mkoeppe]:
> A question: Should this method rather be invoked by the `__init__` method of the subset whenever `base_manifold` is passed?
Yes, why not?


---

Comment by mkoeppe created at 2021-04-16 16:49:12

OK, then I will rewrite it like this.


---

Comment by egourgoulhon created at 2021-04-16 17:29:27

Replying to [comment:21 mkoeppe]:
> OK, then I will rewrite it like this.
Giving a second thought, this seems indeed a good idea! It makes the object returned by `__init__` as "finished" as possible.


---

Comment by mkoeppe created at 2021-04-16 18:14:14

Just will add one more keyword arg to `__init__`, but I think that should be fine.


---

Comment by mkoeppe created at 2021-04-16 18:16:22

I think I would also like to move `TopologicalManifold.open_subset` to its superclass `ManifoldSubset`.


---

Comment by mkoeppe created at 2021-04-17 03:35:14

Replying to [comment:24 mkoeppe]:
> I think I would also like to move `TopologicalManifold.open_subset` to its superclass `ManifoldSubset`.

I'll do this in #31677.


---

Comment by mkoeppe created at 2021-04-17 03:37:11

Replying to [comment:22 egourgoulhon]:
> Replying to [comment:21 mkoeppe]:
> > OK, then I will rewrite it like this.
> Giving a second thought, this seems indeed a good idea! It makes the object returned by `__init__` as "finished" as possible. 

I tried this approach but it led to complicated changes. Too much for one ticket. So I'll revert to the original plan, completing this ticket by adding docstrings for `_init_open_subset`. An immediate follow-up is #31677.


---

Comment by mkoeppe created at 2021-04-17 03:59:14

Replying to [comment:9 egourgoulhon]:
> Note that the comment 
> {{{
> #!# update vector frames and change of frames
> }}}
> in `DifferentiableManifold.open_subset` means that vector frames that are not coordinate frames could be inherited from those on the ambient manifold. I've put the marker `#!#` to indicate that this is not implemented yet.

I've opened #31678 for this


---

Comment by git created at 2021-04-17 04:48:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-17 04:51:48

Ready for review


---

Comment by egourgoulhon created at 2021-04-17 08:10:51

Replying to [comment:26 mkoeppe]:
> Replying to [comment:22 egourgoulhon]:
> > Giving a second thought, this seems indeed a good idea! It makes the object returned by `__init__` as "finished" as possible. 
> 
> I tried this approach but it led to complicated changes. Too much for one ticket. So I'll revert to the original plan, completing this ticket by adding docstrings for `_init_open_subset`. An immediate follow-up is #31677.
> 

OK, very good. 
Thanks for your work!


---

Comment by egourgoulhon created at 2021-04-17 08:10:51

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2021-04-17 08:17:27

Is there a way to get rid of the various copies of


```diff
+        if self is not self._manifold:
+            return "Open subset {} of the {}".format(self._name, self._manifold)
```


and delegate it?


---

Comment by mkoeppe created at 2021-04-17 15:50:26

Well, the `_repr_` methods in their entirety are there in multiple copies. This could be simplified, but not on this ticket.


---

Comment by mkoeppe created at 2021-04-17 15:50:34

Thanks for the review!


---

Comment by @mjungmath created at 2021-04-17 16:44:43

Replying to [comment:32 mkoeppe]:
> Well, the `_repr_` methods in their entirety are there in multiple copies. This could be simplified, but not on this ticket.

Right, makes sense.

Nice work though! :)


---

Comment by vbraun created at 2021-06-06 13:18:03

Resolution: fixed
