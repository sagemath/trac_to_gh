# Issue 12393: E = EllipticCurve('10a1') gives a stupid traceback (rather than a smart one)

Issue created by migration from https://trac.sagemath.org/ticket/12565

Original creator: was

Original creation time: 2012-02-22 18:46:16

Assignee: cremona

I don't like this error:

```
sage: E = EllipticCurve('10a1')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/Users/wstein/sage/install/sage-5.0.beta2/devel/sage-git/sage/modular/modsym/padic_lseries/<ipython console> in <module>()

/Users/wstein/sage/install/sage-5.0.beta2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/constructor.pyc in EllipticCurve(x, y, j)
    293         
    294     if isinstance(x, str):
--> 295         return ell_rational_field.EllipticCurve_rational_field(x)
    296         
    297     if rings.is_RingElement(x) and y is None:

/Users/wstein/sage/install/sage-5.0.beta2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in __init__(self, ainvs, extra)
    197             label = ainvs
    198             X = sage.databases.cremona.CremonaDatabase()[label]
--> 199             EllipticCurve_number_field.__init__(self, Q, list(X.a_invariants()))
    200             self.__np = {}
    201             self.__gens = {}

AttributeError: 'NoneType' object has no attribute 'a_invariants'
```


I would expect something like:


```
ValueError: no known curve with Cremona label '10a1' 
```


Another bug.  If you use Sage for a level outside the Cremona range and you're using a system-wide Sage install, this is the error you get, which is pretty scary looking:

```
sage: E = EllipticCurve('10050000s1')
Traceback (most recent call last):
  File "/usr/local/share/sage-4.8/local/bin/sage-list-packages", line 21, in <module>
    os.makedirs(SAGE_ROOT_TMP)
  File "/usr/local/share/sage-4.8/local/lib/python/os.py", line 157, in makedirs
    mkdir(name, mode)
OSError: [Errno 13] Permission denied: '/usr/local/share/sage-4.8/tmp'
Using SAGE Server http://www.sagemath.org//packages

Optional package list (shown above) appears to be currently not available or corrupted (network error?).
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/wstein/<ipython console> in <module>()

/usr/local/share/sage-4.8/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/constructor.pyc in EllipticCurve(x, y, j)
    293         
    294     if isinstance(x, str):
--> 295         return ell_rational_field.EllipticCurve_rational_field(x)
    296         
    297     if rings.is_RingElement(x) and y is None:

/usr/local/share/sage-4.8/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in __init__(self, ainvs, extra)
    197             label = ainvs
    198             X = sage.databases.cremona.CremonaDatabase()[label]
--> 199             EllipticCurve_number_field.__init__(self, Q, list(X.a_invariants()))
    200             self.__np = {}
    201             self.__gens = {}

AttributeError: 'NoneType' object has no attribute 'a_invariants'
```



---

Comment by cremona created at 2012-02-23 09:21:47

That is really stupid.  I'm sure it never used to do that --but why is there not a dictest for this construction on a failing string?  I wonder if this came in with the new database implmentation.  The error should surely be raised in the call to teh class contructor with the string, not just returning None.


---

Comment by ohanar created at 2012-02-23 17:49:25

Replying to [comment:1 cremona]:
> I wonder if this came in with the new database implementation.
Yup, with 4.7.2 (pre database change)

```
sage: EllipticCurve('10a1')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)

/home/ohanar/sage-dev/sage-4.7.2-sage.math.washington.edu-x86_64-Linux/<ipython console> in <module>()

/home/ohanar/sage-dev/sage-4.7.2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/constructor.pyc in EllipticCurve(x, y, j)
    293         
    294     if isinstance(x, str):
--> 295         return ell_rational_field.EllipticCurve_rational_field(x)
    296         
    297     if rings.is_RingElement(x) and y is None:

/home/ohanar/sage-dev/sage-4.7.2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in __init__(self, ainvs, extra)
    196         if isinstance(ainvs, str):
    197             label = ainvs
--> 198             X = sage.databases.cremona.CremonaDatabase()[label]
    199             EllipticCurve_number_field.__init__(self, Q, list(X.a_invariants()))
    200             self.__np = {}

/home/ohanar/sage-dev/sage-4.7.2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/databases/cremona.pyc in __getitem__(self, N)
    453                 return sage.databases.db.Database.__getitem__(self, N)
    454             else:
--> 455                 return self.elliptic_curve(N)
    456         try:
    457             N = int(N)

/home/ohanar/sage-dev/sage-4.7.2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/databases/cremona.pyc in elliptic_curve(self, label)
    693             else:
    694                 message = "There is no elliptic curve with label "+label+" in the currently available databases"
--> 695             raise RuntimeError, message
    696         
    697         F = elliptic.EllipticCurve(e[0])

RuntimeError: There is no elliptic curve with label 10a1 in the database (note: use lower case letters!)
```


I'll go see about fixing this now.

For the other bug, that looks like it might not be specific to the cremona database.


---

Comment by ohanar created at 2012-02-23 18:07:41

ok, that first bug was really stupid. The error message was being created, but it was never being raised. This also gives the correct error for the other end of the spectrum, but it doesn't fix the scary permissions error. I'm going to see what that is about now.


---

Comment by ohanar created at 2012-02-23 18:13:21

Changing status from new to needs_review.


---

Comment by ohanar created at 2012-02-23 18:13:21

so #12341 fixes the other issue, please review these two tickets


---

Comment by was created at 2012-02-23 19:01:14

Changing status from needs_review to needs_work.


---

Comment by was created at 2012-02-23 19:01:14

I think this error message is annoying: 

```
RuntimeError: There is no elliptic curve with label 10a1 in the database (note: use lower case letters!) 
```

I can see putting " (note: use lower case letters!) " if the user input "10A1", but if they already input lower case letters, why add that remark!?


---

Comment by ohanar created at 2012-02-23 19:26:58

ok, changed that by making it accept old cremona labels (and having the label parser actually throw errors if there is a problem with the label)


---

Comment by ohanar created at 2012-02-23 19:26:58

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-02-23 19:30:56

dependency was added since otherwise this patch no longer applies cleanly


---

Comment by was created at 2012-02-23 19:39:06

Changing status from needs_review to needs_work.


---

Comment by was created at 2012-02-23 19:39:06

Include an example that illustrates the following: "accept old cremona labels"


---

Comment by ohanar created at 2012-02-23 19:41:43

Replying to [comment:8 was]:
> Include an example that illustrates the following: "accept old cremona labels"

Where? In the elliptic curve constructor, the database method, or both?


---

Comment by was created at 2012-02-23 19:43:58

> In the elliptic curve constructor, the database method, or both?

In both, and use different examples in each case (it's your chance to be creative!)


---

Attachment


---

Comment by ohanar created at 2012-02-23 20:07:38

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-02-23 20:07:38

ok, hopefully there that satisfies all of your complaints :)


---

Comment by ohanar created at 2012-02-23 20:54:54

oops, put the wrong ticket as the dependency


---

Comment by ohanar created at 2012-02-23 21:46:30

I found the root of the permissions issue that #12341 avoids and have made the ticket #12578 for it.


---

Comment by cremona created at 2012-02-24 14:40:16

I get an error applying the patch to 5.0.beta5, at line 677 in sage/databases/cremona.py with reject messsage

```
Hunk #4 FAILED at 677
1 out of 5 hunks FAILED -- saving rejects to file sage/databases/cremona.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh trac12565.patch
```

but I'm not sure what is causing this.  the patch looks fine to me.  After app;lying the patch (without that hunk) I still get

```
sage: EllipticCurve('10a1')
...
RuntimeError: There is no elliptic curve with label 10a1 in the database (note: use lower case letters!)
```

If you can fix this I'm sure I'll be able to give a positive review quickly.


---

Comment by cremona created at 2012-02-24 14:40:16

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2012-02-24 18:34:58

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-02-24 18:34:58

Replying to [comment:14 cremona]:
> I get an error applying the patch to 5.0.beta5, at line 677 in sage/databases/cremona.py with reject messsage

This patch was based off of #12341 which also touches this file, which is why I added it as a dependency. (The reason why it fails is due to the line following the one that generates the error message, it is changed in #12341)


---

Comment by cremona created at 2012-02-25 12:14:17

Replying to [comment:15 ohanar]:
> Replying to [comment:14 cremona]:
> > I get an error applying the patch to 5.0.beta5, at line 677 in sage/databases/cremona.py with reject messsage
> 
> This patch was based off of #12341 which also touches this file, which is why I added it as a dependency. (The reason why it fails is due to the line following the one that generates the error message, it is changed in #12341)

Sorry, my mistake -- I did not notice the dependency.  I will get back to it.


---

Comment by cremona created at 2012-02-25 16:09:42

With #12341 this applies (to 5.0.beta5) and works fine.


---

Comment by cremona created at 2012-02-25 16:09:42

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2012-10-11 11:58:15

Changing status from positive_review to needs_work.


---

Comment by cremona created at 2012-10-11 11:59:03

Rebasing after #12341's rebase


---

Attachment

I have rebased the patch so that it now works after the rebased #12341.

This was not quite trivial as a little extra coding was needed so that "Old Cremona labels" could be parsed properly using the regexp method.

I tested sage/databses/cremona.py and all in sage/schemes/elliptic_curves.


---

Comment by cremona created at 2012-10-11 12:01:49

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-10-11 23:40:47

The regexp code looks good to me.


---

Comment by cremona created at 2012-10-12 08:06:25

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2012-10-15 12:51:11

To confirm: I checked that the rebased patch applies to 5.4.rc1+trac_12341.patch (after that was rebased), and that all tests in schemes/elliptic_curves pass (1) without database_ell_cremona installed, (2) with it installed, without "-optional database_cremona_ellcurve", (3) with it installed and with "-optional database_cremona_ellcurve".

The only failed test is the one in heegner.py which fails when the optional database is installed for reasons spelled out elsewhere and to be fixed in #13547.


---

Comment by jdemeyer created at 2012-11-13 08:20:42

Resolution: fixed
