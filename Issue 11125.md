# Issue 11125: altivec must be disabled for ECL on PPC OSX 10.5

archive/issues_011125.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  fbissey kcrisman\n\nKeywords: PPC, MacOSX 10.5, ECL\n\nECL 11.1.1.p0 spkg does not build on MacOSX PPC (G4) running MacOSX 10.5, and using XCode 3.1.4 (the lastest XCode for this platform).\nSymptoms: a crash half-way the build, at the log point\n\n```\n;;; About to load cmp/load.lsp \n;;; \n;;; Now we are in shape to do something useful. \n;;; End of bare.lsp\n```\n \nit can be:\n\n``` \nInternal or unrecoverable error in: \nnot a lisp data object \n  [2: No such file or directory] \n```\n\nor\n\n``` \nDetected access to an invalid or protected memory address. \nAvailable restarts: \n1. (CONTINUE) Ignore signal\n```\n \nor\n\n``` \n64 is an illegal index to \"Variable in COMMON-LISP package: \nThe last-but-one top-level forme\". \nNo restarts available. \n```\n\nor perhaps something else like this. This is apparently due to an ECL bug having to do with altivec instructions.\nConfiguring with \n\n```\n./configure CFLAGS=\"-mno-altivec -mabi=no-altivec\"\n```\n\nmakes the ECL build OK. See\nhttps://groups.google.com/group/sage-devel/browse_thread/thread/55313fb49133b97/8cbd9ac8826ef685#8cbd9ac8826ef685\n\nfor more info on this.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11297\n\n",
    "created_at": "2011-05-05T05:08:04Z",
    "labels": [
        "build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7",
    "title": "altivec must be disabled for ECL on PPC OSX 10.5",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11125",
    "user": "dimpase"
}
```
Assignee: GeorgSWeber

CC:  fbissey kcrisman

Keywords: PPC, MacOSX 10.5, ECL

ECL 11.1.1.p0 spkg does not build on MacOSX PPC (G4) running MacOSX 10.5, and using XCode 3.1.4 (the lastest XCode for this platform).
Symptoms: a crash half-way the build, at the log point

```
;;; About to load cmp/load.lsp 
;;; 
;;; Now we are in shape to do something useful. 
;;; End of bare.lsp
```
 
it can be:

``` 
Internal or unrecoverable error in: 
not a lisp data object 
  [2: No such file or directory] 
```

or

``` 
Detected access to an invalid or protected memory address. 
Available restarts: 
1. (CONTINUE) Ignore signal
```
 
or

``` 
64 is an illegal index to "Variable in COMMON-LISP package: 
The last-but-one top-level forme". 
No restarts available. 
```

or perhaps something else like this. This is apparently due to an ECL bug having to do with altivec instructions.
Configuring with 

```
./configure CFLAGS="-mno-altivec -mabi=no-altivec"
```

makes the ECL build OK. See
https://groups.google.com/group/sage-devel/browse_thread/thread/55313fb49133b97/8cbd9ac8826ef685#8cbd9ac8826ef685

for more info on this.

Issue created by migration from https://trac.sagemath.org/ticket/11297





---

archive/issue_comments_121681.json:
```json
{
    "body": "so this is the proposed patch for spkg-install in ecl-11.1.1.p0.spkg\n\n\n```\ndiff -r 492613112d08 spkg-install\n--- a/spkg-install\tWed Mar 23 10:24:48 2011 +1300\n+++ b/spkg-install\tThu May 05 14:08:59 2011 +0800\n@@ -83,6 +83,9 @@\n    # 2) Intel or AMD CPU \n    # 3) 64-bit build\n    ./configure --prefix=\"$SAGE_LOCAL\" --with-dffi=no\n+elif [ \"`uname -sm`\" = \"Darwin Power Macintosh\" ] ; then\n+   # disbaling altivec instructions (trac 11297)\n+     ./configure --prefix=\"$SAGE_LOCAL\" CFLAGS=\"$CFLAGS -mno-altivec -mabi=no-altivec\" \n else\n    ./configure --prefix=\"$SAGE_LOCAL\" \n fi\n```\n",
    "created_at": "2011-05-05T06:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121681",
    "user": "dimpase"
}
```

so this is the proposed patch for spkg-install in ecl-11.1.1.p0.spkg


```
diff -r 492613112d08 spkg-install
--- a/spkg-install	Wed Mar 23 10:24:48 2011 +1300
+++ b/spkg-install	Thu May 05 14:08:59 2011 +0800
@@ -83,6 +83,9 @@
    # 2) Intel or AMD CPU 
    # 3) 64-bit build
    ./configure --prefix="$SAGE_LOCAL" --with-dffi=no
+elif [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
+   # disbaling altivec instructions (trac 11297)
+     ./configure --prefix="$SAGE_LOCAL" CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec" 
 else
    ./configure --prefix="$SAGE_LOCAL" 
 fi
```




---

archive/issue_comments_121682.json:
```json
{
    "body": "Looks reasonable. I am not I can cut yet another ecl spkg today. Actually work is peaking up so if someone else wants to pick that up it'd be great.\n\nAs I noted in the thread this may need to be followed by the addition of the same CFLAGS when you build sage/libs/ecl.pyx. This can be done with platform specific instructions.\n\nI can review if I cannot cut it.",
    "created_at": "2011-05-05T09:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121682",
    "user": "fbissey"
}
```

Looks reasonable. I am not I can cut yet another ecl spkg today. Actually work is peaking up so if someone else wants to pick that up it'd be great.

As I noted in the thread this may need to be followed by the addition of the same CFLAGS when you build sage/libs/ecl.pyx. This can be done with platform specific instructions.

I can review if I cannot cut it.



---

archive/issue_comments_121683.json:
```json
{
    "body": "I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do\n\n```\nif [ \"`uname -sm`\" = \"Darwin Power Macintosh\" ] ; then\n    CFLAGS=\"$CFLAGS -mno-altivec -mabi=no-altivec\"\n    export CFLAGS\nfi\n```\n\n\nThe ticket mentions \"Reported upstream. Little or no feedback.\"  How was this reported?  Can you put a link to the relevant mailing list post or bug tracker page?",
    "created_at": "2011-05-05T10:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121683",
    "user": "jdemeyer"
}
```

I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do

```
if [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
    CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec"
    export CFLAGS
fi
```


The ticket mentions "Reported upstream. Little or no feedback."  How was this reported?  Can you put a link to the relevant mailing list post or bug tracker page?



---

archive/issue_comments_121684.json:
```json
{
    "body": "I know I never reported it upstream.",
    "created_at": "2011-05-05T10:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121684",
    "user": "fbissey"
}
```

I know I never reported it upstream.



---

archive/issue_comments_121685.json:
```json
{
    "body": "I reported this on an ECL bug tracker on sourceforge.",
    "created_at": "2011-05-05T15:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121685",
    "user": "dimpase"
}
```

I reported this on an ECL bug tracker on sourceforge.



---

archive/issue_comments_121686.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do\n\n {{{\n if [ \"`uname -sm`\" = \"Darwin Power Macintosh\" ] ; then\n     CFLAGS=\"$CFLAGS -mno-altivec -mabi=no-altivec\"\n     export CFLAGS\n fi\n}}}\n> \nOK, I've created an spkg with this patch (link in the ticket description).",
    "created_at": "2011-05-06T06:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121686",
    "user": "dimpase"
}
```

Replying to [comment:4 jdemeyer]:
> I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do

 {{{
 if [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
     CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec"
     export CFLAGS
 fi
}}}
> 
OK, I've created an spkg with this patch (link in the ticket description).



---

archive/issue_comments_121687.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-05-06T06:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121687",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_121688.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-06T23:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121688",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_121689.json:
```json
{
    "body": "I am happy with your change and the spkg is correct and hg committed. I will give this a positive review. As I mentioned on sage-devel the problem with sage/libs/ecl.pyx would only happen with a more recent compiler - none will be shipped by apple and we can only hope that non-apple ones will not have altivec enabled by default.\n\nThere will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.",
    "created_at": "2011-05-06T23:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121689",
    "user": "fbissey"
}
```

I am happy with your change and the spkg is correct and hg committed. I will give this a positive review. As I mentioned on sage-devel the problem with sage/libs/ecl.pyx would only happen with a more recent compiler - none will be shipped by apple and we can only hope that non-apple ones will not have altivec enabled by default.

There will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.



---

archive/issue_comments_121690.json:
```json
{
    "body": "Replying to [comment:8 fbissey]:\n \n> There will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.\n\nit might be you saw a log on a stand-alone compilation attempt (which would certainly use the built0in gc). I certainly did not tweak the flags in the spkg that deal with this, so whatever setting is currently in Sage remains.",
    "created_at": "2011-05-07T06:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121690",
    "user": "dimpase"
}
```

Replying to [comment:8 fbissey]:
 
> There will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.

it might be you saw a log on a stand-alone compilation attempt (which would certainly use the built0in gc). I certainly did not tweak the flags in the spkg that deal with this, so whatever setting is currently in Sage remains.



---

archive/issue_comments_121691.json:
```json
{
    "body": "Changing component from build to packages.",
    "created_at": "2011-05-07T11:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121691",
    "user": "jdemeyer"
}
```

Changing component from build to packages.



---

archive/issue_comments_121692.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-05-08T12:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11125#issuecomment-121692",
    "user": "jdemeyer"
}
```

Resolution: fixed
