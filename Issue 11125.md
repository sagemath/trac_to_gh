# Issue 11125: altivec must be disabled for ECL on PPC OSX 10.5

Issue created by migration from https://trac.sagemath.org/ticket/11297

Original creator: dimpase

Original creation time: 2011-05-05 05:08:04

Assignee: GeorgSWeber

CC:  fbissey kcrisman

Keywords: PPC, MacOSX 10.5, ECL

ECL 11.1.1.p0 spkg does not build on MacOSX PPC (G4) running MacOSX 10.5, and using XCode 3.1.4 (the lastest XCode for this platform).
Symptoms: a crash half-way the build, at the log point

```
;;; About to load cmp/load.lsp 
;;; 
;;; Now we are in shape to do something useful. 
;;; End of bare.lsp
}}} 
it can be:
{{{ 
Internal or unrecoverable error in: 
not a lisp data object 
  [2: No such file or directory] 
}}}
or
{{{ 
Detected access to an invalid or protected memory address. 
Available restarts: 
1. (CONTINUE) Ignore signal
}}} 
or
{{{ 
64 is an illegal index to "Variable in COMMON-LISP package: 
The last-but-one top-level forme". 
No restarts available. 
}}}
or perhaps something else like this. This is apparently due to an ECL bug having to do with altivec instructions.
Configuring with 
{{{
./configure CFLAGS="-mno-altivec -mabi=no-altivec"
}}}
makes the ECL build OK. See
https://groups.google.com/group/sage-devel/browse_thread/thread/55313fb49133b97/8cbd9ac8826ef685#8cbd9ac8826ef685

for more info on this.


---

Comment by dimpase created at 2011-05-05 06:10:55

so this is the proposed patch for spkg-install in ecl-11.1.1.p0.spkg


```
diff -r 492613112d08 spkg-install
--- a/spkg-install	Wed Mar 23 10:24:48 2011 +1300
+++ b/spkg-install	Thu May 05 14:08:59 2011 +0800
@@ -83,6 +83,9 @@
    # 2) Intel or AMD CPU 
    # 3) 64-bit build
    ./configure --prefix="$SAGE_LOCAL" --with-dffi=no
+elif [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
+   # disbaling altivec instructions (trac 11297)
+     ./configure --prefix="$SAGE_LOCAL" CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec" 
 else
    ./configure --prefix="$SAGE_LOCAL" 
 fi
```



---

Comment by fbissey created at 2011-05-05 09:43:50

Looks reasonable. I am not I can cut yet another ecl spkg today. Actually work is peaking up so if someone else wants to pick that up it'd be great.

As I noted in the thread this may need to be followed by the addition of the same CFLAGS when you build sage/libs/ecl.pyx. This can be done with platform specific instructions.

I can review if I cannot cut it.


---

Comment by jdemeyer created at 2011-05-05 10:06:24

I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do

```
if [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
    CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec"
    export CFLAGS
fi
```


The ticket mentions "Reported upstream. Little or no feedback."  How was this reported?  Can you put a link to the relevant mailing list post or bug tracker page?


---

Comment by fbissey created at 2011-05-05 10:28:59

I know I never reported it upstream.


---

Comment by dimpase created at 2011-05-05 15:42:03

I reported this on an ECL bug tracker on sourceforge.


---

Comment by dimpase created at 2011-05-06 06:30:55

Replying to [comment:4 jdemeyer]:
> I think having an argument CFLAGS and a conflicting environment variable CFLAGS is asking for touble.  Why not simply do

 {{{
 if [ "`uname -sm`" = "Darwin Power Macintosh" ] ; then
     CFLAGS="$CFLAGS -mno-altivec -mabi=no-altivec"
     export CFLAGS
 fi
}}}
> 
OK, I've created an spkg with this patch (link in the ticket description).


---

Comment by dimpase created at 2011-05-06 06:30:55

Changing status from new to needs_review.


---

Comment by fbissey created at 2011-05-06 23:53:22

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2011-05-06 23:53:22

I am happy with your change and the spkg is correct and hg committed. I will give this a positive review. As I mentioned on sage-devel the problem with sage/libs/ecl.pyx would only happen with a more recent compiler - none will be shipped by apple and we can only hope that non-apple ones will not have altivec enabled by default.

There will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.


---

Comment by dimpase created at 2011-05-07 06:45:47

Replying to [comment:8 fbissey]:
 
> There will be a small (but not blocking) matter that I have noticed in your build log. If confirmed it will go in another ticket for 4.7.1. Can you confirm whether or not you are using the sage installed boehm_gc or the ecl internal copy with your new spkg? Like I said in the log you posted the internal copy was used. It is not impossible that fixing the flags also solved that but we should check more widely what happens on computers where bohem_gc is not installed as part of the system.

it might be you saw a log on a stand-alone compilation attempt (which would certainly use the built0in gc). I certainly did not tweak the flags in the spkg that deal with this, so whatever setting is currently in Sage remains.


---

Comment by jdemeyer created at 2011-05-07 11:46:09

Changing component from build to packages.


---

Comment by jdemeyer created at 2011-05-08 12:24:53

Resolution: fixed
