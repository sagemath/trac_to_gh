# Issue 22368: Better error handling of the polyhedron constructor for non-embedded NumberField and floats.

Issue created by migration from Trac.

Original creator: jipilab

Original creation time: 2017-03-15 12:58:51

CC:  moritz mkoeppe vdelecroix novoselt tmonteil tscrim

Keywords: polyhedron, base ring

These error messages are not really informative of what the problem really is:


```

sage: K = NumberField(x^2-2,'s')
sage: s = K.0
sage: L = NumberField(x^3-2,'t')
sage: t = L.0
sage: P = Polyhedron(vertices = [[0,s],[t,0]])
Traceback (most recent call last):
...
AttributeError: 'Objects_with_category' object has no attribute 'is_exact'

```


similar problem with `floats`:


```

sage: f = float(1.1)
sage: f
1.1
sage: Polyhedron(vertices=[This is the Trac macro *f* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#f-macro))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-55-aea1b8b1f057> in <module>()
----> 1 Polyhedron(vertices=[This is the Trac macro *f* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#f-macro))

/Users/jplab/sage/sage2/src/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (/Users/jplab/sage/sage2/src/build/cythonized/sage/misc/lazy_import.c:4007)()
    387             True
    388         """
--> 389         return self._get_object()(*args, **kwds)
    390 
    391     def __repr__(self):

/Users/jplab/sage/sage2/local/lib/python2.7/site-packages/sage/geometry/polyhedron/constructor.pyc in Polyhedron(vertices, rays, lines, ieqs, eqns, ambient_dim, base_ring, minimize, verbose, backend)
    490     # Specific backends can override the base_ring
    491     from sage.geometry.polyhedron.parent import Polyhedra
--> 492     parent = Polyhedra(base_ring, ambient_dim, backend=backend)
    493     base_ring = parent.base_ring()
    494 

/Users/jplab/sage/sage2/local/lib/python2.7/site-packages/sage/geometry/polyhedron/parent.pyc in Polyhedra(base_ring, ambient_dim, backend)
     89         elif base_ring is RDF:
     90             backend = 'cdd'
---> 91         elif base_ring.is_exact():
     92             backend = 'field'
     93         else:

AttributeError: type object 'float' has no attribute 'is_exact'

```



---

Comment by vdelecroix created at 2017-03-15 13:41:48

Indeed. Do we want to convert `float -> RDF` these two are fully compatible?


---

Comment by jipilab created at 2017-03-15 13:49:17

If this:


```
sage: RDF.has_coerce_map_from(float)
True
```


is all we need, I guess so... It would do a similar trick as for RR with 53 bits of precision...


---

Comment by vdelecroix created at 2017-03-15 13:55:50

It is not: coercion has nothing to do with embedding

```
sage: Zmod(5).has_coerce_map_from(ZZ)
True
sage: RealField(5).has_coerce_map_from(RealField(256))
True
```



---

Comment by jipilab created at 2017-03-17 13:30:01

So how to check for the embedding? Simply wrap?


---

Comment by jipilab created at 2017-03-17 14:37:34

I added a way to catch the float and set the base ring to `RDF`. Now, I'm wondering how we could handle the algebraic numbers in an efficient way. Indeed, it seems that they are automatically converted while they might not need it. 

----
New commits:


---

Comment by git created at 2017-04-04 14:24:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-04-04 14:28:13

Changing status from new to needs_review.


---

Comment by git created at 2017-04-04 14:31:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-04-04 16:02:24

A polyhedron with *one* non embedded number field should already gives an error. Could you add an example involving only `L`?


---

Comment by vdelecroix created at 2017-04-04 16:04:57

Instead of the manual `float -> RDF` you should use `py_scalar_parent` from `sage.structure.coercion`. By the way, where the conversion `Python int -> ZZ` is happening? This should be done at the same time.


---

Comment by vdelecroix created at 2017-04-04 19:42:54

Much more resaonable code path in my branch. Though the error message could still be elaborated.
----
New commits:


---

Comment by vdelecroix created at 2017-04-04 19:48:47

BTW, I think that the following would better be handled by `Polyhedra` (constructor of the parent)

```
# TODO: find a more robust way of checking that the coefficients are indeed
# real numbers
if base_ring not in Rings() or not RDF.has_coerce_map_from(base_ring):
    raise ValueError("invalid base ring")
```



---

Comment by jipilab created at 2017-04-04 20:09:33

I was also hesitating about where to put the handling of the error... But since there was not proper `base_ring` to pass to the parent, I thought it is better to stop there... But then, looking up at the documentation on top of the constructor... there is not much...

I then looked at the output of `Polyhedron?` and it is there... So I guess it is a good idea to put it in the constructor?

I will have a deeper look at your commit asap. I would be happy to have a cleaner and clearer constructor...


---

Comment by jipilab created at 2017-04-05 07:33:47

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2017-04-05 07:33:47

I'm looking at the last commit and at line 488 of the constructor, I got puzzled a bit...

If you give a polyhedron with an `H`-representation and specified the `base_ring=ZZ`, then it would convert it automatically to `QQ`? What if the user is clever and knows that the `H`-representation that is given really describes a lattice polytope and would like to specify its parent to be Polyhedron_ZZ. So forcing the `base_ring` should be possible?

I have #22754 in mind as an example.

I'll try to put some time on this, but I will look at the trac only sporadically in the next 2 weeks.


---

Comment by mkoeppe created at 2017-04-06 18:02:07

Overall I think the distinction of `base_ring=QQ` and `base_ring=ZZ` is completely unnecessary. The constructor could just unconditionally replace the given base ring by its fraction field.


---

Comment by jipilab created at 2017-04-06 20:58:07

Replying to [comment:18 mkoeppe]:
> Overall I think the distinction of `base_ring=QQ` and `base_ring=ZZ` is completely unnecessary. The constructor could just unconditionally replace the given base ring by its fraction field.

But this distinction is used in order to pick the proper parent isn't it? So what about the distinction of the two parent classes `_QQ` and `_ZZ`? It is true that a rational polytope has an Ehrhart quasipolynomial which is not necessarily a polynomial... Well, well...

It is true that this distinction makes life more difficult in some cases...


---

Comment by mkoeppe created at 2017-04-06 21:27:26

Yes, that's what I mean; there is no need to distinguish the parents for QQ and ZZ. 

The method for computing an ehrhart polynomial should also be available for rational polytopes; being a lattice polytope is merely a sufficient condition for getting an ehrhart polynomial. If the user asks for the ehrhart polynomial but the counting function is a quasipolynomial (with a true period), then an exception should be raised by the method.


---

Comment by vdelecroix created at 2017-04-07 06:54:22

Replying to [comment:20 mkoeppe]:
> Yes, that's what I mean; there is no need to distinguish the parents for QQ and ZZ. 
> 
> The method for computing an ehrhart polynomial should also be available for rational polytopes; being a lattice polytope is merely a sufficient condition for getting an ehrhart polynomial. If the user asks for the ehrhart polynomial but the counting function is a quasipolynomial (with a true period), then an exception should be raised by the method. 

As far as I understand, what you propose is way beyond the scope of this ticket. The simplification I wrote keep the ancient behavior (up to the fact that rationals are now treated as rationals).


---

Comment by vdelecroix created at 2017-04-07 06:55:20

Replying to [comment:17 jipilab]:
> I'm looking at the last commit and at line 488 of the constructor, I got puzzled a bit...
> 
> If you give a polyhedron with an `H`-representation and specified the `base_ring=ZZ`, then it would convert it automatically to `QQ`? What if the user is clever and knows that the `H`-representation that is given really describes a lattice polytope and would like to specify its parent to be Polyhedron_ZZ. So forcing the `base_ring` should be possible?

True! The constructor should not overwrite `base_ring` if it was set by the user. I will add a commit.


---

Comment by vdelecroix created at 2017-04-07 06:57:50

Replying to [comment:22 vdelecroix]:
> Replying to [comment:17 jipilab]:
> > I'm looking at the last commit and at line 488 of the constructor, I got puzzled a bit...
> > 
> > If you give a polyhedron with an `H`-representation and specified the `base_ring=ZZ`, then it would convert it automatically to `QQ`? What if the user is clever and knows that the `H`-representation that is given really describes a lattice polytope and would like to specify its parent to be Polyhedron_ZZ. So forcing the `base_ring` should be possible?
> 
> True! The constructor should not overwrite `base_ring` if it was set by the user. I will add a commit.

Where is this happening!? I don't see the code path that you are mentioning...


---

Comment by vdelecroix created at 2017-04-07 06:58:11

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2017-04-07 11:29:32

Replying to [comment:23 vdelecroix]:
> Replying to [comment:22 vdelecroix]:
> > Replying to [comment:17 jipilab]:
> > > I'm looking at the last commit and at line 488 of the constructor, I got puzzled a bit...
> > > 
> > > If you give a polyhedron with an `H`-representation and specified the `base_ring=ZZ`, then it would convert it automatically to `QQ`? What if the user is clever and knows that the `H`-representation that is given really describes a lattice polytope and would like to specify its parent to be Polyhedron_ZZ. So forcing the `base_ring` should be possible?
> > 
> > True! The constructor should not overwrite `base_ring` if it was set by the user. I will add a commit.
> 
> Where is this happening!? I don't see the code path that you are mentioning...

Sorry, got confused in reading the code and running an example in my head. If the user specified a `base_ring` it won't go where I thought it would because of the if, elif, else clause... So nevermind... my bad!


---

Comment by jipilab created at 2017-05-04 10:08:58

Oops, sorry. Didn't want to change the branch to do the rebase. My bad...

I'll change it back.
----
New commits:


---

Comment by git created at 2017-05-04 10:16:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-05-04 10:21:19

Tests passed on base.py and constructor.py with Sage-8.0.beta3.

The bots didn't have a look at this yet?!


---

Comment by vdelecroix created at 2017-05-04 10:34:34

The bots are not testing many things see https://github.com/sagemath/sage-patchbot/issues/76


---

Comment by vdelecroix created at 2017-05-04 10:35:34

(I just launched mine manually)


---

Comment by vdelecroix created at 2017-05-04 11:25:03

`.. TESTS:` should be `TESTS:` (no `.. `)


---

Comment by vdelecroix created at 2017-05-04 11:26:17

And in the doctest for float it would actually be good to also test `int` and `Fraction` (from the Python module fractions).


---

Comment by jipilab created at 2017-05-10 15:41:27

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2017-05-10 15:41:27

Some MIP's tests are broken by the code. I will look into this and correct the docstring too.


---

Comment by mforets created at 2017-06-30 09:22:12

Changing status from needs_work to needs_info.


---

Comment by mforets created at 2017-06-30 09:22:12

hi, 

i've adjusted the doctests in MIP and added the `int` construction test to JP's branch.

i had trouble with Python's `Fraction` though:


```
sage: from fractions import Fraction
sage: Polyhedron(vertices=[This is the Trac macro *Fraction* that was inherited from the migration called with arguments (int)](https://trac.sagemath.org/wiki/WikiMacros#Fraction-macro))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-27-199a9229f10f> in <module>()
----> 1 Polyhedron(vertices=[This is the Trac macro *Fraction* that was inherited from the migration called with arguments (int)](https://trac.sagemath.org/wiki/WikiMacros#Fraction-macro))

 
/Users/forets/sage-src/sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/constructor.pyc in Polyhedron(vertices, rays, lines, ieqs, eqns, ambient_dim, base_ring, minimi
ze, verbose, backend)
    497     # real numbers
    498     if base_ring not in Rings() or not RDF.has_coerce_map_from(base_ring):
--> 499         raise ValueError("invalid base ring")
    500
    501     # TODO: remove this hack
 
ValueError: invalid base ring
```


any ideas? 
----
New commits:


---

Comment by vdelecroix created at 2017-06-30 10:37:56

I think that those two functions should be fixed to work with `Fraction`

```
sage: from sage.structure.coerce import py_scalar_to_element, py_scalar_parent
sage: f = fractions.Fraction(2r, 3r)
sage: py_scalar_parent(type(f))    # should be QQ
sage: py_scalar_to_element(f)      # should be Rational
Fraction(2, 3)
```

(could be a dependency ticket)


---

Comment by vdelecroix created at 2017-06-30 14:25:28

see #23345


---

Comment by git created at 2017-07-08 11:40:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-07-12 08:51:54

Changing status from needs_info to needs_review.


---

Comment by jipilab created at 2017-07-12 08:51:54

Hi all,

I believe that the last issues have been addressed by Marcelo, so I set this to "needs review".

What is the error given by the bot? A time-out? Yet again, some unknown behavior to me.


---

Comment by vdelecroix created at 2017-07-13 17:32:42

Two problems from the doctest need to be fixed

```
$ sage -t geometry/polyhedron/constructor.py
Running doctests with ID 2017-07-13-19-29-08-cb0892b4.
Git branch: 22605-8.0.rc1
Using --optional=bliss,lrslib,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t --warn-long 75.0 geometry/polyhedron/constructor.py
**********************************************************************
File "geometry/polyhedron/constructor.py", line 443, in sage.geometry.polyhedron.constructor.?
Failed example:
    Polyhedron(vertices=[This is the Trac macro *f* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#f-macro))
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: invalid base ring
**********************************************************************
1 item had failures:
   1 of  27 in sage.geometry.polyhedron.constructor.?
    [59 tests, 1 failure, 0.55 s]
----------------------------------------------------------------------
sage -t --warn-long 75.0 geometry/polyhedron/constructor.py  # 1 doctest failed
----------------------------------------------------------------------
```


```
$ sage -t categories/finite_coxeter_groups.py
Running doctests with ID 2017-07-13-19-30-14-e608e41e.
Git branch: 22605-8.0.rc1
Using --optional=bliss,lrslib,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t --warn-long 75.0 categories/finite_coxeter_groups.py
**********************************************************************
File "categories/finite_coxeter_groups.py", line 720, in sage.categories.finite_coxeter_groups.FiniteCoxeterGroups.ParentMethods.permutahedron
Failed example:
    W.permutahedron()
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: invalid base ring
**********************************************************************
1 item had failures:
   1 of   6 in sage.categories.finite_coxeter_groups.FiniteCoxeterGroups.ParentMethods.permutahedron
    [151 tests, 1 failure, 5.21 s]
----------------------------------------------------------------------
sage -t --warn-long 75.0 categories/finite_coxeter_groups.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vdelecroix created at 2017-07-13 17:32:42

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-07-13 17:40:23

The following comment in the test block `Check that giving ``float`` and ``int`` input gets converted to `\RDF`` should be modified since int are converted to elements of ZZ and not RDF. Furthermore, replace ``\RDF`` by ```RDF```.


---

Comment by git created at 2017-07-23 19:25:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-07-23 19:42:30

- comment:42, doctest in `constructor.py`, done (upon merging with #23345)
- comment:42, doctest in `finite_coxeter_groups.py` : i'm confused. the UniversalCyclotomicField should still be supported in the constructor, right? in this case:

    - the base ring is `UniversalCyclotomicField()`, and `base_ring not in Rings()` is False
    - `RDF.has_coerce_map_from(UniversalCyclotomicField())` is also False
- comment:43, done


---

Comment by vdelecroix created at 2017-07-23 21:08:42

The universal cyclotomic field is the *complex* field generated by all roots of unity! We don't want to deal with that in polyhedron constructor (as we don't for `QQbar`). For both `QQbar` and `UCF` we can either try conversion to `AA` or raise an error. Which one do you prefer?


---

Comment by mforets created at 2017-07-25 14:38:59

Replying to [comment:46 vdelecroix]:
> The universal cyclotomic field is the *complex* field generated by all roots of unity! We don't want to deal with that in polyhedron constructor (as we don't for `QQbar`). For both `QQbar` and `UCF` we can either try conversion to `AA` or raise an error. Which one do you prefer?

Ok, thanks for the clarification. i look forward to suggestions on that choice (since i don't have one).


---

Comment by vdelecroix created at 2017-07-25 14:43:11

Replying to [comment:47 mforets]:
> Replying to [comment:46 vdelecroix]:
> > The universal cyclotomic field is the *complex* field generated by all roots of unity! We don't want to deal with that in polyhedron constructor (as we don't for `QQbar`). For both `QQbar` and `UCF` we can either try conversion to `AA` or raise an error. Which one do you prefer?
> 
> Ok, thanks for the clarification. i look forward to suggestions on that choice (since i don't have one).

I think an error is safer. The code in Coxeter group that constructs the polytope should call `Polyhedron` with an appropriate base ring (like `AA` or `QQ[cos(pi/q)]`).


---

Comment by vdelecroix created at 2017-07-25 14:50:31

The following does work

```
sage: W = CoxeterGroup(['I',7])
sage: n = W.one().canonical_matrix().rank()
sage: weights = W.fundamental_weights()
sage: point = [ZZ.one()] * n
sage: v = sum(point[i-1] * weights[i] for i in weights.keys())
sage: vertices = [(v*w).change_ring(AA) for w in W]
sage: Polyhedron(vertices)
```

It is perhaps not optimal, but fixes the issue with Coxeter groups.


---

Comment by git created at 2017-07-25 16:48:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-07-25 16:49:53

Changing status from needs_work to needs_review.


---

Comment by mforets created at 2017-07-25 16:55:25

disclaimer: i didn't run those tests which require the optional GAP3 package 'chevie'. if someone has it installed already, could you try it please?


---

Comment by vdelecroix created at 2017-07-26 07:53:42

Replying to [comment:52 mforets]:
> disclaimer: i didn't run those tests which require the optional GAP3 package 'chevie'. if someone has it installed already, could you try it please? 

Travis: After this ticket, it will be forbidden to use `UCF` and `QQbar` as ground fields for polytopes. I believe that you have GAP3 installed. Could you check that we do not break anything for generating the polyhedra related to Coxeter groups?


---

Comment by mforets created at 2017-07-26 08:59:20

i was getting:


```
sage: W = ReflectionGroup(['A',3])
...
ImportError: the GAP3 package 'chevie' is needed to work with (complex) reflection groups
sage: is_package_installed("gap3")
False
```


and got scared with the message below.. but installing turned out to be very fast!


```
=========================== WARNING ===========================
You are about to download and install the experimental package
gap3-01may17.  This probably won't work at all for you! There
is no guarantee that it will build correctly, or behave as
expected. Use at your own risk!
===============================================================
...
```


anyway, testing with `--optional=gap3` flag i do find problems. those tests with the `ReflectionGroup` and integer base ring were failing. 

in the new commit, i'm 'hardcoding' the base ring that is passed to the constructor to be QQ in those cases (before, this was guessed from the vertices). what do you think?


---

Comment by git created at 2017-07-26 09:01:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-07-26 09:31:53

with respect to the tests, it also works to infer the base ring from the sum over weights v, that is:


```
if base_ring is None:
    base_ring = v.base_ring()
```


instead of


```
if base_ring is None:
    base_ring = self.base_ring()
    if base_ring is ZZ:
        base_ring = QQ
```



---

Comment by vdelecroix created at 2017-07-26 12:54:59

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-07-26 12:54:59

`@`Marcelo: this beahvior is bad

```
sage: W = CoxeterGroup(['I',7])
sage: W.permutahedron(base_ring=QQbar).base_ring() is QQbar
False
```

If the user supplies explicitely a `base_ring` in the method `permutahedron()` then it should be used. The above example should be an error (that would be raised by the polyhedron constructor). The automatic conversion `QQbar -> AA` and `UCF -> AA` should only be done when the user calls `permutahedron()` without specifying the base ring.


---

Comment by git created at 2017-07-26 18:22:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-07-26 18:22:47

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-07-27 10:10:41

Here

```
+            if base_ring is None and v.base_ring() in [UniversalCyclotomicField(), QQbar]:
+                    vertices = [(v*w).change_ring(AA) for w in self]
```

you have an identation with 8 spaces!


---

Comment by vdelecroix created at 2017-07-27 10:12:24

And concerning the same piece of code, it would be simpler to do

```
vertices = [v*w for w in self]
if base_ring is None and v.base_ring() in [UniversalCyclotomicField(), QQbar]:
    vertices = [v.change_ring(AA) for v in vertices]
    base_ring = AA
```



---

Comment by git created at 2017-07-27 11:09:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-07-27 11:13:02

Replying to [comment:62 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[af03de8](https://git.sagemath.org/sage.git/commit/?id=af03de82ed07686322db70895a0ab34973888981)||`fix indentation issue, and simplify`||

`@`vdelec: you're right, thanks.


---

Comment by vdelecroix created at 2017-07-27 13:19:40

This is a great improvement! Thank you!


---

Comment by vdelecroix created at 2017-07-27 13:19:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-29 15:30:57

Resolution: fixed
