# Issue 17421: Incorrect densification of polynomial matrix

Issue created by migration from Trac.

Original creator: gagern

Original creation time: 2015-01-22 12:42:01

I found this strange bug, trying to turn a sparse matrix into a dense one.


```
sage: R1.<a,b> = QQ[]
sage: R2.<c,d> = R1[]
sage: p = a*c+b*d
sage: d = dict(zip([i.degrees() for i in p.monomials()], p.coefficients()))
sage: m = matrix(R1, 2, 2, d)
sage: m
[0 b]
[a 0]
sage: m.dense_matrix()
[0 0]
[0 0]
```


For some reason the source of the matrix entries seems to play a role here as well: if I simply type in the dict `d` directly, the result works as expected. So I'm not at all sure what actual component is to blame for this behavior. Omitting the two levels of polynomials, and using QQ for the coefficients, doesn't exhibit this problem either.

Since this can lead to silent wrong answers, I consider this a critical problem.


---

Comment by pbruin created at 2015-01-22 14:35:44

I wonder if there could be any link with #17527.


---

Comment by gagern created at 2015-01-22 15:51:42

Replying to [comment:1 pbruin]:
> I wonder if there could be any link with #17527.

I doubt it. `loads(dumps(m))` works in my case. One thing which appears to be a factor here is the fact that `i.degrees()` returns an `ETuple`.


```
sage: R1.<a,b> = QQ[]
sage: m = matrix({ETuple((0, 1)): b, ETuple((1, 0)): a})
sage: m.dense_matrix()
[0 0]
[0 0]
```


But the underlying ring plays a role as well. Particularly, `Matrix_generic_sparse` seems to be affected while `Matrix_integer_sparse` or `Matrix_modn_sparse` are not. Other things which are handled by the generic implementation suffer as well:


```
sage: matrix(GF(5^2,"z"),{ETuple((1, 1)): 2}).dense_matrix()
[0 0]
[0 0]
```



---

Comment by gagern created at 2015-01-22 16:27:32

Found the problem: ETuple won't convert to regular tuple, and won't have the same hash either. For this reason, we should make sure that our dict keys are regular tuples. Preferably of Python integers.

I left the doctest with the method I used to observe this problem. If you would prefer it in the module-level docstring of the `matrix_generic_sparse.pyx` file, feel free to move it there or tell me that I should move it. If you have some other place to suggest, let me know.
----
New commits:


---

Comment by gagern created at 2015-01-22 16:27:40

Changing status from new to needs_review.


---

Comment by gagern created at 2015-01-22 16:28:55

Replying to [comment:1 pbruin]:
> I wonder if there could be any link with #17527.

Not fixed by my fix, so not related.


---

Comment by vdelecroix created at 2015-01-22 23:17:01

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-01-22 23:17:01

follow up: #17663


---

Comment by vbraun created at 2015-01-23 23:40:58

Resolution: fixed
