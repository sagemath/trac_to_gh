# Issue 17421: Incorrect densification of polynomial matrix

archive/issues_017421.json:
```json
{
    "body": "I found this strange bug, trying to turn a sparse matrix into a dense one.\n\n\n```\nsage: R1.<a,b> = QQ[]\nsage: R2.<c,d> = R1[]\nsage: p = a*c+b*d\nsage: d = dict(zip([i.degrees() for i in p.monomials()], p.coefficients()))\nsage: m = matrix(R1, 2, 2, d)\nsage: m\n[0 b]\n[a 0]\nsage: m.dense_matrix()\n[0 0]\n[0 0]\n```\n\n\nFor some reason the source of the matrix entries seems to play a role here as well: if I simply type in the dict `d` directly, the result works as expected. So I'm not at all sure what actual component is to blame for this behavior. Omitting the two levels of polynomials, and using QQ for the coefficients, doesn't exhibit this problem either.\n\nSince this can lead to silent wrong answers, I consider this a critical problem.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17658\n\n",
    "created_at": "2015-01-22T12:42:01Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "title": "Incorrect densification of polynomial matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17421",
    "user": "gagern"
}
```
I found this strange bug, trying to turn a sparse matrix into a dense one.


```
sage: R1.<a,b> = QQ[]
sage: R2.<c,d> = R1[]
sage: p = a*c+b*d
sage: d = dict(zip([i.degrees() for i in p.monomials()], p.coefficients()))
sage: m = matrix(R1, 2, 2, d)
sage: m
[0 b]
[a 0]
sage: m.dense_matrix()
[0 0]
[0 0]
```


For some reason the source of the matrix entries seems to play a role here as well: if I simply type in the dict `d` directly, the result works as expected. So I'm not at all sure what actual component is to blame for this behavior. Omitting the two levels of polynomials, and using QQ for the coefficients, doesn't exhibit this problem either.

Since this can lead to silent wrong answers, I consider this a critical problem.

Issue created by migration from https://trac.sagemath.org/ticket/17658





---

archive/issue_comments_232589.json:
```json
{
    "body": "I wonder if there could be any link with #17527.",
    "created_at": "2015-01-22T14:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232589",
    "user": "pbruin"
}
```

I wonder if there could be any link with #17527.



---

archive/issue_comments_232590.json:
```json
{
    "body": "Replying to [comment:1 pbruin]:\n> I wonder if there could be any link with #17527.\n\nI doubt it. `loads(dumps(m))` works in my case. One thing which appears to be a factor here is the fact that `i.degrees()` returns an `ETuple`.\n\n\n```\nsage: R1.<a,b> = QQ[]\nsage: m = matrix({ETuple((0, 1)): b, ETuple((1, 0)): a})\nsage: m.dense_matrix()\n[0 0]\n[0 0]\n```\n\n\nBut the underlying ring plays a role as well. Particularly, `Matrix_generic_sparse` seems to be affected while `Matrix_integer_sparse` or `Matrix_modn_sparse` are not. Other things which are handled by the generic implementation suffer as well:\n\n\n```\nsage: matrix(GF(5^2,\"z\"),{ETuple((1, 1)): 2}).dense_matrix()\n[0 0]\n[0 0]\n```\n",
    "created_at": "2015-01-22T15:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232590",
    "user": "gagern"
}
```

Replying to [comment:1 pbruin]:
> I wonder if there could be any link with #17527.

I doubt it. `loads(dumps(m))` works in my case. One thing which appears to be a factor here is the fact that `i.degrees()` returns an `ETuple`.


```
sage: R1.<a,b> = QQ[]
sage: m = matrix({ETuple((0, 1)): b, ETuple((1, 0)): a})
sage: m.dense_matrix()
[0 0]
[0 0]
```


But the underlying ring plays a role as well. Particularly, `Matrix_generic_sparse` seems to be affected while `Matrix_integer_sparse` or `Matrix_modn_sparse` are not. Other things which are handled by the generic implementation suffer as well:


```
sage: matrix(GF(5^2,"z"),{ETuple((1, 1)): 2}).dense_matrix()
[0 0]
[0 0]
```




---

archive/issue_comments_232591.json:
```json
{
    "body": "Found the problem: ETuple won't convert to regular tuple, and won't have the same hash either. For this reason, we should make sure that our dict keys are regular tuples. Preferably of Python integers.\n\nI left the doctest with the method I used to observe this problem. If you would prefer it in the module-level docstring of the `matrix_generic_sparse.pyx` file, feel free to move it there or tell me that I should move it. If you have some other place to suggest, let me know.\n----\nNew commits:",
    "created_at": "2015-01-22T16:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232591",
    "user": "gagern"
}
```

Found the problem: ETuple won't convert to regular tuple, and won't have the same hash either. For this reason, we should make sure that our dict keys are regular tuples. Preferably of Python integers.

I left the doctest with the method I used to observe this problem. If you would prefer it in the module-level docstring of the `matrix_generic_sparse.pyx` file, feel free to move it there or tell me that I should move it. If you have some other place to suggest, let me know.
----
New commits:



---

archive/issue_comments_232592.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-22T16:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232592",
    "user": "gagern"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_232593.json:
```json
{
    "body": "Replying to [comment:1 pbruin]:\n> I wonder if there could be any link with #17527.\n\nNot fixed by my fix, so not related.",
    "created_at": "2015-01-22T16:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232593",
    "user": "gagern"
}
```

Replying to [comment:1 pbruin]:
> I wonder if there could be any link with #17527.

Not fixed by my fix, so not related.



---

archive/issue_comments_232594.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-22T23:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232594",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_232595.json:
```json
{
    "body": "follow up: #17663",
    "created_at": "2015-01-22T23:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232595",
    "user": "vdelecroix"
}
```

follow up: #17663



---

archive/issue_comments_232596.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-23T23:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17421#issuecomment-232596",
    "user": "vbraun"
}
```

Resolution: fixed
