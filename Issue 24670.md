# Issue 24670: GCC is installed multiple times

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-03-06 10:17:16

CC:  embray

#24599 introduced an import regression: GCC is installed multiple times:

```
jdemeyer`@`sardonis:~/sage-gcc$ grep 'Setting up build directory for gcc' logs/install.log 
[gcc-7.2.0] Setting up build directory for gcc-7.2.0
[gcc-7.2.0] Setting up build directory for gcc-7.2.0
[gcc-7.2.0] Setting up build directory for gcc-7.2.0
```



---

Comment by jdemeyer created at 2018-03-08 09:17:23

New commits:


---

Comment by jdemeyer created at 2018-03-08 09:17:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2018-03-09 04:32:10


```
+            rm -f "$SAGE_LOCAL"/gcc
+            rm -f "$SAGE_LOCAL"/g++
```

Do you mean `"$SAGE_LOCAL"/bin/gcc` etc. here? And what does it mean to "pretend" that it is not installed?


---

Comment by jdemeyer created at 2018-03-09 06:37:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-09 09:27:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-09 09:43:51

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2018-03-10 00:35:57

This looks fine to me but I don't fully understand the details of how gcc and its dependencies are installed in sage, so someone else should finish the review of this ticket.


---

Comment by vbraun created at 2018-03-13 23:26:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-03-16 22:28:35

This wasn't the cause for the breakage in ppl/givaro noted at #24703#comment:17, various 32-bit buildbots are still borked


---

Comment by vbraun created at 2018-03-16 22:36:01

In fact mpir isn't built a second time, there is only the first build which does disable the c++ interface:

```
buildbot`@`sagebd07_32s02:~/slave/sage_git/build$ grep -B 1 able-cxx logs/pkgs/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.log 
Configuring MPIR with the following options:
    --prefix="/home/buildbot/slave/sage_git/build/local" --libdir="/home/buildbot/slave/sage_git/build/local/lib" --enable-gmpcompat --enable-shared  --disable-cxx --disable-static
```



---

Comment by vbraun created at 2018-03-16 22:37:09

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-03-16 22:37:54

It does fix the building-gcc-twice bug tho; but maybe the remaining toolchain dependencies coud be fixed here as well?


---

Comment by jdemeyer created at 2018-03-17 07:21:19

If you insist... but one could also consider that an independent bug.


---

Comment by jdemeyer created at 2018-03-17 07:35:24

Replying to [comment:10 vbraun]:
> In fact mpir isn't built a second time, there is only the first build which does disable the c++ interface:

I think that might have been broken in #21524.


---

Comment by git created at 2018-03-17 08:50:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-17 08:50:34

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2018-03-19 07:57:37

Resolution: fixed


---

Comment by embray created at 2018-03-19 11:20:03

I didn't even get to see this before it was closed as "fixed", but I must insist that in the future `./configure` should not be doing weird things that modify `$SAGE_LOCAL`.

Instead this should change something about how the makefile works...


---

Comment by embray created at 2018-03-19 11:29:10

What's a reliable way to reproduce this, so that I can try out a different fix?  Is it just to install Sage's gcc package, and then what?  Why would the gcc in Sage be broken?


---

Comment by jdemeyer created at 2018-03-19 12:33:35

Replying to [comment:19 embray]:
> What's a reliable way to reproduce this

Revert this commit and build Sage with `SAGE_INSTALL_GCC=yes`. It should only build GCC once.

> Why would the gcc in Sage be broken?

Because the libraries it depends on are upgraded, see #24599.


---

Comment by embray created at 2018-03-20 15:41:01

I still cannot figure out an exact sequence of steps to reproduce this on 8.2.beta8.  I install GCC, then I install giac, then I `./sage -f gcc`?  Seems to work...  Should I go back to an older version?


---

Comment by jdemeyer created at 2018-03-20 20:53:32

Replying to [comment:21 embray]:
> I still cannot figure out an exact sequence of steps to reproduce this

What is "this"? #24907 or #24599?


---

Comment by embray created at 2018-03-21 09:46:54

Both, really.  I can't reproduce #24907 (this ticket, hence "this").  But I don't know how to reproduce it without reproducing #24599 which I also can't do (but maybe I have to go back to an older version to do that).
