# Issue 30727: partial flake8 cleanup for repl/

Issue created by migration from https://trac.sagemath.org/ticket/30964

Original creator: chapoton

Original creation time: 2020-11-25 18:28:58

CC:  tscrim slelievre

as a general cleaning procedure.


---

Comment by chapoton created at 2020-11-25 18:29:31

New commits:


---

Comment by chapoton created at 2020-11-25 18:29:31

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-11-27 17:21:10

ok, bot is morally green, please review


---

Comment by slelievre created at 2020-11-28 09:05:03

Below some "since-we-are-editing-these-lines" optional changes.

Clearly out of scope for this reformatting ticket,
so feel free to make them or not.

With all or some or none of these in,
you can set to `positive_review` on my behalf.

Optionally fix these comments:


```diff
-# TODO: This global variable do_preparse should be associated with an
+# TODO: This global variable _do_preparse should be associated with an
 # IPython InteractiveShell as opposed to a global variable in this
 # module.
 _do_preparse = True
```



```diff
-    If the file is not a Cython, Python, or a Sage file, a ``ValueError``
+    If the file is not a Cython, Python, or Sage file, a ``ValueError``
```



```diff
-    # Note: On Python 3 b64encode only accepts bytes, and returns bytes (yet
-    # b64decode does accept str, but always returns bytes)
+    # Note: In Python 3, b64encode only accepts bytes, and returns bytes.
     b64 = base64.b64encode(str_to_bytes(filename, FS_ENCODING,
                                         "surrogateescape"))
     return 'sage.repl.load.load(sage.repl.load.base64.b64decode("{}"),globals(),{})'.format(bytes_to_str(b64, 'ascii'), attach)
```


Optionally split a long line and pep8 its output:


```diff
-    return 'sage.repl.load.load(sage.repl.load.base64.b64decode("{}"),globals(),{})'.format(bytes_to_str(b64, 'ascii'), attach)
+    return ('sage.repl.load.load(sage.repl.load.base64.b64decode'
+            '("{}"), globals(), {})'.format(bytes_to_str(b64, 'ascii'), attach))
```


Optionally shrink two lines into one
(unless it decreases readability):


```diff
-        i = s.find('\n')
-        s = s[i + 1:]
+        s = s[s.find('\n') + 1:]
```



---

Comment by git created at 2020-11-28 10:11:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-11-28 12:55:53

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2020-11-28 13:13:10

Regarding the two flake8 complaints of patchbots.

One says

```
src/sage/repl/interface_magic.py:127:21 undefined name 'get_ipython'
```

but that seems unrelated to the changes here.

One says

```
src/sage/repl/interpreter.py:788:13 'line_profiler' imported but unused
```

but that is as intended: it is imported
in a try-except-else, only to ascertain
and record whether it is available:

```
        # Load the %lprun extension if available
        try:
            import line_profiler
        except ImportError:
            pass
        else:
            self.extensions.append('line_profiler')
```



---

Comment by git created at 2020-12-06 21:02:59

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-12-06 21:02:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by chapoton created at 2020-12-06 21:04:17

after trivial rebase, setting back to positive


---

Comment by chapoton created at 2020-12-06 21:04:17

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-12-07 01:35:12

Ouch that hurts

```
 * python3_8: running distutils-r1_run_phase python_compile_all
Traceback (most recent call last):
  File "sage_setup/docbuild/__main__.py", line 1, in <module>
    from sage_setup.docbuild import main
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/sage_setup/docbuild/__init__.py", line 57, in <module>
    import sage.all
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/all.py", line 131, in <module>
    from sage.misc.all       import *         # takes a while
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/misc/all.py", line 30, in <module>
    from .html import html
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/misc/html.py", line 19, in <module>
    from sage.misc.latex import latex
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/misc/latex.py", line 28, in <module>
    from sage.misc import sage_eval
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/misc/sage_eval.py", line 14, in <module>
    import sage.repl.preparse as preparser
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_8/build/lib/sage/repl/preparse.py", line 1924
    <<<<<<< HEAD
```

Someone left out git stuff from a merge in `sage/repl/preparse.py`.


---

Comment by fbissey created at 2020-12-07 01:35:12

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2020-12-07 01:37:32

Here
https://github.com/vbraun/sage/commit/b48b1f9d61ea2c774cb11a38c53a5b707e8ec00f#diff-cc58fbd2c68d139a07abf71362b887c37b055a649591e523ecb1bdff1b894cdeR1924
and quite possibly there too
https://github.com/vbraun/sage/commit/b48b1f9d61ea2c774cb11a38c53a5b707e8ec00f#diff-cc58fbd2c68d139a07abf71362b887c37b055a649591e523ecb1bdff1b894cdeR1924


---

Comment by fbissey created at 2020-12-07 01:40:24

Didn't work like I was expecting. Ignore the last comment. So we have one thing at
https://github.com/vbraun/sage/blob/b48b1f9d61ea2c774cb11a38c53a5b707e8ec00f/src/sage/repl/preparse.py#L1924

and it looks like another at
https://github.com/vbraun/sage/blob/b48b1f9d61ea2c774cb11a38c53a5b707e8ec00f/src/sage/repl/preparse.py#L1963


---

Comment by vbraun created at 2020-12-07 23:38:07

There are some merge conflict markers checked in %-)


---

Comment by git created at 2020-12-08 08:07:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2020-12-08 08:07:48

ok, sorry. Here is a clean new branch


---

Comment by chapoton created at 2020-12-08 08:07:48

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-12-11 08:39:56

please review


---

Comment by fbissey created at 2020-12-11 08:41:40

Looks clean. Back to positive.


---

Comment by fbissey created at 2020-12-11 08:41:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-12-13 20:41:53

merge conflict


---

Comment by vbraun created at 2020-12-13 20:41:53

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-12-15 10:10:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-12-15 10:10:50

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2020-12-15 10:10:50

after trivial rebase, setting back to positive


---

Comment by vbraun created at 2020-12-27 00:22:37

Resolution: fixed
