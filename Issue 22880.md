# Issue 22880: Set up embeddings for extensions created using the syntax R[alg]

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2017-05-31 17:23:33

CC:  zimmerma

This fixes in particular the following issue, found thanks to a question
of Paul Zimmermann:

```
sage: QQ[I](I.pyobject())
...
TypeError: No compatible natural embeddings found for Number Field in I
with defining polynomial x^2 + 1 and Complex Lazy Field
```

Also fix the conversion of elements of ℚ[i] to CIF to correctly take into account the choice of embedding.


---

Comment by mmezzarobba created at 2017-05-31 17:28:13

(branch not fully tested yet)
----
New commits:


---

Comment by git created at 2017-06-02 12:22:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2017-06-02 12:23:46

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-06-03 00:20:40

Some comments:

- I don't see the point of the internal `embedding` function. IMO, it makes things more complicated.
- This is ugly:
  {{{#!diff
diff --git a/src/sage/algebras/group_algebra.py b/src/sage/algebras/group_algebra.py
index d275ee1..f1aa4ff 100644
--- a/src/sage/algebras/group_algebra.py
+++ b/src/sage/algebras/group_algebra.py
`@``@` -691,7 +691,7 `@``@` class GroupAlgebra(CombinatorialFreeModule):
             ...
             TypeError: Attempt to coerce non-integral RealNumber to Integer
             sage: OG(OG.base_ring().basis()[1])
-            sqrt5*[1 0]
+            -(-sqrt5)*[1 0]
             [0 1]
         """
         from sage.rings.ring import is_Ring
  }}}
  but it might be an necessary evil.

Otherwise everything seems to be good.


---

Comment by git created at 2017-06-03 02:04:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2017-06-03 02:10:23

Thanks for your comments!

Replying to [comment:4 tscrim]:
> - I don't see the point of the internal `embedding` function. IMO, it makes things more complicated.

Having an internal function makes it easy to exit at any point of the chain of `try`s using `return`, that's all.

> - This is ugly: [...]
>   but it might be an necessary evil.

That's what I thought, but I had another look thanks to your comment, and it turns out it was a weakness in my code (or perhaps in `NumberField`/`NumberFieldElement_quadratic`, which are not clever enough to recognize the standard embedding of a real number field when given as an embedding into ℂ).


---

Comment by tscrim created at 2017-06-03 05:53:44

Replying to [comment:6 mmezzarobba]:
> Thanks for your comments!
> 
> Replying to [comment:4 tscrim]:
> > - I don't see the point of the internal `embedding` function. IMO, it makes things more complicated.
> 
> Having an internal function makes it easy to exit at any point of the chain of `try`s using `return`, that's all.

At least right now you don't really have a chain (and your current order is suboptimal when it fails for `CIF`). I would just do

```python
from sage.rings.all import CIF, CLF, RIF, RLF
try:
    iv = CIF(elt)
except (TypeError, ValueError):
    emb = None
else:
    try:
        RIF(elt) # There is a better check for realness, correct?
        LF = RLF
    except (TypeError, ValueError):
        LF = CLF
    # First try creating an ANRoot manually, because extension(...,
    # embedding=CLF(expr)) (or ...QQbar(expr)) would normalize the
    # expression in QQbar, which currently is VERY slow in many
    # cases. This may fail when minpoly has close roots or elt is a
    # complicated symbolic expression.
    # TODO: Rewrite using #19362 and/or #17886 and/or #15600 once
    # those issues are solved.
    from sage.rings.qqbar import AlgebraicNumber, ANRoot
    try:
        elt = AlgebraicNumber(ANRoot(minpoly, iv))
    except ValueError:
        pass
    emb = LF(elt)
```


> > - This is ugly: [...]
> >   but it might be an necessary evil.
> 
> That's what I thought, but I had another look thanks to your comment, and it turns out it was a weakness in my code (or perhaps in `NumberField`/`NumberFieldElement_quadratic`, which are not clever enough to recognize the standard embedding of a real number field when given as an embedding into ℂ).

So it is a necessary evil at present until another part of code is improved? Am I understanding your comment correctly?


---

Comment by git created at 2017-06-03 13:26:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-06-03 13:50:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2017-06-03 13:53:57

Replying to [comment:7 tscrim]:
> At least right now you don't really have a chain (and your current order is suboptimal when it fails for `CIF`). I would just do
> {{{#!python
> from sage.rings.all import CIF, CLF, RIF, RLF
> try:
>     iv = CIF(elt)
> except (TypeError, ValueError):
>     emb = None
> else:
>     ...
> }}}

Why not—I changed the implementation to something like that.

> {{{
>     try:
>         RIF(elt) # There is a better check for realness, correct?
> }}}

I don't know. I'm now testing

```
if iv.imag().is_zero() or iv.imag().contains_zero() and elt.imag().is_zero())
```

but I don't think it makes a significant difference.

> > That's what I thought, but I had another look thanks to your comment, and it turns out it was a weakness in my code (or perhaps in `NumberField`/`NumberFieldElement_quadratic`, which are not clever enough to recognize the standard embedding of a real number field when given as an embedding into ℂ).
> 
> So it is a necessary evil at present until another part of code is improved? Am I understanding your comment correctly?

No, sorry if I was not clear: it was a weakness of my initial implementation, fixed in a469c70 (itself now squashed into 742c8a4).


---

Comment by tscrim created at 2017-06-03 14:04:57

Thanks. LGTM.


---

Comment by tscrim created at 2017-06-03 14:04:57

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-06-06 08:55:24

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2017-06-06 08:55:24

Changing status from positive_review to needs_review.


---

Comment by mmezzarobba created at 2017-06-06 08:57:44

As it turns out, some of the doctest changes were no longer necessary (nor correct!) with the new version that sets up real embeddings when possible.


---

Comment by tscrim created at 2017-06-06 13:17:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-09 18:37:46

Resolution: fixed
