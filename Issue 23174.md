# Issue 23174: Fix pickling of matrix_gfpn_dense

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2017-07-12 14:19:25

There currently are two problems related with pickling of `Matrix_gfpn_dense`: 
- When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.
- The number of bytes used holding the data of a matrix row is machine independent. However, the number of bytes actually used to store the row always is a multiple of `sizeof(long)`, which is machine dependent (at least in theory). Pickling should of course only involve the machine independent memory chunks, but currently it involves the machine dependent chunks.


---

Comment by SimonKing created at 2017-07-12 15:09:05

Changing status from new to needs_review.


---

Comment by SimonKing created at 2017-07-12 15:09:05

New commits:


---

Comment by SimonKing created at 2017-07-12 15:12:48

Sorry, one commit is missing


---

Comment by SimonKing created at 2017-07-12 15:12:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-12 15:48:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-12 15:49:18

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-12 15:49:18

Now it builds and tests are passing...


---

Comment by jdemeyer created at 2017-07-13 09:50:20

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-13 09:50:20

1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.

2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.


---

Comment by SimonKing created at 2017-07-13 10:07:51

Replying to [comment:6 jdemeyer]:
> 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.

You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.

> 2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.

OK. Just to be on the safe side: You do not say that I should imitate a pickle string that results from a machine where, say, `sizeof(long)==3`? Cause otherwise we would never see the deprecation warning.


---

Comment by SimonKing created at 2017-07-13 10:12:29

Replying to [comment:7 SimonKing]:
> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.

PS: Adding such patch would also imply to modify the lines where I import the `PyString...` functions, which means that there will be further conflicts with #21437.


---

Comment by git created at 2017-07-13 11:20:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-13 11:24:41

In the latest commit, I add a test that should demonstrate machine independence of pickling (provided that the patchbots provide a whole lot of different architectures, including little and big endian and different sizes of `long`). I also add a test that triggers the deprecation warning.

I am not really happy about doing part of the code cleanup here. Would you accept to do all cleanup on a separate ticket. If you do, then please consider this ticket as "needs review".


---

Comment by SimonKing created at 2017-07-13 11:25:22

Setting it to "needs review" in order to allow the patchbots to test the ticket.


---

Comment by SimonKing created at 2017-07-13 11:25:22

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-07-13 12:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-13 12:40:01

Question: Will the buildbot automatically test with and without meataxe being installed? If not: How can I advice the buildbot to do so?


---

Comment by jdemeyer created at 2017-07-13 13:35:18

Replying to [comment:7 SimonKing]:
> Replying to [comment:6 jdemeyer]:
> > 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.
> 
> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.

It's just a bit strange that you write "unclean" code in one ticket and then at the same time have another ticket to clean it up.

But that's not a big deal since the old code also uses strings.


---

Comment by jdemeyer created at 2017-07-13 13:36:50

Also in some other ticket, I made the comment that you should use floor division (`//`) if that's what you want.


---

Comment by jdemeyer created at 2017-07-13 13:39:48

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-13 13:39:48

Please do not use the `for ... from ...` syntax. Cython understands `range()`.


---

Comment by jdemeyer created at 2017-07-13 13:47:29

When unpickling, it seems that there is no protecting against reading out of bounds. The case where `x` is too short should be handled gracefully. The code should be more like:

```
if len(Data) == expected_size:
    # Handle new-style pickle
elif len(Data) == expected_size_for_old_pickle:
    # Handle deprecated pickle
else:
    raise ValueError(f"expected a pickle with {expected_size} bytes, got {len(Data)} instead")
```

EDIT: note the swapped conditions. It is possible that `expected_size == expected_size_for_old_pickle`.

And a small detail: you write twice `x = PyString_AsString(Data)` while once (outside the branch) should be sufficient.


---

Comment by SimonKing created at 2017-07-13 14:02:41

Replying to [comment:14 jdemeyer]:
> It's just a bit strange that you write "unclean" code in one ticket and then at the same time have another ticket to clean it up.
> 
> But that's not a big deal since the old code also uses strings.

Right. And you spotted further problems with the code added by this ticket.

So, I guess it is better to clean the new code, although it will imply manual merging in other tickets.


---

Comment by jdemeyer created at 2017-07-13 14:30:36

If I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)


---

Comment by git created at 2017-07-13 14:38:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-13 14:39:33

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-13 14:44:04

Replying to [comment:19 jdemeyer]:
> If I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)

Hooray, it merges cleanly into #21437...

I guess I'll wait a while till I move on to #23400.


---

Comment by SimonKing created at 2017-07-13 14:45:21

PS: Perhaps it would have been better to *first* clean the existing code, and then do the bug fixes and additions. But I suppose I shouldn't change the order of tickets again, or should I?


---

Comment by jdemeyer created at 2017-07-13 14:57:25

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-13 14:57:25

This is a potential division by zero:

```
cdef size_t pickled_rowsize = lenData//nr
```

It would be good to add a doctest for the case `nr == 0`.

I think the best solution is to replace the condition `if Data` by `if nr`.


---

Comment by git created at 2017-07-15 11:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-15 11:48:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-15 11:50:02

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-17 08:38:49

Assertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.


---

Comment by jdemeyer created at 2017-07-17 08:38:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-17 08:40:42

It would be good to add doctests for _correct_ unpickling of matrices with zero rows or columns.


---

Comment by SimonKing created at 2017-07-17 08:42:27

Replying to [comment:28 jdemeyer]:
> Assertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.

OK. And I guess since I am touching some sub-optimal code here (using `PyString...`), it'd be better to clean this here, not in #23400


---

Comment by SimonKing created at 2017-07-17 08:43:38

Replying to [comment:29 jdemeyer]:
> It would be good to add doctests for _correct_ unpickling of matrices with zero rows or columns.

Do you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?


---

Comment by jdemeyer created at 2017-07-17 08:45:12

Replying to [comment:31 SimonKing]:
> Replying to [comment:29 jdemeyer]:
> > It would be good to add doctests for _correct_ unpickling of matrices with zero rows or columns.
> 
> Do you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?

I meant the latter.  Although an explicit call to `mtx_unpickle` with empty `Data` would be good also.


---

Comment by jdemeyer created at 2017-07-17 09:10:46

Replying to [ticket:23411 SimonKing]:
> - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.

I don't like your fix for this for several reasons:

1. I can't actually reproduce the issue. Without this patch, the doctest that you added passes. I think this is because the memory for Python objects is automatically initialized with all zeros.

2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.

3. A non-existing file should be an error, not something to be silently ignored.

4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.

From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.


---

Comment by git created at 2017-07-17 09:12:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 09:24:50

Replying to [comment:33 jdemeyer]:
> Replying to [ticket:23411 SimonKing]:
> > - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.
> 
> I don't like your fix for this for several reasons:
> 
> 1. I can't actually reproduce the issue.

Strange. has there been a recent change in Cython? If I recall correctly, reading from a non-existing file left the matrix in an undefined state. In particular, it was possible that the `self.Data` pointer was *not* NULL.

> 3. A non-existing file should be an error, not something to be silently ignored.

OK.
 
> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.
> 
> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.

If it is really the case that I can rely on `self.Data` being initialised to NULL, then I guess removing `__cinit__` is fine.


---

Comment by git created at 2017-07-17 09:55:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 09:59:19

Replying to [comment:33 jdemeyer]:
> Replying to [ticket:23411 SimonKing]:
> 2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.

That is the case, provided that `self.Data` is correctly initialised to NULL by cython.
 
> 3. A non-existing file should be an error, not something to be silently ignored.

Done. Now, an error raised by MeatAxe is propagated.

> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? 

No, one can simply catch the resulting error, if one likes...

> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.

Done. And the tests pass :)


---

Comment by SimonKing created at 2017-07-17 09:59:26

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-17 11:49:49

There is something wrong with the indentation here:

```
        5. Creating a matrix from a file in MeatAxe format. If the file doesn't exist,
            an error raised by the MeatAxe library is propagated::

            sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe
            Traceback (most recent call last):
            ...
            SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)
```

Correct indentation would be

```
        5.  Creating a matrix from a file in MeatAxe format. If the file doesn't exist,
            an error raised by the MeatAxe library is propagated::

                sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe
                Traceback (most recent call last):
                ...
                SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)
```

(note the double space after `5.` to make allow 4 spaces of indentation on the next line)


---

Comment by jdemeyer created at 2017-07-17 11:49:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-17 11:53:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 11:54:19

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-17 11:56:14

What is the purpose of

```
            if not parent:
                self._cache == {}
```


It seems that you want to allow `Matrix_gfpn_dense("")` to return an uninitialized matrix but I wonder why. If you _really_ want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.


---

Comment by jdemeyer created at 2017-07-17 11:59:05

Except for my last comment, this ticket is fine for me.


---

Comment by SimonKing created at 2017-07-17 12:01:17

Replying to [comment:42 jdemeyer]:
> What is the purpose of
> {{{
>             if not parent:
>                 self._cache == {}
> }}}
> 
> It seems that you want to allow `Matrix_gfpn_dense("")` to return an uninitialized matrix but I wonder why. If you _really_ want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.

I do use uninitialised meataxe matrices in some application (of course in my group cohomology package), namely when I want to create a `Matrix_gfpn_dense` from an existing `Matrix_t*`. But your suggestion makes perfect sense.


---

Comment by git created at 2017-07-17 12:04:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 12:04:47

Done!


---

Comment by jdemeyer created at 2017-07-17 12:18:26

Replying to [comment:44 SimonKing]:
> I do use uninitialised meataxe matrices in some application

I would argue that the _proper_ way to get an "uninitialised meataxe matrix" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.

This idiom of using `__new__` and then manually filling in a data structure is used a lot in Sage. For example, in the `numerator` method for rational numbers:

```
    def numerator(self):
        cdef Integer n = Integer.__new__(Integer)
        n.set_from_mpz(mpq_numref(self.value))
        return n
```



---

Comment by SimonKing created at 2017-07-17 12:26:33

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2017-07-17 12:26:33

Replying to [comment:47 jdemeyer]:
> I would argue that the _proper_ way to get an "uninitialised meataxe matrix" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.

Actually I just checked: I am using the `.__new__` thing in some part of my cohomology code, and in some other parts I'd really better do it as well. I suppose it should be removed.


---

Comment by SimonKing created at 2017-07-17 12:28:21

PS: Also note the statement in the docstring of `__init__`, where I say that the case `parent = None` is used for unpickling --- which is not true, as I am using `__new__` there as well!


---

Comment by git created at 2017-07-17 12:37:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-07-17 12:39:29

Avoid `six` in Cython files if possible! Please revert to `basestring`.


---

Comment by SimonKing created at 2017-07-17 12:42:56

Replying to [comment:51 jdemeyer]:
> Avoid `six` in Cython files if possible! Please revert to `basestring`.

Really? I thought this was needed to make things Python3 compliant. OK, I'll revert it.

Something else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change
`Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?


---

Comment by jdemeyer created at 2017-07-17 12:47:55

Replying to [comment:52 SimonKing]:
> I thought this was needed to make things Python3 compliant.

Yes, `six` is needed to make things Python 3 compliant.

However, Cython is a language by itself. Cython is not Python 2 and it's not Python 3. Cython tries to be compatible with Python 2 and Python 3. This makes porting Cython code to Python 3 much easier than porting Python code.

Of course, some Cython code is really just Python code and that code can depend on the Python version. And there are some incompatibilities that Cython cannot fix: support for `__cmp__` is gone in Python 3, there is nothing that Cython can do about that.


---

Comment by jdemeyer created at 2017-07-17 12:48:55

Replying to [comment:52 SimonKing]:
> Replying to [comment:51 jdemeyer]:
> > Avoid `six` in Cython files if possible! Please revert to `basestring`.
> 
> Really? I thought this was needed to make things Python3 compliant. OK, I'll revert it.
> 
> Something else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change
> `Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?

Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.


---

Comment by SimonKing created at 2017-07-17 12:52:30

Replying to [comment:54 jdemeyer]:
> Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.

If you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?

In any case, changing the function header of `MatLoad` should be done.


---

Comment by jdemeyer created at 2017-07-17 13:01:54

Replying to [comment:55 SimonKing]:
> Replying to [comment:54 jdemeyer]:
> > Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.
> 
> If you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?

But you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.


---

Comment by SimonKing created at 2017-07-17 13:50:11

Replying to [comment:56 jdemeyer]:
> But you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.

From my perspective, one could simply return an empty 0x0-matrix over an unspecified field in that special case. But if you prefer an error being raised (`ValueError("Received NULL pointer from initialisation of MeatAxe matrix")`, perhaps?), I can do that.


---

Comment by jdemeyer created at 2017-07-17 14:00:26

I consider it a bug that `MatLoad("")` returns `NULL` without an error. So we are just working around a MeatAxe bug here...


---

Comment by git created at 2017-07-17 14:11:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 14:11:54

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-25 09:58:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-25 09:58:57

As expected, this "machine dependent" doctest may fail depending on the machine:

```
        sage: t = 'Uq\x82\x00\x00\x00\x00\x00\xa7\x8bh\x00\x00\x00\x00\x00'
        sage: len(t)
        16
        sage: N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe
```



---

Comment by jdemeyer created at 2017-07-25 09:59:53

On a 32-bit system, this gives:

```
sage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx
**********************************************************************
File "src/sage/matrix/matrix_gfpn_dense.pyx", line 1635, in sage.matrix.matrix_gfpn_dense.mtx_unpickle
Failed example:
    N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe
Exception raised:
    Traceback (most recent call last):
      File "/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_gfpn_dense.mtx_unpickle[18]>", line 1, in <module>
        N == mtx_unpickle(MS, Integer(2), Integer(5), t, True)           # optional: meataxe
      File "sage/matrix/matrix_gfpn_dense.pyx", line 1712, in sage.matrix.matrix_gfpn_dense.mtx_unpickle (/home/jdemeyer/sage-git/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:14936)
        raise ValueError(f"Expected a pickle with {FfCurrentRowSizeIo}*{nr} bytes per row, got {lenData} instead")
    ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead
**********************************************************************
```



---

Comment by SimonKing created at 2017-07-25 12:19:15

Replying to [comment:62 jdemeyer]:
> On a 32-bit system, this gives:
> {{{
> sage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx
> ...
>     ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead
> **********************************************************************
> }}}

Thank you for testing on different architectures!

So, what shall we do with that test?
- On the one hand, that test is about a pickling format that is known to be machine dependent and is therefore deprecated. That's an argument for removing it (which I would like to avoid).
- On the other hand, I could try to do better and make unpickling work in that case as well.

I think I prefer the second way.


---

Comment by git created at 2017-07-25 12:50:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-25 12:52:45

Done! And I demonstrate that a deprecated pickle can be opened even if it was created on a silly machine with `sizeof(long)==9`.


---

Comment by SimonKing created at 2017-07-25 12:52:45

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-25 14:44:06

Cool test! Now, we are still missing a doctest for the `else` case, when `elif pickled_rowsize < FfCurrentRowSizeIo`


---

Comment by jdemeyer created at 2017-07-25 14:44:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-26 11:45:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-26 11:47:12

Done!

There is now one test where the number of bytes is not divisible by the number of rows and one test where the number is divisible but too small to contain a matrix of the given dimensions. Together with the existing tests, I think it covers all code paths.
----
New commits:


---

Comment by SimonKing created at 2017-07-26 11:47:12

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-27 09:26:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-29 15:30:47

Resolution: fixed
