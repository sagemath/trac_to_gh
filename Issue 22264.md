# Issue 22264: Make it easier to customize pexpect interfaces

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2017-03-02 18:47:40

Keywords: pexpect

While working on #22452, I found a couple of issues that might be dealt with in a separate ticket.

- Currently, it is assumed that equality test is done by evaluating the line
  {{{
"%s %s %s"%(var1, self._equality_symbol(), var2)
  }}}
  where `self` is a pexpect interface. However, there is software doing comparison by a prefix rather than an infix operator.

  __Suggestion__

  Let `_equality_symbol` be a format string, so that comparison will in future be done by evaluating
  {{{
self._equality_symbol().format(var1, var2)
  }}}
- It is not always the case that `self.eval(var)` returns a non-empty string. However, in some places in `sage.interfaces`, it is expected that it returns a string representation, provided that `var` corresponds to an integer or a boolean. However, this assumption does NOT hold for Polymake!

  __Suggestion__

  Introduce a method `self._get_primitive` that defaults to `self.eval` but can be overridden for interfaces in which an explicit print statement is needed to get the string representation of an integer.
- The pexpect interfaces and the interface elements inherit from `Parent` resp. from `Element`. But they override `__repr__`, which is bad.

  __Suggestion__

  Change `__repr__` into single underscore methods in all interfaces.
- The methods `_pre_interact` and `_post_interact` are defined in sage.interfaces.interface and overridden in sage.interfaces.gap, and there is also a method `call` defined in sage.interfaces.interface. However it seems that none of the three is used anywhere.

  __Suggestion__

  Remove them (without deprecation?).


---

Comment by SimonKing created at 2017-03-02 18:48:18

There is one more thing. The methods `_left_list_delim`, `_right_func_delim` and similar are currently only used to make the string representation of an interface element a bit more similar to Python. However, it is conceivable that they could be used in a nice default implementation of `__getitem__` - but I am not sure if such a default implementation would really be of wide use.


---

Comment by SimonKing created at 2017-03-02 18:50:43

Changing keywords from "pexpect" to "pexpect, days84".


---

Comment by SimonKing created at 2017-03-02 19:04:14

The first commit implements and uses `_get_primitive`. Next, I'll add tests.
----
New commits:


---

Comment by git created at 2017-03-02 19:17:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-03 00:07:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 00:11:43

I have now also sanitised string representation of pexpect elements. "Sanitise" means: There is a default `__repr__` method that is not supposed to be overridden, and if anything needs to be overridden then it is the single underscore `_repr_`. The change mainly consisted how invalid objects are printed.

Since I am not particularly eager to remove the superfluous functions mentioned in the ticket description, I'll let this be "needs review" --- now I have the prerequisites for #22452.
----
New commits:


---

Comment by SimonKing created at 2017-03-03 00:13:07

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-03 09:07:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-03 09:07:26

I don't think that you should remove doctests.

If you remove a method which is no longer needed, then move the doctests somewhere else (say, at the top of the module if you don't see a better place) instead of removing them.


---

Comment by jdemeyer created at 2017-03-03 09:08:53

Here

```
        except ValueError:
            return '(invalid {} object -- defined in terms of closed session)'.format(self.parent())
```

you should use the exception message instead of hardcoding `"defined in terms of closed session"`. Maybe there are other reasons why a `ValueError` can be raised. And it might also make sense to replace `except ValueError` by `except Exception`.


---

Comment by SimonKing created at 2017-03-03 09:09:10

Replying to [comment:9 jdemeyer]:
> I don't think that you should remove doctests.
> 
> If you remove a method which is no longer needed, then move the doctests somewhere else (say, at the top of the module if you don't see a better place) instead of removing them.

OK, good point. Actually my plan was to do exactly as you said, but I simply forgot it.


---

Comment by jdemeyer created at 2017-03-03 09:11:47

Concerning `invalid None object`: in case that `parent` is `None`, could you use the `type` instead? Just because `None` is not a very interesting value.


---

Comment by SimonKing created at 2017-03-03 09:12:14

Replying to [comment:10 jdemeyer]:
> Here
> {{{
>         except ValueError:
>             return '(invalid {} object -- defined in terms of closed session)'.format(self.parent())
> }}}
> you should use the exception message instead of hardcoding `"defined in terms of closed session"`. Maybe there are other reasons why a `ValueError` can be raised.

No. Here is the code of `_check_valid()`:

```
    def _check_valid(self):
        """
        Check that this object is valid, i.e., the session in which this
        object is defined is still running. This is relevant for
        interpreters that can't be interrupted via ctrl-C, hence get
        restarted.
        """
        try:
            P = self.parent()
            if P is None:
                raise ValueError("The %s session in which this object was defined is no longer running."%P.name())
        except AttributeError:
            raise ValueError("The session in which this object was defined is no longer running.")
        return P
```

So, catching the ValueError is exactly the same as saying "the session is no longer running or some noob overrode `Element.parent` by something that raises a ValueError and thus the whole interface is broken anyway.


---

Comment by jdemeyer created at 2017-03-03 09:14:36

Since this whole ticket is about _generalizing_ why would you assume that ` _check_valid` will never be generalized?


---

Comment by git created at 2017-03-03 09:19:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-03-03 09:19:35

I don't like silly accessor methods like `_get_custom_name` (but that's just a personal opinion). What's wrong with the more explicit

```
getattr(foo, "__custom_name", None)
```

instead of

```
foo._get_custom_name()
```


However, if you really insist on using `_get_custom_name`, you should at least allow for it to be overridden and it should be used everywhere to access `__custom_name`.


---

Comment by jdemeyer created at 2017-03-03 09:27:04

I'm not convinced for the need of the method `_get_primitive()`. Why cannot you just override `eval()` to do the right thing instead of inventing an additional layer of indirection?


---

Comment by git created at 2017-03-03 09:27:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 09:29:09

Replying to [comment:14 jdemeyer]:
> Since this whole ticket is about _generalizing_ why would you assume that ` _check_valid` will never be generalized?

If the semantics of `_check_valid` changes then of course the person who changes it has to deal with the consequences.


---

Comment by jdemeyer created at 2017-03-03 09:32:09

Replying to [comment:19 SimonKing]:
> If the semantics of `_check_valid` changes then of course the person who changes it has to deal with the consequences.

Or you just make a minor change to the code here such that there won't be any bad consequences.


---

Comment by SimonKing created at 2017-03-03 09:32:20

Replying to [comment:16 jdemeyer]:
> I don't like silly accessor methods like `_get_custom_name` (but that's just a personal opinion). What's wrong with the more explicit
> {{{
> getattr(foo, "__custom_name", None)
> }}}
> instead of
> {{{
> foo._get_custom_name()
> }}}

Name mangling. It simply didn't work (and was the reason why I added that method). One could of course change `__custom_name` into a less private attribute. But if we keep it private then there should be an accessor method.


---

Comment by SimonKing created at 2017-03-03 09:34:34

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 SimonKing]:
> > If the semantics of `_check_valid` changes then of course the person who changes it has to deal with the consequences.
> 
> Or you just make a minor change to the code here such that there won't be any bad consequences.

I wish SageMath had followed that idea in the past. Otherwise my group cohomology package wouldn't have been broken so often...


---

Comment by jdemeyer created at 2017-03-03 09:35:03

Replying to [comment:21 SimonKing]:
> Name mangling.

That prevents `foo.__custom_name` but `getattr(foo, "__custom_name")` should still work.


---

Comment by SimonKing created at 2017-03-03 09:39:08

Replying to [comment:17 jdemeyer]:
> I'm not convinced for the need of the method `_get_primitive()`. Why cannot you just override `eval()` to do the right thing instead of inventing an additional layer of indirection?

Currently `eval` and `get` have a different semantics, which I tried to explain in the documentation that I added. The reason to introduce `_get_primitive` is performance: If doing `MyInterface.eval('1')` returns `''` then you need a print statement, such as `MyInterface.eval('print(1)')`. However, if you are in an interface such as Gap or Singular then the print statement is not needed, and of course it is a bit faster to not use the print statement.

Thus, for *efficiency*, the default is to not use the print statement, but for an interface that needs the print statement you are able to override the default.


---

Comment by git created at 2017-03-03 09:50:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 09:57:44

Replying to [comment:10 jdemeyer]:
> Here
> {{{
>         except ValueError:
>             return '(invalid {} object -- defined in terms of closed session)'.format(self.parent())
> }}}
> you should use the exception message instead of hardcoding `"defined in terms of closed session"`.

By the way, how do I use the exception message? If I do

```
    except ValueError, msg:
```

then `"no longer" in msg` doesn't work (ValueError has no `__contains__` method) and `"no longer" in msg.message` gives a DeprecationWarning.

So, am I really supposed to do `"no longer" in repr(msg)`? Or did you mean I should let the `__repr__` method return `'(invalid {} object - {})'.format(self.parent() or type(self), msg)`?

> Maybe there are other reasons why a `ValueError` can be raised. And it might also make sense to replace `except ValueError` by `except Exception`.

I was taught by several people to not catch a general `Exception` (in contrast to a more specific type of error) unless it is absolutely clear that I do not want that exception to be propagated. And that's not the case here. If a different error occurs then I don't want to hide it.


---

Comment by git created at 2017-03-03 10:11:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 10:16:04

Meanwhile I think it is in fact a good idea to explicitly include the error message of the `ValueError` raised by `self._check_valid()` into the string representation of an invalid interface element `self`. But it really should be `ValueError`. There is no point in trying to guess future semantical changes to `_check_valid`. If someone lets it raise a different error than it is his/her job to take care of backward compatibility.
----
New commits:


---

Comment by SimonKing created at 2017-03-03 10:21:05

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-03-03 10:21:05

I think I have answered the points that you raised. So, I'll change it back to "needs review".


---

Comment by jdemeyer created at 2017-03-03 10:22:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-03 10:22:22

What about [comment:16]


---

Comment by jdemeyer created at 2017-03-03 10:24:54

Replying to [comment:24 SimonKing]:
> Currently `eval` and `get` have a different semantics, which I tried to explain in the documentation that I added. The reason to introduce `_get_primitive` is performance: If doing `MyInterface.eval('1')` returns `''` then you need a print statement, such as `MyInterface.eval('print(1)')`. However, if you are in an interface such as Gap or Singular then the print statement is not needed, and of course it is a bit faster to not use the print statement.

I guess we are misunderstanding eachother. My point was: why not change `SimonKingsInterface.eval()` to add the `print` statement? Why does it need an _additional_ method?


---

Comment by jdemeyer created at 2017-03-03 10:27:33

Replying to [comment:26 SimonKing]:
> I was taught by several people to not catch a general `Exception` (in contrast to a more specific type of error) unless it is absolutely clear that I do not want that exception to be propagated.

In general, that's true. I'm just saying that it's debatable whether you do want the exception to be propagated. Anyway, changing this to `except Exception` was just a suggestion so it's perfectly OK to keep it as `except ValueError`.


---

Comment by SimonKing created at 2017-03-03 10:35:04

Replying to [comment:30 jdemeyer]:
> What about [comment:16]

I already answered that. I was bitten by name mangling. While

```
sage: r = singular.ring(0,'(x,y)','dp')
sage: M = singular.matrix(2,2,"(25/47*x^2*y^4 + 63/127*x + 27)^3,y,0,1")
sage: M.rename('T')
sage: M.__custom_name
'T'
```

does work, `hasattr(self,'__custom_name')` returned `False` when I had it in the `_repr_` method.

But if you use `self.__custom_name` in the same module in which the private attribute is defined (namely `sage.structure.sage_object`) then there is no point to use the accessor method, as it is slower.

Just to be on the safe side (maybe I had a typo such as `hasattr(self,'__custon_name')`?), I'll try to change it into using `self.__custom_name?` and tell you what happens.


---

Comment by SimonKing created at 2017-03-03 10:38:51

Replying to [comment:31 jdemeyer]:
> I guess we are misunderstanding eachother. My point was: why not change `SimonKingsInterface.eval()` to add the `print` statement? Why does it need an _additional_ method?

If you need the print statement then use the (already existing) method `.get()`, not `.eval()`. The same applies to Singular:

```
sage: r = singular.ring(0,'(x,y)','dp')
sage: M = singular.matrix(2,2,"(25/47*x^2*y^4 + 63/127*x + 27)^3,y,0,1")
sage: singular.eval(M._name)
'sage8[1,1]=15625/103823*x^6*y^12+118125/280543*x^5*y^8+50625/2209*x^4*y^8+297675/758063*x^4*y^4+255150/5969*x^3*y^4+54675/47*x^2*y^4+250047/2048383*x^3+321489/16129*x^2+137781/127*x+19683\nsage8[1,2]=y\nsage8[2,1]=0\nsage8[2,2]=1'
sage: singular.get(M._name)
'sage8[1,1],y,\n0,         1 '
```



---

Comment by jdemeyer created at 2017-03-03 10:39:39

Maybe you missed [comment:23]. You can override the mangling with `getattr()`/`setattr()`/`hasattr()`.


---

Comment by jdemeyer created at 2017-03-03 10:40:49

Replying to [comment:34 SimonKing]:
> If you need the print statement then use the (already existing) method `.get()`, not `.eval()`.

I am getting more and more lost here...

Given what you just said, what's the difference between `get()` and `_get_primitive()`?


---

Comment by SimonKing created at 2017-03-03 10:41:18

Replying to [comment:35 jdemeyer]:
> Maybe you missed [comment:23]. You can override the mangling with `getattr()`/`setattr()`/`hasattr()`.

Yes, I missed it. Thanks for pointing it out. Next commit will be removal of `_get_custom_name`.


---

Comment by SimonKing created at 2017-03-03 10:45:48

Replying to [comment:36 jdemeyer]:
> Replying to [comment:34 SimonKing]:
> > If you need the print statement then use the (already existing) method `.get()`, not `.eval()`.
> 
> I am getting more and more lost here...
> 
> Given what you just said, what's the difference between `get()` and `_get_primitive()`?

For Singular and Gap, `_get_primitive()` does the same as `eval()`, which is fine because primitives (such as integers) in Gap or Singular do not need to be printed in order to get their string representations. So, blindly using `get()` has a small performance effect.

However, note that this ticket is a dependency for #22452. And in Polymake, you need an explicit print statement even for primitives; thus, blindly using `eval()` wouldn't do the right thing.

Hence, it is needed to introduce a hook `_get_primitive` to customise it.


---

Comment by jdemeyer created at 2017-03-03 10:56:04

Given the explanations that you just made that `_get_primitive()` is just a more efficient version of `get()`, I think that `_get_primitive()` should default to calling `get()` instead of `eval()`.


---

Comment by SimonKing created at 2017-03-03 11:02:24

Replying to [comment:39 jdemeyer]:
> Given the explanations that you just made that `_get_primitive()` is just a more efficient version of `get()`, I think that `_get_primitive()` should default to calling `get()` instead of `eval()`.

The default, I think, should cover the **most frequent** case. So far, Polymake is the only interface I am aware of that would need a print statement to show an integer. That's why I chose it to default to `eval()`, which works for...

```
sage: gp.eval('1')
'1'
sage: singular.eval('1')
'1'
sage: gap.eval('1')
'1'
sage: maxima.eval('1')
'1'
```

whereas you will have (with #22452)

```
sage: polymake.eval('1')
''
```



---

Comment by git created at 2017-03-03 11:04:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 11:06:35

After reverting `_get_custom_name` in the latest commit, I think the only open question at the moment is what should be the default for `_get_primitive`, right?
----
New commits:


---

Comment by jdemeyer created at 2017-03-03 11:10:02

Replying to [comment:40 SimonKing]:
> Replying to [comment:39 jdemeyer]:
> > Given the explanations that you just made that `_get_primitive()` is just a more efficient version of `get()`, I think that `_get_primitive()` should default to calling `get()` instead of `eval()`.
> 
> The default, I think, should cover the **most frequent** case.

No, I think the default should cover the case which makes it least likely to make mistakes.

I also think that many interfaces have custom `get()` methods but don't really need it. For example, GP has a custom `get()` method calling `print()` but I don't see how GP would treat variables differently from "primitive" objects.

Also, it is mentally a lot easier to understand if `_get_primitive()` would default to `get()`. Until all your extra explanations I found it hard to understand what `_get_primitive()` is about. If you say that `_get_primitive()` is just an optimization for `get()`, then it makes a lot of sense that `_get_primitive()` would default to `get()`.


---

Comment by jdemeyer created at 2017-03-03 11:14:15

Replying to [comment:42 SimonKing]:
> After reverting `_get_custom_name` in the latest commit, I think the only open question at the moment is what should be the default for `_get_primitive`, right?

I guess so.

Don't forget the doctests. Speaking of which, you should add a direct doctest for `_get_primitive()` too.


---

Comment by SimonKing created at 2017-03-03 11:17:13

Replying to [comment:44 jdemeyer]:
> Replying to [comment:42 SimonKing]:
> > After reverting `_get_custom_name` in the latest commit, I think the only open question at the moment is what should be the default for `_get_primitive`, right?
> 
> I guess so.
> 
> Don't forget the doctests. Speaking of which, you should add a direct doctest for `_get_primitive()` too.

O, right! I forgot to run `sage --coverage` yet.


---

Comment by git created at 2017-03-03 11:30:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 11:33:25

Replying to [comment:43 jdemeyer]:
> I also think that many interfaces have custom `get()` methods but don't really need it. For example, GP has a custom `get()` method calling `print()` but I don't see how GP would treat variables differently from "primitive" objects.

It does treat them differently:

```
sage: M = random_matrix(ZZ,3,3)
sage: m = gp(M); n = gp(15)
sage: gp.get(m._name), gp.get(n._name)
('[0, -1, 2; 2, -12, 0; -2, 1, 2]', '15')
sage: gp.eval(m._name), gp.eval(n._name)
('\n[ 0  -1 2]\n\n[ 2 -12 0]\n\n[-2   1 2]\n', '15')
```


Apparently the creator of the interface thought that the latter result is nicer than the former.

> Also, it is mentally a lot easier to understand if `_get_primitive()` would default to `get()`. Until all your extra explanations I found it hard to understand what `_get_primitive()` is about. If you say that `_get_primitive()` is just an optimization for `get()`, then it makes a lot of sense that `_get_primitive()` would default to `get()`.

__First proposition:__ `_get_primitive_` should be used in the default comparison method.

__Rationale:__ Using `eval()` in the default comparison means I'll have to override the comparison method in the Polymake interface (doable of course, but I'd like to avoid it). Using `get()` means to lose performance of comparison (thus, an important operation) in all other interfaces.

__Second proposition:__ If `_get_primitive_` is used in comparison methods, it should default to `eval`.

__Rationale:__ If instead it would default to `get`, I'd need to override the default in ALL existing interfaces, or I would have to live with a performance loss in comparison.

__Counterargument:__ I do override `_get_primitive` in Polymake mainly in order to avoid overriding `__cmp__` (I also use it in helper methods, but they are cached and thus using `get()` is fine there). Hence, why do I introduce `_get_primitive` and override it in Polymake, rather than I change the helper methods to use `get()` and then override `__cmp__` in Polymake?
----
New commits:


---

Comment by jdemeyer created at 2017-03-03 11:47:03

Replying to [comment:47 SimonKing]:
> It does treat them differently:

Right, thanks for actually checking my statements :-)

> {{{
> sage: M = random_matrix(ZZ,3,3)
> sage: m = gp(M); n = gp(15)
> sage: gp.get(m._name), gp.get(n._name)
> ('[0, -1, 2; 2, -12, 0; -2, 1, 2]', '15')
> sage: gp.eval(m._name), gp.eval(n._name)
> ('\n[ 0  -1 2]\n\n[ 2 -12 0]\n\n[-2   1 2]\n', '15')
> }}}
> 
> Apparently the creator of the interface thought that the latter result is nicer than the former.

You mean that the former

```
[0, -1, 2; 2, -12, 0; -2, 1, 2]
```

is nicer than the latter

```
[ 0  -1 2]

[ 2 -12 0]

[-2   1 2]
```


I think it depends a lot on the application. If the output of `get()` is supposed to be machine-readable, then certainly the former is nicer.


---

Comment by SimonKing created at 2017-03-03 11:50:38

Replying to [comment:48 jdemeyer]:
> You mean that the former
> ...
> is nicer than the latter

Yes, copy-and-paste error (first, I had the code ordered differently).


---

Comment by SimonKing created at 2017-03-03 11:52:20

Replying to [comment:48 jdemeyer]:
> I think it depends a lot on the application. If the output of `get()` is supposed to be machine-readable, then certainly the former is nicer.

This I cannot tell. I added some documentation based on the observation the `get` in all cases that I looked at involves printing, whereas `eval` in all instances that I looked at does not. So, if the purpose of `get()` is to get something machine-readable then it hasn't been documented.


---

Comment by SimonKing created at 2017-03-03 11:54:51

Replying to [comment:47 SimonKing]:
> __Counterargument:__ I do override `_get_primitive` in Polymake mainly in order to avoid overriding `__cmp__` (I also use it in helper methods, but they are cached and thus using `get()` is fine there). Hence, why do I introduce `_get_primitive` and override it in Polymake, rather than I change the helper methods to use `get()` and then override `__cmp__` in Polymake?

I found my own counter-argument convincing. Thus, I'll remove `_get_primitive` in my next commit. But that has to wait -- I have to prepare the talk that I'm about to give at sage days 84...


---

Comment by jdemeyer created at 2017-03-03 12:08:52

Replying to [comment:47 SimonKing]:
> Using `get()` means to lose performance of comparison (thus, an important operation) in all other interfaces.

Are you sure that there is a real performance hit? Or is this just some hypothetical consideration?


---

Comment by SimonKing created at 2017-03-03 12:20:24

Replying to [comment:52 jdemeyer]:
> Replying to [comment:47 SimonKing]:
> > Using `get()` means to lose performance of comparison (thus, an important operation) in all other interfaces.
> 
> Are you sure that there is a real performance hit? Or is this just some hypothetical consideration?

It is hypothetical. And as I said in my previous post I now plan to leave the default implementation of `__cmp__` as it is, do not introduce `_get_primitive`, and override `__cmp__` for the upcoming Polymake interface.


---

Comment by git created at 2017-03-03 16:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-03 16:54:57

I think with the current commit I have addressed the objections that we discussed above. Note that I did not remove the seemingly unused methods mentioned in the ticket description. I hope that's fine.
----
New commits:


---

Comment by SimonKing created at 2017-03-03 16:54:57

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-03-05 14:48:01

What is the point of replacing `self.__custom_name` by `getattr(self, '__custom_name')`?


---

Comment by SimonKing created at 2017-03-05 15:04:34

Replying to [comment:57 vdelecroix]:
> What is the point of replacing `self.__custom_name` by `getattr(self, '__custom_name')`?

I tried `self.__custom_name` before changing to "getattr", and it didn't work.


---

Comment by jdemeyer created at 2017-03-06 14:30:54

Replying to [comment:58 SimonKing]:
> Replying to [comment:57 vdelecroix]:
> > What is the point of replacing `self.__custom_name` by `getattr(self, '__custom_name')`?
> 
> I tried `self.__custom_name` before changing to "getattr", and it didn't work.

Indeed. `__custom_name` wouldn't work to the Python's name mangling. So the old code could never have worked...


---

Comment by jdemeyer created at 2017-03-06 14:35:01

Replying to [comment:56 SimonKing]:
> I think with the current commit I have addressed the objections that we discussed above. Note that I did not remove the seemingly unused methods mentioned in the ticket description. I hope that's fine.

I think you should update the ticket description. It's much easier to review a ticket like this when the purpose of the ticket is clear.


---

Comment by jdemeyer created at 2017-03-06 14:35:01

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-03-06 14:39:10

Replace

```
except ValueError, msg
```

by

```
except ValueError as msg
```



---

Comment by SimonKing created at 2017-03-06 15:29:39

Changing status from needs_info to needs_review.


---

Comment by git created at 2017-03-06 15:35:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-06 15:37:18

Replying to [comment:61 jdemeyer]:
> Replace
> {{{
> except ValueError, msg
> }}}
> by
> {{{
> except ValueError as msg
> }}}

I did this in the current commit, and I changed the ticket description to say that I believe the mentioned functions "could be removed, but not on this ticket".

So, I guess that means "needs review" again.


---

Comment by jdemeyer created at 2017-03-06 15:54:10

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-03-06 15:54:10

The ticket description isn't up-to-date. For example, it still talks about `_get_primitive`.


---

Comment by SimonKing created at 2017-03-06 16:07:11

Changing status from needs_info to needs_review.


---

Comment by SimonKing created at 2017-03-06 16:18:02

I think the ticket description now clearly states what this ticket is doing.


---

Comment by mantepse created at 2017-03-14 09:39:53

Is the fricas interface not touched because it is "experimental"?  I just checked that there is a `__repr__` method in the `FriCAS` class, with two underscores.  Should that be changed?


---

Comment by SimonKing created at 2017-03-14 10:19:49

Replying to [comment:69 mantepse]:
> Is the fricas interface not touched because it is "experimental"? 

No, I simply missed that one.

> I just checked that there is a `__repr__` method in the `FriCAS` class, with two underscores.  Should that be changed?

Yes.


---

Comment by SimonKing created at 2017-03-14 10:22:10

Oops! I just realise that there are many double underscore `__repr__` that I forgot to change.

Anyway, the interfaces themselves inherit from parent, the objects represented in the interface inherit from element. And that means it should be single underscore, as a rule of thumb.


---

Comment by SimonKing created at 2017-03-14 10:22:45

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-14 10:33:41

Since you're changing the branch anyway, could you please either remove the whitespace changes or move them to a separate commit? I found it quite annoying when reviewing to see that many whitespace changes.


---

Comment by SimonKing created at 2017-03-14 11:05:42

Replying to [comment:73 jdemeyer]:
> Since you're changing the branch anyway, could you please either remove the whitespace changes or move them to a separate commit? I found it quite annoying when reviewing to see that many whitespace changes.

I didn't intend to do whitespace changes, however my editor (geany) is configured to change tabs into four blanks and to remove trailing whitespace when saving a file.

How should I proceed? Shall I rewrite history, force-push and then rebase #22452 on top of it? Or shall I add a commit that re-introduces the whitespace (probably not)?


---

Comment by vdelecroix created at 2017-03-14 12:19:06

Replying to [comment:74 SimonKing]:
> Replying to [comment:73 jdemeyer]:
> > Since you're changing the branch anyway, could you please either remove the whitespace changes or move them to a separate commit? I found it quite annoying when reviewing to see that many whitespace changes.
> 
> I didn't intend to do whitespace changes, however my editor (geany) is configured to change tabs into four blanks and to remove trailing whitespace when saving a file.

So the editor is the culprit?

> How should I proceed? Shall I rewrite history, force-push and then rebase #22452 on top of it? Or shall I add a commit that re-introduces the whitespace (probably not)?

Force push would even be more trouble now. But I agree that for diff readers, seeing all these tiny modifications is annoying. For the future I would suggest: just start with a first commit that deal with whitespaces and nothing else. Then add non trivial commits on top of that.


---

Comment by SimonKing created at 2017-03-14 12:24:21

Replying to [comment:75 vdelecroix]:
> > I didn't intend to do whitespace changes, however my editor (geany) is configured to change tabs into four blanks and to remove trailing whitespace when saving a file.
> 
> So the editor is the culprit?

I said "I didn't _intend_ to...". So, the fact that I have this option by default is a good when creating a new file, but bad when editing an existing file that doesn't conform to the standards that sage has regarding trailing whitespace.

> Force push would even be more trouble now. But I agree that for diff readers, seeing all these tiny modifications is annoying. For the future I would suggest: just start with a first commit that deal with whitespaces and nothing else. Then add non trivial commits on top of that.

I am not talking about future. What to do _now_?


---

Comment by jdemeyer created at 2017-03-14 12:27:01

Replying to [comment:75 vdelecroix]:
> Force push would even be more trouble now.

Why?

You should not force-push here and then base #22452. Instead, you should force-push #22452, checkout the commit corresponding to this ticket and force-push that.

That's very easy to do.


---

Comment by SimonKing created at 2017-03-14 12:29:13

Replying to [comment:77 jdemeyer]:
> Replying to [comment:75 vdelecroix]:
> > Force push would even be more trouble now.
> 
> Why?
> 
> You should not force-push here and then base #22452. Instead, you should force-push #22452, checkout the commit corresponding to this ticket and force-push that.
> 
> That's very easy to do.

I don't understand that at all. This ticket is a dependency for #22452. Do you suggest to revert the dependencies?


---

Comment by jdemeyer created at 2017-03-14 12:49:28

Replying to [comment:78 SimonKing]:
> This ticket is a dependency for #22452. Do you suggest to revert the dependencies?

No. If I understand things correctly, #22452 contains the commit from this ticket (#22501). So you could rebase #22452 but keeping a separation between the commits which really belong to #22501 and the ones which really belong to #22452 (so not squashing everything together).

Then you can force-push #22452. At this point, the branch from #22501 will no longer be a sub-branch of #22452. But that can be fixed by resetting the branch on #22501 to a commit which was pushed on #22452.

I can easily do this myself if you want.


---

Comment by SimonKing created at 2017-03-14 13:34:33

Replying to [comment:79 jdemeyer]:
> Replying to [comment:78 SimonKing]:
> > This ticket is a dependency for #22452. Do you suggest to revert the dependencies?
> 
> No. If I understand things correctly, #22452 contains the commit from this ticket (#22501).

Yes, it does.

> So you could rebase #22452 but keeping a separation between the commits which really belong to #22501 and the ones which really belong to #22452 (so not squashing everything together).

That's why I suggested to force a change here and then rebase the commits that really belong to #22452 on top of the new forced commit from here (#22501).

> Then you can force-push #22452. At this point, the branch from #22501 will no longer be a sub-branch of #22452. But that can be fixed by resetting the branch on #22501 to a commit which was pushed on #22452.

It seems to me that the result is equivalent to what I suggest.

So, my plan now is:

- Create a new single commit for this ticket (#22501) that removes trailing whitespace only in the lines that have also been edited for other reasons.
- Force-push the new commit here.
- Rebase the commits from #22452 that really belong to #22452 on top of the new commit. Push (of course using force) the result there.


---

Comment by git created at 2017-03-14 13:54:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2017-03-14 14:11:42

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-03-14 14:11:42

I guess both tickets are changed so that reviewing can be resumed (just make sure that you check out the new force-changed branches).


---

Comment by vdelecroix created at 2017-03-15 09:59:09

Why `self._obj._check_valid()` is done in `_repr_`? Could it be moved to `__repr__`? That way we would have the clearer `M = self.parent()` in the multiple `_repr_` methods.


---

Comment by SimonKing created at 2017-03-15 10:06:55

Replying to [comment:83 vdelecroix]:
> Why `self._obj._check_valid()` is done in `_repr_`? Could it be moved to `__repr__`? That way we would have the clearer `M = self.parent()` in the multiple `_repr_` methods.

In fact, `_check_valid` _is_ done in the default (double underscore) `__repr__` - see `sage.interfaces.interface.InterfaceElement`. So, you are right, it should be safe to just do "self.parent()". Will change it in a minute.


---

Comment by git created at 2017-03-15 10:10:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-15 10:10:44

Done.
----
New commits:
----
New commits:


---

Comment by SimonKing created at 2017-03-15 10:12:02

PS: I will not put this additional commit into #22452, as it isn't relevant there, and I was told to avoid useless merges.


---

Comment by SimonKing created at 2017-03-16 09:09:30

Oddly, the patchbot reports failures. But as much as I can see they are unrelated with this ticket.


---

Comment by vdelecroix created at 2017-03-16 09:35:41

Indeed. It is weird.

I am good with this ticket, if nobody have further comment I will set it to positive review.


---

Comment by mantepse created at 2017-03-16 10:03:09

I am currently recompiling, so I can run the tests of the fricas interface (which still has "experimental" status, unfortunately).


---

Comment by mantepse created at 2017-03-16 13:40:52

OK, fricas tests are passing.


---

Comment by vdelecroix created at 2017-03-18 09:53:34

Let it be!


---

Comment by vdelecroix created at 2017-03-18 09:53:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-27 20:42:09

Resolution: fixed
