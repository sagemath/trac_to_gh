# Issue 11741: Notebook hang in ?? source display Trackback

archive/issues_011741.json:
```json
{
    "body": "Assignee: jason, mpatel, was\n\nCC:  simonking\n\nIn the notebook, looking at the source of some methods ends with a Traceback and then the notebook keeps being busy until I interrupt the computation.\n\nSteps to reproduce:\n\n1. Open notebook (tested on sage-4.7.2.alpha2 and alpha3)\n\n2. create matrix, e.g. (without the sage:)\n\n```\nsage: m = random_matrix(ZZ,100);  m\n```\n\n\n3. look at source of the `determinant()` method:\n\n```\nsage: m.determinant??\n```\n\n\nIt seems like the source formatter gets confused by the traceback in the method's docstring. See attached screenshot for illustration.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11913\n\n",
    "created_at": "2011-10-11T08:12:29Z",
    "labels": [
        "component: notebook",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4",
    "title": "Notebook hang in ?? source display Trackback",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11741",
    "user": "https://github.com/vbraun"
}
```
Assignee: jason, mpatel, was

CC:  simonking

In the notebook, looking at the source of some methods ends with a Traceback and then the notebook keeps being busy until I interrupt the computation.

Steps to reproduce:

1. Open notebook (tested on sage-4.7.2.alpha2 and alpha3)

2. create matrix, e.g. (without the sage:)

```
sage: m = random_matrix(ZZ,100);  m
```


3. look at source of the `determinant()` method:

```
sage: m.determinant??
```


It seems like the source formatter gets confused by the traceback in the method's docstring. See attached screenshot for illustration.

Issue created by migration from https://trac.sagemath.org/ticket/11913





---

archive/issue_comments_133320.json:
```json
{
    "body": "Screenshot of the problem",
    "created_at": "2011-10-11T08:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133320",
    "user": "https://github.com/vbraun"
}
```

Screenshot of the problem



---

archive/issue_comments_133321.json:
```json
{
    "body": "Attachment [screenshot.png](tarball://root/attachments/some-uuid/ticket11913/screenshot.png) by @simon-king-jena created at 2012-04-15 08:40:53",
    "created_at": "2012-04-15T08:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133321",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [screenshot.png](tarball://root/attachments/some-uuid/ticket11913/screenshot.png) by @simon-king-jena created at 2012-04-15 08:40:53



---

archive/issue_comments_133322.json:
```json
{
    "body": "The traceback is hidden by the method \"format_exception\" in sage.server.notebook.cell. That function is called by the method `parse_html`, if the cell is not interactive (line 1500 of sage.server.notebook.cell).",
    "created_at": "2012-04-15T15:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133322",
    "user": "https://github.com/simon-king-jena"
}
```

The traceback is hidden by the method "format_exception" in sage.server.notebook.cell. That function is called by the method `parse_html`, if the cell is not interactive (line 1500 of sage.server.notebook.cell).



---

archive/issue_comments_133323.json:
```json
{
    "body": "Strange. I modified the function, such that some protocol output is put into a file when it is called. But apparently it is NOT called when requesting the source of an object.\n\nIs there code for the notebook that can not be found with search_src?",
    "created_at": "2012-04-15T15:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133323",
    "user": "https://github.com/simon-king-jena"
}
```

Strange. I modified the function, such that some protocol output is put into a file when it is called. But apparently it is NOT called when requesting the source of an object.

Is there code for the notebook that can not be found with search_src?



---

archive/issue_comments_133324.json:
```json
{
    "body": "Meanwhile it seems to me that the notebook is reinventing the wheel. Namely, devel/sagenb/sagenb contains files that seem to be old snapshots of corresponding files in devel/sage/sage. For example, misc/sageinspect.py exists in both repositories -- and they are different, the version in devel/sagenb lacks some important patches.\n\nProbably, for this ticket, working on the \"format_exception\" function will be enough. But I do think that the code duplication and the lack of synchronisation between devel/sage and devel/sagenb is a bug that deserves its own ticket.",
    "created_at": "2012-04-15T16:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133324",
    "user": "https://github.com/simon-king-jena"
}
```

Meanwhile it seems to me that the notebook is reinventing the wheel. Namely, devel/sagenb/sagenb contains files that seem to be old snapshots of corresponding files in devel/sage/sage. For example, misc/sageinspect.py exists in both repositories -- and they are different, the version in devel/sagenb lacks some important patches.

Probably, for this ticket, working on the "format_exception" function will be enough. But I do think that the code duplication and the lack of synchronisation between devel/sage and devel/sagenb is a bug that deserves its own ticket.



---

archive/issue_comments_133325.json:
```json
{
    "body": "The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.\n\nIt looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...\n\nAt one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.",
    "created_at": "2012-04-15T16:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133325",
    "user": "https://github.com/jhpalmieri"
}
```

The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.

It looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...

At one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.



---

archive/issue_comments_133326.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.\n\nYep. Meanwhile I figured that out.\n \n> It looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...\n\nThat is really an awkward situation. I would try to fix the problem using trac. But I would certainly not learn how to use github just for fixing a notebook problem: After all, I am hardly using the notebook, myself.\n\n> At one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.\n\nSagenb ticket meaning that it is a github thingy? Or is it here?\n\nI think, if there is new stuff in devel/sagenb/sagenb/misc and in devel/sagenb/sagenb/interfaces, then it should be moved to devel/sage/sage/misc and devel/sage/sage/interfaces. Afterwards, devel/sagenb/sagenb/misc and devel/sagenb/sagenb/interfaces should be deleted and the stuff from the sage repository should be used instead.\n\nIn other words, I think that synchronisation is the wrong approach, since synchronisation would preserve the duplication of code.\n\nCode that is found elsewhere in sage or even new code that is likely to be useful elsewhere in sage does not belong to devel/sagenb/sagenb/ and should be (re-)moved.",
    "created_at": "2012-04-15T17:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133326",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 jhpalmieri]:
> The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.

Yep. Meanwhile I figured that out.
 
> It looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...

That is really an awkward situation. I would try to fix the problem using trac. But I would certainly not learn how to use github just for fixing a notebook problem: After all, I am hardly using the notebook, myself.

> At one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.

Sagenb ticket meaning that it is a github thingy? Or is it here?

I think, if there is new stuff in devel/sagenb/sagenb/misc and in devel/sagenb/sagenb/interfaces, then it should be moved to devel/sage/sage/misc and devel/sage/sage/interfaces. Afterwards, devel/sagenb/sagenb/misc and devel/sagenb/sagenb/interfaces should be deleted and the stuff from the sage repository should be used instead.

In other words, I think that synchronisation is the wrong approach, since synchronisation would preserve the duplication of code.

Code that is found elsewhere in sage or even new code that is likely to be useful elsewhere in sage does not belong to devel/sagenb/sagenb/ and should be (re-)moved.



---

archive/issue_comments_133327.json:
```json
{
    "body": "But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage. So from that standpoint, maybe this code should all be moved out of the Sage library and just into sagenb; since sagenb is part of Sage, Sage could still use it. (I'm not sure I agree with this, but perhaps we should consider it.)",
    "created_at": "2012-04-15T18:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133327",
    "user": "https://github.com/jhpalmieri"
}
```

But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage. So from that standpoint, maybe this code should all be moved out of the Sage library and just into sagenb; since sagenb is part of Sage, Sage could still use it. (I'm not sure I agree with this, but perhaps we should consider it.)



---

archive/issue_comments_133328.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage.\n\nsageinspect.py is designed to inspect *__Sage__* source code. It first tries to use python's inspect module to do the job, but when it fails (and this is likely the case in Cython code) then it tries to find the source files - and these source files are searched for *in the devel/sage/sage repository*.\n\nHence, if what you say is true, then the notebook should not use sageinspect.py at all.",
    "created_at": "2012-04-15T18:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133328",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:7 jhpalmieri]:
> But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage.

sageinspect.py is designed to inspect *__Sage__* source code. It first tries to use python's inspect module to do the job, but when it fails (and this is likely the case in Cython code) then it tries to find the source files - and these source files are searched for *in the devel/sage/sage repository*.

Hence, if what you say is true, then the notebook should not use sageinspect.py at all.



---

archive/issue_comments_133329.json:
```json
{
    "body": "I've submitted a [pull request](https://github.com/sagemath/sagenb/pull/62) for sagenb. Go to [this link](https://github.com/sagemath/sagenb/pull/62/files) to see the changes (very much like looking at an attached patch on trac). Fixing this also requires a small modification to the Sage library, related to #10860: as far as I can tell, the patch at #10860 relied on sagenb's somewhat broken version of sageinspect.py, so once we use Sage's version, the patch at #10860 no longer quite works. Hence the patch to the Sage library here.",
    "created_at": "2012-06-13T21:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133329",
    "user": "https://github.com/jhpalmieri"
}
```

I've submitted a [pull request](https://github.com/sagemath/sagenb/pull/62) for sagenb. Go to [this link](https://github.com/sagemath/sagenb/pull/62/files) to see the changes (very much like looking at an attached patch on trac). Fixing this also requires a small modification to the Sage library, related to #10860: as far as I can tell, the patch at #10860 relied on sagenb's somewhat broken version of sageinspect.py, so once we use Sage's version, the patch at #10860 no longer quite works. Hence the patch to the Sage library here.



---

archive/issue_comments_133330.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-06-13T21:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133330",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133331.json:
```json
{
    "body": "I'm not sure mine is a perfect solution, but it basically works. I still see the \"Traceback\", but nothing hangs. If I click to the left of the docstring, it shows the rest of the source.\n\nEdit: maybe what I mean to say is this: I think my changes are beneficial and should be merged anyway. Then we can tinker with how the notebook displays source code involving Tracebacks afterwards.",
    "created_at": "2012-06-13T21:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133331",
    "user": "https://github.com/jhpalmieri"
}
```

I'm not sure mine is a perfect solution, but it basically works. I still see the "Traceback", but nothing hangs. If I click to the left of the docstring, it shows the rest of the source.

Edit: maybe what I mean to say is this: I think my changes are beneficial and should be merged anyway. Then we can tinker with how the notebook displays source code involving Tracebacks afterwards.



---

archive/issue_comments_133332.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd41\".",
    "created_at": "2012-06-15T00:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133332",
    "user": "https://github.com/kini"
}
```

Changing keywords from "" to "sd41".



---

archive/issue_comments_133333.json:
```json
{
    "body": "Tests pass, and I like your solution, though you're right that it's only a solution to the sageinspect duplication stuff and the hang, and not of [issue #34](https://github.com/sagemath/sagenb/issues/34).",
    "created_at": "2012-06-15T00:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133333",
    "user": "https://github.com/kini"
}
```

Tests pass, and I like your solution, though you're right that it's only a solution to the sageinspect duplication stuff and the hang, and not of [issue #34](https://github.com/sagemath/sagenb/issues/34).



---

archive/issue_comments_133334.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-15T00:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133334",
    "user": "https://github.com/kini"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_133335.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2012-06-15T21:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133335",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_133336.json:
```json
{
    "body": "Is this sagenb patch merged in the spkg at #11080? If not, this ticket needs a proper sagenb spkg.",
    "created_at": "2012-06-15T21:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133336",
    "user": "https://github.com/jdemeyer"
}
```

Is this sagenb patch merged in the spkg at #11080? If not, this ticket needs a proper sagenb spkg.



---

archive/issue_comments_133337.json:
```json
{
    "body": "The patch to the Sage library can be merged independently of any changes to sagenb, and that patch does fix a bug (as described in the new doctest). The changes to sagenb actually attempt to fix the problem described in the ticket.",
    "created_at": "2012-06-15T21:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133337",
    "user": "https://github.com/jhpalmieri"
}
```

The patch to the Sage library can be merged independently of any changes to sagenb, and that patch does fix a bug (as described in the new doctest). The changes to sagenb actually attempt to fix the problem described in the ticket.



---

archive/issue_comments_133338.json:
```json
{
    "body": "The relevant sagenb spkg will be at #13121.",
    "created_at": "2012-06-15T21:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133338",
    "user": "https://github.com/jhpalmieri"
}
```

The relevant sagenb spkg will be at #13121.



---

archive/issue_comments_133339.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-06-15T21:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133339",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_133340.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-15T21:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133340",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_133341.json:
```json
{
    "body": "Attachment [trac_11913-sage.patch](tarball://root/attachments/some-uuid/ticket11913/trac_11913-sage.patch) by @jhpalmieri created at 2012-06-15 21:56:40\n\nSage library",
    "created_at": "2012-06-15T21:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133341",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_11913-sage.patch](tarball://root/attachments/some-uuid/ticket11913/trac_11913-sage.patch) by @jhpalmieri created at 2012-06-15 21:56:40

Sage library



---

archive/issue_comments_133342.json:
```json
{
    "body": "(I just attached a new version of the patch which uses proper !Sage/Sphinx markup for trac ticket references. Keshav, who is sitting next to me, still gives it a positive review.)",
    "created_at": "2012-06-15T21:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133342",
    "user": "https://github.com/jhpalmieri"
}
```

(I just attached a new version of the patch which uses proper !Sage/Sphinx markup for trac ticket references. Keshav, who is sitting next to me, still gives it a positive review.)



---

archive/issue_events_011807.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-09-05T18:05:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11741#event-11807"
}
```



---

archive/issue_comments_133343.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-09-05T18:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11741#issuecomment-133343",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
