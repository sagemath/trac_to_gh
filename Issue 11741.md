# Issue 11741: Notebook hang in ?? source display Trackback

Issue created by migration from https://trac.sagemath.org/ticket/11913

Original creator: vbraun

Original creation time: 2011-10-11 08:12:29

Assignee: jason, mpatel, was

CC:  simonking

In the notebook, looking at the source of some methods ends with a Traceback and then the notebook keeps being busy until I interrupt the computation.

Steps to reproduce:

1. Open notebook (tested on sage-4.7.2.alpha2 and alpha3)

2. create matrix, e.g. (without the sage:)

```
sage: m = random_matrix(ZZ,100);  m
```


3. look at source of the `determinant()` method:

```
sage: m.determinant??
```


It seems like the source formatter gets confused by the traceback in the method's docstring. See attached screenshot for illustration.


---

Comment by vbraun created at 2011-10-11 08:12:45

Screenshot of the problem


---

Attachment


---

Comment by SimonKing created at 2012-04-15 15:45:46

The traceback is hidden by the method "format_exception" in sage.server.notebook.cell. That function is called by the method `parse_html`, if the cell is not interactive (line 1500 of sage.server.notebook.cell).


---

Comment by SimonKing created at 2012-04-15 15:57:56

Strange. I modified the function, such that some protocol output is put into a file when it is called. But apparently it is NOT called when requesting the source of an object.

Is there code for the notebook that can not be found with search_src?


---

Comment by SimonKing created at 2012-04-15 16:30:10

Meanwhile it seems to me that the notebook is reinventing the wheel. Namely, devel/sagenb/sagenb contains files that seem to be old snapshots of corresponding files in devel/sage/sage. For example, misc/sageinspect.py exists in both repositories -- and they are different, the version in devel/sagenb lacks some important patches.

Probably, for this ticket, working on the "format_exception" function will be enough. But I do think that the code duplication and the lack of synchronisation between devel/sage and devel/sagenb is a bug that deserves its own ticket.


---

Comment by jhpalmieri created at 2012-04-15 16:44:02

The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.

It looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...

At one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.


---

Comment by SimonKing created at 2012-04-15 17:18:02

Replying to [comment:5 jhpalmieri]:
> The notebook no longer uses sage.server.notebook.cell; see SAGE_ROOT/devel/sagenb/... instead.

Yep. Meanwhile I figured that out.
 
> It looks like this issue is also being tracked for the notebook at [https://github.com/sagemath/sagenb/issues/34](https://github.com/sagemath/sagenb/issues/34). Not that they've made any progress on it...

That is really an awkward situation. I would try to fix the problem using trac. But I would certainly not learn how to use github just for fixing a notebook problem: After all, I am hardly using the notebook, myself.

> At one point, I also thought I had opened a sagenb ticket saying that they needed to synchronize with the newest version of Sage's sageinspect, but I couldn't find that one.

Sagenb ticket meaning that it is a github thingy? Or is it here?

I think, if there is new stuff in devel/sagenb/sagenb/misc and in devel/sagenb/sagenb/interfaces, then it should be moved to devel/sage/sage/misc and devel/sage/sage/interfaces. Afterwards, devel/sagenb/sagenb/misc and devel/sagenb/sagenb/interfaces should be deleted and the stuff from the sage repository should be used instead.

In other words, I think that synchronisation is the wrong approach, since synchronisation would preserve the duplication of code.

Code that is found elsewhere in sage or even new code that is likely to be useful elsewhere in sage does not belong to devel/sagenb/sagenb/ and should be (re-)moved.


---

Comment by jhpalmieri created at 2012-04-15 18:17:18

But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage. So from that standpoint, maybe this code should all be moved out of the Sage library and just into sagenb; since sagenb is part of Sage, Sage could still use it. (I'm not sure I agree with this, but perhaps we should consider it.)


---

Comment by SimonKing created at 2012-04-15 18:24:32

Replying to [comment:7 jhpalmieri]:
> But sagenb is supposed to be a stand-alone project; people should be able to use it for other purposes, not just within Sage.

sageinspect.py is designed to inspect ___Sage___ source code. It first tries to use python's inspect module to do the job, but when it fails (and this is likely the case in Cython code) then it tries to find the source files - and these source files are searched for _in the devel/sage/sage repository_.

Hence, if what you say is true, then the notebook should not use sageinspect.py at all.


---

Comment by jhpalmieri created at 2012-06-13 21:38:42

I've submitted a [pull request](https://github.com/sagemath/sagenb/pull/62) for sagenb. Go to [this link](https://github.com/sagemath/sagenb/pull/62/files) to see the changes (very much like looking at an attached patch on trac). Fixing this also requires a small modification to the Sage library, related to #10860: as far as I can tell, the patch at #10860 relied on sagenb's somewhat broken version of sageinspect.py, so once we use Sage's version, the patch at #10860 no longer quite works. Hence the patch to the Sage library here.


---

Comment by jhpalmieri created at 2012-06-13 21:38:42

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-06-13 21:49:53

I'm not sure mine is a perfect solution, but it basically works. I still see the "Traceback", but nothing hangs. If I click to the left of the docstring, it shows the rest of the source.

Edit: maybe what I mean to say is this: I think my changes are beneficial and should be merged anyway. Then we can tinker with how the notebook displays source code involving Tracebacks afterwards.


---

Comment by kini created at 2012-06-15 00:29:47

Changing keywords from "" to "sd41".


---

Comment by kini created at 2012-06-15 00:29:47

Tests pass, and I like your solution, though you're right that it's only a solution to the sageinspect duplication stuff and the hang, and not of [issue #34](https://github.com/sagemath/sagenb/issues/34).


---

Comment by kini created at 2012-06-15 00:29:47

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-15 21:06:35

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2012-06-15 21:06:35

Is this sagenb patch merged in the spkg at #11080? If not, this ticket needs a proper sagenb spkg.


---

Comment by jhpalmieri created at 2012-06-15 21:52:02

The patch to the Sage library can be merged independently of any changes to sagenb, and that patch does fix a bug (as described in the new doctest). The changes to sagenb actually attempt to fix the problem described in the ticket.


---

Comment by jhpalmieri created at 2012-06-15 21:53:28

The relevant sagenb spkg will be at #13121.


---

Comment by jhpalmieri created at 2012-06-15 21:53:28

Changing status from needs_info to needs_review.


---

Comment by jhpalmieri created at 2012-06-15 21:53:36

Changing status from needs_review to positive_review.


---

Attachment

Sage library


---

Comment by jhpalmieri created at 2012-06-15 21:58:01

(I just attached a new version of the patch which uses proper !Sage/Sphinx markup for trac ticket references. Keshav, who is sitting next to me, still gives it a positive review.)


---

Comment by jdemeyer created at 2012-09-05 18:05:25

Resolution: fixed
