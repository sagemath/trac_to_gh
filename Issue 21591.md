# Issue 21591: Crash in SubgraphSearch of empty graph

Issue created by migration from https://trac.sagemath.org/ticket/21828

Original creator: rws

Original creation time: 2016-11-06 07:47:50

Sage on OpenSuSE 42.2 crashes on the command `Poset().is_incomparable_chain_free(1,1)`. Reason is there is no check in the `SubgraphSearch` member function for an empty graph, so happily zero bytes are deallocated.


---

Comment by rws created at 2016-11-06 07:57:40

New commits:


---

Comment by rws created at 2016-11-06 07:57:40

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-11-06 09:22:58

It's not really clear to me if adding `if self.ng == 0: return` in those places is the right thing to do. Why in `__cinit__` and `__dealloc__` for example? I don't see the problem there. And in `_initialize`, why should `self.stack` and `self.active` not be initialized? If you do the initialization correctly, it should also be possible to remove the `if self.ng == 0: return` from `__next__`.


---

Comment by jdemeyer created at 2016-11-06 09:27:55

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-01-17 07:51:53

Deallocation of `tmp_array` is also missing.


---

Comment by rws created at 2017-01-17 08:04:15

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-01-17 08:04:15

Let's try again differently.
----
New commits:


---

Comment by vdelecroix created at 2017-01-29 13:53:05

doctest?


---

Comment by jmantysalo created at 2017-01-29 14:03:35

Good to fix this. For larger context see #21741.


---

Comment by jdemeyer created at 2017-01-29 16:36:41

This seems overly complicated to me...

This looks like the only place where you really need to do something:

```
self.busy[0] = 1
```



---

Comment by jdemeyer created at 2017-01-29 16:36:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-01-29 16:37:47

You may also want to look at `src/sage/ext/memory_allocator.pyx` to simplify the memory allocations.


---

Comment by rws created at 2017-01-30 06:57:42

My Python understanding does not suffice for this. Please someone take over.


---

Comment by jdemeyer created at 2017-01-30 07:11:21

What exactly is the problem here? What would be the minimal code to exhibit the problem?


---

Comment by Konrad127123 created at 2018-02-05 11:52:15

Replying to [comment:6 rws]:
> Deallocation of `tmp_array` is also missing.

I've added a fix for this part in #24660 .


---

Comment by jmantysalo created at 2018-02-06 07:27:08

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-02-06 07:38:31

You mean #24660? As said in comment:15 that is only part of it.


---

Comment by rws created at 2018-03-05 08:49:31

Finally I got the handle on this. I'm inserting/leaving some checks for efficiency reasons. Please review, as this makes patchbot fail on OpenSuSE.
----
New commits:


---

Comment by dcoudert created at 2018-03-06 17:50:36

I don't have OpenSuSE, so I cannot fully test the patch (working for me on OSX). 

Could you add a doctest for `Poset().is_incomparable_chain_free(1,1)` ?


---

Comment by jdemeyer created at 2018-03-06 21:05:48

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-06 21:05:48

1. `MemoryAllocator` raises exceptions when out of memory, so the `NULL` checks are no longer needed.

2. I'm surprised that `for 0 < i < self.ng` is legal Cython syntax. Cython understands `for i in range(1, self.ng)` though. To be safe, you may want to add `cdef int i`.

3. My impression is that `self.ng` is constant. So I don't understand code of the form

```
if self.ng == 0:
   raise StopIteration
....
if self.ng > 0: ...
```

Isn't the latter trivially true?


---

Comment by git created at 2018-03-07 08:12:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-03-07 08:12:50

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-07 09:19:44

I think that you should still fix the `for 0 < i < self.ng:` syntax (sorry if my previous comment was not clear on this).


---

Comment by jdemeyer created at 2018-03-07 09:19:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-07 09:29:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-03-07 09:29:54

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2018-03-28 18:38:25

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2018-03-28 18:38:25

For me this patch is perfectly working, so I give it positive review.


---

Comment by rws created at 2018-03-29 05:21:32

Thanks!


---

Comment by vbraun created at 2018-03-30 23:28:37

Resolution: fixed
