# Issue 30392: wsl-ubuntu-focal: ECL build fails

Issue created by migration from https://trac.sagemath.org/ticket/30629

Original creator: mkoeppe

Original creation time: 2020-09-21 21:38:46

CC:  @tobiasdiez @spaghettisalat dimpase mjo

https://github.com/mkoeppe/sage/runs/1145335573

```
dpp: /mnt/d/a/sage/sage/.tox/local/local/var/tmp/sage/build/ecl-20.4.24.p1/src/src/c/threads/atomic.d -> threads/atomic.o.c
dpp: /mnt/d/a/sage/sage/.tox/local/local/var/tmp/sage/build/ecl-20.4.24.p1/src/src/c/all_symbols.d -> all_symbols.c
dpp: /mnt/d/a/sage/sage/.tox/local/local/var/tmp/sage/build/ecl-20.4.24.p1/src/src/c/cinit.d -> cinit.c
Building ecl_min...
Wrong __data_start/_end pair
/usr/bin/bash: line 4: 23807 Aborted                 (core dumped) ECLDIR=`pwd`/ ./ecl_min compile
make[6]: *** [Makefile:99: bin/ecl] Error 134
```



---

Comment by @spaghettisalat created at 2020-09-22 06:14:43

This is a bdwgc issue (see https://github.com/ivmai/bdwgc/issues/321 and also https://github.com/ivmai/bdwgc/issues/259 for a similar issue on android).


---

Comment by mkoeppe created at 2020-09-22 14:16:38

Are you working on a workaround in ECL, or do we have to reject system libgc that was built with the wrong options?


---

Comment by mkoeppe created at 2020-09-22 14:16:38

Changing priority from critical to blocker.


---

Comment by @spaghettisalat created at 2020-09-22 16:18:05

Replying to [comment:3 mkoeppe]:
> Are you working on a workaround in ECL, or do we have to reject system libgc that was built with the wrong options?

No, I'm not implementing a workaround.


---

Comment by mkoeppe created at 2020-09-24 00:03:34

Is there a reliable way to detect the problematic libgc installation?


---

Comment by dimpase created at 2020-09-24 07:19:04

is this a WSL-only problem?


---

Comment by mjo created at 2020-09-25 14:11:31

These are general bdwgc problems, but what sucks for us is that they only appear when the garbage collector is linked with `-Bsymbolic-functions`, and I don't see an easy way to detect that.

Instead we may have to reject the system copy of gc if `dpkg-buildflags --get LDFLAGS` includes `Bsymbolic-functions` and if the system version of gc is before 8.0.5 (which should include the upstream fix).


---

Comment by mkoeppe created at 2020-09-25 19:48:51

Replying to [comment:8 mjo]:
> Instead we may have to reject the system copy of gc if `dpkg-buildflags --get LDFLAGS` includes `Bsymbolic-functions` and if the system version of gc is before 8.0.5 (which should include the upstream fix).

Build tools like `dpkg-buildflags` are, however, not installed on typical user machines.


---

Comment by mkoeppe created at 2020-09-25 19:49:17

I think we need a run test


---

Comment by mjo created at 2020-09-25 19:52:13

I suppose we could also ask Ubuntu to ship an unbroken copy of gc to its users?


---

Comment by mkoeppe created at 2020-09-25 19:55:35

Ideally both


---

Comment by dimpase created at 2020-09-26 07:18:31

reported on https://bugs.launchpad.net/ubuntu/+source/libgc/+bug/1897371


---

Comment by mkoeppe created at 2020-09-27 17:07:19

In the meantime I'd suggest to disable the gc spkg-configure for the 9.2 release.


---

Comment by mkoeppe created at 2020-09-27 17:13:28

New commits:


---

Comment by mkoeppe created at 2020-09-27 17:13:28

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-27 18:46:02

Replying to [comment:7 dimpase]:
> is this a WSL-only problem?

Is this the case? If so, perhaps we should only disable it on WSL?


---

Comment by mkoeppe created at 2020-09-27 22:30:29

I don't know if it is WSL-only.

grepping for "Microsoft" in /proc/sys/kernel/osrelease seems to do the trick of detecting WSL. https://github.com/karelzak/util-linux/commit/3673936f84bcf0b3ac5bff37394180bed7d692d2


---

Comment by mkoeppe created at 2020-09-27 22:32:35

This one tests for a few more patterns:
https://github.com/systemd/systemd/pull/15325/files


---

Comment by git created at 2020-09-28 21:47:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-09-28 21:48:15

Here's an attempt. I have only tested that it does not break things on macOS.


---

Comment by @tobiasdiez created at 2020-10-02 14:08:25

The check is not working for me since all files under `/proc` are empty for some reason (this seems to be very strange and unusual).

Note that for me `libgc1c2` version 7.6.4 was the problem to get a running ecl. I also read somewhere that these issues don't occur on WSL 2


---

Comment by mkoeppe created at 2020-10-02 18:07:22

These files in `/proc` are not seekable and looking at them in a text editor usually does not work, but what is the result of `cat /proc/sys/kernel/osrelease`?


---

Comment by mkoeppe created at 2020-10-02 18:07:42

Yes, WSL2 is a completely different architecture


---

Comment by @tobiasdiez created at 2020-10-02 18:39:16

Ah sorry, the grep command didn't report anything (because I missed the `-q`) and the files seemed to be empty. False alarm: I have `4.4.0-19041-Microsoft` in that file.


---

Comment by vbraun created at 2020-10-03 22:59:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-10-03 23:04:45

Thanks!


---

Comment by vbraun created at 2020-10-05 20:12:38

Resolution: fixed


---

Comment by dimpase created at 2021-11-26 09:11:16

the problem fixed in gc v8.0.6, as upstream says in https://bugs.launchpad.net/ubuntu/+source/libgc/+bug/1897371
