# Issue 31306: Eliminate use of patches for Python packages

archive/issues_031306.json:
```json
{
    "body": "CC:  dimpase mjo @tobiasdiez\n\nInstalling \"sdist + patches\" is not supported by Python package infrastructure.\n\n\n```\n$ ./sage -package list --has-file install-requires.txt --has-file patches\nrpy2\nwidgetsnbextension\ncvxopt\nipywidgets\ndot2tex\ncython\nnumpy\ncypari\npillow\nrst2ipynb\nsphinx\nnotedown\nsetuptools\npsutil\n```\n\n\nWe review existing patches, and for those packages that still need them, we create a repository fork and create and deposit an sdist tarball from here.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31543\n\n",
    "created_at": "2021-03-23T05:48:27Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Eliminate use of patches for Python packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31306",
    "user": "mkoeppe"
}
```
CC:  dimpase mjo @tobiasdiez

Installing "sdist + patches" is not supported by Python package infrastructure.


```
$ ./sage -package list --has-file install-requires.txt --has-file patches
rpy2
widgetsnbextension
cvxopt
ipywidgets
dot2tex
cython
numpy
cypari
pillow
rst2ipynb
sphinx
notedown
setuptools
psutil
```


We review existing patches, and for those packages that still need them, we create a repository fork and create and deposit an sdist tarball from here.

Issue created by migration from https://trac.sagemath.org/ticket/31543





---

archive/issue_comments_447577.json:
```json
{
    "body": "rst2ipynb could be updated to 0.2.3, that contains our patch",
    "created_at": "2021-06-12T09:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-447577",
    "user": "chapoton"
}
```

rst2ipynb could be updated to 0.2.3, that contains our patch



---

archive/issue_comments_447578.json:
```json
{
    "body": "The pillow patch might not be needed any longer, but someone with macOS will have to check.",
    "created_at": "2021-10-15T05:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-447578",
    "user": "mjo"
}
```

The pillow patch might not be needed any longer, but someone with macOS will have to check.



---

archive/issue_comments_447579.json:
```json
{
    "body": "In #30371, no patches to python packages are applied (as the packages used there come directly from pypi completely bypassing sages package infrastructure).\nThe only real test failures on ubuntu are:\n\n```\n\nFile \"sage/matrix/matrix_integer_dense.pyx\", line 3706, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.determinant\nFailed example:\n    A.determinant(algorithm='linbox',proof=False) == d\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"sage/cpython/dict_del_by_value.pyx\", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, ZZ, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[6]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n**********************************************************************\nFile \"sage/cpython/dict_del_by_value.pyx\", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, QQ, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[8]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, QQ, Integer(1))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n```\n\nThat's good evidence that most patches might no longer be needed (at least on ubuntu and possibly updating the python packages).",
    "created_at": "2021-10-15T10:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-447579",
    "user": "@tobiasdiez"
}
```

In #30371, no patches to python packages are applied (as the packages used there come directly from pypi completely bypassing sages package infrastructure).
The only real test failures on ubuntu are:

```

File "sage/matrix/matrix_integer_dense.pyx", line 3706, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.determinant
Failed example:
    A.determinant(algorithm='linbox',proof=False) == d
Expected:
    True
Got:
    False
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[6]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, QQ, 1)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[8]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, QQ, Integer(1))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```

That's good evidence that most patches might no longer be needed (at least on ubuntu and possibly updating the python packages).
