# Issue 31306: Eliminate use of patches for Python packages

Issue created by migration from https://trac.sagemath.org/ticket/31543

Original creator: mkoeppe

Original creation time: 2021-03-23 05:48:27

CC:  dimpase mjo @tobiasdiez

Installing "sdist + patches" is not supported by Python package infrastructure.


```
$ ./sage -package list --has-file install-requires.txt --has-file patches
rpy2
widgetsnbextension
cvxopt
ipywidgets
dot2tex
cython
numpy
cypari
pillow
rst2ipynb
sphinx
notedown
setuptools
psutil
```


We review existing patches, and for those packages that still need them, we create a repository fork and create and deposit an sdist tarball from here.


---

Comment by chapoton created at 2021-06-12 09:41:05

rst2ipynb could be updated to 0.2.3, that contains our patch


---

Comment by mjo created at 2021-10-15 05:36:56

The pillow patch might not be needed any longer, but someone with macOS will have to check.


---

Comment by @tobiasdiez created at 2021-10-15 10:43:17

In #30371, no patches to python packages are applied (as the packages used there come directly from pypi completely bypassing sages package infrastructure).
The only real test failures on ubuntu are:

```

File "sage/matrix/matrix_integer_dense.pyx", line 3706, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.determinant
Failed example:
    A.determinant(algorithm='linbox',proof=False) == d
Expected:
    True
Got:
    False
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[6]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, QQ, 1)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[8]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, QQ, Integer(1))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```

That's good evidence that most patches might no longer be needed (at least on ubuntu and possibly updating the python packages).
