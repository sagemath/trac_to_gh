# Issue 20565: Sage requires Python 2.7+

archive/issues_020565.json:
```json
{
    "body": "CC:  dimpase embray jdemeyer\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20802\n\n",
    "created_at": "2016-06-10T18:18:39Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Sage requires Python 2.7+",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20565",
    "user": "vbraun"
}
```
CC:  dimpase embray jdemeyer



Issue created by migration from https://trac.sagemath.org/ticket/20802





---

archive/issue_comments_284003.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-06-10T18:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284003",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_284004.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2016-06-10T18:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284004",
    "user": "vbraun"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_284005.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to documentation.",
    "created_at": "2016-06-10T18:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284005",
    "user": "vbraun"
}
```

Changing component from PLEASE CHANGE to documentation.



---

archive/issue_comments_284006.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-10T18:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284006",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_284007.json:
```json
{
    "body": "Just a few months ago, people were complaining about a change (fixed in #20252) which prevented Sage from building with Python 2.6. So I think this is a dangerous change to implement: we will lose some of our user base. See [discussion in sage-devel](https://groups.google.com/d/msg/sage-devel/1hbXSJFWDZw/NNP9L2V9DQAJ). What is the motivation?",
    "created_at": "2016-06-10T18:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284007",
    "user": "jhpalmieri"
}
```

Just a few months ago, people were complaining about a change (fixed in #20252) which prevented Sage from building with Python 2.6. So I think this is a dangerous change to implement: we will lose some of our user base. See [discussion in sage-devel](https://groups.google.com/d/msg/sage-devel/1hbXSJFWDZw/NNP9L2V9DQAJ). What is the motivation?



---

archive/issue_comments_284008.json:
```json
{
    "body": "The fix has been broken in #20721\n\nI've advocated bundling argparse (which is imho a no-brainer) but the 0.1% size increase was deemed unacceptable in #19984.",
    "created_at": "2016-06-10T18:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284008",
    "user": "vbraun"
}
```

The fix has been broken in #20721

I've advocated bundling argparse (which is imho a no-brainer) but the 0.1% size increase was deemed unacceptable in #19984.



---

archive/issue_comments_284009.json:
```json
{
    "body": "Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).\n\nThat said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.",
    "created_at": "2016-06-13T08:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284009",
    "user": "embray"
}
```

Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).

That said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.



---

archive/issue_comments_284010.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).\n> \n> That said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.\n\nthere is demand for Python 2.6 support. It should be easy to set up a VM with one of these LTS Linux systems which are using 2.6 as the default. The question is who will do this, and on what system. There is spare capacity on the UW cluster, I think, to do this.",
    "created_at": "2016-06-13T08:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284010",
    "user": "dimpase"
}
```

Replying to [comment:5 embray]:
> Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).
> 
> That said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.

there is demand for Python 2.6 support. It should be easy to set up a VM with one of these LTS Linux systems which are using 2.6 as the default. The question is who will do this, and on what system. There is spare capacity on the UW cluster, I think, to do this.



---

archive/issue_comments_284011.json:
```json
{
    "body": "So, what should be done to reenable 2.6?",
    "created_at": "2016-06-13T08:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284011",
    "user": "dimpase"
}
```

So, what should be done to reenable 2.6?



---

archive/issue_comments_284012.json:
```json
{
    "body": "I guess also I was confused about using Python as a build dependency versus as a runtime dependency.  As a runtime dependency only Python 2.7 is supported I guess.  But for the build tools 2.6+ makes sense (but should be tested if we're to claim to support it).",
    "created_at": "2016-06-13T08:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284012",
    "user": "embray"
}
```

I guess also I was confused about using Python as a build dependency versus as a runtime dependency.  As a runtime dependency only Python 2.7 is supported I guess.  But for the build tools 2.6+ makes sense (but should be tested if we're to claim to support it).



---

archive/issue_comments_284013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-13T16:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284013",
    "user": "vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_284014.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2016-06-13T16:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284014",
    "user": "vbraun"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_284015.json:
```json
{
    "body": "There is testing via tox for multiple Python versions. Though you need to write tests, obviously. Its not currently tested on the buildbot, thats a todo for the buildbot configuration.",
    "created_at": "2016-06-13T16:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284015",
    "user": "vbraun"
}
```

There is testing via tox for multiple Python versions. Though you need to write tests, obviously. Its not currently tested on the buildbot, thats a todo for the buildbot configuration.



---

archive/issue_comments_284016.json:
```json
{
    "body": "I'm still a little confused here.  What specifically is being tested via tox is there are no tests (and what are we talking about tests *for*)?  \n\nFor example, what command(s) are being run by tox?  Who's running tox, if not the build bot?",
    "created_at": "2016-06-14T08:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284016",
    "user": "embray"
}
```

I'm still a little confused here.  What specifically is being tested via tox is there are no tests (and what are we talking about tests *for*)?  

For example, what command(s) are being run by tox?  Who's running tox, if not the build bot?



---

archive/issue_comments_284017.json:
```json
{
    "body": "I don't understand what you mean; Tests are in `build/tests` and you can run them right now via `cd build && tox`. Developers are supposed to run the tests before making commits, not just the buildbot ;-)",
    "created_at": "2016-06-14T16:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284017",
    "user": "vbraun"
}
```

I don't understand what you mean; Tests are in `build/tests` and you can run them right now via `cd build && tox`. Developers are supposed to run the tests before making commits, not just the buildbot ;-)



---

archive/issue_comments_284018.json:
```json
{
    "body": "Ah, I think that's relatively new.  Wasn't there a few days ago.",
    "created_at": "2016-06-15T08:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284018",
    "user": "embray"
}
```

Ah, I think that's relatively new.  Wasn't there a few days ago.



---

archive/issue_comments_284019.json:
```json
{
    "body": "Ping.\n\nDo we need more than, say\n\n```diff\ndiff --git a/build/bin/sage-uncompress-spkg b/build/bin/sage-uncompress-spkg\nindex 9b72878..e7339ad 100755\n--- a/build/bin/sage-uncompress-spkg\n+++ b/build/bin/sage-uncompress-spkg\n@@ -28,10 +28,22 @@ printing the SPKG.txt file from an old-style spkg.)\n \n from __future__ import print_function\n \n-import argparse\n-import copy\n import os\n import sys\n+try:\n+    import argparse\n+except ImportError:\n+    # Python 2.6 doesn't have it\n+    SAGE_ROOT = os.environ.get(\"SAGE_ROOT\")\n+    if not SAGE_ROOT:\n+        sys.stderr.write(\n+            \"Error: SAGE_ROOT not set, needed to import Sage's argparse module.\\n\")\n+        sys.exit(1)\n+    sys.path.append(os.path.join(SAGE_ROOT, \"build\", \"sage_bootstrap\", \"compat\"))\n+    # we could also first check the presence of Sage's argparse.py here\n+    import argparse\n+    # bail out if that also fails (or suggest something else?)\n+import copy\n import tarfile\n import zipfile\n \n```\n\n?",
    "created_at": "2016-07-01T16:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284019",
    "user": "leif"
}
```

Ping.

Do we need more than, say

```diff
diff --git a/build/bin/sage-uncompress-spkg b/build/bin/sage-uncompress-spkg
index 9b72878..e7339ad 100755
--- a/build/bin/sage-uncompress-spkg
+++ b/build/bin/sage-uncompress-spkg
@@ -28,10 +28,22 @@ printing the SPKG.txt file from an old-style spkg.)
 
 from __future__ import print_function
 
-import argparse
-import copy
 import os
 import sys
+try:
+    import argparse
+except ImportError:
+    # Python 2.6 doesn't have it
+    SAGE_ROOT = os.environ.get("SAGE_ROOT")
+    if not SAGE_ROOT:
+        sys.stderr.write(
+            "Error: SAGE_ROOT not set, needed to import Sage's argparse module.\n")
+        sys.exit(1)
+    sys.path.append(os.path.join(SAGE_ROOT, "build", "sage_bootstrap", "compat"))
+    # we could also first check the presence of Sage's argparse.py here
+    import argparse
+    # bail out if that also fails (or suggest something else?)
+import copy
 import tarfile
 import zipfile
 
```

?



---

archive/issue_comments_284020.json:
```json
{
    "body": "Changing component from documentation to build.",
    "created_at": "2016-07-01T16:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284020",
    "user": "leif"
}
```

Changing component from documentation to build.



---

archive/issue_comments_284021.json:
```json
{
    "body": "If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.",
    "created_at": "2016-07-04T10:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284021",
    "user": "embray"
}
```

If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.



---

archive/issue_comments_284022.json:
```json
{
    "body": "Replying to [comment:16 embray]:\n> If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.\n\nI rather meant to ask whether it's only the above little change we need, but I've meanwhile built Sage 7.3.beta6 from scratch with that on a system with just Python 2.6, which worked without any issues.  (`argparse.py` already gets shipped in `build/sage_bootstrap/compat/` anyway.)\n\nSo now the question is whether I should put a branch *here* or open a separate ticket specifically for `sage-uncompress-spkg` as the ticket's title sounds pretty generic (as if it was meant to be a meta-ticket).",
    "created_at": "2016-07-04T12:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284022",
    "user": "leif"
}
```

Replying to [comment:16 embray]:
> If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.

I rather meant to ask whether it's only the above little change we need, but I've meanwhile built Sage 7.3.beta6 from scratch with that on a system with just Python 2.6, which worked without any issues.  (`argparse.py` already gets shipped in `build/sage_bootstrap/compat/` anyway.)

So now the question is whether I should put a branch *here* or open a separate ticket specifically for `sage-uncompress-spkg` as the ticket's title sounds pretty generic (as if it was meant to be a meta-ticket).



---

archive/issue_comments_284023.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2016-07-04T12:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284023",
    "user": "leif"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_284024.json:
```json
{
    "body": "Changing keywords from \"\" to \"argparse sage-uncompress-spkg\".",
    "created_at": "2016-07-04T12:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284024",
    "user": "leif"
}
```

Changing keywords from "" to "argparse sage-uncompress-spkg".



---

archive/issue_comments_284025.json:
```json
{
    "body": "As long as `sage-uncompress-spkg` is not **needed** to install things into `build/sage_bootstrap/compat/`, this looks good.",
    "created_at": "2016-07-04T12:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284025",
    "user": "dimpase"
}
```

As long as `sage-uncompress-spkg` is not **needed** to install things into `build/sage_bootstrap/compat/`, this looks good.



---

archive/issue_comments_284026.json:
```json
{
    "body": "Just import from `sage_bootstrap.compat.argparse`",
    "created_at": "2016-07-04T12:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284026",
    "user": "vbraun"
}
```

Just import from `sage_bootstrap.compat.argparse`



---

archive/issue_comments_284027.json:
```json
{
    "body": "Replying to [comment:19 vbraun]:\n> Just import from `sage_bootstrap.compat.argparse`\n\nYou mean unconditionally?",
    "created_at": "2016-07-04T13:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284027",
    "user": "leif"
}
```

Replying to [comment:19 vbraun]:
> Just import from `sage_bootstrap.compat.argparse`

You mean unconditionally?



---

archive/issue_comments_284028.json:
```json
{
    "body": "Replying to [comment:20 leif]:\n> Replying to [comment:19 vbraun]:\n> > Just import from `sage_bootstrap.compat.argparse`\n> \n> You mean unconditionally?\n> \nWell, why? The difference is that, AFAII, `bootstrap.compat.argparse` exists, while `build/sage_bootstrap/compat/` might not (yet).",
    "created_at": "2016-07-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284028",
    "user": "dimpase"
}
```

Replying to [comment:20 leif]:
> Replying to [comment:19 vbraun]:
> > Just import from `sage_bootstrap.compat.argparse`
> 
> You mean unconditionally?
> 
Well, why? The difference is that, AFAII, `bootstrap.compat.argparse` exists, while `build/sage_bootstrap/compat/` might not (yet).



---

archive/issue_comments_284029.json:
```json
{
    "body": "`build/sage_bootstrap/compat` is checked into the Sage repo so it will exist as long as you have the source code.",
    "created_at": "2016-07-04T13:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284029",
    "user": "vbraun"
}
```

`build/sage_bootstrap/compat` is checked into the Sage repo so it will exist as long as you have the source code.



---

archive/issue_comments_284030.json:
```json
{
    "body": "I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.",
    "created_at": "2016-07-04T14:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284030",
    "user": "embray"
}
```

I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.



---

archive/issue_comments_284031.json:
```json
{
    "body": "#20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...",
    "created_at": "2016-07-09T14:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284031",
    "user": "leif"
}
```

#20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...



---

archive/issue_comments_284032.json:
```json
{
    "body": "Replying to [comment:24 leif]:\n> #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...\n\nOnly the `stat` module, for two constants, both of which are the same in Python 2.6.",
    "created_at": "2016-07-11T11:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284032",
    "user": "embray"
}
```

Replying to [comment:24 leif]:
> #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...

Only the `stat` module, for two constants, both of which are the same in Python 2.6.



---

archive/issue_comments_284033.json:
```json
{
    "body": "Replying to [comment:25 embray]:\n> Replying to [comment:24 leif]:\n> > #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...\n> \n> Only the `stat` module, for two constants, both of which are the same in Python 2.6.  \n\nYep, but that broke the patch because a change happened within its context.  (While there's no branch here yet anyway, it'll have to depend on #20871 now).",
    "created_at": "2016-07-11T12:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284033",
    "user": "leif"
}
```

Replying to [comment:25 embray]:
> Replying to [comment:24 leif]:
> > #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...
> 
> Only the `stat` module, for two constants, both of which are the same in Python 2.6.  

Yep, but that broke the patch because a change happened within its context.  (While there's no branch here yet anyway, it'll have to depend on #20871 now).



---

archive/issue_comments_284034.json:
```json
{
    "body": "Replying to [comment:23 embray]:\n> I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.\n\nGenerally, I don't like the philosophy of \"try A and if that didn't work, use B instead\". It means two different scenarios which can break. If B is always available and it works, why bother with trying A first?",
    "created_at": "2016-07-11T23:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284034",
    "user": "jdemeyer"
}
```

Replying to [comment:23 embray]:
> I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.

Generally, I don't like the philosophy of "try A and if that didn't work, use B instead". It means two different scenarios which can break. If B is always available and it works, why bother with trying A first?



---

archive/issue_comments_284035.json:
```json
{
    "body": "Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.",
    "created_at": "2016-07-12T07:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284035",
    "user": "vbraun"
}
```

Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.



---

archive/issue_comments_284036.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.\n\n+1",
    "created_at": "2016-07-12T08:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284036",
    "user": "embray"
}
```

Replying to [comment:28 vbraun]:
> Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.

+1



---

archive/issue_comments_284037.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-07-23T23:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284037",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_284038.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2016-07-23T23:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284038",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_284039.json:
```json
{
    "body": "FWIW, I intentionally did *not* import the whole `sage_bootstrap` package just because `sage-uncompress-spkg` in case of Python 2.6 needs the `argparse` module (and only that) from `.../compat/` in my patch.\n\n----\n\nCould you add a `.contains_garbage()` property in order to not pass the whole list of all files in a tarball to `.extractall()` if it returns `False` (which is the normal case -- it should IMHO error out unless given some option to override that otherwise, or *at least* give a warning).\n\nAs is, it essentially does\n\n```sh\ntar xf $TARBALL $( tar tf $TARBALL | cat )\n```\n\nor, worse (and more explicit),\n\n```sh\ngunzip -c $TARBALL | tar xf - $( gunzip -c $TARBALL | tar tf - | cat )\n```\n\nin the normal (non-error) case, where `gunzip` will be `bunzip2` if `$TARBALL` ends with `.bz2` instead of `.gz`; since you're also building a dictionary, `cat` here doesn't even properly reflect the no-op processing of all filenames in the archive (it would have to be some more complex identity function).\n\n\\\\\n\nYou could in addition rename `.names()` to `.valid_names()` say, and add another function `.invalid_names()` (or `.names()` returning *all* names) or whatever (such that it is possible to obtain the ones filtered out, or at least see whether any files got filtered out, but if we give an error or warning message, that should contain *which* files are considered garbage).",
    "created_at": "2016-07-24T15:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284039",
    "user": "leif"
}
```

FWIW, I intentionally did *not* import the whole `sage_bootstrap` package just because `sage-uncompress-spkg` in case of Python 2.6 needs the `argparse` module (and only that) from `.../compat/` in my patch.

----

Could you add a `.contains_garbage()` property in order to not pass the whole list of all files in a tarball to `.extractall()` if it returns `False` (which is the normal case -- it should IMHO error out unless given some option to override that otherwise, or *at least* give a warning).

As is, it essentially does

```sh
tar xf $TARBALL $( tar tf $TARBALL | cat )
```

or, worse (and more explicit),

```sh
gunzip -c $TARBALL | tar xf - $( gunzip -c $TARBALL | tar tf - | cat )
```

in the normal (non-error) case, where `gunzip` will be `bunzip2` if `$TARBALL` ends with `.bz2` instead of `.gz`; since you're also building a dictionary, `cat` here doesn't even properly reflect the no-op processing of all filenames in the archive (it would have to be some more complex identity function).

\\

You could in addition rename `.names()` to `.valid_names()` say, and add another function `.invalid_names()` (or `.names()` returning *all* names) or whatever (such that it is possible to obtain the ones filtered out, or at least see whether any files got filtered out, but if we give an error or warning message, that should contain *which* files are considered garbage).



---

archive/issue_comments_284040.json:
```json
{
    "body": "IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.\n\nI don't mind beautifying the file handling logic, but that doesn't belong to this ticket.",
    "created_at": "2016-07-24T15:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284040",
    "user": "vbraun"
}
```

IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.

I don't mind beautifying the file handling logic, but that doesn't belong to this ticket.



---

archive/issue_comments_284041.json:
```json
{
    "body": "P.S.:  To those unfamiliar with the tar (**t**ape **ar**chive) file format:\n\nIn contrast to e.g. a zip archive, the tar header does *not* contain a \"table of contents\"; to get a list of all files contained in a tarball (or to see whether it contains some file(s)), the *whole archive* has to get read.  (This originates from the sequential access of tapes, and has other advantages.)",
    "created_at": "2016-07-24T15:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284041",
    "user": "leif"
}
```

P.S.:  To those unfamiliar with the tar (**t**ape **ar**chive) file format:

In contrast to e.g. a zip archive, the tar header does *not* contain a "table of contents"; to get a list of all files contained in a tarball (or to see whether it contains some file(s)), the *whole archive* has to get read.  (This originates from the sequential access of tapes, and has other advantages.)



---

archive/issue_comments_284042.json:
```json
{
    "body": "Replying to [comment:33 vbraun]:\n> IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.\n\nSure, but I didn't put `argparse` there, which is unrelated to and independent of all the other stuff there.\n\n\\\\\n\n> I don't mind beautifying the file handling logic, but that doesn't belong to this ticket.\n\nBut completely rewriting it (or changing its structure, and adding tests etc.) does?\n\nThat's really completely unrelated to Python 2.6 support; if you're referring to the title, all we need *here* is to pick up the `argparse` module.  And it's currently a blocker ticket.\n\nI'd suggest to put your restructuring etc. on a follow-up, where we can improve other things as well (to not say remove further regressions introduced previously).\n\nIf the latter still makes it into Sage 7.3, fine, otherwise it doesn't hurt because the main issue has already been fixed here -- quickly and safe.",
    "created_at": "2016-07-24T15:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284042",
    "user": "leif"
}
```

Replying to [comment:33 vbraun]:
> IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.

Sure, but I didn't put `argparse` there, which is unrelated to and independent of all the other stuff there.

\\

> I don't mind beautifying the file handling logic, but that doesn't belong to this ticket.

But completely rewriting it (or changing its structure, and adding tests etc.) does?

That's really completely unrelated to Python 2.6 support; if you're referring to the title, all we need *here* is to pick up the `argparse` module.  And it's currently a blocker ticket.

I'd suggest to put your restructuring etc. on a follow-up, where we can improve other things as well (to not say remove further regressions introduced previously).

If the latter still makes it into Sage 7.3, fine, otherwise it doesn't hurt because the main issue has already been fixed here -- quickly and safe.



---

archive/issue_comments_284043.json:
```json
{
    "body": "Replying to [comment:35 leif]:\n> But completely rewriting it (or changing its structure, and adding tests etc.) does?\n\nYes, especially adding tests that you can run with tox on a variety of Python versions is IMHO crucially important.",
    "created_at": "2016-07-24T15:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284043",
    "user": "vbraun"
}
```

Replying to [comment:35 leif]:
> But completely rewriting it (or changing its structure, and adding tests etc.) does?

Yes, especially adding tests that you can run with tox on a variety of Python versions is IMHO crucially important.



---

archive/issue_comments_284044.json:
```json
{
    "body": "Then also add tests with \"garbage\" in the archive.\n\nAnd a warning message is still missing, which is even more important.",
    "created_at": "2016-07-24T15:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284044",
    "user": "leif"
}
```

Then also add tests with "garbage" in the archive.

And a warning message is still missing, which is even more important.



---

archive/issue_comments_284045.json:
```json
{
    "body": "P.S.:  If we want to continue Python 2.6 support, at least one buildbot should have (and use) it anyway.",
    "created_at": "2016-07-24T15:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284045",
    "user": "leif"
}
```

P.S.:  If we want to continue Python 2.6 support, at least one buildbot should have (and use) it anyway.



---

archive/issue_comments_284046.json:
```json
{
    "body": "Those are good suggestions but not really on scope for this ticket.",
    "created_at": "2016-07-24T17:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284046",
    "user": "vbraun"
}
```

Those are good suggestions but not really on scope for this ticket.



---

archive/issue_comments_284047.json:
```json
{
    "body": "Replying to [comment:39 vbraun]:\n> Those are good suggestions but not really on scope for this ticket.\n\n[https://en.wikipedia.org/wiki/Procrastination](https://en.wikipedia.org/wiki/Procrastination)",
    "created_at": "2016-07-24T20:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284047",
    "user": "leif"
}
```

Replying to [comment:39 vbraun]:
> Those are good suggestions but not really on scope for this ticket.

[https://en.wikipedia.org/wiki/Procrastination](https://en.wikipedia.org/wiki/Procrastination)



---

archive/issue_comments_284048.json:
```json
{
    "body": "`filter_os_files.py` seems a bit overly-specialized.  I might just call that `utils.py`.  But up to you.  LGTM otherwise.",
    "created_at": "2016-07-26T12:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284048",
    "user": "embray"
}
```

`filter_os_files.py` seems a bit overly-specialized.  I might just call that `utils.py`.  But up to you.  LGTM otherwise.



---

archive/issue_comments_284049.json:
```json
{
    "body": "there is [comment:ticket:20870:4] about getting directory permissions right in `sage-uncompress-spkg`.\n\nIs it indeed the case it is fixed here, or was always fixed anyway?\n\n----\n\nEDIT: Cross-ticket comment reference is `[comment:ticket:TTTTT:CCC]`.",
    "created_at": "2016-07-26T13:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284049",
    "user": "dimpase"
}
```

there is [comment:ticket:20870:4] about getting directory permissions right in `sage-uncompress-spkg`.

Is it indeed the case it is fixed here, or was always fixed anyway?

----

EDIT: Cross-ticket comment reference is `[comment:ticket:TTTTT:CCC]`.



---

archive/issue_comments_284050.json:
```json
{
    "body": "I didn't change anything, but `SageTarFile.chmod` (which I didn't change) suggests that permissions are sanitized.",
    "created_at": "2016-07-26T14:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284050",
    "user": "vbraun"
}
```

I didn't change anything, but `SageTarFile.chmod` (which I didn't change) suggests that permissions are sanitized.



---

archive/issue_comments_284051.json:
```json
{
    "body": "what are these errors:\n\n```\nsage -t build/test/capture.py  # ImportError in doctesting framework\n...\n```\n\nAre these files meant to be tested in some other way?",
    "created_at": "2016-07-26T14:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284051",
    "user": "dimpase"
}
```

what are these errors:

```
sage -t build/test/capture.py  # ImportError in doctesting framework
...
```

Are these files meant to be tested in some other way?



---

archive/issue_comments_284052.json:
```json
{
    "body": "Replying to [comment:44 dimpase]:\n> what are these errors:\n> {{{\n> sage -t build/test/capture.py  # ImportError in doctesting framework\n> ...\n> }}}\n> Are these files meant to be tested in some other way?\n\nAt least they're not directly tested by `ptestlong` (which passed for me):\n\n```sh\n$ ./sage -t --long build/test/\n...\n----------------------------------------------------------------------\nsage -t --long build/test/test_package.py  # ImportError in doctesting framework\nsage -t --long build/test/test_is_url.py  # ImportError in doctesting framework\nsage -t --long build/test/test_download.py  # ValueError in doctesting framework\nsage -t --long build/test/runnable.py  # ImportError in doctesting framework\nsage -t --long build/test/test_download_cmdline.py  # ImportError in doctesting framework\nsage -t --long build/test/test_config.py  # ImportError in doctesting framework\nsage -t --long build/test/capture.py  # ImportError in doctesting framework\nsage -t --long build/test/test_mirror_list.py  # ValueError in doctesting framework\nsage -t --long build/test/test_cksum.py  # ImportError in doctesting framework\nsage -t --long build/test/test_tarball.py  # ImportError in doctesting framework\nsage -t --long build/test/test_uncompress.py  # ImportError in doctesting framework\nsage -t --long build/test/test_logger.py  # ValueError in doctesting framework\nsage -t --long build/test/test_package_cmdline.py  # ImportError in doctesting framework\n----------------------------------------------------------------------\n```\n",
    "created_at": "2016-07-26T15:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284052",
    "user": "leif"
}
```

Replying to [comment:44 dimpase]:
> what are these errors:
> {{{
> sage -t build/test/capture.py  # ImportError in doctesting framework
> ...
> }}}
> Are these files meant to be tested in some other way?

At least they're not directly tested by `ptestlong` (which passed for me):

```sh
$ ./sage -t --long build/test/
...
----------------------------------------------------------------------
sage -t --long build/test/test_package.py  # ImportError in doctesting framework
sage -t --long build/test/test_is_url.py  # ImportError in doctesting framework
sage -t --long build/test/test_download.py  # ValueError in doctesting framework
sage -t --long build/test/runnable.py  # ImportError in doctesting framework
sage -t --long build/test/test_download_cmdline.py  # ImportError in doctesting framework
sage -t --long build/test/test_config.py  # ImportError in doctesting framework
sage -t --long build/test/capture.py  # ImportError in doctesting framework
sage -t --long build/test/test_mirror_list.py  # ValueError in doctesting framework
sage -t --long build/test/test_cksum.py  # ImportError in doctesting framework
sage -t --long build/test/test_tarball.py  # ImportError in doctesting framework
sage -t --long build/test/test_uncompress.py  # ImportError in doctesting framework
sage -t --long build/test/test_logger.py  # ValueError in doctesting framework
sage -t --long build/test/test_package_cmdline.py  # ImportError in doctesting framework
----------------------------------------------------------------------
```




---

archive/issue_comments_284053.json:
```json
{
    "body": "No, they aren't meant to be run with the Sage doctest runner. They are meant to execute under tox, which is also ideally suited to run against multiple python versions (see tox.ini):\n\n```\ncd build\ntox\n```\n",
    "created_at": "2016-07-26T16:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284053",
    "user": "vbraun"
}
```

No, they aren't meant to be run with the Sage doctest runner. They are meant to execute under tox, which is also ideally suited to run against multiple python versions (see tox.ini):

```
cd build
tox
```




---

archive/issue_comments_284054.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-26T22:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284054",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_284055.json:
```json
{
    "body": "LGTM",
    "created_at": "2016-07-26T22:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284055",
    "user": "dimpase"
}
```

LGTM



---

archive/issue_comments_284056.json:
```json
{
    "body": "PS. Perhaps for another ticket:\n\n```\npy34 runtests: commands[0] | python3.4 -m unittest discover\n...../home/dima/software/sage/build/sage_bootstrap/download/transfer.py:123: DeprecationWarning: FancyURLopener style of invoking requests is deprecated. Use newer urlopen functions/methods\n  opener = urllib.FancyURLopener()\n```\n",
    "created_at": "2016-07-26T22:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284056",
    "user": "dimpase"
}
```

PS. Perhaps for another ticket:

```
py34 runtests: commands[0] | python3.4 -m unittest discover
...../home/dima/software/sage/build/sage_bootstrap/download/transfer.py:123: DeprecationWarning: FancyURLopener style of invoking requests is deprecated. Use newer urlopen functions/methods
  opener = urllib.FancyURLopener()
```




---

archive/issue_comments_284057.json:
```json
{
    "body": "OMG, fancy is deprecated?!",
    "created_at": "2016-07-26T22:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284057",
    "user": "leif"
}
```

OMG, fancy is deprecated?!



---

archive/issue_comments_284058.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-27T20:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20565#issuecomment-284058",
    "user": "vbraun"
}
```

Resolution: fixed
