# Issue 20565: Sage requires Python 2.7+

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2016-06-10 18:18:39

CC:  dimpase embray jdemeyer




---

Comment by vbraun created at 2016-06-10 18:25:33

New commits:


---

Comment by vbraun created at 2016-06-10 18:25:33

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2016-06-10 18:25:33

Changing component from PLEASE CHANGE to documentation.


---

Comment by vbraun created at 2016-06-10 18:25:33

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2016-06-10 18:44:55

Just a few months ago, people were complaining about a change (fixed in #20252) which prevented Sage from building with Python 2.6. So I think this is a dangerous change to implement: we will lose some of our user base. See [discussion in sage-devel](https://groups.google.com/d/msg/sage-devel/1hbXSJFWDZw/NNP9L2V9DQAJ). What is the motivation?


---

Comment by vbraun created at 2016-06-10 18:49:44

The fix has been broken in #20721

I've advocated bundling argparse (which is imho a no-brainer) but the 0.1% size increase was deemed unacceptable in #19984.


---

Comment by embray created at 2016-06-13 08:11:16

Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).

That said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.


---

Comment by dimpase created at 2016-06-13 08:20:54

Replying to [comment:5 embray]:
> Is use of argparse the only thing that currently breaks compatibility for Python 2.6?  If so I think bundling it is a no-brainer--I've done it in a dozen other projects (though most projects are finally droppping support for Python 2.6).
> 
> That said we either support Python 2.6 or we don't.  If Sage isn't tested against Python 2.6 it doesn't support it as far as anyone should be concerned.  Same goes for any other Python version.  If it's not tested it's not supported.

there is demand for Python 2.6 support. It should be easy to set up a VM with one of these LTS Linux systems which are using 2.6 as the default. The question is who will do this, and on what system. There is spare capacity on the UW cluster, I think, to do this.


---

Comment by dimpase created at 2016-06-13 08:22:17

So, what should be done to reenable 2.6?


---

Comment by embray created at 2016-06-13 08:23:27

I guess also I was confused about using Python as a build dependency versus as a runtime dependency.  As a runtime dependency only Python 2.7 is supported I guess.  But for the build tools 2.6+ makes sense (but should be tested if we're to claim to support it).


---

Comment by vbraun created at 2016-06-13 16:14:36

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2016-06-13 16:14:36

Changing priority from major to blocker.


---

Comment by vbraun created at 2016-06-13 16:16:07

There is testing via tox for multiple Python versions. Though you need to write tests, obviously. Its not currently tested on the buildbot, thats a todo for the buildbot configuration.


---

Comment by embray created at 2016-06-14 08:32:19

I'm still a little confused here.  What specifically is being tested via tox is there are no tests (and what are we talking about tests _for_)?  

For example, what command(s) are being run by tox?  Who's running tox, if not the build bot?


---

Comment by vbraun created at 2016-06-14 16:12:01

I don't understand what you mean; Tests are in `build/tests` and you can run them right now via `cd build && tox`. Developers are supposed to run the tests before making commits, not just the buildbot ;-)


---

Comment by embray created at 2016-06-15 08:25:41

Ah, I think that's relatively new.  Wasn't there a few days ago.


---

Comment by leif created at 2016-07-01 16:14:03

Ping.

Do we need more than, say

```diff
diff --git a/build/bin/sage-uncompress-spkg b/build/bin/sage-uncompress-spkg
index 9b72878..e7339ad 100755
--- a/build/bin/sage-uncompress-spkg
+++ b/build/bin/sage-uncompress-spkg
`@``@` -28,10 +28,22 `@``@` printing the SPKG.txt file from an old-style spkg.)
 
 from __future__ import print_function
 
-import argparse
-import copy
 import os
 import sys
+try:
+    import argparse
+except ImportError:
+    # Python 2.6 doesn't have it
+    SAGE_ROOT = os.environ.get("SAGE_ROOT")
+    if not SAGE_ROOT:
+        sys.stderr.write(
+            "Error: SAGE_ROOT not set, needed to import Sage's argparse module.\n")
+        sys.exit(1)
+    sys.path.append(os.path.join(SAGE_ROOT, "build", "sage_bootstrap", "compat"))
+    # we could also first check the presence of Sage's argparse.py here
+    import argparse
+    # bail out if that also fails (or suggest something else?)
+import copy
 import tarfile
 import zipfile
 
```

?


---

Comment by leif created at 2016-07-01 16:16:48

Changing component from documentation to build.


---

Comment by embray created at 2016-07-04 10:11:59

If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.


---

Comment by leif created at 2016-07-04 12:06:48

Replying to [comment:16 embray]:
> If it's too much trouble, I can also just change this script to use `optparse` instead of `argparse`.  I don't think there's really any `argparse`-specific features that it's strongly relying on.

I rather meant to ask whether it's only the above little change we need, but I've meanwhile built Sage 7.3.beta6 from scratch with that on a system with just Python 2.6, which worked without any issues.  (`argparse.py` already gets shipped in `build/sage_bootstrap/compat/` anyway.)

So now the question is whether I should put a branch _here_ or open a separate ticket specifically for `sage-uncompress-spkg` as the ticket's title sounds pretty generic (as if it was meant to be a meta-ticket).


---

Comment by leif created at 2016-07-04 12:06:48

Changing status from needs_work to needs_info.


---

Comment by leif created at 2016-07-04 12:06:48

Changing keywords from "" to "argparse sage-uncompress-spkg".


---

Comment by dimpase created at 2016-07-04 12:11:14

As long as `sage-uncompress-spkg` is not **needed** to install things into `build/sage_bootstrap/compat/`, this looks good.


---

Comment by vbraun created at 2016-07-04 12:42:06

Just import from `sage_bootstrap.compat.argparse`


---

Comment by leif created at 2016-07-04 13:01:01

Replying to [comment:19 vbraun]:
> Just import from `sage_bootstrap.compat.argparse`

You mean unconditionally?


---

Comment by dimpase created at 2016-07-04 13:07:33

Replying to [comment:20 leif]:
> Replying to [comment:19 vbraun]:
> > Just import from `sage_bootstrap.compat.argparse`
> 
> You mean unconditionally?
> 
Well, why? The difference is that, AFAII, `bootstrap.compat.argparse` exists, while `build/sage_bootstrap/compat/` might not (yet).


---

Comment by vbraun created at 2016-07-04 13:13:43

`build/sage_bootstrap/compat` is checked into the Sage repo so it will exist as long as you have the source code.


---

Comment by embray created at 2016-07-04 14:01:28

I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.


---

Comment by leif created at 2016-07-09 14:53:55

#20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...


---

Comment by embray created at 2016-07-11 11:22:32

Replying to [comment:24 leif]:
> #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...

Only the `stat` module, for two constants, both of which are the same in Python 2.6.


---

Comment by leif created at 2016-07-11 12:04:42

Replying to [comment:25 embray]:
> Replying to [comment:24 leif]:
> > #20871 (merged in 7.3.beta7) added a new import to `sage-uncompress-spkg`...
> 
> Only the `stat` module, for two constants, both of which are the same in Python 2.6.  

Yep, but that broke the patch because a change happened within its context.  (While there's no branch here yet anyway, it'll have to depend on #20871 now).


---

Comment by jdemeyer created at 2016-07-11 23:49:40

Replying to [comment:23 embray]:
> I think it would still be better to try to import the existing package first, and fall back on the compat version shipped with sage otherwise.

Generally, I don't like the philosophy of "try A and if that didn't work, use B instead". It means two different scenarios which can break. If B is always available and it works, why bother with trying A first?


---

Comment by vbraun created at 2016-07-12 07:29:17

Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.


---

Comment by embray created at 2016-07-12 08:01:54

Replying to [comment:28 vbraun]:
> Thats the standard pattern for vendoring python libraries, I don't think its particularly fruitful to discuss it here.

+1


---

Comment by vbraun created at 2016-07-23 23:03:54

New commits:


---

Comment by vbraun created at 2016-07-23 23:03:54

Changing status from needs_info to needs_review.


---

Comment by leif created at 2016-07-24 15:02:09

FWIW, I intentionally did _not_ import the whole `sage_bootstrap` package just because `sage-uncompress-spkg` in case of Python 2.6 needs the `argparse` module (and only that) from `.../compat/` in my patch.

----

Could you add a `.contains_garbage()` property in order to not pass the whole list of all files in a tarball to `.extractall()` if it returns `False` (which is the normal case -- it should IMHO error out unless given some option to override that otherwise, or _at least_ give a warning).

As is, it essentially does

```sh
tar xf $TARBALL $( tar tf $TARBALL | cat )
```

or, worse (and more explicit),

```sh
gunzip -c $TARBALL | tar xf - $( gunzip -c $TARBALL | tar tf - | cat )
```

in the normal (non-error) case, where `gunzip` will be `bunzip2` if `$TARBALL` ends with `.bz2` instead of `.gz`; since you're also building a dictionary, `cat` here doesn't even properly reflect the no-op processing of all filenames in the archive (it would have to be some more complex identity function).

\\

You could in addition rename `.names()` to `.valid_names()` say, and add another function `.invalid_names()` (or `.names()` returning _all_ names) or whatever (such that it is possible to obtain the ones filtered out, or at least see whether any files got filtered out, but if we give an error or warning message, that should contain _which_ files are considered garbage).


---

Comment by vbraun created at 2016-07-24 15:22:14

IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.

I don't mind beautifying the file handling logic, but that doesn't belong to this ticket.


---

Comment by leif created at 2016-07-24 15:24:00

P.S.:  To those unfamiliar with the tar (*t*ape *ar*chive) file format:

In contrast to e.g. a zip archive, the tar header does _not_ contain a "table of contents"; to get a list of all files contained in a tarball (or to see whether it contains some file(s)), the _whole archive_ has to get read.  (This originates from the sequential access of tapes, and has other advantages.)


---

Comment by leif created at 2016-07-24 15:39:19

Replying to [comment:33 vbraun]:
> IHMO adding subdirectories of packages to sys.path is to be avoided as it can cause confusion.

Sure, but I didn't put `argparse` there, which is unrelated to and independent of all the other stuff there.

\\

> I don't mind beautifying the file handling logic, but that doesn't belong to this ticket.

But completely rewriting it (or changing its structure, and adding tests etc.) does?

That's really completely unrelated to Python 2.6 support; if you're referring to the title, all we need _here_ is to pick up the `argparse` module.  And it's currently a blocker ticket.

I'd suggest to put your restructuring etc. on a follow-up, where we can improve other things as well (to not say remove further regressions introduced previously).

If the latter still makes it into Sage 7.3, fine, otherwise it doesn't hurt because the main issue has already been fixed here -- quickly and safe.


---

Comment by vbraun created at 2016-07-24 15:41:36

Replying to [comment:35 leif]:
> But completely rewriting it (or changing its structure, and adding tests etc.) does?

Yes, especially adding tests that you can run with tox on a variety of Python versions is IMHO crucially important.


---

Comment by leif created at 2016-07-24 15:44:48

Then also add tests with "garbage" in the archive.

And a warning message is still missing, which is even more important.


---

Comment by leif created at 2016-07-24 15:51:16

P.S.:  If we want to continue Python 2.6 support, at least one buildbot should have (and use) it anyway.


---

Comment by vbraun created at 2016-07-24 17:57:36

Those are good suggestions but not really on scope for this ticket.


---

Comment by leif created at 2016-07-24 20:12:33

Replying to [comment:39 vbraun]:
> Those are good suggestions but not really on scope for this ticket.

[https://en.wikipedia.org/wiki/Procrastination](https://en.wikipedia.org/wiki/Procrastination)


---

Comment by embray created at 2016-07-26 12:19:47

`filter_os_files.py` seems a bit overly-specialized.  I might just call that `utils.py`.  But up to you.  LGTM otherwise.


---

Comment by dimpase created at 2016-07-26 13:26:02

there is [comment:ticket:20870:4] about getting directory permissions right in `sage-uncompress-spkg`.

Is it indeed the case it is fixed here, or was always fixed anyway?

----

EDIT: Cross-ticket comment reference is `[comment:ticket:TTTTT:CCC]`.


---

Comment by vbraun created at 2016-07-26 14:00:19

I didn't change anything, but `SageTarFile.chmod` (which I didn't change) suggests that permissions are sanitized.


---

Comment by dimpase created at 2016-07-26 14:13:09

what are these errors:

```
sage -t build/test/capture.py  # ImportError in doctesting framework
...
```

Are these files meant to be tested in some other way?


---

Comment by leif created at 2016-07-26 15:42:34

Replying to [comment:44 dimpase]:
> what are these errors:
> {{{
> sage -t build/test/capture.py  # ImportError in doctesting framework
> ...
> }}}
> Are these files meant to be tested in some other way?

At least they're not directly tested by `ptestlong` (which passed for me):

```sh
$ ./sage -t --long build/test/
...
----------------------------------------------------------------------
sage -t --long build/test/test_package.py  # ImportError in doctesting framework
sage -t --long build/test/test_is_url.py  # ImportError in doctesting framework
sage -t --long build/test/test_download.py  # ValueError in doctesting framework
sage -t --long build/test/runnable.py  # ImportError in doctesting framework
sage -t --long build/test/test_download_cmdline.py  # ImportError in doctesting framework
sage -t --long build/test/test_config.py  # ImportError in doctesting framework
sage -t --long build/test/capture.py  # ImportError in doctesting framework
sage -t --long build/test/test_mirror_list.py  # ValueError in doctesting framework
sage -t --long build/test/test_cksum.py  # ImportError in doctesting framework
sage -t --long build/test/test_tarball.py  # ImportError in doctesting framework
sage -t --long build/test/test_uncompress.py  # ImportError in doctesting framework
sage -t --long build/test/test_logger.py  # ValueError in doctesting framework
sage -t --long build/test/test_package_cmdline.py  # ImportError in doctesting framework
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2016-07-26 16:40:51

No, they aren't meant to be run with the Sage doctest runner. They are meant to execute under tox, which is also ideally suited to run against multiple python versions (see tox.ini):

```
cd build
tox
```



---

Comment by dimpase created at 2016-07-26 22:03:27

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2016-07-26 22:03:27

LGTM


---

Comment by dimpase created at 2016-07-26 22:04:51

PS. Perhaps for another ticket:

```
py34 runtests: commands[0] | python3.4 -m unittest discover
...../home/dima/software/sage/build/sage_bootstrap/download/transfer.py:123: DeprecationWarning: FancyURLopener style of invoking requests is deprecated. Use newer urlopen functions/methods
  opener = urllib.FancyURLopener()
```



---

Comment by leif created at 2016-07-26 22:21:27

OMG, fancy is deprecated?!


---

Comment by vbraun created at 2016-07-27 20:24:40

Resolution: fixed
