# Issue 14166: Run IPython tests with --color=NoColors

Issue created by migration from https://trac.sagemath.org/ticket/14370

Original creator: jdemeyer

Original creation time: 2013-03-27 22:39:01

Assignee: was

On some systems:

```
Running doctests with ID 2013-03-27-15-38-22-527abcba.
Doctesting 2 files.
sage -t --long sage/misc/interpreter.py
**********************************************************************
File "sage/misc/interpreter.py", line 150, in sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    u'sage'
**********************************************************************
File "sage/misc/interpreter.py", line 566, in sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    [ false, true, true, false, true, false, true, false, false, false ]
**********************************************************************
2 items had failures:
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 2 failures, 3.3 s]
sage -t --long sage/misc/sage_extension.py
**********************************************************************
File "sage/misc/sage_extension.py", line 34, in sage.misc.sage_extension
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    2
**********************************************************************
File "sage/misc/sage_extension.py", line 39, in sage.misc.sage_extension
Failed example:
    shell.run_cell('%time 594.factor()')
Expected:
    CPU times: user ...
    Wall time: ...
    2 * 3^3 * 11
Got:
    CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
    Wall time: 0.00 s
    2 * 3^3 * 11
**********************************************************************
File "sage/misc/sage_extension.py", line 75, in sage.misc.sage_extension.SageMagics.runfile
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    2
**********************************************************************
File "sage/misc/sage_extension.py", line 99, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    2
**********************************************************************
File "sage/misc/sage_extension.py", line 103, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    3
**********************************************************************
File "sage/misc/sage_extension.py", line 106, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('attached_files()')
Expected:
    []
Got:
    []
**********************************************************************
File "sage/misc/sage_extension.py", line 127, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    2
**********************************************************************
File "sage/misc/sage_extension.py", line 131, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    3
**********************************************************************
File "sage/misc/sage_extension.py", line 134, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('attached_files()')
Expected:
    []
Got:
    []
**********************************************************************
File "sage/misc/sage_extension.py", line 210, in sage.misc.sage_extension.SagePlainTextFormatter
Failed example:
    shell.run_cell('a = identity_matrix(ZZ, 2); [a,a]')
Expected:
    [
    [1 0]  [1 0]
    [0 1], [0 1]
    ]
Got:
    [
    [1 0]  [1 0]
    [0 1], [0 1]
    ]
**********************************************************************
5 items had failures:
   2 of  12 in sage.misc.sage_extension
   3 of  14 in sage.misc.sage_extension.SageMagics.attach
   3 of  14 in sage.misc.sage_extension.SageMagics.pre_run_code_hook
   1 of   9 in sage.misc.sage_extension.SageMagics.runfile
   1 of   5 in sage.misc.sage_extension.SagePlainTextFormatter
    [55 tests, 10 failures, 2.3 s]
----------------------------------------------------------------------
sage -t --long sage/misc/interpreter.py  # 2 doctests failed
sage -t --long sage/misc/sage_extension.py  # 10 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.7 seconds
    cpu time: 0.8 seconds
    cumulative wall time: 5.6 seconds
```



---

Comment by jdemeyer created at 2013-03-27 23:03:16

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-03-28 02:24:51

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2013-03-28 14:28:09

The OSX issue is the same as #12263, either set `TERM=dumb` or ellipsize the smm escape sequence that may or may not be there.

It would be nice to run with #14290 to verify that the problem actually is color and not some other escape sequence.


---

Comment by jdemeyer created at 2013-03-28 17:14:08

Excellent diagnosis Volker!


---

Comment by jhpalmieri created at 2013-03-28 17:34:27

On OS X 10.8: I ran `make ptest`, and all tests passed. Immediately afterward, I ran

```
./sage -tp devel/sage/sage/misc/interpreter.py devel/sage/sage/misc/sage_extension.py
```

and I got the failures listed here. Does that make any sense?


---

Comment by vbraun created at 2013-03-28 17:46:01

Maybe `make ptest` changes `TERM` somewhere on OSX? Try with #14290 to actually see the escape sequences, otherwise we can just guess.


---

Comment by jhpalmieri created at 2013-03-28 18:08:46

With #14290:

```
$ ./sage -tp devel/sage/sage/misc/interpreter.py devel/sage/sage/misc/sage_extension.py
Running doctests with ID 2013-03-28-10-54-43-7fc9b4da.
Doctesting 2 files using 2 threads.
sage -t devel/sage/sage/misc/sage_extension.py
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 34, in sage.misc.sage_extension
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    <CSI-0;31m><CSI-0m>2
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 39, in sage.misc.sage_extension
Failed example:
    shell.run_cell('%time 594.factor()')
Expected:
    CPU times: user ...
    Wall time: ...
    2 * 3^3 * 11
Got:
    CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
    Wall time: 0.00 s
    <CSI-0;31m><CSI-0m>2 * 3^3 * 11
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 75, in sage.misc.sage_extension.SageMagics.runfile
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    <CSI-0;31m><CSI-0m>2
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 99, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    <CSI-0;31m><CSI-0m>2
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 103, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    <CSI-0;31m><CSI-0m>3
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 106, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('attached_files()')
Expected:
    []
Got:
    <CSI-0;31m><CSI-0m>[]
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 127, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('a')
Expected:
    2
Got:
    <CSI-0;31m><CSI-0m>2
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 131, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    <CSI-0;31m><CSI-0m>3
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 134, in sage.misc.sage_extension.SageMagics.pre_run_code_hook
Failed example:
    shell.run_cell('attached_files()')
Expected:
    []
Got:
    <CSI-0;31m><CSI-0m>[]
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 210, in sage.misc.sage_extension.SagePlainTextFormatter
Failed example:
    shell.run_cell('a = identity_matrix(ZZ, 2); [a,a]')
Expected:
    [
    [1 0]  [1 0]
    [0 1], [0 1]
    ]
Got:
    <CSI-0;31m><CSI-0m>[
    [1 0]  [1 0]
    [0 1], [0 1]
    ]
**********************************************************************
5 items had failures:
   2 of  12 in sage.misc.sage_extension
   3 of  14 in sage.misc.sage_extension.SageMagics.attach
   3 of  14 in sage.misc.sage_extension.SageMagics.pre_run_code_hook
   1 of   9 in sage.misc.sage_extension.SageMagics.runfile
   1 of   5 in sage.misc.sage_extension.SagePlainTextFormatter
    [55 tests, 10 failures, 2.6 s]
sage -t devel/sage/sage/misc/interpreter.py
**********************************************************************
File "devel/sage/sage/misc/interpreter.py", line 150, in sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    <CSI-0;31m><CSI-0m>u'sage'
**********************************************************************
File "devel/sage/sage/misc/interpreter.py", line 566, in sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    <CSI-0;31m><CSI-0m>[ false, true, true, false, true, false, true, false, false, false ]
**********************************************************************
2 items had failures:
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 2 failures, 8.8 s]
----------------------------------------------------------------------
sage -t devel/sage/sage/misc/sage_extension.py  # 10 doctests failed
sage -t devel/sage/sage/misc/interpreter.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 8.9 seconds
    cpu time: 0.9 seconds
    cumulative wall time: 11.3 seconds
```

This command yields the same failures:

```
./sage -tp devel/sage/sage/misc/
```

This one passes all tests:

```
spkg/pipestatus "./sage -tp devel/sage/sage/misc 2>&1" "tee -a testmisc.log"
```



---

Comment by jdemeyer created at 2013-03-28 18:17:45

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-03-28 20:20:44

The patch doesn't apply cleanly to 5.9.beta1. What are the dependencies?


---

Comment by jhpalmieri created at 2013-03-28 21:40:13

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2013-03-28 21:40:13

The code makes sense, and this seems to fix the problem. A minor fix:

```diff
diff --git a/sage/doctest/test.py b/sage/doctest/test.py
--- a/sage/doctest/test.py
+++ b/sage/doctest/test.py
@@ -13,7 +13,7 @@
     sage: tests_dir = os.path.join(SAGE_SRC, 'sage', 'doctest', 'tests')
     sage: tests_env = dict(os.environ)
 
-Unset :envvar:TERM when running doctests, see :trac:`14370`::
+Unset :envvar:`TERM` when running doctests, see :trac:`14370`::
 
     sage: try:
     ....:     del tests_env['TERM']
```

Along these lines, is there a ticket to add files from the `doctest` directory to the reference manual?


---

Attachment


---

Comment by jdemeyer created at 2013-03-28 21:47:49

Replying to [comment:12 jhpalmieri]:
> Along these lines, is there a ticket to add files from the `doctest` directory to the reference manual?
See #14376, you can go ahead and make a patch for it.


---

Attachment


---

Comment by jdemeyer created at 2013-04-01 12:39:04

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-04-01 12:40:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-04-01 12:40:05

I changed the patch slightly, I think this is a better solution. Note the change to `doctest/forker.py`, needs review.


---

Comment by vbraun created at 2013-04-01 13:06:16

I prefer v2, too. But `run_doctests(sage.misc.interpreter)` then still coughs up an escape code in `shell.run_cell('List( [1..10], IsPrime )')`, because that is not going through the doctest forker. I suppose `run_doctests` need not only disable color in the test shell but also the defaults if the doctest creates yet another shell.


---

Attachment

Initial patch


---

Comment by vbraun created at 2013-04-01 13:21:36

I've added the patch that does that. Positive review to Jeroen's patch.


---

Comment by roed created at 2013-04-02 11:35:14

Changing status from needs_review to positive_review.


---

Comment by roed created at 2013-04-02 11:35:14

Looks good to me.


---

Comment by jdemeyer created at 2013-04-02 11:45:18

Resolution: fixed
