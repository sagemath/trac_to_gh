# Issue 33710: Crystals: "view" command doesn't work

Issue created by migration from https://trac.sagemath.org/ticket/33947

Original creator: jhpalmieri

Original creation time: 2022-06-02 23:05:26

CC:  tscrim

The command `view(crystals.Tableaux("A3",shape=[2,1]))` produces broken LaTeX and hence fails. (The attachment is the file as printed by `view(..., debug=True)`.) Replacing each argument `L={\hbox...}` with something simpler produces a LaTeX document which compiles, so that seems to be where the problem lies.


---

Attachment


---

Comment by slabbe created at 2022-06-03 07:22:17

For me, on Ubuntu 20.04 and `SageMath version 9.7.beta1, Release Date: 2022-05-26`, the command`view(crystals.Tableaux("A3",shape=[2,1]))` works ok and opens the pdf which looks nice.

So I can't reproduce the problem.


---

Comment by jhpalmieri created at 2022-06-03 17:50:14

Can you successfully run `latex` or `pdflatex` on the attached file? Maybe it's a difference in the version of LaTeX/TeX-Live/etc. that's installed.


---

Comment by slabbe created at 2022-06-03 20:06:45

I can't compile it:


```
$ wget https://trac.sagemath.org/raw-attachment/ticket/33947/crystals.tex
$ pdflatex crystals.tex
This is pdfTeX, Version 3.14159265-2.6-1.40.20 (TeX Live 2019/Debian) 
(preloaded format=pdflatex 2020.9.1)  3 JUN 2022 22:02

...

File: ursfs.fd 1998/03/24 rsfs font definition file (jk)
)
! Illegal parameter number in definition of \cmdGR@vertex@L.
<to be read again> 
                   1
l.137 }$},x=4.8995cm,y=2.7442cm]{v0}
                                    
? 
! Illegal parameter number in definition of \cmdGR@vertex@L.
<to be read again> 
                   1
l.137 }$},x=4.8995cm,y=2.7442cm]{v0}
                                    
? 
! Undefined control sequence.
\cmdGR@vertex@L ->\hbox {${\def \lr 
                                    ##1{\multicolumn {1}{|@{\hspace {.6ex}}c...
l.137 }$},x=4.8995cm,y=2.7442cm]{v0}
                                    
? 
! Illegal parameter number in definition of \@gtempa.
<to be read again> 
                   1
l.137 }$},x=4.8995cm,y=2.7442cm]{v0}
                                    
? 
! Undefined control sequence.
l.138 ...=circle},LabelOut=false,L=\hbox{${\def\lr
                                                  #1{\multicolumn{1}{|@{\hsp...

? 
! Illegal parameter number in definition of \@gtempa.
<to be read again> 
                   1
l.138 ...ircle},LabelOut=false,L=\hbox{${\def\lr#1
                                                  {\multicolumn{1}{|@{\hspac...

? 
)
! Incomplete \iffalse; all text was ignored after line 138.
<inserted text> 
                \fi 
<*> crystals.tex

```


Same error with `latex crystals.tex`.


---

Comment by jhpalmieri created at 2022-06-03 21:28:52

Thank you for checking that. Can you run `view(crystals.Tableaux("A3",shape=[2,1]), debug=True)`? This should print a LaTeX file which apparently works on your machine. Can you see the differences between the one you get and the one I posted?


---

Comment by jhpalmieri created at 2022-06-03 21:30:02

Maybe it produces different LaTeX depending on what packages are available on your system?


---

Comment by jhpalmieri created at 2022-06-05 01:07:31

Now I'm guessing that you have `dot2tex` installed. If I install that, then a different LaTeX file is produced, one that works. Without `dot2tex`, it relies on apparently bad `tkz-graph` code.


---

Comment by @DaveWitteMorris created at 2022-06-05 20:54:31

FYI: This is not a new bug.  It was discussed 5 years previously on [tex.stackexchange.com](https://tex.stackexchange.com/questions/342983/on-drawing-a-crystal-graph-i-have-a-trouble-illegal-parameter-number-in-defi) and [sage-support](https://groups.google.com/g/sage-support/c/BOlqVpkJzAQ/m/vQEgCbmwBwAJ), but no ticket seems to have been opened.


---

Comment by jhpalmieri created at 2022-06-06 21:38:32

This looks like a real mess to fix. The issue is the file `sage/combinat/output.py`, which is used to typeset the vertex labels here: the LaTeX code is too complicated for a vertex label in `tkz-graph`. (See https://tex.stackexchange.com/questions/646826/complicated-vertex-labels-with-tkz-graph/646834#646834.) We could remove the `\lr` macro and just include the corresponding code in the LaTeX: change

```
\hbox{${\def\lr#1{\multicolumn{1}{|@{\hspace{.6ex}}c@{\hspace{.6ex}}|}{\raisebox{-.3ex}{$#1$}}}\raisebox{-.6ex}
{$\begin{array}[b]{*{2}c}\cline{1-2}\lr{1}&\lr{1}\\\cline{1-2}\lr{2}\\\cline{1-1}\end{array}$}}$}
```

to (option 1)

```
\hbox{$\begin{array}[b]{*{2}{c}}\cline{1-2}
\multicolumn{1}{|@{\hspace{.6ex}}c@{\hspace{.6ex}}|}{\raisebox{-.3ex}1}&\multicolumn{1}{|@{\hspace{.6ex}}c@{\hspace{.6ex}}|}{\raisebox{-.3ex}1}\\
\cline{1-2}\multicolumn{1}{|@{\hspace{.6ex}}c@{\hspace{.6ex}}|}{\raisebox{-.3ex}2}
\\\cline{1-1}\end{array}$}
```

If we want simpler LaTeX code but less tight output, we can also just do (option 2)

```
$\begin{array}{*2{|c}|}\cline{1-2}
2&4\\\cline{1-2}
3\\\cline{1-1}
\end{array}$
```

(See the attachment for a picture with the original version and the "less tight" version.)

The annoying thing is that this code is used in many places in `sage.combinat`, and I don't know how important the esthetics are if we went with option 2, and I don't think I would be able to check each of the instances where it is used. If we went with option 1, then many doctests would have to be fixed.


---

Attachment

In principle, something like this should work for option 1, but it's not quite right:

```diff
diff --git a/src/sage/combinat/output.py b/src/sage/combinat/output.py
index 95b5cd0c04..09271aec3b 100644
--- a/src/sage/combinat/output.py
+++ b/src/sage/combinat/output.py
@@ -20,7 +20,8 @@ from sage.combinat.tableau import Tableaux
 
 # The tex macro used to latex individual cells in an array (as a template).
 # When using bar should be replaced by '|' or ''.
-lr_macro = Template(r'\def\lr#1{\multicolumn{1}{$bar@{\hspace{.6ex}}c@{\hspace{.6ex}}$bar}{\raisebox{-.3ex}{$$#1$$}}}')
+# lr_macro = Template(r'\def\lr#1{\multicolumn{1}{$bar@{\hspace{.6ex}}c@{\hspace{.6ex}}$bar}{\raisebox{-.3ex}{$$#1$$}}}')
+lr_macro = Template(r'{\multicolumn{1}{$bar@{\hspace{.6ex}}c@{\hspace{.6ex}}$bar}{\raisebox{-.3ex}{$$ $elt $$}}}')
 
 def tex_from_array(array, with_lines=True):
     r"""
@@ -170,11 +171,10 @@ def tex_from_array(array, with_lines=True):
         }
         sage: Tableaux.options._reset()
     """
-    lr=lr_macro.substitute(bar='|' if with_lines else '')
     if Tableaux.options.convention == "English":
-        return '{%s\n%s\n}' % (lr, tex_from_skew_array(array, with_lines))
+        return '{%s\n}' % (tex_from_skew_array(array, with_lines))
     else:
-        return '{%s\n%s\n}' % (lr, tex_from_skew_array(array[::-1], with_lines, align='t'))
+        return '{%s\n}' % (tex_from_skew_array(array[::-1], with_lines, align='t'))
 
 
 def tex_from_array_tuple(a_tuple, with_lines=True):
@@ -240,12 +240,11 @@ def tex_from_array_tuple(a_tuple, with_lines=True):
         }
         sage: Tableaux.options._reset()
     """
-    lr=lr_macro.substitute(bar='|' if with_lines else '')
     if Tableaux.options.convention == "English":
-        return '{%s\n%s\n}' % (lr, ','.join(
+        return '{%s\n%s\n}' % ('', ','.join(
             r'\emptyset' if comp==[] else tex_from_skew_array(comp, with_lines) for comp in a_tuple))
     else:
-        return '{%s\n%s\n}' % (lr, ','.join(
+        return '{%s\n%s\n}' % ('', ','.join(
             r'\emptyset' if comp==[] else tex_from_skew_array(comp[::-1], with_lines, align='t') for comp in a_tuple))
 
 
@@ -302,14 +301,17 @@ def tex_from_skew_array(array, with_lines=False, align='b'):
                 start=min(nones[r], nones[r-1])
                 finish=max(len(array[r]), len(array[r-1]))
             return r'\\' if start>finish else r'\\\cline{%s-%s}'%(start, finish)
+        bar = '|'
     else:
         end_line=lambda r: r'\\'
+        bar = ''
 
     # now we draw the array
     tex=r'\raisebox{-.6ex}{$\begin{array}[%s]{*{%s}c}'%(align,max(map(len,array)))
     tex+=end_line(0)+'\n'
     for r in range(len(array)):
-        tex+='&'.join('' if c is None else r'\lr{%s}'%(c,) for c in array[r])
+        tex+='&'.join('' if c is None else lr_macro.substitute({'bar': bar, 'elt': c})
+                      for c in array[r])
         tex+=end_line(r+1)+'\n'
     return tex+r'\end{array}$}'
 
```



---

Comment by tscrim created at 2022-06-07 00:17:34

Some quick comments:

- You need to be careful about skew cases versus straight cases for tableaux. IIRC, the current code was written to work for both simultaneously as skew tableaux contain regular tableaux. Option 2 would split the two and result in some code redundancy.
- The `lr` makes a subtle but noticeable change to where the letters are placed within the box; it does make it look better in my opinion. I would prefer to leave it in, but this is not too strong of an opinion.
- Implicit in your discussion is the fact that it is the (di)graph code with tableaux that contains the underlying problem, not anything specific to the crystals code.
- IMO, the `tkz-graph` should be able to take this more arbitrary latex code and compile it correctly. I would argue it is an upstream bug. Plus the output really looks quite bad compared to the `dot2tex` version (compare with Nakajima monomials). What about if other combinatorial objects that get used as vertices of a graph (say, the Hasse diagram of a poset)? I don’t think the right approach is for us to find Tex code that `tkz-graph` will accept (especially when the “dot2tex“ and any latex compiler is fine with it).


---

Comment by jhpalmieri created at 2022-06-07 02:08:50

The last point is certainly an issue. Why bother working on the `tkz-graph` version when the `dot2tex` version is so much nicer? Can we just recommend or require `dot2tex` for some situations? `view(crystals.KacModule(...)` seems to require this currently. How do we detect the relevant situations?


---

Comment by jhpalmieri created at 2022-06-07 16:53:09

I just tried examples of many of the crystals in the crystal catalog, and the default (non-`dot2tex`) LaTeX output looks bad or fails for most of them. Should we just require `dot2tex` for these? I don't think we need to do this for all graphs or all digraphs: I think the issue is the combination of the graph plotting with complicated vertex labels.

An example:

```
sage: R = RootSystem(['C',3,1])
sage: La = R.weight_space().basis()
sage: LS = crystals.ProjectedLevelZeroLSPaths(La[1]+La[3])
sage: view(LS)
```

This one is a little better, but not much, if you do

```
sage: D = LS.digraph()
sage: D.set_latex_options(vertex_labels=False)
sage: view(D)
```

Either case looks much better if `dot2tex` is installed. See the attachments for the output from `view(LS)` with and without `dot2tex`.


---

Attachment


---

Comment by slabbe created at 2022-06-07 21:06:47

If I remember well, Nicolas Thiéry and Anne Schilling were definitely using `dot2tex` when working with this code.

One way of making sure that dot2tex is installed is to first do this in the code (taken from `sage/misc/latex_standalone.py`):


```python
        from sage.features.graphviz import Graphviz
        Graphviz().require()
        from sage.features import PythonModule
        PythonModule("dot2tex").require()
```



---

Comment by jhpalmieri created at 2022-06-07 22:07:37

So we could add this snippet, for example, to the `_latex_` method for crystals in `sage.categories.crystals`?


---

Comment by tscrim created at 2022-06-08 02:34:57

Replying to [comment:16 jhpalmieri]:
> So we could add this snippet, for example, to the `_latex_` method for crystals in `sage.categories.crystals`?

I am a strong -1 on doing this. Not only does it "work" for some crystals, you can reproduce the same failure by creating a digraph with tableaux (maybe even partitions; I would have to check) as the vertices. We could have a warning for crystals where we suggest that the user installs `dot2tex`, but this currently is not possible on prebuilt binaries (we cannot include `dot2tex` because of incompatible licenses IIRC). I feel like errorring out just for crystals is just shooting the messenger.

Side note: I think improving detecting and using a system install of `dot2tex` will go a fair ways to mollifying me here. We also require a user to have a system install of `graphviz`.


---

Comment by jhpalmieri created at 2022-06-08 02:47:47

So do you suggest doing nothing?

Note the status quo in this example, by the way:

```
sage: view(crystals.KacModule(['A', [1,1]], [2], [1]))

An error occurred when importing dot2tex.

Please see :meth:`sage.graphs.generic_graph.GenericGraph.layout_graphviz`
for installation instructions.

...

ModuleNotFoundError: No module named 'dot2tex'
```



---

Comment by tscrim created at 2022-06-08 03:04:58

Replying to [comment:18 jhpalmieri]:
> So do you suggest doing nothing?

I think we need to fix `tkz-graph` and allow it to handle more general latex code. Although that is probably easier said than done.

> Note the status quo in this example, by the way:
> {{{
> sage: view(crystals.KacModule(['A', [1,1]], [2], [1]))
> 
> An error occurred when importing dot2tex.
> 
> Please see :meth:`sage.graphs.generic_graph.GenericGraph.layout_graphviz`
> for installation instructions.
> 
> ...
> 
> ModuleNotFoundError: No module named 'dot2tex'
> }}}

IMO (and IIRC) that is a bug on our part for supercrystals with not checking for `dot2tex` first.

Now we could do the same thing and have any crystal graph return a digraph with `format="dot2tex"` so the failure hints at what the user can do to get nice pictures. Yet, I see that as curing the symptoms rather than the disease.


---

Comment by @DaveWitteMorris created at 2022-06-08 04:13:09

I think dot2tex is [licensed under the MIT licence](https://dot2tex.readthedocs.io/en/latest/license.html), and I think that is [compatible with GPL](https://www.gnu.org/licenses/license-list.en.html#Expat). So distributing dot2tex does seem to be an option. 

I don't understand the details of the discussion, but if dot2tex solves the problem, then my uninformed opinion is that it would be best not to reinvent the wheel.


---

Comment by jhpalmieri created at 2022-06-08 04:14:17

There is the approach in comment:9 and comment:10. I can't help with fixing `tkz-graph`. Given the terrible output when not using `dot2tex`, it seems that at least we should advocate its installation somewhere, if we don't actually require it. To be honest, though, this ticket is very low on my list of priorities. I don't actually care about plotting crystals, and if I did, I now know to install `dot2tex` first.


---

Comment by jhpalmieri created at 2022-06-08 04:15:53

Replying to [comment:20 gh-DaveWitteMorris]:
> I think dot2tex is [licensed under the MIT licence](https://dot2tex.readthedocs.io/en/latest/license.html), and I think that is [compatible with GPL](https://www.gnu.org/licenses/license-list.en.html#Expat). So distributing dot2tex does seem to be an option. 
> 
> I don't understand the details of the discussion, but if dot2tex solves the problem, then my uninformed opinion is that it would be best not to reinvent the wheel.
Maybe the issue is instead the `graphviz` license, since `graphviz` is a dependency for `dot2tex`.


---

Comment by @DaveWitteMorris created at 2022-06-08 04:22:49

Replying to [comment:22 jhpalmieri]:
> Replying to [comment:20 gh-DaveWitteMorris]:
> > I think dot2tex is [licensed under the MIT licence](https://dot2tex.readthedocs.io/en/latest/license.html), and I think that is [compatible with GPL](https://www.gnu.org/licenses/license-list.en.html#Expat). So distributing dot2tex does seem to be an option. 
> > 
> > I don't understand the details of the discussion, but if dot2tex solves the problem, then my uninformed opinion is that it would be best not to reinvent the wheel.
> Maybe the issue is instead the `graphviz` license, since `graphviz` is a dependency for `dot2tex`.

Oh, that is indeed a problem.  Graphviz is [licensed under Common Public License Version 1.0](https://graphviz.org/license/), which is [not GPL-compatible](https://www.gnu.org/licenses/license-list.en.html#CommonPublicLicense10).


---

Comment by tscrim created at 2022-06-08 05:52:53

Replying to [comment:23 gh-DaveWitteMorris]:
> Replying to [comment:22 jhpalmieri]:
> > Replying to [comment:20 gh-DaveWitteMorris]:
> > > I think dot2tex is [licensed under the MIT licence](https://dot2tex.readthedocs.io/en/latest/license.html), and I think that is [compatible with GPL](https://www.gnu.org/licenses/license-list.en.html#Expat). So distributing dot2tex does seem to be an option. 
> > > 
> > > I don't understand the details of the discussion, but if dot2tex solves the problem, then my uninformed opinion is that it would be best not to reinvent the wheel.
> > Maybe the issue is instead the `graphviz` license, since `graphviz` is a dependency for `dot2tex`.
> 
> Oh, that is indeed a problem.  Graphviz is [licensed under Common Public License Version 1.0](https://graphviz.org/license/), which is [not GPL-compatible](https://www.gnu.org/licenses/license-list.en.html#CommonPublicLicense10).

Which subsequently means we cannot include `dot2tex` OOTB as I understand it. Although it would be useful if a user can just install it on their system and Sage automatically uses that without having to do anything to Sage.
