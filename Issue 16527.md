# Issue 16527: Add CM detection for elliptic curves over number fields

Issue created by migration from https://trac.sagemath.org/ticket/16764

Original creator: cremona

Original creation time: 2014-08-05 13:17:45

Keywords: complex multiplication

Elliptic curves over the rationals have mathods ``has_cm()`` and ``cm_discriminant()``.  We extend these to curves over number fields, and add a function ``has_rational_cm()`` to indicate the the curve has CM which is defined over its base field (i.e. the CM discriminant is a square in that field), which is always False over QQ.


---

Comment by cremona created at 2014-08-05 13:22:25

New commits:


---

Comment by cremona created at 2014-08-05 13:23:58

The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.


---

Comment by git created at 2014-08-05 13:44:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-08-05 13:46:18

Changing status from new to needs_review.


---

Comment by cremona created at 2014-08-05 13:46:18

Replying to [comment:2 cremona]:
> The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.

Done.  This probably counts as rewriting history, too bad.  #16743 will depend on this anyway.


---

Comment by chapoton created at 2014-08-06 16:56:43

Hello,

Lines after a `.. NOTE::` should be indented by 4 spaces (not 3).


---

Comment by cremona created at 2014-08-06 18:40:42

Replying to [comment:5 chapoton]:
> Hello,
> 
> Lines after a `.. NOTE::` should be indented by 4 spaces (not 3).

Are you sure?  See http://sphinx-doc.org/markup/para.html.  I was aligning the following text under the n of "note".


---

Comment by chapoton created at 2014-08-06 18:49:57

Oh, well. I was trusting

http://www.sagemath.org/doc/developer/coding_basics.html

but I wonder now who is right.


---

Comment by mstreng created at 2014-08-08 08:08:22

While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?

I've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so "Returns True iff this elliptic curve has Complex Multiplication." is ambiguous. It could be "Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure." or "Returns True iff this elliptic curve has a CM j-invariant." as in the number field case.


---

Comment by cremona created at 2014-08-08 08:32:52

Replying to [comment:8 mstreng]:
> While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?
> 
> I've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so "Returns True iff this elliptic curve has Complex Multiplication." is ambiguous. It could be "Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure." or "Returns True iff this elliptic curve has a CM j-invariant." as in the number field case.

Good point!  Thanks.  A suitable change for a reviewer's patch (as they used to be called)?


---

Comment by cremona created at 2014-08-10 10:29:53

I will follow Marco's suggestion about the documentation for has_cm, and also add a field parameter to has_rational_cm (defaulting to the base_field) as William had suggested.


---

Comment by git created at 2014-08-10 11:55:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-08-10 11:56:07

Done as above;  also merged 6.3.rc1 into the branch.


---

Comment by git created at 2014-08-27 12:53:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-08-27 12:54:46

I hope that merging in the develop branch (as at version 6.4.beta1) will make this easier to review and not harder!


---

Comment by mstreng created at 2014-08-29 12:58:41

The documentation has three references to "the `j`-invariant of an immaginary quadratic order",
which is either a whole Galois orbit or one specific complex number. In all those places it
should be "a `j`-invariant of an imaginary quadratic order". I'm writing a reviewer patch
that corrects this.


---

Comment by cremona created at 2014-08-29 13:06:41

Thanks, Marco.  If that's the only thing you found I am delighted!

At some point a better implementation of the basic function (detecting whether an algebraic integer is a CM j-invariant) would be good, but the one there is fine for small degrees which is likely to be all that is needed most of the time.
----
New commits:


---

Comment by mstreng created at 2014-08-29 13:10:25

Hi John. If you agree with my reviewer patch, you can set the ticket to postive_review.

----
New commits:


---

Comment by mstreng created at 2014-08-29 13:17:37

Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...


---

Comment by mstreng created at 2014-08-29 13:22:34

Replying to [comment:21 mstreng]:
> Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...

Never mind, the tab character is in some kind of xcode temp file, not in the actual source code.


---

Comment by wuthrich created at 2014-09-22 10:59:27

All tests pass for me, the documentation builds nicely (I can see a tab character). So this all looks fine to me.


---

Comment by wuthrich created at 2014-09-22 10:59:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-25 12:05:42

Resolution: fixed


---

Comment by jdemeyer created at 2014-09-30 20:53:47

What's the intention of the code

```
try:
    D = self._CMD
    if D:
        return D
    else:
        raise ValueError("%s does not have CM"%self)
except:
    pass
```


which is obviously equivalent to

```
try:
    D = self._CMD
    if D:
        return D
except:
    pass
```


I assume you meant something like

```
try:
    D = self._CMD
except AttributeError:
    pass
else:
    if D:
        return D
    else:
        raise ValueError("%s does not have CM"%self)
```


Apart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.


---

Comment by mstreng created at 2014-10-01 07:40:51

Replying to [comment:25 jdemeyer]:
> Apart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.

You are right. Could you reopen this ticket? This should not be merged into a stable version without fixing that code.


---

Comment by jdemeyer created at 2014-10-01 07:49:49

I will fix it in #17076.


---

Comment by cremona created at 2014-10-01 08:38:04

Apologies, of course I meant to write "except AttributeError".  I do know the rules.

To make absolutely sure:  the field _CMD stores 0 if it has already been determined that E does not have CM, and in this case the method cm_discriminant raises an error -- not my choice but for compatibility with curves over Q.  (I would have preferred to return 0 which is easy for other coed to check).

I'll be happy to review #17076 (though I seem to have forfeited my right to give any code a trustworthy review with this lapse).
