# Issue 25396: Speed up LAT computation for SBoxes

Issue created by migration from https://trac.sagemath.org/ticket/25633

Original creator: asante

Original creation time: 2018-06-21 17:46:05

CC:  tscrim

Keywords: days94

As briefly discussed on ask.sagemath.org (https://ask.sagemath.org/question/42492/huge-delay-in-sagecryptosboxsbox-method-nonlinearity-introduced-in-v82/?answer=42505#post-id-42505), the implementation for computing the linear approximation table can be speed up.


---

Comment by asante created at 2018-06-21 17:46:15

Set assignee to asante.


---

Comment by asante created at 2018-06-25 08:25:04

This is a follow up ticket of #25516.


---

Comment by git created at 2018-07-01 14:15:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-07-01 14:16:46

I've reset the branch, because the initial "git del && git add" poluted the diff (instead of doing a "git mv").


---

Comment by git created at 2018-07-01 15:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-01 15:15:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-07-01 15:16:19

So, finally managed to delete the branch from my first attempt ~.~


---

Comment by git created at 2018-07-02 14:46:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-02 21:23:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-02 21:33:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-03 09:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-07-03 09:16:33

I think the methods are now reasonable optimized. Computing the linear approximation matrix now takes roughly 40 to 80ms on my laptop -- note that this heavily depends on the scaling of the matrix in the end:


```sage
sage: for j in range(10):
....:     S = [x for x in range(256)];shuffle(S)
....:     S = sage.crypto.sbox.SBox(S)
....:     %time _ = S.linear_approximation_matrix()
....:     
CPU times: user 180 ms, sys: 24 ms, total: 204 ms
Wall time: 191 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 84.6 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 85.2 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 84.5 ms
CPU times: user 88 ms, sys: 0 ns, total: 88 ms
Wall time: 84.9 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 84.5 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 83.6 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 84.1 ms
CPU times: user 88 ms, sys: 0 ns, total: 88 ms
Wall time: 85.9 ms
CPU times: user 84 ms, sys: 0 ns, total: 84 ms
Wall time: 85.3 ms
sage: for j in range(10):
....:     S = [x for x in range(256)];shuffle(S)
....:     S = sage.crypto.sbox.SBox(S)
....:     %time _ = S.linear_approximation_matrix("fourier_coefficient")
....:     
CPU times: user 48 ms, sys: 0 ns, total: 48 ms
Wall time: 49.3 ms
CPU times: user 44 ms, sys: 0 ns, total: 44 ms
Wall time: 42.6 ms
CPU times: user 48 ms, sys: 0 ns, total: 48 ms
Wall time: 45.7 ms
CPU times: user 40 ms, sys: 0 ns, total: 40 ms
Wall time: 40.6 ms
CPU times: user 44 ms, sys: 0 ns, total: 44 ms
Wall time: 44.5 ms
CPU times: user 40 ms, sys: 0 ns, total: 40 ms
Wall time: 40.5 ms
CPU times: user 44 ms, sys: 0 ns, total: 44 ms
Wall time: 44.3 ms
CPU times: user 44 ms, sys: 0 ns, total: 44 ms
Wall time: 41.7 ms
CPU times: user 44 ms, sys: 0 ns, total: 44 ms
Wall time: 44.5 ms
CPU times: user 40 ms, sys: 0 ns, total: 40 ms
Wall time: 40.9 ms
```



---

Comment by asante created at 2018-07-03 09:16:33

Changing keywords from "days94" to "cython, sbox, days94".


---

Comment by asante created at 2018-07-03 09:16:33

Changing status from new to needs_review.


---

Comment by git created at 2018-07-03 10:20:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 12:00:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 13:11:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 13:58:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-27 12:28:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 19:25:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-11-25 23:33:22

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2018-11-25 23:33:22

Merge conflict. Once rebased on the latest beta, I will review this.


---

Comment by git created at 2018-11-26 12:02:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-11-26 12:05:21

In #25708 some SBox class methods were deprecated.
These now throw an error, when called:


```python
sage: from sage.crypto.sbox import SBox
sage: S = SBox(7,6,0,4,2,5,1,3)
sage: S.difference_distribution_matrix()
/home/asante/werkstatt/werkbank/sage/src/bin/sage-ipython:1: DeprecationWarning: difference_distribution_matrix is deprecated. Please use difference_distribution_table instead.
See https://trac.sagemath.org/25708 for details.
  #!/usr/bin/env sage-python23
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-9af42cf79b34> in <module>()
----> 1 S.difference_distribution_matrix()
/home/asante/werkstatt/werkbank/sage/local/lib/python2.7/site-packages/sage/misc/superseded.pyc in __call__(self, *args, **kwds)
    426             return self.func(*args, **kwds)
    427         else:
--> 428             return self.func(self.instance, *args, **kwds)
    429
    430     def __get__(self, inst, cls=None):
TypeError: __call__() takes exactly 0 positional arguments (1 given)
```


Should I fix this within this ticket or create a new one?
And does anyone has an idea whats wrong with this deprecation?
The new methods work as expected.
----
New commits:


---

Comment by tscrim created at 2018-11-27 02:56:06

We should fix this within this ticket by not making it an alias but manually issuing the deprecation warning and calling the corresponding function. So something like this:

```python
def difference_distribution_matrix(self):
    """
    Deprecated in :trac:`25708` for :meth:`difference_distribution_table`.
    """
    from sage.misc.superseded import deprecation
    deprecation(25708, "difference_distribution_matrix is deprecated. Please use difference_distribution_table instead.")
    return self.difference_distribution_table()
```

Since this is slated to be removed, it is not worth the time to add doctests.


---

Comment by tscrim created at 2018-11-27 03:29:24

Some comments:

- Instead of using `long` and `int`, you should use the more machine-independent `Py_ssize_t` (unless you have a specific reason to limit the size, such as you know these must be small values).

- In `_nterms`, it would be good to mark `total`, `divisor`, and `var_choices` as `Py_ssize_t`. Do you also want `var_choices/divisor` to be floor/integer division? If so, I think it is better to do `var_choices//divisor` to better emphasize this.

- It might be better to not declare `i` to be a `bint` in `from_bits` as you never use that fact (so it avoids extra checks in Cython). Also, why is there even a `swp` function? Would it be better to just do
  {{{#!python
        if self._big_endian:
            x = list(reversed(x))
        return ZZ([i for i in self._rpad(swp(x), n)], 2)
  }}}
- Replace `[GF(2)(0)]` with `[GF(2).zero()]`.
- Why are you converting to `ZZ` here `X = ZZ([ZZ(i) for i in X], 2)` when `i` is already an `int`? It might also be good to take care of this comment in `Integer`: `# should probably also have fast code for Python ints...` It actually seems like a good thing to factor the code to construct an integer from a bitstring out into a `cdef` helper function.
- It seems redundant to call `vector` here `return K(vector(GF(2), out))`. Shouldn't `K` be able to handle `out`?
- You could consider making `output_bits` into an array that you manually `alloc`/`free` so you will have better type control and can initialize without having to create a temp object to reverse it.
- You could use the `get_unsafe` operations for `lat` and `act` (once you explicitly cast it as a `Matrix` object).
- This is not correct: `cdef A = []`. I believe you want `cdef list A = []`.
- Add the `cdef list` declaration: `cdef list L = [self(i) for i in range(1 << m)]`.
- I would factor out the `substitute` into a `cdef` function and explicitly declare variable types.


---

Comment by git created at 2018-11-27 09:05:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-11-27 09:11:54

regarding the `cdef Py_ssize_t`, should I also change parts like the following?

```python
cdef int i
x = [GF(2)(i) for i in ZZ(x).digits(base=2, padto=n)]
```



Another thing that comes to my mind, when I see this part: I'm not so sure how helpful it actually is, to convert the digits to GF(2) elements, as we are only returning a list and not a vector.

But I guess changing this could cause some other code to break, so it may not be good to do so?


---

Comment by tscrim created at 2018-11-27 09:38:33

Replying to [comment:31 asante]:
> regarding the `cdef Py_ssize_t`, should I also change parts like the following?
> {{{
> #!python
> cdef int i
> x = [GF(2)(i) for i in ZZ(x).digits(base=2, padto=n)]
> }}}

I don't see the benefit of saying/converting `i` to an `int` because the `GF(2)` element constructor does not use that information. So it essentially adds another useless check. Thus, I would remove the `cdef int i` altogether.

> Another thing that comes to my mind, when I see this part: I'm not so sure how helpful it actually is, to convert the digits to GF(2) elements, as we are only returning a list and not a vector.

A list is lightweight compared to a vector and implemented directly into the Python interpreter/language, so it is much faster.


---

Comment by asante created at 2018-11-27 10:03:30

OK. I added this `cdef int i` because, IIRC, Jeroen said that it is faster, because cython can then optimize the `for i in` loop stuff. But maybe I just misunderstood this and its only faster when doing something like `for i in range(...)`?
But OK, I'll just remove it then.

Regarding the second point: should I remove the conversion to GF(2) then, or leave it?


---

Comment by tscrim created at 2018-11-27 10:09:50

Replying to [comment:33 asante]:
> OK. I added this `cdef int i` because, IIRC, Jeroen said that it is faster, because cython can then optimize the `for i in` loop stuff. But maybe I just misunderstood this and its only faster when doing something like `for i in range(...)`?
> But OK, I'll just remove it then.

Yes, that is when it is faster because Cython converts it to a C `for` loop. It is also useful for when you are using the type declaration.

> Regarding the second point: should I remove the conversion to GF(2) then, or leave it?

IDK as this is outside of my area of math. If it is the object you return and mathematically it should be in `GF(2)`, then you should keep the conversion. I was merely commenting on your question above returning a list versus a vector.

Micro-optimization:

```python
F = GF(2)
x = [F(i) for i in ZZ(x).digits(base=2, padto=n)]
```

so you do not (re)create `GF(2)` on every call.


---

Comment by git created at 2018-11-27 18:30:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-11-27 18:39:25

I tried to commit the changes in logical parts, hopefully thats ok for reviewing.

Regarding commit 24a8bbe 'clean up the SBox construction functions, as they duplicate some code' -- I'm not sure how to properly test the cdef functions used here. Are these indirect doctests ok or should I think about some better tests?


---

Comment by tscrim created at 2018-11-27 22:02:40

Replying to [comment:36 asante]:
> I tried to commit the changes in logical parts, hopefully thats ok for reviewing.

Yes, that is good (both for reviewing and history, makes it easier to find when bugs might have been introduced; I am not as good as I should be with granularity of my commits...).

> Regarding commit 24a8bbe 'clean up the SBox construction functions, as they duplicate some code' -- I'm not sure how to properly test the cdef functions used here. Are these indirect doctests ok or should I think about some better tests?

Indirect doctests are good. Strictly speaking, I think our policy is `cdef` functions/methods do not need doctests, but it is better to have them when can be meaningful.


---

Comment by tscrim created at 2018-11-27 22:26:33

As a data point for why `list` is faster:

```
sage: L = list(map(GF(2), [1,0,1,0,1]))
sage: %timeit k(vector(L))
The slowest run took 896.22 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 81.6 µs per loop
sage: %timeit k(L)
10000 loops, best of 3: 22.5 µs per loop
```


I am planning to go through the files here this morning and see what other changes I can do to try and speed things up further. Do you have some computations you have been doing for timings of various parts (besides comment:16)? (I do not know anything of the mathematics, so I don't know what are meaningful examples.)


---

Comment by asante created at 2018-11-27 22:46:38

No I have no other timing checks. And its also quite late here, so I wont have much time for some experiments in the next few hours..

From my intuition it might be worth to look for optimisations in the `__call__` method. I assume it is the most called method and the current input handling looks like it takes some time.. But I also do not know how to handle this more elegant.

It's basically only a array look up, but for sake of easier handling, we also want to support vector/list/tuple inputs (that encodes the array index as a binary string) or a finite field element (where the coefficient vector encodes the index as binary string, or, equivalent, the return value is the evaluation of the polynomial representation of the sbox).

Currently this is done with this try blocks, but I guess catching exceptions just to handle different input types might not be the fastest option.


---

Comment by tscrim created at 2018-12-01 00:03:05

Is this a bug? According to the docstring in `__call__`, it is:

```
sage: from sage.crypto.sbox import SBox
sage: S = SBox([7,6,0,4,2,5,1,3])
sage: k.<a> = GF(2^3)
sage: vector(a^2)
(0, 0, 1)
sage: S([0,0,1])
[1, 1, 0]
sage: S(vector(a^2))
[1, 1, 0]
sage: S(a^2)  # From the docstring, this should be 1 + a
a
```



---

Comment by asante created at 2018-12-06 10:07:44

Thanks for checking this. I stumbled across this during changing to cython.
In the end I was a bit confused and then forgot about this again. But I think you are right, it should be 1 + a.

When fixing this thou, other doctests that rely on the current behaviour fail:



```
**********************************************************************
File "src/sage/crypto/sbox.pyx", line 1007, in sage.crypto.sbox.SBox.interpolation_polynomial
Failed example:
    f
Expected:
    x^6 + a*x^5 + (a + 1)*x^4 + (a^2 + a + 1)*x^3
      + (a^2 + 1)*x^2 + (a + 1)*x + a^2 + a + 1
Got:
    (a^2 + a + 1)*x^6 + a^2*x^5 + (a + 1)*x^4 + (a^2 + a)*x^3 + x^2 + a*x + a^2 + a + 1
**********************************************************************
File "src/sage/crypto/sbox.pyx", line 1759, in sage.crypto.sbox.SBox.is_monomial_function
Failed example:
    S.interpolation_polynomial()
Expected:
    (a + 1)*x^6 + (a^2 + a + 1)*x^5 + (a^2 + 1)*x^3
Got:
    (a + 1)*x^6 + (a^2 + a + 1)*x^5 + (a^2 + a)*x^4 + (a^2 + 1)*x^3 + a*x^2 + a*x
**********************************************************************
File "src/sage/crypto/sbox.pyx", line 1763, in sage.crypto.sbox.SBox.is_monomial_function
Failed example:
    S.is_monomial_function()
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/crypto/sbox.pyx", line 1765, in sage.crypto.sbox.SBox.is_monomial_function
Failed example:
    S.interpolation_polynomial()
Expected:
    x^6
Got:
    (a^2 + a)*x^6 + (a + 1)*x^5 + (a + 1)*x^4 + (a^2 + a + 1)*x^3 + (a^2 + a)*x
**********************************************************************
```


Should I change this doctests? This might also brake other code, could'nt it?


---

Comment by tscrim created at 2018-12-06 13:44:36

I knew these were failing, but I did not want to change them until I knew what the correct behavior was (specifically, if I switched the endianness, then the tests passed). I will change them as I continue my review. It is possible that it will break code in the wild, but I would treat that as a [spacebar](https://xkcd.com/1172/).


---

Comment by tscrim created at 2018-12-08 11:08:16

With my latest changes, I am getting a speedup from your last comment of `72ms` and `36ms` to `60ms` and `<22ms` respectively.

Some other timings of current:
without my last commit:

```
sage: from sage.crypto.sbox import SBox
sage: S = SBox([7,6,0,4,2,5,1,3])
sage: k.<a> = GF(2^3)
sage: x = vector(a)
sage: %timeit S([0,1,0])
100000 loops, best of 3: 10.5 µs per loop
sage: %timeit S(a)
10000 loops, best of 3: 50.6 µs per loop
sage: %timeit S(x)
10000 loops, best of 3: 32.4 µs per loop
sage: %timeit S(5)
10000000 loops, best of 3: 138 ns per loop
```

vs your branch:

```
sage: %timeit S([0,1,0])
100000 loops, best of 3: 14.5 µs per loop
sage: %timeit S(a)
10000 loops, best of 3: 65.3 µs per loop
sage: %timeit S(x)
10000 loops, best of 3: 33.9 µs per loop
sage: %timeit S(5)
1000000 loops, best of 3: 434 ns per loop
```



---

Comment by tscrim created at 2018-12-08 11:09:03

With my last commit, I now get `50ms` and `13ms` respectively. Little tweaks and looking at the C code can go a long way. `:)`


---

Comment by tscrim created at 2018-12-08 11:14:03

Okay, I have done what I can other than special casing the bit in/output for `ZZ`. Yet, I think this is good for now.

However, I would like verification from someone else who does use the *F*<sub>2</sub> call input to the SBox to verify that the docstring was indeed how it was suppose to be treated. Subsequently, I would like verification about the corresponding doctests that needed to be changed.
----
New commits:


---

Comment by tscrim created at 2018-12-08 11:14:03

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-12-08 11:30:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-12-08 11:31:19

I took care of two other todo points I mentioned above. Now I am done.


---

Comment by asante created at 2018-12-19 14:59:57

Thanks for your work :)

Is the change in rings/integer.pyx on purpose within this ticket?

Apart from that, LGTM. I'll see if I can find someone who used the interpolation stuff (maybe Martin Albrecht did).


---

Comment by tscrim created at 2018-12-19 23:30:54

Replying to [comment:48 asante]:
> Thanks for your work :)

No problem.

> Is the change in rings/integer.pyx on purpose within this ticket?

Yes, it is.

> Apart from that, LGTM. I'll see if I can find someone who used the interpolation stuff (maybe Martin Albrecht did).

Great, thank you. Looks like we will need to rebase the branch on the latest version before finalizing this, but that should be trivial.


---

Comment by git created at 2018-12-19 23:32:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-12-19 23:34:24

I just did the trivial rebase.


---

Comment by asante created at 2019-06-16 20:09:34

So in order to get this ticket closed at some point and as https://groups.google.com/forum/#!searchin/sage-devel/sbox$20interpolation_polynomial%7Csort:date/sage-devel/_fLVL-r4B7Q/KnxL9WnyBQAJ did not really resulted in a final decision, should we go with Martin's suggestion and keep the current behaviour, and discuss it in the docs?


---

Comment by asante created at 2022-01-10 21:54:59

Changing status from needs_review to needs_work.


---

Comment by asante created at 2022-01-10 21:54:59

As there was no more reaction, I'd go with Martins suggestion: "If it’s all the same, perhaps keeping the current behaviour (and changing the documentation) is the strategy of least surprise?"

I'll try to work on this in the next days.


---

Comment by git created at 2022-01-11 18:42:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-01-13 00:43:48

That is fine with me. (I don't have any stake in this as I don't use this code.)


---

Comment by git created at 2022-01-13 22:49:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-14 20:53:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2022-01-14 21:02:19

I'd say its ready for review - however since I worked on a ticket for the last time, this new lint button seems to be introduced, which says 'failing'.

Can someone tell me how to use this, so that I can find out what to fix? Thanks in advance!


---

Comment by tscrim created at 2022-01-15 01:37:36

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-01-15 01:37:36

I wouldn't worry too much about it. Setting to needs review to get the patchbot to look at this. Have you reverted the behavior? I don't see those changes, but maybe I missed something.


---

Comment by git created at 2022-01-15 21:02:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-15 21:14:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2022-01-15 21:15:06

Yes you are right.

I agree with your changes, that `interpolation_polynomial` should directly use `__call__`.
However, changing the endianness for the finite field input inside the call function breaks a lot of stuff at other places.

Thus, I'd propose to (instead of what suggested by Martin and mentioned by me above) keep the documented behaviour.


---

Comment by tscrim created at 2022-01-16 03:20:38

I think there was a pair of changes I needed to make, but it has been too long for me to remember exactly. While there might be some doctests that break, only the ones that were touched could potentially be reset. Anyways, if you are happy with the current behavior, then I will set a positive review assuming there are no other objections (and a green patchbot).

One trivial change needed before that though:

```diff
-NOTE:
+.. NOTE::
```



---

Comment by git created at 2022-01-17 21:19:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-01-23 10:43:48

Thanks. I think this will be good for now. It should be relatively easy to revert the change if necessary (such as people disagree with it). I am slightly wondering if we want to put a note in the doc about this ticket with the change. Either way you decide, you can set a positive review (on my behalf if you add the note).


---

Comment by asante created at 2022-01-23 11:30:40

OK cool.

Regarding the note in the doc: I added the following note to the docstring of `interpolation_polynomial`. Do you have something else in mind?


```diff

diff --git a/src/sage/crypto/sbox.pyx b/src/sage/crypto/sbox.pyx
--- a/src/sage/crypto/sbox.pyx
+++ b/src/sage/crypto/sbox.pyx
@@ -1044,6 +1044,12 @@ cdef class SBox(SageObject):
             sage: f(a^2 + 1), S(5)
             (a^2 + 1, 5)
+
+        ..NOTE::
+
+            The method-internal call to the S-box initially used a different
+            endianess for handling finite field elements. This changed in
+            https://trac.sagemath.org/ticket/25633, by calling the S-box directly.
         """
         if self.m != self.n:
             raise TypeError("Lagrange interpolation only supported if"

```



---

Comment by tscrim created at 2022-01-23 11:53:27

Ah, right. No that is good other than using `:trac:`25633`` instead of the explicit trac link.


---

Comment by git created at 2022-01-23 12:14:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-23 12:17:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2022-01-23 12:19:55

Changing status from needs_review to positive_review.


---

Comment by asante created at 2022-01-23 12:19:55

Perfect, I wasn't aware of that macro.
Setting it to _positive review_ then.


---

Comment by vbraun created at 2022-01-31 23:31:51

Resolution: fixed


---

Comment by mkoeppe created at 2022-02-03 19:51:24

This breaks the Cygwin build:

```
[ 74/529] gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I./sage/cpython -I/opt/sage-3c8073266a16294562cd0273556664c883917216/lib/python3.8/site-packages/cysignals -I/cygdrive/d/a/sage/sage/pkgs/sagemath-standard -I/usr/include/python3.8 -I/opt/sage-3c8073266a16294562cd0273556664c883917216/lib/python3.8/site-packages/numpy/core/include -Ibuild/cythonized -I/opt/sage-3c8073266a16294562cd0273556664c883917216/include -I/usr/include/python3.8 -c build/cythonized/sage/crypto/sbox.c -o build/temp.cygwin-3.3.4-x86_64-3.8/build/cythonized/sage/crypto/sbox.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=gnu99
gcc -shared -Wl,--enable-auto-image-base -L/opt/sage-3c8073266a16294562cd0273556664c883917216/lib -Wl,-rpath,/opt/sage-3c8073266a16294562cd0273556664c883917216/lib -g -O2 build/temp.cygwin-3.3.4-x86_64-3.8/build/cythonized/sage/cpython/wrapperdescr.o -L/opt/sage-3c8073266a16294562cd0273556664c883917216/lib/python3.8/config -L/usr/lib -lpython3.8 -o build/lib.cygwin-3.3.4-x86_64-3.8/sage/cpython/wrapperdescr.cpython-38-x86_64-cygwin.dll
In file included from /usr/include/python3.8/unicodeobject.h:58,
                 from /usr/include/python3.8/Python.h:97,
                 from build/cythonized/sage/crypto/sbox.c:45:
build/cythonized/sage/crypto/sbox.c:1642:13: error: expected identifier or ‘(’ before numeric constant
 1642 |   PyObject *_S;
      |             ^~
In file included from /usr/include/python3.8/pytime.h:6,
                 from /usr/include/python3.8/Python.h:85,
                 from build/cythonized/sage/crypto/sbox.c:45:
build/cythonized/sage/crypto/sbox.c: In function ‘__pyx_pf_4sage_6crypto_4sbox_4SBox___init__’:
build/cythonized/sage/crypto/sbox.c:4577:30: error: expected identifier before numeric constant
 4577 |   __Pyx_DECREF(__pyx_v_self->_S);
      |                              ^~
```

https://github.com/mkoeppe/sage/runs/5054706036?check_suite_focus=true


---

Comment by mkoeppe created at 2022-02-03 19:54:37

This is likely from a clash with an unfortunately named macro from a system header file

(see https://eigen.tuxfamily.org/bz/show_bug.cgi?id=658)


---

Comment by asante created at 2022-02-03 19:57:19

Should I take care of fixing this?


---

Comment by mkoeppe created at 2022-02-03 20:00:05

That would be great. Since the ticket has already been closed, it would be best done in a follow-up ticket


---

Comment by asante created at 2022-02-03 20:06:40

Ok. I opened #33284 for this.


---

Comment by chapoton created at 2022-02-15 13:07:15

usage of six is no longer allowed. See #33350
