# Issue 31902: Ineffective deprecation warnings

Issue created by migration from https://trac.sagemath.org/ticket/32139

Original creator: mkoeppe

Original creation time: 2021-07-05 21:35:56

CC:  chapoton tscrim jhpalmieri vbraun

As observed in #14270 with 9.4.beta4, some of our = deprecation warnings are currently not issued.

This happens through an interaction of several flaws.
- #26132 broke the `filterwarnings` regex in `sage.all` that is supposed to make "sure to keep OUR deprecation warnings"
- counting the `stacklevel` may depend on whether Cython functions are involved

In addition, some of the regexes in `filterwarnings` in `sage.all` are too broad, such as matching on `module='.*ast'`


---

Comment by mkoeppe created at 2021-07-05 22:15:41

New commits:


---

Comment by git created at 2021-07-05 22:16:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 22:37:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-05 22:44:58

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-07-05 22:49:05

It's not as though we're vigilant about removing old deprecated code, but do we need to somehow add a grace period for code connected to the reappearing deprecation warnings? If someone decides in the near future to remove the code deprecated in #5930, is that okay?


---

Comment by mkoeppe created at 2021-07-06 01:14:19

Replying to [comment:10 jhpalmieri]:
> If someone decides in the near future to remove the code deprecated in #5930

I just did in the revived #14270.


---

Comment by mkoeppe created at 2021-07-06 01:17:53

Replying to [comment:10 jhpalmieri]:
> grace period for code connected to the reappearing deprecation warnings? 

I think, but have not tested, that the deprecation warning was only suppressed if this call is done directly on the top level; as soon as 1 level of Python function is wrapped around it, the deprecation warning would still show. If I'm right about this, the change in #14270 can certainly break people's interactive sessions in notebooks but not "code".


---

Comment by jhpalmieri created at 2021-07-06 20:06:50

I get lots of doctest failures:

```
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/misc/sagedoc.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/doc/en/thematic_tutorials/sandpile.rst  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/sandpiles/sandpile.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/misc/cachefunc.pyx  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/parallel/decorate.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/tests/lazy_imports.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/sets/set_from_iterator.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/doc/en/developer/coding_basics.rst  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/repl/ipython_tests.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/misc/sphinxify.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/repl/interface_magic.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage_docbuild/utils.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/misc/bindable_class.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/structure/dynamic_class.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/interfaces/tachyon.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/structure/mutability.pyx  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage_docbuild/sphinxbuild.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage_docbuild/__init__.py  # 1 doctest failed
sage -t --long --warn-long 119.7 --random-seed=0 src/sage/databases/findstat.py  # 1 doctest failed
```

The typical failure is because of this:

```
    DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3, and in 3.10 it will stop working
```

Full details for one file:

```
File "src/sage/misc/cachefunc.pyx", line 250, in sage.misc.cachefunc
Failed example:
    print(sage_getdoc(test_pfunc))
Expected:
       Some documentation
Got:
    doctest:warning
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/src/bin/sage-runtests", line 144, in <module>
        err = DC.run()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1207, in run
        self.run_doctests()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/control.py", line 909, in run_doctests
        self.dispatcher.dispatch()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2044, in dispatch
        self.parallel_dispatch()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1939, in parallel_dispatch
        w.start()  # This might take some time
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2211, in start
        super(DocTestWorker, self).start()
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2183, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2512, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2559, in _run
        result = runner.run(test)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 910, in run
        return self._run(test, compileflags, out)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cachefunc[50]>", line 1, in <module>
        print(sage_getdoc(test_pfunc))
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sageinspect.py", line 2033, in sage_getdoc
        s = sage.misc.sagedoc.format(r, embedded=(embedded_override or EMBEDDED_MODE))
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sagedoc.py", line 746, in format
        s = detex(s, embedded=embedded)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sagedoc.py", line 244, in detex
        s = sphinxify(s, format='text')
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sphinxify.py", line 121, in sphinxify
        sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/application.py", line 217, in __init__
        self.config = Config.read(self.confdir, confoverrides or {}, self.tags)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/config.py", line 168, in read
        namespace = eval_config_file(filename, tags)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/config.py", line 323, in eval_config_file
        exec(code, namespace)
      File "/var/folders/z6/yjw_7s357yx3_mhh81__lplc0000gn/T/tmppgjltzvc/en/introspect/conf.py", line 2, in <module>
        from sage.docs.conf import *
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/docs/conf.py", line 12, in <module>
        import sphinx.ext.intersphinx as intersphinx
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/ext/intersphinx.py", line 46, in <module>
        from sphinx.util import logging, requests
      File "<frozen importlib._bootstrap>", line 1058, in _handle_fromlist
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/util/requests.py", line 17, in <module>
        import requests
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/__init__.py", line 52, in <module>
        from .packages.urllib3.contrib import pyopenssl
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 972, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 972, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/__init__.py", line 27, in <module>
        from . import urllib3
      File "<frozen importlib._bootstrap>", line 1058, in _handle_fromlist
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/__init__.py", line 8, in <module>
        from .connectionpool import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/connectionpool.py", line 29, in <module>
        from .connection import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/connection.py", line 39, in <module>
        from .util.ssl_ import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 972, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/util/__init__.py", line 3, in <module>
        from .connection import is_connection_dropped
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/util/connection.py", line 3, in <module>
        from .wait import wait_for_read
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/util/wait.py", line 1, in <module>
        from .selectors import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/util/selectors.py", line 11, in <module>
        from collections import namedtuple, Mapping
      File "<frozen importlib._bootstrap>", line 1055, in _handle_fromlist
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/collections/__init__.py", line 62, in __getattr__
        warnings.warn("Using or importing the ABCs from 'collections' instead "
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3, and in 3.10 it will stop working
    doctest:warning
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/src/bin/sage-runtests", line 144, in <module>
        err = DC.run()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1207, in run
        self.run_doctests()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/control.py", line 909, in run_doctests
        self.dispatcher.dispatch()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2044, in dispatch
        self.parallel_dispatch()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1939, in parallel_dispatch
        w.start()  # This might take some time
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2211, in start
        super(DocTestWorker, self).start()
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2183, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2512, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2559, in _run
        result = runner.run(test)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 910, in run
        return self._run(test, compileflags, out)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cachefunc[50]>", line 1, in <module>
        print(sage_getdoc(test_pfunc))
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sageinspect.py", line 2033, in sage_getdoc
        s = sage.misc.sagedoc.format(r, embedded=(embedded_override or EMBEDDED_MODE))
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sagedoc.py", line 746, in format
        s = detex(s, embedded=embedded)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sagedoc.py", line 244, in detex
        s = sphinxify(s, format='text')
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/misc/sphinxify.py", line 121, in sphinxify
        sphinx_app = Sphinx(srcdir, confdir, outdir, doctreedir, format,
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/application.py", line 217, in __init__
        self.config = Config.read(self.confdir, confoverrides or {}, self.tags)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/config.py", line 168, in read
        namespace = eval_config_file(filename, tags)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/config.py", line 323, in eval_config_file
        exec(code, namespace)
      File "/var/folders/z6/yjw_7s357yx3_mhh81__lplc0000gn/T/tmppgjltzvc/en/introspect/conf.py", line 2, in <module>
        from sage.docs.conf import *
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sage/docs/conf.py", line 12, in <module>
        import sphinx.ext.intersphinx as intersphinx
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/ext/intersphinx.py", line 46, in <module>
        from sphinx.util import logging, requests
      File "<frozen importlib._bootstrap>", line 1058, in _handle_fromlist
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/sphinx/util/requests.py", line 17, in <module>
        import requests
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/__init__.py", line 52, in <module>
        from .packages.urllib3.contrib import pyopenssl
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 972, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 972, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/__init__.py", line 27, in <module>
        from . import urllib3
      File "<frozen importlib._bootstrap>", line 1058, in _handle_fromlist
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/__init__.py", line 8, in <module>
        from .connectionpool import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/connectionpool.py", line 29, in <module>
        from .connection import (
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/connection.py", line 50, in <module>
        from ._collections import HTTPHeaderDict
      File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
      File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 855, in exec_module
      File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/lib/python3.9/site-packages/requests/packages/urllib3/_collections.py", line 2, in <module>
        from collections import Mapping, MutableMapping
      File "<frozen importlib._bootstrap>", line 1055, in _handle_fromlist
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/collections/__init__.py", line 62, in __getattr__
        warnings.warn("Using or importing the ABCs from 'collections' instead "
      File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3, and in 3.10 it will stop working
       Some documentation
    <BLANKLINE>
```

I'm using OS X, and obviously this is with homebrew's Python.


---

Comment by mkoeppe created at 2021-07-06 21:10:16

OK, I messed up the `collections.abc` filter, mistaking a `message` condition for a `module` condition


---

Comment by git created at 2021-07-06 21:11:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-07-06 23:14:10

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-07-06 23:14:10

Looks good to me, tests pass, and evaluating `(x+y)(1, 2)` now prints a deprecation warning, both from the command line and the Jupyter notebook.


---

Comment by mkoeppe created at 2021-07-07 00:18:54

Thank you!


---

Comment by mkoeppe created at 2021-07-17 21:46:36

Failing patchbot report is from an old commit

```
/data/pell/lipnik/patchbot/local/lib/python3.9/site-packages/requests/packages/urllib3/util/selectors.py:11: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3, and in 3.10 it will stop working
  from collections import namedtuple, Mapping
```



---

Comment by @mwageringel created at 2021-07-18 14:50:37

Replying to [ticket:32139 mkoeppe]:
> - counting the `stacklevel` may depend on whether Cython functions are involved

All the other deprecation warnings from Cython code are affected by this problem as well: #28500.


---

Comment by vbraun created at 2021-07-18 22:53:49

Resolution: fixed
